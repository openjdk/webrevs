{"files":[{"patch":"@@ -604,2 +604,2 @@\n-  INSN(_beq, 0b1100011, 0b000);\n-  INSN(_bne, 0b1100011, 0b001);\n+  INSN(beq, 0b1100011, 0b000);\n+  INSN(bne, 0b1100011, 0b001);\n@@ -822,1 +822,1 @@\n-  INSN(_jal, 0b1101111);\n+  INSN(jal, 0b1101111);\n@@ -2044,7 +2044,6 @@\n-\/\/ 1. When UseRVC is enabled, 32-bit instructions under 'CompressibleRegion's will be\n-\/\/    transformed to 16-bit instructions if compressible.\n-\/\/ 2. RVC instructions in Assembler always begin with 'c_' prefix, as 'c_li',\n-\/\/    but most of time we have no need to explicitly use these instructions.\n-\/\/ 3. 'CompressibleRegion' is introduced to hint instructions in this Region's RTTI range\n-\/\/    are qualified to be compressed with their 2-byte versions.\n-\/\/    An example:\n+\/\/ 1. Assembler functions encoding 16-bit compressed instructions always begin with a 'c_'\n+\/\/    prefix, such as 'c_add'. Correspondingly, assembler functions encoding normal 32-bit\n+\/\/    instructions with begin with a '_' prefix, such as \"_add\". Most of time users have no\n+\/\/    need to explicitly emit these compressed instructions. Instead, they still use unified\n+\/\/    wrappers such as 'add' which do the compressing work through 'c_add' depending on the\n+\/\/    the operands of the instruction and availability of the RVC hardware extension.\n@@ -2052,2 +2051,3 @@\n-\/\/      CompressibleRegion cr(_masm);\n-\/\/      __ andr(...);      \/\/ this instruction could change to c.and if able to\n+\/\/ 2. 'CompressibleRegion' and 'IncompressibleRegion' are introduced to mark assembler scopes\n+\/\/     within which instructions are qualified or unqualified to be compressed into their 16-bit\n+\/\/     versions. An example:\n@@ -2055,2 +2055,10 @@\n-\/\/ 4. Using -XX:PrintAssemblyOptions=no-aliases could distinguish RVC instructions from\n-\/\/    normal ones.\n+\/\/      CompressibleRegion cr(_masm);\n+\/\/      __ add(...);       \/\/ this instruction will be compressed into 'c.and' when possible\n+\/\/      {\n+\/\/         IncompressibleRegion ir(_masm);\n+\/\/         __ add(...);    \/\/ this instruction will not be compressed\n+\/\/         {\n+\/\/            CompressibleRegion cr(_masm);\n+\/\/            __ add(...); \/\/ this instruction will be compressed into 'c.and' when possible\n+\/\/         }\n+\/\/      }\n@@ -2058,0 +2066,2 @@\n+\/\/ 3. When printing JIT assembly code, using -XX:PrintAssemblyOptions=no-aliases could help\n+\/\/    distinguish compressed 16-bit instructions from normal 32-bit ones.\n@@ -2066,2 +2076,2 @@\n-  \/\/ a compressible region\n-  class CompressibleRegion : public StackObj {\n+  \/\/ an abstract compressible region\n+  class AbstractCompressibleRegion : public StackObj {\n@@ -2071,2 +2081,2 @@\n-  public:\n-    CompressibleRegion(Assembler *_masm)\n+  protected:\n+    AbstractCompressibleRegion(Assembler *_masm)\n@@ -2074,1 +2084,6 @@\n-    , _saved_in_compressible_region(_masm->in_compressible_region()) {\n+    , _saved_in_compressible_region(_masm->in_compressible_region()) {}\n+  };\n+  \/\/ a compressible region\n+  class CompressibleRegion : public AbstractCompressibleRegion {\n+  public:\n+    CompressibleRegion(Assembler *_masm) : AbstractCompressibleRegion(_masm) {\n@@ -2081,0 +2096,10 @@\n+  \/\/ an incompressible region\n+  class IncompressibleRegion : public AbstractCompressibleRegion {\n+  public:\n+    IncompressibleRegion(Assembler *_masm) : AbstractCompressibleRegion(_masm) {\n+      _masm->set_in_compressible_region(false);\n+    }\n+    ~IncompressibleRegion() {\n+      _masm->set_in_compressible_region(_saved_in_compressible_region);\n+    }\n+  };\n@@ -2781,20 +2806,0 @@\n-\/\/ --------------------------\n-\/\/ Conditional branch instructions\n-\/\/ --------------------------\n-#define INSN(NAME, C_NAME, NORMAL_NAME)                                                      \\\n-  void NAME(Register Rs1, Register Rs2, const int64_t offset) {                              \\\n-    \/* beq\/bne -> c.beqz\/c.bnez *\/                                                           \\\n-    if (do_compress() &&                                                                     \\\n-        (offset != 0 && Rs2 == x0 && Rs1->is_compressed_valid() &&                           \\\n-        is_imm_in_range(offset, 8, 1))) {                                                    \\\n-      C_NAME(Rs1, offset);                                                                   \\\n-      return;                                                                                \\\n-    }                                                                                        \\\n-    NORMAL_NAME(Rs1, Rs2, offset);                                                           \\\n-  }\n-\n-  INSN(beq, c_beqz, _beq);\n-  INSN(bne, c_beqz, _bne);\n-\n-#undef INSN\n-\n@@ -2803,15 +2808,0 @@\n-\/\/ --------------------------\n-#define INSN(NAME)                                                                           \\\n-  void NAME(Register Rd, const int32_t offset) {                                             \\\n-    \/* jal -> c.j *\/                                                                         \\\n-    if (do_compress() && offset != 0 && Rd == x0 && is_imm_in_range(offset, 11, 1)) {        \\\n-      c_j(offset);                                                                           \\\n-      return;                                                                                \\\n-    }                                                                                        \\\n-    _jal(Rd, offset);                                                                        \\\n-  }\n-\n-  INSN(jal);\n-\n-#undef INSN\n-\n","filename":"src\/hotspot\/cpu\/riscv\/assembler_riscv.hpp","additions":44,"deletions":54,"binary":false,"changes":98,"status":"modified"},{"patch":"@@ -324,1 +324,2 @@\n-  nop();\n+  IncompressibleRegion ir(this);  \/\/ keep the nop as 4 bytes for patching.\n+  nop();  \/\/ 4 bytes\n","filename":"src\/hotspot\/cpu\/riscv\/c1_MacroAssembler_riscv.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -259,0 +259,1 @@\n+    IncompressibleRegion ir(this);  \/\/ the label address will be patched back.\n@@ -569,0 +570,1 @@\n+  IncompressibleRegion ir(this);  \/\/ Fixed length: see CompiledStaticCall::to_interp_stub_size().\n@@ -773,0 +775,1 @@\n+  IncompressibleRegion ir(this);   \/\/ the label address may be patched back.\n@@ -2365,0 +2368,1 @@\n+  IncompressibleRegion ir(this);  \/\/ Fixed length: see MacroAssembler::far_branch_size()\n@@ -2382,0 +2386,1 @@\n+  IncompressibleRegion ir(this);  \/\/ Fixed length: see MacroAssembler::far_branch_size()\n","filename":"src\/hotspot\/cpu\/riscv\/macroAssembler_riscv.cpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -369,0 +369,1 @@\n+  Assembler::IncompressibleRegion ir(&a);  \/\/ Fixed length: see NativeGeneralJump::get_instruction_size()\n","filename":"src\/hotspot\/cpu\/riscv\/nativeInst_riscv.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -1066,2 +1066,5 @@\n-  MacroAssembler::assert_alignment(__ pc());\n-  __ nop();\n+  {\n+    Assembler::IncompressibleRegion ir(&_masm);  \/\/ keep the nop as 4 bytes for patching.\n+    MacroAssembler::assert_alignment(__ pc());\n+    __ nop();  \/\/ 4 bytes\n+  }\n@@ -1358,0 +1361,1 @@\n+  Assembler::IncompressibleRegion ir(&_masm);  \/\/ Fixed length: see BoxLockNode::size()\n@@ -1967,0 +1971,1 @@\n+    Assembler::IncompressibleRegion ir(&_masm);  \/\/ Fixed length: see ret_addr_offset\n@@ -1999,0 +2004,1 @@\n+    Assembler::IncompressibleRegion ir(&_masm);  \/\/ Fixed length: see ret_addr_offset\n@@ -2017,0 +2023,1 @@\n+    Assembler::IncompressibleRegion ir(&_masm);  \/\/ Fixed length: see ret_addr_offset\n","filename":"src\/hotspot\/cpu\/riscv\/riscv.ad","additions":9,"deletions":2,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -1090,2 +1090,5 @@\n-    MacroAssembler::assert_alignment(__ pc());\n-    __ nop();\n+    {\n+      Assembler::IncompressibleRegion ir(masm);  \/\/ keep the nop as 4 bytes for patching.\n+      MacroAssembler::assert_alignment(__ pc());\n+      __ nop();  \/\/ 4 bytes\n+    }\n@@ -1242,2 +1245,5 @@\n-  MacroAssembler::assert_alignment(__ pc());\n-  __ nop();\n+  {\n+    Assembler::IncompressibleRegion ir(masm);  \/\/ keep the nop as 4 bytes for patching.\n+    MacroAssembler::assert_alignment(__ pc());\n+    __ nop();  \/\/ 4 bytes\n+  }\n","filename":"src\/hotspot\/cpu\/riscv\/sharedRuntime_riscv.cpp","additions":10,"deletions":4,"binary":false,"changes":14,"status":"modified"}]}