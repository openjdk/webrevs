{"files":[{"patch":"@@ -241,0 +241,2 @@\n+        final byte[] handshakeBytes;\n+        int totalRead = 0;\n@@ -245,13 +247,8 @@\n-            final byte[] handshakeBytes = new byte[JTREG_AGENT_HANDSHAKE_MAGIC.length];\n-            final int numRead = s.getInputStream().read(handshakeBytes);\n-            if (numRead == -1) {\n-                \/\/ EOF\n-                log(\"Received EOF before handshake from \" + s);\n-                return null;\n-            }\n-            \/\/ verify the handshake bytes\n-            if (!Arrays.equals(JTREG_AGENT_HANDSHAKE_MAGIC, handshakeBytes)) {\n-                log(\"Unexpected handshake bytes from socket: \" + s + \", expected: \"\n-                        + Arrays.toString(JTREG_AGENT_HANDSHAKE_MAGIC)\n-                        + \", actual: \" + Arrays.toString(handshakeBytes));\n-                return null;\n+            handshakeBytes = new byte[JTREG_AGENT_HANDSHAKE_MAGIC.length];\n+            while (totalRead < JTREG_AGENT_HANDSHAKE_MAGIC.length) {\n+                final int numRead = s.getInputStream().read(handshakeBytes,\n+                        totalRead, (JTREG_AGENT_HANDSHAKE_MAGIC.length - totalRead));\n+                if (numRead == -1) {\n+                    break;\n+                }\n+                totalRead += numRead;\n@@ -268,0 +265,16 @@\n+        \/\/ we don't read more than handshake bytes in this method\n+        assert totalRead <= JTREG_AGENT_HANDSHAKE_MAGIC.length : \"unexpected number of handshake\" +\n+                \" bytes read: \" + totalRead;\n+\n+        if (totalRead < JTREG_AGENT_HANDSHAKE_MAGIC.length) {\n+            \/\/ EOF\n+            log(\"handshake failed - \" + totalRead + \" bytes received from \" + s);\n+            return null;\n+        }\n+        \/\/ verify the handshake bytes\n+        if (!Arrays.equals(JTREG_AGENT_HANDSHAKE_MAGIC, handshakeBytes)) {\n+            log(\"Unexpected handshake bytes from socket: \" + s\n+                    + \", expected: \" + Arrays.toString(JTREG_AGENT_HANDSHAKE_MAGIC)\n+                    + \", actual: \" + Arrays.toString(handshakeBytes));\n+            return null;\n+        }\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/exec\/Agent.java","additions":26,"deletions":13,"binary":false,"changes":39,"status":"modified"}]}