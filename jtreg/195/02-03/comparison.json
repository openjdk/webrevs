{"files":[{"patch":"@@ -103,0 +103,5 @@\n+    \/\/ We tolerate a certain number of connection attempts from unexpected processes\n+    \/\/ on the port we listen on. We discard such connections if, after connecting,\n+    \/\/ our internal handshake fails.\n+    private static final int MAX_ACCEPT_ATTEMPTS = 3;\n+\n@@ -151,4 +156,1 @@\n-            \/\/ We allow for some unexpected processes to connect to the port we listen on.\n-            \/\/ We discard such connections if, after connecting, our internal handshake fails.\n-            final int maxAcceptAttempts = 3;\n-            final int backlog = maxAcceptAttempts;\n+            final int backlog = MAX_ACCEPT_ATTEMPTS;\n@@ -192,1 +194,1 @@\n-                for (int i = 0; i < maxAcceptAttempts; i++) {\n+                for (int i = 0; i < MAX_ACCEPT_ATTEMPTS; i++) {\n@@ -204,1 +206,1 @@\n-                            + maxAcceptAttempts + \" attempts\");\n+                            + MAX_ACCEPT_ATTEMPTS + \" attempts\");\n@@ -240,1 +242,0 @@\n-        final Socket s = ss.accept();\n@@ -243,0 +244,1 @@\n+        final Socket s = ss.accept();\n@@ -257,1 +259,0 @@\n-            log(\"closing connection to \" + s + \" due to: \" + ioe);\n@@ -260,2 +261,4 @@\n-            } catch (IOException ignored) {\n-                \/\/ ignore\n+            } catch (IOException closeFailure) {\n+                if (closeFailure != ioe) {\n+                    ioe.addSuppressed(closeFailure);\n+                }\n@@ -263,0 +266,2 @@\n+            log(\"closed the connection to \" + s + \" due to: \" + ioe);\n+            ioe.printStackTrace(); \/\/ log the read failure stacktrace\n@@ -265,6 +270,4 @@\n-        \/\/ we don't read more than handshake bytes in this method\n-        assert totalRead <= JTREG_AGENT_HANDSHAKE_MAGIC.length : \"unexpected number of handshake\" +\n-                \" bytes read: \" + totalRead;\n-\n-        if (totalRead < JTREG_AGENT_HANDSHAKE_MAGIC.length) {\n-            \/\/ EOF\n+        if (totalRead != JTREG_AGENT_HANDSHAKE_MAGIC.length) {\n+            \/\/ we don't expect to read more than handshake bytes in this method\n+            assert totalRead < JTREG_AGENT_HANDSHAKE_MAGIC.length : \"unexpected number of\" +\n+                    \" handshake bytes read: \" + totalRead;\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/exec\/Agent.java","additions":19,"deletions":16,"binary":false,"changes":35,"status":"modified"}]}