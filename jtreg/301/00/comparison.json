{"files":[{"patch":"@@ -36,0 +36,1 @@\n+import java.io.OutputStream;\n@@ -39,0 +40,1 @@\n+import java.lang.reflect.Array;\n@@ -437,5 +439,10 @@\n-            Constructor<?> constr = toolClass.getConstructor(PrintStream.class, String.class);\n-            ByteArrayOutputStream baos = new ByteArrayOutputStream();\n-            PrintStream ps = new PrintStream(baos);\n-            try {\n-                Object tool = constr.newInstance(ps, toolName);\n+            Constructor<?> constr = getAsmToolConstructor(toolClass);\n+            ByteArrayOutputStream toolOutput = new ByteArrayOutputStream();\n+            ByteArrayOutputStream toolStdout = new ByteArrayOutputStream();\n+            ByteArrayOutputStream toolStderr = new ByteArrayOutputStream();\n+\n+            try (var output = new PrintStream(toolOutput);\n+                 var stdout = new PrintStream(toolStdout);\n+                 var stderr = new PrintStream(toolStderr)) {\n+\n+                Object tool = createAsmToolInstance(constr, output, stdout, stderr);\n@@ -450,0 +457,8 @@\n+                \/\/ print out the stdout and stderr content generated by the tool\n+                try (PrintWriter out = section.createOutput(toolName + \"-stdout\")) {\n+                    out.write(toolStdout.toString());\n+                }\n+                try (PrintWriter out = section.createOutput(toolName + \"-stderr\")) {\n+                    out.write(toolStderr.toString());\n+                }\n+                \/\/ print out the tool's output\n@@ -451,1 +466,1 @@\n-                    out.write(baos.toString());\n+                    out.write(toolOutput.toString());\n@@ -461,0 +476,30 @@\n+    private static <T> Constructor<T> getAsmToolConstructor(final Class<T> toolMainClass)\n+            throws ReflectiveOperationException {\n+        final Class<?> toolOutputClass = Class.forName(\"org.openjdk.asmtools.common.outputs.ToolOutput\");\n+        final Class<?> logClass = Class.forName(\"org.openjdk.asmtools.common.outputs.log.DualStreamToolOutput\");\n+        final Class<?> toolInputClassArr = Class.forName(\"[Lorg.openjdk.asmtools.common.inputs.ToolInput;\");\n+        \/\/ Constructor of the form Klass(ToolOutput toolOutput, DualStreamToolOutput log, ToolInput... toolInputs)\n+        return toolMainClass.getConstructor(toolOutputClass, logClass, toolInputClassArr);\n+    }\n+\n+    private static Object createAsmToolInstance(final Constructor<?> constructor,\n+                                                final PrintStream toolOutput,\n+                                                final PrintStream toolStdout,\n+                                                final PrintStream toolStderr)\n+            throws ReflectiveOperationException {\n+        final Object printWriterOutput =\n+                Class.forName(\"org.openjdk.asmtools.common.outputs.PrintWriterOutput\")\n+                        .getConstructor(OutputStream.class)\n+                        .newInstance(toolOutput);\n+        final Object stdOutErrOutput =\n+                Class.forName(\"org.openjdk.asmtools.common.outputs.log.DualOutputStreamOutput\")\n+                        .getConstructor(PrintStream.class, PrintStream.class)\n+                        .newInstance(toolStdout, toolStderr);\n+        final Class<?> toolInputClass = Class.forName(\"org.openjdk.asmtools.common.inputs.ToolInput\");\n+        \/\/ construct the instance in the form of:\n+        \/\/  new Klass(new PrintWriterOutput(toolOutput),\n+        \/\/           new DualOutputStreamOutput(toolStdout, toolStderr),\n+        \/\/           new ToolInput[0]);\n+        return constructor.newInstance(printWriterOutput, stdOutErrOutput, Array.newInstance(toolInputClass, 0));\n+    }\n+\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/exec\/CompileAction.java","additions":51,"deletions":6,"binary":false,"changes":57,"status":"modified"},{"patch":"@@ -25,5 +25,4 @@\n-public class LibA {\n-\n-    public static void name() {\n-       \/\/ do nothing\n-     throw new RuntimeException();\n+public class Hello {\n+    public static Method getInt:\"()I\" stack 1 locals 0 {\n+        bipush 42;\n+        ireturn;\n@@ -31,1 +30,0 @@\n-\n","filename":"test\/jasm\/Hello.jasm","additions":4,"deletions":6,"binary":false,"changes":10,"previous_filename":"test\/libs-build-implicit\/lib\/LibA.java","status":"copied"},{"patch":"@@ -0,0 +1,48 @@\n+#\n+# Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+#\n+# This code is free software; you can redistribute it and\/or modify it\n+# under the terms of the GNU General Public License version 2 only, as\n+# published by the Free Software Foundation.\n+#\n+# This code is distributed in the hope that it will be useful, but WITHOUT\n+# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+# version 2 for more details (a copy is included in the LICENSE file that\n+# accompanied this code).\n+#\n+# You should have received a copy of the GNU General Public License version\n+# 2 along with this work; if not, write to the Free Software Foundation,\n+# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+#\n+# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+# or visit www.oracle.com if you need additional information or have any\n+# questions.\n+#\n+\n+# verify that when a jasm file is compiled as a jtreg action, then\n+# the jtr report of the test contains the \"jasm-stdout\", \"jasm-stderr\"\n+# and \"jasm\" sections for that test action\n+$(BUILDTESTDIR)\/jasmreporting.ok: \\\n+                $(JTREG_IMAGEDIR)\/lib\/javatest.jar \\\n+\t\t$(JTREG_IMAGEDIR)\/lib\/jtreg.jar \\\n+\t\t$(JTREG_IMAGEDIR)\/bin\/jtreg\n+\n+\t$(RM) $(@:%.ok=%)\n+\t$(MKDIR) $(@:%.ok=%)\n+\n+\t$(JTREG_IMAGEDIR)\/bin\/jtreg $(JTREG_OPTS) \\\n+\t\t-jdk:$(JDKHOME) \\\n+\t\t-w $(@:%.ok=%)\/work\/ \\\n+\t\t-r $(@:%.ok=%)\/report\/ \\\n+\t\t$(TESTDIR)\/jasm\/ > $(@:%.ok=%\/jt.log)\n+\n+\t$(GREP) '\\---jasm-stdout:' $(@:%.ok=%)\/work\/JasmUsageTest.jtr > \/dev\/null\n+\t$(GREP) '\\---jasm-stderr:' $(@:%.ok=%)\/work\/JasmUsageTest.jtr > \/dev\/null\n+\t$(GREP) '\\---jasm:' $(@:%.ok=%)\/work\/JasmUsageTest.jtr > \/dev\/null\n+\n+\techo \"$@ test passed at `date`\" > $@\n+\n+\n+TESTS.jtreg += $(BUILDTESTDIR)\/jasmreporting.ok\n","filename":"test\/jasm\/Jasm.gmk","additions":48,"deletions":0,"binary":false,"changes":48,"status":"added"},{"patch":"@@ -0,0 +1,40 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @compile Hello.jasm\n+ * @run main JasmUsageTest\n+ *\/\n+public class JasmUsageTest {\n+    public static void main(final String[] args) throws Exception {\n+        \/\/ verify that the Hello.jasm was compiled correctly into a class\n+        \/\/ and available for use\n+        final int actual = Hello.getInt();\n+        final int expected = 42;\n+        if (actual != expected) {\n+            throw new AssertionError(\"unexpected value \" + actual\n+                    + \" returned by Hello.getInt(), expected \" + expected);\n+        }\n+    }\n+}\n","filename":"test\/jasm\/JasmUsageTest.java","additions":40,"deletions":0,"binary":false,"changes":40,"status":"added"},{"patch":"","filename":"test\/jasm\/TEST.ROOT","additions":0,"deletions":0,"binary":false,"changes":0,"previous_filename":"test\/4499340\/test\/TEST.ROOT","status":"copied"}]}