{"files":[{"patch":"@@ -330,1 +330,1 @@\n-        int insertPos = -1;\n+        String sourceOrReleaseVersion = null;\n@@ -334,1 +334,2 @@\n-        for (String currArg : args) {\n+        for (int i = 0; i < args.size(); i++) {\n+            String currArg = args.get(i);\n@@ -338,3 +339,0 @@\n-                if (insertPos == -1) {\n-                    insertPos = javacArgs.size();\n-                }\n@@ -352,1 +350,1 @@\n-                        break;\n+                        break; \/\/ switch\n@@ -356,2 +354,5 @@\n-                        if (insertPos == -1) {\n-                            insertPos = javacArgs.size();\n+                        seenSourceOrRelease = true;\n+                        if (eq != -1) {\n+                            sourceOrReleaseVersion = currArg.substring(eq + 1).trim();\n+                        } else {\n+                            sourceOrReleaseVersion = args.size() > i + 1 ? args.get(i + 1) : null;\n@@ -359,2 +360,1 @@\n-                        seenSourceOrRelease= true;\n-                        break;\n+                        break; \/\/ switch\n@@ -371,4 +371,2 @@\n-            if (insertPos == -1) { \/\/ happens for example in \"-proc:only CLASS\" cases\n-                insertPos = 0;     \/\/ prepend in order to not mess with variadic arguments\n-            }\n-            javacArgs.add(insertPos, \"--enable-preview\");\n+            String version = script.getTestJDKVersion().name();\n+            \/\/ always prepend in order to not mess with variadic arguments\n@@ -376,3 +374,6 @@\n-                int v = script.getTestJDKVersion().major;\n-                javacArgs.add(insertPos + 1, \"-source\");\n-                javacArgs.add(insertPos + 2, String.valueOf(v));\n+                javacArgs.add(0, version);\n+                javacArgs.add(0, \"-source\");\n+            }\n+            \/\/ 7903809: prevent invalid source release errors\n+            if (!seenSourceOrRelease || version.equals(sourceOrReleaseVersion)) {\n+                javacArgs.add(0, \"--enable-preview\");\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/exec\/CompileAction.java","additions":18,"deletions":17,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+ * @bug 7903809\n@@ -27,0 +28,3 @@\n+ * @compile --release 11 TestUsingPreviewLibrary.java\n+ * @compile  -source 1.8 TestUsingPreviewLibrary.java\n+ * @compile --source 1.8 TestUsingPreviewLibrary.java\n","filename":"test\/libPropertiesEnablePreview\/TestUsingPreviewLibrary.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"}]}