{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -40,1 +40,0 @@\n-import java.lang.reflect.Method;\n@@ -462,0 +461,4 @@\n+    private boolean isAgentServerAlive() {\n+        return this.process.isAlive();\n+    }\n+\n@@ -499,14 +502,0 @@\n-    void writeOptionalString(String s) throws IOException {\n-        if (s == null)\n-            out.writeByte(0);\n-        else {\n-            out.writeByte(1);\n-            out.writeUTF(s);\n-        }\n-    }\n-\n-    static String readOptionalString(DataInputStream in) throws IOException {\n-        int b = in.readByte();\n-        return (b == 0) ? null : in.readUTF();\n-    }\n-\n@@ -858,8 +847,12 @@\n-                logger.log(null, \"POOL: Reusing Agent[\" + a.getId() + \"]\");\n-                allAgents.remove(a);\n-                stats.reuse(a);\n-            } else {\n-                logger.log(null, \"POOL: Creating new agent\");\n-                a = new Agent(dir, jdk, vmOpts, envVars, policyFile, timeoutFactor, logger,\n-                        testThreadFactory, testThreadFactoryPath);\n-                stats.add(a);\n+                \/\/ use a pooled agent only if the agent's process hasn't exited\n+                \/\/ (for example due to JVM crash when the agent was pooled)\n+                if (a.isAgentServerAlive()) {\n+                    logger.log(null, \"POOL: Reusing Agent[\" + a.getId() + \"]\");\n+                    allAgents.remove(a);\n+                    stats.reuse(a);\n+                    return a;\n+                }\n+                \/\/ remove the dead agent from the pool\n+                logger.log(null, \"POOL: Removing Agent[\" + a.getId() + \"]\"\n+                        + \" because agent server process \" + a.getAgentServerPid() + \" is dead\");\n+                removeAgent(a);\n@@ -867,1 +860,4 @@\n-\n+            logger.log(null, \"POOL: Creating new agent\");\n+            a = new Agent(dir, jdk, vmOpts, envVars, policyFile, timeoutFactor, logger,\n+                    testThreadFactory, testThreadFactoryPath);\n+            stats.add(a);\n@@ -878,0 +874,6 @@\n+            \/\/ do not save the agent into the pool if the agent's process is already dead\n+            if (!agent.isAgentServerAlive()) {\n+                logger.log(agent, \"Agent server process \" + agent.getAgentServerPid()\n+                        + \" is dead, will not save agent to pool\");\n+                return;\n+            }\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/exec\/Agent.java","additions":27,"deletions":25,"binary":false,"changes":52,"status":"modified"}]}