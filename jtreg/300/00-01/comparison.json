{"files":[{"patch":"@@ -109,1 +109,1 @@\n-            tcTestIgnored(\"jtreg\");\n+            tcTestIgnored(\"jtreg\", status.getReason());\n@@ -160,1 +160,1 @@\n-            case SKIPPED -> tcTestIgnored(test.name());\n+            case SKIPPED -> tcTestIgnored(test.name(), test.skipReason());\n@@ -221,2 +221,3 @@\n-    private static void tcTestIgnored(String testName) {\n-        System.out.println(\"##teamcity[testIgnored name='\" + escapeName(testName) + \"']\");\n+    private static void tcTestIgnored(String testName, String reason) {\n+        System.out.println(\"##teamcity[testIgnored name='\" + escapeName(testName) + \"' \"\n+                + \"message='\" + escapeName(reason) + \"']\");\n@@ -247,1 +248,1 @@\n-                                  List<String> stderrLines, String duration) {\n+                                  List<String> stderrLines, String duration, String skipReason) {\n@@ -251,1 +252,1 @@\n-                private static final Pattern PATTERN = Pattern.compile(\"'\\\\[(?<num>\\\\d+)] (?<name>.*)'\");\n+                private static final Pattern PATTERN = Pattern.compile(\"\\\\[(?<num>\\\\d+)] (?<name>.*)\");\n@@ -272,1 +273,4 @@\n-                \"STARTED\\\\s+(?<class>[A-Za-z0-9._$]+)::(?<method>[A-Za-z0-9._$]+)\\\\s+(?<rest>.*)\");\n+                \"(?<kind>STARTED|SKIPPED)\\\\s+(?<class>[A-Za-z0-9._$]+)::(?<method>[A-Za-z0-9._$]+)\\\\s+'(?<name>[^']+)'(?: (?<reason>.*))?\");\n+\n+        private static final Pattern JUNIT_TEST_END = Pattern.compile(\n+                \"(?<status>SUCCESSFUL|ABORTED|FAILED)\\\\s+\\\\S+ '[^']+' \\\\[(?<milis>\\\\d+)ms]\");\n@@ -288,1 +292,1 @@\n-                    TestMethod.Iteration iteration = TestMethod.Iteration.parse(m.group(\"rest\"));\n+                    TestMethod.Iteration iteration = TestMethod.Iteration.parse(m.group(\"name\"));\n@@ -291,6 +295,22 @@\n-                    do {\n-                        line = itt.next();\n-                        if (line.startsWith(\"JT Harness has limited the test output\")) {\n-                            \/\/ jtharness truncated the output. Discard this result\n-                            \/\/ and look for the next one.\n-                            continue outer;\n+                    TestMethod.Result result;\n+                    String duration = null;\n+                    String skipReason = null;\n+                    String kind = m.group(\"kind\");\n+                    if (kind.equals(\"STARTED\")) {\n+                        Matcher endMatcher;\n+                        do {\n+                            line = itt.next();\n+                            if (line.startsWith(\"JT Harness has limited the test output\")) {\n+                                \/\/ jtharness truncated the output. Discard this result\n+                                \/\/ and look for the next one.\n+                                continue outer;\n+                            }\n+                            stdErr.add(line);\n+                            endMatcher = JUNIT_TEST_END.matcher(line);\n+                        } while (!endMatcher.find());\n+\n+                        String status = endMatcher.group(\"status\");\n+                        if (status.contains(\"FAILED\") || status.contains(\"ABORTED\")) {\n+                            result = TestMethod.Result.FAILED;\n+                        } else {\n+                            result = TestMethod.Result.SUCCESSFUL;\n@@ -298,3 +318,0 @@\n-                        stdErr.add(line);\n-                    } while (!line.contains(\"SUCCESSFUL\") && !line.contains(\"ABORTED\")\n-                            && !line.contains(\"SKIPPED\") && !line.contains(\"FAILED\"));\n@@ -302,5 +319,1 @@\n-                    TestMethod.Result result;\n-                    if (line.contains(\"SKIPPED\")) {\n-                        result = TestMethod.Result.SKIPPED;\n-                    } else if (line.contains(\"FAILED\") || line.contains(\"ABORTED\")) {\n-                        result = TestMethod.Result.FAILED;\n+                        duration = endMatcher.group(\"milis\"); \/\/ may be null for 'SKIPPED'\n@@ -308,1 +321,2 @@\n-                        result = TestMethod.Result.SUCCESSFUL;\n+                        result = TestMethod.Result.SKIPPED;\n+                        skipReason = m.group(\"reason\");\n@@ -311,5 +325,2 @@\n-                    String[] lineParts = line.split(\" \");\n-                    String duration = lineParts[lineParts.length -1]; \/\/ e.g. '[64ms]'\n-                    duration = duration.substring(1, duration.length() - 3); \/\/ drop '[' and 'ms]'\n-\n-                    TestMethod test = new TestMethod(displayTestName, methodName, iteration, result, stdErr, duration);\n+                    TestMethod test = new TestMethod(displayTestName, methodName,\n+                            iteration, result, stdErr, duration, skipReason);\n","filename":"plugins\/idea\/src\/main\/java\/com\/oracle\/plugin\/jtreg\/runtime\/JTRegTestListener.java","additions":39,"deletions":28,"binary":false,"changes":67,"status":"modified"}]}