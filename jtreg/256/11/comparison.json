{"files":[{"patch":"@@ -247,0 +247,4 @@\n+        Path libDir = absTestClsDir;\n+        if (testSuite.getShareLibraries(td)) {\n+            libDir = absBaseClsDir;\n+        }\n@@ -251,1 +255,1 @@\n-                return createLibLocn(lib, absBaseSrcDir, absBaseClsDir);\n+                return createLibLocn(lib, absBaseSrcDir, libDir);\n@@ -259,1 +263,1 @@\n-                            return createLibLocn(lib, extRoot, absBaseClsDir);\n+                            return createLibLocn(lib, extRoot, libDir);\n@@ -286,1 +290,1 @@\n-                return createLibLocn(lib, absTestSrcDir, absBaseClsDir.resolve(relLibDir));\n+                return createLibLocn(lib, absTestSrcDir, libDir.resolve(relLibDir));\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/config\/Locations.java","additions":7,"deletions":3,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -241,0 +241,4 @@\n+    public boolean getShareLibraries(TestDescription td) {\n+        return properties.getShareLibraries(td.getFile());\n+    }\n+\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/config\/RegressionTestSuite.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -146,0 +146,4 @@\n+    boolean getShareLibraries(File file) {\n+        return getEntry(file).shareLibraries;\n+    }\n+\n@@ -223,0 +227,1 @@\n+            final boolean shareLibraries;\n@@ -270,0 +275,3 @@\n+                    \/\/ determine if explicitly compiled libraries should be shared\n+                    shareLibraries = initShareLibraries(parent);\n+\n@@ -300,0 +308,1 @@\n+                    shareLibraries = parent.shareLibraries;\n@@ -509,0 +518,12 @@\n+            private boolean initShareLibraries(Entry parent) {\n+                if (properties.containsKey(\"shareLibraries\")) {\n+                    return properties.getProperty(\"shareLibraries\").equals(\"true\");\n+                }\n+\n+                if (parent != null) {\n+                    return parent.shareLibraries;\n+                }\n+\n+                return false;\n+            }\n+\n","filename":"src\/share\/classes\/com\/sun\/javatest\/regtest\/config\/TestProperties.java","additions":21,"deletions":0,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -257,5 +257,8 @@\n-those classes. A test that relies upon library classes should contain appropriate\n-<code>@build<\/code> directives to ensure that the classes will be compiled.\n-It is strongly recommended that tests do not rely on the use of implicit compilation\n-by the Java compiler. Such an approach is generally fragile, and may lead to\n-incomplete recompilation when a test or library code has been modified.\n+those classes. The library directory is used as an additional sourcepath for test compilation.\n+So jtreg implicitly compiles all test dependencies that are located in a library directory.\n+A test that relies upon library classes in runtime only should contains appropriate\n+<code>@build<\/code> directives to explictily compile classes.\n+This is useful when a test depends on library classes during reflection for example.\n+\n+<p>\n+The implicit usage might cause incomplete recompilation when a test or library code has been modified.\n","filename":"src\/share\/doc\/javatest\/regtest\/tag-spec.html","additions":8,"deletions":5,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -31,1 +31,1 @@\n- * @run main Test Test A LA\n+ * @run main Test Test A LA lib.LA\n@@ -33,1 +33,1 @@\n- * @run main Test Test A B C LA LB LC\n+ * @run main Test Test A B C LA LB LC lib.LA lib.LB lib.LC\n@@ -35,1 +35,1 @@\n- * @run main Test Test A B C LA LB LC p.PA p.LPA\n+ * @run main Test Test A B C LA LB LC p.PA p.LPA lib.LC lib.LA lib.LB lib.p.LPA\n@@ -37,1 +37,1 @@\n- * @run main Test Test A B C LA LB LC p.PA p.PB p.PC p.LPA p.LPB p.LPC\n+ * @run main Test Test A B C LA LB LC p.PA p.PB p.PC p.LPA p.LPB p.LPC lib.LA lib.LB lib.LC lib.p.LPA lib.p.LPB lib.p.LPC\n","filename":"test\/build-wildcards\/tests\/Test.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -72,1 +72,23 @@\n-        TestSuite ts = createTests(base, \"p.*\");\n+        TestSuite ts = createTests(base, \"p.*\", false);\n+        ts.run(base.resolve(\"work\"), base.resolve(\"report\"), ts.dir.resolve(\"std\"));\n+        checkClassFiles(base.resolve(\"work\/classes\"),\n+            \"std\/Test1.d\/lib\/p\/Lib1.class\",\n+            \"std\/Test1.d\/lib\/p\/Lib2.class\",\n+            \"std\/Test2.d\/lib\/p\/Lib1.class\",\n+            \"std\/Test2.d\/lib\/p\/Lib2.class\",\n+            \"std\/Test1.d\/Test1.class\",\n+            \"std\/Test2.d\/Test2.class\"\n+        );\n+    }\n+\n+    \/**\n+     * Verifies the set of expected classes when the tests use\n+     * explicit build tags for library classes.\n+     * The property shareLibraries is set to true.\n+     *\n+     * @param base a directory for the test suite and results\n+     * @throws Exception if an error occurs\n+     *\/\n+    @Test\n+    void testNoImplicitCompilationLegacy(Path base) throws Exception {\n+        TestSuite ts = createTests(base, \"p.*\", true);\n@@ -82,0 +104,1 @@\n+\n@@ -92,1 +115,1 @@\n-        TestSuite ts = createTests(base, \"p.Lib2\");\n+        TestSuite ts = createTests(base, \"p.Lib2\", false);\n@@ -95,2 +118,4 @@\n-            \"lib\/p\/Lib1.class\",\n-            \"lib\/p\/Lib2.class\",\n+            \"std\/Test1.d\/lib\/p\/Lib1.class\",\n+            \"std\/Test1.d\/lib\/p\/Lib2.class\",\n+            \"std\/Test2.d\/lib\/p\/Lib1.class\",\n+            \"std\/Test2.d\/lib\/p\/Lib2.class\",\n@@ -112,1 +137,1 @@\n-        TestSuite ts = createTests(base, null);\n+        TestSuite ts = createTests(base, null, false);\n@@ -133,1 +158,1 @@\n-        TestSuite ts = createTests(base, null);\n+        TestSuite ts = createTests(base, null, false);\n@@ -136,2 +161,2 @@\n-            \"lib\/p\/Lib1.class\",\n-            \"lib\/p\/Lib2.class\",\n+            \"testng\/lib\/p\/Lib1.class\",\n+            \"testng\/lib\/p\/Lib2.class\",\n@@ -153,1 +178,1 @@\n-        TestSuite ts = createTests(base, null);\n+        TestSuite ts = createTests(base, null, false);\n@@ -157,2 +182,4 @@\n-            \"lib\/p\/Lib1.class\",\n-            \"lib\/p\/Lib2.class\",\n+            \"std\/Test1.d\/p\/Lib1.class\",\n+            \"std\/Test1.d\/p\/Lib2.class\",\n+            \"std\/Test2.d\/p\/Lib1.class\",\n+            \"std\/Test2.d\/p\/Lib2.class\",\n@@ -161,0 +188,2 @@\n+            \"testng\/lib\/p\/Lib1.class\",\n+            \"testng\/lib\/p\/Lib2.class\",\n@@ -176,1 +205,1 @@\n-        TestSuite ts = createTests(base, null);\n+        TestSuite ts = createTests(base, null, false);\n@@ -180,2 +209,2 @@\n-            \"lib\/p\/Lib1.class\",\n-            \"lib\/p\/Lib2.class\",\n+            \"testng\/lib\/p\/Lib1.class\",\n+            \"testng\/lib\/p\/Lib2.class\",\n@@ -201,2 +230,3 @@\n-    private TestSuite createTests(Path base, String build) throws Exception {\n-        TestSuite ts = new TestSuite(base.resolve(\"tests\"), \"requiredVersion = 4.2 b08\")\n+    private TestSuite createTests(Path base, String build, boolean shareLibraries) throws Exception {\n+        String shareLibrariesLine = shareLibraries ? \"shareLibraries = true\" : \"\";\n+        TestSuite ts = new TestSuite(base.resolve(\"tests\"), \"requiredVersion = 4.2 b08\\n\" + shareLibrariesLine)\n","filename":"test\/classDirs\/ClassDirsTest.java","additions":47,"deletions":17,"binary":false,"changes":64,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-# Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+# Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -23,2 +23,0 @@\n-\n-JUnit.dirs = .\n\\ No newline at end of file\n","filename":"test\/libs-build-implicit\/TEST.ROOT","additions":1,"deletions":3,"binary":false,"changes":4,"previous_filename":"test\/junitQueryTest\/a\/b\/c\/TEST.properties","status":"copied"},{"patch":"@@ -0,0 +1,32 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+public class LibA {\n+\n+    public static void name() {\n+       \/\/ do nothing\n+     throw new RuntimeException();\n+    }\n+\n+}\n","filename":"test\/libs-build-implicit\/lib\/LibA.java","additions":32,"deletions":0,"binary":false,"changes":32,"status":"added"},{"patch":"@@ -0,0 +1,1 @@\n+\n@@ -22,0 +23,1 @@\n+ *\n@@ -24,1 +26,2 @@\n-package java\/io;\n+public class LibB extends LibA {\n+  public static void main(String args[]) {\n@@ -26,4 +29,2 @@\n-public class IOHelper2\n-    version 58:0\n-{\n-} \/\/ end class IOHelper2\n+  }\n+}\n","filename":"test\/libs-build-implicit\/lib\/LibB.java","additions":6,"deletions":5,"binary":false,"changes":11,"previous_filename":"test\/modlibs\/compileAction\/patch\/java.base\/java\/io\/IOHelper2.jasm","status":"copied"},{"patch":"@@ -0,0 +1,39 @@\n+#\n+# Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+#\n+# This code is free software; you can redistribute it and\/or modify it\n+# under the terms of the GNU General Public License version 2 only, as\n+# published by the Free Software Foundation.  Oracle designates this\n+# particular file as subject to the \"Classpath\" exception as provided\n+# by Oracle in the LICENSE file that accompanied this code.\n+#\n+# This code is distributed in the hope that it will be useful, but WITHOUT\n+# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+# version 2 for more details (a copy is included in the LICENSE file that\n+# accompanied this code).\n+#\n+# You should have received a copy of the GNU General Public License version\n+# 2 along with this work; if not, write to the Free Software Foundation,\n+# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+#\n+# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+# or visit www.oracle.com if you need additional information or have any\n+# questions.\n+#\n+\n+\n+$(BUILDTESTDIR)\/libsBuildImplicit.ok: \\\n+\t$(JTREG_IMAGEDIR)\/lib\/jtreg.jar \\\n+\t$(JTREG_IMAGEDIR)\/bin\/jtreg\n+\t$(RM) $(@:%.ok=%) ; $(MKDIR) $(@:%.ok=%)\n+\t$(JTREG_IMAGEDIR)\/bin\/jtreg $(JTREG_OPTS) \\\n+\t\t-w:$(@:%.ok=%)\/work -r:$(@:%.ok=%)\/report \\\n+\t\t-jdk:$(JDKHOME) \\\n+\t\t$(TESTDIR)\/libs-build-implicit \\\n+\t\t\t> $(@:%.ok=%\/jt.log) 2>&1\n+\techo \"test passed at `date`\" > $@\n+\n+TESTS.jtreg += \\\n+\t$(BUILDTESTDIR)\/libsBuildImplicit.ok\n","filename":"test\/libs-build-implicit\/libsBuildImplicit.gmk","additions":39,"deletions":0,"binary":false,"changes":39,"status":"added"},{"patch":"@@ -0,0 +1,40 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+\n+\/*\n+ * @test\n+ * @summary This test tries to build LibA implicitly and LibB explictitly.\n+ * @library \/lib\n+ * @build Test1\n+ * @run main LibB\n+ * @run main Test1\n+ *\/\n+\n+public class Test1 extends LibA {\n+  public static void main(String args[]) {\n+\n+\n+  }\n+}\n","filename":"test\/libs-build-implicit\/test\/Test1.java","additions":40,"deletions":0,"binary":false,"changes":40,"status":"added"},{"patch":"@@ -0,0 +1,39 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+\n+\/*\n+ * @test\n+ * @summary Test executes LibB that should have been build in 2 steps by Test1\n+ * @library \/lib\n+ * @run main LibB\n+ * @run main Test2\n+ *\/\n+\n+public class Test2 {\n+  public static void main(String args[]) {\n+\n+\n+  }\n+}\n","filename":"test\/libs-build-implicit\/test\/Test2.java","additions":39,"deletions":0,"binary":false,"changes":39,"status":"added"},{"patch":"@@ -0,0 +1,8 @@\n+.\/classes\/buildAction\/BuildLibPatch.d\/libs\/patchmods\/java.base\/java\/util\/streams\/StreamsHelper.class\n+.\/classes\/buildAction\/BuildLibPkg.d\/libs\/packages\/lp\/lp_C.class\n+.\/classes\/buildAction\/BuildLibUserModClass.d\/libs\/usermods\/lum1\/lum1_p1\/lum1_p1_C.class\n+.\/classes\/buildAction\/BuildLibUserModClass.d\/libs\/usermods\/lum1\/module-info.class\n+.\/classes\/buildAction\/BuildLibUserModClasses.d\/libs\/usermods\/lum2\/lum2_p1\/lum2_p1_C.class\n+.\/classes\/buildAction\/BuildLibUserModClasses.d\/libs\/usermods\/lum2\/module-info.class\n+.\/classes\/buildAction\/BuildLibUserModClasses.d\/libs\/usermods\/lum3\/lum3_p1\/lum3_p1_C.class\n+.\/classes\/buildAction\/BuildLibUserModClasses.d\/libs\/usermods\/lum3\/module-info.class\n@@ -26,8 +34,0 @@\n-.\/classes\/libs\/packages\/lp\/lp_C.class\n-.\/classes\/libs\/patchmods\/java.base\/java\/util\/streams\/StreamsHelper.class\n-.\/classes\/libs\/usermods\/lum1\/lum1_p1\/lum1_p1_C.class\n-.\/classes\/libs\/usermods\/lum1\/module-info.class\n-.\/classes\/libs\/usermods\/lum2\/lum2_p1\/lum2_p1_C.class\n-.\/classes\/libs\/usermods\/lum2\/module-info.class\n-.\/classes\/libs\/usermods\/lum3\/lum3_p1\/lum3_p1_C.class\n-.\/classes\/libs\/usermods\/lum3\/module-info.class\n@@ -38,0 +38,2 @@\n+.\/classes\/mainAction\/usermods\/UseUserModAsLib.d\/libs\/usermods\/lum1\/lum1_p1\/lum1_p1_C.class\n+.\/classes\/mainAction\/usermods\/UseUserModAsLib.d\/libs\/usermods\/lum1\/module-info.class\n","filename":"test\/modlibs\/expect-classes.txt","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"}]}