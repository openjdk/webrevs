{"files":[{"patch":"@@ -49,0 +49,2 @@\n+    public static final String TIME_BUDGET_SWITCH = \"tb\";\n+\n@@ -96,1 +98,1 @@\n-                \"Larger value increases cache footprint.\")\n+                 \"Larger value increases cache footprint.\")\n@@ -147,1 +149,1 @@\n-        OptionSpec<TimeValue> optTimeBudget = parser.accepts(\"tb\", \"Time budget to run the tests. Harness code would try to fit the entire \" +\n+        OptionSpec<TimeValue> optTimeBudget = parser.accepts(TIME_BUDGET_SWITCH, \"Time budget to run the tests. Harness code would try to fit the entire \" +\n@@ -153,1 +155,1 @@\n-        parser.accepts(\"v\", \"Be verbose.\");\n+        parser.accepts(\"v\", \"Be verbose. Will print known properties in help\");\n@@ -164,1 +166,1 @@\n-            parser.printHelpOn(System.err);\n+            printHelp(parser, System.err);\n@@ -167,0 +169,1 @@\n+        setVerbosity(set);\n@@ -169,1 +172,1 @@\n-            parser.printHelpOn(System.out);\n+            printHelp(parser, System.out);\n@@ -188,9 +191,0 @@\n-        if (set.has(\"vvv\")) {\n-            this.verbosity = new Verbosity(3);\n-        } else if (set.has(\"vv\")) {\n-            this.verbosity = new Verbosity(2);\n-        } else if (set.has(\"v\")) {\n-            this.verbosity = new Verbosity(1);\n-        } else {\n-            this.verbosity = new Verbosity(0);\n-        }\n@@ -204,1 +198,1 @@\n-            parser.printHelpOn(System.err);\n+            printHelp(parser, System.err);\n@@ -230,1 +224,1 @@\n-            parser.printHelpOn(System.err);\n+            printHelp(parser, System.err);\n@@ -237,1 +231,1 @@\n-            parser.printHelpOn(System.err);\n+            printHelp(parser, System.err);\n@@ -244,1 +238,1 @@\n-            parser.printHelpOn(System.err);\n+            printHelp(parser, System.err);\n@@ -266,0 +260,20 @@\n+    private void setVerbosity(OptionSet set) {\n+        if (set.has(\"vvv\")) {\n+            this.verbosity = new Verbosity(3);\n+        } else if (set.has(\"vv\")) {\n+            this.verbosity = new Verbosity(2);\n+        } else if (set.has(\"v\")) {\n+            this.verbosity = new Verbosity(1);\n+        } else {\n+            this.verbosity = new Verbosity(0);\n+        }\n+    }\n+\n+    private void printHelp(OptionParser parser, PrintStream ouer) throws IOException {\n+        parser.printHelpOn(ouer);\n+        ouer.println();\n+        if (verbosity != null && verbosity.printAllTests()) {\n+            UsedProperties.printHelpOn(ouer);\n+        }\n+    }\n+\n@@ -300,1 +314,1 @@\n-        out.printf(\"    Forks per test: %d normal, %d stress%n\", getForks(), getForks()*getForksStressMultiplier());\n+        out.printf(\"    Forks per test: %d normal, %d stress%n\", getForks(), getForks() * getForksStressMultiplier());\n@@ -395,1 +409,3 @@\n-    public TimeValue timeBudget() { return timeBudget; }\n+    public TimeValue timeBudget() {\n+        return timeBudget;\n+    }\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/Options.java","additions":36,"deletions":20,"binary":false,"changes":56,"status":"modified"},{"patch":"@@ -37,3 +37,3 @@\n-    static final int DEFAULT_PER_TEST_MS = Integer.getInteger(\"jcstress.timeBudget.defaultPerTestMs\", 3000);\n-    static final int MIN_TIME_MS = Integer.getInteger(\"jcstress.timeBudget.minTimeMs\", 30);\n-    static final int MAX_TIME_MS = Integer.getInteger(\"jcstress.timeBudget.maxTimeMs\", 60_000);\n+    static final int DEFAULT_PER_TEST_MS =  UsedProperties.getJcstressTimeBudgetDefaultPerTestMs();\n+    static final int MIN_TIME_MS = UsedProperties.getJcstressTimeBudgetMinTimeMs();\n+    static final int MAX_TIME_MS = UsedProperties.getJcstressTimeBudgetMaxTimeMs();\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/TimeBudget.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -0,0 +1,245 @@\n+\/*\n+ * Copyright (c) 2005, 2014, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package org.openjdk.jcstress;\n+\n+import java.io.PrintStream;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+\n+\/**\n+ * Known Properties affecting JCStress. Some of them publicly document themselves, some do not need to.\n+ *\/\n+public class UsedProperties {\n+\n+    private static abstract class JcstressProperty<T> {\n+        private final String key;\n+        private final List<T> defaults;\n+\n+        public JcstressProperty(String key, T[] defaults) {\n+            this.key = key;\n+            this.defaults = Collections.unmodifiableList(Arrays.asList(defaults));\n+        }\n+\n+        public String getKey() {\n+            return key;\n+        }\n+\n+        public List<T> getDefaults() {\n+            return defaults;\n+        }\n+\n+        public T getDefault() {\n+            return defaults.get(0);\n+        }\n+\n+        public boolean isCustom(){\n+            return System.getProperty(getKey()) != null;\n+        }\n+\n+        public abstract String getDescription();\n+\n+        public abstract T getValue();\n+    }\n+\n+    private static abstract class IntJcstressProperty extends JcstressProperty<Integer> {\n+\n+        public IntJcstressProperty(String key, Integer... defaults) {\n+            super(key, defaults);\n+        }\n+\n+        @Override\n+        public Integer getValue() {\n+            return Integer.getInteger(getKey(), getDefault());\n+        }\n+    }\n+\n+    private static abstract class LongJcstressProperty extends JcstressProperty<Long> {\n+\n+        public LongJcstressProperty(String key, Long... defaults) {\n+            super(key, defaults);\n+        }\n+\n+        @Override\n+        public Long getValue() {\n+            return Long.getLong(getKey(), getDefault());\n+        }\n+    }\n+\n+\n+    private static abstract class StringJcstressProperty extends JcstressProperty<String> {\n+\n+        public StringJcstressProperty(String key, String... defaults) {\n+            super(key, defaults);\n+        }\n+\n+        @Override\n+        public String getValue() {\n+            return System.getProperty(getKey(), getDefault());\n+        }\n+    }\n+\n+    private static final IntJcstressProperty TIMEBUDGET_DEFAULTPERTESTMS = new IntJcstressProperty(\"jcstress.timeBudget.defaultPerTestMs\", 3000) {\n+        @Override\n+        public String getDescription() {\n+            return getKey() + \" set default time the individual test executes. Defaults to \" + getDefault() +\n+                    \"ms set to \" + getValue() + \"ms\";\n+        }\n+    };\n+\n+    private static final IntJcstressProperty TIMEBUDGET_MINTIMEMS = new IntJcstressProperty(\"jcstress.timeBudget.minTimeMs\", 30) {\n+        @Override\n+        public String getDescription() {\n+            return getKey() + \" set minimal time the individual test executes. Defaults to \" + getDefault() +\n+                    \"ms set to \" + getValue() + \"ms\";\n+        }\n+    };\n+\n+    private static final IntJcstressProperty TIMEBUDGET_MAXTIMEMS = new IntJcstressProperty(\"jcstress.timeBudget.maxTimeMs\", 60_000) {\n+        @Override\n+        public String getDescription() {\n+            return getKey() +\n+                    \" set maximum time the individual test executes. Defaults to \" + getDefault() +\n+                    \"ms set to \" + getValue() + \"ms\";\n+        }\n+    };\n+\n+    private static final String TIMEBUDGET_ADDITIONAL_COMMENT = \"The time each test is run is (simplified) calculated as value of \" + Options.TIME_BUDGET_SWITCH + \" switch divided by number of tests (after all filters applied)\" +\n+            \" If te resulting time is smaller then \" + TIMEBUDGET_MINTIMEMS.getKey() + \", it is used.  If it si bigger then \" + TIMEBUDGET_MAXTIMEMS.getKey() + \" it is used. If no \" + Options.TIME_BUDGET_SWITCH + \"  is set,\" +\n+            \" then \" + TIMEBUDGET_DEFAULTPERTESTMS.getKey() + \" is used. See \" + Options.TIME_BUDGET_SWITCH + \" for more info. Properties do not accept unit suffixes.\";\n+\n+    private static final StringJcstressProperty LINK_ADDRESS = new StringJcstressProperty(\"jcstress.link.address\", new String[]{null}) {\n+        @Override\n+        public String getDescription() {\n+            return getKey() + \" is address where to connect to forked VMs. Defaults to loop-back. Set to '\" + getListenAddressForInfo() + \"'\";\n+        }\n+    };\n+\n+\n+    private static final IntJcstressProperty LINK_PORT = new IntJcstressProperty(\"jcstress.link.port\", 0) {\n+        @Override\n+        public String getDescription() {\n+            return getKey() + \" is port where to connect to forked VMs on \" + LINK_ADDRESS.getKey() + \". Defaults to \" + getDefault() + \" (random free port).\" +\n+                    \" Set to \" + getJcstressLinkPort();\n+        }\n+    };\n+\n+    private static final IntJcstressProperty LINK_TIMEOUTMS = new IntJcstressProperty(\"jcstress.link.timeoutMs\", 30 * 1000) {\n+        @Override\n+        public String getDescription() {\n+            return getKey() + \" set timeout to forked VM communication ms.\" +\n+                    \" Defaults to \" + getDefault() + \"ms. Set to \" + getValue() + \"ms.\";\n+        }\n+    };\n+\n+    private static final LongJcstressProperty CONSOLE_PRINTINTERVALMS = new LongJcstressProperty(\"jcstress.console.printIntervalMs\", 1_000L, 15_000L) {\n+\n+        @Override\n+        public Long getValue() {\n+            return Long.getLong(getKey(), null);\n+        }\n+\n+        @Override\n+        public String getDescription() {\n+            return getKey() + \" sets interval how often to print results to console in ms. Have two defaults: \" +\n+                    getDefaults().get(0) + \"ms in interactive mode and \" +\n+                    getDefaults().get(1) + \"ms in noninteractive mode. Set to \" +\n+                    getPrintIntervalMs() + \"ms\";\n+        }\n+    };\n+\n+    public static int getJcstressTimeBudgetDefaultPerTestMs() {\n+        return TIMEBUDGET_DEFAULTPERTESTMS.getValue();\n+    }\n+\n+    public static int getJcstressTimeBudgetMinTimeMs() {\n+        return TIMEBUDGET_MINTIMEMS.getValue();\n+    }\n+\n+    public static int getJcstressTimeBudgetMaxTimeMs() {\n+        return TIMEBUDGET_MAXTIMEMS.getValue();\n+    }\n+\n+    private static String getJcstressLinkAddress() {\n+        return LINK_ADDRESS.getValue();\n+    }\n+\n+    private static String getListenAddressForInfo() {\n+        try {\n+            return getListenAddress().toString();\n+        } catch (Exception ex) {\n+            return ex.getMessage();\n+        }\n+    }\n+\n+    public static InetAddress getListenAddress() {\n+        \/\/ Try to use user-provided override first.\n+        if (getJcstressLinkAddress() != null) {\n+            try {\n+                return InetAddress.getByName(getJcstressLinkAddress());\n+            } catch (UnknownHostException e) {\n+                \/\/ override failed, notify user\n+                throw new IllegalStateException(\"Can not initialize binary link.\", e);\n+            }\n+        }\n+\n+        return InetAddress.getLoopbackAddress();\n+    }\n+\n+    public static int getJcstressLinkPort() {\n+        return LINK_PORT.getValue();\n+    }\n+\n+\n+    public static int getJcstressLinkTimeoutMs() {\n+        return LINK_TIMEOUTMS.getValue();\n+    }\n+\n+    public static boolean isProgressInteractive() {\n+        return System.console() != null;\n+    }\n+\n+    public static long getPrintIntervalMs() {\n+        return (CONSOLE_PRINTINTERVALMS.isCustom()) ?\n+                CONSOLE_PRINTINTERVALMS.getValue() :\n+                isProgressInteractive() ? CONSOLE_PRINTINTERVALMS.getDefaults().get(0) : CONSOLE_PRINTINTERVALMS.getDefaults().get(1);\n+    }\n+\n+    public static void printHelpOn(PrintStream ouer) {\n+        ouer.println(\"JCStress recognize several internal properties:\");\n+        ouer.println(\"  \" + TIMEBUDGET_DEFAULTPERTESTMS.getDescription());\n+        ouer.println(\"  \" + TIMEBUDGET_MINTIMEMS.getDescription());\n+        ouer.println(\"  \" + TIMEBUDGET_MAXTIMEMS.getDescription());\n+        ouer.println(\"  \" + TIMEBUDGET_ADDITIONAL_COMMENT);\n+        ouer.println(\"  \" + LINK_ADDRESS.getDescription());\n+        ouer.println(\"  \" + LINK_PORT.getDescription());\n+        ouer.println(\"  \" + LINK_TIMEOUTMS.getDescription());\n+        ouer.println(\"  \" + CONSOLE_PRINTINTERVALMS.getDescription());\n+\n+\n+    }\n+}\n\\ No newline at end of file\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/UsedProperties.java","additions":245,"deletions":0,"binary":false,"changes":245,"status":"added"},{"patch":"@@ -30,0 +30,1 @@\n+import org.openjdk.jcstress.UsedProperties;\n@@ -46,2 +47,0 @@\n-    private static final Integer PRINT_INTERVAL_MS = Integer.getInteger(\"jcstress.console.printIntervalMs\");\n-\n@@ -83,1 +82,1 @@\n-        progressInteractive = (System.console() != null);\n+        progressInteractive = UsedProperties.isProgressInteractive();\n@@ -87,3 +86,1 @@\n-        printIntervalMs = (PRINT_INTERVAL_MS != null) ?\n-                PRINT_INTERVAL_MS :\n-                progressInteractive ? 1_000 : 15_000;\n+        printIntervalMs = UsedProperties.getPrintIntervalMs();\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/infra\/grading\/ConsoleReportPrinter.java","additions":3,"deletions":6,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import org.openjdk.jcstress.UsedProperties;\n@@ -35,1 +36,1 @@\n-    private static final int LINK_TIMEOUT_MS = Integer.getInteger(\"jcstress.link.timeoutMs\", 30 * 1000);\n+    private static final int LINK_TIMEOUT_MS = UsedProperties.getJcstressLinkTimeoutMs();\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/link\/BinaryLinkClient.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import org.openjdk.jcstress.UsedProperties;\n@@ -40,3 +41,2 @@\n-    private static final String LINK_ADDRESS = System.getProperty(\"jcstress.link.address\");\n-    private static final int LINK_PORT = Integer.getInteger(\"jcstress.link.port\", 0);\n-    private static final int LINK_TIMEOUT_MS = Integer.getInteger(\"jcstress.link.timeoutMs\", 30 * 1000);\n+    private static final int LINK_PORT = UsedProperties.getJcstressLinkPort();\n+    private static final int LINK_TIMEOUT_MS = UsedProperties.getJcstressLinkTimeoutMs();\n@@ -52,1 +52,1 @@\n-        listenAddress = getListenAddress();\n+        listenAddress = UsedProperties.getListenAddress();\n@@ -60,10 +60,0 @@\n-    private InetAddress getListenAddress() {\n-        \/\/ Try to use user-provided override first.\n-        if (LINK_ADDRESS != null) {\n-            try {\n-                return InetAddress.getByName(LINK_ADDRESS);\n-            } catch (UnknownHostException e) {\n-                \/\/ override failed, notify user\n-                throw new IllegalStateException(\"Can not initialize binary link.\", e);\n-            }\n-        }\n@@ -71,2 +61,0 @@\n-        return InetAddress.getLoopbackAddress();\n-    }\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/link\/BinaryLinkServer.java","additions":4,"deletions":16,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -38,1 +38,1 @@\n-        sb.append(\"Usage: java -jar jcstress.jar [options]\");\n+        sb.append(\"Usage: java [properties] -jar jcstress.jar [options]\");\n","filename":"jcstress-core\/src\/main\/java\/org\/openjdk\/jcstress\/util\/OptionFormatter.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}