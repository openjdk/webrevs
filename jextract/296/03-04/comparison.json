{"files":[{"patch":"@@ -71,2 +71,0 @@\n-    private static final int NO_ALIGN_REQUIRED_MARKER = -1;\n-\n@@ -207,1 +205,1 @@\n-        return fieldLayoutString(type, -1, NO_ALIGN_REQUIRED_MARKER);\n+        return layoutString(type, Long.MAX_VALUE);\n@@ -210,1 +208,1 @@\n-    String fieldLayoutString(Type type, long typeAlign, long expectedAlign) {\n+    String layoutString(Type type, long align) {\n@@ -212,11 +210,7 @@\n-            case Primitive p -> primitiveLayoutString(p, typeAlign, expectedAlign);\n-            case Declared d when Utils.isEnum(d) ->\n-                   fieldLayoutString(ClangEnumType.get(d.tree()).get(), typeAlign, expectedAlign);\n-            case Declared d when Utils.isStructOrUnion(d) ->\n-                    alignIfNeeded(JavaName.getFullNameOrThrow(d.tree()) + \".layout()\", typeAlign, expectedAlign);\n-            case Delegated d when d.kind() == Delegated.Kind.POINTER ->\n-                    alignIfNeeded(runtimeHelperName() + \".C_POINTER\", typeAlign, expectedAlign);\n-            case Delegated d -> fieldLayoutString(d.type(), typeAlign, expectedAlign);\n-            case Function _ -> alignIfNeeded(runtimeHelperName() + \".C_POINTER\", typeAlign, expectedAlign);\n-            case Array a -> String.format(\"MemoryLayout.sequenceLayout(%1$d, %2$s)\", a.elementCount().orElse(0L),\n-                    fieldLayoutString(a.elementType(), typeAlign, expectedAlign));\n+            case Primitive p -> primitiveLayoutString(p, align);\n+            case Declared d when Utils.isEnum(d) -> layoutString(ClangEnumType.get(d.tree()).get(), align);\n+            case Declared d when Utils.isStructOrUnion(d) -> alignIfNeeded(JavaName.getFullNameOrThrow(d.tree()) + \".layout()\", ClangAlignOf.getOrThrow(d.tree()) \/ 8, align);\n+            case Delegated d when d.kind() == Delegated.Kind.POINTER -> alignIfNeeded(runtimeHelperName() + \".C_POINTER\", 8, align);\n+            case Delegated d -> layoutString(d.type(), align);\n+            case Function _ -> alignIfNeeded(runtimeHelperName() + \".C_POINTER\", 8, align);\n+            case Array a -> String.format(\"MemoryLayout.sequenceLayout(%1$d, %2$s)\", a.elementCount().orElse(0L), layoutString(a.elementType(), align));\n@@ -259,1 +253,1 @@\n-    private String primitiveLayoutString(Primitive primitiveType, long defaultAlign, long expectedAlign) {\n+    private String primitiveLayoutString(Primitive primitiveType, long align) {\n@@ -261,8 +255,8 @@\n-            case Bool -> alignIfNeeded(runtimeHelperName() + \".C_BOOL\", defaultAlign, expectedAlign);\n-            case Char -> alignIfNeeded(runtimeHelperName() + \".C_CHAR\", defaultAlign, expectedAlign);\n-            case Short -> alignIfNeeded(runtimeHelperName() + \".C_SHORT\", defaultAlign, expectedAlign);\n-            case Int -> alignIfNeeded(runtimeHelperName() + \".C_INT\", defaultAlign, expectedAlign);\n-            case Long -> alignIfNeeded(runtimeHelperName() + \".C_LONG\", defaultAlign, expectedAlign);\n-            case LongLong -> alignIfNeeded(runtimeHelperName() + \".C_LONG_LONG\", defaultAlign, expectedAlign);\n-            case Float -> alignIfNeeded(runtimeHelperName() + \".C_FLOAT\", defaultAlign, expectedAlign);\n-            case Double -> alignIfNeeded(runtimeHelperName() + \".C_DOUBLE\", defaultAlign, expectedAlign);\n+            case Bool -> runtimeHelperName() + \".C_BOOL\";\n+            case Char -> runtimeHelperName() + \".C_CHAR\";\n+            case Short -> alignIfNeeded(runtimeHelperName() + \".C_SHORT\", 2, align);\n+            case Int -> alignIfNeeded(runtimeHelperName() + \".C_INT\", 4, align);\n+            case Long -> alignIfNeeded(runtimeHelperName() + \".C_LONG\", TypeImpl.IS_WINDOWS ? 4 : 8, align);\n+            case LongLong -> alignIfNeeded(runtimeHelperName() + \".C_LONG_LONG\", 8, align);\n+            case Float -> alignIfNeeded(runtimeHelperName() + \".C_FLOAT\", 4, align);\n+            case Double -> alignIfNeeded(runtimeHelperName() + \".C_DOUBLE\", TypeImpl.IS_AIX ? 4 : 8, align);\n@@ -270,1 +264,1 @@\n-                    alignIfNeeded(runtimeHelperName() + \".C_LONG_DOUBLE\", defaultAlign, expectedAlign) :\n+                    alignIfNeeded(runtimeHelperName() + \".C_LONG_DOUBLE\", 8, align) :\n@@ -278,2 +272,2 @@\n-    private String alignIfNeeded(String layoutPrefix, long defaultAlign, long expectedAlign) {\n-        return expectedAlign != NO_ALIGN_REQUIRED_MARKER && defaultAlign != expectedAlign ?\n+    private String alignIfNeeded(String layoutPrefix, long align, long expectedAlign) {\n+        return align > expectedAlign ?\n","filename":"src\/main\/java\/org\/openjdk\/jextract\/impl\/ClassSourceBuilder.java","additions":21,"deletions":27,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -488,1 +488,1 @@\n-                    memberLayout = fieldLayoutString(var.type(), fieldTypeAlign, expectedAlign);\n+                    memberLayout = layoutString(var.type(), expectedAlign);\n","filename":"src\/main\/java\/org\/openjdk\/jextract\/impl\/StructBuilder.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}