{"files":[{"patch":"@@ -148,2 +148,2 @@\n-                emitFieldArrayGetter(javaName, varTree, arrayHandle, indexList);\n-                emitFieldArraySetter(javaName, varTree, arrayHandle, indexList);\n+                emitFieldArrayGetter(javaName, varTree, arrayHandle, offsetField, indexList);\n+                emitFieldArraySetter(javaName, varTree, arrayHandle, offsetField, indexList);\n@@ -253,1 +253,1 @@\n-    private void emitFieldArrayGetter(String javaName, Declaration.Variable varTree, String arrayElementHandle, IndexList indexList) {\n+    private void emitFieldArrayGetter(String javaName, Declaration.Variable varTree, String arrayElementHandle, String offsetField, IndexList indexList) {\n@@ -263,1 +263,1 @@\n-                        return (MemorySegment)%4$s.invokeExact(%2$s, 0L, %5$s);\n+                        return (MemorySegment)%4$s.invokeExact(%2$s, %5$s, %6$s);\n@@ -270,1 +270,1 @@\n-                \"\"\", javaName, segmentParam, indexList.decl(), arrayElementHandle, indexList.use());\n+                \"\"\", javaName, segmentParam, indexList.decl(), arrayElementHandle, offsetField, indexList.use());\n@@ -274,1 +274,1 @@\n-                    return (%1$s)%5$s.get(%3$s, 0L, %6$s);\n+                    return (%1$s)%5$s.get(%3$s, %6$s, %7$s);\n@@ -277,1 +277,1 @@\n-                   ,indexList.decl(), arrayElementHandle, indexList.use());\n+                   ,indexList.decl(), arrayElementHandle, offsetField, indexList.use());\n@@ -281,1 +281,1 @@\n-    private void emitFieldArraySetter(String javaName, Declaration.Variable varTree, String arrayElementHandle, IndexList indexList) {\n+    private void emitFieldArraySetter(String javaName, Declaration.Variable varTree, String arrayElementHandle, String offsetField, IndexList indexList) {\n@@ -298,1 +298,1 @@\n-                    %6$s.set(%2$s, 0L, %7$s, %5$s);\n+                    %6$s.set(%2$s, %7$s, %8$s, %5$s);\n@@ -301,1 +301,1 @@\n-                   ,valueParam, arrayElementHandle, indexList.use());\n+                   ,valueParam, arrayElementHandle, offsetField, indexList.use());\n","filename":"src\/main\/java\/org\/openjdk\/jextract\/impl\/StructBuilder.java","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -0,0 +1,190 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.lang.foreign.Arena;\n+import java.lang.foreign.MemorySegment;\n+import org.testng.annotations.Test;\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertTrue;\n+import static org.testng.Assert.assertFalse;\n+import test.jextract.testStructArrayFields.*;\n+\n+\/*\n+ * @test\n+ * @library \/lib\n+ * @build testlib.TestUtils\n+ * @run main\/othervm JtregJextract -l TestStructArrayFields --use-system-load-library -t test.jextract.testStructArrayFields testStructArrayFields.h\n+ * @build TestStructArrayFields\n+ * @run testng\/othervm --enable-native-access=ALL-UNNAMED TestStructArrayFields\n+ *\/\n+public class TestStructArrayFields {\n+    @Test\n+    void testStructArrayNoClobber() {\n+        try (Arena arena = Arena.ofConfined()) {\n+            MemorySegment rec = Record_st.allocate(arena);\n+\n+            Record_st.a(rec, 0x11111111);\n+            Record_st.b(rec, 0x22222222);\n+\n+            Record_st.arr(rec, 0, 10);\n+            Record_st.arr(rec, 1, 20);\n+            Record_st.arr(rec, 2, 30);\n+\n+            assertEquals(0x11111111, Record_st.a(rec));\n+            assertEquals(0x22222222, Record_st.b(rec));\n+            assertEquals(10, Record_st.arr(rec, 0));\n+            assertEquals(20, Record_st.arr(rec, 1));\n+            assertEquals(30, Record_st.arr(rec, 2));\n+        }\n+    }\n+\n+    @Test\n+    void testUnionArrayNoClobber() {\n+        try (Arena arena = Arena.ofConfined()) {\n+            MemorySegment rec = Record_st.allocate(arena);\n+\n+            Record_st.a(rec, 0xAAAAAAAA);\n+            Record_st.b(rec, 0xBBBBBBBB);\n+            Record_st.tail(rec, 0x7F7F7F7F);\n+            Record_st.flag(rec, false);\n+\n+            MemorySegment u = Record_st.u(rec);\n+\n+            InnerU.ua(u, 0, 101);\n+            InnerU.ua(u, 1, 202);\n+            InnerU.ua(u, 2, 303);\n+\n+            assertEquals(0xAAAAAAAA, Record_st.a(rec));\n+            assertEquals(0xBBBBBBBB, Record_st.b(rec));\n+            assertEquals(0x7F7F7F7F, Record_st.tail(rec));\n+            assertFalse(Record_st.flag(rec));\n+\n+            assertEquals(101, InnerU.ua(u, 0));\n+            assertEquals(202, InnerU.ua(u, 1));\n+            assertEquals(303, InnerU.ua(u, 2));\n+        }\n+    }\n+\n+    @Test\n+    void testUnionStructSlice() {\n+        try (Arena arena = Arena.ofConfined()) {\n+            MemorySegment rec = Record_st.allocate(arena);\n+            MemorySegment u = Record_st.u(rec);\n+\n+            MemorySegment is = InnerU.is(u);\n+\n+            InnerS.s(is, (short) 0x1234);\n+            InnerS.c(is, (byte) 0x7F);\n+\n+            Record_st.tail(rec, 0x01020304);\n+            Record_st.flag(rec, true);\n+\n+            assertEquals((short) 0x1234, InnerS.s(is));\n+            assertEquals((byte) 0x7F, InnerS.c(is));\n+\n+            assertEquals(0x01020304, Record_st.tail(rec));\n+            assertTrue(Record_st.flag(rec));\n+        }\n+    }\n+\n+    @Test\n+    void testOffsetsAndSizes() {\n+        long offA = Record_st.a$offset();\n+        long offB = Record_st.b$offset();\n+        long offArr = Record_st.arr$offset();\n+        long offU = Record_st.u$offset();\n+        long offTail = Record_st.tail$offset();\n+        long offFlag = Record_st.flag$offset();\n+\n+        assertTrue(offA < offB);\n+        assertTrue(offB < offArr);\n+        assertTrue(offArr < offU);\n+        assertTrue(offU < offTail);\n+        assertTrue(offTail < offFlag);\n+\n+        assertEquals(3L * Integer.BYTES, Record_st.arr$layout().byteSize());\n+        assertEquals(3L * Integer.BYTES, InnerU.ua$layout().byteSize());\n+    }\n+\n+    @Test\n+    void testStructOfStructArrayNoClobber() {\n+        try (Arena arena = Arena.ofConfined()) {\n+            MemorySegment rec = Record_st.allocate(arena);\n+\n+            Record_st.a(rec, 0x11111111);\n+            Record_st.b(rec, 0x22222222);\n+            Record_st.tail(rec, 0x7F7F7F7F);\n+            Record_st.flag(rec, false);\n+\n+            MemorySegment sa0 = Record_st.sa(rec, 0);\n+            MemorySegment sa1 = Record_st.sa(rec, 1);\n+\n+            InnerS.s(sa0, (short) 0x1234);\n+            InnerS.c(sa0, (byte) 0x55);\n+            InnerS.s(sa1, (short) 0xABCD);\n+            InnerS.c(sa1, (byte) 0x7F);\n+\n+            assertEquals(0x11111111, Record_st.a(rec));\n+            assertEquals(0x22222222, Record_st.b(rec));\n+            assertEquals(0x7F7F7F7F, Record_st.tail(rec));\n+            assertFalse(Record_st.flag(rec));\n+\n+            assertEquals((short) 0x1234, InnerS.s(sa0));\n+            assertEquals((byte) 0x55, InnerS.c(sa0));\n+            assertEquals((short) 0xABCD, InnerS.s(sa1));\n+            assertEquals((byte) 0x7F, InnerS.c(sa1));\n+        }\n+    }\n+\n+    @Test\n+    void testUnionStructArrayNoClobber() {\n+        try (Arena arena = Arena.ofConfined()) {\n+            MemorySegment rec = Record_st.allocate(arena);\n+\n+            Record_st.a(rec, 0xAAAAAAAA);\n+            Record_st.b(rec, 0xBBBBBBBB);\n+            Record_st.tail(rec, 0x01020304);\n+            Record_st.flag(rec, true);\n+\n+            MemorySegment u = Record_st.u(rec);\n+\n+            MemorySegment ia0 = InnerU.ia(u, 0);\n+            MemorySegment ia1 = InnerU.ia(u, 1);\n+\n+            InnerS.s(ia0, (short) 0x0001);\n+            InnerS.c(ia0, (byte) 0x11);\n+            InnerS.s(ia1, (short) 0x0002);\n+            InnerS.c(ia1, (byte) 0x22);\n+\n+            assertEquals(0xAAAAAAAA, Record_st.a(rec));\n+            assertEquals(0xBBBBBBBB, Record_st.b(rec));\n+            assertEquals(0x01020304, Record_st.tail(rec));\n+            assertTrue(Record_st.flag(rec));\n+\n+            assertEquals((short) 0x0001, InnerS.s(ia0));\n+            assertEquals((byte) 0x11, InnerS.c(ia0));\n+            assertEquals((short) 0x0002, InnerS.s(ia1));\n+            assertEquals((byte) 0x22, InnerS.c(ia1));\n+        }\n+    }\n+}\n","filename":"test\/jtreg\/generator\/testStructArrayFields\/TestStructArrayFields.java","additions":190,"deletions":0,"binary":false,"changes":190,"status":"added"},{"patch":"@@ -0,0 +1,45 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+typedef struct InnerS {\n+    short s;\n+    char  c;\n+} InnerS;\n+\n+typedef union InnerU {\n+    int      ui;\n+    float    uf;\n+    int      ua[3];\n+    InnerS   is;\n+    InnerS   ia[2];\n+} InnerU;\n+\n+typedef struct Record_st {\n+    int    a;\n+    int    b;\n+    int    arr[3];\n+    InnerS sa[2];\n+    InnerU u;\n+    int    tail;\n+    _Bool  flag;\n+} Record_st;\n\\ No newline at end of file\n","filename":"test\/jtreg\/generator\/testStructArrayFields\/testStructArrayFields.h","additions":45,"deletions":0,"binary":false,"changes":45,"status":"added"}]}