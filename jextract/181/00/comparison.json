{"files":[{"patch":"@@ -81,0 +81,1 @@\n+            import static java.lang.foreign.MemoryLayout.PathElement.*;\n","filename":"src\/main\/java\/org\/openjdk\/jextract\/impl\/SourceFileBuilder.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -142,2 +142,3 @@\n-            emitFieldGetter(javaName, varTree, offsetField);\n-            emitFieldSetter(javaName, varTree, offsetField);\n+            String layoutField = emitLayoutFieldDecl(varTree);\n+            emitFieldGetter(javaName, varTree, layoutField, offsetField);\n+            emitFieldSetter(javaName, varTree, layoutField, offsetField);\n@@ -149,0 +150,17 @@\n+    private List<String> prefixNamesList() {\n+        return nestedAnonDeclarations.stream()\n+                .map(d -> AnonymousStruct.anonName((Declaration.Scoped)d))\n+                .toList().reversed();\n+    }\n+\n+    private String fieldElementPaths(String nativeName) {\n+        StringBuilder builder = new StringBuilder();\n+        String prefix = \"\";\n+        for (String prefixElementName : prefixNamesList()) {\n+            builder.append(prefix + \"groupElement(\\\"\" + prefixElementName + \"\\\")\");\n+            prefix = \", \";\n+        }\n+        builder.append(prefix + \"groupElement(\\\"\" + nativeName + \"\\\")\");\n+        return builder.toString();\n+    }\n+\n@@ -155,1 +173,1 @@\n-    private void emitFieldGetter(String javaName, Declaration.Variable varTree, String offsetField) {\n+    private void emitFieldGetter(String javaName, Declaration.Variable varTree, String layoutField, String offsetField) {\n@@ -162,1 +180,1 @@\n-                return \\{seg}.get(\\{layoutString(varTree.type())}, \\{offsetField});\n+                return \\{seg}.get(\\{layoutField}, \\{offsetField});\n@@ -167,1 +185,1 @@\n-    private void emitFieldSetter(String javaName, Declaration.Variable varTree, String offsetField) {\n+    private void emitFieldSetter(String javaName, Declaration.Variable varTree, String layoutField, String offsetField) {\n@@ -175,1 +193,1 @@\n-                \\{seg}.set(\\{layoutString(varTree.type())}, \\{offsetField}, \\{x});\n+                \\{seg}.set(\\{layoutField}, \\{offsetField}, \\{x});\n@@ -243,1 +261,10 @@\n-            private static final long \\{offsetFieldName} = \\{ClangOffsetOf.getOrThrow(field) \/ 8};\n+            private static final long \\{offsetFieldName} = $LAYOUT.byteOffset(\\{fieldElementPaths(field.name())});\n+            \"\"\");\n+        return offsetFieldName;\n+    }\n+\n+    private String emitLayoutFieldDecl(Declaration.Variable field) {\n+        String offsetFieldName = STR.\"\\{field.name()}$LAYOUT\";\n+        String layoutType = Utils.layoutCarrierFor(field.type()).getSimpleName();\n+        appendIndentedLines(STR.\"\"\"\n+            private static final \\{layoutType} \\{offsetFieldName} = (\\{layoutType})$LAYOUT.select(\\{fieldElementPaths(field.name())});\n","filename":"src\/main\/java\/org\/openjdk\/jextract\/impl\/StructBuilder.java","additions":34,"deletions":7,"binary":false,"changes":41,"status":"modified"}]}