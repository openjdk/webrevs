{"files":[{"patch":"@@ -41,1 +41,0 @@\n-\n@@ -76,15 +75,22 @@\n-    \/\/ make sure we only pick up the \"real\" shared library file from LLVM installation\n-    \/\/ (e.g. exclude symlinks on Linux)\n-    def clang_path_include = (Os.isFamily(Os.FAMILY_UNIX) && !Os.isFamily(Os.FAMILY_MAC)) ?\n-            \"libclang.so.${clang_version}\" : \"*clang*\"\n-\n-    from(\"${libclang_dir}\") {\n-        include(clang_path_include)\n-        include(\"libLLVM.*\")\n-        exclude(\"clang.exe\")\n-        into(\"libs\")\n-        \/\/ make sure we drop shared library version name (Linux only)\n-        rename(\"libclang.so.${clang_version}\", \"libclang.so\")\n-    }\n-\n-    from(\"$clang_include_dir\") {\n+     \/\/ make sure we only pick up the \"real\" shared library file from LLVM installation\n+     \/\/ (e.g. exclude symlinks on Linux)\n+     def isAix = Os.isName(\"AIX\") || Os.isName(\"aix\")\n+     def isUnixNotMac  = Os.isFamily(Os.FAMILY_UNIX) && !Os.isFamily(Os.FAMILY_MAC)\n+     def clang_path_include =\n+        isAix  ? \"libclang.a\" :\n+        isUnixNotMac ? \"libclang.so.${clang_version}\" :\n+                 \"*clang*\"\n+     from(\"${libclang_dir}\") {\n+         include(clang_path_include)\n+         include(\"libLLVM.*\")\n+         exclude(\"clang.exe\")\n+         into(\"libs\")\n+         \/\/ make sure we drop shared library version name (Linux only)\n+         rename(\"libclang.so.*\", \"libclang.so\")\n+\n+     }\n+     from(\"${libclang_dir}\") {\n+        include(\"libclang.a\")\n+        into(\"$buildDir\/test-libs\")\n+     }\n+     from(\"$clang_include_dir\") {\n@@ -93,1 +99,2 @@\n-    }\n+     }\n+\n@@ -206,0 +213,1 @@\n+\n@@ -241,1 +249,1 @@\n-                \"-retain:fail,error\",\n+                \"-retain:fail,error\"\n@@ -261,0 +269,14 @@\n+\n+tasks.register(\"copyLibClangToTestLib\", Copy) {\n+    def srcFile = file(\"${project.buildDir}\/jmod_inputs\/libs\/libclang.a\")\n+    def destDir = file(\"${project.buildDir}\/test-lib\/libs\")\n+    dependsOn(copyLibClang)\n+    from(srcFile) \n+    into(destDir)\n+}\n+\n+\/\/ Make jtreg depend on it\n+tasks.named(\"jtreg\") {\n+    dependsOn(\"copyLibClangToTestLib\")\n+}\n+\n","filename":"build.gradle","additions":40,"deletions":18,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -17,0 +17,2 @@\n+else ifeq ($(PLATFORM_OS), aix)\n+  TAR_SUPPORTS_TRANSFORM := false\n@@ -32,0 +34,2 @@\n+else ifeq ($(PLATFORM_OS), aix)\n+  BUNDLE_PLATFORM := aix-$(PLATFORM_CPU)\n@@ -58,0 +62,2 @@\n+else ifeq ($(PLATFORM_OS), aix)\n+  LIBCLANG_COPY_PATH := \"libclang.a\"\n@@ -73,1 +79,0 @@\n-\n","filename":"make\/Build.gmk","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -71,1 +71,1 @@\n-\n+UNAME_P := $(shell uname -p)\n@@ -73,0 +73,2 @@\n+\n+# CPU detection\n@@ -74,8 +76,2 @@\n-  DEVKIT_VS_CPU_VAR_NAME := x86_64\n-  PLATFORM_CPU := x64\n-else ifeq ($(UNAME_M),arm64)\n-  DEVKIT_VS_CPU_VAR_NAME := aarch64\n-  PLATFORM_CPU := aarch64\n-else ifeq ($(UNAME_M),aarch64)\n-  DEVKIT_VS_CPU_VAR_NAME := aarch64\n-  PLATFORM_CPU := aarch64\n+    DEVKIT_VS_CPU_VAR_NAME := x86_64\n+    PLATFORM_CPU := x64\n@@ -83,1 +79,16 @@\n-  $(error \"Unknown CPU: $(UNAME_M)\")\n+    ifeq ($(UNAME_M),arm64)\n+        DEVKIT_VS_CPU_VAR_NAME := aarch64\n+        PLATFORM_CPU := aarch64\n+    else\n+        ifeq ($(UNAME_M),aarch64)\n+            DEVKIT_VS_CPU_VAR_NAME := aarch64\n+            PLATFORM_CPU := aarch64\n+        else\n+            ifeq ($(UNAME_P),powerpc)\n+                DEVKIT_VS_CPU_VAR_NAME := ppc64\n+                PLATFORM_CPU := ppc64\n+            else\n+                $(error \"Unknown CPU: $(UNAME_M)\")\n+            endif\n+        endif\n+    endif\n@@ -86,0 +97,1 @@\n+# OS detection\n@@ -87,2 +99,2 @@\n-  PLATFORM_OS := windows\n-  FIXPATH := bash $(TOPDIR)\/make\/scripts\/fixpath.sh exec\n+    PLATFORM_OS := windows\n+    FIXPATH := bash $(TOPDIR)\/make\/scripts\/fixpath.sh exec\n@@ -90,8 +102,4 @@\n-  FIXPATH :=\n-\n-  UNAME_S := $(shell uname -s)\n-  ifeq ($(UNAME_S), Darwin)\n-    PLATFORM_OS := macosx\n-  else\n-    ifeq ($(UNAME_S), Linux)\n-      PLATFORM_OS := linux\n+    FIXPATH :=\n+    UNAME_S := $(shell uname -s)\n+    ifeq ($(UNAME_S),Darwin)\n+        PLATFORM_OS := macosx\n@@ -99,1 +107,9 @@\n-      $(error \"Unknown OS: $(UNAME_S)\")\n+        ifeq ($(UNAME_S),Linux)\n+            PLATFORM_OS := linux\n+        else\n+            ifeq ($(UNAME_S),AIX)\n+                PLATFORM_OS := aix\n+            else\n+                $(error \"Unknown OS: $(UNAME_S)\")\n+            endif\n+        endif\n@@ -101,1 +117,0 @@\n-  endif\n@@ -103,1 +118,0 @@\n-\n","filename":"make\/Common.gmk","additions":37,"deletions":23,"binary":false,"changes":60,"status":"modified"},{"patch":"@@ -89,0 +89,13 @@\n+    ifeq ($(PLATFORM_OS), aix)\n+      SHARED_LIB_SUFFIX := .a\n+      CC_NAME := xlc\n+      LINK_NAME := xlc\n+\n+      # xlc typically requires -q64 for 64-bit builds\n+      CFLAGS += -q64 -bexpall -qhalt=e -qalign=power -sysroot=$(SYSROOT) -m64\n+      LDFLAGS += -q64 -G -Wl,-bnoentry -Wl,-bexpall, -malign-power -m64\n+      CPPFLAGS += -D_AIX\n+\n+      # AIX-specific export file handling can be added here if needed\n+    endif\n+\n","filename":"make\/NativeCompilation.gmk","additions":13,"deletions":0,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -36,1 +36,0 @@\n-\n@@ -38,0 +37,1 @@\n+import java.util.StringTokenizer;\n@@ -39,0 +39,1 @@\n+import java.io.File;\n@@ -83,0 +84,1 @@\n+    static SymbolLookup SYMBOL_LOOKUP;\n@@ -85,2 +87,24 @@\n-        String libName = System.getProperty(\"os.name\").startsWith(\"Windows\") ? \"libclang\" : \"clang\";\n-        System.loadLibrary(libName);\n+        String osName = System.getProperty(\"os.name\");\n+        String libName = \"\";\n+        if (osName.startsWith(\"AIX\")) {\n+        List<String> pathsToCheck = new ArrayList<>(Arrays.asList(\n+                System.getProperty(\"java.library.path\").split(File.pathSeparator)\n+        ));\n+        \/\/ 2. Add alternate calculated paths\n+        String currentDir = System.getProperty(\"user.dir\"); \/\/ wherever JVM was launched\n+        pathsToCheck.add(currentDir + \"\/build\/jextract-jdk-test-image\/lib\");\n+        pathsToCheck.add(currentDir + \"\/..\/..\/..\/jextract-jdk-test-image\/lib\"); \/\/ in case running from subdir\n+        \/\/ 3. Try to find the library\n+        for (String path : pathsToCheck) {\n+            File f = new File(path, \"libclang.a\"); \/\/ AIX uses .a, Linux .so\n+            if (f.exists() && !f.isDirectory()) {\n+                libName = f.getAbsolutePath();\n+                break;\n+            }\n+        }\n+        SYMBOL_LOOKUP = SymbolLookup.libraryLookup(libName + \"(libclang.so.14)\", Arena.global());\n+        } else {\n+            libName = osName.startsWith(\"Windows\") ? \"libclang\" : \"clang\";\n+            System.loadLibrary(libName);\n+            SYMBOL_LOOKUP = SymbolLookup.loaderLookup().or(Linker.nativeLinker().defaultLookup());\n+        }\n@@ -88,4 +112,0 @@\n-\n-    static final SymbolLookup SYMBOL_LOOKUP = SymbolLookup.loaderLookup()\n-            .or(Linker.nativeLinker().defaultLookup());\n-\n","filename":"src\/main\/java\/org\/openjdk\/jextract\/clang\/libclang\/Index_h.java","additions":27,"deletions":7,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -5,1 +5,0 @@\n-\n@@ -14,0 +13,11 @@\n+    if(${CMAKE_SYSTEM_NAME} MATCHES \"AIX\")\n+      add_library(${LIB_NAME} SHARED ${TEST_LIB})\n+      set_target_properties(${LIB_NAME} PROPERTIES\n+          PREFIX \"lib\"\n+          SUFFIX \".a\"\n+          COMPILE_FLAGS \"-q64  -qhalt=e\"\n+          LINK_FLAGS \"-q64 -G -Wl,-bnoentry,-bexpall\"\n+    \t)\n+    else()\n+      add_library(${LIB_NAME} SHARED ${TEST_LIB})\n+    endif()\n@@ -15,1 +25,0 @@\n-    add_library(${LIB_NAME} SHARED ${TEST_LIB})\n@@ -21,0 +30,3 @@\n+    # Link against libm to resolve sqrt() and other math symbols\n+    target_link_libraries(${LIB_NAME} m)\n+\n","filename":"test\/test-support\/CMakeLists.txt","additions":14,"deletions":2,"binary":false,"changes":16,"status":"modified"}]}