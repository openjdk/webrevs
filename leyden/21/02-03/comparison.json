{"files":[{"patch":"@@ -28,0 +28,1 @@\n+#include \"cds\/cdsConfig.hpp\"\n@@ -46,1 +47,0 @@\n-#include \"runtime\/globals_extension.hpp\"\n@@ -1403,1 +1403,1 @@\n-  if (!FLAG_IS_DEFAULT(AOTEndTrainingOnMethodEntry) && CDSPreimage == nullptr) {\n+  if (CDSConfig::is_dumping_preimage_static_archive_with_triggers()) {\n","filename":"src\/hotspot\/cpu\/aarch64\/interp_masm_aarch64.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1275,3 +1275,0 @@\n-  \/\/ AOT training run support\n-  __ end_training_check();\n-\n@@ -1281,0 +1278,3 @@\n+  \/\/ AOT training run support\n+  __ end_training_check();\n+\n@@ -1727,3 +1727,0 @@\n-  \/\/ AOT training run support\n-  __ end_training_check();\n-\n@@ -1733,0 +1730,3 @@\n+  \/\/ AOT training run support\n+  __ end_training_check();\n+\n","filename":"src\/hotspot\/cpu\/aarch64\/templateInterpreterGenerator_aarch64.cpp","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+#include \"cds\/cdsConfig.hpp\"\n@@ -42,1 +43,0 @@\n-#include \"runtime\/globals_extension.hpp\"\n@@ -1935,1 +1935,1 @@\n-  if (!FLAG_IS_DEFAULT(AOTEndTrainingOnMethodEntry) && CDSPreimage == nullptr) {\n+  if (CDSConfig::is_dumping_preimage_static_archive_with_triggers()) {\n","filename":"src\/hotspot\/cpu\/x86\/interp_masm_x86.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -916,3 +916,0 @@\n-  \/\/ AOT training run support\n-  __ end_training_check();\n-\n@@ -922,0 +919,3 @@\n+  \/\/ AOT training run support\n+  __ end_training_check();\n+\n@@ -1474,3 +1474,0 @@\n-  \/\/ AOT training run support\n-  __ end_training_check();\n-\n@@ -1480,0 +1477,3 @@\n+  \/\/ AOT training run support\n+  __ end_training_check();\n+\n","filename":"src\/hotspot\/cpu\/x86\/templateInterpreterGenerator_x86.cpp","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+#include \"cds\/cdsConfig.hpp\"\n@@ -45,1 +46,0 @@\n-#include \"runtime\/globals_extension.hpp\"\n@@ -4068,7 +4068,0 @@\n-  if (!FLAG_IS_DEFAULT(AOTEndTrainingOnMethodEntry) && CDSPreimage == nullptr) {\n-    if(callee->is_end_training_trigger()) {\n-      Values* args = new Values(0);\n-      append(new RuntimeCall(voidType, \"end_training_check_c1\", CAST_FROM_FN_PTR(address, SharedRuntime::end_training_check_c1), args));\n-    }\n-  }\n-\n@@ -4081,0 +4074,5 @@\n+  if (CDSConfig::is_dumping_preimage_static_archive_with_triggers() && callee->is_end_training_trigger()) {\n+    Values* args = new Values(0);\n+    append(new RuntimeCall(voidType, \"end_training_check_c1\", CAST_FROM_FN_PTR(address, SharedRuntime::end_training_check_c1), args));\n+  }\n+\n","filename":"src\/hotspot\/share\/c1\/c1_GraphBuilder.cpp","additions":6,"deletions":8,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -33,0 +33,1 @@\n+#include \"cds\/cdsConfig.hpp\"\n@@ -44,1 +45,0 @@\n-#include \"runtime\/globals_extension.hpp\"\n@@ -2668,10 +2668,0 @@\n-  if (!FLAG_IS_DEFAULT(AOTEndTrainingOnMethodEntry) && CDSPreimage == nullptr) {\n-    if(method()->is_end_training_trigger()) {\n-      BasicTypeList signature;\n-      signature.append(LP64_ONLY(T_LONG) NOT_LP64(T_INT));    \/\/ thread\n-      LIR_OprList* args = new LIR_OprList();\n-      args->append(getThreadPointer());\n-      call_runtime(&signature, args, CAST_FROM_FN_PTR(address, SharedRuntime::end_training_check_c1), voidType, nullptr);\n-    }\n-  }\n-\n@@ -2690,0 +2680,8 @@\n+  if (CDSConfig::is_dumping_preimage_static_archive_with_triggers() && method()->is_end_training_trigger()) {\n+    BasicTypeList signature;\n+    signature.append(LP64_ONLY(T_LONG) NOT_LP64(T_INT));    \/\/ thread\n+    LIR_OprList* args = new LIR_OprList();\n+    args->append(getThreadPointer());\n+    call_runtime(&signature, args, CAST_FROM_FN_PTR(address, SharedRuntime::end_training_check_c1), voidType, nullptr);\n+  }\n+\n","filename":"src\/hotspot\/share\/c1\/c1_LIRGenerator.cpp","additions":9,"deletions":11,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -674,0 +674,4 @@\n+bool CDSConfig::is_dumping_preimage_static_archive_with_triggers() {\n+  return _is_dumping_static_archive && CacheDataStore != nullptr && CDSPreimage == nullptr && !FLAG_IS_DEFAULT(AOTEndTrainingOnMethodEntry);\n+}\n+\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -96,3 +96,4 @@\n-  static bool is_dumping_classic_static_archive()            NOT_CDS_RETURN_(false); \/\/ -Xshare:dump\n-  static bool is_dumping_preimage_static_archive()           NOT_CDS_RETURN_(false); \/\/ 1st phase of -XX:CacheDataStore dumping\n-  static bool is_dumping_final_static_archive()              NOT_CDS_RETURN_(false); \/\/ 2nd phase of -XX:CacheDataStore dumping\n+  static bool is_dumping_classic_static_archive()                NOT_CDS_RETURN_(false); \/\/ -Xshare:dump\n+  static bool is_dumping_preimage_static_archive()               NOT_CDS_RETURN_(false); \/\/ 1st phase of -XX:CacheDataStore dumping\n+  static bool is_dumping_preimage_static_archive_with_triggers() NOT_CDS_RETURN_(false); \/\/ 1st phase of -XX:CacheDataStore dumping with triggers\n+  static bool is_dumping_final_static_archive()                  NOT_CDS_RETURN_(false); \/\/ 2nd phase of -XX:CacheDataStore dumping\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.hpp","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -113,0 +113,1 @@\n+int volatile MetaspaceShared::_preimage_static_archive_dumped = 0;\n@@ -875,0 +876,6 @@\n+  if (CDSConfig::is_dumping_preimage_static_archive()) {\n+    if (Atomic::cmpxchg(&_preimage_static_archive_dumped, 0, 1) != 0) {\n+      return;\n+    }\n+  }\n+\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -64,0 +64,1 @@\n+  static int volatile _preimage_static_archive_dumped;\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -521,1 +521,0 @@\n-  bool is_end_training_trigger() const { return _method != nullptr && _method->is_end_training_trigger(); }\n","filename":"src\/hotspot\/share\/code\/nmethod.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -86,1 +86,0 @@\n-#include \"runtime\/globals_extension.hpp\"\n@@ -1079,4 +1078,1 @@\n-  ResourceMark rm(THREAD);\n-\n-  bool addingAOTTriggers = (!FLAG_IS_DEFAULT(AOTEndTrainingOnMethodEntry)) && CDSPreimage == nullptr;\n-\n+  bool addingAOTTriggers = CDSConfig::is_dumping_preimage_static_archive_with_triggers();\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.cpp","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+#include \"cds\/cdsConfig.hpp\"\n@@ -41,1 +42,0 @@\n-#include \"runtime\/globals_extension.hpp\"\n@@ -1211,6 +1211,0 @@\n-  if (!FLAG_IS_DEFAULT(AOTEndTrainingOnMethodEntry) && CDSPreimage == nullptr) {\n-    if (method()->is_end_training_trigger()) {\n-      make_end_training_check();\n-    }\n-  }\n-\n@@ -1221,0 +1215,4 @@\n+  if (CDSConfig::is_dumping_preimage_static_archive_with_triggers() && method()->is_end_training_trigger()) {\n+    make_end_training_check();\n+  }\n+\n","filename":"src\/hotspot\/share\/opto\/parse1.cpp","additions":5,"deletions":7,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+#include \"cds\/metaspaceShared.hpp\"\n@@ -29,1 +30,0 @@\n-#include \"classfile\/systemDictionary.hpp\"\n@@ -1433,1 +1433,0 @@\n-  \/\/ This should only execute once\n@@ -1435,12 +1434,2 @@\n-    JavaThread* current = THREAD;\n-    ResourceMark rm(current);\n-    Symbol* system_name  = vmSymbols::java_lang_System();\n-    Klass*  system_klass = SystemDictionary::resolve_or_fail(system_name, true \/*throw error*\/,  CHECK);\n-    JavaValue result(T_OBJECT);\n-    JavaCallArguments args;\n-    args.push_int(0);\n-    JavaCalls::call_static(&result,\n-                          system_klass,\n-                          vmSymbols::exit_method_name(),\n-                          vmSymbols::int_void_signature(),\n-                          &args, CHECK);\n+    MetaspaceShared::preload_and_dump(CHECK);\n+    assert(!THREAD->has_pending_exception(), \"must be\");\n","filename":"src\/hotspot\/share\/runtime\/sharedRuntime.cpp","additions":3,"deletions":14,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -997,1 +997,5 @@\n-  SharedRuntime::end_training(CHECK);\n+  if (!CDSConfig::is_dumping_preimage_static_archive()) {\n+    output()->print_cr(\"Must be in training run\");\n+  } else {\n+    SharedRuntime::end_training(CHECK);\n+  }\n","filename":"src\/hotspot\/share\/services\/diagnosticCommand.cpp","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"}]}