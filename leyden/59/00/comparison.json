{"files":[{"patch":"@@ -462,1 +462,1 @@\n-    md->clean_method_data(true);\n+    md->clean_method_data(false \/* always_clean *\/);\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -324,0 +324,22 @@\n+static bool is_excluded(Klass* k) {\n+#if INCLUDE_CDS\n+  if (SafepointSynchronize::is_at_safepoint() &&\n+      CDSConfig::is_dumping_archive() &&\n+      CDSConfig::current_thread_is_vm_or_dumper()) {\n+    if (k->is_instance_klass() && InstanceKlass::cast(k)->is_loaded() == false) {\n+      log_debug(cds)(\"Purged %s from MDO: unloaded class\", k->name()->as_C_string());\n+      return true;\n+    } else if (CDSConfig::is_dumping_dynamic_archive() && k->is_shared()) {\n+      return false;\n+    } else {\n+      bool excluded = SystemDictionaryShared::should_be_excluded(k);\n+      if (excluded) {\n+        log_debug(cds)(\"Purged %s from MDO: excluded class\", k->name()->as_C_string());\n+      }\n+      return excluded;\n+    }\n+  }\n+#endif\n+  return false;\n+}\n+\n@@ -332,1 +354,1 @@\n-      if (always_clean || !k->is_loader_alive()) {\n+      if (always_clean || !k->is_loader_alive() || is_excluded(k)) {\n@@ -353,1 +375,1 @@\n-    if (always_clean || !k->is_loader_alive()) {\n+    if (always_clean || !k->is_loader_alive() || is_excluded(k)) {\n@@ -443,1 +465,1 @@\n-      if (always_clean || !p->is_loader_alive()) {\n+      if (always_clean || !p->is_loader_alive() || is_excluded(p)) {\n@@ -1869,8 +1891,1 @@\n-      bool exclude = false;\n-      if (SafepointSynchronize::is_at_safepoint() && CDSConfig::is_dumping_archive()) {\n-#if INCLUDE_CDS\n-        InstanceKlass* holder = m->method_holder();\n-        exclude = (holder == nullptr || !holder->is_loaded() || SystemDictionaryShared::check_for_exclusion(holder, nullptr));\n-#endif\n-      }\n-      if (exclude || !cl->is_live(m)) {\n+      if (is_excluded(m->method_holder()) || !cl->is_live(m)) {\n","filename":"src\/hotspot\/share\/oops\/methodData.cpp","additions":26,"deletions":11,"binary":false,"changes":37,"status":"modified"}]}