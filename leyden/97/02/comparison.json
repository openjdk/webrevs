{"files":[{"patch":"@@ -242,1 +242,3 @@\n-    return bucket->object();\n+    ciObject* obj = bucket->object();\n+    notice_object_access(obj);\n+    return obj;\n@@ -254,1 +256,1 @@\n-  notice_new_object(new_object);\n+  notice_object_access(new_object);\n@@ -258,1 +260,1 @@\n-void ciObjectFactory::notice_new_object(ciBaseObject* new_object) {\n+void ciObjectFactory::notice_object_access(ciBaseObject* new_object) {\n@@ -350,1 +352,1 @@\n-    notice_new_object(new_object);\n+    notice_object_access(new_object);\n@@ -353,1 +355,3 @@\n-  return _ci_metadata.at(index)->as_metadata();\n+  ciMetadata* metadata = _ci_metadata.at(index)->as_metadata();\n+  notice_object_access(metadata);\n+  return metadata;\n","filename":"src\/hotspot\/share\/ci\/ciObjectFactory.cpp","additions":9,"deletions":5,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -111,1 +111,1 @@\n-  void notice_new_object(ciBaseObject* new_object);\n+  void notice_object_access(ciBaseObject* new_object);\n","filename":"src\/hotspot\/share\/ci\/ciObjectFactory.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -314,21 +314,12 @@\n-  CompileTask* task = env->task();\n-  assert(task != nullptr, \"\");\n-  Method* method = task->method();\n-  InstanceKlass* compiling_klass = method->method_holder();\n-  if (what->is_metadata()) {\n-    ciMetadata* md = what->as_metadata();\n-    if (md->is_loaded() && md->is_instance_klass()) {\n-      ciInstanceKlass* cik = md->as_instance_klass();\n-\n-      if (cik->is_initialized()) {\n-        InstanceKlass* ik = md->as_instance_klass()->get_instanceKlass();\n-        KlassTrainingData* ktd = KlassTrainingData::make(ik);\n-        if (ktd == nullptr) {\n-          \/\/ Allocation failure or snapshot in progress\n-          return;\n-        }\n-        \/\/ This JIT task is (probably) requesting that ik be initialized,\n-        \/\/ so add him to my _init_deps list.\n-        TrainingDataLocker l;\n-        add_init_dep(ktd);\n-      }\n+  ciMetadata* md = nullptr;\n+  if (what->is_object()) {\n+    md = what->as_object()->klass();\n+  } else if (what->is_metadata()) {\n+    md = what->as_metadata();\n+  }\n+  if (md != nullptr && md->is_loaded() && md->is_instance_klass()) {\n+    InstanceKlass* ik = md->as_instance_klass()->get_instanceKlass();\n+    KlassTrainingData* ktd = KlassTrainingData::make(ik);\n+    if (ktd == nullptr) {\n+      \/\/ Allocation failure or snapshot in progress\n+      return;\n@@ -336,0 +327,4 @@\n+    \/\/ This JIT task is (probably) requesting that ik be initialized,\n+    \/\/ so add it to my _init_deps list.\n+    TrainingDataLocker l;\n+    add_init_dep(ktd);\n","filename":"src\/hotspot\/share\/oops\/trainingData.cpp","additions":16,"deletions":21,"binary":false,"changes":37,"status":"modified"}]}