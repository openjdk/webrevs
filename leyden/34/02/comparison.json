{"files":[{"patch":"@@ -540,1 +540,0 @@\n-  _C_load_buffer = nullptr;\n@@ -552,2 +551,0 @@\n-  \/\/ Read header at the begining of cache\n-  uint header_size = sizeof(SCCHeader);\n@@ -556,5 +553,6 @@\n-    _C_load_buffer = NEW_C_HEAP_ARRAY(char, load_size + DATA_ALIGNMENT, mtCode);\n-    _load_buffer = align_up(_C_load_buffer, DATA_ALIGNMENT);\n-    uint n = (uint)::read(fd, _load_buffer, load_size);\n-    if (n != load_size) {\n-      log_warning(scc, init)(\"Failed to read %d bytes at address \" INTPTR_FORMAT \" from Startup Code Cache file '%s'\", load_size, p2i(_load_buffer), _cache_path);\n+    \/\/ Implementation note: the mapping is not read-only, because entries are updated in-place.\n+    \/\/ However, this mapping is MAP_PRIVATE, which means the changes to mapping do not reflect\n+    \/\/ in the backing file. TODO: Avoid in-place modifications, so we do not have to rely on this?\n+    _load_buffer = os::map_memory(fd, _cache_path, 0, nullptr, load_size, false, false, mtCode);\n+    if (_load_buffer == nullptr) {\n+      log_warning(scc, init)(\"Failed to mmap %d bytes at address \" INTPTR_FORMAT \" from Startup Code Cache file '%s'\", load_size, p2i(_load_buffer), _cache_path);\n@@ -564,1 +562,1 @@\n-    log_info(scc, init)(\"Read %d bytes at address \" INTPTR_FORMAT \" from Startup Code Cache '%s'\", load_size, p2i(_load_buffer), _cache_path);\n+    log_info(scc, init)(\"Mmaped %d bytes at address \" INTPTR_FORMAT \" from Startup Code Cache '%s'\", load_size, p2i(_load_buffer), _cache_path);\n@@ -773,3 +771,2 @@\n-  if (_C_load_buffer != nullptr) {\n-    FREE_C_HEAP_ARRAY(char, _C_load_buffer);\n-    _C_load_buffer = nullptr;\n+  if (_load_buffer != nullptr) {\n+    os::unmap_memory(_load_buffer, _load_size);\n","filename":"src\/hotspot\/share\/code\/SCCache.cpp","additions":9,"deletions":12,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -388,1 +388,0 @@\n-  char*       _C_load_buffer;  \/\/ Original unaligned buffer\n","filename":"src\/hotspot\/share\/code\/SCCache.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"}]}