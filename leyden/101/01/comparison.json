{"files":[{"patch":"@@ -986,2 +986,2 @@\n-\/\/ aot_code_entry != nullptr implies loading compiled code from AOT code cache\n-bool ciEnv::is_compilation_valid(JavaThread* thread, ciMethod* target, bool preload, bool install_code, CodeBuffer* code_buffer, AOTCodeEntry* aot_code_entry) {\n+\/\/ is_loading_aot_code = true implies loading compiled code from AOT code cache\n+bool ciEnv::is_compilation_valid(JavaThread* thread, ciMethod* target, bool install_code, bool is_loading_aot_code, bool preload) {\n@@ -993,3 +993,0 @@\n-    if (code_buffer != nullptr) {\n-      code_buffer->free_blob();\n-    }\n@@ -999,9 +996,0 @@\n-  if (aot_code_entry != nullptr) {\n-    \/\/ Invalid compilation states:\n-    \/\/  - AOTCodeCache is closed, AOTCode entry is garbage.\n-    \/\/  - AOTCode entry indicates this shared code was marked invalid while it was loaded.\n-    if (!AOTCodeCache::is_on() || aot_code_entry->not_entrant()) {\n-      return false;\n-    }\n-  }\n-\n@@ -1025,1 +1013,1 @@\n-  if (!failing() && (aot_code_entry == nullptr)) {\n+  if (!failing() && !is_loading_aot_code) {\n@@ -1051,4 +1039,0 @@\n-\n-    if (code_buffer != nullptr) {\n-      code_buffer->free_blob();\n-    }\n@@ -1153,1 +1137,6 @@\n-    if (!is_compilation_valid(thread, target, preload, true \/*install_code*\/, nullptr \/*code_buffer*\/, aot_code_entry)) {\n+    \/\/ AOTCode entry indicates this shared code was marked invalid while it was loaded.\n+    if (aot_code_entry->not_entrant()) {\n+      return nullptr;\n+    }\n+\n+    if (!is_compilation_valid(thread, target, true \/*install_code*\/, true, preload)) {\n@@ -1208,2 +1197,1 @@\n-                            bool install_code,\n-                            AOTCodeEntry* aot_code_entry) {\n+                            bool install_code) {\n@@ -1214,1 +1202,0 @@\n-    bool preload = task()->preload(); \/\/ Code is preloaded before Java method execution\n@@ -1228,1 +1215,2 @@\n-    if (!is_compilation_valid(THREAD, target, preload, install_code, code_buffer, aot_code_entry)) {\n+    if (!is_compilation_valid(THREAD, target, install_code, \/*aot_code_entry*\/ false, \/*preload*\/ false)) {\n+      code_buffer->free_blob();\n@@ -1244,2 +1232,1 @@\n-                                 compiler, CompLevel(task()->comp_level()),\n-                                 aot_code_entry);\n+                                 compiler, CompLevel(task()->comp_level()));\n@@ -1255,1 +1242,1 @@\n-      nm->set_preloaded(preload);\n+      nm->set_preloaded(false);\n@@ -1260,1 +1247,1 @@\n-        aot_code_entry = AOTCodeCache::store_nmethod(nm, compiler, for_preload);\n+        AOTCodeEntry* aot_code_entry = AOTCodeCache::store_nmethod(nm, compiler, for_preload);\n@@ -1265,1 +1252,1 @@\n-      make_code_usable(THREAD, target, preload, entry_bci, aot_code_entry, nm);\n+      make_code_usable(THREAD, target, \/* preload *\/ false, entry_bci, \/* aot_code_entry *\/ nullptr, nm);\n","filename":"src\/hotspot\/share\/ci\/ciEnv.cpp","additions":16,"deletions":29,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -299,1 +299,1 @@\n-  bool is_compilation_valid(JavaThread* thread, ciMethod* target, bool preload, bool install_code, CodeBuffer* code_buffer, AOTCodeEntry* aot_code_entry);\n+  bool is_compilation_valid(JavaThread* thread, ciMethod* target, bool install_code, bool is_loading_aot_code, bool preload);\n@@ -406,2 +406,1 @@\n-                       bool                      install_code,\n-                       AOTCodeEntry*             entry = nullptr);\n+                       bool                      install_code);\n","filename":"src\/hotspot\/share\/ci\/ciEnv.hpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -1171,1 +1171,0 @@\n-  , AOTCodeEntry* aot_code_entry\n@@ -1215,1 +1214,1 @@\n-            handler_table, nul_chk_table, compiler, comp_level, aot_code_entry\n+            handler_table, nul_chk_table, compiler, comp_level\n@@ -1544,1 +1543,0 @@\n-  , AOTCodeEntry* aot_code_entry\n@@ -1564,1 +1562,1 @@\n-    _aot_code_entry          = aot_code_entry;\n+    _aot_code_entry          = nullptr; \/\/ runtime compiled nmethod does not have AOTCodeEntry\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -342,1 +342,0 @@\n-          , AOTCodeEntry* aot_code_entry\n@@ -605,1 +604,0 @@\n-                              , AOTCodeEntry* aot_code_entry\n","filename":"src\/hotspot\/share\/code\/nmethod.hpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2171,1 +2171,1 @@\n-                                 compiler, comp_level, nullptr \/* AOTCodeEntry *\/,\n+                                 compiler, comp_level,\n","filename":"src\/hotspot\/share\/jvmci\/jvmciRuntime.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}