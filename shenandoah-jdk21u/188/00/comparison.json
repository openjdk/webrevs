{"files":[{"patch":"@@ -688,4 +688,0 @@\n-    if (_generation->is_young()) {\n-      ShenandoahGCPhase phase(ShenandoahPhaseTimings::init_swap_rset);\n-      _generation->swap_card_tables();\n-    }\n@@ -702,0 +698,8 @@\n+    {\n+      \/\/ After we swap card table below, the write-table is all clean, and the read table holds\n+      \/\/ cards dirty prior to the start of GC. Young and bootstrap collection will update\n+      \/\/ the write card table as a side effect of remembered set scanning. Global collection will\n+      \/\/ update the card table as a side effect of global marking of old objects.\n+      ShenandoahGCPhase phase(ShenandoahPhaseTimings::init_swap_rset);\n+      _generation->swap_card_tables();\n+    }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahConcurrentGC.cpp","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -1159,0 +1159,3 @@\n+    \/\/ Set mark incomplete because the marking bitmaps have been reset except pinned regions.\n+    heap->global_generation()->set_mark_incomplete();\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahFullGC.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1058,1 +1058,7 @@\n-    verify_at_safepoint(\n+  VerifyRememberedSet verify_remembered_set = _verify_remembered_before_marking;\n+  if (_heap->mode()->is_generational() &&\n+      !_heap->old_generation()->is_mark_complete()) {\n+    \/\/ Before marking in generational mode, remembered set can't be verified w\/o complete old marking.\n+    verify_remembered_set = _verify_remembered_disable;\n+  }\n+  verify_at_safepoint(\n@@ -1060,1 +1066,1 @@\n-          _verify_remembered_before_marking,\n+          verify_remembered_set,\n@@ -1117,0 +1123,5 @@\n+  VerifyRememberedSet verify_remembered_set = _verify_remembered_before_updating_references;\n+  if (_heap->mode()->is_generational() &&\n+      !_heap->old_generation()->is_mark_complete()) {\n+    verify_remembered_set = _verify_remembered_disable;\n+  }\n@@ -1119,1 +1130,1 @@\n-          _verify_remembered_before_updating_references,  \/\/ verify read-write remembered set\n+          verify_remembered_set,        \/\/ verify read-write remembered set\n@@ -1279,8 +1290,0 @@\n-ShenandoahMarkingContext* ShenandoahVerifier::get_marking_context_for_old() {\n-  shenandoah_assert_generations_reconciled();\n-  if (_heap->old_generation()->is_mark_complete() || _heap->gc_generation()->is_global()) {\n-    return _heap->complete_marking_context();\n-  }\n-  return nullptr;\n-}\n-\n@@ -1288,1 +1291,1 @@\n-void ShenandoahVerifier::help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r, ShenandoahMarkingContext* ctx,\n+void ShenandoahVerifier::help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r,\n@@ -1290,0 +1293,5 @@\n+  shenandoah_assert_generations_reconciled();\n+  ShenandoahOldGeneration* old_gen = _heap->old_generation();\n+  assert(old_gen->is_mark_complete() || old_gen->is_parsable(), \"Sanity\");\n+\n+  ShenandoahMarkingContext* ctx = old_gen->is_mark_complete() ?old_gen->complete_marking_context() : nullptr;\n@@ -1360,1 +1368,0 @@\n-  ShenandoahMarkingContext* ctx = get_marking_context_for_old();\n@@ -1369,1 +1376,1 @@\n-      help_verify_region_rem_set(scanner, r, ctx, r->end(), \"Verify init-mark remembered set violation\");\n+      help_verify_region_rem_set(scanner, r, r->end(), \"Verify init-mark remembered set violation\");\n@@ -1382,1 +1389,1 @@\n-      help_verify_region_rem_set(&scanner, r, nullptr, r->top(), \"Remembered set violation at end of Full GC\");\n+      help_verify_region_rem_set(&scanner, r, r->top(), \"Remembered set violation at end of Full GC\");\n@@ -1395,1 +1402,0 @@\n-  ShenandoahMarkingContext* ctx = get_marking_context_for_old();\n@@ -1400,1 +1406,1 @@\n-      help_verify_region_rem_set(&scanner, r, ctx, r->get_update_watermark(), \"Remembered set violation at init-update-references\");\n+      help_verify_region_rem_set(&scanner, r, r->get_update_watermark(), \"Remembered set violation at init-update-references\");\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVerifier.cpp","additions":23,"deletions":17,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -232,1 +232,1 @@\n-  void help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r, ShenandoahMarkingContext* ctx,\n+  void help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r,\n@@ -238,2 +238,0 @@\n-\n-  ShenandoahMarkingContext* get_marking_context_for_old();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVerifier.hpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"}]}