{"files":[{"patch":"@@ -3566,7 +3566,4 @@\n-            \/\/ type classes unary operation\n-            TypeClassOperatorSymbol tcOp = (TypeClassOperatorSymbol)tree.operator;\n-            Type opType = tree.operator.type.getParameterTypes().head;\n-            ClassType witness = new ClassType(Type.noType, List.of(opType), (TypeSymbol) tcOp.opMethod.owner);\n-            JCExpression witnessRcvr = make.Ident(witnessOf((WitnessSymbol) rs.findWitness(attrEnv, witness)));\n-            JCExpression witnessMeth = make.Select(witnessRcvr, tcOp.opMethod);\n-            result = make.App(witnessMeth, List.of(tree.arg)).setType(tree.type);\n+            result = visitTypeClassOperator(\n+                    (TypeClassOperatorSymbol)tree.operator,\n+                    List.of(tree.arg),\n+                    tree.type);\n@@ -3616,7 +3613,4 @@\n-            \/\/ type classes unary operation\n-            TypeClassOperatorSymbol tcOp = (TypeClassOperatorSymbol)tree.operator;\n-            Type opType = tree.operator.type.getParameterTypes().head;\n-            ClassType witness = new ClassType(Type.noType, List.of(opType), (TypeSymbol) tcOp.opMethod.owner);\n-            JCExpression witnessRcvr = make.Ident(witnessOf((WitnessSymbol) rs.findWitness(attrEnv, witness)));\n-            JCExpression witnessMeth = make.Select(witnessRcvr, tcOp.opMethod);\n-            result = make.App(witnessMeth, List.of(tree.lhs, tree.rhs)).setType(tree.type);\n+            result = visitTypeClassOperator(\n+                    (TypeClassOperatorSymbol)tree.operator,\n+                    List.of(tree.lhs, tree.rhs),\n+                    tree.type);\n@@ -3628,0 +3622,20 @@\n+    \/*\n+     * This method lowers a type class-mediated operator (unary or binary) into the corresponding\n+     * witness call. For instance:\n+     *\n+     * P p1 = ... ; P p2 = ...\n+     * p1 + p2\n+     *\n+     * is translated to:\n+     *\n+     * (P)Numerical<P>.__witness.add(p1, p2)\n+     *\/\n+    JCExpression visitTypeClassOperator(TypeClassOperatorSymbol tcOp, List<JCExpression> loweredArgs, Type pType) {\n+        Type opType = tcOp.type.getParameterTypes().head;\n+        ClassType witness = new ClassType(Type.noType, List.of(opType), (TypeSymbol) tcOp.opMethod.owner);\n+        JCExpression witnessRcvr = make.Ident(witnessOf((WitnessSymbol) rs.findWitness(attrEnv, witness)));\n+        JCExpression witnessMeth = make.Select(witnessRcvr, tcOp.opMethod);\n+        JCExpression witnessCall = make.App(witnessMeth, loweredArgs);\n+        return convert(witnessCall, types.erasure(pType));\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Lower.java","additions":28,"deletions":14,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -292,0 +292,54 @@\n+\n+    @Test\n+    void testStackmapUnary() {\n+        NumBox e1 = numBox(1);\n+        NumBox eR  = testStackmapUnary(e1, true);\n+        assertEquals(eR, numBox(-1));\n+    }\n+\n+    @Test\n+    static NumBox testStackmapUnary(NumBox e1, boolean cond) {\n+        NumBox eR = null;\n+        if (cond) {\n+            eR = -e1;\n+        } else {\n+            eR = e1;\n+        }\n+        return eR;\n+    }\n+\n+    @Test\n+    void testStackmapBinary() {\n+        NumBox e1 = numBox(1);\n+        NumBox e2 = numBox(2);\n+        NumBox eR  = testStackmapBinary(e1, e2, true);\n+        assertEquals(eR, numBox(3));\n+    }\n+\n+    NumBox testStackmapBinary(NumBox e1, NumBox e2, boolean cond) {\n+        NumBox eR = null;\n+        if (cond) {\n+            eR = e1 + e2;\n+        } else {\n+            eR = e1;\n+        }\n+        return eR;\n+    }\n+\n+    @Test\n+    void testStackmapAssignop() {\n+        NumBox e1 = numBox(1);\n+        NumBox e2 = numBox(2);\n+        NumBox eR  = testStackmapAssignop(e1, e2, true);\n+        assertEquals(eR, numBox(3));\n+    }\n+\n+    NumBox testStackmapAssignop(NumBox e1, NumBox e2, boolean cond) {\n+        NumBox eR = e1;\n+        if (cond) {\n+            eR += e2;\n+        } else {\n+            eR = e1;\n+        }\n+        return eR;\n+    }\n","filename":"test\/langtools\/tools\/javac\/typeClasses\/TypeClassesOperatorResolutionTest.java","additions":54,"deletions":0,"binary":false,"changes":54,"status":"modified"}]}