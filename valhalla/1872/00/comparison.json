{"files":[{"patch":"@@ -279,0 +279,5 @@\n+        \/**\n+         * Warn about operations on null-restricted and nullable types.\n+         *\/\n+        NULL(\"null\"),\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/Lint.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+import com.sun.tools.javac.tree.JCTree.JCNullableTypeExpression.NullMarker;\n@@ -240,1 +241,0 @@\n-            buf.append(nullMarker(t));\n@@ -244,1 +244,0 @@\n-            buf.append(nullMarker(t));\n@@ -251,0 +250,1 @@\n+        buf.append(nullMarker(t));\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/Printer.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2372,1 +2372,0 @@\n-\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/Type.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -616,0 +616,8 @@\n+        boolean res = isConvertibleInternal(t, s, warn);\n+        if (res && t.hasTag(BOT) && isNonNullable(s)) {\n+            warn.warn(LintCategory.NULL);\n+        }\n+        return res;\n+    }\n+\n+    private boolean isConvertibleInternal(Type t, Type s, Warner warn) {\n@@ -1135,3 +1143,0 @@\n-                     if (isNonNullable(s)) {\n-                         return false;\n-                     }\n@@ -1766,2 +1771,7 @@\n-                case BOT:\n-                    return isSubtype(t, s);\n+                case BOT: {\n+                    boolean res = isSubtype(t, s);\n+                    if (res && isNonNullable(s)) {\n+                        warnStack.head.warn(LintCategory.NULL);\n+                    }\n+                    return res;\n+                }\n@@ -1780,1 +1790,1 @@\n-                if (s.hasTag(ERROR) || s.hasTag(BOT) && (!isNonNullable(t)))\n+                if (s.hasTag(ERROR) || s.hasTag(BOT))\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/Types.java","additions":16,"deletions":6,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -270,0 +270,10 @@\n+    \/** Warn about operation with bang types.\n+     *  @param pos        Position to be used for error reporting.\n+     *  @param warnKey    A warning key.\n+     *\/\n+    public void warnNullableTypes(DiagnosticPosition pos, LintWarning warnKey) {\n+        if (allowNullRestrictedTypes) {\n+            log.warning(pos, warnKey);\n+        }\n+    }\n+\n@@ -4444,0 +4454,3 @@\n+                case NULL:\n+                    Check.this.warnNullableTypes(pos(), LintWarnings.SuspiciousNullnessConversion(expected, found));\n+                    break;\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Check.java","additions":13,"deletions":0,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -4385,0 +4385,7 @@\n+\n+# lint: null\n+# 0: type, 1: type\n+compiler.warn.suspicious.nullness.conversion=\\\n+    Suspicious nullness conversion\\n\\\n+    required: {0}!\\n\\\n+    found:    {1}\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/resources\/compiler.properties","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -248,0 +248,3 @@\n+javac.opt.Xlint.desc.null=\\\n+    Warn about operations on null-restricted types.\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/resources\/javac.properties","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -234,0 +234,1 @@\n+compiler.warn.suspicious.nullness.conversion\n\\ No newline at end of file\n","filename":"test\/langtools\/tools\/javac\/diags\/examples.not-yet.txt","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -57,0 +57,3 @@\n+    private static String[] PREVIEW_PLUS_LINT_OPTIONS = {\n+            \"--enable-preview\", \"-source\", Integer.toString(Runtime.version().feature()),\n+            \"-Xlint:null\" };\n@@ -64,0 +67,1 @@\n+        COMPILE_WITH_WARNING,\n@@ -80,1 +84,5 @@\n-                assertFail(diagsMessage, code);\n+                if (testResult == TestResult.COMPILE_WITH_WARNING) {\n+                    assertOKWithWarning(diagsMessage, diagsCount, code);\n+                } else {\n+                    assertFail(diagsMessage, code);\n+                }\n@@ -96,0 +104,14 @@\n+            if (diagAndCode.result == Result.Clean) {\n+                testHelper(PREVIEW_PLUS_LINT_OPTIONS, diagAndCode.code);\n+            } else if (diagAndCode.result == Result.Warning) {\n+                testHelper(PREVIEW_PLUS_LINT_OPTIONS, diagAndCode.diag, diagAndCode.diagsCount, TestResult.COMPILE_WITH_WARNING, diagAndCode.code, null);\n+                testHelper(PREVIEW_OPTIONS, diagAndCode.code,\n+                        d -> {\n+                            if (d.getKind() == Diagnostic.Kind.WARNING) {\n+                                \/\/ shouldn't issue any warnings if the -Xlint:null option is not passed\n+                                throw new AssertionError(\"unexpected warning for \" + diagAndCode.code);\n+                            }\n+                        });\n+            } else {\n+                testHelper(PREVIEW_OPTIONS, diagAndCode.diag, diagAndCode.diagsCount, TestResult.ERROR, diagAndCode.code, null);\n+            }\n@@ -104,1 +126,1 @@\n-    enum Result { Error, Clean }\n+    enum Result { Warning, Error, Clean}\n@@ -112,42 +134,0 @@\n-    @Test\n-    void testErrorNonNullableCantBeAssignedNull() {\n-        testList(\n-                List.of(\n-                        new DiagAndCode(\n-                                \"\"\"\n-                                value class Point { }\n-                                class Foo {\n-                                    Point! s = null;\n-                                }\n-                                \"\"\",\n-                                Result.Error,\n-                                \"compiler.err.prob.found.req\"),\n-                        new DiagAndCode(\n-                                \"\"\"\n-                                class Foo {\n-                                    Foo! s = null;\n-                                }\n-                                \"\"\",\n-                                Result.Error,\n-                                \"compiler.err.prob.found.req\"),\n-                        new DiagAndCode(\n-                                \"\"\"\n-                                value class Point { }\n-                                class Foo {\n-                                    Point[]! s = null;\n-                                }\n-                                \"\"\",\n-                                Result.Error,\n-                                \"compiler.err.prob.found.req\"),\n-                        new DiagAndCode(\n-                                \"\"\"\n-                                class Foo {\n-                                    Foo[]! s = null;\n-                                }\n-                                \"\"\",\n-                                Result.Error,\n-                                \"compiler.err.prob.found.req\")\n-                )\n-        );\n-    }\n-\n@@ -224,1 +204,1 @@\n-    void testUncheckedNullnessConversions () {\n+    void testSuspiciousNullnessConversions () {\n@@ -230,2 +210,2 @@\n-                                    void m(Object! s1, String s3) {\n-                                        s1 = s3;\n+                                    void m() {\n+                                        String! s = null;\n@@ -235,2 +215,3 @@\n-                                Result.Clean,\n-                                \"\"),\n+                                Result.Warning,\n+                                \"compiler.warn.suspicious.nullness.conversion\",\n+                                1),\n@@ -239,1 +220,0 @@\n-                                value class Point { }\n@@ -241,2 +221,2 @@\n-                                    void m(Point! s1, Point s3) {\n-                                        s3 = s1;\n+                                    void m() {\n+                                        String[]! s = null;\n@@ -246,2 +226,71 @@\n-                                Result.Clean,\n-                                \"\")\n+                                Result.Warning,\n+                                \"compiler.warn.suspicious.nullness.conversion\",\n+                                1),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Foo {\n+                                    void m() {\n+                                        String! s = (String!)null;\n+                                    }\n+                                }\n+                                \"\"\",\n+                                Result.Warning,\n+                                \"compiler.warn.suspicious.nullness.conversion\",\n+                                1),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Foo {\n+                                    void m() {\n+                                        String[]! s = (String[]!)null;\n+                                    }\n+                                }\n+                                \"\"\",\n+                                Result.Warning,\n+                                \"compiler.warn.suspicious.nullness.conversion\",\n+                                1),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Foo {\n+                                    void m() {\n+                                        g(null);\n+                                    }\n+                                    void g(String! s) { }\n+                                }\n+                                \"\"\",\n+                                Result.Warning,\n+                                \"compiler.warn.suspicious.nullness.conversion\",\n+                                1),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Foo {\n+                                    void m() {\n+                                        g(null);\n+                                    }\n+                                    void g(String[]! s) { }\n+                                }\n+                                \"\"\",\n+                                Result.Warning,\n+                                \"compiler.warn.suspicious.nullness.conversion\",\n+                                1),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Foo {\n+                                    String! m() {\n+                                        return null;\n+                                    }\n+                                }\n+                                \"\"\",\n+                                Result.Warning,\n+                                \"compiler.warn.suspicious.nullness.conversion\",\n+                                1),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Foo {\n+                                    String[]! m() {\n+                                        return null;\n+                                    }\n+                                }\n+                                \"\"\",\n+                                Result.Warning,\n+                                \"compiler.warn.suspicious.nullness.conversion\",\n+                                1)\n","filename":"test\/langtools\/tools\/javac\/nullability\/NullabilityCompilationTests.java","additions":103,"deletions":54,"binary":false,"changes":157,"status":"modified"},{"patch":"@@ -6,1 +6,1 @@\n- * @compile\/fail\/ref=SeparateCompilationTest.out -XDrawDiagnostics SeparateCompilationTest.java\n+ * @compile\/fail\/ref=SeparateCompilationTest.out -Werror -Xlint:null -XDrawDiagnostics SeparateCompilationTest.java\n","filename":"test\/langtools\/tools\/javac\/nullability\/separate\/SeparateCompilationTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1,6 +1,8 @@\n-SeparateCompilationTest.java:13:17: compiler.err.prob.found.req: (compiler.misc.inconvertible.types: compiler.misc.type.null, java.lang.String)\n-SeparateCompilationTest.java:14:21: compiler.err.prob.found.req: (compiler.misc.inconvertible.types: compiler.misc.type.null, java.lang.String[])\n-SeparateCompilationTest.java:15:17: compiler.err.prob.found.req: (compiler.misc.inconvertible.types: compiler.misc.type.null, java.lang.String)\n-SeparateCompilationTest.java:16:21: compiler.err.prob.found.req: (compiler.misc.inconvertible.types: compiler.misc.type.null, java.lang.String[])\n-SeparateCompilationTest.java:17:22: compiler.err.prob.found.req: (compiler.misc.inconvertible.types: compiler.misc.type.null, java.util.List<java.lang.String>)\n-5 errors\n+SeparateCompilationTest.java:13:17: compiler.warn.suspicious.nullness.conversion: java.lang.String, compiler.misc.type.null\n+SeparateCompilationTest.java:14:21: compiler.warn.suspicious.nullness.conversion: java.lang.String[], compiler.misc.type.null\n+SeparateCompilationTest.java:15:17: compiler.warn.suspicious.nullness.conversion: java.lang.String, compiler.misc.type.null\n+SeparateCompilationTest.java:16:21: compiler.warn.suspicious.nullness.conversion: java.lang.String[], compiler.misc.type.null\n+SeparateCompilationTest.java:17:22: compiler.warn.suspicious.nullness.conversion: java.util.List<java.lang.String>, compiler.misc.type.null\n+- compiler.err.warnings.and.werror\n+1 error\n+5 warnings\n","filename":"test\/langtools\/tools\/javac\/nullability\/separate\/SeparateCompilationTest.out","additions":8,"deletions":6,"binary":false,"changes":14,"status":"modified"}]}