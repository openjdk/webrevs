{"files":[{"patch":"@@ -41,0 +41,1 @@\n+import com.sun.tools.javac.util.Assert;\n@@ -46,0 +47,2 @@\n+import java.util.Locale;\n+\n@@ -76,1 +79,1 @@\n-    private final boolean noUseSiteNullChecks;\n+    private final UseSiteNullChecks useSiteNullChecks;\n@@ -89,1 +92,36 @@\n-        noUseSiteNullChecks = Options.instance(context).isSet(\"noUseSiteNullChecks\");\n+        useSiteNullChecks = UseSiteNullChecks.of(Options.instance(context).get(\"useSiteNullChecks\"));\n+    }\n+\n+    private enum UseSiteNullChecks {\n+        NONE(false, false),\n+        METHODS(true, false),\n+        METHODS_AND_FIELDS(true, true, \"methods+fields\");\n+\n+        final boolean generateChecksForMethods;\n+        final boolean generateChecksForFields;\n+        final String compilerOpt;\n+\n+        UseSiteNullChecks(boolean generateChecksForMethods, boolean generateChecksForFields) {\n+            this.generateChecksForMethods = generateChecksForMethods;\n+            this.generateChecksForFields = generateChecksForFields;\n+            this.compilerOpt = name().toLowerCase(Locale.ROOT);\n+        }\n+\n+        UseSiteNullChecks(boolean generateChecksForMethods, boolean generateChecksForFields, String compilerOpt) {\n+            this.generateChecksForMethods = generateChecksForMethods;\n+            this.generateChecksForFields = generateChecksForFields;\n+            this.compilerOpt = compilerOpt;\n+        }\n+\n+        static UseSiteNullChecks of(String compilerOpt) {\n+            if (compilerOpt == null) {\n+                return METHODS_AND_FIELDS;\n+            }\n+            for (UseSiteNullChecks useSiteNullChecks: UseSiteNullChecks.values()) {\n+                if (useSiteNullChecks.compilerOpt.equals(compilerOpt)) {\n+                    return useSiteNullChecks;\n+                }\n+            }\n+            Assert.error(\"Unknown useSiteNullChecks: \" + compilerOpt);\n+            throw new IllegalStateException(\"Unknown useSiteNullChecks: \" + compilerOpt);\n+        }\n@@ -164,1 +202,1 @@\n-            if (!noUseSiteNullChecks &&\n+            if (useSiteNullChecks.generateChecksForFields &&\n@@ -222,1 +260,1 @@\n-        if (!noUseSiteNullChecks) {\n+        if (useSiteNullChecks.generateChecksForMethods) {\n@@ -227,1 +265,1 @@\n-        if (!noUseSiteNullChecks) {\n+        if (useSiteNullChecks.generateChecksForMethods) {\n@@ -236,1 +274,1 @@\n-        if (!noUseSiteNullChecks) {\n+        if (useSiteNullChecks.generateChecksForMethods) {\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/NullChecksWriter.java","additions":44,"deletions":6,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -320,1 +320,1 @@\n-    private static String[] PREVIEW_OPTIONS = {\n+    private static String[] PREVIEW = {\n@@ -325,1 +325,1 @@\n-    private static String[] PREVIEW_PLUS_NO_USE_SITE_OPTIONS = {\n+    private static String[] NO_USE_SITE_CHECKS = {\n@@ -328,1 +328,1 @@\n-            \"-XDnoUseSiteNullChecks\"\n+            \"-XDuseSiteNullChecks=none\"\n@@ -331,2 +331,17 @@\n-    private void testHelper(Path base, String testCode, boolean shouldFail, Class<?> expectedError) throws Exception {\n-        testHelper(base, testCode, shouldFail, expectedError, PREVIEW_OPTIONS);\n+    private static String[] USE_SITE_CHECKS_FOR_METHODS_ONLY = {\n+            \"--enable-preview\",\n+            \"-source\", Integer.toString(Runtime.version().feature()),\n+            \"-XDuseSiteNullChecks=methods\"\n+    };\n+\n+    private static String[] USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS = {\n+            \"--enable-preview\",\n+            \"-source\", Integer.toString(Runtime.version().feature()),\n+            \"-XDuseSiteNullChecks=methods+fields\"\n+    };\n+\n+    private void testHelper(Path base,\n+                            String testCode,\n+                            boolean shouldFail,\n+                            Class<?> expectedError) throws Exception {\n+        testHelper(base, testCode, shouldFail, expectedError, PREVIEW);\n@@ -335,1 +350,5 @@\n-    private void testHelper(Path base, String testCode, boolean shouldFail, Class<?> expectedError, String[] compilerOptions) throws Exception {\n+    private void testHelper(Path base,\n+                            String testCode,\n+                            boolean shouldFail,\n+                            Class<?> expectedError,\n+                            String[] compilerOptions) throws Exception {\n@@ -413,1 +432,1 @@\n-            .options(PREVIEW_OPTIONS)\n+            .options(PREVIEW)\n@@ -502,1 +521,3 @@\n-            testHelper(base, code, false, null, PREVIEW_PLUS_NO_USE_SITE_OPTIONS);\n+            testHelper(base, code, true, NullPointerException.class, USE_SITE_CHECKS_FOR_METHODS_ONLY);\n+            testHelper(base, code, true, NullPointerException.class, USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS);\n+            testHelper(base, code, false, null, NO_USE_SITE_CHECKS);\n@@ -620,1 +641,1 @@\n-                .options(PREVIEW_OPTIONS)\n+                .options(PREVIEW)\n@@ -642,1 +663,1 @@\n-                .options(PREVIEW_PLUS_NO_USE_SITE_OPTIONS)\n+                .options(NO_USE_SITE_CHECKS)\n@@ -707,1 +728,1 @@\n-                .options(PREVIEW_OPTIONS)\n+                .options(USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS) \/\/ equivalent to just using PREVIEW options\n@@ -729,1 +750,1 @@\n-                .options(PREVIEW_OPTIONS)\n+                .options(USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS) \/\/ equivalent to just using PREVIEW options\n","filename":"test\/langtools\/tools\/javac\/nullability\/RuntimeNullChecks.java","additions":33,"deletions":12,"binary":false,"changes":45,"status":"modified"}]}