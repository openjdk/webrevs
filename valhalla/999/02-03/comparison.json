{"files":[{"patch":"@@ -6442,1 +6442,0 @@\n-          assert(klass->is_instance_klass(), \"Sanity check\");\n@@ -6445,1 +6444,1 @@\n-                    err_msg(\"Class %s expects class %s to be a concrete value type, but it is an identity class\",\n+                    err_msg(\"Class %s expects class %s to be a value class, but it is an identity class\",\n@@ -6460,1 +6459,1 @@\n-                    err_msg(\"Null restricted fields with a non-implicitly constructible class are not supported: %s\",\n+                    err_msg(\"class %s is not implicitly constructible and it is used in a null restricted non-static field (not supported)\",\n@@ -6464,1 +6463,1 @@\n-        log_info(class, preload)(\"Preloading of class %s during loading of class %s (cause null-free non-static field) succeeded\", s->as_C_string(), _class_name->as_C_string());\n+        log_info(class, preload)(\"Preloading of class %s during loading of class %s (cause: null-free non-static field) succeeded\", s->as_C_string(), _class_name->as_C_string());\n@@ -6470,1 +6469,1 @@\n-          log_info(class, preload)(\"Preloading class %s during loading of class %s. Cause: field type listed in Preload attribute\", name->as_C_string(), _class_name->as_C_string());\n+          log_info(class, preload)(\"Preloading class %s during loading of class %s. Cause: field type in Preload attribute\", name->as_C_string(), _class_name->as_C_string());\n@@ -6476,1 +6475,1 @@\n-              log_info(class, preload)(\"Preloading of class %s during loading of class %s (cause Preload attribute) succeeded\", name->as_C_string(), _class_name->as_C_string());\n+              log_info(class, preload)(\"Preloading of class %s during loading of class %s (cause: field type in Preload attribute) succeeded\", name->as_C_string(), _class_name->as_C_string());\n","filename":"src\/hotspot\/share\/classfile\/classFileParser.cpp","additions":5,"deletions":6,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -974,1 +974,1 @@\n-          log_info(class, preload)(\"Preloading class %s during linking of class %s because a null-free static field is declared with this type\", s->as_C_string(), name()->as_C_string());\n+          log_info(class, preload)(\"Preloading class %s during linking of class %s. Cause: a null-free static field is declared with this type\", s->as_C_string(), name()->as_C_string());\n@@ -983,1 +983,1 @@\n-          log_info(class, preload)(\"Preloading of class %s during linking of class %s (cause null-free static field) succeeded\",\n+          log_info(class, preload)(\"Preloading of class %s during linking of class %s (cause: null-free static field) succeeded\",\n@@ -988,1 +988,8 @@\n-                       err_msg(\"class %s is not a value class\", klass->external_name()), false);\n+                       err_msg(\"class %s expects class %s to be a value class but it is an identity class\",\n+                       name()->as_C_string(), klass->external_name()), false);\n+          }\n+          if (klass->is_abstract()) {\n+            THROW_MSG_(vmSymbols::java_lang_IncompatibleClassChangeError(),\n+                      err_msg(\"Class %s expects class %s to be concrete value class, but it is an abstract class\",\n+                      name()->as_C_string(),\n+                      InstanceKlass::cast(klass)->external_name()), false);\n@@ -1006,0 +1013,1 @@\n+        log_info(class, preload)(\"Preloading class %s during linking of class %s because of the class is listed in the Preload attribute\", class_name->as_C_string(), name()->as_C_string());\n@@ -1014,1 +1022,5 @@\n-          log_info(class, preload)(\"Preloading class %s during linking of class %s because of its Preload attribute\", class_name->as_C_string(), name()->as_C_string());\n+          log_info(class, preload)(\"Preloading of class %s during linking of class %s (cause: Preload attribute) succeeded\", class_name->as_C_string(), name()->as_C_string());\n+          if (!klass->is_inline_klass()) {\n+            \/\/ Non value class are allowed by the current spec, but it could be an indication of an issue so let's log a warning\n+              log_warning(class, preload)(\"Preloading class %s during linking of class %s (cause: Preload attribute) but loaded class is not a value class\", class_name->as_C_string(), name()->as_C_string());\n+          }\n@@ -1016,1 +1028,1 @@\n-          log_warning(class, preload)(\"Preloading of class %s during linking of class %s (Preload attribute) failed\", class_name->as_C_string(), name()->as_C_string());\n+          log_warning(class, preload)(\"Preloading of class %s during linking of class %s (cause: Preload attribute) failed\", class_name->as_C_string(), name()->as_C_string());\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.cpp","additions":17,"deletions":5,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -75,2 +75,2 @@\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class0c during loading of class PreloadCircularityTest$Class0b (cause null-free non-static field) succeeded\");\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class0b during loading of class PreloadCircularityTest$Class0a (cause null-free non-static field) succeeded\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class0c during loading of class PreloadCircularityTest$Class0b (cause: null-free non-static field) succeeded\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class0b during loading of class PreloadCircularityTest$Class0a (cause: null-free non-static field) succeeded\");\n@@ -98,3 +98,3 @@\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class1c during loading of class PreloadCircularityTest$Class1b. Cause: field type listed in Preload attribute\");\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class1c during loading of class PreloadCircularityTest$Class1b (cause Preload attribute) succeeded\");\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class1b during loading of class PreloadCircularityTest$Class1a (cause null-free non-static field) succeeded\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class1c during loading of class PreloadCircularityTest$Class1b. Cause: field type in Preload attribute\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class1c during loading of class PreloadCircularityTest$Class1b (cause: field type in Preload attribute) succeeded\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class1b during loading of class PreloadCircularityTest$Class1a (cause: null-free non-static field) succeeded\");\n@@ -152,1 +152,1 @@\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class3b during loading of class PreloadCircularityTest$Class3c. Cause: field type listed in Preload attribute\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class3b during loading of class PreloadCircularityTest$Class3c. Cause: field type in Preload attribute\");\n@@ -154,2 +154,2 @@\n-        out.shouldContain(\"[info   ][class,preload] Preloading of class PreloadCircularityTest$Class3c during loading of class PreloadCircularityTest$Class3b (cause null-free non-static field) succeeded\");\n-        out.shouldContain(\"[info   ][class,preload] Preloading of class PreloadCircularityTest$Class3b during loading of class PreloadCircularityTest$Class3a (cause null-free non-static field) succeeded\");\n+        out.shouldContain(\"[info   ][class,preload] Preloading of class PreloadCircularityTest$Class3c during loading of class PreloadCircularityTest$Class3b (cause: null-free non-static field) succeeded\");\n+        out.shouldContain(\"[info   ][class,preload] Preloading of class PreloadCircularityTest$Class3b during loading of class PreloadCircularityTest$Class3a (cause: null-free non-static field) succeeded\");\n@@ -203,1 +203,1 @@\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class5b during loading of class PreloadCircularityTest$Class5a. Cause: field type listed in Preload attribute\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class5b during loading of class PreloadCircularityTest$Class5a. Cause: field type in Preload attribute\");\n@@ -210,1 +210,1 @@\n-        out.shouldContain(\"[info   ][class,preload] Preloading class PreloadCircularityTest$Class5b during loading of class PreloadCircularityTest$Class5c. Cause: field type listed in Preload attribute\");\n+        out.shouldContain(\"[info   ][class,preload] Preloading class PreloadCircularityTest$Class5b during loading of class PreloadCircularityTest$Class5c. Cause: field type in Preload attribute\");\n@@ -216,1 +216,1 @@\n-        out.shouldContain(\"[info   ][class,preload] Preloading of class PreloadCircularityTest$Class5c during loading of class PreloadCircularityTest$Class5a (cause null-free non-static field) succeeded\");\n+        out.shouldContain(\"[info   ][class,preload] Preloading of class PreloadCircularityTest$Class5c during loading of class PreloadCircularityTest$Class5a (cause: null-free non-static field) succeeded\");\n@@ -246,2 +246,2 @@\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class6c during loading of class PreloadCircularityTest$Class6b. Cause: field type listed in Preload attribute\");\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class6c during loading of class PreloadCircularityTest$Class6b (cause Preload attribute) succeeded\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class6c during loading of class PreloadCircularityTest$Class6b. Cause: field type in Preload attribute\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class6c during loading of class PreloadCircularityTest$Class6b (cause: field type in Preload attribute) succeeded\");\n@@ -288,1 +288,1 @@\n-        out.shouldContain(\"java.lang.IncompatibleClassChangeError: Class PreloadCircularityTest$Class9a expects class PreloadCircularityTest$Class9b to be a concrete value type, but it is an identity class\");\n+        out.shouldContain(\"java.lang.IncompatibleClassChangeError: Class PreloadCircularityTest$Class9a expects class PreloadCircularityTest$Class9b to be a value class, but it is an identity class\");\n@@ -302,1 +302,1 @@\n-        out.shouldContain(\"java.lang.IncompatibleClassChangeError: Null restricted fields with a non-implicitly constructible class are not supported: PreloadCircularityTest$Class10b\");\n+        out.shouldContain(\"java.lang.IncompatibleClassChangeError: class PreloadCircularityTest$Class10b is not implicitly constructible and it is used in a null restricted non-static field (not supported)\");\n@@ -343,3 +343,3 @@\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class51b during linking of class PreloadCircularityTest$Class51a because a null-free static field is declared with this type\");\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class51b during linking of class PreloadCircularityTest$Class51a (cause null-free static field) succeeded\");\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class51c during linking of class PreloadCircularityTest$Class51a because a null-free static field is declared with this type\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class51b during linking of class PreloadCircularityTest$Class51a. Cause: a null-free static field is declared with this type\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class51b during linking of class PreloadCircularityTest$Class51a (cause: null-free static field) succeeded\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class51c during linking of class PreloadCircularityTest$Class51a. Cause: a null-free static field is declared with this type\");\n@@ -347,4 +347,4 @@\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class51a during loading of class PreloadCircularityTest$Class51c (cause null-free non-static field) succeeded\");\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class51c during linking of class PreloadCircularityTest$Class51a (cause null-free static field) succeeded\");\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class51a during linking of class PreloadCircularityTest$Class51b because a null-free static field is declared with this type\");\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class51a during linking of class PreloadCircularityTest$Class51b (cause null-free static field) succeeded\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class51a during loading of class PreloadCircularityTest$Class51c (cause: null-free non-static field) succeeded\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class51c during linking of class PreloadCircularityTest$Class51a (cause: null-free static field) succeeded\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class51a during linking of class PreloadCircularityTest$Class51b. Cause: a null-free static field is declared with this type\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class51a during linking of class PreloadCircularityTest$Class51b (cause: null-free static field) succeeded\");\n@@ -373,1 +373,1 @@\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class52b during linking of class PreloadCircularityTest$Class52a because a null-free static field is declared with this type\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class52b during linking of class PreloadCircularityTest$Class52a. Cause: a null-free static field is declared with this type\");\n@@ -399,1 +399,1 @@\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class53b during loading of class PreloadCircularityTest$Class53a. Cause: field type listed in Preload attribute\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class53b during loading of class PreloadCircularityTest$Class53a. Cause: field type in Preload attribute\");\n@@ -403,1 +403,1 @@\n-        out.shouldContain(\"[info   ][class,preload] Preloading class PreloadCircularityTest$Class53b during linking of class PreloadCircularityTest$Class53a because a null-free static field is declared with this type\");\n+        out.shouldContain(\"[info   ][class,preload] Preloading class PreloadCircularityTest$Class53b during linking of class PreloadCircularityTest$Class53a. Cause: a null-free static field is declared with this type\");\n@@ -405,2 +405,2 @@\n-        out.shouldContain(\"[info   ][class,preload] Preloading of class PreloadCircularityTest$Class53a during loading of class PreloadCircularityTest$Class53b (cause null-free non-static field) succeeded\");\n-        out.shouldContain(\"[info   ][class,preload] Preloading of class PreloadCircularityTest$Class53b during linking of class PreloadCircularityTest$Class53a (cause null-free static field) succeeded\");\n+        out.shouldContain(\"[info   ][class,preload] Preloading of class PreloadCircularityTest$Class53a during loading of class PreloadCircularityTest$Class53b (cause: null-free non-static field) succeeded\");\n+        out.shouldContain(\"[info   ][class,preload] Preloading of class PreloadCircularityTest$Class53b during linking of class PreloadCircularityTest$Class53a (cause: null-free static field) succeeded\");\n@@ -419,3 +419,3 @@\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class54b during linking of class PreloadCircularityTest$Class54a because a null-free static field is declared with this type\");\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class54b during linking of class PreloadCircularityTest$Class54a (cause null-free static field) succeeded\");\n-        out.shouldContain(\"java.lang.IncompatibleClassChangeError: class PreloadCircularityTest$Class54b is not a value class\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class54b during linking of class PreloadCircularityTest$Class54a. Cause: a null-free static field is declared with this type\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class54b during linking of class PreloadCircularityTest$Class54a (cause: null-free static field) succeeded\");\n+        out.shouldContain(\"java.lang.IncompatibleClassChangeError: class PreloadCircularityTest$Class54a expects class PreloadCircularityTest$Class54b to be a value class but it is an identity class\");\n@@ -434,2 +434,2 @@\n-        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class55b during linking of class PreloadCircularityTest$Class55a because a null-free static field is declared with this type\");\n-        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class55b during linking of class PreloadCircularityTest$Class55a (cause null-free static field) succeeded\");\n+        out.shouldContain(\"[info][class,preload] Preloading class PreloadCircularityTest$Class55b during linking of class PreloadCircularityTest$Class55a. Cause: a null-free static field is declared with this type\");\n+        out.shouldContain(\"[info][class,preload] Preloading of class PreloadCircularityTest$Class55b during linking of class PreloadCircularityTest$Class55a (cause: null-free static field) succeeded\");\n","filename":"test\/hotspot\/jtreg\/runtime\/valhalla\/inlinetypes\/PreloadCircularityTest.java","additions":32,"deletions":32,"binary":false,"changes":64,"status":"modified"},{"patch":"@@ -56,1 +56,1 @@\n-        checkFor(pb, \"[info][class,preload] Preloading class PreloadValue0 during linking of class ValuePreloadClient0 because of its Preload attribute\");\n+        checkFor(pb, \"[info][class,preload] Preloading class PreloadValue0 during loading of class ValuePreloadClient0. Cause: field type in Preload attribute\");\n@@ -59,1 +59,1 @@\n-        checkFor(pb, \"[warning][class,preload] Preloading of class PreloadValue1 during linking of class ValuePreloadClient1 (Preload attribute) failed\");\n+        checkFor(pb, \"[warning][class,preload] Preloading of class PreloadValue1 during linking of class ValuePreloadClient1 (cause: Preload attribute) failed\");\n","filename":"test\/hotspot\/jtreg\/runtime\/valhalla\/inlinetypes\/ValuePreloadTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}