{"files":[{"patch":"@@ -61,3 +61,0 @@\n-bool CDSConfig::_module_patching_disables_cds = false;\n-bool CDSConfig::_java_base_module_patching_disables_cds = false;\n-\n@@ -341,1 +338,2 @@\n-    \"jdk.module.upgrade.path\"\n+    \"jdk.module.upgrade.path\",\n+    \"jdk.module.patch.0\"\n@@ -345,1 +343,2 @@\n-    \"--upgrade-module-path\"\n+    \"--upgrade-module-path\",\n+    \"--patch-module\"\n@@ -368,6 +367,0 @@\n-\n-  if (module_patching_disables_cds()) {\n-    vm_exit_during_initialization(\n-            \"Cannot use the following option when dumping the shared archive\", \"--patch-module\");\n-  }\n-\n@@ -402,10 +395,0 @@\n-\n-  if (module_patching_disables_cds()) {\n-    if (RequireSharedSpaces) {\n-      warning(\"CDS is disabled when the %s option is specified.\", \"--patch-module\");\n-    } else {\n-      log_info(cds)(\"CDS is disabled when the %s option is specified.\", \"--patch-module\");\n-    }\n-    return true;\n-  }\n-\n@@ -646,1 +629,1 @@\n-bool CDSConfig::check_vm_args_consistency(bool mode_flag_cmd_line) {\n+bool CDSConfig::check_vm_args_consistency(bool patch_mod_javabase, bool mode_flag_cmd_line) {\n@@ -721,1 +704,1 @@\n-  if (is_using_archive() && java_base_module_patching_disables_cds() && module_patching_disables_cds()) {\n+  if (is_using_archive() && patch_mod_javabase) {\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.cpp","additions":6,"deletions":23,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -49,3 +49,0 @@\n-  static bool _module_patching_disables_cds;\n-  static bool _java_base_module_patching_disables_cds;\n-\n@@ -103,1 +100,1 @@\n-  static bool check_vm_args_consistency(bool mode_flag_cmd_line) NOT_CDS_RETURN_(true);\n+  static bool check_vm_args_consistency(bool patch_mod_javabase, bool mode_flag_cmd_line) NOT_CDS_RETURN_(true);\n@@ -105,4 +102,0 @@\n-  static bool module_patching_disables_cds() { return CDS_ONLY(_module_patching_disables_cds) NOT_CDS(false); }\n-  static void set_module_patching_disables_cds() { CDS_ONLY(_module_patching_disables_cds = true;) }\n-  static bool java_base_module_patching_disables_cds() { return CDS_ONLY(_java_base_module_patching_disables_cds) NOT_CDS(false); }\n-  static void set_java_base_module_patching_disables_cds() { CDS_ONLY(_java_base_module_patching_disables_cds = true;) }\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.hpp","additions":1,"deletions":8,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -953,1 +953,0 @@\n-  assert(!CDSConfig::module_patching_disables_cds(), \"Cannot use CDS\");\n@@ -1029,1 +1028,1 @@\n-        assert(!CDSConfig::module_patching_disables_cds(), \"Cannot use CDS\");\n+        assert(!mod_entry->is_patched(), \"cannot load archived classes for patched module\");\n","filename":"src\/hotspot\/share\/classfile\/systemDictionary.cpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -1800,0 +1800,1 @@\n+static unsigned int patch_mod_count = 0;\n@@ -1807,1 +1808,1 @@\n-  if (!CDSConfig::check_vm_args_consistency(mode_flag_cmd_line)) {\n+  if (!CDSConfig::check_vm_args_consistency(patch_mod_javabase, mode_flag_cmd_line)) {\n@@ -2056,1 +2057,1 @@\n-      add_patch_mod_prefix(module_name, module_equal + 1, false \/* no append *\/, false \/* no cds *\/);\n+      add_patch_mod_prefix(module_name, module_equal + 1);\n@@ -2058,22 +2059,1 @@\n-    } else {\n-      return JNI_ENOMEM;\n-    }\n-  }\n-  return JNI_OK;\n-}\n-\n-\/\/ Finalize --patch-module args and --enable-preview related to value class module patches.\n-\/\/ Create all numbered properties passing module patches.\n-int Arguments::finalize_patch_module() {\n-  \/\/ Create numbered properties for each module that has been patched by --patch-module.\n-  \/\/ Format is \"jdk.module.patch.<n>=<module_name>=<path>\"\n-  if (_patch_mod_prefix != nullptr) {\n-    char * prop_value = AllocateHeap(JVM_MAXPATHLEN + JVM_MAXPATHLEN + 1, mtArguments);\n-    unsigned int patch_mod_count = 0;\n-\n-    for (GrowableArrayIterator<ModulePatchPath *> it = _patch_mod_prefix->begin();\n-            it != _patch_mod_prefix->end(); ++it) {\n-      jio_snprintf(prop_value, JVM_MAXPATHLEN + JVM_MAXPATHLEN + 1, \"%s=%s\",\n-                   (*it)->module_name(), (*it)->path_string());\n-      if (!create_numbered_module_property(\"jdk.module.patch\", prop_value, patch_mod_count++)) {\n-        FreeHeap(prop_value);\n+      if (!create_numbered_module_property(\"jdk.module.patch\", patch_mod_tail, patch_mod_count++)) {\n@@ -2082,0 +2062,2 @@\n+    } else {\n+      return JNI_ENOMEM;\n@@ -2083,1 +2065,0 @@\n-    FreeHeap(prop_value);\n@@ -2879,5 +2860,10 @@\n-void Arguments::add_patch_mod_prefix(const char* module_name, const char* path, bool allow_append, bool allow_cds) {\n-  if (!allow_cds) {\n-    CDSConfig::set_module_patching_disables_cds();\n-    if (strcmp(module_name, JAVA_BASE_NAME) == 0) {\n-      CDSConfig::set_java_base_module_patching_disables_cds();\n+void Arguments::add_patch_mod_prefix(const char* module_name, const char* path) {\n+  \/\/ For java.base check for duplicate --patch-module options being specified on the command line.\n+  \/\/ This check is only required for java.base, all other duplicate module specifications\n+  \/\/ will be checked during module system initialization.  The module system initialization\n+  \/\/ will throw an ExceptionInInitializerError if this situation occurs.\n+  if (strcmp(module_name, JAVA_BASE_NAME) == 0) {\n+    if (patch_mod_javabase) {\n+      vm_exit_during_initialization(\"Cannot specify \" JAVA_BASE_NAME \" more than once to --patch-module\");\n+    } else {\n+      patch_mod_javabase = true;\n@@ -2892,18 +2878,1 @@\n-  \/\/ Scan patches for matching module\n-  int i = _patch_mod_prefix->find_if([&](ModulePatchPath* patch) {\n-    return (strcmp(module_name, patch->module_name()) == 0);\n-  });\n-  if (i == -1) {\n-    _patch_mod_prefix->push(new ModulePatchPath(module_name, path));\n-  } else {\n-    if (allow_append) {\n-      \/\/ append path to existing module entry\n-      _patch_mod_prefix->at(i)->append_path(path);\n-    } else {\n-      if (strcmp(module_name, JAVA_BASE_NAME) == 0) {\n-        vm_exit_during_initialization(\"Cannot specify \" JAVA_BASE_NAME \" more than once to --patch-module\");\n-      } else {\n-        vm_exit_during_initialization(\"Cannot specify a module more than once to --patch-module\", module_name);\n-      }\n-    }\n-  }\n+  _patch_mod_prefix->push(new ModulePatchPath(module_name, path));\n@@ -3024,5 +2993,0 @@\n-  \/\/ finalize --module-patch.\n-  if (finalize_patch_module() != JNI_OK) {\n-    return JNI_ERR;\n-  }\n-\n","filename":"src\/hotspot\/share\/runtime\/arguments.cpp","additions":18,"deletions":54,"binary":false,"changes":72,"status":"modified"},{"patch":"@@ -481,1 +481,1 @@\n-  static void add_patch_mod_prefix(const char *module_name, const char *path, bool allow_append, bool allow_cds);\n+  static void add_patch_mod_prefix(const char *module_name, const char *path);\n","filename":"src\/hotspot\/share\/runtime\/arguments.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -47,1 +47,1 @@\n-    output.shouldContain(\"Cannot specify a module more than once to --patch-module\");\n+    output.shouldContain(\"java.lang.ExceptionInInitializerError\");\n","filename":"test\/hotspot\/jtreg\/runtime\/modules\/PatchModule\/PatchModuleDupModule.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -138,19 +138,0 @@\n-    \/**\n-     * Test with --patch-module options patching the same module (not java.base).\n-     *\n-     *\/\n-    public void testDuplicateModuleLogging() throws Exception {\n-        int exitValue =\n-            executeTestJava(\"--patch-module\", \"java.logging=\" + PATCHES1_DIR.resolve(\"java.base\"),\n-                            \"--patch-module\", \"java.logging=\" + PATCHES2_DIR.resolve(\"java.base\"),\n-                            \"--module-path\", MODS_DIR.toString(),\n-                            \"-m\", \"test\/jdk.test.Main\")\n-                .outputTo(System.out)\n-                .errorTo(System.out)\n-                \/\/ error output by VM\n-                .shouldContain(\"Cannot specify a module more than once to --patch-module: java.logging\")\n-                .getExitValue();\n-\n-        assertTrue(exitValue != 0);\n-    }\n-\n","filename":"test\/jdk\/tools\/launcher\/modules\/patch\/basic\/PatchTestWarningError.java","additions":0,"deletions":19,"binary":false,"changes":19,"status":"modified"}]}