{"files":[{"patch":"@@ -102,6 +102,6 @@\n-\/\/ JImageMode status to control preview behaviour. JImage_file is unusable\n-\/\/ for normal lookup until (JImage_mode != JIMAGE_MODE_UNINITIALIZED).\n-enum JImageMode {\n-  JIMAGE_MODE_UNINITIALIZED = 0,\n-  JIMAGE_MODE_DEFAULT = 1,\n-  JIMAGE_MODE_ENABLE_PREVIEW = 2\n+\/\/ PreviewMode status to control preview behaviour. JImage_file is unusable\n+\/\/ for normal lookup until (Preview_mode != PREVIEW_MODE_UNINITIALIZED).\n+enum PreviewMode {\n+  PREVIEW_MODE_UNINITIALIZED = 0,\n+  PREVIEW_MODE_DEFAULT = 1,\n+  PREVIEW_MODE_ENABLE_PREVIEW = 2\n@@ -109,1 +109,1 @@\n-static JImageMode                      JImage_mode            = JIMAGE_MODE_UNINITIALIZED;\n+static PreviewMode                     Preview_mode           = PREVIEW_MODE_UNINITIALIZED;\n@@ -237,1 +237,1 @@\n-\/\/ The following jimage_xxx static functions encapsulate all JImage_file and JImage_mode access.\n+\/\/ The following jimage_xxx static functions encapsulate all JImage_file and Preview_mode access.\n@@ -269,7 +269,0 @@\n-\/\/ Called once to set the access mode for resource (i.e. preview or non-preview) before\n-\/\/ general resource lookup can occur.\n-static void jimage_init(bool enable_preview) {\n-  assert(JImage_mode == JIMAGE_MODE_UNINITIALIZED, \"jimage_init must not be called twice\");\n-  JImage_mode = enable_preview ? JIMAGE_MODE_ENABLE_PREVIEW : JIMAGE_MODE_DEFAULT;\n-}\n-\n@@ -279,1 +272,1 @@\n-  return jimage_exists() && JImage_mode != JIMAGE_MODE_UNINITIALIZED;\n+  return jimage_exists() && Preview_mode != PREVIEW_MODE_UNINITIALIZED;\n@@ -283,3 +276,2 @@\n-static bool jimage_is_preview_enabled() {\n-  assert(jimage_is_initialized(), \"jimage is not initialized\");\n-  return JImage_mode == JIMAGE_MODE_ENABLE_PREVIEW;\n+static bool is_preview_enabled() {\n+  return Preview_mode == PREVIEW_MODE_ENABLE_PREVIEW;\n@@ -468,1 +460,1 @@\n-  bool is_preview = jimage_is_preview_enabled();\n+  const bool is_preview = is_preview_enabled();\n@@ -697,1 +689,1 @@\n-  \/\/ 10 represents the length of \"modules\" + 2 file separators + \\0\n+  \/\/ 10 represents the length of \"modules\" (7) + 2 file separators + \\0\n@@ -704,0 +696,10 @@\n+\/\/ Gets a preview path for a given class path as a resource.\n+static const char* get_preview_path(const char* path) {\n+  const char file_sep = os::file_separator()[0];\n+  \/\/ 18 represents the length of \"META-INF\" (8) + \"preview\" (7) + 2 file separators + \\0\n+  size_t len = strlen(path) + 18;\n+  char *preview_path = NEW_RESOURCE_ARRAY(char, len);\n+  jio_snprintf(preview_path, len, \"%s%cMETA-INF%cpreview\", path, file_sep, file_sep);\n+  return preview_path;\n+}\n+\n@@ -719,1 +721,0 @@\n-\n@@ -726,0 +727,15 @@\n+      log_info(class, load)(\"path: %s\", path);\n+\n+      \/\/ If we are in preview mode, attempt to add a preview entry *before* the\n+      \/\/ new class path entry if a preview path exists.\n+      if (is_preview_enabled()) {\n+        const char* preview_path = get_preview_path(path);\n+        if (os::stat(preview_path, &st) == 0) {\n+          ClassPathEntry* preview_entry = create_class_path_entry(current, preview_path, &st);\n+          if (preview_entry != nullptr) {\n+            module_cpl->add_to_list(preview_entry);\n+            log_info(class, load)(\"preview path: %s\", preview_path);\n+          }\n+        }\n+      }\n+\n@@ -731,1 +747,0 @@\n-      log_info(class, load)(\"path: %s\", path);\n@@ -1480,1 +1495,1 @@\n-    \/\/ Special case where we lookup the options string *before* calling jimage_init().\n+    \/\/ Special case where we lookup the options string *before* set_preview_mode() is called.\n@@ -1497,4 +1512,3 @@\n-void ClassLoader::init_jimage(bool enable_preview) {\n-  if (jimage_exists()) {\n-    jimage_init(enable_preview);\n-  }\n+void ClassLoader::set_preview_mode(bool enable_preview) {\n+  assert(Preview_mode == PREVIEW_MODE_UNINITIALIZED, \"set_preview_mode must not be called twice\");\n+  Preview_mode = enable_preview ? PREVIEW_MODE_ENABLE_PREVIEW : PREVIEW_MODE_DEFAULT;\n","filename":"src\/hotspot\/share\/classfile\/classLoader.cpp","additions":42,"deletions":28,"binary":false,"changes":70,"status":"modified"},{"patch":"@@ -363,1 +363,1 @@\n-  static void init_jimage(bool enable_preview);\n+  static void set_preview_mode(bool enable_preview);\n","filename":"src\/hotspot\/share\/classfile\/classLoader.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -3041,1 +3041,1 @@\n-  ClassLoader::init_jimage(is_valhalla_enabled());\n+  ClassLoader::set_preview_mode(is_valhalla_enabled());\n","filename":"src\/hotspot\/share\/runtime\/arguments.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}