{"files":[{"patch":"@@ -495,1 +495,1 @@\n-\/\/ FakeOop (and subclasses FakeMirror, FakeString, FakeObjArray, FakeTypeArray) are used to traverse\n+\/\/ FakeOop (and subclasses FakeMirror, FakeString, FakeRefArray, FakeFlatArray, FakeTypeArray) are used to traverse\n@@ -533,1 +533,2 @@\n-  FakeObjArray as_obj_array();\n+  FakeRefArray as_ref_array();\n+  FakeFlatArray as_flat_array();\n@@ -621,3 +622,3 @@\n-class AOTMapLogger::FakeObjArray : public AOTMapLogger::FakeOop {\n-  objArrayOop raw_objArrayOop() {\n-    return (objArrayOop)raw_oop();\n+class AOTMapLogger::FakeRefArray : public AOTMapLogger::FakeOop {\n+  refArrayOop raw_refArrayOop() {\n+    return (refArrayOop)raw_oop();\n@@ -627,1 +628,1 @@\n-  FakeObjArray(OopDataIterator* iter, OopData data) : FakeOop(iter, data) {}\n+  FakeRefArray(OopDataIterator* iter, OopData data) : FakeOop(iter, data) {}\n@@ -630,1 +631,1 @@\n-    return raw_objArrayOop()->length();\n+    return raw_refArrayOop()->length();\n@@ -634,1 +635,1 @@\n-      return read_oop_at(raw_objArrayOop()->obj_at_addr<narrowOop>(i));\n+      return read_oop_at(raw_refArrayOop()->obj_at_addr<narrowOop>(i));\n@@ -636,1 +637,1 @@\n-      return read_oop_at(raw_objArrayOop()->obj_at_addr<oop>(i));\n+      return read_oop_at(raw_refArrayOop()->obj_at_addr<oop>(i));\n@@ -639,1 +640,18 @@\n-}; \/\/ AOTMapLogger::FakeObjArray\n+}; \/\/ AOTMapLogger::FakeRefArray\n+\n+class AOTMapLogger::FakeFlatArray : public AOTMapLogger::FakeOop {\n+  flatArrayOop raw_flatArrayOop() {\n+    return (flatArrayOop)raw_oop();\n+  }\n+\n+public:\n+  FakeFlatArray(OopDataIterator* iter, OopData data) : FakeOop(iter, data) {}\n+\n+  int length() {\n+    return raw_flatArrayOop()->length();\n+  }\n+  void print_elements_on(outputStream* st) {\n+    FlatArrayKlass::cast(real_klass())->oop_print_elements_on(raw_flatArrayOop(), st);\n+  }\n+\n+}; \/\/ AOTMapLogger::FakeRefArray\n@@ -679,3 +697,8 @@\n-AOTMapLogger::FakeObjArray AOTMapLogger::FakeOop::as_obj_array() {\n-  precond(real_klass()->is_objArray_klass());\n-  return FakeObjArray(_iter, _data);\n+AOTMapLogger::FakeRefArray AOTMapLogger::FakeOop::as_ref_array() {\n+  precond(real_klass()->is_refArray_klass());\n+  return FakeRefArray(_iter, _data);\n+}\n+\n+AOTMapLogger::FakeFlatArray AOTMapLogger::FakeOop::as_flat_array() {\n+  precond(real_klass()->is_flatArray_klass());\n+  return FakeFlatArray(_iter, _data);\n@@ -926,2 +949,6 @@\n-  } else if (real_klass->is_objArray_klass()) {\n-    FakeObjArray fake_obj_array = fake_oop.as_obj_array();\n+  } else if (real_klass->is_flatArray_klass()) {\n+    \/\/ Archiving FlatArrayOop with embedded oops is not supported.\n+    \/\/ TODO: add restriction.\n+    fake_oop.as_flat_array().print_elements_on(st);\n+  } else if (real_klass->is_refArray_klass()) {\n+    FakeRefArray fake_obj_array = fake_oop.as_ref_array();\n","filename":"src\/hotspot\/share\/cds\/aotMapLogger.cpp","additions":42,"deletions":15,"binary":false,"changes":57,"status":"modified"},{"patch":"@@ -72,1 +72,2 @@\n-  class   FakeObjArray;\n+  class   FakeRefArray;\n+  class   FakeFlatArray;\n","filename":"src\/hotspot\/share\/cds\/aotMapLogger.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -439,0 +439,1 @@\n+    assert(!EnableValhalla || Universe::objectArrayKlass()->prototype_header() == markWord::prototype(), \"should be the same\");\n@@ -645,1 +646,2 @@\n-    fake_oop->set_mark(markWord::prototype().set_narrow_klass(nk));\n+    markWord prototype_header = src_klass->prototype_header().set_narrow_klass(nk);\n+    fake_oop->set_mark(prototype_header);\n@@ -658,1 +660,1 @@\n-      fake_oop->set_mark(markWord::prototype().set_narrow_klass(nk).copy_set_hash(src_hash));\n+      fake_oop->set_mark(fake_oop->mark().copy_set_hash(src_hash));\n","filename":"src\/hotspot\/share\/cds\/aotMappedHeapWriter.cpp","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -393,1 +393,1 @@\n-  markWord mw = markWord::prototype();\n+  markWord mw = Arguments::enable_preview() ? src_klass->prototype_header() : markWord::prototype();\n@@ -400,1 +400,1 @@\n-  if (src_obj != nullptr) {\n+  if (src_obj != nullptr && !src_klass->is_inline_klass()) {\n","filename":"src\/hotspot\/share\/cds\/aotStreamedHeapWriter.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -406,1 +406,0 @@\n-\n@@ -411,14 +410,1 @@\n-  InlineKlass* vk = element_klass();\n-  int print_len = MIN2(va->length(), MaxElementPrintSize);\n-  for(int index = 0; index < print_len; index++) {\n-    int off = (address) va->value_at_addr(index, layout_helper()) - cast_from_oop<address>(obj);\n-    st->print_cr(\" - Index %3d offset %3d: \", index, off);\n-    oop obj = cast_to_oop((address)va->value_at_addr(index, layout_helper()) - vk->payload_offset());\n-    FieldPrinter print_field(st, obj);\n-    vk->do_nonstatic_fields(&print_field);\n-    st->cr();\n-  }\n-  int remaining = va->length() - print_len;\n-  if (remaining > 0) {\n-    st->print_cr(\" - <%d more elements, increase MaxElementPrintSize to print>\", remaining);\n-  }\n+  oop_print_elements_on(va, st);\n@@ -448,0 +434,17 @@\n+void FlatArrayKlass::oop_print_elements_on(flatArrayOop fa, outputStream* st) {\n+  InlineKlass* vk = element_klass();\n+  int print_len = MIN2(fa->length(), MaxElementPrintSize);\n+  for(int index = 0; index < print_len; index++) {\n+    int off = (address) fa->value_at_addr(index, layout_helper()) - cast_from_oop<address>(fa);\n+    st->print_cr(\" - Index %3d offset %3d: \", index, off);\n+    oop obj = cast_to_oop((address)fa->value_at_addr(index, layout_helper()) - vk->payload_offset());\n+    FieldPrinter print_field(st, obj);\n+    vk->do_nonstatic_fields(&print_field);\n+    st->cr();\n+  }\n+  int remaining = fa->length() - print_len;\n+  if (remaining > 0) {\n+    st->print_cr(\" - <%d more elements, increase MaxElementPrintSize to print>\", remaining);\n+  }\n+}\n+\n","filename":"src\/hotspot\/share\/oops\/flatArrayKlass.cpp","additions":18,"deletions":15,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -148,0 +148,1 @@\n+  void oop_print_elements_on(flatArrayOop fa, outputStream* st);\n","filename":"src\/hotspot\/share\/oops\/flatArrayKlass.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -46,1 +46,0 @@\n-  friend class AOTMapLogger;\n","filename":"src\/hotspot\/share\/oops\/objArrayOop.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -47,0 +47,1 @@\n+  friend class AOTMapLogger;\n","filename":"src\/hotspot\/share\/oops\/refArrayOop.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}