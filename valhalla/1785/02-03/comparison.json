{"files":[{"patch":"@@ -1475,0 +1475,17 @@\n+    static bool should_preserve_mark(oop obj, HeapWord* end_addr) {\n+      size_t remaining_words = pointer_delta(end_addr, cast_from_oop<HeapWord*>(obj));\n+\n+      if (EnableValhalla && !safe_to_read_header(remaining_words)) {\n+        \/\/ When using Valhalla, it might be necessary to preserve the Valhalla-\n+        \/\/ specific bits in the markWord. If the entire object header is\n+        \/\/ copied, the correct markWord (with the appropriate Valhalla bits)\n+        \/\/ can be safely read from the Klass. However, if the full header is\n+        \/\/ not copied, we cannot safely read the Klass to obtain this information.\n+        \/\/ In such cases, we always preserve the markWord to ensure that all\n+        \/\/ relevant bits, including Valhalla-specific ones, are retained.\n+        return true;\n+      } else {\n+        return obj->mark().must_be_preserved();\n+      }\n+    }\n+\n@@ -1491,10 +1508,1 @@\n-          size_t remaining_words = pointer_delta(end, cur_addr);\n-\n-          if (EnableValhalla && !safe_to_read_header(remaining_words)) {\n-            \/\/ When using Valhalla, it might be necessary to preserve the Valhalla-\n-            \/\/ specific bits in the markWord. If the entire object header is\n-            \/\/ copied, the correct markWord (with the appropriate Valhalla bits)\n-            \/\/ can be safely read from the Klass. However, if the full header is\n-            \/\/ not copied, we cannot safely read the Klass to obtain this information.\n-            \/\/ In such cases, we always preserve the markWord to ensure that all\n-            \/\/ relevant bits, including Valhalla-specific ones, are retained.\n+          if (should_preserve_mark(obj, end)) {\n@@ -1502,2 +1510,0 @@\n-          } else {\n-            cm->preserved_marks()->push_if_necessary(obj, obj->mark());\n@@ -2147,1 +2153,1 @@\n-static markWord safe_mark_prototype(HeapWord* addr, size_t words) {\n+static markWord safe_mark_word_prototype(HeapWord* cur_addr, HeapWord* end_addr) {\n@@ -2152,0 +2158,1 @@\n+  size_t remaining_words = pointer_delta(end_addr, cur_addr);\n@@ -2153,2 +2160,2 @@\n-  if (UseCompactObjectHeaders || (EnableValhalla && safe_to_read_header(words))) {\n-    return cast_to_oop(addr)->klass()->prototype_header();\n+  if (UseCompactObjectHeaders || (EnableValhalla && safe_to_read_header(remaining_words))) {\n+    return cast_to_oop(cur_addr)->klass()->prototype_header();\n@@ -2276,2 +2283,1 @@\n-      size_t remaining_words = pointer_delta(end_addr, cur_addr);\n-      markWord mark = safe_mark_prototype(cur_addr, remaining_words);\n+      markWord mark = safe_mark_word_prototype(cur_addr, end_addr);\n@@ -2279,0 +2285,1 @@\n+      \/\/ Perform the move and update of the object\n","filename":"src\/hotspot\/share\/gc\/parallel\/psParallelCompact.cpp","additions":24,"deletions":17,"binary":false,"changes":41,"status":"modified"}]}