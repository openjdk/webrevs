{"files":[{"patch":"@@ -30,0 +30,1 @@\n+ * @enablePreview\n@@ -36,1 +37,0 @@\n- *     jdk.jdeps\/com.sun.tools.classfile\n@@ -39,1 +39,0 @@\n- * @ignore\n@@ -52,14 +51,5 @@\n-import com.sun.tools.classfile.Attribute;\n-import com.sun.tools.classfile.Attributes;\n-import com.sun.tools.classfile.ClassFile;\n-import com.sun.tools.classfile.Code_attribute;\n-import com.sun.tools.classfile.ConstantPool;\n-import com.sun.tools.classfile.ConstantPool.CONSTANT_Class_info;\n-import com.sun.tools.classfile.ConstantPool.CONSTANT_Fieldref_info;\n-import com.sun.tools.classfile.ConstantPool.CONSTANT_Methodref_info;\n-import com.sun.tools.classfile.ImplicitCreation_attribute;\n-import com.sun.tools.classfile.NullRestricted_attribute;\n-import com.sun.tools.classfile.Field;\n-import com.sun.tools.classfile.Instruction;\n-import com.sun.tools.classfile.Method;\n-import com.sun.tools.classfile.Signature_attribute;\n+import java.lang.classfile.Attribute;\n+import java.lang.classfile.Attributes;\n+import java.lang.classfile.ClassFile;\n+import java.lang.classfile.Instruction;\n+import java.lang.classfile.Opcode;\n@@ -89,1 +79,1 @@\n-                        Test! t = new Test();\n+                        String! t = \"\";\n@@ -92,1 +82,1 @@\n-                    \"LTest!;\"\n+                    \"!Ljava\/lang\/String;\"\n@@ -95,8 +85,0 @@\n-                    \"\"\"\n-                    class Test {\n-                        Test? t;\n-                    }\n-                    \"\"\",\n-                    \"LTest?;\"\n-            ),\n-            new SignatureData( \/\/ case 2\n@@ -106,1 +88,1 @@\n-                        List<Test!> t;\n+                        List<Test>! t = new ArrayList<>();\n@@ -109,1 +91,1 @@\n-                    \"Ljava\/util\/List<LTest!;>;\"\n+                    \"!Ljava\/util\/List<LTest;>;\"\n@@ -111,28 +93,1 @@\n-            new SignatureData( \/\/ case 3\n-                    \"\"\"\n-                    import java.util.*;\n-                    class Test {\n-                        List<Test?> t;\n-                    }\n-                    \"\"\",\n-                    \"Ljava\/util\/List<LTest?;>;\"\n-            ),\n-            new SignatureData( \/\/ case 4\n-                    \"\"\"\n-                    import java.util.*;\n-                    class Test {\n-                        List!<Test!> t = new ArrayList<>();\n-                    }\n-                    \"\"\",\n-                    \"Ljava\/util\/List<LTest!;>!;\"\n-            ),\n-            new SignatureData( \/\/ case 5\n-                    \"\"\"\n-                    import java.util.*;\n-                    class Test {\n-                        List?<Test?> t;\n-                    }\n-                    \"\"\",\n-                    \"Ljava\/util\/List<LTest?;>?;\"\n-            ),\n-            new SignatureData( \/\/ case 6\n+            new SignatureData( \/\/ case 2\n@@ -144,9 +99,1 @@\n-                    \"TT!;\"\n-            ),\n-            new SignatureData( \/\/ case 7\n-                    \"\"\"\n-                    class Test<T> {\n-                        T? t;\n-                    }\n-                    \"\"\",\n-                    \"TT?;\"\n+                    \"!TT;\"\n@@ -154,9 +101,1 @@\n-            new SignatureData( \/\/ case 8\n-                    \"\"\"\n-                    class Test {\n-                        String[]? t;\n-                    }\n-                    \"\"\",\n-                    \"[Ljava\/lang\/String;\"\n-            ),\n-            new SignatureData( \/\/ case 9\n+            new SignatureData( \/\/ case 3\n@@ -168,9 +107,1 @@\n-                    \"[Ljava\/lang\/String;\"\n-            ),\n-            new SignatureData( \/\/ case 10\n-                    \"\"\"\n-                    class Test {\n-                        String![]? t;\n-                    }\n-                    \"\"\",\n-                    \"[Ljava\/lang\/String!;\"\n+                    \"![Ljava\/lang\/String;\"\n@@ -178,1 +109,1 @@\n-            new SignatureData( \/\/ case 11\n+            new SignatureData( \/\/ case 4\n@@ -181,1 +112,1 @@\n-                        String?[]![]? t = {{\"\"}};\n+                        String[][]! t = {{\"\"}};\n@@ -184,1 +115,1 @@\n-                    \"[[Ljava\/lang\/String?;\"\n+                    \"![[Ljava\/lang\/String;\"\n@@ -195,5 +126,4 @@\n-                ClassFile classFile = ClassFile.read(fileEntry);\n-                Field field = classFile.fields[0];\n-                Signature_attribute sa = (Signature_attribute)field.attributes.get(\"Signature\");\n-                System.err.println(sa.getSignature(classFile.constant_pool).toString());\n-                Assert.check(sa.getSignature(classFile.constant_pool).toString().equals(sd.expectedSignature));\n+                var classFile = ClassFile.of().parse(fileEntry.toPath());\n+                var field = classFile.fields().get(0);\n+                var sa = field.findAttribute(Attributes.signature()).orElseThrow();\n+                Assert.check(sa.signature().toString().equals(sd.expectedSignature));\n@@ -207,36 +137,0 @@\n-                    \"\"\"\n-                    class Client {\n-                        static Integer! a = Server.b;\n-                    }\n-                    \"\"\",\n-                    \"\"\"\n-                    class Server {\n-                        public static Integer? b;\n-                    }\n-                    \"\"\",\n-                    List.of(\"Client.java:2:31: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.plural: DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\"),\n-                    List.of(\"Client.java:2:31: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.filename: Client.java, DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\")\n-            ),\n-            new SepCompilationData(  \/\/ case 1\n-                    \"\"\"\n-                    class Client {\n-                        static Integer! a = Server.b;\n-                    }\n-                    \"\"\",\n-                    \"\"\"\n-                    class Server {\n-                        public static Integer b;\n-                    }\n-                    \"\"\",\n-                    List.of(\"- compiler.note.preview.filename: Client.java, DEFAULT\",\n-                            \"- compiler.note.preview.recompile\"),\n-                    List.of(\"- compiler.note.preview.filename: Client.java, DEFAULT\",\n-                            \"- compiler.note.preview.recompile\")\n-            ),\n-            new SepCompilationData(  \/\/ case 2\n@@ -258,1 +152,1 @@\n-            new SepCompilationData( \/\/ case 3\n+            new SepCompilationData( \/\/ case 1\n@@ -262,1 +156,1 @@\n-                        static List!<String> a = Server.b;\n+                        static List<String>! a = Server.b;\n@@ -268,1 +162,1 @@\n-                        public static List!<String> b = new ArrayList<>();\n+                        public static List<String>! b = new ArrayList<>();\n@@ -276,23 +170,1 @@\n-            new SepCompilationData( \/\/ case 4\n-                    \"\"\"\n-                    import java.util.*;\n-                    class Client {\n-                        static List!<String> a = Server.b;\n-                    }\n-                    \"\"\",\n-                    \"\"\"\n-                    import java.util.*;\n-                    class Server {\n-                        public static List?<String> b = new ArrayList<>();\n-                    }\n-                    \"\"\",\n-                    List.of(\"Client.java:3:36: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.plural: DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\"),\n-                    List.of(\"Client.java:3:36: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.filename: Client.java, DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\")\n-            ),\n-            new SepCompilationData( \/\/ case 5\n+            new SepCompilationData( \/\/ case 2\n@@ -302,1 +174,1 @@\n-                        static List!<String> a = Server.b;\n+                        static List<String>! a = Server.b;\n@@ -316,1 +188,1 @@\n-            new SepCompilationData( \/\/ case 6\n+            new SepCompilationData( \/\/ case 3\n@@ -319,1 +191,1 @@\n-                        static Server!.Inner! a = Server.b;\n+                        static Server.Inner! a = Server.b;\n@@ -325,59 +197,1 @@\n-                        public static Server?.Inner? b = new Server.Inner();\n-                    }\n-                    \"\"\",\n-                    List.of(\"Client.java:2:37: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.plural: DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\"),\n-                    List.of(\"Client.java:2:37: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.filename: Client.java, DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\")\n-            ),\n-            new SepCompilationData( \/\/ case 7\n-                    \"\"\"\n-                    class Client {\n-                        static String?[]![]? a = Server.b;\n-                    }\n-                    \"\"\",\n-                    \"\"\"\n-                    class Server {\n-                        public static String?[]?[]? b;\n-                    }\n-                    \"\"\",\n-                    List.of(\"Client.java:2:36: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.plural: DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\"),\n-                    List.of(\"- compiler.note.preview.filename: Client.java, DEFAULT\",  \/\/ some information is lost\n-                            \"- compiler.note.preview.recompile\")\n-            ),\n-            new SepCompilationData( \/\/ case 8\n-                    \"\"\"\n-                    class Client {\n-                        static String![]?[]? a = Server.b;\n-                    }\n-                    \"\"\",\n-                    \"\"\"\n-                    class Server {\n-                        public static String?[]?[]? b;\n-                    }\n-                    \"\"\",\n-                    List.of(\"Client.java:2:36: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.plural: DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\"),\n-                    List.of(\"Client.java:2:36: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.filename: Client.java, DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\")\n-            ),\n-            new SepCompilationData( \/\/ case 9\n-                    \"\"\"\n-                    class Client {\n-                        static String?[]?[]! a = Server.b;\n-                    }\n-                    \"\"\",\n-                    \"\"\"\n-                    class Server {\n-                        public static String?[]?[]? b;\n+                        public static Server.Inner b = new Server.Inner();\n@@ -386,4 +200,2 @@\n-                    List.of(\"Client.java:2:36: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.plural: DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\"),\n+                    List.of(\"- compiler.note.preview.filename: Client.java, DEFAULT\",\n+                            \"- compiler.note.preview.recompile\"),\n@@ -393,1 +205,1 @@\n-            new SepCompilationData( \/\/ case 10\n+            new SepCompilationData( \/\/ case 4\n@@ -396,1 +208,1 @@\n-                        static String?[]?[]? a = Server.b;\n+                        static String[][]! a = Server.b;\n@@ -401,1 +213,1 @@\n-                        public static String?[]?[]? b;\n+                        public static String[][] b;\n@@ -404,1 +216,1 @@\n-                    List.of(\"- compiler.note.preview.plural: DEFAULT\",\n+                    List.of(\"- compiler.note.preview.filename: Client.java, DEFAULT\",\n@@ -409,1 +221,1 @@\n-            new SepCompilationData( \/\/ case 11\n+            new SepCompilationData( \/\/ case 5\n@@ -413,1 +225,1 @@\n-                        static List<? extends String!> a = Server.b;\n+                        static List<? extends String>! a = Server.b;\n@@ -419,47 +231,1 @@\n-                        public static List<? extends String?> b;\n-                    }\n-                    \"\"\",\n-                    List.of(\"Client.java:3:46: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.plural: DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\"),\n-                    List.of(\"Client.java:3:46: compiler.warn.unchecked.nullness.conversion\",\n-                            \"- compiler.note.preview.filename: Client.java, DEFAULT\",\n-                            \"- compiler.note.preview.recompile\",\n-                            \"1 warning\")\n-            ),\n-            new SepCompilationData( \/\/ case 12\n-                    \"\"\"\n-                    import java.util.function.*;\n-                    class Client extends Vector<Byte>{\n-                        void foo(Server s, Unary op) {\n-                            int opc = 1;\n-                            s.unaryOp(getClass(), null, byte.class, this, null, UN_IMPL.find(op, opc, Client::unaryOperations));\n-                        }\n-                        interface Operator {}\n-                        interface Unary extends Operator {}\n-                        static class ImplCache<OP extends Operator,T> {\n-                            public ImplCache(Class<OP> whatKind, Class<? extends Vector<?>> whatVec) {}\n-                            public T find(OP op, int opc, IntFunction<T> supplier) {\n-                                return null;\n-                            }\n-                        }\n-                        static ImplCache<Unary, Server.UnaryOperation<Client, VectorMask<Byte>>>\n-                            UN_IMPL = new ImplCache<>(Unary.class, Client.class);\n-                        static Server.UnaryOperation<Client, VectorMask<Byte>> unaryOperations(int opc_) { return null; }\n-                    }\n-                    \"\"\",\n-                    \"\"\"\n-                    class Server {\n-                        <V extends Vector<E>,\n-                         M extends VectorMask<E>,\n-                         E>\n-                        V unaryOp(Class<? extends V> vClass, Class<? extends M> mClass, Class<E> eClass,\n-                                  V v, M m,\n-                                  UnaryOperation<V, M> defaultImpl) {\n-                            return null;\n-                        }\n-                        public interface UnaryOperation<V extends Vector<?>,\n-                                                        M extends VectorMask<?>> {\n-                            V apply(V v, M m);\n-                        }\n+                        public static List<? extends String> b;\n@@ -467,2 +233,0 @@\n-                    class Vector<V> {}\n-                    class VectorMask<VM> {}\n@@ -470,2 +234,4 @@\n-                    List.of(\"\"),\n-                    List.of(\"\")\n+                    List.of(\"- compiler.note.preview.filename: Client.java, DEFAULT\",\n+                            \"- compiler.note.preview.recompile\"),\n+                    List.of(\"- compiler.note.preview.filename: Client.java, DEFAULT\",\n+                            \"- compiler.note.preview.recompile\")\n","filename":"test\/langtools\/tools\/javac\/nullability\/NullabilitySignatureAttrTests.java","additions":42,"deletions":276,"binary":false,"changes":318,"status":"modified"}]}