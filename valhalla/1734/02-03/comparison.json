{"files":[{"patch":"@@ -2867,10 +2867,9 @@\n-        \/\/ We turn the payload of an atomic value into a numeric value (of suitable type)\n-        \/\/ by storing the value into an array element (of matching layout) and by reading\n-        \/\/ back the array element as an integral value. After which we can implement the CAS\n-        \/\/ as a plain numeric CAS. Note: this only works if the payload contains no oops\n-        \/\/ (see VarHandles::isAtomicFlat).\n-\n-        \/\/ array 0: witness (to translate to object), 1: x (to translate to raw)\n-        \/\/ caller pass the array so it can capture the witness if needed\n-        \/\/ we must witness the raw value instead of the value object, otherwise\n-        \/\/ garbage value can cause failure\n+        \/\/ We can convert between a value object and a binary value (of suitable size) using array elements.\n+        \/\/ This only works if the payload contains no oops (see VarHandles::isAtomicFlat).\n+        \/\/ Thus, we can implement the CAS with a plain numeric CAS.\n+\n+        \/\/ array[0]: witness (put as binary, get as object), at base\n+        \/\/ array[1]: x (put as object, get as binary), at base + scale\n+        \/\/ When witness == expected, the witness binary may be different from the expected binary.\n+        \/\/ This happens when compiler does not zero unused positions in the witness.\n+        \/\/ So we must obtain the witness binary and use it as expected binary for the numeric CAS.\n@@ -2879,1 +2878,1 @@\n-        putFlatValue(array, base + scale, layout, valueType, x); \/\/ translate x to raw bytes\n+        putFlatValue(array, base + scale, layout, valueType, x); \/\/ put x as object\n@@ -2884,2 +2883,2 @@\n-                    putByte(array, base, witnessByte); \/\/ translate witness to value object\n-                    Object witness = getFlatValue(array, base, layout, valueType);\n+                    putByte(array, base, witnessByte); \/\/ put witness as binary\n+                    Object witness = getFlatValue(array, base, layout, valueType); \/\/ get witness as object\n@@ -2889,1 +2888,1 @@\n-                    byte xByte = getByte(array, base + scale);\n+                    byte xByte = getByte(array, base + scale); \/\/ get x as binary\n@@ -2898,2 +2897,2 @@\n-                    putShort(array, base, witnessShort); \/\/ translate witness to value object\n-                    Object witness = getFlatValue(array, base, layout, valueType);\n+                    putShort(array, base, witnessShort); \/\/ put witness as binary\n+                    Object witness = getFlatValue(array, base, layout, valueType); \/\/ get witness as object\n@@ -2903,1 +2902,1 @@\n-                    short xShort = getShort(array, base + scale);\n+                    short xShort = getShort(array, base + scale); \/\/ get x as binary\n@@ -2912,2 +2911,2 @@\n-                    putInt(array, base, witnessInt); \/\/ translate witness to value object\n-                    Object witness = getFlatValue(array, base, layout, valueType);\n+                    putInt(array, base, witnessInt); \/\/ put witness as binary\n+                    Object witness = getFlatValue(array, base, layout, valueType); \/\/ get witness as object\n@@ -2917,1 +2916,1 @@\n-                    int xInt = getInt(array, base + scale);\n+                    int xInt = getInt(array, base + scale); \/\/ get x as binary\n@@ -2926,1 +2925,1 @@\n-                    putLong(array, base, witnessLong); \/\/ translate witness to value object\n+                    putLong(array, base, witnessLong); \/\/ put witness as binary\n@@ -2931,1 +2930,1 @@\n-                    long xLong = getLong(array, base + scale);\n+                    long xLong = getLong(array, base + scale); \/\/ get x as binary\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/misc\/Unsafe.java","additions":21,"deletions":22,"binary":false,"changes":43,"status":"modified"}]}