{"files":[{"patch":"@@ -28,1 +28,0 @@\n-import jdk.internal.value.ValueClass;\n@@ -1714,9 +1713,2 @@\n-        while (true) {\n-            Object witness = getFlatValueVolatile(o, offset, layout, valueType);\n-            if (witness != expected) {\n-                return false;\n-            }\n-            if (compareAndSetFlatValueAsBytes(o, offset, layout, valueType, witness, x)) {\n-                return true;\n-            }\n-        }\n+        Object[] array = newSpecialArray(valueType, 2, layout);\n+        return compareAndSetFlatValueAsBytes(array, o, offset, layout, valueType, expected, x);\n@@ -1756,9 +1748,3 @@\n-        while (true) {\n-            Object witness = getFlatValueVolatile(o, offset, layout, valueType);\n-            if (witness != expected) {\n-                return witness;\n-            }\n-            if (compareAndSetFlatValueAsBytes(o, offset, layout, valueType, witness, x)) {\n-                return witness;\n-            }\n-        }\n+        Object[] array = newSpecialArray(valueType, 2, layout);\n+        compareAndSetFlatValueAsBytes(array, o, offset, layout, valueType, expected, x);\n+        return array[0];\n@@ -2880,1 +2866,1 @@\n-    private boolean compareAndSetFlatValueAsBytes(Object o, long offset, int layout, Class<?> valueType, Object expected, Object x) {\n+    private boolean compareAndSetFlatValueAsBytes(Object[] array, Object o, long offset, int layout, Class<?> valueType, Object expected, Object x) {\n@@ -2886,6 +2872,8 @@\n-        Object[] expectedArray = newSpecialArray(valueType, 1, layout);\n-        Object xArray = newSpecialArray(valueType, 1, layout);\n-        long base = arrayInstanceBaseOffset(expectedArray);\n-        int scale = arrayInstanceIndexScale(expectedArray);\n-        putFlatValue(expectedArray, base, layout, valueType, expected);\n-        putFlatValue(xArray, base, layout, valueType, x);\n+\n+        \/\/ array 0: witness (to translate to object), 1: x (to translate to raw)\n+        \/\/ caller pass the array so it can capture the witness if needed\n+        \/\/ we must witness the raw value instead of the value object, otherwise\n+        \/\/ garbage value can cause failure\n+        long base = arrayInstanceBaseOffset(array);\n+        int scale = arrayInstanceIndexScale(array);\n+        putFlatValue(array, base + scale, layout, valueType, x); \/\/ translate x to raw bytes\n@@ -2894,3 +2882,12 @@\n-                byte expectedByte = getByte(expectedArray, base);\n-                byte xByte = getByte(xArray, base);\n-                return compareAndSetByte(o, offset, expectedByte, xByte);\n+                do {\n+                    byte witnessByte = getByteVolatile(o, offset);\n+                    putByte(array, base, witnessByte); \/\/ translate witness to value object\n+                    Object witness = getFlatValue(array, base, layout, valueType);\n+                    if (witness != expected) {\n+                        return false;\n+                    }\n+                    byte xByte = getByte(array, base + scale);\n+                    if (compareAndSetByte(o, offset, witnessByte, xByte)) {\n+                        return true;\n+                    }\n+                } while (true);\n@@ -2899,3 +2896,12 @@\n-                short expectedShort = getShort(expectedArray, base);\n-                short xShort = getShort(xArray, base);\n-                return compareAndSetShort(o, offset, expectedShort, xShort);\n+                do {\n+                    short witnessShort = getShortVolatile(o, offset);\n+                    putShort(array, base, witnessShort); \/\/ translate witness to value object\n+                    Object witness = getFlatValue(array, base, layout, valueType);\n+                    if (witness != expected) {\n+                        return false;\n+                    }\n+                    short xShort = getShort(array, base + scale);\n+                    if (compareAndSetShort(o, offset, witnessShort, xShort)) {\n+                        return true;\n+                    }\n+                } while (true);\n@@ -2904,3 +2910,12 @@\n-                int expectedInt = getInt(expectedArray, base);\n-                int xInt = getInt(xArray, base);\n-                return compareAndSetInt(o, offset, expectedInt, xInt);\n+                do {\n+                    int witnessInt = getIntVolatile(o, offset);\n+                    putInt(array, base, witnessInt); \/\/ translate witness to value object\n+                    Object witness = getFlatValue(array, base, layout, valueType);\n+                    if (witness != expected) {\n+                        return false;\n+                    }\n+                    int xInt = getInt(array, base + scale);\n+                    if (compareAndSetInt(o, offset, witnessInt, xInt)) {\n+                        return true;\n+                    }\n+                } while (true);\n@@ -2909,3 +2924,12 @@\n-                long expectedLong = getLong(expectedArray, base);\n-                long xLong = getLong(xArray, base);\n-                return compareAndSetLong(o, offset, expectedLong, xLong);\n+                do {\n+                    long witnessLong = getLongVolatile(o, offset);\n+                    putLong(array, base, witnessLong); \/\/ translate witness to value object\n+                    Object witness = getFlatValue(array, base, layout, valueType);\n+                    if (witness != expected) {\n+                        return false;\n+                    }\n+                    long xLong = getLong(array, base + scale);\n+                    if (compareAndSetLong(o, offset, witnessLong, xLong)) {\n+                        return true;\n+                    }\n+                } while (true);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/misc\/Unsafe.java","additions":62,"deletions":38,"binary":false,"changes":100,"status":"modified"},{"patch":"@@ -801,2 +801,0 @@\n-java\/lang\/invoke\/VarHandles\/VarHandleTestMethodHandleAccessValue.java 8367346 generic-all\n-\n","filename":"test\/jdk\/ProblemList.txt","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}