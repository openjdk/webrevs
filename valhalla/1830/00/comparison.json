{"files":[{"patch":"@@ -3553,1 +3553,0 @@\n-            List<NullMarker> nullMarkers = tree.nullMarkers.reverse();\n@@ -3556,3 +3555,1 @@\n-                owntype = new ArrayType(owntype, syms.arrayClass)\n-                        .asNullMarked(nullMarkers.head);\n-                nullMarkers = nullMarkers.tail;\n+                owntype = new ArrayType(owntype, syms.arrayClass);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Attr.java","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -40,1 +40,0 @@\n-import com.sun.tools.javac.code.FlagsEnum;\n@@ -44,1 +43,0 @@\n-import com.sun.tools.javac.parser.Tokens.Comment.CommentStyle;\n@@ -58,1 +56,0 @@\n-import static com.sun.tools.javac.code.Flags.asFlagSet;\n@@ -67,1 +64,1 @@\n-import static com.sun.tools.javac.parser.Tokens.TokenKind.SYNCHRONIZED;\n+\n@@ -298,1 +295,1 @@\n-     *     mode |= NOQUES     : nullable types are not allowed\n+     *     mode |= ALLOW_BANGS: bang types are allowed\n@@ -306,1 +303,1 @@\n-    protected static final int NOQUES        = 1 << 6;\n+    protected static final int ALLOW_BANGS   = 1 << 6;\n@@ -325,1 +322,1 @@\n-        setMode((mode & (NOLAMBDA | NOQUES)) | EXPR);\n+        setMode((mode & NOLAMBDA) | EXPR);\n@@ -329,1 +326,1 @@\n-        setMode((mode & (NOLAMBDA | NOQUES)) | TYPE);\n+        setMode((mode & ALLOW_BANGS) | (mode & NOLAMBDA) | TYPE);\n@@ -1019,1 +1016,1 @@\n-                e = unannotatedType(allowVar, TYPE | NOLAMBDA);\n+                e = unannotatedType(allowVar, TYPE | NOLAMBDA | ALLOW_BANGS);\n@@ -1086,1 +1083,5 @@\n-        return parseType(false);\n+        return parseType(TYPE);\n+    }\n+\n+    public JCExpression parseType(int mode) {\n+        return parseType(false, mode);\n@@ -1090,0 +1091,4 @@\n+        return parseType(allowVar, TYPE);\n+    }\n+\n+    public JCExpression parseType(boolean allowVar, int mode) {\n@@ -1091,1 +1096,1 @@\n-        return parseType(allowVar, annotations);\n+        return parseType(allowVar, mode, annotations);\n@@ -1095,1 +1100,5 @@\n-        JCExpression result = unannotatedType(allowVar);\n+        return parseType(allowVar, TYPE, annotations);\n+    }\n+\n+    public JCExpression parseType(boolean allowVar, int mode, List<JCAnnotation> annotations) {\n+        JCExpression result = unannotatedType(allowVar, mode);\n@@ -1110,1 +1119,1 @@\n-            targets = targets.prepend(parseType());\n+            targets = targets.prepend(parseType(TYPE | ALLOW_BANGS));\n@@ -1282,12 +1291,1 @@\n-                    JCExpression type = unannotatedType(false, NOQUES | TYPE);\n-                    if (allowNullRestrictedTypes && token.kind == QUES) {\n-                        if (peekToken(IDENTIFIER, COMMA) || peekToken(IDENTIFIER, SEMI) ||\n-                                peekToken(IDENTIFIER, RPAREN) || peekToken(IDENTIFIER, INSTANCEOF_INFIX)) {\n-                            setNullMarker(type);\n-                            accept(QUES);\n-                        } else if (peekToken(COMMA) || peekToken(SEMI) ||\n-                                peekToken(RPAREN) || peekToken(QUES) || peekToken(INSTANCEOF_INFIX)) {\n-                            setNullMarker(type);\n-                            accept(QUES);\n-                        }\n-                    }\n+                    JCExpression type = unannotatedType(false, TYPE | ALLOW_BANGS);\n@@ -1505,1 +1503,1 @@\n-                       t = parseIntersectionType(pos, parseType());\n+                       t = parseIntersectionType(pos, parseType(TYPE | ALLOW_BANGS));\n@@ -1618,1 +1616,2 @@\n-                if (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(token.kind) && (peekToken(LBRACKET) || peekToken(LT))) {\n+                if (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(token.kind)) {\n+                    checkNullRestrictionLocation();\n@@ -1635,0 +1634,1 @@\n+                        boolean pendingNullRestriction = false;\n@@ -1637,1 +1637,0 @@\n-                            Token nullMarker = null;\n@@ -1639,1 +1638,2 @@\n-                                nullMarker = token;\n+                                checkNullRestrictionLocation();\n+                                pendingNullRestriction = true;\n@@ -1642,4 +1642,10 @@\n-                            t = bracketsOpt(t);\n-                            t = toP(F.at(pos).TypeArray(t));\n-                            if (nullMarker != null) {\n-                                setNullMarker(t, nullMarker);\n+                            JCExpression elem = bracketsOpt(t);\n+                            t = toP(F.at(pos).TypeArray(elem));\n+                            if (elem instanceof JCNullableTypeExpression nullableTypeExpression &&\n+                                    nullableTypeExpression.getNullMarker() != NullMarker.UNSPECIFIED) {\n+                                \/\/ fixup, as null-restriction was attached to the \"wrong\" array\n+                                nullableTypeExpression.setNullMarker(NullMarker.UNSPECIFIED);\n+                                pendingNullRestriction = true;\n+                            }\n+                            if (pendingNullRestriction) {\n+                                ((JCNullableTypeExpression)t).setNullMarker(NullMarker.NOT_NULL);\n@@ -1892,0 +1898,1 @@\n+                checkNullRestrictionLocation();\n@@ -1905,0 +1912,1 @@\n+                            checkNullRestrictionLocation();\n@@ -2262,1 +2270,1 @@\n-    protected Predicate<TokenKind> EMOTIONAL_QUALIFIER = t -> t == BANG || (t == QUES && !isMode(NOQUES)) || t == STAR;\n+    protected Predicate<TokenKind> EMOTIONAL_QUALIFIER = t -> t == BANG;\n@@ -2264,2 +2272,1 @@\n-    protected Predicate<TokenKind> INSTANCEOF_INFIX = t -> t == AMPAMP || t == BARBAR ||\n-                                                           t == EQEQ || t == BANGEQ;\n+    protected Predicate<TokenKind> BAD_BANG_LOCATION = t -> t == LBRACKET || t == MONKEYS_AT || t == DOT || t == LPAREN;\n@@ -2620,0 +2627,26 @@\n+    \/*\n+     * Null restriction support. If we see a null restriction token (e.g. '!'),\n+     * we check that the token is not followed by unsupported tokens, like '[', '(' and '.'.\n+     * Then, we also make sure that null restriction is enabled in this context\n+     * e.g. by making sure the ALLOW_BANG mode is set.\n+     *\/\n+    void checkNullRestrictionLocation() {\n+        Assert.check(EMOTIONAL_QUALIFIER.test(token.kind));\n+        if (peekToken(BAD_BANG_LOCATION)) {\n+            unsupportedNullRestriction();\n+        } else {\n+            checkNullRestrictonAllowed();\n+        }\n+    }\n+\n+    void checkNullRestrictonAllowed() {\n+        Assert.check(EMOTIONAL_QUALIFIER.test(token.kind));\n+        if ((mode & ALLOW_BANGS) == 0) {\n+            unsupportedNullRestriction();\n+        }\n+    }\n+\n+    void unsupportedNullRestriction() {\n+        reportSyntaxError(token.pos, Errors.UnsupportedNullRestriction);\n+    }\n+\n@@ -2631,0 +2664,1 @@\n+            checkNullRestrictionLocation();\n@@ -2760,0 +2794,1 @@\n+                checkNullRestrictonAllowed();\n@@ -2860,1 +2895,0 @@\n-            ListBuffer<NullMarker> nullMarkers = new ListBuffer<>();\n@@ -2869,1 +2903,1 @@\n-                nullMarkers.add(nullMarker(token));\n+                checkNullRestrictionLocation();\n@@ -2871,2 +2905,0 @@\n-            } else {\n-                nullMarkers.add(NullMarker.UNSPECIFIED);\n@@ -2875,2 +2907,1 @@\n-                    || token.kind == MONKEYS_AT ||\n-                    (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(token.kind))) {\n+                    || token.kind == MONKEYS_AT) {\n@@ -2881,5 +2912,0 @@\n-                    Token nullMarker = null;\n-                    if (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(token.kind)) {\n-                        nullMarker = token;\n-                        nextToken();\n-                    }\n@@ -2887,3 +2913,0 @@\n-                    if (nullMarker != null) {\n-                        setNullMarker(elemtype, nullMarker);\n-                    }\n@@ -2895,1 +2918,1 @@\n-                        nullMarkers.add(nullMarker(token));\n+                        checkNullRestrictionLocation();\n@@ -2897,2 +2920,0 @@\n-                    } else {\n-                        nullMarkers.add(NullMarker.UNSPECIFIED);\n@@ -2910,1 +2931,1 @@\n-            JCNewArray na = toP(F.at(newpos).NewArray(elemtype, dims.toList(), elems, nullMarkers.toList()));\n+            JCNewArray na = toP(F.at(newpos).NewArray(elemtype, dims.toList(), elems));\n@@ -2913,2 +2934,0 @@\n-            Assert.check(dims.length() == nullMarkers.length(), na);\n-\n@@ -3087,1 +3106,1 @@\n-                JCExpression t = parseType(true);\n+                JCExpression t = parseType(true, TYPE | ALLOW_BANGS);\n@@ -3184,1 +3203,1 @@\n-            JCExpression t = term(EXPR | TYPE);\n+            JCExpression t = term(EXPR | TYPE | ALLOW_BANGS);\n@@ -3598,0 +3617,1 @@\n+                            peekToken(lookahead, EMOTIONAL_QUALIFIER, LBRACKET) ||\n@@ -3634,1 +3654,2 @@\n-                    if (peekToken(lookahead, RBRACKET, LAX_IDENTIFIER)) {\n+                    if (peekToken(lookahead, RBRACKET, LAX_IDENTIFIER) ||\n+                            allowNullRestrictedTypes && peekToken(lookahead, RBRACKET, EMOTIONAL_QUALIFIER, LAX_IDENTIFIER)) {\n@@ -3636,1 +3657,2 @@\n-                    } else if (peekToken(lookahead, RBRACKET)) {\n+                    } else if (peekToken(lookahead, RBRACKET) ||\n+                            allowNullRestrictedTypes && peekToken(lookahead, EMOTIONAL_QUALIFIER, RBRACKET)) {\n@@ -5009,1 +5031,1 @@\n-            type = unannotatedType(false);\n+            type = unannotatedType(false, TYPE | ALLOW_BANGS);\n@@ -5671,1 +5693,1 @@\n-        JCExpression type = parseType(lambdaParameter);\n+        JCExpression type = parseType(lambdaParameter, TYPE | ALLOW_BANGS);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/parser\/JavacParser.java","additions":84,"deletions":62,"binary":false,"changes":146,"status":"modified"},{"patch":"@@ -4449,0 +4449,3 @@\n+\n+compiler.err.unsupported.null.restriction=\\\n+    null restriction not supported in this type context\n\\ No newline at end of file\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/resources\/compiler.properties","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1976,1 +1976,0 @@\n-        public List<NullMarker> nullMarkers;\n@@ -1980,2 +1979,1 @@\n-                             List<JCExpression> elems,\n-                             List<NullMarker> nullMarkers)\n+                             List<JCExpression> elems)\n@@ -1987,1 +1985,0 @@\n-            this.nullMarkers = nullMarkers;\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/tree\/JCTree.java","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -327,2 +327,1 @@\n-        return M.at(t.pos).NewArray(elemtype, dims, elems,\n-                ((JCNewArray)node).nullMarkers);\n+        return M.at(t.pos).NewArray(elemtype, dims, elems);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/tree\/TreeCopier.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -442,11 +442,1 @@\n-        JCNewArray tree = new JCNewArray(elemtype, dims, elems, List.nil());\n-        tree.pos = pos;\n-        return tree;\n-    }\n-\n-    public JCNewArray NewArray(JCExpression elemtype,\n-                             List<JCExpression> dims,\n-                             List<JCExpression> elems,\n-                             List<NullMarker> nullMarkers)\n-    {\n-        JCNewArray tree = new JCNewArray(elemtype, dims, elems, nullMarkers);\n+        JCNewArray tree = new JCNewArray(elemtype, dims, elems);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/tree\/TreeMaker.java","additions":1,"deletions":11,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -239,0 +239,1 @@\n+unsupported.null.restriction\n\\ No newline at end of file\n","filename":"test\/langtools\/tools\/javac\/diags\/examples.not-yet.txt","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}