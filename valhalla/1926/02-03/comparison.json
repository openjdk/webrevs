{"files":[{"patch":"@@ -508,1 +508,1 @@\n-        testSeparateCompilationHelper(base,\n+        testUseSiteForMethodsSeparateCompilationHelper(base,\n@@ -529,1 +529,1 @@\n-        testSeparateCompilationHelper(base,\n+        testUseSiteForMethodsSeparateCompilationHelper(base,\n@@ -550,1 +550,1 @@\n-        testSeparateCompilationHelper(base,\n+        testUseSiteForMethodsSeparateCompilationHelper(base,\n@@ -575,1 +575,1 @@\n-        testSeparateCompilationHelper(base,\n+        testUseSiteForMethodsSeparateCompilationHelper(base,\n@@ -602,1 +602,1 @@\n-    private void testSeparateCompilationHelper(\n+    private void testUseSiteForMethodsSeparateCompilationHelper(\n@@ -653,0 +653,92 @@\n+\n+    @Test\n+    public void testUseSideChecksForFieldsSepCompilation(Path base) throws Exception {\n+        testUseSiteForFieldsSeparateCompilationHelper(base,\n+                \"\"\"\n+                package pkg;\n+                public class A {\n+                    String! a;\n+                    public A() {\n+                        this.a = \"test\";\n+                        super();\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                public class A {\n+                    String a;\n+                    public A() {\n+                        this.a = null;\n+                        super();\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                class Test {\n+                    public static void main(String... args) {\n+                        A a = new A();\n+                        System.out.println(a.a.toString());\n+                    }\n+                }\n+                \"\"\");\n+    }\n+\n+    private void testUseSiteForFieldsSeparateCompilationHelper(\n+            Path base,\n+            String code1,\n+            String code2,\n+            String testCode) throws Exception {\n+        Path src = base.resolve(\"src\");\n+        Path pkg = src.resolve(\"pkg\");\n+        Path ASrc = pkg.resolve(\"A\");\n+        Path test = pkg.resolve(\"Test\");\n+\n+        tb.writeJavaFiles(ASrc, code1);\n+        tb.writeJavaFiles(test, testCode);\n+\n+        Path out = base.resolve(\"out\");\n+        Files.createDirectories(out);\n+\n+        \/\/ this compilation will generate null checks in Test before accessing field A.a\n+        new JavacTask(tb)\n+                .outdir(out)\n+                .options(PREVIEW_OPTIONS)\n+                .files(findJavaFiles(pkg))\n+                .run();\n+\n+        \/\/ let's execute to check that it's producing the NPE\n+        System.err.println(\"running, this test should pass\");\n+        String output = new JavaTask(tb)\n+                .classpath(out.toString())\n+                .classArgs(\"pkg.Test\")\n+                .vmOptions(\"--enable-preview\")\n+                .run()\n+                .writeAll()\n+                .getOutput(Task.OutputKind.STDOUT);\n+        if (!output.startsWith(\"test\")) {\n+            throw new AssertionError(\"unexpected output: \" + output);\n+        }\n+\n+        \/\/ now lets change the code\n+        tb.writeJavaFiles(ASrc, code2);\n+\n+        new JavacTask(tb)\n+                .outdir(out)\n+                .options(PREVIEW_OPTIONS)\n+                .files(findJavaFiles(ASrc))\n+                .run();\n+\n+        System.err.println(\"running, this test should fail\");\n+        output = new JavaTask(tb)\n+                .classpath(out.toString())\n+                .classArgs(\"pkg.Test\")\n+                .vmOptions(\"--enable-preview\")\n+                .run(Task.Expect.FAIL)\n+                .writeAll()\n+                .getOutput(Task.OutputKind.STDERR);\n+        if (!output.startsWith(\"Exception in thread \\\"main\\\" java.lang.NullPointerException\")) {\n+            throw new AssertionError(\"NPE error expected\");\n+        }\n+    }\n","filename":"test\/langtools\/tools\/javac\/nullability\/RuntimeNullChecks.java","additions":97,"deletions":5,"binary":false,"changes":102,"status":"modified"}]}