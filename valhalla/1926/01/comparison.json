{"files":[{"patch":"@@ -46,0 +46,1 @@\n+import static com.sun.tools.javac.code.Kinds.Kind.PCK;\n@@ -47,0 +48,1 @@\n+import static com.sun.tools.javac.code.Kinds.Kind.VAR;\n@@ -91,1 +93,4 @@\n-    public JCTree translateTopLevelClass(JCTree cdef, TreeMaker make) {\n+    Symbol.ClassSymbol currentClass;\n+    Env<AttrContext> env;\n+\n+    public JCTree translateTopLevelClass(Env<AttrContext> env, JCTree cdef, TreeMaker make) {\n@@ -95,0 +100,2 @@\n+                this.env = env;\n+                currentClass = (Symbol.ClassSymbol) TreeInfo.symbolFor(cdef);\n@@ -99,0 +106,2 @@\n+                this.currentClass = null;\n+                this.env = null;\n@@ -141,0 +150,43 @@\n+    boolean isInThisSameCompUnit(Symbol sym) {\n+        return env.toplevel.getTypeDecls().stream().anyMatch(\n+                tree -> {\n+                    Symbol csym = TreeInfo.symbolFor(tree);\n+                    return csym.kind == TYP && csym instanceof Symbol.ClassSymbol && csym == outermostType(sym);\n+                });\n+    }\n+\n+    private Symbol outermostType(Symbol sym) {\n+        Symbol prev = null;\n+        while (sym.kind != PCK) {\n+            prev = sym;\n+            sym = sym.owner;\n+        }\n+        return prev;\n+    }\n+\n+    @Override\n+    public void visitIdent(JCIdent tree) {\n+        super.visitIdent(tree);\n+        identSelectVisitHelper(tree);\n+    }\n+\n+    @Override\n+    public void visitSelect(JCFieldAccess tree) {\n+        super.visitSelect(tree);\n+        identSelectVisitHelper(tree);\n+    }\n+\n+    private void identSelectVisitHelper(JCTree tree) {\n+        Symbol sym = TreeInfo.symbolFor(tree);\n+        if (!noUseSiteNullChecks &&\n+                sym.owner.kind == TYP &&\n+                sym.kind == VAR &&\n+                !isInThisSameCompUnit(sym) &&\n+                types.isNonNullable(sym.type)) {\n+            \/* we are accessing a non-nullable field declared in another\n+             * compilation unit\n+             *\/\n+            result = attr.makeNullCheck((JCExpression) tree, true);\n+        }\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/NullChecksWriter.java","additions":53,"deletions":1,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -1711,1 +1711,1 @@\n-                NullChecksWriter.instance(context).translateTopLevelClass(def, localMake);\n+                NullChecksWriter.instance(context).translateTopLevelClass(env, def, localMake);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/main\/JavaCompiler.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -437,1 +437,1 @@\n-    public void testClientSideChecks(Path base) throws Exception {\n+    public void testUseSideChecksForMethods(Path base) throws Exception {\n@@ -507,1 +507,1 @@\n-    public void testClientSideChecksSepCompilation(Path base) throws Exception {\n+    public void testUseSideChecksForMethodsSepCompilation(Path base) throws Exception {\n","filename":"test\/langtools\/tools\/javac\/nullability\/RuntimeNullChecks.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}