{"files":[{"patch":"@@ -194,5 +194,10 @@\n-static void add_wrapper_class(JavaThread* current, ClassLoaderData* cld, Symbol* classname) {\n-  InstanceKlass* ik = SystemDictionary::find_instance_klass(current, classname, Handle(current, nullptr));\n-  assert(ik != nullptr, \"Must exist\");\n-  SystemDictionary::add_to_initiating_loader(current, ik, cld);\n-}\n+\/\/ These migrated value classes are loaded by the bootstrap class loader but are added to the initiating\n+\/\/ loaders automatically so that fields of these types can be found and potentially flattened during\n+\/\/ field layout.\n+static void add_migrated_value_classes(ClassLoaderData* cld) {\n+  JavaThread* current = JavaThread::current();\n+  auto add_klass = [&] (Symbol* classname) {\n+    InstanceKlass* ik = SystemDictionary::find_instance_klass(current, classname, Handle(current, nullptr));\n+    assert(ik != nullptr, \"Must exist\");\n+    SystemDictionary::add_to_initiating_loader(current, ik, cld);\n+  };\n@@ -200,1 +205,0 @@\n-static void add_wrapper_classes(ClassLoaderData* cld) {\n@@ -202,9 +206,1 @@\n-  JavaThread* current = JavaThread::current();\n-  add_wrapper_class(current, cld, vmSymbols::java_lang_Boolean());\n-  add_wrapper_class(current, cld, vmSymbols::java_lang_Byte());\n-  add_wrapper_class(current, cld, vmSymbols::java_lang_Character());\n-  add_wrapper_class(current, cld, vmSymbols::java_lang_Short());\n-  add_wrapper_class(current, cld, vmSymbols::java_lang_Integer());\n-  add_wrapper_class(current, cld, vmSymbols::java_lang_Long());\n-  add_wrapper_class(current, cld, vmSymbols::java_lang_Float());\n-  add_wrapper_class(current, cld, vmSymbols::java_lang_Double());\n+  vmSymbols::migrated_class_names_do(add_klass);\n@@ -222,1 +218,3 @@\n-      add_wrapper_classes(cld);\n+      if (EnableValhalla) {\n+        add_migrated_value_classes(cld);\n+      }\n","filename":"src\/hotspot\/share\/classfile\/systemDictionary.cpp","additions":14,"deletions":16,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -176,0 +176,24 @@\n+  \/* Other valhalla migrated klasses. *\/                                                                        \\\n+  do_klass(Number_klass,                                java_lang_Number                                      ) \\\n+  do_klass(Optional_klass,                              java_util_Optional                                    ) \\\n+  do_klass(OptionalInt_klass,                           java_util_OptionalInt                                 ) \\\n+  do_klass(OptionalLong_klass,                          java_util_OptionalLong                                ) \\\n+  do_klass(OptionalDouble_klass,                        java_util_OptionalDouble                              ) \\\n+  do_klass(LocalDate_klass,                             java_time_LocalDate                                   ) \\\n+  do_klass(LocalDateTime_klass,                         java_time_LocalDateTime                               ) \\\n+  do_klass(LocalTime_klass,                             java_time_LocalTime                                   ) \\\n+  do_klass(Duration_klass,                              java_time_Duration                                    ) \\\n+  do_klass(Instant_klass,                               java_time_Instant                                     ) \\\n+  do_klass(MonthDay_klass,                              java_time_MonthDay                                    ) \\\n+  do_klass(ZonedDateTime_klass,                         java_time_ZonedDateTime                               ) \\\n+  do_klass(OffsetDateTime_klass,                        java_time_OffsetDateTime                              ) \\\n+  do_klass(OffsetTime_klass,                            java_time_OffsetTime                                  ) \\\n+  do_klass(YearMonth_klass,                             java_time_YearMonth                                   ) \\\n+  do_klass(Year_klass,                                  java_time_Year                                        ) \\\n+  do_klass(Period_klass,                                java_time_Period                                      ) \\\n+  do_klass(chrono_ChronoLocalDateImpl_klass,            java_time_chrono_ChronoLocalDateImpl                  ) \\\n+  do_klass(chrono_MinguoDate_klass,                     java_time_chrono_MinguoDate                           ) \\\n+  do_klass(chrono_HijrahDate_klass,                     java_time_chrono_HijrahDate                           ) \\\n+  do_klass(chrono_JapaneseDate_klass,                   java_time_chrono_JapaneseDate                         ) \\\n+  do_klass(chrono_ThaiBuddhistDate_klass,               java_time_chrono_ThaiBuddhistDate                     ) \\\n+                                                                                                                \\\n","filename":"src\/hotspot\/share\/classfile\/vmClassMacros.hpp","additions":24,"deletions":0,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -113,0 +113,2 @@\n+  initialize_migrated_class_names();\n+\n@@ -299,0 +301,40 @@\n+\n+\/\/ The list of these migrated value classes is in\n+\/\/ open\/make\/modules\/java.base\/gensrc\/GensrcValueClasses.gmk.\n+\n+Symbol* vmSymbols::_migrated_class_names[_migrated_class_names_length];\n+\n+void vmSymbols::initialize_migrated_class_names() {\n+  int i = 0;\n+  _migrated_class_names[i++] = java_lang_Byte();\n+  _migrated_class_names[i++] = java_lang_Short();\n+  _migrated_class_names[i++] = java_lang_Integer();\n+  _migrated_class_names[i++] = java_lang_Long();\n+  _migrated_class_names[i++] = java_lang_Float();\n+  _migrated_class_names[i++] = java_lang_Double();\n+  _migrated_class_names[i++] = java_lang_Boolean();\n+  _migrated_class_names[i++] = java_lang_Character();\n+  _migrated_class_names[i++] = java_lang_Number();\n+  _migrated_class_names[i++] = java_lang_Record();\n+  _migrated_class_names[i++] = java_util_Optional();\n+  _migrated_class_names[i++] = java_util_OptionalInt();\n+  _migrated_class_names[i++] = java_util_OptionalLong();\n+  _migrated_class_names[i++] = java_util_OptionalDouble();\n+  _migrated_class_names[i++] = java_time_LocalDate();\n+  _migrated_class_names[i++] = java_time_LocalDateTime();\n+  _migrated_class_names[i++] = java_time_LocalTime();\n+  _migrated_class_names[i++] = java_time_Duration();\n+  _migrated_class_names[i++] = java_time_Instant();\n+  _migrated_class_names[i++] = java_time_MonthDay();\n+  _migrated_class_names[i++] = java_time_ZonedDateTime();\n+  _migrated_class_names[i++] = java_time_OffsetDateTime();\n+  _migrated_class_names[i++] = java_time_OffsetTime();\n+  _migrated_class_names[i++] = java_time_YearMonth();\n+  _migrated_class_names[i++] = java_time_Year();\n+  _migrated_class_names[i++] = java_time_Period();\n+  _migrated_class_names[i++] = java_time_chrono_ChronoLocalDateImpl();\n+  _migrated_class_names[i++] = java_time_chrono_MinguoDate();\n+  _migrated_class_names[i++] = java_time_chrono_HijrahDate();\n+  _migrated_class_names[i++] = java_time_chrono_JapaneseDate();\n+  _migrated_class_names[i++] = java_time_chrono_ThaiBuddhistDate();\n+}\n","filename":"src\/hotspot\/share\/classfile\/vmSymbols.cpp","additions":42,"deletions":0,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -94,0 +94,25 @@\n+  \/* Valhalla migrated classes. *\/                                                                \\\n+  template(java_lang_Number,                          \"java\/lang\/Number\")                         \\\n+  template(java_lang_Record,                          \"java\/lang\/Record\")                         \\\n+  template(java_util_Optional,                        \"java\/util\/Optional\")                       \\\n+  template(java_util_OptionalInt,                     \"java\/util\/OptionalInt\")                    \\\n+  template(java_util_OptionalLong,                    \"java\/util\/OptionalLong\")                   \\\n+  template(java_util_OptionalDouble,                  \"java\/util\/OptionalDouble\")                 \\\n+  template(java_time_LocalDate,                       \"java\/time\/LocalDate\")                      \\\n+  template(java_time_LocalDateTime,                   \"java\/time\/LocalDateTime\")                  \\\n+  template(java_time_LocalTime,                       \"java\/time\/LocalTime\")                      \\\n+  template(java_time_Duration,                        \"java\/time\/Duration\")                       \\\n+  template(java_time_Instant,                         \"java\/time\/Instant\")                        \\\n+  template(java_time_MonthDay,                        \"java\/time\/MonthDay\")                       \\\n+  template(java_time_ZonedDateTime,                   \"java\/time\/ZonedDateTime\")                  \\\n+  template(java_time_OffsetDateTime,                  \"java\/time\/OffsetDateTime\")                 \\\n+  template(java_time_OffsetTime,                      \"java\/time\/OffsetTime\")                     \\\n+  template(java_time_YearMonth,                       \"java\/time\/YearMonth\")                      \\\n+  template(java_time_Year,                            \"java\/time\/Year\")                           \\\n+  template(java_time_Period,                          \"java\/time\/Period\")                         \\\n+  template(java_time_chrono_ChronoLocalDateImpl,      \"java\/time\/chrono\/ChronoLocalDateImpl\")     \\\n+  template(java_time_chrono_MinguoDate,               \"java\/time\/chrono\/MinguoDate\")              \\\n+  template(java_time_chrono_HijrahDate,               \"java\/time\/chrono\/HijrahDate\")              \\\n+  template(java_time_chrono_JapaneseDate,             \"java\/time\/chrono\/JapaneseDate\")            \\\n+  template(java_time_chrono_ThaiBuddhistDate,         \"java\/time\/chrono\/ThaiBuddhistDate\")        \\\n+                                                                                                  \\\n@@ -140,1 +165,0 @@\n-  template(java_lang_Record,                          \"java\/lang\/Record\")                         \\\n@@ -833,0 +857,4 @@\n+  static void initialize_migrated_class_names();\n+\n+  static const int _migrated_class_names_length = 31;\n+  static Symbol* _migrated_class_names[_migrated_class_names_length];\n@@ -868,0 +896,7 @@\n+\n+  template<typename Function>\n+  static void migrated_class_names_do(Function f) {\n+     for (int i = 0; i < _migrated_class_names_length; i++) {\n+       f(_migrated_class_names[i]);\n+     }\n+  }\n","filename":"src\/hotspot\/share\/classfile\/vmSymbols.hpp","additions":36,"deletions":1,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,0 +38,1 @@\n+#include \"utilities\/copy.hpp\"\n","filename":"src\/hotspot\/share\/gc\/z\/zBarrierSet.inline.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}