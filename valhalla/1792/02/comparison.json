{"files":[{"patch":"@@ -25,1 +25,0 @@\n-#include \"classfile\/vmSymbols.hpp\"\n@@ -30,2 +29,0 @@\n-#include \"memory\/resourceArea.hpp\"\n-#include \"oops\/objArrayKlass.inline.hpp\"\n@@ -57,27 +54,0 @@\n-void BarrierSet::throw_array_null_pointer_store_exception(arrayOop src, arrayOop dst, TRAPS) {\n-  ResourceMark rm(THREAD);\n-  Klass* bound = ObjArrayKlass::cast(dst->klass())->element_klass();\n-  stringStream ss;\n-  ss.print(\"arraycopy: can not copy null values into %s[]\",\n-           bound->external_name());\n-  THROW_MSG(vmSymbols::java_lang_NullPointerException(), ss.as_string());\n-}\n-\n-void BarrierSet::throw_array_store_exception(arrayOop src, arrayOop dst, TRAPS) {\n-  ResourceMark rm(THREAD);\n-  Klass* bound = ObjArrayKlass::cast(dst->klass())->element_klass();\n-  Klass* stype = ObjArrayKlass::cast(src->klass())->element_klass();\n-  stringStream ss;\n-  if (!bound->is_subtype_of(stype)) {\n-    ss.print(\"arraycopy: type mismatch: can not copy %s[] into %s[]\",\n-             stype->external_name(), bound->external_name());\n-  } else {\n-    \/\/ oop_arraycopy should return the index in the source array that\n-    \/\/ contains the problematic oop.\n-    ss.print(\"arraycopy: element type mismatch: can not cast one of the elements\"\n-             \" of %s[] to the type of the destination array, %s\",\n-             stype->external_name(), bound->external_name());\n-  }\n-  THROW_MSG(vmSymbols::java_lang_ArrayStoreException(), ss.as_string());\n-}\n-\n","filename":"src\/hotspot\/share\/gc\/shared\/barrierSet.cpp","additions":0,"deletions":30,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -123,3 +123,0 @@\n-  static void throw_array_null_pointer_store_exception(arrayOop src, arrayOop dst, TRAPS);\n-  static void throw_array_store_exception(arrayOop src, arrayOop dst, TRAPS);\n-\n@@ -288,3 +285,3 @@\n-    static void oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                      size_t length);\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                               size_t length);\n","filename":"src\/hotspot\/share\/gc\/shared\/barrierSet.hpp","additions":3,"deletions":6,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -39,3 +39,3 @@\n-inline void BarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                                                                      arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                                                                      size_t length) {\n+inline OopCopyResult BarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                                                                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                                                                               size_t length) {\n@@ -49,1 +49,2 @@\n-    return;\n+\n+    return OopCopyResult::ok;\n@@ -57,2 +58,1 @@\n-      throw_array_null_pointer_store_exception(src_obj, dst_obj, JavaThread::current());\n-      return;\n+      return OopCopyResult::failed_check_null;\n@@ -61,3 +61,2 @@\n-        (!oopDesc::is_instanceof_or_null(CompressedOops::decode(elem), dst_klass))) {\n-      throw_array_store_exception(src_obj, dst_obj, JavaThread::current());\n-      return;\n+        !oopDesc::is_instanceof_or_null(CompressedOops::decode(elem), dst_klass)) {\n+      return OopCopyResult::failed_check_class_cast;\n@@ -67,0 +66,2 @@\n+\n+  return OopCopyResult::ok;\n","filename":"src\/hotspot\/share\/gc\/shared\/barrierSet.inline.hpp","additions":10,"deletions":9,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -107,3 +107,3 @@\n-    static void oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                      size_t length);\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                               size_t length);\n","filename":"src\/hotspot\/share\/gc\/shared\/cardTableBarrierSet.hpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -114,1 +114,1 @@\n-inline void CardTableBarrierSet::AccessBarrier<decorators, BarrierSetT>::\n+inline OopCopyResult CardTableBarrierSet::AccessBarrier<decorators, BarrierSetT>::\n@@ -140,2 +140,1 @@\n-        throw_array_null_pointer_store_exception(src_obj, dst_obj, JavaThread::current());\n-        return;\n+        return OopCopyResult::failed_check_null;\n@@ -146,2 +145,1 @@\n-        throw_array_store_exception(src_obj, dst_obj, JavaThread::current());\n-        return;\n+        return OopCopyResult::failed_check_class_cast;\n@@ -155,0 +153,2 @@\n+\n+  return OopCopyResult::ok;\n","filename":"src\/hotspot\/share\/gc\/shared\/cardTableBarrierSet.inline.hpp","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -176,3 +176,3 @@\n-    static void oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                      size_t length);\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                               size_t length);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahBarrierSet.hpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -371,1 +371,1 @@\n-void ShenandoahBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+OopCopyResult ShenandoahBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n@@ -381,1 +381,1 @@\n-  Raw::oop_arraycopy_in_heap(src_obj, src_offset_in_bytes, src_raw, dst_obj, dst_offset_in_bytes, dst_raw, length);\n+  OopCopyResult result = Raw::oop_arraycopy_in_heap(src_obj, src_offset_in_bytes, src_raw, dst_obj, dst_offset_in_bytes, dst_raw, length);\n@@ -385,0 +385,1 @@\n+  return result;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahBarrierSet.inline.hpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -68,6 +68,0 @@\n-  enum OopCopyCheckStatus {\n-    oop_copy_check_ok = 0,         \/\/ oop array copy sucessful\n-    oop_copy_check_class_cast = 1, \/\/ oop array copy failed subtype check (ARRAYCOPY_CHECKCAST)\n-    oop_copy_check_null = 2        \/\/ oop array copy failed null check (ARRAYCOPY_NOTNULL)\n-  };\n-\n@@ -97,0 +91,1 @@\n+    [[noreturn]]\n@@ -107,2 +102,2 @@\n-    static OopCopyCheckStatus oop_copy_one_check_cast(zpointer* dst, zpointer* src, Klass* dst_klass);\n-    static OopCopyCheckStatus oop_copy_one(zpointer* dst, zpointer* src);\n+    static OopCopyResult oop_copy_one_check_cast(zpointer* dst, zpointer* src, Klass* dst_klass);\n+    static OopCopyResult oop_copy_one(zpointer* dst, zpointer* src);\n@@ -110,2 +105,2 @@\n-    static OopCopyCheckStatus oop_arraycopy_in_heap_check_cast(zpointer* dst, zpointer* src, size_t length, Klass* dst_klass);\n-    static OopCopyCheckStatus oop_arraycopy_in_heap_no_check_cast(zpointer* dst, zpointer* src, size_t length);\n+    static OopCopyResult oop_arraycopy_in_heap_check_cast(zpointer* dst, zpointer* src, size_t length, Klass* dst_klass);\n+    static OopCopyResult oop_arraycopy_in_heap_no_check_cast(zpointer* dst, zpointer* src, size_t length);\n@@ -143,9 +138,9 @@\n-    static void oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, zpointer* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, zpointer* dst_raw,\n-                                      size_t length);\n-    static void oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, oop* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, oop* dst_raw,\n-                                      size_t length) {\n-      oop_arraycopy_in_heap(src_obj, src_offset_in_bytes, (zpointer*)src_raw,\n-                            dst_obj, dst_offset_in_bytes, (zpointer*)dst_raw,\n-                            length);\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, zpointer* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, zpointer* dst_raw,\n+                                               size_t length);\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, oop* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, oop* dst_raw,\n+                                              size_t length) {\n+      return oop_arraycopy_in_heap(src_obj, src_offset_in_bytes, (zpointer*)src_raw,\n+                                   dst_obj, dst_offset_in_bytes, (zpointer*)dst_raw,\n+                                   length);\n@@ -153,3 +148,3 @@\n-    static void oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, narrowOop* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, narrowOop* dst_raw,\n-                                      size_t length) { unsupported(); }\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, narrowOop* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, narrowOop* dst_raw,\n+                                               size_t length) { unsupported(); }\n","filename":"src\/hotspot\/share\/gc\/z\/zBarrierSet.hpp","additions":17,"deletions":22,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -334,1 +334,1 @@\n-inline ZBarrierSet::OopCopyCheckStatus ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_copy_one(zpointer* dst, zpointer* src) {\n+inline OopCopyResult ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_copy_one(zpointer* dst, zpointer* src) {\n@@ -338,1 +338,1 @@\n-    return oop_copy_check_null;\n+    return OopCopyResult::failed_check_null;\n@@ -342,1 +342,2 @@\n-  return oop_copy_check_ok;\n+\n+  return OopCopyResult::ok;\n@@ -346,1 +347,1 @@\n-inline ZBarrierSet::OopCopyCheckStatus ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_copy_one_check_cast(zpointer* dst, zpointer* src, Klass* dst_klass) {\n+inline OopCopyResult ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_copy_one_check_cast(zpointer* dst, zpointer* src, Klass* dst_klass) {\n@@ -348,1 +349,0 @@\n-  const bool null_check = HasDecorator<decorators, ARRAYCOPY_NOTNULL>::value;\n@@ -350,2 +350,2 @@\n-  if (null_check && is_null(obj)) {\n-    return oop_copy_check_null;\n+  if (HasDecorator<decorators, ARRAYCOPY_NOTNULL>::value && is_null(obj)) {\n+    return OopCopyResult::failed_check_null;\n@@ -353,1 +353,2 @@\n-  else if (!oopDesc::is_instanceof_or_null(to_oop(obj), dst_klass)) {\n+\n+  if (!oopDesc::is_instanceof_or_null(to_oop(obj), dst_klass)) {\n@@ -355,1 +356,1 @@\n-    return oop_copy_check_class_cast;\n+    return OopCopyResult::failed_check_class_cast;\n@@ -360,1 +361,1 @@\n-  return oop_copy_check_ok;\n+  return OopCopyResult::ok;\n@@ -364,1 +365,1 @@\n-inline ZBarrierSet::OopCopyCheckStatus ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap_check_cast(zpointer* dst, zpointer* src, size_t length, Klass* dst_klass) {\n+inline OopCopyResult ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap_check_cast(zpointer* dst, zpointer* src, size_t length, Klass* dst_klass) {\n@@ -366,3 +367,5 @@\n-  OopCopyCheckStatus check_status = oop_copy_check_ok;\n-  for (const zpointer* const end = src + length; (check_status == oop_copy_check_ok) && (src < end); src++, dst++) {\n-    check_status = oop_copy_one_check_cast(dst, src, dst_klass);\n+  for (const zpointer* const end = src + length; src < end; src++, dst++) {\n+    const OopCopyResult result = oop_copy_one_check_cast(dst, src, dst_klass);\n+    if (result != OopCopyResult::ok) {\n+      return result;\n+    }\n@@ -370,1 +373,2 @@\n-  return check_status;\n+\n+  return OopCopyResult::ok;\n@@ -374,1 +378,1 @@\n-inline ZBarrierSet::OopCopyCheckStatus ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap_no_check_cast(zpointer* dst, zpointer* src, size_t length) {\n+inline OopCopyResult ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap_no_check_cast(zpointer* dst, zpointer* src, size_t length) {\n@@ -376,1 +380,1 @@\n-  OopCopyCheckStatus check_status = oop_copy_check_ok;\n+\n@@ -378,2 +382,5 @@\n-    for (const zpointer* const end = src + length; (check_status == oop_copy_check_ok) && (src < end); src++, dst++) {\n-      check_status = oop_copy_one(dst, src);\n+    for (const zpointer* const end = src + length; src < end; src++, dst++) {\n+      const OopCopyResult result = oop_copy_one(dst, src);\n+      if (result != OopCopyResult::ok) {\n+        return result;\n+      }\n@@ -381,1 +388,2 @@\n-    return check_status;\n+\n+    return OopCopyResult::ok;\n@@ -388,2 +396,5 @@\n-    for ( ; (check_status == oop_copy_check_ok) && (src >= end); src--, dst--) {\n-      check_status = oop_copy_one(dst, src);\n+    for ( ; src >= end; src--, dst--) {\n+      const OopCopyResult result = oop_copy_one(dst, src);\n+      if (result != OopCopyResult::ok) {\n+        return result;\n+      }\n@@ -391,1 +402,2 @@\n-    return check_status;\n+\n+    return OopCopyResult::ok;\n@@ -395,1 +407,1 @@\n-  return check_status;\n+  return OopCopyResult::ok;\n@@ -399,3 +411,3 @@\n-inline void ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, zpointer* src_raw,\n-                                                                                       arrayOop dst_obj, size_t dst_offset_in_bytes, zpointer* dst_raw,\n-                                                                                       size_t length) {\n+inline OopCopyResult ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, zpointer* src_raw,\n+                                                                                                arrayOop dst_obj, size_t dst_offset_in_bytes, zpointer* dst_raw,\n+                                                                                                size_t length) {\n@@ -404,1 +416,0 @@\n-  OopCopyCheckStatus check_status;\n@@ -408,1 +419,1 @@\n-    check_status = oop_arraycopy_in_heap_check_cast(dst, src, length, dst_klass);\n+    return oop_arraycopy_in_heap_check_cast(dst, src, length, dst_klass);\n@@ -410,15 +421,1 @@\n-    check_status = oop_arraycopy_in_heap_no_check_cast(dst, src, length);\n-  }\n-\n-  switch (check_status) {\n-  case oop_copy_check_ok:\n-    return;\n-  case oop_copy_check_class_cast:\n-    throw_array_store_exception(src_obj, dst_obj, JavaThread::current());\n-    break;\n-  case oop_copy_check_null:\n-    throw_array_null_pointer_store_exception(src_obj, dst_obj, JavaThread::current());\n-    break;\n-  default:\n-    ShouldNotReachHere();\n-    return;\n+    return oop_arraycopy_in_heap_no_check_cast(dst, src, length);\n","filename":"src\/hotspot\/share\/gc\/z\/zBarrierSet.inline.hpp","additions":41,"deletions":44,"binary":false,"changes":85,"status":"modified"},{"patch":"@@ -139,3 +139,3 @@\n-  static inline void oop_arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, const T* src_raw,\n-                                   arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                   size_t length) {\n+  static inline OopCopyResult oop_arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, const T* src_raw,\n+                                            arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                            size_t length) {\n@@ -144,3 +144,3 @@\n-    AccessInternal::arraycopy<decorators | INTERNAL_VALUE_IS_OOP>(src_obj, src_offset_in_bytes, src_raw,\n-                                                                  dst_obj, dst_offset_in_bytes, dst_raw,\n-                                                                  length);\n+    return AccessInternal::arraycopy<decorators | INTERNAL_VALUE_IS_OOP>(src_obj, src_offset_in_bytes, src_raw,\n+                                                                         dst_obj, dst_offset_in_bytes, dst_raw,\n+                                                                         length);\n@@ -335,6 +335,7 @@\n-  static inline void oop_arraycopy(arrayOop src_obj, size_t src_offset_in_bytes,\n-                                   arrayOop dst_obj, size_t dst_offset_in_bytes,\n-                                   size_t length) {\n-    AccessT::oop_arraycopy(src_obj, src_offset_in_bytes, static_cast<const HeapWord*>(nullptr),\n-                           dst_obj, dst_offset_in_bytes, static_cast<HeapWord*>(nullptr),\n-                           length);\n+  [[nodiscard]] \/\/ The caller is responsible to thow an exception on failure\n+  static inline OopCopyResult oop_arraycopy(arrayOop src_obj, size_t src_offset_in_bytes,\n+                                            arrayOop dst_obj, size_t dst_offset_in_bytes,\n+                                            size_t length) {\n+    return AccessT::oop_arraycopy(src_obj, src_offset_in_bytes, static_cast<const HeapWord*>(nullptr),\n+                                  dst_obj, dst_offset_in_bytes, static_cast<HeapWord*>(nullptr),\n+                                  length);\n@@ -345,3 +346,8 @@\n-    AccessT::oop_arraycopy(nullptr, 0, src,\n-                           nullptr, 0, dst,\n-                           length);\n+    static_assert((decorators & ARRAYCOPY_CHECKCAST) == 0);\n+    static_assert((decorators & ARRAYCOPY_NOTNULL) == 0);\n+\n+    OopCopyResult result = AccessT::oop_arraycopy(nullptr, 0, src,\n+                                                  nullptr, 0, dst,\n+                                                  length);\n+\n+    assert(result == OopCopyResult::ok, \"Should never fail\");\n","filename":"src\/hotspot\/share\/oops\/access.hpp","additions":21,"deletions":15,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -128,3 +128,3 @@\n-    static void access_barrier(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                               size_t length) {\n+    static OopCopyResult access_barrier(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                        arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                        size_t length) {\n@@ -134,0 +134,1 @@\n+      return OopCopyResult::ok;\n@@ -137,3 +138,3 @@\n-    static void oop_access_barrier(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                   arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                   size_t length) {\n+    static OopCopyResult oop_access_barrier(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                            arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                            size_t length) {\n@@ -141,3 +142,3 @@\n-      GCBarrierType::oop_arraycopy_in_heap(src_obj, src_offset_in_bytes, reinterpret_cast<OopType*>(src_raw),\n-                                           dst_obj, dst_offset_in_bytes, reinterpret_cast<OopType*>(dst_raw),\n-                                           length);\n+      return GCBarrierType::oop_arraycopy_in_heap(src_obj, src_offset_in_bytes, reinterpret_cast<OopType*>(src_raw),\n+                                                  dst_obj, dst_offset_in_bytes, reinterpret_cast<OopType*>(dst_raw),\n+                                                  length);\n@@ -340,3 +341,3 @@\n-  void RuntimeDispatch<decorators, T, BARRIER_ARRAYCOPY>::arraycopy_init(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                                                         arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                                                         size_t length) {\n+  OopCopyResult RuntimeDispatch<decorators, T, BARRIER_ARRAYCOPY>::arraycopy_init(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                                                                  arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                                                                  size_t length) {\n@@ -345,3 +346,3 @@\n-    function(src_obj, src_offset_in_bytes, src_raw,\n-             dst_obj, dst_offset_in_bytes, dst_raw,\n-             length);\n+    return function(src_obj, src_offset_in_bytes, src_raw,\n+                    dst_obj, dst_offset_in_bytes, dst_raw,\n+                    length);\n","filename":"src\/hotspot\/share\/oops\/access.inline.hpp","additions":16,"deletions":15,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -39,0 +39,7 @@\n+\/\/ Result from oop_arraycopy\n+enum class OopCopyResult {\n+  ok,                      \/\/ oop array copy sucessful\n+  failed_check_class_cast, \/\/ oop array copy failed subtype check (ARRAYCOPY_CHECKCAST)\n+  failed_check_null        \/\/ oop array copy failed null check (ARRAYCOPY_NOTNULL)\n+};\n+\n@@ -105,3 +112,3 @@\n-    typedef void (*arraycopy_func_t)(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                     arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                     size_t length);\n+    typedef OopCopyResult (*arraycopy_func_t)(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                              arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                              size_t length);\n@@ -114,3 +121,3 @@\n-    typedef void (*arraycopy_func_t)(arrayOop src_obj, size_t src_offset_in_bytes, void* src,\n-                                     arrayOop dst_obj, size_t dst_offset_in_bytes, void* dst,\n-                                     size_t length);\n+    typedef OopCopyResult (*arraycopy_func_t)(arrayOop src_obj, size_t src_offset_in_bytes, void* src,\n+                                              arrayOop dst_obj, size_t dst_offset_in_bytes, void* dst,\n+                                              size_t length);\n@@ -524,3 +531,3 @@\n-    static void arraycopy_init(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                               size_t length);\n+    static OopCopyResult arraycopy_init(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                        arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                        size_t length);\n@@ -528,3 +535,3 @@\n-    static inline void arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                 arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                 size_t length) {\n+    static inline OopCopyResult arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                          arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                          size_t length) {\n@@ -855,1 +862,1 @@\n-      HasDecorator<decorators, AS_RAW>::value && CanHardwireRaw<decorators>::value, void>::type\n+      HasDecorator<decorators, AS_RAW>::value && CanHardwireRaw<decorators>::value, OopCopyResult>::type\n@@ -869,0 +876,2 @@\n+\n+      return OopCopyResult::ok;\n@@ -873,1 +882,1 @@\n-      HasDecorator<decorators, AS_RAW>::value && !CanHardwireRaw<decorators>::value, void>::type\n+      HasDecorator<decorators, AS_RAW>::value && !CanHardwireRaw<decorators>::value, OopCopyResult>::type\n@@ -879,3 +888,3 @@\n-        PreRuntimeDispatch::arraycopy<expanded_decorators>(src_obj, src_offset_in_bytes, src_raw,\n-                                                           dst_obj, dst_offset_in_bytes, dst_raw,\n-                                                           length);\n+        return PreRuntimeDispatch::arraycopy<expanded_decorators>(src_obj, src_offset_in_bytes, src_raw,\n+                                                                  dst_obj, dst_offset_in_bytes, dst_raw,\n+                                                                  length);\n@@ -884,3 +893,3 @@\n-        PreRuntimeDispatch::arraycopy<expanded_decorators>(src_obj, src_offset_in_bytes, src_raw,\n-                                                           dst_obj, dst_offset_in_bytes, dst_raw,\n-                                                           length);\n+        return PreRuntimeDispatch::arraycopy<expanded_decorators>(src_obj, src_offset_in_bytes, src_raw,\n+                                                                  dst_obj, dst_offset_in_bytes, dst_raw,\n+                                                                  length);\n@@ -892,1 +901,1 @@\n-      !HasDecorator<decorators, AS_RAW>::value, void>::type\n+      !HasDecorator<decorators, AS_RAW>::value, OopCopyResult>::type\n@@ -898,3 +907,3 @@\n-        PreRuntimeDispatch::arraycopy<expanded_decorators>(src_obj, src_offset_in_bytes, src_raw,\n-                                                           dst_obj, dst_offset_in_bytes, dst_raw,\n-                                                           length);\n+        return PreRuntimeDispatch::arraycopy<expanded_decorators>(src_obj, src_offset_in_bytes, src_raw,\n+                                                                  dst_obj, dst_offset_in_bytes, dst_raw,\n+                                                                  length);\n@@ -902,3 +911,3 @@\n-        RuntimeDispatch<decorators, T, BARRIER_ARRAYCOPY>::arraycopy(src_obj, src_offset_in_bytes, src_raw,\n-                                                                     dst_obj, dst_offset_in_bytes, dst_raw,\n-                                                                     length);\n+        return RuntimeDispatch<decorators, T, BARRIER_ARRAYCOPY>::arraycopy(src_obj, src_offset_in_bytes, src_raw,\n+                                                                            dst_obj, dst_offset_in_bytes, dst_raw,\n+                                                                            length);\n@@ -1052,6 +1061,6 @@\n-  inline void arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                     arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                     size_t length) {\n-    PreRuntimeDispatch::arraycopy<decorators>(src_obj, src_offset_in_bytes, src_raw,\n-                                              dst_obj, dst_offset_in_bytes, dst_raw,\n-                                              length);\n+  inline OopCopyResult arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                              arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                              size_t length) {\n+    return PreRuntimeDispatch::arraycopy<decorators>(src_obj, src_offset_in_bytes, src_raw,\n+                                                     dst_obj, dst_offset_in_bytes, dst_raw,\n+                                                     length);\n@@ -1061,3 +1070,3 @@\n-  inline void arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, HeapWord* src_raw,\n-                                     arrayOop dst_obj, size_t dst_offset_in_bytes, HeapWord* dst_raw,\n-                                     size_t length) {\n+  inline OopCopyResult arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, HeapWord* src_raw,\n+                                              arrayOop dst_obj, size_t dst_offset_in_bytes, HeapWord* dst_raw,\n+                                              size_t length) {\n@@ -1065,3 +1074,3 @@\n-    PreRuntimeDispatch::arraycopy<expanded_decorators>(src_obj, src_offset_in_bytes, src_raw,\n-                                                       dst_obj, dst_offset_in_bytes, dst_raw,\n-                                                       length);\n+    return PreRuntimeDispatch::arraycopy<expanded_decorators>(src_obj, src_offset_in_bytes, src_raw,\n+                                                              dst_obj, dst_offset_in_bytes, dst_raw,\n+                                                              length);\n@@ -1071,3 +1080,3 @@\n-  inline void arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, narrowOop* src_raw,\n-                                     arrayOop dst_obj, size_t dst_offset_in_bytes, narrowOop* dst_raw,\n-                                     size_t length) {\n+  inline OopCopyResult arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, narrowOop* src_raw,\n+                                              arrayOop dst_obj, size_t dst_offset_in_bytes, narrowOop* dst_raw,\n+                                              size_t length) {\n@@ -1076,3 +1085,3 @@\n-    PreRuntimeDispatch::arraycopy<expanded_decorators>(src_obj, src_offset_in_bytes, src_raw,\n-                                                       dst_obj, dst_offset_in_bytes, dst_raw,\n-                                                       length);\n+    return PreRuntimeDispatch::arraycopy<expanded_decorators>(src_obj, src_offset_in_bytes, src_raw,\n+                                                              dst_obj, dst_offset_in_bytes, dst_raw,\n+                                                              length);\n@@ -1211,3 +1220,3 @@\n-  inline void arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, const T* src_raw,\n-                        arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                        size_t length) {\n+  inline OopCopyResult arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, const T* src_raw,\n+                                 arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                 size_t length) {\n@@ -1219,3 +1228,3 @@\n-    arraycopy_reduce_types<expanded_decorators>(src_obj, src_offset_in_bytes, const_cast<DecayedT*>(src_raw),\n-                                                dst_obj, dst_offset_in_bytes, const_cast<DecayedT*>(dst_raw),\n-                                                length);\n+    return arraycopy_reduce_types<expanded_decorators>(src_obj, src_offset_in_bytes, const_cast<DecayedT*>(src_raw),\n+                                                       dst_obj, dst_offset_in_bytes, const_cast<DecayedT*>(dst_raw),\n+                                                       length);\n","filename":"src\/hotspot\/share\/oops\/accessBackend.hpp","additions":60,"deletions":51,"binary":false,"changes":111,"status":"modified"},{"patch":"@@ -338,0 +338,1 @@\n+\n","filename":"src\/hotspot\/share\/oops\/accessBackend.inline.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -41,0 +41,1 @@\n+#include \"oops\/objArrayKlass.inline.hpp\"\n@@ -153,0 +154,27 @@\n+static void throw_array_null_pointer_store_exception(arrayOop src, arrayOop dst, TRAPS) {\n+  ResourceMark rm(THREAD);\n+  Klass* bound = ObjArrayKlass::cast(dst->klass())->element_klass();\n+  stringStream ss;\n+  ss.print(\"arraycopy: can not copy null values into %s[]\",\n+           bound->external_name());\n+  THROW_MSG(vmSymbols::java_lang_NullPointerException(), ss.as_string());\n+}\n+\n+static void throw_array_store_exception(arrayOop src, arrayOop dst, TRAPS) {\n+  ResourceMark rm(THREAD);\n+  Klass* bound = ObjArrayKlass::cast(dst->klass())->element_klass();\n+  Klass* stype = ObjArrayKlass::cast(src->klass())->element_klass();\n+  stringStream ss;\n+  if (!bound->is_subtype_of(stype)) {\n+    ss.print(\"arraycopy: type mismatch: can not copy %s[] into %s[]\",\n+             stype->external_name(), bound->external_name());\n+  } else {\n+    \/\/ oop_arraycopy should return the index in the source array that\n+    \/\/ contains the problematic oop.\n+    ss.print(\"arraycopy: element type mismatch: can not cast one of the elements\"\n+             \" of %s[] to the type of the destination array, %s\",\n+             stype->external_name(), bound->external_name());\n+  }\n+  THROW_MSG(vmSymbols::java_lang_ArrayStoreException(), ss.as_string());\n+}\n+\n@@ -160,1 +188,2 @@\n-    ArrayAccess<>::oop_arraycopy(s, src_offset, d, dst_offset, length);\n+    OopCopyResult result = ArrayAccess<>::oop_arraycopy(s, src_offset, d, dst_offset, length);\n+    assert(result == OopCopyResult::ok, \"Should never fail\");\n@@ -162,3 +191,0 @@\n-    \/\/ We have to make sure all elements conform to the destination array\n-    Klass *bound = RefArrayKlass::cast(d->klass())->element_klass();\n-    Klass *stype = RefArrayKlass::cast(s->klass())->element_klass();\n@@ -168,13 +194,14 @@\n-    if (stype == bound || stype->is_subtype_of(bound)) {\n-      if (null_check) {\n-        ArrayAccess<ARRAYCOPY_DISJOINT | ARRAYCOPY_NOTNULL>::oop_arraycopy(\n-            s, src_offset, d, dst_offset, length);\n-      } else {\n-        ArrayAccess<ARRAYCOPY_DISJOINT>::oop_arraycopy(s, src_offset, d,\n-                                                       dst_offset, length);\n-      }\n-    } else {\n-      if (null_check) {\n-        ArrayAccess<ARRAYCOPY_DISJOINT | ARRAYCOPY_CHECKCAST |\n-                    ARRAYCOPY_NOTNULL>::oop_arraycopy(s, src_offset, d,\n-                                                      dst_offset, length);\n+    \/\/ We have to make sure all elements conform to the destination array\n+    Klass *bound = RefArrayKlass::cast(d->klass())->element_klass();\n+    Klass *stype = RefArrayKlass::cast(s->klass())->element_klass();\n+    bool type_check = stype != bound && !stype->is_subtype_of(bound);\n+\n+    auto arraycopy = [&] {\n+      if (type_check) {\n+        if (null_check) {\n+          return ArrayAccess<ARRAYCOPY_DISJOINT | ARRAYCOPY_CHECKCAST | ARRAYCOPY_NOTNULL>::\n+              oop_arraycopy(s, src_offset, d, dst_offset, length);\n+        } else {\n+          return ArrayAccess<ARRAYCOPY_DISJOINT | ARRAYCOPY_CHECKCAST>::\n+              oop_arraycopy(s, src_offset, d, dst_offset, length);\n+        }\n@@ -182,2 +209,7 @@\n-        ArrayAccess<ARRAYCOPY_DISJOINT | ARRAYCOPY_CHECKCAST>::oop_arraycopy(\n-            s, src_offset, d, dst_offset, length);\n+        if (null_check) {\n+          return ArrayAccess<ARRAYCOPY_DISJOINT | ARRAYCOPY_NOTNULL>::\n+              oop_arraycopy(s, src_offset, d, dst_offset, length);\n+        } else {\n+          return ArrayAccess<ARRAYCOPY_DISJOINT>::\n+              oop_arraycopy(s, src_offset, d, dst_offset, length);\n+        }\n@@ -185,0 +217,16 @@\n+    };\n+\n+    OopCopyResult result = arraycopy();\n+\n+    switch (result) {\n+    case OopCopyResult::ok:\n+      \/\/ Done\n+      break;\n+    case OopCopyResult::failed_check_class_cast:\n+      throw_array_store_exception(s, d, JavaThread::current());\n+      break;\n+    case OopCopyResult::failed_check_null:\n+      throw_array_null_pointer_store_exception(s, d, JavaThread::current());\n+      break;\n+    default:\n+      ShouldNotReachHere();\n","filename":"src\/hotspot\/share\/oops\/refArrayKlass.cpp","additions":67,"deletions":19,"binary":false,"changes":86,"status":"modified"}]}