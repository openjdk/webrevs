{"files":[{"patch":"@@ -80,0 +80,2 @@\n+import com.sun.tools.javac.tree.JCTree.JCNullableTypeExpression;\n+import com.sun.tools.javac.tree.JCTree.JCNullableTypeExpression.NullMarker;\n@@ -332,0 +334,1 @@\n+            boolean nonNull = false;\n@@ -343,0 +346,4 @@\n+                if (baseType instanceof JCNullableTypeExpression nullable &&\n+                    nullable.getNullMarker() == NullMarker.NOT_NULL) {\n+                    nonNull = true;\n+                }\n@@ -428,1 +435,1 @@\n-                                     winit, enhancedDesugaring, anonDeclareWrap);\n+                                     winit, nonNull, enhancedDesugaring, anonDeclareWrap);\n@@ -431,1 +438,2 @@\n-                    name, fieldName, subkind, displayType, hasEnhancedType ? fullTypeName : null, anonymousClasses,\n+                    name, fieldName, subkind, displayType, hasEnhancedType ? fullTypeName : null,\n+                    nonNull, anonymousClasses,\n@@ -691,1 +699,1 @@\n-                        name, name, SubKind.TEMP_VAR_EXPRESSION_SUBKIND, displayTypeName, fullTypeName, anonymousClasses, declareReferences, null);\n+                        name, name, SubKind.TEMP_VAR_EXPRESSION_SUBKIND, displayTypeName, fullTypeName, false, anonymousClasses, declareReferences, null);\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/jshell\/Eval.java","additions":11,"deletions":3,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -220,1 +220,1 @@\n-                                : EXPR | TYPE);\n+                                : EXPR | TYPE | ALLOW_BANGS);\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/jshell\/ReplParser.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -55,0 +55,1 @@\n+    final boolean nonNull;\n@@ -65,0 +66,1 @@\n+            boolean nonNull,\n@@ -71,0 +73,1 @@\n+        this.nonNull = nonNull;\n@@ -89,1 +92,1 @@\n-        return \"import static \" + classFullName() + \".\" + name() + \";   \" +\n+        return \"import static \" + classFullName() + \".\" + (nonNull ? \"Holder.\" : \"\") + name() + \";   \" +\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/jshell\/VarSnippet.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -91,1 +91,1 @@\n-                               Wrap wname, Wrap winit, boolean enhanced,\n+                               Wrap wname, Wrap winit, boolean nonNull, boolean enhanced,\n@@ -94,1 +94,1 @@\n-        components.add(new VarDeclareWrap(wtype, brackets, wname));\n+\n@@ -97,2 +97,8 @@\n-        if (winit == null) {\n-            wmeth = new CompoundWrap(new NoWrap(\" \"), \"   return null;\\n\");\n+        if (nonNull) {\n+            components.add(\n+                    new CompoundWrap(\"    public static class Holder {\\n    \",\n+                                     new VarDeclareWrap(wtype, brackets, wname, winit),\n+                                     \"    }\\n\"));\n+            wmeth = new CompoundWrap(\n+                    \"        return \", \"Holder.\", wname, \";\\n\"\n+            );\n@@ -100,26 +106,4 @@\n-            \/\/ int x = y\n-            if (enhanced) {\n-                \/\/ private static <Z> Z do_itAux() {\n-                \/\/     wtype x_ = y;\n-                \/\/     @SuppressWarnings(\"unchecked\")\n-                \/\/     Z x__ = (Z) x_;\n-                \/\/     return x__;\n-                \/\/ }\n-                \/\/ in do_it method:\n-                \/\/return do_itAux();\n-                \/\/find an unused name:\n-                String scratchName = \"$\";\n-                while (winit.wrapped().contains(scratchName)) {\n-                    scratchName += \"$\";\n-                }\n-                Wrap waux = new CompoundWrap(\n-                        \"    private static <\" + scratchName + \"> \" + scratchName +\" \", DOIT_METHOD_NAME + \"Aux\", \"() throws java.lang.Throwable {\\n\",\n-                        wtype, brackets + \" \", scratchName, \"_ =\\n        \", winit, semi(winit),\n-                        \"        @java.lang.SuppressWarnings(\\\"unchecked\\\") \", scratchName, \" \", scratchName, \"__ = (\", scratchName, \")\", scratchName, \"_;\\n\",\n-                        \"        return \", scratchName, \"__;\\n\",\n-                        \"}\"\n-                );\n-                components.add(waux);\n-                wmeth = new CompoundWrap(\n-                        \"        return \", wname, \" = \", DOIT_METHOD_NAME + \"Aux\", \"();\\n\"\n-                );\n+            components.add(new VarDeclareWrap(wtype, brackets, wname));\n+\n+            if (winit == null) {\n+                wmeth = new CompoundWrap(new NoWrap(\" \"), \"   return null;\\n\");\n@@ -127,6 +111,34 @@\n-                \/\/ int x_ = y; return x = x_;\n-                \/\/ decl + \"_ = \" + init ; + \"return \" + name + \"= \" + name + \"_ ;\"\n-                wmeth = new CompoundWrap(\n-                        wtype, brackets + \" \", wname, \"_ =\\n        \", winit, semi(winit),\n-                        \"        return \", wname, \" = \", wname, \"_;\\n\"\n-                );\n+                \/\/ int x = y\n+                if (enhanced) {\n+                    \/\/ private static <Z> Z do_itAux() {\n+                    \/\/     wtype x_ = y;\n+                    \/\/     @SuppressWarnings(\"unchecked\")\n+                    \/\/     Z x__ = (Z) x_;\n+                    \/\/     return x__;\n+                    \/\/ }\n+                    \/\/ in do_it method:\n+                    \/\/return do_itAux();\n+                    \/\/find an unused name:\n+                    String scratchName = \"$\";\n+                    while (winit.wrapped().contains(scratchName)) {\n+                        scratchName += \"$\";\n+                    }\n+                    Wrap waux = new CompoundWrap(\n+                            \"    private static <\" + scratchName + \"> \" + scratchName +\" \", DOIT_METHOD_NAME + \"Aux\", \"() throws java.lang.Throwable {\\n\",\n+                            wtype, brackets + \" \", scratchName, \"_ =\\n        \", winit, semi(winit),\n+                            \"        @java.lang.SuppressWarnings(\\\"unchecked\\\") \", scratchName, \" \", scratchName, \"__ = (\", scratchName, \")\", scratchName, \"_;\\n\",\n+                            \"        return \", scratchName, \"__;\\n\",\n+                            \"}\"\n+                    );\n+                    components.add(waux);\n+                    wmeth = new CompoundWrap(\n+                            \"        return \", wname, \" = \", DOIT_METHOD_NAME + \"Aux\", \"();\\n\"\n+                    );\n+                } else {\n+                    \/\/ int x_ = y; return x = x_;\n+                    \/\/ decl + \"_ = \" + init ; + \"return \" + name + \"= \" + name + \"_ ;\"\n+                    wmeth = new CompoundWrap(\n+                            wtype, brackets + \" \", wname, \"_ =\\n        \", winit, semi(winit),\n+                            \"        return \", wname, \" = \", wname, \"_;\\n\"\n+                    );\n+                }\n@@ -564,0 +576,3 @@\n+        VarDeclareWrap(Wrap wtype, String brackets, Wrap wname, Wrap init) {\n+            super(\"    public static \", wtype, brackets + \" \", wname, \" = \", init, \";\\n\");\n+        }\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/jshell\/Wrap.java","additions":51,"deletions":36,"binary":false,"changes":87,"status":"modified"},{"patch":"@@ -49,0 +49,1 @@\n+import jdk.jshell.JShell;\n@@ -56,0 +57,1 @@\n+import org.junit.jupiter.api.TestInfo;\n@@ -593,2 +595,1 @@\n-    @Override\n-    public void setUp() {\n+    public void setUp(TestInfo info) {\n@@ -644,1 +645,1 @@\n-        setUp(b -> b\n+        setUp(b -> addExtraOptions(b, info)\n@@ -649,0 +650,10 @@\n+    protected JShell.Builder addExtraOptions(JShell.Builder b, TestInfo testInfo) {\n+        return switch (testInfo.getTestMethod().orElseThrow().getName()) {\n+            case \"nonNullVariables\" ->\n+                b.compilerOptions(\"--source\", System.getProperty(\"java.specification.version\"),\n+                                  \"--enable-preview\")\n+                 .remoteVMOptions(\"--enable-preview\");\n+            default -> b;\n+        };\n+    }\n+\n@@ -680,0 +691,13 @@\n+    @Test\n+    public void nonNullVariables() {\n+        assertEval(\"String! str1 = \\\"\\\";\", \"\\\"\\\"\");\n+        assertEval(\"str1 = \\\"\\\";\", \"\\\"\\\"\");\n+        assertEvalException(\"str1 = null;\");\n+        assertEvalException(\"String! str2 = null;\");\n+        assertEval(\"int[] count = new int[1];\");\n+        assertEval(\"String! str3 = String.valueOf(count[0]++);\");\n+        assertEval(\"count[0]\", \"1\");\n+        assertEval(\"String! fail() { throw new RuntimeException(); }\");\n+        assertEvalException(\"String! str4 = fail();\");\n+        assertEval(\"String[]! arr1 = new String[0];\", \"String[0] {  }\");\n+    }\n","filename":"test\/langtools\/jdk\/jshell\/VariablesTest.java","additions":27,"deletions":3,"binary":false,"changes":30,"status":"modified"}]}