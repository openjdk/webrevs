{"files":[{"patch":"@@ -329,0 +329,4 @@\n+    protected void selectTypeModeWithBangs() {\n+        setMode(ALLOW_BANGS | (mode & NOLAMBDA) | TYPE);\n+    }\n+\n@@ -850,1 +854,3 @@\n-            checkNullRestrictionLocation(BAD_BANG_LOCATION_QUALIDENT);\n+            if (checkNullRestrictionLocation(BAD_BANG_LOCATION_QUALIDENT)) {\n+                setNullMarker(t);\n+            }\n@@ -865,1 +871,3 @@\n-                checkNullRestrictionLocation(BAD_BANG_LOCATION_QUALIDENT);\n+                if (checkNullRestrictionLocation(BAD_BANG_LOCATION_QUALIDENT)) {\n+                    setNullMarker(t);\n+                }\n@@ -1774,0 +1782,1 @@\n+                            skipUnsupportedNullRestriction();\n@@ -1780,0 +1789,1 @@\n+                                skipUnsupportedNullRestriction();\n@@ -2037,1 +2047,1 @@\n-                case MONKEYS_AT:\n+                case MONKEYS_AT: case BANG:\n@@ -2073,1 +2083,2 @@\n-                            nextKind == TokenKind.COLCOL;\n+                            nextKind == TokenKind.COLCOL ||\n+                            (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(nextKind));\n@@ -2287,2 +2298,2 @@\n-    protected Predicate<TokenKind> BAD_BANG_LOCATION = t -> t == LBRACKET || t == MONKEYS_AT || t == DOT || t == LPAREN;\n-    protected Predicate<TokenKind> BAD_BANG_LOCATION_QUALIDENT = t -> t == MONKEYS_AT || t == DOT || t == LPAREN;\n+    protected Predicate<TokenKind> BAD_BANG_LOCATION = t -> t == LT || t == LBRACKET || t == MONKEYS_AT || t == DOT || t == LPAREN;\n+    protected Predicate<TokenKind> BAD_BANG_LOCATION_QUALIDENT = t -> t == LT || t == MONKEYS_AT || t == DOT || t == LPAREN;\n@@ -2501,1 +2512,1 @@\n-        if (token.kind == LT &&\n+        if (isParameterizedTypeStart() &&\n@@ -2510,0 +2521,6 @@\n+\n+    private boolean isParameterizedTypeStart() {\n+        return token.kind == LT ||\n+                (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(token.kind) && peekToken(LT));\n+    }\n+\n@@ -2608,0 +2625,1 @@\n+        skipUnsupportedNullRestriction(); \/\/ null-restriction not supported immediately before '<'\n@@ -2803,1 +2821,1 @@\n-        selectTypeMode();\n+        selectTypeModeWithBangs();\n@@ -2806,4 +2824,0 @@\n-        if (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(token.kind)) {\n-            setNullMarker(t);\n-            nextToken();\n-        }\n@@ -2813,0 +2827,6 @@\n+            if (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(token.kind)) {\n+                if (checkNullRestrictionLocation(BAD_BANG_LOCATION_QUALIDENT)) {\n+                    setNullMarker(t);\n+                }\n+                nextToken();\n+            }\n@@ -2830,2 +2850,3 @@\n-                checkNullRestrictonAllowed();\n-                setNullMarker(t);\n+                if (checkNullRestrictionLocation(BAD_BANG_LOCATION_QUALIDENT)) {\n+                    setNullMarker(t);\n+                }\n@@ -2838,0 +2859,6 @@\n+                if (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(token.kind)) {\n+                    if (checkNullRestrictionLocation(BAD_BANG_LOCATION_QUALIDENT)) {\n+                        setNullMarker(t);\n+                    }\n+                    nextToken();\n+                }\n@@ -2892,1 +2919,1 @@\n-        if (token.kind == LT) {\n+        if (isParameterizedTypeStart()) {\n@@ -2897,0 +2924,3 @@\n+\n+        skipUnsupportedNullRestriction();\n+\n@@ -2909,0 +2939,1 @@\n+            skipUnsupportedNullRestriction();\n@@ -2938,4 +2969,1 @@\n-            if (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(token.kind)) {\n-                checkNullRestrictionLocation();\n-                nextToken();\n-            }\n+            skipUnsupportedNullRestriction();\n@@ -2953,4 +2981,1 @@\n-                    if (allowNullRestrictedTypes && EMOTIONAL_QUALIFIER.test(token.kind)) {\n-                        checkNullRestrictionLocation();\n-                        nextToken();\n-                    }\n+                    skipUnsupportedNullRestriction();\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/parser\/JavacParser.java","additions":48,"deletions":23,"binary":false,"changes":71,"status":"modified"},{"patch":"@@ -31,0 +31,7 @@\n+    void testNewArrayWithInit() {\n+        var z = new Foo![] { null }; \/\/ ok\n+        var y = new Foo![]! { null }; \/\/ bad, bang can't appear at the end\n+        var x = new Foo![]![] { null }; \/\/ bad, bang can't appear in the middle\n+        var x = new Foo![]![]! { null }; \/\/ bad, bang can't appear in the middle or at the end\n+    }\n+\n@@ -38,0 +45,29 @@\n+    void testNoBangInMrefQualifier() {\n+        Runnable r = Foo!<String>::m;\n+        Runnable r = Foo<String!>::m;\n+        Runnable r = Foo<String>!::m;\n+        Runnable r = Foo<String>![]::m;\n+        Runnable r = Foo<String>![]!::m;\n+        Runnable r = Foo<String>.Foo!<Integer>::m;\n+        Runnable r = Foo<String>.Foo<Integer!>::m;\n+        Runnable r = Foo<String>.Foo<Integer>!::m;\n+        Runnable r = Foo<String>.Foo!<Integer>::m;\n+        Runnable r = Foo<String>.Foo<Integer!>::m;\n+        Runnable r = Foo<String>.Foo<Integer>![]::m;\n+        Runnable r = Foo<String>.Foo<Integer>![]!::m;\n+    }\n+\n+    void testInnerClassCreator() {\n+        encl.new Foo!();\n+        encl.new Foo<String!>();\n+        encl.new Foo<String>!();\n+    }\n+\n+    void testQualifiedType() {\n+        A<String>!.B<Integer> a;\n+        A!<String>.B<Integer> a;\n+        A<String>.B!<Integer> a;\n+        A<String>.B<Integer!> a;\n+        A<String!>.B<Integer> a;\n+    }\n+\n","filename":"test\/langtools\/tools\/javac\/nullability\/NullRestrictionNegParserTest.java","additions":36,"deletions":0,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -17,7 +17,33 @@\n-NullRestrictionNegParserTest.java:32:10: compiler.err.unsupported.null.restriction\n-NullRestrictionNegParserTest.java:33:10: compiler.err.unsupported.null.restriction\n-NullRestrictionNegParserTest.java:33:13: compiler.err.unsupported.null.restriction\n-NullRestrictionNegParserTest.java:34:10: compiler.err.unsupported.null.restriction\n-NullRestrictionNegParserTest.java:35:12: compiler.err.unsupported.null.restriction\n-NullRestrictionNegParserTest.java:39:24: compiler.err.unsupported.null.restriction\n-22 errors\n+NullRestrictionNegParserTest.java:33:27: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:34:27: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:35:27: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:35:30: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:39:10: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:40:10: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:40:13: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:41:10: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:42:12: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:46:25: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:47:32: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:48:33: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:49:33: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:50:33: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:50:36: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:51:37: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:52:45: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:53:46: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:54:37: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:55:45: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:56:46: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:57:46: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:57:49: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:61:21: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:62:28: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:63:29: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:67:18: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:68:10: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:69:20: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:70:28: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:71:17: compiler.err.unsupported.null.restriction\n+NullRestrictionNegParserTest.java:75:24: compiler.err.unsupported.null.restriction\n+48 errors\n","filename":"test\/langtools\/tools\/javac\/nullability\/NullRestrictionNegParserTest.out","additions":33,"deletions":7,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -78,2 +78,4 @@\n-        NN_LIST_STRING(\"#{ANNO}List<String>!\", 0);\n-        \/\/NN_LIST_STRING_ARR(\"#{ANNO}List<String>[]!\", 0); \/\/ this doesn't work because of an issue (see JDK-8374629)\n+        NN_LIST_STRING(\"#{ANNO}List<String>!\", 0),\n+        NN_LIST_STRING_BAD_POS(\"#{ANNO}List!<#{ANNO}String>\", 1),\n+        LIST_NN_STRING(\"#{ANNO}List<#{ANNO}String!>\", 1);\n+        \/\/NN_LIST_STRING_ARR(\"#{ANNO}List<#{ANNO}String>[]!\", 0); \/\/ this doesn't work because of an issue (see JDK-8374629)\n","filename":"test\/langtools\/tools\/javac\/nullability\/NullRestrictionParserTest.java","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"}]}