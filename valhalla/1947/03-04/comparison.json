{"files":[{"patch":"@@ -762,2 +762,3 @@\n-    public void testUseSideChecksForFieldsSepCompilation(Path base) throws Exception {\n-        testUseSiteForFieldsSeparateCompilationHelper(base,\n+    public void testUseSideChecksForFields(Path base) throws Exception {\n+        \/\/ separate compilation\n+        String ASrc1 =\n@@ -773,1 +774,2 @@\n-                \"\"\",\n+                \"\"\";\n+        String ASrc2 =\n@@ -783,1 +785,2 @@\n-                \"\"\",\n+                \"\"\";\n+        String testSrc =\n@@ -792,1 +795,23 @@\n-                \"\"\");\n+                \"\"\";\n+        Path out;\n+        String sequenceWithNullCheck =\n+                \"Field[OP=GETFIELD, field=pkg\/A.a:Ljava\/lang\/String;]\" +\n+                \"UnboundStackInstruction[op=DUP]\" +\n+                \"Invoke[OP=INVOKESTATIC, m=java\/lang\/runtime\/Checks.nullCheck(Ljava\/lang\/Object;)V]\" +\n+                        \"Invoke[OP=INVOKEVIRTUAL, m=java\/lang\/String.toString()Ljava\/lang\/String;]\";\n+        for (String[] options : new String[][] {USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS, PREVIEW}) {\n+            out = testUseSiteForFieldsSeparateCompilationHelper(base, ASrc1, ASrc2, testSrc, true, options);\n+            if (!checkInstructionsSequence(out.resolve(\"pkg\").resolve(\"Test.class\"), \"main\", sequenceWithNullCheck)) {\n+                throw new AssertionError(\"was expecting a null check before String::toString invocation\");\n+            }\n+        }\n+\n+        String sequenceWithoutNullCheck =\n+                \"Field[OP=GETFIELD, field=pkg\/A.a:Ljava\/lang\/String;]\" +\n+                        \"Invoke[OP=INVOKEVIRTUAL, m=java\/lang\/String.toString()Ljava\/lang\/String;]\";\n+        for (String[] options : new String[][] {USE_SITE_CHECKS_FOR_METHODS_ONLY, NO_USE_SITE_CHECKS}) {\n+            out = testUseSiteForFieldsSeparateCompilationHelper(base, ASrc1, ASrc2, testSrc, false, options);\n+            if (!checkInstructionsSequence(out.resolve(\"pkg\").resolve(\"Test.class\"), \"main\", sequenceWithoutNullCheck)) {\n+                throw new AssertionError(\"was expecting a null check before String::toString invocation\");\n+            }\n+        }\n@@ -795,1 +820,1 @@\n-    private void testUseSiteForFieldsSeparateCompilationHelper(\n+    private Path testUseSiteForFieldsSeparateCompilationHelper(\n@@ -799,1 +824,3 @@\n-            String testCode) throws Exception {\n+            String testCode,\n+            boolean shouldFailDueToNullCheck,\n+            String[] options) throws Exception {\n@@ -814,1 +841,1 @@\n-                .options(USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS) \/\/ equivalent to just using PREVIEW options\n+                .options(options)\n@@ -818,1 +845,0 @@\n-        \/\/ let's execute to check that it's producing the NPE\n@@ -836,1 +862,1 @@\n-                .options(USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS) \/\/ equivalent to just using PREVIEW options\n+                .options(options)\n@@ -850,3 +876,9 @@\n-        if (!output.contains(\"java.lang.NullPointerException\") &&\n-                !output.contains(\"java.base\/java.lang.runtime.Checks.nullCheck\")) {\n-            throw new AssertionError(\"unexpected output: \" + output);\n+        if (shouldFailDueToNullCheck) {\n+            if (!output.contains(\"java.lang.NullPointerException\") &&\n+                    !output.contains(\"java.base\/java.lang.runtime.Checks.nullCheck\")) {\n+                throw new AssertionError(\"unexpected output: \" + output);\n+            }\n+        } else {\n+            if (!output.startsWith(\"Exception in thread \\\"main\\\" java.lang.NullPointerException: Cannot invoke \\\"String.toString()\\\" because \\\"<local1>.a\\\" is null\")) {\n+                throw new AssertionError(\"unexpected output: \" + output);\n+            }\n@@ -854,0 +886,23 @@\n+        return out;\n+    }\n+\n+    private Path compile(Path base,\n+                         String code,\n+                         String className,\n+                         String pakageName,\n+                         String[] options) throws Exception {\n+        Path src = base.resolve(\"src\");\n+        Path pkg = pakageName != null ? src.resolve(\"pakageName\") : src;\n+        Path ASrc = pkg.resolve(className);\n+\n+        tb.writeJavaFiles(ASrc, code);\n+\n+        Path out = base.resolve(\"out\");\n+        Files.createDirectories(out);\n+\n+        new JavacTask(tb)\n+                .outdir(out)\n+                .options(options) \/\/ equivalent to just using PREVIEW options\n+                .files(findJavaFiles(pkg))\n+                .run();\n+        return out;\n","filename":"test\/langtools\/tools\/javac\/nullability\/RuntimeNullChecks.java","additions":68,"deletions":13,"binary":false,"changes":81,"status":"modified"}]}