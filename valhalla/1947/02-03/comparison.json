{"files":[{"patch":"@@ -469,1 +469,1 @@\n-        String[] testCases1 = new String[] {\n+        String src =\n@@ -484,1 +484,18 @@\n-                \"\"\",\n+                \"\"\";\n+        String expectedInstSequence =\n+                \"Invoke[OP=INVOKESTATIC, m=java\/lang\/runtime\/Checks.nullCheck(Ljava\/lang\/Object;)V]\" +\n+                        \"Invoke[OP=INVOKEVIRTUAL, m=Test$Inner.m(Ljava\/lang\/Object;)Ljava\/lang\/Object;]\";\n+        Path out;\n+        for (String[] options : new String[][] {PREVIEW, USE_SITE_CHECKS_FOR_METHODS_ONLY, USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS}) {\n+            out = testHelper(base, src, true, NullPointerException.class, options);\n+            if (!checkInstructionsSequence(out.resolve(\"Test.class\"), \"main\", expectedInstSequence)) {\n+                throw new AssertionError(\"was expecting a null check before Inner::m invocation\");\n+            }\n+        }\n+        out = testHelper(base, src, false, null, NO_USE_SITE_CHECKS);\n+        if (checkInstructionsSequence(out.resolve(\"Test.class\"), \"main\", expectedInstSequence)) {\n+            throw new AssertionError(\"was not expecting a null check before Inner::m invocation\");\n+        }\n+\n+        \/\/ null checks in user site for returns\n+        src =\n@@ -499,29 +516,12 @@\n-                \"\"\",\n-                \"\"\"\n-                class Test {\n-                    class Inner {\n-                        Object m(Object! arg, Object... args) { return null; }\n-                    }\n-                    class Inner2 extends Inner {\n-                        @Override\n-                        String m(Object arg, Object... args) { return null; }\n-                    }\n-                    public static void main(String... args) {\n-                        Inner inner = new Test().new Inner2();\n-                        inner.m(null, null);\n-                    }\n-                }\n-                \"\"\",\n-                \"\"\"\n-                class Test {\n-                    class Inner {\n-                        Object! m(Object arg, Object... args) { return \"\"; }\n-                    }\n-                    class Inner2 extends Inner {\n-                        @Override\n-                        String m(Object arg, Object... args) { return null; }\n-                    }\n-                    public static void main(String... args) {\n-                        Inner inner = new Test().new Inner2();\n-                        inner.m(null, null);\n-                    }\n+                \"\"\";\n+        expectedInstSequence =\n+                \"Invoke[OP=INVOKEVIRTUAL, m=Test$Inner.m(Ljava\/lang\/Object;)Ljava\/lang\/Object;]\" +\n+                        \"UnboundStackInstruction[op=DUP]\" +\n+                        \"Invoke[OP=INVOKESTATIC, m=java\/lang\/runtime\/Checks.nullCheck(Ljava\/lang\/Object;)V]\";\n+        for (String[] options : new String[][] {PREVIEW, USE_SITE_CHECKS_FOR_METHODS_ONLY, USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS}) {\n+            out = testHelper(base, src, true, NullPointerException.class, options);\n+            if (!checkInstructionsSequence(out.resolve(\"Test.class\"), \"main\", expectedInstSequence)) {\n+                List<CodeElement> foundSequence = readInstructions(out.resolve(\"Test.class\"), \"main\");\n+                String found = \"\";\n+                for (CodeElement ce : foundSequence) {\n+                    found += ce.toString() + \"\\n\";\n@@ -529,7 +529,6 @@\n-                \"\"\"\n-        };\n-        for (String code : testCases1) {\n-            testHelper(base, code, true, NullPointerException.class);\n-            testHelper(base, code, true, NullPointerException.class, USE_SITE_CHECKS_FOR_METHODS_ONLY);\n-            testHelper(base, code, true, NullPointerException.class, USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS);\n-            testHelper(base, code, false, null, NO_USE_SITE_CHECKS);\n+                throw new AssertionError(\"was expecting a null check after Inner::m invocation, found: \\n\" + found);\n+            }\n+        }\n+        out = testHelper(base, src, false, null, NO_USE_SITE_CHECKS);\n+        if (checkInstructionsSequence(out.resolve(\"Test.class\"), \"main\", expectedInstSequence)) {\n+            throw new AssertionError(\"was not expecting a null check after Inner::m invocation\");\n@@ -584,4 +583,2 @@\n-            Path out = testHelper(base, code, true, NullPointerException.class, USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS);\n-            List<CodeElement> instructions = readInstructions(out.resolve(\"Test.class\"), \"main\");\n-            if (instructions.stream()\n-                    .anyMatch(instruction -> instruction.toString().equals(nullCheckInvocation))) {\n+            out = testHelper(base, code, true, NullPointerException.class, USE_SITE_CHECKS_FOR_METHODS_AND_FIELDS);\n+            if (checkInstructionsSequence(out.resolve(\"Test.class\"), \"main\", nullCheckInvocation)) {\n@@ -593,0 +590,9 @@\n+    private boolean checkInstructionsSequence(Path path, String methodName, String sequence) throws Exception {\n+        List<CodeElement> instructions = readInstructions(path, methodName);\n+        String foundSequence = \"\";\n+        for (CodeElement ce : instructions) {\n+            foundSequence += ce;\n+        }\n+        return foundSequence.contains(sequence);\n+    }\n+\n","filename":"test\/langtools\/tools\/javac\/nullability\/RuntimeNullChecks.java","additions":48,"deletions":42,"binary":false,"changes":90,"status":"modified"}]}