{"files":[{"patch":"@@ -40,3 +40,3 @@\n-static bool is_oop_containing_flat_array(Klass* klass) {\n-  return ArrayKlass::cast(klass)->is_flatArray_klass() &&\n-         FlatArrayKlass::cast(klass)->contains_oops();\n+static bool is_oop_containing_flat_array(ArrayKlass* ak) {\n+  return ak->is_flatArray_klass() &&\n+         FlatArrayKlass::cast(ak)->contains_oops();\n@@ -64,1 +64,3 @@\n-  if (is_oop_containing_flat_array(_klass)) {\n+  ArrayKlass* const ak = ArrayKlass::cast(_klass);\n+\n+  if (is_oop_containing_flat_array(ak)) {\n@@ -76,0 +78,7 @@\n+  const BasicType element_type = ak->element_type();\n+\n+  \/\/ Flat arrays containing oops are not supported and only contain primitives\n+  \/\/ from here on out.\n+  const bool is_oop_array = element_type != T_FLAT_ELEMENT &&\n+                            is_reference_type(element_type);\n+\n@@ -104,1 +113,0 @@\n-  const BasicType element_type = ArrayKlass::cast(_klass)->element_type();\n@@ -112,1 +120,1 @@\n-    assert(!is_reference_type(element_type), \"Only TypeArrays can be 4-byte aligned\");\n+    assert(!is_oop_array, \"Only TypeArrays can be 4-byte aligned\");\n@@ -151,1 +159,1 @@\n-      const uintptr_t fill_value = is_reference_type(element_type) ? colored_null : 0;\n+      const uintptr_t fill_value = is_oop_array ? colored_null : 0;\n@@ -158,1 +166,1 @@\n-      if (is_reference_type(element_type) && !seen_gc_safepoint && gc_safepoint_happened()) {\n+      if (is_oop_array && !seen_gc_safepoint && gc_safepoint_happened()) {\n","filename":"src\/hotspot\/share\/gc\/z\/zObjArrayAllocator.cpp","additions":16,"deletions":8,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -0,0 +1,68 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @requires vm.gc.Z\n+ * @summary Ensures that large flat arrays with only primitives can be allocated\n+ *          and properly initialized by ZGC\n+ * @bug 8373858\n+ * @enablePreview\n+ * @library \/test\/lib\n+ * @modules java.base\/jdk.internal.value\n+ *          java.base\/jdk.internal.vm.annotation\n+ * @run main\/othervm -Xmx1G\n+ *                   -XX:+UseZGC\n+ *                   runtime.valhalla.inlinetypes.FlatArrayLargePrimitiveOnly\n+ *\/\n+\n+package runtime.valhalla.inlinetypes;\n+\n+import jdk.internal.value.ValueClass;\n+import jdk.internal.vm.annotation.LooselyConsistentValue;\n+\n+import static jdk.test.lib.Asserts.*;\n+\n+public class FlatArrayLargePrimitiveOnly {\n+  private static final int LARGE_ARRAY_SIZE = 16 * 1024;\n+\n+  @LooselyConsistentValue\n+  static value class LooseIntegers {\n+    int i0 = 0;\n+    int i1 = 0;\n+    int i2 = 0;\n+    int i3 = 0;\n+  }\n+\n+  public static void main(String[] args) {\n+    Integer[] array = (Integer[])ValueClass.newNullableAtomicArray(Integer.class, LARGE_ARRAY_SIZE);\n+    if (array.length != LARGE_ARRAY_SIZE) {\n+      throw new RuntimeException(\"nullable atomic array not created properly\");\n+  }\n+\n+    LooseIntegers[] looseArray = (LooseIntegers[])ValueClass.newNullRestrictedNonAtomicArray(LooseIntegers.class, LARGE_ARRAY_SIZE, new LooseIntegers());\n+    if (looseArray.length != LARGE_ARRAY_SIZE) {\n+      throw new RuntimeException(\"null-restricted non-atomic array not created properly\");\n+    }\n+  }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/valhalla\/inlinetypes\/FlatArrayLargePrimitiveOnly.java","additions":68,"deletions":0,"binary":false,"changes":68,"status":"added"}]}