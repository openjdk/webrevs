{"files":[{"patch":"@@ -103,0 +103,1 @@\n+    private final NullChecksWriter nullChecksWriter;\n@@ -132,0 +133,1 @@\n+        nullChecksWriter = NullChecksWriter.instance(context);\n@@ -3395,1 +3397,2 @@\n-        if (boxingReq || depScanner.dependencyFound) {\n+        if (boxingReq || depScanner.dependencyFound ||\n+            nullChecksWriter.needsUseSiteNullCheck(tree.lhs, currentClass)) {\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Lower.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -80,0 +80,1 @@\n+    private boolean checkNulls;\n@@ -178,1 +179,2 @@\n-        super.visitAssign(tree);\n+        tree.lhs = translate(tree.lhs, false);\n+        tree.rhs = translate(tree.rhs);\n@@ -201,6 +203,2 @@\n-            Symbol sym = TreeInfo.symbolFor(tree);\n-            if (useSiteNullChecks.generateChecksForFields &&\n-                    sym.owner.kind == TYP &&\n-                    sym.kind == VAR &&\n-                    types.isNonNullable(sym.type) &&\n-                    sym.owner != currentClass) {\n+            if (needsUseSiteNullCheck(tree, currentClass) &&\n+                checkNulls) {\n@@ -318,0 +316,25 @@\n+\n+    @Override\n+    public <T extends JCTree> T translate(T tree) {\n+        return translate(tree, true);\n+    }\n+\n+    public <T extends JCTree> T translate(T tree, boolean checkNulls) {\n+        boolean prevCheckNulls = this.checkNulls;\n+        try {\n+            this.checkNulls = checkNulls;\n+            return super.translate(tree);\n+        } finally {\n+            this.checkNulls = prevCheckNulls;\n+        }\n+    }\n+\n+    public boolean needsUseSiteNullCheck(JCTree tree, ClassSymbol currentClass) {\n+        Symbol sym = TreeInfo.symbolFor(tree);\n+        return sym != null &&\n+                useSiteNullChecks.generateChecksForFields &&\n+                sym.owner.kind == TYP &&\n+                sym.kind == VAR &&\n+                types.isNonNullable(sym.type) &&\n+                sym.owner != currentClass;\n+    }\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/NullChecksWriter.java","additions":30,"deletions":7,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -313,0 +313,27 @@\n+                \"\"\",\n+                \/\/should not crash javac:\n+                \"\"\"\n+                class Test {\n+                    static String get() {\n+                        return Other.str = \"\";\n+                    }\n+                    public static void main(String... args) {\n+                        get();\n+                    }\n+                }\n+                class Other {\n+                    public static String! str = \"\";\n+                }\n+                \"\"\",\n+                \"\"\"\n+                class Test {\n+                    static String get() {\n+                        return Other.str += \"add\";\n+                    }\n+                    public static void main(String... args) {\n+                        get();\n+                    }\n+                }\n+                class Other {\n+                    public static String! str = \"\";\n+                }\n@@ -707,0 +734,62 @@\n+        testUseSiteForFieldsSeparateCompilationHelper(base,\n+                \"\"\"\n+                package pkg;\n+                public class A {\n+                    String! value;\n+                    public A() {\n+                        this.value = \"test\";\n+                        super();\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                public class A {\n+                    String value;\n+                    public A() {\n+                        this.value = null;\n+                        super();\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                class Test {\n+                    public static void main(String... args) {\n+                        A a = new A();\n+                        a.value = a.value + \"\";\n+                        System.out.println(a.value);\n+                    }\n+                }\n+                \"\"\");\n+        testUseSiteForFieldsSeparateCompilationHelper(base,\n+                \"\"\"\n+                package pkg;\n+                public class A {\n+                    String! value;\n+                    public A() {\n+                        this.value = \"test\";\n+                        super();\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                public class A {\n+                    String value;\n+                    public A() {\n+                        this.value = null;\n+                        super();\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                class Test {\n+                    public static void main(String... args) {\n+                        A a = new A();\n+                        a.value += \"\";\n+                        System.out.println(a.value);\n+                    }\n+                }\n+                \"\"\");\n","filename":"test\/langtools\/tools\/javac\/nullability\/RuntimeNullChecks.java","additions":89,"deletions":0,"binary":false,"changes":89,"status":"modified"}]}