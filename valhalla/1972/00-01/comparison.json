{"files":[{"patch":"@@ -80,0 +80,1 @@\n+    private boolean checkNulls;\n@@ -175,2 +176,0 @@\n-    boolean generateNullChecks = false;\n-\n@@ -180,13 +179,6 @@\n-        boolean prevGenerateNullChecks = generateNullChecks;\n-        try {\n-            generateNullChecks = false;\n-            tree.lhs = translate(tree.lhs);\n-            generateNullChecks = true;\n-            tree.rhs = translate(tree.rhs);\n-            Symbol lhsSym = TreeInfo.symbolFor(tree.lhs);\n-            if (lhsSym != null &&\n-                    types.isNonNullable(lhsSym.type)) {\n-                tree.rhs = attr.makeNullCheck(tree.rhs, true);\n-            }\n-        } finally {\n-            generateNullChecks = prevGenerateNullChecks;\n+        tree.lhs = translate(tree.lhs, false);\n+        tree.rhs = translate(tree.rhs);\n+        Symbol lhsSym = TreeInfo.symbolFor(tree.lhs);\n+        if (lhsSym != null &&\n+                types.isNonNullable(lhsSym.type)) {\n+            tree.rhs = attr.makeNullCheck(tree.rhs, true);\n@@ -212,2 +204,1 @@\n-            if (generateNullChecks &&\n-                    useSiteNullChecks.generateChecksForFields &&\n+            if (useSiteNullChecks.generateChecksForFields &&\n@@ -217,1 +208,2 @@\n-                    sym.owner != currentClass) {\n+                    sym.owner != currentClass &&\n+                    checkNulls) {\n@@ -226,9 +218,3 @@\n-        boolean prevGenerateNullChecks = generateNullChecks;\n-        try {\n-            generateNullChecks = false;\n-            super.visitTypeCast(tree);\n-            if (tree.strict) {\n-                tree.expr = attr.makeNullCheck(tree.expr, true);\n-            }\n-        } finally {\n-            generateNullChecks = prevGenerateNullChecks;\n+        super.visitTypeCast(tree);\n+        if (tree.strict) {\n+            tree.expr = attr.makeNullCheck(tree.expr, true);\n@@ -244,1 +230,0 @@\n-        boolean prevGenerateNullChecks = generateNullChecks;\n@@ -246,1 +231,0 @@\n-            generateNullChecks = true;\n@@ -262,1 +246,0 @@\n-            generateNullChecks = prevGenerateNullChecks;\n@@ -268,7 +251,4 @@\n-        boolean prevGenerateNullChecks = generateNullChecks;\n-        try {\n-            super.visitReturn(tree);\n-            if (tree.expr != null && returnType != null && !returnType.hasTag(VOID)) {\n-                if (types.isNonNullable(returnType)) {\n-                    tree.expr = attr.makeNullCheck(tree.expr, true);\n-                }\n+        super.visitReturn(tree);\n+        if (tree.expr != null && returnType != null && !returnType.hasTag(VOID)) {\n+            if (types.isNonNullable(returnType)) {\n+                tree.expr = attr.makeNullCheck(tree.expr, true);\n@@ -276,2 +256,0 @@\n-        } finally {\n-            generateNullChecks = prevGenerateNullChecks;\n@@ -284,13 +262,9 @@\n-        boolean prevGenerateNullChecks = generateNullChecks;\n-        try {\n-            generateNullChecks = true;\n-            Symbol.MethodSymbol msym = (Symbol.MethodSymbol) TreeInfo.symbolFor(tree.meth);\n-            if (useSiteNullChecks.generateChecksForMethods) {\n-                tree.args = newArgs(msym, tree.args);\n-            }\n-            super.visitApply(tree);\n-            result = tree;\n-            if (useSiteNullChecks.generateChecksForMethods) {\n-                if (types.isNonNullable(msym.type.asMethodType().restype)) {\n-                    result = attr.makeNullCheck(tree, true);\n-                }\n+        Symbol.MethodSymbol msym = (Symbol.MethodSymbol) TreeInfo.symbolFor(tree.meth);\n+        if (useSiteNullChecks.generateChecksForMethods) {\n+            tree.args = newArgs(msym, tree.args);\n+        }\n+        super.visitApply(tree);\n+        result = tree;\n+        if (useSiteNullChecks.generateChecksForMethods) {\n+            if (types.isNonNullable(msym.type.asMethodType().restype)) {\n+                result = attr.makeNullCheck(tree, true);\n@@ -298,2 +272,0 @@\n-        } finally {\n-            generateNullChecks = prevGenerateNullChecks;\n@@ -305,10 +277,2 @@\n-        boolean prevGenerateNullChecks = generateNullChecks;\n-        try {\n-            generateNullChecks = true;\n-            if (useSiteNullChecks.generateChecksForMethods) {\n-                tree.args = newArgs((Symbol.MethodSymbol) tree.constructor, tree.args);\n-            }\n-            super.visitNewClass(tree);\n-            result = tree;\n-        } finally {\n-            generateNullChecks = prevGenerateNullChecks;\n+        if (useSiteNullChecks.generateChecksForMethods) {\n+            tree.args = newArgs((Symbol.MethodSymbol) tree.constructor, tree.args);\n@@ -316,1 +280,2 @@\n-\n+        super.visitNewClass(tree);\n+        result = tree;\n@@ -356,0 +321,16 @@\n+\n+    @Override\n+    public <T extends JCTree> T translate(T tree) {\n+        return translate(tree, true);\n+    }\n+\n+    public <T extends JCTree> T translate(T tree, boolean checkNulls) {\n+        boolean prevCheckNulls = this.checkNulls;\n+        try {\n+            this.checkNulls = checkNulls;\n+            return super.translate(tree);\n+        } finally {\n+            this.checkNulls = prevCheckNulls;\n+        }\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/NullChecksWriter.java","additions":46,"deletions":65,"binary":false,"changes":111,"status":"modified"}]}