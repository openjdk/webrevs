{"files":[{"patch":"@@ -431,0 +431,3 @@\n+  case vmIntrinsics::_arrayInstanceBaseOffset:\n+  case vmIntrinsics::_arrayInstanceIndexScale:\n+  case vmIntrinsics::_arrayLayout:\n","filename":"src\/hotspot\/share\/classfile\/vmIntrinsics.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -709,0 +709,7 @@\n+  do_intrinsic(_arrayInstanceBaseOffset,  jdk_internal_misc_Unsafe,     arrayInstanceBaseOffset_name, arrayProperties_signature, F_RN) \\\n+   do_name(     arrayInstanceBaseOffset_name,                           \"arrayInstanceBaseOffset0\")                              \\\n+   do_signature(arrayProperties_signature,                              \"([Ljava\/lang\/Object;)I\")                                \\\n+  do_intrinsic(_arrayInstanceIndexScale,  jdk_internal_misc_Unsafe,     _arrayInstanceIndexScale_name, arrayProperties_signature, F_RN) \\\n+   do_name(    _arrayInstanceIndexScale_name,                           \"arrayInstanceIndexScale0\")                              \\\n+  do_intrinsic(_arrayLayout,  jdk_internal_misc_Unsafe,                 _arrayLayout_name, arrayProperties_signature, F_RN)      \\\n+   do_name(    _arrayLayout_name,                                       \"arrayLayout0\")                                          \\\n","filename":"src\/hotspot\/share\/classfile\/vmIntrinsics.hpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -753,0 +753,3 @@\n+  case vmIntrinsics::_arrayInstanceBaseOffset:\n+  case vmIntrinsics::_arrayInstanceIndexScale:\n+  case vmIntrinsics::_arrayLayout:\n","filename":"src\/hotspot\/share\/opto\/c2compiler.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -488,0 +488,4 @@\n+  case vmIntrinsics::_arrayInstanceBaseOffset:  return inline_arrayInstanceBaseOffset();\n+  case vmIntrinsics::_arrayInstanceIndexScale:  return inline_arrayInstanceIndexScale();\n+  case vmIntrinsics::_arrayLayout:              return inline_arrayLayout();\n+\n@@ -3296,0 +3300,72 @@\n+\/\/ private native int arrayInstanceBaseOffset0(Object[] array);\n+bool LibraryCallKit::inline_arrayInstanceBaseOffset() {\n+  Node* array = argument(1);\n+  Node* klass_node = load_object_klass(array);\n+\n+  jint  layout_con = Klass::_lh_neutral_value;\n+  Node* layout_val = get_layout_helper(klass_node, layout_con);\n+  int   layout_is_con = (layout_val == nullptr);\n+\n+  Node* header_size = nullptr;\n+  if (layout_is_con) {\n+    int hsize = Klass::layout_helper_header_size(layout_con);\n+    header_size = intcon(hsize);\n+  } else {\n+    Node* hss = intcon(Klass::_lh_header_size_shift);\n+    Node* hsm = intcon(Klass::_lh_header_size_mask);\n+    header_size = _gvn.transform(new URShiftINode(layout_val, hss));\n+    header_size = _gvn.transform(new AndINode(header_size, hsm));\n+  }\n+  set_result(header_size);\n+  return true;\n+}\n+\n+\/\/ private native int arrayInstanceIndexScale0(Object[] array);\n+bool LibraryCallKit::inline_arrayInstanceIndexScale() {\n+  Node* array = argument(1);\n+  Node* klass_node = load_object_klass(array);\n+\n+  jint  layout_con = Klass::_lh_neutral_value;\n+  Node* layout_val = get_layout_helper(klass_node, layout_con);\n+  int   layout_is_con = (layout_val == nullptr);\n+\n+  Node* element_size = nullptr;\n+  if (layout_is_con) {\n+    int log_element_size  = Klass::layout_helper_log2_element_size(layout_con);\n+    int elem_size = 1 << log_element_size;\n+    element_size = intcon(elem_size);\n+  } else {\n+    Node* ess = intcon(Klass::_lh_log2_element_size_shift);\n+    Node* esm = intcon(Klass::_lh_log2_element_size_mask);\n+    Node* log_element_size = _gvn.transform(new URShiftINode(layout_val, ess));\n+    log_element_size = _gvn.transform(new AndINode(log_element_size, esm));\n+    element_size = _gvn.transform(new LShiftINode(intcon(1), log_element_size));\n+  }\n+  set_result(element_size);\n+  return true;\n+}\n+\n+\/\/ private native int arrayLayout0(Object[] array);\n+bool LibraryCallKit::inline_arrayLayout() {\n+  RegionNode* region = new RegionNode(2);\n+  Node* phi = new PhiNode(region, TypeInt::POS);\n+\n+  Node* array = argument(1);\n+  Node* klass_node = load_object_klass(array);\n+  generate_refArray_guard(klass_node, region);\n+  if (region->req() == 3) {\n+    phi->add_req(intcon((jint)LayoutKind::REFERENCE));\n+  }\n+\n+  int layout_kind_offset = in_bytes(FlatArrayKlass::layout_kind_offset());\n+  Node* layout_kind_addr = basic_plus_adr(klass_node, klass_node, layout_kind_offset);\n+  Node* layout_kind = make_load(nullptr, layout_kind_addr, TypeInt::POS, T_INT, MemNode::unordered);\n+\n+  region->init_req(1, control());\n+  phi->init_req(1, layout_kind);\n+\n+  set_control(_gvn.transform(region));\n+  set_result(_gvn.transform(phi));\n+  return true;\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/library_call.cpp","additions":76,"deletions":0,"binary":false,"changes":76,"status":"modified"},{"patch":"@@ -350,0 +350,3 @@\n+  bool inline_arrayInstanceBaseOffset();\n+  bool inline_arrayInstanceIndexScale();\n+  bool inline_arrayLayout();\n","filename":"src\/hotspot\/share\/opto\/library_call.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -248,0 +248,1 @@\n+    @IntrinsicCandidate\n@@ -4454,0 +4455,1 @@\n+    @IntrinsicCandidate\n@@ -4456,0 +4458,1 @@\n+    @IntrinsicCandidate\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/misc\/Unsafe.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -46,0 +46,1 @@\n+import static compiler.valhalla.inlinetypes.InlineTypeIRNode.LOAD_OF_ANY_KLASS;\n@@ -170,0 +171,1 @@\n+                             \"-XX:CompileCommand=inline,jdk.internal.misc.Unsafe::*\",\n@@ -2031,0 +2033,96 @@\n+\n+    private static final long BASE_OFF1 = U.arrayInstanceBaseOffset(TEST_ARRAY1);\n+    private static final long BASE_OFF2 = U.arrayInstanceBaseOffset(TEST_ARRAY2);\n+    private static final long BASE_OFF3 = U.arrayInstanceBaseOffset(TEST_ARRAY3);\n+    private static final long BASE_OFF4 = U.arrayInstanceBaseOffset(TEST_ARRAY4);\n+    private static final long BASE_OFF5 = U.arrayInstanceBaseOffset(new Object[1]);\n+\n+    private static final int IDX_SCALE1 = U.arrayInstanceIndexScale(TEST_ARRAY1);\n+    private static final int IDX_SCALE2 = U.arrayInstanceIndexScale(TEST_ARRAY2);\n+    private static final int IDX_SCALE3 = U.arrayInstanceIndexScale(TEST_ARRAY3);\n+    private static final int IDX_SCALE4 = U.arrayInstanceIndexScale(TEST_ARRAY4);\n+    private static final int IDX_SCALE5 = U.arrayInstanceIndexScale(new Object[1]);\n+\n+    private static final int LAYOUT1 = U.arrayLayout(TEST_ARRAY1);\n+    private static final int LAYOUT2 = U.arrayLayout(TEST_ARRAY2);\n+    private static final int LAYOUT3 = U.arrayLayout(TEST_ARRAY3);\n+    private static final int LAYOUT4 = U.arrayLayout(TEST_ARRAY4);\n+    private static final int LAYOUT5 = U.arrayLayout(new Object[1]);\n+\n+    @Test\n+    @IR(failOn = {CALL_UNSAFE})\n+    public long test89(Object[] array) {\n+        return U.arrayInstanceBaseOffset(array);\n+    }\n+\n+    @Run(test = \"test89\")\n+    public void test89_verifier() {\n+        Asserts.assertEquals(test89(TEST_ARRAY1), BASE_OFF1);\n+        Asserts.assertEquals(test89(TEST_ARRAY2), BASE_OFF2);\n+        Asserts.assertEquals(test89(TEST_ARRAY3), BASE_OFF3);\n+        Asserts.assertEquals(test89(TEST_ARRAY4), BASE_OFF4);\n+        Asserts.assertEquals(test89(new Object[1]), BASE_OFF5);\n+    }\n+\n+    @Test\n+    @IR(failOn = {CALL_UNSAFE, LOAD_KLASS, LOAD_OF_ANY_KLASS})\n+    public long test90() {\n+        return U.arrayInstanceBaseOffset(TEST_ARRAY1);\n+    }\n+\n+    @Run(test = \"test90\")\n+    public void test90_verifier() {\n+        Asserts.assertEquals(test90(), BASE_OFF1);\n+    }\n+\n+    @Test\n+    @IR(failOn = {CALL_UNSAFE})\n+    public int test91(Object[] array) {\n+        return U.arrayInstanceIndexScale(array);\n+    }\n+\n+    @Run(test = \"test91\")\n+    public void test91_verifier() {\n+        Asserts.assertEquals(test91(TEST_ARRAY1), IDX_SCALE1);\n+        Asserts.assertEquals(test91(TEST_ARRAY2), IDX_SCALE2);\n+        Asserts.assertEquals(test91(TEST_ARRAY3), IDX_SCALE3);\n+        Asserts.assertEquals(test91(TEST_ARRAY4), IDX_SCALE4);\n+        Asserts.assertEquals(test91(new Object[1]), IDX_SCALE5);\n+    }\n+\n+    @Test\n+    @IR(failOn = {CALL_UNSAFE, LOAD_KLASS, LOAD_OF_ANY_KLASS})\n+    public int test92() {\n+        return U.arrayInstanceIndexScale(TEST_ARRAY1);\n+    }\n+\n+    @Run(test = \"test92\")\n+    public void test92_verifier() {\n+        Asserts.assertEquals(test92(), IDX_SCALE1);\n+    }\n+\n+    @Test\n+    @IR(failOn = {CALL_UNSAFE})\n+    public int test93(Object[] array) {\n+        return U.arrayLayout(array);\n+    }\n+\n+    @Run(test = \"test93\")\n+    public void test93_verifier() {\n+        Asserts.assertEquals(test93(TEST_ARRAY1), LAYOUT1);\n+        Asserts.assertEquals(test93(TEST_ARRAY2), LAYOUT2);\n+        Asserts.assertEquals(test93(TEST_ARRAY3), LAYOUT3);\n+        Asserts.assertEquals(test93(TEST_ARRAY4), LAYOUT4);\n+        Asserts.assertEquals(test93(new Object[1]), LAYOUT5);\n+    }\n+\n+    @Test\n+    @IR(failOn = {CALL_UNSAFE, LOAD_KLASS, LOAD_OF_ANY_KLASS})\n+    public int test94() {\n+        return U.arrayLayout(TEST_ARRAY1);\n+    }\n+\n+    @Run(test = \"test94\")\n+    public void test94_verifier() {\n+        Asserts.assertEquals(test94(), LAYOUT1);\n+    }\n","filename":"test\/hotspot\/jtreg\/compiler\/valhalla\/inlinetypes\/TestIntrinsics.java","additions":98,"deletions":0,"binary":false,"changes":98,"status":"modified"}]}