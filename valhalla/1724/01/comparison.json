{"files":[{"patch":"@@ -561,58 +561,0 @@\n-\n-    \/**\n-     * Helper method that splits a Resource path onto 3 items: module, parent\n-     * and resource name.\n-     *\n-     * @param path\n-     * @return An array containing module, parent and name.\n-     *\/\n-    public static String[] splitPath(String path) {\n-        Objects.requireNonNull(path);\n-        String noRoot = path.substring(1);\n-        int pkgStart = noRoot.indexOf(\"\/\");\n-        String module = noRoot.substring(0, pkgStart);\n-        List<String> result = new ArrayList<>();\n-        result.add(module);\n-        String pkg = noRoot.substring(pkgStart + 1);\n-        String resName;\n-        int pkgEnd = pkg.lastIndexOf(\"\/\");\n-        if (pkgEnd == -1) { \/\/ No package.\n-            resName = pkg;\n-        } else {\n-            resName = pkg.substring(pkgEnd + 1);\n-        }\n-\n-        pkg = toPackage(pkg, false);\n-        result.add(pkg);\n-        result.add(resName);\n-\n-        String[] array = new String[result.size()];\n-        return result.toArray(array);\n-    }\n-\n-    \/**\n-     * Returns the path of the resource.\n-     *\/\n-    public static String resourceName(String path) {\n-        Objects.requireNonNull(path);\n-        String s = path.substring(1);\n-        int index = s.indexOf(\"\/\");\n-        return s.substring(index + 1);\n-    }\n-\n-    public static String toPackage(String name) {\n-        return toPackage(name, false);\n-    }\n-\n-    private static String toPackage(String name, boolean log) {\n-        int index = name.lastIndexOf('\/');\n-        if (index > 0) {\n-            return name.substring(0, index).replace('\/', '.');\n-        } else {\n-            \/\/ ## unnamed package\n-            if (log) {\n-                System.err.format(\"Warning: %s in unnamed package%n\", name);\n-            }\n-            return \"\";\n-        }\n-    }\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/ImageFileCreator.java","additions":0,"deletions":58,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -69,13 +69,0 @@\n-    \/**\n-     * Returns true if a resource is located in a named package.\n-     *\/\n-    public static boolean isNamedPackageResource(String name) {\n-        int index = name.lastIndexOf(\"\/\");\n-        if (index == -1) {\n-            return false;\n-        } else {\n-            String pn = name.substring(0, index).replace('\/', '.');\n-            return Checks.isPackageName(pn);\n-        }\n-    }\n-\n@@ -83,0 +70,1 @@\n+        private static final String PREVIEW_PREFIX = \"META-INF\/preview\/\";\n@@ -135,10 +123,2 @@\n-                .filter(m -> m.type() == ResourcePoolEntry.Type.CLASS_OR_RESOURCE)\n-                .forEach(res -> {\n-                    String name = ImageFileCreator.resourceName(res.path());\n-                    if (isNamedPackageResource(name)) {\n-                        String pkg = ImageFileCreator.toPackage(name);\n-                        if (!pkg.isEmpty()) {\n-                            pkgs.add(pkg);\n-                        }\n-                    }\n-                });\n+                    .filter(m -> m.type() == ResourcePoolEntry.Type.CLASS_OR_RESOURCE)\n+                    .forEach(res -> inferPackageName(res).ifPresent(pkgs::add));\n@@ -162,0 +142,33 @@\n+\n+        \/**\n+         * Returns a valid non-empty package name, inferred from a resource pool\n+         * entry's path.\n+         *\n+         * <p>If the resource pool entry is for a preview resource (i.e. with\n+         * path {@code \"\/mod-name\/META-INF\/preview\/pkg-path\/resource-name\"})\n+         * the package name is the non-preview name based on {@code \"pkg-path\"}.\n+         *\n+         * @return the inferred package name, or {@link Optional#empty() empty}\n+         *     if no name could be inferred.\n+         *\/\n+        private static Optional<String> inferPackageName(ResourcePoolEntry res) {\n+            \/\/ Expect entry paths to be \"\/mod-name\/pkg-path\/resource-name\", but\n+            \/\/ may also get \"\/mod-name\/META-INF\/preview\/pkg-path\/resource-name\"\n+            String name = res.path();\n+            if (name.charAt(0) == '\/') {\n+                int pkgStart = name.indexOf('\/', 1) + 1;\n+                int pkgEnd = name.lastIndexOf('\/');\n+                if (pkgStart > 0 && pkgEnd > pkgStart) {\n+                    String pkgPath = name.substring(pkgStart, pkgEnd);\n+                    \/\/ Handle preview paths by removing the prefix.\n+                    if (pkgPath.startsWith(PREVIEW_PREFIX)) {\n+                        pkgPath = pkgPath.substring(PREVIEW_PREFIX.length());\n+                    }\n+                    String pkgName = pkgPath.replace('\/', '.');\n+                    if (Checks.isPackageName(pkgName)) {\n+                        return Optional.of(pkgName);\n+                    }\n+                }\n+            }\n+            return Optional.empty();\n+        }\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/ResourcePoolManager.java","additions":36,"deletions":23,"binary":false,"changes":59,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -24,10 +24,0 @@\n-\/*\n- * @test\n- * @summary Test a pool containing jimage resources and classes.\n- * @author Jean-Francois Denise\n- * @modules jdk.jlink\/jdk.tools.jlink.internal\n- *          jdk.jlink\/jdk.tools.jlink.plugin\n- * @run build ResourcePoolTest\n- * @run main ResourcePoolTest\n- *\/\n-\n@@ -37,1 +27,0 @@\n-import java.util.HashSet;\n@@ -39,0 +28,1 @@\n+import java.util.Map;\n@@ -46,0 +36,1 @@\n+import org.junit.jupiter.api.Test;\n@@ -47,11 +38,5 @@\n-public class ResourcePoolTest {\n-\n-    public static void main(String[] args) throws Exception {\n-        new ResourcePoolTest().test();\n-    }\n-\n-    public void test() throws Exception {\n-        checkResourceAdding();\n-        checkResourceVisitor();\n-        checkResourcesAfterCompression();\n-    }\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertNotEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n@@ -59,0 +44,9 @@\n+\/*\n+ * @test\n+ * @summary Test a pool containing jimage resources and classes.\n+ * @author Jean-Francois Denise\n+ * @modules jdk.jlink\/jdk.tools.jlink.internal\n+ *          jdk.jlink\/jdk.tools.jlink.plugin\n+ * @run junit ResourcePoolTest\n+ *\/\n+public class ResourcePoolTest {\n@@ -61,1 +55,2 @@\n-    private void checkResourceVisitor() throws Exception {\n+    @Test\n+    public void resourceVisitor() throws Exception {\n@@ -72,11 +67,3 @@\n-        if (visitor.getAmountBefore() == 0) {\n-            throw new AssertionError(\"Resources not found\");\n-        }\n-        if (visitor.getAmountBefore() != input.entryCount()) {\n-            throw new AssertionError(\"Number of visited resources. Expected: \" +\n-                    visitor.getAmountBefore() + \", got: \" + input.entryCount());\n-        }\n-        if (visitor.getAmountAfter() != output.entryCount()) {\n-            throw new AssertionError(\"Number of added resources. Expected: \" +\n-                    visitor.getAmountAfter() + \", got: \" + output.entryCount());\n-        }\n+        assertNotEquals(0, visitor.getAmountBefore(), \"Resources not found\");\n+        assertEquals(visitor.getAmountBefore(), input.entryCount(), \"Number of visited resources\");\n+        assertEquals(visitor.getAmountAfter(), output.entryCount(), \"Number of added resources\");\n@@ -85,3 +72,1 @@\n-            if (!input.findEntry(path).isPresent()) {\n-                throw new AssertionError(\"Unknown resource: \" + path);\n-            }\n+            assertTrue(input.findEntry(path).isPresent(), \"Unknown resource: \" + path);\n@@ -120,8 +105,5 @@\n-    private void checkResourceAdding() {\n-        List<String> samples = new ArrayList<>();\n-        samples.add(\"java.base\");\n-        samples.add(\"java\/lang\/Object\");\n-        samples.add(\"java.base\");\n-        samples.add(\"java\/lang\/String\");\n-        samples.add(\"java.management\");\n-        samples.add(\"javax\/management\/ObjectName\");\n+    @Test\n+    public void resourceAdding() {\n+        Map<String, List<String>> samples = Map.of(\n+                \"java.base\", List.of(\"java\/lang\/Object\", \"java\/lang\/String\"),\n+                \"java.management\", List.of(\"javax\/management\/ObjectName\"));\n@@ -147,22 +129,9 @@\n-    private void test(List<String> samples, ResourceAdder adder) {\n-        if (samples.isEmpty()) {\n-            throw new AssertionError(\"No sample to test\");\n-        }\n-        ResourcePoolManager resources = new ResourcePoolManager();\n-        Set<String> modules = new HashSet<>();\n-        for (int i = 0; i < samples.size(); i++) {\n-            String module = samples.get(i);\n-            modules.add(module);\n-            i++;\n-            String clazz = samples.get(i);\n-            String path = \"\/\" + module + \"\/\" + clazz + \".class\";\n-            adder.add(resources, module, path);\n-        }\n-        for (int i = 0; i < samples.size(); i++) {\n-            String module = samples.get(i);\n-            i++;\n-            String clazz = samples.get(i);\n-            String path = \"\/\" + module + \"\/\" + clazz + \".class\";\n-            Optional<ResourcePoolEntry> res = resources.findEntry(path);\n-            if (!res.isPresent()) {\n-                throw new AssertionError(\"Resource not found \" + path);\n+    @Test\n+    public void packageInference() {\n+        Map<String, List<String>> samples = Map.of(\n+                \"java.base\", List.of(\"NoPackage\", \"java\/lang\/String\", \"java\/util\/List\"));\n+        ResourcePoolManager manager = test(samples, (resources, module, path) -> {\n+            try {\n+                resources.add(ResourcePoolEntry.create(path, new byte[0]));\n+            } catch (Exception ex) {\n+                throw new RuntimeException(ex);\n@@ -170,3 +139,22 @@\n-            checkModule(resources.resourcePool(), res.get());\n-            if (resources.findEntry(clazz).isPresent()) {\n-                throw new AssertionError(\"Resource found \" + clazz);\n+        });\n+\n+        Optional<ResourcePoolModule> modBase = manager.moduleView().findModule(\"java.base\");\n+        assertTrue(modBase.isPresent());\n+        \/\/ Empty packages are not included (and should normally not exist).\n+        assertEquals(Set.of(\"java.lang\", \"java.util\"), modBase.get().packages());\n+    }\n+\n+    @Test\n+    public void packageInference_previewOnly() {\n+        Map<String, List<String>> samples = Map.of(\n+                \"java.base\", List.of(\n+                        \"java\/lang\/Object\",\n+                        \"java\/lang\/String\",\n+                        \"java\/util\/List\",\n+                        \"META-INF\/preview\/java\/lang\/String\",\n+                        \"META-INF\/preview\/java\/extra\/PreviewOnly\"));\n+        ResourcePoolManager manager = test(samples, (resources, module, path) -> {\n+            try {\n+                resources.add(ResourcePoolEntry.create(path, new byte[0]));\n+            } catch (Exception ex) {\n+                throw new RuntimeException(ex);\n@@ -174,4 +162,32 @@\n-        }\n-        if (resources.entryCount() != samples.size() \/ 2) {\n-            throw new AssertionError(\"Invalid number of resources\");\n-        }\n+        });\n+\n+        Optional<ResourcePoolModule> modBase = manager.moduleView().findModule(\"java.base\");\n+        assertTrue(modBase.isPresent());\n+        \/\/ Preview only package is included, and no packages start with 'META-INF'.\n+        assertEquals(Set.of(\"java.lang\", \"java.util\", \"java.extra\"), modBase.get().packages());\n+        \/\/ But the preview resources exist in the META-INF\/preview namespace.\n+        assertTrue(modBase.get().findEntry(\"\/java.base\/META-INF\/preview\/java\/extra\/PreviewOnly.class\").isPresent());\n+    }\n+\n+    private ResourcePoolManager test(Map<String, List<String>> samples, ResourceAdder adder) {\n+        assertFalse(samples.isEmpty(), \"No sample to test\");\n+        ResourcePoolManager resources = new ResourcePoolManager();\n+        samples.forEach((module, clazzes) -> {\n+            clazzes.forEach(clazz -> {\n+                String path = \"\/\" + module + \"\/\" + clazz + \".class\";\n+                adder.add(resources, module, path);\n+            });\n+        });\n+        samples.forEach((module, clazzes) -> {\n+            clazzes.forEach(clazz -> {\n+                String path = \"\/\" + module + \"\/\" + clazz + \".class\";\n+                Optional<ResourcePoolEntry> res = resources.findEntry(path);\n+                assertTrue(res.isPresent(), \"Resource not found \" + path);\n+                checkModule(resources.resourcePool(), res.get());\n+                assertTrue(resources.findEntry(clazz).isEmpty(), \"Resource found \" + clazz);\n+            });\n+        });\n+        long resourcesCount = samples.values().stream().mapToInt(List::size).sum();\n+        assertEquals(resourcesCount, resources.entryCount(), \"Invalid number of resources\");\n+        assertEquals(samples.size(), resources.moduleCount(), \"Invalid number of modules\");\n+        return resources;\n@@ -182,3 +198,1 @@\n-        if (!optMod.isPresent()) {\n-            throw new AssertionError(\"No module \" + res.moduleName());\n-        }\n+        assertTrue(optMod.isPresent(), \"No module \" + res.moduleName());\n@@ -186,7 +200,3 @@\n-        if (!m.name().equals(res.moduleName())) {\n-            throw new AssertionError(\"Not right module name \" + res.moduleName());\n-        }\n-        if (!m.findEntry(res.path()).isPresent()) {\n-            throw new AssertionError(\"resource \" + res.path()\n-                    + \" not in module \" + m.name());\n-        }\n+        assertEquals(res.moduleName(), m.name(), \"Not right module name \" + res.moduleName());\n+        assertTrue(m.findEntry(res.path()).isPresent(),\n+                \"resource \" + res.path() + \" not in module \" + m.name());\n@@ -195,1 +205,2 @@\n-    private void checkResourcesAfterCompression() throws Exception {\n+    @Test\n+    public void resourcesAfterCompression() throws Exception {\n@@ -218,22 +229,5 @@\n-            if (!resources.contains(res)) {\n-                throw new AssertionError(\"Resource not found: \" + res);\n-            }\n-\n-            if (!resources.findEntry(res.path()).isPresent()) {\n-                throw new AssertionError(\"Resource not found: \" + res);\n-            }\n-\n-            if (!modules.contains(res.moduleName())) {\n-                throw new AssertionError(\"Module not found: \" + res.moduleName());\n-            }\n-\n-            if (!resources.contains(res)) {\n-                throw new AssertionError(\"Resources not found: \" + res);\n-            }\n-\n-            try {\n-                resources.add(res);\n-                throw new AssertionError(res + \" already present, but an exception is not thrown\");\n-            } catch (Exception ex) {\n-                \/\/ Expected\n-            }\n+            assertTrue(resources.contains(res), \"Resource not found: \" + res);\n+            assertTrue(resources.findEntry(res.path()).isPresent(), \"Resource not found: \" + res);\n+            assertTrue(modules.contains(res.moduleName()), \"Module not found: \" + res.moduleName());\n+            assertThrows(RuntimeException.class, () -> resources.add(res),\n+                    res + \" already present, but an exception is not thrown\");\n@@ -242,6 +236,3 @@\n-        try {\n-            resources.add(ResourcePoolEntry.create(\"\/module2\/toto1\", new byte[0]));\n-            throw new AssertionError(\"ResourcePool is read-only, but an exception is not thrown\");\n-        } catch (Exception ex) {\n-            \/\/ Expected\n-        }\n+        ResourcePoolEntry toAdd = ResourcePoolEntry.create(\"\/module2\/toto1\", new byte[0]);\n+        assertThrows(RuntimeException.class, () -> resources.add(toAdd),\n+                \"ResourcePool is read-only, but an exception is not thrown\");\n","filename":"test\/jdk\/tools\/jlink\/ResourcePoolTest.java","additions":105,"deletions":114,"binary":false,"changes":219,"status":"modified"}]}