{"files":[{"patch":"@@ -4946,3 +4946,8 @@\n-            if (currentPattern instanceof JCBindingPattern ||\n-                currentPattern instanceof JCAnyPattern) {\n-                return existingPattern instanceof JCBindingPattern ||\n+            if (currentPattern instanceof JCBindingPattern currentBinding) {\n+                return (existingPattern instanceof JCBindingPattern existingBinding &&\n+                        (types.isNullUnspecified(existingBinding.type) ||\n+                         types.isNonNullable(currentBinding.type))) ||\n+                       existingPattern instanceof JCAnyPattern;\n+            } else if (currentPattern instanceof JCAnyPattern) {\n+                return (existingPattern instanceof JCBindingPattern existingBinding &&\n+                        types.isNullUnspecified(existingBinding.type)) ||\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Check.java","additions":8,"deletions":3,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -361,1 +361,2 @@\n-                allowNull = types.isSubtype(componentType,\n+                allowNull = !types.isNonNullable(nestedBinding.type) &&\n+                        types.isSubtype(componentType,\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/TransPatterns.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -3672,1 +3672,2 @@\n-                            peekToken(lookahead, EMOTIONAL_QUALIFIER, LAX_IDENTIFIER, COLON))) ) {\n+                            peekToken(lookahead, EMOTIONAL_QUALIFIER, LAX_IDENTIFIER, COLON) ||\n+                            peekToken(lookahead, EMOTIONAL_QUALIFIER, LAX_IDENTIFIER, RPAREN))) ) {\n@@ -3697,3 +3698,1 @@\n-                case BANG:\n-                    if (allowNullRestrictedTypes && !peekToken(lookahead, LPAREN)) break;\n-                case DOT, QUES, EXTENDS, SUPER, COMMA: break;\n+                case BANG, DOT, QUES, EXTENDS, SUPER, COMMA: break;\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/parser\/JavacParser.java","additions":3,"deletions":4,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -445,0 +445,42 @@\n+                                \"\"),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Test {\n+                                    void test(Box b) {\n+                                        switch (b) {\n+                                            case Box(String! nonNull) -> {}\n+                                            case Box(String isNull) -> {}\n+                                        }\n+                                    }\n+                                    record Box(String str) {}\n+                                }\n+                                \"\"\",\n+                                Result.Clean,\n+                                \"\"),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Test {\n+                                    void test(Box b) {\n+                                        switch (b) {\n+                                            case Box(String! nonNull) -> {}\n+                                            case Box(var v) -> {}\n+                                        }\n+                                    }\n+                                    record Box(String str) {}\n+                                }\n+                                \"\"\",\n+                                Result.Clean,\n+                                \"\"),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Test {\n+                                    void test(Box b) {\n+                                        switch (b) {\n+                                            case Box(String! nonNull) -> {}\n+                                            case Box(_) -> {}\n+                                        }\n+                                    }\n+                                    record Box(String str) {}\n+                                }\n+                                \"\"\",\n+                                Result.Clean,\n@@ -561,0 +603,71 @@\n+\n+    @Test\n+    void testPatternDominance() {\n+        testList(\n+                List.of(\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Test {\n+                                    void test(Box b) {\n+                                        switch (b) {\n+                                            case Box(String nullAllowed) -> {}\n+                                            case Box(String! notNull) -> {}\n+                                        }\n+                                    }\n+                                    record Box(String str) {}\n+                                }\n+                                \"\"\",\n+                                Result.Error,\n+                                \"compiler.err.pattern.dominated\"),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Test {\n+                                    void test(Box b) {\n+                                        switch (b) {\n+                                            case Box(var v) -> {}\n+                                            case Box(String! notNull) -> {}\n+                                        }\n+                                    }\n+                                    record Box(String str) {}\n+                                }\n+                                \"\"\",\n+                                Result.Error,\n+                                \"compiler.err.pattern.dominated\"),\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Test {\n+                                    void test(Box b) {\n+                                        switch (b) {\n+                                            case Box(_) -> {}\n+                                            case Box(String! notNull) -> {}\n+                                        }\n+                                    }\n+                                    record Box(String str) {}\n+                                }\n+                                \"\"\",\n+                                Result.Error,\n+                                \"compiler.err.pattern.dominated\")\n+                )\n+        );\n+    }\n+\n+    @Test\n+    void testPatternExhaustiveness() {\n+        testList(\n+                List.of(\n+                        new DiagAndCode(\n+                                \"\"\"\n+                                class Test {\n+                                    void test(Box b) {\n+                                        switch (b) {\n+                                            case Box(String! notNull) -> {}\n+                                        }\n+                                    }\n+                                    record Box(String str) {}\n+                                }\n+                                \"\"\",\n+                                Result.Clean,\n+                                \"\") \/\/is exhaustive\n+                )\n+        );\n+    }\n","filename":"test\/langtools\/tools\/javac\/nullability\/NullabilityCompilationTests.java","additions":113,"deletions":0,"binary":false,"changes":113,"status":"modified"},{"patch":"@@ -43,1 +43,0 @@\n-import java.util.stream.IntStream;\n@@ -45,2 +44,0 @@\n-import com.sun.tools.javac.code.Flags;\n-import com.sun.tools.javac.util.Assert;\n@@ -52,1 +49,0 @@\n-import toolbox.Task.OutputKind;\n@@ -91,11 +87,0 @@\n-                \/*\"\"\"\n-                class Test {\n-                    record R(String x) {}\n-                    static void m(Object obj) {\n-                        if (obj instanceof R(String! x)) {}  \/\/ should not match not throw NPE\n-                    }\n-                    public static void main(String... args) {\n-                        m(new R(null));\n-                    }\n-                }\n-                \"\"\",*\/\n@@ -377,0 +362,62 @@\n+\n+    @Test\n+    public void testPatternMatching(Path base) throws Exception {\n+        Path src = base.resolve(\"src\");\n+        Path classes = base.resolve(\"classes\");\n+        tb.writeJavaFiles(src,\n+                          \"\"\"\n+                          public class Test {\n+                              public static void main(String... args) {\n+                                  Box box = new Box(null);\n+\n+                                  if (!(box instanceof Box(String s1))) {\n+                                      throw new AssertionError();\n+                                  }\n+\n+                                  if (box instanceof Box(String! s2)) {\n+                                      throw new AssertionError();\n+                                  }\n+\n+                                  switch (box) {\n+                                      case Box(String s3) -> {} \/\/OK\n+                                      default -> throw new AssertionError();\n+                                  }\n+\n+                                  switch (box) {\n+                                      case Box(String! s4) ->\n+                                          throw new AssertionError();\n+                                      default -> {}\n+                                  }\n+\n+                                  System.out.println(\"pass\");\n+                              }\n+                              record Box(String str) {}\n+                          }\n+                          \"\"\");\n+\n+        Files.createDirectories(classes);\n+\n+        new JavacTask(tb)\n+            .options(PREVIEW_OPTIONS)\n+            .outdir(classes)\n+            .files(tb.findJavaFiles(src))\n+            .run(Task.Expect.SUCCESS)\n+            .writeAll();\n+\n+        var out = new JavaTask(tb)\n+                .vmOptions(\"--enable-preview\")\n+                .classpath(classes.toString())\n+                .className(\"Test\")\n+                .run()\n+                .writeAll()\n+                .getOutputLines(Task.OutputKind.STDOUT);\n+\n+        var expectedOut = List.of(\"pass\");\n+\n+        if (!Objects.equals(expectedOut, out)) {\n+            throw new AssertionError(\"Incorrect Output, expected: \" + expectedOut +\n+                                      \", actual: \" + out);\n+\n+        }\n+    }\n+\n","filename":"test\/langtools\/tools\/javac\/nullability\/RuntimeNullChecks.java","additions":62,"deletions":15,"binary":false,"changes":77,"status":"modified"}]}