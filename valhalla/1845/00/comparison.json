{"files":[{"patch":"@@ -102,6 +102,6 @@\n-\/\/ JImageMode status to control preview behaviour. JImage_file is unusable\n-\/\/ for normal lookup until (JImage_mode != JIMAGE_MODE_UNINITIALIZED).\n-enum JImageMode {\n-  JIMAGE_MODE_UNINITIALIZED = 0,\n-  JIMAGE_MODE_DEFAULT = 1,\n-  JIMAGE_MODE_ENABLE_PREVIEW = 2\n+\/\/ PreviewMode status to control preview behaviour. JImage_file is unusable\n+\/\/ for normal lookup until (Preview_mode != PREVIEW_MODE_UNINITIALIZED).\n+enum PreviewMode {\n+  PREVIEW_MODE_UNINITIALIZED = 0,\n+  PREVIEW_MODE_DEFAULT = 1,\n+  PREVIEW_MODE_ENABLE_PREVIEW = 2\n@@ -109,1 +109,1 @@\n-static JImageMode                      JImage_mode            = JIMAGE_MODE_UNINITIALIZED;\n+static PreviewMode                     Preview_mode           = PREVIEW_MODE_UNINITIALIZED;\n@@ -237,1 +237,1 @@\n-\/\/ The following jimage_xxx static functions encapsulate all JImage_file and JImage_mode access.\n+\/\/ The following jimage_xxx static functions encapsulate all JImage_file and Preview_mode access.\n@@ -269,7 +269,0 @@\n-\/\/ Called once to set the access mode for resource (i.e. preview or non-preview) before\n-\/\/ general resource lookup can occur.\n-static void jimage_init(bool enable_preview) {\n-  assert(JImage_mode == JIMAGE_MODE_UNINITIALIZED, \"jimage_init must not be called twice\");\n-  JImage_mode = enable_preview ? JIMAGE_MODE_ENABLE_PREVIEW : JIMAGE_MODE_DEFAULT;\n-}\n-\n@@ -279,1 +272,1 @@\n-  return jimage_exists() && JImage_mode != JIMAGE_MODE_UNINITIALIZED;\n+  return jimage_exists() && Preview_mode != PREVIEW_MODE_UNINITIALIZED;\n@@ -283,3 +276,2 @@\n-static bool jimage_is_preview_enabled() {\n-  assert(jimage_is_initialized(), \"jimage is not initialized\");\n-  return JImage_mode == JIMAGE_MODE_ENABLE_PREVIEW;\n+static bool is_preview_enabled() {\n+  return Preview_mode == PREVIEW_MODE_ENABLE_PREVIEW;\n@@ -468,1 +460,1 @@\n-  bool is_preview = jimage_is_preview_enabled();\n+  const bool is_preview = is_preview_enabled();\n@@ -1007,0 +999,16 @@\n+\/\/ caller needs ResourceMark\n+const char* ClassLoader::create_preview_file_name(const char* file_name) {\n+  \/\/ We trust the file name to have come from a valid Symbol, so no checking\n+  \/\/ of expected semantics is needed.\n+  const int file_name_len = strlen(file_name);\n+\n+  static const char prefix[] = \"META-INF\/preview\/\";\n+  static const int prefix_len = strlen(prefix);\n+\n+  char* const preview_file_name = NEW_RESOURCE_ARRAY(char, prefix_len + file_name_len + 1);\n+  strncpy(preview_file_name, prefix, prefix_len + 1);\n+  \/\/ Include trailing nul from file_name.\n+  strncpy(&preview_file_name[prefix_len], file_name, file_name_len + 1);\n+  return preview_file_name;\n+}\n+\n@@ -1030,1 +1038,2 @@\n-                                                    const char* const file_name) {\n+                                                    const char* const file_name,\n+                                                    const char* const preview_file_name) {\n@@ -1063,1 +1072,6 @@\n-    stream = e->open_stream(current, file_name);\n+    if (nullptr != preview_file_name) {\n+      stream = e->open_stream(current, preview_file_name);\n+    }\n+    if (nullptr == stream) {\n+      stream = e->open_stream(current, file_name);\n+    }\n@@ -1127,1 +1141,1 @@\n-      stream = search_module_entries(THREAD, _patch_mod_entries, pkg_entry, file_name);\n+      stream = search_module_entries(THREAD, _patch_mod_entries, pkg_entry, file_name, nullptr);\n@@ -1143,1 +1157,2 @@\n-      stream = search_module_entries(THREAD, _exploded_entries, pkg_entry, file_name);\n+      const char* preview_file_name = is_preview_enabled() ? create_preview_file_name(file_name) : nullptr;\n+      stream = search_module_entries(THREAD, _exploded_entries, pkg_entry, file_name, preview_file_name);\n@@ -1480,1 +1495,1 @@\n-    \/\/ Special case where we lookup the options string *before* calling jimage_init().\n+    \/\/ Special case where we lookup the options string *before* set_preview_mode() is called.\n@@ -1497,4 +1512,3 @@\n-void ClassLoader::init_jimage(bool enable_preview) {\n-  if (jimage_exists()) {\n-    jimage_init(enable_preview);\n-  }\n+void ClassLoader::set_preview_mode(bool enable_preview) {\n+  assert(Preview_mode == PREVIEW_MODE_UNINITIALIZED, \"set_preview_mode must not be called twice\");\n+  Preview_mode = enable_preview ? PREVIEW_MODE_ENABLE_PREVIEW : PREVIEW_MODE_DEFAULT;\n","filename":"src\/hotspot\/share\/classfile\/classLoader.cpp","additions":43,"deletions":29,"binary":false,"changes":72,"status":"modified"},{"patch":"@@ -252,0 +252,3 @@\n+  \/\/ REVIEWER-NOTE: Where best to put this - it should be private!\n+  static const char* create_preview_file_name(const char* file_name);\n+\n@@ -313,1 +316,2 @@\n-  \/\/ Search the module list for the class file stream based on the file name and java package\n+  \/\/ Search the module list for the class file stream based on the file name and java package.\n+  \/\/ If preview_file_name is not nullptr, it is tried first for each classpath entry.\n@@ -317,1 +321,2 @@\n-                                                const char* const file_name);\n+                                                const char* const file_name,\n+                                                const char* const preview_file_name);\n@@ -363,1 +368,1 @@\n-  static void init_jimage(bool enable_preview);\n+  static void set_preview_mode(bool enable_preview);\n","filename":"src\/hotspot\/share\/classfile\/classLoader.hpp","additions":8,"deletions":3,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -3041,1 +3041,1 @@\n-  ClassLoader::init_jimage(is_valhalla_enabled());\n+  ClassLoader::set_preview_mode(is_valhalla_enabled());\n","filename":"src\/hotspot\/share\/runtime\/arguments.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}