{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -778,13 +778,19 @@\n-      JavaValue result(T_INT);\n-      JavaCallArguments args;\n-      Handle ho(THREAD, obj);\n-      args.push_oop(ho);\n-      methodHandle method(THREAD, UseAltSubstitutabilityMethod\n-              ? Universe::value_object_hash_codeAlt_method() : Universe::value_object_hash_code_method());\n-      JavaCalls::call(&result, method, &args, THREAD);\n-      if (HAS_PENDING_EXCEPTION) {\n-        if (!PENDING_EXCEPTION->is_a(vmClasses::Error_klass())) {\n-          Handle e(THREAD, PENDING_EXCEPTION);\n-          CLEAR_PENDING_EXCEPTION;\n-          THROW_MSG_CAUSE_(vmSymbols::java_lang_InternalError(), \"Internal error in hashCode\", e, false);\n-        }\n+    \/\/ Check if mark word contains hash code already\n+    intptr_t hash = obj->mark().hash();\n+    if (hash != markWord::no_hash) {\n+      return checked_cast<jint>(hash);\n+    }\n+\n+    \/\/ Compute hash by calling ValueObjectMethods.valueObjectHashCode\n+    JavaValue result(T_INT);\n+    JavaCallArguments args;\n+    Handle ho(THREAD, obj);\n+    args.push_oop(ho);\n+    methodHandle method(THREAD, UseAltSubstitutabilityMethod\n+            ? Universe::value_object_hash_codeAlt_method() : Universe::value_object_hash_code_method());\n+    JavaCalls::call(&result, method, &args, THREAD);\n+    if (HAS_PENDING_EXCEPTION) {\n+      if (!PENDING_EXCEPTION->is_a(vmClasses::Error_klass())) {\n+        Handle e(THREAD, PENDING_EXCEPTION);\n+        CLEAR_PENDING_EXCEPTION;\n+        THROW_MSG_CAUSE_(vmSymbols::java_lang_InternalError(), \"Internal error in hashCode\", e, false);\n@@ -792,1 +798,12 @@\n-      return result.get_jint();\n+    }\n+    hash = result.get_jint();\n+\n+    \/\/ Store hash in the mark word\n+    markWord old_mark, new_mark, test;\n+    do {\n+      old_mark = ho->mark();\n+      new_mark = old_mark.copy_set_hash(hash);\n+      test = ho->cas_set_mark(new_mark, old_mark);\n+    } while (test != old_mark);\n+\n+    return checked_cast<jint>(new_mark.hash());\n","filename":"src\/hotspot\/share\/prims\/jvm.cpp","additions":32,"deletions":15,"binary":false,"changes":47,"status":"modified"}]}