{"files":[{"patch":"@@ -784,0 +784,1 @@\n+  template(valueObjectHashCodeAlt_name,                     \"valueObjectHashCodeAlt\")                             \\\n","filename":"src\/hotspot\/share\/classfile\/vmSymbols.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -121,0 +121,1 @@\n+static LatestMethodCache _value_object_hash_code_alt_cache; \/\/ ValueObjectMethods.valueObjectHashCodeAlt()\n@@ -1074,8 +1075,9 @@\n-Method* Universe::finalizer_register_method()     { return _finalizer_register_cache.get_method(); }\n-Method* Universe::loader_addClass_method()        { return _loader_addClass_cache.get_method(); }\n-Method* Universe::throw_illegal_access_error()    { return _throw_illegal_access_error_cache.get_method(); }\n-Method* Universe::throw_no_such_method_error()    { return _throw_no_such_method_error_cache.get_method(); }\n-Method* Universe::do_stack_walk_method()          { return _do_stack_walk_cache.get_method(); }\n-Method* Universe::is_substitutable_method()       { return _is_substitutable_cache.get_method(); }\n-Method* Universe::value_object_hash_code_method() { return _value_object_hash_code_cache.get_method(); }\n-Method* Universe::is_substitutableAlt_method()    { return _is_substitutable_alt_cache.get_method(); }\n+Method* Universe::finalizer_register_method()        { return _finalizer_register_cache.get_method(); }\n+Method* Universe::loader_addClass_method()           { return _loader_addClass_cache.get_method(); }\n+Method* Universe::throw_illegal_access_error()       { return _throw_illegal_access_error_cache.get_method(); }\n+Method* Universe::throw_no_such_method_error()       { return _throw_no_such_method_error_cache.get_method(); }\n+Method* Universe::do_stack_walk_method()             { return _do_stack_walk_cache.get_method(); }\n+Method* Universe::is_substitutable_method()          { return _is_substitutable_cache.get_method(); }\n+Method* Universe::value_object_hash_code_method()    { return _value_object_hash_code_cache.get_method(); }\n+Method* Universe::is_substitutableAlt_method()       { return _is_substitutable_alt_cache.get_method(); }\n+Method* Universe::value_object_hash_codeAlt_method() { return _value_object_hash_code_alt_cache.get_method(); }\n@@ -1126,0 +1128,4 @@\n+  _value_object_hash_code_alt_cache.init(current,\n+                          vmClasses::ValueObjectMethods_klass(),\n+                          vmSymbols::valueObjectHashCodeAlt_name()->as_C_string(),\n+                          vmSymbols::object_int_signature(), true);\n","filename":"src\/hotspot\/share\/memory\/universe.cpp","additions":14,"deletions":8,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -263,0 +263,1 @@\n+  static Method*      value_object_hash_codeAlt_method();\n","filename":"src\/hotspot\/share\/memory\/universe.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -768,1 +768,2 @@\n-      methodHandle method(THREAD, Universe::value_object_hash_code_method());\n+      methodHandle method(THREAD, UseAltSubstitutabilityMethod\n+              ? Universe::value_object_hash_codeAlt_method() : Universe::value_object_hash_code_method());\n","filename":"src\/hotspot\/share\/prims\/jvm.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1119,1 +1119,1 @@\n-            System.out.println(\"substitutable \" + a.getClass() + \": \" + a + \" vs \" + b);\n+            System.out.println(\"isSubstitutable \" + a + \" vs \" + b);\n@@ -1409,0 +1409,3 @@\n+        if (VERBOSE) {\n+            System.out.println(\"isSubstitutableAlt \" + a + \" vs \" + b);\n+        }\n@@ -1455,0 +1458,55 @@\n+\n+    \/**\n+     * Return the identity hashCode of a value object.\n+     * The hashCode is computed using Unsafe.getFieldMap.\n+     * @param obj a value class instance, non-null\n+     * @return the hashCode of the object\n+     *\/\n+    private static int valueObjectHashCodeAlt(Object obj) {\n+        if (VERBOSE) {\n+            System.out.println(\"valueObjectHashCodeAlt: obj.getClass:\" + obj);\n+        }\n+        \/\/ This method assumes a is not null and is an instance of a value class\n+        Class<?> type = obj.getClass();\n+        final Unsafe U = UNSAFE;\n+        int[] map = U.getFieldMap(type);\n+        int result = 0;\n+        int nbNonRef = map[0];\n+        for (int i = 0; i < nbNonRef; i++) {\n+            int offset = map[i * 2 + 1];\n+            int size = map[i * 2 + 2];\n+            int nlong = size \/ 8;\n+            for (int j = 0; j < nlong; j++) {\n+                long la = U.getLong(obj, offset);\n+                result = 31 * result + (int) la;\n+                result = 31 * result + (int) (la >>> 32);\n+                offset += 8;\n+            }\n+            size -= nlong * 8;\n+            int nint = size \/ 4;\n+            for (int j = 0; j < nint; j++) {\n+                int ia = U.getInt(obj, offset);\n+                result = 31 * result + ia;\n+                offset += 4;\n+            }\n+            size -= nint * 4;\n+            int nshort = size \/ 2;\n+            for (int j = 0; j < nshort; j++) {\n+                short sa = U.getShort(obj, offset);\n+                result = 31 * result + sa;\n+                offset += 2;\n+            }\n+            size -= nshort * 2;\n+            for (int j = 0; j < size; j++) {\n+                byte ba = U.getByte(obj, offset);\n+                result = 31 * result + ba;\n+                offset++;\n+            }\n+        }\n+        for (int i = nbNonRef * 2 + 1; i < map.length; i++) {\n+            int offset = map[i];\n+            Object oa = U.getReference(obj, offset);\n+            result = 31 * result + Objects.hashCode(oa);\n+        }\n+        return result;\n+    }\n","filename":"src\/java.base\/share\/classes\/java\/lang\/runtime\/ValueObjectMethods.java","additions":59,"deletions":1,"binary":false,"changes":60,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+ * @run junit\/othervm -Xshare:off -XX:+UseAltSubstitutabilityMethod SubstitutabilityTest\n","filename":"test\/jdk\/valhalla\/valuetypes\/SubstitutabilityTest.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+ * @bug 8357373 8370714\n@@ -29,4 +30,4 @@\n- * @run junit\/othervm -XX:-UseFieldFlattening ValueObjectMethodsTest\n- * @run junit\/othervm -XX:-UseAtomicValueFlattening ValueObjectMethodsTest\n- * @run junit\/othervm -XX:+UseFieldFlattening ValueObjectMethodsTest\n- * @run junit\/othervm -XX:+UseAtomicValueFlattening ValueObjectMethodsTest\n+ * @run junit\/othervm ValueObjectMethodsTest\n+ * @run junit\/othervm -XX:+UseAltSubstitutabilityMethod ValueObjectMethodsTest\n+ * @run junit\/othervm -XX:+UseAltSubstitutabilityMethod -XX:+UseFieldFlattening ValueObjectMethodsTest\n+ * @run junit\/othervm -XX:+UseAltSubstitutabilityMethod -XX:+UseAtomicValueFlattening ValueObjectMethodsTest\n@@ -269,0 +270,2 @@\n+                List.of(10, 20, 30, 40),\n+                List.of(0x0001000100020002L, 0x0002000200040004L, 0x0008000800100010L, 0x0020002000400040L),\n","filename":"test\/jdk\/valhalla\/valuetypes\/ValueObjectMethodsTest.java","additions":7,"deletions":4,"binary":false,"changes":11,"status":"modified"}]}