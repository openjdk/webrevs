{"files":[{"patch":"@@ -186,0 +186,10 @@\n+    \/**\n+     * <p>Support for a \"preview version\" of classfiles when running with preview\n+     * mode. This is modeled as a new version (@) and since preview mode is only\n+     * supported for the current version, a single identifier token is sufficient.\n+     *\n+     * <p>For example, inside ct.sym, 27 will be modeled as 'R', and the preview\n+     * for 27 will be '@'. Classfiles unchanged between 27 and 27-preview will\n+     * not be duplicated (in the same way classfiles that are common between 26\n+     * and 27 are shared).\n+     *\/\n","filename":"make\/langtools\/src\/classes\/build\/tools\/symbolgenerator\/CreateSymbols.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -60,1 +60,0 @@\n-import com.sun.tools.javac.platform.PlatformDescription;\n@@ -68,2 +67,1 @@\n-import com.sun.tools.javac.code.Symbol;\n-import com.sun.tools.javac.code.Symbol.CompletionFailure;\n+\n@@ -225,1 +223,1 @@\n-            jrtIndex = JRTIndex.getInstance(preview.isEnabled());\n+            jrtIndex = JRTIndex.instance(preview.isEnabled());\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/ClassFinder.java","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,1 +53,1 @@\n-import com.sun.tools.javac.util.Context;\n+import com.sun.tools.javac.util.Assert;\n@@ -57,0 +57,5 @@\n+ *\n+ * <p>Instances of this class may share underlying file-system resources. This\n+ * is to avoid the need for singleton instances with unbounded lifetimes which\n+ * could never release and close the underlying JRT file-system, effectively\n+ * creating a resource leak.\n@@ -58,2 +63,31 @@\n-public class JRTIndex implements Closeable {\n-    public static JRTIndex getInstance(boolean previewMode) {\n+\/\/ Final to ensure equals\/hashCode are not overridden (instance sharing relies\n+\/\/ on default identity semantics).\n+public final class JRTIndex implements Closeable {\n+    \/**\n+     * Potentially shared access to underlying resources. Resources exist for\n+     * both preview and non-preview mode, and this field holds the version\n+     * corresponding to the preview mode flag with which it was created.\n+     *\/\n+    private final FileSystemResources sharedResources;\n+\n+    \/**\n+     * Create and initialize an index based on the preview mode flag.\n+     *\/\n+    private JRTIndex(boolean previewMode) throws IOException {\n+        this.sharedResources = FileSystemResources.claim(previewMode, this);\n+    }\n+\n+    @Override\n+    public void close() throws IOException {\n+        \/\/ Release is atomic and succeeds at most once per index.\n+        if (!sharedResources.release(this)) {\n+            throw new IllegalStateException(\"JRTIndex is closed\");\n+        }\n+    }\n+\n+    \/**\n+     * {@return a JRT index suitable for the given preview mode}\n+     *\n+     * <p>The returned instance must be closed by the caller.\n+     *\/\n+    public static JRTIndex instance(boolean previewMode) {\n@@ -67,0 +101,1 @@\n+    \/** {@return whether the JRT file-system is available to create an index} *\/\n@@ -76,0 +111,6 @@\n+    \/**\n+     * Underlying file system resources potentially shared between many indexes.\n+     *\n+     * <p>This class is thread-safe so JRT indexes can be created from arbitrary\n+     * threads.\n+     *\/\n@@ -77,1 +118,2 @@\n-        \/\/ Holds active non-preview and preview versions. Can be reset multiple times.\n+        \/\/ Holds the active non-preview (index 0) and preview (index 1) indexes.\n+        \/\/ Active instances can be reset multiple times.\n@@ -87,0 +129,2 @@\n+        \/\/ The set of indexes which have claimed this resource. This assumes\n+        \/\/ that index instances have default identity semantics.\n@@ -97,1 +141,1 @@\n-        FileSystemResources(boolean previewMode) throws IOException {\n+        private FileSystemResources(boolean previewMode) throws IOException {\n@@ -102,0 +146,1 @@\n+        \/** Claims shared ownership of resources for in index. *\/\n@@ -110,3 +155,3 @@\n-                if (!active.owners.add(owner)) {\n-                    throw new IOException(\"Index already opened by: \" + owner);\n-                }\n+                \/\/ Since claim is only called once per instance (during init)\n+                \/\/ seeing an index that's already claimed should be impossible.\n+                Assert.check(!active.owners.add(owner));\n@@ -117,0 +162,5 @@\n+        \/**\n+         * Releases ownership of this resource for an index with an existing claim.\n+         *\n+         * @return whether the given index is being released for the first time\n+         *\/\n@@ -121,1 +171,2 @@\n-                assert instances[idx] == this;\n+                Assert.check(instances[idx] == this);\n+                \/\/ Not finding a claim means the index was already released\/closed.\n@@ -131,1 +182,1 @@\n-                \/\/ This should be the only call to close().\n+                \/\/ This should be the only call to close() on the resource instance.\n@@ -139,1 +190,1 @@\n-            assert !isClosed;\n+            Assert.check(!isClosed);\n@@ -148,1 +199,1 @@\n-                throw new IOException(\"JRTIndex is closed\");\n+                throw new IllegalStateException(\"JRTIndex is closed\");\n@@ -305,17 +356,0 @@\n-    private final FileSystemResources sharedResources;\n-\n-    \/**\n-     * Create and initialize the index.\n-     *\/\n-    private JRTIndex(boolean previewMode) throws IOException {\n-        this.sharedResources = FileSystemResources.claim(previewMode, this);\n-    }\n-\n-    @Override\n-    public void close() throws IOException {\n-        \/\/ Release is atomic and succeeds at most once.\n-        if (!sharedResources.release(this)) {\n-            throw new IllegalStateException(\"Already closed\");\n-        }\n-    }\n-\n@@ -353,1 +387,6 @@\n-     * Whether the given {@link FileObject file} belongs to this index.\n+     * {@returns whether the given {@link FileObject file} belongs to this index}\n+     *\n+     * <p>A file \"belongs\" to an index if it was found in that index by {@code\n+     * ClassFinder}. Since indexes can differ with respect to preview mode, it\n+     * is important that the {@code ClassFinder} and {@link JavacFileManager}\n+     * agree on the preview mode setting being used during compilation.\n@@ -359,0 +398,3 @@\n+        \/\/ It is not sufficient to test if the file's path is *any* JRT path,\n+        \/\/ it must exist in the file-system instance of this index (which should\n+        \/\/ be the same index used by ClassFinder to obtain file objects).\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/JRTIndex.java","additions":73,"deletions":31,"binary":false,"changes":104,"status":"modified"},{"patch":"@@ -396,1 +396,1 @@\n-                jrtIndex = JRTIndex.getInstance(previewMode);\n+                jrtIndex = JRTIndex.instance(previewMode);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/JavacFileManager.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1971,1 +1971,1 @@\n-                        JRTIndex jrtIndex = JRTIndex.getInstance(previewMode);\n+                        JRTIndex jrtIndex = JRTIndex.instance(previewMode);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/Locations.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1562,0 +1562,5 @@\n+                \/\/ This is a temporary workaround until preview patching is removed and preview\n+                \/\/ versions of classes are loaded directly from the JRT file system.\n+                \/\/ Migrated value classes are marked with @jdk.internal.MigratedValueClass (or a\n+                \/\/ corresponding javac-internal annotation). This code marks such classes as\n+                \/\/ value-based, even if the original classfile is not the preview classfile.\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/jvm\/ClassReader.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -85,1 +85,1 @@\n-                \/\/without preview:\n+                \/\/ Without preview:\n@@ -103,1 +103,1 @@\n-                \/\/with preview:\n+                \/\/ With preview:\n","filename":"test\/langtools\/tools\/javac\/preview\/PreviewJRTImage.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}