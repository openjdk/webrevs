{"files":[{"patch":"@@ -148,1 +148,21 @@\n-    if (locOffset == 0) {\n+    if (locOffset != 0) {\n+        ImageLocation loc;\n+        loc.set_data(image_file->get_location_offset_data(locOffset));\n+\n+        u4 flags = loc.get_preview_flags();\n+        \/\/ No preview flags means \"a normal resource, without a preview version\".\n+        \/\/ This is the overwhelmingly common case, with or without preview mode.\n+        if (flags == 0) {\n+            return locOffset;\n+        }\n+        \/\/ Regardless of preview mode, don't return resources requested directly\n+        \/\/ via their preview path.\n+        if ((flags & ImageLocation::FLAGS_IS_PREVIEW_VERSION) != 0) {\n+            return 0L;\n+        }\n+        \/\/ Even if there is a preview version, we might not want to return it.\n+        if (!is_preview_mode || (flags & ImageLocation::FLAGS_HAS_PREVIEW_VERSION) == 0) {\n+            return locOffset;\n+        }\n+    } else if (!is_preview_mode) {\n+        \/\/ No normal resource found, and not in preview mode.\n@@ -151,18 +171,10 @@\n-    ImageLocation loc;\n-    loc.set_data(image_file->get_location_offset_data(locOffset));\n-\n-    u4 flags = loc.get_preview_flags();\n-    \/\/ No preview flags means \"a normal resource, without a preview version\".\n-    \/\/ This is the overwhelmingly common case, with or without preview mode.\n-    if (flags == 0) {\n-        return locOffset;\n-    }\n-    \/\/ Regardless of preview mode, don't return resources requested directly\n-    \/\/ via their preview path.\n-    if ((flags & ImageLocation::FLAGS_IS_PREVIEW_VERSION) != 0) {\n-        return 0L;\n-    }\n-    \/\/ Even if there is a preview version, we might not want to return it.\n-    if (!is_preview_mode || (flags & ImageLocation::FLAGS_HAS_PREVIEW_VERSION) == 0) {\n-        return locOffset;\n-    }\n+\n+    \/\/ We are in preview mode, and the preview version of the resource is needed.\n+    \/\/ This is either because:\n+    \/\/ 1. The normal resource was flagged as having a preview version (rare)\n+    \/\/ 2. This is a preview-only resource (there was no normal resource, very rare)\n+    \/\/ 3. The requested resource doesn't exist (this should typically not happen)\n+    \/\/\n+    \/\/ Since we only expect requests for resources which exist in jimage files, we\n+    \/\/ expect this 2nd lookup to succeed (this is contrary to the expectations for\n+    \/\/ the JRT file system, where non-existent resource lookups are common).\n@@ -182,2 +194,0 @@\n-\n-    \/\/ Lookup the preview version (which *should* exist).\n","filename":"src\/java.base\/share\/native\/libjimage\/jimage.cpp","additions":31,"deletions":21,"binary":false,"changes":52,"status":"modified"}]}