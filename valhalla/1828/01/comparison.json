{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -269,0 +269,1 @@\n+        \/\/ Map of currently open shared-readers.\n@@ -271,1 +272,1 @@\n-        \/\/ List of openers for this shared image.\n+        \/\/ List of openers for this shared image. Synchronized on OPEN_FILES.\n@@ -279,1 +280,1 @@\n-        \/\/ Cache of all user visible nodes, guarded by synchronizing 'this' instance.\n+        \/\/ Cache of all user visible nodes. Synchronized on 'this'.\n@@ -286,1 +287,1 @@\n-        \/\/ directories as they are completed.\n+        \/\/ directories as they are completed. Synchronized on 'this'.\n@@ -408,1 +409,1 @@\n-                SharedImageReader reader = OPEN_FILES.get(key);\n+                SharedImageReader sharedReader = OPEN_FILES.get(key);\n@@ -410,1 +411,1 @@\n-                if (reader == null) {\n+                if (sharedReader == null) {\n@@ -412,4 +413,4 @@\n-                    reader = new SharedImageReader(imagePath, byteOrder, previewMode);\n-                    OPEN_FILES.put(key, reader);\n-                } else if (reader.getByteOrder() != byteOrder) {\n-                    throw new IOException(\"\\\"\" + reader.getName() + \"\\\" is not an image file\");\n+                    sharedReader = new SharedImageReader(imagePath, byteOrder, previewMode);\n+                    OPEN_FILES.put(key, sharedReader);\n+                } else if (sharedReader.getByteOrder() != byteOrder) {\n+                    throw new IOException(\"\\\"\" + sharedReader.getName() + \"\\\" has incorrect byte ordering\");\n@@ -418,2 +419,2 @@\n-                ImageReader image = new ImageReader(reader);\n-                reader.openers.add(image);\n+                ImageReader image = new ImageReader(sharedReader);\n+                sharedReader.openers.add(image);\n@@ -428,0 +429,1 @@\n+            boolean shouldCloseSharedReader;\n@@ -432,3 +434,8 @@\n-\n-                if (openers.isEmpty()) {\n-                    close();\n+                shouldCloseSharedReader = openers.isEmpty();\n+                if (shouldCloseSharedReader\n+                        && !OPEN_FILES.remove(new ReaderKey(getImagePath(), previewMode), this)) {\n+                    throw new IOException(\"image file not found in open list\");\n+                }\n+            }\n+            if (shouldCloseSharedReader) {\n+                synchronized (this) {\n@@ -436,4 +443,0 @@\n-\n-                    if (!OPEN_FILES.remove(new ReaderKey(getImagePath(), previewMode), this)) {\n-                        throw new IOException(\"image file not found in open list\");\n-                    }\n@@ -441,0 +444,1 @@\n+                super.close();\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/jimage\/ImageReader.java","additions":23,"deletions":19,"binary":false,"changes":42,"status":"modified"}]}