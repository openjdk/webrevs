{"files":[{"patch":"@@ -28,0 +28,3 @@\n+import com.sun.tools.javac.code.Flags;\n+import com.sun.tools.javac.code.Preview;\n+import com.sun.tools.javac.code.Source;\n@@ -36,0 +39,1 @@\n+import com.sun.tools.javac.util.List;\n@@ -37,0 +41,1 @@\n+import com.sun.tools.javac.util.Options;\n@@ -62,0 +67,4 @@\n+    \/** are null restricted types allowed?\n+      *\/\n+    private final boolean allowNullRestrictedTypes;\n+    private final boolean noUseSiteNullChecks;\n@@ -69,0 +78,5 @@\n+        Preview preview = Preview.instance(context);\n+        Source source = Source.instance(context);\n+        allowNullRestrictedTypes = (!preview.isPreview(Source.Feature.NULL_RESTRICTED_TYPES) || preview.isEnabled()) &&\n+                Source.Feature.NULL_RESTRICTED_TYPES.allowedInSource(source);\n+        noUseSiteNullChecks = Options.instance(context).isSet(\"noUseSiteNullChecks\");\n@@ -72,6 +86,8 @@\n-        try {\n-            this.make = make;\n-            return translate(cdef);\n-        } finally {\n-            \/\/ note that recursive invocations of this method fail hard\n-            this.make = null;\n+        if (allowNullRestrictedTypes) {\n+            try {\n+                this.make = make;\n+                return translate(cdef);\n+            } finally {\n+                \/\/ note that recursive invocations of this method fail hard\n+                this.make = null;\n+            }\n@@ -79,0 +95,1 @@\n+        return cdef;\n@@ -150,0 +167,59 @@\n+\n+    @Override\n+    public void visitApply(JCMethodInvocation tree) {\n+        if (noUseSiteNullChecks) {\n+            super.visitApply(tree);\n+            result = tree;\n+        } else {\n+            Symbol.MethodSymbol msym = (Symbol.MethodSymbol) TreeInfo.symbolFor(tree.meth);\n+            tree.args = newArgs(msym, tree.args);\n+            super.visitApply(tree);\n+            result = tree;\n+            if (types.isNonNullable(msym.type.asMethodType().restype)) {\n+                result = attr.makeNullCheck(tree, true);\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void visitNewClass(JCNewClass tree) {\n+        if (!noUseSiteNullChecks) {\n+            tree.args = newArgs((Symbol.MethodSymbol) tree.constructor, tree.args);\n+        }\n+        super.visitNewClass(tree);\n+        result = tree;\n+    }\n+\n+    private List<JCExpression> newArgs(Symbol.MethodSymbol msym, List<JCExpression> actualArgs) {\n+        \/\/ skip signature polymorphic methods they won't have null restricted fields arguments\n+        if ((msym.flags_field & Flags.SIGNATURE_POLYMORPHIC) != 0) {\n+            return actualArgs;\n+        }\n+        ListBuffer<JCExpression> newArgs = new ListBuffer<>();\n+        List<Type> declaredArgTypes = msym.type.asMethodType().argtypes;\n+        \/* there can be prefix arguments added by Lower, for example captured variables, etc\n+         * nothing to check for them\n+         *\/\n+        int prefixArgsLength = msym.externalType(types).getParameterTypes().size() - declaredArgTypes.size();\n+        List<JCExpression> actualArgsTmp = actualArgs;\n+        while (prefixArgsLength-- > 0) {\n+            newArgs.add(actualArgsTmp.head);\n+            actualArgsTmp = actualArgsTmp.tail;\n+        }\n+        int declaredArgSize = declaredArgTypes.size();\n+        int argsToCheck = msym.isVarArgs() ? declaredArgSize - 1 : declaredArgSize;\n+        while (argsToCheck-- > 0) {\n+            Type formalArgType = declaredArgTypes.head;\n+            if (types.isNonNullable(formalArgType)) {\n+                newArgs.add(attr.makeNullCheck(actualArgsTmp.head, true));\n+            } else {\n+                newArgs.add(actualArgsTmp.head);\n+            }\n+            actualArgsTmp = actualArgsTmp.tail;\n+        }\n+        \/\/ now add the last vararg argument if applicable\n+        if (msym.isVarArgs()) {\n+            newArgs.add(actualArgsTmp.head);\n+        }\n+        return newArgs.toList();\n+    }\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/NullChecksWriter.java","additions":82,"deletions":6,"binary":false,"changes":88,"status":"modified"},{"patch":"@@ -218,0 +218,31 @@\n+                \"\"\",\n+                \/\/ use site null checks negative examples\n+                \"\"\"\n+                class Test {\n+                    class Inner {\n+                        Object m(Object! arg) { return null; }\n+                    }\n+                    class Inner2 extends Inner {\n+                        @Override\n+                        String m(Object arg) { return null; }\n+                    }\n+                    public static void main(String... args) {\n+                        Inner inner = new Test().new Inner2();\n+                        inner.m(null);\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                class Test {\n+                    class Inner {\n+                        Object! m(Object arg) { return null; }\n+                    }\n+                    class Inner2 extends Inner {\n+                        @Override\n+                        String m(Object arg) { return null; }\n+                    }\n+                    public static void main(String... args) {\n+                        Inner inner = new Test().new Inner2();\n+                        inner.m(null);\n+                    }\n+                }\n@@ -318,0 +349,37 @@\n+\n+        \/\/ use site null checks positive examples\n+        testHelper(base,\n+                \"\"\"\n+                class Test {\n+                    class Inner {\n+                        Object m(Object! arg) { return null; }\n+                    }\n+                    class Inner2 extends Inner {\n+                        @Override\n+                        String m(Object arg) { return null; }\n+                    }\n+                    public static void main(String... args) {\n+                        Inner inner = new Test().new Inner2();\n+                        inner.m(null);\n+                    }\n+                }\n+                \"\"\",\n+                false, null, PREVIEW_PLUS_NO_USE_SITE_OPTIONS);\n+        \/\/ similar to the above but now checking the return type\n+        testHelper(base,\n+                \"\"\"\n+                class Test {\n+                    class Inner {\n+                        Object! m(Object arg) { return null; }\n+                    }\n+                    class Inner2 extends Inner {\n+                        @Override\n+                        String m(Object arg) { return null; }\n+                    }\n+                    public static void main(String... args) {\n+                        Inner inner = new Test().new Inner2();\n+                        inner.m(null);\n+                    }\n+                }\n+                \"\"\",\n+                false, null, PREVIEW_PLUS_NO_USE_SITE_OPTIONS);\n@@ -321,1 +389,9 @@\n-            \"--enable-preview\", \"-source\", Integer.toString(Runtime.version().feature())};\n+            \"--enable-preview\",\n+            \"-source\", Integer.toString(Runtime.version().feature())\n+    };\n+\n+    private static String[] PREVIEW_PLUS_NO_USE_SITE_OPTIONS = {\n+            \"--enable-preview\",\n+            \"-source\", Integer.toString(Runtime.version().feature()),\n+            \"-XDnoUseSiteNullChecks\"\n+    };\n@@ -324,0 +400,4 @@\n+        testHelper(base, testCode, shouldFail, expectedError, PREVIEW_OPTIONS);\n+    }\n+\n+    private void testHelper(Path base, String testCode, boolean shouldFail, Class<?> expectedError, String[] compilerOptions) throws Exception {\n@@ -334,1 +414,1 @@\n-                .options(PREVIEW_OPTIONS)\n+                .options(compilerOptions)\n","filename":"test\/langtools\/tools\/javac\/nullability\/RuntimeNullChecks.java","additions":82,"deletions":2,"binary":false,"changes":84,"status":"modified"}]}