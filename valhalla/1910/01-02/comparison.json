{"files":[{"patch":"@@ -71,1 +71,1 @@\n-    @Test\n+    \/\/@Test\n@@ -218,31 +218,0 @@\n-                \"\"\",\n-                \/\/ use site null checks negative examples\n-                \"\"\"\n-                class Test {\n-                    class Inner {\n-                        Object m(Object! arg) { return null; }\n-                    }\n-                    class Inner2 extends Inner {\n-                        @Override\n-                        String m(Object arg) { return null; }\n-                    }\n-                    public static void main(String... args) {\n-                        Inner inner = new Test().new Inner2();\n-                        inner.m(null);\n-                    }\n-                }\n-                \"\"\",\n-                \"\"\"\n-                class Test {\n-                    class Inner {\n-                        Object! m(Object arg) { return null; }\n-                    }\n-                    class Inner2 extends Inner {\n-                        @Override\n-                        String m(Object arg) { return null; }\n-                    }\n-                    public static void main(String... args) {\n-                        Inner inner = new Test().new Inner2();\n-                        inner.m(null);\n-                    }\n-                }\n@@ -349,37 +318,0 @@\n-\n-        \/\/ use site null checks positive examples\n-        testHelper(base,\n-                \"\"\"\n-                class Test {\n-                    class Inner {\n-                        Object m(Object! arg) { return null; }\n-                    }\n-                    class Inner2 extends Inner {\n-                        @Override\n-                        String m(Object arg) { return null; }\n-                    }\n-                    public static void main(String... args) {\n-                        Inner inner = new Test().new Inner2();\n-                        inner.m(null);\n-                    }\n-                }\n-                \"\"\",\n-                false, null, PREVIEW_PLUS_NO_USE_SITE_OPTIONS);\n-        \/\/ similar to the above but now checking the return type\n-        testHelper(base,\n-                \"\"\"\n-                class Test {\n-                    class Inner {\n-                        Object! m(Object arg) { return null; }\n-                    }\n-                    class Inner2 extends Inner {\n-                        @Override\n-                        String m(Object arg) { return null; }\n-                    }\n-                    public static void main(String... args) {\n-                        Inner inner = new Test().new Inner2();\n-                        inner.m(null);\n-                    }\n-                }\n-                \"\"\",\n-                false, null, PREVIEW_PLUS_NO_USE_SITE_OPTIONS);\n@@ -443,1 +375,1 @@\n-    @Test\n+    \/\/@Test\n@@ -504,0 +436,217 @@\n+    \/\/@Test\n+    public void testClientSideChecks(Path base) throws Exception {\n+        String[] negativeCompilationTestCases = new String[] {\n+                \"\"\"\n+                class Test {\n+                    class Inner {\n+                        Object m(Object! arg) { return null; }\n+                    }\n+                    class Inner2 extends Inner {\n+                        @Override\n+                        String m(Object arg) { return null; }\n+                    }\n+                    public static void main(String... args) {\n+                        Inner inner = new Test().new Inner2();\n+                        inner.m(null);\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                class Test {\n+                    class Inner {\n+                        Object! m(Object arg) { return \"\"; }\n+                    }\n+                    class Inner2 extends Inner {\n+                        @Override\n+                        String m(Object arg) { return null; }\n+                    }\n+                    public static void main(String... args) {\n+                        Inner inner = new Test().new Inner2();\n+                        inner.m(null);\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                class Test {\n+                    class Inner {\n+                        Object m(Object! arg, Object... args) { return null; }\n+                    }\n+                    class Inner2 extends Inner {\n+                        @Override\n+                        String m(Object arg, Object... args) { return null; }\n+                    }\n+                    public static void main(String... args) {\n+                        Inner inner = new Test().new Inner2();\n+                        inner.m(null, null);\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                class Test {\n+                    class Inner {\n+                        Object! m(Object arg, Object... args) { return \"\"; }\n+                    }\n+                    class Inner2 extends Inner {\n+                        @Override\n+                        String m(Object arg, Object... args) { return null; }\n+                    }\n+                    public static void main(String... args) {\n+                        Inner inner = new Test().new Inner2();\n+                        inner.m(null, null);\n+                    }\n+                }\n+                \"\"\"\n+        };\n+        for (String code : negativeCompilationTestCases) {\n+            testHelper(base, code, true, NullPointerException.class);\n+            testHelper(base, code, false, null, PREVIEW_PLUS_NO_USE_SITE_OPTIONS);\n+        }\n+    }\n+\n+    @Test\n+    public void testClientSideChecksSepCompilation(Path base) throws Exception {\n+        testSeparateCompilationHelper(base,\n+                \"\"\"\n+                package pkg;\n+                class Super {\n+                    Super(Object! arg) {}\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                class Super {\n+                    Super(Object arg) {}\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                class Client {\n+                    public static void main(String... args) {\n+                        Super sup = new Super(null);\n+                    }\n+                }\n+                \"\"\");\n+        testSeparateCompilationHelper(base,\n+                \"\"\"\n+                package pkg;\n+                class Super {\n+                    Super(Object! arg, Object... args) {}\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                class Super {\n+                    Super(Object arg, Object... args) {}\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                class Client {\n+                    public static void main(String... args) {\n+                        Super sup = new Super(null, null);\n+                    }\n+                }\n+                \"\"\");\n+        testSeparateCompilationHelper(base,\n+                \"\"\"\n+                package pkg;\n+                public class Super {\n+                    public class Inner extends Super {\n+                        public Inner(Object! arg) {}\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                public class Super {\n+                    public class Inner extends Super {\n+                        public Inner(Object arg) {}\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                class Client {\n+                    public static void main(String... args) {\n+                        Super.Inner inner = new Super().new Inner(null);\n+                    }\n+                }\n+                \"\"\");\n+        testSeparateCompilationHelper(base,\n+                \"\"\"\n+                package pkg;\n+                public class Super {\n+                    public class Inner extends Super {\n+                        public Inner(Object! arg, Object... args) {}\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                public class Super {\n+                    public class Inner extends Super {\n+                        public Inner(Object arg, Object... args) {}\n+                    }\n+                }\n+                \"\"\",\n+                \"\"\"\n+                package pkg;\n+                class Client {\n+                    public static void main(String... args) {\n+                        Super.Inner inner = new Super().new Inner(null, null);\n+                    }\n+                }\n+                \"\"\");\n+    }\n+\n+    private void testSeparateCompilationHelper(\n+            Path base,\n+            String code1,\n+            String code2,\n+            String clientCode) throws Exception {\n+        Path src = base.resolve(\"src\");\n+        Path pkg = src.resolve(\"pkg\");\n+        Path ASrc = pkg.resolve(\"A\");\n+        Path client = pkg.resolve(\"Client\");\n+\n+        tb.writeJavaFiles(ASrc, code1);\n+        tb.writeJavaFiles(client, clientCode);\n+\n+        Path out = base.resolve(\"out\");\n+        Files.createDirectories(out);\n+\n+        new JavacTask(tb)\n+                .outdir(out)\n+                .options(PREVIEW_OPTIONS)\n+                .files(findJavaFiles(pkg))\n+                .run();\n+\n+        \/\/ let's execute to check that it's producing the NPE\n+        System.err.println(\"running, this test should fail\");\n+        String output = new JavaTask(tb)\n+                .classpath(out.toString())\n+                .classArgs(\"pkg.Client\")\n+                .vmOptions(\"--enable-preview\")\n+                .run(Task.Expect.FAIL)\n+                .writeAll()\n+                .getOutput(Task.OutputKind.STDERR);\n+        if (!output.startsWith(\"Exception in thread \\\"main\\\" java.lang.NullPointerException\")) {\n+            throw new AssertionError(\"java.lang.NullPointerException expected\");\n+        }\n+\n+        \/\/ now lets change the code\n+        tb.writeJavaFiles(ASrc, code2);\n+\n+        new JavacTask(tb)\n+                .outdir(out)\n+                .options(PREVIEW_PLUS_NO_USE_SITE_OPTIONS)\n+                .files(findJavaFiles(pkg))\n+                .run();\n+\n+        System.err.println(\"running, this test should pass\");\n+        new JavaTask(tb)\n+                .classpath(out.toString())\n+                .classArgs(\"pkg.Client\")\n+                .vmOptions(\"--enable-preview\")\n+                .run(Task.Expect.SUCCESS);\n+    }\n","filename":"test\/langtools\/tools\/javac\/nullability\/RuntimeNullChecks.java","additions":219,"deletions":70,"binary":false,"changes":289,"status":"modified"}]}