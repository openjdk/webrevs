{"files":[{"patch":"@@ -185,0 +185,4 @@\n+  if (!vk->maybe_flat_in_array()) {\n+    return ArrayDescription(RefArrayKlassKind, properties, LayoutKind::REFERENCE);\n+  }\n+\n@@ -188,1 +192,1 @@\n-      if (vk->maybe_flat_in_array() && vk->has_non_atomic_layout()) {\n+      if (vk->has_non_atomic_layout()) {\n@@ -190,0 +194,2 @@\n+      } else if (vk->has_atomic_layout()) {\n+        return ArrayDescription(FlatArrayKlassKind, properties, LayoutKind::ATOMIC_FLAT);\n@@ -195,1 +201,1 @@\n-      if (vk->maybe_flat_in_array() && vk->is_naturally_atomic() && vk->has_non_atomic_layout()) {\n+      if (vk->is_naturally_atomic() && vk->has_non_atomic_layout()) {\n@@ -197,1 +203,1 @@\n-      } else if (vk->maybe_flat_in_array() && vk->has_atomic_layout()) {\n+      } else if (vk->has_atomic_layout()) {\n@@ -205,1 +211,1 @@\n-    if (vk->maybe_flat_in_array() && vk->has_nullable_atomic_layout()) {\n+    if (vk->has_nullable_atomic_layout()) {\n@@ -215,2 +221,0 @@\n-  assert(!ArrayKlass::is_non_atomic(props) || (element_klass()->is_inline_klass() && InlineKlass::cast(element_klass())->has_non_atomic_layout()),\n-         \"cannot create non-atomic species\");\n","filename":"src\/hotspot\/share\/oops\/objArrayKlass.cpp","additions":10,"deletions":6,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -1418,1 +1418,1 @@\n-      \/\/ incorrect!).\n+      \/\/ incorrect, see JDK-8331133).\n","filename":"src\/hotspot\/share\/opto\/compile.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -4882,3 +4882,0 @@\n-        if (!t->as_inline_klass()->has_non_atomic_layout()) {\n-          atomic = true;\n-        }\n","filename":"src\/hotspot\/share\/opto\/library_call.cpp","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -59,1 +59,0 @@\n-#include \"oops\/arrayKlass.hpp\"\n@@ -488,4 +487,1 @@\n-  ArrayKlass::ArrayProperties props = ArrayKlass::ArrayProperties::NULL_RESTRICTED;\n-  if (vk->has_non_atomic_layout()) {\n-    props = (ArrayKlass::ArrayProperties)(props | ArrayKlass::ArrayProperties::NON_ATOMIC);\n-  }\n+  ArrayKlass::ArrayProperties props = (ArrayKlass::ArrayProperties)(ArrayKlass::ArrayProperties::NON_ATOMIC | ArrayKlass::ArrayProperties::NULL_RESTRICTED);\n","filename":"src\/hotspot\/share\/prims\/jvm.cpp","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"}]}