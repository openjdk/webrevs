{"files":[{"patch":"@@ -173,5 +173,15 @@\n-  public:\n-   Klass::KlassKind _kind;\n-   ArrayKlass::ArrayProperties _properties;\n-   LayoutKind _layout_kind;\n-   ArrayDescription(Klass::KlassKind k, ArrayKlass::ArrayProperties p, LayoutKind lk) { _kind = k; _properties = p; _layout_kind = lk; }\n+public:\n+  Klass::KlassKind _kind;\n+  ArrayKlass::ArrayProperties _properties;\n+  LayoutKind _layout_kind;\n+  ArrayDescription(Klass::KlassKind k, ArrayKlass::ArrayProperties p, LayoutKind lk) {\n+    _kind = k;\n+    _layout_kind = lk;\n+\n+    if (lk == LayoutKind::REFERENCE || LayoutKindHelper::is_atomic_flat(lk)) {\n+      p = (ArrayKlass::ArrayProperties) (p &~ ArrayKlass::NON_ATOMIC);\n+    } else {\n+      p = (ArrayKlass::ArrayProperties) (p | ArrayKlass::NON_ATOMIC);\n+    }\n+    _properties = p;\n+  }\n","filename":"src\/hotspot\/share\/oops\/arrayKlass.hpp","additions":15,"deletions":5,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -103,5 +103,0 @@\n-  if (LayoutKindHelper::is_atomic_flat(lk)) {\n-    \/\/ For classes without a non-atomic layout, trying to create a non-atomic array will create one\n-    \/\/ with atomic property, we need to normalize the true properties of the array\n-    props = (ArrayProperties) (props &~ ArrayProperties::NON_ATOMIC);\n-  }\n","filename":"src\/hotspot\/share\/oops\/flatArrayKlass.cpp","additions":0,"deletions":5,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -43,0 +43,1 @@\n+#include \"oops\/layoutKind.hpp\"\n@@ -225,1 +226,1 @@\n-      ak = RefArrayKlass::allocate_refArray_klass(class_loader_data(), dimension(), element_klass(), props, CHECK_NULL);\n+      ak = RefArrayKlass::allocate_refArray_klass(class_loader_data(), dimension(), element_klass(), ad._properties, CHECK_NULL);\n@@ -230,1 +231,1 @@\n-      ak = FlatArrayKlass::allocate_klass(element_klass(), props, ad._layout_kind, CHECK_NULL);\n+      ak = FlatArrayKlass::allocate_klass(element_klass(), ad._properties, ad._layout_kind, CHECK_NULL);\n@@ -407,0 +408,2 @@\n+  ArrayDescription ad = array_layout_selection(element_klass(), props);\n+  props = ad._properties;\n","filename":"src\/hotspot\/share\/oops\/objArrayKlass.cpp","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -66,2 +66,0 @@\n-  \/\/ RefArrays are always atomic\n-  props = (ArrayProperties) (props &~ ArrayProperties::NON_ATOMIC);\n","filename":"src\/hotspot\/share\/oops\/refArrayKlass.cpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1899,1 +1899,1 @@\n-  return _gvn.transform(new CastPPNode(control(), array, arytype, ConstraintCastNode::StrongDependency));\n+  return _gvn.transform(new CheckCastPPNode(control(), array, arytype, ConstraintCastNode::StrongDependency));\n@@ -1910,2 +1910,1 @@\n-  assert(arytype->is_atomic() == is_atomic, \"inconsistency\");\n-  return _gvn.transform(new CastPPNode(control(), array, arytype, ConstraintCastNode::StrongDependency));\n+  return _gvn.transform(new CheckCastPPNode(control(), array, arytype, ConstraintCastNode::StrongDependency));\n","filename":"src\/hotspot\/share\/opto\/graphKit.cpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -4876,1 +4876,0 @@\n-        assert(array_klass->is_elem_atomic() == atomic, \"inconsistency\");\n@@ -4900,1 +4899,0 @@\n-          assert(arytype->is_atomic() == atomic, \"inconsistency\");\n","filename":"src\/hotspot\/share\/opto\/library_call.cpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}