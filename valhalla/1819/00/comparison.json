{"files":[{"patch":"@@ -2100,19 +2100,0 @@\n-\/\/ Temporary system property to disable preview patching and enable the new preview mode\n-\/\/ feature for testing\/development. Once the preview mode feature is finished, the value\n-\/\/ will be always 'true' and this code, and all related dead-code can be removed.\n-\/\/ See also:\n-\/\/ * src\/java.base\/share\/classes\/jdk\/internal\/jimage\/PreviewMode.java\n-\/\/ * src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/jvm\/ClassReader.java\n-#define DISABLE_PREVIEW_PATCHING_DEFAULT true\n-\n-bool Arguments::disable_preview_patching() {\n-  const char* prop = get_property(\"DISABLE_PREVIEW_PATCHING\");\n-  return (prop != nullptr)\n-      ? strncmp(prop, \"true\", strlen(\"true\")) == 0\n-      : DISABLE_PREVIEW_PATCHING_DEFAULT;\n-}\n-\n-\/\/ VALUECLASS_STR must match string used in the build\n-#define VALUECLASS_STR \"valueclasses\"\n-#define VALUECLASS_JAR \"-\" VALUECLASS_STR \".jar\"\n-\n@@ -2122,44 +2103,1 @@\n-  \/\/ If --enable-preview is true, modules may have preview mode resources.\n-  bool enable_valhalla_preview = is_valhalla_enabled();\n-  \/\/ Whether to use module patching, or the new preview mode feature for preview resources.\n-  bool disable_patching = disable_preview_patching();\n-\n-  \/\/ This must be called, even with 'false', to enable resource lookup from JImage.\n-  ClassLoader::init_jimage(disable_patching && enable_valhalla_preview);\n-\n-  \/\/ For each <module>-valueclasses.jar in <JAVA_HOME>\/lib\/valueclasses\/\n-  \/\/ appends the equivalent of --patch-module <module>=<JAVA_HOME>\/lib\/valueclasses\/<module>-valueclasses.jar\n-  if (!disable_patching && enable_valhalla_preview) {\n-    char * valueclasses_dir = AllocateHeap(JVM_MAXPATHLEN, mtArguments);\n-    const char * fileSep = os::file_separator();\n-\n-    jio_snprintf(valueclasses_dir, JVM_MAXPATHLEN, \"%s%slib%s\" VALUECLASS_STR \"%s\",\n-                 Arguments::get_java_home(), fileSep, fileSep, fileSep);\n-    DIR* dir = os::opendir(valueclasses_dir);\n-    if (dir != nullptr) {\n-      char * module_name = AllocateHeap(JVM_MAXPATHLEN, mtArguments);\n-      char * path = AllocateHeap(JVM_MAXPATHLEN, mtArguments);\n-\n-      for (dirent * entry = os::readdir(dir); entry != nullptr; entry = os::readdir(dir)) {\n-        \/\/ Test if file ends-with \"-valueclasses.jar\"\n-        int len = (int)strlen(entry->d_name) - (sizeof(VALUECLASS_JAR) - 1);\n-        if (len <= 0 || strcmp(&entry->d_name[len], VALUECLASS_JAR) != 0) {\n-          continue;         \/\/ too short or not the expected suffix\n-        }\n-\n-        strcpy(module_name, entry->d_name);\n-        module_name[len] = '\\0';     \/\/ truncate to just module-name\n-\n-        jio_snprintf(path, JVM_MAXPATHLEN, \"%s%s\", valueclasses_dir, &entry->d_name);\n-        add_patch_mod_prefix(module_name, path, true \/* append *\/, true \/* cds OK*\/);\n-        log_info(class)(\"--enable-preview appending value classes for module %s: %s\", module_name, entry->d_name);\n-      }\n-      FreeHeap(module_name);\n-      FreeHeap(path);\n-      os::closedir(dir);\n-    }\n-    FreeHeap(valueclasses_dir);\n-  }\n-\n-  \/\/ Create numbered properties for each module that has been patched either\n-  \/\/ by --patch-module (or --enable-preview if disable_patching is false).\n+  \/\/ Create numbered properties for each module that has been patched by --patch-module.\n@@ -3115,1 +3053,3 @@\n-  \/\/ finalize --module-patch and related --enable-preview\n+  ClassLoader::init_jimage(is_valhalla_enabled());\n+\n+  \/\/ finalize --module-patch.\n","filename":"src\/hotspot\/share\/runtime\/arguments.cpp","additions":4,"deletions":64,"binary":false,"changes":68,"status":"modified"},{"patch":"@@ -489,1 +489,0 @@\n-  static bool disable_preview_patching();\n","filename":"src\/hotspot\/share\/runtime\/arguments.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -59,3 +59,0 @@\n-        if (!DISABLE_PREVIEW_PATCHING) {\n-            return false;\n-        }\n@@ -89,12 +86,0 @@\n-\n-    \/\/ Temporary system property to disable preview patching and enable the new preview mode\n-    \/\/ feature for testing\/development. Once the preview mode feature is finished, the value\n-    \/\/ will be always 'true' and this code, and all related dead-code can be removed.\n-    \/\/ See also:\n-    \/\/ * src\/hotspot\/share\/runtime\/arguments.cpp\n-    \/\/ * src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/jvm\/ClassReader.java\n-    private static final boolean DISABLE_PREVIEW_PATCHING_DEFAULT = true;\n-    private static final boolean DISABLE_PREVIEW_PATCHING = Boolean.parseBoolean(\n-            System.getProperty(\n-                    \"DISABLE_PREVIEW_PATCHING\",\n-                    Boolean.toString(DISABLE_PREVIEW_PATCHING_DEFAULT)));\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/jimage\/PreviewMode.java","additions":0,"deletions":15,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -1560,13 +1560,0 @@\n-            } else if (!DISABLE_PREVIEW_PATCHING\n-                    && proxy.type.tsym.flatName() == syms.migratedValueClassInternalType.tsym.flatName()) {\n-                \/\/ This is a temporary workaround until preview patching is removed and preview\n-                \/\/ versions of classes are loaded directly from the JRT file system.\n-                \/\/ Migrated value classes are marked with @jdk.internal.MigratedValueClass (or a\n-                \/\/ corresponding javac-internal annotation). This code marks such classes as\n-                \/\/ value-based, even if the original classfile is not the preview classfile.\n-                Assert.check(sym.kind == TYP);\n-                sym.flags_field |= MIGRATED_VALUE_CLASS;\n-                if (needsValueFlag(sym, sym.flags_field)) {\n-                    sym.flags_field |= VALUE_CLASS;\n-                    sym.flags_field &= ~IDENTITY_TYPE;\n-                }\n@@ -1592,8 +1579,1 @@\n-                }  else if (!DISABLE_PREVIEW_PATCHING\n-                        && proxy.type.tsym == syms.migratedValueClassType.tsym && sym.kind == TYP) {\n-                    sym.flags_field |= MIGRATED_VALUE_CLASS;\n-                    if (needsValueFlag(sym, sym.flags_field)) {\n-                        sym.flags_field |= VALUE_CLASS;\n-                        sym.flags_field &= ~IDENTITY_TYPE;\n-                    }\n-                }  else if (proxy.type.tsym == syms.restrictedType.tsym) {\n+                } else if (proxy.type.tsym == syms.restrictedType.tsym) {\n@@ -3605,12 +3585,0 @@\n-\n-    \/\/ Temporary system property to disable preview patching and enable the new preview mode\n-    \/\/ feature for testing\/development. Once the preview mode feature is finished, the value\n-    \/\/ will be always 'true' and this code, and all related dead-code can be removed.\n-    \/\/ See also:\n-    \/\/ * src\/hotspot\/share\/runtime\/arguments.cpp\n-    \/\/ * src\/java.base\/share\/classes\/jdk\/internal\/jimage\/PreviewMode.java\n-    private static final boolean DISABLE_PREVIEW_PATCHING_DEFAULT = true;\n-    private static final boolean DISABLE_PREVIEW_PATCHING = Boolean.parseBoolean(\n-            System.getProperty(\n-                    \"DISABLE_PREVIEW_PATCHING\",\n-                    Boolean.toString(DISABLE_PREVIEW_PATCHING_DEFAULT)));\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/jvm\/ClassReader.java","additions":1,"deletions":33,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -43,1 +43,1 @@\n- * @run junit\/othervm -esa -DDISABLE_PREVIEW_PATCHING=true ImageLocationTest\n+ * @run junit\/othervm -esa ImageLocationTest\n","filename":"test\/jdk\/jdk\/internal\/jimage\/ImageLocationTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -68,1 +68,1 @@\n- * @run junit\/othervm -esa -DDISABLE_PREVIEW_PATCHING=true ImageReaderTest\n+ * @run junit\/othervm -esa ImageReaderTest\n@@ -71,1 +71,1 @@\n-\/\/\/ Using PER_CLASS lifecycle means the (expensive) image file is only build once.\n+\/\/\/ Using PER_CLASS lifecycle means the (expensive) image file is only built once.\n","filename":"test\/jdk\/jdk\/internal\/jimage\/ImageReaderTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -80,1 +80,1 @@\n- * @run junit\/othervm -esa -DDISABLE_PREVIEW_PATCHING=true SystemImageTest\n+ * @run junit\/othervm -esa SystemImageTest\n","filename":"test\/jdk\/jdk\/internal\/jrtfs\/SystemImageTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -58,1 +58,1 @@\n- * @run main\/othervm\/timeout=1200 -ea -esa -DDISABLE_PREVIEW_PATCHING=false -Xmx1g PackagedModulesVsRuntimeImageLinkTest\n+ * @run main\/othervm\/timeout=1200 -ea -esa -Xmx1g PackagedModulesVsRuntimeImageLinkTest\n","filename":"test\/jdk\/tools\/jlink\/runtimeImage\/PackagedModulesVsRuntimeImageLinkTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -33,4 +33,2 @@\n- * @run junit\/othervm -DDISABLE_PREVIEW_PATCHING=false PreviewJRTImage\n- * @run junit\/othervm -DDISABLE_PREVIEW_PATCHING=false --enable-preview PreviewJRTImage\n- * @run junit\/othervm -DDISABLE_PREVIEW_PATCHING=true PreviewJRTImage\n- * @run junit\/othervm -DDISABLE_PREVIEW_PATCHING=true --enable-preview PreviewJRTImage\n+ * @run junit\/othervm PreviewJRTImage\n+ * @run junit\/othervm --enable-preview PreviewJRTImage\n","filename":"test\/langtools\/tools\/javac\/preview\/PreviewJRTImage.java","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"}]}