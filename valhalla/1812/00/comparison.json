{"files":[{"patch":"@@ -514,1 +514,1 @@\n-      __ ldr(rscratch1, Address(rscratch1, InstanceKlass::adr_inlineklass_fixed_block_offset()));\n+      __ ldr(rscratch1, Address(rscratch1, InlineKlass::adr_members_offset()));\n","filename":"src\/hotspot\/cpu\/aarch64\/c1_LIRAssembler_aarch64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -774,1 +774,1 @@\n-    ldr(rscratch1, Address(rscratch1, InstanceKlass::adr_inlineklass_fixed_block_offset()));\n+    ldr(rscratch1, Address(rscratch1, InlineKlass::adr_members_offset()));\n","filename":"src\/hotspot\/cpu\/aarch64\/interp_masm_aarch64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -5545,1 +5545,1 @@\n-  ldr(offset, Address(inline_klass, InstanceKlass::adr_inlineklass_fixed_block_offset()));\n+  ldr(offset, Address(inline_klass, InlineKlass::adr_members_offset()));\n@@ -7039,1 +7039,1 @@\n-      ldr(tmp1, Address(klass, InstanceKlass::adr_inlineklass_fixed_block_offset()));\n+      ldr(tmp1, Address(klass, InlineKlass::adr_members_offset()));\n","filename":"src\/hotspot\/cpu\/aarch64\/macroAssembler_aarch64.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -407,1 +407,1 @@\n-      __ ldr(rscratch1, Address(rscratch1, InstanceKlass::adr_inlineklass_fixed_block_offset()));\n+      __ ldr(rscratch1, Address(rscratch1, InlineKlass::adr_members_offset()));\n","filename":"src\/hotspot\/cpu\/aarch64\/stubGenerator_aarch64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -511,1 +511,1 @@\n-      __ movptr(rdi, Address(rdi, InstanceKlass::adr_inlineklass_fixed_block_offset()));\n+      __ movptr(rdi, Address(rdi, InlineKlass::adr_members_offset()));\n","filename":"src\/hotspot\/cpu\/x86\/c1_LIRAssembler_x86.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1084,1 +1084,1 @@\n-    movptr(rdi, Address(rdi, InstanceKlass::adr_inlineklass_fixed_block_offset()));\n+    movptr(rdi, Address(rdi, InlineKlass::adr_members_offset()));\n","filename":"src\/hotspot\/cpu\/x86\/interp_masm_x86.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -5526,1 +5526,1 @@\n-  movptr(offset, Address(inline_klass, InstanceKlass::adr_inlineklass_fixed_block_offset()));\n+  movptr(offset, Address(inline_klass, InlineKlass::adr_members_offset()));\n@@ -5979,1 +5979,1 @@\n-      movptr(rbx, Address(klass, InstanceKlass::adr_inlineklass_fixed_block_offset()));\n+      movptr(rbx, Address(klass, InlineKlass::adr_members_offset()));\n","filename":"src\/hotspot\/cpu\/x86\/macroAssembler_x86.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -395,1 +395,1 @@\n-    __ movptr(rax, Address(rax, InstanceKlass::adr_inlineklass_fixed_block_offset()));\n+    __ movptr(rax, Address(rax, InlineKlass::adr_members_offset()));\n","filename":"src\/hotspot\/cpu\/x86\/stubGenerator_x86_64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -44,0 +44,1 @@\n+class SigEntry;\n","filename":"src\/hotspot\/share\/ci\/ciMethod.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -56,0 +56,17 @@\n+InlineKlass::Members::Members()\n+  : _extended_sig(nullptr),\n+    _return_regs(nullptr),\n+    _pack_handler(nullptr),\n+    _pack_handler_jobject(nullptr),\n+    _unpack_handler(nullptr),\n+    _null_reset_value_offset(0),\n+    _payload_offset(-1),\n+    _payload_size_in_bytes(-1),\n+    _payload_alignment(-1),\n+    _non_atomic_size_in_bytes(-1),\n+    _non_atomic_alignment(-1),\n+    _atomic_size_in_bytes(-1),\n+    _nullable_size_in_bytes(-1),\n+    _null_marker_offset(-1) {\n+}\n+\n@@ -60,1 +77,1 @@\n-  \/\/ Constructor\n+\/\/ Constructor\n@@ -66,2 +83,2 @@\n-  \/\/ Set up the offset to the InstanceKlassFixedBlock of this klass\n-  _adr_inlineklass_fixed_block = new (calculate_fixed_block_address()) InlineKlassFixedBlock;\n+  \/\/ Set up the offset to the members of this klass\n+  _adr_inline_klass_members = calculate_members_address();\n@@ -69,6 +86,2 @@\n-  \/\/ Addresses used for inline type calling convention\n-  set_extended_sig(nullptr);\n-  set_return_regs(nullptr);\n-  set_pack_handler(nullptr);\n-  set_pack_handler_jobject(nullptr);\n-  set_unpack_handler(nullptr);\n+  \/\/ Placement install the members\n+  new (_adr_inline_klass_members) Members();\n@@ -76,0 +89,1 @@\n+  \/\/ Sanity check construction of the members\n@@ -77,10 +91,0 @@\n-\n-  set_null_reset_value_offset(0);\n-  set_payload_offset(-1);\n-  set_payload_size_in_bytes(-1);\n-  set_payload_alignment(-1);\n-  set_non_atomic_size_in_bytes(-1);\n-  set_non_atomic_alignment(-1);\n-  set_atomic_size_in_bytes(-1);\n-  set_nullable_size_in_bytes(-1);\n-  set_null_marker_offset(-1);\n@@ -89,2 +93,2 @@\n-address InlineKlass::calculate_fixed_block_address() const {\n-  \/\/ The fix block is placed after all other fields inherited from the InstanceKlass\n+address InlineKlass::calculate_members_address() const {\n+  \/\/ The members are placed after all other contents inherited from the InstanceKlass\n@@ -440,1 +444,1 @@\n-    MetadataFactory::free_array<SigEntry>(loader_data, fixed_block()._extended_sig);\n+    MetadataFactory::free_array<SigEntry>(loader_data, members()._extended_sig);\n@@ -444,1 +448,1 @@\n-    MetadataFactory::free_array<VMRegPair>(loader_data, fixed_block()._return_regs);\n+    MetadataFactory::free_array<VMRegPair>(loader_data, members()._return_regs);\n@@ -662,2 +666,2 @@\n-  _adr_inlineklass_fixed_block = reinterpret_cast<InlineKlassFixedBlock*>(calculate_fixed_block_address());\n-  ArchivePtrMarker::mark_pointer((address*)&_adr_inlineklass_fixed_block);\n+  _adr_inline_klass_members = calculate_members_address();\n+  ArchivePtrMarker::mark_pointer(&_adr_inline_klass_members);\n","filename":"src\/hotspot\/share\/oops\/inlineKlass.cpp","additions":29,"deletions":25,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -35,0 +35,2 @@\n+class SigEntry;\n+\n@@ -46,0 +48,31 @@\n+  \/\/ The member fields of the InlineKlass.\n+  \/\/\n+  \/\/ The InstanceKlass objects have dynamic size because of vtables and other\n+  \/\/ features (see InstanceKlass::size). Therefore, we can't put C++ fields\n+  \/\/ directly into the InlineKlass class, but instead we stamp out a block of\n+  \/\/ these members after the part of the object that comes from the InstanceKlass.\n+  class Members {\n+    friend class InlineKlass;\n+\n+    \/\/ Addresses used for inline type calling convention\n+    Array<SigEntry>* _extended_sig;\n+    Array<VMRegPair>* _return_regs;\n+\n+    address _pack_handler;\n+    address _pack_handler_jobject;\n+    address _unpack_handler;\n+\n+    int _null_reset_value_offset;\n+    int _payload_offset;           \/\/ offset of the beginning of the payload in a heap buffered instance\n+    int _payload_size_in_bytes;    \/\/ size of payload layout\n+    int _payload_alignment;        \/\/ alignment required for payload\n+    int _non_atomic_size_in_bytes; \/\/ size of null-free non-atomic flat layout\n+    int _non_atomic_alignment;     \/\/ alignment requirement for null-free non-atomic layout\n+    int _atomic_size_in_bytes;     \/\/ size and alignment requirement for a null-free atomic layout, -1 if no atomic flat layout is possible\n+    int _nullable_size_in_bytes;   \/\/ size and alignment requirement for a nullable layout (always atomic), -1 if no nullable flat layout is possible\n+    int _null_marker_offset;       \/\/ expressed as an offset from the beginning of the object for a heap buffered value\n+                                   \/\/ payload_offset must be subtracted to get the offset from the beginning of the payload\n+\n+    Members();\n+  };\n+\n@@ -53,5 +86,2 @@\n-  \/\/ After the InstanceKlass part of the InlineKlass comes the\n-  \/\/ InlineKlassFixedBlock. It can't be instantiated as a field\n-  \/\/ because InstanceKlass instances have dynamic size.\n-\n-  address calculate_fixed_block_address() const;\n+  \/\/ Calculates where the members are supposed to be placed\n+  address calculate_members_address() const;\n@@ -59,3 +89,3 @@\n-  InlineKlassFixedBlock& fixed_block() {\n-    assert(_adr_inlineklass_fixed_block != 0, \"Should have been initialized\");\n-    return *_adr_inlineklass_fixed_block;\n+  Members& members() {\n+    assert(_adr_inline_klass_members != 0, \"Should have been initialized\");\n+    return *reinterpret_cast<Members*>(_adr_inline_klass_members);\n@@ -64,1 +94,1 @@\n-  inline const InlineKlassFixedBlock& fixed_block() const {\n+  inline const Members& members() const {\n@@ -66,1 +96,1 @@\n-    return const_cast<const InlineKlassFixedBlock&>(ik->fixed_block());\n+    return const_cast<const Members&>(ik->members());\n@@ -74,1 +104,1 @@\n-  \/\/ InlineKlassFixedBlock access functions\n+  \/\/ Members access functions\n@@ -76,2 +106,2 @@\n-  const Array<SigEntry>* extended_sig() const                 {return fixed_block()._extended_sig; }\n-  void set_extended_sig(Array<SigEntry>* extended_sig)        { fixed_block()._extended_sig = extended_sig; }\n+  const Array<SigEntry>* extended_sig() const                 {return members()._extended_sig; }\n+  void set_extended_sig(Array<SigEntry>* extended_sig)        { members()._extended_sig = extended_sig; }\n@@ -79,2 +109,2 @@\n-  const Array<VMRegPair>* return_regs() const                 { return fixed_block()._return_regs; }\n-  void set_return_regs(Array<VMRegPair>* return_regs)         { fixed_block()._return_regs = return_regs; }\n+  const Array<VMRegPair>* return_regs() const                 { return members()._return_regs; }\n+  void set_return_regs(Array<VMRegPair>* return_regs)         { members()._return_regs = return_regs; }\n@@ -84,2 +114,2 @@\n-  address pack_handler() const                                { return fixed_block()._pack_handler; }\n-  void set_pack_handler(address pack_handler)                 { fixed_block()._pack_handler = pack_handler; }\n+  address pack_handler() const                                { return members()._pack_handler; }\n+  void set_pack_handler(address pack_handler)                 { members()._pack_handler = pack_handler; }\n@@ -87,2 +117,2 @@\n-  address pack_handler_jobject() const                        { return fixed_block()._pack_handler_jobject; }\n-  void set_pack_handler_jobject(address pack_handler_jobject) { fixed_block()._pack_handler_jobject = pack_handler_jobject; }\n+  address pack_handler_jobject() const                        { return members()._pack_handler_jobject; }\n+  void set_pack_handler_jobject(address pack_handler_jobject) { members()._pack_handler_jobject = pack_handler_jobject; }\n@@ -90,2 +120,2 @@\n-  address unpack_handler() const                              { return fixed_block()._unpack_handler; }\n-  void set_unpack_handler(address unpack_handler)             { fixed_block()._unpack_handler = unpack_handler; }\n+  address unpack_handler() const                              { return members()._unpack_handler; }\n+  void set_unpack_handler(address unpack_handler)             { members()._unpack_handler = unpack_handler; }\n@@ -94,1 +124,1 @@\n-    int offset = fixed_block()._null_reset_value_offset;\n+    int offset = members()._null_reset_value_offset;\n@@ -98,1 +128,1 @@\n-  void set_null_reset_value_offset(int offset)                { fixed_block()._null_reset_value_offset = offset; }\n+  void set_null_reset_value_offset(int offset)                { members()._null_reset_value_offset = offset; }\n@@ -101,1 +131,1 @@\n-    int offset = fixed_block()._payload_offset;\n+    int offset = members()._payload_offset;\n@@ -105,1 +135,1 @@\n-  void set_payload_offset(int offset)                         { fixed_block()._payload_offset = offset; }\n+  void set_payload_offset(int offset)                         { members()._payload_offset = offset; }\n@@ -107,2 +137,2 @@\n-  int payload_size_in_bytes() const                           { return fixed_block()._payload_size_in_bytes; }\n-  void set_payload_size_in_bytes(int payload_size)            { fixed_block()._payload_size_in_bytes = payload_size; }\n+  int payload_size_in_bytes() const                           { return members()._payload_size_in_bytes; }\n+  void set_payload_size_in_bytes(int payload_size)            { members()._payload_size_in_bytes = payload_size; }\n@@ -110,2 +140,2 @@\n-  int payload_alignment() const                               { return fixed_block()._payload_alignment; }\n-  void set_payload_alignment(int alignment)                   { fixed_block()._payload_alignment = alignment; }\n+  int payload_alignment() const                               { return members()._payload_alignment; }\n+  void set_payload_alignment(int alignment)                   { members()._payload_alignment = alignment; }\n@@ -113,2 +143,2 @@\n-  int non_atomic_size_in_bytes() const                        { return fixed_block()._non_atomic_size_in_bytes; }\n-  void set_non_atomic_size_in_bytes(int size)                 { fixed_block()._non_atomic_size_in_bytes = size; }\n+  int non_atomic_size_in_bytes() const                        { return members()._non_atomic_size_in_bytes; }\n+  void set_non_atomic_size_in_bytes(int size)                 { members()._non_atomic_size_in_bytes = size; }\n@@ -117,2 +147,2 @@\n-  int non_atomic_alignment() const                            { return fixed_block()._non_atomic_alignment; }\n-  void set_non_atomic_alignment(int alignment)                { fixed_block()._non_atomic_alignment = alignment; }\n+  int non_atomic_alignment() const                            { return members()._non_atomic_alignment; }\n+  void set_non_atomic_alignment(int alignment)                { members()._non_atomic_alignment = alignment; }\n@@ -120,2 +150,2 @@\n-  int atomic_size_in_bytes() const                            { return fixed_block()._atomic_size_in_bytes; }\n-  void set_atomic_size_in_bytes(int size)                     { fixed_block()._atomic_size_in_bytes = size; }\n+  int atomic_size_in_bytes() const                            { return members()._atomic_size_in_bytes; }\n+  void set_atomic_size_in_bytes(int size)                     { members()._atomic_size_in_bytes = size; }\n@@ -125,2 +155,2 @@\n-  int nullable_atomic_size_in_bytes() const                   { return fixed_block()._nullable_size_in_bytes; }\n-  void set_nullable_size_in_bytes(int size)                   { fixed_block()._nullable_size_in_bytes = size; }\n+  int nullable_atomic_size_in_bytes() const                   { return members()._nullable_size_in_bytes; }\n+  void set_nullable_size_in_bytes(int size)                   { members()._nullable_size_in_bytes = size; }\n@@ -129,2 +159,2 @@\n-  int null_marker_offset() const                              { return fixed_block()._null_marker_offset; }\n-  void set_null_marker_offset(int offset)                     { fixed_block()._null_marker_offset = offset; }\n+  int null_marker_offset() const                              { return members()._null_marker_offset; }\n+  void set_null_marker_offset(int offset)                     { members()._null_marker_offset = offset; }\n@@ -230,0 +260,4 @@\n+  static ByteSize adr_members_offset() {\n+    return InstanceKlass::adr_inline_klass_members_offset();\n+  }\n+\n@@ -233,1 +267,1 @@\n-    return byte_offset_of(InlineKlassFixedBlock, _pack_handler);\n+    return byte_offset_of(Members, _pack_handler);\n@@ -237,1 +271,1 @@\n-    return byte_offset_of(InlineKlassFixedBlock, _pack_handler_jobject);\n+    return byte_offset_of(Members, _pack_handler_jobject);\n@@ -241,1 +275,1 @@\n-    return byte_offset_of(InlineKlassFixedBlock, _unpack_handler);\n+    return byte_offset_of(Members, _unpack_handler);\n@@ -245,1 +279,1 @@\n-    return byte_offset_of(InlineKlassFixedBlock, _null_reset_value_offset);\n+    return byte_offset_of(Members, _null_reset_value_offset);\n@@ -249,1 +283,1 @@\n-    return byte_offset_of(InlineKlassFixedBlock, _payload_offset);\n+    return byte_offset_of(Members, _payload_offset);\n@@ -253,1 +287,1 @@\n-    return byte_offset_of(InlineKlassFixedBlock, _null_marker_offset);\n+    return byte_offset_of(Members, _null_marker_offset);\n","filename":"src\/hotspot\/share\/oops\/inlineKlass.hpp","additions":79,"deletions":45,"binary":false,"changes":124,"status":"modified"},{"patch":"@@ -600,1 +600,1 @@\n-  _adr_inlineklass_fixed_block(nullptr)\n+  _adr_inline_klass_members(nullptr)\n@@ -842,0 +842,22 @@\n+\/\/ Static size helper\n+int InstanceKlass::size(int vtable_length,\n+                        int itable_length,\n+                        int nonstatic_oop_map_size,\n+                        bool is_interface,\n+                        bool is_inline_type) {\n+  return align_metadata_size(header_size() +\n+         vtable_length +\n+         itable_length +\n+         nonstatic_oop_map_size +\n+         (is_interface ? (int)sizeof(Klass*) \/ wordSize : 0) +\n+         (is_inline_type ? (int)sizeof(InlineKlass::Members) \/ wordSize : 0));\n+}\n+\n+int InstanceKlass::size() const {\n+  return size(vtable_length(),\n+              itable_length(),\n+              nonstatic_oop_map_size(),\n+              is_interface(),\n+              is_inline_klass());\n+}\n+\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.cpp","additions":23,"deletions":1,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -141,22 +141,0 @@\n-class SigEntry;\n-\n-class InlineKlassFixedBlock {\n-  friend class InlineKlass;\n-\n-  Array<SigEntry>* _extended_sig;\n-  Array<VMRegPair>* _return_regs;\n-  address _pack_handler;\n-  address _pack_handler_jobject;\n-  address _unpack_handler;\n-  int _null_reset_value_offset;\n-  int _payload_offset;           \/\/ offset of the begining of the payload in a heap buffered instance\n-  int _payload_size_in_bytes;    \/\/ size of payload layout\n-  int _payload_alignment;        \/\/ alignment required for payload\n-  int _non_atomic_size_in_bytes; \/\/ size of null-free non-atomic flat layout\n-  int _non_atomic_alignment;     \/\/ alignment requirement for null-free non-atomic layout\n-  int _atomic_size_in_bytes;     \/\/ size and alignment requirement for a null-free atomic layout, -1 if no atomic flat layout is possible\n-  int _nullable_size_in_bytes;   \/\/ size and alignment requirement for a nullable layout (always atomic), -1 if no nullable flat layout is possible\n-  int _null_marker_offset;       \/\/ expressed as an offset from the beginning of the object for a heap buffered value\n-                                 \/\/ payload_offset must be subtracted to get the offset from the beginning of the payload\n-};\n-\n@@ -348,2 +326,2 @@\n-  \/\/ Located here because sub-klasses can't have their own explicit fields\n-  InlineKlassFixedBlock* _adr_inlineklass_fixed_block;\n+  \/\/ Located here because sub-klasses can't have their own C++ fields\n+  address _adr_inline_klass_members;\n@@ -980,1 +958,1 @@\n-  static ByteSize adr_inlineklass_fixed_block_offset() { return in_ByteSize(offset_of(InstanceKlass, _adr_inlineklass_fixed_block)); }\n+  static ByteSize adr_inline_klass_members_offset() { return in_ByteSize(offset_of(InstanceKlass, _adr_inline_klass_members)); }\n@@ -1043,1 +1021,2 @@\n-  static int size(int vtable_length, int itable_length,\n+  static int size(int vtable_length,\n+                  int itable_length,\n@@ -1046,15 +1025,1 @@\n-                  bool is_inline_type) {\n-    return align_metadata_size(header_size() +\n-           vtable_length +\n-           itable_length +\n-           nonstatic_oop_map_size +\n-           (is_interface ? (int)sizeof(Klass*) \/ wordSize : 0) +\n-           (is_inline_type ? (int)sizeof(InlineKlassFixedBlock) \/ wordSize : 0));\n-  }\n-\n-  int size() const override           { return size(vtable_length(),\n-                                               itable_length(),\n-                                               nonstatic_oop_map_size(),\n-                                               is_interface(),\n-                                               is_inline_klass());\n-  }\n+                  bool is_inline_type);\n@@ -1062,0 +1027,1 @@\n+  int size() const override;\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.hpp","additions":7,"deletions":41,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -2743,2 +2743,2 @@\n-    Node* fixed_block  = make_load(fast_oop_ctrl, fast_oop_rawmem, klass_node, in_bytes(InstanceKlass::adr_inlineklass_fixed_block_offset()), TypeRawPtr::BOTTOM, T_ADDRESS);\n-    Node* pack_handler = make_load(fast_oop_ctrl, fast_oop_rawmem, fixed_block, in_bytes(InlineKlass::pack_handler_offset()), TypeRawPtr::BOTTOM, T_ADDRESS);\n+    Node* members  = make_load(fast_oop_ctrl, fast_oop_rawmem, klass_node, in_bytes(InlineKlass::adr_members_offset()), TypeRawPtr::BOTTOM, T_ADDRESS);\n+    Node* pack_handler = make_load(fast_oop_ctrl, fast_oop_rawmem, members, in_bytes(InlineKlass::pack_handler_offset()), TypeRawPtr::BOTTOM, T_ADDRESS);\n","filename":"src\/hotspot\/share\/opto\/macro.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -572,0 +572,1 @@\n+class SigEntry;\n","filename":"src\/hotspot\/share\/runtime\/signature.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}