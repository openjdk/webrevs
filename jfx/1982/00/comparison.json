{"files":[{"patch":"@@ -66,0 +66,15 @@\n+namespace\n+{\n+    BOOL GetExtendedFrameBounds(HWND hwnd, RECT* r) {\n+        if (r == NULL) {\n+            return FALSE;\n+        }\n+\n+        if (FAILED(::DwmGetWindowAttribute(hwnd, DWMWA_EXTENDED_FRAME_BOUNDS, r, sizeof(RECT)))) {\n+            return ::GetWindowRect(hwnd, r);\n+        }\n+\n+        return TRUE;\n+    }\n+}\n+\n@@ -321,2 +336,2 @@\n-                HandleMoveEvent(NULL);\n-                HandleSizeEvent(com_sun_glass_events_WindowEvent_RESIZE, NULL);\n+                HandleMoveEvent();\n+                HandleSizeEvent(com_sun_glass_events_WindowEvent_RESIZE);\n@@ -353,1 +368,1 @@\n-                        HandleSizeEvent(com_sun_glass_events_WindowEvent_RESTORE, NULL);\n+                        HandleSizeEvent(com_sun_glass_events_WindowEvent_RESTORE);\n@@ -356,1 +371,1 @@\n-                        HandleSizeEvent(com_sun_glass_events_WindowEvent_RESIZE, NULL);\n+                        HandleSizeEvent(com_sun_glass_events_WindowEvent_RESIZE);\n@@ -360,1 +375,1 @@\n-                    HandleSizeEvent(com_sun_glass_events_WindowEvent_MINIMIZE, NULL);\n+                    HandleSizeEvent(com_sun_glass_events_WindowEvent_MINIMIZE);\n@@ -364,1 +379,1 @@\n-                    HandleSizeEvent(com_sun_glass_events_WindowEvent_MAXIMIZE, NULL);\n+                    HandleSizeEvent(com_sun_glass_events_WindowEvent_MAXIMIZE);\n@@ -380,1 +395,1 @@\n-                HandleMoveEvent(NULL);\n+                HandleMoveEvent();\n@@ -435,0 +450,7 @@\n+                int extraW = 0, extraH = 0;\n+                RECT shadowBounds, extBounds;\n+                if (GetWindowRect(GetHWND(), &shadowBounds) && GetExtendedFrameBounds(GetHWND(), &extBounds)) {\n+                    extraW = (extBounds.left - shadowBounds.left) + (shadowBounds.right - extBounds.right);\n+                    extraH = (extBounds.top - shadowBounds.top) + (shadowBounds.bottom - extBounds.bottom);\n+                }\n+\n@@ -437,1 +459,1 @@\n-                    info->ptMinTrackSize.x = m_minSize.x;\n+                    info->ptMinTrackSize.x = m_minSize.x + extraW;\n@@ -440,1 +462,1 @@\n-                    info->ptMinTrackSize.y = m_minSize.y;\n+                    info->ptMinTrackSize.y = m_minSize.y + extraH;\n@@ -443,1 +465,1 @@\n-                    info->ptMaxTrackSize.x = m_maxSize.x;\n+                    info->ptMaxTrackSize.x = m_maxSize.x + extraW;\n@@ -446,1 +468,1 @@\n-                    info->ptMaxTrackSize.y = m_maxSize.y;\n+                    info->ptMaxTrackSize.y = m_maxSize.y + extraH;\n@@ -789,2 +811,1 @@\n-\/\/ if pRect == NULL => get position\/size by GetWindowRect\n-void GlassWindow::HandleMoveEvent(RECT *pRect)\n+void GlassWindow::HandleMoveEvent()\n@@ -793,1 +814,0 @@\n-\n@@ -795,4 +815,0 @@\n-    if (pRect == NULL) {\n-        ::GetWindowRect(GetHWND(), &r);\n-        pRect = &r;\n-    }\n@@ -800,2 +816,4 @@\n-    env->CallVoidMethod(m_grefThis, midNotifyMove, pRect->left, pRect->top);\n-    CheckAndClearException(env);\n+    if (GetExtendedFrameBounds(GetHWND(), &r)) {\n+        env->CallVoidMethod(m_grefThis, midNotifyMove, r.left, r.top);\n+        CheckAndClearException(env);\n+    }\n@@ -804,2 +822,1 @@\n-\/\/ if pRect == NULL => get position\/size by GetWindowRect\n-void GlassWindow::HandleSizeEvent(int type, RECT *pRect)\n+void GlassWindow::HandleSizeEvent(int type)\n@@ -808,1 +825,0 @@\n-\n@@ -810,4 +826,0 @@\n-    if (pRect == NULL) {\n-        ::GetWindowRect(GetHWND(), &r);\n-        pRect = &r;\n-    }\n@@ -815,3 +827,4 @@\n-    env->CallVoidMethod(m_grefThis, midNotifyResize,\n-                        type, pRect->right-pRect->left, pRect->bottom-pRect->top);\n-    CheckAndClearException(env);\n+    if (GetExtendedFrameBounds(GetHWND(), &r)) {\n+        env->CallVoidMethod(m_grefThis, midNotifyResize, type, r.right - r.left, r.bottom - r.top);\n+        CheckAndClearException(env);\n+    }\n@@ -994,2 +1007,2 @@\n-    ::GetWindowRect(GetHWND(), &outer);\n-    ::GetClientRect(GetHWND(), &inner);\n+    \/\/ Clear last error because the return value of MapWindowPoints is not sufficient to detect failure\n+    SetLastError(0);\n@@ -997,1 +1010,5 @@\n-    ::MapWindowPoints(GetHWND(), (HWND)NULL, (LPPOINT)&inner, (sizeof(RECT)\/sizeof(POINT)));\n+    if (!GetClientRect(GetHWND(), &inner) ||\n+            !GetExtendedFrameBounds(GetHWND(), &outer) ||\n+            (MapWindowPoints(GetHWND(), (HWND)NULL, (LPPOINT)&inner, 2) == 0 && GetLastError() != 0)) {\n+        return;\n+    }\n@@ -1844,2 +1861,4 @@\n-        RECT r;\n-        ::GetWindowRect(hWnd, &r);\n+        RECT shadowBounds = {};\n+        if (!GetWindowRect(hWnd, &shadowBounds)) {\n+            return;\n+        }\n@@ -1847,2 +1866,7 @@\n-        int newX = jbool_to_bool(xSet) ? x : r.left;\n-        int newY = jbool_to_bool(ySet) ? y : r.top;\n+        RECT extBounds = {};\n+        if (!GetExtendedFrameBounds(hWnd, &extBounds)) {\n+            return;\n+        }\n+\n+        int newX = jbool_to_bool(xSet) ? x : extBounds.left;\n+        int newY = jbool_to_bool(ySet) ? y : extBounds.top;\n@@ -1850,1 +1874,1 @@\n-                       cw > 0 ? cw + is.right + is.left : r.right - r.left;\n+                       cw > 0 ? cw + is.right + is.left : extBounds.right - extBounds.left;\n@@ -1852,1 +1876,1 @@\n-                       ch > 0 ? ch + is.bottom + is.top : r.bottom - r.top;\n+                       ch > 0 ? ch + is.bottom + is.top : extBounds.bottom - extBounds.top;\n@@ -1861,0 +1885,9 @@\n+        int shadowL = extBounds.left - shadowBounds.left;\n+        int shadowR = shadowBounds.right - extBounds.right;\n+        int shadowT = extBounds.top - shadowBounds.top;\n+        int shadowB = shadowBounds.bottom - extBounds.bottom;\n+        newX = newX - shadowL;\n+        newY = newY - shadowT;\n+        newW = newW + shadowL + shadowR;\n+        newH = newH + shadowT + shadowB;\n+\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/GlassWindow.cpp","additions":72,"deletions":39,"binary":false,"changes":111,"status":"modified"},{"patch":"@@ -183,1 +183,0 @@\n-    \/\/ if pRect == NULL => get position\/size by GetWindowRect\n@@ -185,3 +184,2 @@\n-    void HandleMoveEvent(RECT *pRect);\n-    \/\/ if pRect == NULL => get position\/size by GetWindowRect\n-    void HandleSizeEvent(int type, RECT *pRect);\n+    void HandleMoveEvent();\n+    void HandleSizeEvent(int type);\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/GlassWindow.h","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"}]}