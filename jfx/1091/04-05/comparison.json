{"files":[{"patch":"@@ -87,0 +87,16 @@\n+ *\n+ * Steps for testTextFlowInsertionIndexWhenMouseMovedOutsideText()\n+ * 1. Create a TextFlow. Add a Text node with text and emojis.\n+ * 2. Move the cursor to the first character and click.\n+ * 3. Insertion index should be same as character index.\n+ * 4. Move the cursor towards bottom of the application window check that\n+ *    chracter index and insertion index are as expected.\n+ * This test is implemented to test insertion index initialization\n+ * when text run is not used to calculate character index.\n+ *\n+ * Steps for testTextFlowInsertionIndexUsingWrappedText()\n+ * 1. Create a TextFlow. Add a Text node with text and emojis whose length is\n+ *    more than the size of application window.\n+ * 2. Move the cursor from first character to last character.\n+ * 3. Character index should increase monotonically as expected.\n+ * 4. Insertion index should also increase as expected along with character index.\n@@ -100,0 +116,3 @@\n+    static final int WIDTH = 500;\n+    static final int HEIGHT = 150;\n+\n@@ -105,0 +124,1 @@\n+    boolean isSurrogatePair;\n@@ -119,15 +139,1 @@\n-    private void moveMouseToLeadingSide() throws Exception {\n-        mouseClickLatch = new CountDownLatch(1);\n-        mouseClick(textFlow.getLayoutX() + X_LEADING_OFFSET,\n-                    textFlow.getLayoutY() + Y_OFFSET);\n-        Util.waitForLatch(mouseClickLatch, 5, \"Timeout waiting for mouse click\");\n-    }\n-\n-    private void moveMouseToTrailingSide() throws Exception {\n-        mouseClickLatch = new CountDownLatch(1);\n-        mouseClick(textFlow.getLayoutX() + X_TRAILING_OFFSET,\n-                    textFlow.getLayoutY() + Y_OFFSET);\n-        Util.waitForLatch(mouseClickLatch, 5, \"Timeout waiting for mouse click\");\n-    }\n-\n-    private void moveMouseByPixel(int c) throws Exception {\n+    private void moveMouseOverTextFlow(int x, int y) throws Exception {\n@@ -135,9 +141,2 @@\n-        mouseClick(textFlow.getLayoutX() + X_LEADING_OFFSET + c,\n-                    textFlow.getLayoutY() + Y_OFFSET);\n-        Util.waitForLatch(mouseClickLatch, 5, \"Timeout waiting for mouse click\");\n-    }\n-\n-    private void moveMouseVertically(int x, int y) throws Exception {\n-        mouseClickLatch = new CountDownLatch(1);\n-        mouseClick(textFlow.getLayoutX() + X_LEADING_OFFSET + x,\n-                    textFlow.getLayoutY() + Y_OFFSET + y);\n+        mouseClick(textFlow.getLayoutX() + x,\n+                    textFlow.getLayoutY() + y);\n@@ -203,0 +202,14 @@\n+    private void addLongText() {\n+        textSetLatch = new CountDownLatch(1);\n+        Util.runAndWait(() -> {\n+            text = new Text(\"[This is text ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜† ğŸ™‚ğŸ™ƒğŸ˜‰ğŸ˜ŠğŸ˜‡]\");\n+            text.setFont(new Font(48));\n+\n+            textFlow.getChildren().clear();\n+            textFlow.getChildren().setAll(text);\n+\n+            textSetLatch.countDown();\n+        });\n+        Util.waitForLatch(textSetLatch, 5, \"Timeout waiting for text intialization.\");\n+    }\n+\n@@ -206,1 +219,3 @@\n-        moveMouseToLeadingSide();\n+        Thread.sleep(500);\n+\n+        moveMouseOverTextFlow(X_LEADING_OFFSET, Y_OFFSET);\n@@ -210,1 +225,1 @@\n-        moveMouseToTrailingSide();\n+        moveMouseOverTextFlow(X_TRAILING_OFFSET, Y_OFFSET);\n@@ -218,0 +233,1 @@\n+        Thread.sleep(500);\n@@ -221,1 +237,0 @@\n-        Thread.sleep(500);\n@@ -223,1 +238,1 @@\n-            moveMouseByPixel(index);\n+            moveMouseOverTextFlow(index, Y_OFFSET);\n@@ -236,0 +251,1 @@\n+        Thread.sleep(500);\n@@ -240,1 +256,1 @@\n-            moveMouseByPixel(index);\n+            moveMouseOverTextFlow(index, Y_OFFSET);\n@@ -255,0 +271,1 @@\n+        Thread.sleep(500);\n@@ -260,2 +277,2 @@\n-            moveMouseByPixel(index);\n-            if(isLeading) {\n+            moveMouseOverTextFlow(index, Y_OFFSET);\n+            if (isLeading) {\n@@ -263,3 +280,1 @@\n-            } else if (!isLeading && charIndex < 4) {\n-                Assert.assertEquals(charIndex, insertionIndex - 1);\n-            } else {\n+            } else if (isSurrogatePair) {\n@@ -267,0 +282,2 @@\n+            } else {\n+                Assert.assertEquals(charIndex, insertionIndex - 1);\n@@ -275,0 +292,1 @@\n+        Thread.sleep(500);\n@@ -277,3 +295,3 @@\n-        while (index < (2 * Y_OFFSET)) {\n-            moveMouseVertically(X_LEADING_OFFSET, index);\n-            if(isLeading) {\n+        while (index < (HEIGHT - Y_OFFSET)) {\n+            moveMouseOverTextFlow(X_LEADING_OFFSET, (Y_OFFSET + index));\n+            if (isLeading) {\n@@ -288,0 +306,19 @@\n+    @Test\n+    public void testTextFlowInsertionIndexUsingWrappedText() throws Exception {\n+        addLongText();\n+        Thread.sleep(500);\n+\n+        for (int y = 0; y < 2; y++) {\n+            for (int x = 0; x < (WIDTH - X_LEADING_OFFSET); x += 5) {\n+                moveMouseOverTextFlow(x, (Y_OFFSET + (Y_OFFSET * (y * 2))));\n+                if (isLeading) {\n+                    Assert.assertEquals(charIndex, insertionIndex);\n+                } else if (isSurrogatePair) {\n+                    Assert.assertEquals(charIndex, insertionIndex - 2);\n+                } else {\n+                    Assert.assertEquals(charIndex, insertionIndex - 1);\n+                }\n+            }\n+        }\n+    }\n+\n@@ -294,0 +331,9 @@\n+\n+        String testString = text.getText();\n+        if (charIndex >= testString.length() && emoji != null) {\n+            testString += emoji.getText();\n+        }\n+        if (charIndex < testString.length()) {\n+            char c = testString.charAt(charIndex);\n+            isSurrogatePair = Character.isSurrogate(c);\n+        }\n@@ -327,1 +373,1 @@\n-            scene = new Scene(textFlow, 500, 100);\n+            scene = new Scene(textFlow, WIDTH, HEIGHT);\n","filename":"tests\/system\/src\/test\/java\/test\/robot\/javafx\/scene\/TextFlowSurrogatePairInsertionIndexTest.java","additions":84,"deletions":38,"binary":false,"changes":122,"status":"modified"}]}