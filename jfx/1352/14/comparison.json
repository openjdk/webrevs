{"files":[{"patch":"@@ -29,0 +29,2 @@\n+\n+import javafx.application.Platform;\n@@ -1000,0 +1002,13 @@\n+\n+    \/**\n+     * Ensures that a code segment is run on the FX thread.\n+     *\n+     * @param runnable a {@code Runnable} encapsulating the code\n+     *\/\n+    public static void runOnFxThread(Runnable runnable) {\n+        if (Platform.isFxApplicationThread()) {\n+            runnable.run();\n+        } else {\n+            Platform.runLater(runnable);\n+        }\n+    }\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/util\/Utils.java","additions":15,"deletions":0,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -886,0 +886,3 @@\n+     * <p>\n+     * Note: if this method is not called on the JavaFX Application Thread, it is delegated to it automatically.\n+     * In this case, the call is asynchronous and may not happen immediately.\n@@ -897,0 +900,12 @@\n+        if (parent != null) {\n+            throw new IllegalStateException(\"Cannot start when embedded in another animation\");\n+        }\n+        Utils.runOnFxThread(() -> playFromImpl(cuePoint));\n+    }\n+\n+    \/**\n+     * This method must be run on the JavaFX Application Thread.\n+     *\n+     * @see #playFrom(String)\n+     *\/\n+    private void playFromImpl(String cuePoint) {\n@@ -914,0 +929,3 @@\n+     * <p>\n+     * Note: if this method is not called on the JavaFX Application Thread, it is delegated to it automatically.\n+     * In this case, the call is asynchronous and may not happen immediately.\n@@ -926,0 +944,12 @@\n+        if (parent != null) {\n+            throw new IllegalStateException(\"Cannot start when embedded in another animation\");\n+        }\n+        Utils.runOnFxThread(() -> playFromImpl(time));\n+    }\n+\n+    \/**\n+     * This method must be run on the JavaFX Application Thread.\n+     *\n+     * @see #playFrom(Duration)\n+     *\/\n+    private void playFromImpl(Duration time) {\n@@ -941,1 +971,0 @@\n-     *\n@@ -943,3 +972,2 @@\n-     * Note: <ul>\n-     * <li>{@code playFromStart()} is an asynchronous call, {@code Animation} may\n-     * not start immediately. <\/ul>\n+     * Note: if this method is not called on the JavaFX Application Thread, it is delegated to it automatically.\n+     * In this case, the call is asynchronous and may not happen immediately.\n@@ -952,0 +980,12 @@\n+        if (parent != null) {\n+            throw new IllegalStateException(\"Cannot start when embedded in another animation\");\n+        }\n+        Utils.runOnFxThread(this::playFromStartImpl);\n+    }\n+\n+    \/**\n+     * This method must be run on the JavaFX Application Thread.\n+     *\n+     * @see #playFromStart()\n+     *\/\n+    private void playFromStartImpl() {\n@@ -979,5 +1019,2 @@\n-     * Note: <ul>\n-     * <li>{@code play()} is an asynchronous call, the {@code Animation} may not\n-     * start immediately. <\/ul>\n-     * <p>\n-     * This method must be called on the JavaFX Application thread.\n+     * Note: if this method is not called on the JavaFX Application Thread, it is delegated to it automatically.\n+     * In this case, the call is asynchronous and may not happen immediately.\n@@ -985,2 +1022,1 @@\n-     * @throws IllegalStateException if this method is called on a thread\n-     *                other than the JavaFX Application Thread, or if embedded in another animation,\n+     * @throws IllegalStateException if embedded in another animation,\n@@ -990,1 +1026,0 @@\n-        Toolkit.getToolkit().checkFxUserThread();\n@@ -994,0 +1029,9 @@\n+        Utils.runOnFxThread(this::playImpl);\n+    }\n+\n+    \/**\n+     * This method must be run on the JavaFX Application Thread.\n+     *\n+     * @see #play()\n+     *\/\n+    private void playImpl() {\n@@ -1039,5 +1083,2 @@\n-     * Note: <ul>\n-     * <li>{@code stop()} is an asynchronous call, the {@code Animation} may not stop\n-     * immediately. <\/ul>\n-     * <p>\n-     * This method must be called on the JavaFX Application thread.\n+     * Note: if this method is not called on the JavaFX Application Thread, it is delegated to it automatically.\n+     * In this case, the call is asynchronous and may not happen immediately.\n@@ -1045,2 +1086,1 @@\n-     * @throws IllegalStateException if this method is called on a thread\n-     *                other than the JavaFX Application Thread, or if embedded in another animation,\n+     * @throws IllegalStateException if embedded in another animation,\n@@ -1050,1 +1090,0 @@\n-        Toolkit.getToolkit().checkFxUserThread();\n@@ -1054,0 +1093,10 @@\n+        Utils.runOnFxThread(this::stopImpl);\n+    }\n+\n+    \/**\n+     * This method must be run on the JavaFX Application Thread.\n+     *\n+     * @see #stop()\n+     *\/\n+    \/\/ package-private for Timeline\n+    void stopImpl() {\n@@ -1074,5 +1123,2 @@\n-     * Note: <ul>\n-     * <li>{@code pause()} is an asynchronous call, the {@code Animation} may not pause\n-     * immediately. <\/ul>\n-     * <p>\n-     * This method must be called on the JavaFX Application thread.\n+     * Note: if this method is not called on the JavaFX Application Thread, it is delegated to it automatically.\n+     * In this case, the call is asynchronous and may not happen immediately.\n@@ -1080,2 +1126,1 @@\n-     * @throws IllegalStateException if this method is called on a thread\n-     *                other than the JavaFX Application Thread, or if embedded in another animation,\n+     * @throws IllegalStateException if embedded in another animation,\n@@ -1085,1 +1130,0 @@\n-        Toolkit.getToolkit().checkFxUserThread();\n@@ -1089,0 +1133,9 @@\n+        Utils.runOnFxThread(this::pauseImpl);\n+    }\n+\n+    \/**\n+     * This method must be run on the JavaFX Application Thread.\n+     *\n+     * @see #pause()\n+     *\/\n+    private void pauseImpl() {\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/animation\/Animation.java","additions":81,"deletions":28,"binary":false,"changes":109,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import com.sun.javafx.util.Utils;\n@@ -103,1 +104,9 @@\n-     * This method must be called on the JavaFX Application thread.\n+     * Note: if this method is not called on the JavaFX Application Thread, it is delegated to it automatically.\n+     * In this case, the call is asynchronous and may not happen immediately.\n+     *\/\n+    public void start() {\n+        Utils.runOnFxThread(this::startImpl);\n+    }\n+\n+    \/**\n+     * This method must be run on the JavaFX Application Thread.\n@@ -105,2 +114,1 @@\n-     * @throws IllegalStateException if this method is called on a thread\n-     *                  other than the JavaFX Application Thread.\n+     * @see #start()\n@@ -109,2 +117,1 @@\n-    public void start() {\n-        Toolkit.getToolkit().checkFxUserThread();\n+    private void startImpl() {\n@@ -123,4 +130,2 @@\n-     * This method must be called on the JavaFX Application thread.\n-     *\n-     * @throws IllegalStateException if this method is called on a thread\n-     *                  other than the JavaFX Application Thread.\n+     * Note: if this method is not called on the JavaFX Application Thread, it is delegated to it automatically.\n+     * In this case, the call is asynchronous and may not happen immediately.\n@@ -129,1 +134,9 @@\n-        Toolkit.getToolkit().checkFxUserThread();\n+        Utils.runOnFxThread(this::stopImpl);\n+    }\n+\n+    \/**\n+     * This method must be run on the JavaFX Application Thread.\n+     *\n+     * @see #stop()\n+     *\/\n+    private void stopImpl() {\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/animation\/AnimationTimer.java","additions":23,"deletions":10,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -194,3 +194,0 @@\n-    \/**\n-     * {@inheritDoc}\n-     *\/\n@@ -198,1 +195,1 @@\n-    public void stop() {\n+    void stopImpl() {\n@@ -205,1 +202,1 @@\n-        super.stop();\n+        super.stopImpl();\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/animation\/Timeline.java","additions":2,"deletions":5,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,4 +28,4 @@\n-import javafx.animation.PauseTransition;\n-import javafx.application.Application;\n-import javafx.application.Platform;\n-import javafx.stage.Stage;\n+import org.junit.jupiter.api.Test;\n+\n+import javafx.animation.Animation;\n+import javafx.animation.StrokeTransition;\n@@ -33,3 +33,0 @@\n-import org.junit.AfterClass;\n-import org.junit.BeforeClass;\n-import org.junit.Test;\n@@ -38,38 +35,1 @@\n-import java.util.concurrent.CountDownLatch;\n-\n-import static org.junit.Assert.assertFalse;\n-import static org.junit.Assert.assertTrue;\n-import static org.junit.jupiter.api.Assertions.assertThrows;\n-\n-public class AnimationTest {\n-\n-    private static final CountDownLatch startupLatch = new CountDownLatch(1);\n-\n-    private static Stage primaryStage;\n-\n-    public static class TestApp extends Application {\n-\n-        @Override\n-        public void init() throws Exception {\n-            assertFalse(Platform.isFxApplicationThread());\n-        }\n-\n-        @Override\n-        public void start(Stage stage) throws Exception {\n-            primaryStage = stage;\n-            assertTrue(Platform.isFxApplicationThread());\n-\n-            startupLatch.countDown();\n-        }\n-\n-    }\n-\n-    @BeforeClass\n-    public static void setup() throws Exception {\n-        Util.launch(startupLatch, TestApp.class);\n-    }\n-\n-    @AfterClass\n-    public static void shutdown() {\n-        Util.shutdown(primaryStage);\n-    }\n+public class AnimationTest extends SynchronizationTest {\n@@ -78,11 +38,2 @@\n-    public void animationOnFXThreadTest() throws InterruptedException {\n-        final CountDownLatch l = new CountDownLatch(1);\n-        Platform.runLater(() -> {\n-            assertTrue(Platform.isFxApplicationThread());\n-            PauseTransition pause = new PauseTransition(Duration.seconds(1));\n-            pause.play();\n-            pause.pause();\n-            pause.stop();\n-            l.countDown();\n-        });\n-        l.await();\n+    public void testAnimation() throws InterruptedException {\n+        runTest(this::startAnimation);\n@@ -91,6 +42,2 @@\n-    @Test\n-    public void startAnimationNotOnFXThreadTest() {\n-        assertFalse(Platform.isFxApplicationThread());\n-        PauseTransition pause = new PauseTransition(Duration.seconds(1));\n-        assertThrows(IllegalStateException.class, pause::play);\n-    }\n+    private void startAnimation() {\n+        registerExceptionHandler();\n@@ -98,7 +45,2 @@\n-    @Test\n-    public void pauseAnimationNotOnFXThreadTest() {\n-        assertFalse(Platform.isFxApplicationThread());\n-        PauseTransition pause = new PauseTransition(Duration.seconds(1));\n-        Platform.runLater(pause::play);\n-        assertThrows(IllegalStateException.class, pause::pause);\n-    }\n+        var anim = new StrokeTransition(Duration.millis(10));\n+        anim.setCycleCount(Animation.INDEFINITE);\n@@ -106,9 +48,7 @@\n-    @Test\n-    public void stopAnimationNotOnFXThreadTest() {\n-        assertFalse(Platform.isFxApplicationThread());\n-        PauseTransition pause = new PauseTransition(Duration.seconds(1));\n-        Platform.runLater(() -> {\n-            pause.play();\n-            pause.pause();\n-        });\n-        assertThrows(IllegalStateException.class, pause::stop);\n+        \/\/ Start and stop continuously until aborted by the test harness\n+        while (true) {\n+            anim.play();\n+            Util.sleep(10);\n+            anim.stop();\n+            Util.sleep(10);\n+        }\n","filename":"tests\/system\/src\/test\/java\/test\/com\/sun\/javafx\/animation\/AnimationTest.java","additions":19,"deletions":79,"binary":false,"changes":98,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,1 +28,2 @@\n-import java.util.concurrent.CountDownLatch;\n+import org.junit.jupiter.api.Test;\n+\n@@ -30,6 +31,0 @@\n-import javafx.application.Application;\n-import javafx.application.Platform;\n-import javafx.stage.Stage;\n-import org.junit.AfterClass;\n-import org.junit.BeforeClass;\n-import org.junit.Test;\n@@ -38,36 +33,1 @@\n-import static org.junit.Assert.assertFalse;\n-import static org.junit.Assert.assertTrue;\n-import static org.junit.jupiter.api.Assertions.assertThrows;\n-\n-public class AnimationTimerTest {\n-\n-    private static final CountDownLatch startupLatch = new CountDownLatch(1);\n-\n-    private static Stage primaryStage;\n-\n-    public static class TestApp extends Application {\n-\n-        @Override\n-        public void init() throws Exception {\n-            assertFalse(Platform.isFxApplicationThread());\n-        }\n-\n-        @Override\n-        public void start(Stage stage) throws Exception {\n-            primaryStage = stage;\n-            assertTrue(Platform.isFxApplicationThread());\n-\n-            startupLatch.countDown();\n-        }\n-\n-    }\n-\n-    @BeforeClass\n-    public static void setup() throws Exception {\n-        Util.launch(startupLatch, TestApp.class);\n-    }\n-\n-    @AfterClass\n-    public static void shutdown() {\n-        Util.shutdown(primaryStage);\n-    }\n+public class AnimationTimerTest extends SynchronizationTest {\n@@ -76,15 +36,2 @@\n-    public void animationTimerOnFXThreadTest() throws InterruptedException {\n-        final CountDownLatch frameCounter = new CountDownLatch(3);\n-        Platform.runLater(() -> {\n-            AnimationTimer timer = new AnimationTimer() {\n-                @Override public void handle(long l) {\n-                    frameCounter.countDown();\n-                    if (frameCounter.getCount() == 0L) {\n-                        stop();\n-                    }\n-                }\n-            };\n-            assertTrue(Platform.isFxApplicationThread());\n-            timer.start();\n-        });\n-        frameCounter.await();\n+    public void testAnimationTimer() throws InterruptedException {\n+        runTest(this::startAnimationTimer);\n@@ -93,8 +40,2 @@\n-    @Test\n-    public void startAnimationTimerNotOnFXThreadTest() {\n-        assertFalse(Platform.isFxApplicationThread());\n-        AnimationTimer timer = new AnimationTimer() {\n-            @Override public void handle(long l) {}\n-        };\n-        assertThrows(IllegalStateException.class, timer::start);\n-    }\n+    private void startAnimationTimer() {\n+        registerExceptionHandler();\n@@ -102,6 +43,6 @@\n-    @Test\n-    public void stopAnimationTimerNotOnFXThreadTest() {\n-        assertFalse(Platform.isFxApplicationThread());\n-        AnimationTimer timer = new AnimationTimer() {\n-            @Override public void handle(long l) {\n-                assertThrows(IllegalStateException.class, () -> stop());\n+        var timer = new AnimationTimer() {\n+\n+            @Override\n+            public void handle(long now) {\n+                \/\/ Simulate intensive processing\n+                Util.sleep(10);\n@@ -110,1 +51,8 @@\n-        Platform.runLater(timer::start);\n+\n+        \/\/ Start and stop continuously until aborted by the test harness\n+        while (true) {\n+            timer.start();\n+            Util.sleep(10);\n+            timer.stop();\n+            Util.sleep(10);\n+        }\n","filename":"tests\/system\/src\/test\/java\/test\/com\/sun\/javafx\/animation\/AnimationTimerTest.java","additions":22,"deletions":74,"binary":false,"changes":96,"status":"modified"},{"patch":"@@ -0,0 +1,104 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.com.sun.javafx.animation;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+\n+import javafx.application.Application;\n+import javafx.application.Platform;\n+import javafx.stage.Stage;\n+import test.util.Util;\n+\n+\/\/ Based on https:\/\/bugs.openjdk.org\/browse\/JDK-8159048\n+public class SynchronizationTest {\n+\n+    private static final CountDownLatch startupLatch = new CountDownLatch(1);\n+    private static Stage primaryStage;\n+\n+    public static class TestApp extends Application {\n+\n+        @Override\n+        public void start(Stage stage) throws Exception {\n+            primaryStage = stage;\n+            startupLatch.countDown();\n+        }\n+    }\n+\n+    @BeforeAll\n+    public static void setup() throws Exception {\n+        Util.launch(startupLatch, TestApp.class);\n+    }\n+\n+    @AfterAll\n+    public static void shutdown() {\n+        Util.shutdown(primaryStage);\n+    }\n+\n+    \/**\n+     * Number of seconds to wait for a failure. If an exception is not thrown in this time, it's assumed it won't be\n+     * thrown later too.\n+     *\/\n+    private static final int GRACE_PERIOD = 15;\n+\n+    final private AtomicBoolean failed = new AtomicBoolean(false);\n+    final private CountDownLatch waiter = new CountDownLatch(1);\n+    final private ExecutorService executor = Executors.newCachedThreadPool();\n+\n+    private Thread thread;\n+    private Throwable throwable;\n+\n+    protected void runTest(Runnable runnable) throws InterruptedException {\n+        Platform.runLater(() -> registerExceptionHandler());\n+\n+        for (int i = 0; i < 10; i++) {\n+            executor.submit(runnable);\n+        }\n+\n+        \/\/ If no exception is thrown after GRACE_PERIOD seconds, await completes and the test will succeed.\n+        \/\/ If an exception is thrown, await completes via countDown() instead and the test will fail.\n+        waiter.await(GRACE_PERIOD, TimeUnit.SECONDS);\n+        executor.shutdownNow();\n+        assertFalse(failed.get(), \"<\" + throwable + \"> was thrown on \" + thread);\n+    }\n+\n+    protected void registerExceptionHandler() {\n+        Thread.currentThread().setUncaughtExceptionHandler((t, e) -> {\n+            thread = t;\n+            throwable = e;\n+            failed.set(true);\n+            waiter.countDown();\n+        });\n+    }\n+}\n","filename":"tests\/system\/src\/test\/java\/test\/com\/sun\/javafx\/animation\/SynchronizationTest.java","additions":104,"deletions":0,"binary":false,"changes":104,"status":"added"}]}