{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -96,4 +96,2 @@\n-        \/\/ Ensures that the default application user agent stylesheet is loaded\n-        if (Application.getUserAgentStylesheet() == null) {\n-            PlatformImpl.setDefaultPlatformUserAgentStylesheet();\n-        }\n+        \/\/ Ensures that the default theme is loaded\n+        PlatformImpl.ensureDefaultTheme();\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/Control.java","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -87,4 +87,2 @@\n-        \/\/ Ensures that the default application user agent stylesheet is loaded\n-        if (Application.getUserAgentStylesheet() == null) {\n-            PlatformImpl.setDefaultPlatformUserAgentStylesheet();\n-        }\n+        \/\/ Ensures that the default theme is loaded\n+        PlatformImpl.ensureDefaultTheme();\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/PopupControl.java","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -0,0 +1,108 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package javafx.scene.control.theme;\n+\n+import com.sun.javafx.PlatformUtil;\n+import com.sun.javafx.application.PlatformImpl;\n+import javafx.application.ConditionalFeature;\n+import javafx.application.Platform;\n+import javafx.beans.value.WritableValue;\n+\n+\/**\n+ * {@code Caspian} is a built-in JavaFX theme that shipped as default in JavaFX 2.\n+ *\n+ * @since 21\n+ *\/\n+public class CaspianTheme extends ThemeBase {\n+\n+    private final WritableValue<String> highContrastStylesheet;\n+\n+    \/**\n+     * Creates a new instance of the {@code CaspianTheme} class.\n+     *\/\n+    public CaspianTheme() {\n+        addLast(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/caspian.css\");\n+\n+        if (PlatformImpl.isSupported(ConditionalFeature.INPUT_TOUCH)) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/embedded.css\");\n+\n+            if (com.sun.javafx.util.Utils.isQVGAScreen()) {\n+                addLast(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/embedded-qvga.css\");\n+            }\n+\n+            if (PlatformUtil.isAndroid()) {\n+                addLast(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/android.css\");\n+            }\n+\n+            if (PlatformUtil.isIOS()) {\n+                addLast(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/ios.css\");\n+            }\n+        }\n+\n+        if (PlatformImpl.isSupported(ConditionalFeature.TWO_LEVEL_FOCUS)) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/two-level-focus.css\");\n+        }\n+\n+        if (PlatformImpl.isSupported(ConditionalFeature.VIRTUAL_KEYBOARD)) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/fxvk.css\");\n+        }\n+\n+        if (!PlatformImpl.isSupported(ConditionalFeature.TRANSPARENT_WINDOW)) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/caspian-no-transparency.css\");\n+        }\n+\n+        highContrastStylesheet = addLast(null);\n+        updateHighContrastTheme();\n+    }\n+\n+    @Override\n+    protected void onPreferencesChanged() {\n+        updateHighContrastTheme();\n+    }\n+\n+    private void updateHighContrastTheme() {\n+        boolean enabled = false;\n+        String overrideThemeName = System.getProperty(\"com.sun.javafx.highContrastTheme\");\n+        if (overrideThemeName != null) {\n+            enabled = true;\n+        }\n+\n+        if (!enabled) {\n+            Platform.Preferences preferences = Platform.getPreferences();\n+            if (preferences.getBoolean(\"Windows.SPI.HighContrastOn\", false)) {\n+                enabled = preferences.getString(\"Windows.SPI.HighContrastColorScheme\") != null;\n+            }\n+        }\n+\n+        if (enabled) {\n+            \/\/ caspian has only one high contrast theme, use it regardless of the user or platform theme.\n+            highContrastStylesheet.setValue(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/highcontrast.css\");\n+        } else {\n+            highContrastStylesheet.setValue(null);\n+        }\n+    }\n+\n+}\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/theme\/CaspianTheme.java","additions":108,"deletions":0,"binary":false,"changes":108,"status":"added"},{"patch":"@@ -0,0 +1,127 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package javafx.scene.control.theme;\n+\n+import com.sun.javafx.PlatformUtil;\n+import com.sun.javafx.application.HighContrastScheme;\n+import com.sun.javafx.application.PlatformImpl;\n+import javafx.application.ConditionalFeature;\n+import javafx.application.Platform;\n+import javafx.beans.value.WritableValue;\n+import java.util.ResourceBundle;\n+\n+\/**\n+ * {@code Modena} is the default built-in JavaFX theme as of JavaFX 8.\n+ *\n+ * @since 21\n+ *\/\n+public class ModenaTheme extends ThemeBase {\n+\n+    private final WritableValue<String> highContrastStylesheet;\n+\n+    \/**\n+     * Creates a new instance of the {@code ModenaTheme} class.\n+     *\/\n+    public ModenaTheme() {\n+        addLast(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/modena.css\");\n+\n+        if (PlatformImpl.isSupported(ConditionalFeature.INPUT_TOUCH)) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/touch.css\");\n+        }\n+\n+        if (PlatformUtil.isEmbedded()) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/modena-embedded-performance.css\");\n+        }\n+\n+        if (PlatformUtil.isAndroid()) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/android.css\");\n+        }\n+\n+        if (PlatformUtil.isIOS()) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/ios.css\");\n+        }\n+\n+        if (PlatformImpl.isSupported(ConditionalFeature.TWO_LEVEL_FOCUS)) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/two-level-focus.css\");\n+        }\n+\n+        if (PlatformImpl.isSupported(ConditionalFeature.VIRTUAL_KEYBOARD)) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/fxvk.css\");\n+        }\n+\n+        if (!PlatformImpl.isSupported(ConditionalFeature.TRANSPARENT_WINDOW)) {\n+            addLast(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/modena-no-transparency.css\");\n+        }\n+\n+        highContrastStylesheet = addLast(null);\n+        updateHighContrastTheme();\n+    }\n+\n+    @Override\n+    protected void onPreferencesChanged() {\n+        updateHighContrastTheme();\n+    }\n+\n+    private void updateHighContrastTheme() {\n+        String themeName = null;\n+        String overrideThemeName = System.getProperty(\"com.sun.javafx.highContrastTheme\");\n+        if (overrideThemeName != null) {\n+            themeName = overrideThemeName;\n+        }\n+\n+        if (themeName == null) {\n+            Platform.Preferences preferences = Platform.getPreferences();\n+            if (preferences.getBoolean(\"Windows.SPI.HighContrastOn\", false)) {\n+                themeName = preferences.getString(\"Windows.SPI.HighContrastColorScheme\");\n+            }\n+        }\n+\n+        if (themeName != null) {\n+            String stylesheet = switch (themeName.toUpperCase()) {\n+                case \"BLACKONWHITE\" -> \"com\/sun\/javafx\/scene\/control\/skin\/modena\/blackOnWhite.css\";\n+                case \"WHITEONBLACK\" -> \"com\/sun\/javafx\/scene\/control\/skin\/modena\/whiteOnBlack.css\";\n+                case \"YELLOWONBLACK\" -> \"com\/sun\/javafx\/scene\/control\/skin\/modena\/yellowOnBlack.css\";\n+                default -> null;\n+            };\n+\n+            if (stylesheet == null) {\n+                ResourceBundle bundle = ResourceBundle.getBundle(\"com\/sun\/glass\/ui\/win\/themes\");\n+                String enumValue = HighContrastScheme.fromThemeName(bundle::getString, themeName);\n+\n+                stylesheet = enumValue != null ? switch (HighContrastScheme.valueOf(enumValue)) {\n+                    case HIGH_CONTRAST_WHITE -> \"com\/sun\/javafx\/scene\/control\/skin\/modena\/blackOnWhite.css\";\n+                    case HIGH_CONTRAST_BLACK -> \"com\/sun\/javafx\/scene\/control\/skin\/modena\/whiteOnBlack.css\";\n+                    case HIGH_CONTRAST_1, HIGH_CONTRAST_2 -> \"com\/sun\/javafx\/scene\/control\/skin\/modena\/yellowOnBlack.css\";\n+                } : null;\n+            }\n+\n+            highContrastStylesheet.setValue(stylesheet);\n+        } else {\n+            highContrastStylesheet.setValue(null);\n+        }\n+    }\n+\n+}\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/theme\/ModenaTheme.java","additions":127,"deletions":0,"binary":false,"changes":127,"status":"added"},{"patch":"@@ -0,0 +1,132 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package javafx.scene.control.theme;\n+\n+import javafx.beans.value.WritableValue;\n+import javafx.collections.ObservableListBase;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+\/**\n+ * Implements a list that allows individual elements to be changed via a {@link WritableValue} wrapper.\n+ *\/\n+class StylesheetList extends ObservableListBase<String> {\n+\n+    private final List<WritableValue<String>> elements;\n+    private final List<String> values;\n+\n+    public StylesheetList() {\n+        elements = new ArrayList<>();\n+        values = new ArrayList<>();\n+    }\n+\n+    public void lock() {\n+        beginChange();\n+    }\n+\n+    public void unlock() {\n+        endChange();\n+    }\n+\n+    public WritableValue<String> addFirstElement(String value) {\n+        if (value != null) {\n+            values.add(0, value);\n+        }\n+\n+        WritableValue<String> element = new ElementImpl(value);\n+        elements.add(0, element);\n+        return element;\n+    }\n+\n+    public WritableValue<String> addLastElement(String value) {\n+        if (value != null) {\n+            values.add(value);\n+        }\n+\n+        WritableValue<String> element = new ElementImpl(value);\n+        elements.add(element);\n+        return element;\n+    }\n+\n+    @Override\n+    public String get(int index) {\n+        return values.get(index);\n+    }\n+\n+    @Override\n+    public int size() {\n+        return values.size();\n+    }\n+\n+    private class ElementImpl implements WritableValue<String> {\n+        String currentValue;\n+\n+        ElementImpl(String initialValue) {\n+            currentValue = initialValue;\n+        }\n+\n+        @Override\n+        public String getValue() {\n+            return currentValue;\n+        }\n+\n+        @Override\n+        public void setValue(String newValue) {\n+            if (Objects.equals(currentValue, newValue)) {\n+                return;\n+            }\n+\n+            int index = 0;\n+            for (int i = 0, max = elements.size(); i < max; ++i) {\n+                WritableValue<String> element = elements.get(i);\n+                if (element == this) {\n+                    break;\n+                } else if (element.getValue() != null) {\n+                    ++index;\n+                }\n+            }\n+\n+            beginChange();\n+\n+            if (currentValue == null && newValue != null) {\n+                nextAdd(index, index + 1);\n+                values.add(index, newValue);\n+            } else if (currentValue != null && newValue == null) {\n+                nextRemove(index, currentValue);\n+                values.remove(index);\n+            } else if (currentValue != null) {\n+                nextReplace(index, index + 1, List.of(currentValue));\n+                values.set(index, newValue);\n+            }\n+\n+            currentValue = newValue;\n+\n+            endChange();\n+        }\n+    }\n+\n+}\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/theme\/StylesheetList.java","additions":132,"deletions":0,"binary":false,"changes":132,"status":"added"},{"patch":"@@ -0,0 +1,101 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package javafx.scene.control.theme;\n+\n+import javafx.application.Platform;\n+import javafx.beans.InvalidationListener;\n+import javafx.beans.WeakInvalidationListener;\n+import javafx.beans.value.WritableValue;\n+import javafx.collections.ObservableList;\n+import javafx.css.StyleTheme;\n+\n+\/**\n+ * {@link ThemeBase} is a {@link StyleTheme} implementation that simplifies toggling or modifying\n+ * stylesheets while retaining the order in which the stylesheets were originally added.\n+ * <p>\n+ * Stylesheet URIs can be added to the theme by calling {@link #addFirst(String)} or {@link #addLast(String)}.\n+ * The value of a stylesheet URI can be changed at any time with the {@link WritableValue} wrapper\n+ * that is returned by {@code addFirst} and {@code addLast}.\n+ *\n+ * @since 21\n+ *\/\n+public abstract class ThemeBase implements StyleTheme {\n+\n+    private final StylesheetList stylesheetList = new StylesheetList();\n+\n+    private final InvalidationListener preferencesChanged = observable -> {\n+        try {\n+            stylesheetList.lock();\n+            onPreferencesChanged();\n+        } finally {\n+            stylesheetList.unlock();\n+        }\n+    };\n+\n+    \/**\n+     * Creates a new instance of the {@code ThemeBase} class.\n+     *\/\n+    protected ThemeBase() {\n+        Platform.getPreferences().addListener(new WeakInvalidationListener(preferencesChanged));\n+    }\n+\n+    @Override\n+    public final ObservableList<String> getStylesheets() {\n+        return stylesheetList;\n+    }\n+\n+    \/**\n+     * Adds a new stylesheet URL at the front of the list of stylesheets.\n+     * <p>\n+     * The returned {@link WritableValue} can be used to change the value of the URL at runtime.\n+     * If the value is set to {@code null}, the stylesheet will not be included in the CSS cascade.\n+     *\n+     * @param url the stylesheet URL, or {@code null}\n+     * @return a {@code WritableValue} that represents the stylesheet URL in the list of stylesheets\n+     *\/\n+    protected final WritableValue<String> addFirst(String url) {\n+        return stylesheetList.addFirstElement(url);\n+    }\n+\n+    \/**\n+     * Adds a new stylesheet URL at the back of the list of stylesheets.\n+     * <p>\n+     * The returned {@link WritableValue} can be used to change the value of the URL at runtime.\n+     * If the value is set to {@code null}, the stylesheet will not be included in the CSS cascade.\n+     *\n+     * @param url the stylesheet URL, or {@code null}\n+     * @return a {@code WritableValue} that represents the stylesheet URL in the list of stylesheets\n+     *\/\n+    protected final WritableValue<String> addLast(String url) {\n+        return stylesheetList.addLastElement(url);\n+    }\n+\n+    \/**\n+     * Occurs when platform preferences have changed.\n+     *\/\n+    protected void onPreferencesChanged() {}\n+\n+}\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/theme\/ThemeBase.java","additions":101,"deletions":0,"binary":false,"changes":101,"status":"added"},{"patch":"@@ -0,0 +1,54 @@\n+<!doctype html>\n+\n+<!--\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+-->\n+\n+<html>\n+<head>\n+<meta http-equiv=\"Content-Type\" content=\"text\/html; charset=UTF-8\">\n+<title>javafx.scene.control.theme<\/title>\n+<\/head>\n+<body>\n+<p>This package contains the built-in style themes for JavaFX controls.<\/p>\n+<ol>\n+    <li>{@link javafx.scene.control.theme.CaspianTheme Caspian}, which is the default theme for JavaFX 2.X<\/li>\n+    <li>{@link javafx.scene.control.theme.ModenaTheme Modena}, which is the default theme for JavaFX 8.X and later<\/li>\n+<\/ol>\n+<p>Style themes can be applied using the {@link javafx.application.Application#setUserAgentStyleTheme} method:<\/p>\n+<pre>{@code\n+    public class App extends Application {\n+        @Override\n+        public void start(Stage primaryStage) {\n+            setUserAgentStyleTheme(new CaspianTheme());\n+\n+            primaryStage.setScene(...);\n+            primaryStage.show();\n+        }\n+    }\n+}<\/pre>\n+<\/body>\n+<\/html>\n","filename":"modules\/javafx.controls\/src\/main\/java\/javafx\/scene\/control\/theme\/package.html","additions":54,"deletions":0,"binary":false,"changes":54,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -41,0 +41,1 @@\n+    exports javafx.scene.control.theme;\n","filename":"modules\/javafx.controls\/src\/main\/java\/module-info.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,29 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package javafx.scene.control.theme;\n+\n+public class StylesheetListShim extends StylesheetList {\n+}\n","filename":"modules\/javafx.controls\/src\/shims\/java\/javafx\/scene\/control\/theme\/StylesheetListShim.java","additions":29,"deletions":0,"binary":false,"changes":29,"status":"added"},{"patch":"@@ -0,0 +1,111 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.javafx.scene.control.theme;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import javafx.css.StyleTheme;\n+import javafx.scene.control.theme.CaspianTheme;\n+import javafx.scene.control.theme.ModenaTheme;\n+\n+import static com.sun.javafx.application.PlatformImpl.*;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class BuiltinThemeTest {\n+\n+    private static String originalUAStylesheet;\n+    private static StyleTheme originalTheme;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        originalUAStylesheet = platformUserAgentStylesheetProperty().get();\n+        originalTheme = platformUserAgentStyleThemeProperty().get();\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        platformUserAgentStyleThemeProperty().set(originalTheme);\n+        platformUserAgentStylesheetProperty().set(originalUAStylesheet);\n+    }\n+\n+    \/*\n+       When platformUserAgentStylesheet is set to a built-in theme name, platformTheme is implicitly\n+       set to the corresponding theme class:\n+\n+       ┌───────────────────────────────────────────────────────────────┐\n+       │ platformUserAgentStylesheet    platformTheme                  │\n+       ├───────────────────────────────────────────────────────────────┤\n+       │ null --> foo.css               null                           │\n+       │ foo.css --> CASPIAN            null --> CaspianTheme          │\n+       │ CASPIAN --> MODENA             CaspianTheme --> ModenaTheme   │\n+       └───────────────────────────────────────────────────────────────┘\n+     *\/\n+    @Test\n+    public void testThemeIsImplicitlySet() {\n+        platformUserAgentStylesheetProperty().set(null);\n+        platformUserAgentStyleThemeProperty().set(null);\n+\n+        platformUserAgentStylesheetProperty().set(\"foo.css\");\n+        assertNull(platformUserAgentStyleThemeProperty().get());\n+\n+        platformUserAgentStylesheetProperty().set(\"CASPIAN\");\n+        assertEquals(\"CaspianTheme\", platformUserAgentStyleThemeProperty().get().getClass().getSimpleName());\n+\n+        platformUserAgentStylesheetProperty().set(\"MODENA\");\n+        assertEquals(\"ModenaTheme\", platformUserAgentStyleThemeProperty().get().getClass().getSimpleName());\n+    }\n+\n+    \/*\n+       When platformTheme is explicitly set to one of the built-in themes, platformUserAgentStylesheet\n+       is cleared when it was previously set to one of the built-in theme constants.\n+     *\/\n+    @Test\n+    public void testUAConstantIsClearedWhenBuiltinThemeIsExplicitlySet() {\n+        platformUserAgentStylesheetProperty().set(\"CASPIAN\");\n+        platformUserAgentStyleThemeProperty().set(new CaspianTheme());\n+        assertNull(platformUserAgentStylesheetProperty().get());\n+        assertTrue(platformUserAgentStyleThemeProperty().get() instanceof CaspianTheme);\n+\n+        platformUserAgentStylesheetProperty().set(\"MODENA\");\n+        platformUserAgentStyleThemeProperty().set(new ModenaTheme());\n+        assertNull(platformUserAgentStylesheetProperty().get());\n+        assertTrue(platformUserAgentStyleThemeProperty().get() instanceof ModenaTheme);\n+    }\n+\n+    \/*\n+       When platformTheme is explicitly set to one of the built-in themes, platformUserAgentStylesheet\n+       is NOT cleared when its value does not represent a built-in theme constant.\n+     *\/\n+    @Test\n+    public void testUAStylesheetIsNotClearedWhenBuiltinThemeIsExplicitlySet() {\n+        platformUserAgentStylesheetProperty().set(\"foo.css\");\n+        platformUserAgentStyleThemeProperty().set(new CaspianTheme());\n+        assertEquals(\"foo.css\", platformUserAgentStylesheetProperty().get());\n+        assertTrue(platformUserAgentStyleThemeProperty().get() instanceof CaspianTheme);\n+    }\n+\n+}\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/theme\/BuiltinThemeTest.java","additions":111,"deletions":0,"binary":false,"changes":111,"status":"added"},{"patch":"@@ -0,0 +1,64 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.javafx.scene.control.theme;\n+\n+import com.sun.javafx.application.PlatformImpl;\n+import com.sun.javafx.application.PlatformPreferencesImpl;\n+import org.junit.jupiter.api.Test;\n+import javafx.scene.control.theme.CaspianTheme;\n+import java.util.Map;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class CaspianThemeTest {\n+\n+    @Test\n+    public void testHighContrastThemeWithSystemProperty() {\n+        var theme = new CaspianTheme();\n+        assertFalse(theme.getStylesheets().stream().anyMatch(fileName -> fileName.contains(\"highcontrast.css\")));\n+        System.setProperty(\"com.sun.javafx.highContrastTheme\", \"ANY_VALUE_HERE\");\n+        theme = new CaspianTheme();\n+        assertTrue(theme.getStylesheets().stream().anyMatch(fileName -> fileName.contains(\"highcontrast.css\")));\n+        System.clearProperty(\"com.sun.javafx.highContrastTheme\");\n+    }\n+\n+    @Test\n+    public void testHighContrastThemeWithPlatformPreference() {\n+        var theme = new CaspianTheme();\n+        assertFalse(theme.getStylesheets().stream().anyMatch(fileName -> fileName.contains(\"highcontrast.css\")));\n+\n+        Map<String, Object> map = ((PlatformPreferencesImpl)PlatformImpl.getPlatformPreferences()).getModifiableMap();\n+        Object originalOn = map.put(\"Windows.SPI.HighContrastOn\", true);\n+        Object originalName = map.put(\"Windows.SPI.HighContrastColorScheme\", \"ANY_VALUE_HERE\");\n+\n+        theme = new CaspianTheme();\n+        assertTrue(theme.getStylesheets().stream().anyMatch(fileName -> fileName.contains(\"highcontrast.css\")));\n+\n+        map.put(\"Windows.SPI.HighContrastOn\", originalOn);\n+        map.put(\"Windows.SPI.HighContrastColorScheme\", originalName);\n+    }\n+\n+}\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/theme\/CaspianThemeTest.java","additions":64,"deletions":0,"binary":false,"changes":64,"status":"added"},{"patch":"@@ -0,0 +1,64 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.javafx.scene.control.theme;\n+\n+import com.sun.javafx.application.PlatformImpl;\n+import com.sun.javafx.application.PlatformPreferencesImpl;\n+import org.junit.jupiter.api.Test;\n+import javafx.scene.control.theme.ModenaTheme;\n+import java.util.Map;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class ModenaThemeTest {\n+\n+    @Test\n+    public void testHighContrastThemeWithSystemProperty() {\n+        var theme = new ModenaTheme();\n+        assertFalse(theme.getStylesheets().stream().anyMatch(fileName -> fileName.contains(\"blackOnWhite.css\")));\n+        System.setProperty(\"com.sun.javafx.highContrastTheme\", \"BLACKONWHITE\");\n+        theme = new ModenaTheme();\n+        assertTrue(theme.getStylesheets().stream().anyMatch(fileName -> fileName.contains(\"blackOnWhite.css\")));\n+        System.clearProperty(\"com.sun.javafx.highContrastTheme\");\n+    }\n+\n+    @Test\n+    public void testHighContrastThemeWithPlatformPreference() {\n+        var theme = new ModenaTheme();\n+        assertFalse(theme.getStylesheets().stream().anyMatch(fileName -> fileName.contains(\"blackOnWhite.css\")));\n+\n+        Map<String, Object> map = ((PlatformPreferencesImpl)PlatformImpl.getPlatformPreferences()).getModifiableMap();\n+        Object originalOn = map.put(\"Windows.SPI.HighContrastOn\", true);\n+        Object originalName = map.put(\"Windows.SPI.HighContrastColorScheme\", \"BLACKONWHITE\");\n+\n+        theme = new ModenaTheme();\n+        assertTrue(theme.getStylesheets().stream().anyMatch(fileName -> fileName.contains(\"blackOnWhite.css\")));\n+\n+        map.put(\"Windows.SPI.HighContrastOn\", originalOn);\n+        map.put(\"Windows.SPI.HighContrastColorScheme\", originalName);\n+    }\n+\n+}\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/theme\/ModenaThemeTest.java","additions":64,"deletions":0,"binary":false,"changes":64,"status":"added"},{"patch":"@@ -0,0 +1,167 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.javafx.scene.control.theme;\n+\n+import javafx.scene.control.theme.StylesheetListShim;\n+import org.junit.jupiter.api.Test;\n+import test.javafx.collections.MockListObserver;\n+import javafx.beans.value.WritableValue;\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class StylesheetListTest {\n+\n+    @Test\n+    public void testEmptyList() {\n+        var list = new StylesheetListShim();\n+        list.addLastElement(null);\n+        list.addLastElement(null);\n+        list.addLastElement(null);\n+\n+        assertEquals(0, list.size());\n+    }\n+\n+    @Test\n+    public void testAddLast() {\n+        var list = new StylesheetListShim();\n+        list.addLastElement(\"foo\");\n+        list.addLastElement(\"bar\");\n+        list.addLastElement(\"baz\");\n+\n+        assertEquals(List.of(\"foo\", \"bar\", \"baz\"), list);\n+    }\n+\n+    @Test\n+    public void testAddFirst() {\n+        var list = new StylesheetListShim();\n+        list.addLastElement(\"foo\");\n+        list.addFirstElement(\"bar\");\n+        list.addFirstElement(\"baz\");\n+\n+        assertEquals(List.of(\"baz\", \"bar\", \"foo\"), list);\n+    }\n+\n+    @Test\n+    public void testToggleItem() {\n+        var list = new StylesheetListShim() {\n+            final WritableValue<String> p1 = addLastElement(null);\n+            final WritableValue<String> p2 = addLastElement(null);\n+            final WritableValue<String> p3 = addLastElement(null);\n+        };\n+\n+        list.p1.setValue(\"foo\");\n+        assertEquals(List.of(\"foo\"), list);\n+\n+        list.p3.setValue(\"bar\");\n+        assertEquals(List.of(\"foo\", \"bar\"), list);\n+\n+        list.p1.setValue(null);\n+        assertEquals(List.of(\"bar\"), list);\n+    }\n+\n+    @Test\n+    public void testChangeItem() {\n+        var list = new StylesheetListShim() {\n+            final WritableValue<String> p1 = addLastElement(null);\n+            final WritableValue<String> p2 = addLastElement(null);\n+            final WritableValue<String> p3 = addLastElement(null);\n+        };\n+\n+        list.p1.setValue(\"foo\");\n+        assertEquals(List.of(\"foo\"), list);\n+\n+        list.p3.setValue(\"bar\");\n+        assertEquals(List.of(\"foo\", \"bar\"), list);\n+\n+        list.p3.setValue(\"baz\");\n+        assertEquals(List.of(\"foo\", \"baz\"), list);\n+    }\n+\n+    @Test\n+    public void testChangeEvent() {\n+        var list = new StylesheetListShim() {\n+            final WritableValue<String> p1 = addLastElement(null);\n+            final WritableValue<String> p2 = addLastElement(null);\n+            final WritableValue<String> p3 = addLastElement(null);\n+        };\n+\n+        var observer = new MockListObserver<String>();\n+        list.addListener(observer);\n+\n+        list.p1.setValue(\"foo\");\n+        observer.check1AddRemove(list, List.of(), 0, 1);\n+        observer.clear();\n+\n+        list.p3.setValue(\"bar\");\n+        observer.check1AddRemove(list, List.of(), 1, 2);\n+        observer.clear();\n+\n+        list.p2.setValue(\"baz\");\n+        observer.check1AddRemove(list, List.of(), 1, 2);\n+        observer.clear();\n+\n+        list.p2.setValue(\"qux\");\n+        observer.check1AddRemove(list, List.of(\"baz\"), 1, 2);\n+        observer.clear();\n+\n+        list.p2.setValue(null);\n+        observer.check1AddRemove(list, List.of(\"qux\"), 1, 1);\n+        observer.clear();\n+\n+        list.p3.setValue(null);\n+        observer.check1AddRemove(list, List.of(\"bar\"), 1, 1);\n+        observer.clear();\n+    }\n+\n+    @Test\n+    public void testBatchChange() {\n+        var list = new StylesheetListShim() {\n+            final WritableValue<String> p1 = addLastElement(null);\n+            final WritableValue<String> p2 = addLastElement(null);\n+            final WritableValue<String> p3 = addLastElement(\"baz\");\n+        };\n+\n+        var observer = new MockListObserver<String>();\n+        list.addListener(observer);\n+\n+        list.lock();\n+        list.p1.setValue(\"foo\");\n+        observer.check0();\n+\n+        list.p2.setValue(\"bar\");\n+        observer.check0();\n+\n+        list.p3.setValue(null);\n+        observer.check0();\n+\n+        list.unlock();\n+        observer.check1();\n+        observer.check1AddRemove(list, List.of(\"baz\"), 0, 2);\n+\n+    }\n+\n+}\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/theme\/StylesheetListTest.java","additions":167,"deletions":0,"binary":false,"changes":167,"status":"added"},{"patch":"@@ -0,0 +1,79 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.javafx.scene.control.theme;\n+\n+import com.sun.javafx.application.PlatformImpl;\n+import org.junit.jupiter.api.Test;\n+import javafx.scene.control.theme.ThemeBase;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class ThemeBaseTest {\n+\n+    @Test\n+    public void testOnPreferencesChangedIsInvokedWhenPreferencesAreInvalidated() {\n+        int[] count = new int[1];\n+        var theme = new ThemeBase() {\n+            @Override\n+            protected void onPreferencesChanged() {\n+                count[0]++;\n+            }\n+        };\n+\n+        PlatformImpl.updatePreferences(Map.of(\"foo\", \"bar\"));\n+        assertEquals(1, count[0]);\n+\n+        PlatformImpl.updatePreferences(Map.of(\"foo\", \"baz\", \"qux\", \"quz\"));\n+        assertEquals(2, count[0]);\n+    }\n+\n+    @Test\n+    public void testAddFirst() {\n+        var theme = new ThemeBase() {\n+            {\n+                addFirst(\"foo\");\n+                addFirst(\"bar\");\n+            }\n+        };\n+\n+        assertEquals(List.of(\"bar\", \"foo\"), theme.getStylesheets());\n+    }\n+\n+    @Test\n+    public void testAddLast() {\n+        var theme = new ThemeBase() {\n+            {\n+                addLast(\"foo\");\n+                addLast(\"bar\");\n+            }\n+        };\n+\n+        assertEquals(List.of(\"foo\", \"bar\"), theme.getStylesheets());\n+    }\n+\n+}\n","filename":"modules\/javafx.controls\/src\/test\/java\/test\/javafx\/scene\/control\/theme\/ThemeBaseTest.java","additions":79,"deletions":0,"binary":false,"changes":79,"status":"added"},{"patch":"@@ -5,1 +5,1 @@\n- * Copyright (c) 2012, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -252,1 +252,2 @@\n-          <li><a href=\"#introstylesheets\">Scene, Parent and SubScene Stylesheets<\/a><\/li>\n+          <li><a href=\"#introstylesheets\">Stylesheets and inline styles<\/a><\/li>\n+          <li><a href=\"#introstyletheme\">Style themes<\/a><\/li>\n@@ -552,1 +553,1 @@\n-    <h3><a id=\"introstylesheets\">Scene, Parent and SubScene Stylesheets<\/a><\/h3>\n+    <h3><a id=\"introstylesheets\">Stylesheets and inline styles<\/a><\/h3>\n@@ -554,11 +555,5 @@\n-        CSS styles can come from style sheets or inline styles. Style sheets are\n-        loaded from the URLs specified in the\n-        <a href=\"..\/..\/..\/javafx\/scene\/Scene.html#getStylesheets--\">getStylesheets<\/a>\n-        property of the Scene object. If the scene&#8209;graph contains a Control, a\n-        default user agent style sheet is loaded. Inline styles are specified via\n-        the Node <span style=\"font-weight: bold;\">setStyle<\/span> API. Inline\n-        styles are analogous to the style=\"...\" attribute of an HTML element.\n-        Styles loaded from a Scene's style sheets take precedence over selectors from\n-        the user agent style sheet. Inline styles take precedence over\n-        styles originating elsewhere. The precedence order of style selectors can be\n-        modified using \"!important\" in a style declaration.\n+        CSS styles are specified as inline styles or in stylesheets.\n+        Inline styles have the highest priority in the CSS cascade, and can be set using\n+        <a href=\"..\/..\/..\/javafx\/scene\/Node.html#setStyle--\">Node.setStyle<\/a>.\n+        An inline style can only contain CSS declarations (property\/value pairs).\n+        This is analogous to the <code>style=\"...\"<\/code> attribute of an HTML element.\n@@ -567,7 +562,9 @@\n-        Beginning with JavaFX 2.1, the Parent class has a\n-        <a href=\"..\/..\/..\/javafx\/scene\/Parent.html#getStylesheets--\">getStylesheets<\/a> property,\n-        allowing style sheets to be set on a container. This allows for one branch\n-        of of the scene&#8209;graph to have a distinct set of styles. Any instance of\n-        Parent can have style sheets. A child will take its styles from its own\n-        inline styles, the style sheets of all its ancestors, and any style sheets\n-        from the Scene.\n+        Stylesheets can be added to a JavaFX scene graph using a variety of APIs (see the table below).\n+        Depending on the API, a stylesheet is either classified as an <span style=\"font-weight: bold;\">author<\/span>\n+        stylesheet or a <span style=\"font-weight: bold;\">user-agent<\/span> stylesheet.\n+        Property values specified in author stylesheets have a higher precedence in the CSS cascade than\n+        property values set from code, while property values specified in user-agent stylesheets have a\n+        lower precedence than property values set from code.\n+        This makes user-agent stylesheets particularly useful to define the general appearance of an\n+        application, while allowing user code to override individual property values to customize a\n+        particular control in the scene graph.\n@@ -576,6 +573,66 @@\n-        Beginning with JavaFX 8u20, the Scene class has a\n-        <a href=\"..\/..\/..\/javafx\/scene\/Scene.html#getUserAgentStylesheet--\">getUserAgentStylesheet<\/a> property,\n-        allowing a user&#8209;style sheet to be set on a Scene. This allows a Scene\n-        to have a set of user&#8209;agent styles distinct from the platform default. When a user&#8209;agent\n-        stylesheet is set on a Scene, the user&#8209;agent styles are used instead of the styles from the\n-        platform default user&#8209;agent stylesheet.\n+        Another important difference between an author stylesheet and a user-agent stylesheet is whether\n+        the stylesheet is included in the CSS cascade for a styleable node. Since user-agent stylesheets\n+        specify the general appearance of an application, only the user-agent stylesheet closest to the\n+        styleable node is included in the CSS cascade; all other user-agent stylesheets are discarded.\n+        A notable exception to this rule is the stylesheet returned from\n+        <a href=\"..\/..\/..\/javafx\/scene\/layout\/Region.html#getUserAgentStylesheet--\">Region.getUserAgentStylesheet<\/a>,\n+        which does not cause the next-closest user-agent stylesheet to be discarded. This allows control\n+        authors to add a user-agent stylesheet that is only relevant for the particular control, without\n+        discarding the user-agent stylesheet for the rest of the application.\n+        <table class=\"cssmisctable\">\n+            <caption>Styling APIs<br\/>(sorted by order of precedence, descending)<\/caption>\n+            <thead>\n+                <tr>\n+                    <th scope=\"col\"><\/th>\n+                    <th scope=\"col\">API<\/th>\n+                    <th scope=\"col\"><a href=\"..\/..\/..\/javafx\/css\/StyleOrigin.html\">StyleOrigin<\/a><\/th>\n+                <\/tr>\n+            <\/thead>\n+            <tbody>\n+                <tr>\n+                    <th scope=\"row\">1<\/th>\n+                    <th><a href=\"..\/..\/..\/javafx\/scene\/Node.html#setStyle--\">Node.style<\/a><\/th>\n+                    <td><a href=\"..\/..\/..\/javafx\/css\/StyleOrigin.html#INLINE--\">inline<\/a><\/td>\n+                <\/tr>\n+                <tr>\n+                    <th scope=\"row\">2<\/th>\n+                    <td><a href=\"..\/..\/..\/javafx\/scene\/Parent.html#getStylesheets--\">Parent.getStylesheets<\/a><\/td>\n+                    <td><a href=\"..\/..\/..\/javafx\/css\/StyleOrigin.html#AUTHOR--\">author<\/a><\/td>\n+                <\/tr>\n+                <tr>\n+                    <th scope=\"row\">3<\/th>\n+                    <td><a href=\"..\/..\/..\/javafx\/scene\/Scene.html#getStylesheets--\">Scene.getStylesheets<\/a><\/td>\n+                    <td><a href=\"..\/..\/..\/javafx\/css\/StyleOrigin.html#AUTHOR--\">author<\/a><\/td>\n+                <\/tr>\n+                <tr>\n+                    <th scope=\"row\">4<\/th>\n+                    <td><a href=\"..\/..\/..\/javafx\/css\/StyleableProperty.html\">StyleableProperty<\/a> values set from code<\/td>\n+                    <td><a href=\"..\/..\/..\/javafx\/css\/StyleOrigin.html#USER--\">user<\/a><\/td>\n+                <\/tr>\n+                <tr>\n+                    <th scope=\"row\">5<\/th>\n+                    <td><a href=\"..\/..\/..\/javafx\/scene\/layout\/Region.html#getUserAgentStylesheet--\">Region.getUserAgentStylesheet<\/a><\/td>\n+                    <td><a href=\"..\/..\/..\/javafx\/css\/StyleOrigin.html#USER_AGENT--\">user-agent<\/a><\/td>\n+                <\/tr>\n+                <tr>\n+                    <th scope=\"row\">6<\/th>\n+                    <td><a href=\"..\/..\/..\/javafx\/scene\/SubScene.html#userAgentStylesheetProperty--\">SubScene.userAgentStylesheet<\/a><\/td>\n+                    <td><a href=\"..\/..\/..\/javafx\/css\/StyleOrigin.html#USER_AGENT--\">user-agent<\/a><\/td>\n+                <\/tr>\n+                <tr>\n+                    <th scope=\"row\">7<\/th>\n+                    <td><a href=\"..\/..\/..\/javafx\/scene\/Scene.html#userAgentStylesheetProperty--\">Scene.userAgentStylesheet<\/a><\/td>\n+                    <td><a href=\"..\/..\/..\/javafx\/css\/StyleOrigin.html#USER_AGENT--\">user-agent<\/a><\/td>\n+                <\/tr>\n+                <tr>\n+                    <th scope=\"row\">8<\/th>\n+                    <td><a href=\"..\/..\/..\/javafx\/application\/Application.html#userAgentStylesheetProperty--\">Application.userAgentStylesheet<\/a><\/td>\n+                    <td><a href=\"..\/..\/..\/javafx\/css\/StyleOrigin.html#USER_AGENT--\">user-agent<\/a><\/td>\n+                <\/tr>\n+                <tr>\n+                    <th scope=\"row\">9<\/th>\n+                    <td><a href=\"..\/..\/..\/javafx\/application\/Application.html#userAgentStyleThemeProperty--\">Application.userAgentStyleTheme<\/a><\/td>\n+                    <td><a href=\"..\/..\/..\/javafx\/css\/StyleOrigin.html#USER_AGENT--\">user-agent<\/a><\/td>\n+                <\/tr>\n+            <\/tbody>\n+        <\/table>\n@@ -583,0 +640,1 @@\n+    <h3><a id=\"introstyletheme\">Style themes<\/a><\/h3>\n@@ -584,7 +642,19 @@\n-        Beginning with JavaFX 8u20, the SubScene class has a\n-        <a href=\"..\/..\/..\/javafx\/scene\/SubScene.html#getUserAgentStylesheet--\">getUserAgentStylesheet<\/a> property,\n-        allowing a user&#8209;style sheet to be set on a SubScene. This allows a SubScene\n-        of the scene&#8209;graph to have set of user&#8209;agent styles distinct from the platform default\n-        or from the Scene in which the SubScene is contained. When a user&#8209;agent\n-        stylesheet is set on a SubScene, the user&#8209;agent styles are used instead of the styles from the\n-        platform default user&#8209;agent stylesheet or any user&#8209;agent stylesheet set on the Scene.\n+        <a href=\"..\/..\/..\/javafx\/css\/StyleTheme.html\">StyleThemes<\/a> are collections of user-agent\n+        stylesheets that comprise a single application-wide theme. All stylesheets that are part of\n+        a style theme are classified as user-agent stylesheets.\n+        JavaFX ships with two themes, <a href=\"..\/..\/..\/javafx\/scene\/control\/theme\/CaspianTheme.html\">Caspian<\/a>\n+        and <a href=\"..\/..\/..\/javafx\/scene\/control\/theme\/ModenaTheme.html\">Modena<\/a>, which are\n+        implemented as extensible style themes.\n+        The list of stylesheets that comprise a style theme can be modified while the application is\n+        running, enabling applications to create dynamic themes that respond to changing user preferences.\n+    <\/p>\n+    <p>\n+        The application-wide style theme is set using the\n+        <a href=\"..\/..\/..\/javafx\/application\/Application.html#userAgentStyleThemeProperty--\">Application.userAgentStyleTheme<\/a>\n+        property. Note that a style theme has the lowest precedence in the CSS cascade, and can be\n+        replaced by user-agent stylesheets set for any of the following properties:\n+        <ol>\n+            <li><a href=\"..\/..\/..\/javafx\/scene\/SubScene.html#userAgentStylesheetProperty--\">SubScene.userAgentStylesheet<\/a><\/li>\n+            <li><a href=\"..\/..\/..\/javafx\/scene\/Scene.html#userAgentStylesheetProperty--\">Scene.userAgentStylesheet<\/a><\/li>\n+            <li><a href=\"..\/..\/..\/javafx\/scene\/Application.html#userAgentStylesheetProperty--\">Application.userAgentStylesheet<\/a><\/li>\n+        <\/ol>\n@@ -592,14 +662,0 @@\n-    <p>It is important to note that styles from a stylesheet added to a Scene or Parent, do not affect\n-        a SubScene which is a child or descendent of the Scene or Parent. Unless a user&#8209;agent has\n-        been set on the SubScene, the SubScene will get styles\n-        from the a Scene's user&#8209;agent stylesheet or the platform user&#8209;agent stylesheet.<\/p>\n-    The implementation allows designers to style an application by using style\n-    sheets to override property values set from code. For example, a call to <code>rectangle.setFill(Color.YELLOW)<\/code>\n-    can be overridden by an inline&#8209;style or a style from an author stylesheet. This has implications for\n-    the cascade; particularly, when does a style from a style sheet override a\n-    value set from code? The JavaFX CSS implementation applies the following\n-    order of precedence: <cite>a style from a user agent style sheet has lower\n-    priority than a value set from code, which has lower priority than a Scene\n-    or Parent style sheet. Inline styles have highest precedence. Style sheets\n-    from a Parent instance are considered to be more specific than those styles\n-    from Scene style sheets.<\/cite>\n","filename":"modules\/javafx.graphics\/src\/main\/docs\/javafx\/scene\/doc-files\/cssref.html","additions":104,"deletions":48,"binary":false,"changes":152,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -87,2 +87,1 @@\n-        public boolean handleThemeChanged(String themeName) {\n-            return false;\n+        public void handlePreferencesChanged(Map<String, Object> properties) {\n@@ -262,1 +261,1 @@\n-    protected boolean notifyThemeChanged(String themeName) {\n+    protected void notifyPreferencesChanged(Map<String, Object> preferences) {\n@@ -265,1 +264,1 @@\n-            return handler.handleThemeChanged(themeName);\n+            handler.handlePreferencesChanged(preferences);\n@@ -267,1 +266,0 @@\n-        return false;\n@@ -678,13 +676,0 @@\n-    public String getHighContrastScheme(String themeName) {\n-        return themeName;\n-    }\n-\n-    \/**\n-     * Gets the Name of the currently active high contrast theme.\n-     * If null, then high contrast is not enabled.\n-     *\/\n-    public String getHighContrastTheme() {\n-        checkEventThread();\n-        return null;\n-    }\n-\n@@ -771,0 +756,4 @@\n+\n+    public Map<String, Object> getPlatformPreferences() {\n+        return Map.of();\n+    }\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/glass\/ui\/Application.java","additions":8,"deletions":19,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -523,0 +523,3 @@\n+    @Override\n+    public native Map<String, Object> getPlatformPreferences();\n+\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/glass\/ui\/gtk\/GtkApplication.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -39,0 +39,1 @@\n+import java.util.Map;\n@@ -391,0 +392,3 @@\n+\n+    @Override\n+    public native Map<String, Object> getPlatformPreferences();\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/glass\/ui\/mac\/MacApplication.java","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,1 +30,0 @@\n-import com.sun.javafx.application.PlatformImpl;\n@@ -39,0 +38,1 @@\n+import java.util.Map;\n@@ -43,1 +43,0 @@\n-    private static final String BASE_NAME = \"com\/sun\/glass\/ui\/win\/themes\";\n@@ -342,11 +341,0 @@\n-    @Override\n-    public String getHighContrastScheme(String themeName) {\n-        return PlatformImpl.HighContrastScheme.fromThemeName(ResourceBundle.getBundle(BASE_NAME)::getString, themeName);\n-    }\n-\n-    private native String _getHighContrastTheme();\n-    @Override public String getHighContrastTheme() {\n-        checkEventThread();\n-        return getHighContrastScheme(_getHighContrastTheme());\n-    }\n-\n@@ -381,0 +369,3 @@\n+\n+    @Override\n+    public native Map<String, Object> getPlatformPreferences();\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/glass\/ui\/win\/WinApplication.java","additions":5,"deletions":14,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -0,0 +1,78 @@\n+\/*\n+ * Copyright (c) 2021, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package com.sun.javafx.application;\n+\n+import java.util.function.Function;\n+\n+\/**\n+ * Enumeration of possible high contrast scheme values.\n+ * <p>\n+ * For each scheme, a theme key is defined. These keys can be\n+ * used, for instance, in a resource bundle that defines the theme name values\n+ * for supported locales.\n+ * <p>\n+ * The high contrast feature may not be available on all platforms.\n+ *\/\n+public enum HighContrastScheme {\n+    HIGH_CONTRAST_BLACK(\"high.contrast.black.theme\"),\n+    HIGH_CONTRAST_WHITE(\"high.contrast.white.theme\"),\n+    HIGH_CONTRAST_1(\"high.contrast.1.theme\"),\n+    HIGH_CONTRAST_2(\"high.contrast.2.theme\");\n+\n+    private final String themeKey;\n+\n+    HighContrastScheme(String themeKey) {\n+        this.themeKey = themeKey;\n+    }\n+\n+    public String getThemeKey() {\n+        return themeKey;\n+    }\n+\n+    \/**\n+     * Given a theme name string, this method finds the possible enum constant\n+     * for which the result of a function, applying its theme key, matches the theme name.\n+     * <p>\n+     * An example of such function can be {@code ResourceBundle::getString},\n+     * as {@link java.util.ResourceBundle#getString(String)} returns a string for\n+     * the given key.\n+     *\n+     * @param keyFunction a {@link Function} that returns a string for a given theme key string.\n+     * @param themeName   a string with the theme name\n+     * @return the name of the enum constant or null if not found\n+     *\/\n+    public static String fromThemeName(Function<String, String> keyFunction, String themeName) {\n+        if (keyFunction == null || themeName == null) {\n+            return null;\n+        }\n+        for (HighContrastScheme item : values()) {\n+            if (themeName.equalsIgnoreCase(keyFunction.apply(item.getThemeKey()))) {\n+                return item.toString();\n+            }\n+        }\n+        return null;\n+    }\n+}\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/application\/HighContrastScheme.java","additions":78,"deletions":0,"binary":false,"changes":78,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -762,0 +762,1 @@\n+                        PlatformImpl.ensureDefaultTheme();\n@@ -840,0 +841,1 @@\n+                        PlatformImpl.ensureDefaultTheme();\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/application\/LauncherImpl.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,0 +29,1 @@\n+\n@@ -43,1 +44,1 @@\n-import java.util.ArrayList;\n+import java.util.Arrays;\n@@ -47,0 +48,1 @@\n+import java.util.Objects;\n@@ -53,1 +55,0 @@\n-import java.util.function.Function;\n@@ -58,0 +59,1 @@\n+import javafx.application.Platform;\n@@ -59,0 +61,2 @@\n+import javafx.beans.property.ObjectProperty;\n+import javafx.beans.property.ObjectPropertyBase;\n@@ -60,1 +64,5 @@\n-import javafx.scene.Scene;\n+import javafx.beans.property.StringProperty;\n+import javafx.beans.property.StringPropertyBase;\n+import javafx.collections.ListChangeListener;\n+import javafx.collections.ObservableList;\n+import javafx.css.StyleTheme;\n@@ -682,0 +690,25 @@\n+    @SuppressWarnings(\"deprecation\")\n+    private enum BuiltinTheme {\n+        CASPIAN(Application.STYLESHEET_CASPIAN, \"javafx.scene.control.theme.CaspianTheme\"),\n+        MODENA(Application.STYLESHEET_MODENA, \"javafx.scene.control.theme.ModenaTheme\");\n+\n+        BuiltinTheme(String themeName, String className) {\n+            this.themeName = themeName;\n+            this.className = className;\n+        }\n+\n+        private final String themeName;\n+        private final String className;\n+\n+        public static BuiltinTheme fromName(String name) {\n+            if (CASPIAN.themeName.equals(name)) return CASPIAN;\n+            if (MODENA.themeName.equals(name)) return MODENA;\n+            return null;\n+        }\n+\n+        public boolean isCurrent() {\n+            StyleTheme currentTheme = platformUserAgentStyleTheme.get();\n+            return currentTheme != null && currentTheme.getClass().getName().equals(className);\n+        }\n+    }\n+\n@@ -683,1 +716,1 @@\n-     * Set the platform user agent stylesheet to the default.\n+     * Ensures that the default theme is loaded if no theme is set at this point.\n@@ -685,2 +718,5 @@\n-    public static void setDefaultPlatformUserAgentStylesheet() {\n-        setPlatformUserAgentStylesheet(Application.STYLESHEET_MODENA);\n+    @SuppressWarnings(\"deprecation\")\n+    public static void ensureDefaultTheme() {\n+        if (platformUserAgentStyleThemeProperty().get() == null) {\n+            platformUserAgentStylesheetProperty().set(Application.STYLESHEET_MODENA);\n+        }\n@@ -689,3 +725,0 @@\n-    private static boolean isModena = false;\n-    private static boolean isCaspian = false;\n-\n@@ -701,1 +734,1 @@\n-        return isModena;\n+        return BuiltinTheme.MODENA.isCurrent();\n@@ -713,13 +746,1 @@\n-        return isCaspian;\n-    }\n-\n-    \/**\n-     * Set the platform user agent stylesheet to the given URL. This method has special handling for platform theme\n-     * name constants.\n-     *\/\n-    public static void setPlatformUserAgentStylesheet(final String stylesheetUrl) {\n-        if (isFxApplicationThread()) {\n-            _setPlatformUserAgentStylesheet(stylesheetUrl);\n-        } else {\n-            runLater(() -> _setPlatformUserAgentStylesheet(stylesheetUrl));\n-        }\n+        return BuiltinTheme.CASPIAN.isCurrent();\n@@ -728,23 +749,3 @@\n-    \/**\n-     * Enumeration of possible high contrast scheme values.\n-     *\n-     * For each scheme, a theme key is defined. These keys can be\n-     * used, for instance, in a resource bundle that defines the theme name values\n-     * for supported locales.\n-     *\n-     * The high contrast feature may not be available on all platforms.\n-     *\/\n-    public enum HighContrastScheme {\n-        HIGH_CONTRAST_BLACK(\"high.contrast.black.theme\"),\n-        HIGH_CONTRAST_WHITE(\"high.contrast.white.theme\"),\n-        HIGH_CONTRAST_1(\"high.contrast.1.theme\"),\n-        HIGH_CONTRAST_2(\"high.contrast.2.theme\");\n-\n-        private final String themeKey;\n-        HighContrastScheme(String themeKey) {\n-            this.themeKey = themeKey;\n-        }\n-\n-        public String getThemeKey() {\n-            return themeKey;\n-        }\n+    private static StyleTheme newThemeInstance(BuiltinTheme theme) {\n+        try {\n+            Class<?> themeClass;\n@@ -752,19 +753,8 @@\n-        \/**\n-         * Given a theme name string, this method finds the possible enum constant\n-         * for which the result of a function, applying its theme key, matches the theme name.\n-         *\n-         * An example of such function can be {@code ResourceBundle::getString},\n-         * as {@link java.util.ResourceBundle#getString(String)} returns a string for\n-         * the given key.\n-         *\n-         * @param keyFunction a {@link Function} that returns a string for a given theme key string.\n-         * @param themeName a string with the theme name\n-         * @return the name of the enum constant or null if not found\n-         *\/\n-        public static String fromThemeName(Function<String, String> keyFunction, String themeName) {\n-            if (keyFunction == null || themeName == null) {\n-                return null;\n-            }\n-            for (HighContrastScheme item : values()) {\n-                if (themeName.equalsIgnoreCase(keyFunction.apply(item.getThemeKey()))) {\n-                    return item.toString();\n+            try {\n+                themeClass = Class.forName(theme.className, false, PlatformImpl.class.getClassLoader());\n+            } catch (ClassNotFoundException ex) {\n+                ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();\n+                if (contextClassLoader != null) {\n+                    themeClass = Class.forName(theme.className, false, contextClassLoader);\n+                } else {\n+                    throw ex;\n@@ -773,1 +763,8 @@\n-            return null;\n+\n+            return (StyleTheme)themeClass.getConstructor().newInstance();\n+        } catch (ClassNotFoundException ex) {\n+            Logging.getJavaFXLogger().warning(\n+                \"The default style theme \" + theme.className + \" cannot be found, \" +\n+                \"and no custom style theme was specified.\");\n+        } catch (Throwable ex) {\n+            Logging.getJavaFXLogger().severe(\"Cannot instantiate \" + theme.className, ex);\n@@ -775,0 +772,2 @@\n+\n+        return null;\n@@ -777,2 +776,2 @@\n-    private static String accessibilityTheme;\n-    public static boolean setAccessibilityTheme(String platformTheme) {\n+    private static final class UserAgentStylesheetProperty extends StringPropertyBase {\n+        boolean updating;\n@@ -780,3 +779,3 @@\n-        if (accessibilityTheme != null) {\n-            StyleManager.getInstance().removeUserAgentStylesheet(accessibilityTheme);\n-            accessibilityTheme = null;\n+        @Override\n+        public Object getBean() {\n+            return PlatformImpl.class;\n@@ -785,5 +784,3 @@\n-        _setAccessibilityTheme(platformTheme);\n-\n-        if (accessibilityTheme != null) {\n-            StyleManager.getInstance().addUserAgentStylesheet(accessibilityTheme);\n-            return true;\n+        @Override\n+        public String getName() {\n+            return \"platformUserAgentStylesheet\";\n@@ -791,10 +788,0 @@\n-        return false;\n-\n-    }\n-\n-    private static void _setAccessibilityTheme(String platformTheme) {\n-\n-        \/\/ check to see if there is an override to enable a high-contrast theme\n-        @SuppressWarnings(\"removal\")\n-        final String userTheme = AccessController.doPrivileged(\n-                (PrivilegedAction<String>) () -> System.getProperty(\"com.sun.javafx.highContrastTheme\"));\n@@ -802,36 +789,11 @@\n-        if (isCaspian()) {\n-            if (platformTheme != null || userTheme != null) {\n-                \/\/ caspian has only one high contrast theme, use it regardless of the user or platform theme.\n-                accessibilityTheme = \"com\/sun\/javafx\/scene\/control\/skin\/caspian\/highcontrast.css\";\n-            }\n-        } else if (isModena()) {\n-            \/\/ User-defined property takes precedence\n-            if (userTheme != null) {\n-                switch (userTheme.toUpperCase()) {\n-                    case \"BLACKONWHITE\":\n-                        accessibilityTheme = \"com\/sun\/javafx\/scene\/control\/skin\/modena\/blackOnWhite.css\";\n-                        break;\n-                    case \"WHITEONBLACK\":\n-                        accessibilityTheme = \"com\/sun\/javafx\/scene\/control\/skin\/modena\/whiteOnBlack.css\";\n-                        break;\n-                    case \"YELLOWONBLACK\":\n-                        accessibilityTheme = \"com\/sun\/javafx\/scene\/control\/skin\/modena\/yellowOnBlack.css\";\n-                        break;\n-                    default:\n-                }\n-            } else {\n-                if (platformTheme != null) {\n-                    \/\/ The following names are Platform specific (Windows 7 and 8)\n-                    switch (HighContrastScheme.valueOf(platformTheme)) {\n-                        case HIGH_CONTRAST_WHITE:\n-                            accessibilityTheme = \"com\/sun\/javafx\/scene\/control\/skin\/modena\/blackOnWhite.css\";\n-                            break;\n-                        case HIGH_CONTRAST_BLACK:\n-                            accessibilityTheme = \"com\/sun\/javafx\/scene\/control\/skin\/modena\/whiteOnBlack.css\";\n-                            break;\n-                        case HIGH_CONTRAST_1:\n-                        case HIGH_CONTRAST_2: \/\/TODO #2 should be green on black\n-                            accessibilityTheme = \"com\/sun\/javafx\/scene\/control\/skin\/modena\/yellowOnBlack.css\";\n-                            break;\n-                        default:\n-                    }\n+        @Override\n+        protected void invalidated() {\n+            BuiltinTheme builtinTheme = BuiltinTheme.fromName(get());\n+            if (builtinTheme == null) {\n+                platformUserAgentStyleThemeChanged(get(), platformUserAgentStyleTheme.get());\n+            } else if (!builtinTheme.isCurrent()) {\n+                try {\n+                    updating = true;\n+                    platformUserAgentStyleTheme.set(newThemeInstance(builtinTheme));\n+                } finally {\n+                    updating = false;\n@@ -843,6 +805,1 @@\n-    private static void _setPlatformUserAgentStylesheet(String stylesheetUrl) {\n-        isModena = isCaspian = false;\n-        \/\/ check for command line override\n-        @SuppressWarnings(\"removal\")\n-        final String overrideStylesheetUrl = AccessController.doPrivileged(\n-                (PrivilegedAction<String>) () -> System.getProperty(\"javafx.userAgentStylesheetUrl\"));\n+    private static final UserAgentStylesheetProperty platformUserAgentStylesheet = new UserAgentStylesheetProperty();\n@@ -850,3 +807,3 @@\n-        if (overrideStylesheetUrl != null) {\n-            stylesheetUrl = overrideStylesheetUrl;\n-        }\n+    public static StringProperty platformUserAgentStylesheetProperty() {\n+        return platformUserAgentStylesheet;\n+    }\n@@ -854,1 +811,5 @@\n-        final List<String> uaStylesheets = new ArrayList<>();\n+    private static final ObjectProperty<StyleTheme> platformUserAgentStyleTheme = new ObjectPropertyBase<>() {\n+        @Override\n+        public Object getBean() {\n+            return PlatformImpl.class;\n+        }\n@@ -856,3 +817,4 @@\n-        \/\/ check for named theme constants for modena and caspian\n-        if (Application.STYLESHEET_CASPIAN.equalsIgnoreCase(stylesheetUrl)) {\n-            isCaspian = true;\n+        @Override\n+        public String getName() {\n+            return \"platformUserAgentStyleTheme\";\n+        }\n@@ -860,1 +822,5 @@\n-            uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/caspian.css\");\n+        @Override\n+        protected void invalidated() {\n+            boolean clearBuiltinThemeUAConstant =\n+                !platformUserAgentStylesheet.updating\n+                && BuiltinTheme.fromName(platformUserAgentStylesheet.get()) != null;\n@@ -862,12 +828,6 @@\n-            if (isSupported(ConditionalFeature.INPUT_TOUCH)) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/embedded.css\");\n-                if (com.sun.javafx.util.Utils.isQVGAScreen()) {\n-                    uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/embedded-qvga.css\");\n-                }\n-                if (PlatformUtil.isAndroid()) {\n-                    uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/android.css\");\n-                }\n-                if (PlatformUtil.isIOS()) {\n-                    uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/ios.css\");\n-                }\n-            }\n+            if (clearBuiltinThemeUAConstant) {\n+                platformUserAgentStylesheet.set(null);\n+            } else {\n+                String userAgentStylesheet =\n+                    BuiltinTheme.fromName(platformUserAgentStylesheet.get()) == null ?\n+                    platformUserAgentStylesheet.get() : null;\n@@ -875,2 +835,1 @@\n-            if (isSupported(ConditionalFeature.TWO_LEVEL_FOCUS)) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/two-level-focus.css\");\n+                platformUserAgentStyleThemeChanged(userAgentStylesheet, get());\n@@ -878,0 +837,2 @@\n+        }\n+    };\n@@ -879,3 +840,3 @@\n-            if (isSupported(ConditionalFeature.VIRTUAL_KEYBOARD)) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/fxvk.css\");\n-            }\n+    public static ObjectProperty<StyleTheme> platformUserAgentStyleThemeProperty() {\n+        return platformUserAgentStyleTheme;\n+    }\n@@ -883,2 +844,21 @@\n-            if (!isSupported(ConditionalFeature.TRANSPARENT_WINDOW)) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/caspian-no-transparency.css\");\n+    private static void platformUserAgentStyleThemeChanged(String userAgentStylesheet, StyleTheme theme) {\n+        if (!isFxApplicationThread()) {\n+            final String userAgentStylesheetCopy = userAgentStylesheet;\n+            final StyleTheme themeCopy = theme;\n+            runLater(() -> platformUserAgentStyleThemeChanged(userAgentStylesheetCopy, themeCopy));\n+        } else {\n+            \/\/ If the javafx.userAgentStylesheetUrl system property is specified, we ignore the current theme\n+            \/\/ to maximize compatibility with earlier versions of JavaFX where setting a UA stylesheet replaces\n+            \/\/ the style theme entirely.\n+            String overrideStylesheetUrl = System.getProperty(\"javafx.userAgentStylesheetUrl\");\n+            if (overrideStylesheetUrl != null) {\n+                userAgentStylesheet = overrideStylesheetUrl.trim();\n+                BuiltinTheme builtinTheme = BuiltinTheme.fromName(userAgentStylesheet);\n+                if (builtinTheme != null) {\n+                    theme = newThemeInstance(builtinTheme);\n+                    userAgentStylesheet = null;\n+                } else {\n+                    theme = null;\n+                }\n+            } else if (userAgentStylesheet != null) {\n+                userAgentStylesheet = userAgentStylesheet.trim();\n@@ -887,2 +867,3 @@\n-        } else if (Application.STYLESHEET_MODENA.equalsIgnoreCase(stylesheetUrl)) {\n-            isModena = true;\n+            updateStyleManager(userAgentStylesheet, theme != null ? theme.getStylesheets() : null);\n+        }\n+    }\n@@ -890,1 +871,1 @@\n-            uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/modena.css\");\n+    private static List<String> themeStylesheets;\n@@ -892,13 +873,5 @@\n-            if (isSupported(ConditionalFeature.INPUT_TOUCH)) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/touch.css\");\n-            }\n-            \/\/ when running on embedded add a extra stylesheet to tune performance of modena theme\n-            if (PlatformUtil.isEmbedded()) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/modena-embedded-performance.css\");\n-            }\n-            if (PlatformUtil.isAndroid()) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/android.css\");\n-            }\n-            if (PlatformUtil.isIOS()) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/ios.css\");\n-            }\n+    private static final ListChangeListener<String> themeStylesheetsChanged =\n+        change -> {\n+            Toolkit.getToolkit().checkFxUserThread();\n+            updateStyleManager(platformUserAgentStylesheet.get(), themeStylesheets);\n+        };\n@@ -906,2 +879,14 @@\n-            if (isSupported(ConditionalFeature.TWO_LEVEL_FOCUS)) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/two-level-focus.css\");\n+    \/**\n+     * Updates the {@link StyleManager} with a new list of stylesheets that consist of the current\n+     * user-agent stylesheet or the list of stylesheets contained in the current {@link StyleTheme}.\n+     * <p>\n+     * If {@code stylesheets} is an {@code ObservableList}, this method also registers a\n+     * {@code ListChangeListener} to update the {@code StyleManager} when the list is changed.\n+     *\n+     * @param userAgentStylesheet the user-agent stylesheet, or {@code null}\n+     * @param stylesheets the stylesheets of the {@code StyleTheme}, or {@code null}\n+     *\/\n+    private static void updateStyleManager(String userAgentStylesheet, List<String> stylesheets) {\n+        if (themeStylesheets != stylesheets) {\n+            if (themeStylesheets instanceof ObservableList<String> list) {\n+                list.removeListener(themeStylesheetsChanged);\n@@ -910,3 +895,1 @@\n-            if (isSupported(ConditionalFeature.VIRTUAL_KEYBOARD)) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/caspian\/fxvk.css\");\n-            }\n+            themeStylesheets = stylesheets;\n@@ -914,2 +897,2 @@\n-            if (!isSupported(ConditionalFeature.TRANSPARENT_WINDOW)) {\n-                uaStylesheets.add(\"com\/sun\/javafx\/scene\/control\/skin\/modena\/modena-no-transparency.css\");\n+            if (themeStylesheets instanceof ObservableList<String> list) {\n+                list.addListener(themeStylesheetsChanged);\n@@ -917,9 +900,0 @@\n-\n-        } else {\n-            uaStylesheets.add(stylesheetUrl);\n-        }\n-\n-        \/\/ Ensure that accessibility starts right\n-        _setAccessibilityTheme(Toolkit.getToolkit().getThemeName());\n-        if (accessibilityTheme != null) {\n-            uaStylesheets.add(accessibilityTheme);\n@@ -928,7 +902,1 @@\n-        @SuppressWarnings(\"removal\")\n-        var dummy = AccessController.doPrivileged((PrivilegedAction) () -> {\n-            StyleManager.getInstance().setUserAgentStylesheets(uaStylesheets);\n-            return null;\n-        });\n-\n-    }\n+        boolean hasUserAgentStylesheet = userAgentStylesheet != null && !userAgentStylesheet.isEmpty();\n@@ -936,14 +904,6 @@\n-    @SuppressWarnings(\"removal\")\n-    public static void addNoTransparencyStylesheetToScene(final Scene scene) {\n-        if (PlatformImpl.isCaspian()) {\n-            AccessController.doPrivileged((PrivilegedAction) () -> {\n-                StyleManager.getInstance().addUserAgentStylesheet(scene,\n-                        \"com\/sun\/javafx\/scene\/control\/skin\/caspian\/caspian-no-transparency.css\");\n-                return null;\n-            });\n-        } else if (PlatformImpl.isModena()) {\n-            AccessController.doPrivileged((PrivilegedAction) () -> {\n-                StyleManager.getInstance().addUserAgentStylesheet(scene,\n-                        \"com\/sun\/javafx\/scene\/control\/skin\/modena\/modena-no-transparency.css\");\n-                return null;\n-            });\n+        if (hasUserAgentStylesheet) {\n+            StyleManager.getInstance().setUserAgentStylesheets(List.of(userAgentStylesheet));\n+        } else if (themeStylesheets != null) {\n+            StyleManager.getInstance().setUserAgentStylesheets(themeStylesheets);\n+        } else {\n+            StyleManager.getInstance().setUserAgentStylesheets(List.of());\n@@ -1047,0 +1007,50 @@\n+\n+    private static final PlatformPreferencesImpl platformPreferences = new PlatformPreferencesImpl();\n+\n+    public static Platform.Preferences getPlatformPreferences() {\n+        return platformPreferences;\n+    }\n+\n+    \/**\n+     * Called by Glass when one or several platform preferences have changed.\n+     * <p>\n+     * This method can be called on any thread. The supplied {@code preferences} map may\n+     * include all platform preferences, or only the changed preferences.\n+     *\n+     * @param preferences a map that includes the changed preferences\n+     *\/\n+    public static void updatePreferences(Map<String, Object> preferences) {\n+        if (preferences == null) {\n+            return;\n+        }\n+\n+        if (isFxApplicationThread()) {\n+            Map<String, Object> changed = new HashMap<>();\n+            for (Map.Entry<String, Object> entry : preferences.entrySet()) {\n+                Object existingValue = platformPreferences.getModifiableMap().get(entry.getKey());\n+                Object newValue = entry.getValue();\n+                boolean equals = false;\n+\n+                if (existingValue instanceof Object[] && newValue instanceof Object[]) {\n+                    equals = Arrays.equals((Object[]) existingValue, (Object[]) newValue);\n+                } else if (!(existingValue instanceof Object[]) && !(newValue instanceof Object[])) {\n+                    equals = Objects.equals(existingValue, entry.getValue());\n+                }\n+\n+                if (!equals) {\n+                    changed.put(entry.getKey(), entry.getValue());\n+                }\n+            }\n+\n+            if (!changed.isEmpty()) {\n+                platformPreferences.getModifiableMap().putAll(changed);\n+                platformPreferences.firePreferencesChanged(changed);\n+            }\n+        } else {\n+            \/\/ Make a defensive copy in case the caller of this method decides to re-use or\n+            \/\/ modify its preferences map after the method returns.\n+            Map<String, Object> preferencesCopy = new HashMap<>(preferences);\n+            runLater(() -> updatePreferences(preferencesCopy));\n+        }\n+    }\n+\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/application\/PlatformImpl.java","additions":219,"deletions":209,"binary":false,"changes":428,"status":"modified"},{"patch":"@@ -0,0 +1,136 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package com.sun.javafx.application;\n+\n+import javafx.application.Platform;\n+import javafx.beans.InvalidationListener;\n+import javafx.collections.MapChangeListener;\n+import javafx.scene.paint.Color;\n+import java.util.AbstractMap;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+\n+public final class PlatformPreferencesImpl extends AbstractMap<String, Object> implements Platform.Preferences {\n+\n+    private final Map<String, Object> modifiableMap = new HashMap<>();\n+    private final Set<Entry<String, Object>> unmodifiableEntrySet = Collections.unmodifiableSet(modifiableMap.entrySet());\n+    private final List<InvalidationListener> invalidationListeners = new CopyOnWriteArrayList<>();\n+    private final List<MapChangeListener<? super String, ? super Object>> changeListeners = new CopyOnWriteArrayList<>();\n+\n+    public Map<String, Object> getModifiableMap() {\n+        return modifiableMap;\n+    }\n+\n+    @Override\n+    public Set<Entry<String, Object>> entrySet() {\n+        return unmodifiableEntrySet;\n+    }\n+\n+    @Override\n+    public String getString(String key) {\n+        Object value = modifiableMap.get(key);\n+        if (value instanceof String s) {\n+            return s;\n+        }\n+\n+        return null;\n+    }\n+\n+    @Override\n+    public Boolean getBoolean(String key) {\n+        Object value = modifiableMap.get(key);\n+        if (value instanceof Boolean b) {\n+            return b;\n+        }\n+\n+        return null;\n+    }\n+\n+    @Override\n+    public Color getColor(String key) {\n+        Object value = modifiableMap.get(key);\n+        if (value instanceof Color c) {\n+            return c;\n+        }\n+\n+        return null;\n+    }\n+\n+    @Override\n+    public void addListener(InvalidationListener listener) {\n+        invalidationListeners.add(listener);\n+    }\n+\n+    @Override\n+    public void removeListener(InvalidationListener listener) {\n+        invalidationListeners.remove(listener);\n+    }\n+\n+    @Override\n+    public void addListener(MapChangeListener<? super String, ? super Object> listener) {\n+        changeListeners.add(listener);\n+    }\n+\n+    @Override\n+    public void removeListener(MapChangeListener<? super String, ? super Object> listener) {\n+        changeListeners.remove(listener);\n+    }\n+\n+    void firePreferencesChanged(Map<String, Object> changed) {\n+        for (InvalidationListener listener : invalidationListeners) {\n+            try {\n+                listener.invalidated(this);\n+            } catch (Exception e) {\n+                Thread.currentThread().getUncaughtExceptionHandler().uncaughtException(Thread.currentThread(), e);\n+            }\n+        }\n+\n+        for (Map.Entry<String, Object> entry : changed.entrySet()) {\n+            boolean keyExists = modifiableMap.containsKey(entry.getKey());\n+            Object oldValue = keyExists ? modifiableMap.get(entry.getKey()) : null;\n+            MapChangeListener.Change<String, Object> change = new MapChangeListener.Change<>(this) {\n+                @Override public boolean wasAdded() { return true; }\n+                @Override public boolean wasRemoved() { return keyExists; }\n+                @Override public String getKey() { return entry.getKey(); }\n+                @Override public Object getValueAdded() { return entry.getValue(); }\n+                @Override public Object getValueRemoved() { return oldValue; }\n+            };\n+\n+            for (MapChangeListener<? super String, ? super Object> listener : changeListeners) {\n+                try {\n+                    listener.onChanged(change);\n+                } catch (Exception e) {\n+                    Thread.currentThread().getUncaughtExceptionHandler().uncaughtException(Thread.currentThread(), e);\n+                }\n+            }\n+        }\n+    }\n+\n+}\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/application\/PlatformPreferencesImpl.java","additions":136,"deletions":0,"binary":false,"changes":136,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -90,0 +90,1 @@\n+import java.util.Objects;\n@@ -94,0 +95,1 @@\n+import java.util.stream.Collectors;\n@@ -1253,2 +1255,1 @@\n-     * is the order of their styles in the cascade. Passing null, an empty list, or a list full of empty\n-     * strings does nothing.\n+     * is the order of their styles in the cascade.\n@@ -1259,2 +1260,9 @@\n-\n-        if (urls == null || urls.size() == 0) return;\n+        if (urls == null) {\n+            urls = List.of();\n+        } else {\n+            urls = urls.stream()\n+                       .filter(Objects::nonNull)\n+                       .map(String::trim)\n+                       .filter(s -> !s.isEmpty())\n+                       .collect(Collectors.toList());\n+        }\n@@ -1267,6 +1275,1 @@\n-\n-                    final String url = urls.get(n);\n-                    final String fname = (url != null) ? url.trim() : null;\n-\n-                    if (fname == null || fname.isEmpty()) break;\n-\n+                    final String fname = urls.get(n);\n@@ -1289,1 +1292,1 @@\n-            boolean modified = false;\n+            platformUserAgentStylesheetContainers.clear();\n@@ -1292,12 +1295,1 @@\n-\n-                final String url = urls.get(n);\n-                final String fname = (url != null) ? url.trim() : null;\n-\n-                if (fname == null || fname.isEmpty()) continue;\n-\n-                if (!modified) {\n-                    \/\/ we have at least one non null or non-empty url\n-                    platformUserAgentStylesheetContainers.clear();\n-                    modified = true;\n-                }\n-\n+                final String fname = urls.get(n);\n@@ -1311,3 +1303,1 @@\n-            if (modified) {\n-                userAgentStylesheetsChanged();\n-            }\n+            userAgentStylesheetsChanged();\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/StyleManager.java","additions":17,"deletions":27,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -362,0 +362,2 @@\n+            PlatformImpl.updatePreferences(Application.GetApplication().getPlatformPreferences());\n+\n@@ -367,3 +369,3 @@\n-                @Override public boolean handleThemeChanged(String themeName) {\n-                    String highContrastSchemeName = Application.GetApplication().getHighContrastScheme(themeName);\n-                    return PlatformImpl.setAccessibilityTheme(highContrastSchemeName);\n+                @Override\n+                public void handlePreferencesChanged(Map<String, Object> preferences) {\n+                    PlatformImpl.updatePreferences(preferences);\n@@ -1808,5 +1810,0 @@\n-    @Override\n-    public String getThemeName() {\n-        return Application.GetApplication().getHighContrastTheme();\n-    }\n-\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/tk\/quantum\/QuantumToolkit.java","additions":6,"deletions":9,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,5 @@\n+import javafx.beans.property.ObjectProperty;\n+import javafx.beans.property.SimpleObjectProperty;\n+import javafx.beans.property.SimpleStringProperty;\n+import javafx.beans.property.StringProperty;\n+import javafx.css.StyleTheme;\n@@ -36,0 +41,2 @@\n+import javafx.scene.SubScene;\n+import javafx.scene.layout.Region;\n@@ -179,2 +186,4 @@\n-     * Constant for user agent stylesheet for the \"Caspian\" theme. Caspian\n-     * is the theme that shipped as default in JavaFX 2.x.\n+     * Constant for user agent stylesheet for the \"Caspian\" theme,\n+     * corresponding to {@link javafx.scene.control.theme.CaspianTheme}.\n+     * Caspian is the theme that shipped as default in JavaFX 2.x.\n+     *\n@@ -182,0 +191,3 @@\n+     * @deprecated this constant is provided for backwards compatibility only,\n+     *             call {@link #setUserAgentStyleTheme(StyleTheme)} with an instance of\n+     *             {@link javafx.scene.control.theme.CaspianTheme} instead\n@@ -183,0 +195,1 @@\n+    @Deprecated(since = \"21\")\n@@ -184,0 +197,1 @@\n+\n@@ -185,2 +199,4 @@\n-     * Constant for user agent stylesheet for the \"Modena\" theme. Modena\n-     * is the default theme for JavaFX 8.x.\n+     * Constant for user agent stylesheet for the \"Modena\" theme,\n+     * corresponding to {@link javafx.scene.control.theme.ModenaTheme}.\n+     * Modena is the default theme for JavaFX 8.x.\n+     *\n@@ -188,0 +204,3 @@\n+     * @deprecated this constant is provided for backwards compatibility only,\n+     *             call {@link #setUserAgentStyleTheme(StyleTheme)} with an instance of\n+     *             {@link javafx.scene.control.theme.ModenaTheme} instead\n@@ -189,0 +208,1 @@\n+    @Deprecated(since = \"21\")\n@@ -488,2 +508,0 @@\n-    private static String userAgentStylesheet = null;\n-\n@@ -491,3 +509,1 @@\n-     * Get the user agent stylesheet used by the whole application. This is\n-     * used to provide default styling for all ui controls and other nodes.\n-     * A value of null means the platform default stylesheet is being used.\n+     * Specifies the single user-agent stylesheet of the application.\n@@ -495,20 +511,7 @@\n-     * NOTE: This method must be called on the JavaFX Application Thread.\n-     * <\/p>\n-     *\n-     * @return The URL to the stylesheet as a String.\n-     * @since JavaFX 8.0\n-     *\/\n-    public static String getUserAgentStylesheet() {\n-        return userAgentStylesheet;\n-    }\n-\n-    \/**\n-     * Set the user agent stylesheet used by the whole application. This is used\n-     * to provide default styling for all ui controls and other nodes. Each\n-     * release of JavaFX may have a new default value for this so if you need\n-     * to guarantee consistency you will need to call this method and choose\n-     * what default you would like for your application. A value of null will\n-     * restore the platform default stylesheet. This property can also be set\n-     * on the command line with {@code -Djavafx.userAgentStylesheetUrl=[URL]}\n-     * Setting it on the command line overrides anything set using this method\n-     * in code.\n+     * The user-agent stylesheet is a global stylesheet that defines the appearance of the application.\n+     * It has the lowest precedence in the CSS cascade, and can be overridden in the scene graph by\n+     * setting the {@link Scene#userAgentStylesheetProperty() Scene.userAgentStylesheet} or\n+     * {@link SubScene#userAgentStylesheetProperty() SubScene.userAgentStylesheet} property.\n+     * <p>\n+     * This property can also be set on the command line with {@code -Djavafx.userAgentStylesheetUrl=[URL]}.\n+     * Setting it on the command line overrides the value of this property.\n@@ -528,1 +531,8 @@\n-     * NOTE: This method must be called on the JavaFX Application Thread.\n+     * Before JavaFX 21, built-in themes were selectable using the special user-agent stylesheet constants\n+     * {@link #STYLESHEET_CASPIAN} and {@link #STYLESHEET_MODENA}. For backwards compatibility, the meaning\n+     * of these special constants is retained: setting the user-agent stylesheet to either {@code STYLESHEET_CASPIAN}\n+     * or {@code STYLESHEET_MODENA} will also set the value of the {@link #userAgentStyleThemeProperty() userAgentStyleTheme}\n+     * property to a new instance of the corresponding theme class.\n+     * <p>\n+     * Note: this property can be modified on any thread, but it is not thread-safe and must\n+     *       not be concurrently modified with {@link #userAgentStyleThemeProperty() userAgentStyleTheme}.\n@@ -530,2 +540,1 @@\n-     * @param url The URL to the stylesheet as a String.\n-     * @since JavaFX 8.0\n+     * @since 21\n@@ -533,0 +542,14 @@\n+    private static StringProperty userAgentStylesheet;\n+\n+    public static StringProperty userAgentStylesheetProperty() {\n+        if (userAgentStylesheet == null) {\n+            userAgentStylesheet = new SimpleStringProperty(Application.class, \"userAgentStylesheet\");\n+            userAgentStylesheet.bindBidirectional(PlatformImpl.platformUserAgentStylesheetProperty());\n+        }\n+        return userAgentStylesheet;\n+    }\n+\n+    public static String getUserAgentStylesheet() {\n+        return userAgentStylesheetProperty().get();\n+    }\n+\n@@ -534,5 +557,26 @@\n-        userAgentStylesheet = url;\n-        if (url == null) {\n-            PlatformImpl.setDefaultPlatformUserAgentStylesheet();\n-        } else {\n-            PlatformImpl.setPlatformUserAgentStylesheet(url);\n+        userAgentStylesheetProperty().set(url);\n+    }\n+\n+    \/**\n+     * Specifies the user-agent {@link StyleTheme} of the application.\n+     * <p>\n+     * {@code StyleTheme} is a collection of user-agent stylesheets that define the appearance of the application.\n+     * {@code StyleTheme} has the lowest precedence in the CSS cascade, and can be overridden in the scene graph\n+     * by setting any of the following properties:\n+     * <ul>\n+     *     <li>{@link #userAgentStylesheetProperty() Application.userAgentStylesheet}\n+     *     <li>{@link Scene#userAgentStylesheetProperty() Scene.userAgentStylesheet}\n+     *     <li>{@link SubScene#userAgentStylesheetProperty() SubScene.userAgentStylesheet}\n+     * <\/ul>\n+     * <p>\n+     * Note: this property can be modified on any thread, but it is not thread-safe and must not be\n+     *       concurrently modified with {@link #userAgentStylesheetProperty() userAgentStylesheet}.\n+     *\n+     * @since 21\n+     *\/\n+    private static ObjectProperty<StyleTheme> userAgentStyleTheme;\n+\n+    public static ObjectProperty<StyleTheme> userAgentStyleThemeProperty() {\n+        if (userAgentStyleTheme == null) {\n+            userAgentStyleTheme = new SimpleObjectProperty<>(Application.class, \"userAgentStyleTheme\");\n+            userAgentStyleTheme.bindBidirectional(PlatformImpl.platformUserAgentStyleThemeProperty());\n@@ -540,0 +584,1 @@\n+        return userAgentStyleTheme;\n@@ -541,0 +586,9 @@\n+\n+    public static StyleTheme getUserAgentStyleTheme() {\n+        return userAgentStyleThemeProperty().get();\n+    }\n+\n+    public static void setUserAgentStyleTheme(StyleTheme theme) {\n+        userAgentStyleThemeProperty().set(theme);\n+    }\n+\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/application\/Application.java","additions":92,"deletions":38,"binary":false,"changes":130,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,1 @@\n+import javafx.collections.ObservableMap;\n@@ -34,0 +35,1 @@\n+import javafx.scene.paint.Color;\n@@ -419,0 +421,195 @@\n+\n+    \/**\n+     * Gets all {@link Preferences preferences} of the current platform.\n+     *\n+     * @return a {@code Preferences} instance\n+     * @since 21\n+     *\/\n+    public static Preferences getPreferences() {\n+        return PlatformImpl.getPlatformPreferences();\n+    }\n+\n+    \/**\n+     * Contains UI preferences of the current platform.\n+     * <p>\n+     * {@code Preferences} extends {@link ObservableMap} to expose platform preferences as key-value pairs.\n+     * For convenience, {@link #getString}, {@link #getBoolean} and {@link #getColor} are provided as typed\n+     * alternatives to the untyped {@link #get} method.\n+     * <p>\n+     * The preferences that are reported by the platform may be dependent on the operating system version.\n+     * Applications should always test whether a preference is available, or use the {@link #getString(String, String)},\n+     * {@link #getBoolean(String, boolean)} or {@link #getColor(String, Color)} overloads that accept a fallback\n+     * value if the preference is not available.\n+     * <p>\n+     * The following list contains all preferences that are potentially available on the specified platforms:\n+     *\n+     * <table>\n+     *     <caption><\/caption>\n+     *     <tbody>\n+     *         <tr><th colspan=\"2\" scope=\"colgroup\">Windows<\/th><\/tr>\n+     *         <tr><td>{@code Windows.SPI.HighContrast}<\/td><td>{@link Boolean}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.SPI.HighContrastColorScheme}<\/td><td>{@link String}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.SysColor.COLOR_3DFACE}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.SysColor.COLOR_BTNTEXT}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.SysColor.COLOR_GRAYTEXT}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.SysColor.COLOR_HIGHLIGHT}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.SysColor.COLOR_HIGHLIGHTTEXT}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.SysColor.COLOR_HOTLIGHT}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.SysColor.COLOR_WINDOW}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.SysColor.COLOR_WINDOWTEXT}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.UIColor.Background}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.UIColor.Foreground}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.UIColor.AccentDark3}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.UIColor.AccentDark2}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.UIColor.AccentDark1}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.UIColor.Accent}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.UIColor.AccentLight1}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.UIColor.AccentLight2}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code Windows.UIColor.AccentLight3}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><\/tr>\n+     *\n+     *         <tr><th colspan=\"2\" scope=\"colgroup\">macOS<\/th><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.labelColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.secondaryLabelColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.tertiaryLabelColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.quaternaryLabelColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.textColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.placeholderTextColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.selectedTextColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.textBackgroundColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.selectedTextBackgroundColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.keyboardFocusIndicatorColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.unemphasizedSelectedTextColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.unemphasizedSelectedTextBackgroundColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.linkColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.separatorColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.selectedContentBackgroundColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.unemphasizedSelectedContentBackgroundColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.selectedMenuItemTextColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.gridColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.headerTextColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.alternatingContentBackgroundColors}<\/td><td>{@link Color}{@code []}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.controlAccentColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.controlColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.controlBackgroundColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.controlTextColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.disabledControlTextColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.selectedControlColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.selectedControlTextColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.alternateSelectedControlTextColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.currentControlTint}<\/td><td>{@link String}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.windowBackgroundColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.windowFrameTextColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.underPageBackgroundColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.findHighlightColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.highlightColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.shadowColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemBlueColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemBrownColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemGrayColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemGreenColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemIndigoColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemOrangeColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemPinkColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemPurpleColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemRedColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemTealColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code macOS.NSColor.systemYellowColor}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><\/tr>\n+     *\n+     *         <tr><th colspan=\"2\" scope=\"colgroup\">Linux<\/th><\/tr>\n+     *         <tr><td>{@code GTK.theme_name}<\/td><td>{@link String}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.theme_fg_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.theme_bg_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.theme_base_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.theme_selected_bg_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.theme_selected_fg_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.insensitive_bg_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.insensitive_fg_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.insensitive_base_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.theme_unfocused_fg_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.theme_unfocused_bg_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.theme_unfocused_base_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.theme_unfocused_selected_bg_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.theme_unfocused_selected_fg_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.borders}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.unfocused_borders}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.warning_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.error_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><td>{@code GTK.success_color}<\/td><td>{@link Color}<\/td><\/tr>\n+     *         <tr><\/tr>\n+     *     <\/tbody>\n+     * <\/table>\n+     *\n+     * @since 21\n+     *\/\n+    public interface Preferences extends ObservableMap<String, Object> {\n+        \/**\n+         * Returns the {@link String} instance to which the specified key is mapped.\n+         *\n+         * @param key the key\n+         * @return the {@code String} instance to which the {@code key} is mapped, or\n+         *         {@code null} if the key is not mapped to a {@code String} instance\n+         *\/\n+        String getString(String key);\n+\n+        \/**\n+         * Returns the {@link String} instance to which the specified key is mapped,\n+         * or a fallback value if the key is not mapped to a {@code String} instance.\n+         *\n+         * @param key the key\n+         * @return the {@code String} instance to which the {@code key} is mapped, or\n+         *         {@code fallbackValue} if the key is not mapped to a {@code String}\n+         *         instance\n+         *\/\n+        default String getString(String key, String fallbackValue) {\n+            String value = getString(key);\n+            return value != null ? value : fallbackValue;\n+        }\n+\n+        \/**\n+         * Returns the {@link Boolean} instance to which the specified key is mapped.\n+         *\n+         * @param key the key\n+         * @return the {@code Boolean} instance to which the {@code key} is mapped, or\n+         *         {@code null} if the key is not mapped to a {@code Boolean} instance\n+         *\/\n+        Boolean getBoolean(String key);\n+\n+        \/**\n+         * Returns the {@code boolean} value to which the specified key is mapped,\n+         * or a fallback value if the key is not mapped to a {@code boolean} value.\n+         *\n+         * @param key the key\n+         * @return the {@code boolean} value to which the {@code key} is mapped, or\n+         *         {@code fallbackValue} if the key is not mapped to a {@code boolean}\n+         *         value\n+         *\/\n+        default boolean getBoolean(String key, boolean fallbackValue) {\n+            Boolean value = getBoolean(key);\n+            return value != null ? value : fallbackValue;\n+        }\n+\n+        \/**\n+         * Returns the {@link Color} instance to which the specified key is mapped.\n+         *\n+         * @param key the key\n+         * @return the {@code Color} instance to which the {@code key} is mapped, or\n+         *         {@code null} if the key is not mapped to a {@code Color} instance\n+         *\/\n+        Color getColor(String key);\n+\n+        \/**\n+         * Returns the {@link Color} instance to which the specified key is mapped,\n+         * or a fallback value if the key is not mapped to a {@code Color} instance.\n+         *\n+         * @param key the key\n+         * @return the {@code Color} instance to which the {@code key} is mapped, or\n+         *         {@code fallbackValue} if the key is not mapped to a {@code Color}\n+         *         instance\n+         *\/\n+        default Color getColor(String key, Color fallbackValue) {\n+            Color value = getColor(key);\n+            return value != null ? value : fallbackValue;\n+        }\n+    }\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/application\/Platform.java","additions":198,"deletions":1,"binary":false,"changes":199,"status":"modified"},{"patch":"@@ -0,0 +1,96 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package javafx.css;\n+\n+import javafx.application.Application;\n+import javafx.collections.ObservableList;\n+import javafx.scene.Scene;\n+import javafx.scene.SubScene;\n+import java.io.File;\n+import java.util.List;\n+\n+\/**\n+ * {@code StyleTheme} is a collection of user-agent stylesheets that specify the appearance of UI controls and\n+ * other nodes in the application. {@code StyleTheme} is implicitly used by all JavaFX nodes in the scene graph,\n+ * unless it is overridden by any of the following properties:\n+ * <ul>\n+ *     <li>{@link Application#userAgentStylesheetProperty() Application.userAgentStylesheet}\n+ *     <li>{@link Scene#userAgentStylesheetProperty() Scene.userAgentStylesheet}\n+ *     <li>{@link SubScene#userAgentStylesheetProperty() SubScene.userAgentStylesheet}\n+ * <\/ul>\n+ * <p>\n+ * The list of stylesheets that comprise a {@code StyleTheme} can be modified while the application is running,\n+ * enabling applications to create dynamic themes that respond to changing user preferences.\n+ * <p>\n+ * A {@code StyleTheme} can be applied using the {@link Application#setUserAgentStyleTheme(StyleTheme)} method:\n+ * <pre>{@code\n+ *     public class App extends Application {\n+ *         @Override\n+ *         public void start(Stage primaryStage) {\n+ *             setUserAgentStyleTheme(new MyCustomTheme());\n+ *\n+ *             primaryStage.setScene(...);\n+ *             primaryStage.show();\n+ *         }\n+ *     }\n+ * }<\/pre>\n+ *\n+ * @since 21\n+ *\/\n+public interface StyleTheme {\n+\n+    \/**\n+     * Gets the list of stylesheet URLs that comprise this {@code StyleTheme}.\n+     * <p>\n+     * The URL is a hierarchical URI of the form [scheme:][\/\/authority][path]. If the URL\n+     * does not have a [scheme:] component, the URL is considered to be the [path] component only.\n+     * Any leading '\/' character of the [path] is ignored and the [path] is treated as a path relative to\n+     * the root of the application's classpath.\n+     * <p>\n+     * The RFC 2397 \"data\" scheme for URLs is supported in addition to the protocol handlers that\n+     * are registered for the application.\n+     * If a URL uses the \"data\" scheme and the MIME type is either empty, \"text\/plain\", or \"text\/css\",\n+     * the payload will be interpreted as a CSS file.\n+     * If the MIME type is \"application\/octet-stream\", the payload will be interpreted as a binary\n+     * CSS file (see {@link Stylesheet#convertToBinary(File, File)}).\n+     * <p>\n+     * If the list of stylesheets that comprise this {@code StyleTheme} is changed at runtime, this\n+     * method must return an {@link ObservableList} to allow the CSS subsystem to subscribe to list\n+     * change notifications.\n+     *\n+     * @implSpec Implementations of this method that return an {@link ObservableList} must emit all\n+     *           change notifications on the JavaFX application thread.\n+     *\n+     * @implNote Implementations of this method that return an {@link ObservableList} are encouraged\n+     *           to minimize the number of subsequent list change notifications that are fired by the\n+     *           list, as each change notification causes the CSS subsystem to re-apply the referenced\n+     *           stylesheets.\n+     *\n+     * @return the list of stylesheet URLs\n+     *\/\n+    List<String> getStylesheets();\n+\n+}\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/css\/StyleTheme.java","additions":96,"deletions":0,"binary":false,"changes":96,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -822,5 +822,0 @@\n-        final boolean isTransparentWindowsSupported = Platform.isSupported(ConditionalFeature.TRANSPARENT_WINDOW);\n-        if (!isTransparentWindowsSupported) {\n-            PlatformImpl.addNoTransparencyStylesheetToScene(this);\n-        }\n-\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/scene\/Scene.java","additions":1,"deletions":6,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -45,0 +45,1 @@\n+#include \"PlatformSupport.h\"\n@@ -50,0 +51,1 @@\n+PlatformSupport* platformSupport = NULL;\n@@ -176,0 +178,2 @@\n+\n+    platformSupport = new PlatformSupport(env);\n@@ -239,0 +243,5 @@\n+\n+    if (platformSupport) {\n+        delete platformSupport;\n+        platformSupport = NULL;\n+    }\n@@ -391,0 +400,11 @@\n+\/*\n+ * Class:     com_sun_glass_ui_gtk_GtkApplication\n+ * Method:    getPlatformPreferences\n+ * Signature: ()Ljava\/util\/Map;\n+ *\/\n+JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_gtk_GtkApplication_getPlatformPreferences\n+  (JNIEnv *env, jobject self)\n+{\n+    return platformSupport ? platformSupport->collectPreferences() : NULL;\n+}\n+\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/GlassApplication.cpp","additions":21,"deletions":1,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -0,0 +1,123 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#include \"PlatformSupport.h\"\n+#include \"glass_general.h\"\n+#include <gtk\/gtk.h>\n+\n+namespace\n+{\n+    void putColor(JNIEnv* env, GtkStyle* style, jobject preferences, const char* colorName) {\n+        GdkColor color;\n+        if (gtk_style_lookup_color(style, colorName, &color)) {\n+            env->CallObjectMethod(preferences, jMapPut,\n+                env->NewStringUTF(colorName),\n+                env->CallStaticObjectMethod(\n+                    jColorCls, jColorRgb,\n+                    (int)(CLAMP((double)color.red \/ 65535.0, 0.0, 1.0) * 255.0),\n+                    (int)(CLAMP((double)color.green \/ 65535.0, 0.0, 1.0) * 255.0),\n+                    (int)(CLAMP((double)color.blue \/ 65535.0, 0.0, 1.0) * 255.0),\n+                    1.0));\n+        }\n+\n+        CHECK_JNI_EXCEPTION(env);\n+    }\n+\n+    void putString(JNIEnv* env, jobject preferences, const char* name, const char* value) {\n+        env->CallObjectMethod(preferences, jMapPut,\n+            env->NewStringUTF(name),\n+            env->NewStringUTF(value));\n+    }\n+}\n+\n+PlatformSupport::~PlatformSupport() {\n+    if (preferences) {\n+        env->DeleteGlobalRef(preferences);\n+    }\n+}\n+\n+jobject PlatformSupport::collectPreferences() const {\n+    jobject prefs = env->NewObject(jHashMapCls, jHashMapInit);\n+    if (EXCEPTION_OCCURED(env)) return NULL;\n+\n+    GtkStyle* style = gtk_style_new();\n+    putColor(env, style, prefs, \"GTK.theme_fg_color\");\n+    putColor(env, style, prefs, \"GTK.theme_bg_color\");\n+    putColor(env, style, prefs, \"GTK.theme_base_color\");\n+    putColor(env, style, prefs, \"GTK.theme_selected_bg_color\");\n+    putColor(env, style, prefs, \"GTK.theme_selected_fg_color\");\n+    putColor(env, style, prefs, \"GTK.insensitive_bg_color\");\n+    putColor(env, style, prefs, \"GTK.insensitive_fg_color\");\n+    putColor(env, style, prefs, \"GTK.insensitive_base_color\");\n+    putColor(env, style, prefs, \"GTK.theme_unfocused_fg_color\");\n+    putColor(env, style, prefs, \"GTK.theme_unfocused_bg_color\");\n+    putColor(env, style, prefs, \"GTK.theme_unfocused_base_color\");\n+    putColor(env, style, prefs, \"GTK.theme_unfocused_selected_bg_color\");\n+    putColor(env, style, prefs, \"GTK.theme_unfocused_selected_fg_color\");\n+    putColor(env, style, prefs, \"GTK.borders\");\n+    putColor(env, style, prefs, \"GTK.unfocused_borders\");\n+    putColor(env, style, prefs, \"GTK.warning_color\");\n+    putColor(env, style, prefs, \"GTK.error_color\");\n+    putColor(env, style, prefs, \"GTK.success_color\");\n+    g_object_unref(style);\n+\n+    GtkSettings* settings = gtk_settings_get_default();\n+    gchar* themeName;\n+    g_object_get(settings, \"gtk-theme-name\", &themeName, NULL);\n+    putString(env, prefs, \"GTK.theme_name\", themeName);\n+    g_object_unref(settings);\n+\n+    return prefs;\n+}\n+\n+void PlatformSupport::updatePreferences(jobject application) const {\n+    if (application == NULL) {\n+        return;\n+    }\n+\n+    jobject newPreferences = collectPreferences();\n+\n+    jboolean preferencesChanged =\n+        newPreferences != NULL &&\n+        !env->CallBooleanMethod(newPreferences, jObjectEquals, preferences);\n+\n+    if (!EXCEPTION_OCCURED(env) && preferencesChanged) {\n+        if (preferences) {\n+            env->DeleteGlobalRef(preferences);\n+        }\n+\n+        preferences = env->NewGlobalRef(newPreferences);\n+\n+        jobject unmodifiablePreferences = env->CallStaticObjectMethod(\n+            jCollectionsCls, jCollectionsUnmodifiableMap, newPreferences);\n+\n+        if (!EXCEPTION_OCCURED(env)) {\n+            env->CallVoidMethod(application, jApplicationNotifyPreferencesChanged, unmodifiablePreferences);\n+            env->DeleteLocalRef(unmodifiablePreferences);\n+        }\n+    }\n+\n+    env->DeleteLocalRef(newPreferences);\n+}\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/PlatformSupport.cpp","additions":123,"deletions":0,"binary":false,"changes":123,"status":"added"},{"patch":"@@ -0,0 +1,52 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#pragma once\n+\n+#include <jni.h>\n+\n+class PlatformSupport final\n+{\n+public:\n+    PlatformSupport(JNIEnv* env) : env(env) {}\n+    ~PlatformSupport();\n+    PlatformSupport(PlatformSupport const&) = delete;\n+    PlatformSupport& operator=(PlatformSupport const&) = delete;\n+\n+    \/**\n+     * Collect all platform preferences and return them as a new java\/util\/Map.\n+     *\/\n+    jobject collectPreferences() const;\n+\n+    \/**\n+     * Collect all platform preferences and notify the JavaFX application when a preference has changed.\n+     * The change notification includes all preferences, not only the changed preferences.\n+     *\/\n+    void updatePreferences(jobject application) const;\n+\n+private:\n+    JNIEnv* env;\n+    mutable jobject preferences;\n+};\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/PlatformSupport.h","additions":52,"deletions":0,"binary":false,"changes":52,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -91,0 +91,1 @@\n+jclass jMapCls;\n@@ -92,0 +93,1 @@\n+jmethodID jMapPut;\n@@ -95,0 +97,3 @@\n+jclass jHashMapCls;\n+jmethodID jHashMapInit;\n+\n@@ -113,0 +118,14 @@\n+jmethodID jApplicationNotifyPreferencesChanged;\n+\n+jclass jObjectCls;\n+jmethodID jObjectEquals;\n+\n+jclass jBooleanCls;\n+jfieldID jBooleanTRUE;\n+jfieldID jBooleanFALSE;\n+\n+jclass jCollectionsCls;\n+jmethodID jCollectionsUnmodifiableMap;\n+\n+jclass jColorCls;\n+jmethodID jColorRgb;\n@@ -279,0 +298,1 @@\n+    jMapCls = (jclass)env->NewGlobalRef(clazz);\n@@ -281,0 +301,2 @@\n+    jMapPut = env->GetMethodID(clazz, \"put\", \"(Ljava\/lang\/Object;Ljava\/lang\/Object;)Ljava\/lang\/Object;\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n@@ -286,0 +308,6 @@\n+    clazz = env->FindClass(\"java\/util\/HashMap\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+    jHashMapCls = (jclass) env->NewGlobalRef(clazz);\n+    jHashMapInit = env->GetMethodID(jHashMapCls, \"<init>\", \"()V\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+\n@@ -330,0 +358,28 @@\n+    jApplicationNotifyPreferencesChanged = env->GetMethodID(jApplicationCls, \"notifyPreferencesChanged\", \"(Ljava\/util\/Map;)V\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+\n+    clazz = env->FindClass(\"java\/lang\/Object\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+    jObjectCls = (jclass)env->NewGlobalRef(clazz);\n+    jObjectEquals = env->GetMethodID(jObjectCls, \"equals\", \"(Ljava\/lang\/Object;)Z\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+\n+    clazz = env->FindClass(\"java\/lang\/Boolean\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+    jBooleanCls = (jclass)env->NewGlobalRef(clazz);\n+    jBooleanTRUE = env->GetStaticFieldID(jBooleanCls, \"TRUE\", \"Ljava\/lang\/Boolean;\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+    jBooleanFALSE = env->GetStaticFieldID(jBooleanCls, \"FALSE\", \"Ljava\/lang\/Boolean;\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+\n+    clazz = env->FindClass(\"java\/util\/Collections\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+    jCollectionsCls = (jclass)env->NewGlobalRef(clazz);\n+    jCollectionsUnmodifiableMap = env->GetStaticMethodID(jCollectionsCls, \"unmodifiableMap\", \"(Ljava\/util\/Map;)Ljava\/util\/Map;\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+\n+    clazz = env->FindClass(\"javafx\/scene\/paint\/Color\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n+    jColorCls = (jclass)env->NewGlobalRef(clazz);\n+    jColorRgb = env->GetStaticMethodID(jColorCls, \"rgb\", \"(IIID)Ljavafx\/scene\/paint\/Color;\");\n+    if (env->ExceptionCheck()) return JNI_ERR;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/glass_general.cpp","additions":57,"deletions":1,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -195,0 +195,1 @@\n+    extern jclass jMapCls; \/\/ java.util.Map\n@@ -196,0 +197,1 @@\n+    extern jmethodID jMapPut; \/\/ java.util.Map#put(Ljava\/lang\/Object;Ljava\/lang\/Object;)Ljava\/lang\/Object;\n@@ -199,0 +201,3 @@\n+    extern jclass jHashMapCls; \/\/ java.util.HashMap\n+    extern jmethodID jHashMapInit; \/\/ java.util.HashMap#<init> ()V\n+\n@@ -217,0 +222,14 @@\n+    extern jmethodID jApplicationNotifyPreferencesChanged; \/\/ notifyPreferencesChanged(Ljava\/util\/Map;)V\n+\n+    extern jclass jObjectCls; \/\/ java.lang.Object\n+    extern jmethodID jObjectEquals; \/\/ java.lang.Object#equals(Ljava\/lang\/Object;)Z\n+\n+    extern jclass jBooleanCls; \/\/ java.lang.Boolean\n+    extern jfieldID jBooleanTRUE; \/\/ java.lang.Boolean#TRUE\n+    extern jfieldID jBooleanFALSE; \/\/ java.lang.Boolean#FALSE\n+\n+    extern jclass jCollectionsCls; \/\/ java.util.Collections;\n+    extern jmethodID jCollectionsUnmodifiableMap; \/\/ java.util.Collections#unmodifiableMap(Ljava\/util\/Map;)Ljava\/util\/Map;\n+\n+    extern jclass jColorCls; \/\/ javafx.scene.paint.Color\n+    extern jmethodID jColorRgb; \/\/ javafx.scene.paint.Color#rgb(IIID)Ljavafx\/scene\/paint\/Color;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/glass_general.h","additions":20,"deletions":1,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,0 +38,1 @@\n+#import \"PlatformSupport.h\"\n@@ -157,0 +158,19 @@\n+- (void)platformPreferencesDidChange {\n+    \/\/ Some dynamic colors like NSColor.controlAccentColor don't seem to be reliably updated\n+    \/\/ at the exact moment AppleColorPreferencesChangedNotification is received.\n+    \/\/ As a workaround, we wait for a short period of time (one second seems sufficient) before\n+    \/\/ we query the updated platform preferences.\n+\n+    [NSObject cancelPreviousPerformRequestsWithTarget:self\n+              selector:@selector(updatePlatformPreferences)\n+              object:nil];\n+\n+    [self performSelector:@selector(updatePlatformPreferences)\n+          withObject:nil\n+          afterDelay:1.0];\n+}\n+\n+- (void)updatePlatformPreferences {\n+    [PlatformSupport updatePreferences:self->jApplication];\n+}\n+\n@@ -196,0 +216,10 @@\n+                        [[NSDistributedNotificationCenter defaultCenter] addObserver:self\n+                                                                         selector:@selector(platformPreferencesDidChange)\n+                                                                         name:@\"AppleInterfaceThemeChangedNotification\"\n+                                                                         object:nil];\n+\n+                        [[NSDistributedNotificationCenter defaultCenter] addObserver:self\n+                                                                         selector:@selector(platformPreferencesDidChange)\n+                                                                         name:@\"AppleColorPreferencesChangedNotification\"\n+                                                                         object:nil];\n+\n@@ -837,0 +867,4 @@\n+    javaIDs.MacApplication.notifyPreferencesChanged = (*env)->GetMethodID(\n+            env, jClass, \"notifyPreferencesChanged\", \"(Ljava\/util\/Map;)V\");\n+    if ((*env)->ExceptionCheck(env)) return;\n+\n@@ -844,0 +878,2 @@\n+\n+    [PlatformSupport initIDs:env];\n@@ -1142,0 +1178,11 @@\n+\n+\/*\n+ * Class:     com_sun_glass_ui_mac_MacApplication\n+ * Method:    getPreferences\n+ * Signature: ()Ljava\/util\/Map;\n+ *\/\n+JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_mac_MacApplication_getPlatformPreferences\n+(JNIEnv *env, jobject self)\n+{\n+    return [PlatformSupport collectPreferences];\n+}\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassApplication.m","additions":48,"deletions":1,"binary":false,"changes":49,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -89,0 +89,12 @@\n+extern jclass jObjectClass;\n+extern jclass jCollectionsClass;\n+extern jclass jColorClass;\n+extern jclass jHashMapClass;\n+extern jfieldID jBooleanTRUE;\n+extern jfieldID jBooleanFALSE;\n+extern jmethodID jColorRgbMethod;\n+extern jmethodID jHashMapInitMethod;\n+extern jmethodID jMapPutMethod;\n+extern jmethodID jObjectEqualsMethod;\n+extern jmethodID jCollectionsUnmodifiableMapMethod;\n+\n@@ -119,0 +131,1 @@\n+        jmethodID notifyPreferencesChanged;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassStatics.h","additions":14,"deletions":1,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -91,0 +91,12 @@\n+jclass jObjectClass = NULL;\n+jclass jCollectionsClass = NULL;\n+jclass jColorClass = NULL;\n+jclass jHashMapClass = NULL;\n+jfieldID jBooleanTRUE = NULL;\n+jfieldID jBooleanFALSE = NULL;\n+jmethodID jColorRgbMethod = NULL;\n+jmethodID jHashMapInitMethod = NULL;\n+jmethodID jMapPutMethod = NULL;\n+jmethodID jObjectEqualsMethod = NULL;\n+jmethodID jCollectionsUnmodifiableMapMethod = NULL;\n+\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassStatics.m","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -0,0 +1,46 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#pragma once\n+\n+#import <Cocoa\/Cocoa.h>\n+#import <jni.h>\n+\n+@interface PlatformSupport : NSObject\n+\n++ (void)initIDs:(JNIEnv*)env;\n+\n+\/**\n+ * Collect all platform preferences and return them as a new java\/util\/Map.\n+ *\/\n++ (jobject)collectPreferences;\n+\n+\/**\n+ * Collect all platform preferences and notify the JavaFX application when a preference has changed.\n+ * The change notification includes all preferences, not only the changed preferences.\n+ *\/\n++ (void)updatePreferences:(jobject)application;\n+\n+@end\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/PlatformSupport.h","additions":46,"deletions":0,"binary":false,"changes":46,"status":"added"},{"patch":"@@ -0,0 +1,281 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#import \"PlatformSupport.h\"\n+#import \"GlassMacros.h\"\n+\n+#define MACOS_10_13 @available(macOS 10.13, *)\n+#define MACOS_10_14 @available(macOS 10.14, *)\n+\n+#define INIT_CLASS(CLS, NAME)\\\n+    if (CLS == nil) {\\\n+        jclass cls = (*env)->FindClass(env, NAME);\\\n+        if ((*env)->ExceptionCheck(env)) {\\\n+            GLASS_CHECK_EXCEPTION(env);\\\n+            return;\\\n+        }\\\n+        CLS = (*env)->NewGlobalRef(env, cls);\\\n+    }\n+\n+#define INIT_METHOD(CLS, METHOD, NAME, SIG)\\\n+    if (METHOD == nil) {\\\n+        METHOD = (*env)->GetMethodID(env, CLS, NAME, SIG);\\\n+        if ((*env)->ExceptionCheck(env)) {\\\n+            GLASS_CHECK_EXCEPTION(env);\\\n+            return;\\\n+        }\\\n+    }\n+\n+#define INIT_STATIC_METHOD(CLS, METHOD, NAME, SIG)\\\n+    if (METHOD == nil) {\\\n+        METHOD = (*env)->GetStaticMethodID(env, CLS, NAME, SIG);\\\n+        if ((*env)->ExceptionCheck(env)) {\\\n+            GLASS_CHECK_EXCEPTION(env);\\\n+            return;\\\n+        }\\\n+    }\n+\n+#define INIT_STATIC_FIELD(CLS, FIELD, NAME, SIG)\\\n+    if (FIELD == nil) {\\\n+        FIELD = (*env)->GetStaticFieldID(env, CLS, NAME, SIG);\\\n+        if ((*env)->ExceptionCheck(env)) {\\\n+            GLASS_CHECK_EXCEPTION(env);\\\n+            return;\\\n+        }\\\n+    }\n+\n+static jobject currentPreferences = nil;\n+\n+@implementation PlatformSupport\n+\n++ (void)initIDs:(JNIEnv*)env {\n+    INIT_CLASS(jMapClass, \"java\/util\/Map\");\n+    INIT_METHOD(jMapClass, jMapPutMethod, \"put\", \"(Ljava\/lang\/Object;Ljava\/lang\/Object;)Ljava\/lang\/Object;\");\n+\n+    INIT_CLASS(jHashMapClass, \"java\/util\/HashMap\");\n+    INIT_METHOD(jHashMapClass, jHashMapInitMethod, \"<init>\", \"()V\");\n+\n+    INIT_CLASS(jBooleanClass, \"java\/lang\/Boolean\");\n+    INIT_STATIC_FIELD(jBooleanClass, jBooleanTRUE, \"TRUE\", \"Ljava\/lang\/Boolean;\");\n+    INIT_STATIC_FIELD(jBooleanClass, jBooleanFALSE, \"FALSE\", \"Ljava\/lang\/Boolean;\");\n+\n+    INIT_CLASS(jCollectionsClass, \"java\/util\/Collections\");\n+    INIT_STATIC_METHOD(jCollectionsClass, jCollectionsUnmodifiableMapMethod, \"unmodifiableMap\", \"(Ljava\/util\/Map;)Ljava\/util\/Map;\");\n+\n+    INIT_CLASS(jObjectClass, \"java\/lang\/Object\");\n+    INIT_METHOD(jObjectClass, jObjectEqualsMethod, \"equals\", \"(Ljava\/lang\/Object;)Z\");\n+\n+    INIT_CLASS(jColorClass, \"javafx\/scene\/paint\/Color\");\n+    INIT_STATIC_METHOD(jColorClass, jColorRgbMethod, \"rgb\", \"(IIID)Ljavafx\/scene\/paint\/Color;\");\n+}\n+\n++ (jobject)collectPreferences {\n+    GET_MAIN_JENV;\n+\n+    jobject preferences = (*env)->NewObject(env, jHashMapClass, jHashMapInitMethod);\n+    GLASS_CHECK_EXCEPTION(env);\n+    if (preferences == nil) {\n+        return nil;\n+    }\n+\n+    \/\/ The current appearance is set to the system appearance when the application is started.\n+    \/\/ Since the system appearance can change while the application is running, we need to set\n+    \/\/ the current appearance to the application's effective appearance before querying system\n+    \/\/ colors.\n+    NSAppearance* lastAppearance = [NSAppearance currentAppearance];\n+    [NSAppearance setCurrentAppearance:[NSApp effectiveAppearance]];\n+    [PlatformSupport queryNSColors:preferences];\n+    [NSAppearance setCurrentAppearance:lastAppearance];\n+\n+    return preferences;\n+}\n+\n++ (void)queryNSColors:(jobject)preferences {\n+    \/\/ Label colors\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.labelColor\" value:[NSColor labelColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.secondaryLabelColor\" value:[NSColor secondaryLabelColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.tertiaryLabelColor\" value:[NSColor tertiaryLabelColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.quaternaryLabelColor\" value:[NSColor quaternaryLabelColor]];\n+\n+    \/\/ Text colors\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.textColor\" value:[NSColor textColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.placeholderTextColor\" value:[NSColor placeholderTextColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.selectedTextColor\" value:[NSColor selectedTextColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.textBackgroundColor\" value:[NSColor textBackgroundColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.selectedTextBackgroundColor\" value:[NSColor selectedTextBackgroundColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.keyboardFocusIndicatorColor\" value:[NSColor keyboardFocusIndicatorColor]];\n+    if (MACOS_10_14) {\n+        [PlatformSupport putColor:preferences key:\"macOS.NSColor.unemphasizedSelectedTextColor\" value:[NSColor unemphasizedSelectedTextColor]];\n+        [PlatformSupport putColor:preferences key:\"macOS.NSColor.unemphasizedSelectedTextBackgroundColor\" value:[NSColor unemphasizedSelectedTextBackgroundColor]];\n+    }\n+\n+    \/\/ Content colors\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.linkColor\" value:[NSColor linkColor]];\n+    if (MACOS_10_14) {\n+        [PlatformSupport putColor:preferences key:\"macOS.NSColor.separatorColor\" value:[NSColor separatorColor]];\n+        [PlatformSupport putColor:preferences key:\"macOS.NSColor.selectedContentBackgroundColor\" value:[NSColor selectedContentBackgroundColor]];\n+        [PlatformSupport putColor:preferences key:\"macOS.NSColor.unemphasizedSelectedContentBackgroundColor\" value:[NSColor unemphasizedSelectedContentBackgroundColor]];\n+    }\n+\n+    \/\/ Menu colors\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.selectedMenuItemTextColor\" value:[NSColor selectedMenuItemTextColor]];\n+\n+    \/\/ Table colors\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.gridColor\" value:[NSColor gridColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.headerTextColor\" value:[NSColor headerTextColor]];\n+    if (MACOS_10_14) {\n+        [PlatformSupport putColors:preferences key:\"macOS.NSColor.alternatingContentBackgroundColors\" value:[NSColor alternatingContentBackgroundColors]];\n+    }\n+\n+    \/\/ Control colors\n+    if (MACOS_10_14) {\n+        [PlatformSupport putColor:preferences key:\"macOS.NSColor.controlAccentColor\" value:[NSColor controlAccentColor]];\n+    }\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.controlColor\" value:[NSColor controlColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.controlBackgroundColor\" value:[NSColor controlBackgroundColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.controlTextColor\" value:[NSColor controlTextColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.disabledControlTextColor\" value:[NSColor disabledControlTextColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.selectedControlColor\" value:[NSColor selectedControlColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.selectedControlTextColor\" value:[NSColor selectedControlTextColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.alternateSelectedControlTextColor\" value:[NSColor alternateSelectedControlTextColor]];\n+\n+    const char* controlTint = nil;\n+    switch ([NSColor currentControlTint]) {\n+        case NSDefaultControlTint: controlTint = \"NSDefaultControlTint\"; break;\n+        case NSGraphiteControlTint: controlTint = \"NSGraphiteControlTint\"; break;\n+        case NSBlueControlTint: controlTint = \"NSBlueControlTint\"; break;\n+        case NSClearControlTint: controlTint = \"NSClearControlTint\"; break;\n+    }\n+    if (controlTint != nil) {\n+        [PlatformSupport putString:preferences key:\"macOS.NSColor.currentControlTint\" value:controlTint];\n+    }\n+\n+    \/\/ Window colors\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.windowBackgroundColor\" value:[NSColor windowBackgroundColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.windowFrameTextColor\" value:[NSColor windowFrameTextColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.underPageBackgroundColor\" value:[NSColor underPageBackgroundColor]];\n+\n+    \/\/ Highlights and shadows\n+    if (MACOS_10_13) {\n+        [PlatformSupport putColor:preferences key:\"macOS.NSColor.findHighlightColor\" value:[NSColor findHighlightColor]];\n+    }\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.highlightColor\" value:[NSColor highlightColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.shadowColor\" value:[NSColor shadowColor]];\n+\n+    \/\/ Adaptable system colors\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemBlueColor\" value:[NSColor systemBlueColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemBrownColor\" value:[NSColor systemBrownColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemGrayColor\" value:[NSColor systemGrayColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemGreenColor\" value:[NSColor systemGreenColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemIndigoColor\" value:[NSColor systemIndigoColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemOrangeColor\" value:[NSColor systemOrangeColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemPinkColor\" value:[NSColor systemPinkColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemPurpleColor\" value:[NSColor systemPurpleColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemRedColor\" value:[NSColor systemRedColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemTealColor\" value:[NSColor systemTealColor]];\n+    [PlatformSupport putColor:preferences key:\"macOS.NSColor.systemYellowColor\" value:[NSColor systemYellowColor]];\n+}\n+\n++ (void)updatePreferences:(jobject)application {\n+    GET_MAIN_JENV;\n+\n+    jobject newPreferences = [self collectPreferences];\n+    if (newPreferences == nil) {\n+        return;\n+    }\n+\n+    jboolean preferencesChanged = !(*env)->CallBooleanMethod(\n+        env, newPreferences, jObjectEqualsMethod, currentPreferences);\n+    GLASS_CHECK_EXCEPTION(env);\n+\n+    if (preferencesChanged) {\n+        if (currentPreferences != nil) {\n+            (*env)->DeleteGlobalRef(env, currentPreferences);\n+        }\n+\n+        currentPreferences = (*env)->NewGlobalRef(env, newPreferences);\n+\n+        jobject unmodifiablePreferences = (*env)->CallStaticObjectMethod(\n+            env, jCollectionsClass, jCollectionsUnmodifiableMapMethod, newPreferences);\n+        GLASS_CHECK_EXCEPTION(env);\n+\n+        if (unmodifiablePreferences != nil) {\n+            (*env)->CallVoidMethod(\n+                env, application,\n+                javaIDs.MacApplication.notifyPreferencesChanged,\n+                unmodifiablePreferences);\n+\n+            (*env)->DeleteLocalRef(env, unmodifiablePreferences);\n+        }\n+\n+    }\n+\n+    (*env)->DeleteLocalRef(env, newPreferences);\n+}\n+\n++ (void)putString:(jobject)preferences key:(const char*)key value:(const char*)value {\n+    GET_MAIN_JENV;\n+\n+    (*env)->CallObjectMethod(env, preferences, jMapPutMethod,\n+        (*env)->NewStringUTF(env, key),\n+        value != nil ? (*env)->NewStringUTF(env, value) : nil);\n+}\n+\n++ (void)putColor:(jobject)preferences key:(const char*)colorName value:(NSColor*)color {\n+    GET_MAIN_JENV;\n+\n+    NSColor* c = [color colorUsingColorSpace:[NSColorSpace deviceRGBColorSpace]];\n+    (*env)->CallObjectMethod(env, preferences, jMapPutMethod,\n+        (*env)->NewStringUTF(env, colorName),\n+        (*env)->CallStaticObjectMethod(\n+            env, jColorClass, jColorRgbMethod,\n+            (int)([c redComponent] * 255.0f),\n+            (int)([c greenComponent] * 255.0f),\n+            (int)([c blueComponent] * 255.0f),\n+            (double)[c alphaComponent]));\n+}\n+\n++ (void)putColors:(jobject)preferences key:(const char*)colorName value:(NSArray*)colors {\n+    GET_MAIN_JENV;\n+\n+    int count = [colors count];\n+    jobjectArray res = (*env)->NewObjectArray(env, count, jColorClass, nil);\n+\n+    for (int i = 0; i < count; ++i) {\n+        NSColor* c = [colors[i] colorUsingColorSpace:[NSColorSpace deviceRGBColorSpace]];\n+        jobject fxcolor = (*env)->CallStaticObjectMethod(\n+            env, jColorClass, jColorRgbMethod,\n+            (int)([c redComponent] * 255.0f),\n+            (int)([c greenComponent] * 255.0f),\n+            (int)([c blueComponent] * 255.0f),\n+            (double)[c alphaComponent]);\n+\n+        (*env)->SetObjectArrayElement(env, res, i, fxcolor);\n+    }\n+\n+    (*env)->CallObjectMethod(env, preferences, jMapPutMethod, (*env)->NewStringUTF(env, colorName), res);\n+}\n+\n+@end\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/PlatformSupport.m","additions":281,"deletions":0,"binary":false,"changes":281,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,1 @@\n+#include \"RoActivationSupport.h\"\n@@ -101,1 +102,1 @@\n-GlassApplication::GlassApplication(jobject jrefThis) : BaseWnd()\n+GlassApplication::GlassApplication(jobject jrefThis) : BaseWnd(), m_platformSupport(GetEnv())\n@@ -126,14 +127,0 @@\n-jstring GlassApplication::GetThemeName(JNIEnv* env)\n-{\n-    HIGHCONTRAST contrastInfo;\n-    contrastInfo.cbSize = sizeof(HIGHCONTRAST);\n-    ::SystemParametersInfo(SPI_GETHIGHCONTRAST, sizeof(HIGHCONTRAST), &contrastInfo, 0);\n-    if (contrastInfo.dwFlags & HCF_HIGHCONTRASTON) {\n-        jsize length = (jsize) wcslen(contrastInfo.lpszDefaultScheme);\n-        jstring jstr = env->NewString((jchar*) contrastInfo.lpszDefaultScheme, length);\n-        if (CheckAndClearException(env)) return NULL;\n-        return jstr;\n-    }\n-    return NULL;\n-}\n-\n@@ -184,0 +171,5 @@\n+            if (((UINT)wParam == SPI_GETHIGHCONTRAST ||\n+                    lParam != NULL && wcscmp(LPCWSTR(lParam), L\"ImmersiveColorSet\") == 0) &&\n+                    m_platformSupport.updatePreferences(m_grefThis)) {\n+                return 0;\n+            }\n@@ -191,7 +183,7 @@\n-        case WM_THEMECHANGED: {\n-            JNIEnv* env = GetEnv();\n-            jstring themeName = GlassApplication::GetThemeName(env);\n-            jboolean result = env->CallBooleanMethod(m_grefThis, javaIDs.Application.notifyThemeChangedMID, themeName);\n-            if (CheckAndClearException(env)) return 1;\n-            return !result;\n-        }\n+        case WM_THEMECHANGED:\n+        case WM_SYSCOLORCHANGE:\n+        case WM_DWMCOLORIZATIONCOLORCHANGED:\n+            if (m_platformSupport.updatePreferences(m_grefThis)) {\n+                return 0;\n+            }\n+            break;\n@@ -316,0 +308,3 @@\n+        tryInitializeRoActivationSupport();\n+    } else if (dwReason == DLL_PROCESS_DETACH) {\n+        uninitializeRoActivationSupport();\n@@ -341,3 +336,3 @@\n-    javaIDs.Application.notifyThemeChangedMID =\n-        env->GetMethodID(cls, \"notifyThemeChanged\", \"(Ljava\/lang\/String;)Z\");\n-    ASSERT(javaIDs.Application.notifyThemeChangedMID);\n+    javaIDs.Application.notifyPreferencesChangedMID =\n+        env->GetMethodID(cls, \"notifyPreferencesChanged\", \"(Ljava\/util\/Map;)V\");\n+    ASSERT(javaIDs.Application.notifyPreferencesChangedMID);\n@@ -454,11 +449,0 @@\n-\/*\n- * Class:     com_sun_glass_ui_win_WinApplication\n- * Method:    _getHighContrastTheme\n- * Signature: ()Ljava\/lang\/String;\n- *\/\n-JNIEXPORT jstring JNICALL Java_com_sun_glass_ui_win_WinApplication__1getHighContrastTheme\n-  (JNIEnv * env, jobject self)\n-{\n-    return GlassApplication::GetThemeName(env);\n-}\n-\n@@ -538,0 +522,11 @@\n+\/*\n+ * Class:     com_sun_glass_ui_win_WinApplication\n+ * Method:    getPlatformPreferences\n+ * Signature: ()Ljava\/util\/Map;\n+ *\/\n+JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_win_WinApplication_getPlatformPreferences\n+    (JNIEnv * env, jobject self)\n+{\n+    return GlassApplication::GetPlatformPreferences();\n+}\n+\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/GlassApplication.cpp","additions":32,"deletions":37,"binary":false,"changes":69,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,1 +30,1 @@\n-\n+#include \"PlatformSupport.h\"\n@@ -84,1 +84,4 @@\n-    static jstring GetThemeName(JNIEnv* env);\n+\n+    static jobject GetPlatformPreferences() {\n+        return pInstance ? pInstance->m_platformSupport.collectPreferences() : NULL;\n+    }\n@@ -128,0 +131,1 @@\n+    PlatformSupport m_platformSupport;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/GlassApplication.h","additions":7,"deletions":3,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -0,0 +1,234 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#include \"PlatformSupport.h\"\n+#include \"RoActivationSupport.h\"\n+#include <windows.ui.viewmanagement.h>\n+#include <tuple>\n+\n+using namespace Microsoft::WRL;\n+using namespace ABI::Windows::UI;\n+using namespace ABI::Windows::UI::ViewManagement;\n+\n+PlatformSupport::PlatformSupport(JNIEnv* env) : env(env), initialized(false)\n+{\n+    javaClasses.Object = (jclass)env->FindClass(\"java\/lang\/Object\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaIDs.Object.equals = env->GetMethodID(javaClasses.Object, \"equals\", \"(Ljava\/lang\/Object;)Z\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaClasses.Collections = (jclass)env->FindClass(\"java\/util\/Collections\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaIDs.Collections.unmodifiableMap = env->GetStaticMethodID(\n+        javaClasses.Collections, \"unmodifiableMap\", \"(Ljava\/util\/Map;)Ljava\/util\/Map;\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaClasses.Map = (jclass)env->FindClass(\"java\/util\/Map\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaIDs.Map.put = env->GetMethodID(\n+        javaClasses.Map, \"put\", \"(Ljava\/lang\/Object;Ljava\/lang\/Object;)Ljava\/lang\/Object;\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaClasses.HashMap = (jclass)env->FindClass(\"java\/util\/HashMap\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaIDs.HashMap.init = env->GetMethodID(javaClasses.HashMap, \"<init>\", \"()V\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaClasses.Color = (jclass)env->FindClass(\"javafx\/scene\/paint\/Color\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaIDs.Color.rgb = env->GetStaticMethodID(javaClasses.Color, \"rgb\", \"(IIID)Ljavafx\/scene\/paint\/Color;\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaClasses.Boolean = (jclass)env->FindClass(\"java\/lang\/Boolean\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaIDs.Boolean.trueID = env->GetStaticFieldID(javaClasses.Boolean, \"TRUE\", \"Ljava\/lang\/Boolean;\");\n+    if (CheckAndClearException(env)) return;\n+\n+    javaIDs.Boolean.falseID = env->GetStaticFieldID(javaClasses.Boolean, \"FALSE\", \"Ljava\/lang\/Boolean;\");\n+    if (CheckAndClearException(env)) return;\n+\n+    initialized = true;\n+}\n+\n+jobject PlatformSupport::collectPreferences() const\n+{\n+    if (!initialized) {\n+        return NULL;\n+    }\n+\n+    jobject prefs = env->NewObject(javaClasses.HashMap, javaIDs.HashMap.init);\n+    if (CheckAndClearException(env)) return NULL;\n+\n+    queryHighContrastScheme(prefs);\n+    querySystemColors(prefs);\n+    queryUIColors(prefs);\n+    return prefs;\n+}\n+\n+bool PlatformSupport::updatePreferences(jobject application) const\n+{\n+    if (!initialized || application == NULL) {\n+        return false;\n+    }\n+\n+    jobject newPreferences = collectPreferences();\n+\n+    jboolean preferencesChanged =\n+        newPreferences != NULL &&\n+        !env->CallBooleanMethod(newPreferences, javaIDs.Object.equals, preferences);\n+\n+    if (!CheckAndClearException(env) && preferencesChanged) {\n+        preferences = newPreferences;\n+        jobject unmodifiablePreferences = env->CallStaticObjectMethod(\n+            javaClasses.Collections, javaIDs.Collections.unmodifiableMap, newPreferences);\n+\n+        if (!CheckAndClearException(env)) {\n+            env->CallVoidMethod(application, javaIDs.Application.notifyPreferencesChangedMID, unmodifiablePreferences);\n+            env->DeleteLocalRef(unmodifiablePreferences);\n+            env->DeleteLocalRef(newPreferences);\n+            return true;\n+        }\n+    }\n+\n+    env->DeleteLocalRef(newPreferences);\n+    return false;\n+}\n+\n+void PlatformSupport::queryHighContrastScheme(jobject properties) const\n+{\n+    HIGHCONTRAST contrastInfo;\n+    contrastInfo.cbSize = sizeof(HIGHCONTRAST);\n+    ::SystemParametersInfo(SPI_GETHIGHCONTRAST, sizeof(HIGHCONTRAST), &contrastInfo, 0);\n+    if (contrastInfo.dwFlags & HCF_HIGHCONTRASTON) {\n+        putBoolean(properties, \"Windows.SPI.HighContrastOn\", true);\n+        putString(properties, \"Windows.SPI.HighContrastColorScheme\", contrastInfo.lpszDefaultScheme);\n+    } else {\n+        putBoolean(properties, \"Windows.SPI.HighContrastOn\", false);\n+        putString(properties, \"Windows.SPI.HighContrastColorScheme\", (const char*)NULL);\n+    }\n+}\n+\n+void PlatformSupport::querySystemColors(jobject properties) const\n+{\n+    putColor(properties, \"Windows.SysColor.COLOR_3DFACE\", GetSysColor(COLOR_3DFACE));\n+    putColor(properties, \"Windows.SysColor.COLOR_BTNTEXT\", GetSysColor(COLOR_BTNTEXT));\n+    putColor(properties, \"Windows.SysColor.COLOR_GRAYTEXT\", GetSysColor(COLOR_GRAYTEXT));\n+    putColor(properties, \"Windows.SysColor.COLOR_HIGHLIGHT\", GetSysColor(COLOR_HIGHLIGHT));\n+    putColor(properties, \"Windows.SysColor.COLOR_HIGHLIGHTTEXT\", GetSysColor(COLOR_HIGHLIGHTTEXT));\n+    putColor(properties, \"Windows.SysColor.COLOR_HOTLIGHT\", GetSysColor(COLOR_HOTLIGHT));\n+    putColor(properties, \"Windows.SysColor.COLOR_WINDOW\", GetSysColor(COLOR_WINDOW));\n+    putColor(properties, \"Windows.SysColor.COLOR_WINDOWTEXT\", GetSysColor(COLOR_WINDOWTEXT));\n+}\n+\n+void PlatformSupport::queryUIColors(jobject properties) const\n+{\n+    if (!isRoActivationSupported()) {\n+        return;\n+    }\n+\n+    try {\n+        ComPtr<IUISettings> settings;\n+        RO_CHECKED(\"RoActivateInstance\",\n+                   RoActivateInstance(hstring(\"Windows.UI.ViewManagement.UISettings\"), (IInspectable**)&settings));\n+\n+        ComPtr<IUISettings3> settings3;\n+        RO_CHECKED(\"IUISettings::QueryInterface<IUISettings3>\",\n+                   settings->QueryInterface<IUISettings3>(&settings3));\n+\n+        Color background, foreground, accentDark3, accentDark2, accentDark1, accent,\n+              accentLight1, accentLight2, accentLight3;\n+\n+        settings3->GetColorValue(UIColorType::UIColorType_Background, &background);\n+        settings3->GetColorValue(UIColorType::UIColorType_Foreground, &foreground);\n+        settings3->GetColorValue(UIColorType::UIColorType_AccentDark3, &accentDark3);\n+        settings3->GetColorValue(UIColorType::UIColorType_AccentDark2, &accentDark2);\n+        settings3->GetColorValue(UIColorType::UIColorType_AccentDark1, &accentDark1);\n+        settings3->GetColorValue(UIColorType::UIColorType_Accent, &accent);\n+        settings3->GetColorValue(UIColorType::UIColorType_AccentLight1, &accentLight1);\n+        settings3->GetColorValue(UIColorType::UIColorType_AccentLight2, &accentLight2);\n+        settings3->GetColorValue(UIColorType::UIColorType_AccentLight3, &accentLight3);\n+\n+        putColor(properties, \"Windows.UIColor.Background\", background);\n+        putColor(properties, \"Windows.UIColor.Foreground\", foreground);\n+        putColor(properties, \"Windows.UIColor.AccentDark3\", accentDark3);\n+        putColor(properties, \"Windows.UIColor.AccentDark2\", accentDark2);\n+        putColor(properties, \"Windows.UIColor.AccentDark1\", accentDark1);\n+        putColor(properties, \"Windows.UIColor.Accent\", accent);\n+        putColor(properties, \"Windows.UIColor.AccentLight1\", accentLight1);\n+        putColor(properties, \"Windows.UIColor.AccentLight2\", accentLight2);\n+        putColor(properties, \"Windows.UIColor.AccentLight3\", accentLight3);\n+    } catch (RoException const&) {\n+        \/\/ If an activation exception occurs, it probably means that we're on a Windows system\n+        \/\/ that doesn't support the UISettings API. This is not a problem, it simply means that\n+        \/\/ we don't report the UISettings properties back to the JavaFX application.\n+        return;\n+    }\n+}\n+\n+void PlatformSupport::putString(jobject properties, const char* key, const char* value) const\n+{\n+    env->CallObjectMethod(properties, javaIDs.Map.put,\n+        env->NewStringUTF(key),\n+        value != NULL ? env->NewStringUTF(value) : NULL);\n+}\n+\n+void PlatformSupport::putString(jobject properties, const char* key, const wchar_t* value) const\n+{\n+    env->CallObjectMethod(properties, javaIDs.Map.put,\n+        env->NewStringUTF(key),\n+        value != NULL ? env->NewString((jchar*)value, wcslen(value)) : NULL);\n+}\n+\n+void PlatformSupport::putBoolean(jobject properties, const char* key, const bool value) const\n+{\n+    env->CallObjectMethod(properties, javaIDs.Map.put,\n+        env->NewStringUTF(key),\n+        value ? env->GetStaticObjectField(javaClasses.Boolean, javaIDs.Boolean.trueID) :\n+                env->GetStaticObjectField(javaClasses.Boolean, javaIDs.Boolean.falseID));\n+}\n+\n+void PlatformSupport::putColor(jobject properties, const char* colorName, int colorValue) const\n+{\n+    env->CallObjectMethod(properties, javaIDs.Map.put,\n+        env->NewStringUTF(colorName),\n+        env->CallStaticObjectMethod(\n+            javaClasses.Color, javaIDs.Color.rgb,\n+            GetRValue(colorValue), GetGValue(colorValue), GetBValue(colorValue), 1.0));\n+}\n+\n+void PlatformSupport::putColor(jobject properties, const char* colorName, Color colorValue) const\n+{\n+    env->CallObjectMethod(properties, javaIDs.Map.put,\n+        env->NewStringUTF(colorName),\n+        env->CallStaticObjectMethod(\n+            javaClasses.Color, javaIDs.Color.rgb,\n+            colorValue.R, colorValue.G, colorValue.B, (double)colorValue.A \/ 255.0));\n+}\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/PlatformSupport.cpp","additions":234,"deletions":0,"binary":false,"changes":234,"status":"added"},{"patch":"@@ -0,0 +1,74 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#pragma once\n+\n+#include <common.h>\n+\n+namespace ABI { namespace Windows { namespace UI { struct Color; } } }\n+\n+class PlatformSupport final\n+{\n+public:\n+    PlatformSupport(JNIEnv*);\n+    ~PlatformSupport() = default;\n+    PlatformSupport(PlatformSupport const&) = delete;\n+    PlatformSupport& operator=(PlatformSupport const&) = delete;\n+\n+    \/**\n+     * Collect all platform preferences and return them as a new java\/util\/Map.\n+     *\/\n+    jobject collectPreferences() const;\n+\n+    \/**\n+     * Collect all platform preferences and notify the JavaFX application when a preference has changed.\n+     * The change notification includes all preferences, not only the changed preferences.\n+     *\/\n+    bool updatePreferences(jobject application) const;\n+\n+private:\n+    JNIEnv* env;\n+    bool initialized;\n+    mutable JGlobalRef<jobject> preferences;\n+\n+    struct {\n+        JGlobalRef<jclass> Boolean;\n+        JGlobalRef<jclass> Object;\n+        JGlobalRef<jclass> Collections;\n+        JGlobalRef<jclass> Map;\n+        JGlobalRef<jclass> HashMap;\n+        JGlobalRef<jclass> Color;\n+    } javaClasses;\n+\n+    void querySystemColors(jobject properties) const;\n+    void queryHighContrastScheme(jobject properties) const;\n+    void queryUIColors(jobject properties) const;\n+\n+    void putString(jobject properties, const char* key, const char* value) const;\n+    void putString(jobject properties, const char* key, const wchar_t* value) const;\n+    void putBoolean(jobject properties, const char* key, const bool value) const;\n+    void putColor(jobject properties, const char* colorName, int colorValue) const;\n+    void putColor(jobject properties, const char* colorName, ABI::Windows::UI::Color colorValue) const;\n+};\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/PlatformSupport.h","additions":74,"deletions":0,"binary":false,"changes":74,"status":"added"},{"patch":"@@ -0,0 +1,240 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#include \"RoActivationSupport.h\"\n+#include <comdef.h>\n+#include <winstring.h>\n+#include <jni.h>\n+\n+namespace\n+{\n+    bool initialized = false;\n+    const char* moduleNotFoundMessage = \"WinRT: %s not found\\n\";\n+\n+    const char* catStrW(const char* s1, const wchar_t* s2w)\n+    {\n+        int s1_len = int(strlen(s1));\n+        int s2_len = WideCharToMultiByte(CP_ACP, 0, s2w, -1, NULL, 0, NULL, FALSE);\n+        char* res = new char[s1_len + s2_len];\n+        WideCharToMultiByte(CP_ACP, 0, s2w, -1, res + s1_len, s2_len, NULL, FALSE);\n+        memcpy_s(res, s1_len + s2_len, s1, s1_len);\n+        return res;\n+    }\n+\n+    typedef HRESULT WINAPI FnRoInitialize(RO_INIT_TYPE initType);\n+    typedef void WINAPI FnRoUninitialize();\n+    typedef HRESULT WINAPI FnRoActivateInstance(HSTRING activatableClassId, IInspectable** instance);\n+    typedef HRESULT WINAPI FnWindowsCreateString(PCNZWCH sourceString, UINT32 length, HSTRING* string);\n+    typedef HRESULT WINAPI FnWindowsDeleteString(HSTRING string);\n+\n+    HMODULE hLibComBase = NULL;\n+    FnRoInitialize* pRoInitialize = NULL;\n+    FnRoUninitialize* pRoUninitialize = NULL;\n+    FnRoActivateInstance* pRoActivateInstance = NULL;\n+    FnWindowsCreateString* pWindowsCreateString = NULL;\n+    FnWindowsDeleteString* pWindowsDeleteString = NULL;\n+\n+    template<class T>\n+    bool loadFunction(HMODULE lib, T*& fnptr, const char* name)\n+    {\n+        fnptr = reinterpret_cast<T*>(GetProcAddress(lib, name));\n+        if (fnptr == nullptr) {\n+            fprintf(stderr, \"GetProcAddress: %s not loaded\\n\", name);\n+            initialized = false;\n+            return false;\n+        }\n+\n+        return true;\n+    }\n+}\n+\n+void tryInitializeRoActivationSupport()\n+{\n+    if (initialized) {\n+        return;\n+    }\n+\n+    wchar_t path[MAX_PATH];\n+    wchar_t file[MAX_PATH];\n+\n+    if (GetSystemDirectory(path, sizeof(path) \/ sizeof(wchar_t)) == 0) {\n+        return;\n+    }\n+\n+    memcpy_s(file, sizeof(file), path, sizeof(path));\n+    wcscat_s(file, MAX_PATH-1, L\"\\\\combase.dll\");\n+    hLibComBase = LoadLibraryW(file);\n+    if (!hLibComBase) {\n+        fprintf(stderr, moduleNotFoundMessage, \"combase.dll\");\n+        return;\n+    }\n+\n+    bool loaded =\n+        loadFunction(hLibComBase, pRoInitialize, \"RoInitialize\") &&\n+        loadFunction(hLibComBase, pRoUninitialize, \"RoUninitialize\") &&\n+        loadFunction(hLibComBase, pRoActivateInstance, \"RoActivateInstance\") &&\n+        loadFunction(hLibComBase, pWindowsCreateString, \"WindowsCreateString\") &&\n+        loadFunction(hLibComBase, pWindowsDeleteString, \"WindowsDeleteString\");\n+\n+    if (!loaded) {\n+        uninitializeRoActivationSupport();\n+    } else {\n+        HRESULT res = RoInitialize(RO_INIT_SINGLETHREADED);\n+        if (FAILED(res)) {\n+            fprintf(stderr, RoException(\"RoInitialize failed: \", res).message());\n+            uninitializeRoActivationSupport();\n+        } else {\n+            initialized = true;\n+        }\n+    }\n+}\n+\n+void uninitializeRoActivationSupport()\n+{\n+    if (initialized) {\n+        RoUninitialize();\n+    }\n+\n+    initialized = false;\n+\n+    if (hLibComBase) {\n+        FreeLibrary(hLibComBase);\n+        hLibComBase = NULL;\n+        pRoInitialize = NULL;\n+        pRoUninitialize = NULL;\n+        pRoActivateInstance = NULL;\n+        pWindowsCreateString = NULL;\n+        pWindowsDeleteString = NULL;\n+    }\n+}\n+\n+bool isRoActivationSupported()\n+{\n+    return initialized;\n+}\n+\n+HRESULT WINAPI RoInitialize(RO_INIT_TYPE initType)\n+{\n+    return pRoInitialize(initType);\n+}\n+\n+void WINAPI RoUninitialize()\n+{\n+    pRoUninitialize();\n+}\n+\n+HRESULT WINAPI RoActivateInstance(HSTRING activatableClassId, IInspectable** instance)\n+{\n+    return pRoActivateInstance(activatableClassId, instance);\n+}\n+\n+HRESULT WINAPI WindowsCreateString(PCNZWCH sourceString, UINT32 length, HSTRING* string)\n+{\n+    return pWindowsCreateString(sourceString, length, string);\n+}\n+\n+HRESULT WINAPI WindowsDeleteString(HSTRING string)\n+{\n+    return pWindowsDeleteString(string);\n+}\n+\n+hstring::hstring(const char* str)\n+{\n+    int wstr_len = MultiByteToWideChar(CP_UTF8, 0, str, -1, nullptr, 0);\n+    WCHAR* wstr = new WCHAR[wstr_len];\n+    memset(wstr, 0, wstr_len * sizeof(WCHAR));\n+    MultiByteToWideChar(CP_UTF8, 0, str, -1, wstr, wstr_len);\n+    WindowsCreateString(wstr, wstr_len - 1, &hstr_);\n+    delete[] wstr;\n+}\n+\n+hstring::~hstring()\n+{\n+    WindowsDeleteString(hstr_);\n+}\n+\n+hstring::operator HSTRING()\n+{\n+    return hstr_;\n+}\n+\n+RoException::RoException(const char* message)\n+{\n+    size_t len = strlen(message);\n+    char* msg = new char[len + 1];\n+    strcpy_s(msg, len + 1, message);\n+    message_ = msg;\n+}\n+\n+RoException::RoException(const char* message, HRESULT res)\n+{\n+    message_ = catStrW(message, _com_error(res).ErrorMessage());\n+}\n+\n+RoException::RoException(const RoException& source) : RoException(source.message()) {}\n+\n+RoException::RoException(RoException&& source)\n+{\n+    message_ = source.message_;\n+    source.message_ = nullptr;\n+}\n+\n+RoException::~RoException()\n+{\n+    if (message_ != nullptr) {\n+        delete[] message_;\n+    }\n+}\n+\n+RoException& RoException::operator=(const RoException& source)\n+{\n+    if (message_ != nullptr) {\n+        delete[] message_;\n+    }\n+\n+    size_t len = strlen(source.message());\n+    char* msg = new char[len + 1];\n+    strcpy_s(msg, len + 1, source.message());\n+    message_ = msg;\n+\n+    return *this;\n+}\n+\n+RoException& RoException::operator=(RoException&& source)\n+{\n+    if (message_ != nullptr) {\n+        delete[] message_;\n+    }\n+\n+    message_ = source.message_;\n+    source.message_ = nullptr;\n+\n+    return *this;\n+}\n+\n+const char* RoException::message() const\n+{\n+    return message_;\n+}\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/RoActivationSupport.cpp","additions":240,"deletions":0,"binary":false,"changes":240,"status":"added"},{"patch":"@@ -0,0 +1,66 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#pragma once\n+\n+#define _ROAPI_\n+#include <roapi.h>\n+#include <wrl.h>\n+#include <hstring.h>\n+\n+#define RO_CHECKED(NAME, FUNC) \\\n+    { HRESULT res = FUNC; if (FAILED(res)) throw RoException(NAME ## \" failed: \", res); }\n+\n+struct hstring\n+{\n+    hstring(const char* str);\n+    ~hstring();\n+    operator HSTRING();\n+\n+private:\n+    HSTRING hstr_;\n+};\n+\n+void tryInitializeRoActivationSupport();\n+void uninitializeRoActivationSupport();\n+bool isRoActivationSupported();\n+\n+class RoException\n+{\n+public:\n+    RoException(const char* message);\n+    RoException(const char* message, HRESULT);\n+    RoException(const RoException&);\n+    RoException(RoException&&);\n+    ~RoException();\n+\n+    RoException& operator=(const RoException&);\n+    RoException& operator=(RoException&&);\n+\n+    const char* message() const;\n+\n+private:\n+    const char* message_;\n+};\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/RoActivationSupport.h","additions":66,"deletions":0,"binary":false,"changes":66,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2014, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -291,3 +291,3 @@\n-    operator T() { return m_localJRef; }\n-    operator bool() { return NULL!=m_localJRef; }\n-    bool operator !() { return NULL==m_localJRef; }\n+    operator T() const { return m_localJRef; }\n+    operator bool() const { return NULL!=m_localJRef; }\n+    bool operator !() const { return NULL==m_localJRef; }\n@@ -329,3 +329,3 @@\n-    operator T() { return m_globalJRef; }\n-    operator bool() { return NULL!=m_globalJRef; }\n-    bool operator !() { return NULL==m_globalJRef; }\n+    operator T() const { return m_globalJRef; }\n+    operator bool() const { return NULL!=m_globalJRef; }\n+    bool operator !() const { return NULL==m_globalJRef; }\n@@ -506,1 +506,1 @@\n-        jmethodID notifyThemeChangedMID;\n+        jmethodID notifyPreferencesChangedMID;\n@@ -508,0 +508,19 @@\n+    struct {\n+        jmethodID rgb;\n+    } Color;\n+    struct {\n+        jfieldID trueID;\n+        jfieldID falseID;\n+    } Boolean;\n+    struct {\n+        jmethodID equals;\n+    } Object;\n+    struct {\n+        jmethodID unmodifiableMap;\n+    } Collections;\n+    struct {\n+        jmethodID put;\n+    } Map;\n+    struct {\n+        jmethodID init;\n+    } HashMap;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/Utils.h","additions":27,"deletions":8,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -0,0 +1,116 @@\n+\/*\n+ * Copyright (c) 2023 Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.com.sun.javafx.application;\n+\n+import com.sun.javafx.application.PlatformPreferencesImpl;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import test.javafx.collections.MockMapObserver;\n+import javafx.beans.InvalidationListener;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static com.sun.javafx.application.PlatformImpl.*;\n+import static org.junit.jupiter.api.Assertions.*;\n+import static test.javafx.collections.MockMapObserver.Tuple.*;\n+\n+public class PlatformImplTest {\n+\n+    private static Map<String, Object> preferences;\n+    private static Map<String, Object> originalPreferences;\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        preferences.clear();\n+    }\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        originalPreferences = new HashMap<>(getPlatformPreferences());\n+        preferences = ((PlatformPreferencesImpl)getPlatformPreferences()).getModifiableMap();\n+    }\n+\n+    @AfterAll\n+    static void afterAll() {\n+        preferences.clear();\n+        preferences.putAll(originalPreferences);\n+    }\n+\n+    @Test\n+    public void testUpdatePlatformPreferences() {\n+        Map<String, Object> newPrefs = Map.of(\"foo\", \"bar\", \"baz\", \"qux\");\n+        updatePreferences(newPrefs);\n+        assertEquals(newPrefs, getPlatformPreferences());\n+    }\n+\n+    @Test\n+    public void testPlatformPreferencesInvalidationListener() {\n+        int[] count = new int[1];\n+        InvalidationListener listener = observable -> count[0]++;\n+        getPlatformPreferences().addListener(listener);\n+\n+        updatePreferences(Map.of(\"foo\", \"bar\"));\n+        assertEquals(1, count[0]);\n+\n+        \/\/ InvalidationListener is invoked only once, even when multiple values are changed at the same time\n+        updatePreferences(Map.of(\"qux\", \"quux\", \"quz\", \"quuz\"));\n+        assertEquals(2, count[0]);\n+\n+        getPlatformPreferences().removeListener(listener);\n+    }\n+\n+    @Test\n+    public void testPlatformPreferencesChangeListener() {\n+        var observer = new MockMapObserver<String, Object>();\n+        getPlatformPreferences().addListener(observer);\n+\n+        \/\/ Two added keys are included in the change notification\n+        updatePreferences(Map.of(\"foo\", \"bar\", \"baz\", \"qux\"));\n+        observer.assertAdded(0, tup(\"foo\", \"bar\"));\n+        observer.assertAdded(1, tup(\"baz\", \"qux\"));\n+        observer.clear();\n+\n+        \/\/ Mappings that haven't changed are not included in the change notification\n+        updatePreferences(Map.of(\"foo\", \"bar2\", \"baz\", \"qux\"));\n+        observer.assertAdded(0, tup(\"foo\", \"bar2\"));\n+        observer.clear();\n+\n+        \/\/ Change the second mapping\n+        updatePreferences(Map.of(\"baz\", \"qux2\"));\n+        observer.assertAdded(0, tup(\"baz\", \"qux2\"));\n+        observer.clear();\n+\n+        \/\/ If no mapping was changed, no change notification is fired\n+        updatePreferences(Map.of(\"foo\", \"bar2\", \"baz\", \"qux2\"));\n+        observer.check0();\n+        observer.clear();\n+\n+        getPlatformPreferences().removeListener(observer);\n+    }\n+\n+}\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/com\/sun\/javafx\/application\/PlatformImplTest.java","additions":116,"deletions":0,"binary":false,"changes":116,"status":"added"},{"patch":"@@ -0,0 +1,85 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import javafx.application.Application;\n+import javafx.application.Platform;\n+import javafx.geometry.Insets;\n+import javafx.scene.Scene;\n+import javafx.scene.control.*;\n+import javafx.scene.control.theme.*;\n+import javafx.scene.layout.*;\n+import javafx.stage.Stage;\n+\n+public class StyleThemeTest extends Application {\n+\n+    @Override\n+    public void start(Stage stage) {\n+        setUserAgentStyleTheme(new ModenaTheme());\n+\n+        var passButton = new Button(\"Pass\");\n+        passButton.setOnAction(e -> Platform.exit());\n+\n+        var failButton = new Button(\"Fail\");\n+        failButton.setOnAction(e -> {\n+            Platform.exit();\n+            throw new AssertionError(\"StyleTheme was not correctly applied\");\n+        });\n+\n+        var toggleGroup = new ToggleGroup();\n+\n+        var modenaButton = new RadioButton(\"Modena\");\n+        modenaButton.setOnAction(e -> setUserAgentStyleTheme(new ModenaTheme()));\n+        modenaButton.setToggleGroup(toggleGroup);\n+        modenaButton.setSelected(true);\n+\n+        var caspianButton = new RadioButton(\"Caspian\");\n+        caspianButton.setOnAction(e -> setUserAgentStyleTheme(new CaspianTheme()));\n+        caspianButton.setToggleGroup(toggleGroup);\n+\n+        var box = new VBox();\n+        box.setSpacing(20);\n+        box.setPadding(new Insets(20));\n+        box.getChildren().add(new VBox(10,\n+            new VBox(5,\n+                new Label(\"1. Use the radio buttons below to switch between Modena and Caspian themes.\"),\n+                new Label(\"2. Observe whether the selected theme is applied to the controls in this window.\"),\n+                new Label(\"3. Click \\\"Pass\\\" if the selected theme is correctly applied, otherwise click \\\"Fail\\\".\")),\n+            new HBox(5, modenaButton, caspianButton),\n+            new HBox(5, passButton, failButton),\n+            new Label(\"Sample controls:\"),\n+            new CheckBox(\"CheckBox\"),\n+            new Slider(),\n+            new Spinner(0, 100, 50)\n+        ));\n+\n+        stage.setScene(new Scene(box));\n+        stage.show();\n+    }\n+\n+    public static void main(String[] args) {\n+        Application.launch(args);\n+    }\n+\n+}\n","filename":"tests\/manual\/UI\/StyleThemeTest.java","additions":85,"deletions":0,"binary":false,"changes":85,"status":"added"},{"patch":"@@ -0,0 +1,114 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import javafx.application.Application;\n+import javafx.application.Platform;\n+import javafx.beans.InvalidationListener;\n+import javafx.geometry.Insets;\n+import javafx.scene.Scene;\n+import javafx.scene.control.Button;\n+import javafx.scene.control.Label;\n+import javafx.scene.control.TextArea;\n+import javafx.scene.layout.BorderPane;\n+import javafx.scene.layout.HBox;\n+import javafx.scene.layout.VBox;\n+import javafx.stage.Stage;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+import java.util.stream.Collectors;\n+\n+public class PlatformPreferencesTest extends Application {\n+\n+    private Map<String, Object> cachedPreferences;\n+\n+    @Override\n+    public void start(Stage stage) {\n+        var passButton = new Button(\"Pass\");\n+        passButton.setOnAction(e -> Platform.exit());\n+\n+        var failButton = new Button(\"Fail\");\n+        failButton.setOnAction(e -> {\n+            Platform.exit();\n+            throw new AssertionError(\"Platform preferences were not correctly reported\");\n+        });\n+\n+        var textArea = new TextArea();\n+        textArea.setEditable(false);\n+\n+        var clearButton = new Button(\"Clear Log\");\n+        clearButton.setOnAction(e -> textArea.setText(\"\"));\n+\n+        var box = new VBox();\n+        box.setSpacing(20);\n+        box.getChildren().add(new VBox(10,\n+            new VBox(\n+                new Label(\"1. On a supported platform, change any of the platform preferences.\"),\n+                new Label(\"    See javafx.application.PlatformPreferences for a list of supported platforms.\")),\n+            new Label(\"2. Observe whether the changed preferences are reported in the log below.\"),\n+            new Label(\"3. Click \\\"Pass\\\" if the changes were correctly reported, otherwise click \\\"Fail\\\".\"),\n+            new HBox(5, passButton, failButton, clearButton)\n+        ));\n+\n+        var root = new BorderPane();\n+        root.setPadding(new Insets(20));\n+        root.setTop(box);\n+        root.setCenter(textArea);\n+        BorderPane.setMargin(textArea, new Insets(20, 0, 0, 0));\n+\n+        cachedPreferences = new HashMap<>(Platform.getPreferences());\n+        textArea.setText(\"preferences = \" + formatPrefs(cachedPreferences.entrySet().stream()));\n+\n+        Platform.getPreferences().addListener(\n+            (InvalidationListener)observable -> {\n+                Stream<Map.Entry<String, Object>> changed = Platform.getPreferences().entrySet().stream()\n+                        .filter(entry -> !Objects.equals(entry.getValue(), cachedPreferences.get(entry.getKey())));\n+\n+                double scrollTop = textArea.getScrollTop();\n+                textArea.setText(textArea.getText() + \"changed = \" + formatPrefs(changed));\n+                textArea.setScrollTop(scrollTop);\n+\n+                cachedPreferences = new HashMap<>(Platform.getPreferences());\n+            });\n+\n+        stage.setScene(new Scene(root));\n+        stage.show();\n+    }\n+\n+    public static void main(String[] args) {\n+        Application.launch(args);\n+    }\n+\n+    private static String formatPrefs(Stream<Map.Entry<String, Object>> prefs) {\n+        String entries = prefs\n+                .sorted(Map.Entry.comparingByKey())\n+                .map(Object::toString)\n+                .collect(Collectors.joining(\"\\r\\n\\t\"));\n+\n+        return \"{\\r\\n\\t\" + entries + \"\\r\\n}\\r\\n\";\n+    }\n+\n+}\n","filename":"tests\/manual\/events\/PlatformPreferencesTest.java","additions":114,"deletions":0,"binary":false,"changes":114,"status":"added"}]}