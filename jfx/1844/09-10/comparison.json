{"files":[{"patch":"@@ -34,0 +34,1 @@\n+import javafx.css.Size;\n@@ -37,5 +38,59 @@\n-    LESS(LessExpression::of),\n-    LESS_OR_EQUAL(LessOrEqualExpression::of),\n-    GREATER(GreaterExpression::of),\n-    GREATER_OR_EQUAL(GreaterOrEqualExpression::of),\n-    EQUAL(EqualExpression::of);\n+    LESS(new RangeExpression.Supplier() {\n+        @Override\n+        public RangeExpression getSizeExpression(SizeQueryType featureType, Size sizeValue) {\n+            return LessExpression.ofSize(featureType, sizeValue);\n+        }\n+\n+        @Override\n+        public RangeExpression getNumberExpression(SizeQueryType featureType, double numberValue) {\n+            return LessExpression.ofNumber(featureType, numberValue);\n+        }\n+    }),\n+\n+    LESS_OR_EQUAL(new RangeExpression.Supplier() {\n+        @Override\n+        public RangeExpression getSizeExpression(SizeQueryType featureType, Size sizeValue) {\n+            return LessOrEqualExpression.ofSize(featureType, sizeValue);\n+        }\n+\n+        @Override\n+        public RangeExpression getNumberExpression(SizeQueryType featureType, double numberValue) {\n+            return LessOrEqualExpression.ofNumber(featureType, numberValue);\n+        }\n+    }),\n+\n+    GREATER(new RangeExpression.Supplier() {\n+        @Override\n+        public RangeExpression getSizeExpression(SizeQueryType featureType, Size sizeValue) {\n+            return GreaterExpression.ofSize(featureType, sizeValue);\n+        }\n+\n+        @Override\n+        public RangeExpression getNumberExpression(SizeQueryType featureType, double numberValue) {\n+            return GreaterExpression.ofNumber(featureType, numberValue);\n+        }\n+    }),\n+\n+    GREATER_OR_EQUAL(new RangeExpression.Supplier() {\n+        @Override\n+        public RangeExpression getSizeExpression(SizeQueryType featureType, Size sizeValue) {\n+            return GreaterOrEqualExpression.ofSize(featureType, sizeValue);\n+        }\n+\n+        @Override\n+        public RangeExpression getNumberExpression(SizeQueryType featureType, double numberValue) {\n+            return GreaterOrEqualExpression.ofNumber(featureType, numberValue);\n+        }\n+    }),\n+\n+    EQUAL(new RangeExpression.Supplier() {\n+        @Override\n+        public RangeExpression getSizeExpression(SizeQueryType featureType, Size sizeValue) {\n+            return EqualExpression.ofSize(featureType, sizeValue);\n+        }\n+\n+        @Override\n+        public RangeExpression getNumberExpression(SizeQueryType featureType, double numberValue) {\n+            return EqualExpression.ofNumber(featureType, numberValue);\n+        }\n+    });\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/ComparisonOp.java","additions":60,"deletions":5,"binary":false,"changes":65,"status":"modified"},{"patch":"@@ -32,2 +32,0 @@\n-import javafx.css.Size;\n-import javafx.css.SizeUnits;\n@@ -180,6 +178,4 @@\n-                                                   RangeExpression.Supplier supplier) {\n-        Size size = lengthValue(\n-            featureType.getFeatureName(),\n-            checkNotNullValue(featureType.getFeatureName(), lowerCaseFeatureValue));\n-\n-        return supplier.rangeExpression(featureType, size);\n+                                                   RangeExpression.Supplier rangeExpressionSupplier) {\n+        return featureType.getQueryExpression(\n+            checkNotNullValue(featureType.getFeatureName(), lowerCaseFeatureValue),\n+            rangeExpressionSupplier);\n@@ -224,30 +220,0 @@\n-    private static Size lengthValue(String featureName, String lowerCaseText) {\n-        int unitIndex = -1;\n-\n-        for (int i = 0; i < lowerCaseText.length(); i++) {\n-            if (!Character.isDigit(lowerCaseText.charAt(i))) {\n-                unitIndex = i;\n-                break;\n-            }\n-        }\n-\n-        if (unitIndex == -1) {\n-            return new Size(Double.parseDouble(lowerCaseText), SizeUnits.PX);\n-        }\n-\n-        double value = Double.parseDouble(lowerCaseText.substring(0, unitIndex));\n-\n-        return new Size(value, switch (lowerCaseText.substring(unitIndex)) {\n-            case \"px\" -> SizeUnits.PX;\n-            case \"em\" -> SizeUnits.EM;\n-            case \"ex\" -> SizeUnits.EX;\n-            case \"cm\" -> SizeUnits.CM;\n-            case \"mm\" -> SizeUnits.MM;\n-            case \"in\" -> SizeUnits.IN;\n-            case \"pt\" -> SizeUnits.PT;\n-            case \"pc\" -> SizeUnits.PC;\n-            default -> throw new IllegalArgumentException(\n-                String.format(\"Invalid value <%s> for media feature <%s>\", lowerCaseText, featureName));\n-        });\n-    }\n-\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/MediaFeatures.java","additions":4,"deletions":38,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -382,2 +382,7 @@\n-                    return MediaFeatures.rangeQueryExpression(\n-                        featureName.getText(), featureValue1.getText(), operator1.flipped());\n+                    try {\n+                        return MediaFeatures.rangeQueryExpression(\n+                            featureName.getText(), featureValue1.getText(), operator1.flipped());\n+                    } catch (IllegalArgumentException ex) {\n+                        errorHandler.accept(tokens.consume(), ex.getMessage());\n+                        return null;\n+                    }\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/MediaQueryParser.java","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -45,0 +45,1 @@\n+import java.util.function.BiFunction;\n@@ -133,2 +134,6 @@\n-                os.writeDouble(expr.getFeatureValue().getValue());\n-                os.writeByte(expr.getFeatureValue().getUnits().ordinal());\n+                os.writeDouble(expr.getFeatureValue());\n+                if (expr.getUnit() != null) {\n+                    os.writeByte(expr.getUnit().ordinal());\n+                } else {\n+                    os.writeByte(-1);\n+                }\n@@ -151,5 +156,5 @@\n-            case EQUAL -> EqualExpression.of(SizeQueryType.of(strings[is.readInt()]), readSize(is));\n-            case GREATER -> GreaterExpression.of(SizeQueryType.of(strings[is.readInt()]), readSize(is));\n-            case GREATER_OR_EQUAL -> GreaterOrEqualExpression.of(SizeQueryType.of(strings[is.readInt()]), readSize(is));\n-            case LESS -> LessExpression.of(SizeQueryType.of(strings[is.readInt()]), readSize(is));\n-            case LESS_OR_EQUAL -> LessOrEqualExpression.of(SizeQueryType.of(strings[is.readInt()]), readSize(is));\n+            case EQUAL -> readRangeExpression(is, strings, EqualExpression::ofSize, EqualExpression::ofNumber);\n+            case GREATER -> readRangeExpression(is, strings, GreaterExpression::ofSize, GreaterExpression::ofNumber);\n+            case GREATER_OR_EQUAL -> readRangeExpression(is, strings, GreaterOrEqualExpression::ofSize, GreaterOrEqualExpression::ofNumber);\n+            case LESS -> readRangeExpression(is, strings, LessExpression::ofSize, LessExpression::ofNumber);\n+            case LESS_OR_EQUAL -> readRangeExpression(is, strings, LessOrEqualExpression::ofSize, LessOrEqualExpression::ofNumber);\n@@ -159,1 +164,10 @@\n-    private static final SizeUnits[] SIZE_UNITS = SizeUnits.values();\n+    private static MediaQuery readRangeExpression(DataInputStream is, String[] strings,\n+                                                  BiFunction<SizeQueryType, Size, MediaQuery> sizeFactory,\n+                                                  BiFunction<SizeQueryType, Double, MediaQuery> numberFactory) throws IOException {\n+        var sizeQueryType = SizeQueryType.of(strings[is.readInt()]);\n+        double value = is.readDouble();\n+        SizeUnits unit = readUnit(is);\n+        return unit != null\n+            ? sizeFactory.apply(sizeQueryType, new Size(value, unit))\n+            : numberFactory.apply(sizeQueryType, value);\n+    }\n@@ -161,2 +175,3 @@\n-    private static Size readSize(DataInputStream is) throws IOException {\n-        return new Size(is.readDouble(), SIZE_UNITS[is.readByte()]);\n+    private static SizeUnits readUnit(DataInputStream is) throws IOException {\n+        byte unit = is.readByte();\n+        return unit < 0 ? null : SIZE_UNITS[unit];\n@@ -164,0 +179,2 @@\n+\n+    private static final SizeUnits[] SIZE_UNITS = SizeUnits.values();\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/MediaQuerySerializer.java","additions":27,"deletions":10,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -28,0 +28,4 @@\n+import com.sun.javafx.css.media.expression.RangeExpression;\n+import javafx.css.Size;\n+import javafx.css.SizeUnits;\n+\n@@ -30,3 +34,3 @@\n-    WIDTH(\"width\", MediaQueryContext::getWidth),\n-    HEIGHT(\"height\", MediaQueryContext::getHeight),\n-    ASPECT_RATIO(\"aspect-ratio\", context -> context.getWidth() \/ context.getHeight());\n+    WIDTH(\"width\", SizeQueryType::sizeExpression, MediaQueryContext::getWidth),\n+    HEIGHT(\"height\", SizeQueryType::sizeExpression, MediaQueryContext::getHeight),\n+    ASPECT_RATIO(\"aspect-ratio\", SizeQueryType::numberExpression, context -> context.getWidth() \/ context.getHeight());\n@@ -34,1 +38,1 @@\n-    SizeQueryType(String featureName, SizeSupplier supplier) {\n+    SizeQueryType(String featureName, QuerySupplier supplier, QueryEvaluator evaluator) {\n@@ -36,0 +40,1 @@\n+        this.evaluator = evaluator;\n@@ -49,0 +54,21 @@\n+    private static MediaQuery numberExpression(SizeQueryType queryType,\n+                                               String featureValue,\n+                                               RangeExpression.Supplier rangeExpressionSupplier) {\n+        try {\n+            return rangeExpressionSupplier.getNumberExpression(queryType, Double.parseDouble(featureValue));\n+        } catch (NumberFormatException ignored) {\n+            throw invalidValue(queryType.getFeatureName(), featureValue);\n+        }\n+    }\n+\n+    private static MediaQuery sizeExpression(SizeQueryType queryType,\n+                                             String featureValue,\n+                                             RangeExpression.Supplier rangeExpressionSupplier) {\n+        try {\n+            return rangeExpressionSupplier.getSizeExpression(\n+                queryType, sizeValue(queryType.getFeatureName(), featureValue));\n+        } catch (NumberFormatException ignored) {\n+            throw invalidValue(queryType.getFeatureName(), featureValue);\n+        }\n+    }\n+\n@@ -50,1 +76,2 @@\n-    private final SizeSupplier supplier;\n+    private final QueryEvaluator evaluator;\n+    private final QuerySupplier supplier;\n@@ -56,2 +83,53 @@\n-    public SizeSupplier getSupplier() {\n-        return supplier;\n+    public MediaQuery getQueryExpression(String featureValue, RangeExpression.Supplier rangeExpressionSupplier) {\n+        return supplier.get(this, featureValue, rangeExpressionSupplier);\n+    }\n+\n+    public double evaluate(MediaQueryContext context) {\n+        return evaluator.get(context);\n+    }\n+\n+    \/*\n+     * As per CSS specification (https:\/\/www.w3.org\/TR\/css-values-4\/#lengths), a <length> value (called <size>\n+     * in JavaFX) always requires a unit. The only exception is the zero value, which can be specified without\n+     * a unit. However, JavaFX's CssParser accepts sizes without a unit by implicitly treating them as pixels.\n+     *\/\n+    private static Size sizeValue(String featureName, String lowerCaseText) {\n+        int unitIndex = -1;\n+\n+        for (int i = 0; i < lowerCaseText.length(); i++) {\n+            if (!Character.isDigit(lowerCaseText.charAt(i))) {\n+                unitIndex = i;\n+                break;\n+            }\n+        }\n+\n+        if (unitIndex == -1) {\n+            return new Size(Double.parseDouble(lowerCaseText), SizeUnits.PX);\n+        }\n+\n+        double value = Double.parseDouble(lowerCaseText.substring(0, unitIndex));\n+\n+        return new Size(value, switch (lowerCaseText.substring(unitIndex)) {\n+            case \"px\" -> SizeUnits.PX;\n+            case \"em\" -> SizeUnits.EM;\n+            case \"ex\" -> SizeUnits.EX;\n+            case \"cm\" -> SizeUnits.CM;\n+            case \"mm\" -> SizeUnits.MM;\n+            case \"in\" -> SizeUnits.IN;\n+            case \"pt\" -> SizeUnits.PT;\n+            case \"pc\" -> SizeUnits.PC;\n+            default -> throw invalidValue(featureName, lowerCaseText);\n+        });\n+    }\n+\n+    private static RuntimeException invalidValue(String featureName, String featureValue) {\n+        return new IllegalArgumentException(\n+            String.format(\"Invalid value <%s> for media feature <%s>\", featureValue, featureName));\n+    }\n+\n+    private interface QuerySupplier {\n+        MediaQuery get(SizeQueryType queryType, String featureValue, RangeExpression.Supplier supplier);\n+    }\n+\n+    private interface QueryEvaluator {\n+        double get(MediaQueryContext context);\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/SizeQueryType.java","additions":85,"deletions":7,"binary":false,"changes":92,"status":"modified"},{"patch":"@@ -1,31 +0,0 @@\n-\/*\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.  Oracle designates this\n- * particular file as subject to the \"Classpath\" exception as provided\n- * by Oracle in the LICENSE file that accompanied this code.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-package com.sun.javafx.css.media;\n-\n-public interface SizeSupplier {\n-\n-    double get(MediaQueryContext context);\n-}\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/SizeSupplier.java","additions":0,"deletions":31,"binary":false,"changes":31,"status":"deleted"},{"patch":"@@ -38,2 +38,2 @@\n-    private EqualExpression(SizeQueryType featureType, Size featureValue) {\n-        super(featureType, featureValue);\n+    private EqualExpression(SizeQueryType featureType, Size sizeValue) {\n+        super(featureType, sizeValue);\n@@ -42,2 +42,10 @@\n-    public static EqualExpression of(SizeQueryType featureType, Size featureValue) {\n-        return MediaQueryCache.getCachedMediaQuery(new EqualExpression(featureType, featureValue));\n+    private EqualExpression(SizeQueryType featureType, double numberValue) {\n+        super(featureType, numberValue);\n+    }\n+\n+    public static EqualExpression ofSize(SizeQueryType featureType, Size sizeValue) {\n+        return MediaQueryCache.getCachedMediaQuery(new EqualExpression(featureType, sizeValue));\n+    }\n+\n+    public static EqualExpression ofNumber(SizeQueryType featureType, double numberValue) {\n+        return MediaQueryCache.getCachedMediaQuery(new EqualExpression(featureType, numberValue));\n@@ -48,1 +56,1 @@\n-        return getFeatureType().getSupplier().get(context) == getFeatureValue().pixels();\n+        return getFeatureType().evaluate(context) == getValue();\n@@ -53,1 +61,1 @@\n-        return \"(\" + getFeatureName() + \" = \" + getFeatureValue() + \")\";\n+        return \"(\" + getFeatureName() + \" = \" + getFormattedValue() + \")\";\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/EqualExpression.java","additions":14,"deletions":6,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -38,2 +38,2 @@\n-    private GreaterExpression(SizeQueryType featureType, Size featureValue) {\n-        super(featureType, featureValue);\n+    private GreaterExpression(SizeQueryType featureType, Size sizeValue) {\n+        super(featureType, sizeValue);\n@@ -42,2 +42,10 @@\n-    public static GreaterExpression of(SizeQueryType featureType, Size featureValue) {\n-        return MediaQueryCache.getCachedMediaQuery(new GreaterExpression(featureType, featureValue));\n+    private GreaterExpression(SizeQueryType featureType, double numberValue) {\n+        super(featureType, numberValue);\n+    }\n+\n+    public static GreaterExpression ofSize(SizeQueryType featureType, Size sizeValue) {\n+        return MediaQueryCache.getCachedMediaQuery(new GreaterExpression(featureType, sizeValue));\n+    }\n+\n+    public static GreaterExpression ofNumber(SizeQueryType featureType, double numberValue) {\n+        return MediaQueryCache.getCachedMediaQuery(new GreaterExpression(featureType, numberValue));\n@@ -48,1 +56,1 @@\n-        return getFeatureType().getSupplier().get(context) > getFeatureValue().pixels();\n+        return getFeatureType().evaluate(context) > getValue();\n@@ -53,1 +61,1 @@\n-        return \"(\" + getFeatureName() + \" > \" + getFeatureValue() + \")\";\n+        return \"(\" + getFeatureName() + \" > \" + getFormattedValue() + \")\";\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/GreaterExpression.java","additions":14,"deletions":6,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -38,2 +38,2 @@\n-    private GreaterOrEqualExpression(SizeQueryType featureType, Size featureValue) {\n-        super(featureType, featureValue);\n+    private GreaterOrEqualExpression(SizeQueryType featureType, Size sizeValue) {\n+        super(featureType, sizeValue);\n@@ -42,2 +42,10 @@\n-    public static GreaterOrEqualExpression of(SizeQueryType featureType, Size featureValue) {\n-        return MediaQueryCache.getCachedMediaQuery(new GreaterOrEqualExpression(featureType, featureValue));\n+    private GreaterOrEqualExpression(SizeQueryType featureType, double numberValue) {\n+        super(featureType, numberValue);\n+    }\n+\n+    public static GreaterOrEqualExpression ofSize(SizeQueryType featureType, Size sizeValue) {\n+        return MediaQueryCache.getCachedMediaQuery(new GreaterOrEqualExpression(featureType, sizeValue));\n+    }\n+\n+    public static GreaterOrEqualExpression ofNumber(SizeQueryType featureType, double numberValue) {\n+        return MediaQueryCache.getCachedMediaQuery(new GreaterOrEqualExpression(featureType, numberValue));\n@@ -48,1 +56,1 @@\n-        return getFeatureType().getSupplier().get(context) >= getFeatureValue().pixels();\n+        return getFeatureType().evaluate(context) >= getValue();\n@@ -53,1 +61,1 @@\n-        return \"(\" + getFeatureName() + \" >= \" + getFeatureValue() + \")\";\n+        return \"(\" + getFeatureName() + \" >= \" + getFormattedValue() + \")\";\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/GreaterOrEqualExpression.java","additions":14,"deletions":6,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -38,2 +38,2 @@\n-    private LessExpression(SizeQueryType featureType, Size featureValue) {\n-        super(featureType, featureValue);\n+    private LessExpression(SizeQueryType featureType, Size sizeValue) {\n+        super(featureType, sizeValue);\n@@ -42,2 +42,10 @@\n-    public static LessExpression of(SizeQueryType featureType, Size featureValue) {\n-        return MediaQueryCache.getCachedMediaQuery(new LessExpression(featureType, featureValue));\n+    private LessExpression(SizeQueryType featureType, double numberValue) {\n+        super(featureType, numberValue);\n+    }\n+\n+    public static LessExpression ofSize(SizeQueryType featureType, Size sizeValue) {\n+        return MediaQueryCache.getCachedMediaQuery(new LessExpression(featureType, sizeValue));\n+    }\n+\n+    public static LessExpression ofNumber(SizeQueryType featureType, double numberValue) {\n+        return MediaQueryCache.getCachedMediaQuery(new LessExpression(featureType, numberValue));\n@@ -48,1 +56,1 @@\n-        return getFeatureType().getSupplier().get(context) < getFeatureValue().pixels();\n+        return getFeatureType().evaluate(context) < getValue();\n@@ -53,1 +61,1 @@\n-        return \"(\" + getFeatureName() + \" < \" + getFeatureValue() + \")\";\n+        return \"(\" + getFeatureName() + \" < \" + getFormattedValue() + \")\";\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/LessExpression.java","additions":14,"deletions":6,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -38,2 +38,2 @@\n-    private LessOrEqualExpression(SizeQueryType featureType, Size featureValue) {\n-        super(featureType, featureValue);\n+    private LessOrEqualExpression(SizeQueryType featureType, Size sizeValue) {\n+        super(featureType, sizeValue);\n@@ -42,2 +42,10 @@\n-    public static LessOrEqualExpression of(SizeQueryType featureType, Size featureValue) {\n-        return MediaQueryCache.getCachedMediaQuery(new LessOrEqualExpression(featureType, featureValue));\n+    private LessOrEqualExpression(SizeQueryType featureType, double numberValue) {\n+        super(featureType, numberValue);\n+    }\n+\n+    public static LessOrEqualExpression ofSize(SizeQueryType featureType, Size sizeValue) {\n+        return MediaQueryCache.getCachedMediaQuery(new LessOrEqualExpression(featureType, sizeValue));\n+    }\n+\n+    public static LessOrEqualExpression ofNumber(SizeQueryType featureType, double numberValue) {\n+        return MediaQueryCache.getCachedMediaQuery(new LessOrEqualExpression(featureType, numberValue));\n@@ -48,1 +56,1 @@\n-        return getFeatureType().getSupplier().get(context) <= getFeatureValue().pixels();\n+        return getFeatureType().evaluate(context) <= getValue();\n@@ -53,1 +61,1 @@\n-        return \"(\" + getFeatureName() + \" <= \" + getFeatureValue() + \")\";\n+        return \"(\" + getFeatureName() + \" <= \" + getFormattedValue() + \")\";\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/LessOrEqualExpression.java","additions":14,"deletions":6,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import javafx.css.SizeUnits;\n@@ -45,1 +46,2 @@\n-    private final Size featureValue;\n+    private final Size sizeValue;\n+    private final double numberValue;\n@@ -47,1 +49,1 @@\n-    RangeExpression(SizeQueryType featureType, Size featureValue) {\n+    RangeExpression(SizeQueryType featureType, Size sizeValue) {\n@@ -49,1 +51,8 @@\n-        this.featureValue = Objects.requireNonNull(featureValue, \"featureValue cannot be null\");\n+        this.sizeValue = Objects.requireNonNull(sizeValue, \"sizeValue cannot be null\");\n+        this.numberValue = sizeValue.pixels();\n+    }\n+\n+    RangeExpression(SizeQueryType featureType, double numberValue) {\n+        this.featureType = Objects.requireNonNull(featureType, \"featureType cannot be null\");\n+        this.numberValue = numberValue;\n+        this.sizeValue = null;\n@@ -60,2 +69,20 @@\n-    public final Size getFeatureValue() {\n-        return featureValue;\n+    \/**\n+     * Gets the feature value as specified in the stylesheet; for example, \"100em\" will return the value 100.\n+     *\/\n+    public final double getFeatureValue() {\n+        return sizeValue != null ? sizeValue.getValue() : numberValue;\n+    }\n+\n+    \/**\n+     * Gets the converted feature value; for example, \"100em\" will not return the value 100, but the\n+     * result of calling {@code SizeUnits.EM.pixels(100, 1, null)}.\n+     *\/\n+    public final double getValue() {\n+        return numberValue;\n+    }\n+\n+    \/**\n+     * Gets the unit as specified in the stylesheet, or {@code null} if no unit was specified.\n+     *\/\n+    public final SizeUnits getUnit() {\n+        return sizeValue != null ? sizeValue.getUnits() : null;\n@@ -77,1 +104,2 @@\n-            && other.featureValue.equals(featureValue);\n+            && other.numberValue == numberValue\n+            && Objects.equals(other.sizeValue, sizeValue);\n@@ -82,1 +110,5 @@\n-        return Objects.hash(getClass(), featureType, featureValue);\n+        return Objects.hash(getClass(), featureType, sizeValue, numberValue);\n+    }\n+\n+    final String getFormattedValue() {\n+        return sizeValue != null ? sizeValue.toString() : Double.toString(numberValue);\n@@ -86,1 +118,2 @@\n-        RangeExpression rangeExpression(SizeQueryType featureType, Size featureValue);\n+        RangeExpression getSizeExpression(SizeQueryType featureType, Size sizeValue);\n+        RangeExpression getNumberExpression(SizeQueryType featureType, double numberValue);\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/RangeExpression.java","additions":41,"deletions":8,"binary":false,"changes":49,"status":"modified"},{"patch":"@@ -52,2 +52,0 @@\n-    public static final int LESS = 48;\n-    public static final int EQUALS = 49;\n@@ -74,0 +72,2 @@\n+    public static final int LESS = 48;\n+    public static final int EQUALS = 49;\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/parser\/CssLexer.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2776,3 +2776,12 @@\n-            if (widthChanged) Scene.this.setWidth(w);\n-            if (heightChanged) Scene.this.setHeight(h);\n-            if (widthChanged || heightChanged) Scene.this.context.notifySizeChanged();\n+\n+            if (widthChanged) {\n+                Scene.this.setWidth(w);\n+            }\n+\n+            if (heightChanged) {\n+                Scene.this.setHeight(h);\n+            }\n+\n+            if (widthChanged || heightChanged) {\n+                Scene.this.context.notifySizeChanged();\n+            }\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/scene\/Scene.java","additions":12,"deletions":3,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -56,5 +56,10 @@\n-        GREATER(() -> GreaterExpression.of(SizeQueryType.WIDTH, new Size(1, SizeUnits.PX))),\n-        GREATER_OR_EQUAL(() -> GreaterOrEqualExpression.of(SizeQueryType.WIDTH, new Size(1, SizeUnits.PX))),\n-        LESS(() -> LessExpression.of(SizeQueryType.WIDTH, new Size(1, SizeUnits.PX))),\n-        LESS_OR_EQUAL(() -> LessOrEqualExpression.of(SizeQueryType.WIDTH, new Size(1, SizeUnits.PX))),\n-        EQUAL(() -> EqualExpression.of(SizeQueryType.WIDTH, new Size(1, SizeUnits.PX)));\n+        GREATER_SIZE(() -> GreaterExpression.ofSize(SizeQueryType.WIDTH, new Size(1, SizeUnits.PX))),\n+        GREATER_NUMBER(() -> GreaterExpression.ofNumber(SizeQueryType.WIDTH, 123)),\n+        GREATER_OR_EQUAL_SIZE(() -> GreaterOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(1, SizeUnits.PX))),\n+        GREATER_OR_EQUAL_NUMBER(() -> GreaterOrEqualExpression.ofNumber(SizeQueryType.WIDTH, 123)),\n+        LESS_SIZE(() -> LessExpression.ofSize(SizeQueryType.WIDTH, new Size(1, SizeUnits.PX))),\n+        LESS_NUMBER(() -> LessExpression.ofNumber(SizeQueryType.WIDTH, 123)),\n+        LESS_OR_EQUAL_SIZE(() -> LessOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(1, SizeUnits.PX))),\n+        LESS_OR_EQUAL_NUMBER(() -> LessOrEqualExpression.ofNumber(SizeQueryType.WIDTH, 123)),\n+        EQUAL_SIZE(() -> EqualExpression.ofSize(SizeQueryType.WIDTH, new Size(1, SizeUnits.PX))),\n+        EQUAL_NUMBER(() -> EqualExpression.ofNumber(SizeQueryType.WIDTH, 123));\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/com\/sun\/javafx\/css\/media\/MediaQueryCacheTest.java","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -108,1 +108,1 @@\n-        var expected = GreaterOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX));\n+        var expected = GreaterOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX));\n@@ -111,0 +111,4 @@\n+\n+        expected = GreaterOrEqualExpression.ofNumber(SizeQueryType.WIDTH, 123);\n+        actual = deserialize(serialize(expected));\n+        assertEquals(expected, actual);\n@@ -115,1 +119,1 @@\n-        var expected = GreaterExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX));\n+        var expected = GreaterExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX));\n@@ -118,0 +122,4 @@\n+\n+        expected = GreaterExpression.ofNumber(SizeQueryType.WIDTH, 123);\n+        actual = deserialize(serialize(expected));\n+        assertEquals(expected, actual);\n@@ -122,1 +130,1 @@\n-        var expected = LessOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX));\n+        var expected = LessOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX));\n@@ -125,0 +133,4 @@\n+\n+        expected = LessOrEqualExpression.ofNumber(SizeQueryType.WIDTH, 123);\n+        actual = deserialize(serialize(expected));\n+        assertEquals(expected, actual);\n@@ -129,1 +141,1 @@\n-        var expected = LessExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX));\n+        var expected = LessExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX));\n@@ -132,0 +144,4 @@\n+\n+        expected = LessExpression.ofNumber(SizeQueryType.WIDTH, 123);\n+        actual = deserialize(serialize(expected));\n+        assertEquals(expected, actual);\n@@ -136,1 +152,1 @@\n-        var expected = EqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX));\n+        var expected = EqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX));\n@@ -139,0 +155,4 @@\n+\n+        expected = EqualExpression.ofNumber(SizeQueryType.WIDTH, 123);\n+        actual = deserialize(serialize(expected));\n+        assertEquals(expected, actual);\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/com\/sun\/javafx\/css\/media\/MediaQuerySerializerTest.java","additions":25,"deletions":5,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -185,3 +185,3 @@\n-                GreaterOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX)),\n-                LessExpression.of(SizeQueryType.HEIGHT, new Size(1000, SizeUnits.PX)),\n-                LessOrEqualExpression.of(SizeQueryType.HEIGHT, new Size(500, SizeUnits.PX))\n+                GreaterOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX)),\n+                LessExpression.ofSize(SizeQueryType.HEIGHT, new Size(1000, SizeUnits.PX)),\n+                LessOrEqualExpression.ofSize(SizeQueryType.HEIGHT, new Size(500, SizeUnits.PX))\n@@ -489,1 +489,1 @@\n-            @media (100px > width) {\n+            @media (100em > width) {\n@@ -493,1 +493,1 @@\n-            @media (100px <= width) {\n+            @media (100cm <= width) {\n@@ -497,1 +497,1 @@\n-            @media (100px < width) {\n+            @media (100 < width) {\n@@ -501,1 +501,9 @@\n-            @media (100px = width) {\n+            @media (100 = width) {\n+                .foo { bar: baz; }\n+            }\n+\n+            @media (0.5 < aspect-ratio) {\n+                .foo { bar: baz; }\n+            }\n+\n+            @media (0.5em < aspect-ratio) {\n@@ -506,1 +514,1 @@\n-        assertEquals(5, stylesheet.getRules().size());\n+        assertEquals(7, stylesheet.getRules().size());\n@@ -508,1 +516,1 @@\n-            List.of(LessOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(LessOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n@@ -511,1 +519,1 @@\n-            List.of(LessExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(LessExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.EM))),\n@@ -514,1 +522,1 @@\n-            List.of(GreaterOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(GreaterOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.CM))),\n@@ -517,1 +525,1 @@\n-            List.of(GreaterExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(GreaterExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n@@ -520,1 +528,1 @@\n-            List.of(EqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(EqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n@@ -522,0 +530,6 @@\n+        assertEquals(\n+            List.of(GreaterExpression.ofNumber(SizeQueryType.ASPECT_RATIO, 0.5)),\n+            RuleHelper.getMediaRule(stylesheet.getRules().get(5)).getQueries());\n+        assertEquals(\n+            List.of(ConstantExpression.of(false)), \/\/ error: aspect-ratio is a <number>, not a <size>\n+            RuleHelper.getMediaRule(stylesheet.getRules().get(6)).getQueries());\n@@ -531,1 +545,5 @@\n-            @media (width > 100px) {\n+            @media (width > 100em) {\n+                .foo { bar: baz; }\n+            }\n+\n+            @media (width <= 100cm) {\n@@ -535,1 +553,1 @@\n-            @media (width <= 100px) {\n+            @media (width < 100) {\n@@ -539,1 +557,5 @@\n-            @media (width < 100px) {\n+            @media (width = 100) {\n+                .foo { bar: baz; }\n+            }\n+            \n+            @media (aspect-ratio > 0.5) {\n@@ -543,1 +565,1 @@\n-            @media (width = 100px) {\n+            @media (aspect-ratio > 0.5em) {\n@@ -548,1 +570,1 @@\n-        assertEquals(5, stylesheet.getRules().size());\n+        assertEquals(7, stylesheet.getRules().size());\n@@ -550,1 +572,1 @@\n-            List.of(GreaterOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(GreaterOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n@@ -553,1 +575,1 @@\n-            List.of(GreaterExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(GreaterExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.EM))),\n@@ -556,1 +578,1 @@\n-            List.of(LessOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(LessOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.CM))),\n@@ -559,1 +581,1 @@\n-            List.of(LessExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(LessExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n@@ -562,1 +584,1 @@\n-            List.of(EqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(EqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n@@ -564,0 +586,6 @@\n+        assertEquals(\n+            List.of(GreaterExpression.ofNumber(SizeQueryType.ASPECT_RATIO, 0.5)),\n+            RuleHelper.getMediaRule(stylesheet.getRules().get(5)).getQueries());\n+        assertEquals(\n+            List.of(ConstantExpression.of(false)), \/\/ error: aspect-ratio is a <number>, not a <size>\n+            RuleHelper.getMediaRule(stylesheet.getRules().get(6)).getQueries());\n@@ -589,2 +617,2 @@\n-                LessExpression.of(SizeQueryType.WIDTH, new Size(50, SizeUnits.PX)),\n-                GreaterOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX)))),\n+                LessExpression.ofSize(SizeQueryType.WIDTH, new Size(50, SizeUnits.PX)),\n+                GreaterOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX)))),\n@@ -594,2 +622,2 @@\n-                LessOrEqualExpression.of(SizeQueryType.WIDTH, new Size(50, SizeUnits.PX)),\n-                GreaterExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX)))),\n+                LessOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(50, SizeUnits.PX)),\n+                GreaterExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX)))),\n@@ -599,2 +627,2 @@\n-                GreaterExpression.of(SizeQueryType.WIDTH, new Size(50, SizeUnits.PX)),\n-                LessOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX)))),\n+                GreaterExpression.ofSize(SizeQueryType.WIDTH, new Size(50, SizeUnits.PX)),\n+                LessOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX)))),\n@@ -604,2 +632,2 @@\n-                GreaterOrEqualExpression.of(SizeQueryType.WIDTH, new Size(50, SizeUnits.PX)),\n-                LessExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX)))),\n+                GreaterOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(50, SizeUnits.PX)),\n+                LessExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX)))),\n@@ -658,1 +686,1 @@\n-            List.of(GreaterOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(GreaterOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n@@ -661,1 +689,1 @@\n-            List.of(LessOrEqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            List.of(LessOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n@@ -671,0 +699,4 @@\n+\n+            @media (aspect-ratio: 0.5) {\n+                .foo { bar: baz; }\n+            }\n@@ -673,1 +705,1 @@\n-        assertEquals(1, stylesheet.getRules().size());\n+        assertEquals(2, stylesheet.getRules().size());\n@@ -675,2 +707,5 @@\n-            List.of(EqualExpression.of(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n-            RuleHelper.getMediaRule(stylesheet.getRules().getFirst()).getQueries());\n+            List.of(EqualExpression.ofSize(SizeQueryType.WIDTH, new Size(100, SizeUnits.PX))),\n+            RuleHelper.getMediaRule(stylesheet.getRules().get(0)).getQueries());\n+        assertEquals(\n+            List.of(EqualExpression.ofNumber(SizeQueryType.ASPECT_RATIO, 0.5)),\n+            RuleHelper.getMediaRule(stylesheet.getRules().get(1)).getQueries());\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/javafx\/css\/CssParser_mediaQuery_Test.java","additions":71,"deletions":36,"binary":false,"changes":107,"status":"modified"}]}