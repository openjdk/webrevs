{"files":[{"patch":"@@ -784,9 +784,8 @@\n-    <h4>@import<\/h4>\n-    <p>\n-        Beginning with JavaFX 8u20, the CSS\n-        <a href=\"http:\/\/www.w3.org\/TR\/CSS21\/cascade.html#at-import\">@import<\/a> is partially supported.\n-        Only unconditional import is supported. In other words, the media&#8209;type qualifier is not supported.\n-        Also, the JavaFX CSS parser is non-compliant with regard to where an @import may appear within a stylesheet\n-        (see <a href=\"http:\/\/www.w3.org\/TR\/CSS21\/syndata.html#at-rules\">At&#8209;rules<\/a>).\n-        Users are cautioned that this will be fixed in a future release. Adherence to the W3C standard is strongly advised.\n-    <\/p>\n+    <h4>@import <a class=\"grammar\" style=\"font-weight: normal\">[ &lt;url&gt; | &lt;string&gt; ] &lt;media-query-list&gt;? ;<\/a><\/h4>\n+    <p>The @import rule allows applications to import rules from other stylesheets. Import rules must be placed before\n+        all other @-rules and style rules, and no other rule can be placed between @import rules. If a valid import\n+        rule is encountered, the content of the referenced stylesheet is treated as if it literally appeared at the\n+        location of the @import rule.<\/p>\n+    <p>An import rule can optionally include a <a href=\"#figure-media-query-list\">media query list<\/a> that specifies\n+        the conditions under which the imported rules apply, as if they were wrapped in a @media rule with the same\n+        media query list.<\/p>\n@@ -842,1 +841,1 @@\n-        <figure style=\"margin: 0\">\n+        <figure style=\"margin: 0\" id=\"figure-media-query-list\">\n","filename":"modules\/javafx.graphics\/src\/main\/docs\/javafx\/scene\/doc-files\/cssref.html","additions":9,"deletions":10,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+import java.util.function.BiFunction;\n@@ -39,1 +40,1 @@\n-final class MediaFeatures {\n+public final class MediaFeatures {\n@@ -43,0 +44,5 @@\n+    \/\/ Extension point for unit tests to add media features\n+    public static BiFunction<String, Token, MediaQuery> DEFAULT = (featureName, _) -> {\n+        throw new IllegalArgumentException(String.format(\"Unknown media feature <%s>\", featureName));\n+    };\n+\n@@ -135,2 +141,1 @@\n-            default -> throw new IllegalArgumentException(\n-                String.format(\"Unknown media feature <%s>\", featureName));\n+            default -> DEFAULT.apply(featureName, featureValue);\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/MediaFeatures.java","additions":8,"deletions":3,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -57,0 +57,10 @@\n+    \/**\n+     * Attempts to determine the result of this media query without a context, and returns {@link TriState#TRUE}\n+     * if the query matches for all possible contexts, {@link TriState#FALSE} if it matches for no possible\n+     * context, or {@link TriState#UNKNOWN} if the result depends on the context or cannot be determined.\n+     *\n+     * @return {@link TriState#TRUE} if the query is always true, {@link TriState#FALSE}\n+     *         if the query is always false, otherwise {@link TriState#UNKNOWN}\n+     *\/\n+    TriState evaluate();\n+\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/MediaQuery.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -0,0 +1,111 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package com.sun.javafx.css.media;\n+\n+import javafx.css.StyleConverter;\n+import java.io.DataInputStream;\n+import java.io.DataOutputStream;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+\n+public final class MediaQueryList extends ArrayList<MediaQuery> {\n+\n+    public MediaQueryList() {}\n+\n+    public MediaQueryList(int capacity) {\n+        super(capacity);\n+    }\n+\n+    \/**\n+     * Attempts to determine the result of this media query list without a context, and returns\n+     * {@link TriState#TRUE} if it matches for all possible contexts, {@link TriState#FALSE} if\n+     * it matches for no possible context, or {@link TriState#UNKNOWN} if the result depends on\n+     * the context or cannot be determined.\n+     *\n+     * @return {@link TriState#TRUE} if the media query list is always true, {@link TriState#FALSE}\n+     *         if the media query list is always false, otherwise {@link TriState#UNKNOWN}\n+     *\/\n+    public TriState evaluate() {\n+        if (isEmpty()) {\n+            return TriState.TRUE;\n+        }\n+\n+        boolean unknown = false;\n+\n+        for (int i = 0, max = size(); i < max; i++) {\n+            switch (get(i).evaluate()) {\n+                case TRUE -> { return TriState.TRUE; }\n+                case UNKNOWN -> unknown = true;\n+            }\n+        }\n+\n+        return unknown ? TriState.UNKNOWN : TriState.FALSE;\n+    }\n+\n+    \/**\n+     * Evaluates whether any of the media queries is {@code true}.\n+     *\n+     * @param context the evaluation context\n+     * @return {@code true} if any of the media queries is {@code true} or if the list is empty,\n+     *         {@code false} otherwise\n+     *\/\n+    public boolean evaluate(MediaQueryContext context) {\n+        if (isEmpty()) {\n+            return true;\n+        }\n+\n+        for (int i = 0, max = size(); i < max; i++) {\n+            MediaQuery query = get(i);\n+            boolean value = query.evaluate(context);\n+            context.notifyQueryEvaluated(query, value);\n+\n+            if (value) {\n+                return true;\n+            }\n+        }\n+\n+        return false;\n+    }\n+\n+    public void writeBinary(DataOutputStream stream, StyleConverter.StringStore stringStore) throws IOException {\n+        stream.writeInt(size());\n+\n+        for (MediaQuery query : this) {\n+            MediaQuerySerializer.writeBinary(query, stream, stringStore);\n+        }\n+    }\n+\n+    public static MediaQueryList readBinary(DataInputStream stream, String[] strings) throws IOException {\n+        int size = stream.readInt();\n+        var queries = new MediaQueryList(size);\n+\n+        for (int i = 0; i < size; i++) {\n+            queries.add(MediaQuerySerializer.readBinary(stream, strings));\n+        }\n+\n+        return queries;\n+    }\n+}\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/MediaQueryList.java","additions":111,"deletions":0,"binary":false,"changes":111,"status":"added"},{"patch":"@@ -86,1 +86,1 @@\n-     * @return the expression\n+     * @return the media query list\n@@ -88,1 +88,1 @@\n-    public List<MediaQuery> parseMediaQueryList(List<Token> tokens) {\n+    public MediaQueryList parseMediaQueryList(List<Token> tokens) {\n@@ -90,1 +90,1 @@\n-        var expressions = new ArrayList<MediaQuery>();\n+        var expressions = new MediaQueryList();\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/MediaQueryParser.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -33,1 +33,0 @@\n-import java.util.List;\n@@ -41,1 +40,1 @@\n-    private final List<MediaQuery> queries;\n+    private final MediaQueryList queries;\n@@ -44,2 +43,2 @@\n-    public MediaRule(List<MediaQuery> queries, MediaRule parent) {\n-        this.queries = List.copyOf(queries);\n+    public MediaRule(MediaQueryList queries, MediaRule parent) {\n+        this.queries = queries;\n@@ -50,1 +49,1 @@\n-     * Returns the unmodifiable list of media queries.\n+     * Returns the list of media queries.\n@@ -52,1 +51,1 @@\n-     * @return the unmodifiable list of media queries\n+     * @return the list of media queries\n@@ -54,1 +53,1 @@\n-    public List<MediaQuery> getQueries() {\n+    public MediaQueryList getQueries() {\n@@ -67,0 +66,25 @@\n+    \/**\n+     * Attempts to determine the result of this media rule without a context, and returns {@link TriState#TRUE}\n+     * if the rule matches for all possible contexts, {@link TriState#FALSE} if it matches for no possible\n+     * context, or {@link TriState#UNKNOWN} if the result depends on the context or cannot be determined.\n+     *\n+     * @return {@link TriState#TRUE} if the rule always matches, {@link TriState#FALSE}\n+     *         if the rule never matches, otherwise {@link TriState#UNKNOWN}\n+     *\/\n+    public TriState evaluate() {\n+        boolean parentUnknown = false;\n+\n+        if (parent != null) {\n+            switch (parent.evaluate()) {\n+                case FALSE -> { return TriState.FALSE; }\n+                case UNKNOWN -> parentUnknown = true;\n+            }\n+        }\n+\n+        return switch (queries.evaluate()) {\n+            case TRUE -> parentUnknown ? TriState.UNKNOWN : TriState.TRUE;\n+            case FALSE -> TriState.FALSE;\n+            case UNKNOWN -> TriState.UNKNOWN;\n+        };\n+    }\n+\n@@ -79,15 +103,1 @@\n-        if (queries.isEmpty()) {\n-            return true;\n-        }\n-\n-        for (int i = 0, max = queries.size(); i < max; i++) {\n-            MediaQuery query = queries.get(i);\n-            boolean value = query.evaluate(context);\n-            context.notifyQueryEvaluated(query, value);\n-\n-            if (value) {\n-                return true;\n-            }\n-        }\n-\n-        return false;\n+        return queries.evaluate(context);\n@@ -97,5 +107,1 @@\n-        stream.writeInt(queries.size());\n-\n-        for (MediaQuery query : queries) {\n-            MediaQuerySerializer.writeBinary(query, stream, stringStore);\n-        }\n+        queries.writeBinary(stream, stringStore);\n@@ -111,6 +117,1 @@\n-        int size = stream.readInt();\n-        var queries = new MediaQuery[size];\n-\n-        for (int i = 0; i < size; i++) {\n-            queries[i] = MediaQuerySerializer.readBinary(stream, strings);\n-        }\n+        MediaQueryList queries = MediaQueryList.readBinary(stream, strings);\n@@ -121,1 +122,1 @@\n-        return new MediaRule(List.of(queries), parentRule);\n+        return new MediaRule(queries, parentRule);\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/MediaRule.java","additions":35,"deletions":34,"binary":false,"changes":69,"status":"modified"},{"patch":"@@ -0,0 +1,32 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package com.sun.javafx.css.media;\n+\n+public enum TriState {\n+    TRUE,\n+    FALSE,\n+    UNKNOWN\n+}\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/TriState.java","additions":32,"deletions":0,"binary":false,"changes":32,"status":"added"},{"patch":"@@ -31,0 +31,1 @@\n+import com.sun.javafx.css.media.TriState;\n@@ -86,0 +87,17 @@\n+    @Override\n+    public TriState evaluate() {\n+        return switch (left.evaluate()) {\n+            case TRUE -> right.evaluate();\n+            case FALSE -> TriState.FALSE;\n+            case UNKNOWN -> switch (right.evaluate()) {\n+                case TRUE, UNKNOWN -> TriState.UNKNOWN;\n+                case FALSE -> TriState.FALSE;\n+            };\n+        };\n+    }\n+\n+    @Override\n+    public boolean evaluate(MediaQueryContext context) {\n+        return left.evaluate(context) && right.evaluate(context);\n+    }\n+\n@@ -98,5 +116,0 @@\n-    @Override\n-    public boolean evaluate(MediaQueryContext context) {\n-        return left.evaluate(context) && right.evaluate(context);\n-    }\n-\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/ConjunctionExpression.java","additions":18,"deletions":5,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import com.sun.javafx.css.media.TriState;\n@@ -58,0 +59,5 @@\n+    @Override\n+    public TriState evaluate() {\n+        return value ?  TriState.TRUE : TriState.FALSE;\n+    }\n+\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/ConstantExpression.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import com.sun.javafx.css.media.TriState;\n@@ -86,0 +87,17 @@\n+    @Override\n+    public TriState evaluate() {\n+        return switch (left.evaluate()) {\n+            case TRUE -> TriState.TRUE;\n+            case FALSE -> right.evaluate();\n+            case UNKNOWN -> switch (right.evaluate()) {\n+                case TRUE -> TriState.TRUE;\n+                case FALSE, UNKNOWN -> TriState.UNKNOWN;\n+            };\n+        };\n+    }\n+\n+    @Override\n+    public boolean evaluate(MediaQueryContext context) {\n+        return left.evaluate(context) || right.evaluate(context);\n+    }\n+\n@@ -98,5 +116,0 @@\n-    @Override\n-    public boolean evaluate(MediaQueryContext context) {\n-        return left.evaluate(context) || right.evaluate(context);\n-    }\n-\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/DisjunctionExpression.java","additions":18,"deletions":5,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import com.sun.javafx.css.media.TriState;\n@@ -34,0 +35,1 @@\n+import java.util.function.Supplier;\n@@ -42,0 +44,1 @@\n+    private final Supplier<TriState> contextFreeFunction;\n@@ -48,0 +51,1 @@\n+                               Supplier<TriState> contextFreeFunction,\n@@ -53,0 +57,1 @@\n+        this.contextFreeFunction = Objects.requireNonNull(contextFreeFunction, \"contextFreeFunction cannot be null\");\n@@ -72,2 +77,22 @@\n-        return MediaQueryCache.getCachedMediaQuery(\n-            new FunctionExpression<>(featureName, featureValue, function, value, contextAwareness));\n+        return MediaQueryCache.getCachedMediaQuery(new FunctionExpression<>(\n+            featureName, featureValue, () -> TriState.UNKNOWN, function, value, contextAwareness));\n+    }\n+\n+    \/**\n+     * Returns an interned {@code FunctionExpression}.\n+     *\n+     * @param featureName the feature name\n+     * @param featureValue the feature value, or {@code null} to indicate a boolean context\n+     * @param contextFreeFunction the context-free evaluation function, must never return {@code null}\n+     * @param function the evaluation function\n+     * @param value the expected return value of the function\n+     * @param contextAwareness the context awareness of the function, see {@link MediaQuery#getContextAwareness()}\n+     *\/\n+    public static <T> FunctionExpression<T> of(String featureName,\n+                                               String featureValue,\n+                                               Supplier<TriState> contextFreeFunction,\n+                                               Function<MediaQueryContext, T> function,\n+                                               T value,\n+                                               ContextAwareness... contextAwareness) {\n+        return MediaQueryCache.getCachedMediaQuery(new FunctionExpression<>(\n+            featureName, featureValue, contextFreeFunction, function, value, contextAwareness));\n@@ -89,0 +114,5 @@\n+    @Override\n+    public TriState evaluate() {\n+        return contextFreeFunction.get();\n+    }\n+\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/FunctionExpression.java","additions":32,"deletions":2,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import com.sun.javafx.css.media.TriState;\n@@ -59,0 +60,14 @@\n+    @Override\n+    public TriState evaluate() {\n+        return switch (expression.evaluate()) {\n+            case TRUE -> TriState.FALSE;\n+            case FALSE -> TriState.TRUE;\n+            case UNKNOWN -> TriState.UNKNOWN;\n+        };\n+    }\n+\n+    @Override\n+    public boolean evaluate(MediaQueryContext context) {\n+        return !expression.evaluate(context);\n+    }\n+\n@@ -69,5 +84,0 @@\n-    @Override\n-    public boolean evaluate(MediaQueryContext context) {\n-        return !expression.evaluate(context);\n-    }\n-\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/NegationExpression.java","additions":15,"deletions":5,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import com.sun.javafx.css.media.TriState;\n@@ -96,0 +97,5 @@\n+    @Override\n+    public TriState evaluate() {\n+        return TriState.UNKNOWN;\n+    }\n+\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/css\/media\/expression\/RangeExpression.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+import com.sun.javafx.css.media.MediaQueryList;\n@@ -31,0 +32,1 @@\n+import com.sun.javafx.css.media.TriState;\n@@ -143,0 +145,6 @@\n+    \/\/ Specifies whether conditional rules with unmatchable conditions (i.e. conditions that always\n+    \/\/ evaluate to false) should be included in the returned stylesheet. For serialization purposes,\n+    \/\/ this flag is set so that the complete stylesheet with all of its rules and imports is retained\n+    \/\/ in the serialized form.\n+    private boolean includeUnmatchableRules;\n+\n@@ -214,0 +222,13 @@\n+        Stylesheet stylesheet = parseUnmerged(stylesheetText, false);\n+        stylesheet.mergeStylesheetImports();\n+        return stylesheet;\n+    }\n+\n+    \/**\n+     * Parses a stylesheet from the given text, but doesn't merge its imports into the stylesheet.\n+     * <p>\n+     * The only purpose of having a stylesheet with unmerged imports is to retain its hierarchical structure\n+     * for serialization purposes. At runtime, all imported stylesheets must be merged into the main stylesheet.\n+     *\/\n+    Stylesheet parseUnmerged(String stylesheetText, boolean includeUnmatchableRules) {\n+        this.includeUnmatchableRules = includeUnmatchableRules;\n@@ -236,0 +257,1 @@\n+        includeUnmatchableRules = false;\n@@ -243,0 +265,1 @@\n+        stylesheet.mergeStylesheetImports();\n@@ -255,0 +278,4 @@\n+        Stylesheet stylesheet = parseUnmerged(url, false);\n+        stylesheet.mergeStylesheetImports();\n+        return stylesheet;\n+    }\n@@ -256,0 +283,8 @@\n+    \/**\n+     * Parses a stylesheet from the given URL, but doesn't merge its imports into the stylesheet.\n+     * <p>\n+     * The only purpose of having a stylesheet with unmerged imports is to retain its hierarchical structure\n+     * for serialization purposes. At runtime, all imported stylesheets must be merged into the main stylesheet.\n+     *\/\n+    Stylesheet parseUnmerged(URL url, boolean includeUnmatchableRules) throws IOException {\n+        this.includeUnmatchableRules = includeUnmatchableRules;\n@@ -4271,2 +4306,1 @@\n-                    Stylesheet importedStylesheet = handleImport(lexer);\n-\n+                    StylesheetImport importedStylesheet = handleImport(lexer);\n@@ -4274,1 +4308,1 @@\n-                        stylesheet.importStylesheet(importedStylesheet);\n+                        stylesheet.addStylesheetImport(importedStylesheet);\n@@ -4308,1 +4342,1 @@\n-                mediaRule = mediaRule(lexer, mediaRule);\n+                mediaRule = new MediaRule(mediaQueryList(lexer), mediaRule);\n@@ -4331,1 +4365,1 @@\n-                    mediaRule = mediaRule(lexer, mediaRule);\n+                    mediaRule = new MediaRule(mediaQueryList(lexer), mediaRule);\n@@ -4388,1 +4422,3 @@\n-            stylesheet.getRules().add(new Rule(mediaRule, selectors, declarations));\n+            if (includeUnmatchableRules || mediaRule == null || mediaRule.evaluate() != TriState.FALSE) {\n+                stylesheet.getRules().add(new Rule(mediaRule, selectors, declarations));\n+            }\n@@ -4435,1 +4471,1 @@\n-    private MediaRule mediaRule(CssLexer lexer, MediaRule mediaRule) {\n+    private MediaQueryList mediaQueryList(CssLexer lexer) {\n@@ -4461,1 +4497,1 @@\n-        return new MediaRule(mediaQueryParser.parseMediaQueryList(mediaQueryTokens), mediaRule);\n+        return mediaQueryParser.parseMediaQueryList(mediaQueryTokens);\n@@ -4622,1 +4658,1 @@\n-    private Stylesheet handleImport(CssLexer lexer) {\n+    private StylesheetImport handleImport(CssLexer lexer) {\n@@ -4636,0 +4672,6 @@\n+        \/\/ Skip loading the referenced stylesheet if we know that the import conditions never match.\n+        MediaQueryList importConditions = mediaQueryList(lexer);\n+        if (!includeUnmatchableRules && importConditions.evaluate() == TriState.FALSE) {\n+            return null;\n+        }\n+\n@@ -4657,0 +4699,1 @@\n+\n@@ -4666,1 +4709,4 @@\n-        return importedStylesheet;\n+\n+        return importedStylesheet != null\n+            ? new StylesheetImport(importedStylesheet, importConditions)\n+            : null;\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/css\/CssParser.java","additions":56,"deletions":10,"binary":false,"changes":66,"status":"modified"},{"patch":"@@ -36,0 +36,5 @@\n+import com.sun.javafx.css.media.MediaQuery;\n+import com.sun.javafx.css.media.MediaQueryList;\n+import com.sun.javafx.css.media.MediaQuerySerializer;\n+import com.sun.javafx.css.media.MediaRule;\n+import com.sun.javafx.css.media.TriState;\n@@ -41,0 +46,1 @@\n+import java.io.EOFException;\n@@ -69,0 +75,1 @@\n+     * Version 9: conditional stylesheet imports\n@@ -70,1 +77,1 @@\n-    final static int BINARY_CSS_VERSION = 8;\n+    final static int BINARY_CSS_VERSION = 9;\n@@ -130,0 +137,3 @@\n+    \/** List of all stylesheet imports *\/\n+    private List<StylesheetImport> stylesheetImports;\n+\n@@ -227,3 +237,3 @@\n-    final void writeBinary(final DataOutputStream os, final StringStore stringStore)\n-        throws IOException\n-    {\n+    final void writeBinary(final DataOutputStream os, final StringStore stringStore) throws IOException {\n+        writeBinaryImports(os, stringStore);\n+\n@@ -250,3 +260,1 @@\n-    final void readBinary(int bssVersion, DataInputStream is, String[] strings)\n-        throws IOException\n-    {\n+    final void readBinary(int bssVersion, DataInputStream is, String[] strings) throws IOException {\n@@ -254,0 +262,5 @@\n+\n+        if (bssVersion >= 9) {\n+            readBinaryImports(bssVersion, is, strings);\n+        }\n+\n@@ -259,1 +272,5 @@\n-            persistedRules.add(Rule.readBinary(bssVersion,is,strings));\n+            Rule rule = Rule.readBinary(bssVersion, is, strings);\n+            MediaRule mediaRule = RuleHelper.getMediaRule(rule);\n+            if (mediaRule == null || mediaRule.evaluate() != TriState.FALSE) {\n+                persistedRules.add(rule);\n+            }\n@@ -273,0 +290,45 @@\n+    private void writeBinaryImports(DataOutputStream os, StringStore stringStore) throws IOException {\n+        if (stylesheetImports == null) {\n+            os.writeInt(0);\n+            return;\n+        }\n+\n+        os.writeInt(stylesheetImports.size());\n+\n+        for (StylesheetImport stylesheetImport : stylesheetImports) {\n+            os.writeInt(stylesheetImport.importConditions().size());\n+            for (MediaQuery query : stylesheetImport.importConditions()) {\n+                MediaQuerySerializer.writeBinary(query, os, stringStore);\n+            }\n+\n+            try (var byteStream = new ByteArrayOutputStream();\n+                 var importOut = new DataOutputStream(byteStream)) {\n+                stylesheetImport.stylesheet().writeBinary(importOut, stringStore);\n+                os.writeInt(importOut.size());\n+                byteStream.writeTo(os);\n+            }\n+        }\n+    }\n+\n+    private void readBinaryImports(int bssVersion, DataInputStream is, String[] strings) throws IOException {\n+        for (int i = 0, max = is.readInt(); i < max; i++) {\n+            int queryCount = is.readInt();\n+            var importConditions = new MediaQueryList();\n+            for (int j = 0; j < queryCount; j++) {\n+                importConditions.add(MediaQuerySerializer.readBinary(is, strings));\n+            }\n+\n+            \/\/ Skip referenced stylesheets whose media query list can never match.\n+            int stylesheetSizeInBytes = is.readInt();\n+            if (importConditions.evaluate() != TriState.FALSE) {\n+                var stylesheet = new Stylesheet();\n+                stylesheet.readBinary(bssVersion, is, strings);\n+                addStylesheetImport(new StylesheetImport(stylesheet, importConditions));\n+            } else if (is.skip(stylesheetSizeInBytes) != stylesheetSizeInBytes) {\n+                throw new EOFException();\n+            }\n+        }\n+\n+        mergeStylesheetImports();\n+    }\n+\n@@ -383,1 +445,1 @@\n-        Stylesheet stylesheet = new CssParser().parse(sourceURI.toURL());\n+        Stylesheet stylesheet = new CssParser().parseUnmerged(sourceURI.toURL(), true);\n@@ -408,3 +470,14 @@\n-    \/\/ Add the rules from the other stylesheet to this one\n-    void importStylesheet(Stylesheet importedStylesheet) {\n-        if (importedStylesheet == null) return;\n+    void addStylesheetImport(StylesheetImport stylesheetImport) {\n+        if (stylesheetImports == null) {\n+            stylesheetImports = new ArrayList<>();\n+        }\n+\n+        stylesheetImports.add(stylesheetImport);\n+    }\n+\n+    void mergeStylesheetImports() {\n+        if (stylesheetImports != null) {\n+            List<Rule> importedRules = new ArrayList<>();\n+            for (StylesheetImport stylesheetImport : stylesheetImports) {\n+                importedRules.addAll(importRules(stylesheetImport));\n+            }\n@@ -412,0 +485,8 @@\n+            rules.addAll(0, importedRules);\n+            stylesheetImports = null;\n+        }\n+    }\n+\n+    private List<Rule> importRules(StylesheetImport stylesheetImport) {\n+        Stylesheet importedStylesheet = stylesheetImport.stylesheet();\n+        MediaQueryList importConditions = stylesheetImport.importConditions();\n@@ -413,1 +494,3 @@\n-        if (rulesToImport == null || rulesToImport.isEmpty()) return;\n+        if (rulesToImport.isEmpty()) {\n+            return List.of();\n+        }\n@@ -415,0 +498,11 @@\n+        switch (importConditions.evaluate()) {\n+            case FALSE -> {\n+                return List.of();\n+            }\n+\n+            case TRUE -> {\n+                return importedStylesheet.getRules();\n+            }\n+        }\n+\n+        MediaRule importConditionsRule = new MediaRule(importConditions, null);\n@@ -416,0 +510,1 @@\n+\n@@ -419,1 +514,5 @@\n-            importedRules.add(new Rule(RuleHelper.getMediaRule(rule), selectors, declarations));\n+            MediaRule mediaRule = RuleHelper.getMediaRule(rule) instanceof MediaRule r\n+                ? new MediaRule(r.getQueries(), importConditionsRule)\n+                : importConditionsRule;\n+\n+            importedRules.add(new Rule(mediaRule, selectors, declarations));\n@@ -422,1 +521,1 @@\n-        rules.addAll(importedRules);\n+        return importedRules;\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/css\/Stylesheet.java","additions":114,"deletions":15,"binary":false,"changes":129,"status":"modified"},{"patch":"@@ -0,0 +1,37 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package javafx.css;\n+\n+import com.sun.javafx.css.media.MediaQueryList;\n+import java.util.Objects;\n+\n+record StylesheetImport(Stylesheet stylesheet, MediaQueryList importConditions) {\n+\n+    StylesheetImport {\n+        Objects.requireNonNull(stylesheet, \"stylesheet cannot be null\");\n+        Objects.requireNonNull(importConditions, \"importConditions cannot be null\");\n+    }\n+}\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/css\/StylesheetImport.java","additions":37,"deletions":0,"binary":false,"changes":37,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -44,0 +44,3 @@\n+    public Stylesheet parseUnmerged(String stylesheetText, boolean includeUnmatchableRules) {\n+        return parser.parseUnmerged(stylesheetText, includeUnmatchableRules);\n+    }\n","filename":"modules\/javafx.graphics\/src\/shims\/java\/javafx\/css\/CssParserShim.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -0,0 +1,178 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.com.sun.javafx.css.media;\n+\n+import com.sun.javafx.css.media.MediaQuery;\n+import com.sun.javafx.css.media.TriState;\n+import com.sun.javafx.css.media.expression.ConjunctionExpression;\n+import com.sun.javafx.css.media.expression.DisjunctionExpression;\n+import com.sun.javafx.css.media.expression.FunctionExpression;\n+import com.sun.javafx.css.media.expression.NegationExpression;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+import java.util.UUID;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.function.Supplier;\n+import java.util.stream.Stream;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class MediaQueryTest {\n+\n+    private static MediaQuery expr(TriState state) {\n+        return FunctionExpression.of(UUID.randomUUID().toString(), \"value\", () -> state, _ -> null, null);\n+    }\n+\n+    private static MediaQuery expr(Supplier<TriState> supplier) {\n+        return FunctionExpression.of(UUID.randomUUID().toString(), \"value\", supplier, _ -> null, null);\n+    }\n+\n+    static Stream<Arguments> conjunctionTruthTable() {\n+        return Stream.of(\n+            Arguments.of(TriState.TRUE, TriState.TRUE, TriState.TRUE),\n+            Arguments.of(TriState.TRUE, TriState.UNKNOWN, TriState.UNKNOWN),\n+            Arguments.of(TriState.TRUE, TriState.FALSE, TriState.FALSE),\n+            Arguments.of(TriState.FALSE, TriState.TRUE, TriState.FALSE),\n+            Arguments.of(TriState.FALSE, TriState.UNKNOWN, TriState.FALSE),\n+            Arguments.of(TriState.FALSE, TriState.FALSE, TriState.FALSE),\n+            Arguments.of(TriState.UNKNOWN, TriState.TRUE, TriState.UNKNOWN),\n+            Arguments.of(TriState.UNKNOWN, TriState.UNKNOWN, TriState.UNKNOWN),\n+            Arguments.of(TriState.UNKNOWN, TriState.FALSE, TriState.FALSE)\n+        );\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"conjunctionTruthTable\")\n+    void conjunction(TriState left, TriState right, TriState expected) {\n+        assertEquals(expected, ConjunctionExpression.of(expr(left), expr(right)).evaluate());\n+    }\n+\n+    static Stream<Arguments> disjunctionTruthTable() {\n+        return Stream.of(\n+            Arguments.of(TriState.TRUE, TriState.TRUE, TriState.TRUE),\n+            Arguments.of(TriState.TRUE, TriState.UNKNOWN, TriState.TRUE),\n+            Arguments.of(TriState.TRUE, TriState.FALSE, TriState.TRUE),\n+            Arguments.of(TriState.FALSE, TriState.TRUE, TriState.TRUE),\n+            Arguments.of(TriState.FALSE, TriState.UNKNOWN, TriState.UNKNOWN),\n+            Arguments.of(TriState.FALSE, TriState.FALSE, TriState.FALSE),\n+            Arguments.of(TriState.UNKNOWN, TriState.TRUE, TriState.TRUE),\n+            Arguments.of(TriState.UNKNOWN, TriState.UNKNOWN, TriState.UNKNOWN),\n+            Arguments.of(TriState.UNKNOWN, TriState.FALSE, TriState.UNKNOWN)\n+        );\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"disjunctionTruthTable\")\n+    void disjunction(TriState left, TriState right, TriState expected) {\n+        assertEquals(expected, DisjunctionExpression.of(expr(left), expr(right)).evaluate());\n+    }\n+\n+    static Stream<Arguments> negationTruthTable() {\n+        return Stream.of(\n+            Arguments.of(TriState.TRUE, TriState.FALSE),\n+            Arguments.of(TriState.FALSE, TriState.TRUE),\n+            Arguments.of(TriState.UNKNOWN, TriState.UNKNOWN)\n+        );\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"negationTruthTable\")\n+    void negation(TriState inner, TriState expected) {\n+        assertEquals(expected, NegationExpression.of(expr(inner)).evaluate());\n+    }\n+\n+    @Test\n+    void nestedComposition1() {\n+        \/\/ T and (U or F) = T and U = U\n+        MediaQuery inner = DisjunctionExpression.of(expr(TriState.UNKNOWN), expr(TriState.FALSE));\n+        MediaQuery expr = ConjunctionExpression.of(expr(TriState.TRUE), inner);\n+        assertEquals(TriState.UNKNOWN, expr.evaluate());\n+    }\n+\n+    @Test\n+    void nestedComposition2() {\n+        \/\/ F or (U and T) = F or U = U\n+        MediaQuery inner = ConjunctionExpression.of(expr(TriState.UNKNOWN), expr(TriState.TRUE));\n+        MediaQuery expr = DisjunctionExpression.of(expr(TriState.FALSE), inner);\n+        assertEquals(TriState.UNKNOWN, expr.evaluate());\n+    }\n+\n+    @Test\n+    void nestedComposition3() {\n+        \/\/ T or (F and U) = T or F = T\n+        MediaQuery inner = ConjunctionExpression.of(expr(TriState.FALSE), expr(TriState.UNKNOWN));\n+        MediaQuery expr = DisjunctionExpression.of(expr(TriState.TRUE), inner);\n+        assertEquals(TriState.TRUE, expr.evaluate());\n+    }\n+\n+    @Test\n+    void conjunctionOfListPropagates() {\n+        \/\/ ((T and U) and F) => (U and F) => F\n+        MediaQuery inner = ConjunctionExpression.of(expr(TriState.TRUE), expr(TriState.UNKNOWN));\n+        MediaQuery expr = ConjunctionExpression.of(inner, expr(TriState.FALSE));\n+        assertEquals(TriState.FALSE, expr.evaluate());\n+    }\n+\n+    @Test\n+    void disjunctionOfListPropagates() {\n+        \/\/ ((F or U) or T) => (U or T) => T\n+        MediaQuery inner = DisjunctionExpression.of(expr(TriState.FALSE), expr(TriState.UNKNOWN));\n+        MediaQuery expr = DisjunctionExpression.of(inner, expr(TriState.TRUE));\n+        assertEquals(TriState.TRUE, expr.evaluate());\n+    }\n+\n+    @Test\n+    void disjunctionShortCircuitsOnLeftTautology() {\n+        var calls = new AtomicInteger(0);\n+\n+        MediaQuery right = expr(() -> {\n+            calls.incrementAndGet();\n+            return TriState.FALSE;\n+        });\n+\n+        MediaQuery expr = DisjunctionExpression.of(expr(TriState.TRUE), right);\n+\n+        assertEquals(TriState.TRUE, expr.evaluate());\n+        assertEquals(0, calls.get(), \"Right supplier should not be called when left is TRUE for OR\");\n+    }\n+\n+    @Test\n+    void conjunctionShortCircuitsOnLeftContradiction() {\n+        var calls = new AtomicInteger(0);\n+\n+        MediaQuery right = expr(() -> {\n+            calls.incrementAndGet();\n+            return TriState.TRUE;\n+        });\n+\n+        MediaQuery expr = ConjunctionExpression.of(expr(TriState.FALSE), right);\n+\n+        assertEquals(TriState.FALSE, expr.evaluate());\n+        assertEquals(0, calls.get(), \"Right supplier should not be called when left is FALSE for AND\");\n+    }\n+}\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/com\/sun\/javafx\/css\/media\/MediaQueryTest.java","additions":178,"deletions":0,"binary":false,"changes":178,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,1 +28,8 @@\n-import com.sun.javafx.css.*;\n+import com.sun.javafx.css.FontFaceImpl;\n+import com.sun.javafx.css.RuleHelper;\n+import com.sun.javafx.css.media.MediaFeatures;\n+import com.sun.javafx.css.media.SizeQueryType;\n+import com.sun.javafx.css.media.TriState;\n+import com.sun.javafx.css.media.expression.ConjunctionExpression;\n+import com.sun.javafx.css.media.expression.FunctionExpression;\n+import com.sun.javafx.css.media.expression.GreaterOrEqualExpression;\n@@ -36,0 +43,1 @@\n+import java.util.Base64;\n@@ -38,0 +46,1 @@\n+import javafx.application.ColorScheme;\n@@ -42,1 +51,0 @@\n-\n@@ -46,0 +54,2 @@\n+import javafx.css.Size;\n+import javafx.css.SizeUnits;\n@@ -347,0 +357,100 @@\n+\n+    @Test\n+    public void stylesheetImport_withAlwaysFalseMediaQueryList_isNotImported() {\n+        var oldDefault = MediaFeatures.DEFAULT;\n+\n+        try {\n+            MediaFeatures.DEFAULT = (_, _) -> FunctionExpression.of(\n+                \"CssParserTest-feature1\", \"value\", () -> TriState.FALSE, _ -> null, null);\n+\n+            String importedStylesheet = Base64.getEncoder().encodeToString(\"\"\"\n+                .rule1 { foo: bar; }\n+                @media (prefers-reduced-motion) {\n+                    .rule2 { foo: bar; }\n+                }\n+                \"\"\".getBytes(StandardCharsets.UTF_8));\n+\n+            Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+                @import url(\"data:text\/css;base64,%s\") (CssParserTest-feature1);\n+                .rule3 { foo: bar; }\n+                \"\"\".formatted(importedStylesheet));\n+\n+            assertEquals(1, stylesheet.getRules().size());\n+            assertNull(RuleHelper.getMediaRule(stylesheet.getRules().getFirst()));\n+        } finally {\n+            MediaFeatures.DEFAULT = oldDefault;\n+        }\n+    }\n+\n+    @Test\n+    public void stylesheetImport_withAlwaysTrueMediaQueryList_isImportedUnconditionally() {\n+        var oldDefault = MediaFeatures.DEFAULT;\n+\n+        try {\n+            MediaFeatures.DEFAULT = (_, _) -> FunctionExpression.of(\n+                \"CssParserTest-feature2\", \"value\", () -> TriState.TRUE, _ -> null, null);\n+\n+            String importedStylesheet = Base64.getEncoder().encodeToString(\"\"\"\n+                .rule1 { foo: bar; }\n+                @media (prefers-reduced-motion) {\n+                    .rule2 { foo: bar; }\n+                }\n+                \"\"\".getBytes(StandardCharsets.UTF_8));\n+\n+            Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+                @import url(\"data:text\/css;base64,%s\") (CssParserTest-feature2);\n+                .rule3 { foo: bar; }\n+                \"\"\".formatted(importedStylesheet));\n+\n+            assertEquals(3, stylesheet.getRules().size());\n+\n+            Rule importedRule1 = stylesheet.getRules().get(0);\n+            assertNull(RuleHelper.getMediaRule(importedRule1));\n+\n+            Rule importedRule2 = stylesheet.getRules().get(1);\n+            assertNull(RuleHelper.getMediaRule(importedRule2).getParent());\n+\n+            Rule rule3 = stylesheet.getRules().get(2);\n+            assertNull(RuleHelper.getMediaRule(rule3));\n+        } finally {\n+            MediaFeatures.DEFAULT = oldDefault;\n+        }\n+    }\n+\n+    @Test\n+    public void stylesheetImport_withMediaQueryList_isImportedWithMediaRules() {\n+        String importedStylesheet = Base64.getEncoder().encodeToString(\"\"\"\n+            .rule1 { foo: bar; }\n+            @media (prefers-reduced-motion) {\n+                .rule2 { foo: bar; }\n+            }\n+            \"\"\".getBytes(StandardCharsets.UTF_8));\n+\n+        Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+            @import url(\"data:text\/css;base64,%s\") (min-width: 1000px) and (prefers-color-scheme: dark);\n+            .rule3 { foo: bar; }\n+            \"\"\".formatted(importedStylesheet));\n+\n+        assertEquals(3, stylesheet.getRules().size());\n+\n+        Rule importedRule1 = stylesheet.getRules().get(0);\n+        Rule importedRule2 = stylesheet.getRules().get(1);\n+\n+        var importConditions = List.of(ConjunctionExpression.of(\n+            GreaterOrEqualExpression.ofSize(SizeQueryType.WIDTH, new Size(1000, SizeUnits.PX)),\n+            FunctionExpression.of(\"prefers-color-scheme\", \"dark\", _ -> null, ColorScheme.DARK)));\n+\n+        assertEquals(\n+            importConditions,\n+            RuleHelper.getMediaRule(importedRule1).getQueries());\n+\n+        assertNull(RuleHelper.getMediaRule(importedRule1).getParent());\n+\n+        assertEquals(\n+            List.of(FunctionExpression.of(\"prefers-reduced-motion\", null, _ -> null, true)),\n+            RuleHelper.getMediaRule(importedRule2).getQueries());\n+\n+        assertEquals(\n+            importConditions,\n+            RuleHelper.getMediaRule(importedRule2).getParent().getQueries());\n+    }\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/javafx\/css\/CssParserTest.java","additions":113,"deletions":3,"binary":false,"changes":116,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+import javafx.css.CssParserShim;\n@@ -276,1 +277,1 @@\n-        Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+        String stylesheetText = \"\"\"\n@@ -282,1 +283,1 @@\n-            \"\"\");\n+            \"\"\";\n@@ -284,0 +285,1 @@\n+        Stylesheet stylesheet = new CssParserShim().parseUnmerged(stylesheetText, true);\n@@ -287,0 +289,3 @@\n+\n+        stylesheet = new CssParser().parse(stylesheetText);\n+        assertEquals(0, stylesheet.getRules().size());\n@@ -348,1 +353,1 @@\n-        Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+        String stylesheetText = \"\"\"\n@@ -352,1 +357,1 @@\n-            \"\"\");\n+            \"\"\";\n@@ -354,0 +359,1 @@\n+        Stylesheet stylesheet = new CssParserShim().parseUnmerged(stylesheetText, true);\n@@ -357,0 +363,3 @@\n+\n+        stylesheet = new CssParser().parse(stylesheetText);\n+        assertEquals(0, stylesheet.getRules().size());\n@@ -361,1 +370,1 @@\n-        Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+        String stylesheetText = \"\"\"\n@@ -369,1 +378,3 @@\n-            \"\"\");\n+            \"\"\";\n+\n+        Stylesheet stylesheet = new CssParserShim().parseUnmerged(stylesheetText, true);\n@@ -378,0 +389,3 @@\n+\n+        stylesheet = new CssParser().parse(stylesheetText);\n+        assertEquals(0, stylesheet.getRules().size());\n@@ -382,1 +396,1 @@\n-        Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+        Stylesheet stylesheet = new CssParserShim().parseUnmerged(\"\"\"\n@@ -390,1 +404,1 @@\n-            \"\"\");\n+            \"\"\", true);\n@@ -422,1 +436,1 @@\n-        Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+        String stylesheetText = \"\"\"\n@@ -426,1 +440,1 @@\n-            \"\"\");\n+            \"\"\";\n@@ -428,0 +442,1 @@\n+        Stylesheet stylesheet = new CssParserShim().parseUnmerged(stylesheetText, true);\n@@ -431,0 +446,3 @@\n+\n+        stylesheet = new CssParser().parse(stylesheetText);\n+        assertEquals(0, stylesheet.getRules().size());\n@@ -484,1 +502,1 @@\n-        Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+        Stylesheet stylesheet = new CssParserShim().parseUnmerged(\"\"\"\n@@ -512,1 +530,1 @@\n-            \"\"\");\n+            \"\"\", true);\n@@ -540,1 +558,1 @@\n-        Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+        Stylesheet stylesheet = new CssParserShim().parseUnmerged(\"\"\"\n@@ -568,1 +586,1 @@\n-            \"\"\");\n+            \"\"\", true);\n@@ -639,1 +657,1 @@\n-        Stylesheet stylesheet = new CssParser().parse(\"\"\"\n+        Stylesheet stylesheet = new CssParserShim().parseUnmerged(\"\"\"\n@@ -655,1 +673,1 @@\n-            \"\"\");\n+            \"\"\", true);\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/javafx\/css\/CssParser_mediaQuery_Test.java","additions":34,"deletions":16,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -31,0 +31,2 @@\n+import com.sun.javafx.css.media.MediaFeatures;\n+import com.sun.javafx.css.media.TriState;\n@@ -52,0 +54,1 @@\n+import javafx.css.CssParserShim;\n@@ -657,1 +660,1 @@\n-        var stylesheet = new CssParser().parse(cssText);\n+        var stylesheet = new CssParserShim().parseUnmerged(cssText, true);\n@@ -819,0 +822,46 @@\n+\n+    @Test\n+    void serializeStylesheetWithConditionalImport() throws IOException {\n+        var oldDefault = MediaFeatures.DEFAULT;\n+\n+        try {\n+            TriState[] testFeatureValue = new TriState[] { TriState.FALSE };\n+\n+            MediaFeatures.DEFAULT = (_, _) -> FunctionExpression.of(\n+                \"StylesheetTest-feature1\", \"value\", () -> testFeatureValue[0], _ -> null, null);\n+\n+            byte[] data = convertCssTextToBinary(\"\"\"\n+                @import url(\"%s\") (StylesheetTest-feature1);\n+                .rect2 { -fx-fill: green; }\n+                \"\"\".formatted(\"data:base64,\" + Base64.getEncoder().encodeToString(\"\"\"\n+                .rect1 { -fx-fill: blue; }\n+                @media (prefers-color-scheme: dark) {\n+                    .rect1 { -fx-fill: red; }\n+                }\n+                \"\"\".getBytes(StandardCharsets.UTF_8))));\n+\n+            \/\/ 1. If the import condition never matches, the stylesheet is not imported.\n+            testFeatureValue[0] = TriState.FALSE;\n+            var stylesheet = Stylesheet.loadBinary(new ByteArrayInputStream(data));\n+            assertEquals(1, stylesheet.getRules().size());\n+            assertNull(RuleHelper.getMediaRule(stylesheet.getRules().getFirst()));\n+\n+            \/\/ 2. If the import condition always matches, the stylesheet is unconditionally imported.\n+            testFeatureValue[0] = TriState.TRUE;\n+            stylesheet = Stylesheet.loadBinary(new ByteArrayInputStream(data));\n+            assertEquals(3, stylesheet.getRules().size());\n+            assertNull(RuleHelper.getMediaRule(stylesheet.getRules().get(0))); \/\/ unconditional import\n+            assertNotNull(RuleHelper.getMediaRule(stylesheet.getRules().get(1)));\n+            assertNull(RuleHelper.getMediaRule(stylesheet.getRules().get(2)));\n+\n+            \/\/ 3. If the import condition is unknown, the stylesheet is conditionally imported.\n+            testFeatureValue[0] = TriState.UNKNOWN;\n+            stylesheet = Stylesheet.loadBinary(new ByteArrayInputStream(data));\n+            assertEquals(3, stylesheet.getRules().size());\n+            assertNotNull(RuleHelper.getMediaRule(stylesheet.getRules().get(0))); \/\/ conditional import\n+            assertNotNull(RuleHelper.getMediaRule(stylesheet.getRules().get(1)));\n+            assertNull(RuleHelper.getMediaRule(stylesheet.getRules().get(2)));\n+        } finally {\n+            MediaFeatures.DEFAULT = oldDefault;\n+        }\n+    }\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/javafx\/css\/StylesheetTest.java","additions":50,"deletions":1,"binary":false,"changes":51,"status":"modified"}]}