{"files":[{"patch":"@@ -105,0 +105,1 @@\n+    virtual void setOnPreEdit(bool) = 0;\n@@ -177,0 +178,1 @@\n+        bool on_preedit;\n@@ -178,1 +180,1 @@\n-        guint keyval;\n+        bool on_key_event;\n@@ -219,0 +221,1 @@\n+    void setOnPreEdit(bool);\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/glass_window.h","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -33,0 +33,5 @@\n+static void on_preedit_start(GtkIMContext *im_context, gpointer user_data) {\n+    WindowContext *ctx = (WindowContext *) user_data;\n+    ctx->setOnPreEdit(true);\n+}\n+\n@@ -41,0 +46,1 @@\n+    ctx->setOnPreEdit(true);\n@@ -75,0 +81,5 @@\n+static void on_preedit_end(GtkIMContext *im_context, gpointer user_data) {\n+    WindowContext *ctx = (WindowContext *) user_data;\n+    ctx->setOnPreEdit(false);\n+}\n+\n@@ -80,3 +91,4 @@\n-void WindowContextBase::commitIME(gchar *str) {\n-    int len = g_utf8_strlen(str, -1);\n-    gunichar unicode_char = g_utf8_get_char(str);\n+\/\/ Note: JavaFX did not have surround support at this time\n+static gboolean on_delete_surrounding(GtkIMContext* self, gint offset, gint n_chars, gpointer user_data) {\n+    return TRUE;\n+}\n@@ -84,4 +96,6 @@\n-    \/\/ The committed IME is the same as keypress, so send keypress\n-    if (len == 1 && unicode_char == gdk_keyval_to_unicode(im_ctx.keyval)) {\n-        im_ctx.send_keypress = true;\n-    } else {\n+static gboolean on_retrieve_surrounding(GtkIMContext* self, gpointer user_data) {\n+    return TRUE;\n+}\n+\n+void WindowContextBase::commitIME(gchar *str) {\n+    if (im_ctx.on_preedit || !im_ctx.on_key_event) {\n@@ -90,0 +104,1 @@\n+        jsize slen = mainEnv->GetStringLength(jstr);\n@@ -94,2 +109,2 @@\n-                len,\n-                len,\n+                slen,\n+                slen,\n@@ -98,0 +113,2 @@\n+    } else {\n+        im_ctx.send_keypress = true;\n@@ -110,5 +127,2 @@\n-    GdkEventKey* ke = &event->key;\n-\n-    im_ctx.send_keypress = false;\n-    im_ctx.keyval = ke->keyval;\n-    bool filtered = gtk_im_context_filter_keypress(im_ctx.ctx, ke);\n+    im_ctx.on_key_event = true;\n+    bool filtered = gtk_im_context_filter_keypress(im_ctx.ctx, &event->key);\n@@ -117,0 +131,1 @@\n+        im_ctx.send_keypress = false;\n@@ -120,0 +135,1 @@\n+    im_ctx.on_key_event = false;\n@@ -123,0 +139,4 @@\n+void WindowContextBase::setOnPreEdit(bool preedit) {\n+    im_ctx.on_preedit = preedit;\n+}\n+\n@@ -145,1 +165,1 @@\n-    if (im_ctx.enabled) {\n+    if (im_ctx.on_preedit) {\n@@ -152,0 +172,2 @@\n+        gtk_im_context_set_use_preedit(GTK_IM_CONTEXT(im_ctx.ctx), true);\n+        g_signal_connect(im_ctx.ctx, \"preedit-start\", G_CALLBACK(on_preedit_start), this);\n@@ -153,0 +175,1 @@\n+        g_signal_connect(im_ctx.ctx, \"preedit-end\", G_CALLBACK(on_preedit_end), this);\n@@ -154,0 +177,2 @@\n+        g_signal_connect(im_ctx.ctx, \"retrieve-surrounding\", G_CALLBACK(on_retrieve_surrounding), this);\n+        g_signal_connect(im_ctx.ctx, \"delete-surrounding\", G_CALLBACK(on_delete_surrounding), this);\n@@ -159,0 +184,1 @@\n+    im_ctx.on_preedit = false;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/glass_window_ime.cpp","additions":41,"deletions":15,"binary":false,"changes":56,"status":"modified"}]}