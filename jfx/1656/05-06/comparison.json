{"files":[{"patch":"@@ -106,2 +106,6 @@\n-    native void _runLoop(ClassLoader classLoader, Runnable launchable,\n-                         boolean isTaskbarApplication);\n+    private long delegateHandle;\n+\n+    native long _initDelegate(ClassLoader classLoader, Runnable launchable, boolean isTaskbarApplication);\n+\n+    native void _runLoop(long delegate);\n+\n@@ -131,1 +135,2 @@\n-        _runLoop(classLoader, wrappedRunnable, isTaskbarApplication);\n+        delegateHandle = _initDelegate(classLoader, wrappedRunnable, isTaskbarApplication);\n+        _runLoop(delegateHandle);\n@@ -157,1 +162,1 @@\n-    native private void _finishTerminating();\n+    native private void _finishTerminating(long delegateHandle);\n@@ -160,1 +165,1 @@\n-        _finishTerminating();\n+        _finishTerminating(delegateHandle);\n@@ -423,0 +428,2 @@\n+    private native Map<String, Object> _getPlatformPreferences(long delegateHandle);\n+\n@@ -424,1 +431,3 @@\n-    public native Map<String, Object> getPlatformPreferences();\n+    public Map<String, Object> getPlatformPreferences() {\n+        return _getPlatformPreferences(delegateHandle);\n+    }\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/glass\/ui\/mac\/MacApplication.java","additions":15,"deletions":6,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -955,2 +955,2 @@\n- * Method:    _runLoop\n- * Signature: (Ljava\/lang\/ClassLoader;Ljava\/lang\/Runnable;Z)V\n+ * Method:    _initDelegate\n+ * Signature: (Ljava\/lang\/ClassLoader;Ljava\/lang\/Runnable;Z)J\n@@ -958,1 +958,1 @@\n-JNIEXPORT void JNICALL Java_com_sun_glass_ui_mac_MacApplication__1runLoop\n+JNIEXPORT jlong JNICALL Java_com_sun_glass_ui_mac_MacApplication__1initDelegate\n@@ -962,1 +962,1 @@\n-    LOG(\"Java_com_sun_glass_ui_mac_MacApplication__1runLoop\");\n+    LOG(\"Java_com_sun_glass_ui_mac_MacApplication__1initDelegate\");\n@@ -964,1 +964,1 @@\n-    NSAutoreleasePool *glasspool = [[NSAutoreleasePool alloc] init];\n+    if ([NSThread isMainThread] == YES)\n@@ -966,5 +966,5 @@\n-        if ([NSThread isMainThread] == YES)\n-        {\n-            \/\/            fprintf(stderr, \"\\nWARNING: Glass was started on 1st thread and will block this thread.\\nYou most likely do not want to do this - please remove \\\"-XstartOnFirstThread\\\" from VM arguments.\\n\\n\");\n-        }\n-        else\n+        \/\/            fprintf(stderr, \"\\nWARNING: Glass was started on 1st thread and will block this thread.\\nYou most likely do not want to do this - please remove \\\"-XstartOnFirstThread\\\" from VM arguments.\\n\\n\");\n+    }\n+    else\n+    {\n+        if ([[NSThread currentThread] name] == nil)\n@@ -972,4 +972,1 @@\n-            if ([[NSThread currentThread] name] == nil)\n-            {\n-                [[NSThread currentThread] setName:@\"Main Java Thread\"];\n-            }\n+            [[NSThread currentThread] setName:@\"Main Java Thread\"];\n@@ -977,0 +974,8 @@\n+    }\n+\n+    return (jlong)[[GlassApplication alloc] initWithEnv:env\n+                                            application:japplication\n+                                            launchable:jlaunchable\n+                                            taskbarApplication:isTaskbarApplication\n+                                            classLoader:classLoader];\n+}\n@@ -978,1 +983,13 @@\n-        GlassApplication *glass = [[GlassApplication alloc] initWithEnv:env application:japplication launchable:jlaunchable taskbarApplication:isTaskbarApplication classLoader:classLoader];\n+\/*\n+ * Class:     com_sun_glass_ui_mac_MacApplication\n+ * Method:    _runLoop\n+ * Signature: (J)V\n+ *\/\n+JNIEXPORT void JNICALL Java_com_sun_glass_ui_mac_MacApplication__1runLoop\n+(JNIEnv *env, jobject japplication, jlong appDelegate)\n+{\n+    LOG(\"Java_com_sun_glass_ui_mac_MacApplication__1runLoop\");\n+\n+    NSAutoreleasePool *glasspool = [[NSAutoreleasePool alloc] init];\n+    {\n+        GlassApplication* glass = (GlassApplication*)appDelegate;\n@@ -1001,1 +1018,1 @@\n- * Signature: ()V\n+ * Signature: (J)V\n@@ -1004,1 +1021,1 @@\n-(JNIEnv *env, jobject japplication)\n+(JNIEnv *env, jobject japplication, jlong appDelegate)\n@@ -1008,0 +1025,4 @@\n+    if (appDelegate) {\n+        [(GlassApplication*)appDelegate release];\n+    }\n+\n@@ -1265,1 +1286,1 @@\n- * Signature: ()Ljava\/util\/Map;\n+ * Signature: (J)Ljava\/util\/Map;\n@@ -1267,2 +1288,2 @@\n-JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_mac_MacApplication_getPlatformPreferences\n-(JNIEnv *env, jobject self)\n+JNIEXPORT jobject JNICALL Java_com_sun_glass_ui_mac_MacApplication__1getPlatformPreferences\n+(JNIEnv *env, jobject self, jlong appDelegate)\n@@ -1270,2 +1291,3 @@\n-    GlassApplication* app = (GlassApplication*)[NSApp delegate];\n-    return [app getPlatformPreferences];\n+    return appDelegate\n+        ? [(GlassApplication*)appDelegate getPlatformPreferences]\n+        : nil;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassApplication.m","additions":44,"deletions":22,"binary":false,"changes":66,"status":"modified"}]}