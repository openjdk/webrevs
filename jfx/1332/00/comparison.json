{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -2149,1 +2149,1 @@\n-        WritableImage result = Scene.doSnapshot(getScene(), x, y, w, h,\n+        WritableImage result = Scene.doSnapshot(getScene(), getSubScene(), x, y, w, h,\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/scene\/Node.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -1301,0 +1301,13 @@\n+    \/*\n+     * Shared between Scene and SubScene\n+     *\/\n+    static NGLightBase[] accumulateLightsForSnapshot(List<LightBase> lights) {\n+        if (lights == null || lights.isEmpty()) return null;\n+\n+        NGLightBase[] l = new NGLightBase[lights.size()];\n+        for (int i = 0; i < lights.size(); i++) {\n+            l[i] = lights.get(i).getPeer();\n+        }\n+        return l;\n+    }\n+\n@@ -1303,1 +1316,1 @@\n-    static WritableImage doSnapshot(Scene scene,\n+    static WritableImage doSnapshot(Scene scene, SubScene subScene,\n@@ -1349,1 +1362,1 @@\n-        \/\/ Grab the lights from the scene\n+        \/\/ Grab the lights from the scene and\/or subscene\n@@ -1351,4 +1364,25 @@\n-        if (scene != null && !scene.lights.isEmpty()) {\n-            context.lights = new NGLightBase[scene.lights.size()];\n-            for (int i = 0; i < scene.lights.size(); i++) {\n-                context.lights[i] = scene.lights.get(i).getPeer();\n+        int totalLightCount = 0;\n+\n+        NGLightBase[] sceneLights = (scene != null) ? accumulateLightsForSnapshot(scene.lights) : null;\n+        NGLightBase[] subSceneLights = (subScene != null) ? accumulateLightsForSnapshot(subScene.getLights()) : null;\n+        if (sceneLights != null) {\n+            totalLightCount += sceneLights.length;\n+        }\n+        if (subSceneLights != null) {\n+            totalLightCount += subSceneLights.length;\n+        }\n+\n+        if (totalLightCount > 0) {\n+            context.lights = new NGLightBase[totalLightCount];\n+\n+            int totalLightsAdded = 0;\n+            if (sceneLights != null) {\n+                for (int i = 0; i < sceneLights.length; i++) {\n+                    context.lights[i] = sceneLights[i];\n+                }\n+                totalLightsAdded += sceneLights.length;\n+            }\n+            if (subSceneLights != null) {\n+                for (int i = 0; i < subSceneLights.length; i++) {\n+                    context.lights[i + totalLightsAdded] = subSceneLights[i];\n+                }\n@@ -1397,1 +1431,1 @@\n-        return doSnapshot(this, 0, 0, w, h,\n+        return doSnapshot(this, null, 0, 0, w, h,\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/scene\/Scene.java","additions":42,"deletions":8,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2013, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -933,0 +933,3 @@\n+    List<LightBase> getLights() {\n+        return lights;\n+    }\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/scene\/SubScene.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -0,0 +1,136 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.javafx.scene;\n+\n+import javafx.geometry.Pos;\n+import javafx.scene.Node;\n+import javafx.scene.PointLight;\n+import javafx.scene.Scene;\n+import javafx.scene.SubScene;\n+import javafx.scene.image.PixelReader;\n+import javafx.scene.image.WritableImage;\n+import javafx.scene.layout.StackPane;\n+import javafx.scene.paint.Color;\n+import javafx.scene.paint.PhongMaterial;\n+import javafx.scene.shape.Box;\n+\n+import org.junit.After;\n+import org.junit.AfterClass;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import test.util.Util;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.assertNotNull;\n+\n+public class SnapshotLightsTest extends SnapshotCommon {\n+\n+    static final int BOX_DIM = 50;\n+\n+    @BeforeClass\n+    public static void setupOnce() {\n+        doSetupOnce();\n+    }\n+\n+    @AfterClass\n+    public static void teardownOnce() {\n+        doTeardownOnce();\n+    }\n+\n+    @Before\n+    public void setupEach() {\n+        assertNotNull(myApp);\n+        assertNotNull(myApp.primaryStage);\n+        assertTrue(myApp.primaryStage.isShowing());\n+    }\n+\n+    @After\n+    public void teardownEach() {\n+    }\n+\n+    private Scene buildScene(boolean inSubScene) {\n+        Box boxNode = new Box(BOX_DIM, BOX_DIM, BOX_DIM - 10);\n+        boxNode.setMaterial(new PhongMaterial(Color.WHITE));\n+\n+        StackPane pane = new StackPane(boxNode);\n+        pane.setAlignment(Pos.CENTER);\n+\n+        PointLight light = new PointLight(Color.BLUE);\n+        light.setTranslateZ(-150);\n+        pane.getChildren().add(light);\n+\n+        if (inSubScene) {\n+            SubScene ss = new SubScene(pane, BOX_DIM, BOX_DIM);\n+            StackPane subSceneRoot = new StackPane(ss);\n+            subSceneRoot.setAlignment(Pos.CENTER);\n+            return new Scene(subSceneRoot, BOX_DIM, BOX_DIM);\n+        } else {\n+            return new Scene(pane, BOX_DIM, BOX_DIM);\n+        }\n+    }\n+\n+    private void compareSnapshots(WritableImage base, WritableImage node) {\n+        assertEquals(base.getWidth(), node.getWidth(), 0.1);\n+        assertEquals(base.getHeight(), node.getHeight(), 0.1);\n+\n+        PixelReader baseReader = base.getPixelReader();\n+        PixelReader nodeReader = node.getPixelReader();\n+\n+        assertEquals(baseReader.getArgb(BOX_DIM \/ 2, BOX_DIM \/ 2), nodeReader.getArgb(BOX_DIM \/ 2, BOX_DIM \/ 2));\n+    }\n+\n+    public SnapshotLightsTest() {\n+    }\n+\n+    @Test\n+    public void testSceneNodeSnapshotLighting() throws Exception {\n+        Util.runAndWait(() -> {\n+            Scene scene = buildScene(false);\n+            WritableImage baseSnapshot = scene.snapshot(null);\n+\n+            Node boxNode = scene.getRoot().getChildrenUnmodifiable().get(0);\n+            WritableImage nodeSnapshot = boxNode.snapshot(null, null);\n+\n+            compareSnapshots(baseSnapshot, nodeSnapshot);\n+        });\n+    }\n+\n+    @Test\n+    public void testSubSceneNodeSnapshotLighting() throws Exception {\n+        Util.runAndWait(() -> {\n+            Scene scene = buildScene(true);\n+            WritableImage baseSnapshot = scene.snapshot(null);\n+\n+            SubScene ss = (SubScene)scene.getRoot().getChildrenUnmodifiable().get(0);\n+            Node boxNode = ss.getRoot().getChildrenUnmodifiable().get(0);\n+            WritableImage nodeSnapshot = boxNode.snapshot(null, null);\n+\n+            compareSnapshots(baseSnapshot, nodeSnapshot);\n+        });\n+    }\n+}\n","filename":"tests\/system\/src\/test\/java\/test\/javafx\/scene\/SnapshotLightsTest.java","additions":136,"deletions":0,"binary":false,"changes":136,"status":"added"}]}