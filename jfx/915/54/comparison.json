{"files":[{"patch":"@@ -59,2 +59,0 @@\n-    private native void setBoundsImpl(long ptr, int x, int y, boolean xSet, boolean ySet, int w, int h, int cw, int ch);\n-\n@@ -184,2 +182,0 @@\n-    private native void _setGravity(long ptr, float xGravity, float yGravity);\n-\n@@ -187,18 +183,3 @@\n-    protected void _setBounds(long ptr, int x, int y, boolean xSet, boolean ySet, int w, int h, int cw, int ch, float xGravity, float yGravity) {\n-        _setGravity(ptr, xGravity, yGravity);\n-        setBoundsImpl(ptr, x, y, xSet, ySet, w, h, cw, ch);\n-\n-        if ((w <= 0) && (cw > 0) || (h <= 0) && (ch > 0)) {\n-            final int[] extarr = new int[4];\n-            getFrameExtents(ptr, extarr);\n-\n-            \/\/ TODO: ((w <= 0) && (cw <= 0)) || ((h <= 0) && (ch <= 0))\n-            notifyResize(WindowEvent.RESIZE,\n-                         ((w <= 0) && (cw > 0)) ? cw + extarr[0] + extarr[1]\n-                                                : w,\n-                         ((h <= 0) && (ch > 0)) ? ch + extarr[2] + extarr[3]\n-                                                : h);\n-        }\n-    }\n-\n-    private native void getFrameExtents(long ptr, int[] extarr);\n+    protected native void _setBounds(long ptr, int x, int y, boolean xSet, boolean ySet,\n+                                       int w, int h, int cw, int ch,\n+                                       float xGravity, float yGravity);\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/glass\/ui\/gtk\/GtkWindow.java","additions":3,"deletions":22,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -443,1 +443,1 @@\n-                    ctx->process_property_notify(&event->property);\n+                    \/\/ let gtk handle it first to prevent a glitch\n@@ -445,0 +445,1 @@\n+                    ctx->process_property_notify(&event->property);\n@@ -495,1 +496,0 @@\n-                    ctx->process_map();\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/GlassApplication.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -175,2 +175,2 @@\n- * Method:    setBoundsImpl\n- * Signature: (JIIZZIIII)V\n+ * Method:    _setBounds\n+ * Signature: (JIIZZIIIIFF)V\n@@ -178,3 +178,3 @@\n-JNIEXPORT void JNICALL Java_com_sun_glass_ui_gtk_GtkWindow_setBoundsImpl\n-  (JNIEnv * env, jobject obj, jlong ptr, jint x, jint y, jboolean xSet, jboolean ySet, jint w, jint h, jint cw, jint ch)\n-{\n+JNIEXPORT void JNICALL Java_com_sun_glass_ui_gtk_GtkWindow__1setBounds\n+  (JNIEnv * env, jobject obj, jlong ptr, jint x, jint y, jboolean xSet, jboolean ySet,\n+   jint w, jint h, jint cw, jint ch, jfloat xGravity, jfloat yGravity) {\n@@ -185,1 +185,1 @@\n-    ctx->set_bounds(x, y, xSet, ySet, w, h, cw, ch);\n+    ctx->set_bounds(x, y, xSet, ySet, w, h, cw, ch, xGravity, yGravity);\n@@ -431,1 +431,1 @@\n-    ctx->restack(true);\n+    ctx->to_front();\n@@ -446,2 +446,1 @@\n-    ctx->restack(false);\n-\n+    ctx->to_back();\n@@ -542,0 +541,1 @@\n+\n@@ -551,34 +551,0 @@\n-\/*\n- * Class:     com_sun_glass_ui_gtk_GtkWindow\n- * Method:    getFrameExtents\n- * Signature: (J[I)V\n- *\/\n-JNIEXPORT void JNICALL Java_com_sun_glass_ui_gtk_GtkWindow_getFrameExtents\n-    (JNIEnv * env, jobject obj, jlong ptr, jintArray extarr)\n-{\n-    (void)obj;\n-\n-    WindowContext* ctx = JLONG_TO_WINDOW_CTX(ptr);\n-    WindowFrameExtents extents = ctx->get_frame_extents();\n-\n-    env->SetIntArrayRegion(extarr, 0, 1, &extents.left);\n-    env->SetIntArrayRegion(extarr, 1, 1, &extents.right);\n-    env->SetIntArrayRegion(extarr, 2, 1, &extents.top);\n-    env->SetIntArrayRegion(extarr, 3, 1, &extents.bottom);\n-}\n-\n-\/*\n- * Class:     com_sun_glass_ui_gtk_GtkWindow\n- * Method:    _setGravity\n- * Signature: (JFF)V\n- *\/\n-JNIEXPORT void JNICALL Java_com_sun_glass_ui_gtk_GtkWindow__1setGravity\n-    (JNIEnv * env, jobject obj, jlong ptr, jfloat xGravity, jfloat yGravity)\n-{\n-    (void)env;\n-    (void)obj;\n-\n-    WindowContext* ctx = JLONG_TO_WINDOW_CTX(ptr);\n-    ctx->set_gravity(xGravity, yGravity);\n-\n-}\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/GlassWindow.cpp","additions":9,"deletions":43,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -104,2 +104,1 @@\n-    if (event->changed_mask &\n-            (GDK_WINDOW_STATE_ICONIFIED | GDK_WINDOW_STATE_MAXIMIZED)) {\n+    if (event->changed_mask & (GDK_WINDOW_STATE_ICONIFIED | GDK_WINDOW_STATE_MAXIMIZED)) {\n@@ -110,0 +109,1 @@\n+\n@@ -122,1 +122,2 @@\n-            if ((gdk_windowManagerFunctions & GDK_FUNC_MINIMIZE) == 0) {\n+            if ((gdk_windowManagerFunctions & GDK_FUNC_MINIMIZE) == 0\n+                || (gdk_windowManagerFunctions & GDK_FUNC_MAXIMIZE) == 0) {\n@@ -124,1 +125,1 @@\n-                \/\/ request to iconify - so we need to restore it now.\n+                \/\/ request to iconify \/ maximize - so we need to restore it now.\n@@ -131,1 +132,1 @@\n-        notify_on_top( event->new_window_state & GDK_WINDOW_STATE_ABOVE);\n+        notify_on_top(event->new_window_state & GDK_WINDOW_STATE_ABOVE);\n@@ -151,1 +152,2 @@\n-                    event->in ? com_sun_glass_events_WindowEvent_FOCUS_GAINED : com_sun_glass_events_WindowEvent_FOCUS_LOST);\n+                    event->in ? com_sun_glass_events_WindowEvent_FOCUS_GAINED\n+                              : com_sun_glass_events_WindowEvent_FOCUS_LOST);\n@@ -515,5 +517,1 @@\n-void WindowContextBase::paint(void* data, jint width, jint height)\n-{\n-    if (!is_visible()) {\n-        return;\n-    }\n+void WindowContextBase::paint(void* data, jint width, jint height) {\n@@ -521,1 +519,2 @@\n-    cairo_region_t *region = gdk_window_get_clip_region(gdk_window);\n+    cairo_rectangle_int_t rect = {0, 0, width, height};\n+    cairo_region_t *region = cairo_region_create_rectangle(&rect);\n@@ -524,2 +523,1 @@\n-    cairo_t* context;\n-    context = gdk_cairo_create(gdk_window);\n+    cairo_t* context = gdk_cairo_create(gdk_window);\n@@ -527,2 +525,2 @@\n-    cairo_surface_t* cairo_surface;\n-    cairo_surface = cairo_image_surface_create_for_data(\n+    cairo_surface_t* cairo_surface =\n+        cairo_image_surface_create_for_data(\n@@ -536,1 +534,1 @@\n-    cairo_set_operator (context, CAIRO_OPERATOR_SOURCE);\n+    cairo_set_operator(context, CAIRO_OPERATOR_SOURCE);\n@@ -538,0 +536,1 @@\n+\n@@ -565,9 +564,0 @@\n-void WindowContextBase::reparent_children(WindowContext* parent) {\n-    std::set<WindowContextTop*>::iterator it;\n-    for (it = children.begin(); it != children.end(); ++it) {\n-        (*it)->set_owner(parent);\n-        parent->add_child(*it);\n-    }\n-    children.clear();\n-}\n-\n@@ -576,1 +566,1 @@\n-        gtk_widget_show_all(gtk_widget);\n+        gtk_widget_show(gtk_widget);\n@@ -599,1 +589,0 @@\n-\n@@ -703,2 +692,0 @@\n-WindowFrameExtents WindowContextTop::normal_extents = {28, 1, 1, 1};\n-WindowFrameExtents WindowContextTop::utility_extents = {28, 1, 1, 1};\n@@ -707,0 +694,43 @@\n+\/\/ Work-around because frame extents are only obtained after window is shown.\n+\/\/ This is used to know the total window size (content + decoration)\n+\/\/ The first window will have a duplicated resize event, subsequent windows will use the cached value.\n+WindowFrameExtents WindowContextTop::normal_extents = {0, 0, 0, 0};\n+WindowFrameExtents WindowContextTop::utility_extents = {0, 0, 0, 0};\n+\n+static int geometry_get_window_width(const WindowGeometry *windowGeometry) {\n+     return (windowGeometry->final_width.type == BOUNDSTYPE_WINDOW)\n+                   ? windowGeometry->final_width.value\n+                   : windowGeometry->final_width.value\n+                         + windowGeometry->extents.left\n+                         + windowGeometry->extents.right;\n+}\n+\n+static int geometry_get_window_height(const WindowGeometry *windowGeometry) {\n+    return (windowGeometry->final_height.type == BOUNDSTYPE_WINDOW)\n+                   ? windowGeometry->final_height.value\n+                   : windowGeometry->final_height.value\n+                         + windowGeometry->extents.top\n+                         + windowGeometry->extents.bottom;\n+}\n+\n+static int geometry_get_content_width(WindowGeometry *windowGeometry) {\n+    return (windowGeometry->final_width.type == BOUNDSTYPE_CONTENT)\n+                   ? windowGeometry->final_width.value\n+                   : windowGeometry->final_width.value\n+                         - windowGeometry->extents.left\n+                         - windowGeometry->extents.right;\n+}\n+\n+static int geometry_get_content_height(WindowGeometry *windowGeometry) {\n+    return (windowGeometry->final_height.type == BOUNDSTYPE_CONTENT)\n+                   ? windowGeometry->final_height.value\n+                   : windowGeometry->final_height.value\n+                         - windowGeometry->extents.top\n+                         - windowGeometry->extents.bottom;\n+}\n+\n+static GdkAtom get_net_frame_extents_atom() {\n+    static const char * extents_str = \"_NET_FRAME_EXTENTS\";\n+    return gdk_atom_intern(extents_str, FALSE);\n+}\n+\n@@ -716,4 +746,0 @@\n-            frame_extents_initialized(),\n-            map_received(false),\n-            location_assigned(false),\n-            size_assigned(false),\n@@ -721,2 +747,1 @@\n-            requested_bounds()\n-{\n+            is_fullscreen(false) {\n@@ -725,1 +750,1 @@\n-    gtk_widget =  gtk_window_new(type == POPUP ? GTK_WINDOW_POPUP : GTK_WINDOW_TOPLEVEL);\n+    gtk_widget = gtk_window_new(type == POPUP ? GTK_WINDOW_POPUP : GTK_WINDOW_TOPLEVEL);\n@@ -743,0 +768,3 @@\n+    const char* wm_name = gdk_x11_screen_get_window_manager_name(gdk_screen_get_default());\n+    wmanager = (g_strcmp0(\"Compiz\", wm_name) == 0) ? COMPIZ : UNKNOWN;\n+\n@@ -752,1 +780,0 @@\n-    gtk_widget_set_size_request(gtk_widget, 0, 0);\n@@ -755,4 +782,0 @@\n-    if (frame_type != TITLED) {\n-        gtk_window_set_decorated(GTK_WINDOW(gtk_widget), FALSE);\n-    }\n-\n@@ -760,1 +783,0 @@\n-    gtk_window_set_title(GTK_WINDOW(gtk_widget), \"\");\n@@ -762,0 +784,1 @@\n+    gtk_window_set_title(GTK_WINDOW(gtk_widget), \"\");\n@@ -774,1 +797,3 @@\n-    if (frame_type == TITLED) {\n+    if (frame_type != TITLED) {\n+        gtk_window_set_decorated(GTK_WINDOW(gtk_widget), FALSE);\n+    } else {\n@@ -776,0 +801,1 @@\n+        geometry.extents = get_cached_extents();\n@@ -777,2 +803,0 @@\n-\n-    event_serial = GDK_CURRENT_TIME;\n@@ -793,8 +817,1 @@\n-static GdkAtom\n-get_net_frame_extents_atom() {\n-    static const char * extents_str = \"_NET_FRAME_EXTENTS\";\n-    return gdk_atom_intern(extents_str, TRUE);\n-}\n-\n-void\n-WindowContextTop::request_frame_extents() {\n+void WindowContextTop::request_frame_extents() {\n@@ -802,1 +819,2 @@\n-    Atom rfeAtom = XInternAtom(display, \"_NET_REQUEST_FRAME_EXTENTS\", True);\n+    static Atom rfeAtom = XInternAtom(display, \"_NET_REQUEST_FRAME_EXTENTS\", False);\n+\n@@ -819,6 +837,2 @@\n-void WindowContextTop::activate_window() {\n-    Display *display = GDK_DISPLAY_XDISPLAY (gdk_window_get_display (gdk_window));\n-    Atom navAtom = XInternAtom(display, \"_NET_ACTIVE_WINDOW\", True);\n-    if (navAtom != None) {\n-        XClientMessageEvent clientMessage;\n-        memset(&clientMessage, 0, sizeof(clientMessage));\n+void WindowContextTop::update_frame_extents() {\n+    int top, left, bottom, right;\n@@ -826,7 +840,12 @@\n-        clientMessage.type = ClientMessage;\n-        clientMessage.window = GDK_WINDOW_XID(gdk_window);\n-        clientMessage.message_type = navAtom;\n-        clientMessage.format = 32;\n-        clientMessage.data.l[0] = 1;\n-        clientMessage.data.l[1] = gdk_x11_get_server_time(gdk_window);\n-        clientMessage.data.l[2] = 0;\n+    if (get_frame_extents_property(&top, &left, &bottom, &right)) {\n+        if (top > 0 || right > 0 || bottom > 0 || left > 0) {\n+            bool changed = geometry.extents.top != top\n+                            || geometry.extents.left != left\n+                            || geometry.extents.bottom != bottom\n+                            || geometry.extents.right != right;\n+\n+            if (changed) {\n+                geometry.extents.top = top;\n+                geometry.extents.left = left;\n+                geometry.extents.bottom = bottom;\n+                geometry.extents.right = right;\n@@ -834,4 +853,23 @@\n-        XSendEvent(display, XDefaultRootWindow(display), False,\n-                   SubstructureRedirectMask | SubstructureNotifyMask,\n-                   (XEvent *) &clientMessage);\n-        XFlush(display);\n+                set_cached_extents(geometry.extents);\n+\n+                \/\/ set bounds again to correct window size\n+                \/\/ accounting decorations\n+                int w = geometry_get_window_width(&geometry);\n+                int h = geometry_get_window_height(&geometry);\n+                int cw = geometry_get_content_width(&geometry);\n+                int ch = geometry_get_content_height(&geometry);\n+\n+                int x = geometry.x;\n+                int y = geometry.y;\n+\n+                if (geometry.gravity_x != 0) {\n+                    x -= geometry.gravity_x * (float) (left + right);\n+                }\n+\n+                if (geometry.gravity_y != 0) {\n+                    y -= geometry.gravity_y * (float) (top + bottom);\n+                }\n+\n+                set_bounds(x, y, true, true, w, h, cw, ch, 0, 0);\n+           }\n+        }\n@@ -853,24 +891,1 @@\n-\n-bool WindowContextTop::update_frame_extents() {\n-    bool changed = false;\n-    int top, left, bottom, right;\n-    if (get_frame_extents_property(&top, &left, &bottom, &right)) {\n-        changed = geometry.extents.top != top\n-                    || geometry.extents.left != left\n-                    || geometry.extents.bottom != bottom\n-                    || geometry.extents.right != right;\n-        if (changed) {\n-            geometry.extents.top = top;\n-            geometry.extents.left = left;\n-            geometry.extents.bottom = bottom;\n-            geometry.extents.right = right;\n-            if (!is_null_extents()) {\n-                set_cached_extents(geometry.extents);\n-            }\n-        }\n-    }\n-    return changed;\n-}\n-\n-bool\n-WindowContextTop::get_frame_extents_property(int *top, int *left,\n+bool WindowContextTop::get_frame_extents_property(int *top, int *left,\n@@ -902,68 +917,1 @@\n-static int geometry_get_window_width(const WindowGeometry *windowGeometry) {\n-     return (windowGeometry->final_width.type != BOUNDSTYPE_WINDOW)\n-                   ? windowGeometry->final_width.value\n-                         + windowGeometry->extents.left\n-                         + windowGeometry->extents.right\n-                   : windowGeometry->final_width.value;\n-}\n-\n-static int geometry_get_window_height(const WindowGeometry *windowGeometry) {\n-    return (windowGeometry->final_height.type != BOUNDSTYPE_WINDOW)\n-                   ? windowGeometry->final_height.value\n-                         + windowGeometry->extents.top\n-                         + windowGeometry->extents.bottom\n-                   : windowGeometry->final_height.value;\n-}\n-\n-static int geometry_get_content_width(WindowGeometry *windowGeometry) {\n-    return (windowGeometry->final_width.type != BOUNDSTYPE_CONTENT)\n-                   ? windowGeometry->final_width.value\n-                         - windowGeometry->extents.left\n-                         - windowGeometry->extents.right\n-                   : windowGeometry->final_width.value;\n-}\n-static int geometry_get_content_height(WindowGeometry *windowGeometry) {\n-    return (windowGeometry->final_height.type != BOUNDSTYPE_CONTENT)\n-                   ? windowGeometry->final_height.value\n-                         - windowGeometry->extents.top\n-                         - windowGeometry->extents.bottom\n-                   : windowGeometry->final_height.value;\n-}\n-\n-static int geometry_get_window_x(const WindowGeometry *windowGeometry) {\n-    float value = windowGeometry->refx;\n-    if (windowGeometry->gravity_x != 0) {\n-        value -= geometry_get_window_width(windowGeometry)\n-                     * windowGeometry->gravity_x;\n-    }\n-    return (int) value;\n-}\n-\n-static int geometry_get_window_y(const WindowGeometry *windowGeometry) {\n-    float value = windowGeometry->refy;\n-    if (windowGeometry->gravity_y != 0) {\n-        value -= geometry_get_window_height(windowGeometry)\n-                     * windowGeometry->gravity_y;\n-    }\n-    return (int) value;\n-}\n-\n-static void geometry_set_window_x(WindowGeometry *windowGeometry, int value) {\n-    float newValue = value;\n-    if (windowGeometry->gravity_x != 0) {\n-        newValue += geometry_get_window_width(windowGeometry)\n-                * windowGeometry->gravity_x;\n-    }\n-    windowGeometry->refx = newValue;\n-}\n-\n-static void geometry_set_window_y(WindowGeometry *windowGeometry, int value) {\n-    float newValue = value;\n-    if (windowGeometry->gravity_y != 0) {\n-        newValue += geometry_get_window_height(windowGeometry)\n-                * windowGeometry->gravity_y;\n-    }\n-    windowGeometry->refy = newValue;\n-}\n-\n-void WindowContextTop::process_net_wm_property() {\n+void WindowContextTop::work_around_compiz_state() {\n@@ -971,0 +919,3 @@\n+    if (wmanager != COMPIZ) {\n+        return;\n+    }\n@@ -1011,2 +962,6 @@\n-    if (event->atom == atom_net_wm_state && event->window == gdk_window) {\n-        process_net_wm_property();\n+    if (event->window == gdk_window) {\n+        if (event->atom == get_net_frame_extents_atom()) {\n+            update_frame_extents();\n+        } else if (event->atom == atom_net_wm_state) {\n+            work_around_compiz_state();\n+        }\n@@ -1016,6 +971,4 @@\n-void WindowContextTop::process_configure(GdkEventConfigure* event) {\n-    gint x, y, w, h;\n-    bool updateWindowConstraints = false;\n-    if (gtk_window_get_decorated(GTK_WINDOW(gtk_widget))) {\n-        GdkRectangle frame;\n-        gint top, left, bottom, right;\n+void WindowContextTop::process_state(GdkEventWindowState* event) {\n+    if (event->changed_mask & GDK_WINDOW_STATE_FULLSCREEN) {\n+        is_fullscreen = event->new_window_state & GDK_WINDOW_STATE_FULLSCREEN;\n+    }\n@@ -1023,26 +976,4 @@\n-        gdk_window_get_frame_extents(gdk_window, &frame);\n-#ifdef GLASS_GTK3\n-        gdk_window_get_geometry(gdk_window, NULL, NULL, &w, &h);\n-#else\n-        gdk_window_get_geometry(gdk_window, NULL, NULL, &w, &h, NULL);\n-#endif\n-        x = frame.x;\n-        y = frame.y;\n-        geometry.current_width = frame.width;\n-        geometry.current_height = frame.height;\n-\n-        if (update_frame_extents()) {\n-            updateWindowConstraints = true;\n-            if (!frame_extents_initialized && !is_null_extents()) {\n-                frame_extents_initialized = true;\n-                set_bounds(0, 0, false, false,\n-                    requested_bounds.width, requested_bounds.height,\n-                    requested_bounds.client_width, requested_bounds.client_height\n-                );\n-            }\n-        }\n-    } else {\n-        x = event->x;\n-        y = event->y;\n-        w = event->width;\n-        h = event->height;\n+    if (event->changed_mask & GDK_WINDOW_STATE_MAXIMIZED\n+        && !(event->new_window_state & GDK_WINDOW_STATE_MAXIMIZED)) {\n+        gtk_window_resize(GTK_WINDOW(gtk_widget), geometry_get_content_width(&geometry),\n+                                    geometry_get_content_height(&geometry));\n@@ -1051,5 +982,2 @@\n-    if (size_assigned && w <= 1 && h <= 1 && (geometry.final_width.value > 1 ||\n-                                             geometry.final_height.value > 1)) {\n-        \/\/ skip artifact\n-        return;\n-   }\n+    WindowContextBase::process_state(event);\n+}\n@@ -1057,7 +985,3 @@\n-    \/\/ JDK-8232811: to avoid conflicting events, update the geometry only after window pops.\n-    if (map_received) {\n-        geometry.final_width.value = w;\n-        geometry.final_width.type = BOUNDSTYPE_CONTENT;\n-        geometry.final_height.value = h;\n-        geometry.final_height.type = BOUNDSTYPE_CONTENT;\n-    }\n+void WindowContextTop::process_configure(GdkEventConfigure* event) {\n+    int ww = event->width + geometry.extents.left + geometry.extents.right;\n+    int wh = event->height + geometry.extents.top + geometry.extents.bottom;\n@@ -1065,2 +989,3 @@\n-    geometry_set_window_x(&geometry, x);\n-    geometry_set_window_y(&geometry, y);\n+    if (!is_maximized && !is_fullscreen) {\n+        geometry.final_width.value = (geometry.final_width.type == BOUNDSTYPE_CONTENT)\n+                ? event->width : ww;\n@@ -1068,8 +993,2 @@\n-    if (jview) {\n-        mainEnv->CallVoidMethod(jview, jViewNotifyResize,\n-                event->width,\n-                event->height);\n-        CHECK_JNI_EXCEPTION(mainEnv)\n-        mainEnv->CallVoidMethod(jview, jViewNotifyView,\n-                com_sun_glass_events_ViewEvent_MOVE);\n-        CHECK_JNI_EXCEPTION(mainEnv)\n+        geometry.final_height.value = (geometry.final_height.type == BOUNDSTYPE_CONTENT)\n+                ? event->height : wh;\n@@ -1077,1 +996,3 @@\n-    if (jwindow) {\n+\n+    \/\/ Do not report if iconified, because Java side would set the state to NORMAL\n+    if (jwindow && !is_iconified) {\n@@ -1082,2 +1003,1 @@\n-                geometry.current_width,\n-                geometry.current_height);\n+                ww, wh);\n@@ -1086,2 +1006,4 @@\n-        mainEnv->CallVoidMethod(jwindow, jWindowNotifyMove, x, y);\n-        CHECK_JNI_EXCEPTION(mainEnv)\n+        if (jview) {\n+            mainEnv->CallVoidMethod(jview, jViewNotifyResize, event->width, event->height);\n+            CHECK_JNI_EXCEPTION(mainEnv)\n+        }\n@@ -1090,1 +1012,16 @@\n-    glong to_screen = getScreenPtrForLocation(x, y);\n+    int x, y;\n+\n+    if (frame_type == TITLED) {\n+        GdkRectangle rect;\n+        gdk_window_get_frame_extents(gdk_window, &rect);\n+        x = rect.x;\n+        y = rect.y;\n+    } else {\n+        gdk_window_get_origin(gdk_window, &x, &y);\n+    }\n+\n+    geometry.x = x;\n+    geometry.y = y;\n+    notify_window_move();\n+\n+    glong to_screen = getScreenPtrForLocation(geometry.x, geometry.y);\n@@ -1102,9 +1039,0 @@\n-\n-    if (resizable.request != REQUEST_NONE) {\n-        set_window_resizable(resizable.request == REQUEST_RESIZABLE);\n-        resizable.request = REQUEST_NONE;\n-    } else if (!resizable.value) {\n-        set_window_resizable(false);\n-    } else if (updateWindowConstraints) {\n-        update_window_constraints();\n-    }\n@@ -1114,19 +1042,17 @@\n-    if (resizable.value) {\n-        GdkGeometry geom = {\n-            (resizable.minw == -1) ? 1\n-                    : resizable.minw - geometry.extents.left - geometry.extents.right,\n-            (resizable.minh == -1) ? 1\n-                    : resizable.minh - geometry.extents.top - geometry.extents.bottom,\n-            (resizable.maxw == -1) ? 100000\n-                    : resizable.maxw - geometry.extents.left - geometry.extents.right,\n-            (resizable.maxh == -1) ? 100000\n-                    : resizable.maxh - geometry.extents.top - geometry.extents.bottom,\n-            0, 0, 0, 0, 0.0, 0.0, GDK_GRAVITY_NORTH_WEST\n-        };\n-        gtk_window_set_geometry_hints(GTK_WINDOW(gtk_widget), NULL, &geom,\n-                static_cast<GdkWindowHints> (GDK_HINT_MIN_SIZE | GDK_HINT_MAX_SIZE));\n-    }\n-}\n-\n-void WindowContextTop::set_window_resizable(bool res) {\n-    if(!res) {\n+    GdkGeometry hints;\n+\n+    if (resizable.value && !is_disabled) {\n+        int min_w = (resizable.minw == -1) ? 1\n+                      : resizable.minw - geometry.extents.left - geometry.extents.right;\n+        int min_h =  (resizable.minh == -1) ? 1\n+                      : resizable.minh - geometry.extents.top - geometry.extents.bottom;\n+\n+        hints.min_width = (min_w < 1) ? 1 : min_w;\n+        hints.min_height = (min_h < 1) ? 1 : min_h;\n+\n+        hints.max_width = (resizable.maxw == -1) ? G_MAXINT\n+                            : resizable.maxw - geometry.extents.left - geometry.extents.right;\n+\n+        hints.max_height = (resizable.maxh == -1) ? G_MAXINT\n+                           : resizable.maxh - geometry.extents.top - geometry.extents.bottom;\n+    } else {\n@@ -1135,10 +1061,5 @@\n-        if (w == -1 && h == -1) {\n-            gtk_window_get_size(GTK_WINDOW(gtk_widget), &w, &h);\n-        }\n-        GdkGeometry geom = {w, h, w, h, 0, 0, 0, 0, 0.0, 0.0, GDK_GRAVITY_NORTH_WEST};\n-        gtk_window_set_geometry_hints(GTK_WINDOW(gtk_widget), NULL, &geom,\n-                static_cast<GdkWindowHints>(GDK_HINT_MIN_SIZE | GDK_HINT_MAX_SIZE));\n-        resizable.value = false;\n-    } else {\n-        resizable.value = true;\n-        update_window_constraints();\n+\n+        hints.min_width = w;\n+        hints.min_height = h;\n+        hints.max_width = w;\n+        hints.max_height = h;\n@@ -1146,0 +1067,3 @@\n+\n+    gtk_window_set_geometry_hints(GTK_WINDOW(gtk_widget), NULL, &hints,\n+                                  (GdkWindowHints)(GDK_HINT_MIN_SIZE | GDK_HINT_MAX_SIZE));\n@@ -1149,9 +1073,2 @@\n-    resizable.prev = false;\n-    gint w, h;\n-    gtk_window_get_size(GTK_WINDOW(gtk_widget), &w, &h);\n-    if (map_received || w > 1 || h > 1) {\n-        set_window_resizable(res);\n-    } else {\n-        \/\/Since window is not ready yet set only request for change of resizable.\n-        resizable.request  = res ? REQUEST_RESIZABLE : REQUEST_NOT_RESIZABLE;\n-    }\n+    resizable.value = res;\n+    update_window_constraints();\n@@ -1160,10 +1077,1 @@\n-void WindowContextTop::set_visible(bool visible)\n-{\n-    if (visible) {\n-        if (!size_assigned) {\n-            set_bounds(0, 0, false, false, 320, 200, -1, -1);\n-        }\n-        if (!location_assigned) {\n-            set_bounds(0, 0, true, true, -1, -1, -1, -1);\n-        }\n-    }\n+void WindowContextTop::set_visible(bool visible) {\n@@ -1171,0 +1079,5 @@\n+\n+    if (visible && !geometry.size_assigned) {\n+        set_bounds(0, 0, false, false, 320, 200, -1, -1, 0, 0);\n+    }\n+\n@@ -1178,5 +1091,7 @@\n-void WindowContextTop::set_bounds(int x, int y, bool xSet, bool ySet, int w, int h, int cw, int ch) {\n-    requested_bounds.width = w;\n-    requested_bounds.height = h;\n-    requested_bounds.client_width = cw;\n-    requested_bounds.client_height = ch;\n+void WindowContextTop::set_bounds(int x, int y, bool xSet, bool ySet, int w, int h, int cw, int ch,\n+                                  float gravity_x, float gravity_y) {\n+\/\/     fprintf(stderr, \"set_bounds -> x = %d, y = %d, xset = %d, yset = %d, w = %d, h = %d, cw = %d, ch = %d, gx = %f, gy = %f\\n\",\n+\/\/            x, y, xSet, ySet, w, h, cw, ch, gravity_x, gravity_y);\n+    \/\/ newW \/ newH are view\/content sizes\n+    int newW = 0;\n+    int newH = 0;\n@@ -1184,10 +1099,2 @@\n-    if (!frame_extents_initialized && frame_type == TITLED) {\n-        update_frame_extents();\n-        if (is_null_extents()) {\n-            if (!is_null_extents(get_cached_extents())) {\n-                geometry.extents = get_cached_extents();\n-            }\n-        } else {\n-            frame_extents_initialized = true;\n-        }\n-    }\n+    geometry.gravity_x = gravity_x;\n+    geometry.gravity_y = gravity_y;\n@@ -1195,2 +1102,0 @@\n-    XWindowChanges windowChanges;\n-    unsigned int windowChangesMask = 0;\n@@ -1198,1 +1103,0 @@\n-        geometry.final_width.value = w;\n@@ -1200,3 +1104,2 @@\n-        geometry.current_width = geometry_get_window_width(&geometry);\n-        windowChanges.width = geometry_get_content_width(&geometry);\n-        windowChangesMask |= CWWidth;\n+        geometry.final_width.value = w;\n+        newW = w - (geometry.extents.left + geometry.extents.right);\n@@ -1204,1 +1107,0 @@\n-        geometry.final_width.value = cw;\n@@ -1206,3 +1108,2 @@\n-        geometry.current_width = geometry_get_window_width(&geometry);\n-        windowChanges.width = geometry_get_content_width(&geometry);\n-        windowChangesMask |= CWWidth;\n+        geometry.final_width.value = cw;\n+        newW = cw;\n@@ -1212,1 +1113,0 @@\n-        geometry.final_height.value = h;\n@@ -1214,3 +1114,2 @@\n-        geometry.current_height = geometry_get_window_height(&geometry);\n-        windowChanges.height = geometry_get_content_height(&geometry);\n-        windowChangesMask |= CWHeight;\n+        geometry.final_height.value = h;\n+        newH = h - (geometry.extents.top + geometry.extents.bottom);\n@@ -1218,1 +1117,0 @@\n-        geometry.final_height.value = ch;\n@@ -1220,3 +1118,10 @@\n-        geometry.current_height = geometry_get_window_height(&geometry);\n-        windowChanges.height = geometry_get_content_height(&geometry);\n-        windowChangesMask |= CWHeight;\n+        geometry.final_height.value = ch;\n+        newH = ch;\n+    }\n+\n+    if (newW > 0 || newH > 0) {\n+        \/\/ call update_window_constraints() to let gtk_window_resize succeed, because it's bound to geometry constraints\n+        update_window_constraints();\n+        gtk_window_resize(GTK_WINDOW(gtk_widget), newW, newH);\n+        geometry.size_assigned = true;\n+        notify_window_resize();\n@@ -1227,1 +1132,1 @@\n-            geometry.refx = x + geometry.current_width * geometry.gravity_x;\n+            geometry.x = x;\n@@ -1230,3 +1135,0 @@\n-        windowChanges.x = geometry_get_window_x(&geometry);\n-        windowChangesMask |= CWX;\n-\n@@ -1234,1 +1136,1 @@\n-            geometry.refy = y + geometry.current_height * geometry.gravity_y;\n+            geometry.y = y;\n@@ -1237,4 +1139,2 @@\n-        windowChanges.y = geometry_get_window_y(&geometry);\n-        windowChangesMask |= CWY;\n-\n-        location_assigned = true;\n+        gtk_window_move(GTK_WINDOW(gtk_widget), geometry.x, geometry.y);\n+        notify_window_move();\n@@ -1242,9 +1142,0 @@\n-\n-    if (w > 0 || h > 0 || cw > 0 || ch > 0) size_assigned = true;\n-\n-    window_configure(&windowChanges, windowChangesMask);\n-\n-}\n-\n-void WindowContextTop::process_map() {\n-    map_received = true;\n@@ -1253,61 +1144,1 @@\n-void WindowContextTop::window_configure(XWindowChanges *windowChanges,\n-        unsigned int windowChangesMask) {\n-    if (windowChangesMask == 0) {\n-        return;\n-    }\n-\n-    if (windowChangesMask & (CWX | CWY)) {\n-        gint newX, newY;\n-        gtk_window_get_position(GTK_WINDOW(gtk_widget), &newX, &newY);\n-\n-        if (windowChangesMask & CWX) {\n-            newX = windowChanges->x;\n-        }\n-        if (windowChangesMask & CWY) {\n-            newY = windowChanges->y;\n-        }\n-        gtk_window_move(GTK_WINDOW(gtk_widget), newX, newY);\n-    }\n-\n-    if (windowChangesMask & (CWWidth | CWHeight)) {\n-        gint newWidth, newHeight;\n-        gtk_window_get_size(GTK_WINDOW(gtk_widget), &newWidth, &newHeight);\n-\n-        if (windowChangesMask & CWWidth) {\n-            newWidth = windowChanges->width;\n-        }\n-        if (windowChangesMask & CWHeight) {\n-            newHeight = windowChanges->height;\n-        }\n-\n-        if (!resizable.value) {\n-            GdkGeometry geom;\n-            GdkWindowHints hints = (GdkWindowHints)(GDK_HINT_MIN_SIZE | GDK_HINT_MAX_SIZE);\n-            geom.min_width = geom.max_width = newWidth;\n-            geom.min_height = geom.max_height = newHeight;\n-            gtk_window_set_geometry_hints(GTK_WINDOW(gtk_widget), NULL, &geom, hints);\n-        }\n-        gtk_window_resize(GTK_WINDOW(gtk_widget), newWidth, newHeight);\n-\n-        \/\/JDK-8193502: Moved here from WindowContextBase::set_view because set_view is called\n-        \/\/first and the size is not set yet. This also guarantees that the size will be correct\n-        \/\/see: gtk_window_get_size doc for more context.\n-        if (jview) {\n-            mainEnv->CallVoidMethod(jview, jViewNotifyResize, newWidth, newHeight);\n-            CHECK_JNI_EXCEPTION(mainEnv);\n-        }\n-    }\n-}\n-\n-void WindowContextTop::process_key(GdkEventKey* event) {\n-    WindowContextBase::process_key(event);\n-    event_serial = event->time;\n-}\n-\n-void WindowContextTop::process_mouse_button(GdkEventButton* event) {\n-    WindowContextBase::process_mouse_button(event);\n-    event_serial = event->time;\n-}\n-\n-void WindowContextTop::applyShapeMask(void* data, uint width, uint height)\n-{\n+void WindowContextTop::applyShapeMask(void* data, uint width, uint height) {\n@@ -1321,15 +1152,0 @@\n-void WindowContextTop::ensure_window_size() {\n-    gint w, h;\n-#ifdef GLASS_GTK3\n-    gdk_window_get_geometry(gdk_window, NULL, NULL, &w, &h);\n-#else\n-    gdk_window_get_geometry(gdk_window, NULL, NULL, &w, &h, NULL);\n-#endif\n-    if (size_assigned && (geometry.final_width.value != w\n-                       || geometry.final_height.value != h)) {\n-\n-        gdk_window_resize(gdk_window, geometry.final_width.value,\n-                                      geometry.final_height.value);\n-    }\n-}\n-\n@@ -1339,1 +1155,1 @@\n-        if (frame_type == TRANSPARENT) {\n+        if (frame_type == TRANSPARENT && wmanager == COMPIZ) {\n@@ -1353,1 +1169,1 @@\n-        activate_window();\n+        gdk_window_focus(gdk_window, GDK_CURRENT_TIME);\n@@ -1356,0 +1172,1 @@\n+\n@@ -1364,1 +1181,0 @@\n-        ensure_window_size();\n@@ -1372,1 +1188,0 @@\n-    ensure_window_size();\n@@ -1374,0 +1189,1 @@\n+    is_fullscreen = true;\n@@ -1381,3 +1197,0 @@\n-    \/\/JDK-8212060: Window show and then move glitch.\n-    \/\/The WindowContextBase::set_visible will take care of showing the window.\n-    \/\/The below code will only handle later request_focus.\n@@ -1385,5 +1198,1 @@\n-        \/\/ event_serial holds an event serial that will help X11 determine which window should have the focus and\n-        \/\/ prevents activeWindows on WindowStage.java to be out of order which may cause the FOCUS_DISABLED event\n-        \/\/ to bring up the wrong window (it brings up the last which will not be the real \"last\" if out of order).\n-        gtk_window_present_with_time(GTK_WINDOW(gtk_widget), event_serial);\n-        event_serial = GDK_CURRENT_TIME;\n+        gtk_window_present(GTK_WINDOW(gtk_widget));\n@@ -1398,1 +1207,1 @@\n-    gtk_window_set_title(GTK_WINDOW(gtk_widget),title);\n+    gtk_window_set_title(GTK_WINDOW(gtk_widget), title);\n@@ -1406,13 +1215,2 @@\n-    if (enabled) {\n-        if (resizable.prev) {\n-            set_window_resizable(true);\n-        }\n-    } else {\n-        if (resizable.value) {\n-            set_window_resizable(false);\n-            resizable.prev = true;\n-        } else if (resizable.request == REQUEST_RESIZABLE) {\n-            resizable.request = REQUEST_NOT_RESIZABLE;\n-            resizable.prev = true;\n-        }\n-    }\n+    is_disabled = !enabled;\n+    update_window_constraints();\n@@ -1422,2 +1220,2 @@\n-    resizable.minw = w;\n-    resizable.minh = h;\n+    resizable.minw = (w <= 0) ? 1 : w;\n+    resizable.minh = (h <= 0) ? 1 : h;\n@@ -1437,2 +1235,6 @@\n-void WindowContextTop::restack(bool restack) {\n-    gdk_window_restack(gdk_window, NULL, restack ? TRUE : FALSE);\n+void WindowContextTop::to_front() {\n+    gdk_window_raise(gdk_window);\n+}\n+\n+void WindowContextTop::to_back() {\n+    gdk_window_lower(gdk_window);\n@@ -1459,9 +1261,0 @@\n-void WindowContextTop::set_gravity(float x, float y) {\n-    int oldX = geometry_get_window_x(&geometry);\n-    int oldY = geometry_get_window_y(&geometry);\n-    geometry.gravity_x = x;\n-    geometry.gravity_y = y;\n-    geometry_set_window_x(&geometry, oldX);\n-    geometry_set_window_y(&geometry, oldY);\n-}\n-\n@@ -1532,0 +1325,31 @@\n+void WindowContextTop::notify_window_resize() {\n+    int w = geometry_get_window_width(&geometry);\n+    int h = geometry_get_window_height(&geometry);\n+\n+    mainEnv->CallVoidMethod(jwindow, jWindowNotifyResize,\n+                 com_sun_glass_events_WindowEvent_RESIZE, w, h);\n+    CHECK_JNI_EXCEPTION(mainEnv)\n+\n+    if (jview) {\n+        int cw = geometry_get_content_width(&geometry);\n+        int ch = geometry_get_content_height(&geometry);\n+\n+        mainEnv->CallVoidMethod(jview, jViewNotifyResize, cw, ch);\n+        CHECK_JNI_EXCEPTION(mainEnv)\n+    }\n+}\n+\n+void WindowContextTop::notify_window_move() {\n+    if (jwindow) {\n+        mainEnv->CallVoidMethod(jwindow, jWindowNotifyMove,\n+                                 geometry.x, geometry.y);\n+        CHECK_JNI_EXCEPTION(mainEnv)\n+\n+        if (jview) {\n+            mainEnv->CallVoidMethod(jview, jViewNotifyView,\n+                    com_sun_glass_events_ViewEvent_MOVE);\n+            CHECK_JNI_EXCEPTION(mainEnv)\n+        }\n+    }\n+}\n+\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/glass_window.cpp","additions":273,"deletions":449,"binary":false,"changes":722,"status":"modified"},{"patch":"@@ -37,0 +37,5 @@\n+enum WindowManager {\n+    COMPIZ,\n+    UNKNOWN\n+};\n+\n@@ -49,6 +54,0 @@\n-enum request_type {\n-    REQUEST_NONE,\n-    REQUEST_RESIZABLE,\n-    REQUEST_NOT_RESIZABLE\n-};\n-\n@@ -71,1 +70,1 @@\n-    refx(), refy(), gravity_x(), gravity_y(), current_width(), current_height(), extents() {}\n+    size_assigned(false), x(), y(), gravity_x(), gravity_y(), extents() {}\n@@ -84,2 +83,4 @@\n-    float refx;\n-    float refy;\n+    bool size_assigned;\n+\n+    int x;\n+    int y;\n@@ -89,8 +90,0 @@\n-    \/\/ the last width which was configured or obtained from configure\n-    \/\/ notification\n-    int current_width;\n-\n-    \/\/ the last height which was configured or obtained from configure\n-    \/\/ notification\n-    int current_height;\n-\n@@ -98,1 +91,0 @@\n-\n@@ -118,1 +110,1 @@\n-    virtual void set_bounds(int, int, bool, bool, int, int, int, int) = 0;\n+    virtual void set_bounds(int, int, bool, bool, int, int, int, int, float, float) = 0;\n@@ -134,1 +126,2 @@\n-    virtual void restack(bool) = 0;\n+    virtual void to_front() = 0;\n+    virtual void to_back() = 0;\n@@ -137,1 +130,0 @@\n-    virtual void set_gravity(float, float) = 0;\n@@ -143,1 +135,0 @@\n-    virtual void process_map() = 0;\n@@ -176,1 +167,1 @@\n-    struct _XIM{\n+    struct _XIM {\n@@ -195,0 +186,1 @@\n+    bool is_disabled;\n@@ -228,1 +220,0 @@\n-    void reparent_children(WindowContext* parent);\n@@ -240,1 +231,0 @@\n-    void process_map() {}\n@@ -272,4 +262,3 @@\n-    struct _Resizable{\/\/ we can't use set\/get gtk_window_resizable function\n-        _Resizable(): request(REQUEST_NONE), value(true), prev(false),\n-                minw(-1), minh(-1), maxw(-1), maxh(-1){}\n-        request_type request; \/\/request for future setResizable\n+    struct _Resizable {\/\/ we can't use set\/get gtk_window_resizable function\n+        _Resizable(): value(true),\n+                minw(-1), minh(-1), maxw(-1), maxh(-1) {}\n@@ -277,1 +266,0 @@\n-        bool prev; \/\/former resizable value (used in setEnabled for parents of modal window)\n@@ -281,1 +269,0 @@\n-    bool frame_extents_initialized;\n@@ -283,2 +270,0 @@\n-    bool location_assigned;\n-    bool size_assigned;\n@@ -286,11 +271,1 @@\n-\n-    struct _Size {\n-        int width, height;\n-        int client_width, client_height;\n-    } requested_bounds;\n-\n-    bool is_null_extents() { return is_null_extents(geometry.extents); }\n-\n-    bool is_null_extents(WindowFrameExtents ex) {\n-        return !ex.top && !ex.left && !ex.bottom && !ex.right;\n-    }\n+    bool is_fullscreen;\n@@ -301,2 +276,1 @@\n-    long event_serial;\n-\n+    WindowManager wmanager;\n@@ -305,1 +279,0 @@\n-    void process_map();\n@@ -307,0 +280,1 @@\n+    void process_state(GdkEventWindowState*);\n@@ -309,1 +283,1 @@\n-    void process_net_wm_property();\n+    void work_around_compiz_state();\n@@ -315,1 +289,1 @@\n-    void set_bounds(int, int, bool, bool, int, int, int, int);\n+    void set_bounds(int, int, bool, bool, int, int, int, int, float, float);\n@@ -325,1 +299,2 @@\n-    void restack(bool);\n+    void to_front();\n+    void to_back();\n@@ -327,1 +302,0 @@\n-    void set_gravity(float, float);\n@@ -339,2 +313,0 @@\n-    void process_key(GdkEventKey*);\n-    void process_mouse_button(GdkEventButton*);\n@@ -344,1 +316,0 @@\n-    bool get_frame_extents_property(int *, int *, int *, int *);\n@@ -346,2 +317,1 @@\n-    void activate_window();\n-    bool update_frame_extents();\n+    void update_frame_extents();\n@@ -350,1 +320,1 @@\n-    void window_configure(XWindowChanges *, unsigned int);\n+    bool get_frame_extents_property(int *, int *, int *, int *);\n@@ -352,1 +322,0 @@\n-    void set_window_resizable(bool);\n@@ -356,1 +325,2 @@\n-    void ensure_window_size();\n+    void notify_window_move();\n+    void notify_window_resize();\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/gtk\/glass_window.h","additions":29,"deletions":59,"binary":false,"changes":88,"status":"modified"}]}