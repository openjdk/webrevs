{"files":[{"patch":"@@ -65,0 +65,1 @@\n+        devDetails.put(\"isVsyncEnabled\", PrismSettings.isVsyncEnabled ? 1L : 0L);\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/prism\/mtl\/MTLPipeline.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+      isVsyncEnabled:(BOOL)isVsyncEnabled\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassLayer.h","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -47,0 +47,1 @@\n+      isVsyncEnabled:(BOOL)isVsyncEnabled\n@@ -57,0 +58,1 @@\n+                                                   isVsyncEnabled:isVsyncEnabled\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassLayer.m","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -41,0 +41,1 @@\n+     isVsyncEnabled:(BOOL)isVsyncEnabled\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassLayerMTL.h","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+     isVsyncEnabled:(BOOL)isVsyncEnabled\n@@ -50,1 +51,1 @@\n-    self.displaySyncEnabled = NO; \/\/ to support FPS faster than 60fps (-Djavafx.animation.fullspeed=true)\n+    self.displaySyncEnabled = isVsyncEnabled;\n@@ -88,1 +89,1 @@\n-static int nextDrawableCount = 0;\n+volatile static int nextDrawableCount = 0;\n@@ -92,27 +93,54 @@\n-    id<MTLTexture> backBufferTex = [(GlassMTLOffscreen*)self->_painterOffscreen getMTLTexture];\n-\n-    if (backBufferTex == nil) {\n-        return;\n-    }\n-\n-    int width = [self->_painterOffscreen width];\n-    int height = [self->_painterOffscreen height];\n-\n-    if (width <= 0 || height <= 0) {\n-        \/\/ NSLog(@\"Layer --------- backing texture not ready yet--- skipping blit.\");\n-        return;\n-    }\n-\n-    if (nextDrawableCount > 2) {\n-        \/\/ NSLog(@\"Layer --------- previous drawing in progress.. skipping blit to screen.\");\n-        return;\n-    }\n-\n-    @autoreleasepool {\n-        id<MTLCommandBuffer> commandBuf = [self->_blitCommandQueue commandBuffer];\n-        if (commandBuf == nil) {\n-            return;\n-        }\n-        id<CAMetalDrawable> mtlDrawable = [self nextDrawable];\n-        if (mtlDrawable == nil) {\n-            return;\n+    if ([((GlassMTLOffscreen*)self->_painterOffscreen) tryLockTexture])\n+    {\n+        @try {\n+            id<MTLTexture> backBufferTex = [(GlassMTLOffscreen*)self->_painterOffscreen getMTLTexture];\n+\n+            if (backBufferTex == nil) {\n+                return;\n+            }\n+\n+            int width = [self->_painterOffscreen width];\n+            int height = [self->_painterOffscreen height];\n+\n+            if (width <= 0 || height <= 0) {\n+                \/\/ NSLog(@\"Layer --------- backing texture not ready yet--- skipping blit.\");\n+                return;\n+            }\n+\n+            if (nextDrawableCount > 2) {\n+                \/\/ NSLog(@\"Layer --------- previous drawing in progress.. skipping blit to screen.\");\n+                return;\n+            }\n+\n+            @autoreleasepool {\n+                id<CAMetalDrawable> mtlDrawable = [self nextDrawable];\n+                if (mtlDrawable == nil) {\n+                    return;\n+                }\n+\n+                id<MTLTexture> dstTexture = mtlDrawable.texture;\n+                if (dstTexture.width != width || dstTexture.height != height) {\n+                    return;\n+                }\n+\n+                id<MTLCommandBuffer> commandBuf = [self->_blitCommandQueue commandBuffer];\n+                if (commandBuf == nil) {\n+                    return;\n+                }\n+\n+                nextDrawableCount++;\n+\n+                id <MTLBlitCommandEncoder> blitEncoder = [commandBuf blitCommandEncoder];\n+\n+                [blitEncoder copyFromTexture:backBufferTex\n+                                   toTexture:dstTexture];\n+\n+                [blitEncoder endEncoding];\n+                [commandBuf presentDrawable:mtlDrawable];\n+                [commandBuf addCompletedHandler:^(id <MTLCommandBuffer> commandBuf) {\n+                    nextDrawableCount--;\n+                }];\n+\n+                [commandBuf commit];\n+                \/\/ [commandBuf waitUntilCompleted];\n+            }\n@@ -120,9 +148,2 @@\n-\n-        nextDrawableCount++;\n-\n-        id <MTLBlitCommandEncoder> blitEncoder = [commandBuf blitCommandEncoder];\n-\n-        MTLRegion region = {{0, 0, 0}, {width, height, 1}};\n-\n-        if (backBufferTex.usage == MTLTextureUsageRenderTarget) {\n-            [blitEncoder synchronizeTexture:backBufferTex slice:0 level:0];\n+        @finally {\n+            [((GlassMTLOffscreen*)self->_painterOffscreen) unlockTexture];\n@@ -130,18 +151,0 @@\n-        [blitEncoder copyFromTexture:backBufferTex\n-                         sourceSlice:0\n-                         sourceLevel:0\n-                        sourceOrigin:MTLOriginMake(0, 0, 0)\n-                          sourceSize:MTLSizeMake(width, height, 1)\n-                           toTexture:mtlDrawable.texture\n-                    destinationSlice:0\n-                    destinationLevel:0\n-                   destinationOrigin:MTLOriginMake(0, 0, 0)];\n-\n-        [blitEncoder endEncoding];\n-        [commandBuf presentDrawable:mtlDrawable];\n-        [commandBuf addCompletedHandler:^(id <MTLCommandBuffer> commandBuf) {\n-            nextDrawableCount--;\n-        }];\n-\n-        [commandBuf commit];\n-        \/\/ [commandBuf waitUntilCompleted];\n@@ -149,0 +152,5 @@\n+    \/\/ else\n+    \/\/ {\n+    \/\/     The texture is locked, either being created\/destroyed or being encoded into BlitEncoder\n+    \/\/     hence the frame could be dropped.\n+    \/\/ }\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassLayerMTL.m","additions":64,"deletions":56,"binary":false,"changes":120,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-    id<MTLTexture> _texture;\n+    volatile id<MTLTexture> _texture;\n@@ -35,0 +35,2 @@\n+\n+    NSLock* lock;\n@@ -46,0 +48,2 @@\n+- (bool)tryLockTexture;\n+- (void)unlockTexture;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassMTLFrameBufferObject.h","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+        [lock lock];\n@@ -44,0 +45,1 @@\n+        [lock unlock];\n@@ -57,14 +59,14 @@\n-        @autoreleasepool {\n-            \/\/ Create a texture\n-            id<MTLDevice> device = MTLCreateSystemDefaultDevice();\n-\n-            MTLTextureDescriptor *texDescriptor =\n-                    [MTLTextureDescriptor texture2DDescriptorWithPixelFormat:MTLPixelFormatBGRA8Unorm\n-                                                                       width:width\n-                                                                      height:height\n-                                                                   mipmapped:false];\n-            texDescriptor.storageMode = MTLStorageModeManaged;\n-            texDescriptor.usage = MTLTextureUsageRenderTarget;\n-\n-            self->_texture = [device newTextureWithDescriptor:texDescriptor];\n-        }\n+        \/\/ Create a texture\n+        id<MTLDevice> device = MTLCreateSystemDefaultDevice();\n+\n+        MTLTextureDescriptor *texDescriptor =\n+                [MTLTextureDescriptor texture2DDescriptorWithPixelFormat:MTLPixelFormatBGRA8Unorm\n+                                                                   width:width\n+                                                                  height:height\n+                                                               mipmapped:false];\n+        texDescriptor.storageMode = MTLStorageModeManaged;\n+        texDescriptor.usage = MTLTextureUsageRenderTarget;\n+\n+        [lock lock];\n+        self->_texture = [device newTextureWithDescriptor:texDescriptor];\n+        [lock unlock];\n@@ -82,0 +84,1 @@\n+        lock = [NSLock new];\n@@ -131,0 +134,8 @@\n+- (bool)tryLockTexture {\n+    return [lock tryLock];\n+}\n+\n+- (void)unlockTexture {\n+    return [lock unlock];\n+}\n+\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassMTLFrameBufferObject.m","additions":25,"deletions":14,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -44,0 +44,2 @@\n+- (bool)tryLockTexture;\n+- (void)unlockTexture;\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassMTLOffscreen.h","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -116,0 +116,8 @@\n+- (bool)tryLockTexture {\n+    return [self->_fbo tryLockTexture];\n+}\n+\n+- (void)unlockTexture {\n+    return [self->_fbo unlockTexture];\n+}\n+\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassMTLOffscreen.m","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -177,0 +177,1 @@\n+                                      isVsyncEnabled:NO \/\/ Unused in es2, the flag is added for metal.\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassViewCGL.m","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -44,0 +44,1 @@\n+    BOOL isVsyncEnabled = YES;\n@@ -81,0 +82,10 @@\n+\n+        jobject isVsyncEnabledKey = (*env)->NewStringUTF(env, \"isVsyncEnabled\");\n+        jobject isVsyncEnabledValue = (*env)->CallObjectMethod(env, jproperties, jMapGetMethod, isVsyncEnabledKey);\n+        GLASS_CHECK_EXCEPTION(env);\n+        if (isVsyncEnabledValue != NULL)\n+        {\n+            jlong isVsyncEnabledLongValue = (*env)->CallLongMethod(env, isVsyncEnabledValue, jLongValueMethod);\n+            GLASS_CHECK_EXCEPTION(env);\n+            isVsyncEnabled = isVsyncEnabledLongValue == 1l ? YES : NO;\n+        }\n@@ -92,0 +103,1 @@\n+                                      isVsyncEnabled:isVsyncEnabled\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/mac\/GlassViewMTL.m","additions":12,"deletions":0,"binary":false,"changes":12,"status":"modified"}]}