{"files":[{"patch":"@@ -668,2 +668,1 @@\n-                ObjectProperty<StyleOrigin> whence = new SimpleObjectProperty<>(style.getOrigin());\n-                ParsedValue resolved = resolveLookups(node, cssValue, styleMap, transitionStates[0], whence, new HashSet<>());\n+                ParsedValue resolved = resolveLookups(node, cssValue, styleMap, transitionStates[0], new HashSet<>());\n@@ -1319,1 +1318,0 @@\n-            final ObjectProperty<StyleOrigin> whence,\n@@ -1350,12 +1348,0 @@\n-                    \/\/ The origin of this parsed value is the greatest of\n-                    \/\/ any of the resolved reference. If a resolved reference\n-                    \/\/ comes from an inline style, for example, then the value\n-                    \/\/ calculated from the resolved lookup should have inline\n-                    \/\/ as its origin. Otherwise, an inline style could be\n-                    \/\/ stored in shared cache.\n-                    final StyleOrigin wOrigin = whence.get();\n-                    final StyleOrigin rOrigin = resolved.getOrigin();\n-                    if (rOrigin != null && (wOrigin == null ||  wOrigin.compareTo(rOrigin) < 0)) {\n-                        whence.set(rOrigin);\n-                    }\n-\n@@ -1365,1 +1351,1 @@\n-                    ParsedValue pv = resolveLookups(styleable, resolved.getParsedValue(), styleMap, states, whence, resolves);\n+                    ParsedValue pv = resolveLookups(styleable, resolved.getParsedValue(), styleMap, states, resolves);\n@@ -1394,1 +1380,1 @@\n-                        resolveLookups(styleable, layers[l][ll], styleMap, states, whence, resolves);\n+                        resolveLookups(styleable, layers[l][ll], styleMap, states, resolves);\n@@ -1410,1 +1396,1 @@\n-                    resolveLookups(styleable, layer[l], styleMap, states, whence, resolves);\n+                    resolveLookups(styleable, layer[l], styleMap, states, resolves);\n@@ -1545,2 +1531,1 @@\n-                ObjectProperty<StyleOrigin> whence = new SimpleObjectProperty<>(style.getOrigin());\n-                resolved = resolveLookups(styleable, cssValue, styleMap, states, whence, new HashSet<>());\n+                resolved = resolveLookups(styleable, cssValue, styleMap, states, new HashSet<>());\n@@ -1638,2 +1623,1 @@\n-                final StyleOrigin origin = whence.get();\n-                return new CalculatedValue(val, origin, isRelative);\n+                return new CalculatedValue(val, style.getOrigin(), isRelative);\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/scene\/CssStyleHelper.java","additions":6,"deletions":22,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -27,0 +27,15 @@\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Base64;\n+import java.util.List;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.EnumSource;\n+\n@@ -28,1 +43,0 @@\n-import javafx.stage.Stage;\n@@ -30,1 +44,1 @@\n-import java.io.IOException;\n+\n@@ -36,0 +50,1 @@\n+import javafx.scene.layout.Background;\n@@ -39,0 +54,1 @@\n+import javafx.scene.paint.Paint;\n@@ -40,7 +56,1 @@\n-import static org.junit.Assert.assertEquals;\n-import static org.junit.Assert.assertFalse;\n-import static org.junit.Assert.assertNull;\n-import static org.junit.Assert.assertTrue;\n-import org.junit.AfterClass;\n-import org.junit.Before;\n-import org.junit.Test;\n+import javafx.stage.Stage;\n@@ -63,1 +73,1 @@\n-    @Before\n+    @BeforeEach\n@@ -72,1 +82,1 @@\n-    @AfterClass\n+    @AfterAll\n@@ -661,0 +671,86 @@\n+\n+    private static final String GRAY_STYLESHEET = \".my-pane {-fx-background-color: #808080}\";\n+    private static final String GRAY_INDIRECT_STYLESHEET = \".root {-fx-base: #808080} .my-pane {-fx-background-color: -fx-base}\";\n+    private static final String RED_STYLESHEET = \".my-pane {-fx-background-color: red}\";\n+    private static final String RED_INDIRECT_STYLESHEET = \".root {-fx-base: red} .my-pane {-fx-background-color: -fx-base}\";\n+    private static final String FX_BASE_GREEN_STYLESHEET = \".root {-fx-base: green}\";\n+    private static final String FX_BASE_GRAY_STYLESHEET = \".root {-fx-base: #808080}\";\n+\n+    \/**\n+     * All cases will lead to a neutral gray color #808080\n+     *\/\n+    enum OverrideCases {\n+        \/\/ User agent styles win when not overridden directly or indirectly:\n+        USER_AGENT(GRAY_STYLESHEET, null, null, null),\n+        INDIRECT_USER_AGENT(GRAY_INDIRECT_STYLESHEET, null, null, null),\n+\n+        \/\/ Property wins when not directly overridden by author or inline style:\n+        PROPERTY_OVERRIDES_USER_AGENT(RED_STYLESHEET, Color.web(\"#808080\"), null, null),\n+        PROPERTY_OVERRIDES_INDIRECT_USER_AGENT(RED_INDIRECT_STYLESHEET, Color.web(\"#808080\"), null, null),\n+        PROPERTY_OVERRIDES_USER_AGENT_VARIABLE_SET_IN_AUTHOR(RED_INDIRECT_STYLESHEET, Color.web(\"#808080\"), FX_BASE_GREEN_STYLESHEET, null),\n+        PROPERTY_OVERRIDES_USER_AGENT_VARIABLE_SET_INLINE(RED_INDIRECT_STYLESHEET, Color.web(\"#808080\"), null, \"-fx-base: yellow\"),\n+\n+        \/\/ Author style wins when not directly overridden by inline style:\n+        AUTHOR_OVERRIDES_USER_AGENT(RED_STYLESHEET, null, GRAY_STYLESHEET, null),\n+        AUTHOR_OVERRIDES_INDIRECT_USER_AGENT(RED_INDIRECT_STYLESHEET, null, GRAY_STYLESHEET, null),\n+        AUTHOR_OVERRIDES_PROPERTY(RED_STYLESHEET, Color.BLUE, GRAY_STYLESHEET, null),\n+        AUTHOR_OVERRIDES_USER_AGENT_VARIABLE_SET_INLINE(RED_INDIRECT_STYLESHEET, null, GRAY_STYLESHEET, \"-fx-base: yellow\"),\n+\n+        \/\/ Indirect author styles win when property is not set directly, and there is no direct or indirect override in an inline style:\n+        AUTHOR_VARIABLE_OVERRIDES_USER_AGENT_VARIABLE(RED_INDIRECT_STYLESHEET, null, FX_BASE_GRAY_STYLESHEET, null),\n+\n+        \/\/ Direct inline styles always win:\n+        INLINE_OVERRIDES_USER_AGENT(RED_STYLESHEET, null, null, \"-fx-background-color: #808080\"),\n+        INLINE_OVERRIDES_PROPERTY(RED_STYLESHEET, Color.BLUE, null, \"-fx-background-color: #808080\"),\n+        INLINE_OVERRIDES_AUTHOR(RED_STYLESHEET, null, RED_STYLESHEET, \"-fx-background-color: #808080\"),\n+\n+        \/\/ Indirect inline styles win when not directly overridden by author stylesheet or property:\n+        INLINE_VARIABLE_OVERRIDES_USER_AGENT_VARIABLE(RED_INDIRECT_STYLESHEET, null, null, \"-fx-base: #808080\"),\n+        INLINE_VARIABLE_OVERRIDES_AUTHOR_VARIABLE(RED_INDIRECT_STYLESHEET, null, FX_BASE_GREEN_STYLESHEET, \"-fx-base: #808080\");\n+\n+        private final String userAgentStylesheet;\n+        private final Color property;\n+        private final String authorStylesheet;\n+        private final String inlineStyles;\n+\n+        OverrideCases(String userAgentStylesheet, Color property, String authorStylesheet, String inlineStyles) {\n+            this.userAgentStylesheet = userAgentStylesheet;\n+            this.property = property;\n+            this.authorStylesheet = authorStylesheet;\n+            this.inlineStyles = inlineStyles;\n+        }\n+    }\n+\n+    \/*\n+     * Tests various override cases, with direct or indirect (via lookup) overrides. All cases should lead\n+     * to a neutral gray color.\n+     *\/\n+    @ParameterizedTest\n+    @EnumSource(OverrideCases.class)\n+    public void whenAllStylesAndOverridesAreAppliedShouldBeNeutralGray(OverrideCases c) throws IOException {\n+        StyleManager.getInstance().setDefaultUserAgentStylesheet(new CssParser().parse(\"userAgentStylSheet\", c.userAgentStylesheet));\n+        Pane pane = new Pane();\n+\n+        pane.getStyleClass().addAll(\"root\", \"my-pane\");\n+\n+        if (c.property != null) {\n+            pane.setBackground(Background.fill(c.property));\n+        }\n+        if (c.authorStylesheet != null) {\n+            pane.getStylesheets().add(toDataURL(c.authorStylesheet));\n+        }\n+        if (c.inlineStyles != null) {\n+            pane.setStyle(c.inlineStyles);\n+        }\n+\n+        root.getChildren().add(pane);\n+\n+        stage.show();\n+        Toolkit.getToolkit().firePulse();\n+\n+        assertEquals(Paint.valueOf(\"#808080\"), pane.getBackground().getFills().get(0).getFill());\n+    }\n+\n+    private static String toDataURL(String stylesheet) {\n+        return \"data:text\/plain;base64,\" + Base64.getEncoder().encodeToString(stylesheet.getBytes(StandardCharsets.UTF_8));\n+    }\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/javafx\/scene\/CssStyleHelperTest.java","additions":107,"deletions":11,"binary":false,"changes":118,"status":"modified"}]}