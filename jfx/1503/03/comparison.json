{"files":[{"patch":"@@ -671,2 +671,1 @@\n-                ObjectProperty<StyleOrigin> whence = new SimpleObjectProperty<>(style.getOrigin());\n-                ParsedValue resolved = resolveLookups(node, cssValue, styleMap, transitionStates[0], whence, new HashSet<>());\n+                ParsedValue resolved = resolveLookups(node, cssValue, styleMap, transitionStates[0], new HashSet<>());\n@@ -1322,1 +1321,0 @@\n-            final ObjectProperty<StyleOrigin> whence,\n@@ -1353,12 +1351,0 @@\n-                    \/\/ The origin of this parsed value is the greatest of\n-                    \/\/ any of the resolved reference. If a resolved reference\n-                    \/\/ comes from an inline style, for example, then the value\n-                    \/\/ calculated from the resolved lookup should have inline\n-                    \/\/ as its origin. Otherwise, an inline style could be\n-                    \/\/ stored in shared cache.\n-                    final StyleOrigin wOrigin = whence.get();\n-                    final StyleOrigin rOrigin = resolved.getOrigin();\n-                    if (rOrigin != null && (wOrigin == null ||  wOrigin.compareTo(rOrigin) < 0)) {\n-                        whence.set(rOrigin);\n-                    }\n-\n@@ -1368,1 +1354,1 @@\n-                    ParsedValue pv = resolveLookups(styleable, resolved.getParsedValue(), styleMap, states, whence, resolves);\n+                    ParsedValue pv = resolveLookups(styleable, resolved.getParsedValue(), styleMap, states, resolves);\n@@ -1397,1 +1383,1 @@\n-                        resolveLookups(styleable, layers[l][ll], styleMap, states, whence, resolves);\n+                        resolveLookups(styleable, layers[l][ll], styleMap, states, resolves);\n@@ -1413,1 +1399,1 @@\n-                    resolveLookups(styleable, layer[l], styleMap, states, whence, resolves);\n+                    resolveLookups(styleable, layer[l], styleMap, states, resolves);\n@@ -1548,2 +1534,1 @@\n-                ObjectProperty<StyleOrigin> whence = new SimpleObjectProperty<>(style.getOrigin());\n-                resolved = resolveLookups(styleable, cssValue, styleMap, states, whence, new HashSet<>());\n+                resolved = resolveLookups(styleable, cssValue, styleMap, states, new HashSet<>());\n@@ -1641,2 +1626,1 @@\n-                final StyleOrigin origin = whence.get();\n-                return new CalculatedValue(val, origin, isRelative);\n+                return new CalculatedValue(val, style.getOrigin(), isRelative);\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/scene\/CssStyleHelper.java","additions":6,"deletions":22,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -27,0 +27,3 @@\n+import java.io.IOException;\n+import java.nio.charset.StandardCharsets;\n+import java.util.Base64;\n@@ -30,1 +33,0 @@\n-import java.io.IOException;\n@@ -36,0 +38,1 @@\n+import javafx.scene.layout.Background;\n@@ -39,0 +42,1 @@\n+import javafx.scene.paint.Paint;\n@@ -46,0 +50,2 @@\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.EnumSource;\n@@ -660,0 +666,95 @@\n+\n+    private static final String GRAY_STYLESHEET = \".my-pane {-fx-background-color: #808080}\";\n+    private static final String GRAY_INDIRECT_STYLESHEET = \".root {-fx-base: #808080} .my-pane {-fx-background-color: -fx-base}\";\n+    private static final String RED_STYLESHEET = \".my-pane {-fx-background-color: red}\";\n+    private static final String RED_INDIRECT_STYLESHEET = \".root {-fx-base: red} .my-pane {-fx-background-color: -fx-base}\";\n+    private static final String FX_BASE_GREEN_STYLESHEET = \".root {-fx-base: green}\";\n+    private static final String FX_BASE_GRAY_STYLESHEET = \".root {-fx-base: #808080}\";\n+\n+    \/**\n+     * All cases will lead to a neutral gray color #808080.\n+     *\n+     * UA = USER_AGENT\n+     *\/\n+    enum OverrideCases {\n+        \/\/ User agent styles win when not overridden directly or indirectly:\n+        UA(GRAY_STYLESHEET, null, null, null),\n+        INDIRECT_UA(GRAY_INDIRECT_STYLESHEET, null, null, null),\n+\n+        \/\/ Property wins when not directly overridden by author or inline style:\n+        PROPERTY(null, Color.web(\"#808080\"), null, null),\n+        PROPERTY_OVERRIDES_UA(RED_STYLESHEET, Color.web(\"#808080\"), null, null),\n+        PROPERTY_OVERRIDES_INDIRECT_UA(RED_INDIRECT_STYLESHEET, Color.web(\"#808080\"), null, null),\n+\n+        \/\/ Property wins even if indirectly overridden by author or inline style (resolving of a lookup does not change priority of the user agent style)::\n+        PROPERTY_OVERRIDES_UA_VARIABLE_SET_IN_AUTHOR(RED_INDIRECT_STYLESHEET, Color.web(\"#808080\"), FX_BASE_GREEN_STYLESHEET, null),\n+        PROPERTY_OVERRIDES_UA_VARIABLE_SET_INLINE(RED_INDIRECT_STYLESHEET, Color.web(\"#808080\"), null, \"-fx-base: yellow\"),\n+\n+        \/\/ Author style wins when not directly overridden by inline style:\n+        AUTHOR_OVERRIDES_UA(RED_STYLESHEET, null, GRAY_STYLESHEET, null),\n+        AUTHOR_OVERRIDES_INDIRECT_UA(RED_INDIRECT_STYLESHEET, null, GRAY_STYLESHEET, null),\n+        AUTHOR_OVERRIDES_PROPERTY(null, Color.BLUE, GRAY_STYLESHEET, null),\n+\n+        \/\/ Author style wins even if indirectly overridden by inline style (resolving of a lookup does not change priority of the user agent style):\n+        AUTHOR_OVERRIDES_UA_VARIABLE_SET_INLINE(RED_INDIRECT_STYLESHEET, null, GRAY_STYLESHEET, \"-fx-base: yellow\"),\n+\n+        \/\/ Indirect author styles win when property is not set directly, and there is no direct or indirect override in an inline style:\n+        AUTHOR_VARIABLE_OVERRIDES_UA_VARIABLE(RED_INDIRECT_STYLESHEET, null, FX_BASE_GRAY_STYLESHEET, null),\n+\n+        \/\/ Direct inline styles always win over author styles:\n+        INLINE_OVERRIDES_UA(RED_STYLESHEET, null, null, \"-fx-background-color: #808080\"),\n+        INLINE_OVERRIDES_PROPERTY(null, Color.BLUE, null, \"-fx-background-color: #808080\"),\n+        INLINE_OVERRIDES_AUTHOR(null, null, RED_STYLESHEET, \"-fx-background-color: #808080\"),\n+        INLINE_OVERRIDES_ALL(RED_STYLESHEET, Color.BLUE, RED_STYLESHEET, \"-fx-background-color: #808080\"),\n+\n+        \/\/ Indirect inline styles win when not directly overridden by author stylesheet or property:\n+        INLINE_VARIABLE_OVERRIDES_UA_VARIABLE(RED_INDIRECT_STYLESHEET, null, null, \"-fx-base: #808080\"),\n+        INLINE_VARIABLE_OVERRIDES_AUTHOR_VARIABLE(null, null, RED_INDIRECT_STYLESHEET, \"-fx-base: #808080\"),\n+        INLINE_VARIABLE_OVERRIDES_ALL(RED_INDIRECT_STYLESHEET, null, FX_BASE_GREEN_STYLESHEET, \"-fx-base: #808080\");\n+\n+        private final String userAgentStylesheet;\n+        private final Color property;\n+        private final String authorStylesheet;\n+        private final String inlineStyles;\n+\n+        OverrideCases(String userAgentStylesheet, Color property, String authorStylesheet, String inlineStyles) {\n+            this.userAgentStylesheet = userAgentStylesheet;\n+            this.property = property;\n+            this.authorStylesheet = authorStylesheet;\n+            this.inlineStyles = inlineStyles;\n+        }\n+    }\n+\n+    \/*\n+     * Tests various override cases, with direct or indirect (via lookup) overrides. All cases should lead\n+     * to a neutral gray color.\n+     *\/\n+    @ParameterizedTest\n+    @EnumSource(OverrideCases.class)\n+    public void whenAllStylesAndOverridesAreAppliedShouldBeNeutralGray(OverrideCases c) throws IOException {\n+        StyleManager.getInstance().setDefaultUserAgentStylesheet(new CssParser().parse(\"userAgentStylSheet\", c.userAgentStylesheet));\n+        Pane pane = new Pane();\n+\n+        pane.getStyleClass().addAll(\"root\", \"my-pane\");\n+\n+        if (c.property != null) {\n+            pane.setBackground(Background.fill(c.property));\n+        }\n+        if (c.authorStylesheet != null) {\n+            pane.getStylesheets().add(toDataURL(c.authorStylesheet));\n+        }\n+        if (c.inlineStyles != null) {\n+            pane.setStyle(c.inlineStyles);\n+        }\n+\n+        root.getChildren().add(pane);\n+\n+        stage.show();\n+        Toolkit.getToolkit().firePulse();\n+\n+        assertEquals(Paint.valueOf(\"#808080\"), pane.getBackground().getFills().get(0).getFill());\n+    }\n+\n+    private static String toDataURL(String stylesheet) {\n+        return \"data:text\/plain;base64,\" + Base64.getEncoder().encodeToString(stylesheet.getBytes(StandardCharsets.UTF_8));\n+    }\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/javafx\/scene\/CssStyleHelperTest.java","additions":102,"deletions":1,"binary":false,"changes":103,"status":"modified"}]}