{"files":[{"patch":"@@ -719,26 +719,2 @@\n-        \/\/ We know that the cursor has moved from the client area to the title bar when the following two\n-        \/\/ conditions are met:\n-        \/\/   1. The window under the cursor is our own window. This allows us to disambiguate the situation\n-        \/\/      when the cursor was moved to another overlapping window that just happens to be placed over\n-        \/\/      our title bar.\n-        \/\/   2. The cursor position is still within the client area of our window. This allows us to detect\n-        \/\/      when the cursor was moved to the resize border of our window, which isn't part of the client\n-        \/\/      area and should therefore emit an EXIT event.\n-        if (::ChildWindowFromPointEx(::GetDesktopWindow(), pt, CWP_SKIPINVISIBLE) == hwnd\n-                && ::GetClientRect(hwnd, &windowRect)\n-                && ::ClientToScreen(hwnd, reinterpret_cast<POINT*>(&windowRect.left))\n-                && ::ClientToScreen(hwnd, reinterpret_cast<POINT*>(&windowRect.right))\n-                && ::PtInRect(&windowRect, pt)) { \/\/ pt is still in screen coordinates here\n-            TRACKMOUSEEVENT trackData;\n-            trackData.cbSize = sizeof(trackData);\n-            trackData.dwFlags = TME_LEAVE | TME_NONCLIENT;\n-            trackData.hwndTrack = hwnd;\n-            trackData.dwHoverTime = HOVER_DEFAULT;\n-\n-            \/\/ The cursor is now on the non-client hit-testing area of our window, and we need to enable\n-            \/\/ non-client mouse tracking to get a WM_NCMOUSELEAVE message when the cursor leaves the\n-            \/\/ non-client hit-testing area.\n-            if (::TrackMouseEvent(&trackData)) {\n-                m_bTrackingMouse = TRUE;\n-            }\n-        } else {\n+        \/\/ If the cursor is not over our window, we reset mouse tracking and emit an EXIT event.\n+        if (::ChildWindowFromPointEx(::GetDesktopWindow(), pt, CWP_SKIPINVISIBLE) != hwnd) {\n@@ -748,0 +724,33 @@\n+        } else {\n+            \/\/ If the cursor is still on our window, we need to detect whether it has moved from the client area\n+            \/\/ to the title bar, and suppress the EXIT event in this case.\n+            \/\/ Important: WM_MOUSELEAVE does not necessarily imply that the cursor physically left the client area.\n+            \/\/ In particular, during OLE drag-and-drop, Windows can disrupt the TrackMouseEvent state and deliver\n+            \/\/ WM_MOUSELEAVE even though the cursor is still over this window and still over the client area.\n+            \/\/ Therefore we query WM_NCHITTEST at the current cursor position to determine what area the cursor\n+            \/\/ is actually over. Only when the hit-test indicates a true non-client target (caption\/buttons) do\n+            \/\/ we switch tracking to TME_NONCLIENT and keep the mouse \"entered\".\n+            LRESULT ht = ::SendMessage(hwnd, WM_NCHITTEST, 0, MAKELPARAM(pt.x, pt.y));\n+\n+            \/\/ If hit testing indicates that the cursor is over our client area, we reset mouse tracking.\n+            \/\/ The hit-test return values that do not identify meaningful areas of our window are included\n+            \/\/ here, but should not happen in practice (see ChildWindowFromPointEx).\n+            if (ht == HTCLIENT || ht == HTNOWHERE || ht == HTERROR || ht == HTTRANSPARENT) {\n+                type = com_sun_glass_events_MouseEvent_EXIT;\n+                m_bTrackingMouse = FALSE;\n+                m_lastMouseMovePosition = -1;\n+            } else {\n+                \/\/ In this branch, we know that the cursor is on the non-client area of our window, and we need\n+                \/\/ to enable non-client mouse tracking to get a WM_NCMOUSELEAVE message when the cursor leaves\n+                \/\/ the non-client area.\n+                TRACKMOUSEEVENT trackData = {\n+                    sizeof(trackData),\n+                    TME_LEAVE | TME_NONCLIENT,\n+                    hwnd,\n+                    HOVER_DEFAULT\n+                };\n+\n+                if (::TrackMouseEvent(&trackData)) {\n+                    m_bTrackingMouse = TRUE;\n+                }\n+            }\n","filename":"modules\/javafx.graphics\/src\/main\/native-glass\/win\/ViewContainer.cpp","additions":35,"deletions":26,"binary":false,"changes":61,"status":"modified"}]}