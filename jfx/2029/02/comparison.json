{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,1 +29,0 @@\n-import com.sun.jfx.incubator.scene.control.richtext.util.RichUtils;\n@@ -35,0 +34,1 @@\n+    private final int limit;\n@@ -38,2 +38,4 @@\n-    public StringBuilderStyledOutput(LineEnding lineEnding) {\n-        sb = new StringBuilder(1024);\n+    public StringBuilderStyledOutput(StringBuilder sb, LineEnding lineEnding, int limit) {\n+        \/\/ TODO throw IOException on running over limit\n+        this.limit = limit;\n+        this.sb = sb;\n@@ -43,0 +45,4 @@\n+    public StringBuilderStyledOutput(LineEnding lineEnding) {\n+        this(new StringBuilder(1024), lineEnding, Integer.MAX_VALUE);\n+    }\n+\n@@ -44,1 +50,1 @@\n-    public void consume(StyledSegment seg) {\n+    public void consume(StyledSegment seg) throws IOException {\n@@ -47,1 +53,1 @@\n-            sb.append(newline);\n+            append(newline, false);\n@@ -51,1 +57,3 @@\n-            sb.append(text);\n+            \/\/ append as much text as possible\n+            \/\/ potentially risking breaking up code points and grapheme clusters\n+            append(text, true);\n@@ -56,0 +64,13 @@\n+    private void append(String text, boolean allowPartial) throws IOException {\n+        if (limit < Integer.MAX_VALUE) {\n+            int available = limit - sb.length();\n+            if (text.length() > available) {\n+                if (allowPartial) {\n+                    sb.append(text, 0, available);\n+                }\n+                throw new IOException(\"limit exceeded\");\n+            }\n+        }\n+        sb.append(text);\n+    }\n+\n","filename":"modules\/jfx.incubator.richtext\/src\/main\/java\/com\/sun\/jfx\/incubator\/scene\/control\/richtext\/StringBuilderStyledOutput.java","additions":28,"deletions":7,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -65,0 +65,1 @@\n+import com.sun.jfx.incubator.scene.control.richtext.StringBuilderStyledOutput;\n@@ -1538,30 +1539,7 @@\n-        String lineSeparator = m.getLineEnding().getText();\n-        int toCopy = limit;\n-        int index = start.index();\n-        boolean first = true;\n-        boolean all = true;\n-        while (toCopy > 0) {\n-            int beg;\n-            if (first) {\n-                first = false;\n-                beg = start.offset();\n-            } else {\n-                sb.append(lineSeparator);\n-                beg = 0;\n-            }\n-            String text = getPlainText(index);\n-            int len = Math.min(toCopy, text.length() - beg);\n-            sb.append(text, beg, beg + len);\n-            toCopy -= len;\n-            index++;\n-\n-            \/\/ did we copy all?\n-            if (toCopy == 0) {\n-                if (index < end.index()) {\n-                    all = false;\n-                } else if (index == end.index()) {\n-                    if (beg + len < end.offset()) {\n-                        all = false;\n-                    }\n-                }\n-            }\n+        LineEnding lineEnding = m.getLineEnding();\n+        StringBuilderStyledOutput out = new StringBuilderStyledOutput(sb, lineEnding, limit);\n+        try {\n+            m.export(start, end, out);\n+            return true;\n+        } catch(IOException e) {\n+            return false;\n@@ -1569,1 +1547,0 @@\n-        return all;\n","filename":"modules\/jfx.incubator.richtext\/src\/main\/java\/jfx\/incubator\/scene\/control\/richtext\/RichTextArea.java","additions":8,"deletions":31,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -215,0 +215,2 @@\n+            \/\/ always has at least one paragraph\n+            paragraphs.add(\"\");\n@@ -219,3 +221,1 @@\n-            int sz = paragraphs.size();\n-            \/\/ empty model always have one line\n-            return sz == 0 ? 1 : sz;\n+            return paragraphs.size();\n","filename":"modules\/jfx.incubator.richtext\/src\/main\/java\/jfx\/incubator\/scene\/control\/richtext\/model\/BasicTextModel.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -488,0 +488,3 @@\n+        \/\/ clamp and normalize\n+        start = clamp(start);\n+        end = clamp(end);\n@@ -490,1 +493,0 @@\n-            \/\/ make sure start < end\n","filename":"modules\/jfx.incubator.richtext\/src\/main\/java\/jfx\/incubator\/scene\/control\/richtext\/model\/StyledTextModel.java","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -44,0 +44,3 @@\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.CsvSource;\n+import org.junit.jupiter.params.provider.ValueSource;\n@@ -47,0 +50,1 @@\n+import jfx.incubator.scene.control.richtext.SelectionSegment;\n@@ -311,0 +315,59 @@\n+\n+    @ParameterizedTest\n+    @ValueSource(strings = {\n+        \"1\",\n+        \"1\\n\",\n+        \"1\\n2\",\n+        \"1\\n2\\n\"\n+    })\n+    public void setTextNewlines(String text) {\n+        control.setText(text);\n+        control.setLineEnding(LineEnding.LF);\n+\n+        String s = RichTestUtil.getText(control, TextPos.ZERO, control.getDocumentEnd());\n+        assertEquals(text, s);\n+    }\n+\n+    @ParameterizedTest\n+    @CsvSource(textBlock =\n+        \"\"\"\n+        0, 0, 0, 1, '1'\n+        0, 0, 0, 2, '11'\n+        0, 0, 0, 3, '11'\n+        0, 0, 1, 0, '11\\n'\n+        0, 0, 1, 1, '11\\n2'\n+        0, 0, 1, 3, '11\\n22'\n+        0, 0, 2, 0, '11\\n22'\n+        0, 0, 2, 222, '11\\n22'\n+        0, 1, 9, 9, '1\\n22'\n+        0, 2, 9, 9, '\\n22'\n+        0, 3, 9, 9, '\\n22'\n+        1, 0, 9, 9, '22'\n+        1, 1, 9, 9, '2'\n+        1, 2, 9, 9, ''\n+        1, 9, 9, 9, ''\n+        \"\"\"\n+    )\n+    public void getTextRanges(int startIndex, int startOffset, int endIndex, int endOffset, String expected) {\n+        control.setText(\"11\\n22\");\n+        control.setLineEnding(LineEnding.LF);\n+        TextPos start = TextPos.ofLeading(startIndex, startOffset);\n+        TextPos end = TextPos.ofLeading(endIndex, endOffset);\n+        String s = RichTestUtil.getText(control, start, end);\n+        assertEquals(expected, s);\n+    }\n+\n+    @Test\n+    public void setTextSelectAll() {\n+        String text = \"1\\n2\\n\";\n+        control.setText(text);\n+        control.setLineEnding(LineEnding.LF);\n+        assertEquals(3, control.getParagraphCount());\n+\n+        control.selectAll();\n+        SelectionSegment sel = control.getSelection();\n+        assertEquals(TextPos.ofLeading(2, 0), sel.getMax());\n+\n+        String s = RichTestUtil.getText(control, sel);\n+        assertEquals(text, s);\n+    }\n","filename":"modules\/jfx.incubator.richtext\/src\/test\/java\/test\/jfx\/incubator\/scene\/control\/richtext\/CodeAreaTest.java","additions":64,"deletions":1,"binary":false,"changes":65,"status":"modified"},{"patch":"@@ -0,0 +1,60 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package test.jfx.incubator.scene.control.richtext;\n+\n+import com.sun.jfx.incubator.scene.control.richtext.RichTextAreaHelper;\n+import jfx.incubator.scene.control.richtext.RichTextArea;\n+import jfx.incubator.scene.control.richtext.SelectionSegment;\n+import jfx.incubator.scene.control.richtext.TextPos;\n+\n+\/**\n+ * Utilities for testing RichTextArea.\n+ *\/\n+public class RichTestUtil {\n+\n+    \/**\n+     * @param r the rich text area\n+     * @param sel the selection segment\n+     * @return the plain text string for the given selection segment\n+     *\/\n+    public static String getText(RichTextArea r, SelectionSegment sel) {\n+        if (sel == null) {\n+            return null;\n+        }\n+        return getText(r, sel.getMin(), sel.getMax());\n+    }\n+\n+    \/**\n+     * @param r the rich text area\n+     * @param start the start position\n+     * @param end the end position\n+     * @return the plain text string between the given text positions\n+     *\/\n+    public static String getText(RichTextArea r, TextPos start, TextPos end) {\n+        StringBuilder sb = new StringBuilder();\n+        RichTextAreaHelper.getText(r, start, end, sb, Integer.MAX_VALUE);\n+        return sb.toString();\n+    }\n+}\n","filename":"modules\/jfx.incubator.richtext\/src\/test\/java\/test\/jfx\/incubator\/scene\/control\/richtext\/RichTestUtil.java","additions":60,"deletions":0,"binary":false,"changes":60,"status":"added"},{"patch":"@@ -40,1 +40,0 @@\n-import javafx.beans.NamedArg;\n@@ -44,1 +43,0 @@\n-import javafx.event.EventType;\n@@ -54,1 +52,0 @@\n-import javafx.scene.layout.Region;\n@@ -57,0 +54,1 @@\n+import javafx.scene.layout.Region;\n@@ -61,0 +59,3 @@\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.CsvSource;\n+import org.junit.jupiter.params.provider.ValueSource;\n@@ -1040,0 +1041,59 @@\n+\n+    @ParameterizedTest\n+    @ValueSource(strings = {\n+        \"1\",\n+        \"1\\n\",\n+        \"1\\n2\",\n+        \"1\\n2\\n\"\n+    })\n+    public void setTextNewlines(String text) {\n+        control.appendText(text);\n+        control.setLineEnding(LineEnding.LF);\n+\n+        String s = RichTestUtil.getText(control, TextPos.ZERO, control.getDocumentEnd());\n+        assertEquals(text, s);\n+    }\n+\n+    @ParameterizedTest\n+    @CsvSource(textBlock =\n+        \"\"\"\n+        0, 0, 0, 1, '1'\n+        0, 0, 0, 2, '11'\n+        0, 0, 0, 3, '11'\n+        0, 0, 1, 0, '11\\n'\n+        0, 0, 1, 1, '11\\n2'\n+        0, 0, 1, 3, '11\\n22'\n+        0, 0, 2, 0, '11\\n22'\n+        0, 0, 2, 222, '11\\n22'\n+        0, 1, 9, 9, '1\\n22'\n+        0, 2, 9, 9, '\\n22'\n+        0, 3, 9, 9, '\\n22'\n+        1, 0, 9, 9, '22'\n+        1, 1, 9, 9, '2'\n+        1, 2, 9, 9, ''\n+        1, 9, 9, 9, ''\n+        \"\"\"\n+    )\n+    public void getTextRanges(int startIndex, int startOffset, int endIndex, int endOffset, String expected) {\n+        control.appendText(\"11\\n22\");\n+        control.setLineEnding(LineEnding.LF);\n+        TextPos start = TextPos.ofLeading(startIndex, startOffset);\n+        TextPos end = TextPos.ofLeading(endIndex, endOffset);\n+        String s = RichTestUtil.getText(control, start, end);\n+        assertEquals(expected, s);\n+    }\n+\n+    @Test\n+    public void appendTextSelectAll() {\n+        String text = \"1\\n2\\n\";\n+        control.appendText(text);\n+        control.setLineEnding(LineEnding.LF);\n+        assertEquals(3, control.getParagraphCount());\n+\n+        control.selectAll();\n+        SelectionSegment sel = control.getSelection();\n+        assertEquals(TextPos.ofLeading(2, 0), sel.getMax());\n+\n+        String s = RichTestUtil.getText(control, sel);\n+        assertEquals(text, s);\n+    }\n","filename":"modules\/jfx.incubator.richtext\/src\/test\/java\/test\/jfx\/incubator\/scene\/control\/richtext\/RichTextAreaTest.java","additions":63,"deletions":3,"binary":false,"changes":66,"status":"modified"},{"patch":"@@ -0,0 +1,66 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package test.jfx.incubator.scene.control.richtext;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import java.io.IOException;\n+import org.junit.jupiter.api.Test;\n+import com.sun.jfx.incubator.scene.control.richtext.StringBuilderStyledOutput;\n+import jfx.incubator.scene.control.richtext.LineEnding;\n+import jfx.incubator.scene.control.richtext.model.StyledSegment;\n+\n+public class StringBuilderStyledOutputTest {\n+    @Test\n+    public void noLimit() throws IOException {\n+        String text = \"01234567890123456789\";\n+        StringBuilder sb = new StringBuilder();\n+        StringBuilderStyledOutput out = new StringBuilderStyledOutput(sb, LineEnding.CRLF, Integer.MAX_VALUE);\n+        out.consume(StyledSegment.of(text));\n+        assertEquals(text, sb.toString());\n+    }\n+\n+    @Test\n+    public void withLimit() {\n+        StringBuilder sb = new StringBuilder();\n+        StringBuilderStyledOutput out = new StringBuilderStyledOutput(sb, LineEnding.CRLF, 5);\n+        assertThrows(IOException.class, () -> {\n+            out.consume(StyledSegment.of(\"01234567890123456789\"));\n+        });\n+        \/\/ appends as much as possible under the limit\n+        assertEquals(\"01234\", sb.toString());\n+    }\n+\n+    @Test\n+    public void newlineWithLimit() {\n+        StringBuilder sb = new StringBuilder();\n+        StringBuilderStyledOutput out = new StringBuilderStyledOutput(sb, LineEnding.CRLF, 1);\n+        assertThrows(IOException.class, () -> {\n+            out.consume(StyledSegment.LINE_BREAK);\n+        });\n+        \/\/ appends nothing\n+        assertEquals(\"\", sb.toString());\n+    }\n+}\n","filename":"modules\/jfx.incubator.richtext\/src\/test\/java\/test\/jfx\/incubator\/scene\/control\/richtext\/StringBuilderStyledOutputTest.java","additions":66,"deletions":0,"binary":false,"changes":66,"status":"added"}]}