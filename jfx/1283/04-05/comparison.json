{"files":[{"patch":"@@ -221,1 +221,1 @@\n-    private void setMenuBindings(final Menu glassMenu, final MenuBase mb) {\n+    protected void setMenuBindings(final Menu glassMenu, final MenuBase mb) {\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/tk\/quantum\/GlassSystemMenu.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,60 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package com.sun.javafx.tk.quantum;\n+\n+import com.sun.glass.ui.Menu;\n+import com.sun.javafx.menu.MenuBase;\n+import java.lang.ref.WeakReference;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public class GlassSystemMenuShim extends GlassSystemMenu {\n+\n+    private GlassSystemMenu gsm;\n+    final ArrayList<WeakReference<Menu>> uncollectedMenus = new ArrayList<>();\n+\n+    public GlassSystemMenuShim() {\n+        super();\n+    }\n+\n+    public void setMenus(List<MenuBase> menus) {\n+        super.setMenus(menus);\n+    }\n+\n+    public void createMenuBar() {\n+        super.createMenuBar();\n+    }\n+\n+    @Override\n+    protected void setMenuBindings(final Menu glassMenu, final MenuBase mb) {\n+        super.setMenuBindings(glassMenu, mb);\n+        uncollectedMenus.add(new WeakReference(glassMenu));\n+    }\n+\n+    public List<WeakReference<Menu>> getWeakMenuReferences() {\n+        return uncollectedMenus;\n+    }\n+}\n","filename":"modules\/javafx.graphics\/src\/shims\/java\/com\/sun\/javafx\/tk\/quantum\/GlassSystemMenuShim.java","additions":60,"deletions":0,"binary":false,"changes":60,"status":"added"},{"patch":"@@ -24,0 +24,1 @@\n+--add-exports=javafx.graphics\/com.sun.javafx.menu=ALL-UNNAMED\n@@ -27,0 +28,1 @@\n+--add-exports=javafx.graphics\/com.sun.javafx.tk.quantum=ALL-UNNAMED\n","filename":"tests\/system\/src\/test\/addExports","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,255 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package test.com.sun.javafx.tk.quantum;\n+\n+import com.sun.javafx.menu.MenuBase;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import test.util.Util;\n+import test.util.memory.JMemoryBuddy;\n+import java.lang.ref.WeakReference;\n+import java.util.ArrayList;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+\n+import com.sun.javafx.tk.quantum.GlassSystemMenuShim;\n+import com.sun.javafx.scene.control.GlobalMenuAdapter;\n+import java.util.List;\n+import javafx.application.Platform;\n+import javafx.scene.control.Menu;\n+import javafx.scene.control.MenuBar;\n+import javafx.scene.control.MenuItem;\n+import javafx.scene.layout.VBox;\n+import javafx.scene.Scene;\n+import javafx.stage.Stage;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class SystemMenuBarTest {\n+    @BeforeClass\n+    public static void initFX() throws Exception {\n+        CountDownLatch startupLatch = new CountDownLatch(1);\n+        Platform.setImplicitExit(false);\n+\n+        Util.startup(startupLatch, () -> {\n+            startupLatch.countDown();\n+        });\n+    }\n+\n+    @AfterClass\n+    public static void teardownOnce() {\n+        Util.shutdown();\n+    }\n+\n+    CountDownLatch menubarLatch = new CountDownLatch(1);\n+    CountDownLatch memoryLatch = new CountDownLatch(1);\n+    CountDownLatch memoryFocusLatch = new CountDownLatch(1);\n+    AtomicBoolean failed = new AtomicBoolean(false);\n+\n+    @Test\n+    public void testFailingMenuBar() throws InterruptedException {\n+        Util.runAndWait(() -> {\n+            Thread.currentThread().setUncaughtExceptionHandler((t,e) -> {\n+                e.printStackTrace();\n+                failed.set(true);\n+            });\n+            createMenuBarStage();\n+        });\n+\n+        menubarLatch.await();\n+\n+        assertFalse(failed.get());\n+    }\n+\n+    public void createMenuBarStage() {\n+        Stage stage = new Stage();\n+        VBox root = new VBox();\n+\n+        root.getChildren().add(createFailingMenuBar());\n+\n+        Scene scene = new Scene(root);\n+        stage.setScene(scene);\n+        stage.show();\n+    }\n+\n+    public MenuBar createFailingMenuBar() {\n+        MenuBar menuBar = new MenuBar();\n+\n+        menuBar.setUseSystemMenuBar(true);\n+\n+        Menu systemMenu = new Menu(\"systemMenu\");\n+        menuBar.getMenus().add(systemMenu);\n+\n+        var newItem = new MenuItem();\n+        newItem.setVisible(false);\n+        systemMenu.getItems().add(newItem);\n+\n+        Platform.runLater(() -> {\n+            javafx.scene.control.Menu systemMenuContributions = new Menu(\"123\");\n+            systemMenu.getItems().add(systemMenuContributions);\n+            menubarLatch.countDown();\n+        });\n+\n+        return menuBar;\n+    }\n+\n+    @Test\n+    public void testMemoryLeak() throws InterruptedException {\n+        Util.runAndWait(() -> {\n+            Thread.currentThread().setUncaughtExceptionHandler((t,e) -> {\n+                e.printStackTrace();\n+                failed.set(true);\n+                memoryLatch.countDown();\n+            });\n+            createMenuBarWithItemsStage();\n+        });\n+        memoryLatch.await();\n+        assertFalse(failed.get());\n+    }\n+\n+    private void createMenuBarWithItemsStage() {\n+        final ArrayList<WeakReference<MenuItem>> uncollectedMenuItems = new ArrayList<>();\n+\n+        Stage stage = new Stage();\n+        VBox root = new VBox();\n+        final MenuBar menuBar = new MenuBar();\n+        final Menu menu = new Menu(\"MyMenu\");\n+        menuBar.getMenus().add(menu);\n+        menuBar.setUseSystemMenuBar(true);\n+        root.getChildren().add(menuBar);\n+\n+        Scene scene = new Scene(root);\n+        stage.setScene(scene);\n+        stage.show();\n+        stage.requestFocus();\n+        Thread t = new Thread() {\n+            @Override public void run() {\n+                for (int i = 0; i < 10; i++) {\n+                    try {\n+                        Thread.sleep(20);\n+                    } catch (Exception e) {\n+                        e.printStackTrace();\n+                    }\n+                    Platform.runLater(() -> {\n+                        menu.getItems().clear();\n+                        MenuItem menuItem = new MenuItem(\"MyItem\");\n+                        WeakReference<MenuItem> wr = new WeakReference<>(menuItem);\n+                        uncollectedMenuItems.add(wr);\n+                        menu.getItems().add(menuItem);\n+                    });\n+                }\n+                Platform.runLater( () -> {\n+                    int strongCount = 0;\n+                    for (WeakReference<MenuItem> wr: uncollectedMenuItems) {\n+                        if (!JMemoryBuddy.checkCollectable(wr)) strongCount++;\n+                    }\n+                    assertEquals(1, strongCount, \"Only the last menuItem should be alive\");\n+                    memoryLatch.countDown();\n+                });\n+            }\n+        };\n+        t.start();\n+    }\n+\n+    @Test\n+    public void testFocusMemoryLeak() throws InterruptedException {\n+        Util.runAndWait(() -> {\n+            Thread.currentThread().setUncaughtExceptionHandler((t,e) -> {\n+                e.printStackTrace();\n+                failed.set(true);\n+                memoryFocusLatch.countDown();\n+            });\n+            createAndRefocusMenuBarStage();\n+        });\n+        memoryFocusLatch.await();\n+        assertFalse(failed.get());\n+    }\n+\n+    public void createAndRefocusMenuBarStage() {\n+        Stage stage = new Stage();\n+        VBox root = new VBox();\n+\n+        final MenuBar menuBar = new MenuBar();\n+        final Menu menu = new Menu(\"MyMenu\");\n+        menuBar.getMenus().add(menu);\n+        menuBar.setUseSystemMenuBar(true);\n+        root.getChildren().add(menuBar);\n+\n+        Scene scene = new Scene(root);\n+        stage.setScene(scene);\n+        stage.show();\n+        final ArrayList<WeakReference<MenuBase>> uncollectedMenus = new ArrayList<>();\n+        GlassSystemMenuShim gsmh = new GlassSystemMenuShim();\n+        Menu m1 = new Menu(\"Menu\");\n+\n+        MenuBase menuBase = GlobalMenuAdapter.adapt(m1);\n+        ArrayList<MenuBase> menus = new ArrayList<>();\n+        gsmh.createMenuBar();\n+        for (int i = 0; i < 100; i++) {\n+            Platform.runLater(() -> {\n+                gsmh.setMenus(List.of(menuBase));\n+            });\n+        }\n+        Platform.runLater(() -> {\n+            int strongCount = 0;\n+            final List<WeakReference<com.sun.glass.ui.Menu>> u2 = gsmh.getWeakMenuReferences();\n+            for (WeakReference<com.sun.glass.ui.Menu> wr : u2) {\n+                if (!JMemoryBuddy.checkCollectable(wr)) {\n+                    strongCount++;\n+                    assertTrue(\"Too much refs\", strongCount < 2);\n+                }\n+            }\n+            assertEquals(1, strongCount, \"Exactly one reference should be reachable\");\n+            memoryFocusLatch.countDown();\n+        });\n+    }\n+\n+    public MenuBar createSimpleMenuBar() {\n+        MenuBar menuBar = new MenuBar();\n+\n+        menuBar.setUseSystemMenuBar(true);\n+\n+        Menu systemMenu = new Menu(\"systemMenu\");\n+        menuBar.getMenus().add(systemMenu);\n+\n+        var newItem = new MenuItem();\n+        newItem.setVisible(false);\n+        systemMenu.getItems().add(newItem);\n+\n+        Platform.runLater(() -> {\n+            javafx.scene.control.Menu systemMenuContributions = new Menu(\"123\");\n+            systemMenu.getItems().add(systemMenuContributions);\n+        });\n+\n+        return menuBar;\n+    }\n+\n+}\n","filename":"tests\/system\/src\/test\/java\/test\/com\/sun\/javafx\/tk\/quantum\/SystemMenuBarTest.java","additions":255,"deletions":0,"binary":false,"changes":255,"status":"added"},{"patch":"@@ -1,175 +0,0 @@\n-\/*\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.  Oracle designates this\n- * particular file as subject to the \"Classpath\" exception as provided\n- * by Oracle in the LICENSE file that accompanied this code.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-package test.javafx.stage;\n-\n-import org.junit.AfterClass;\n-import org.junit.BeforeClass;\n-import org.junit.Test;\n-import test.util.Util;\n-import test.util.memory.JMemoryBuddy;\n-import java.lang.ref.WeakReference;\n-import java.util.ArrayList;\n-import java.util.concurrent.CountDownLatch;\n-import java.util.concurrent.atomic.AtomicBoolean;\n-\n-import javafx.application.Platform;\n-import javafx.scene.control.MenuBar;\n-import javafx.scene.control.MenuItem;\n-import javafx.scene.control.Menu;\n-import javafx.scene.layout.VBox;\n-import javafx.scene.Scene;\n-import javafx.stage.Stage;\n-\n-import static org.junit.Assert.assertTrue;\n-import static org.junit.jupiter.api.Assertions.assertFalse;\n-import static org.junit.jupiter.api.Assertions.assertEquals;\n-\n-public class SystemMenuBarTest {\n-    @BeforeClass\n-    public static void initFX() throws Exception {\n-        CountDownLatch startupLatch = new CountDownLatch(1);\n-        Platform.setImplicitExit(false);\n-\n-        Util.startup(startupLatch, () -> {\n-            startupLatch.countDown();\n-        });\n-    }\n-\n-    @AfterClass\n-    public static void teardownOnce() {\n-        Util.shutdown();\n-    }\n-\n-    CountDownLatch menubarLatch = new CountDownLatch(1);\n-    CountDownLatch memoryLatch = new CountDownLatch(1);\n-    AtomicBoolean failed = new AtomicBoolean(false);\n-\n-    @Test\n-    public void testFailingMenuBar() throws InterruptedException {\n-        Util.runAndWait(() -> {\n-            Thread.currentThread().setUncaughtExceptionHandler((t,e) -> {\n-                e.printStackTrace();\n-                failed.set(true);\n-            });\n-            createMenuBarStage();\n-        });\n-\n-        menubarLatch.await();\n-\n-        assertFalse(failed.get());\n-    }\n-\n-    public void createMenuBarStage() {\n-        Stage stage = new Stage();\n-        VBox root = new VBox();\n-\n-        root.getChildren().add(createFailingMenuBar());\n-\n-        Scene scene = new Scene(root);\n-        stage.setScene(scene);\n-        stage.show();\n-    }\n-\n-    public MenuBar createFailingMenuBar() {\n-        MenuBar menuBar = new MenuBar();\n-\n-        menuBar.setUseSystemMenuBar(true);\n-\n-        Menu systemMenu = new Menu(\"systemMenu\");\n-        menuBar.getMenus().add(systemMenu);\n-\n-        var newItem = new MenuItem();\n-        newItem.setVisible(false);\n-        systemMenu.getItems().add(newItem);\n-\n-        Platform.runLater(() -> {\n-            javafx.scene.control.Menu systemMenuContributions = new Menu(\"123\");\n-            systemMenu.getItems().add(systemMenuContributions);\n-            menubarLatch.countDown();\n-        });\n-\n-        return menuBar;\n-    }\n-\n-    @Test\n-    public void testMemoryLeak() throws InterruptedException {\n-        Util.runAndWait(() -> {\n-            Thread.currentThread().setUncaughtExceptionHandler((t,e) -> {\n-                e.printStackTrace();\n-                failed.set(true);\n-                memoryLatch.countDown();\n-            });\n-            createMenuBarWithItemsStage();\n-        });\n-        memoryLatch.await();\n-        assertFalse(failed.get());\n-    }\n-\n-    private void createMenuBarWithItemsStage() {\n-        final ArrayList<WeakReference<MenuItem>> uncollectedMenuItems = new ArrayList<>();\n-\n-        Stage stage = new Stage();\n-        VBox root = new VBox();\n-        final MenuBar menuBar = new MenuBar();\n-        final Menu menu = new Menu(\"MyMenu\");\n-        menuBar.getMenus().add(menu);\n-        menuBar.setUseSystemMenuBar(true);\n-        root.getChildren().add(menuBar);\n-\n-        Scene scene = new Scene(root);\n-        stage.setScene(scene);\n-        stage.show();\n-        stage.requestFocus();\n-        Thread t = new Thread() {\n-            @Override public void run() {\n-                for (int i = 0; i < 10; i++) {\n-                    try {\n-                        Thread.sleep(20);\n-                    } catch (Exception e) {\n-                        e.printStackTrace();\n-                    }\n-                    Platform.runLater(() -> {\n-                        menu.getItems().clear();\n-                        MenuItem menuItem = new MenuItem(\"MyItem\");\n-                        WeakReference<MenuItem> wr = new WeakReference<>(menuItem);\n-                        uncollectedMenuItems.add(wr);\n-                        menu.getItems().add(menuItem);\n-                    });\n-                }\n-                Platform.runLater( () -> {\n-                    int strongCount = 0;\n-                    for (WeakReference<MenuItem> wr: uncollectedMenuItems) {\n-                        if (!JMemoryBuddy.checkCollectable(wr)) strongCount++;\n-                    }\n-                    assertEquals(1, strongCount, \"Only the last menuItem should be alive\");\n-                    memoryLatch.countDown();\n-                });\n-            }\n-        };\n-        t.start();\n-    }\n-\n-}\n","filename":"tests\/system\/src\/test\/java\/test\/javafx\/stage\/SystemMenuBarTest.java","additions":0,"deletions":175,"binary":false,"changes":175,"status":"deleted"}]}