{"files":[{"patch":"@@ -212,3 +212,2 @@\n-     *                     For TextFlow this value will be -1 to distinguish it from Text node.\n-     * @param curRunStart starting position of text run where hit info is requested.\n-     *                    For TextFlow this value will be -1  to distinguish it from Text node.\n+     * @param curRunStart Start position of text run where hit info is requested.\n+     * @param forTextFlow Indicates if the hit info is requested for TextFlow or Text node. True for TextFlow and False for Text node.\n@@ -217,1 +216,1 @@\n-    public Hit getHitInfo(float x, float y, String text, int textRunStart, int curRunStart);\n+    public Hit getHitInfo(float x, float y, String text, int textRunStart, int curRunStart, boolean forTextFlow);\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/scene\/text\/TextLayout.java","additions":3,"deletions":4,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -424,1 +424,1 @@\n-    public Hit getHitInfo(float x, float y, String text, int textRunStart, int curRunStart) {\n+    public Hit getHitInfo(float x, float y, String text, int textRunStart, int curRunStart, boolean forTextFlow) {\n@@ -427,1 +427,0 @@\n-        boolean isMultiRunText = false;\n@@ -441,2 +440,1 @@\n-            boolean isTextFlow = textRunStart == -1 && curRunStart == -1;\n-            if (isMirrored && (isTextFlow || spans == null)) {\n+            if (isMirrored && (forTextFlow || spans == null)) {\n@@ -451,1 +449,2 @@\n-                \/\/ To calculate Text and TextFlow hit info\n+                \/* This code branch is used to calculate hit info of Text node\n+                   which are not embedded in TextFlow and hit info requested on TextFlow. *\/\n@@ -456,1 +455,1 @@\n-                        if (x < run.getWidth() && (isTextFlow || (run.getStart() == curRunStart))) {\n+                        if (x < run.getWidth() && (forTextFlow || (run.getStart() == curRunStart))) {\n@@ -461,1 +460,3 @@\n-                            if (runs[i - 1].isLinebreak()) break;\n+                            if (runs[i - 1].isLinebreak()) {\n+                                break;\n+                            }\n@@ -472,1 +473,3 @@\n-                        if (x < run.getWidth()) break;\n+                        if (x < run.getWidth()) {\n+                            break;\n+                        }\n@@ -474,1 +477,3 @@\n-                            if (runs[i + 1].isLinebreak()) break;\n+                            if (runs[i + 1].isLinebreak()) {\n+                                break;\n+                            }\n@@ -480,1 +485,1 @@\n-                \/\/ To calculate hit info of Text embedded in TextFlow\n+                \/\/ This code branch is used to calculate hit info of Text node embedded in TextFlow.\n@@ -490,0 +495,1 @@\n+                    boolean isMultiRunText = false;\n@@ -524,1 +530,1 @@\n-                        \/\/ For only English Text embedded in TextFlow in RTL orientation\n+                        \/\/ This condition handles LTR Text nodes embedded in TextFlow in RTL mode.\n@@ -562,1 +568,4 @@\n-                    if (run.getLevel() % 2 != 0) {\n+                    if ((run.getLevel() & 0x01) != 0) {\n+                        \/* Odd level represents RTL text.\n+                        *  If the RTL text has LTR text embedded,\n+                        *  add the LTR index here to get effective character index *\/\n","filename":"modules\/javafx.graphics\/src\/main\/java\/com\/sun\/javafx\/text\/PrismTextLayout.java","additions":21,"deletions":12,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -1035,1 +1035,1 @@\n-        TextLayout.Hit h = layout.getHitInfo((float)x, (float)y, getText(), textRunStart, curRunStart);\n+        TextLayout.Hit h = layout.getHitInfo((float)x, (float)y, getText(), textRunStart, curRunStart, false);\n@@ -1040,27 +1040,14 @@\n-        int runIndex = 0;\n-        if (runs.length != 0) {\n-            if (getEffectiveNodeOrientation() == NodeOrientation.RIGHT_TO_LEFT) {\n-                double yPos = y;\n-                if (runs[runIndex].getTextSpan() == null) {\n-                    while (runIndex < runs.length - 1) {\n-                        if (x > runs[runIndex].getLocation().x && x < runs[runIndex + 1].getLocation().x\n-                                && y > runs[runIndex].getLocation().y && y < runs[runIndex].getHeight()) {\n-                            break;\n-                        }\n-                        runIndex++;\n-                        if (y > runs[runIndex].getHeight() && (runs[runIndex].getLocation().y != runs[runIndex - 1].getLocation().y)) {\n-                            y -= runs[runIndex].getHeight();\n-                        }\n-                    }\n-                } else {\n-                    double ptX = localToParent(x, y).getX();\n-                    double ptY = localToParent(x, y).getY();\n-                    while (runIndex < runs.length - 1) {\n-                        if (ptX > runs[runIndex].getLocation().x && ptX < (runs[runIndex].getLocation().x + runs[runIndex].getWidth()) && ptY >= runs[runIndex].getLocation().y\n-                                && y < runs[runIndex].getHeight()) {\n-                            break;\n-                        }\n-                        runIndex++;\n-                        if (y > runs[runIndex].getHeight() && (runs[runIndex].getLocation().y != runs[runIndex - 1].getLocation().y)) {\n-                            y -= runs[runIndex].getHeight();\n-                        }\n+        int ix = 0;\n+        int lastIndex = runs.length - 1;\n+\n+        if (runs.length == 0) {\n+            return ix;\n+        }\n+\n+        if (getEffectiveNodeOrientation() == NodeOrientation.RIGHT_TO_LEFT) {\n+            if (runs[ix].getTextSpan() == null) {\n+                while (ix < lastIndex) {\n+                    GlyphList r = runs[ix];\n+                    if (x > r.getLocation().x && x < runs[ix + 1].getLocation().x\n+                            && y > r.getLocation().y && y < r.getHeight()) {\n+                        break;\n@@ -1068,0 +1055,2 @@\n+                    ix++;\n+                    y = updateY(y, ix, runs);\n@@ -1070,0 +1059,1 @@\n+                double ptX = localToParent(x, y).getX();\n@@ -1071,2 +1061,4 @@\n-                while (runIndex < runs.length - 1) {\n-                    if (ptY > runs[runIndex].getLocation().y && ptY < runs[runIndex + 1].getLocation().y) {\n+                while (ix < lastIndex) {\n+                    GlyphList r = runs[ix];\n+                    if (ptX > r.getLocation().x && ptX < (r.getLocation().x + r.getWidth()) && ptY >= r.getLocation().y\n+                            && y < r.getHeight()) {\n@@ -1075,1 +1067,9 @@\n-                    runIndex++;\n+                    ix++;\n+                    y = updateY(y, ix, runs);\n+                }\n+            }\n+        } else {\n+            double ptY = localToParent(x, y).getY();\n+            while (ix < lastIndex) {\n+                if (ptY > runs[ix].getLocation().y && ptY < runs[ix + 1].getLocation().y) {\n+                    break;\n@@ -1077,0 +1077,1 @@\n+                ix++;\n@@ -1079,1 +1080,9 @@\n-        return runIndex;\n+        return ix;\n+    }\n+\n+    private double updateY(double y, int ix, GlyphList[] runs) {\n+        GlyphList curRun = runs[ix];\n+        if (y > curRun.getHeight() && (curRun.getLocation().y != runs[ix - 1].getLocation().y)) {\n+            y -= curRun.getHeight();\n+        }\n+        return y;\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/scene\/text\/Text.java","additions":41,"deletions":32,"binary":false,"changes":73,"status":"modified"},{"patch":"@@ -202,1 +202,1 @@\n-            TextLayout.Hit h = layout.getHitInfo((float)x, (float)y, null, -1, -1);\n+            TextLayout.Hit h = layout.getHitInfo((float)x, (float)y, null, 0, 0, true);\n","filename":"modules\/javafx.graphics\/src\/main\/java\/javafx\/scene\/text\/TextFlow.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -161,1 +161,1 @@\n-    public Hit getHitInfo(float x, float y, String text, int textRunStart, int curRunStart) {\n+    public Hit getHitInfo(float x, float y, String text, int textRunStart, int curRunStart, boolean forTextFlow) {\n","filename":"modules\/javafx.graphics\/src\/test\/java\/test\/com\/sun\/javafx\/pgstub\/StubTextLayout.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -111,1 +111,1 @@\n-    static Text textOne;\n+    static Text text;\n@@ -140,2 +140,2 @@\n-        mouseClick(textOne.getLayoutX() + x,\n-                    textOne.getLayoutY() \/ 2 + y);\n+        mouseClick(text.getLayoutX() + x,\n+                    text.getLayoutY() \/ 2 + y);\n@@ -146,3 +146,3 @@\n-            textOne.setText(\"This is text\");\n-            textOne.setFont(new Font(48));\n-            vBox.getChildren().setAll(textOne);\n+            text.setText(\"This is text\");\n+            text.setFont(new Font(48));\n+            vBox.getChildren().setAll(text);\n@@ -154,3 +154,3 @@\n-            textOne.setText(\"شسيبلاتنم\");\n-            textOne.setFont(new Font(48));\n-            vBox.getChildren().setAll(textOne);\n+            text.setText(\"شسيبلاتنم\");\n+            text.setFont(new Font(48));\n+            vBox.getChildren().setAll(text);\n@@ -162,3 +162,3 @@\n-            textOne.setText(\"Arabic:شسيبلاتنم\");\n-            textOne.setFont(new Font(48));\n-            vBox.getChildren().setAll(textOne);\n+            text.setText(\"Arabic:شسيبلاتنم\");\n+            text.setFont(new Font(48));\n+            vBox.getChildren().setAll(text);\n@@ -170,3 +170,3 @@\n-            textOne.setText(\"This is text\\nThis is text\");\n-            textOne.setFont(new Font(48));\n-            vBox.getChildren().setAll(textOne);\n+            text.setText(\"This is text\\nThis is text\");\n+            text.setFont(new Font(48));\n+            vBox.getChildren().setAll(text);\n@@ -178,3 +178,3 @@\n-            textOne.setText(\"Arabic:شسيبلاتنم\\nArabic:شسيبلاتنم\");\n-            textOne.setFont(new Font(48));\n-            vBox.getChildren().setAll(textOne);\n+            text.setText(\"Arabic:شسيبلاتنم\\nArabic:شسيبلاتنم\");\n+            text.setFont(new Font(48));\n+            vBox.getChildren().setAll(text);\n@@ -186,3 +186,3 @@\n-            textOne.setText(\"شسيبلاتنم شسيبلاتنم\\nشسيبلاتنم شسيبلاتنم\");\n-            textOne.setFont(new Font(48));\n-            vBox.getChildren().setAll(textOne);\n+            text.setText(\"شسيبلاتنم شسيبلاتنم\\nشسيبلاتنم شسيبلاتنم\");\n+            text.setFont(new Font(48));\n+            vBox.getChildren().setAll(text);\n@@ -197,1 +197,1 @@\n-        int textOneLength = textOne.getText().length();\n+        int textLength = text.getText().length();\n@@ -207,1 +207,1 @@\n-            Assertions.assertTrue(charIndex < textOneLength);\n+            Assertions.assertTrue(charIndex < textLength);\n@@ -217,1 +217,1 @@\n-        int textOneLength = textOne.getText().length();\n+        int textLength = text.getText().length();\n@@ -227,1 +227,1 @@\n-            Assertions.assertTrue(charIndex < textOneLength);\n+            Assertions.assertTrue(charIndex < textLength);\n@@ -237,1 +237,1 @@\n-        int textOneLength = textOne.getText().length();\n+        int textLength = text.getText().length();\n@@ -247,1 +247,1 @@\n-            Assertions.assertTrue(charIndex < textOneLength);\n+            Assertions.assertTrue(charIndex < textLength);\n@@ -257,1 +257,1 @@\n-        int textOneLength = textOne.getText().length();\n+        int textLength = text.getText().length();\n@@ -268,1 +268,1 @@\n-                Assertions.assertTrue(charIndex < textOneLength);\n+                Assertions.assertTrue(charIndex < textLength);\n@@ -279,1 +279,1 @@\n-        int textOneLength = textOne.getText().length();\n+        int textLength = text.getText().length();\n@@ -290,1 +290,1 @@\n-                Assertions.assertTrue(charIndex < textOneLength);\n+                Assertions.assertTrue(charIndex < textLength);\n@@ -301,1 +301,1 @@\n-        int textOneLength = textOne.getText().length();\n+        int textLength = text.getText().length();\n@@ -312,1 +312,1 @@\n-                Assertions.assertTrue(charIndex < textOneLength);\n+                Assertions.assertTrue(charIndex < textLength);\n@@ -340,1 +340,1 @@\n-            textOne.removeEventHandler(MouseEvent.MOUSE_PRESSED, this::handleTextMouseEvent);\n+            text.removeEventHandler(MouseEvent.MOUSE_PRESSED, this::handleTextMouseEvent);\n@@ -347,1 +347,1 @@\n-            textOne.addEventHandler(MouseEvent.MOUSE_PRESSED, this::handleTextMouseEvent);\n+            text.addEventHandler(MouseEvent.MOUSE_PRESSED, this::handleTextMouseEvent);\n@@ -371,1 +371,1 @@\n-            textOne = new Text();\n+            text = new Text();\n","filename":"tests\/system\/src\/test\/java\/test\/robot\/javafx\/scene\/RTLTextCharacterIndexTest.java","additions":36,"deletions":36,"binary":false,"changes":72,"status":"modified"}]}