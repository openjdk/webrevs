{"files":[{"patch":"@@ -4204,18 +4204,17 @@\n-#define FCVT_SAFE(FLOATCVT, FLOATEQ)                                                             \\\n-void MacroAssembler:: FLOATCVT##_safe(Register dst, FloatRegister src, Register tmp) {           \\\n-  Label L_Okay;                                                                                  \\\n-  fscsr(zr);                                                                                     \\\n-  FLOATCVT(dst, src);                                                                            \\\n-  frcsr(tmp);                                                                                    \\\n-  andi(tmp, tmp, 0x1E);                                                                          \\\n-  beqz(tmp, L_Okay);                                                                             \\\n-  FLOATEQ(tmp, src, src);                                                                        \\\n-  bnez(tmp, L_Okay);                                                                             \\\n-  mv(dst, zr);                                                                                   \\\n-  bind(L_Okay);                                                                                  \\\n-}\n-\n-FCVT_SAFE(fcvt_w_s, feq_s)\n-FCVT_SAFE(fcvt_l_s, feq_s)\n-FCVT_SAFE(fcvt_w_d, feq_d)\n-FCVT_SAFE(fcvt_l_d, feq_d)\n+#define FCVT_SAFE(FLOATCVT, FLOATSIG)                                                     \\\n+void MacroAssembler::FLOATCVT##_safe(Register dst, FloatRegister src, Register tmp) {     \\\n+  Label done;                                                                             \\\n+  assert_different_registers(dst, tmp);                                                   \\\n+  fclass_##FLOATSIG(tmp, src);                                                            \\\n+  mv(dst, zr);                                                                            \\\n+  \/* check if src is NaN *\/                                                               \\\n+  andi(tmp, tmp, 0b1100000000);                                                           \\\n+  bnez(tmp, done);                                                                        \\\n+  FLOATCVT(dst, src);                                                                     \\\n+  bind(done);                                                                             \\\n+}\n+\n+FCVT_SAFE(fcvt_w_s, s);\n+FCVT_SAFE(fcvt_l_s, s);\n+FCVT_SAFE(fcvt_w_d, d);\n+FCVT_SAFE(fcvt_l_d, d);\n","filename":"src\/hotspot\/cpu\/riscv\/macroAssembler_riscv.cpp","additions":17,"deletions":18,"binary":false,"changes":35,"status":"modified"}]}