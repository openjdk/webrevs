{"files":[{"patch":"@@ -53,1 +53,1 @@\n-void Assembler::addw(Register Rd, Register Rn, int64_t increment, Register temp) {\n+void Assembler::addw(Register Rd, Register Rn, int32_t increment, Register temp) {\n@@ -73,1 +73,1 @@\n-void Assembler::subw(Register Rd, Register Rn, int64_t decrement, Register temp) {\n+void Assembler::subw(Register Rd, Register Rn, int32_t decrement, Register temp) {\n@@ -120,6 +120,6 @@\n-   \/\/ Load upper 32 bits. upper = imm[63:32], but if imm[31] == 1 or\n-   \/\/ (imm[31:20] == 0x7ff && imm[19] == 1), upper = imm[63:32] + 1.\n-   int64_t lower = imm & 0xffffffff;\n-   lower -= ((lower << 44) >> 44);\n-   int64_t tmp_imm = ((uint64_t)(imm & 0xffffffff00000000)) + (uint64_t)lower;\n-   int32_t upper = (tmp_imm - (int32_t)lower) >> 32;\n+  \/\/ Load upper 32 bits. upper = imm[63:32], but if imm[31] == 1 or\n+  \/\/ (imm[31:20] == 0x7ff && imm[19] == 1), upper = imm[63:32] + 1.\n+  int64_t lower = imm & 0xffffffff;\n+  lower -= ((lower << 44) >> 44);\n+  int64_t tmp_imm = ((uint64_t)(imm & 0xffffffff00000000)) + (uint64_t)lower;\n+  int32_t upper = (tmp_imm - (int32_t)lower) >> 32;\n@@ -127,7 +127,7 @@\n-   \/\/ Load upper 32 bits\n-   int64_t up = upper, lo = upper;\n-   lo = (lo << 52) >> 52;\n-   up -= lo;\n-   up = (int32_t)up;\n-   lui(Rd, up);\n-   addi(Rd, Rd, lo);\n+  \/\/ Load upper 32 bits\n+  int64_t up = upper, lo = upper;\n+  lo = (lo << 52) >> 52;\n+  up -= lo;\n+  up = (int32_t)up;\n+  lui(Rd, up);\n+  addi(Rd, Rd, lo);\n@@ -135,9 +135,9 @@\n-   \/\/ Load the rest 32 bits.\n-   slli(Rd, Rd, 12);\n-   addi(Rd, Rd, (int32_t)lower >> 20);\n-   slli(Rd, Rd, 12);\n-   lower = ((int32_t)imm << 12) >> 20;\n-   addi(Rd, Rd, lower);\n-   slli(Rd, Rd, 8);\n-   lower = imm & 0xff;\n-   addi(Rd, Rd, lower);\n+  \/\/ Load the rest 32 bits.\n+  slli(Rd, Rd, 12);\n+  addi(Rd, Rd, (int32_t)lower >> 20);\n+  slli(Rd, Rd, 12);\n+  lower = ((int32_t)imm << 12) >> 20;\n+  addi(Rd, Rd, lower);\n+  slli(Rd, Rd, 8);\n+  lower = imm & 0xff;\n+  addi(Rd, Rd, lower);\n","filename":"src\/hotspot\/cpu\/riscv\/assembler_riscv.cpp","additions":24,"deletions":24,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -3081,1 +3081,1 @@\n-  \/\/ calculate pseudoinstruction\n+  \/\/ Computational pseudo instructions\n@@ -3083,1 +3083,2 @@\n-  void addw(Register Rd, Register Rn, int64_t increment, Register temp = t0);\n+  void addw(Register Rd, Register Rn, int32_t increment, Register temp = t0);\n+\n@@ -3085,1 +3086,1 @@\n-  void subw(Register Rd, Register Rn, int64_t decrement, Register temp = t0);\n+  void subw(Register Rd, Register Rn, int32_t decrement, Register temp = t0);\n","filename":"src\/hotspot\/cpu\/riscv\/assembler_riscv.hpp","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -350,1 +350,1 @@\n-    __ add_memory_int32(Address(t1), 1);\n+    __ incrementw(Address(t1));\n","filename":"src\/hotspot\/cpu\/riscv\/c1_CodeStubs_riscv.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -60,1 +60,1 @@\n-    __ add_memory_int32(ExternalAddress((address)&Runtime1::_generic_arraycopystub_cnt), 1);\n+    __ incrementw(ExternalAddress((address)&Runtime1::_generic_arraycopystub_cnt));\n@@ -167,1 +167,1 @@\n-    __ add_memory_int32(ExternalAddress((address)&Runtime1::_arraycopy_checkcast_cnt), 1);\n+    __ incrementw(ExternalAddress((address)&Runtime1::_arraycopy_checkcast_cnt));\n@@ -176,1 +176,1 @@\n-    __ add_memory_int32(ExternalAddress((address)&Runtime1::_arraycopy_checkcast_attempt_cnt), 1);\n+    __ incrementw(ExternalAddress((address)&Runtime1::_arraycopy_checkcast_attempt_cnt));\n@@ -327,1 +327,1 @@\n-    __ add_memory_int32(ExternalAddress(Runtime1::arraycopy_count_address(basic_type)), 1);\n+    __ incrementw(ExternalAddress(Runtime1::arraycopy_count_address(basic_type)));\n","filename":"src\/hotspot\/cpu\/riscv\/c1_LIRAssembler_arraycopy_riscv.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -1080,1 +1080,1 @@\n-    __ add_memory_int64(data_addr, DataLayout::counter_increment);\n+    __ increment(data_addr, DataLayout::counter_increment);\n@@ -1575,1 +1575,1 @@\n-          __ add_memory_int64(data_addr, DataLayout::counter_increment);\n+          __ increment(data_addr, DataLayout::counter_increment);\n@@ -1591,1 +1591,1 @@\n-          __ add_memory_int64(data_addr, DataLayout::counter_increment);\n+          __ increment(data_addr, DataLayout::counter_increment);\n@@ -1601,1 +1601,1 @@\n-      __ add_memory_int64(counter_addr, DataLayout::counter_increment);\n+      __ increment(counter_addr, DataLayout::counter_increment);\n@@ -1607,1 +1607,1 @@\n-    __ add_memory_int64(counter_addr, DataLayout::counter_increment);\n+    __ increment(counter_addr, DataLayout::counter_increment);\n","filename":"src\/hotspot\/cpu\/riscv\/c1_LIRAssembler_riscv.cpp","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -3197,1 +3197,4 @@\n-void MacroAssembler::add_memory_int64(const Address dst, int64_t imm) {\n+void MacroAssembler::increment(const Address dst, int64_t value) {\n+  assert(((dst.getMode() == Address::base_plus_offset &&\n+           is_offset_in_range(dst.offset(), 12)) || is_imm_in_range(value, 12, 0)),\n+          \"invalid value and address mode combination\");\n@@ -3199,1 +3202,1 @@\n-  assert_different_registers(adr.base(), t0);\n+  assert(!adr.uses(t0), \"invalid dst for address increment\");\n@@ -3201,1 +3204,1 @@\n-  addi(t0, t0, imm);\n+  add(t0, t0, value, t1);\n@@ -3205,1 +3208,4 @@\n-void MacroAssembler::add_memory_int32(const Address dst, int32_t imm) {\n+void MacroAssembler::incrementw(const Address dst, int32_t value) {\n+  assert(((dst.getMode() == Address::base_plus_offset &&\n+           is_offset_in_range(dst.offset(), 12)) || is_imm_in_range(value, 12, 0)),\n+          \"invalid value and address mode combination\");\n@@ -3207,1 +3213,1 @@\n-  assert_different_registers(adr.base(), t0);\n+  assert(!adr.uses(t0), \"invalid dst for address increment\");\n@@ -3209,1 +3215,23 @@\n-  addiw(t0, t0, imm);\n+  addw(t0, t0, value, t1);\n+  sw(t0, adr);\n+}\n+\n+void MacroAssembler::decrement(const Address dst, int64_t value) {\n+  assert(((dst.getMode() == Address::base_plus_offset &&\n+           is_offset_in_range(dst.offset(), 12)) || is_imm_in_range(value, 12, 0)),\n+          \"invalid value and address mode combination\");\n+  Address adr = add_memory_helper(dst);\n+  assert(!adr.uses(t0), \"invalid dst for address decrement\");\n+  ld(t0, adr);\n+  sub(t0, t0, value, t1);\n+  sd(t0, adr);\n+}\n+\n+void MacroAssembler::decrementw(const Address dst, int32_t value) {\n+  assert(((dst.getMode() == Address::base_plus_offset &&\n+           is_offset_in_range(dst.offset(), 12)) || is_imm_in_range(value, 12, 0)),\n+          \"invalid value and address mode combination\");\n+  Address adr = add_memory_helper(dst);\n+  assert(!adr.uses(t0), \"invalid dst for address decrement\");\n+  lwu(t0, adr);\n+  subw(t0, t0, value, t1);\n","filename":"src\/hotspot\/cpu\/riscv\/macroAssembler_riscv.cpp","additions":34,"deletions":6,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -656,2 +656,13 @@\n-  void add_memory_int64(const Address dst, int64_t imm);\n-  void add_memory_int32(const Address dst, int32_t imm);\n+  \/\/ Support for memory inc\/dec\n+  \/\/ n.b. increment\/decrement calls with an Address destination will\n+  \/\/ need to use a scratch register to load the value to be\n+  \/\/ incremented. increment\/decrement calls which add or subtract a\n+  \/\/ constant value other than sign-extended 12-bit immediate will need\n+  \/\/ to use a 2nd scratch register to hold the constant. so, an address\n+  \/\/ increment\/decrement may trash both t0 and t1.\n+\n+  void increment(const Address dst, int64_t value = 1);\n+  void incrementw(const Address dst, int32_t value = 1);\n+\n+  void decrement(const Address dst, int64_t value = 1);\n+  void decrementw(const Address dst, int32_t value = 1);\n","filename":"src\/hotspot\/cpu\/riscv\/macroAssembler_riscv.hpp","additions":13,"deletions":2,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -75,1 +75,1 @@\n-    __ add_memory_int64(Address(t2), 1);\n+    __ increment(Address(t2));\n@@ -166,1 +166,1 @@\n-    __ add_memory_int64(Address(x18), 1);\n+    __ increment(Address(x18));\n","filename":"src\/hotspot\/cpu\/riscv\/vtableStubs_riscv.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}