{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -491,3 +491,4 @@\n-\/\/ Select a nice fellow from the worklist to schedule next. If there is only\n-\/\/ one choice, then use it. Projections take top priority for correctness\n-\/\/ reasons - if I see a projection, then it is next.  There are a number of\n+\/\/ Select a nice fellow from the worklist to schedule next. If there is only one\n+\/\/ choice, then use it. CreateEx nodes must start their blocks and are selected\n+\/\/ eagerly. After them, projections take top priority for correctness. Next\n+\/\/ after projections are constants and CheckCastPP nodes. There are a number of\n@@ -531,5 +532,3 @@\n-    if( n->is_Proj() ||         \/\/ Projections always win\n-        n->Opcode()== Op_Con || \/\/ So does constant 'Top'\n-        iop == Op_CreateEx ||   \/\/ Create-exception must start block\n-        iop == Op_CheckCastPP\n-        ) {\n+    if (iop == Op_CreateEx) {\n+      \/\/ CreateEx must start the block (after Phi and Parm nodes which are\n+      \/\/ pre-scheduled): select it right away.\n@@ -540,0 +539,21 @@\n+    uint n_choice = 2;\n+    if (n->is_Proj()) {\n+      \/\/ Projections should follow their parents.\n+      n_choice = 5;\n+    } else if (n->Opcode() == Op_Con || iop == Op_CheckCastPP) {\n+      \/\/ Constants and CheckCastPP nodes have higher priority than the rest of\n+      \/\/ the nodes tested below.\n+      n_choice = 4;\n+    }\n+\n+    if (n_choice >= 4 && choice < n_choice) {\n+      \/\/ n is a constant, a projection, or a CheckCastPP node: record as current\n+      \/\/ winner, but keep looking for higher-priority nodes in the worklist.\n+      choice  = n_choice;\n+      \/\/ Latency and score are only used to break ties among low-priority nodes.\n+      latency = 0;\n+      score   = 0;\n+      idx     = i;\n+      continue;\n+    }\n+\n@@ -558,2 +578,0 @@\n-    uint n_choice  = 2;\n-\n@@ -1063,4 +1081,0 @@\n-      } else if (m->is_Mach() && m->as_Mach()->ideal_Opcode() == Op_CreateEx) {\n-        \/\/ Force the CreateEx to the top of the list so it's processed\n-        \/\/ first and ends up at the start of the block.\n-        worklist.insert(0, m);\n","filename":"src\/hotspot\/share\/opto\/lcm.cpp","additions":29,"deletions":15,"binary":false,"changes":44,"status":"modified"}]}