{"files":[{"patch":"@@ -81,1 +81,1 @@\n-    @Arguments({ Argument.RANDOM_EACH })\n+    @Arguments(values = { Argument.RANDOM_EACH })\n@@ -91,1 +91,1 @@\n-    @Arguments({ Argument.RANDOM_EACH })\n+    @Arguments(values = { Argument.RANDOM_EACH })\n@@ -122,1 +122,1 @@\n-    @Arguments({ Argument.RANDOM_EACH })\n+    @Arguments(values = { Argument.RANDOM_EACH })\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/TestIterativeEA.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -44,1 +44,1 @@\n-    @Arguments({Argument.MAX}) \/\/ the argument needs to be big enough to fall out of cache.\n+    @Arguments(values = {Argument.MAX}) \/\/ the argument needs to be big enough to fall out of cache.\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/TestOptimizeUnstableIf.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -43,1 +43,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n@@ -54,1 +54,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n@@ -65,1 +65,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n@@ -76,1 +76,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n@@ -87,1 +87,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n@@ -98,1 +98,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/TestRemixAddressExpressions.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -47,1 +47,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -61,1 +61,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -78,1 +78,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.BOOLEAN_TOGGLE_FIRST_TRUE})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.BOOLEAN_TOGGLE_FIRST_TRUE})\n@@ -99,1 +99,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.BOOLEAN_TOGGLE_FIRST_TRUE})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.BOOLEAN_TOGGLE_FIRST_TRUE})\n@@ -210,1 +210,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n@@ -224,1 +224,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n@@ -277,1 +277,1 @@\n-    @Arguments({Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH})\n@@ -291,1 +291,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.BOOLEAN_TOGGLE_FIRST_TRUE})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.BOOLEAN_TOGGLE_FIRST_TRUE})\n@@ -329,1 +329,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/TestShiftAndMask.java","additions":9,"deletions":9,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -46,1 +46,1 @@\n-    @Arguments({Argument.RANDOM_ONCE, Argument.RANDOM_ONCE, Argument.RANDOM_ONCE})\n+    @Arguments(values = {Argument.RANDOM_ONCE, Argument.RANDOM_ONCE, Argument.RANDOM_ONCE})\n@@ -54,1 +54,1 @@\n-    @Arguments({Argument.RANDOM_ONCE, Argument.RANDOM_ONCE, Argument.RANDOM_ONCE})\n+    @Arguments(values = {Argument.RANDOM_ONCE, Argument.RANDOM_ONCE, Argument.RANDOM_ONCE})\n@@ -62,1 +62,1 @@\n-    @Arguments({Argument.RANDOM_ONCE, Argument.RANDOM_ONCE, Argument.RANDOM_ONCE})\n+    @Arguments(values = {Argument.RANDOM_ONCE, Argument.RANDOM_ONCE, Argument.RANDOM_ONCE})\n@@ -70,1 +70,1 @@\n-    @Arguments({Argument.RANDOM_ONCE, Argument.RANDOM_ONCE, Argument.RANDOM_ONCE})\n+    @Arguments(values = {Argument.RANDOM_ONCE, Argument.RANDOM_ONCE, Argument.RANDOM_ONCE})\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/TestSpecialCasesOf_AMinusB_Plus_CMinusD_InAddIdeal.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -117,1 +117,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -132,1 +132,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -147,1 +147,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -162,1 +162,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -177,1 +177,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -192,1 +192,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -207,1 +207,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -222,1 +222,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -237,1 +237,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -254,1 +254,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -272,1 +272,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -289,1 +289,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -307,1 +307,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -325,1 +325,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -343,1 +343,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -358,1 +358,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -373,1 +373,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -388,1 +388,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -403,1 +403,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -495,1 +495,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -511,1 +511,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -526,1 +526,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -541,1 +541,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -556,1 +556,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -571,1 +571,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -586,1 +586,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -601,1 +601,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -616,1 +616,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -633,1 +633,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -651,1 +651,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -668,1 +668,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -686,1 +686,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -704,1 +704,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -722,1 +722,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -737,1 +737,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -752,1 +752,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -767,1 +767,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n@@ -782,1 +782,1 @@\n-    @Arguments({Argument.TRUE, Argument.FALSE})\n+    @Arguments(values = {Argument.TRUE, Argument.FALSE})\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/igvn\/TestIntegerMulRing.java","additions":38,"deletions":38,"binary":false,"changes":76,"status":"modified"},{"patch":"@@ -58,1 +58,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -66,1 +66,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -74,1 +74,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -83,1 +83,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -92,1 +92,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH})\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/scalarReplacement\/ScalarReplacementTests.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -30,2 +30,4 @@\n- * This annotation is used to specify well-defined {@link Argument} values for test methods (specifying {@link Test}) when\n- * used as part of a <b>base test<\/b> or <b>checked test<\/b>.\n+ * This annotation is used for test methods (see {@link Test}) to specify what values should be passed as arguments.\n+ * One can either specify the individual arguments with values (see {@link Argument}), or use\n+ * a setup method (see {@link Setup}) to define more complex arguments and\/or even set fields values.\n+ * This annotation can only be applied to a <b>normal test<\/b>.\n@@ -40,1 +42,1 @@\n-     * Get the argument value.\n+     * Get the argument values.\n@@ -42,1 +44,5 @@\n-    Argument[] value();\n+    Argument[] values() default {};\n+    \/**\n+     * Get the setup method name.\n+     *\/\n+    String setup() default \"\";\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/Arguments.java","additions":10,"deletions":4,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -37,3 +37,1 @@\n-There are three kinds of tests depending on how much control is needed over the test invocation.\n-#### Base Tests\n-The simplest form of testing provides a single `@Test` annotated method which the framework will invoke as part of the testing. The test method has no or well-defined arguments that the framework can automatically provide.\n+There are two ways a test can be written, depending on how much control is needed over the test invocation.\n@@ -41,1 +39,2 @@\n-More information on base tests with a precise definition can be found in the Javadocs of [Test](.\/Test.java). Concrete examples on how to specify a base test can be found in [BaseTestsExample](..\/..\/..\/testlibrary_tests\/ir_framework\/examples\/BaseTestExample.java).\n+#### Normal Test\n+The normal and simplest form of testing provides a single `@Test` annotated method which the framework invokes directly as part of the testing. The test method either has no arguments, or they must be specified with an `@Arguments` annotation.\n@@ -43,2 +42,1 @@\n-#### Checked Tests\n-The base tests do not provide any way of verification by user code. A checked test enables this by allowing the user to define an additional `@Check` annotated method which is invoked directly after the `@Test` annotated method. This allows the user to perform various checks about the test method including return value verification.\n+Arguments can be provided with `@Arguments(values = {...})` by providing well-specified inputs for each individual argument. Alternatively, a setup method can be chosen with `@Arguments(setup = \"setupMethodName\")`, which computes arguments and can also set fields.\n@@ -46,1 +44,13 @@\n-More information on checked tests with a precise definition can be found in the Javadocs of [Check](.\/Check.java). Concrete examples on how to specify a checked test can be found in [CheckedTestsExample](..\/..\/..\/testlibrary_tests\/ir_framework\/examples\/CheckedTestExample.java).\n+More information on normal test methods with a precise definition can be found in the Javadocs of [Test](.\/Test.java). Concrete examples on how to specify a normal test can be found in [NormalTestExample](..\/..\/..\/testlibrary_tests\/ir_framework\/examples\/NormalTestExample.java).\n+\n+##### Setup Method\n+A `@Setup` annotated method can provide custom arguments and set fields before a normal test is run. A `@Test` annotated method can additionally be annotated with `@Arguments(setup = \"setupMethodName\")` to define the dedicated `@Setup` method.\n+\n+More information on normal tests with `@Setup` methods together with a precise definition can be found in the Javadocs of [Setup](.\/Setup.java). Concrete examples on how to specify a setup method can be found in [SetupExample](..\/..\/..\/testlibrary_tests\/ir_framework\/examples\/SetupExample.java).\n+\n+##### Check Method\n+A `@Check(test = \"checkMethodName\")` annotated method is invoked directly after the `@Test` annotated method `checkMethodName()` is executed. The user can perform various checks, such as test method return value and field value verification.\n+\n+More information on check methods with a precise definition can be found in the Javadocs of [Check](.\/Check.java). Concrete examples on how to specify check methods can be found in [CheckedTestExample](..\/..\/..\/testlibrary_tests\/ir_framework\/examples\/CheckedTestExample.java).\n+\n+Note: `@Setup` and `@Check` methods can only be specified for normal but not for custom run tests (see next section).\n@@ -49,1 +59,1 @@\n-Neither the base nor the checked tests provide any control over how a `@Test` annotated method is invoked in terms of customized argument values and\/or conditions for the invocation itself. A custom run test gives full control over the invocation of the `@Test` annotated method to the user. The framework calls a dedicated `@Run` annotated method from which the user can invoke the `@Test` method according to his\/her needs.\n+A custom run test gives full control over the invocation of the `@Test` annotated method to the user which includes argument and field setup as well as result and field value verification. The framework calls a dedicated `@Run` annotated method from which the user can invoke the `@Test` method according to their needs.\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/README.md","additions":18,"deletions":8,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -0,0 +1,45 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package compiler.lib.ir_framework;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+\n+\/**\n+ * This annotation is used to identify Setup methods. These can be used to compute arbitrary arguments for a test\n+ * method (see {@link Test}), as well as to set field values. A test method can use a setup method, by specifying\n+ * it in a {@link Arguments} annotation. A setup method can optionally take a {@link SetupInfo} as an argument. The\n+ * arguments for the test methods are returned as a new object array.\n+ *\n+ * Examples on how to use test methods can be found in {@link ir_framework.examples.SetupExample} and also as part of the\n+ * internal testing in the package {@link ir_framework.tests}.\n+ *\n+ * @see Arguments\n+ * @see Setup\n+ * @see SetupInfo\n+ * @see Test\n+ *\/\n+@Retention(RetentionPolicy.RUNTIME)\n+public @interface Setup {\n+}\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/Setup.java","additions":45,"deletions":0,"binary":false,"changes":45,"status":"added"},{"patch":"@@ -0,0 +1,41 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package compiler.lib.ir_framework;\n+\n+\/**\n+ * Info optionally passed to {@link Setup} annotated methods.\n+ *\n+ * @see Setup\n+ *\/\n+public record SetupInfo(int invocationCounter) {\n+\n+    \/**\n+     * Get the invocation counter, which increments with every invocation of the setup method. It allows the creation\n+     * of deterministically different inputs to the test method for every invocation.\n+     *\/\n+    @Override\n+    public int invocationCounter() {\n+        return invocationCounter;\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/SetupInfo.java","additions":41,"deletions":0,"binary":false,"changes":41,"status":"added"},{"patch":"@@ -74,1 +74,1 @@\n- * Examples on how to write base tests can be found in {@link ir_framework.examples.BaseTestExample}\n+ * Examples on how to write base tests can be found in {@link ir_framework.examples.NormalTestExample}\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/Test.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -97,1 +97,0 @@\n-        onStart();\n@@ -107,4 +106,0 @@\n-    protected void onStart() {\n-        \/\/ Do nothing by default.\n-    }\n-\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/test\/AbstractTest.java","additions":0,"deletions":5,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -71,1 +71,1 @@\n-     * Return all arguments for the @Arguments annotation.\n+     * From the @Arguments(value = {...}) annotation, determine the list of ArgumentValues for a specific test method m.\n@@ -74,0 +74,1 @@\n+     * @param values The argument values specified in the annotation.\n@@ -77,6 +78,1 @@\n-    public static ArgumentValue[] getArguments(Method m) {\n-        Arguments argumentsAnno = m.getAnnotation(Arguments.class);\n-        if (argumentsAnno == null) {\n-            return null;\n-        }\n-        Argument[] values = argumentsAnno.value();\n+    public static ArgumentValue[] getArgumentValues(Method m, Argument[] values) {\n@@ -253,1 +249,1 @@\n-    public Object getArgument() {\n+    public Object getValue() {\n@@ -325,1 +321,1 @@\n-    public Object getArgument() {\n+    public Object getValue() {\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/test\/ArgumentValue.java","additions":5,"deletions":9,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -0,0 +1,140 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package compiler.lib.ir_framework.test;\n+\n+import compiler.lib.ir_framework.shared.TestFormat;\n+import compiler.lib.ir_framework.shared.TestRunException;\n+import compiler.lib.ir_framework.Argument;\n+import compiler.lib.ir_framework.Arguments;\n+import compiler.lib.ir_framework.SetupInfo;\n+\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Modifier;\n+import java.util.HashMap;\n+import java.util.Arrays;\n+\n+\/**\n+ * This interface provides arguments (and can set fields) for a test method. Different implementations are chosen\n+ * based on the @Arguments annotation for the @Test method.\n+ *\/\n+interface ArgumentsProvider {\n+    \/**\n+     * Compute arguments (and possibly set fields) for a test method.\n+     *\n+     * @param invocationTarget object on which the test method is called, or null if the test method is static.\n+     * @param invocationCounter is incremented for every set of arguments to be provided for the test method.\n+     *                          It can be used to create deterministic inputs, that vary between different\n+     *                          invocations of the test method.\n+     * @return Returns the arguments to be passed into the test method.\n+     *\/\n+    Object[] getArguments(Object invocationTarget, int invocationCounter);\n+\n+}\n+\n+\/**\n+ * For a test method, determine what ArgumentsProvider is to be constructed, given its @Arguments annotation,\n+ * and the available setup methods.\n+ *\/\n+class ArgumentsProviderBuilder {\n+   public static ArgumentsProvider build(Method method,\n+                                         HashMap<String, Method> setupMethodMap) {\n+        Arguments argumentsAnnotation = method.getAnnotation(Arguments.class);\n+        if (argumentsAnnotation == null) {\n+            return new DefaultArgumentsProvider();\n+        }\n+\n+        Argument[] values = argumentsAnnotation.values();\n+        String setupMethodName = argumentsAnnotation.setup();\n+\n+        if (!setupMethodName.isEmpty()) {\n+            TestFormat.check(values.length == 0,\n+                             \"@Arguments: Can only specify \\\"setup\\\" or \\\"values\\\" but not both in \" + method);\n+            TestFormat.check(setupMethodMap.containsKey(setupMethodName),\n+                             \"@Arguments setup: did not find \" + setupMethodName +\n+                             \" for \" + method);\n+            Method setupMethod = setupMethodMap.get(setupMethodName);\n+            return new SetupArgumentsProvider(setupMethod);\n+        } else {\n+            TestFormat.check(values.length > 0,\n+                             \"@Arguments: Empty annotation not allowed. Either specify \\\"values\\\" or \\\"setup\\\" in \" + method);\n+            ArgumentValue[] argumentValues = ArgumentValue.getArgumentValues(method, values);\n+            return new ValueArgumentsProvider(argumentValues);\n+        }\n+    }\n+}\n+\n+\/**\n+ * Default: when no @Arguments annotation is provided (including for custom run tests).\n+ *\/\n+final class DefaultArgumentsProvider implements ArgumentsProvider {\n+    @Override\n+    public Object[] getArguments(Object invocationTarget, int invocationCounter) {\n+        return new Object[]{};\n+    }\n+}\n+\n+\/**\n+ * Used for @Arguments(values = {...}) to specify individual arguments directly.\n+ *\/\n+final class ValueArgumentsProvider implements ArgumentsProvider {\n+    ArgumentValue[] argumentValues;\n+\n+    ValueArgumentsProvider(ArgumentValue[] argumentValues) {\n+        this.argumentValues = argumentValues;\n+    }\n+\n+    @Override\n+    public Object[] getArguments(Object invocationTarget, int invocationCounter) {\n+        return Arrays.stream(argumentValues).map(v -> v.getValue()).toArray();\n+    }\n+}\n+\n+\/**\n+ * Used for @Arguments(setup = \"setupMethodName\") to specify a setup method to provide arguments\n+ * and possibly set fields.\n+ *\/\n+final class SetupArgumentsProvider implements ArgumentsProvider {\n+    Method setupMethod;\n+\n+    SetupArgumentsProvider(Method setupMethod) {\n+        this.setupMethod = setupMethod;\n+    }\n+\n+    @Override\n+    public Object[] getArguments(Object invocationTarget, int invocationCounter) {\n+        Object target = Modifier.isStatic(setupMethod.getModifiers()) ? null\n+                                                                      : invocationTarget;\n+        try {\n+            if (setupMethod.getParameterCount() == 1) {\n+                return (Object[]) setupMethod.invoke(target, new SetupInfo(invocationCounter));\n+            } else {\n+                return (Object[]) setupMethod.invoke(target);\n+            }\n+        } catch (Exception e) {\n+            throw new TestRunException(\"There was an error while invoking setup method \" +\n+                                       setupMethod + \" on \" + target, e);\n+        }\n+    }\n+}\n+\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/test\/ArgumentsProvider.java","additions":140,"deletions":0,"binary":false,"changes":140,"status":"added"},{"patch":"@@ -41,0 +41,1 @@\n+    private int invocationCounter;\n@@ -50,0 +51,1 @@\n+        this.invocationCounter = 0;\n@@ -62,5 +64,0 @@\n-    @Override\n-    protected void onStart() {\n-        test.printFixedRandomArguments();\n-    }\n-\n@@ -77,0 +74,3 @@\n+    \/**\n+     * Compute arguments (and possibly set fields), and invoke the test method.\n+     *\/\n@@ -78,0 +78,1 @@\n+        Object[] arguments = test.getArguments(invocationTarget, invocationCounter++);\n@@ -79,5 +80,1 @@\n-            if (test.hasArguments()) {\n-                return testMethod.invoke(invocationTarget, test.getArguments());\n-            } else {\n-                return testMethod.invoke(invocationTarget);\n-            }\n+            return testMethod.invoke(invocationTarget, arguments);\n@@ -85,2 +82,4 @@\n-            throw new TestRunException(\"There was an error while invoking @Test method \" + testMethod\n-                                       + \". Used arguments: \" + test.getArgumentsString(), e);\n+            throw new TestRunException(\"There was an error while invoking @Test method \" + testMethod +\n+                                       \". Target: \" + invocationTarget +\n+                                       \". Arguments: \" + test.formatArguments(arguments),\n+                                       e);\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/test\/BaseTest.java","additions":11,"deletions":12,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -30,1 +30,0 @@\n-import java.util.Arrays;\n@@ -37,1 +36,1 @@\n-    private final ArgumentValue[] arguments;\n+    private final ArgumentsProvider argumentsProvider;\n@@ -42,1 +41,1 @@\n-    public DeclaredTest(Method testMethod, ArgumentValue[] arguments, CompLevel compLevel, int warmupIterations) {\n+    public DeclaredTest(Method testMethod, ArgumentsProvider argumentsProvider, CompLevel compLevel, int warmupIterations) {\n@@ -47,1 +46,1 @@\n-        this.arguments = arguments;\n+        this.argumentsProvider = argumentsProvider;\n@@ -64,6 +63,2 @@\n-    public boolean hasArguments() {\n-        return arguments != null;\n-    }\n-\n-    public Object[] getArguments() {\n-        return Arrays.stream(arguments).map(ArgumentValue::getArgument).toArray();\n+    public Object[] getArguments(Object invocationTarget, int invocationCounter) {\n+        return argumentsProvider.getArguments(invocationTarget, invocationCounter);\n@@ -80,21 +75,6 @@\n-    public void printFixedRandomArguments() {\n-        if (hasArguments()) {\n-            boolean hasRandomArgs = false;\n-            StringBuilder builder = new StringBuilder(\"Fixed random arguments for method \").append(testMethod).append(\": \");\n-            for (int i = 0; i < arguments.length; i++) {\n-                ArgumentValue argument = arguments[i];\n-                if (argument.isFixedRandom()) {\n-                    hasRandomArgs = true;\n-                    Object argumentVal = argument.getArgument();\n-                    builder.append(\"arg \").append(i).append(\": \").append(argumentVal.toString());\n-                    if (argumentVal instanceof Character) {\n-                        builder.append(\" (\").append((int)(Character)argumentVal).append(\")\");\n-                    }\n-                    builder.append(\", \");\n-                }\n-            }\n-            if (hasRandomArgs) {\n-                \/\/ Drop the last comma and space.\n-                builder.setLength(builder.length() - 2);\n-                System.out.println(builder.toString());\n-            }\n+    \/**\n+     * Format an array of arguments to string for error reporting.\n+     *\/\n+    public String formatArguments(Object[] arguments) {\n+        if (arguments == null) {\n+            return \"<null>\";\n@@ -102,11 +82,1 @@\n-    }\n-\n-    public String getArgumentsString() {\n-        if (hasArguments()) {\n-            StringBuilder builder = new StringBuilder();\n-            for (int i = 0; i < arguments.length; i++) {\n-                builder.append(\"arg \").append(i).append(\": \").append(arguments[i].getArgument()).append(\", \");\n-            }\n-            builder.setLength(builder.length() - 2);\n-            return builder.toString();\n-        } else {\n+        if (arguments.length == 0) {\n@@ -115,0 +85,6 @@\n+        StringBuilder builder = new StringBuilder();\n+        for (int i = 0; i < arguments.length; i++) {\n+            builder.append(\"arg \").append(i).append(\": \").append(arguments[i]).append(\", \");\n+        }\n+        builder.setLength(builder.length() - 2);\n+        return builder.toString();\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/test\/DeclaredTest.java","additions":18,"deletions":42,"binary":false,"changes":60,"status":"modified"},{"patch":"@@ -110,0 +110,1 @@\n+    private final HashMap<String, Method> setupMethodMap = new HashMap<>();\n@@ -228,0 +229,2 @@\n+            TestFormat.checkNoThrow(getAnnotation(m, Setup.class) == null,\n+                                    \"Cannot use @Setup annotation in \" + clazzType + \" \" + c + \" at \" + m);\n@@ -259,0 +262,5 @@\n+\n+        \/\/ Collect the @Setup methods so we can reference them\n+        \/\/ from the test methods\n+        collectSetupMethods();\n+\n@@ -498,0 +506,29 @@\n+\n+    \/**\n+     *  Collect all @Setup annotated methods and add them to setupMethodMap, for convenience to reference later from\n+     *  tests with @Arguments(setup = \"setupMethodName\").\n+     *\/\n+    private void collectSetupMethods() {\n+        for (Method m : testClass.getDeclaredMethods()) {\n+            Setup setupAnnotation = getAnnotation(m, Setup.class);\n+            if (setupAnnotation != null) {\n+                addSetupMethod(m);\n+            }\n+        }\n+    }\n+\n+    private void addSetupMethod(Method m) {\n+        TestFormat.checkNoThrow(getAnnotation(m, Test.class) == null,\n+                                \"@Setup method cannot have @Test annotation: \" + m);\n+        TestFormat.checkNoThrow(getAnnotation(m, Check.class) == null,\n+                                \"@Setup method cannot have @Check annotation: \" + m);\n+        TestFormat.checkNoThrow(getAnnotation(m, Arguments.class) == null,\n+                                \"@Setup method cannot have @Arguments annotation: \" + m);\n+        TestFormat.checkNoThrow(getAnnotation(m, Run.class) == null,\n+                                \"@Setup method cannot have @Run annotation: \" + m);\n+        Method mOverloaded = setupMethodMap.put(m.getName(), m);\n+        TestFormat.checkNoThrow(mOverloaded == null,\n+                                \"@Setup method cannot be overloaded: \" + mOverloaded + \" with \" + m);\n+        m.setAccessible(true);\n+    }\n+\n@@ -543,1 +580,2 @@\n-        DeclaredTest test = new DeclaredTest(m, ArgumentValue.getArguments(m), compLevel, warmupIterations);\n+        ArgumentsProvider argumentsProvider = ArgumentsProviderBuilder.build(m, setupMethodMap);\n+        DeclaredTest test = new DeclaredTest(m, argumentsProvider, compLevel, warmupIterations);\n@@ -732,1 +770,2 @@\n-        TestFormat.check(!test.hasArguments(),\n+        Arguments argumentsAnno = getAnnotation(testMethod, Arguments.class);\n+        TestFormat.check(argumentsAnno == null,\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/test\/TestVM.java","additions":41,"deletions":2,"binary":false,"changes":43,"status":"modified"},{"patch":"@@ -77,1 +77,1 @@\n-    @Arguments(Argument.DEFAULT) \/\/ As with normal tests, you need to tell the framework what the argument is.\n+    @Arguments(values = Argument.DEFAULT) \/\/ As with normal tests, you need to tell the framework what the argument is.\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/examples\/CheckedTestExample.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n- * @run driver ir_framework.examples.BaseTestExample\n+ * @run driver ir_framework.examples.NormalTestExample\n@@ -61,1 +61,1 @@\n-public class BaseTestExample {\n+public class NormalTestExample {\n@@ -65,1 +65,1 @@\n-        TestFramework.run(); \/\/ equivalent to TestFramework.run(BaseTestExample.class)\n+        TestFramework.run(); \/\/ equivalent to TestFramework.run(NormalTestExample.class)\n@@ -77,1 +77,1 @@\n-    @Arguments({Argument.DEFAULT, Argument.MAX})\n+    @Arguments(values = {Argument.DEFAULT, Argument.MAX})\n@@ -84,1 +84,1 @@\n-    @Arguments({Argument.DEFAULT, Argument.MAX})\n+    @Arguments(values = {Argument.DEFAULT, Argument.MAX})\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/examples\/NormalTestExample.java","additions":5,"deletions":5,"binary":false,"changes":10,"previous_filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/examples\/BaseTestExample.java","status":"renamed"},{"patch":"@@ -0,0 +1,162 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package ir_framework.examples;\n+\n+import compiler.lib.ir_framework.*;\n+import compiler.lib.ir_framework.SetupInfo;\n+\n+import jdk.test.lib.Utils;\n+import java.util.Random;\n+\n+\/*\n+ * @test\n+ * @summary Example test to use setup method (provide arguments and set fields).\n+ * @library \/test\/lib \/\n+ * @run driver ir_framework.examples.SetupExample\n+ *\/\n+\n+\/**\n+ * This file shows some examples of how to use a setup method, annotated with {@link Setup}, and referenced by\n+ * a test method with @Arguments(setup = \"setupMethodName\").\n+ *\n+ * @see Setup\n+ * @see Arguments\n+ * @see Test\n+ *\/\n+public class SetupExample {\n+    private static final Random RANDOM = Utils.getRandomInstance();\n+\n+    int iFld1, iFld2;\n+\n+    public static void main(String[] args) {\n+        TestFramework.run();\n+    }\n+\n+    \/\/ ----------------- Random but Linked --------------\n+    @Setup\n+    static Object[] setupLinkedII() {\n+        int r = RANDOM.nextInt();\n+        return new Object[]{ r, r + 42 };\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupLinkedII\")\n+    static int testSetupLinkedII(int a, int b) {\n+        return b - a;\n+    }\n+\n+    @Check(test = \"testSetupLinkedII\")\n+    static void checkSetupLinkedII(int res) {\n+        if (res != 42) {\n+            throw new RuntimeException(\"wrong result \" + res);\n+        }\n+    }\n+\n+    \/\/ ----------------- Random Arrays --------------\n+    static int[] generateI(int len) {\n+        int[] a = new int[len];\n+        for (int i = 0; i < len; i++) {\n+            a[i] = RANDOM.nextInt();\n+        }\n+        return a;\n+    }\n+\n+    @Setup\n+    static Object[] setupRandomArrayII() {\n+        \/\/ Random length, so that AutoVectorization pre\/main\/post and drain loops are tested\n+        int len = RANDOM.nextInt(20_000);\n+        int[] a = generateI(len);\n+        int[] b = generateI(len);\n+        return new Object[] { a, b };\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupRandomArrayII\")\n+    static Object[] testAdd(int[] a, int[] b) {\n+        int[] c = new int[a.length];\n+        for (int i = 0; i < a.length; i++) {\n+            c[i] = a[i] + b[i];\n+        }\n+        return new Object[] { a, b, c };\n+    }\n+\n+    @Check(test = \"testAdd\")\n+    static void checkAdd(Object[] res) {\n+        int[] a = (int[])res[0];\n+        int[] b = (int[])res[1];\n+        int[] c = (int[])res[2];\n+        for (int i = 0; i < a.length; i++) {\n+            if (c[i] != a[i] + b[i]) {\n+                throw new RuntimeException(\"wrong values: \" + a[i] + \" \" + b[i] + \" \" + c[i]);\n+            }\n+        }\n+    }\n+\n+    \/\/ ----------------- Setup Fields ---------------\n+    @Setup\n+    void setupFields() {\n+        int r = RANDOM.nextInt();\n+        iFld1 = r;\n+        iFld2 = r + 42;\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupFields\")\n+    int testSetupFields() {\n+        return iFld2 - iFld1;\n+    }\n+\n+    @Check(test = \"testSetupFields\")\n+    static void checkSetupFields(int res) {\n+        if (res != 42) {\n+            throw new RuntimeException(\"wrong result \" + res);\n+        }\n+    }\n+\n+    \/\/ ----------------- Deterministic Values -------\n+    @Setup\n+    Object[] setupDeterministic(SetupInfo info) {\n+        \/\/ This value increments with every invocation of the setup method: 0, 1, 2, ...\n+        int cnt = info.invocationCounter();\n+\n+        \/\/ Return true with low frequency. If we did this randomly, we can get unlucky\n+        \/\/ and never return true. So doing it deterministically can be helpful when we\n+        \/\/ want \"low frequency\" but a guaranteed \"true\" at some point.\n+        return new Object[]{ cnt % 1_000 };\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupDeterministic\")\n+    @IR(counts = {IRNode.STORE_OF_FIELD, \"iFld1\", \"1\",\n+                  IRNode.STORE_OF_FIELD, \"iFld2\", \"1\"})\n+    void testLowProbabilityBranchDeterministic(int x) {\n+        if (x == 7) {\n+            \/\/ unlikely branch -> guaranteed taken -> in profile -> not trapped -> in IR\n+            iFld1 = 42;\n+        } else {\n+            \/\/ likely branch\n+            iFld2 = 77;\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/examples\/SetupExample.java","additions":162,"deletions":0,"binary":false,"changes":162,"status":"added"},{"patch":"@@ -48,1 +48,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/tests\/TestAccessModifiers.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -59,0 +59,1 @@\n+        expectTestFormatException(BadSetupTest.class);\n@@ -208,1 +209,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -212,1 +213,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -216,1 +217,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -220,1 +221,1 @@\n-    @Arguments(Argument.NUMBER_MINUS_42)\n+    @Arguments(values = Argument.NUMBER_MINUS_42)\n@@ -224,1 +225,1 @@\n-    @Arguments(Argument.TRUE)\n+    @Arguments(values = Argument.TRUE)\n@@ -228,1 +229,1 @@\n-    @Arguments(Argument.FALSE)\n+    @Arguments(values = Argument.FALSE)\n@@ -232,1 +233,1 @@\n-    @Arguments(Argument.BOOLEAN_TOGGLE_FIRST_TRUE)\n+    @Arguments(values = Argument.BOOLEAN_TOGGLE_FIRST_TRUE)\n@@ -236,1 +237,1 @@\n-    @Arguments(Argument.BOOLEAN_TOGGLE_FIRST_FALSE)\n+    @Arguments(values = Argument.BOOLEAN_TOGGLE_FIRST_FALSE)\n@@ -240,1 +241,1 @@\n-    @Arguments({Argument.BOOLEAN_TOGGLE_FIRST_FALSE, Argument.TRUE})\n+    @Arguments(values = {Argument.BOOLEAN_TOGGLE_FIRST_FALSE, Argument.TRUE})\n@@ -245,1 +246,1 @@\n-    @Arguments({Argument.BOOLEAN_TOGGLE_FIRST_FALSE, Argument.NUMBER_42})\n+    @Arguments(values = {Argument.BOOLEAN_TOGGLE_FIRST_FALSE, Argument.NUMBER_42})\n@@ -250,1 +251,1 @@\n-    @Arguments({Argument.MIN, Argument.MAX})\n+    @Arguments(values = {Argument.MIN, Argument.MAX})\n@@ -254,1 +255,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -258,1 +259,1 @@\n-    @Arguments(Argument.TRUE)\n+    @Arguments(values = Argument.TRUE)\n@@ -268,1 +269,1 @@\n-    @Arguments(Argument.TRUE)\n+    @Arguments(values = Argument.TRUE)\n@@ -285,1 +286,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -289,1 +290,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -491,1 +492,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -498,1 +499,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -505,1 +506,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -534,1 +535,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -581,1 +582,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -626,0 +627,68 @@\n+class BadSetupTest {\n+    \/\/ ----------- Bad Combinations of Annotations -----------------\n+    @Setup\n+    @Test\n+    public Object[] badSetupTestAnnotation() {\n+      return new Object[]{1, 2, 3};\n+    }\n+\n+    @NoFail\n+    @Test\n+    public void testForBadSetupCheckAnnotation() {}\n+\n+    @Setup\n+    @Check(test = \"testForBadSetupCheckAnnotation\")\n+    public void badSetupCheckAnnotation() {}\n+\n+    @Setup\n+    @Arguments(values = {Argument.NUMBER_42, Argument.NUMBER_42})\n+    public void badSetupArgumentsAnnotation(int a, int b) {}\n+\n+    @NoFail\n+    @Test\n+    public void testForBadSetupRunAnnotation() {}\n+\n+    @Setup\n+    @Run(test = \"testForBadSetupRunAnnotation\")\n+    public void badSetupRunAnnotation() {}\n+\n+    \/\/ ----------- Useless but ok: Setup Without Test Method -----\n+    @NoFail\n+    @Setup\n+    public void setupWithNoTest() {}\n+\n+    \/\/ ----------- Bad: Test where Setup Method does not exist ---\n+    @Test\n+    @Arguments(setup = \"nonExistingMethod\")\n+    public void testWithNonExistingMethod() {}\n+\n+    \/\/ ----------- Bad Arguments Annotation ----------------------\n+    @NoFail\n+    @Setup\n+    public Object[] setupForTestSetupAndValues() {\n+        return new Object[]{1, 2};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupForTestSetupAndValues\",\n+               values = {Argument.NUMBER_42, Argument.NUMBER_42})\n+    public void testSetupAndValues(int a, int b) {}\n+\n+    \/\/ ----------- Overloaded Setup Method ----------------------\n+    @NoFail\n+    @Setup\n+    Object[] setupOverloaded() {\n+        return new Object[]{3, 2, 1};\n+    }\n+\n+    @Setup\n+    Object[] setupOverloaded(SetupInfo info) {\n+        return new Object[]{1, 2, 3};\n+    }\n+\n+    @NoFail\n+    @Test\n+    @Arguments(setup = \"setupOverloaded\")\n+    void testOverloaded(int a, int b, int c) {}\n+}\n+\n@@ -705,1 +774,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/tests\/TestBadFormat.java","additions":91,"deletions":22,"binary":false,"changes":113,"status":"modified"},{"patch":"@@ -136,1 +136,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -145,1 +145,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -154,1 +154,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -163,1 +163,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -172,1 +172,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -181,1 +181,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -190,1 +190,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -199,1 +199,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -208,1 +208,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -217,1 +217,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -226,1 +226,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -235,1 +235,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -244,1 +244,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -253,1 +253,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -262,1 +262,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -271,1 +271,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -280,1 +280,1 @@\n-    @Arguments(Argument.FALSE)\n+    @Arguments(values = Argument.FALSE)\n@@ -289,1 +289,1 @@\n-    @Arguments(Argument.TRUE)\n+    @Arguments(values = Argument.TRUE)\n@@ -298,1 +298,1 @@\n-    @Arguments(Argument.RANDOM_ONCE)\n+    @Arguments(values = Argument.RANDOM_ONCE)\n@@ -304,1 +304,1 @@\n-    @Arguments(Argument.RANDOM_ONCE)\n+    @Arguments(values = Argument.RANDOM_ONCE)\n@@ -310,1 +310,1 @@\n-    @Arguments(Argument.RANDOM_ONCE)\n+    @Arguments(values = Argument.RANDOM_ONCE)\n@@ -316,1 +316,1 @@\n-    @Arguments(Argument.RANDOM_ONCE)\n+    @Arguments(values = Argument.RANDOM_ONCE)\n@@ -322,1 +322,1 @@\n-    @Arguments(Argument.RANDOM_ONCE)\n+    @Arguments(values = Argument.RANDOM_ONCE)\n@@ -328,1 +328,1 @@\n-    @Arguments(Argument.RANDOM_ONCE)\n+    @Arguments(values = Argument.RANDOM_ONCE)\n@@ -339,1 +339,1 @@\n-    @Arguments(Argument.RANDOM_ONCE)\n+    @Arguments(values = Argument.RANDOM_ONCE)\n@@ -345,1 +345,1 @@\n-    @Arguments(Argument.BOOLEAN_TOGGLE_FIRST_FALSE)\n+    @Arguments(values = Argument.BOOLEAN_TOGGLE_FIRST_FALSE)\n@@ -360,1 +360,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -367,1 +367,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -374,1 +374,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -381,1 +381,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -388,1 +388,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -395,1 +395,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -402,1 +402,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -409,1 +409,1 @@\n-    @Arguments(Argument.RANDOM_EACH)\n+    @Arguments(values = Argument.RANDOM_EACH)\n@@ -462,1 +462,1 @@\n-    @Arguments(Argument.NUMBER_MINUS_42)\n+    @Arguments(values = Argument.NUMBER_MINUS_42)\n@@ -471,1 +471,1 @@\n-    @Arguments(Argument.NUMBER_MINUS_42)\n+    @Arguments(values = Argument.NUMBER_MINUS_42)\n@@ -480,1 +480,1 @@\n-    @Arguments(Argument.NUMBER_MINUS_42)\n+    @Arguments(values = Argument.NUMBER_MINUS_42)\n@@ -489,1 +489,1 @@\n-    @Arguments(Argument.NUMBER_MINUS_42)\n+    @Arguments(values = Argument.NUMBER_MINUS_42)\n@@ -498,1 +498,1 @@\n-    @Arguments(Argument.NUMBER_MINUS_42)\n+    @Arguments(values = Argument.NUMBER_MINUS_42)\n@@ -507,1 +507,1 @@\n-    @Arguments(Argument.NUMBER_MINUS_42)\n+    @Arguments(values = Argument.NUMBER_MINUS_42)\n@@ -516,1 +516,1 @@\n-    @Arguments(Argument.MIN)\n+    @Arguments(values = Argument.MIN)\n@@ -525,1 +525,1 @@\n-    @Arguments(Argument.MIN)\n+    @Arguments(values = Argument.MIN)\n@@ -534,1 +534,1 @@\n-    @Arguments(Argument.MIN)\n+    @Arguments(values = Argument.MIN)\n@@ -543,1 +543,1 @@\n-    @Arguments(Argument.MIN)\n+    @Arguments(values = Argument.MIN)\n@@ -552,1 +552,1 @@\n-    @Arguments(Argument.MIN)\n+    @Arguments(values = Argument.MIN)\n@@ -561,1 +561,1 @@\n-    @Arguments(Argument.MIN)\n+    @Arguments(values = Argument.MIN)\n@@ -570,1 +570,1 @@\n-    @Arguments(Argument.MIN)\n+    @Arguments(values = Argument.MIN)\n@@ -579,1 +579,1 @@\n-    @Arguments(Argument.MAX)\n+    @Arguments(values = Argument.MAX)\n@@ -588,1 +588,1 @@\n-    @Arguments(Argument.MAX)\n+    @Arguments(values = Argument.MAX)\n@@ -597,1 +597,1 @@\n-    @Arguments(Argument.MAX)\n+    @Arguments(values = Argument.MAX)\n@@ -606,1 +606,1 @@\n-    @Arguments(Argument.MAX)\n+    @Arguments(values = Argument.MAX)\n@@ -615,1 +615,1 @@\n-    @Arguments(Argument.MAX)\n+    @Arguments(values = Argument.MAX)\n@@ -624,1 +624,1 @@\n-    @Arguments(Argument.MAX)\n+    @Arguments(values = Argument.MAX)\n@@ -633,1 +633,1 @@\n-    @Arguments(Argument.MAX)\n+    @Arguments(values = Argument.MAX)\n@@ -642,1 +642,1 @@\n-    @Arguments({Argument.DEFAULT, Argument.DEFAULT})\n+    @Arguments(values = {Argument.DEFAULT, Argument.DEFAULT})\n@@ -651,1 +651,1 @@\n-    @Arguments({Argument.DEFAULT, Argument.DEFAULT})\n+    @Arguments(values = {Argument.DEFAULT, Argument.DEFAULT})\n@@ -660,1 +660,1 @@\n-    @Arguments({Argument.DEFAULT, Argument.DEFAULT})\n+    @Arguments(values = {Argument.DEFAULT, Argument.DEFAULT})\n@@ -669,1 +669,1 @@\n-    @Arguments({Argument.DEFAULT, Argument.DEFAULT})\n+    @Arguments(values = {Argument.DEFAULT, Argument.DEFAULT})\n@@ -678,1 +678,1 @@\n-    @Arguments({Argument.DEFAULT, Argument.DEFAULT})\n+    @Arguments(values = {Argument.DEFAULT, Argument.DEFAULT})\n@@ -687,1 +687,1 @@\n-    @Arguments({Argument.DEFAULT, Argument.DEFAULT})\n+    @Arguments(values = {Argument.DEFAULT, Argument.DEFAULT})\n@@ -696,1 +696,1 @@\n-    @Arguments({Argument.RANDOM_ONCE, Argument.RANDOM_ONCE})\n+    @Arguments(values = {Argument.RANDOM_ONCE, Argument.RANDOM_ONCE})\n@@ -702,1 +702,1 @@\n-    @Arguments({Argument.RANDOM_ONCE, Argument.RANDOM_ONCE,\n+    @Arguments(values = {Argument.RANDOM_ONCE, Argument.RANDOM_ONCE,\n@@ -714,1 +714,1 @@\n-    @Arguments({Argument.RANDOM_ONCE, Argument.RANDOM_ONCE,\n+    @Arguments(values = {Argument.RANDOM_ONCE, Argument.RANDOM_ONCE,\n@@ -723,1 +723,1 @@\n-    @Arguments({Argument.RANDOM_EACH, Argument.RANDOM_EACH,\n+    @Arguments(values = {Argument.RANDOM_EACH, Argument.RANDOM_EACH,\n@@ -732,1 +732,1 @@\n-    @Arguments({Argument.RANDOM_ONCE, Argument.RANDOM_ONCE,\n+    @Arguments(values = {Argument.RANDOM_ONCE, Argument.RANDOM_ONCE,\n@@ -741,1 +741,1 @@\n-    @Arguments({Argument.NUMBER_42, Argument.NUMBER_42,\n+    @Arguments(values = {Argument.NUMBER_42, Argument.NUMBER_42,\n@@ -752,1 +752,1 @@\n-    @Arguments({Argument.NUMBER_MINUS_42, Argument.NUMBER_MINUS_42,\n+    @Arguments(values = {Argument.NUMBER_MINUS_42, Argument.NUMBER_MINUS_42,\n@@ -763,1 +763,1 @@\n-    @Arguments({Argument.NUMBER_MINUS_42, Argument.NUMBER_42,\n+    @Arguments(values = {Argument.NUMBER_MINUS_42, Argument.NUMBER_42,\n@@ -775,1 +775,1 @@\n-    @Arguments(Argument.BOOLEAN_TOGGLE_FIRST_TRUE)\n+    @Arguments(values = Argument.BOOLEAN_TOGGLE_FIRST_TRUE)\n@@ -790,1 +790,1 @@\n-    @Arguments({Argument.BOOLEAN_TOGGLE_FIRST_FALSE, Argument.BOOLEAN_TOGGLE_FIRST_TRUE})\n+    @Arguments(values = {Argument.BOOLEAN_TOGGLE_FIRST_FALSE, Argument.BOOLEAN_TOGGLE_FIRST_TRUE})\n@@ -807,1 +807,1 @@\n-    @Arguments({Argument.BOOLEAN_TOGGLE_FIRST_FALSE, Argument.FALSE,\n+    @Arguments(values = {Argument.BOOLEAN_TOGGLE_FIRST_FALSE, Argument.FALSE,\n@@ -856,1 +856,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/tests\/TestBasics.java","additions":72,"deletions":72,"binary":false,"changes":144,"status":"modified"},{"patch":"@@ -99,1 +99,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -142,1 +142,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -156,1 +156,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -171,1 +171,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n@@ -213,1 +213,1 @@\n-    @Arguments(Argument.NUMBER_42)\n+    @Arguments(values = Argument.NUMBER_42)\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/tests\/TestCheckedTests.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -416,1 +416,1 @@\n-    @Arguments(Argument.DEFAULT)\n+    @Arguments(values = Argument.DEFAULT)\n@@ -1113,1 +1113,1 @@\n-    @Arguments(Argument.TRUE)\n+    @Arguments(values = Argument.TRUE)\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/tests\/TestIRMatching.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -0,0 +1,369 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package ir_framework.tests;\n+\n+import compiler.lib.ir_framework.*;\n+import compiler.lib.ir_framework.driver.TestVMException;\n+import compiler.lib.ir_framework.shared.TestRunException;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import jdk.test.lib.Asserts;\n+import jdk.test.lib.Utils;\n+import java.util.Random;\n+\n+\/*\n+ * @test\n+ * @bug 8324641\n+ * @requires vm.debug == true & vm.compMode != \"Xint\" & vm.compiler2.enabled & vm.flagless\n+ * @summary Test different custom run tests.\n+ * @library \/test\/lib \/testlibrary_tests \/\n+ * @run driver ir_framework.tests.TestSetupTests\n+ *\/\n+\n+public class TestSetupTests {\n+    private static final Random RANDOM = Utils.getRandomInstance();\n+\n+    public static void main(String[] args) {\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        PrintStream ps = new PrintStream(baos);\n+        PrintStream oldOut = System.out;\n+        System.setOut(ps);\n+\n+        \/\/ Positive tests in TestSetupTests class\n+        TestFramework.run();\n+\n+        \/\/ Positive tests in TestSetupTestsWithFields class\n+        TestFramework.run(TestSetupTestsWithFields.class);\n+\n+        \/\/ Positive tests in TestSetupTestsSetupInfo class\n+        TestFramework.run(TestSetupTestsSetupInfo.class);\n+\n+        \/\/ Positive tests with expected exceptions\n+        try {\n+            TestFramework.run(TestSetupTestsWithExpectedExceptions.class);\n+            Asserts.fail(\"Should have thrown exception\");\n+        } catch (TestVMException e) {\n+            System.setOut(oldOut);\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"testTooManyArgs\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"IllegalArgumentException: wrong number of arguments: 3 expected: 1\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"testTooFewArgs\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"IllegalArgumentException: wrong number of arguments: 2 expected: 3\"));\n+\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"testTooManyArgs2\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"IllegalArgumentException: wrong number of arguments: 3 expected: 0\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"testTooFewArgs2\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"IllegalArgumentException: wrong number of arguments: 0 expected: 3\"));\n+\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"setupTestBadSetupArgsTooMany\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"wrong number of arguments: 0 expected: 2\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"setupTestBadSetupArgsWrongType\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"argument type mismatch\"));\n+\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"setupReturnIntArray\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"class [I cannot be cast to class [Ljava.lang.Object;\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"setupReturnInt\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"class java.lang.Integer cannot be cast to class [Ljava.lang.Object;\"));\n+\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"testSetupWrongArgumentType\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"argument type mismatch\"));\n+\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"testSetupNull\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"wrong number of arguments: 0 expected: 1\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"Arguments: <null>\"));\n+\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"setupThrowInSetup\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"BadCheckedTestException: expected setup\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"testThrowInTest\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"BadCheckedTestException: expected test\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"checkThrowInCheck\"));\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"BadCheckedTestException: expected check\"));\n+\n+            \/\/ Check number of total failures:\n+            Asserts.assertEQ(e.getExceptionInfo().split(\"argument type mismatch\").length - 1, 2);\n+            Asserts.assertEQ(e.getExceptionInfo().split(\"There was an error while invoking setup\").length - 1, 5);\n+            Asserts.assertEQ(e.getExceptionInfo().split(\"There was an error while invoking @Test\").length - 1, 7);\n+            Asserts.assertEQ(e.getExceptionInfo().split(\"There was an error while invoking @Check\").length - 1, 1);\n+            Asserts.assertEQ(e.getExceptionInfo().split(\"BadCheckedTestException\").length - 1, 3);\n+            Asserts.assertTrue(e.getExceptionInfo().contains(\"Test Failures (13)\"));\n+        }\n+    }\n+\n+    \/\/ ---------- Setup Nothing ---------------\n+    @Setup\n+    public void setupVoid() {}\n+\n+    @Test\n+    @Arguments(setup = \"setupVoid\")\n+    public void testSetupVoid() {}\n+\n+    @Setup\n+    public Object[] setupEmpty() {\n+        return new Object[]{};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupEmpty\")\n+    public void testSetupEmpty() {}\n+\n+    \/\/ ---------- Setup Arrays ---------------\n+    @Setup\n+    static Object[] setupArrayII(SetupInfo info) {\n+        int[] a = new int[1_000];\n+        int[] b = new int[1_000];\n+        int x = info.invocationCounter();\n+        for (int i = 0; i < a.length; i++) { a[i] = x + i; }\n+        for (int i = 0; i < a.length; i++) { b[i] = x - i; }\n+        return new Object[]{a, b};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupArrayII\")\n+    static void testSetupArrayII(int[] a, int[] b) {\n+        for (int i = 0; i < a.length; i++) {\n+            int y = a[i] - b[i];\n+            if (y != 2 * i) {\n+                throw new RuntimeException(\"bad values for i=\" + i + \" a[i]=\" + a[i] + \" b[i]=\" + b[i]);\n+            }\n+        }\n+    }\n+\n+    \/\/ ---------- Setup \"linked\" random values ---------------\n+    @Setup\n+    static Object[] setupLinkedII() {\n+        int r = RANDOM.nextInt();\n+        return new Object[]{ r, r + 42};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupLinkedII\")\n+    static int testSetupLinkedII(int a, int b) {\n+        return b - a;\n+    }\n+\n+    @Check(test = \"testSetupLinkedII\")\n+    static void checkSetupLinkedII(int res) {\n+        if (res != 42) { throw new RuntimeException(\"wrong result \" + res); }\n+    }\n+}\n+\n+class TestSetupTestsWithFields {\n+    int iFld1, iFld2, iFld3;\n+\n+    @Setup\n+    Object[] setupTest1(SetupInfo info) {\n+        iFld1 = info.invocationCounter() + 1;\n+        iFld2 = info.invocationCounter() + 2;\n+        iFld3 = info.invocationCounter() + 3;\n+        return new Object[]{info.invocationCounter()}; \/\/ -> argument x in test\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupTest1\")\n+    int test1(int x) {\n+        if (iFld1 != x + 1) { throw new RuntimeException(\"iFld1 wrong value: \" + iFld1 + \" != \" + (x + 1)); }\n+        if (iFld2 != x + 2) { throw new RuntimeException(\"iFld2 wrong value: \" + iFld2 + \" != \" + (x + 2)); }\n+        if (iFld3 != x + 3) { throw new RuntimeException(\"iFld3 wrong value: \" + iFld3 + \" != \" + (x + 3)); }\n+        iFld1++;\n+        iFld2++;\n+        iFld3++;\n+        return x + 5; \/\/ -> argument y in check\n+    }\n+\n+    @Check(test = \"test1\")\n+    void checkTest1(int y) {\n+        if (iFld1 != y - 3) { throw new RuntimeException(\"iFld1 wrong value: \" + iFld1 + \" != \" + (y - 3)); }\n+        if (iFld2 != y - 2) { throw new RuntimeException(\"iFld2 wrong value: \" + iFld2 + \" != \" + (y - 2)); }\n+        if (iFld3 != y - 1) { throw new RuntimeException(\"iFld3 wrong value: \" + iFld3 + \" != \" + (y - 1)); }\n+    }\n+}\n+\n+class TestSetupTestsSetupInfo {\n+    static int lastCnt = -1;\n+\n+    @Setup\n+    Object[] setupTest1(SetupInfo info) {\n+        int cnt = info.invocationCounter();\n+        \/\/ Check that we increment every time\n+        if (cnt - 1 != lastCnt) {\n+            throw new RuntimeException(\"SetupInfo invocationCounter does not increment correctly: \" +\n+                                       cnt + \", vs last: \" + lastCnt);\n+        }\n+        lastCnt = cnt;\n+        return new Object[]{1, 2};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupTest1\")\n+    void test1(int a, int b) {}\n+}\n+\n+class TestSetupTestsWithExpectedExceptions {\n+    \/\/ ----------------- wrong number of arguments ------------------\n+    @Setup\n+    public Object[] setupTooManyArgs() {\n+      return new Object[]{1, 2, 3};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupTooManyArgs\")\n+    public void testTooManyArgs(int a) {}\n+\n+    @Setup\n+    public Object[] setupTooFewArgs() {\n+      return new Object[]{1, 2};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupTooFewArgs\")\n+    public void testTooFewArgs(int a, int b, int c) {}\n+\n+    @Setup\n+    public Object[] setupTooManyArgs2() {\n+      return new Object[]{1, 2, 3};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupTooManyArgs2\")\n+    public void testTooManyArgs2() {}\n+\n+    @Setup\n+    public Object[] setupTooFewArgs2() {\n+      return new Object[]{};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupTooFewArgs2\")\n+    public void testTooFewArgs2(int a, int b, int c) {}\n+\n+    \/\/ ----------------- wrong arguments for setup ------------------\n+    @Setup\n+    public Object[] setupTestBadSetupArgsTooMany(SetupInfo setupInfo, int bad) {\n+      return new Object[]{1, 2};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupTestBadSetupArgsTooMany\")\n+    public void testBadSetupArgsTooMany(int a, int b) {}\n+\n+    @Setup\n+    public Object[] setupTestBadSetupArgsWrongType(int bad) {\n+      return new Object[]{1, 2};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupTestBadSetupArgsWrongType\")\n+    public void testBadSetupArgsWrongType(int a, int b) {}\n+\n+    \/\/ ----------------- setup wrong return type ------------------\n+    @Setup\n+    public int[] setupReturnIntArray() {\n+        return new int[]{1, 2, 3};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupReturnIntArray\")\n+    public void testSetupReturnIntArray(int a, int b, int c) {}\n+\n+    @Setup\n+    public int setupReturnInt(SetupInfo setupInfo) {\n+        return setupInfo.invocationCounter();\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupReturnInt\")\n+    public void testSetupReturnInt(int a) {}\n+\n+    \/\/ ----------------- setup provides wrong argument types ------\n+    @Setup\n+    public Object[] setupWrongArgumentType(SetupInfo setupInfo) {\n+        return new Object[]{(int)1, (long)2};\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupWrongArgumentType\")\n+    public void testSetupWrongArgumentType(long a, int b) {}\n+\n+    \/\/ ----------------- setup returns null ------\n+    @Setup\n+    public Object[] setupNull() {\n+        return null;\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupNull\")\n+    public void testSetupNull(Object x) {}\n+\n+    \/\/ ----------------- Throw in Setup -----------\n+    @Setup\n+    public Object[] setupThrowInSetup() {\n+        throw new BadCheckedTestException(\"expected setup\");\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupThrowInSetup\")\n+    public void testThrowInSetup() {\n+        throw new RuntimeException(\"should have thrown in setup\");\n+    }\n+\n+    \/\/ ----------------- Throw in Test  -----------\n+    @Setup\n+    public Object[] setupThrowInTest(SetupInfo info) {\n+        return new Object[]{ info.invocationCounter() };\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupThrowInTest\")\n+    public int testThrowInTest(int x) {\n+        throw new BadCheckedTestException(\"expected test\");\n+    }\n+\n+    @Check(test = \"testThrowInTest\")\n+    public void checkThrowInTest(int x) {\n+        throw new RuntimeException(\"should have thrown in test\");\n+    }\n+\n+    \/\/ ----------------- Throw in Check -----------\n+    @Setup\n+    public Object[] setupThrowInCheck(SetupInfo info) {\n+        return new Object[]{ info.invocationCounter() };\n+    }\n+\n+    @Test\n+    @Arguments(setup = \"setupThrowInCheck\")\n+    public int testThrowInCheck(int x) {\n+        return x + 1;\n+    }\n+\n+    @Check(test = \"testThrowInCheck\")\n+    public void checkThrowInCheck(int x) {\n+        throw new BadCheckedTestException(\"expected check\");\n+    }\n+}\n+\n+class BadCheckedTestException extends RuntimeException {\n+    BadCheckedTestException(String s) {\n+        super(s);\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/tests\/TestSetupTests.java","additions":369,"deletions":0,"binary":false,"changes":369,"status":"added"}]}