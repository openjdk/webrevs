{"files":[{"patch":"@@ -313,0 +313,4 @@\n+    \/\/ Parse the specified cipher transformation for algorithm and the\n+    \/\/ optional mode and padding. If the transformation contains only\n+    \/\/ algorithm, then only algorithm is returned. Otherwise, the\n+    \/\/ transformation must contain all 3 and they must be non-empty.\n@@ -319,1 +323,1 @@\n-         * array containing the components of a cipher transformation:\n+         * Components of a cipher transformation:\n@@ -321,3 +325,3 @@\n-         * index 0: algorithm component (e.g., AES)\n-         * index 1: feedback component (e.g., CFB)\n-         * index 2: padding component (e.g., PKCS5Padding)\n+         * 1) algorithm component (e.g., AES)\n+         * 2) feedback component (e.g., CFB) - optional\n+         * 3) padding component (e.g., PKCS5Padding) - optional\n@@ -325,1 +329,0 @@\n-        String[] parts = { \"\", \"\", \"\" };\n@@ -334,3 +337,11 @@\n-        if (endIdx == -1) {\n-            \/\/ algorithm\n-            parts[0] = transformation.trim();\n+\n+        boolean algorithmOnly = (endIdx == -1);\n+        String algo = (algorithmOnly ? transformation.trim() :\n+                transformation.substring(0, endIdx).trim());\n+        if (algo.isEmpty()) {\n+            throw new NoSuchAlgorithmException(\"Invalid transformation: \" +\n+                                   \"algorithm not specified-\"\n+                                   + transformation);\n+        }\n+        if (algorithmOnly) { \/\/ done\n+            return new String[] { algo };\n@@ -338,2 +349,1 @@\n-            \/\/ algorithm\/mode\/padding\n-            parts[0] = transformation.substring(0, endIdx).trim();\n+            \/\/ continue parsing mode and padding\n@@ -346,6 +356,6 @@\n-            parts[1] = transformation.substring(startIdx, endIdx).trim();\n-            parts[2] = transformation.substring(endIdx+1).trim();\n-        }\n-        if (parts[0].isEmpty()) {\n-            throw new NoSuchAlgorithmException(\"Invalid transformation: \" +\n-                                   \"algorithm not specified-\"\n+            String mode = transformation.substring(startIdx, endIdx).trim();\n+            String padding = transformation.substring(endIdx+1).trim();\n+            \/\/ ensure mode and padding are specified\n+            if (mode.isEmpty() || padding.isEmpty()) {\n+                throw new NoSuchAlgorithmException(\"Invalid transformation: \" +\n+                                   \"missing mode and\/or padding-\"\n@@ -353,0 +363,2 @@\n+            }\n+            return new String[] { algo, mode, padding };\n@@ -354,1 +366,0 @@\n-        return parts;\n@@ -450,5 +461,1 @@\n-        String alg = parts[0];\n-        String mode = (parts[1].length() == 0 ? null : parts[1]);\n-        String pad = (parts[2].length() == 0 ? null : parts[2]);\n-\n-        if ((mode == null) && (pad == null)) {\n+        if (parts.length == 1) {\n@@ -456,2 +463,1 @@\n-            Transform tr = new Transform(alg, \"\", null, null);\n-            return Collections.singletonList(tr);\n+            return List.of(new Transform(parts[0], \"\", null, null));\n@@ -459,13 +465,7 @@\n-            \/\/ Algorithm w\/ at least mode or padding or both\n-            List<Transform> list = new ArrayList<>(4);\n-            if ((mode != null) && (pad != null)) {\n-                list.add(new Transform(alg, \"\/\" + mode + \"\/\" + pad, null, null));\n-            }\n-            if (mode != null) {\n-                list.add(new Transform(alg, \"\/\" + mode, null, pad));\n-            }\n-            if (pad != null) {\n-                list.add(new Transform(alg, \"\/\/\" + pad, mode, null));\n-            }\n-            list.add(new Transform(alg, \"\", mode, pad));\n-            return list;\n+            \/\/ Algorithm w\/ both mode and padding\n+            return List.of(\n+                    new Transform(parts[0], \"\/\" + parts[1] + \"\/\" + parts[2],\n+                    null, null),\n+                    new Transform(parts[0], \"\/\" + parts[1], null, parts[2]),\n+                    new Transform(parts[0], \"\/\/\" + parts[2], parts[1], null),\n+                    new Transform(parts[0], \"\", parts[1], parts[2]));\n","filename":"src\/java.base\/share\/classes\/javax\/crypto\/Cipher.java","additions":37,"deletions":37,"binary":false,"changes":74,"status":"modified"},{"patch":"@@ -27,4 +27,3 @@\n- * @bug 8358159\n- * @summary test that the Cipher.getInstance() handles\n- * transformations with empty mode and\/or padding\n- * @run main TestEmptyModePadding\n+ * @bug 8359388\n+ * @summary test that the Cipher.getInstance() would reject improper\n+ *     transformations with empty mode and\/or padding.\n@@ -33,3 +32,4 @@\n-\n-import java.security.*;\n-import javax.crypto.*;\n+import java.security.NoSuchAlgorithmException;\n+import java.security.Provider;\n+import java.security.Security;\n+import javax.crypto.Cipher;\n@@ -40,1 +40,4 @@\n-        Provider provider = Security.getProvider(System.getProperty(\"test.provider.name\", \"SunJCE\"));\n+        Provider provider = Security.getProvider(\n+                System.getProperty(\"test.provider.name\", \"SunJCE\"));\n+\n+        System.out.println(\"Testing against \" + provider.getName());\n@@ -42,8 +45,26 @@\n-        test(\"AES\", provider);\n-        test(\"AES\/ECB\/PKCS5Padding\", provider);\n-        test(\"AES\/\/PKCS5Padding\", provider);        \/\/ Empty mode\n-        test(\"AES\/CBC\/\", provider);                 \/\/ Empty padding\n-        test(\"AES\/ \/NoPadding\", provider);          \/\/ Mode is a space\n-        test(\"AES\/CBC\/ \", provider);                \/\/ Padding is a space\n-        test(\"AES\/ \/ \", provider);                  \/\/ Both mode and padding are spaces\n-        test(\"AES\/\/\", provider);                    \/\/ Both mode and padding are missing\n+        String[] testTransformations = {\n+            \/\/ transformations w\/ only 1 component, i.e. algo\n+            \" \",\n+            \/\/ transformations w\/ only 2 components\n+            \"AES\/\",\n+            \"AES\/ \",\n+            \"AES\/CBC\",\n+            \"PBEWithHmacSHA512\/224AndAES_128\/\",\n+            \"PBEWithHmacSHA512\/256AndAES_128\/ \",\n+            \"PBEWithHmacSHA512\/224AndAES_128\/CBC\",\n+            \/\/ 3-component transformations w\/ empty component(s)\n+            \"AES\/\/\",\n+            \"AES\/ \/\",\n+            \"AES\/\/ \",\n+            \"AES\/ \/ \",\n+            \"AES\/CBC\/\", \"AES\/CBC\/ \",\n+            \"AES\/\/PKCS5Padding\", \"AES\/ \/NoPadding\",\n+            \"PBEWithHmacSHA512\/224AndAES_128\/\/\",\n+            \"PBEWithHmacSHA512\/224AndAES_128\/ \/\",\n+            \"PBEWithHmacSHA512\/224AndAES_128\/\/ \",\n+            \"PBEWithHmacSHA512\/224AndAES_128\/ \/ \",\n+            \"PBEWithHmacSHA512\/256AndAES_128\/CBC\/\",\n+            \"PBEWithHmacSHA512\/256AndAES_128\/CBC\/ \",\n+            \"PBEWithHmacSHA512\/256AndAES_128\/\/PKCS5Padding\",\n+            \"PBEWithHmacSHA512\/256AndAES_128\/ \/PKCS5Padding\",\n+        };\n@@ -51,0 +72,3 @@\n+        for (String t : testTransformations) {\n+            test(t, provider);\n+        }\n@@ -53,2 +77,8 @@\n-    private static void test(String transformation, Provider provider) throws Exception {\n-        Cipher c = Cipher.getInstance(transformation, provider);\n+    private static void test(String t, Provider p) throws Exception {\n+        try {\n+            Cipher c = Cipher.getInstance(t, p);\n+            throw new RuntimeException(\"Should throw NSAE for \\'\" + t + \"\\'\");\n+        } catch (NoSuchAlgorithmException nsae) {\n+            \/\/ transformation info is already in the NSAE message\n+            System.out.println(\"Expected NSAE: \" + nsae.getMessage());\n+        }\n","filename":"test\/jdk\/javax\/crypto\/Cipher\/TestEmptyModePadding.java","additions":48,"deletions":18,"binary":false,"changes":66,"status":"modified"}]}