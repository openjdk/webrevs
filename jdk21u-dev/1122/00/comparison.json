{"files":[{"patch":"@@ -3256,2 +3256,2 @@\n-TypeInterfaces::TypeInterfaces()\n-        : Type(Interfaces), _list(Compile::current()->type_arena(), 0, 0, nullptr),\n+TypeInterfaces::TypeInterfaces(ciInstanceKlass** interfaces_base, int nb_interfaces)\n+        : Type(Interfaces), _interfaces(interfaces_base, nb_interfaces),\n@@ -3259,9 +3259,1 @@\n-  DEBUG_ONLY(_initialized = true);\n-}\n-\n-TypeInterfaces::TypeInterfaces(GrowableArray<ciInstanceKlass*>* interfaces)\n-        : Type(Interfaces), _list(Compile::current()->type_arena(), interfaces->length(), 0, nullptr),\n-          _hash(0), _exact_klass(nullptr) {\n-  for (int i = 0; i < interfaces->length(); i++) {\n-    add(interfaces->at(i));\n-  }\n+  _interfaces.sort(compare);\n@@ -3272,1 +3264,14 @@\n-  TypeInterfaces* result = (interfaces == nullptr) ? new TypeInterfaces() : new TypeInterfaces(interfaces);\n+  \/\/ hashcons() can only delete the last thing that was allocated: to\n+  \/\/ make sure all memory for the newly created TypeInterfaces can be\n+  \/\/ freed if an identical one exists, allocate space for the array of\n+  \/\/ interfaces right after the TypeInterfaces object so that they\n+  \/\/ form a contiguous piece of memory.\n+  int nb_interfaces = interfaces == nullptr ? 0 : interfaces->length();\n+  size_t total_size = sizeof(TypeInterfaces) + nb_interfaces * sizeof(ciInstanceKlass*);\n+\n+  void* allocated_mem = operator new(total_size);\n+  ciInstanceKlass** interfaces_base = (ciInstanceKlass**)((char*)allocated_mem + sizeof(TypeInterfaces));\n+  for (int i = 0; i < nb_interfaces; ++i) {\n+    interfaces_base[i] = interfaces->at(i);\n+  }\n+  TypeInterfaces* result = ::new (allocated_mem) TypeInterfaces(interfaces_base, nb_interfaces);\n@@ -3291,4 +3296,2 @@\n-void TypeInterfaces::add(ciInstanceKlass* interface) {\n-  assert(interface->is_interface(), \"for interfaces only\");\n-  _list.insert_sorted<compare>(interface);\n-  verify();\n+int TypeInterfaces::compare(ciInstanceKlass** k1, ciInstanceKlass** k2) {\n+  return compare(*k1, *k2);\n@@ -3299,1 +3302,1 @@\n-  if (_list.length() != other->_list.length()) {\n+  if (_interfaces.length() != other->_interfaces.length()) {\n@@ -3302,3 +3305,3 @@\n-  for (int i = 0; i < _list.length(); i++) {\n-    ciKlass* k1 = _list.at(i);\n-    ciKlass* k2 = other->_list.at(i);\n+  for (int i = 0; i < _interfaces.length(); i++) {\n+    ciKlass* k1 = _interfaces.at(i);\n+    ciKlass* k2 = other->_interfaces.at(i);\n@@ -3315,1 +3318,1 @@\n-  if (_list.length() != interfaces->length()) {\n+  if (_interfaces.length() != interfaces->length()) {\n@@ -3320,1 +3323,1 @@\n-    _list.find_sorted<ciInstanceKlass*, compare>(interfaces->at(i), found);\n+    _interfaces.find_sorted<ciInstanceKlass*, compare>(interfaces->at(i), found);\n@@ -3340,2 +3343,2 @@\n-  for (int i = 0; i < _list.length(); i++) {\n-    ciKlass* k = _list.at(i);\n+  for (int i = 0; i < _interfaces.length(); i++) {\n+    ciKlass* k = _interfaces.at(i);\n@@ -3352,1 +3355,1 @@\n-  if (_list.length() == 0) {\n+  if (_interfaces.length() == 0) {\n@@ -3358,1 +3361,1 @@\n-  interfaces.appendAll(&_list);\n+  interfaces.appendAll(&_interfaces);\n@@ -3373,3 +3376,3 @@\n-  for (int i = 1; i < _list.length(); i++) {\n-    ciInstanceKlass* k1 = _list.at(i-1);\n-    ciInstanceKlass* k2 = _list.at(i);\n+  for (int i = 1; i < _interfaces.length(); i++) {\n+    ciInstanceKlass* k1 = _interfaces.at(i-1);\n+    ciInstanceKlass* k2 = _interfaces.at(i);\n@@ -3386,5 +3389,5 @@\n-  while (i < _list.length() || j < other->_list.length()) {\n-    while (i < _list.length() &&\n-           (j >= other->_list.length() ||\n-            compare(_list.at(i), other->_list.at(j)) < 0)) {\n-      result_list.push(_list.at(i));\n+  while (i < _interfaces.length() || j < other->_interfaces.length()) {\n+    while (i < _interfaces.length() &&\n+           (j >= other->_interfaces.length() ||\n+            compare(_interfaces.at(i), other->_interfaces.at(j)) < 0)) {\n+      result_list.push(_interfaces.at(i));\n@@ -3393,4 +3396,4 @@\n-    while (j < other->_list.length() &&\n-           (i >= _list.length() ||\n-            compare(other->_list.at(j), _list.at(i)) < 0)) {\n-      result_list.push(other->_list.at(j));\n+    while (j < other->_interfaces.length() &&\n+           (i >= _interfaces.length() ||\n+            compare(other->_interfaces.at(j), _interfaces.at(i)) < 0)) {\n+      result_list.push(other->_interfaces.at(j));\n@@ -3399,4 +3402,4 @@\n-    if (i < _list.length() &&\n-        j < other->_list.length() &&\n-        _list.at(i) == other->_list.at(j)) {\n-      result_list.push(_list.at(i));\n+    if (i < _interfaces.length() &&\n+        j < other->_interfaces.length() &&\n+        _interfaces.at(i) == other->_interfaces.at(j)) {\n+      result_list.push(_interfaces.at(i));\n@@ -3410,2 +3413,2 @@\n-  for (int i = 0; i < _list.length(); i++) {\n-    assert(result->_list.contains(_list.at(i)), \"missing\");\n+  for (int i = 0; i < _interfaces.length(); i++) {\n+    assert(result->_interfaces.contains(_interfaces.at(i)), \"missing\");\n@@ -3413,2 +3416,2 @@\n-  for (int i = 0; i < other->_list.length(); i++) {\n-    assert(result->_list.contains(other->_list.at(i)), \"missing\");\n+  for (int i = 0; i < other->_interfaces.length(); i++) {\n+    assert(result->_interfaces.contains(other->_interfaces.at(i)), \"missing\");\n@@ -3416,2 +3419,2 @@\n-  for (int i = 0; i < result->_list.length(); i++) {\n-    assert(_list.contains(result->_list.at(i)) || other->_list.contains(result->_list.at(i)), \"missing\");\n+  for (int i = 0; i < result->_interfaces.length(); i++) {\n+    assert(_interfaces.contains(result->_interfaces.at(i)) || other->_interfaces.contains(result->_interfaces.at(i)), \"missing\");\n@@ -3427,4 +3430,4 @@\n-  while (i < _list.length() || j < other->_list.length()) {\n-    while (i < _list.length() &&\n-           (j >= other->_list.length() ||\n-            compare(_list.at(i), other->_list.at(j)) < 0)) {\n+  while (i < _interfaces.length() || j < other->_interfaces.length()) {\n+    while (i < _interfaces.length() &&\n+           (j >= other->_interfaces.length() ||\n+            compare(_interfaces.at(i), other->_interfaces.at(j)) < 0)) {\n@@ -3433,3 +3436,3 @@\n-    while (j < other->_list.length() &&\n-           (i >= _list.length() ||\n-            compare(other->_list.at(j), _list.at(i)) < 0)) {\n+    while (j < other->_interfaces.length() &&\n+           (i >= _interfaces.length() ||\n+            compare(other->_interfaces.at(j), _interfaces.at(i)) < 0)) {\n@@ -3438,4 +3441,4 @@\n-    if (i < _list.length() &&\n-        j < other->_list.length() &&\n-        _list.at(i) == other->_list.at(j)) {\n-      result_list.push(_list.at(i));\n+    if (i < _interfaces.length() &&\n+        j < other->_interfaces.length() &&\n+        _interfaces.at(i) == other->_interfaces.at(j)) {\n+      result_list.push(_interfaces.at(i));\n@@ -3449,2 +3452,2 @@\n-  for (int i = 0; i < _list.length(); i++) {\n-    assert(!other->_list.contains(_list.at(i)) || result->_list.contains(_list.at(i)), \"missing\");\n+  for (int i = 0; i < _interfaces.length(); i++) {\n+    assert(!other->_interfaces.contains(_interfaces.at(i)) || result->_interfaces.contains(_interfaces.at(i)), \"missing\");\n@@ -3452,2 +3455,2 @@\n-  for (int i = 0; i < other->_list.length(); i++) {\n-    assert(!_list.contains(other->_list.at(i)) || result->_list.contains(other->_list.at(i)), \"missing\");\n+  for (int i = 0; i < other->_interfaces.length(); i++) {\n+    assert(!_interfaces.contains(other->_interfaces.at(i)) || result->_interfaces.contains(other->_interfaces.at(i)), \"missing\");\n@@ -3455,2 +3458,2 @@\n-  for (int i = 0; i < result->_list.length(); i++) {\n-    assert(_list.contains(result->_list.at(i)) && other->_list.contains(result->_list.at(i)), \"missing\");\n+  for (int i = 0; i < result->_interfaces.length(); i++) {\n+    assert(_interfaces.contains(result->_interfaces.at(i)) && other->_interfaces.contains(result->_interfaces.at(i)), \"missing\");\n@@ -3469,1 +3472,1 @@\n-  if (_list.length() == 0) {\n+  if (_interfaces.length() == 0) {\n@@ -3474,2 +3477,2 @@\n-  for (int i = 0; i < _list.length(); i++) {\n-    ciInstanceKlass* interface = _list.at(i);\n+  for (int i = 0; i < _interfaces.length(); i++) {\n+    ciInstanceKlass* interface = _interfaces.at(i);\n@@ -3486,2 +3489,2 @@\n-  for (int i = 0; i < _list.length(); i++) {\n-    ciKlass* interface = _list.at(i);\n+  for (int i = 0; i < _interfaces.length(); i++) {\n+    ciKlass* interface = _interfaces.at(i);\n","filename":"src\/hotspot\/share\/opto\/type.cpp","additions":73,"deletions":70,"binary":false,"changes":143,"status":"modified"},{"patch":"@@ -880,1 +880,1 @@\n-  GrowableArray<ciInstanceKlass*> _list;\n+  GrowableArrayFromArray<ciInstanceKlass*> _interfaces;\n@@ -887,1 +887,0 @@\n-  void add(ciInstanceKlass* interface);\n@@ -891,2 +890,2 @@\n-  TypeInterfaces();\n-  TypeInterfaces(GrowableArray<ciInstanceKlass*>* interfaces);\n+\n+  TypeInterfaces(ciInstanceKlass** interfaces_base, int nb_interfaces);\n@@ -907,1 +906,1 @@\n-  bool empty() const { return _list.length() == 0; }\n+  bool empty() const { return _interfaces.length() == 0; }\n@@ -913,0 +912,1 @@\n+  static int compare(ciInstanceKlass** k1, ciInstanceKlass** k2);\n","filename":"src\/hotspot\/share\/opto\/type.hpp","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"}]}