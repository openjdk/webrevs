{"files":[{"patch":"@@ -60,1 +60,0 @@\n-import java.util.Iterator;\n@@ -525,0 +524,1 @@\n+                                    \/\/ check if connection is being closed\n@@ -531,0 +531,1 @@\n+                                        handle (chan, conn);\n@@ -532,1 +533,0 @@\n-                                    handle (chan, conn);\n@@ -1022,12 +1022,1 @@\n-            ArrayList<HttpConnection> toClose = new ArrayList<>();\n-            final long currentTime = System.currentTimeMillis();\n-            synchronized (idleConnections) {\n-                final Iterator<HttpConnection> it = idleConnections.iterator();\n-                while (it.hasNext()) {\n-                    final HttpConnection c = it.next();\n-                    if (currentTime - c.idleStartTime >= IDLE_INTERVAL) {\n-                        toClose.add(c);\n-                        it.remove();\n-                    }\n-                }\n-            }\n+            closeConnections(idleConnections, IDLE_INTERVAL);\n@@ -1036,8 +1025,10 @@\n-            synchronized (newlyAcceptedConnections) {\n-                final Iterator<HttpConnection> it = newlyAcceptedConnections.iterator();\n-                while (it.hasNext()) {\n-                    final HttpConnection c = it.next();\n-                    if (currentTime - c.idleStartTime >= NEWLY_ACCEPTED_CONN_IDLE_INTERVAL) {\n-                        toClose.add(c);\n-                        it.remove();\n-                    }\n+            closeConnections(newlyAcceptedConnections, NEWLY_ACCEPTED_CONN_IDLE_INTERVAL);\n+        }\n+\n+        private void closeConnections(Set<HttpConnection> connections, long idleInterval) {\n+            long currentTime = System.currentTimeMillis();\n+            ArrayList<HttpConnection> toClose = new ArrayList<>();\n+\n+            connections.forEach(c -> {\n+                if (currentTime - c.idleStartTime >= idleInterval) {\n+                    toClose.add(c);\n@@ -1045,1 +1036,1 @@\n-            }\n+            });\n@@ -1047,4 +1038,8 @@\n-                allConnections.remove(c);\n-                c.close();\n-                if (logger.isLoggable(Level.TRACE)) {\n-                    logger.log(Level.TRACE, \"Closed idle connection \" + c);\n+                \/\/ check if connection still idle\n+                if (currentTime - c.idleStartTime >= idleInterval &&\n+                        connections.remove(c)) {\n+                    allConnections.remove(c);\n+                    c.close();\n+                    if (logger.isLoggable(Level.TRACE)) {\n+                        logger.log(Level.TRACE, \"Closed idle connection \" + c);\n+                    }\n","filename":"src\/jdk.httpserver\/share\/classes\/sun\/net\/httpserver\/ServerImpl.java","additions":22,"deletions":27,"binary":false,"changes":49,"status":"modified"}]}