{"files":[{"patch":"@@ -62,0 +62,2 @@\n+    private static final Pattern DF_PATTERN = Pattern.compile(\"([^\\\\s]+)\\\\s+(\\\\d+)\\\\s+(\\\\d+)\\\\s+(\\\\d+)\\\\s+\\\\d+%\\\\s+([^\\\\s].*)\\n\");\n+\n@@ -112,2 +114,11 @@\n-            if (getSpace0(name, sizes))\n-                System.err.println(\"WARNING: total space is estimated\");\n+            if (Platform.isWindows() & isCDDrive(name)) {\n+                try {\n+                    getCDDriveSpace(name, sizes);\n+                } catch (IOException e) {\n+                    e.printStackTrace();\n+                    throw new RuntimeException(\"can't get CDDrive sizes\");\n+                }\n+            } else {\n+                if (getSpace0(name, sizes))\n+                    System.err.println(\"WARNING: total space is estimated\");\n+            }\n@@ -205,1 +216,2 @@\n-        out.format(fmt, \"getSpace0\", s.total(), s.free(), s.available());\n+        String method = Platform.isWindows() & isCDDrive(s.name()) ? \"getCDDriveSpace\" : \"getSpace0\";\n+        out.format(fmt, method, s.total(), s.free(), s.available());\n@@ -408,1 +420,1 @@\n-        \/\/ returned by File::getXSpace are equivalent to those from getSpace0\n+        \/\/ returned by File::getXSpace are equivalent to those from getSpace0 or getCDDriveSpace\n@@ -421,6 +433,8 @@\n-        for (int i = 0; i < sma.length; i++) {\n-            System.setSecurityManager(sma[i]);\n-            SecurityManager sm = System.getSecurityManager();\n-            if (sma[i] != null && sm == null)\n-                throw new RuntimeException(\"Test configuration error \"\n-                                           + \" - can't set security manager\");\n+        for (var p : l) {\n+            Space s = new Space(p);\n+            for (int i = 0; i < sma.length; i++) {\n+                System.setSecurityManager(sma[i]);\n+                SecurityManager sm = System.getSecurityManager();\n+                if (sma[i] != null && sm == null)\n+                    throw new RuntimeException(\"Test configuration error \"\n+                                            + \" - can't set security manager\");\n@@ -428,1 +442,1 @@\n-            out.format(\"%nSecurityManager = %s%n\" ,\n+                out.format(\"%nSecurityManager = %s%n\" ,\n@@ -430,2 +444,0 @@\n-            for (var p : l) {\n-                Space s = new Space(p);\n@@ -440,0 +452,1 @@\n+            System.setSecurityManager(null);\n@@ -442,2 +455,0 @@\n-        System.setSecurityManager(null);\n-\n@@ -497,0 +508,36 @@\n+\n+    private static native boolean isCDDrive(String root);\n+\n+    private static void getCDDriveSpace(String root, long[] sizes)\n+        throws IOException {\n+        String[] cmd = new String[] {\"df\", \"-k\", \"-P\", root};\n+        Process p = Runtime.getRuntime().exec(cmd);\n+        StringBuilder sb = new StringBuilder();\n+\n+        try (BufferedReader in = new BufferedReader(new InputStreamReader(p.getInputStream()))) {\n+            String s;\n+            int i = 0;\n+            while ((s = in.readLine()) != null) {\n+                \/\/ skip header\n+                if (i++ == 0) continue;\n+                sb.append(s).append(\"\\n\");\n+            }\n+        }\n+        out.println(sb);\n+\n+        Matcher m = DF_PATTERN.matcher(sb);\n+        int j = 0;\n+        while (j < sb.length()) {\n+            if (m.find(j)) {\n+                sizes[0] = Long.parseLong(m.group(2)) * 1024;\n+                sizes[1] = Long.parseLong(m.group(3)) * 1024;\n+                sizes[2] = sizes[0] - sizes[1];\n+                sizes[3] = Long.parseLong(m.group(4)) * 1024;\n+                j = m.end();\n+            } else {\n+                throw new RuntimeException(\"unrecognized df output format: \"\n+                                           + \"charAt(\" + j + \") = '\"\n+                                           + sb.charAt(j) + \"'\");\n+            }\n+        }\n+    }\n","filename":"test\/jdk\/java\/io\/File\/GetXSpace.java","additions":62,"deletions":15,"binary":false,"changes":77,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -162,0 +162,27 @@\n+\n+JNIEXPORT jboolean JNICALL\n+Java_GetXSpace_isCDDrive\n+    (JNIEnv *env, jclass cls, jstring root)\n+{\n+#ifdef WINDOWS\n+    const jchar* strchars = (*env)->GetStringChars(env, root, NULL);\n+    if (strchars == NULL) {\n+        JNU_ThrowByNameWithLastError(env, \"java\/lang\/RuntimeException\",\n+                                     \"GetStringChars\");\n+        return JNI_FALSE;\n+    }\n+\n+    LPCWSTR path = (LPCWSTR)strchars;\n+    UINT driveType = GetDriveTypeW(path);\n+\n+    (*env)->ReleaseStringChars(env, root, strchars);\n+\n+    if (driveType != DRIVE_CDROM) {\n+        return JNI_FALSE;\n+    }\n+\n+    return JNI_TRUE;\n+#else\n+    return JNI_FALSE;\n+#endif\n+}\n","filename":"test\/jdk\/java\/io\/File\/libGetXSpace.c","additions":28,"deletions":1,"binary":false,"changes":29,"status":"modified"}]}