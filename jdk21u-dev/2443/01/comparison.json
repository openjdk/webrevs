{"files":[{"patch":"@@ -319,1 +319,3 @@\n-            nameComponents[0] = String.format(\"%s.%d\", baseName, i);\n+            \/\/ Don't use period (.) as a separator. OSX codesign fails to sign folders\n+            \/\/ with subfolders with names like \"input.0\".\n+            nameComponents[0] = String.format(\"%s-%d\", baseName, i);\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/TKit.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -24,1 +24,1 @@\n-import java.nio.file.Path;\n+import java.io.IOException;\n@@ -26,1 +26,1 @@\n-import jdk.jpackage.internal.ApplicationLayout;\n+import java.nio.file.Path;\n@@ -28,1 +28,0 @@\n-import jdk.jpackage.test.PackageType;\n@@ -31,1 +30,0 @@\n-import jdk.jpackage.test.Annotations.Parameter;\n@@ -36,0 +34,5 @@\n+import static java.util.stream.Collectors.joining;\n+import java.util.stream.Stream;\n+import jdk.jpackage.internal.IOUtils;\n+import jdk.jpackage.test.Functional.ThrowingFunction;\n+import jdk.jpackage.test.JPackageCommand;\n@@ -39,1 +42,1 @@\n- * Tests generation of packages with input folder containing empty folders.\n+ * Tests generation of packages with additional content in app image.\n@@ -54,8 +57,12 @@\n-    private static final String TEST_JAVA = TKit.TEST_SRC_ROOT.resolve(\n-            \"apps\/PrintEnv.java\").toString();\n-    private static final String TEST_DUKE = TKit.TEST_SRC_ROOT.resolve(\n-            \"apps\/dukeplug.png\").toString();\n-    private static final String TEST_DIR = TKit.TEST_SRC_ROOT.resolve(\n-            \"apps\").toString();\n-    private static final String TEST_BAD = TKit.TEST_SRC_ROOT.resolve(\n-            \"non-existant\").toString();\n+    private static final String TEST_JAVA = \"apps\/PrintEnv.java\";\n+    private static final String TEST_DUKE = \"apps\/dukeplug.png\";\n+    private static final String TEST_DIR = \"apps\";\n+    private static final String TEST_BAD = \"non-existant\";\n+\n+    \/\/ On OSX `--app-content` paths will be copied into the \"Contents\" folder\n+    \/\/ of the output app image.\n+    \/\/ \"codesign\" imposes restrictions on the directory structure of \"Contents\" folder.\n+    \/\/ In particular, random files should be placed in \"Contents\/Resources\" folder\n+    \/\/ otherwise \"codesign\" will fail to sign.\n+    \/\/ Need to prepare arguments for `--app-content` accordingly.\n+    private final static boolean copyInResources = TKit.isOSX();\n@@ -81,0 +88,8 @@\n+        final int expectedJPackageExitCode;\n+        if (testPathArgs.contains(TEST_BAD)) {\n+            expectedJPackageExitCode = 1;\n+        } else {\n+            expectedJPackageExitCode = 0;\n+        }\n+\n+        var appContentInitializer = new AppContentInitializer(testPathArgs);\n@@ -83,5 +98,2 @@\n-            .addInitializer(cmd -> {\n-                for (String arg : testPathArgs) {\n-                    cmd.addArguments(\"--app-content\", arg);\n-                }\n-            })\n+            .addRunOnceInitializer(appContentInitializer::initAppContent)\n+            .addInitializer(appContentInitializer::applyTo)\n@@ -89,2 +101,1 @@\n-                ApplicationLayout appLayout = cmd.appLayout();\n-                Path contentDir = appLayout.contentDirectory();\n+                Path baseDir = getAppContentRoot(cmd);\n@@ -95,1 +106,1 @@\n-                        TKit.assertPathExists(contentDir.resolve(name), true);\n+                        TKit.assertPathExists(baseDir.resolve(name), true);\n@@ -100,3 +111,1 @@\n-            \/\/ On macOS we always signing app image and signing will fail, since\n-            \/\/ test produces invalid app bundle.\n-            .setExpectedExitCode(testPathArgs.contains(TEST_BAD) || TKit.isOSX() ? 1 : 0)\n+            .setExpectedExitCode(expectedJPackageExitCode)\n@@ -104,0 +113,56 @@\n+    }\n+\n+    private static Path getAppContentRoot(JPackageCommand cmd) {\n+        Path contentDir = cmd.appLayout().contentDirectory();\n+        if (copyInResources) {\n+            return contentDir.resolve(\"Resources\");\n+        } else {\n+            return contentDir;\n+        }\n+    }\n+\n+    private static final class AppContentInitializer {\n+        AppContentInitializer(List<String> appContentArgs) {\n+            appContentPathGroups = appContentArgs.stream().map(arg -> {\n+                return Stream.of(arg.split(\",\")).map(Path::of).toList();\n+            }).toList();\n+        }\n+\n+        void initAppContent() {\n+            jpackageArgs = appContentPathGroups.stream()\n+                    .map(AppContentInitializer::initAppContentPaths)\n+                    .<String>mapMulti((appContentPaths, consumer) -> {\n+                        consumer.accept(\"--app-content\");\n+                        consumer.accept(\n+                        appContentPaths.stream().map(Path::toString).collect(\n+                                joining(\",\")));\n+                    }).toList();\n+        }\n+\n+        void applyTo(JPackageCommand cmd) {\n+            cmd.addArguments(jpackageArgs);\n+        }\n+\n+        private static Path copyAppContentPath(Path appContentPath) throws IOException {\n+            var appContentArg = TKit.createTempDirectory(\"app-content\").resolve(\"Resources\");\n+            var srcPath = TKit.TEST_SRC_ROOT.resolve(appContentPath);\n+            var dstPath = appContentArg.resolve(srcPath.getFileName());\n+            Files.createDirectories(dstPath.getParent());\n+            IOUtils.copyRecursive(srcPath, dstPath);\n+            return appContentArg;\n+        }\n+\n+        private static List<Path> initAppContentPaths(List<Path> appContentPaths) {\n+            if (copyInResources) {\n+                return appContentPaths.stream().map(appContentPath -> {\n+                    if (appContentPath.endsWith(TEST_BAD)) {\n+                        return appContentPath;\n+                    } else {\n+                        return ThrowingFunction.toFunction(\n+                                AppContentInitializer::copyAppContentPath).apply(\n+                                        appContentPath);\n+                    }\n+                }).toList();\n+            } else {\n+                return appContentPaths.stream().map(TKit.TEST_SRC_ROOT::resolve).toList();\n+            }\n@@ -105,0 +170,4 @@\n+\n+        private List<String> jpackageArgs;\n+        private final List<List<Path>> appContentPathGroups;\n+    }\n","filename":"test\/jdk\/tools\/jpackage\/share\/AppContentTest.java","additions":94,"deletions":25,"binary":false,"changes":119,"status":"modified"}]}