{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -40,0 +40,2 @@\n+import java.security.AccessController;\n+import java.security.PrivilegedAction;\n@@ -61,0 +63,1 @@\n+@SuppressWarnings(\"removal\")\n@@ -72,0 +75,10 @@\n+    private static void doPrivilegedRunnable(Runnable runnable) {\n+        AccessController.doPrivileged(new PrivilegedAction<Void>() {\n+            @Override\n+            public Void run() {\n+                runnable.run();\n+                return null;\n+            }\n+        });\n+    }\n+\n@@ -73,1 +86,7 @@\n-        PROPS_PATH = setupPath();\n+        PROPS_PATH = AccessController.doPrivileged(new PrivilegedAction<Path>() {\n+            @Override\n+            public Path run() {\n+                return setupPath();\n+            }\n+        });\n+\n@@ -195,1 +214,1 @@\n-                        setFilePermission(PROPS_PATH);\n+                        doPrivilegedRunnable(() -> setFilePermission(PROPS_PATH));\n@@ -197,1 +216,1 @@\n-                        readTokens(PROPS_PATH);\n+                        doPrivilegedRunnable(() -> readTokens(PROPS_PATH));\n@@ -210,0 +229,2 @@\n+    private static WatchService watchService;\n+\n@@ -211,3 +232,4 @@\n-        try {\n-            WatchService watchService =\n-                    FileSystems.getDefault().newWatchService();\n+        doPrivilegedRunnable(() -> {\n+            try {\n+                watchService =\n+                        FileSystems.getDefault().newWatchService();\n@@ -215,6 +237,6 @@\n-            PROPS_PATH\n-                    .getParent()\n-                    .register(watchService,\n-                            ENTRY_CREATE,\n-                            ENTRY_DELETE,\n-                            ENTRY_MODIFY);\n+                PROPS_PATH\n+                        .getParent()\n+                        .register(watchService,\n+                                ENTRY_CREATE,\n+                                ENTRY_DELETE,\n+                                ENTRY_MODIFY);\n@@ -222,5 +244,5 @@\n-            new WatcherThread(watchService).start();\n-        } catch (Exception e) {\n-            if (SCREENCAST_DEBUG) {\n-                System.err.printf(\"Token storage: failed to setup \" +\n-                        \"file watch %s\\n\", e);\n+            } catch (Exception e) {\n+                if (SCREENCAST_DEBUG) {\n+                    System.err.printf(\"Token storage: failed to setup \" +\n+                            \"file watch %s\\n\", e);\n+                }\n@@ -228,0 +250,4 @@\n+        });\n+\n+        if (watchService != null) {\n+            new WatcherThread(watchService).start();\n@@ -279,1 +305,1 @@\n-                store(\"save tokens\");\n+                doPrivilegedRunnable(() -> store(\"save tokens\"));\n@@ -334,1 +360,1 @@\n-        removeMalformedRecords(malformed);\n+        doPrivilegedRunnable(() -> removeMalformedRecords(malformed));\n","filename":"src\/java.desktop\/unix\/classes\/sun\/awt\/screencast\/TokenStorage.java","additions":46,"deletions":20,"binary":false,"changes":66,"status":"modified"}]}