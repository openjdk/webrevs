{"files":[{"patch":"@@ -105,0 +105,11 @@\n+#define CONTAINER_READ_NUMERICAL_KEY_VALUE_CHECKED(controller, filename, key, log_string, retval) \\\n+{                                                                                     \\\n+  bool is_ok;                                                                         \\\n+  is_ok = controller->read_numerical_key_value(filename, key, &retval);               \\\n+  if (!is_ok) {                                                                       \\\n+    log_trace(os, container)(log_string \" failed: %d\", OSCONTAINER_ERROR);            \\\n+    return OSCONTAINER_ERROR;                                                         \\\n+  }                                                                                   \\\n+  log_trace(os, container)(log_string \" is: \" JULONG_FORMAT, retval);                 \\\n+}\n+\n","filename":"src\/hotspot\/os\/linux\/cgroupSubsystem_linux.hpp","additions":11,"deletions":0,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -126,0 +126,6 @@\n+jlong CgroupV1MemoryController::uses_mem_hierarchy() {\n+  julong use_hierarchy;\n+  CONTAINER_READ_NUMBER_CHECKED(reader(), \"\/memory.use_hierarchy\", \"Use Hierarchy\", use_hierarchy);\n+  return (jlong)use_hierarchy;\n+}\n+\n@@ -162,6 +168,4 @@\n-  if (memlimit >= phys_mem) {\n-    verbose_log(memlimit, phys_mem);\n-    return (jlong)-1;\n-  } else {\n-    verbose_log(memlimit, phys_mem);\n-    return (jlong)memlimit;\n+  if (memlimit >= phys_mem && uses_mem_hierarchy()) {\n+    CONTAINER_READ_NUMERICAL_KEY_VALUE_CHECKED(reader(), \"\/memory.stat\",\n+                                               \"hierarchical_memory_limit\", \"Hierarchical Memory Limit\",\n+                                               memlimit);\n@@ -169,0 +173,2 @@\n+  verbose_log(memlimit, phys_mem);\n+  return (jlong)((memlimit < phys_mem) ? memlimit : -1);\n@@ -186,5 +192,4 @@\n-  if (memswlimit >= host_total_memsw) {\n-    log_trace(os, container)(\"Memory and Swap Limit is: Unlimited\");\n-    return (jlong)-1;\n-  } else {\n-    return (jlong)memswlimit;\n+  if (memswlimit >= host_total_memsw && uses_mem_hierarchy()) {\n+    CONTAINER_READ_NUMERICAL_KEY_VALUE_CHECKED(reader(), \"\/memory.stat\",\n+                                               \"hierarchical_memsw_limit\", \"Hierarchical Memory and Swap Limit\",\n+                                               memswlimit);\n@@ -192,0 +197,2 @@\n+  verbose_log(memswlimit, host_total_memsw);\n+  return (jlong)((memswlimit < host_total_memsw) ? memswlimit : -1);\n","filename":"src\/hotspot\/os\/linux\/cgroupV1Subsystem_linux.cpp","additions":18,"deletions":11,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -101,0 +101,1 @@\n+    jlong uses_mem_hierarchy();\n","filename":"src\/hotspot\/os\/linux\/cgroupV1Subsystem_linux.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}