{"files":[{"patch":"@@ -313,1 +313,1 @@\n-  uint stk_args = 0; \/\/ inc by 2 each time\n+  uint stk_args = 0;\n@@ -325,0 +325,1 @@\n+        stk_args = align_up(stk_args, 2);\n@@ -326,1 +327,1 @@\n-        stk_args += 2;\n+        stk_args += 1;\n@@ -343,0 +344,1 @@\n+        stk_args = align_up(stk_args, 2);\n@@ -351,0 +353,1 @@\n+        stk_args = align_up(stk_args, 2);\n@@ -352,1 +355,1 @@\n-        stk_args += 2;\n+        stk_args += 1;\n@@ -360,0 +363,1 @@\n+        stk_args = align_up(stk_args, 2);\n@@ -370,1 +374,1 @@\n-  return align_up(stk_args, 2);\n+  return stk_args;\n","filename":"src\/hotspot\/cpu\/aarch64\/sharedRuntime_aarch64.cpp","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -447,1 +447,0 @@\n-  if (slot & 1) slot++;\n","filename":"src\/hotspot\/cpu\/arm\/sharedRuntime_arm.cpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -737,1 +737,1 @@\n-  return align_up(stk, 2);\n+  return stk;\n","filename":"src\/hotspot\/cpu\/ppc\/sharedRuntime_ppc.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -269,1 +269,1 @@\n-  uint stk_args = 0; \/\/ inc by 2 each time\n+  uint stk_args = 0;\n@@ -281,0 +281,1 @@\n+          stk_args = align_up(stk_args, 2);\n@@ -282,1 +283,1 @@\n-          stk_args += 2;\n+          stk_args += 1;\n@@ -298,0 +299,1 @@\n+          stk_args = align_up(stk_args, 2);\n@@ -306,0 +308,1 @@\n+          stk_args = align_up(stk_args, 2);\n@@ -307,1 +310,1 @@\n-          stk_args += 2;\n+          stk_args += 1;\n@@ -315,0 +318,1 @@\n+          stk_args = align_up(stk_args, 2);\n@@ -324,1 +328,1 @@\n-  return align_up(stk_args, 2);\n+  return stk_args;\n","filename":"src\/hotspot\/cpu\/riscv\/sharedRuntime_riscv.cpp","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -758,1 +758,1 @@\n-  return align_up(stk, 2);\n+  return stk;\n","filename":"src\/hotspot\/cpu\/s390\/sharedRuntime_s390.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -531,2 +531,1 @@\n-  \/\/ return value can be odd number of VMRegImpl stack slots make multiple of 2\n-  return align_up(stack, 2);\n+  return stack;\n","filename":"src\/hotspot\/cpu\/x86\/sharedRuntime_x86_32.cpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -500,1 +500,1 @@\n-  uint stk_args = 0; \/\/ inc by 2 each time\n+  uint stk_args = 0;\n@@ -512,0 +512,1 @@\n+        stk_args = align_up(stk_args, 2);\n@@ -513,1 +514,1 @@\n-        stk_args += 2;\n+        stk_args += 1;\n@@ -530,0 +531,1 @@\n+        stk_args = align_up(stk_args, 2);\n@@ -538,0 +540,1 @@\n+        stk_args = align_up(stk_args, 2);\n@@ -539,1 +542,1 @@\n-        stk_args += 2;\n+        stk_args += 1;\n@@ -547,0 +550,1 @@\n+        stk_args = align_up(stk_args, 2);\n@@ -557,1 +561,1 @@\n-  return align_up(stk_args, 2);\n+  return stk_args;\n","filename":"src\/hotspot\/cpu\/x86\/sharedRuntime_x86_64.cpp","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -75,1 +75,1 @@\n-  intptr_t out_preserve = SharedRuntime::java_calling_convention(sig_bt, regs, sizeargs);\n+  intptr_t out_preserve = align_up(SharedRuntime::java_calling_convention(sig_bt, regs, sizeargs), 2);\n","filename":"src\/hotspot\/share\/c1\/c1_FrameMap.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -3062,1 +3062,1 @@\n-      intptr_t out_preserve = SharedRuntime::java_calling_convention(sig_bt, regs, sizeargs);\n+      SharedRuntime::java_calling_convention(sig_bt, regs, sizeargs);\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -447,1 +447,2 @@\n-  int num_stack_arg_slots() const { return constMethod()->num_stack_arg_slots(); }\n+  int num_stack_arg_slots(bool rounded = true) const {\n+    return rounded ? align_up(constMethod()->num_stack_arg_slots(), 2) : constMethod()->num_stack_arg_slots(); }\n","filename":"src\/hotspot\/share\/oops\/method.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -158,1 +158,1 @@\n-  inline BitMap::idx_t bit_index_for(intptr_t* p) const;\n+  inline BitMap::idx_t bit_index_for(address p) const;\n","filename":"src\/hotspot\/share\/oops\/stackChunkOop.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -259,1 +259,1 @@\n-inline BitMap::idx_t stackChunkOopDesc::bit_index_for(intptr_t* p) const {\n+inline BitMap::idx_t stackChunkOopDesc::bit_index_for(address p) const {\n@@ -265,0 +265,1 @@\n+  assert(is_aligned(p, alignof(OopT)), \"should be aligned: \" PTR_FORMAT, p2i(p));\n","filename":"src\/hotspot\/share\/oops\/stackChunkOop.inline.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -173,1 +173,1 @@\n-  int slots = SharedRuntime::java_calling_convention(sig_bt, vm_regs, num_args);\n+  int slots = align_up(SharedRuntime::java_calling_convention(sig_bt, vm_regs, num_args), 2);\n","filename":"src\/hotspot\/share\/prims\/foreignGlobals.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1744,1 +1744,1 @@\n-  void clear_bitmap_bits(intptr_t* start, int range);\n+  void clear_bitmap_bits(address start, address end);\n@@ -2125,1 +2125,4 @@\n-void ThawBase::clear_bitmap_bits(intptr_t* start, int range) {\n+void ThawBase::clear_bitmap_bits(address start, address end) {\n+  assert(is_aligned(start, wordSize), \"should be aligned: \" PTR_FORMAT, p2i(start));\n+  assert(is_aligned(end, VMRegImpl::stack_slot_size), \"should be aligned: \" PTR_FORMAT, p2i(end));\n+\n@@ -2127,2 +2130,8 @@\n-  \/\/ or they will keep objects that are otherwise unreachable alive\n-  log_develop_trace(continuations)(\"clearing bitmap for \" INTPTR_FORMAT \" - \" INTPTR_FORMAT, p2i(start), p2i(start+range));\n+  \/\/ or they will keep objects that are otherwise unreachable alive.\n+\n+  \/\/ Align `end` if UseCompressedOops is not set to avoid UB when calculating the bit index, since\n+  \/\/ `end` could be at an odd number of stack slots from `start`, i.e might not be oop aligned.\n+  \/\/ If that's the case the bit range corresponding to the last stack slot should not have bits set\n+  \/\/ anyways and we assert that before returning.\n+  address effective_end = UseCompressedOops ? end : align_down(end, wordSize);\n+  log_develop_trace(continuations)(\"clearing bitmap for \" INTPTR_FORMAT \" - \" INTPTR_FORMAT, p2i(start), p2i(effective_end));\n@@ -2130,2 +2139,2 @@\n-  chunk->bitmap().clear_range(chunk->bit_index_for(start),\n-                              chunk->bit_index_for(start+range));\n+  chunk->bitmap().clear_range(chunk->bit_index_for(start), chunk->bit_index_for(effective_end));\n+  assert(effective_end == end || !chunk->bitmap().at(chunk->bit_index_for(effective_end)), \"bit should not be set\");\n@@ -2184,1 +2193,3 @@\n-    clear_bitmap_bits(heap_frame_bottom - locals, locals);\n+    address start = (address)(heap_frame_bottom - locals);\n+    address end = (address)heap_frame_bottom;\n+    clear_bitmap_bits(start, end);\n@@ -2257,1 +2268,4 @@\n-    clear_bitmap_bits(heap_frame_top + ContinuationHelper::CompiledFrame::size(hf) + frame::metadata_words_at_top, added_argsize);\n+    address start = (address)(heap_frame_top + ContinuationHelper::CompiledFrame::size(hf) + frame::metadata_words_at_top);\n+    int stack_args_slots = f.cb()->as_compiled_method()->method()->num_stack_arg_slots(false \/* rounded *\/);\n+    int argsize_in_bytes = stack_args_slots * VMRegImpl::stack_slot_size;\n+    clear_bitmap_bits(start, start + argsize_in_bytes);\n","filename":"src\/hotspot\/share\/runtime\/continuationFreezeThaw.cpp","additions":22,"deletions":8,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -1442,1 +1442,1 @@\n-      assert(stack_arg_slots ==  m->num_stack_arg_slots(), \"\");\n+      assert(stack_arg_slots ==  m->num_stack_arg_slots(false \/* rounded *\/), \"\");\n","filename":"src\/hotspot\/share\/runtime\/frame.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1994,1 +1994,1 @@\n-  int comp_args_on_stack = java_calling_convention(sig_bt, regs_without_member_name, total_args_passed - 1);\n+  java_calling_convention(sig_bt, regs_without_member_name, total_args_passed - 1);\n@@ -3092,1 +3092,1 @@\n-      int comp_args_on_stack = SharedRuntime::java_calling_convention(sig_bt, regs, total_args_passed);\n+      SharedRuntime::java_calling_convention(sig_bt, regs, total_args_passed);\n","filename":"src\/hotspot\/share\/runtime\/sharedRuntime.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -181,1 +181,0 @@\n-  _stack_arg_slots = align_up(_stack_arg_slots, 2);\n@@ -238,1 +237,0 @@\n-#if defined(PPC64) || defined(S390)\n@@ -242,0 +240,4 @@\n+#if defined(PPC64) || defined(S390)\n+      _stack_arg_slots += 1;\n+#else\n+      _stack_arg_slots = align_up(_stack_arg_slots, 2);\n@@ -243,0 +245,1 @@\n+#endif \/\/ defined(PPC64) || defined(S390)\n@@ -245,1 +248,0 @@\n-#endif \/\/ defined(PPC64) || defined(S390)\n@@ -253,2 +255,1 @@\n-      PPC64_ONLY(_stack_arg_slots = align_up(_stack_arg_slots, 2));\n-      S390_ONLY(_stack_arg_slots = align_up(_stack_arg_slots, 2));\n+      _stack_arg_slots = align_up(_stack_arg_slots, 2);\n@@ -259,1 +260,0 @@\n-#if defined(PPC64) || defined(S390)\n@@ -263,0 +263,4 @@\n+#if defined(PPC64) || defined(S390)\n+      _stack_arg_slots += 1;\n+#else\n+      _stack_arg_slots = align_up(_stack_arg_slots, 2);\n@@ -264,0 +268,1 @@\n+#endif \/\/ defined(PPC64) || defined(S390)\n@@ -266,1 +271,0 @@\n-#endif \/\/ defined(PPC64) || defined(S390)\n@@ -271,2 +275,1 @@\n-      PPC64_ONLY(_stack_arg_slots = align_up(_stack_arg_slots, 2));\n-      S390_ONLY(_stack_arg_slots = align_up(_stack_arg_slots, 2));\n+      _stack_arg_slots = align_up(_stack_arg_slots, 2);\n","filename":"src\/hotspot\/share\/runtime\/signature.cpp","additions":12,"deletions":9,"binary":false,"changes":21,"status":"modified"}]}