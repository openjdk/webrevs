{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -61,1 +61,0 @@\n-void (*fp_pw_deinit)(void);\n","filename":"src\/java.desktop\/unix\/native\/libawt_xawt\/awt\/fp_pipewire.h","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -288,0 +288,3 @@\n+        fp_g_main_context_default = dl_symbol(\"g_main_context_default\");\n+        fp_g_main_context_is_owner = dl_symbol(\"g_main_context_is_owner\");\n+\n@@ -559,0 +562,1 @@\n+        fp_gtk_main_level = dl_symbol(\"gtk_main_level\");\n@@ -3125,0 +3129,2 @@\n+    gtk->g_main_context_default = fp_g_main_context_default;\n+    gtk->g_main_context_is_owner = fp_g_main_context_is_owner;\n","filename":"src\/java.desktop\/unix\/native\/libawt_xawt\/awt\/gtk3_interface.c","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -395,0 +395,3 @@\n+static GMainContext *(*fp_g_main_context_default)();\n+static gboolean (*fp_g_main_context_is_owner)(GMainContext* context);\n+\n","filename":"src\/java.desktop\/unix\/native\/libawt_xawt\/awt\/gtk3_interface.h","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -795,0 +795,2 @@\n+    GMainContext *(*g_main_context_default)();\n+    gboolean (*g_main_context_is_owner)(GMainContext* context);\n","filename":"src\/java.desktop\/unix\/native\/libawt_xawt\/awt\/gtk_interface.h","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -52,0 +52,1 @@\n+volatile bool isGtkMainThread = FALSE;\n@@ -135,4 +136,0 @@\n-    if (!sessionClosed) {\n-        fp_pw_deinit();\n-    }\n-\n@@ -584,0 +581,7 @@\n+        if (!pw.loop) {\n+            \/\/ in case someone called the pw_deinit before\n+            DEBUG_SCREENCAST(\"pw_init\\n\", NULL);\n+            fp_pw_init(NULL, NULL);\n+            pw.loop = fp_pw_thread_loop_new(\"AWT Pipewire Thread\", NULL);\n+        }\n+\n@@ -715,1 +719,0 @@\n-    LOAD_SYMBOL(fp_pw_deinit, \"pw_deinit\");\n@@ -949,0 +952,1 @@\n+    isGtkMainThread = gtk->g_main_context_is_owner(gtk->g_main_context_default());\n@@ -950,2 +954,2 @@\n-            \"taking screenshot at \\n\\tx: %5i y %5i w %5i h %5i with token |%s|\\n\",\n-            jx, jy, jwidth, jheight, token\n+            \"taking screenshot at \\n\\tx: %5i y %5i w %5i h %5i\\n\\twith token |%s| isGtkMainThread %d\\n\",\n+            jx, jy, jwidth, jheight, token, isGtkMainThread\n","filename":"src\/java.desktop\/unix\/native\/libawt_xawt\/awt\/screencast_pipewire.c","additions":11,"deletions":7,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+extern volatile bool isGtkMainThread;\n@@ -70,0 +71,21 @@\n+void waitForCallback(struct DBusCallbackHelper *helper) {\n+    if (!helper) {\n+        return;\n+    }\n+\n+    if (isGtkMainThread) {\n+        gtk->gtk_main();\n+    } else {\n+        while (!helper->isDone) {\n+            \/\/ do not block if there is a GTK loop running\n+            gtk->g_main_context_iteration(NULL, gtk->gtk_main_level() == 0);\n+        }\n+    }\n+}\n+\n+void callbackEnd() {\n+    if (isGtkMainThread) {\n+        gtk->gtk_main_quit();\n+    }\n+}\n+\n@@ -365,0 +387,1 @@\n+    callbackEnd();\n@@ -429,3 +452,1 @@\n-        while (!helper.isDone) {\n-            gtk->g_main_context_iteration(NULL, TRUE);\n-        }\n+        waitForCallback(&helper);\n@@ -475,0 +496,2 @@\n+\n+    callbackEnd();\n@@ -555,3 +578,1 @@\n-        while (!helper.isDone) {\n-            gtk->g_main_context_iteration(NULL, TRUE);\n-        }\n+        waitForCallback(&helper);\n@@ -643,0 +664,2 @@\n+\n+    callbackEnd();\n@@ -696,3 +719,1 @@\n-        while (!helper.isDone) {\n-            gtk->g_main_context_iteration(NULL, TRUE);\n-        }\n+        waitForCallback(&helper);\n","filename":"src\/java.desktop\/unix\/native\/libawt_xawt\/awt\/screencast_portal.c","additions":30,"deletions":9,"binary":false,"changes":39,"status":"modified"}]}