{"files":[{"patch":"@@ -34,0 +34,2 @@\n+import java.awt.event.ActionEvent;\n+import java.awt.event.ActionListener;\n@@ -35,0 +37,6 @@\n+import java.awt.event.MouseAdapter;\n+import java.awt.event.MouseEvent;\n+import java.awt.event.WindowAdapter;\n+import java.awt.event.WindowEvent;\n+import java.util.concurrent.CountDownLatch;\n+\n@@ -39,1 +47,6 @@\n-public class bug4490179 {\n+import static java.util.concurrent.TimeUnit.MILLISECONDS;\n+import static java.util.concurrent.TimeUnit.SECONDS;\n+\n+public final class bug4490179\n+        extends MouseAdapter\n+        implements ActionListener {\n@@ -42,4 +55,9 @@\n-    static volatile Point pt;\n-    static volatile int buttonW;\n-    static volatile int buttonH;\n-    static volatile boolean passed = true;\n+\n+    private static volatile Point buttonCenter;\n+\n+    private static final CountDownLatch windowGainedFocus = new CountDownLatch(1);\n+\n+    private static final CountDownLatch mouseButton1Released = new CountDownLatch(1);\n+    private static final CountDownLatch mouseButton3Released = new CountDownLatch(2);\n+\n+    private static final CountDownLatch actionPerformed = new CountDownLatch(1);\n@@ -50,1 +68,2 @@\n-        robot.setAutoWaitForIdle(true);\n+\n+        final bug4490179 eventHandler = new bug4490179();\n@@ -53,1 +72,0 @@\n-                frame = new JFrame(\"bug4490179\");\n@@ -55,0 +73,4 @@\n+                button.addActionListener(eventHandler);\n+                button.addMouseListener(eventHandler);\n+\n+                frame = new JFrame(\"bug4490179\");\n@@ -56,5 +78,5 @@\n-                button.addActionListener(e -> {\n-                    if ((e.getModifiers() & InputEvent.BUTTON1_MASK)\n-                            != InputEvent.BUTTON1_MASK) {\n-                        System.out.println(\"Status: Failed\");\n-                        passed = false;\n+\n+                frame.addWindowFocusListener(new WindowAdapter() {\n+                    @Override\n+                    public void windowGainedFocus(WindowEvent e) {\n+                        windowGainedFocus.countDown();\n@@ -63,0 +85,1 @@\n+\n@@ -68,0 +91,4 @@\n+\n+            if (!windowGainedFocus.await(1, SECONDS)) {\n+                throw new RuntimeException(\"Window didn't gain focus\");\n+            }\n@@ -69,1 +96,1 @@\n-            robot.delay(1000);\n+\n@@ -71,3 +98,3 @@\n-                pt = button.getLocationOnScreen();\n-                buttonW = button.getSize().width;\n-                buttonH = button.getSize().height;\n+                Point location = button.getLocationOnScreen();\n+                buttonCenter = new Point(location.x + button.getWidth() \/ 2,\n+                                         location.y + button.getHeight() \/ 2);\n@@ -76,2 +103,2 @@\n-            robot.mouseMove(pt.x + buttonW \/ 2, pt.y + buttonH \/ 2);\n-            robot.waitForIdle();\n+            robot.mouseMove(buttonCenter.x, buttonCenter.y);\n+            System.out.println(\"Press \/ Release button 3\");\n@@ -81,0 +108,1 @@\n+            System.out.println(\"Press button 1\");\n@@ -82,0 +110,1 @@\n+            System.out.println(\"Press button 3\");\n@@ -83,0 +112,1 @@\n+            System.out.println(\"Release button 3\");\n@@ -84,2 +114,0 @@\n-            robot.mouseRelease(InputEvent.BUTTON1_DOWN_MASK);\n-            robot.delay(500);\n@@ -87,2 +115,20 @@\n-            if (!passed) {\n-                throw new RuntimeException(\"Test Failed\");\n+            try {\n+                if (!mouseButton3Released.await(1, SECONDS)) {\n+                    throw new RuntimeException(\"Mouse button 3 isn't released\");\n+                }\n+\n+                robot.waitForIdle();\n+\n+                if (actionPerformed.await(100, MILLISECONDS)) {\n+                    throw new RuntimeException(\"Action event triggered by releasing button 3\");\n+                }\n+            } finally {\n+                System.out.println(\"Release button 1\");\n+                robot.mouseRelease(InputEvent.BUTTON1_DOWN_MASK);\n+            }\n+\n+            if (!mouseButton1Released.await(1, SECONDS)) {\n+                throw new RuntimeException(\"Mouse button 1 isn't released\");\n+            }\n+            if (!actionPerformed.await(100, MILLISECONDS)) {\n+                throw new RuntimeException(\"Action event isn't triggered by releasing button 1\");\n@@ -98,0 +144,17 @@\n+\n+    @Override\n+    public void actionPerformed(ActionEvent e) {\n+        System.out.println(\"    actionPerformed\");\n+        actionPerformed.countDown();\n+    }\n+\n+    @Override\n+    public void mouseReleased(MouseEvent e) {\n+        if (e.getButton() == MouseEvent.BUTTON1) {\n+            System.out.println(\"    mouseReleased: button 1\");\n+            mouseButton1Released.countDown();\n+        } else if (e.getButton() == MouseEvent.BUTTON3) {\n+            System.out.println(\"    mouseReleased: button 3\");\n+            mouseButton3Released.countDown();\n+        }\n+    }\n","filename":"test\/jdk\/javax\/swing\/JButton\/bug4490179.java","additions":85,"deletions":22,"binary":false,"changes":107,"status":"modified"}]}