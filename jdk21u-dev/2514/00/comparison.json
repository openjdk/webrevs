{"files":[{"patch":"@@ -389,1 +389,6 @@\n-  return attempt_allocation(min_size, requested_size, actual_size);\n+  \/\/ Do not allow a GC because we are allocating a new TLAB to avoid an issue\n+  \/\/ with UseGCOverheadLimit: although this GC would return null if the overhead\n+  \/\/ limit would be exceeded, but it would likely free at least some space.\n+  \/\/ So the subsequent outside-TLAB allocation could be successful anyway and\n+  \/\/ the indication that the overhead limit had been exceeded swallowed.\n+  return attempt_allocation(min_size, requested_size, actual_size, false \/* allow_gc *\/);\n@@ -392,3 +397,2 @@\n-HeapWord*\n-G1CollectedHeap::mem_allocate(size_t word_size,\n-                              bool*  gc_overhead_limit_was_exceeded) {\n+HeapWord* G1CollectedHeap::mem_allocate(size_t word_size,\n+                                        bool*  gc_overhead_limit_was_exceeded) {\n@@ -401,1 +405,1 @@\n-  return attempt_allocation(word_size, word_size, &dummy);\n+  return attempt_allocation(word_size, word_size, &dummy, true \/* allow_gc *\/);\n@@ -404,1 +408,1 @@\n-HeapWord* G1CollectedHeap::attempt_allocation_slow(uint node_index, size_t word_size) {\n+HeapWord* G1CollectedHeap::attempt_allocation_slow(uint node_index, size_t word_size, bool allow_gc) {\n@@ -433,0 +437,2 @@\n+      } else if (!allow_gc) {\n+        return nullptr;\n@@ -634,1 +640,2 @@\n-                                                     size_t* actual_word_size) {\n+                                                     size_t* actual_word_size,\n+                                                     bool allow_gc) {\n@@ -646,1 +653,1 @@\n-    result = attempt_allocation_slow(node_index, desired_word_size);\n+    result = attempt_allocation_slow(node_index, desired_word_size, allow_gc);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CollectedHeap.cpp","additions":15,"deletions":8,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -426,7 +426,3 @@\n-  \/\/   this fails, they will attempt to do an evacuation pause and\n-  \/\/   retry the allocation.\n-  \/\/\n-  \/\/ * If all allocation attempts fail, even after trying to schedule\n-  \/\/   an evacuation pause, allocate_new_tlab() will return null,\n-  \/\/   whereas mem_allocate() will attempt a heap expansion and\/or\n-  \/\/   schedule a Full GC.\n+  \/\/   this fails, (only) mem_allocate() will attempt to do an evacuation\n+  \/\/   pause and retry the allocation. Allocate_new_tlab() will return null,\n+  \/\/   deferring to the following mem_allocate().\n@@ -437,1 +433,1 @@\n-  \/\/   will satisfy them with a special path.\n+  \/\/   will satisfy them in a special path.\n@@ -451,2 +447,2 @@\n-                                      size_t* actual_word_size);\n-\n+                                      size_t* actual_word_size,\n+                                      bool allow_gc);\n@@ -455,2 +451,3 @@\n-  \/\/ pause. This should only be used for non-humongous allocations.\n-  HeapWord* attempt_allocation_slow(uint node_index, size_t word_size);\n+  \/\/ pause if allow_gc is set. This should only be used for non-humongous\n+  \/\/ allocations.\n+  HeapWord* attempt_allocation_slow(uint node_index, size_t word_size, bool allow_gc);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CollectedHeap.hpp","additions":9,"deletions":12,"binary":false,"changes":21,"status":"modified"}]}