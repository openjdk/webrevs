{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -24,0 +24,1 @@\n+import java.awt.EventQueue;\n@@ -32,0 +33,2 @@\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n@@ -38,2 +41,1 @@\n- * @author Alexander Scherbatiy\n- * @run main ScaledTransform\n+ * @run main\/timeout=300 ScaledTransform\n@@ -43,1 +45,5 @@\n-    private static volatile boolean passed = false;\n+    private static volatile CountDownLatch painted;\n+    private static volatile boolean passed;\n+    private static volatile Dialog dialog;\n+    private static volatile long startTime;\n+    private static volatile long endTime;\n@@ -45,1 +51,1 @@\n-    public static void main(String[] args) {\n+    public static void main(String[] args) throws Exception {\n@@ -49,4 +55,0 @@\n-        if (ge.isHeadlessInstance()) {\n-            return;\n-        }\n-\n@@ -54,2 +56,6 @@\n-            for (GraphicsConfiguration gc : gd.getConfigurations()) {\n-                testScaleFactor(gc);\n+            System.out.println(\"Screen = \" + gd);\n+            test(gd.getDefaultConfiguration());\n+            \/* Don't want to run too long. Test the default and up to 10 more *\/\n+            GraphicsConfiguration[] configs = gd.getConfigurations();\n+            for (int c = 0; c < configs.length && c < 10; c++) {\n+                test(configs[c]);\n@@ -60,3 +66,1 @@\n-    private static void testScaleFactor(final GraphicsConfiguration gc) {\n-        final Dialog dialog = new Dialog((Frame) null, \"Test\", true, gc);\n-\n+    static void test(GraphicsConfiguration gc) throws Exception {\n@@ -64,20 +68,11 @@\n-            dialog.setSize(100, 100);\n-            Panel panel = new Panel() {\n-\n-                @Override\n-                public void paint(Graphics g) {\n-                    if (g instanceof Graphics2D) {\n-                        AffineTransform gcTx = gc.getDefaultTransform();\n-                        AffineTransform gTx\n-                                = ((Graphics2D) g).getTransform();\n-                        passed = gcTx.getScaleX() == gTx.getScaleX()\n-                                && gcTx.getScaleY() == gTx.getScaleY();\n-                    } else {\n-                        passed = true;\n-                    }\n-                    dialog.setVisible(false);\n-                }\n-            };\n-            dialog.add(panel);\n-            dialog.setVisible(true);\n-\n+            \/* reset vars for each run *\/\n+            passed = false;\n+            dialog = null;\n+            painted = new CountDownLatch(1);\n+            EventQueue.invokeLater(() -> showDialog(gc));\n+            startTime = System.currentTimeMillis();\n+            endTime = startTime;\n+            if (!painted.await(5, TimeUnit.SECONDS)) {\n+                throw new RuntimeException(\"Panel is not painted!\");\n+            }\n+            System.out.println(\"Time to paint = \" + (endTime - startTime) + \"ms.\");\n@@ -88,1 +83,1 @@\n-            dialog.dispose();\n+            EventQueue.invokeAndWait(() -> disposeDialog());\n@@ -91,0 +86,36 @@\n+\n+    private static void showDialog(final GraphicsConfiguration gc) {\n+        System.out.println(\"Creating dialog for gc=\" + gc + \" with tx=\" + gc.getDefaultTransform());\n+        dialog = new Dialog((Frame) null, \"ScaledTransform\", true, gc);\n+        dialog.setSize(300, 100);\n+\n+        Panel panel = new Panel() {\n+\n+            @Override\n+            public void paint(Graphics g) {\n+                System.out.println(\"Painting panel\");\n+                if (g instanceof Graphics2D g2d) {\n+                    AffineTransform gcTx = gc.getDefaultTransform();\n+                    AffineTransform gTx = g2d.getTransform();\n+                    System.out.println(\"GTX = \" + gTx);\n+                    passed = (gcTx.getScaleX() == gTx.getScaleX()) &&\n+                             (gcTx.getScaleY() == gTx.getScaleY());\n+                } else {\n+                    passed = true;\n+                }\n+                endTime = System.currentTimeMillis();\n+                painted.countDown();\n+                System.out.println(\"Painted panel\");\n+            }\n+        };\n+        dialog.add(panel);\n+        dialog.setVisible(true);\n+    }\n+\n+    private static void disposeDialog() {\n+       if (dialog != null) {\n+           System.out.println(\"Disposing dialog\");\n+           dialog.setVisible(false);\n+           dialog.dispose();\n+       }\n+    }\n","filename":"test\/jdk\/java\/awt\/Graphics2D\/ScaledTransform\/ScaledTransform.java","additions":66,"deletions":35,"binary":false,"changes":101,"status":"modified"}]}