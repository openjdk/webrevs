{"files":[{"patch":"@@ -65,0 +65,41 @@\n+    \/**\n+     * Dynamically allocates two distinct ports using {@linkplain java.net.ServerSocket}\n+     * It keeps each of those ports blocked until it is first accessed by its getter\n+     *\/\n+    private static class PortAllocator {\n+        private final int port1, port2;\n+        private final ServerSocket ss1, ss2;\n+        PortAllocator() {\n+            try {\n+                ss1 = new ServerSocket(0);\n+                ss2 = new ServerSocket(0);\n+                port1 = ss1.getLocalPort();\n+                port2 = ss2.getLocalPort();\n+            } catch (IOException e) {\n+                throw new Error(\"Error while obtaining free ports\", e);\n+            }\n+        }\n+\n+        public int getPort1() {\n+            if (!ss1.isClosed()) {\n+                try {\n+                    ss1.close();\n+                } catch (IOException e) {\n+                    \/\/ just ignore\n+                }\n+            }\n+            return port1;\n+        }\n+\n+        public int getPort2() {\n+            if (!ss2.isClosed()) {\n+                try {\n+                    ss2.close();\n+                } catch (IOException e) {\n+                    \/\/ just ignore\n+                }\n+            }\n+            return port2;\n+        }\n+    }\n+\n@@ -410,2 +451,0 @@\n-    private static final int port1 = 50234;\n-    private static final int port2 = 50235;\n@@ -418,0 +457,1 @@\n+        PortAllocator pa = new PortAllocator();\n@@ -421,1 +461,1 @@\n-            \"-Dcom.sun.management.jmxremote.port=\" + port1,\n+            \"-Dcom.sun.management.jmxremote.port=\" + pa.getPort1(),\n@@ -426,1 +466,1 @@\n-            testConnect(port1);\n+            testConnect(pa.getPort1());\n@@ -429,1 +469,1 @@\n-            testNoConnect(port1);\n+            testNoConnect(pa.getPort1());\n@@ -431,2 +471,2 @@\n-            jcmd(CMD_START, \"jmxremote.port=\" + port2);\n-            testConnect(port2);\n+            jcmd(CMD_START, \"jmxremote.port=\" + pa.getPort2());\n+            testConnect(pa.getPort2());\n@@ -445,0 +485,1 @@\n+        PortAllocator pa = new PortAllocator();\n@@ -447,1 +488,1 @@\n-                \"jmxremote.port=\" + port1,\n+                \"jmxremote.port=\" + pa.getPort1(),\n@@ -451,1 +492,1 @@\n-            testConnect(port1);\n+            testConnect(pa.getPort1());\n@@ -453,0 +494,1 @@\n+\/\/            debugPortUsage(pa);\n@@ -464,0 +506,1 @@\n+        PortAllocator pa = new PortAllocator();\n@@ -466,1 +509,1 @@\n-                \"jmxremote.port=\" + port1,\n+                \"jmxremote.port=\" + pa.getPort1(),\n@@ -472,1 +515,1 @@\n-                \"jmxremote.port=\" + port2,\n+                \"jmxremote.port=\" + pa.getPort2(),\n@@ -477,1 +520,1 @@\n-            testConnect(port1);\n+            testConnect(pa.getPort1());\n@@ -480,1 +523,1 @@\n-            testNoConnect(port2);\n+            testNoConnect(pa.getPort2());\n@@ -493,1 +536,1 @@\n-\n+        PortAllocator pa = new PortAllocator();\n@@ -496,2 +539,2 @@\n-                 \"jmxremote.port=\" + port1,\n-                 \"jmxremote.rmi.port=\" + port2,\n+                 \"jmxremote.port=\" + pa.getPort1(),\n+                 \"jmxremote.rmi.port=\" + pa.getPort2(),\n@@ -501,1 +544,1 @@\n-            testConnect(port1, port2);\n+            testConnect(pa.getPort1(), pa.getPort2());\n@@ -514,0 +557,1 @@\n+        PortAllocator pa = new PortAllocator();\n@@ -517,1 +561,1 @@\n-            testNoConnect(port1);\n+            testNoConnect(pa.getPort1());\n@@ -536,1 +580,1 @@\n-\n+        PortAllocator pa = new PortAllocator();\n@@ -539,1 +583,1 @@\n-                 \"jmxremote.port=\" + port1,\n+                 \"jmxremote.port=\" + pa.getPort1(),\n@@ -543,1 +587,1 @@\n-            testConnect(port1, port2);\n+            testConnect(pa.getPort1(), pa.getPort2());\n@@ -553,1 +597,1 @@\n-                 \"jmxremote.port=\" + port1,\n+                 \"jmxremote.port=\" + pa.getPort1(),\n@@ -564,1 +608,1 @@\n-                \"jmxremote.port=\" + port2,\n+                \"jmxremote.port=\" + pa.getPort2(),\n@@ -581,1 +625,1 @@\n-                \"jmxremote.rmi.port=\" + port2,\n+                \"jmxremote.rmi.port=\" + pa.getPort2(),\n@@ -585,1 +629,1 @@\n-                throw new Exception(\"Starting agent on port \" + port1 + \" should \" +\n+                throw new Exception(\"Starting agent on port \" + pa.getPort1() + \" should \" +\n@@ -589,1 +633,1 @@\n-                throw new Exception(\"Starting agent on poprt \" + port2 + \" should \" +\n+                throw new Exception(\"Starting agent on poprt \" + pa.getPort2() + \" should \" +\n@@ -612,0 +656,1 @@\n+        PortAllocator pa = new PortAllocator();\n@@ -614,1 +659,1 @@\n-            testNoConnect(port1);\n+            testNoConnect(pa.getPort1());\n@@ -617,1 +662,1 @@\n-                \"jmxremote.port=\" + port2,\n+                \"jmxremote.port=\" + pa.getPort2(),\n@@ -621,1 +666,1 @@\n-            testConnect(port2);\n+            testConnect(pa.getPort2());\n@@ -634,0 +679,1 @@\n+        PortAllocator pa = new PortAllocator();\n@@ -637,1 +683,1 @@\n-            \"-Dcom.sun.management.jmxremote.port=\" + port1,\n+            \"-Dcom.sun.management.jmxremote.port=\" + pa.getPort1(),\n@@ -642,1 +688,1 @@\n-            testNoConnect(port1);\n+            testNoConnect(pa.getPort1());\n@@ -646,1 +692,1 @@\n-            testNoConnect(port1);\n+            testNoConnect(pa.getPort1());\n@@ -650,1 +696,1 @@\n-                \"jmxremote.port=\" + port2,\n+                \"jmxremote.port=\" + pa.getPort2(),\n@@ -655,1 +701,1 @@\n-            testConnect(port2);\n+            testConnect(pa.getPort2());\n@@ -676,0 +722,1 @@\n+        PortAllocator pa = new PortAllocator();\n@@ -678,1 +725,1 @@\n-            testNoConnect(port1);\n+            testNoConnect(pa.getPort1());\n@@ -682,1 +729,1 @@\n-            testNoConnect(port1);\n+            testNoConnect(pa.getPort1());\n@@ -688,1 +735,1 @@\n-                \"jmxremote.port=\" + port2\n+                \"jmxremote.port=\" + pa.getPort2()\n@@ -691,1 +738,1 @@\n-            testConnect(port2);\n+            testConnect(pa.getPort2());\n@@ -705,0 +752,1 @@\n+        PortAllocator pa = new PortAllocator();\n@@ -708,1 +756,1 @@\n-            \"-Dcom.sun.management.jmxremote.port=\" + port1,\n+            \"-Dcom.sun.management.jmxremote.port=\" + pa.getPort1(),\n@@ -713,1 +761,1 @@\n-            testNoConnect(port1);\n+            testNoConnect(pa.getPort1());\n@@ -718,1 +766,1 @@\n-                \"jmxremote.port=\" + port1\n+                \"jmxremote.port=\" + pa.getPort1()\n@@ -724,1 +772,1 @@\n-                \"jmxremote.port=\" + port1\n+                \"jmxremote.port=\" + pa.getPort1()\n@@ -727,1 +775,1 @@\n-            testNoConnect(port1);\n+            testNoConnect(pa.getPort1());\n@@ -739,0 +787,1 @@\n+        PortAllocator pa = new PortAllocator();\n@@ -742,1 +791,1 @@\n-            \"-Dcom.sun.management.jmxremote.port=\" + port1,\n+            \"-Dcom.sun.management.jmxremote.port=\" + pa.getPort1(),\n@@ -746,1 +795,1 @@\n-            testConnect(port1);\n+            testConnect(pa.getPort1());\n@@ -761,0 +810,1 @@\n+        PortAllocator pa = new PortAllocator();\n@@ -763,1 +813,1 @@\n-            testNoConnect(port1);\n+            testNoConnect(pa.getPort1());\n","filename":"jdk\/test\/sun\/management\/jmxremote\/startstop\/JMXStartStopTest.java","additions":96,"deletions":46,"binary":false,"changes":142,"status":"modified"}]}