{"files":[{"patch":"@@ -272,0 +272,3 @@\n+    virtual jlong rss_usage_in_bytes() = 0;\n+    virtual jlong cache_usage_in_bytes() = 0;\n+\n@@ -278,0 +281,2 @@\n+\n+    virtual void print_version_specific_info(outputStream* st) = 0;\n","filename":"hotspot\/src\/os\/linux\/vm\/cgroupSubsystem_linux.hpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -204,0 +204,43 @@\n+jlong CgroupV1Subsystem::rss_usage_in_bytes() {\n+  GET_CONTAINER_INFO_LINE(julong, _memory->controller(), \"\/memory.stat\",\n+                          \"rss\", JULONG_FORMAT, JULONG_FORMAT, rss);\n+  return rss;\n+}\n+\n+jlong CgroupV1Subsystem::cache_usage_in_bytes() {\n+  GET_CONTAINER_INFO_LINE(julong, _memory->controller(), \"\/memory.stat\",\n+                          \"cache\", JULONG_FORMAT, JULONG_FORMAT, cache);\n+  return cache;\n+}\n+\n+jlong CgroupV1Subsystem::kernel_memory_usage_in_bytes() {\n+  GET_CONTAINER_INFO(jlong, _memory->controller(), \"\/memory.kmem.usage_in_bytes\",\n+                     \"Kernel Memory Usage is: \" JLONG_FORMAT, JLONG_FORMAT, kmem_usage);\n+  return kmem_usage;\n+}\n+\n+jlong CgroupV1Subsystem::kernel_memory_limit_in_bytes() {\n+  GET_CONTAINER_INFO(julong, _memory->controller(), \"\/memory.kmem.limit_in_bytes\",\n+                     \"Kernel Memory Limit is: \" JULONG_FORMAT, JULONG_FORMAT, kmem_limit);\n+  if (kmem_limit >= os::Linux::physical_memory()) {\n+    return (jlong)-1;\n+  }\n+  return (jlong)kmem_limit;\n+}\n+\n+jlong CgroupV1Subsystem::kernel_memory_max_usage_in_bytes() {\n+  GET_CONTAINER_INFO(jlong, _memory->controller(), \"\/memory.kmem.max_usage_in_bytes\",\n+                     \"Maximum Kernel Memory Usage is: \" JLONG_FORMAT, JLONG_FORMAT, kmem_max_usage);\n+  return kmem_max_usage;\n+}\n+\n+void CgroupV1Subsystem::print_version_specific_info(outputStream* st) {\n+  jlong kmem_usage = kernel_memory_usage_in_bytes();\n+  jlong kmem_limit = kernel_memory_limit_in_bytes();\n+  jlong kmem_max_usage = kernel_memory_max_usage_in_bytes();\n+\n+  OSContainer::print_container_helper(st, kmem_usage, \"kernel_memory_usage_in_bytes\");\n+  OSContainer::print_container_helper(st, kmem_limit, \"kernel_memory_max_usage_in_bytes\");\n+  OSContainer::print_container_helper(st, kmem_max_usage, \"kernel_memory_limit_in_bytes\");\n+}\n+\n","filename":"hotspot\/src\/os\/linux\/vm\/cgroupV1Subsystem_linux.cpp","additions":44,"deletions":1,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -82,0 +82,7 @@\n+    jlong rss_usage_in_bytes();\n+    jlong cache_usage_in_bytes();\n+\n+    jlong kernel_memory_usage_in_bytes();\n+    jlong kernel_memory_limit_in_bytes();\n+    jlong kernel_memory_max_usage_in_bytes();\n+\n@@ -90,0 +97,2 @@\n+    void print_version_specific_info(outputStream* st);\n+\n","filename":"hotspot\/src\/os\/linux\/vm\/cgroupV1Subsystem_linux.hpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -163,0 +163,12 @@\n+jlong CgroupV2Subsystem::rss_usage_in_bytes() {\n+  GET_CONTAINER_INFO_LINE(julong, _memory->controller(), \"\/memory.stat\",\n+                          \"anon\", JULONG_FORMAT, JULONG_FORMAT, rss);\n+  return rss;\n+}\n+\n+jlong CgroupV2Subsystem::cache_usage_in_bytes() {\n+  GET_CONTAINER_INFO_LINE(julong, _memory->controller(), \"\/memory.stat\",\n+                          \"file\", JULONG_FORMAT, JULONG_FORMAT, cache);\n+  return cache;\n+}\n+\n@@ -197,0 +209,10 @@\n+\/\/ memory.swap.current : total amount of swap currently used by the cgroup and its descendants\n+char* CgroupV2Subsystem::mem_swp_current_val() {\n+  GET_CONTAINER_INFO_CPTR(cptr, _unified, \"\/memory.swap.current\",\n+                         \"Swap currently used is: %s\", \"%s\", mem_swp_current_str, 1024);\n+  if (mem_swp_current_str == NULL) {\n+    return NULL;\n+  }\n+  return os::strdup(mem_swp_current_str);\n+}\n+\n@@ -245,0 +267,11 @@\n+void CgroupV2Subsystem::print_version_specific_info(outputStream* st) {\n+  char* mem_swp_current_str = mem_swp_current_val();\n+  jlong swap_current = limit_from_str(mem_swp_current_str);\n+\n+  char* mem_swp_limit_str = mem_swp_limit_val();\n+  jlong swap_limit = limit_from_str(mem_swp_limit_str);\n+\n+  OSContainer::print_container_helper(st, swap_current, \"memory_swap_current_in_bytes\");\n+  OSContainer::print_container_helper(st, swap_limit, \"memory_swap_max_limit_in_bytes\");\n+}\n+\n","filename":"hotspot\/src\/os\/linux\/vm\/cgroupV2Subsystem_linux.cpp","additions":33,"deletions":0,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Red Hat Inc.\n+ * Copyright (c) 2020, 2022, Red Hat Inc.\n@@ -61,0 +61,1 @@\n+    char *mem_swp_current_val();\n@@ -80,0 +81,3 @@\n+    jlong rss_usage_in_bytes();\n+    jlong cache_usage_in_bytes();\n+\n@@ -82,0 +86,3 @@\n+\n+    void print_version_specific_info(outputStream* st);\n+\n","filename":"hotspot\/src\/os\/linux\/vm\/cgroupV2Subsystem_linux.hpp","additions":8,"deletions":1,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -107,0 +107,15 @@\n+jlong OSContainer::rss_usage_in_bytes() {\n+  assert(cgroup_subsystem != NULL, \"cgroup subsystem not available\");\n+  return cgroup_subsystem->rss_usage_in_bytes();\n+}\n+\n+jlong OSContainer::cache_usage_in_bytes() {\n+  assert(cgroup_subsystem != NULL, \"cgroup subsystem not available\");\n+  return cgroup_subsystem->cache_usage_in_bytes();\n+}\n+\n+void OSContainer::print_version_specific_info(outputStream* st) {\n+  assert(cgroup_subsystem != NULL, \"cgroup subsystem not available\");\n+  cgroup_subsystem->print_version_specific_info(st);\n+}\n+\n@@ -136,0 +151,13 @@\n+\n+void OSContainer::print_container_helper(outputStream* st, jlong j, const char* metrics) {\n+  st->print(\"%s: \", metrics);\n+  if (j > 0) {\n+    if (j >= 1024) {\n+      st->print_cr(UINT64_FORMAT \" k\", uint64_t(j) \/ 1024);\n+    } else {\n+      st->print_cr(UINT64_FORMAT, uint64_t(j));\n+    }\n+  } else {\n+    st->print_cr(\"%s\", j == OSCONTAINER_ERROR ? \"not supported\" : \"unlimited\");\n+  }\n+}\n","filename":"hotspot\/src\/os\/linux\/vm\/osContainer_linux.cpp","additions":29,"deletions":1,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+#include \"utilities\/ostream.hpp\"\n@@ -46,0 +47,3 @@\n+  static void print_version_specific_info(outputStream* st);\n+  static void print_container_helper(outputStream* st, jlong j, const char* metrics);\n+\n@@ -54,0 +58,2 @@\n+  static jlong rss_usage_in_bytes();\n+  static jlong cache_usage_in_bytes();\n","filename":"hotspot\/src\/os\/linux\/vm\/osContainer_linux.hpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2303,1 +2303,1 @@\n-  st->print(\"container_type: %s\\n\", p_ct != NULL ? p_ct : \"failed\");\n+  st->print(\"container_type: %s\\n\", p_ct != NULL ? p_ct : \"not supported\");\n@@ -2306,1 +2306,1 @@\n-  st->print(\"cpu_cpuset_cpus: %s\\n\", p != NULL ? p : \"failed\");\n+  st->print(\"cpu_cpuset_cpus: %s\\n\", p != NULL ? p : \"not supported\");\n@@ -2310,1 +2310,1 @@\n-  st->print(\"cpu_memory_nodes: %s\\n\", p != NULL ? p : \"failed\");\n+  st->print(\"cpu_memory_nodes: %s\\n\", p != NULL ? p : \"not supported\");\n@@ -2314,0 +2314,1 @@\n+  st->print(\"active_processor_count: \");\n@@ -2315,1 +2316,1 @@\n-    st->print(\"active_processor_count: %d\\n\", i);\n+    st->print(\"%d\\n\", i);\n@@ -2317,1 +2318,1 @@\n-    st->print(\"active_processor_count: failed\\n\");\n+    st->print(\"not supported\\n\");\n@@ -2321,1 +2322,6 @@\n-  st->print(\"cpu_quota: %d\\n\", i);\n+  st->print(\"cpu_quota: \");\n+  if (i > 0) {\n+    st->print(\"%d\\n\", i);\n+  } else {\n+    st->print(\"%s\\n\", i == OSCONTAINER_ERROR ? \"not supported\" : \"no quota\");\n+  }\n@@ -2324,1 +2330,6 @@\n-  st->print(\"cpu_period: %d\\n\", i);\n+  st->print(\"cpu_period: \");\n+  if (i > 0) {\n+    st->print(\"%d\\n\", i);\n+  } else {\n+    st->print(\"%s\\n\", i == OSCONTAINER_ERROR ? \"not supported\" : \"no period\");\n+  }\n@@ -2327,7 +2338,6 @@\n-  st->print(\"cpu_shares: %d\\n\", i);\n-\n-  jlong j = OSContainer::memory_limit_in_bytes();\n-  st->print(\"memory_limit_in_bytes: \" JLONG_FORMAT \"\\n\", j);\n-\n-  j = OSContainer::memory_and_swap_limit_in_bytes();\n-  st->print(\"memory_and_swap_limit_in_bytes: \" JLONG_FORMAT \"\\n\", j);\n+  st->print(\"cpu_shares: \");\n+  if (i > 0) {\n+    st->print(\"%d\\n\", i);\n+  } else {\n+    st->print(\"%s\\n\", i == OSCONTAINER_ERROR ? \"not supported\" : \"no shares\");\n+  }\n@@ -2335,2 +2345,7 @@\n-  j = OSContainer::memory_soft_limit_in_bytes();\n-  st->print(\"memory_soft_limit_in_bytes: \" JLONG_FORMAT \"\\n\", j);\n+  OSContainer::print_container_helper(st, OSContainer::memory_limit_in_bytes(), \"memory_limit_in_bytes\");\n+  OSContainer::print_container_helper(st, OSContainer::memory_and_swap_limit_in_bytes(), \"memory_and_swap_limit_in_bytes\");\n+  OSContainer::print_container_helper(st, OSContainer::memory_soft_limit_in_bytes(), \"memory_soft_limit_in_bytes\");\n+  OSContainer::print_container_helper(st, OSContainer::memory_usage_in_bytes(), \"memory_usage_in_bytes\");\n+  OSContainer::print_container_helper(st, OSContainer::memory_max_usage_in_bytes(), \"memory_max_usage_in_bytes\");\n+  OSContainer::print_container_helper(st, OSContainer::rss_usage_in_bytes(), \"rss_usage_in_bytes\");\n+  OSContainer::print_container_helper(st, OSContainer::cache_usage_in_bytes(), \"cache_usage_in_bytes\");\n@@ -2338,2 +2353,1 @@\n-  j = OSContainer::OSContainer::memory_usage_in_bytes();\n-  st->print(\"memory_usage_in_bytes: \" JLONG_FORMAT \"\\n\", j);\n+  OSContainer::print_version_specific_info(st);\n@@ -2341,2 +2355,0 @@\n-  j = OSContainer::OSContainer::memory_max_usage_in_bytes();\n-  st->print(\"memory_max_usage_in_bytes: \" JLONG_FORMAT \"\\n\", j);\n","filename":"hotspot\/src\/os\/linux\/vm\/os_linux.cpp","additions":32,"deletions":20,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -105,1 +105,3 @@\n-            \"memory_max_usage_in_bytes\"\n+            \"memory_max_usage_in_bytes\",\n+            \"rss_usage_in_bytes\",\n+            \"cache_usage_in_bytes\"\n@@ -111,0 +113,13 @@\n+        String str = out.getOutput();\n+        if (str.contains(\"cgroupv1\")) {\n+            out.shouldContain(\"kernel_memory_usage_in_bytes\");\n+            out.shouldContain(\"kernel_memory_max_usage_in_bytes\");\n+            out.shouldContain(\"kernel_memory_limit_in_bytes\");\n+        } else {\n+            if (str.contains(\"cgroupv2\")) {\n+                out.shouldContain(\"memory_swap_current_in_bytes\");\n+                out.shouldContain(\"memory_swap_max_limit_in_bytes\");\n+            } else {\n+                throw new RuntimeException(\"Output has to contain information about cgroupv1 or cgroupv2\");\n+            }\n+        }\n","filename":"hotspot\/test\/runtime\/containers\/docker\/TestMisc.java","additions":16,"deletions":1,"binary":false,"changes":17,"status":"modified"}]}