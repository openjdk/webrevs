{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2013, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2018, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug     4858522\n+ * @bug     4858522 8174734\n@@ -44,3 +44,36 @@\n-    \/\/ Careful with these values.\n-    private static final long MIN_VALUE_FOR_PASS = 1;\n-    private static final long MAX_VALUE_FOR_PASS = Long.MAX_VALUE;\n+    static void checkPositive(long value, String label) {\n+        if (value < 0)\n+            throw new RuntimeException(label + \" had a negative value of \"\n+                                       + value);\n+    }\n+\n+    static void validate(long count1, long count2, long time1, long time2,\n+                         String label) {\n+        checkPositive(count1, label + \":count1\");\n+        checkPositive(count2, label + \":count2\");\n+        checkPositive(time1, label + \":time1\");\n+        checkPositive(time2, label + \":time2\");\n+\n+        long countDiff = count2 - count1;\n+        long timeDiff = time2 - time1;\n+\n+        if (countDiff < NUM_THREAD_DUMPS) {\n+            throw new RuntimeException(label +\n+                                       \": Expected at least \" + NUM_THREAD_DUMPS +\n+                                       \" safepoints but only got \" + countDiff);\n+        }\n+\n+        \/\/ getSafepointSyncTime is the accumulated time spent getting to a\n+        \/\/ safepoint, so each safepoint will add a little to this, but the\n+        \/\/ resolution is only milliseconds so we may not see it.\n+        if (timeDiff < 0) {\n+            throw new RuntimeException(label + \": Safepoint sync time \" +\n+                                       \"decreased unexpectedly \" +\n+                                       \"(time1 = \" + time1 + \"; \" +\n+                                       \"time2 = \" + time2 + \")\");\n+        }\n+\n+        System.out.format(\"%s: Safepoint count=%d (diff=%d), sync time=%d ms (diff=%d)%n\",\n+                          label, count2, countDiff, time2, timeDiff);\n+\n+    }\n@@ -50,1 +83,6 @@\n-        long value = mbean.getSafepointSyncTime();\n+        long time = mbean.getSafepointSyncTime();\n+\n+        checkPositive(count, \"count\");\n+        checkPositive(time, \"time\");\n+\n+        \/\/ Thread.getAllStackTraces() should cause a safepoint.\n@@ -52,3 +90,0 @@\n-        \/\/ Thread.getAllStackTraces() should cause safepoints.\n-        \/\/ If this test is failing because it doesn't,\n-        \/\/ MIN_VALUE_FOR_PASS should be reset to 0\n@@ -60,1 +95,1 @@\n-        long value1 = mbean.getSafepointSyncTime();\n+        long time1 = mbean.getSafepointSyncTime();\n@@ -62,2 +97,1 @@\n-        System.out.format(\"Safepoint count=%d (diff=%d), sync time=%d ms (diff=%d)%n\",\n-                          count1, count1-count, value1, value1-value);\n+        validate(count, count1, time, time1, \"Pass 1\");\n@@ -65,6 +99,1 @@\n-        if (value1 < MIN_VALUE_FOR_PASS || value1 > MAX_VALUE_FOR_PASS) {\n-            throw new RuntimeException(\"Safepoint sync time \" +\n-                                       \"illegal value: \" + value1 + \" ms \" +\n-                                       \"(MIN = \" + MIN_VALUE_FOR_PASS + \"; \" +\n-                                       \"MAX = \" + MAX_VALUE_FOR_PASS + \")\");\n-        }\n+        \/\/ repeat the experiment\n@@ -77,4 +106,1 @@\n-        long value2 = mbean.getSafepointSyncTime();\n-\n-        System.out.format(\"Safepoint count=%d (diff=%d), sync time=%d ms (diff=%d)%n\",\n-                          count2, count2-count1, value2, value2-value1);\n+        long time2 = mbean.getSafepointSyncTime();\n@@ -82,6 +108,1 @@\n-        if (value2 <= value1) {\n-            throw new RuntimeException(\"Safepoint sync time \" +\n-                                       \"did not increase \" +\n-                                       \"(value1 = \" + value1 + \"; \" +\n-                                       \"value2 = \" + value2 + \")\");\n-        }\n+        validate(count1, count2, time1, time2, \"Pass 2\");\n","filename":"jdk\/test\/sun\/management\/HotspotRuntimeMBean\/GetSafepointSyncTime.java","additions":49,"deletions":28,"binary":false,"changes":77,"status":"modified"}]}