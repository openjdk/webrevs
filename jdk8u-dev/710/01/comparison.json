{"files":[{"patch":"@@ -4,1 +4,1 @@\n-version=openjdk8u472\n+version=openjdk8u482\n","filename":".jcheck\/conf","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1728,1 +1728,1 @@\n-%% This notice is provided with respect to Little CMS 2.12, which may be\n+%% This notice is provided with respect to Little CMS 2.14, which may be\n@@ -1733,0 +1733,6 @@\n+README.1ST file information\n+\n+LittleCMS core is released under MIT License\n+\n+---------------------------------\n+\n@@ -1734,1 +1740,1 @@\n-Copyright (c) 1998-2020 Marti Maria Saguer\n+Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -1736,6 +1742,7 @@\n-Permission is hereby granted, free of charge, to any person obtaining a copy\n-of this software and associated documentation files (the \"Software\"), to deal\n-in the Software without restriction, including without limitation the rights\n-to use, copy, modify, merge, publish, distribute, sublicense, and\/or sell\n-copies of the Software, and to permit persons to whom the Software is\n-furnished to do so, subject to the following conditions:\n+Permission is hereby granted, free of charge, to any person obtaining\n+a copy of this software and associated documentation files (the\n+\"Software\"), to deal in the Software without restriction, including\n+without limitation the rights to use, copy, modify, merge, publish,\n+distribute, sublicense, and\/or sell copies of the Software, and to\n+permit persons to whom the Software is furnished to do so, subject\n+to the following conditions:\n@@ -1743,2 +1750,79 @@\n-The above copyright notice and this permission notice shall be included in all\n-copies or substantial portions of the Software.\n+The above copyright notice and this permission notice shall be\n+included in all copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,\n+EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n+MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.\n+IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY\n+CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,\n+TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE\n+SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n+\n+---------------------------------\n+\n+The below license applies to the following files:\n+liblcms\/cmssm.c\n+\n+Copyright 2001, softSurfer (www.softsurfer.com)\n+\n+This code may be freely used and modified for any purpose\n+providing that this copyright notice is included with it.\n+SoftSurfer makes no warranty for this code, and cannot be held\n+liable for any real or imagined damage resulting from its use.\n+Users of this code must verify correctness for their application.\n+\n+\n+AUTHORS File Information:\n+\n+Main Author\n+------------\n+Marti Maria\n+\n+\n+Contributors\n+------------\n+Bob Friesenhahn\n+Kai-Uwe Behrmann\n+Stuart Nixon\n+Jordi Vilar\n+Richard Hughes\n+Auke Nauta\n+Chris Evans (Google)\n+Lorenzo Ridolfi\n+Robin Watts (Artifex)\n+Shawn Pedersen\n+Andrew Brygin\n+Samuli Suominen\n+Florian Hˆch\n+Aurelien Jarno\n+Claudiu Cebuc\n+Michael Vhrel (Artifex)\n+Michal Cihar\n+Daniel Kaneider\n+Mateusz Jurczyk (Google)\n+Paul Miller\n+SÈbastien LÈon\n+Christian Schmitz\n+XhmikosR\n+Stanislav Brabec (SuSe)\n+Leonhard Gruenschloss (Google)\n+Patrick Noffke\n+Christopher James Halse Rogers\n+John Hein\n+Thomas Weber (Debian)\n+Mark Allen\n+Noel Carboni\n+Sergei Trofimovic\n+Philipp Knechtges\n+\n+Special Thanks\n+--------------\n+Artifex software\n+AlienSkin software\n+Jan Morovic\n+Jos Vernon (WebSupergoo)\n+Harald Schneider (Maxon)\n+Christian Albrecht\n+Dimitrios Anastassakis\n+Lemke Software\n+Tim Zaman\n@@ -1746,7 +1830,0 @@\n-THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n-IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n-FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n-AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n-LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n-OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n-SOFTWARE.\n","filename":"THIRD_PARTY_README","additions":94,"deletions":17,"binary":false,"changes":111,"status":"modified"},{"patch":"@@ -29,1 +29,1 @@\n-JDK_UPDATE_VERSION=472\n+JDK_UPDATE_VERSION=482\n","filename":"common\/autoconf\/version-numbers","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1710,1 +1710,1 @@\n-  \/\/ Smashes rscratch1.\n+  \/\/ Smashes rscratch1, rscratch2.\n@@ -2140,0 +2140,4 @@\n+\n+    \/\/ Registers used as temps\n+    const Register dst_klass  = c_rarg5;\n+\n@@ -2345,2 +2349,1 @@\n-      const Register rscratch2_dst_klass = rscratch2;\n-      __ load_klass(rscratch2_dst_klass, dst); \/\/ reload\n+      __ load_klass(dst_klass, dst); \/\/ reload\n@@ -2356,1 +2359,1 @@\n-                                 rscratch2_dst_klass, scratch_src_klass);\n+                                 dst_klass, scratch_src_klass);\n@@ -2361,3 +2364,4 @@\n-      __ ldrw(sco_temp, Address(rscratch2_dst_klass, sco_offset));\n-      \/\/ assert_clean_int(sco_temp, r18);\n-      generate_type_check(scratch_src_klass, sco_temp, rscratch2_dst_klass, L_plain_copy);\n+      __ ldrw(sco_temp, Address(dst_klass, sco_offset));\n+\n+      \/\/ Smashes rscratch1, rscratch2\n+      generate_type_check(scratch_src_klass, sco_temp, dst_klass, L_plain_copy);\n@@ -2367,2 +2371,2 @@\n-      __ ldr(rscratch2_dst_klass, Address(rscratch2_dst_klass, ek_offset));\n-      __ ldrw(sco_temp, Address(rscratch2_dst_klass, sco_offset));\n+      __ ldr(dst_klass, Address(dst_klass, ek_offset));\n+      __ ldrw(sco_temp, Address(dst_klass, sco_offset));\n@@ -2373,1 +2377,1 @@\n-      __ mov(c_rarg4, rscratch2_dst_klass);  \/\/ dst.klass.element_klass\n+      __ mov(c_rarg4, dst_klass);  \/\/ dst.klass.element_klass\n","filename":"hotspot\/src\/cpu\/aarch64\/vm\/stubGenerator_aarch64.cpp","additions":14,"deletions":10,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2013, 2014, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -37,1 +37,1 @@\n-  static const int BUFFER_LEN = 1024;\n+  static const int BUFFER_LEN = 1024*3;\n@@ -44,0 +44,4 @@\n+    if (_cur >= BUFFER_LEN) {\n+      DEBUG_ONLY(warning(\"previous LineBuffer overflow, request ignored\");)\n+      return;\n+    }\n","filename":"hotspot\/src\/share\/vm\/gc_implementation\/g1\/g1GCPhaseTimes.cpp","additions":6,"deletions":2,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -1893,7 +1893,11 @@\n-  JvmtiThreadState* state = JvmtiThreadState::state_for(JavaThread::current());\n-  \/\/ state can only be NULL if the current thread is exiting which\n-  \/\/ should not happen since we're trying to post an event\n-  guarantee(state != NULL, \"attempt to register stub via an exiting thread\");\n-  JvmtiDynamicCodeEventCollector* collector = state->get_dynamic_code_event_collector();\n-  guarantee(collector != NULL, \"attempt to register stub without event collector\");\n-  collector->register_stub(name, code_begin, code_end);\n+  \/\/ Cannot take safepoint here so do not use state_for to get\n+  \/\/ jvmti thread state.\n+  \/\/ The collector and\/or state might be NULL if JvmtiDynamicCodeEventCollector\n+  \/\/ has been initialized while JVMTI_EVENT_DYNAMIC_CODE_GENERATED was disabled.\n+  JvmtiThreadState* state = JavaThread::current()->jvmti_thread_state();\n+  if (state != NULL) {\n+    JvmtiDynamicCodeEventCollector *collector = state->get_dynamic_code_event_collector();\n+    if (collector != NULL) {\n+      collector->register_stub(name, code_begin, code_end);\n+    }\n+  }\n","filename":"hotspot\/src\/share\/vm\/prims\/jvmtiExport.cpp","additions":11,"deletions":7,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (C) 2020 THL A29 Limited, a Tencent company. All rights reserved.\n+ * Copyright (C) 2020, Tencent. All rights reserved.\n","filename":"hotspot\/test\/compiler\/unsafe\/TestMisalignedUnsafeAccess.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,51 @@\n+\/*\n+ * Copyright (c) 2021, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+public class DynamicCodeGenerated {\n+    static {\n+        System.loadLibrary(\"DynamicCodeGenerated\");\n+    }\n+    public static native void changeEventNotificationMode();\n+\n+    public static void main(String[] args) {\n+        \/\/ Try to enable DynamicCodeGenerated event while it is posted\n+        \/\/ using JvmtiDynamicCodeEventCollector from VtableStubs::find_stub\n+        Thread t = new Thread(() -> {\n+            changeEventNotificationMode();\n+        });\n+        t.setDaemon(true);\n+        t.start();\n+\n+        for (int i = 0; i < 2000; i++) {\n+            new Thread(() -> {\n+                String result = \"string\" + System.currentTimeMillis();\n+\n+                \/\/ Keep a reference to result\n+                if (result.hashCode() == System.currentTimeMillis()) {\n+                    \/\/ Shouldn't happen\n+                    return;\n+                }\n+            }).start();\n+        }\n+    }\n+}\n","filename":"hotspot\/test\/serviceability\/jvmti\/DynamicCodeGenerated\/DynamicCodeGenerated.java","additions":51,"deletions":0,"binary":false,"changes":51,"status":"added"},{"patch":"@@ -0,0 +1,82 @@\n+#!\/bin\/sh\n+\n+# Copyright (c) 2012, 2025, Oracle and\/or its affiliates. All rights reserved.\n+# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+#\n+# This code is free software; you can redistribute it and\/or modify it\n+# under the terms of the GNU General Public License version 2 only, as\n+# published by the Free Software Foundation.\n+#\n+# This code is distributed in the hope that it will be useful, but WITHOUT\n+# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+# version 2 for more details (a copy is included in the LICENSE file that\n+# accompanied this code).\n+#\n+# You should have received a copy of the GNU General Public License version\n+# 2 along with this work; if not, write to the Free Software Foundation,\n+# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+#\n+# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+# or visit www.oracle.com if you need additional information or have any\n+# questions.\n+\n+# @test DynamicCodeGeneratedTest.sh\n+# @bug 8212155\n+# @summary Test concurrent enabling and posting of DynamicCodeGenerated events.\n+# @run shell DynamicCodeGeneratedTest.sh\n+\n+if [ \"$TESTSRC\" = \"\" ]\n+then TESTSRC=.\n+fi\n+\n+if [ \"$TESTJAVA\" = \"\" ]\n+then\n+  PARENT=$(dirname $(which java))\n+  TESTJAVA=$(dirname $PARENT)\n+  echo \"TESTJAVA not set, selecting \" $TESTJAVA\n+  echo \"If this is incorrect, try setting the variable manually.\"\n+fi\n+\n+# set platform-dependent variables\n+OS=$(uname -s)\n+case \"$OS\" in\n+  Linux )\n+    ARCHFLAG=\n+    $TESTJAVA\/bin\/java -version 2>&1 | grep '64-Bit' > \/dev\/null\n+    if [ $? -eq '0' ]\n+    then\n+        ARCH=\"amd64\"\n+    else\n+        ARCH=\"i386\"\n+        ARCHFLAG=\"-m32 -march=i386\"\n+    fi\n+    ;;\n+  * )\n+    echo \"Test passed, unrecognized system.\"\n+    exit 0;\n+    ;;\n+esac\n+\n+echo \"OS-ARCH is\" linux-$ARCH\n+$TESTJAVA\/jre\/bin\/java -fullversion 2>&1\n+\n+which gcc >\/dev\/null 2>&1\n+if [ \"$?\" -ne '0' ]\n+then\n+    echo \"No C compiler found. Test passed.\"\n+    exit 0\n+fi\n+\n+JAVA=$TESTJAVA\/jre\/bin\/java\n+JAVAC=$TESTJAVA\/bin\/javac\n+JAVAH=$TESTJAVA\/bin\/javah\n+\n+$JAVAC -d . $TESTSRC\/DynamicCodeGenerated.java\n+$JAVAH -jni -classpath . -d . DynamicCodeGenerated\n+\n+gcc --shared $ARCHFLAG -fPIC -O -I$TESTJAVA\/include -I$TESTJAVA\/include\/linux -I. -o libDynamicCodeGenerated.so $TESTSRC\/libDynamicCodeGenerated.cpp\n+\n+LD_LIBRARY_PATH=. $JAVA -classpath . -agentlib:DynamicCodeGenerated DynamicCodeGenerated\n+\n+exit $?\n","filename":"hotspot\/test\/serviceability\/jvmti\/DynamicCodeGenerated\/DynamicCodeGeneratedTest.sh","additions":82,"deletions":0,"binary":false,"changes":82,"status":"added"},{"patch":"@@ -0,0 +1,57 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#include <string.h>\n+#include <jvmti.h>\n+\n+static jvmtiEnv* jvmti = NULL;\n+\n+#ifdef __cplusplus\n+extern \"C\" {\n+#endif\n+\n+JNIEXPORT\n+void JNICALL Java_DynamicCodeGenerated_changeEventNotificationMode(JNIEnv* jni, jclass cls) {\n+  while (true) {\n+    jvmti->SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_DYNAMIC_CODE_GENERATED, NULL);\n+    jvmti->SetEventNotificationMode(JVMTI_DISABLE, JVMTI_EVENT_DYNAMIC_CODE_GENERATED, NULL);\n+  }\n+}\n+\n+#ifdef __cplusplus\n+}\n+#endif\n+\n+void JNICALL DynamicCodeGenerated(jvmtiEnv* jvmti, const char* name, const void* address, jint length) {\n+\n+}\n+\n+jint Agent_OnLoad(JavaVM* vm, char* options, void* reserved) {\n+    vm->GetEnv((void**)&jvmti, JVMTI_VERSION_1_0);\n+    jvmtiEventCallbacks callbacks;\n+    memset(&callbacks, 0, sizeof(callbacks));\n+    callbacks.DynamicCodeGenerated = DynamicCodeGenerated;\n+    jvmti->SetEventCallbacks(&callbacks, sizeof(callbacks));\n+\n+    return 0;\n+}\n","filename":"hotspot\/test\/serviceability\/jvmti\/DynamicCodeGenerated\/libDynamicCodeGenerated.cpp","additions":57,"deletions":0,"binary":false,"changes":57,"status":"added"},{"patch":"@@ -110,0 +110,5 @@\n+    VERSIONINFO_RESOURCE := $(JDK_TOPDIR)\/src\/windows\/resource\/version.rc, \\\n+    RC_FLAGS := $(RC_FLAGS) \\\n+        -D \"JDK_FNAME=j2gss.dll\" \\\n+        -D \"JDK_INTERNAL_NAME=j2gss\" \\\n+        -D \"JDK_FTYPE=0x2L\", \\\n@@ -127,0 +132,5 @@\n+    VERSIONINFO_RESOURCE := $(JDK_TOPDIR)\/src\/windows\/resource\/version.rc, \\\n+    RC_FLAGS := $(RC_FLAGS) \\\n+        -D \"JDK_FNAME=sspi_bridge.dll\" \\\n+        -D \"JDK_INTERNAL_NAME=sspi_bridge\" \\\n+        -D \"JDK_FTYPE=0x2L\", \\\n","filename":"jdk\/make\/lib\/SecurityLibraries.gmk","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2008, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2016, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,1 +29,0 @@\n-import java.awt.ComponentOrientation;\n@@ -32,0 +31,1 @@\n+import java.util.Enumeration;\n@@ -238,0 +238,24 @@\n+            if (SunToolkit.isInstanceOf(aComponent,\n+                                                 \"javax.swing.JToggleButton\")) {\n+                ButtonModel buttonModel = ((JToggleButton) aComponent).getModel();\n+                if (buttonModel != null && buttonModel instanceof DefaultButtonModel) {\n+                    DefaultButtonModel model = (DefaultButtonModel) buttonModel;\n+                    ButtonGroup group = model.getGroup();\n+                    if (group != null) {\n+                        Enumeration<AbstractButton> elements =\n+                                                        group.getElements();\n+                        int idx = 0;\n+                        while (elements.hasMoreElements()) {\n+                            AbstractButton member = elements.nextElement();\n+                            if (member.isVisible() && member.isDisplayable() &&\n+                                member.isEnabled() && member.isFocusable()) {\n+                                if (member == aComponent) {\n+                                    return idx == 0;\n+                                }\n+                                idx++;\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+\n","filename":"jdk\/src\/share\/classes\/javax\/swing\/LayoutFocusTraversalPolicy.java","additions":26,"deletions":2,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2016, Oracle and\/or its affiliates. All rights reserved.\n@@ -440,15 +440,1 @@\n-            Component focusBaseComp = activeBtn;\n-            Container container = focusBaseComp.getFocusCycleRootAncestor();\n-            if (container != null) {\n-                FocusTraversalPolicy policy = container.getFocusTraversalPolicy();\n-                Component comp = next ? policy.getComponentAfter(container, activeBtn)\n-                                      : policy.getComponentBefore(container, activeBtn);\n-\n-                \/\/ If next component in the button group, use last\/first button as base focus\n-                \/\/ otherwise, use the activeBtn as the base focus\n-                if (containsInGroup(comp)) {\n-                    focusBaseComp = next ? lastBtn : firstBtn;\n-                }\n-            }\n-\n-            return focusBaseComp;\n+            return firstBtn;\n","filename":"jdk\/src\/share\/classes\/javax\/swing\/plaf\/basic\/BasicRadioButtonUI.java","additions":2,"deletions":16,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -0,0 +1,23 @@\n+# Tips and tasks when updating LittleCMS sources to a newer version.\n+\n+Download and unzip latest release from https:\/\/sourceforge.net\/projects\/lcms\/files\/\n+Replace files in jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms with files from unzipped src and include folders\n+Replace is important because the lcms sources here are just the subset needed by JDK.\n+This is deliberate, so when updating be sure to import only the same files.\n+If a file has been removed from upstream you will notice it during the copy.\n+It should then be removed from the JDK sources.\n+If a new file is needed then the build will fail. Manually copy that in.\n+\n+Some re-editing of these updated files will be needed.\n+Use \"expand\" and \"sed\" to remove tabs and trailing white space from the imported files.\n+Re-apply the GPL headers used by the JDK. If done correctly these should then not\n+show up in the PR diff.\n+\n+Update THIRD_PARTY_README per the current license\/copyrights\/attributions etc.\n+\n+Build on all platforms.\n+If there are compiler warnings causing build failures, update the disabled warnings in\n+jdk\/make\/lib\/Awt2dLibraries.gmk \n+Run all automated client tests on all platforms.\n+Also run J2Ddemo and pay particular attention to the \"color\" tab.\n+Visually verify the color transforms against the same with the current\/previous JDK\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/UPDATING.txt","additions":23,"deletions":0,"binary":false,"changes":23,"status":"added"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -223,1 +223,1 @@\n-    *(cmsUInt8Number*)dst = _cmsQuickSaturateByte(n * 255.0f);\n+    *(cmsUInt8Number*)dst = _cmsQuickSaturateByte(n * 255.0);\n@@ -230,1 +230,1 @@\n-    *(cmsUInt16Number*)dst = _cmsQuickSaturateWord(n * 65535.0f);\n+    *(cmsUInt16Number*)dst = _cmsQuickSaturateWord(n * 65535.0);\n@@ -237,1 +237,1 @@\n-    cmsUInt16Number i = _cmsQuickSaturateWord(n * 65535.0f);\n+    cmsUInt16Number i = _cmsQuickSaturateWord(n * 65535.0);\n@@ -275,1 +275,1 @@\n-       *(cmsUInt8Number*)dst = _cmsQuickSaturateByte(n * 255.0f);\n+       *(cmsUInt8Number*)dst = _cmsQuickSaturateByte(n * 255.0);\n@@ -288,1 +288,1 @@\n-       *(cmsUInt16Number*)dst = _cmsQuickSaturateWord(n * 65535.0f);\n+       *(cmsUInt16Number*)dst = _cmsQuickSaturateWord(n * 65535.0);\n@@ -300,1 +300,1 @@\n-    cmsUInt16Number i = _cmsQuickSaturateWord(n * 65535.0f);\n+    cmsUInt16Number i = _cmsQuickSaturateWord(n * 65535.0);\n@@ -446,3 +446,3 @@\n-           \/\/ Sanity check\n-           if (total_chans <= 0 || total_chans >= cmsMAXCHANNELS)\n-                   return;\n+       \/\/ Sanity check\n+       if (total_chans <= 0 || total_chans >= cmsMAXCHANNELS)\n+           return;\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsalpha.c","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmscam02.c","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -165,1 +165,1 @@\n-\/\/ This struct hold all information about an open IT8 handler.\n+\/\/Very simple string\n@@ -168,0 +168,9 @@\n+        struct struct_it8* it8;\n+        cmsInt32Number max;\n+        cmsInt32Number len;\n+        char* begin;\n+    } string;\n+\n+\n+\/\/ This struct hold all information about an open IT8 handler.\n+typedef struct struct_it8 {\n@@ -185,2 +194,2 @@\n-        char           id[MAXID];             \/\/ identifier\n-        char           str[MAXSTR];           \/\/ string\n+        string*        id;            \/\/ identifier\n+        string*        str;           \/\/ string\n@@ -271,1 +280,1 @@\n-                                                  \/\/ physical targets only (i.e . IT8.7\/1 a nd IT8.7\/2).\n+                                                  \/\/ physical targets only (i.e . IT8.7\/1 and IT8.7\/2).\n@@ -386,0 +395,59 @@\n+static\n+string* StringAlloc(cmsIT8* it8, int max)\n+{\n+    string* s = (string*) AllocChunk(it8, sizeof(string));\n+    if (s == NULL) return NULL;\n+\n+    s->it8 = it8;\n+    s->max = max;\n+    s->len = 0;\n+    s->begin = (char*) AllocChunk(it8, s->max);\n+\n+    return s;\n+}\n+\n+static\n+void StringClear(string* s)\n+{\n+    s->len = 0;\n+}\n+\n+static\n+void StringAppend(string* s, char c)\n+{\n+    if (s->len + 1 >= s->max)\n+    {\n+        char* new_ptr;\n+\n+        s->max *= 10;\n+        new_ptr = (char*) AllocChunk(s->it8, s->max);\n+        if (new_ptr != NULL && s->begin != NULL)\n+            memcpy(new_ptr, s->begin, s->len);\n+\n+        s->begin = new_ptr;\n+    }\n+\n+    if (s->begin != NULL)\n+    {\n+        s->begin[s->len++] = c;\n+        s->begin[s->len] = 0;\n+    }\n+}\n+\n+static\n+char* StringPtr(string* s)\n+{\n+    return s->begin;\n+}\n+\n+static\n+void StringCat(string* s, const char* c)\n+{\n+    while (*c)\n+    {\n+        StringAppend(s, *c);\n+        c++;\n+    }\n+}\n+\n+\n@@ -711,0 +779,33 @@\n+\/\/ Reads a string, special case to avoid infinite resursion on .include\n+static\n+void InStringSymbol(cmsIT8* it8)\n+{\n+    while (isseparator(it8->ch))\n+        NextCh(it8);\n+\n+    if (it8->ch == '\\'' || it8->ch == '\\\"')\n+    {\n+        int sng;\n+\n+        sng = it8->ch;\n+        StringClear(it8->str);\n+\n+        NextCh(it8);\n+\n+        while (it8->ch != sng) {\n+\n+            if (it8->ch == '\\n' || it8->ch == '\\r' || it8->ch == 0) break;\n+            else {\n+                StringAppend(it8->str, (char)it8->ch);\n+                NextCh(it8);\n+            }\n+        }\n+\n+        it8->sy = SSTRING;\n+        NextCh(it8);\n+    }\n+    else\n+        SynError(it8, \"String expected\");\n+\n+}\n+\n@@ -715,2 +816,0 @@\n-    CMSREGISTER char *idptr;\n-    CMSREGISTER int k;\n@@ -718,1 +817,0 @@\n-    int sng;\n@@ -727,2 +825,1 @@\n-            k = 0;\n-            idptr = it8->id;\n+            StringClear(it8->id);\n@@ -732,1 +829,1 @@\n-                if (++k < MAXID) *idptr++ = (char) it8->ch;\n+                StringAppend(it8->id, (char) it8->ch);\n@@ -738,1 +835,0 @@\n-            *idptr = '\\0';\n@@ -740,2 +836,1 @@\n-\n-            key = BinSrchKey(it8->id);\n+            key = BinSrchKey(StringPtr(it8->id));\n@@ -776,0 +871,1 @@\n+                                it8->sy = SEOF;\n@@ -797,0 +893,1 @@\n+                                it8->sy = SEOF;\n@@ -837,0 +934,2 @@\n+                    char buffer[127];\n+\n@@ -839,1 +938,1 @@\n-                        snprintf(it8->id, 127, \"%d\", it8->inum);\n+                        snprintf(buffer, sizeof(buffer), \"%d\", it8->inum);\n@@ -843,1 +942,1 @@\n-                        snprintf(it8->id, 127, it8 ->DoubleFormatter, it8->dnum);\n+                        snprintf(buffer, sizeof(buffer), it8 ->DoubleFormatter, it8->dnum);\n@@ -846,2 +945,2 @@\n-                    k = (int) strlen(it8 ->id);\n-                    idptr = it8 ->id + k;\n+                    StringCat(it8->id, buffer);\n+\n@@ -850,1 +949,1 @@\n-                        if (++k < MAXID) *idptr++ = (char) it8->ch;\n+                        StringAppend(it8->id, (char) it8->ch);\n@@ -856,1 +955,0 @@\n-                    *idptr = '\\0';\n@@ -865,5 +963,0 @@\n-        \/\/ EOF marker -- ignore it\n-        case '\\x1a':\n-            NextCh(it8);\n-            break;\n-\n@@ -871,0 +964,1 @@\n+        case '\\x1a':\n@@ -904,18 +998,1 @@\n-            idptr = it8->str;\n-            sng = it8->ch;\n-            k = 0;\n-            NextCh(it8);\n-\n-            while (k < (MAXSTR-1) && it8->ch != sng) {\n-\n-                if (it8->ch == '\\n'|| it8->ch == '\\r') k = MAXSTR+1;\n-                else {\n-                    *idptr++ = (char) it8->ch;\n-                    NextCh(it8);\n-                    k++;\n-                }\n-            }\n-\n-            it8->sy = SSTRING;\n-            *idptr = '\\0';\n-            NextCh(it8);\n+            InStringSymbol(it8);\n@@ -927,0 +1004,1 @@\n+            it8->sy = SEOF;\n@@ -941,0 +1019,1 @@\n+                    it8->sy = SEOF;\n@@ -944,2 +1023,6 @@\n-                InSymbol(it8);\n-                if (!Check(it8, SSTRING, \"Filename expected\")) return;\n+                InStringSymbol(it8);\n+                if (!Check(it8, SSTRING, \"Filename expected\"))\n+                {\n+                    it8->sy = SEOF;\n+                    return;\n+                }\n@@ -951,2 +1034,5 @@\n-                    \/\/if(FileNest == NULL)\n-                    \/\/  TODO: how to manage out-of-memory conditions?\n+                    if (FileNest == NULL) {\n+                        SynError(it8, \"Out of memory\");\n+                        it8->sy = SEOF;\n+                        return;\n+                    }\n@@ -955,1 +1041,1 @@\n-                if (BuildAbsolutePath(it8->str,\n+                if (BuildAbsolutePath(StringPtr(it8->str),\n@@ -959,0 +1045,1 @@\n+                    it8->sy = SEOF;\n@@ -966,0 +1053,1 @@\n+                        it8->sy = SEOF;\n@@ -1016,1 +1104,1 @@\n-    case SIDENT:  strncpy(Buffer, it8->id, max);\n+    case SIDENT:  strncpy(Buffer, StringPtr(it8->id), max);\n@@ -1021,1 +1109,1 @@\n-    case SSTRING: strncpy(Buffer, it8->str, max);\n+    case SSTRING: strncpy(Buffer, StringPtr(it8->str), max);\n@@ -1126,1 +1214,1 @@\n-        it8 ->Allocator.Block = (cmsUInt8Number*)  AllocBigBlock(it8, it8 ->Allocator.BlockSize);\n+        it8 ->Allocator.Block = (cmsUInt8Number*) AllocBigBlock(it8, it8 ->Allocator.BlockSize);\n@@ -1129,0 +1217,3 @@\n+    if (it8->Allocator.Block == NULL)\n+        return NULL;\n+\n@@ -1146,1 +1237,1 @@\n-    if (ptr) strncpy (ptr, str, Size-1);\n+    if (ptr) memcpy(ptr, str, Size-1);\n@@ -1345,0 +1436,3 @@\n+    it8->id = StringAlloc(it8, MAXSTR);\n+    it8->str = StringAlloc(it8, MAXSTR);\n+\n@@ -1466,0 +1560,15 @@\n+\/\/ A safe atoi that returns 0 when NULL input is given\n+static\n+cmsInt32Number satoi(const char* b)\n+{\n+    int n;\n+\n+    if (b == NULL) return 0;\n+\n+    n = atoi(b);\n+    if (n > 0x7fffffffL) return 0x7fffffffL;\n+    if (n < -0x7ffffffeL) return -0x7ffffffeL;\n+\n+    return (cmsInt32Number)n;\n+}\n+\n@@ -1468,1 +1577,1 @@\n-void AllocateDataFormat(cmsIT8* it8)\n+cmsBool AllocateDataFormat(cmsIT8* it8)\n@@ -1472,1 +1581,1 @@\n-    if (t -> DataFormat) return;    \/\/ Already allocated\n+    if (t -> DataFormat) return TRUE;    \/\/ Already allocated\n@@ -1474,1 +1583,1 @@\n-    t -> nSamples  = (int) cmsIT8GetPropertyDbl(it8, \"NUMBER_OF_FIELDS\");\n+    t -> nSamples  = satoi(cmsIT8GetProperty(it8, \"NUMBER_OF_FIELDS\"));\n@@ -1479,1 +1588,1 @@\n-        t -> nSamples = 10;\n+        return FALSE;\n@@ -1486,0 +1595,1 @@\n+        return FALSE;\n@@ -1488,0 +1598,1 @@\n+    return TRUE;\n@@ -1506,2 +1617,5 @@\n-    if (!t->DataFormat)\n-        AllocateDataFormat(it8);\n+    if (!t->DataFormat) {\n+\n+        if (!AllocateDataFormat(it8))\n+            return FALSE;\n+    }\n@@ -1516,0 +1630,1 @@\n+        if (t->DataFormat[n] == NULL) return FALSE;\n@@ -1528,1 +1643,1 @@\n-\/\/ A safe atoi that returns 0 when NULL input is given\n+\/\/ Convert to binary\n@@ -1530,1 +1645,1 @@\n-cmsInt32Number satoi(const char* b)\n+const char* satob(const char* v)\n@@ -1532,2 +1647,12 @@\n-    if (b == NULL) return 0;\n-    return atoi(b);\n+    cmsUInt32Number x;\n+    static char buf[33];\n+    char *s = buf + 33;\n+\n+    if (v == NULL) return \"0\";\n+\n+    x = atoi(v);\n+    *--s = 0;\n+    if (!x) *--s = '0';\n+    for (; x; x \/= 2) *--s = '0' + x%2;\n+\n+    return s;\n@@ -1536,0 +1661,1 @@\n+\n@@ -1537,1 +1663,1 @@\n-void AllocateDataSet(cmsIT8* it8)\n+cmsBool AllocateDataSet(cmsIT8* it8)\n@@ -1541,1 +1667,1 @@\n-    if (t -> Data) return;    \/\/ Already allocated\n+    if (t -> Data) return TRUE;    \/\/ Already allocated\n@@ -1549,0 +1675,1 @@\n+        return FALSE;\n@@ -1556,0 +1683,1 @@\n+            return FALSE;\n@@ -1559,0 +1687,1 @@\n+    return TRUE;\n@@ -1580,2 +1709,3 @@\n-    if (!t->Data)\n-        AllocateDataSet(it8);\n+    if (!t->Data) {\n+        if (!AllocateDataSet(it8)) return FALSE;\n+    }\n@@ -1721,1 +1851,1 @@\n-                    Writef(fp, \"\\t0x%B\", satoi(p ->Value));\n+                    Writef(fp, \"\\t0b%s\", satob(p ->Value));\n@@ -1891,1 +2021,1 @@\n-            if (!SetDataFormat(it8, iField, it8->id)) return FALSE;\n+            if (!SetDataFormat(it8, iField, StringPtr(it8->id))) return FALSE;\n@@ -1924,2 +2054,3 @@\n-    if (!t->Data)\n-        AllocateDataSet(it8);\n+    if (!t->Data) {\n+        if (!AllocateDataSet(it8)) return FALSE;\n+    }\n@@ -1937,0 +2068,16 @@\n+            switch (it8->sy)\n+            {\n+\n+            \/\/ To keep very long data\n+            case SIDENT:\n+                if (!SetData(it8, iSet, iField, StringPtr(it8->id)))\n+                    return FALSE;\n+                break;\n+\n+            case SSTRING:\n+                if (!SetData(it8, iSet, iField, StringPtr(it8->str)))\n+                    return FALSE;\n+                break;\n+\n+            default:\n+\n@@ -1942,0 +2089,1 @@\n+            }\n@@ -1997,1 +2145,1 @@\n-            strncpy(VarName, it8->id, MAXID - 1);\n+            strncpy(VarName, StringPtr(it8->id), MAXID - 1);\n@@ -2141,1 +2289,1 @@\n-                                         cmsIT8SetSheetType(it8, it8 ->id);\n+                                         cmsIT8SetSheetType(it8, StringPtr(it8 ->id));\n@@ -2153,1 +2301,1 @@\n-                                        cmsIT8SetSheetType(it8, it8 ->str);\n+                                        cmsIT8SetSheetType(it8, StringPtr(it8 ->str));\n@@ -2455,1 +2603,2 @@\n-    Props = (char **) AllocChunk(it8, sizeof(char *) * n);\n+        Props = (char**)AllocChunk(it8, sizeof(char*) * n);\n+        if (Props != NULL) {\n@@ -2457,5 +2606,8 @@\n-    \/\/ Pass#2 - Fill pointers\n-    n = 0;\n-    for (p = t -> HeaderList;  p != NULL; p = p->Next) {\n-        Props[n++] = p -> Keyword;\n-    }\n+                \/\/ Pass#2 - Fill pointers\n+                n = 0;\n+                for (p = t->HeaderList; p != NULL; p = p->Next) {\n+                        Props[n++] = p->Keyword;\n+                }\n+\n+        }\n+        *PropertyNames = Props;\n@@ -2463,1 +2615,0 @@\n-    *PropertyNames = Props;\n@@ -2495,0 +2646,1 @@\n+    if (Props != NULL) {\n@@ -2496,5 +2648,6 @@\n-    \/\/ Pass#2 - Fill pointers\n-    n = 0;\n-    for (tmp = p;  tmp != NULL; tmp = tmp->NextSubkey) {\n-        if(tmp->Subkey != NULL)\n-            Props[n++] = p ->Subkey;\n+        \/\/ Pass#2 - Fill pointers\n+        n = 0;\n+        for (tmp = p; tmp != NULL; tmp = tmp->NextSubkey) {\n+            if (tmp->Subkey != NULL)\n+                Props[n++] = p->Subkey;\n+        }\n@@ -2676,2 +2829,6 @@\n-        AllocateDataFormat(it8);\n-        AllocateDataSet(it8);\n+        if (!AllocateDataFormat(it8))\n+            return FALSE;\n+\n+        if (!AllocateDataSet(it8))\n+            return FALSE;\n+\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmscgats.c","additions":244,"deletions":87,"binary":false,"changes":331,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -418,1 +418,1 @@\n-            cmsCIEXYZ BlackPointIn, BlackPointOut;\n+            cmsCIEXYZ BlackPointIn = { 0, 0, 0}, BlackPointOut = { 0, 0, 0 };\n@@ -662,1 +662,1 @@\n-                  cmsStage* clip = _cmsStageClipNegatives(Result->ContextID, cmsChannelsOf(ColorSpaceOut));\n+                  cmsStage* clip = _cmsStageClipNegatives(Result->ContextID, cmsChannelsOfColorSpace(ColorSpaceOut));\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmscnvrt.c","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -111,1 +111,1 @@\n-\/\/ is up to the plug-in writter to keep in the safe side. There are only three functions\n+\/\/ is up to the plug-in writer to keep in the safe side. There are only three functions\n@@ -340,1 +340,1 @@\n-\/\/ I prefer this method over realloc due to the big inpact on xput realloc may have if\n+\/\/ I prefer this method over realloc due to the big impact on xput realloc may have if\n@@ -645,1 +645,0 @@\n-\n@@ -693,0 +692,44 @@\n+\n+\/\/ The global Context0 storage for parallelization plug-in\n+ _cmsParallelizationPluginChunkType _cmsParallelizationPluginChunk = { 0 };\n+\n+\/\/ Allocate parallelization container.\n+void _cmsAllocParallelizationPluginChunk(struct _cmsContext_struct* ctx,\n+                                         const struct _cmsContext_struct* src)\n+{\n+    if (src != NULL) {\n+        void* from = src->chunks[ParallelizationPlugin];\n+        ctx->chunks[ParallelizationPlugin] = _cmsSubAllocDup(ctx->MemPool, from, sizeof(_cmsParallelizationPluginChunkType));\n+    }\n+    else {\n+        _cmsParallelizationPluginChunkType ParallelizationPluginChunk = { 0 };\n+        ctx->chunks[ParallelizationPlugin] = _cmsSubAllocDup(ctx->MemPool, &ParallelizationPluginChunk, sizeof(_cmsParallelizationPluginChunkType));\n+    }\n+}\n+\n+\/\/ Register parallel processing\n+cmsBool _cmsRegisterParallelizationPlugin(cmsContext ContextID, cmsPluginBase* Data)\n+{\n+    cmsPluginParalellization* Plugin = (cmsPluginParalellization*)Data;\n+    _cmsParallelizationPluginChunkType* ctx = (_cmsParallelizationPluginChunkType*)_cmsContextGetClientChunk(ContextID, ParallelizationPlugin);\n+\n+    if (Data == NULL) {\n+\n+        \/\/ No parallelization routines\n+        ctx->MaxWorkers = 0;\n+        ctx->WorkerFlags = 0;\n+        ctx->SchedulerFn = NULL;\n+        return TRUE;\n+    }\n+\n+    \/\/ callback is required\n+    if (Plugin->SchedulerFn == NULL) return FALSE;\n+\n+    ctx->MaxWorkers = Plugin->MaxWorkers;\n+    ctx->WorkerFlags = Plugin->WorkerFlags;\n+    ctx->SchedulerFn = Plugin->SchedulerFn;\n+\n+    \/\/ All is ok\n+    return TRUE;\n+}\n+\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmserr.c","additions":47,"deletions":4,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -239,1 +239,1 @@\n-\/\/ no optimation curve is computed. nSegments may also be zero in the inverse case, where only the\n+\/\/ no optimization curve is computed. nSegments may also be zero in the inverse case, where only the\n@@ -459,2 +459,2 @@\n-    \/\/ Y = (aX + b)^Gamma | X <= -b\/a\n-    \/\/ Y = c              | else\n+    \/\/ Y = (aX + b)^Gamma + c | X <= -b\/a\n+    \/\/ Y = c                  | else\n@@ -494,1 +494,2 @@\n-        if (fabs(Params[1]) < MATRIX_DET_TOLERANCE)\n+        if (fabs(Params[0]) < MATRIX_DET_TOLERANCE ||\n+            fabs(Params[1]) < MATRIX_DET_TOLERANCE)\n@@ -539,6 +540,4 @@\n-        if (fabs(Params[0]) < MATRIX_DET_TOLERANCE ||\n-            fabs(Params[1]) < MATRIX_DET_TOLERANCE ||\n-            fabs(Params[3]) < MATRIX_DET_TOLERANCE)\n-        {\n-            Val = 0;\n-        }\n+\n+        e = Params[1] * Params[4] + Params[2];\n+        if (e < 0)\n+            disc = 0;\n@@ -546,6 +545,1 @@\n-        {\n-            e = Params[1] * Params[4] + Params[2];\n-            if (e < 0)\n-                disc = 0;\n-            else\n-                disc = pow(e, Params[0]);\n+            disc = pow(e, Params[0]);\n@@ -553,1 +547,4 @@\n-            if (R >= disc) {\n+        if (R >= disc) {\n+\n+            if (fabs(Params[0]) < MATRIX_DET_TOLERANCE ||\n+                fabs(Params[1]) < MATRIX_DET_TOLERANCE)\n@@ -555,0 +552,3 @@\n+                Val = 0;\n+\n+            else\n@@ -556,2 +556,6 @@\n-            }\n-            else {\n+        }\n+        else {\n+\n+            if (fabs(Params[3]) < MATRIX_DET_TOLERANCE)\n+                Val = 0;\n+            else\n@@ -559,1 +563,0 @@\n-            }\n@@ -561,0 +564,1 @@\n+\n@@ -587,9 +591,10 @@\n-        if (fabs(Params[1]) < MATRIX_DET_TOLERANCE ||\n-            fabs(Params[3]) < MATRIX_DET_TOLERANCE)\n-        {\n-            Val = 0;\n-        }\n-        else\n-        {\n-            disc = Params[3] * Params[4] + Params[6];\n-            if (R >= disc) {\n+        disc = Params[3] * Params[4] + Params[6];\n+        if (R >= disc) {\n+\n+            e = R - Params[5];\n+            if (e < 0)\n+                Val = 0;\n+            else\n+            {\n+                if (fabs(Params[0]) < MATRIX_DET_TOLERANCE ||\n+                    fabs(Params[1]) < MATRIX_DET_TOLERANCE)\n@@ -597,2 +602,0 @@\n-                e = R - Params[5];\n-                if (e < 0)\n@@ -603,1 +606,5 @@\n-            else {\n+        }\n+        else {\n+            if (fabs(Params[3]) < MATRIX_DET_TOLERANCE)\n+                Val = 0;\n+            else\n@@ -605,1 +612,0 @@\n-            }\n@@ -607,0 +613,1 @@\n+\n@@ -627,1 +634,2 @@\n-        if (fabs(Params[1]) < MATRIX_DET_TOLERANCE)\n+        if (fabs(Params[0]) < MATRIX_DET_TOLERANCE ||\n+            fabs(Params[1]) < MATRIX_DET_TOLERANCE)\n@@ -1499,0 +1507,3 @@\n+    \/\/ We need enough valid samples\n+    if (n <= 1) return -1.0;\n+\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsgamma.c","additions":46,"deletions":35,"binary":false,"changes":81,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2021 Marti Maria Saguer\n@@ -231,1 +231,1 @@\n-    cmsFloat64Number Thereshold;        \/\/ The thereshold after which is considered out of gamut\n+    cmsFloat64Number Threshold;         \/\/ The threshold after which is considered out of gamut\n@@ -236,1 +236,1 @@\n-\/\/ values with a transform going back and forth. Values above ERR_THERESHOLD\n+\/\/ values with a transform going back and forth. Values above ERR_THRESHOLD\n@@ -239,1 +239,1 @@\n-#define ERR_THERESHOLD      5\n+#define ERR_THRESHOLD      5\n@@ -278,1 +278,1 @@\n-    if (dE1 < t->Thereshold && dE2 < t->Thereshold)\n+    if (dE1 < t->Threshold && dE2 < t->Threshold)\n@@ -283,1 +283,1 @@\n-        if (dE1 < t->Thereshold && dE2 > t->Thereshold)\n+        if (dE1 < t->Threshold && dE2 > t->Threshold)\n@@ -287,2 +287,2 @@\n-            if (dE1 > t->Thereshold && dE2 < t->Thereshold)\n-                Out[0] = (cmsUInt16Number) _cmsQuickFloor((dE1 - t->Thereshold) + .5);\n+            if (dE1 > t->Threshold && dE2 < t->Threshold)\n+                Out[0] = (cmsUInt16Number) _cmsQuickFloor((dE1 - t->Threshold) + .5);\n@@ -298,2 +298,2 @@\n-                if (ErrorRatio > t->Thereshold)\n-                    Out[0] = (cmsUInt16Number)  _cmsQuickFloor((ErrorRatio - t->Thereshold) + .5);\n+                if (ErrorRatio > t->Threshold)\n+                    Out[0] = (cmsUInt16Number)  _cmsQuickFloor((ErrorRatio - t->Threshold) + .5);\n@@ -329,1 +329,2 @@\n-    cmsUInt32Number nChannels, nGridpoints;\n+    cmsUInt32Number nGridpoints;\n+    cmsInt32Number nChannels;\n@@ -355,1 +356,1 @@\n-        Chain.Thereshold = 1.0;\n+        Chain.Threshold = 1.0;\n@@ -358,1 +359,1 @@\n-        Chain.Thereshold = ERR_THERESHOLD;\n+        Chain.Threshold = ERR_THRESHOLD;\n@@ -378,2 +379,1 @@\n-\n-    nChannels   = cmsChannelsOf(ColorSpace);\n+    nChannels   = cmsChannelsOfColorSpace(ColorSpace);\n@@ -504,0 +504,3 @@\n+    \/\/ Unsupported color space?\n+    if (dwFormatter == 0) return 0;\n+\n@@ -620,0 +623,66 @@\n+\n+\/\/ Detect whatever a given ICC profile works in linear (gamma 1.0) space\n+\/\/ Actually, doing that \"well\" is quite hard, since every component may behave completely different.\n+\/\/ Since the true point of this function is to detect suitable optimizations, I am imposing some requirements\n+\/\/ that simplifies things: only RGB, and only profiles that can got in both directions.\n+\/\/ The algorithm obtains Y from a syntetical gray R=G=B. Then least squares fitting is used to estimate gamma.\n+\/\/ For gamma close to 1.0, RGB is linear. On profiles not supported, -1 is returned.\n+\n+cmsFloat64Number CMSEXPORT cmsDetectRGBProfileGamma(cmsHPROFILE hProfile, cmsFloat64Number threshold)\n+{\n+    cmsContext ContextID;\n+    cmsHPROFILE hXYZ;\n+    cmsHTRANSFORM xform;\n+    cmsToneCurve* Y_curve;\n+    cmsUInt16Number rgb[256][3];\n+    cmsCIEXYZ XYZ[256];\n+    cmsFloat32Number Y_normalized[256];\n+    cmsFloat64Number gamma;\n+    cmsProfileClassSignature cl;\n+    int i;\n+\n+    if (cmsGetColorSpace(hProfile) != cmsSigRgbData)\n+        return -1;\n+\n+    cl = cmsGetDeviceClass(hProfile);\n+    if (cl != cmsSigInputClass && cl != cmsSigDisplayClass &&\n+        cl != cmsSigOutputClass && cl != cmsSigColorSpaceClass)\n+        return -1;\n+\n+    ContextID = cmsGetProfileContextID(hProfile);\n+    hXYZ = cmsCreateXYZProfileTHR(ContextID);\n+    if (hXYZ == NULL)\n+        return -1;\n+    xform = cmsCreateTransformTHR(ContextID, hProfile, TYPE_RGB_16, hXYZ, TYPE_XYZ_DBL,\n+                                    INTENT_RELATIVE_COLORIMETRIC, cmsFLAGS_NOOPTIMIZE);\n+\n+    if (xform == NULL) { \/\/ If not RGB or forward direction is not supported, regret with the previous error\n+\n+        cmsCloseProfile(hXYZ);\n+        return -1;\n+    }\n+\n+    for (i = 0; i < 256; i++) {\n+        rgb[i][0] = rgb[i][1] = rgb[i][2] = FROM_8_TO_16(i);\n+    }\n+\n+    cmsDoTransform(xform, rgb, XYZ, 256);\n+\n+    cmsDeleteTransform(xform);\n+    cmsCloseProfile(hXYZ);\n+\n+    for (i = 0; i < 256; i++) {\n+        Y_normalized[i] = (cmsFloat32Number) XYZ[i].Y;\n+    }\n+\n+    Y_curve = cmsBuildTabulatedToneCurveFloat(ContextID, 256, Y_normalized);\n+    if (Y_curve == NULL)\n+        return -1;\n+\n+    gamma = cmsEstimateGamma(Y_curve, threshold);\n+\n+    cmsFreeToneCurve(Y_curve);\n+\n+    return gamma;\n+}\n+\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsgmt.c","additions":84,"deletions":15,"binary":false,"changes":99,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -409,1 +409,1 @@\n-static cmsUInt16Number Offset[64] = {\n+static const cmsUInt16Number Offset[64] = {\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmshalf.c","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -232,2 +232,2 @@\n-    \/\/ if last value...\n-    if (Value[0] == 0xffff) {\n+    \/\/ if last value or just one point\n+    if (Value[0] == 0xffff || p->Domain[0] == 0) {\n@@ -272,1 +272,1 @@\n-       if (val2 == 1.0) {\n+       if (val2 == 1.0 || p->Domain[0] == 0) {\n@@ -306,2 +306,0 @@\n-       v = Input[0] * p16 -> Domain[0];\n-       fk = _cmsToFixedDomain(v);\n@@ -309,2 +307,17 @@\n-       k0 = FIXED_TO_INT(fk);\n-       rk = (cmsUInt16Number) FIXED_REST_TO_INT(fk);\n+       \/\/ if last value...\n+       if (Input[0] == 0xffff || p16->Domain[0] == 0) {\n+\n+           cmsUInt32Number y0 = p16->Domain[0] * p16->opta[0];\n+\n+           for (OutChan = 0; OutChan < p16->nOutputs; OutChan++) {\n+               Output[OutChan] = LutTable[y0 + OutChan];\n+           }\n+       }\n+       else\n+       {\n+\n+           v = Input[0] * p16->Domain[0];\n+           fk = _cmsToFixedDomain(v);\n+\n+           k0 = FIXED_TO_INT(fk);\n+           rk = (cmsUInt16Number)FIXED_REST_TO_INT(fk);\n@@ -312,1 +325,1 @@\n-       k1 = k0 + (Input[0] != 0xFFFFU ? 1 : 0);\n+           k1 = k0 + (Input[0] != 0xFFFFU ? 1 : 0);\n@@ -314,2 +327,2 @@\n-       K0 = p16 -> opta[0] * k0;\n-       K1 = p16 -> opta[0] * k1;\n+           K0 = p16->opta[0] * k0;\n+           K1 = p16->opta[0] * k1;\n@@ -317,1 +330,1 @@\n-       for (OutChan=0; OutChan < p16->nOutputs; OutChan++) {\n+           for (OutChan = 0; OutChan < p16->nOutputs; OutChan++) {\n@@ -319,1 +332,2 @@\n-           Output[OutChan] = LinearInterp(rk, LutTable[K0+OutChan], LutTable[K1+OutChan]);\n+               Output[OutChan] = LinearInterp(rk, LutTable[K0 + OutChan], LutTable[K1 + OutChan]);\n+           }\n@@ -340,1 +354,1 @@\n-    if (val2 == 1.0) {\n+    if (val2 == 1.0 || p->Domain[0] == 0) {\n@@ -342,1 +356,1 @@\n-        y0 = LutTable[p->Domain[0]];\n+        cmsUInt32Number start = p->Domain[0] * p->opta[0];\n@@ -345,1 +359,1 @@\n-            Output[OutChan] = y0;\n+            Output[OutChan] = LutTable[start + OutChan];\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsintrp.c","additions":30,"deletions":16,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -407,0 +407,1 @@\n+    char mode[4] = { 0,0,0,0 };\n@@ -414,1 +415,34 @@\n-    switch (*AccessMode) {\n+    \/\/ Validate access mode\n+    while (*AccessMode) {\n+\n+        switch (*AccessMode)\n+        {\n+        case 'r':\n+        case 'w':\n+\n+            if (mode[0] == 0) {\n+                mode[0] = *AccessMode;\n+                mode[1] = 'b';\n+            }\n+            else {\n+                _cmsFree(ContextID, iohandler);\n+                cmsSignalError(ContextID, cmsERROR_FILE, \"Access mode already specified '%c'\", *AccessMode);\n+                return NULL;\n+            }\n+            break;\n+\n+        \/\/ Close on exec. Not all runtime supports that. Up to the caller to decide.\n+        case 'e':\n+            mode[2] = 'e';\n+            break;\n+\n+        default:\n+            _cmsFree(ContextID, iohandler);\n+            cmsSignalError(ContextID, cmsERROR_FILE, \"Wrong access mode '%c'\", *AccessMode);\n+            return NULL;\n+        }\n+\n+        AccessMode++;\n+    }\n+\n+    switch (mode[0]) {\n@@ -417,1 +451,1 @@\n-        fm = fopen(FileName, \"rb\");\n+        fm = fopen(FileName, mode);\n@@ -423,1 +457,1 @@\n-        fileLen = cmsfilelength(fm);\n+        fileLen = (cmsInt32Number)cmsfilelength(fm);\n@@ -431,1 +465,0 @@\n-\n@@ -436,1 +469,1 @@\n-        fm = fopen(FileName, \"wb\");\n+        fm = fopen(FileName, mode);\n@@ -446,2 +479,1 @@\n-        _cmsFree(ContextID, iohandler);\n-         cmsSignalError(ContextID, cmsERROR_FILE, \"Unknown access mode '%c'\", *AccessMode);\n+        _cmsFree(ContextID, iohandler);   \/\/ Would never reach\n@@ -474,1 +506,1 @@\n-    fileSize = cmsfilelength(Stream);\n+    fileSize = (cmsInt32Number)cmsfilelength(Stream);\n@@ -511,1 +543,1 @@\n-        _cmsICCPROFILE* Icc = (_cmsICCPROFILE*)hProfile;\n+    _cmsICCPROFILE* Icc = (_cmsICCPROFILE*)hProfile;\n@@ -513,2 +545,2 @@\n-        if (Icc == NULL) return NULL;\n-        return Icc->IOhandler;\n+    if (Icc == NULL) return NULL;\n+    return Icc->IOhandler;\n@@ -520,1 +552,0 @@\n-    time_t now = time(NULL);\n@@ -532,0 +563,3 @@\n+    \/\/ Set default device class\n+    Icc->DeviceClass = cmsSigDisplayClass;\n+\n@@ -533,1 +567,2 @@\n-    memmove(&Icc ->Created, gmtime(&now), sizeof(Icc ->Created));\n+    if (!_cmsGetTime(&Icc->Created))\n+        goto Error;\n@@ -540,0 +575,4 @@\n+\n+Error:\n+    _cmsFree(ContextID, Icc);\n+    return NULL;\n@@ -685,0 +724,21 @@\n+\n+\n+\/\/ Checks for link compatibility\n+static\n+cmsBool CompatibleTypes(const cmsTagDescriptor* desc1, const cmsTagDescriptor* desc2)\n+{\n+    cmsUInt32Number i;\n+\n+    if (desc1 == NULL || desc2 == NULL) return FALSE;\n+\n+    if (desc1->nSupportedTypes != desc2->nSupportedTypes) return FALSE;\n+    if (desc1->ElemCount != desc2->ElemCount) return FALSE;\n+\n+    for (i = 0; i < desc1->nSupportedTypes; i++)\n+    {\n+        if (desc1->SupportedTypes[i] != desc2->SupportedTypes[i]) return FALSE;\n+    }\n+\n+    return TRUE;\n+}\n+\n@@ -710,0 +770,23 @@\n+\/\/ Check device class\n+static\n+cmsBool validDeviceClass(cmsProfileClassSignature cl)\n+{\n+    if ((int)cl == 0) return TRUE; \/\/ We allow zero because older lcms versions defaulted to that.\n+\n+    switch (cl)\n+    {\n+    case cmsSigInputClass:\n+    case cmsSigDisplayClass:\n+    case cmsSigOutputClass:\n+    case cmsSigLinkClass:\n+    case cmsSigAbstractClass:\n+    case cmsSigColorSpaceClass:\n+    case cmsSigNamedColorClass:\n+        return TRUE;\n+\n+    default:\n+        return FALSE;\n+    }\n+\n+}\n+\n@@ -746,0 +829,10 @@\n+    if (Icc->Version > 0x5000000) {\n+        cmsSignalError(Icc->ContextID, cmsERROR_UNKNOWN_EXTENSION, \"Unsupported profile version '0x%x'\", Icc->Version);\n+        return FALSE;\n+    }\n+\n+    if (!validDeviceClass(Icc->DeviceClass)) {\n+        cmsSignalError(Icc->ContextID, cmsERROR_UNKNOWN_EXTENSION, \"Unsupported device class '0x%x'\", Icc->DeviceClass);\n+        return FALSE;\n+    }\n+\n@@ -779,0 +872,1 @@\n+        if (Tag.size == 0 || Tag.offset == 0) continue;\n@@ -793,1 +887,6 @@\n-                Icc ->TagLinked[Icc ->TagCount] = Icc ->TagNames[j];\n+                \/\/ Check types.\n+                if (CompatibleTypes(_cmsGetTagDescriptor(Icc->ContextID, Icc->TagNames[j]),\n+                                    _cmsGetTagDescriptor(Icc->ContextID, Tag.sig))) {\n+\n+                    Icc->TagLinked[Icc->TagCount] = Icc->TagNames[j];\n+                }\n@@ -801,0 +900,13 @@\n+\n+    for (i = 0; i < Icc->TagCount; i++) {\n+        for (j = 0; j < Icc->TagCount; j++) {\n+\n+            \/\/ Tags cannot be duplicate\n+            if ((i != j) && (Icc->TagNames[i] == Icc->TagNames[j])) {\n+                cmsSignalError(Icc->ContextID, cmsERROR_RANGE, \"Duplicate tag found\");\n+                return FALSE;\n+            }\n+\n+        }\n+    }\n+\n@@ -1462,0 +1574,7 @@\n+\/\/ Free one tag contents\n+static\n+void freeOneTag(_cmsICCPROFILE* Icc, cmsUInt32Number i)\n+{\n+    if (Icc->TagPtrs[i]) {\n+\n+        cmsTagTypeHandler* TypeHandler = Icc->TagTypeHandlers[i];\n@@ -1463,0 +1582,11 @@\n+        if (TypeHandler != NULL) {\n+            cmsTagTypeHandler LocalTypeHandler = *TypeHandler;\n+\n+            LocalTypeHandler.ContextID = Icc->ContextID;\n+            LocalTypeHandler.ICCVersion = Icc->Version;\n+            LocalTypeHandler.FreePtr(&LocalTypeHandler, Icc->TagPtrs[i]);\n+        }\n+        else\n+            _cmsFree(Icc->ContextID, Icc->TagPtrs[i]);\n+    }\n+}\n@@ -1482,14 +1612,1 @@\n-        if (Icc -> TagPtrs[i]) {\n-\n-            cmsTagTypeHandler* TypeHandler = Icc ->TagTypeHandlers[i];\n-\n-            if (TypeHandler != NULL) {\n-                cmsTagTypeHandler LocalTypeHandler = *TypeHandler;\n-\n-                LocalTypeHandler.ContextID = Icc ->ContextID;              \/\/ As an additional parameters\n-                LocalTypeHandler.ICCVersion = Icc ->Version;\n-                LocalTypeHandler.FreePtr(&LocalTypeHandler, Icc -> TagPtrs[i]);\n-            }\n-            else\n-                _cmsFree(Icc ->ContextID, Icc ->TagPtrs[i]);\n-        }\n+        freeOneTag(Icc, i);\n@@ -1547,2 +1664,6 @@\n-    if (n < 0) goto Error;               \/\/ Not found, return NULL\n-\n+    if (n < 0)\n+    {\n+        \/\/ Not found, return NULL\n+        _cmsUnlockMutex(Icc->ContextID, Icc->UsrMutex);\n+        return NULL;\n+    }\n@@ -1576,0 +1697,6 @@\n+    if (io == NULL) { \/\/ This is a built-in profile that has been manipulated, abort early\n+\n+        cmsSignalError(Icc->ContextID, cmsERROR_CORRUPTION_DETECTED, \"Corrupted built-in profile.\");\n+        goto Error;\n+    }\n+\n@@ -1643,1 +1770,1 @@\n-    \/\/ Return error and unlock tha data\n+    \/\/ Return error and unlock the data\n@@ -1645,0 +1772,4 @@\n+\n+    freeOneTag(Icc, n);\n+    Icc->TagPtrs[n] = NULL;\n+\n@@ -1783,5 +1914,3 @@\n-\/\/ Read and write raw data. The only way those function would work and keep consistence with normal read and write\n-\/\/ is to do an additional step of serialization. That means, readRaw would issue a normal read and then convert the obtained\n-\/\/ data to raw bytes by using the \"write\" serialization logic. And vice-versa. I know this may end in situations where\n-\/\/ raw data written does not exactly correspond with the raw data proposed to cmsWriteRaw data, but this approach allows\n-\/\/ to write a tag as raw data and the read it as handled.\n+\/\/ Read and write raw data. Read\/Write Raw\/cooked pairs try to maintain consistency within the pair. Some sequences\n+\/\/ raw\/cooked would work, but at a cost. Data \"cooked\" may be converted to \"raw\" by using the \"write\" serialization logic.\n+\/\/ In general it is better to avoid mixing pairs.\n@@ -1801,0 +1930,3 @@\n+    \/\/ Sanity check\n+    if (data != NULL && BufferSize == 0) return 0;\n+\n@@ -1804,0 +1936,1 @@\n+\n@@ -1810,1 +1943,1 @@\n-        \/\/ No yet, get original position\n+        \/\/ Not yet, get original position\n@@ -1815,0 +1948,1 @@\n+\n@@ -1818,1 +1952,1 @@\n-                TagSize = BufferSize;\n+                goto Error;\n@@ -1833,0 +1967,1 @@\n+\n@@ -1839,1 +1974,1 @@\n-                TagSize = BufferSize;\n+                goto Error;\n@@ -1852,1 +1987,1 @@\n-    \/\/ data to raw in order to maintain consistency.\n+    \/\/ data to raw to get something that makes sense\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsio0.c","additions":176,"deletions":41,"binary":false,"changes":217,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -292,1 +292,1 @@\n-\/\/ Read the DToAX tag, adjusting the encoding of Lab or XYZ if neded\n+\/\/ Read the DToAX tag, adjusting the encoding of Lab or XYZ if needed\n@@ -354,2 +354,1 @@\n-        if (Lut == NULL) {\n-            cmsFreeNamedColorList(nc);\n+        if (Lut == NULL)\n@@ -357,1 +356,0 @@\n-        }\n@@ -568,1 +566,1 @@\n-\/\/ Read the DToAX tag, adjusting the encoding of Lab or XYZ if neded\n+\/\/ Read the DToAX tag, adjusting the encoding of Lab or XYZ if needed\n@@ -693,1 +691,1 @@\n-\/\/ Read the AToD0 tag, adjusting the encoding of Lab or XYZ if neded\n+\/\/ Read the AToD0 tag, adjusting the encoding of Lab or XYZ if needed\n@@ -772,1 +770,0 @@\n-        cmsFreeNamedColorList(nc);\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsio1.c","additions":5,"deletions":8,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -499,1 +499,1 @@\n-        if (dim == 0) return 0;  \/\/ Error\n+        if (dim <= 1) return 0;  \/\/ Error\n@@ -1258,0 +1258,5 @@\n+cmsContext CMSEXPORT cmsGetStageContextID(const cmsStage* mpe)\n+{\n+    return mpe -> ContextID;\n+}\n+\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmslut.c","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsmd5.c","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsmtrx.c","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -236,1 +236,1 @@\n-\/\/ In the case the user explicitely sets an empty string, we force a \\0\n+\/\/ In the case the user explicitly sets an empty string, we force a \\0\n@@ -574,1 +574,1 @@\n-    cmsNAMEDCOLORLIST* v = (cmsNAMEDCOLORLIST*) _cmsMallocZero(ContextID, sizeof(cmsNAMEDCOLORLIST));\n+    cmsNAMEDCOLORLIST* v;\n@@ -576,0 +576,4 @@\n+    if (ColorantCount > cmsMAXCHANNELS)\n+        return NULL;\n+\n+    v = (cmsNAMEDCOLORLIST*)_cmsMallocZero(ContextID, sizeof(cmsNAMEDCOLORLIST));\n@@ -673,1 +677,1 @@\n-\/\/ Info aboout a given color\n+\/\/ Info about a given color\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsnamed.c","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -679,1 +679,0 @@\n-    cmsStage* mpe;\n@@ -701,1 +700,1 @@\n-    nGridPoints      = _cmsReasonableGridpointsByColorspace(ColorSpace, *dwFlags);\n+    nGridPoints = _cmsReasonableGridpointsByColorspace(ColorSpace, *dwFlags);\n@@ -709,7 +708,0 @@\n-    \/\/ Named color pipelines cannot be optimized either\n-    for (mpe = cmsPipelineGetPtrToFirstStage(Src);\n-        mpe != NULL;\n-        mpe = cmsStageNext(mpe)) {\n-            if (cmsStageType(mpe) == cmsSigNamedColorElemType) return FALSE;\n-    }\n-\n@@ -1083,1 +1075,0 @@\n-    cmsStage* mpe;\n@@ -1105,7 +1096,0 @@\n-   \/\/ Named color pipelines cannot be optimized either\n-   for (mpe = cmsPipelineGetPtrToFirstStage(OriginalLut);\n-         mpe != NULL;\n-         mpe = cmsStageNext(mpe)) {\n-            if (cmsStageType(mpe) == cmsSigNamedColorElemType) return FALSE;\n-    }\n-\n@@ -1565,1 +1549,1 @@\n-\/\/ A fast matrix-shaper evaluator for 8 bits. This is a bit ticky since I'm using 1.14 signed fixed point\n+\/\/ A fast matrix-shaper evaluator for 8 bits. This is a bit tricky since I'm using 1.14 signed fixed point\n@@ -1568,1 +1552,1 @@\n-static\n+static CMS_NO_SANITIZE\n@@ -1950,0 +1934,1 @@\n+    cmsStage* mpe;\n@@ -1964,0 +1949,7 @@\n+    \/\/ Named color pipelines cannot be optimized\n+    for (mpe = cmsPipelineGetPtrToFirstStage(*PtrLut);\n+        mpe != NULL;\n+        mpe = cmsStageNext(mpe)) {\n+        if (cmsStageType(mpe) == cmsSigNamedColorElemType) return FALSE;\n+    }\n+\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsopt.c","additions":12,"deletions":20,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -111,0 +111,1 @@\n+#define ANYPREMUL       PREMUL_SH(1)\n@@ -134,0 +135,2 @@\n+    cmsUInt32Number Premul     = T_PREMUL(info->InputFormat);\n+\n@@ -135,1 +138,1 @@\n-    cmsUInt16Number v;\n+    cmsUInt32Number v;\n@@ -137,0 +140,1 @@\n+    cmsUInt32Number alpha_factor = 1;\n@@ -139,0 +143,4 @@\n+\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(FROM_8_TO_16(accum[0]));\n+\n@@ -141,0 +149,5 @@\n+    else\n+    {\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(FROM_8_TO_16(accum[nChan]));\n+    }\n@@ -143,0 +156,1 @@\n+\n@@ -147,1 +161,8 @@\n-        wIn[index] = v;\n+\n+        if (Premul && alpha_factor > 0)\n+        {\n+            v = ((cmsUInt32Number)((cmsUInt32Number)v << 16) \/ alpha_factor);\n+            if (v > 0xffff) v = 0xffff;\n+        }\n+\n+        wIn[index] = (cmsUInt16Number) v;\n@@ -169,0 +190,1 @@\n+\n@@ -181,0 +203,3 @@\n+    cmsUInt32Number ExtraFirst = DoSwap ^ SwapFirst;\n+    cmsUInt32Number Extra = T_EXTRA(info->InputFormat);\n+    cmsUInt32Number Premul = T_PREMUL(info->InputFormat);\n@@ -182,0 +207,1 @@\n+    cmsUInt32Number alpha_factor = 1;\n@@ -183,2 +209,12 @@\n-    if (DoSwap ^ SwapFirst) {\n-        accum += T_EXTRA(info -> InputFormat) * Stride;\n+    if (ExtraFirst) {\n+\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(FROM_8_TO_16(accum[0]));\n+\n+\n+        accum += Extra * Stride;\n+    }\n+    else\n+    {\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(FROM_8_TO_16(accum[(nChan) * Stride]));\n@@ -190,1 +226,1 @@\n-        cmsUInt16Number v = FROM_8_TO_16(*accum);\n+        cmsUInt32Number v = FROM_8_TO_16(*accum);\n@@ -192,1 +228,9 @@\n-        wIn[index] = Reverse ? REVERSE_FLAVOR_16(v) : v;\n+        v = Reverse ? REVERSE_FLAVOR_16(v) : v;\n+\n+        if (Premul && alpha_factor > 0)\n+        {\n+            v = ((cmsUInt32Number)((cmsUInt32Number)v << 16) \/ alpha_factor);\n+            if (v > 0xffff) v = 0xffff;\n+        }\n+\n+        wIn[index] = (cmsUInt16Number) v;\n@@ -199,0 +243,1 @@\n+\n@@ -549,0 +594,52 @@\n+\n+static\n+cmsUInt8Number* UnrollAnyWordsPremul(CMSREGISTER _cmsTRANSFORM* info,\n+                                     CMSREGISTER cmsUInt16Number wIn[],\n+                                     CMSREGISTER cmsUInt8Number* accum,\n+                                     CMSREGISTER cmsUInt32Number Stride)\n+{\n+   cmsUInt32Number nChan       = T_CHANNELS(info -> InputFormat);\n+   cmsUInt32Number SwapEndian  = T_ENDIAN16(info -> InputFormat);\n+   cmsUInt32Number DoSwap      = T_DOSWAP(info ->InputFormat);\n+   cmsUInt32Number Reverse     = T_FLAVOR(info ->InputFormat);\n+   cmsUInt32Number SwapFirst   = T_SWAPFIRST(info -> InputFormat);\n+   cmsUInt32Number ExtraFirst  = DoSwap ^ SwapFirst;\n+   cmsUInt32Number i;\n+\n+   cmsUInt16Number alpha = (ExtraFirst ? accum[0] : accum[nChan - 1]);\n+   cmsUInt32Number alpha_factor = _cmsToFixedDomain(FROM_8_TO_16(alpha));\n+\n+    if (ExtraFirst) {\n+        accum += sizeof(cmsUInt16Number);\n+    }\n+\n+    for (i=0; i < nChan; i++) {\n+\n+        cmsUInt32Number index = DoSwap ? (nChan - i - 1) : i;\n+        cmsUInt32Number v = *(cmsUInt16Number*) accum;\n+\n+        if (SwapEndian)\n+            v = CHANGE_ENDIAN(v);\n+\n+        if (alpha_factor > 0) {\n+\n+            v = (v << 16) \/ alpha_factor;\n+            if (v > 0xffff) v = 0xffff;\n+        }\n+\n+        wIn[index] = (cmsUInt16Number) (Reverse ? REVERSE_FLAVOR_16(v) : v);\n+\n+        accum += sizeof(cmsUInt16Number);\n+    }\n+\n+    if (!ExtraFirst) {\n+        accum += sizeof(cmsUInt16Number);\n+    }\n+\n+    return accum;\n+\n+    cmsUNUSED_PARAMETER(Stride);\n+}\n+\n+\n+\n@@ -582,0 +679,43 @@\n+static\n+cmsUInt8Number* UnrollPlanarWordsPremul(CMSREGISTER _cmsTRANSFORM* info,\n+                                        CMSREGISTER cmsUInt16Number wIn[],\n+                                        CMSREGISTER cmsUInt8Number* accum,\n+                                        CMSREGISTER cmsUInt32Number Stride)\n+{\n+    cmsUInt32Number nChan = T_CHANNELS(info -> InputFormat);\n+    cmsUInt32Number DoSwap= T_DOSWAP(info ->InputFormat);\n+    cmsUInt32Number SwapFirst = T_SWAPFIRST(info->InputFormat);\n+    cmsUInt32Number Reverse= T_FLAVOR(info ->InputFormat);\n+    cmsUInt32Number SwapEndian = T_ENDIAN16(info -> InputFormat);\n+    cmsUInt32Number i;\n+    cmsUInt32Number ExtraFirst = DoSwap ^ SwapFirst;\n+    cmsUInt8Number* Init = accum;\n+\n+    cmsUInt16Number  alpha = (ExtraFirst ? accum[0] : accum[(nChan - 1) * Stride]);\n+    cmsUInt32Number alpha_factor = _cmsToFixedDomain(FROM_8_TO_16(alpha));\n+\n+    if (ExtraFirst) {\n+        accum += Stride;\n+    }\n+\n+    for (i=0; i < nChan; i++) {\n+\n+        cmsUInt32Number index = DoSwap ? (nChan - i - 1) : i;\n+        cmsUInt32Number v = (cmsUInt32Number) *(cmsUInt16Number*) accum;\n+\n+        if (SwapEndian)\n+            v = CHANGE_ENDIAN(v);\n+\n+        if (alpha_factor > 0) {\n+\n+            v = (v << 16) \/ alpha_factor;\n+            if (v > 0xffff) v = 0xffff;\n+        }\n+\n+        wIn[index] = (cmsUInt16Number) (Reverse ? REVERSE_FLAVOR_16(v) : v);\n+\n+        accum +=  Stride;\n+    }\n+\n+    return (Init + sizeof(cmsUInt16Number));\n+}\n@@ -1119,0 +1259,104 @@\n+\/\/ For anything going from cmsUInt8Number\n+static\n+cmsUInt8Number* Unroll8ToFloat(_cmsTRANSFORM* info,\n+                               cmsFloat32Number wIn[],\n+                               cmsUInt8Number* accum,\n+                               cmsUInt32Number Stride)\n+{\n+\n+    cmsUInt32Number nChan = T_CHANNELS(info->InputFormat);\n+    cmsUInt32Number DoSwap = T_DOSWAP(info->InputFormat);\n+    cmsUInt32Number Reverse = T_FLAVOR(info->InputFormat);\n+    cmsUInt32Number SwapFirst = T_SWAPFIRST(info->InputFormat);\n+    cmsUInt32Number Extra = T_EXTRA(info->InputFormat);\n+    cmsUInt32Number ExtraFirst = DoSwap ^ SwapFirst;\n+    cmsUInt32Number Planar = T_PLANAR(info->InputFormat);\n+    cmsFloat32Number v;\n+    cmsUInt32Number i, start = 0;\n+\n+    Stride \/= PixelSize(info->InputFormat);\n+\n+    if (ExtraFirst)\n+        start = Extra;\n+\n+    for (i = 0; i < nChan; i++) {\n+\n+        cmsUInt32Number index = DoSwap ? (nChan - i - 1) : i;\n+\n+        if (Planar)\n+            v = (cmsFloat32Number) ((cmsUInt8Number *)accum)[(i + start) * Stride];\n+        else\n+            v = (cmsFloat32Number) ((cmsUInt8Number *)accum)[i + start];\n+\n+        v \/= 255.0F;\n+\n+        wIn[index] = Reverse ? 1 - v : v;\n+    }\n+\n+\n+    if (Extra == 0 && SwapFirst) {\n+        cmsFloat32Number tmp = wIn[0];\n+\n+        memmove(&wIn[0], &wIn[1], (nChan - 1) * sizeof(cmsFloat32Number));\n+        wIn[nChan - 1] = tmp;\n+    }\n+\n+    if (T_PLANAR(info->InputFormat))\n+        return accum + sizeof(cmsUInt8Number);\n+    else\n+        return accum + (nChan + Extra) * sizeof(cmsUInt8Number);\n+}\n+\n+\n+\/\/ For anything going from cmsUInt16Number\n+static\n+cmsUInt8Number* Unroll16ToFloat(_cmsTRANSFORM* info,\n+                                cmsFloat32Number wIn[],\n+                                cmsUInt8Number* accum,\n+                                cmsUInt32Number Stride)\n+{\n+\n+    cmsUInt32Number nChan = T_CHANNELS(info->InputFormat);\n+    cmsUInt32Number DoSwap = T_DOSWAP(info->InputFormat);\n+    cmsUInt32Number Reverse = T_FLAVOR(info->InputFormat);\n+    cmsUInt32Number SwapFirst = T_SWAPFIRST(info->InputFormat);\n+    cmsUInt32Number Extra = T_EXTRA(info->InputFormat);\n+    cmsUInt32Number ExtraFirst = DoSwap ^ SwapFirst;\n+    cmsUInt32Number Planar = T_PLANAR(info->InputFormat);\n+    cmsFloat32Number v;\n+    cmsUInt32Number i, start = 0;\n+\n+    Stride \/= PixelSize(info->InputFormat);\n+\n+    if (ExtraFirst)\n+        start = Extra;\n+\n+    for (i = 0; i < nChan; i++) {\n+\n+        cmsUInt32Number index = DoSwap ? (nChan - i - 1) : i;\n+\n+        if (Planar)\n+            v = (cmsFloat32Number)((cmsUInt16Number*)accum)[(i + start) * Stride];\n+        else\n+            v = (cmsFloat32Number)((cmsUInt16Number*)accum)[i + start];\n+\n+        v \/= 65535.0F;\n+\n+        wIn[index] = Reverse ? 1 - v : v;\n+    }\n+\n+\n+    if (Extra == 0 && SwapFirst) {\n+        cmsFloat32Number tmp = wIn[0];\n+\n+        memmove(&wIn[0], &wIn[1], (nChan - 1) * sizeof(cmsFloat32Number));\n+        wIn[nChan - 1] = tmp;\n+    }\n+\n+    if (T_PLANAR(info->InputFormat))\n+        return accum + sizeof(cmsUInt16Number);\n+    else\n+        return accum + (nChan + Extra) * sizeof(cmsUInt16Number);\n+}\n+\n+\n@@ -1127,5 +1371,5 @@\n-    cmsUInt32Number nChan  = T_CHANNELS(info -> InputFormat);\n-    cmsUInt32Number DoSwap   = T_DOSWAP(info ->InputFormat);\n-    cmsUInt32Number Reverse    = T_FLAVOR(info ->InputFormat);\n-    cmsUInt32Number SwapFirst  = T_SWAPFIRST(info -> InputFormat);\n-    cmsUInt32Number Extra   = T_EXTRA(info -> InputFormat);\n+    cmsUInt32Number nChan = T_CHANNELS(info->InputFormat);\n+    cmsUInt32Number DoSwap = T_DOSWAP(info->InputFormat);\n+    cmsUInt32Number Reverse = T_FLAVOR(info->InputFormat);\n+    cmsUInt32Number SwapFirst = T_SWAPFIRST(info->InputFormat);\n+    cmsUInt32Number Extra = T_EXTRA(info->InputFormat);\n@@ -1133,1 +1377,2 @@\n-    cmsUInt32Number Planar     = T_PLANAR(info -> InputFormat);\n+    cmsUInt32Number Planar = T_PLANAR(info->InputFormat);\n+    cmsUInt32Number Premul = T_PREMUL(info->InputFormat);\n@@ -1136,1 +1381,3 @@\n-    cmsFloat32Number maximum = IsInkSpace(info ->InputFormat) ? 100.0F : 1.0F;\n+    cmsFloat32Number maximum = IsInkSpace(info->InputFormat) ? 100.0F : 1.0F;\n+    cmsFloat32Number alpha_factor = 1.0f;\n+    cmsFloat32Number* ptr = (cmsFloat32Number*)accum;\n@@ -1140,0 +1387,8 @@\n+    if (Premul && Extra)\n+    {\n+        if (Planar)\n+            alpha_factor = (ExtraFirst ? ptr[0] : ptr[nChan * Stride]) \/ maximum;\n+        else\n+            alpha_factor = (ExtraFirst ? ptr[0] : ptr[nChan]) \/ maximum;\n+    }\n+\n@@ -1148,1 +1403,1 @@\n-            v = (cmsFloat32Number) ((cmsFloat32Number*) accum)[(i + start) * Stride];\n+            v = ptr[(i + start) * Stride];\n@@ -1150,1 +1405,4 @@\n-            v = (cmsFloat32Number) ((cmsFloat32Number*) accum)[i + start];\n+            v = ptr[i + start];\n+\n+        if (Premul && alpha_factor > 0)\n+            v \/= alpha_factor;\n@@ -1180,5 +1438,5 @@\n-    cmsUInt32Number nChan  = T_CHANNELS(info -> InputFormat);\n-    cmsUInt32Number DoSwap   = T_DOSWAP(info ->InputFormat);\n-    cmsUInt32Number Reverse    = T_FLAVOR(info ->InputFormat);\n-    cmsUInt32Number SwapFirst  = T_SWAPFIRST(info -> InputFormat);\n-    cmsUInt32Number Extra   = T_EXTRA(info -> InputFormat);\n+    cmsUInt32Number nChan = T_CHANNELS(info->InputFormat);\n+    cmsUInt32Number DoSwap = T_DOSWAP(info->InputFormat);\n+    cmsUInt32Number Reverse = T_FLAVOR(info->InputFormat);\n+    cmsUInt32Number SwapFirst = T_SWAPFIRST(info->InputFormat);\n+    cmsUInt32Number Extra = T_EXTRA(info->InputFormat);\n@@ -1186,1 +1444,2 @@\n-    cmsUInt32Number Planar     = T_PLANAR(info -> InputFormat);\n+    cmsUInt32Number Planar = T_PLANAR(info->InputFormat);\n+    cmsUInt32Number Premul = T_PREMUL(info->InputFormat);\n@@ -1190,0 +1449,2 @@\n+    cmsFloat64Number alpha_factor = 1.0;\n+    cmsFloat64Number* ptr = (cmsFloat64Number*)accum;\n@@ -1193,0 +1454,8 @@\n+    if (Premul && Extra)\n+    {\n+        if (Planar)\n+            alpha_factor = (ExtraFirst ? ptr[0] : ptr[(nChan) * Stride]) \/ maximum;\n+        else\n+            alpha_factor = (ExtraFirst ? ptr[0] : ptr[nChan]) \/ maximum;\n+    }\n+\n@@ -1205,0 +1474,4 @@\n+\n+        if (Premul && alpha_factor > 0)\n+            v \/= alpha_factor;\n+\n@@ -1286,2 +1559,0 @@\n-\n-\n@@ -1348,0 +1619,73 @@\n+cmsINLINE void lab4toFloat(cmsFloat32Number wIn[], cmsUInt16Number lab4[3])\n+{\n+    cmsFloat32Number L = (cmsFloat32Number) lab4[0] \/ 655.35F;\n+    cmsFloat32Number a = ((cmsFloat32Number) lab4[1] \/ 257.0F) - 128.0F;\n+    cmsFloat32Number b = ((cmsFloat32Number) lab4[2] \/ 257.0F) - 128.0F;\n+\n+    wIn[0] = (L \/ 100.0F);                    \/\/ from 0..100 to 0..1\n+    wIn[1] = ((a + 128.0F) \/ 255.0F);         \/\/ form -128..+127 to 0..1\n+    wIn[2] = ((b + 128.0F) \/ 255.0F);\n+\n+}\n+\n+static\n+cmsUInt8Number* UnrollLabV2_8ToFloat(_cmsTRANSFORM* info,\n+                                      cmsFloat32Number wIn[],\n+                                      cmsUInt8Number* accum,\n+                                      cmsUInt32Number Stride)\n+{\n+    cmsUInt16Number lab4[3];\n+\n+    lab4[0] = FomLabV2ToLabV4(FROM_8_TO_16(*accum)); accum++;     \/\/ L\n+    lab4[1] = FomLabV2ToLabV4(FROM_8_TO_16(*accum)); accum++;     \/\/ a\n+    lab4[2] = FomLabV2ToLabV4(FROM_8_TO_16(*accum)); accum++;     \/\/ b\n+\n+    lab4toFloat(wIn, lab4);\n+\n+    return accum;\n+\n+    cmsUNUSED_PARAMETER(info);\n+    cmsUNUSED_PARAMETER(Stride);\n+}\n+\n+static\n+cmsUInt8Number* UnrollALabV2_8ToFloat(_cmsTRANSFORM* info,\n+                                      cmsFloat32Number wIn[],\n+                                      cmsUInt8Number* accum,\n+                                      cmsUInt32Number Stride)\n+{\n+    cmsUInt16Number lab4[3];\n+\n+    accum++;  \/\/ A\n+    lab4[0] = FomLabV2ToLabV4(FROM_8_TO_16(*accum)); accum++;     \/\/ L\n+    lab4[1] = FomLabV2ToLabV4(FROM_8_TO_16(*accum)); accum++;     \/\/ a\n+    lab4[2] = FomLabV2ToLabV4(FROM_8_TO_16(*accum)); accum++;     \/\/ b\n+\n+    lab4toFloat(wIn, lab4);\n+\n+    return accum;\n+\n+    cmsUNUSED_PARAMETER(info);\n+    cmsUNUSED_PARAMETER(Stride);\n+}\n+\n+static\n+cmsUInt8Number* UnrollLabV2_16ToFloat(_cmsTRANSFORM* info,\n+                                      cmsFloat32Number wIn[],\n+                                      cmsUInt8Number* accum,\n+                                      cmsUInt32Number Stride)\n+{\n+    cmsUInt16Number lab4[3];\n+\n+    lab4[0] = FomLabV2ToLabV4(*(cmsUInt16Number*) accum); accum += 2;     \/\/ L\n+    lab4[1] = FomLabV2ToLabV4(*(cmsUInt16Number*) accum); accum += 2;     \/\/ a\n+    lab4[2] = FomLabV2ToLabV4(*(cmsUInt16Number*) accum); accum += 2;     \/\/ b\n+\n+    lab4toFloat(wIn, lab4);\n+\n+    return accum;\n+\n+    cmsUNUSED_PARAMETER(info);\n+    cmsUNUSED_PARAMETER(Stride);\n+}\n+\n@@ -1353,1 +1697,0 @@\n-\n@@ -1355,4 +1698,4 @@\n-cmsUInt8Number* PackAnyBytes(CMSREGISTER _cmsTRANSFORM* info,\n-                             CMSREGISTER cmsUInt16Number wOut[],\n-                             CMSREGISTER cmsUInt8Number* output,\n-                             CMSREGISTER cmsUInt32Number Stride)\n+cmsUInt8Number* PackChunkyBytes(CMSREGISTER _cmsTRANSFORM* info,\n+                                CMSREGISTER cmsUInt16Number wOut[],\n+                                CMSREGISTER cmsUInt8Number* output,\n+                                CMSREGISTER cmsUInt32Number Stride)\n@@ -1360,5 +1703,6 @@\n-    cmsUInt32Number nChan  = T_CHANNELS(info -> OutputFormat);\n-    cmsUInt32Number DoSwap   = T_DOSWAP(info ->OutputFormat);\n-    cmsUInt32Number Reverse    = T_FLAVOR(info ->OutputFormat);\n-    cmsUInt32Number Extra   = T_EXTRA(info -> OutputFormat);\n-    cmsUInt32Number SwapFirst  = T_SWAPFIRST(info -> OutputFormat);\n+    cmsUInt32Number nChan = T_CHANNELS(info->OutputFormat);\n+    cmsUInt32Number DoSwap = T_DOSWAP(info->OutputFormat);\n+    cmsUInt32Number Reverse = T_FLAVOR(info->OutputFormat);\n+    cmsUInt32Number Extra = T_EXTRA(info->OutputFormat);\n+    cmsUInt32Number SwapFirst = T_SWAPFIRST(info->OutputFormat);\n+    cmsUInt32Number Premul = T_PREMUL(info->OutputFormat);\n@@ -1367,1 +1711,1 @@\n-    cmsUInt8Number v = 0;\n+    cmsUInt16Number v = 0;\n@@ -1369,0 +1713,1 @@\n+    cmsUInt32Number alpha_factor = 0;\n@@ -1373,0 +1718,4 @@\n+\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(FROM_8_TO_16(output[0]));\n+\n@@ -1375,0 +1724,5 @@\n+    else\n+    {\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(FROM_8_TO_16(output[nChan]));\n+    }\n@@ -1380,1 +1734,1 @@\n-        v = FROM_16_TO_8(wOut[index]);\n+        v = wOut[index];\n@@ -1383,1 +1737,6 @@\n-            v = REVERSE_FLAVOR_8(v);\n+            v = REVERSE_FLAVOR_16(v);\n+\n+        if (Premul && alpha_factor != 0)\n+        {\n+            v = (cmsUInt16Number)((cmsUInt32Number)((cmsUInt32Number)v * alpha_factor + 0x8000) >> 16);\n+        }\n@@ -1385,1 +1744,1 @@\n-        *output++ = v;\n+        *output++ = FROM_16_TO_8(v);\n@@ -1395,1 +1754,1 @@\n-        *swap1 = v;\n+        *swap1 = FROM_16_TO_8(v);\n@@ -1398,1 +1757,0 @@\n-\n@@ -1404,2 +1762,0 @@\n-\n-\n@@ -1407,4 +1763,4 @@\n-cmsUInt8Number* PackAnyWords(CMSREGISTER _cmsTRANSFORM* info,\n-                             CMSREGISTER cmsUInt16Number wOut[],\n-                             CMSREGISTER cmsUInt8Number* output,\n-                             CMSREGISTER cmsUInt32Number Stride)\n+cmsUInt8Number* PackChunkyWords(CMSREGISTER _cmsTRANSFORM* info,\n+                                CMSREGISTER cmsUInt16Number wOut[],\n+                                CMSREGISTER cmsUInt8Number* output,\n+                                CMSREGISTER cmsUInt32Number Stride)\n@@ -1412,6 +1768,7 @@\n-    cmsUInt32Number nChan  = T_CHANNELS(info -> OutputFormat);\n-    cmsUInt32Number SwapEndian = T_ENDIAN16(info -> OutputFormat);\n-    cmsUInt32Number DoSwap   = T_DOSWAP(info ->OutputFormat);\n-    cmsUInt32Number Reverse    = T_FLAVOR(info ->OutputFormat);\n-    cmsUInt32Number Extra   = T_EXTRA(info -> OutputFormat);\n-    cmsUInt32Number SwapFirst  = T_SWAPFIRST(info -> OutputFormat);\n+    cmsUInt32Number nChan = T_CHANNELS(info->OutputFormat);\n+    cmsUInt32Number SwapEndian = T_ENDIAN16(info->OutputFormat);\n+    cmsUInt32Number DoSwap = T_DOSWAP(info->OutputFormat);\n+    cmsUInt32Number Reverse = T_FLAVOR(info->OutputFormat);\n+    cmsUInt32Number Extra = T_EXTRA(info->OutputFormat);\n+    cmsUInt32Number SwapFirst = T_SWAPFIRST(info->OutputFormat);\n+    cmsUInt32Number Premul = T_PREMUL(info->OutputFormat);\n@@ -1422,0 +1779,1 @@\n+    cmsUInt32Number alpha_factor = 0;\n@@ -1426,0 +1784,4 @@\n+\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(*(cmsUInt16Number*) output);\n+\n@@ -1428,0 +1790,5 @@\n+    else\n+    {\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(((cmsUInt16Number*) output)[nChan]);\n+    }\n@@ -1441,0 +1808,5 @@\n+        if (Premul && alpha_factor != 0)\n+        {\n+            v = (cmsUInt16Number)((cmsUInt32Number)((cmsUInt32Number)v * alpha_factor + 0x8000) >> 16);\n+        }\n+\n@@ -1456,1 +1828,0 @@\n-\n@@ -1463,0 +1834,1 @@\n+\n@@ -1469,4 +1841,7 @@\n-    cmsUInt32Number nChan     = T_CHANNELS(info -> OutputFormat);\n-    cmsUInt32Number DoSwap    = T_DOSWAP(info ->OutputFormat);\n-    cmsUInt32Number SwapFirst = T_SWAPFIRST(info ->OutputFormat);\n-    cmsUInt32Number Reverse   = T_FLAVOR(info ->OutputFormat);\n+    cmsUInt32Number nChan = T_CHANNELS(info->OutputFormat);\n+    cmsUInt32Number DoSwap = T_DOSWAP(info->OutputFormat);\n+    cmsUInt32Number SwapFirst = T_SWAPFIRST(info->OutputFormat);\n+    cmsUInt32Number Reverse = T_FLAVOR(info->OutputFormat);\n+    cmsUInt32Number Extra = T_EXTRA(info->OutputFormat);\n+    cmsUInt32Number ExtraFirst = DoSwap ^ SwapFirst;\n+    cmsUInt32Number Premul = T_PREMUL(info->OutputFormat);\n@@ -1475,0 +1850,4 @@\n+    cmsUInt32Number alpha_factor = 0;\n+\n+\n+    if (ExtraFirst) {\n@@ -1476,0 +1855,2 @@\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(FROM_8_TO_16(output[0]));\n@@ -1477,2 +1858,6 @@\n-    if (DoSwap ^ SwapFirst) {\n-        output += T_EXTRA(info -> OutputFormat) * Stride;\n+        output += Extra * Stride;\n+    }\n+    else\n+    {\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(FROM_8_TO_16(output[nChan * Stride]));\n@@ -1485,1 +1870,11 @@\n-        cmsUInt8Number v = FROM_16_TO_8(wOut[index]);\n+        cmsUInt16Number v = wOut[index];\n+\n+        if (Reverse)\n+            v = REVERSE_FLAVOR_16(v);\n+\n+        if (Premul && alpha_factor != 0)\n+        {\n+            v = (cmsUInt16Number)((cmsUInt32Number)((cmsUInt32Number)v * alpha_factor + 0x8000) >> 16);\n+        }\n+\n+        *(cmsUInt8Number*)output = FROM_16_TO_8(v);\n@@ -1487,1 +1882,0 @@\n-        *(cmsUInt8Number*)  output = (cmsUInt8Number) (Reverse ? REVERSE_FLAVOR_8(v) : v);\n@@ -1503,4 +1897,8 @@\n-    cmsUInt32Number nChan      = T_CHANNELS(info -> OutputFormat);\n-    cmsUInt32Number DoSwap     = T_DOSWAP(info ->OutputFormat);\n-    cmsUInt32Number Reverse    = T_FLAVOR(info ->OutputFormat);\n-    cmsUInt32Number SwapEndian = T_ENDIAN16(info -> OutputFormat);\n+    cmsUInt32Number nChan = T_CHANNELS(info->OutputFormat);\n+    cmsUInt32Number DoSwap = T_DOSWAP(info->OutputFormat);\n+    cmsUInt32Number SwapFirst = T_SWAPFIRST(info->OutputFormat);\n+    cmsUInt32Number Reverse = T_FLAVOR(info->OutputFormat);\n+    cmsUInt32Number Extra = T_EXTRA(info->OutputFormat);\n+    cmsUInt32Number ExtraFirst = DoSwap ^ SwapFirst;\n+    cmsUInt32Number Premul = T_PREMUL(info->OutputFormat);\n+    cmsUInt32Number SwapEndian = T_ENDIAN16(info->OutputFormat);\n@@ -1510,0 +1908,1 @@\n+    cmsUInt32Number alpha_factor = 0;\n@@ -1511,2 +1910,11 @@\n-    if (DoSwap) {\n-        output += T_EXTRA(info -> OutputFormat) * Stride;\n+    if (ExtraFirst) {\n+\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(((cmsUInt16Number*) output)[0]);\n+\n+        output += Extra * Stride;\n+    }\n+    else\n+    {\n+        if (Premul && Extra)\n+            alpha_factor = _cmsToFixedDomain(((cmsUInt16Number*)output)[nChan * Stride]);\n@@ -1527,0 +1935,5 @@\n+        if (Premul && alpha_factor != 0)\n+        {\n+            v = (cmsUInt16Number)((cmsUInt32Number)((cmsUInt32Number)v * alpha_factor + 0x8000) >> 16);\n+        }\n+\n@@ -2673,4 +3086,0 @@\n-\n-\n-\n-\n@@ -3061,1 +3470,1 @@\n-    { BYTES_SH(1)|PLANAR_SH(1), ANYFLAVOR|ANYSWAPFIRST|\n+    { BYTES_SH(1)|PLANAR_SH(1), ANYFLAVOR|ANYSWAPFIRST|ANYPREMUL|\n@@ -3064,1 +3473,1 @@\n-    { BYTES_SH(1),    ANYFLAVOR|ANYSWAPFIRST|ANYSWAP|\n+    { BYTES_SH(1),    ANYFLAVOR|ANYSWAPFIRST|ANYSWAP|ANYPREMUL|\n@@ -3086,0 +3495,4 @@\n+\n+    { BYTES_SH(2)|PLANAR_SH(1),  ANYFLAVOR|ANYSWAP|ANYENDIAN|ANYEXTRA|ANYCHANNELS|ANYSPACE|PREMUL_SH(1),  UnrollPlanarWordsPremul},\n+    { BYTES_SH(2),  ANYFLAVOR|ANYSWAPFIRST|ANYSWAP|ANYENDIAN|ANYEXTRA|ANYCHANNELS|ANYSPACE|PREMUL_SH(1),  UnrollAnyWordsPremul}\n+\n@@ -3101,1 +3514,1 @@\n-                                                      ANYCHANNELS|ANYSPACE,  UnrollFloatsToFloat},\n+                                            ANYPREMUL|ANYCHANNELS|ANYSPACE,  UnrollFloatsToFloat},\n@@ -3104,1 +3517,11 @@\n-                                                        ANYCHANNELS|ANYSPACE,  UnrollDoublesToFloat},\n+                                              ANYCHANNELS|ANYSPACE|ANYPREMUL, UnrollDoublesToFloat},\n+\n+    {     TYPE_LabV2_8,                                                   0,  UnrollLabV2_8ToFloat },\n+    {     TYPE_ALabV2_8,                                                  0,  UnrollALabV2_8ToFloat },\n+    {     TYPE_LabV2_16,                                                  0,  UnrollLabV2_16ToFloat },\n+\n+    {     BYTES_SH(1),              ANYPLANAR|ANYSWAPFIRST|ANYSWAP|ANYEXTRA|\n+                                                        ANYCHANNELS|ANYSPACE, Unroll8ToFloat},\n+\n+    {     BYTES_SH(2),              ANYPLANAR|ANYSWAPFIRST|ANYSWAP|ANYEXTRA|\n+                                                        ANYCHANNELS|ANYSPACE, Unroll16ToFloat},\n@@ -3107,1 +3530,1 @@\n-                                                        ANYCHANNELS|ANYSPACE,  UnrollHalfToFloat},\n+                                                        ANYCHANNELS|ANYSPACE, UnrollHalfToFloat},\n@@ -3201,2 +3624,0 @@\n-    { CHANNELS_SH(6)|BYTES_SH(1),                                  ANYSPACE,  Pack6Bytes},\n-    { CHANNELS_SH(6)|BYTES_SH(1)|DOSWAP_SH(1),                     ANYSPACE,  Pack6BytesSwap},\n@@ -3208,0 +3629,8 @@\n+    { CHANNELS_SH(6)|BYTES_SH(1),                                  ANYSPACE,  Pack6Bytes},\n+    { CHANNELS_SH(6)|BYTES_SH(1)|DOSWAP_SH(1),                     ANYSPACE,  Pack6BytesSwap},\n+\n+    { BYTES_SH(1),    ANYFLAVOR|ANYSWAPFIRST|ANYSWAP|ANYEXTRA|ANYCHANNELS|\n+                                                          ANYSPACE|ANYPREMUL, PackChunkyBytes},\n+\n+    { BYTES_SH(1)|PLANAR_SH(1),    ANYFLAVOR|ANYSWAPFIRST|ANYSWAP|ANYEXTRA|\n+                                              ANYCHANNELS|ANYSPACE|ANYPREMUL, PackPlanarBytes},\n@@ -3209,2 +3638,0 @@\n-    { BYTES_SH(1),                 ANYFLAVOR|ANYSWAPFIRST|ANYSWAP|ANYEXTRA|ANYCHANNELS|ANYSPACE, PackAnyBytes},\n-    { BYTES_SH(1)|PLANAR_SH(1),    ANYFLAVOR|ANYSWAPFIRST|ANYSWAP|ANYEXTRA|ANYCHANNELS|ANYSPACE, PackPlanarBytes},\n@@ -3235,2 +3662,4 @@\n-    { BYTES_SH(2)|PLANAR_SH(1),     ANYFLAVOR|ANYENDIAN|ANYSWAP|ANYEXTRA|ANYCHANNELS|ANYSPACE, PackPlanarWords},\n-    { BYTES_SH(2),                  ANYFLAVOR|ANYSWAPFIRST|ANYSWAP|ANYENDIAN|ANYEXTRA|ANYCHANNELS|ANYSPACE, PackAnyWords}\n+    { BYTES_SH(2),                  ANYFLAVOR|ANYSWAPFIRST|ANYSWAP|ANYENDIAN|\n+                                     ANYEXTRA|ANYCHANNELS|ANYSPACE|ANYPREMUL, PackChunkyWords},\n+    { BYTES_SH(2)|PLANAR_SH(1),     ANYFLAVOR|ANYENDIAN|ANYSWAP|ANYEXTRA|\n+                                     ANYCHANNELS|ANYSPACE|ANYPREMUL,          PackPlanarWords}\n@@ -3408,0 +3837,5 @@\n+    if (T_CHANNELS(Type) == 0) {\n+        static const cmsFormatter nullFormatter = { 0 };\n+        return nullFormatter;\n+    }\n+\n@@ -3442,1 +3876,1 @@\n-    cmsUInt32Number        nOutputChans    = cmsChannelsOf(ColorSpace);\n+    cmsInt32Number         nOutputChans    = cmsChannelsOfColorSpace(ColorSpace);\n@@ -3445,0 +3879,3 @@\n+    \/\/ Unsupported color space?\n+    if (nOutputChans < 0) return 0;\n+\n@@ -3459,0 +3896,3 @@\n+    \/\/ Unsupported color space?\n+    if (nOutputChans < 0) return 0;\n+\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmspack.c","additions":523,"deletions":83,"binary":false,"changes":606,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -906,1 +906,1 @@\n-cmsUInt32Number CMSEXPORT cmsChannelsOf(cmsColorSpaceSignature ColorSpace)\n+cmsInt32Number CMSEXPORT cmsChannelsOfColorSpace(cmsColorSpaceSignature ColorSpace)\n@@ -967,1 +967,1 @@\n-    default: return 3;\n+    default: return -1;\n@@ -970,0 +970,10 @@\n+\n+\/**\n+* DEPRECATED: Provided for compatibility only\n+*\/\n+cmsUInt32Number CMSEXPORT cmsChannelsOf(cmsColorSpaceSignature ColorSpace)\n+{\n+    int n = cmsChannelsOfColorSpace(ColorSpace);\n+    if (n < 0) return 3;\n+    return (cmsUInt32Number)n;\n+}\n\\ No newline at end of file\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmspcs.c","additions":13,"deletions":3,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -200,1 +200,4 @@\n-    cmsUInt32Number tmp;\n+    union typeConverter {\n+        cmsUInt32Number integer;\n+        cmsFloat32Number floating_point;\n+    } tmp;\n@@ -204,1 +207,1 @@\n-    if (io->Read(io, &tmp, sizeof(cmsUInt32Number), 1) != 1)\n+    if (io->Read(io, &tmp.integer, sizeof(cmsUInt32Number), 1) != 1)\n@@ -209,2 +212,2 @@\n-        tmp = _cmsAdjustEndianess32(tmp);\n-        *n = *(cmsFloat32Number*)(void*)&tmp;\n+        tmp.integer = _cmsAdjustEndianess32(tmp.integer);\n+        *n = tmp.floating_point;\n@@ -337,7 +340,8 @@\n-    cmsUInt32Number tmp;\n-\n-    _cmsAssert(io != NULL);\n-\n-    tmp = *(cmsUInt32Number*) (void*) &n;\n-    tmp = _cmsAdjustEndianess32(tmp);\n-    if (io -> Write(io, sizeof(cmsUInt32Number), &tmp) != 1)\n+    union typeConverter {\n+        cmsUInt32Number integer;\n+        cmsFloat32Number floating_point;\n+    } tmp;\n+\n+    tmp.floating_point = n;\n+    tmp.integer = _cmsAdjustEndianess32(tmp.integer);\n+    if (io -> Write(io, sizeof(cmsUInt32Number), &tmp.integer) != 1)\n@@ -653,0 +657,4 @@\n+                case cmsPluginParalellizationSig:\n+                    if (!_cmsRegisterParallelizationPlugin(id, Plugin)) return FALSE;\n+                    break;\n+\n@@ -675,2 +683,2 @@\n-    NULL,                              \/\/ Not in the linked list\n-    NULL,                              \/\/ No suballocator\n+    NULL,                                \/\/ Not in the linked list\n+    NULL,                                \/\/ No suballocator\n@@ -678,15 +686,16 @@\n-        NULL,                          \/\/  UserPtr,\n-        &_cmsLogErrorChunk,            \/\/  Logger,\n-        &_cmsAlarmCodesChunk,          \/\/  AlarmCodes,\n-        &_cmsAdaptationStateChunk,     \/\/  AdaptationState,\n-        &_cmsMemPluginChunk,           \/\/  MemPlugin,\n-        &_cmsInterpPluginChunk,        \/\/  InterpPlugin,\n-        &_cmsCurvesPluginChunk,        \/\/  CurvesPlugin,\n-        &_cmsFormattersPluginChunk,    \/\/  FormattersPlugin,\n-        &_cmsTagTypePluginChunk,       \/\/  TagTypePlugin,\n-        &_cmsTagPluginChunk,           \/\/  TagPlugin,\n-        &_cmsIntentsPluginChunk,       \/\/  IntentPlugin,\n-        &_cmsMPETypePluginChunk,       \/\/  MPEPlugin,\n-        &_cmsOptimizationPluginChunk,  \/\/  OptimizationPlugin,\n-        &_cmsTransformPluginChunk,     \/\/  TransformPlugin,\n-        &_cmsMutexPluginChunk          \/\/  MutexPlugin\n+        NULL,                            \/\/  UserPtr,\n+        &_cmsLogErrorChunk,              \/\/  Logger,\n+        &_cmsAlarmCodesChunk,            \/\/  AlarmCodes,\n+        &_cmsAdaptationStateChunk,       \/\/  AdaptationState,\n+        &_cmsMemPluginChunk,             \/\/  MemPlugin,\n+        &_cmsInterpPluginChunk,          \/\/  InterpPlugin,\n+        &_cmsCurvesPluginChunk,          \/\/  CurvesPlugin,\n+        &_cmsFormattersPluginChunk,      \/\/  FormattersPlugin,\n+        &_cmsTagTypePluginChunk,         \/\/  TagTypePlugin,\n+        &_cmsTagPluginChunk,             \/\/  TagPlugin,\n+        &_cmsIntentsPluginChunk,         \/\/  IntentPlugin,\n+        &_cmsMPETypePluginChunk,         \/\/  MPEPlugin,\n+        &_cmsOptimizationPluginChunk,    \/\/  OptimizationPlugin,\n+        &_cmsTransformPluginChunk,       \/\/  TransformPlugin,\n+        &_cmsMutexPluginChunk,           \/\/  MutexPlugin,\n+        &_cmsParallelizationPluginChunk  \/\/  ParallelizationPlugin\n@@ -703,0 +712,47 @@\n+\n+\/\/ Make sure context is initialized (needed on windows)\n+static\n+cmsBool InitContextMutex(void)\n+{\n+    \/\/ See the comments regarding locking in lcms2_internal.h\n+    \/\/ for an explanation of why we need the following code.\n+#ifndef CMS_NO_PTHREADS\n+#ifdef CMS_IS_WINDOWS_\n+#ifndef CMS_RELY_ON_WINDOWS_STATIC_MUTEX_INIT\n+\n+    static cmsBool already_initialized = FALSE;\n+\n+    if (!already_initialized)\n+    {\n+        static HANDLE _cmsWindowsInitMutex = NULL;\n+        static volatile HANDLE* mutex = &_cmsWindowsInitMutex;\n+\n+        if (*mutex == NULL)\n+        {\n+            HANDLE p = CreateMutex(NULL, FALSE, NULL);\n+            if (p && InterlockedCompareExchangePointer((void**)mutex, (void*)p, NULL) != NULL)\n+                CloseHandle(p);\n+        }\n+        if (*mutex == NULL || WaitForSingleObject(*mutex, INFINITE) == WAIT_FAILED)\n+        {\n+            cmsSignalError(0, cmsERROR_INTERNAL, \"Mutex lock failed\");\n+            return FALSE;\n+        }\n+        if (((void**)&_cmsContextPoolHeadMutex)[0] == NULL)\n+            InitializeCriticalSection(&_cmsContextPoolHeadMutex);\n+        if (*mutex == NULL || !ReleaseMutex(*mutex))\n+        {\n+            cmsSignalError(0, cmsERROR_INTERNAL, \"Mutex unlock failed\");\n+            return FALSE;\n+        }\n+        already_initialized = TRUE;\n+    }\n+#endif\n+#endif\n+#endif\n+\n+    return TRUE;\n+}\n+\n+\n+\n@@ -709,1 +765,0 @@\n-\n@@ -714,0 +769,2 @@\n+    InitContextMutex();\n+\n@@ -771,0 +828,2 @@\n+    struct _cmsContext_struct* ctx = _cmsGetContext(ContextID);\n+\n@@ -782,0 +841,5 @@\n+    _cmsRegisterParallelizationPlugin(ContextID, NULL);\n+\n+   if (ctx->MemPool != NULL)\n+       _cmsSubAllocDestroy(ctx->MemPool);\n+   ctx->MemPool = NULL;\n@@ -816,25 +880,1 @@\n-    \/\/ See the comments regarding locking in lcms2_internal.h\n-    \/\/ for an explanation of why we need the following code.\n-#ifndef CMS_NO_PTHREADS\n-#ifdef CMS_IS_WINDOWS_\n-#ifndef CMS_RELY_ON_WINDOWS_STATIC_MUTEX_INIT\n-    {\n-        static HANDLE _cmsWindowsInitMutex = NULL;\n-        static volatile HANDLE* mutex = &_cmsWindowsInitMutex;\n-\n-        if (*mutex == NULL)\n-        {\n-            HANDLE p = CreateMutex(NULL, FALSE, NULL);\n-            if (p && InterlockedCompareExchangePointer((void **)mutex, (void*)p, NULL) != NULL)\n-                CloseHandle(p);\n-        }\n-        if (*mutex == NULL || WaitForSingleObject(*mutex, INFINITE) == WAIT_FAILED)\n-            return NULL;\n-        if (((void **)&_cmsContextPoolHeadMutex)[0] == NULL)\n-            InitializeCriticalSection(&_cmsContextPoolHeadMutex);\n-        if (*mutex == NULL || !ReleaseMutex(*mutex))\n-            return NULL;\n-    }\n-#endif\n-#endif\n-#endif\n+    if (!InitContextMutex()) return NULL;\n@@ -889,0 +929,1 @@\n+    _cmsAllocParallelizationPluginChunk(ctx, NULL);\n@@ -916,0 +957,2 @@\n+    if (!InitContextMutex()) return NULL;\n+\n@@ -950,0 +993,1 @@\n+    _cmsAllocParallelizationPluginChunk(ctx, src);\n@@ -975,0 +1019,3 @@\n+\n+        InitContextMutex();\n+\n@@ -1021,0 +1068,29 @@\n+\/\/ Use context mutex to provide thread-safe time\n+cmsBool _cmsGetTime(struct tm* ptr_time)\n+{\n+    struct tm* t;\n+#if defined(HAVE_GMTIME_R) || defined(HAVE_GMTIME_S)\n+    struct tm tm;\n+#endif\n+\n+    time_t now = time(NULL);\n+\n+#ifdef HAVE_GMTIME_R\n+    t = gmtime_r(&now, &tm);\n+#elif defined(HAVE_GMTIME_S)\n+    t = gmtime_s(&tm, &now) == 0 ? &tm : NULL;\n+#else\n+    if (!InitContextMutex()) return FALSE;\n+\n+    _cmsEnterCriticalSectionPrimitive(&_cmsContextPoolHeadMutex);\n+    t = gmtime(&now);\n+    _cmsLeaveCriticalSectionPrimitive(&_cmsContextPoolHeadMutex);\n+#endif\n+\n+    if (t == NULL)\n+        return FALSE;\n+    else {\n+        *ptr_time = *t;\n+        return TRUE;\n+    }\n+}\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsplugin.c","additions":131,"deletions":55,"binary":false,"changes":186,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -507,1 +507,1 @@\n-        if (i % 10 == 0)\n+    if (i % 10 == 0)\n@@ -586,1 +586,1 @@\n-            buffer[sizeof(buffer)-1] = '\\0';\n+        buffer[sizeof(buffer)-1] = '\\0';\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsps2.c","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -158,0 +158,1 @@\n+    if (Lab.L < 0) Lab.L = 0;\n@@ -354,0 +355,1 @@\n+        if (fabs(b) < 1.0E-10) return 0;\n@@ -364,1 +366,5 @@\n-             double rt = (-b + sqrt(d)) \/ (2.0 * a);\n+             double rt;\n+\n+             if (fabs(a) < 1.0E-10) return 0;\n+\n+             rt = (-b + sqrt(d)) \/ (2.0 * a);\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmssamp.c","additions":8,"deletions":2,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmssm.c","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -166,0 +166,41 @@\n+\/\/ Try to promote correctly to wchar_t when 32 bits\n+cmsINLINE cmsBool is_surrogate(cmsUInt32Number uc) { return (uc - 0xd800u) < 2048u; }\n+cmsINLINE cmsBool is_high_surrogate(cmsUInt32Number uc) { return (uc & 0xfffffc00) == 0xd800; }\n+cmsINLINE cmsBool is_low_surrogate(cmsUInt32Number uc)  { return (uc & 0xfffffc00) == 0xdc00; }\n+\n+cmsINLINE cmsUInt32Number surrogate_to_utf32(cmsUInt32Number high, cmsUInt32Number low)\n+{\n+    return (high << 10) + low - 0x35fdc00;\n+}\n+\n+cmsINLINE cmsBool convert_utf16_to_utf32(cmsIOHANDLER* io, cmsInt32Number n, wchar_t* output)\n+{\n+    cmsUInt16Number uc;\n+\n+    while (n > 0)\n+    {\n+        if (!_cmsReadUInt16Number(io, &uc)) return FALSE;\n+        n--;\n+\n+        if (!is_surrogate(uc))\n+        {\n+            *output++ = (wchar_t)uc;\n+        }\n+        else {\n+\n+            cmsUInt16Number low;\n+\n+            if (!_cmsReadUInt16Number(io, &low)) return FALSE;\n+            n--;\n+\n+            if (is_high_surrogate(uc) && is_low_surrogate(low))\n+                *output++ = (wchar_t)surrogate_to_utf32(uc, low);\n+            else\n+                return FALSE;   \/\/ Corrupted string, just ignore\n+        }\n+    }\n+\n+    return TRUE;\n+}\n+\n+\n@@ -172,0 +213,1 @@\n+    cmsBool is32 = sizeof(wchar_t) > sizeof(cmsUInt16Number);\n@@ -175,0 +217,5 @@\n+    if (is32 && Array != NULL)\n+    {\n+        return convert_utf16_to_utf32(io, n, Array);\n+    }\n+\n@@ -1339,1 +1386,1 @@\n-\/\/ time to UTC when setting these values. Programmes that display these values may show\n+\/\/ time to UTC when setting these values. Programs that display these values may show\n@@ -1535,1 +1582,4 @@\n-        if (!_cmsReadWCharArray(io, NumOfWchar, Block)) goto Error;\n+        if (!_cmsReadWCharArray(io, NumOfWchar, Block)) {\n+            _cmsFree(self->ContextID, Block);\n+            goto Error;\n+        }\n@@ -1778,1 +1828,1 @@\n-\/\/ 8 bit lut may be scaled easely to v4 PCS, but we need also to properly adjust\n+\/\/ 8 bit lut may be scaled easily to v4 PCS, but we need also to properly adjust\n@@ -1885,1 +1935,1 @@\n-    cmsUInt32Number j, nTabSize, i, n;\n+    cmsUInt32Number j, nTabSize, i;\n@@ -1920,1 +1970,1 @@\n-        cmsSignalError(mpe->ContextID, cmsERROR_UNKNOWN_EXTENSION, \"LUT is not suitable to be saved as LUT8\");\n+        cmsSignalError(self->ContextID, cmsERROR_UNKNOWN_EXTENSION, \"LUT is not suitable to be saved as LUT8\");\n@@ -1926,2 +1976,10 @@\n-    else\n-        clutPoints    = clut->Params->nSamples[0];\n+    else {\n+        \/\/ Lut8 only allows same CLUT points in all dimensions\n+        clutPoints = clut->Params->nSamples[0];\n+        for (i = 1; i < cmsPipelineInputChannels(NewLUT); i++) {\n+            if (clut->Params->nSamples[i] != clutPoints) {\n+                cmsSignalError(self->ContextID, cmsERROR_UNKNOWN_EXTENSION, \"LUT with different samples per dimension not suitable to be saved as LUT16\");\n+                return FALSE;\n+            }\n+        }\n+    }\n@@ -1929,2 +1987,2 @@\n-    if (!_cmsWriteUInt8Number(io, (cmsUInt8Number) NewLUT ->InputChannels)) return FALSE;\n-    if (!_cmsWriteUInt8Number(io, (cmsUInt8Number) NewLUT ->OutputChannels)) return FALSE;\n+    if (!_cmsWriteUInt8Number(io, (cmsUInt8Number)cmsPipelineInputChannels(NewLUT))) return FALSE;\n+    if (!_cmsWriteUInt8Number(io, (cmsUInt8Number)cmsPipelineOutputChannels(NewLUT))) return FALSE;\n@@ -1934,2 +1992,0 @@\n-        n = NewLUT->InputChannels * NewLUT->OutputChannels;\n-\n@@ -1938,4 +1994,4 @@\n-                for (i = 0; i < 9; i++)\n-                {\n-                        if (!_cmsWrite15Fixed16Number(io, MatMPE->Double[i])) return FALSE;\n-                }\n+        for (i = 0; i < 9; i++)\n+        {\n+            if (!_cmsWrite15Fixed16Number(io, MatMPE->Double[i])) return FALSE;\n+        }\n@@ -2059,2 +2115,0 @@\n-    nEntries = Tables->TheCurves[0]->nEntries;\n-\n@@ -2063,0 +2117,2 @@\n+        nEntries = Tables->TheCurves[i]->nEntries;\n+\n@@ -2205,1 +2261,1 @@\n-        cmsSignalError(mpe->ContextID, cmsERROR_UNKNOWN_EXTENSION, \"LUT is not suitable to be saved as LUT16\");\n+        cmsSignalError(self->ContextID, cmsERROR_UNKNOWN_EXTENSION, \"LUT is not suitable to be saved as LUT16\");\n@@ -2214,2 +2270,10 @@\n-    else\n-        clutPoints    = clut->Params->nSamples[0];\n+    else {\n+        \/\/ Lut16 only allows same CLUT points in all dimensions\n+        clutPoints = clut->Params->nSamples[0];\n+        for (i = 1; i < InputChannels; i++) {\n+            if (clut->Params->nSamples[i] != clutPoints) {\n+                cmsSignalError(self->ContextID, cmsERROR_UNKNOWN_EXTENSION, \"LUT with different samples per dimension not suitable to be saved as LUT16\");\n+                return FALSE;\n+            }\n+        }\n+    }\n@@ -2224,4 +2288,4 @@\n-                for (i = 0; i < 9; i++)\n-                {\n-                        if (!_cmsWrite15Fixed16Number(io, MatMPE->Double[i])) return FALSE;\n-                }\n+        for (i = 0; i < 9; i++)\n+        {\n+            if (!_cmsWrite15Fixed16Number(io, MatMPE->Double[i])) return FALSE;\n+        }\n@@ -2573,1 +2637,1 @@\n-        cmsUInt32Number i, n;\n+    cmsUInt32Number i, n;\n@@ -2577,1 +2641,1 @@\n-        n = mpe->InputChannels * mpe->OutputChannels;\n+    n = mpe->InputChannels * mpe->OutputChannels;\n@@ -2579,5 +2643,5 @@\n-        \/\/ Write the Matrix\n-        for (i = 0; i < n; i++)\n-        {\n-                if (!_cmsWrite15Fixed16Number(io, m->Double[i])) return FALSE;\n-        }\n+    \/\/ Write the Matrix\n+    for (i = 0; i < n; i++)\n+    {\n+        if (!_cmsWrite15Fixed16Number(io, m->Double[i])) return FALSE;\n+    }\n@@ -2585,1 +2649,1 @@\n-        if (m->Offset != NULL) {\n+    if (m->Offset != NULL) {\n@@ -2587,4 +2651,3 @@\n-                for (i = 0; i < mpe->OutputChannels; i++)\n-                {\n-                        if (!_cmsWrite15Fixed16Number(io, m->Offset[i])) return FALSE;\n-                }\n+        for (i = 0; i < mpe->OutputChannels; i++)\n+        {\n+            if (!_cmsWrite15Fixed16Number(io, m->Offset[i])) return FALSE;\n@@ -2592,5 +2655,5 @@\n-        else {\n-                for (i = 0; i < mpe->OutputChannels; i++)\n-                {\n-                        if (!_cmsWrite15Fixed16Number(io, 0)) return FALSE;\n-                }\n+    }\n+    else {\n+        for (i = 0; i < mpe->OutputChannels; i++)\n+        {\n+            if (!_cmsWrite15Fixed16Number(io, 0)) return FALSE;\n@@ -2598,0 +2661,1 @@\n+    }\n@@ -3128,1 +3192,0 @@\n-\n@@ -3200,2 +3263,2 @@\n-    strncpy(prefix, (const char*) NamedColorList->Prefix, 32);\n-    strncpy(suffix, (const char*) NamedColorList->Suffix, 32);\n+    memcpy(prefix, (const char*) NamedColorList->Prefix, sizeof(prefix));\n+    memcpy(suffix, (const char*) NamedColorList->Suffix, sizeof(suffix));\n@@ -3214,0 +3277,4 @@\n+       memset(Root, 0, sizeof(Root));\n+       memset(PCS, 0, sizeof(PCS));\n+       memset(Colorant, 0, sizeof(Colorant));\n+\n@@ -3454,1 +3521,0 @@\n-    SizeOfTag -= sizeof(cmsUInt32Number);\n@@ -3472,0 +3538,1 @@\n+    cmsUNUSED_PARAMETER(SizeOfTag);\n@@ -3547,0 +3614,1 @@\n+    cmsInt32Number SignedSizeOfTag = (cmsInt32Number)SizeOfTag;\n@@ -3553,0 +3621,2 @@\n+\n+    if (SignedSizeOfTag < (cmsInt32Number) sizeof(cmsUInt32Number)) return NULL;\n@@ -3554,2 +3624,1 @@\n-    if (SizeOfTag < sizeof(cmsUInt32Number)) return NULL;\n-    SizeOfTag -= sizeof(cmsUInt32Number);\n+    SignedSizeOfTag -= sizeof(cmsUInt32Number);\n@@ -3558,1 +3627,1 @@\n-    if (n ->Ucr == NULL) return NULL;\n+    if (n ->Ucr == NULL) goto error;\n@@ -3560,3 +3629,4 @@\n-    if (!_cmsReadUInt16Array(io, CountUcr, n ->Ucr->Table16)) return NULL;\n-    if (SizeOfTag < sizeof(cmsUInt32Number)) return NULL;\n-    SizeOfTag -= CountUcr * sizeof(cmsUInt16Number);\n+    if (SignedSizeOfTag < (cmsInt32Number)(CountUcr * sizeof(cmsUInt16Number))) goto error;\n+    if (!_cmsReadUInt16Array(io, CountUcr, n ->Ucr->Table16)) goto error;\n+\n+    SignedSizeOfTag -= CountUcr * sizeof(cmsUInt16Number);\n@@ -3565,3 +3635,4 @@\n-    if (!_cmsReadUInt32Number(io, &CountBg)) return NULL;\n-    if (SizeOfTag < sizeof(cmsUInt32Number)) return NULL;\n-    SizeOfTag -= sizeof(cmsUInt32Number);\n+\n+    if (SignedSizeOfTag < (cmsInt32Number)sizeof(cmsUInt32Number)) goto error;\n+    if (!_cmsReadUInt32Number(io, &CountBg)) goto error;\n+    SignedSizeOfTag -= sizeof(cmsUInt32Number);\n@@ -3570,5 +3641,7 @@\n-    if (n ->Bg == NULL) return NULL;\n-    if (!_cmsReadUInt16Array(io, CountBg, n ->Bg->Table16)) return NULL;\n-    if (SizeOfTag < CountBg * sizeof(cmsUInt16Number)) return NULL;\n-    SizeOfTag -= CountBg * sizeof(cmsUInt16Number);\n-    if (SizeOfTag == UINT_MAX) return NULL;\n+    if (n ->Bg == NULL) goto error;\n+\n+    if (SignedSizeOfTag < (cmsInt32Number) (CountBg * sizeof(cmsUInt16Number))) goto error;\n+    if (!_cmsReadUInt16Array(io, CountBg, n ->Bg->Table16)) goto error;\n+    SignedSizeOfTag -= CountBg * sizeof(cmsUInt16Number);\n+\n+    if (SignedSizeOfTag < 0 || SignedSizeOfTag > 32000) goto error;\n@@ -3578,1 +3651,1 @@\n-    if (n ->Desc == NULL) return NULL;\n+    if (n ->Desc == NULL) goto error;\n@@ -3580,3 +3653,8 @@\n-    ASCIIString = (char*) _cmsMalloc(self ->ContextID, SizeOfTag + 1);\n-    if (io ->Read(io, ASCIIString, sizeof(char), SizeOfTag) != SizeOfTag) return NULL;\n-    ASCIIString[SizeOfTag] = 0;\n+    ASCIIString = (char*) _cmsMalloc(self ->ContextID, SignedSizeOfTag + 1);\n+    if (io->Read(io, ASCIIString, sizeof(char), SignedSizeOfTag) != (cmsUInt32Number)SignedSizeOfTag)\n+    {\n+        _cmsFree(self->ContextID, ASCIIString);\n+        goto error;\n+    }\n+\n+    ASCIIString[SignedSizeOfTag] = 0;\n@@ -3588,0 +3666,10 @@\n+\n+error:\n+\n+    if (n->Ucr) cmsFreeToneCurve(n->Ucr);\n+    if (n->Bg) cmsFreeToneCurve(n->Bg);\n+    if (n->Desc) cmsMLUfree(n->Desc);\n+    _cmsFree(self->ContextID, n);\n+    *nItems = 0;\n+    return NULL;\n+\n@@ -3668,1 +3756,1 @@\n-cmsBool  ReadCountAndSting(struct _cms_typehandler_struct* self, cmsIOHANDLER* io, cmsMLU* mlu, cmsUInt32Number* SizeOfTag, const char* Section)\n+cmsBool  ReadCountAndString(struct _cms_typehandler_struct* self, cmsIOHANDLER* io, cmsMLU* mlu, cmsUInt32Number* SizeOfTag, const char* Section)\n@@ -3698,1 +3786,1 @@\n-cmsBool  WriteCountAndSting(struct _cms_typehandler_struct* self, cmsIOHANDLER* io, cmsMLU* mlu, const char* Section)\n+cmsBool  WriteCountAndString(struct _cms_typehandler_struct* self, cmsIOHANDLER* io, cmsMLU* mlu, const char* Section)\n@@ -3722,5 +3810,5 @@\n-    if (!ReadCountAndSting(self, io, mlu, &SizeOfTag, \"nm\")) goto Error;\n-    if (!ReadCountAndSting(self, io, mlu, &SizeOfTag, \"#0\")) goto Error;\n-    if (!ReadCountAndSting(self, io, mlu, &SizeOfTag, \"#1\")) goto Error;\n-    if (!ReadCountAndSting(self, io, mlu, &SizeOfTag, \"#2\")) goto Error;\n-    if (!ReadCountAndSting(self, io, mlu, &SizeOfTag, \"#3\")) goto Error;\n+    if (!ReadCountAndString(self, io, mlu, &SizeOfTag, \"nm\")) goto Error;\n+    if (!ReadCountAndString(self, io, mlu, &SizeOfTag, \"#0\")) goto Error;\n+    if (!ReadCountAndString(self, io, mlu, &SizeOfTag, \"#1\")) goto Error;\n+    if (!ReadCountAndString(self, io, mlu, &SizeOfTag, \"#2\")) goto Error;\n+    if (!ReadCountAndString(self, io, mlu, &SizeOfTag, \"#3\")) goto Error;\n@@ -3743,5 +3831,5 @@\n-    if (!WriteCountAndSting(self, io, mlu, \"nm\")) goto Error;\n-    if (!WriteCountAndSting(self, io, mlu, \"#0\")) goto Error;\n-    if (!WriteCountAndSting(self, io, mlu, \"#1\")) goto Error;\n-    if (!WriteCountAndSting(self, io, mlu, \"#2\")) goto Error;\n-    if (!WriteCountAndSting(self, io, mlu, \"#3\")) goto Error;\n+    if (!WriteCountAndString(self, io, mlu, \"nm\")) goto Error;\n+    if (!WriteCountAndString(self, io, mlu, \"#0\")) goto Error;\n+    if (!WriteCountAndString(self, io, mlu, \"#1\")) goto Error;\n+    if (!WriteCountAndString(self, io, mlu, \"#2\")) goto Error;\n+    if (!WriteCountAndString(self, io, mlu, \"#3\")) goto Error;\n@@ -4001,1 +4089,1 @@\n-            case cmsSigFormulaCurveSeg: {\n+           case cmsSigFormulaCurveSeg: {\n@@ -4003,2 +4091,2 @@\n-                cmsUInt16Number Type;\n-                cmsUInt32Number ParamsByType[] = {4, 5, 5 };\n+               cmsUInt16Number Type;\n+               cmsUInt32Number ParamsByType[] = { 4, 5, 5 };\n@@ -4006,2 +4094,2 @@\n-                if (!_cmsReadUInt16Number(io, &Type)) goto Error;\n-                if (!_cmsReadUInt16Number(io, NULL)) goto Error;\n+               if (!_cmsReadUInt16Number(io, &Type)) goto Error;\n+               if (!_cmsReadUInt16Number(io, NULL)) goto Error;\n@@ -4009,2 +4097,2 @@\n-                Segments[i].Type = Type + 6;\n-                if (Type > 2) goto Error;\n+               Segments[i].Type = Type + 6;\n+               if (Type > 2) goto Error;\n@@ -4012,1 +4100,1 @@\n-                for (j=0; j < ParamsByType[Type]; j++) {\n+               for (j = 0; j < ParamsByType[Type]; j++) {\n@@ -4014,6 +4102,6 @@\n-                    cmsFloat32Number f;\n-                    if (!_cmsReadFloat32Number(io, &f)) goto Error;\n-                    Segments[i].Params[j] = f;\n-                }\n-                }\n-                break;\n+                   cmsFloat32Number f;\n+                   if (!_cmsReadFloat32Number(io, &f)) goto Error;\n+                   Segments[i].Params[j] = f;\n+               }\n+           }\n+           break;\n@@ -4022,2 +4110,2 @@\n-            case cmsSigSampledCurveSeg: {\n-                cmsUInt32Number Count;\n+           case cmsSigSampledCurveSeg: {\n+               cmsUInt32Number Count;\n@@ -4025,1 +4113,1 @@\n-                if (!_cmsReadUInt32Number(io, &Count)) goto Error;\n+               if (!_cmsReadUInt32Number(io, &Count)) goto Error;\n@@ -4027,3 +4115,5 @@\n-                Segments[i].nGridPoints = Count;\n-                Segments[i].SampledPoints = (cmsFloat32Number*) _cmsCalloc(self ->ContextID, Count, sizeof(cmsFloat32Number));\n-                if (Segments[i].SampledPoints == NULL) goto Error;\n+               \/\/ The first point is implicit in the last stage, we allocate an extra note to be populated latter on\n+               Count++;\n+               Segments[i].nGridPoints = Count;\n+               Segments[i].SampledPoints = (cmsFloat32Number*)_cmsCalloc(self->ContextID, Count, sizeof(cmsFloat32Number));\n+               if (Segments[i].SampledPoints == NULL) goto Error;\n@@ -4031,5 +4121,6 @@\n-                for (j=0; j < Count; j++) {\n-                    if (!_cmsReadFloat32Number(io, &Segments[i].SampledPoints[j])) goto Error;\n-                }\n-                }\n-                break;\n+               Segments[i].SampledPoints[0] = 0;\n+               for (j = 1; j < Count; j++) {\n+                   if (!_cmsReadFloat32Number(io, &Segments[i].SampledPoints[j])) goto Error;\n+               }\n+           }\n+           break;\n@@ -4055,0 +4146,11 @@\n+\n+     \/\/ Explore for missing implicit points\n+     for (i = 0; i < nSegments; i++) {\n+\n+         \/\/ If sampled curve, fix it\n+         if (Curve->Segments[i].Type == 0) {\n+\n+             Curve->Segments[i].SampledPoints[0] = cmsEvalToneCurveFloat(Curve, Curve->Segments[i].x0);\n+         }\n+     }\n+\n@@ -4149,1 +4251,1 @@\n-            \/\/ This is a sampled curve\n+            \/\/ This is a sampled curve. First point is implicit in the ICC format, but not in our representation\n@@ -4152,1 +4254,1 @@\n-            if (!_cmsWriteUInt32Number(io, ActualSeg -> nGridPoints)) goto Error;\n+            if (!_cmsWriteUInt32Number(io, ActualSeg -> nGridPoints - 1)) goto Error;\n@@ -4154,1 +4256,1 @@\n-            for (j=0; j < g ->Segments[i].nGridPoints; j++) {\n+            for (j=1; j < g ->Segments[i].nGridPoints; j++) {\n@@ -4531,1 +4633,1 @@\n-\/\/ This one is a liitle bit more complex, so we don't use position tables this time.\n+\/\/ This one is a little bit more complex, so we don't use position tables this time.\n@@ -4963,1 +5065,1 @@\n-    \/\/ An offset of zero has special meaning and shal be preserved\n+    \/\/ An offset of zero has special meaning and shall be preserved\n@@ -4971,1 +5073,3 @@\n-cmsBool ReadOffsetArray(cmsIOHANDLER* io,  _cmsDICarray* a, cmsUInt32Number Count, cmsUInt32Number Length, cmsUInt32Number BaseOffset)\n+cmsBool ReadOffsetArray(cmsIOHANDLER* io,  _cmsDICarray* a,\n+                        cmsUInt32Number Count, cmsUInt32Number Length, cmsUInt32Number BaseOffset,\n+                        cmsInt32Number* SignedSizeOfTagPtr)\n@@ -4974,0 +5078,1 @@\n+    cmsInt32Number SignedSizeOfTag = *SignedSizeOfTagPtr;\n@@ -4978,0 +5083,3 @@\n+        if (SignedSizeOfTag < 4 * (cmsInt32Number) sizeof(cmsUInt32Number)) return FALSE;\n+        SignedSizeOfTag -= 4 * sizeof(cmsUInt32Number);\n+\n@@ -4983,0 +5091,3 @@\n+            if (SignedSizeOfTag < 2 * (cmsInt32Number) sizeof(cmsUInt32Number)) return FALSE;\n+            SignedSizeOfTag -= 2 * sizeof(cmsUInt32Number);\n+\n@@ -4989,0 +5100,3 @@\n+            if (SignedSizeOfTag < 2 * (cmsInt32Number) sizeof(cmsUInt32Number)) return FALSE;\n+            SignedSizeOfTag -= 2 * (cmsInt32Number) sizeof(cmsUInt32Number);\n+\n@@ -4992,0 +5106,2 @@\n+\n+    *SignedSizeOfTagPtr = SignedSizeOfTag;\n@@ -5139,1 +5255,1 @@\n-   cmsHANDLE hDict;\n+   cmsHANDLE hDict = NULL;\n@@ -5146,0 +5262,1 @@\n+   cmsInt32Number SignedSizeOfTag = (cmsInt32Number)SizeOfTag;\n@@ -5148,0 +5265,1 @@\n+    memset(&a, 0, sizeof(a));\n@@ -5153,0 +5271,2 @@\n+    SignedSizeOfTag -= sizeof(cmsUInt32Number);\n+    if (SignedSizeOfTag < 0) goto Error;\n@@ -5154,1 +5274,0 @@\n-    SizeOfTag -= sizeof(cmsUInt32Number);\n@@ -5157,0 +5276,2 @@\n+    SignedSizeOfTag -= sizeof(cmsUInt32Number);\n+    if (SignedSizeOfTag < 0) goto Error;\n@@ -5158,1 +5279,1 @@\n-    SizeOfTag -= sizeof(cmsUInt32Number);\n+\n@@ -5174,1 +5295,1 @@\n-    if (!ReadOffsetArray(io, &a, Count, Length, BaseOffset)) goto Error;\n+    if (!ReadOffsetArray(io, &a, Count, Length, BaseOffset, &SignedSizeOfTag)) goto Error;\n@@ -5214,1 +5335,1 @@\n-   cmsDictFree(hDict);\n+   if (hDict != NULL) cmsDictFree(hDict);\n@@ -5312,0 +5433,58 @@\n+\/\/ cicp VideoSignalType\n+\n+static\n+void* Type_VideoSignal_Read(struct _cms_typehandler_struct* self, cmsIOHANDLER* io, cmsUInt32Number* nItems, cmsUInt32Number SizeOfTag)\n+{\n+    cmsVideoSignalType* cicp = NULL;\n+\n+    if (SizeOfTag != 8) return NULL;\n+\n+    if (!_cmsReadUInt32Number(io, NULL)) return NULL;\n+\n+    cicp = (cmsVideoSignalType*)_cmsCalloc(self->ContextID, 1, sizeof(cmsVideoSignalType));\n+    if (cicp == NULL) return NULL;\n+\n+    if (!_cmsReadUInt8Number(io, &cicp->ColourPrimaries)) goto Error;\n+    if (!_cmsReadUInt8Number(io, &cicp->TransferCharacteristics)) goto Error;\n+    if (!_cmsReadUInt8Number(io, &cicp->MatrixCoefficients)) goto Error;\n+    if (!_cmsReadUInt8Number(io, &cicp->VideoFullRangeFlag)) goto Error;\n+\n+    \/\/ Success\n+    *nItems = 1;\n+    return cicp;\n+\n+Error:\n+    if (cicp != NULL) _cmsFree(self->ContextID, cicp);\n+    return NULL;\n+}\n+\n+static\n+cmsBool Type_VideoSignal_Write(struct _cms_typehandler_struct* self, cmsIOHANDLER* io, void* Ptr, cmsUInt32Number nItems)\n+{\n+    cmsVideoSignalType* cicp = (cmsVideoSignalType*)Ptr;\n+\n+    if (!_cmsWriteUInt32Number(io, 0)) return FALSE;\n+    if (!_cmsWriteUInt8Number(io, cicp->ColourPrimaries)) return FALSE;\n+    if (!_cmsWriteUInt8Number(io, cicp->TransferCharacteristics)) return FALSE;\n+    if (!_cmsWriteUInt8Number(io, cicp->MatrixCoefficients)) return FALSE;\n+    if (!_cmsWriteUInt8Number(io, cicp->VideoFullRangeFlag)) return FALSE;\n+\n+    return TRUE;\n+\n+    cmsUNUSED_PARAMETER(self);\n+    cmsUNUSED_PARAMETER(nItems);\n+}\n+\n+void* Type_VideoSignal_Dup(struct _cms_typehandler_struct* self, const void* Ptr, cmsUInt32Number n)\n+{\n+    return _cmsDupMem(self->ContextID, Ptr, sizeof(cmsVideoSignalType));\n+\n+    cmsUNUSED_PARAMETER(n);\n+}\n+\n+\n+static\n+void Type_VideoSignal_Free(struct _cms_typehandler_struct* self, void* Ptr)\n+{\n+    _cmsFree(self->ContextID, Ptr);\n+}\n@@ -5351,0 +5530,1 @@\n+{TYPE_HANDLER(cmsSigcicpType,                  VideoSignal),        (_cmsTagTypeLinkedList*) &SupportedTagTypes[31] },\n@@ -5545,0 +5725,2 @@\n+    { cmsSigcicpTag,                { 1, 1, { cmsSigcicpType},               NULL },   &SupportedTags[64]},\n+\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmstypes.c","additions":294,"deletions":112,"binary":false,"changes":406,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -146,1 +146,1 @@\n-    cmsSetProfileVersion(hICC, 4.3);\n+    cmsSetProfileVersion(hICC, 4.4);\n@@ -267,1 +267,1 @@\n-    cmsSetProfileVersion(hICC, 4.3);\n+    cmsSetProfileVersion(hICC, 4.4);\n@@ -323,1 +323,1 @@\n-    cmsUInt32Number nChannels;\n+    cmsInt32Number nChannels;\n@@ -329,1 +329,1 @@\n-    cmsSetProfileVersion(hICC, 4.3);\n+    cmsSetProfileVersion(hICC, 4.4);\n@@ -338,1 +338,1 @@\n-    nChannels = cmsChannelsOf(ColorSpace);\n+    nChannels = cmsChannelsOfColorSpace(ColorSpace);\n@@ -400,1 +400,1 @@\n-    SumCMY   = In[0]  + In[1] + In[2];\n+    SumCMY   = (cmsFloat64Number) In[0]  + In[1] + In[2];\n@@ -429,1 +429,1 @@\n-    cmsUInt32Number nChannels;\n+    cmsInt32Number nChannels;\n@@ -448,1 +448,1 @@\n-    cmsSetProfileVersion(hICC, 4.3);\n+    cmsSetProfileVersion(hICC, 4.4);\n@@ -558,1 +558,1 @@\n-    cmsSetProfileVersion(hProfile, 4.3);\n+    cmsSetProfileVersion(hProfile, 4.4);\n@@ -604,1 +604,1 @@\n-    cmsSetProfileVersion(hProfile, 4.3);\n+    cmsSetProfileVersion(hProfile, 4.4);\n@@ -871,1 +871,1 @@\n-    cmsSetProfileVersion(hProfile, 4.3);\n+    cmsSetProfileVersion(hProfile, 4.4);\n@@ -1006,1 +1006,1 @@\n-        | BYTES_SH(2) | CHANNELS_SH(cmsChannelsOf(v ->ExitColorSpace)));\n+        | BYTES_SH(2) | CHANNELS_SH(cmsChannelsOfColorSpace(v ->ExitColorSpace)));\n@@ -1094,2 +1094,3 @@\n-    cmsUInt32Number FrmIn, FrmOut, ChansIn, ChansOut;\n-    int ColorSpaceBitsIn, ColorSpaceBitsOut;\n+        cmsUInt32Number FrmIn, FrmOut;\n+        cmsInt32Number ChansIn, ChansOut;\n+        int ColorSpaceBitsIn, ColorSpaceBitsOut;\n@@ -1146,2 +1147,2 @@\n-    ChansIn  = cmsChannelsOf(xform -> EntryColorSpace);\n-    ChansOut = cmsChannelsOf(xform -> ExitColorSpace);\n+    ChansIn  = cmsChannelsOfColorSpace(xform -> EntryColorSpace);\n+    ChansOut = cmsChannelsOfColorSpace(xform -> ExitColorSpace);\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsvirt.c","additions":18,"deletions":17,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -296,1 +296,1 @@\n-\/\/ aspects of the RGB to XYZ process, and assumming that the gamma correction\n+\/\/ aspects of the RGB to XYZ process, and assuming that the gamma correction\n@@ -299,1 +299,1 @@\n-\/\/ the alghoritm:\n+\/\/ the algorithm:\n@@ -304,2 +304,2 @@\n-\/\/              obtaining the coeficients of the transformation\n-\/\/            - Then, I apply these coeficients to the original matrix\n+\/\/              obtaining the coefficients of the transformation\n+\/\/            - Then, I apply these coefficients to the original matrix\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmswtpnt.c","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -316,1 +316,1 @@\n-            \/\/ Any gamut chack to do?\n+            \/\/ Any gamut check to do?\n@@ -813,0 +813,67 @@\n+\/\/ Returns the worker callback for parallelization plug-ins\n+_cmsTransform2Fn CMSEXPORT _cmsGetTransformWorker(struct _cmstransform_struct* CMMcargo)\n+{\n+    _cmsAssert(CMMcargo != NULL);\n+    return CMMcargo->Worker;\n+}\n+\n+\/\/ This field holds maximum number of workers or -1 to auto\n+cmsInt32Number CMSEXPORT _cmsGetTransformMaxWorkers(struct _cmstransform_struct* CMMcargo)\n+{\n+    _cmsAssert(CMMcargo != NULL);\n+    return CMMcargo->MaxWorkers;\n+}\n+\n+\/\/ This field is actually unused and reserved\n+cmsUInt32Number CMSEXPORT _cmsGetTransformWorkerFlags(struct _cmstransform_struct* CMMcargo)\n+{\n+    _cmsAssert(CMMcargo != NULL);\n+    return CMMcargo->WorkerFlags;\n+}\n+\n+\/\/ In the case there is a parallelization plug-in, let it to do its job\n+static\n+void ParalellizeIfSuitable(_cmsTRANSFORM* p)\n+{\n+    _cmsParallelizationPluginChunkType* ctx = (_cmsParallelizationPluginChunkType*)_cmsContextGetClientChunk(p->ContextID, ParallelizationPlugin);\n+\n+    _cmsAssert(p != NULL);\n+    if (ctx != NULL && ctx->SchedulerFn != NULL) {\n+\n+        p->Worker = p->xform;\n+        p->xform = ctx->SchedulerFn;\n+        p->MaxWorkers = ctx->MaxWorkers;\n+        p->WorkerFlags = ctx->WorkerFlags;\n+    }\n+}\n+\n+\n+\/**\n+* An empty unroll to avoid a check with NULL on cmsDoTransform()\n+*\/\n+static\n+cmsUInt8Number* UnrollNothing(CMSREGISTER _cmsTRANSFORM* info,\n+                              CMSREGISTER cmsUInt16Number wIn[],\n+                              CMSREGISTER cmsUInt8Number* accum,\n+                              CMSREGISTER cmsUInt32Number Stride)\n+{\n+    return accum;\n+\n+    cmsUNUSED_PARAMETER(info);\n+    cmsUNUSED_PARAMETER(wIn);\n+    cmsUNUSED_PARAMETER(Stride);\n+}\n+\n+static\n+cmsUInt8Number* PackNothing(CMSREGISTER _cmsTRANSFORM* info,\n+                           CMSREGISTER cmsUInt16Number wOut[],\n+                           CMSREGISTER cmsUInt8Number* output,\n+                           CMSREGISTER cmsUInt32Number Stride)\n+{\n+    return output;\n+\n+    cmsUNUSED_PARAMETER(info);\n+    cmsUNUSED_PARAMETER(wOut);\n+    cmsUNUSED_PARAMETER(Stride);\n+}\n+\n@@ -868,0 +935,1 @@\n+                       ParalellizeIfSuitable(p);\n@@ -878,1 +946,1 @@\n-    if (_cmsFormatterIsFloat(*InputFormat) && _cmsFormatterIsFloat(*OutputFormat)) {\n+    if (_cmsFormatterIsFloat(*OutputFormat)) {\n@@ -904,0 +972,1 @@\n+        \/\/ Formats are intended to be changed before use\n@@ -905,1 +974,2 @@\n-            p ->FromInput = p ->ToOutput = NULL;\n+            p->FromInput = UnrollNothing;\n+            p->ToOutput = PackNothing;\n@@ -922,1 +992,1 @@\n-            BytesPerPixelInput = T_BYTES(p ->InputFormat);\n+            BytesPerPixelInput = T_BYTES(*InputFormat);\n@@ -956,0 +1026,1 @@\n+    ParalellizeIfSuitable(p);\n@@ -1113,0 +1184,9 @@\n+    \/\/ Check whatever the transform is 16 bits and involves linear RGB in first profile. If so, disable optimizations\n+    if (EntryColorSpace == cmsSigRgbData && T_BYTES(InputFormat) == 2 && !(dwFlags & cmsFLAGS_NOOPTIMIZE))\n+    {\n+        cmsFloat64Number gamma = cmsDetectRGBProfileGamma(hProfiles[0], 0.1);\n+\n+        if (gamma > 0 && gamma < 1.6)\n+            dwFlags |= cmsFLAGS_NOOPTIMIZE;\n+    }\n+\n@@ -1121,2 +1201,2 @@\n-    if ((cmsChannelsOf(EntryColorSpace) != cmsPipelineInputChannels(Lut)) ||\n-        (cmsChannelsOf(ExitColorSpace)  != cmsPipelineOutputChannels(Lut))) {\n+    if ((cmsChannelsOfColorSpace(EntryColorSpace) != (cmsInt32Number) cmsPipelineInputChannels(Lut)) ||\n+        (cmsChannelsOfColorSpace(ExitColorSpace)  != (cmsInt32Number) cmsPipelineOutputChannels(Lut))) {\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/cmsxform.c","additions":87,"deletions":7,"binary":false,"changes":94,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2021 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -55,1 +55,1 @@\n-\/\/ Version 2.12\n+\/\/ Version 2.14\n@@ -113,1 +113,1 @@\n-#define LCMS_VERSION        2120\n+#define LCMS_VERSION        2140\n@@ -184,1 +184,1 @@\n-#if defined(CMS_NO_REGISTER_KEYWORD) && !defined(CMS_DLL) && !defined(CMS_DLL_BUILD)\n+#if defined(CMS_NO_REGISTER_KEYWORD)\n@@ -322,0 +322,1 @@\n+    cmsSigcicpType                          = 0x63696370,  \/\/ 'cicp'\n@@ -433,0 +434,1 @@\n+    cmsSigcicpTag                           = 0x63696370,  \/\/ 'cicp'\n@@ -698,2 +700,2 @@\n-\/\/                          3 2 10987 6 5 4 3 2 1 098 7654 321\n-\/\/                          A O TTTTT U Y F P X S EEE CCCC BBB\n+\/\/                        4 3 2 10987 6 5 4 3 2 1 098 7654 321\n+\/\/                        M A O TTTTT U Y F P X S EEE CCCC BBB\n@@ -701,0 +703,1 @@\n+\/\/            M: Premultiplied alpha (only works when extra samples is 1)\n@@ -713,0 +716,1 @@\n+#define PREMUL_SH(m)           ((m) << 23)\n@@ -726,0 +730,1 @@\n+#define T_PREMUL(m)           (((m)>>23)&1)\n@@ -754,1 +759,0 @@\n-\n@@ -770,1 +774,0 @@\n-\n@@ -784,0 +787,1 @@\n+#define TYPE_GRAYA_8_PREMUL    (COLORSPACE_SH(PT_GRAY)|EXTRA_SH(1)|CHANNELS_SH(1)|BYTES_SH(1)|PREMUL_SH(1))\n@@ -785,0 +789,1 @@\n+#define TYPE_GRAYA_16_PREMUL   (COLORSPACE_SH(PT_GRAY)|EXTRA_SH(1)|CHANNELS_SH(1)|BYTES_SH(2)|PREMUL_SH(1))\n@@ -801,0 +806,1 @@\n+#define TYPE_RGBA_8_PREMUL     (COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(1)|PREMUL_SH(1))\n@@ -803,0 +809,1 @@\n+#define TYPE_RGBA_16_PREMUL    (COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(2)|PREMUL_SH(1))\n@@ -807,0 +814,1 @@\n+#define TYPE_ARGB_8_PREMUL     (COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(1)|SWAPFIRST_SH(1)|PREMUL_SH(1))\n@@ -809,0 +817,1 @@\n+#define TYPE_ARGB_16_PREMUL    (COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(2)|SWAPFIRST_SH(1)|PREMUL_SH(1))\n@@ -811,0 +820,1 @@\n+#define TYPE_ABGR_8_PREMUL     (COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(1)|DOSWAP_SH(1)|PREMUL_SH(1))\n@@ -813,0 +823,1 @@\n+#define TYPE_ABGR_16_PREMUL    (COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(2)|DOSWAP_SH(1)|PREMUL_SH(1))\n@@ -817,0 +828,1 @@\n+#define TYPE_BGRA_8_PREMUL     (COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(1)|DOSWAP_SH(1)|SWAPFIRST_SH(1)|PREMUL_SH(1))\n@@ -819,0 +831,1 @@\n+#define TYPE_BGRA_16_PREMUL    (COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(2)|DOSWAP_SH(1)|SWAPFIRST_SH(1)|PREMUL_SH(1))\n@@ -935,1 +948,1 @@\n-\/\/ Named color index. Only 16 bits allowed (don't check colorspace)\n+\/\/ Named color index. Only 16 bits is allowed (don't check colorspace)\n@@ -943,0 +956,2 @@\n+#define TYPE_GRAYA_FLT        (FLOAT_SH(1)|COLORSPACE_SH(PT_GRAY)|CHANNELS_SH(1)|BYTES_SH(4)|EXTRA_SH(1))\n+#define TYPE_GRAYA_FLT_PREMUL (FLOAT_SH(1)|COLORSPACE_SH(PT_GRAY)|CHANNELS_SH(1)|BYTES_SH(4)|EXTRA_SH(1)|PREMUL_SH(1))\n@@ -946,0 +961,1 @@\n+#define TYPE_RGBA_FLT_PREMUL  (FLOAT_SH(1)|COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(4)|PREMUL_SH(1))\n@@ -947,0 +963,1 @@\n+#define TYPE_ARGB_FLT_PREMUL  (FLOAT_SH(1)|COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(4)|SWAPFIRST_SH(1)|PREMUL_SH(1))\n@@ -949,0 +966,1 @@\n+#define TYPE_BGRA_FLT_PREMUL  (FLOAT_SH(1)|COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(4)|DOSWAP_SH(1)|SWAPFIRST_SH(1)|PREMUL_SH(1))\n@@ -950,0 +968,1 @@\n+#define TYPE_ABGR_FLT_PREMUL  (FLOAT_SH(1)|COLORSPACE_SH(PT_RGB)|EXTRA_SH(1)|CHANNELS_SH(3)|BYTES_SH(4)|DOSWAP_SH(1)|PREMUL_SH(1))\n@@ -1053,0 +1072,10 @@\n+typedef struct {\n+    cmsUInt8Number  ColourPrimaries;            \/\/ Recommendation ITU-T H.273\n+    cmsUInt8Number  TransferCharacteristics;    \/\/  (ISO\/IEC 23091-2)\n+    cmsUInt8Number  MatrixCoefficients;\n+    cmsUInt8Number  VideoFullRangeFlag;\n+\n+} cmsVideoSignalType;\n+\n+\n+\n@@ -1288,0 +1317,1 @@\n+CMSAPI cmsContext        CMSEXPORT cmsGetStageContextID(const cmsStage* mpe);\n@@ -1534,0 +1564,1 @@\n+\/\/ Deprecated, use cmsChannelsOfColorSpace instead\n@@ -1536,0 +1567,3 @@\n+\/\/ Get number of channels of color space or -1 if color space is not listed\/supported\n+CMSAPI cmsInt32Number CMSEXPORT cmsChannelsOfColorSpace(cmsColorSpaceSignature ColorSpace);\n+\n@@ -1938,0 +1972,2 @@\n+\/\/ Estimate gamma space, always positive. Returns -1 on error.\n+CMSAPI cmsFloat64Number CMSEXPORT cmsDetectRGBProfileGamma(cmsHPROFILE hProfile, cmsFloat64Number threshold);\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/lcms2.h","additions":45,"deletions":9,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -315,2 +315,2 @@\n-        EnterCriticalSection(m);\n-        return 0;\n+    EnterCriticalSection(m);\n+    return 0;\n@@ -321,2 +321,2 @@\n-        LeaveCriticalSection(m);\n-        return 0;\n+    LeaveCriticalSection(m);\n+    return 0;\n@@ -327,2 +327,2 @@\n-        InitializeCriticalSection(m);\n-        return 0;\n+    InitializeCriticalSection(m);\n+    return 0;\n@@ -333,2 +333,2 @@\n-        DeleteCriticalSection(m);\n-        return 0;\n+    DeleteCriticalSection(m);\n+    return 0;\n@@ -339,2 +339,2 @@\n-        EnterCriticalSection(m);\n-        return 0;\n+    EnterCriticalSection(m);\n+    return 0;\n@@ -345,2 +345,2 @@\n-        LeaveCriticalSection(m);\n-        return 0;\n+    LeaveCriticalSection(m);\n+    return 0;\n@@ -360,1 +360,1 @@\n-        return pthread_mutex_lock(m);\n+    return pthread_mutex_lock(m);\n@@ -365,1 +365,1 @@\n-        return pthread_mutex_unlock(m);\n+    return pthread_mutex_unlock(m);\n@@ -370,1 +370,1 @@\n-        return pthread_mutex_init(m, NULL);\n+    return pthread_mutex_init(m, NULL);\n@@ -375,1 +375,1 @@\n-        return pthread_mutex_destroy(m);\n+    return pthread_mutex_destroy(m);\n@@ -380,1 +380,1 @@\n-        return pthread_mutex_lock(m);\n+    return pthread_mutex_lock(m);\n@@ -385,1 +385,1 @@\n-        return pthread_mutex_unlock(m);\n+    return pthread_mutex_unlock(m);\n@@ -398,1 +398,1 @@\n-        return 0;\n+    return 0;\n@@ -404,1 +404,1 @@\n-        return 0;\n+    return 0;\n@@ -410,1 +410,1 @@\n-        return 0;\n+    return 0;\n@@ -416,1 +416,1 @@\n-        return 0;\n+    return 0;\n@@ -422,1 +422,1 @@\n-        return 0;\n+    return 0;\n@@ -428,1 +428,1 @@\n-        return 0;\n+    return 0;\n@@ -470,0 +470,3 @@\n+\/\/ Paralellization\n+cmsBool _cmsRegisterParallelizationPlugin(cmsContext ContextID, cmsPluginBase* Plugin);\n+\n@@ -517,0 +520,1 @@\n+    ParallelizationPlugin,\n@@ -752,0 +756,18 @@\n+\/\/ Container for parallelization plug-in\n+typedef struct {\n+\n+    cmsInt32Number      MaxWorkers;       \/\/ Number of workers to do as maximum\n+    cmsInt32Number      WorkerFlags;      \/\/ reserved\n+    _cmsTransform2Fn    SchedulerFn;      \/\/ callback to setup functions\n+\n+} _cmsParallelizationPluginChunkType;\n+\n+\/\/ The global Context0 storage for parallelization plug-in\n+extern  _cmsParallelizationPluginChunkType _cmsParallelizationPluginChunk;\n+\n+\/\/ Allocate parallelization container.\n+void _cmsAllocParallelizationPluginChunk(struct _cmsContext_struct* ctx,\n+                                         const struct _cmsContext_struct* src);\n+\n+\n+\n@@ -1113,0 +1135,5 @@\n+    \/\/ A one-worker transform entry for parallelization\n+    _cmsTransform2Fn Worker;\n+    cmsInt32Number   MaxWorkers;\n+    cmsUInt32Number  WorkerFlags;\n+\n@@ -1150,0 +1177,3 @@\n+\/\/ thread-safe gettime\n+cmsBool _cmsGetTime(struct tm* ptr_time);\n+\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/lcms2_internal.h","additions":55,"deletions":25,"binary":false,"changes":80,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-\/\/  Copyright (c) 1998-2020 Marti Maria Saguer\n+\/\/  Copyright (c) 1998-2022 Marti Maria Saguer\n@@ -56,1 +56,1 @@\n-\/\/ It is provided for plug-in writters that may want to access the support\n+\/\/ It is provided for plug-in writers that may want to access the support\n@@ -241,0 +241,1 @@\n+#define cmsPluginParalellizationSig          0x70726C48     \/\/ 'prlH\n@@ -628,1 +629,1 @@\n-                                     cmsUInt32Number Stride);                 \/\/ Stride in bytes to the next plana in planar formats\n+                                     cmsUInt32Number Stride);                 \/\/ Stride in bytes to the next plane in planar formats\n@@ -701,0 +702,19 @@\n+\/\/----------------------------------------------------------------------------------------------------------\n+\/\/ Parallelization\n+\n+CMSAPI _cmsTransform2Fn CMSEXPORT _cmsGetTransformWorker(struct _cmstransform_struct* CMMcargo);\n+CMSAPI cmsInt32Number   CMSEXPORT _cmsGetTransformMaxWorkers(struct _cmstransform_struct* CMMcargo);\n+CMSAPI cmsUInt32Number  CMSEXPORT _cmsGetTransformWorkerFlags(struct _cmstransform_struct* CMMcargo);\n+\n+\/\/ Let's plug-in to guess the best number of workers\n+#define CMS_GUESS_MAX_WORKERS -1\n+\n+typedef struct {\n+    cmsPluginBase       base;\n+\n+    cmsInt32Number      MaxWorkers;       \/\/ Number of starts to do as maximum\n+    cmsUInt32Number     WorkerFlags;      \/\/ Reserved\n+    _cmsTransform2Fn    SchedulerFn;      \/\/ callback to setup functions\n+\n+}  cmsPluginParalellization;\n+\n","filename":"jdk\/src\/share\/native\/sun\/java2d\/cmm\/lcms\/lcms2_plugin.h","additions":23,"deletions":3,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -390,0 +390,1 @@\n+security\/infra\/java\/security\/cert\/CertPathValidator\/certification\/CAInterop.java#actalisauthenticationrootca    8366176 generic-all\n@@ -391,0 +392,1 @@\n+security\/infra\/java\/security\/cert\/CertPathValidator\/certification\/CAInterop.java#entrustrootcag4        8367256 generic-all\n","filename":"jdk\/test\/ProblemList.txt","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,158 @@\n+\/*\n+ * Copyright (c) 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+  @test\n+  @bug 8154043\n+  @summary Fields not reachable anymore by tab-key, because of new tabbing\n+  behaviour of radio button groups.\n+  @run main ButtonGroupLayoutTraversalTest\n+*\/\n+\n+import javax.swing.*;\n+import java.awt.*;\n+import java.awt.event.FocusAdapter;\n+import java.awt.event.FocusEvent;\n+import java.awt.event.KeyEvent;\n+\n+public class ButtonGroupLayoutTraversalTest {\n+    static int nx = 3;\n+    static int ny = 3;\n+\n+    static int focusCnt[] = new int[nx * ny];\n+    private static JFrame window;\n+\n+\n+    public static void main(String[] args) throws Exception {\n+\n+        SwingUtilities.invokeAndWait(()->initLayout(nx, ny));\n+        Robot robot = new Robot();\n+        robot.setAutoDelay(100);\n+        robot.waitForIdle();\n+        robot.delay(200);\n+\n+\n+        for(int i = 0; i < nx * ny - nx * ny \/ 2 - 1; i++) {\n+            robot.keyPress(KeyEvent.VK_RIGHT);\n+            robot.keyRelease(KeyEvent.VK_RIGHT);\n+        }\n+\n+        for(int i = 0; i < nx * ny \/ 2; i++) {\n+            robot.keyPress(KeyEvent.VK_TAB);\n+            robot.keyRelease(KeyEvent.VK_TAB);\n+        }\n+\n+        robot.waitForIdle();\n+        robot.delay(200);\n+\n+        for(int i = 0; i < nx * ny; i++) {\n+            if(focusCnt[i] < 1) {\n+                SwingUtilities.invokeLater(window::dispose);\n+                throw new RuntimeException(\"Component \" + i +\n+                        \" is not reachable in the forward focus cycle\");\n+            } else if (focusCnt[i] > 1) {\n+                SwingUtilities.invokeLater(window::dispose);\n+                throw new RuntimeException(\"Component \" + i +\n+                        \" got focus more than once in the forward focus cycle\");\n+            }\n+        }\n+\n+        for(int i = 0; i < nx * ny \/ 2; i++) {\n+            robot.keyPress(KeyEvent.VK_SHIFT);\n+            robot.keyPress(KeyEvent.VK_TAB);\n+            robot.keyRelease(KeyEvent.VK_TAB);\n+            robot.keyRelease(KeyEvent.VK_SHIFT);\n+        }\n+\n+        for(int i = 0; i < nx * ny - nx * ny \/ 2 - 1; i++) {\n+            robot.keyPress(KeyEvent.VK_LEFT);\n+            robot.keyRelease(KeyEvent.VK_LEFT);\n+        }\n+\n+        robot.keyPress(KeyEvent.VK_SHIFT);\n+        robot.keyPress(KeyEvent.VK_TAB);\n+        robot.keyRelease(KeyEvent.VK_TAB);\n+        robot.keyRelease(KeyEvent.VK_SHIFT);\n+\n+        robot.waitForIdle();\n+        robot.delay(200);\n+\n+        for(int i = 0; i < nx * ny; i++) {\n+            if(focusCnt[i] < 2) {\n+                SwingUtilities.invokeLater(window::dispose);\n+                throw new RuntimeException(\"Component \" + i +\n+                        \" is not reachable in the backward focus cycle\");\n+            } else if (focusCnt[i] > 2) {\n+                SwingUtilities.invokeLater(window::dispose);\n+                throw new RuntimeException(\"Component \" + i +\n+                        \" got focus more than once in the backward focus cycle\");\n+            }\n+        }\n+\n+        SwingUtilities.invokeLater(window::dispose);\n+    }\n+\n+    public static void initLayout(int nx, int ny)\n+    {\n+        window = new JFrame(\"Test\");\n+        window.setDefaultCloseOperation(JFrame.DISPOSE_ON_CLOSE);\n+        JPanel rootPanel = new JPanel();\n+        rootPanel.setLayout(new BorderLayout());\n+        JPanel formPanel = new JPanel(new GridLayout(nx, ny));\n+        formPanel.setFocusTraversalPolicy(new LayoutFocusTraversalPolicy());\n+        formPanel.setFocusCycleRoot(true);\n+        ButtonGroup radioButtonGroup = new ButtonGroup();\n+        for(int i = 0; i < nx * ny; i++) {\n+            JToggleButton comp;\n+            if(i % 2 == 0) {\n+                comp = new JRadioButton(\"Grouped component\");\n+                radioButtonGroup.add(comp);\n+            } else {\n+                comp = new JRadioButton(\"Single component\");\n+            }\n+            formPanel.add(comp);\n+            int fi = i;\n+            comp.setBackground(Color.red);\n+            comp.addFocusListener(new FocusAdapter() {\n+                @Override\n+                public void focusGained(FocusEvent e) {\n+                    focusCnt[fi]++;\n+                    if( focusCnt[fi] == 1) {\n+                        ((JComponent) e.getSource())\n+                                .setBackground(Color.yellow);\n+                    } else if(focusCnt[fi] == 2) {\n+                        ((JComponent) e.getSource())\n+                                .setBackground(Color.green);\n+                    } else {\n+                        ((JComponent) e.getSource())\n+                                .setBackground(Color.red);\n+                    }\n+                }\n+            });\n+        }\n+        rootPanel.add(formPanel, BorderLayout.CENTER);\n+        window.add(rootPanel);\n+        window.pack();\n+        window.setVisible(true);\n+    }\n+}\n","filename":"jdk\/test\/java\/awt\/Focus\/FocusTraversalPolicy\/ButtonGroupLayoutTraversal\/ButtonGroupLayoutTraversalTest.java","additions":158,"deletions":0,"binary":false,"changes":158,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (C) 2022 THL A29 Limited, a Tencent company. All rights reserved.\n+ * Copyright (C) 2022, Tencent. All rights reserved.\n@@ -250,1 +250,0 @@\n-\n","filename":"jdk\/test\/javax\/net\/ssl\/ServerName\/EndingDotHostname.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (C) 2022 THL A29 Limited, a Tencent company. All rights reserved.\n+ * Copyright (C) 2022, Tencent. All rights reserved.\n","filename":"jdk\/test\/javax\/net\/ssl\/templates\/SSLExampleCert.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (C) 2022 THL A29 Limited, a Tencent company. All rights reserved.\n+ * Copyright (C) 2022, Tencent. All rights reserved.\n@@ -61,1 +61,0 @@\n-\n","filename":"jdk\/test\/javax\/security\/auth\/callback\/PasswordCallback\/CheckCleanerBound.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (C) 2022 THL A29 Limited, a Tencent company. All rights reserved.\n+ * Copyright (C) 2022, Tencent. All rights reserved.\n@@ -52,1 +52,0 @@\n-\n","filename":"jdk\/test\/javax\/security\/auth\/callback\/PasswordCallback\/PasswordCleanup.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,85 @@\n+\/*\n+ * Copyright (c) 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\/*\n+ * @test\n+ * @bug 8182577\n+ * @summary  Verifies if moving focus via custom ButtonModel causes crash\n+ * @run main DefaultButtonModelCrashTest\n+ *\/\n+import java.awt.BorderLayout;\n+import java.awt.Container;\n+import java.awt.Point;\n+import java.awt.Robot;\n+import java.awt.event.KeyEvent;\n+import javax.swing.ButtonModel;\n+import javax.swing.DefaultButtonModel;\n+import javax.swing.JCheckBox;\n+import javax.swing.JComponent;\n+import javax.swing.JFrame;\n+import javax.swing.JPanel;\n+import javax.swing.JTextField;\n+import javax.swing.SwingUtilities;\n+\n+public class DefaultButtonModelCrashTest {\n+    private JFrame frame = null;\n+    private JPanel panel;\n+    private volatile Point p = null;\n+\n+    public static void main(String[] args) throws Exception {\n+        new DefaultButtonModelCrashTest();\n+    }\n+\n+    public DefaultButtonModelCrashTest() throws Exception {\n+        try {\n+            Robot robot = new Robot();\n+            robot.setAutoDelay(200);\n+            SwingUtilities.invokeAndWait(() -> go());\n+            robot.waitForIdle();\n+            robot.keyPress(KeyEvent.VK_TAB);\n+            robot.keyRelease(KeyEvent.VK_TAB);\n+            robot.delay(100);\n+            robot.keyPress(KeyEvent.VK_TAB);\n+            robot.keyRelease(KeyEvent.VK_TAB);\n+        } finally {\n+            SwingUtilities.invokeAndWait(()->frame  .dispose());\n+        }\n+    }\n+\n+    private void go() {\n+\n+        frame = new JFrame();\n+        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);\n+        Container contentPane = frame.getContentPane();\n+        ButtonModel model = new DefaultButtonModel();\n+\n+        JCheckBox check = new JCheckBox(\"a bit broken\");\n+        check.setModel(model);\n+        panel = new JPanel(new BorderLayout());\n+        panel.add(new JTextField(\"Press Tab (twice?)\"), BorderLayout.NORTH);\n+        panel.add(check);\n+        contentPane.add(panel);\n+        frame.setLocationRelativeTo(null);\n+        frame.pack();\n+        frame.setVisible(true);\n+    }\n+}\n","filename":"jdk\/test\/javax\/swing\/DefaultButtonModel\/DefaultButtonModelCrashTest.java","additions":85,"deletions":0,"binary":false,"changes":85,"status":"added"},{"patch":"@@ -28,1 +28,1 @@\n- * @bug 8033699 8226892\n+ * @bug 8033699 8154043 8226892\n@@ -140,0 +140,1 @@\n+        hitKey(robot, KeyEvent.VK_TAB);\n@@ -166,0 +167,1 @@\n+        hitKey(robot, KeyEvent.VK_SHIFT, KeyEvent.VK_TAB);\n@@ -170,1 +172,1 @@\n-                if (KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner() != radioBtn3) {\n+                if (KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner() != radioBtn1) {\n@@ -172,1 +174,1 @@\n-                    throw new RuntimeException(\"Focus is not on Radio Button C as Expected\");\n+                    throw new RuntimeException(\"Focus is not on Radio Button A as Expected\");\n@@ -180,2 +182,2 @@\n-        hitKey(robot, KeyEvent.VK_UP);\n-        hitKey(robot, KeyEvent.VK_LEFT);\n+        hitKey(robot, KeyEvent.VK_DOWN);\n+        hitKey(robot, KeyEvent.VK_RIGHT);\n@@ -184,1 +186,1 @@\n-                if (KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner() != radioBtn1) {\n+                if (KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner() != radioBtn3) {\n@@ -186,1 +188,1 @@\n-                    throw new RuntimeException(\"Focus is not on Radio Button A as Expected\");\n+                    throw new RuntimeException(\"Focus is not on Radio Button C as Expected\");\n@@ -193,2 +195,2 @@\n-        hitKey(robot, KeyEvent.VK_DOWN);\n-        hitKey(robot, KeyEvent.VK_RIGHT);\n+        hitKey(robot, KeyEvent.VK_UP);\n+        hitKey(robot, KeyEvent.VK_LEFT);\n@@ -197,1 +199,1 @@\n-                if (KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner() != radioBtn3) {\n+                if (KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner() != radioBtn1) {\n@@ -199,1 +201,1 @@\n-                    throw new RuntimeException(\"Focus is not on Radio Button C as Expected\");\n+                    throw new RuntimeException(\"Focus is not on Radio Button A as Expected\");\n@@ -206,2 +208,2 @@\n-        hitKey(robot, KeyEvent.VK_DOWN);\n-        hitKey(robot, KeyEvent.VK_DOWN);\n+        hitKey(robot, KeyEvent.VK_UP);\n+        hitKey(robot, KeyEvent.VK_UP);\n@@ -212,1 +214,1 @@\n-                    throw new RuntimeException(\"Focus is not on Radio Button A as Expected\");\n+                    throw new RuntimeException(\"Focus is not on Radio Button B as Expected\");\n@@ -234,1 +236,1 @@\n-                if (KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner() != radioBtn3) {\n+                if (KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner() != radioBtnSingle) {\n@@ -236,1 +238,1 @@\n-                    throw new RuntimeException(\"Focus is not on Radio Button C as Expected\");\n+                    throw new RuntimeException(\"Focus is not on Radio Button Single as Expected\");\n","filename":"jdk\/test\/javax\/swing\/JRadioButton\/8033699\/bug8033699.java","additions":18,"deletions":16,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (C) 2020 THL A29 Limited, a Tencent company. All rights reserved.\n+ * Copyright (C) 2020, Tencent. All rights reserved.\n","filename":"jdk\/test\/jdk\/internal\/platform\/docker\/GetFreeSwapSpaceSize.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (C) 2020 THL A29 Limited, a Tencent company. All rights reserved.\n+ * Copyright (C) 2020, Tencent. All rights reserved.\n","filename":"jdk\/test\/jdk\/internal\/platform\/docker\/TestGetFreeSwapSpaceSize.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,89 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8345358\n+ * @run main\/othervm CheckWindowsProperty\n+ * @summary file property check for Windows .exe\/.dll\n+ * @requires os.family == \"windows\"\n+ *\/\n+\n+import java.io.BufferedReader;\n+import java.io.InputStreamReader;\n+\n+public class CheckWindowsProperty {\n+    public static void main(String[] args) throws Exception {\n+        String targetDir = System.getProperty(\"test.jdk\") + \"\\\\\";\n+        String psCommand = String.format(\n+            \"Get-ChildItem -Path '%s' -include *.exe,*.dll -Recurse -File | \" +\n+            \"ForEach-Object { \" +\n+                \"$vi = $_.VersionInfo; \" +\n+                \"@($vi.FileName, $vi.CompanyName, $vi.FileDescription, $vi.FileVersion, \" +\n+                \"$vi.InternalName, $vi.Language, $vi.LegalCopyright, $vi.OriginalFilename, \" +\n+                \"$vi.ProductName, $vi.ProductVersion) -join ';'\" +\n+            \"}\",\n+            targetDir\n+        );\n+\n+        ProcessBuilder pb = new ProcessBuilder(\"powershell\", \"-NoLogo\", \"-NoProfile\",\n+            \"-Command\", psCommand).redirectErrorStream(true);\n+        Process p = pb.start();\n+        p.getOutputStream().close();\n+\n+        try (BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()))) {\n+            for (String line = br.readLine(); line != null; line = br.readLine()) {\n+                checkFileProperty(line);\n+            }\n+        }\n+        p.waitFor();\n+        int exitCode = p.exitValue();\n+        if (exitCode != 0) {\n+            throw new RuntimeException(\"ExitCode is \" + exitCode + \". PowerShell command failed.\");\n+        }\n+    }\n+\n+    static void checkFileProperty(String line) {\n+        \/\/ line format\n+        \/\/ FileName;CompanyName;FileDescription;FileVersion;InternalName;Language;LegalCopyright;\n+        \/\/ OriginalFilename;ProductName;ProductVersion\n+        String[] data = line.split(\";\", -1);\n+        String filename = data[0].substring(data[0].lastIndexOf(System.getProperty(\"file.separator\")) + 1);\n+\n+        \/\/ skip Microsoft redist dll\n+        if (filename.startsWith(\"api-ms-win\") ||\n+            filename.startsWith(\"msvcp\") ||\n+            filename.startsWith(\"ucrtbase\") ||\n+            filename.startsWith(\"vcruntime\")) {\n+            return;\n+        }\n+\n+        for (int i = 1; i < data.length; i++) {\n+            if (data[i] == null || data[i].isEmpty()) {\n+                if (!filename.equals(\"freetype.dll\") && !filename.equals(\"sawindbg.dll\")) {\n+                    throw new RuntimeException(\"data[\" + i + \"] should not be empty for \" + filename);\n+                }\n+            }\n+        }\n+    }\n+}\n","filename":"jdk\/test\/lib\/property\/CheckWindowsProperty.java","additions":89,"deletions":0,"binary":false,"changes":89,"status":"added"}]}