{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -35,1 +35,0 @@\n-import static org.openjdk.skara.bots.pr.CheckRun.syncLabels;\n@@ -76,1 +75,1 @@\n-            var labels =  Arrays.stream(argumentMatcher.group(2).split(\"[\\\\s,]+\")).collect(Collectors.toList());\n+            var labels = Arrays.stream(argumentMatcher.group(2).split(\"[\\\\s,]+\")).collect(Collectors.toList());\n@@ -91,1 +90,0 @@\n-            upgradeLabelsToGroups(pr, bot, currentLabels);\n@@ -123,1 +121,0 @@\n-            upgradeLabelsToGroups(pr, bot, currentLabels);\n@@ -155,2 +152,1 @@\n-     * Updates to currentLabels are performed immediately after each label addition, so group checks always\n-     * reflect the latest state after any modifications.\n+     * Updates to currentLabels are performed immediately after each label addition.\n@@ -161,18 +157,4 @@\n-                var groups = bot.labelConfiguration().groupLabels(label);\n-                \/\/ The group labels already set in this pr\n-                Set<String> commonLabels = currentLabels.stream()\n-                        .filter(groups::contains)\n-                        .collect(Collectors.toSet());\n-                \/\/ No group labels are set\n-                if (commonLabels.isEmpty()) {\n-                    pr.addLabel(label);\n-                    currentLabels.add(label);\n-                    reply.println(LabelTracker.addLabelMarker(label));\n-                    reply.println(\"The `\" + label + \"` label was successfully added.\");\n-                } else {\n-                    reply.println(LabelTracker.addLabelMarker(label));\n-                    reply.println(\"The \" + commonLabels.stream()\n-                            .map(l -> \"`\" + l + \"`\")\n-                            .collect(Collectors.joining(\", \"))\n-                            + \" group label\" + (commonLabels.size() > 1 ? \"s were\" : \" was\") + \" already applied, so `\" + label + \"` label will not be added.\");\n-                }\n+                pr.addLabel(label);\n+                currentLabels.add(label);\n+                reply.println(LabelTracker.addLabelMarker(label));\n+                reply.println(\"The `\" + label + \"` label was successfully added.\");\n@@ -202,7 +184,0 @@\n-    private void upgradeLabelsToGroups(PullRequest pr, PullRequestBot bot, Set<String> currentLabels) {\n-        Set<String> oldLabels = new HashSet<>(currentLabels);\n-        Set<String> newLabels = new HashSet<>(currentLabels);\n-        newLabels = bot.labelConfiguration().upgradeLabelsToGroups(newLabels);\n-        syncLabels(pr, oldLabels, newLabels, log);\n-    }\n-\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/LabelCommand.java","additions":7,"deletions":32,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -88,0 +88,15 @@\n+\n+    \/\/ Return true if the latest operation on the given label by the botUser was \"removed\"\n+    static boolean isLabelManuallyRemoved(HostUser botUser, List<Comment> comments, String label) {\n+        return comments.stream()\n+                .filter(comment -> comment.author().equals(botUser))\n+                .sorted(Comparator.comparing(Comment::createdAt).reversed())\n+                .flatMap(comment -> comment.body().lines())\n+                .map(LABEL_MARKER_PATTERN::matcher)\n+                .filter(Matcher::find)\n+                .filter(matcher -> matcher.group(2).equals(label))\n+                .map(matcher -> matcher.group(1))\n+                .findFirst()\n+                .map(action -> action.equals(\"removed\"))\n+                .orElse(false);\n+    }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/LabelTracker.java","additions":16,"deletions":1,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -149,5 +149,0 @@\n-                    newLabels.addAll(newLabelsNeedToBeAdded);\n-\n-                    newLabels = bot.labelConfiguration().upgradeLabelsToGroups(newLabels);\n-\n-                    syncLabels(pr, oldLabels, newLabels, log);\n@@ -155,0 +150,1 @@\n+                    processLabelsWithGroups(comments, oldLabels, newLabels, newLabelsNeedToBeAdded);\n@@ -178,10 +174,5 @@\n-                newLabels.addAll(getLabels(localRepo));\n-                newLabels = bot.labelConfiguration().upgradeLabelsToGroups(newLabels);\n-                syncLabels(pr, oldLabels, newLabels, log);\n-                var labelsAdded = new HashSet<String>();\n-                for (var newLabel : newLabels) {\n-                    if (!oldLabels.contains(newLabel)) {\n-                        labelsAdded.add(newLabel);\n-                    }\n-                }\n-                createInitialLabelMessage(comments, new ArrayList<>(labelsAdded), pr.headHash().toString());\n+                var newLabelsNeedToBeAdded = getLabels(localRepo);\n+                processLabelsWithGroups(comments, oldLabels, newLabels, newLabelsNeedToBeAdded);\n+                \/\/ The labels actually added\n+                newLabels.removeAll(oldLabels);\n+                createInitialLabelMessage(comments, new ArrayList<>(newLabels), pr.headHash().toString());\n@@ -195,0 +186,42 @@\n+\n+    \/**\n+     * For each label needing to be added, check if an associated group label should be set.\n+     * If no group label applies, just add the original label.\n+     *\/\n+    private void processLabelsWithGroups(List<Comment> comments, Set<String> oldLabels, Set<String> newLabels, Set<String> newLabelsNeedToBeAdded) {\n+        for (var label : newLabelsNeedToBeAdded) {\n+            var groupLabels = bot.labelConfiguration().groupLabels(label);\n+            if (groupLabels.isEmpty()) {\n+                \/\/ If the label doesn't belong to any group, just add it.\n+                newLabels.add(label);\n+            } else {\n+                for (var groupLabel : groupLabels) {\n+                    \/\/ If old Labels already have this group label, skip adding this label or group label\n+                    if (oldLabels.contains(groupLabel)) {\n+                        continue;\n+                    }\n+                    \/\/ Check if this group label was manually removed by the user.\n+                    if (LabelTracker.isLabelManuallyRemoved(pr.repository().forge().currentUser(), comments, groupLabel)) {\n+                        \/\/ If the group was manually removed by user, don't upgrade this label to group label\n+                        newLabels.add(label);\n+                    } else {\n+                        \/\/ See if any existing label belongs to the same group (excluding the current label).\n+                        boolean hasOtherLabelInGroup = bot.labelConfiguration()\n+                                .labelsInGroup(groupLabel)\n+                                .stream()\n+                                .filter(l -> !l.equals(label))\n+                                .anyMatch(oldLabels::contains);\n+                        if (hasOtherLabelInGroup) {\n+                            \/\/ Upgrade: since another group label exists, we can add the group label itself.\n+                            newLabels.add(groupLabel);\n+                        } else {\n+                            \/\/ No other group label found, so add the original label.\n+                            newLabels.add(label);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+        syncLabels(pr, oldLabels, newLabels, log);\n+    }\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/LabelerWorkItem.java","additions":48,"deletions":15,"binary":false,"changes":63,"status":"modified"},{"patch":"@@ -108,2 +108,2 @@\n-            \/\/ Since group label is added, 1 should be removed\n-            assertFalse(pr.store().labelNames().contains(\"1\"));\n+            assertTrue(pr.store().labelNames().contains(\"group\"));\n+            assertTrue(pr.store().labelNames().contains(\"1\"));\n@@ -193,1 +193,1 @@\n-            assertEquals(Set.of(\"group\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"1\", \"group\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n@@ -198,6 +198,1 @@\n-            assertEquals(Set.of(\"group\", \"group2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n-\n-            pr.addComment(\"\/label add 1\");\n-            TestBotRunner.runPeriodicItems(prBot);\n-            assertLastCommentContains(pr, \"The `group2`, `group` group labels were already applied, so `1` label will not be added.\");\n-            assertEquals(Set.of(\"group\", \"group2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"1\", \"group\", \"group2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n@@ -246,1 +241,2 @@\n-            assertEquals(Set.of(\"group\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+            \/\/ hpp file would let the bot add label \"2\", since the user manually added \"1\", so \"2\" will be upgraded to \"group\"\n+            assertEquals(Set.of(\"1\", \"group\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n@@ -250,3 +246,3 @@\n-            \/\/ Add another file to trigger a group match\n-            Files.writeString(localRepoFolder.resolve(\"test.cpp\"), \"Hello there\");\n-            localRepo.add(Path.of(\"test.cpp\"));\n+            \/\/ Add another file to trigger label 2\n+            Files.writeString(localRepoFolder.resolve(\"test2.hpp\"), \"Hello there\");\n+            localRepo.add(Path.of(\"test2.hpp\"));\n@@ -257,1 +253,1 @@\n-            assertEquals(Set.of(\"group\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"1\", \"group\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n@@ -263,2 +259,2 @@\n-            assertLastCommentContains(pr, \"The `group` group label was already applied, so `2` label will not be added.\");\n-            assertEquals(Set.of(\"group\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+            assertLastCommentContains(pr, \"The `2` label was successfully added.\");\n+            assertEquals(Set.of(\"1\", \"2\", \"group\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n@@ -539,1 +535,1 @@\n-            assertEquals(Set.of(\"group\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"1\", \"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n@@ -546,1 +542,1 @@\n-            assertLastCommentContains(pr, \"The `group` label was successfully removed.\");\n+            assertLastCommentContains(pr, \"The `group` label was not set.\");\n@@ -548,1 +544,1 @@\n-            assertEquals(Set.of(), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"1\", \"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n@@ -556,1 +552,1 @@\n-            assertEquals(Set.of(\"rfr\", \"group\"), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"1\", \"2\", \"rfr\", \"group\"), new HashSet<>(pr.store().labelNames()));\n@@ -563,1 +559,1 @@\n-            assertLastCommentContains(pr,\"The `group` group label was already applied, so `2` label will not be added.\");\n+            assertLastCommentContains(pr,\"The `2` label was already applied.\");\n@@ -565,1 +561,1 @@\n-            assertEquals(Set.of(), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"1\", \"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n@@ -573,3 +569,3 @@\n-            assertLastCommentContains(pr,\"The `group` group label was already applied, so `1` label will not be added.\");\n-            assertLastCommentContains(pr,\"The `2` label was not set.\");\n-            assertEquals(Set.of(\"rfr\", \"group\"), new HashSet<>(pr.store().labelNames()));\n+            assertLastCommentContains(pr,\"The `1` label was already applied\");\n+            assertLastCommentContains(pr,\"The `2` label was successfully removed.\");\n+            assertEquals(Set.of(\"1\", \"rfr\", \"group\"), new HashSet<>(pr.store().labelNames()));\n@@ -583,1 +579,1 @@\n-            assertEquals(Set.of(\"rfr\", \"group\"), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"1\", \"rfr\", \"group\"), new HashSet<>(pr.store().labelNames()));\n@@ -591,1 +587,1 @@\n-            assertEquals(Set.of(\"rfr\", \"group\"), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"1\", \"rfr\", \"group\"), new HashSet<>(pr.store().labelNames()));\n@@ -604,1 +600,1 @@\n-            assertEquals(Set.of(\"rfr\", \"group\"), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"1\", \"rfr\", \"group\"), new HashSet<>(pr.store().labelNames()));\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/LabelTests.java","additions":24,"deletions":28,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -361,0 +361,1 @@\n+            \/\/ Add cpp and hpp together should add group label\n@@ -366,1 +367,17 @@\n-            var addHash = localRepo.commit(\"add cpp file\", \"duke\", \"duke@openjdk.org\");\n+            var test1Hpp = localRepo.root().resolve(\"test1.hpp\");\n+            try (var output = Files.newBufferedWriter(test1Hpp)) {\n+                output.append(\"test\");\n+            }\n+            localRepo.add(test1Hpp);\n+            var addHash = localRepo.commit(\"add cpp,hpp file\", \"duke\", \"duke@openjdk.org\");\n+            localRepo.push(addHash, author.authenticatedUrl(), \"edit\", true);\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(Set.of(\"group1\", \"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+\n+            \/\/ Add another Cpp file, since \"group1\" label is already added, the bot shouldn't add \"1\" label\n+            var test2Cpp = localRepo.root().resolve(\"test2.cpp\");\n+            try (var output = Files.newBufferedWriter(test2Cpp)) {\n+                output.append(\"test\");\n+            }\n+            localRepo.add(test2Cpp);\n+            addHash = localRepo.commit(\"add cpp2 file\", \"duke\", \"duke@openjdk.org\");\n@@ -369,1 +386,6 @@\n-            assertEquals(Set.of(\"group1\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"group1\", \"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+\n+            \/\/ But user should still be able to add \"1\" label manually\n+            pr.addComment(\"\/label 1\");\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(Set.of(\"group1\", \"1\", \"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n@@ -381,1 +403,1 @@\n-            assertEquals(Set.of(\"group1\", \"rfr\", \"3\"), new HashSet<>(pr.store().labelNames()));\n+            assertEquals(Set.of(\"group1\", \"1\", \"2\", \"rfr\", \"3\"), new HashSet<>(pr.store().labelNames()));\n@@ -453,2 +475,16 @@\n-            \/\/ After adding cpp file, \"1\" should be added and the labels should be upgraded to \"group1\"\n-            assertEquals(Set.of(\"group1\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+            \/\/ After adding cpp file, \"1\" should be added, but \"2\" label already there, so \"1\" will be upgraded to \"group1\"\n+            assertEquals(Set.of(\"group1\", \"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+\n+            \/\/ Remove group1 manually\n+            pr.addComment(\"\/label remove group1\");\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(Set.of(\"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+\n+            \/\/Add another file trigger label \"1\"\n+            var cpp2File = localRepo.root().resolve(\"test2.cpp\");\n+            Files.writeString(cpp2File, \"Hello cpp\");\n+            localRepo.add(cpp2File);\n+            var updated2EditHash = localRepo.commit(\"add test2.cpp file\", \"duke\", \"duke@openjdk.org\");\n+            localRepo.push(updated2EditHash, author.authenticatedUrl(), \"edit\", true);\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(Set.of(\"1\", \"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/LabelerTests.java","additions":42,"deletions":6,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+import java.util.List;\n@@ -37,0 +38,4 @@\n+    \/**\n+     * Returns the set of labels belongs to this group label\n+     *\/\n+    List<String> labelsInGroup(String label);\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/LabelConfiguration.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,1 @@\n+import java.util.List;\n@@ -83,0 +84,5 @@\n+\n+    @Override\n+    public List<String> labelsInGroup(String label) {\n+        return labelConfiguration().labelsInGroup(label);\n+    }\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/LabelConfigurationHostedRepository.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -180,0 +180,9 @@\n+\n+    public List<String> labelsInGroup(String label) {\n+       for(var group : groups.entrySet()) {\n+           if (group.getKey().equals(label)) {\n+               return group.getValue();\n+           }\n+       }\n+       return List.of();\n+    }\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/LabelConfigurationJson.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"}]}