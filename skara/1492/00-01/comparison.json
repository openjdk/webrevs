{"files":[{"patch":"@@ -53,1 +53,1 @@\n-        \/\/ The CSRPullRequestBot will initially evaluate all active PRs so there\n+        \/\/ The PullRequestBot will initially evaluate all active PRs so there\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CSRIssueBot.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -143,1 +143,2 @@\n-     * Get the csr issues. Note: this `Issue` is the issue in module `issuetracker`.\n+     * Get the csr issue map, key is the main issue and value is the csr issue.\n+     * Note: The type of  csr issue is the issue in module `issuetracker`.\n@@ -145,1 +146,1 @@\n-    private List<org.openjdk.skara.issuetracker.Issue> getCsrIssueTrackerIssues(List<Issue> issues, JdkVersion version) {\n+    private Map<Issue, org.openjdk.skara.issuetracker.Issue> getCsrIssueTrackerIssues(List<Issue> issues, JdkVersion version) {\n@@ -147,0 +148,1 @@\n+        var csrIssueMap = new HashMap<Issue, org.openjdk.skara.issuetracker.Issue>();\n@@ -148,1 +150,1 @@\n-            return List.of();\n+            return Map.of();\n@@ -151,1 +153,1 @@\n-            return List.of();\n+            return Map.of();\n@@ -153,1 +155,0 @@\n-        var csrIssues = new ArrayList<org.openjdk.skara.issuetracker.Issue>();\n@@ -159,2 +160,4 @@\n-            Backports.findCsr(jbsIssueOpt.get(), version)\n-                    .ifPresent(csrIssues::add);\n+            var csrOptional = Backports.findCsr(jbsIssueOpt.get(), version);\n+            if (csrOptional.isPresent()) {\n+                csrIssueMap.put(issue, csrOptional.get());\n+            }\n@@ -162,1 +165,1 @@\n-        return csrIssues;\n+        return csrIssueMap;\n@@ -1171,1 +1174,2 @@\n-            var csrIssueTrackerIssues = getCsrIssueTrackerIssues(issues, version);\n+            var csrIssueTrackerIssueMap = getCsrIssueTrackerIssues(issues, version);\n+            var csrIssueTrackerIssues = csrIssueTrackerIssueMap.values().stream().toList();\n@@ -1177,1 +1181,1 @@\n-            updateCSRLabel(issues);\n+            updateCSRLabel(issues, version, csrIssueTrackerIssueMap);\n@@ -1287,1 +1291,1 @@\n-    void updateCSRLabel(List<Issue> issues) {\n+    private void updateCSRLabel(List<Issue> issues, JdkVersion version, Map<Issue, org.openjdk.skara.issuetracker.Issue> csrIssueTrackerIssueMap) {\n@@ -1289,1 +1293,0 @@\n-            log.info(\"No issue found for \" + describe(pr));\n@@ -1293,2 +1296,1 @@\n-        var versionOpt = BotUtils.getVersion(pr);\n-        if (versionOpt.isEmpty()) {\n+        if (version == null) {\n@@ -1318,3 +1320,3 @@\n-            var csrOptional = Backports.findCsr(jbsIssueOpt.get(), versionOpt.get());\n-            if (csrOptional.isEmpty()) {\n-                log.info(\"No CSR found for issue \" + jbsIssueOpt.get().id() + \" for \" + describe(pr) + \" with fixVersion \" + versionOpt.get().raw());\n+            var csr = csrIssueTrackerIssueMap.get(issue);\n+            if (csr == null) {\n+                log.info(\"No CSR found for issue \" + jbsIssueOpt.get().id() + \" for \" + describe(pr) + \" with fixVersion \" + version.raw());\n@@ -1323,1 +1325,0 @@\n-            var csr = csrOptional.get();\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":19,"deletions":18,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -63,1 +63,1 @@\n-    CheckWorkItem(PullRequestBot bot, String prId, Consumer<RuntimeException> errorHandler, ZonedDateTime prUpdatedAt,\n+    CheckWorkItem(PullRequestBot bot, String prId, Consumer<RuntimeException> errorHandler, ZonedDateTime triggerUpdatedAt,\n@@ -65,1 +65,1 @@\n-        super(bot, prId, errorHandler, prUpdatedAt, needsReadyCheck);\n+        super(bot, prId, errorHandler, triggerUpdatedAt, needsReadyCheck);\n@@ -69,0 +69,6 @@\n+    CheckWorkItem(PullRequestBot bot, String prId, Consumer<RuntimeException> errorHandler, ZonedDateTime triggerUpdatedAt,\n+                  boolean needsReadyCheck) {\n+        super(bot, prId, errorHandler, triggerUpdatedAt, needsReadyCheck);\n+        this.forceUpdate = false;\n+    }\n+\n@@ -283,1 +289,1 @@\n-                return List.of(new PullRequestCommandWorkItem(bot, prId, errorHandler, prUpdatedAt, false));\n+                return List.of(new PullRequestCommandWorkItem(bot, prId, errorHandler, triggerUpdatedAt, false));\n@@ -347,1 +353,1 @@\n-                    return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt, false, false));\n+                    return List.of(new CheckWorkItem(bot, prId, errorHandler, triggerUpdatedAt, false));\n@@ -387,1 +393,1 @@\n-                return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt, false, false));\n+                return List.of(new CheckWorkItem(bot, prId, errorHandler, triggerUpdatedAt, false));\n@@ -394,1 +400,1 @@\n-                return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt, false, false));\n+                return List.of(new CheckWorkItem(bot, prId, errorHandler, triggerUpdatedAt, false));\n@@ -442,1 +448,1 @@\n-        return List.of(new PullRequestCommandWorkItem(bot, prId, errorHandler, prUpdatedAt, false));\n+        return List.of(new PullRequestCommandWorkItem(bot, prId, errorHandler, triggerUpdatedAt, false));\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckWorkItem.java","additions":13,"deletions":7,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -102,1 +102,3 @@\n-                .map(pr -> new CheckWorkItem(bot.getPRBot(pr.repository().name()), pr.id(), errorHandler, pr.updatedAt(), true, true))\n+                \/\/ This will mix time stamps from the IssueTracker and the Forge hosting PRs, but it's the\n+                \/\/ best we can do.\n+                .map(pr -> new CheckWorkItem(bot.getPRBot(pr.repository().name()), pr.id(), errorHandler, csrIssue.updatedAt(), true, true))\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/IssueWorkItem.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -127,1 +127,1 @@\n-                ret.add(new CheckWorkItem(this, pr.id(), e -> poller.retryPullRequest(pr), pr.updatedAt(), true, false));\n+                ret.add(new CheckWorkItem(this, pr.id(), e -> poller.retryPullRequest(pr), pr.updatedAt(), true));\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestBot.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -189,1 +189,1 @@\n-                return List.of(new LabelerWorkItem(bot, prId, errorHandler, prUpdatedAt));\n+                return List.of(new LabelerWorkItem(bot, prId, errorHandler, triggerUpdatedAt));\n@@ -214,1 +214,1 @@\n-            return List.of(new CheckWorkItem(bot, prId, errorHandler, prUpdatedAt, false, false));\n+            return List.of(new CheckWorkItem(bot, prId, errorHandler, triggerUpdatedAt, false));\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestCommandWorkItem.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -46,4 +46,4 @@\n-     * The updatedAt timestamp of the PR that triggered this WorkItem at the\n-     * time it was triggered. Used for tracking reaction latency of the bot\n-     * through logging. This is the best estimated value, which is the last\n-     * updatedAt value when the bot finds the PR. This value is propagated\n+     * The updatedAt timestamp of the external entity that triggered this WorkItem,\n+     * which would be either a PR or a CSR Issue. Used for tracking reaction legacy\n+     * of the bot through logging.This is the best estimated value, which is the last\n+     * updatedAt value when the bot finds the PR or CSR Issue. This value is propagated\n@@ -51,1 +51,1 @@\n-     * been triggered by the same PR update.\n+     * been triggered by the same PR update or CSR Issue update.\n@@ -53,1 +53,1 @@\n-    final ZonedDateTime prUpdatedAt;\n+    final ZonedDateTime triggerUpdatedAt;\n@@ -62,1 +62,1 @@\n-        this.prUpdatedAt = prUpdatedAt;\n+        this.triggerUpdatedAt = prUpdatedAt;\n@@ -158,1 +158,1 @@\n-        var latency = Duration.between(prUpdatedAt, endTime);\n+        var latency = Duration.between(triggerUpdatedAt, endTime);\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/PullRequestWorkItem.java","additions":8,"deletions":8,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -452,2 +452,2 @@\n-            \/\/ The bot should reply with a message that there is already an approved\n-            \/\/ Now CheckWorkItem is responsible for updating CSR label, so before 'csr' is handled, csr label is added to this pr\n+            \/\/ The bot should reply with a message that there is already an approved CSR request\n+            \/\/ Now CheckWorkItem is responsible for updating CSR label, so before '\/csr' is handled, csr label is added to this pr\n@@ -526,2 +526,2 @@\n-            \/\/ The bot should reply with a message that there is already an approved\n-            \/\/ Now CheckWorkItem is responsible for updating CSR label, so before 'csr' is handled, csr label is added to this pr\n+            \/\/ The bot should reply with a message that there is already an approved CSR request\n+            \/\/ Now CheckWorkItem is responsible for updating CSR label, so before '\/csr' is handled, csr label is added to this pr\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CSRTests.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"}]}