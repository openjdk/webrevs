{"files":[{"patch":"@@ -297,1 +297,1 @@\n-        if (csrIssues.isEmpty() && pr.labelNames().contains(\"csr\")) {\n+        if (csrIssues.isEmpty() && newLabels.contains(\"csr\")) {\n@@ -756,1 +756,1 @@\n-                            if (!pr.labelNames().contains(\"backport\") &&\n+                            if (!newLabels.contains(\"backport\") &&\n@@ -1352,3 +1352,0 @@\n-            if (needUpdateAdditionalProgresses) {\n-                additionalProgresses = botSpecificProgresses(regularIssuesMap, csrIssues, jepIssue, version);\n-            }\n@@ -1359,0 +1356,7 @@\n+            \/\/ In a backport PR, Check if one of associated issues has a resolved CSR for a different fixVersion\n+            updateBackportCSRLabel(regularIssuesMap, issueToCsrMap);\n+\n+            if (needUpdateAdditionalProgresses) {\n+                additionalProgresses = botSpecificProgresses(regularIssuesMap, csrIssues, jepIssue, version);\n+            }\n+\n@@ -1509,1 +1513,1 @@\n-                if (!pr.labelNames().contains(CSR_LABEL)) {\n+                if (!newLabels.contains(CSR_LABEL)) {\n@@ -1522,1 +1526,1 @@\n-                if (!pr.labelNames().contains(CSR_LABEL)) {\n+                if (!newLabels.contains(CSR_LABEL)) {\n@@ -1538,1 +1542,1 @@\n-                } else if (!pr.labelNames().contains(CSR_LABEL)) {\n+                } else if (!newLabels.contains(CSR_LABEL)) {\n@@ -1550,1 +1554,1 @@\n-        if (notExistingUnresolvedCSR && (!isCSRNeeded(comments) || existingApprovedCSR) && pr.labelNames().contains(CSR_LABEL)) {\n+        if (notExistingUnresolvedCSR && (!isCSRNeeded(comments) || existingApprovedCSR) && newLabels.contains(CSR_LABEL)) {\n@@ -1556,0 +1560,23 @@\n+    private void updateBackportCSRLabel(Map<Issue, Optional<IssueTrackerIssue>> regularIssuesMap, Map<String, IssueTrackerIssue> issueToCsrMap) {\n+        if (newLabels.contains(\"backport\") && !newLabels.contains(\"csr\") && issueToCsrMap.isEmpty() && !isCSRManuallyUnneeded(comments)) {\n+            boolean hasResolvedCSR = regularIssuesMap.values().stream()\n+                    .filter(Optional::isPresent)\n+                    .map(Optional::get)\n+                    .map(Backports::csrLink)\n+                    .filter(Optional::isPresent)\n+                    .map(Optional::get)\n+                    .map(Link::issue)\n+                    .filter(Optional::isPresent)\n+                    .map(Optional::get)\n+                    .anyMatch(csrIssue -> csrIssue.state() == org.openjdk.skara.issuetracker.Issue.State.CLOSED &&\n+                            csrIssue.resolution().map(res -> res.equals(\"Approved\")).orElse(false));\n+\n+            if (hasResolvedCSR) {\n+                newLabels.add(\"csr\");\n+                pr.addComment(\"At least one of the associated issues of this backport has a resolved CSR.\\n\" +\n+                        \"This backport might also need a CSR. `csr` label will be added to this PR.\\n\" +\n+                        \"Please go through the [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) process or using command `csr unneeded` to remove the CSR requirement.\");\n+            }\n+        }\n+    }\n+\n@@ -1569,0 +1596,13 @@\n+    private boolean isCSRManuallyUnneeded(List<Comment> comments) {\n+        for (int i = comments.size() - 1; i >= 0; i--) {\n+            var comment = comments.get(i);\n+            if (comment.body().contains(CSR_NEEDED_MARKER)) {\n+                return false;\n+            }\n+            if (comment.body().contains(CSR_UNNEEDED_MARKER)) {\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":49,"deletions":9,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -850,0 +850,9 @@\n+            \/\/ \"csr\" label should be added automatically because the main issue has a resolved CSR\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(3 ,pr.store().comments().size());\n+            assertTrue(pr.store().body().contains(\"- [ ] Change requires a CSR request matching fixVersion (No fixVersion in .jcheck\/conf) to be approved (needs to be created)\"));\n+            assertLastCommentContains(pr, \"At least one of the associated issues of this backport has a resolved CSR.\\n\" +\n+                    \"This backport might also need a CSR. `csr` label will be added to this PR.\");\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(3 ,pr.store().comments().size());\n+\n@@ -855,6 +864,2 @@\n-            assertLastCommentContains(pr, \"has indicated that a \" +\n-                    \"[compatibility and specification](https:\/\/wiki.openjdk.org\/display\/csr\/Main) (CSR) request \" +\n-                    \"is needed for this pull request.\");\n-            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request\");\n-            assertLastCommentContains(pr, \"with the correct fix version\");\n-            assertLastCommentContains(pr, \"This pull request cannot be integrated until the CSR request is approved.\");\n+            assertLastCommentContains(pr, \"@user1 an approved [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request is already required for this pull request.\");\n+\n@@ -869,0 +874,6 @@\n+            \/\/ Run pr bot again, \"csr\" label should not be added because reviewer issued \"\/csr unneeded\"\n+            assertEquals(7 ,pr.store().comments().size());\n+            TestBotRunner.runPeriodicItems(prBot);\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(7 ,pr.store().comments().size());\n+\n@@ -886,6 +897,2 @@\n-            assertLastCommentContains(pr, \"has indicated that a \" +\n-                    \"[compatibility and specification](https:\/\/wiki.openjdk.org\/display\/csr\/Main) (CSR) request \" +\n-                    \"is needed for this pull request.\");\n-            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request\");\n-            assertLastCommentContains(pr, \"with the correct fix version\");\n-            assertLastCommentContains(pr, \"This pull request cannot be integrated until the CSR request is approved.\");\n+            assertLastCommentContains(pr, \"@user1 an approved [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request is already required for this pull request.\");\n+\n@@ -917,6 +924,2 @@\n-            assertLastCommentContains(pr, \"has indicated that a \" +\n-                    \"[compatibility and specification](https:\/\/wiki.openjdk.org\/display\/csr\/Main) (CSR) request \" +\n-                    \"is needed for this pull request.\");\n-            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request\");\n-            assertLastCommentContains(pr, \"with the correct fix version\");\n-            assertLastCommentContains(pr, \"This pull request cannot be integrated until the CSR request is approved.\");\n+            assertLastCommentContains(pr, \"@user1 an approved [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request is already required for this pull request.\");\n+\n@@ -964,6 +967,2 @@\n-            assertLastCommentContains(pr, \"has indicated that a \" +\n-                    \"[compatibility and specification](https:\/\/wiki.openjdk.org\/display\/csr\/Main) (CSR) request \" +\n-                    \"is needed for this pull request.\");\n-            assertLastCommentContains(pr, \"please create a [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request\");\n-            assertLastCommentContains(pr, \"with the correct fix version\");\n-            assertLastCommentContains(pr, \"This pull request cannot be integrated until the CSR request is approved.\");\n+            assertLastCommentContains(pr, \"@user1 an approved [CSR](https:\/\/wiki.openjdk.org\/display\/csr\/Main) request is already required for this pull request.\");\n+\n@@ -1285,0 +1284,113 @@\n+\n+    @Test\n+    void testBackportCsrLabel(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var reviewer = credentials.getHostedRepository();\n+            var issueProject = credentials.getIssueProject();\n+            var bot = credentials.getHostedRepository();\n+            var censusBuilder = credentials.getCensusBuilder()\n+                    .addReviewer(author.forge().currentUser().id())\n+                    .addReviewer(reviewer.forge().currentUser().id());\n+\n+            var issue = issueProject.createIssue(\"This is the primary issue\", List.of(), Map.of());\n+            issue.setState(Issue.State.CLOSED);\n+            issue.setProperty(\"issuetype\", JSON.of(\"Bug\"));\n+            issue.setProperty(\"fixVersions\", JSON.array().add(\"18\"));\n+\n+            var csr = issueProject.createIssue(\"This is the primary CSR\", List.of(), Map.of());\n+            csr.setState(Issue.State.CLOSED);\n+            csr.setProperty(\"issuetype\", JSON.of(\"CSR\"));\n+            csr.setProperty(\"fixVersions\", JSON.array().add(\"18\"));\n+            csr.setProperty(\"resolution\", JSON.object().put(\"name\", \"Approved\"));\n+            issue.addLink(Link.create(csr, \"csr for\").build());\n+            Map<String, List<PRRecord>> issuePRMap = new HashMap<>();\n+            var prBot = PullRequestBot.newBuilder()\n+                    .repo(bot)\n+                    .enableCsr(true)\n+                    .censusRepo(censusBuilder.build())\n+                    .issueProject(issueProject)\n+                    .issuePRMap(issuePRMap)\n+                    .build();\n+            var csrIssueBot = new CSRIssueBot(issueProject, List.of(author), Map.of(bot.name(), prBot), issuePRMap);\n+\n+            \/\/ Run issue prBot once to initialize lastUpdatedAt\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n+\n+            \/\/ Populate the projects repository\n+            var localRepoFolder = tempFolder.path().resolve(\"localrepo\");\n+            var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType());\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            localRepo.push(masterHash, author.authenticatedUrl(), \"master\", true);\n+\n+            \/\/ Push a commit to the jdk18 branch\n+            var jdk18Branch = localRepo.branch(masterHash, \"jdk18\");\n+            localRepo.checkout(jdk18Branch);\n+            var newFile = localRepo.root().resolve(\"a_new_file.txt\");\n+            Files.writeString(newFile, \"a_new_file\");\n+            localRepo.add(newFile);\n+            var issueNumber = issue.id().split(\"-\")[1];\n+            var commitMessage = issueNumber + \": This is the primary issue\\n\\nReviewed-by: integrationreviewer2\";\n+            var commitHash = localRepo.commit(commitMessage, \"integrationcommitter1\", \"integrationcommitter1@openjdk.org\");\n+            localRepo.push(commitHash, author.authenticatedUrl(), \"jdk18\", true);\n+\n+            \/\/ Create a backport issue whose fix version is 17\n+            var backportIssue = issueProject.createIssue(\"This is the backport issue\", List.of(), Map.of());\n+            backportIssue.setProperty(\"issuetype\", JSON.of(\"Backport\"));\n+            backportIssue.setProperty(\"fixVersions\", JSON.array().add(\"17\"));\n+            backportIssue.setState(Issue.State.OPEN);\n+            issue.addLink(Link.create(backportIssue, \"backported by\").build());\n+\n+            \/\/ Create a backport CSR whose fix version is 17.\n+            var backportCsr = issueProject.createIssue(\"This is the backport CSR\", List.of(), Map.of());\n+            backportCsr.setProperty(\"issuetype\", JSON.of(\"CSR\"));\n+            backportCsr.setProperty(\"fixVersions\", JSON.array().add(\"17\"));\n+            backportCsr.setState(Issue.State.OPEN);\n+            backportIssue.addLink(Link.create(backportCsr, \"csr for\").build());\n+\n+            \/\/ Set the `version` in `.jcheck\/conf` as 17 which is an available version.\n+            localRepo.checkout(localRepo.defaultBranch());\n+            var defaultConf = Files.readString(localRepo.root().resolve(\".jcheck\/conf\"), StandardCharsets.UTF_8);\n+            var newConf = defaultConf.replace(\"version=0.1\", \"version=17\");\n+            Files.writeString(localRepo.root().resolve(\".jcheck\/conf\"), newConf, StandardCharsets.UTF_8);\n+            localRepo.add(localRepo.root().resolve(\".jcheck\/conf\"));\n+            var confHash = localRepo.commit(\"Set the version as 17\", \"duke\", \"duke@openjdk.org\");\n+            localRepo.push(confHash, author.authenticatedUrl(), \"master\", true);\n+            createBackport(localRepo, author, confHash, \"edit1\");\n+            var pr = credentials.createPullRequest(author, \"master\", \"edit1\", \"Backport \" + commitHash);\n+            PullRequestUtils.postPullRequestLinkComment(issue, pr);\n+\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertTrue(pr.store().body().contains(\"- [ ] Change requires CSR request [TEST-4](http:\/\/localhost\/project\/testTEST-4) to be approved\"));\n+            assertTrue(pr.store().labelNames().contains(\"csr\"));\n+            \/\/ The bot shouldn't post backport csr comment because there is a backport csr\n+            assertTrue(pr.store().comments().stream().noneMatch(comment -> comment.body().contains(\"This backport might also need a CSR\")));\n+\n+            \/\/ Change the fixVersion of the backportCSR\n+            backportCsr.setProperty(\"fixVersions\", JSON.array().add(\"19\"));\n+            TestBotRunner.runPeriodicItems(csrIssueBot);\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertTrue(pr.store().body().contains(\"- [ ] Change requires a CSR request matching fixVersion 17 to be approved (needs to be created)\"));\n+            assertTrue(pr.store().labelNames().contains(\"csr\"));\n+            \/\/ The bot shouldn't post backport csr comment because csr label is still there\n+            assertTrue(pr.store().comments().stream().noneMatch(comment -> comment.body().contains(\"This backport might also need a CSR\")));\n+\n+            \/\/ Use '\/csr unneeded'\n+            var prAsReviewer = reviewer.pullRequest(pr.id());\n+            prAsReviewer.addComment(\"\/csr unneeded\");\n+            TestBotRunner.runPeriodicItems(prBot);\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertFalse(pr.store().labelNames().contains(\"csr\"));\n+            \/\/ The bot shouldn't post backport csr comment because csr label has been removed by command\n+            assertTrue(pr.store().comments().stream().noneMatch(comment -> comment.body().contains(\"This backport might also need a CSR\")));\n+\n+            \/\/ Require CSR again\n+            prAsReviewer.addComment(\"\/csr\");\n+            TestBotRunner.runPeriodicItems(prBot);\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertTrue(pr.store().labelNames().contains(\"csr\"));\n+            \/\/ The bot shouldn't post backport csr comment because csr label has been added by command\n+            assertTrue(pr.store().comments().stream().noneMatch(comment -> comment.body().contains(\"This backport might also need a CSR\")));\n+        }\n+    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/CSRCommandTests.java","additions":136,"deletions":24,"binary":false,"changes":160,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -319,1 +319,1 @@\n-    private static Optional<Link> csrLink(IssueTrackerIssue issue) {\n+    public static Optional<Link> csrLink(IssueTrackerIssue issue) {\n","filename":"jbs\/src\/main\/java\/org\/openjdk\/skara\/jbs\/Backports.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}