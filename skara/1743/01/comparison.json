{"files":[{"patch":"@@ -381,1 +381,0 @@\n-            var listServer = MailingListServerFactory.createMailmanServer(bot.listArchive(), bot.smtpServer(), bot.sendInterval());\n@@ -452,1 +451,1 @@\n-                listServer.post(filteredEmail);\n+                bot.mailingListServer().post(filteredEmail);\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/ArchiveWorkItem.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -38,1 +38,1 @@\n-    private final MailingListReader list;\n+    private final MailingListReader mailingListReader;\n@@ -47,2 +47,2 @@\n-    MailingListArchiveReaderBot(MailingListReader list, HostedRepository repository) {\n-        this.list = list;\n+    MailingListArchiveReaderBot(MailingListReader mailingListReader, HostedRepository repository) {\n+        this.mailingListReader = mailingListReader;\n@@ -134,1 +134,1 @@\n-        var readerItems = new ArchiveReaderWorkItem(this, list);\n+        var readerItems = new ArchiveReaderWorkItem(this, mailingListReader);\n@@ -148,0 +148,4 @@\n+    public MailingListReader mailingListReader() {\n+        return mailingListReader;\n+    }\n+\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListArchiveReaderBot.java","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+import org.openjdk.skara.mailinglist.MailingListServer;\n@@ -46,2 +47,0 @@\n-    private final URI listArchive;\n-    private final String smtpServer;\n@@ -53,1 +52,0 @@\n-    private final Duration sendInterval;\n@@ -59,0 +57,1 @@\n+    private final MailingListServer mailingListServer;\n@@ -66,1 +65,1 @@\n-                         Set<String> ignoredUsers, Set<Pattern> ignoredComments, URI listArchive, String smtpServer,\n+                         Set<String> ignoredUsers, Set<Pattern> ignoredComments,\n@@ -71,2 +70,2 @@\n-                         Duration sendInterval, Duration cooldown, boolean repoInSubject, Pattern branchInSubject,\n-                         Path seedStorage) {\n+                         Duration cooldown, boolean repoInSubject, Pattern branchInSubject,\n+                         Path seedStorage, MailingListServer mailingListServer) {\n@@ -82,2 +81,0 @@\n-        this.listArchive = listArchive;\n-        this.smtpServer = smtpServer;\n@@ -88,1 +85,0 @@\n-        this.sendInterval = sendInterval;\n@@ -93,0 +89,1 @@\n+        this.mailingListServer = mailingListServer;\n@@ -132,4 +129,0 @@\n-    Duration sendInterval() {\n-        return sendInterval;\n-    }\n-\n@@ -148,8 +141,0 @@\n-    URI listArchive() {\n-        return listArchive;\n-    }\n-\n-    String smtpServer() {\n-        return smtpServer;\n-    }\n-\n@@ -196,0 +181,4 @@\n+    public MailingListServer mailingListServer() {\n+        return mailingListServer;\n+    }\n+\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListBridgeBot.java","additions":10,"deletions":21,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+import org.openjdk.skara.mailinglist.MailingListServer;\n@@ -46,2 +47,0 @@\n-    private URI listArchive;\n-    private String smtpServer;\n@@ -59,1 +58,0 @@\n-    private Duration sendInterval = Duration.ZERO;\n@@ -64,0 +62,1 @@\n+    private MailingListServer mailingListServer;\n@@ -113,10 +112,0 @@\n-    public MailingListBridgeBotBuilder listArchive(URI listArchive) {\n-        this.listArchive = listArchive;\n-        return this;\n-    }\n-\n-    public MailingListBridgeBotBuilder smtpServer(String smtpServer) {\n-        this.smtpServer = smtpServer;\n-        return this;\n-    }\n-\n@@ -178,5 +167,0 @@\n-    public MailingListBridgeBotBuilder sendInterval(Duration sendInterval) {\n-        this.sendInterval = sendInterval;\n-        return this;\n-    }\n-\n@@ -203,0 +187,5 @@\n+    public MailingListBridgeBotBuilder mailingListServer(MailingListServer mailingListServer) {\n+        this.mailingListServer = mailingListServer;\n+        return this;\n+    }\n+\n@@ -205,1 +194,1 @@\n-                                        ignoredUsers, ignoredComments, listArchive, smtpServer,\n+                                        ignoredUsers, ignoredComments,\n@@ -208,2 +197,2 @@\n-                                        readyLabels, readyComments, issueTracker, headers, sendInterval,\n-                                        cooldown, repoInSubject, branchInSubject, seedStorage);\n+                                        readyLabels, readyComments, issueTracker, headers,\n+                                        cooldown, repoInSubject, branchInSubject, seedStorage, mailingListServer);\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListBridgeBotBuilder.java","additions":10,"deletions":21,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+import java.net.URI;\n@@ -28,0 +29,1 @@\n+import org.openjdk.skara.mailinglist.MailingListServer;\n@@ -80,0 +82,4 @@\n+        String archiveType = null;\n+        if (specific.get(\"server\").contains(\"type\")) {\n+            archiveType = specific.get(\"server\").get(\"type\").asString();\n+        }\n@@ -81,1 +87,2 @@\n-        var interval = specific.get(\"server\").contains(\"interval\") ? Duration.parse(specific.get(\"server\").get(\"interval\").asString()) : Duration.ofSeconds(1);\n+        var interval = specific.get(\"server\").contains(\"interval\") ?\n+                Duration.parse(specific.get(\"server\").get(\"interval\").asString()) : Duration.ofSeconds(1);\n@@ -104,1 +111,1 @@\n-        var mailmanServer = MailingListServerFactory.createMailmanServer(listArchive, listSmtp, Duration.ZERO, useEtag);\n+        MailingListServer mailmanServer = createMailmanServer(archiveType, listArchive, listSmtp, interval, useEtag);\n@@ -164,2 +171,0 @@\n-                                                 .listArchive(listArchive)\n-                                                 .smtpServer(listSmtp)\n@@ -177,1 +182,0 @@\n-                                                 .sendInterval(interval)\n@@ -179,1 +183,2 @@\n-                                                 .seedStorage(configuration.storageFolder().resolve(\"seeds\"));\n+                                                 .seedStorage(configuration.storageFolder().resolve(\"seeds\"))\n+                                                 .mailingListServer(mailmanServer);\n@@ -192,0 +197,13 @@\n+\n+    private static MailingListServer createMailmanServer(String archiveType, URI listArchive, String listSmtp,\n+            Duration sendInterval, boolean useEtag) {\n+        MailingListServer mailmanServer;\n+        if (archiveType == null || archiveType.equals(\"mailman2\")) {\n+            mailmanServer = MailingListServerFactory.createMailman2Server(listArchive, listSmtp, sendInterval, useEtag);\n+        } else if (archiveType.equals(\"mailman3\")) {\n+            mailmanServer = MailingListServerFactory.createMailman3Server(listArchive, listSmtp, sendInterval);\n+        } else {\n+            throw new RuntimeException(\"Invalid server archive type: \" + archiveType);\n+        }\n+        return mailmanServer;\n+    }\n","filename":"bots\/mlbridge\/src\/main\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListBridgeBotFactory.java","additions":24,"deletions":6,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -41,1 +41,1 @@\n-             var listServer = new TestMailmanServer();) {\n+             var listServer = TestMailmanServer.createV2();) {\n@@ -73,1 +73,1 @@\n-             var listServer = new TestMailmanServer();) {\n+             var listServer = TestMailmanServer.createV2();) {\n","filename":"bots\/mlbridge\/src\/test\/java\/org\/openjdk\/skara\/bots\/mlbridge\/LabelsUpdaterTests.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -62,1 +62,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -71,0 +71,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -78,2 +80,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -85,0 +85,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -87,3 +88,0 @@\n-            \/\/ The mailing list as well\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(),\n-                                                                             Duration.ZERO);\n@@ -137,1 +135,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -146,0 +144,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -153,2 +153,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -161,0 +159,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -163,3 +162,0 @@\n-            \/\/ The mailing list as well\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(),\n-                                                                             Duration.ZERO);\n@@ -214,1 +210,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -223,0 +219,3 @@\n+            \/\/ The mailing list as well\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -230,2 +229,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -237,0 +234,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -239,3 +237,0 @@\n-            \/\/ The mailing list as well\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(),\n-                                                                             Duration.ZERO);\n@@ -296,1 +291,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -305,0 +300,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -312,2 +309,0 @@\n-                    .listArchive(listServer.getArchive())\n-                    .smtpServer(listServer.getSMTP())\n@@ -319,0 +314,1 @@\n+                    .mailingListServer(mailmanServer)\n","filename":"bots\/mlbridge\/src\/test\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListArchiveReaderBotTests.java","additions":17,"deletions":21,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -28,0 +28,2 @@\n+import org.openjdk.skara.mailinglist.MailingListReader;\n+import org.openjdk.skara.mailinglist.MailingListServer;\n@@ -168,2 +170,13 @@\n-            assertEquals(\"MailingListArchiveReaderBot@repo3\", mailingListArchiveReaderBots.get(0).toString());\n-            assertEquals(\"MailingListArchiveReaderBot@repo5\", mailingListArchiveReaderBots.get(1).toString());\n+            MailingListArchiveReaderBot mailingListArchiveReaderBot1 =\n+                    (MailingListArchiveReaderBot) mailingListArchiveReaderBots.get(0);\n+            assertEquals(\"MailingListArchiveReaderBot@repo3\", mailingListArchiveReaderBot1.toString());\n+            MailingListReader readerBot1MailingListReader = mailingListArchiveReaderBot1.mailingListReader();\n+            assertTrue(readerBot1MailingListReader.getClass().getName().contains(\"Mailman2\"),\n+                    readerBot1MailingListReader.getClass().getName());\n+\n+            MailingListArchiveReaderBot mailingListArchiveReaderBot2 =\n+                    (MailingListArchiveReaderBot) mailingListArchiveReaderBots.get(1);\n+            assertEquals(\"MailingListArchiveReaderBot@repo5\", mailingListArchiveReaderBot2.toString());\n+            MailingListReader readerBot2MailingListReader = mailingListArchiveReaderBot2.mailingListReader();\n+            assertTrue(readerBot2MailingListReader.getClass().getName().contains(\"Mailman2\"),\n+                    readerBot2MailingListReader.getClass().getName());\n@@ -176,1 +189,0 @@\n-            assertEquals(\"https:\/\/mail.test.org\/test\/\", mailingListBridgeBot1.listArchive().toString());\n@@ -182,1 +194,0 @@\n-            assertEquals(\"0.0.0.0\", mailingListBridgeBot1.smtpServer());\n@@ -187,1 +198,0 @@\n-            assertEquals(Duration.ofSeconds(5), mailingListBridgeBot1.sendInterval());\n@@ -191,1 +201,2 @@\n-\n+            MailingListServer bridgeBot1MailingListServer = mailingListBridgeBot1.mailingListServer();\n+            assertTrue(bridgeBot1MailingListServer.getClass().getName().contains(\"Mailman2\"));\n@@ -198,1 +209,0 @@\n-            assertEquals(\"https:\/\/mail.test.org\/test\/\", mailingListBridgeBot2.listArchive().toString());\n@@ -204,1 +214,0 @@\n-            assertEquals(\"0.0.0.0\", mailingListBridgeBot2.smtpServer());\n@@ -209,1 +218,0 @@\n-            assertEquals(Duration.ofSeconds(5), mailingListBridgeBot2.sendInterval());\n@@ -212,0 +220,2 @@\n+            MailingListServer bridgeBot2MailingListServer = mailingListBridgeBot2.mailingListServer();\n+            assertTrue(bridgeBot2MailingListServer.getClass().getName().contains(\"Mailman2\"));\n@@ -218,1 +228,0 @@\n-            assertEquals(\"https:\/\/mail.test.org\/test\/\", mailingListBridgeBot3.listArchive().toString());\n@@ -225,1 +234,0 @@\n-            assertEquals(\"0.0.0.0\", mailingListBridgeBot3.smtpServer());\n@@ -230,1 +238,0 @@\n-            assertEquals(Duration.ofSeconds(5), mailingListBridgeBot3.sendInterval());\n@@ -234,0 +241,2 @@\n+            MailingListServer bridgeBot3MailingListServer = mailingListBridgeBot3.mailingListServer();\n+            assertTrue(bridgeBot3MailingListServer.getClass().getName().contains(\"Mailman2\"));\n@@ -236,1 +245,1 @@\n-}\n\\ No newline at end of file\n+}\n","filename":"bots\/mlbridge\/src\/test\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListBridgeBotFactoryTest.java","additions":22,"deletions":13,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -114,1 +114,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -123,0 +123,1 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -131,2 +132,1 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n+                                            .mailingListServer(mailmanServer)\n@@ -141,1 +141,0 @@\n-                                            .sendInterval(Duration.ZERO)\n@@ -233,1 +232,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -310,1 +308,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -319,0 +317,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -326,2 +326,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -333,0 +331,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -403,1 +402,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -412,0 +411,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -419,2 +420,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -426,0 +425,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -477,1 +477,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -486,0 +486,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -493,2 +495,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -500,0 +500,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -556,1 +557,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -565,0 +566,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -572,2 +575,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -580,0 +581,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -633,1 +635,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -642,0 +644,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -649,2 +653,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -657,0 +659,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -722,1 +725,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -731,0 +734,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -738,2 +743,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -745,0 +748,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -776,1 +780,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -785,0 +789,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -792,2 +798,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -799,0 +803,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -838,1 +843,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -885,1 +889,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -893,0 +897,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -899,2 +905,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -906,0 +910,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -939,1 +944,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -982,1 +986,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -992,0 +996,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -998,2 +1004,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1005,0 +1009,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1060,1 +1065,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -1111,1 +1115,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1121,0 +1125,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1127,2 +1133,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1134,0 +1138,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1183,1 +1188,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1193,0 +1198,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1199,2 +1206,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1206,0 +1211,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1247,1 +1253,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1257,0 +1263,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1263,2 +1271,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1270,0 +1276,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1312,1 +1319,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1322,0 +1329,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1328,2 +1337,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1335,0 +1342,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1377,1 +1385,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1385,0 +1393,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1391,2 +1401,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1398,0 +1406,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1433,1 +1442,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1441,0 +1450,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1447,2 +1458,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1454,0 +1463,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1509,1 +1519,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1517,0 +1527,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1523,2 +1535,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1530,0 +1540,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1598,1 +1609,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1607,0 +1618,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1613,2 +1626,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1620,0 +1631,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1670,1 +1682,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -1709,1 +1720,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1718,0 +1729,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1724,2 +1737,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1731,0 +1742,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1778,1 +1790,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -1796,1 +1807,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1805,0 +1816,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1811,2 +1824,0 @@\n-                    .listArchive(listServer.getArchive())\n-                    .smtpServer(listServer.getSMTP())\n@@ -1818,0 +1829,1 @@\n+                    .mailingListServer(mailmanServer)\n@@ -1872,1 +1884,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -1890,1 +1901,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1898,0 +1909,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1905,2 +1918,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1912,0 +1923,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -1969,1 +1981,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -1978,0 +1990,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -1985,2 +1999,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -1992,0 +2004,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -2055,1 +2068,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2064,0 +2077,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2071,2 +2086,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -2078,0 +2091,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -2127,1 +2141,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2136,0 +2150,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2143,2 +2159,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -2150,0 +2164,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -2198,1 +2213,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2207,0 +2222,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2214,2 +2231,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -2221,0 +2236,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -2278,1 +2294,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2288,0 +2304,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2294,2 +2312,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -2301,0 +2317,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -2347,1 +2364,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -2371,1 +2387,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2380,0 +2396,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2388,2 +2406,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -2395,0 +2411,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -2437,1 +2454,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2447,0 +2464,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2453,2 +2472,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -2460,0 +2477,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -2498,1 +2516,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2507,0 +2525,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2514,2 +2534,0 @@\n-                                                   .listArchive(listServer.getArchive())\n-                                                   .smtpServer(listServer.getSMTP())\n@@ -2520,1 +2538,2 @@\n-                                                   .issueTracker(URIBuilder.base(\"http:\/\/issues.test\/browse\/\").build());\n+                                                   .issueTracker(URIBuilder.base(\"http:\/\/issues.test\/browse\/\").build())\n+                                                   .mailingListServer(mailmanServer);\n@@ -2563,1 +2582,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2572,0 +2591,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2579,2 +2600,0 @@\n-                                                   .listArchive(listServer.getArchive())\n-                                                   .smtpServer(listServer.getSMTP())\n@@ -2585,1 +2604,2 @@\n-                                                   .issueTracker(URIBuilder.base(\"http:\/\/issues.test\/browse\/\").build());\n+                                                   .issueTracker(URIBuilder.base(\"http:\/\/issues.test\/browse\/\").build())\n+                                                   .mailingListServer(mailmanServer);\n@@ -2629,1 +2649,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2639,0 +2659,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2646,2 +2668,0 @@\n-                                                   .listArchive(listServer.getArchive())\n-                                                   .smtpServer(listServer.getSMTP())\n@@ -2652,1 +2672,2 @@\n-                                                   .issueTracker(URIBuilder.base(\"http:\/\/issues.test\/browse\/\").build());\n+                                                   .issueTracker(URIBuilder.base(\"http:\/\/issues.test\/browse\/\").build())\n+                                                   .mailingListServer(mailmanServer);\n@@ -2721,1 +2742,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2729,0 +2750,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2735,2 +2758,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -2743,0 +2764,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -2778,1 +2800,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2786,0 +2808,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2792,2 +2816,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -2800,0 +2822,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -2835,1 +2858,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2843,0 +2866,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2849,2 +2874,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -2858,0 +2881,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -2893,1 +2917,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2903,0 +2927,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -2910,2 +2936,0 @@\n-                                                   .listArchive(listServer.getArchive())\n-                                                   .smtpServer(listServer.getSMTP())\n@@ -2916,1 +2940,2 @@\n-                                                   .issueTracker(URIBuilder.base(\"http:\/\/issues.test\/browse\/\").build());\n+                                                   .issueTracker(URIBuilder.base(\"http:\/\/issues.test\/browse\/\").build())\n+                                                   .mailingListServer(mailmanServer);\n@@ -2986,1 +3011,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -2995,0 +3020,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -3002,2 +3029,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -3009,0 +3034,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -3030,1 +3056,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -3065,1 +3090,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -3074,0 +3099,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -3082,2 +3109,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -3094,1 +3119,1 @@\n-                                            .sendInterval(Duration.ZERO)\n+                                            .mailingListServer(mailmanServer)\n@@ -3162,1 +3187,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -3266,1 +3290,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -3275,0 +3299,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -3283,2 +3309,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -3292,1 +3316,1 @@\n-                                            .sendInterval(Duration.ZERO)\n+                                            .mailingListServer(mailmanServer)\n@@ -3354,1 +3378,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -3362,0 +3386,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -3368,2 +3394,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -3375,0 +3399,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -3426,1 +3451,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -3435,0 +3460,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -3441,2 +3468,0 @@\n-                                            .listArchive(listServer.getArchive())\n-                                            .smtpServer(listServer.getSMTP())\n@@ -3448,0 +3473,1 @@\n+                                            .mailingListServer(mailmanServer)\n@@ -3502,1 +3528,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -3511,0 +3537,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -3519,2 +3547,0 @@\n-                    .listArchive(listServer.getArchive())\n-                    .smtpServer(listServer.getSMTP())\n@@ -3529,1 +3555,1 @@\n-                    .sendInterval(Duration.ZERO)\n+                    .mailingListServer(mailmanServer)\n@@ -3679,1 +3705,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -3688,0 +3714,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -3696,2 +3724,0 @@\n-                    .listArchive(listServer.getArchive())\n-                    .smtpServer(listServer.getSMTP())\n@@ -3708,1 +3734,1 @@\n-                    .sendInterval(Duration.ZERO)\n+                    .mailingListServer(mailmanServer)\n@@ -3774,1 +3800,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -3825,1 +3850,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -3834,0 +3859,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -3841,2 +3868,0 @@\n-                    .listArchive(listServer.getArchive())\n-                    .smtpServer(listServer.getSMTP())\n@@ -3850,0 +3875,1 @@\n+                    .mailingListServer(mailmanServer)\n@@ -3911,1 +3937,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -3920,0 +3946,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -3928,2 +3956,0 @@\n-                    .listArchive(listServer.getArchive())\n-                    .smtpServer(listServer.getSMTP())\n@@ -3938,1 +3964,1 @@\n-                    .sendInterval(Duration.ZERO)\n+                    .mailingListServer(mailmanServer)\n@@ -3983,1 +4009,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -4005,1 +4030,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -4014,0 +4039,2 @@\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(),\n+                    listServer.getSMTP(), Duration.ZERO);\n@@ -4022,2 +4049,0 @@\n-                    .listArchive(listServer.getArchive())\n-                    .smtpServer(listServer.getSMTP())\n@@ -4032,1 +4057,1 @@\n-                    .sendInterval(Duration.ZERO)\n+                    .mailingListServer(mailmanServer)\n@@ -4066,1 +4091,0 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n","filename":"bots\/mlbridge\/src\/test\/java\/org\/openjdk\/skara\/bots\/mlbridge\/MailingListBridgeBotTests.java","additions":183,"deletions":159,"binary":false,"changes":342,"status":"modified"},{"patch":"@@ -30,1 +30,0 @@\n-import org.openjdk.skara.network.URIBuilder;\n@@ -46,1 +45,0 @@\n-        var archive = URIBuilder.base(notifierConfiguration.get(\"archive\").asString()).build();\n@@ -48,1 +46,1 @@\n-        var listServer = MailingListServerFactory.createMailmanServer(archive, smtp, interval);\n+        var listServer = MailingListServerFactory.createSendOnlyServer(smtp, interval);\n","filename":"bots\/notify\/src\/main\/java\/org\/openjdk\/skara\/bots\/notify\/mailinglist\/MailingListNotifierFactory.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -43,1 +43,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -54,1 +54,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -117,1 +117,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -128,1 +128,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -194,1 +194,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -205,1 +205,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -274,1 +274,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -285,1 +285,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -339,1 +339,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -351,1 +351,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -444,1 +444,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -455,1 +455,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -529,1 +529,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -540,1 +540,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -620,1 +620,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -631,1 +631,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -718,1 +718,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -730,1 +730,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -817,1 +817,1 @@\n-             var listServer = new TestMailmanServer();\n+             var listServer = TestMailmanServer.createV3();\n@@ -828,1 +828,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -941,1 +941,1 @@\n-             var listServer = new TestMailmanServer()) {\n+             var listServer = TestMailmanServer.createV3()) {\n@@ -951,1 +951,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -1036,1 +1036,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -1048,1 +1048,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -1117,1 +1117,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -1128,1 +1128,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n@@ -1184,1 +1184,1 @@\n-        try (var listServer = new TestMailmanServer();\n+        try (var listServer = TestMailmanServer.createV3();\n@@ -1195,1 +1195,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);\n","filename":"bots\/notify\/src\/test\/java\/org\/openjdk\/skara\/bots\/notify\/mailinglist\/MailingListNotifierTests.java","additions":28,"deletions":28,"binary":false,"changes":56,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+import java.nio.charset.StandardCharsets;\n@@ -29,0 +30,1 @@\n+import java.util.regex.Matcher;\n@@ -46,0 +48,4 @@\n+    private final static Pattern mimeHeadersPattern = Pattern.compile(\n+            \"^(Content-Type|Content-Transfer-Encoding): .*\");\n+    private final static Pattern quotedPrintableUtf8Pattern = Pattern.compile(\"=([0-9A-Fa-f]{2})=([0-9A-Fa-f]{2})\");\n+    private final static Pattern quotedPrintablePattern = Pattern.compile(\"=([0-9A-Fa-f]{2})\");\n@@ -74,1 +80,45 @@\n-        ret.body = parts[1].stripTrailing();\n+\n+        var boundary = extractContentBoundary(ret.headers);\n+        if (boundary != null) {\n+            var body = new StringBuilder();\n+            var bodySections = parts[1].split(\"\\\\R?--\" + boundary + \"(?:--)?\\\\R\");\n+            for (String bodySection : bodySections) {\n+                if (bodySection.lines().findFirst().map(e -> mimeHeadersPattern.matcher(e).matches()).orElse(false)) {\n+                    var mimeHeaders = bodySection.lines()\n+                            .takeWhile(s -> !s.isEmpty())\n+                            .map(mboxMessageHeaderPattern::matcher)\n+                            .filter(Matcher::matches)\n+                            .collect(Collectors.toMap(match -> match.group(1), match -> match.group(2)));\n+                    \/\/ Skip any non plain text part\n+                    if (mimeHeaders.containsKey(\"Content-Type\") && !mimeHeaders.get(\"Content-Type\").startsWith(\"text\/plain\")) {\n+                        continue;\n+                    }\n+                    \/\/ Remove the mime headers from the rest of the body section\n+                    var bodySectionBody = bodySection.split(\"\\\\R{2}\", 2)[1];\n+                    \/\/ Mailman3 encodes mail bodies with \"quoted-printable\".\n+                    if (\"quoted-printable\".equals(mimeHeaders.get(\"Content-Transfer-Encoding\"))) {\n+                        \/\/ Remove soft line breaks\n+                        bodySectionBody = bodySectionBody\n+                                .replace(\"=\\r\\n\", \"\")\n+                                .replace(\"=\\n\", \"\");\n+                        if (mimeHeaders.get(\"Content-Type\").contains(\"charset=\\\"utf-8\\\"\")) {\n+                            \/\/ Decode UTF-8 characters which are encoded as pairs of =XX=YY.\n+                            bodySectionBody = quotedPrintableUtf8Pattern.matcher(bodySectionBody).replaceAll(m -> {\n+                                        var bytes = new byte[]{(byte) Integer.parseInt(m.group(1), 16),\n+                                                (byte) Integer.parseInt(m.group(2), 16)};\n+                                        return new String(bytes, StandardCharsets.UTF_8);\n+                                    });\n+                        }\n+                        \/\/ Replace all possibly remaining single instances of =XX.\n+                        bodySectionBody = quotedPrintablePattern.matcher(bodySectionBody).replaceAll(m ->\n+                                Character.toString((char) Integer.parseInt(m.group(1), 16)));\n+                    }\n+                    body.append(bodySectionBody.stripTrailing());\n+                } else {\n+                    body.append(bodySection.stripTrailing());\n+                }\n+            }\n+            ret.body = body.toString();\n+        } else {\n+            ret.body = parts[1].stripTrailing();\n+        }\n@@ -78,0 +128,14 @@\n+    private final static Pattern mboxBoundaryPattern = Pattern.compile(\".*boundary=\\\"([^\\\"]*)\\\".*\");\n+\n+    \/\/ Content-Type: multipart\/mixed; boundary=\"===============3685582790409215631==\"\n+    private static String extractContentBoundary(Map<String, String> headers) {\n+        if (headers.containsKey(\"Content-Type\")) {\n+            var contentType = headers.get(\"Content-Type\");\n+            var matcher = mboxBoundaryPattern.matcher(contentType);\n+            if (matcher.matches()) {\n+                return matcher.group(1);\n+            }\n+        }\n+        return null;\n+    }\n+\n","filename":"email\/src\/main\/java\/org\/openjdk\/skara\/email\/Email.java","additions":65,"deletions":1,"binary":false,"changes":66,"status":"modified"},{"patch":"@@ -153,0 +153,83 @@\n+\n+    @Test\n+    void parseContentType7bit() {\n+        var mail = Email.parse(\"\"\"\n+                Message-Id: <a@b.c>\n+                Date: Wed, 27 Mar 2019 14:31:00 +0100\n+                Subject: hello\n+                From: B <b@b.c>\n+                To: C <c@c.c>, <d@d.c>\n+                Content-Type: multipart\/mixed; boundary=\"===============3685582790409215631==\"\n+\n+                --===============3685582790409215631==\n+                Content-Type: text\/plain; charset=\"utf-8\"\n+                Content-Transfer-Encoding: 7bit\n+\n+                The body text\n+\n+                --===============3685582790409215631==--\n+                \"\"\"\n+        );\n+\n+        assertEquals(\"The body text\", mail.body());\n+    }\n+\n+    @Test\n+    void parseContentTypeQuotedPrintable() {\n+        var mail = Email.parse(\"\"\"\n+                Message-Id: <a@b.c>\n+                Date: Wed, 27 Mar 2019 14:31:00 +0100\n+                Subject: hello\n+                From: B <b@b.c>\n+                To: C <c@c.c>, <d@d.c>\n+                Content-Type: multipart\/mixed; boundary=\"===============3685582790409215631==\"\n+\n+                --===============3685582790409215631==\n+                Content-Type: text\/plain; charset=\"utf-8\"\n+                Content-Transfer-Encoding: quoted-printable\n+\n+                A response with weird characters r=C3=A4ksm=C3=B6rg=C3=A5s and a line longer =\n+                than 76=20\n+                characters.\n+\n+                --===============3685582790409215631==--\n+                \"\"\"\n+        );\n+\n+        assertEquals(\"A response with weird characters rksmrgs and a line longer than 76 \\ncharacters.\", mail.body());\n+    }\n+\n+    @Test\n+    void parseContentTypeMultipart() {\n+        var mail = Email.parse(\"\"\"\n+                Message-Id: <a@b.c>\n+                Date: Wed, 27 Mar 2019 14:31:00 +0100\n+                Subject: hello\n+                From: B <b@b.c>\n+                To: C <c@c.c>, <d@d.c>\n+                Content-Type: multipart\/mixed; boundary=\"===============3685582790409215631==\"\n+\n+                --===============3685582790409215631==\n+                Content-Type: text\/plain; charset=\"utf-8\"\n+                Content-Transfer-Encoding: 7bit\n+\n+                The body text\n+\n+                --===============3685582790409215631==\n+                Content-Type: text\/html\n+                Content-Transfer-Encoding: base64\n+                Content-Disposition: attachment; filename=\"attachment.html\"\n+                MIME-Version: 1.0\n+\n+                PCFET0NUWVBFIGh0bWw+PGh0bWw+PGhlYWQ+CjxtZXRhIGh0dHAtZXF1aXY9IkNvbnRlbnQtVHlw\n+                ZSIgY29udGVudD0idGV4dC9odG1sOyBjaGFyc2V0PXV0Zi04Ij4KICA8L2hlYWQ+CiAgPGJvZHk+\n+                CiAgICA8aDE+VGhpcyBpcyBhbiBlbWFpbCB3aXRoIGZvcm1hdHRpbmc8L2gxPgogICAgPHA+UGFy\n+                YWdyYXBoIHRleHQuPC9wPgogICAgPHByZT5QcmVmb3JtYXQgdGV4dC48L3ByZT4KICA8L2JvZHk+\n+                CjwvaHRtbD4K\n+\n+                --===============3685582790409215631==--\n+                \"\"\"\n+        );\n+\n+        assertEquals(\"The body text\", mail.body());\n+    }\n","filename":"email\/src\/test\/java\/org\/openjdk\/skara\/email\/EmailTests.java","additions":83,"deletions":0,"binary":false,"changes":83,"status":"modified"},{"patch":"@@ -25,1 +25,3 @@\n-import org.openjdk.skara.mailinglist.mailman.MailmanServer;\n+import org.openjdk.skara.mailinglist.mailman.Mailman2Server;\n+import org.openjdk.skara.mailinglist.mailman.Mailman3Server;\n+import org.openjdk.skara.mailinglist.mailman.SendOnlyServer;\n@@ -33,2 +35,2 @@\n-    public static MailingListServer createMailmanServer(URI archive, String smtp, Duration sendInterval) {\n-        return new MailmanServer(archive, smtp, sendInterval, false);\n+    public static MailingListServer createMailman2Server(URI archive, String smtp, Duration sendInterval) {\n+        return new Mailman2Server(archive, smtp, sendInterval, false);\n@@ -37,2 +39,10 @@\n-    public static MailingListServer createMailmanServer(URI archive, String smtp, Duration sendInterval, boolean useEtag) {\n-        return new MailmanServer(archive, smtp, sendInterval, useEtag);\n+    public static MailingListServer createMailman2Server(URI archive, String smtp, Duration sendInterval, boolean useEtag) {\n+        return new Mailman2Server(archive, smtp, sendInterval, useEtag);\n+    }\n+\n+    public static MailingListServer createMailman3Server(URI archive, String smtp, Duration sendInterval) {\n+        return new Mailman3Server(archive, smtp, sendInterval);\n+    }\n+\n+    public static MailingListServer createSendOnlyServer(String smtp, Duration sendInterval) {\n+        return new SendOnlyServer(smtp, sendInterval);\n","filename":"mailinglist\/src\/main\/java\/org\/openjdk\/skara\/mailinglist\/MailingListServerFactory.java","additions":15,"deletions":5,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -0,0 +1,49 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package org.openjdk.skara.mailinglist.mailman;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+import java.time.ZonedDateTime;\n+import java.time.format.DateTimeFormatter;\n+import java.util.Arrays;\n+import java.util.Locale;\n+import org.openjdk.skara.mailinglist.MailingListReader;\n+import org.openjdk.skara.network.URIBuilder;\n+\n+public class Mailman2Server extends MailmanServer {\n+\n+    public Mailman2Server(URI archive, String smtpServer, Duration sendInterval, boolean useEtag) {\n+        super(archive, smtpServer, sendInterval, useEtag);\n+    }\n+\n+    URI getMboxUri(String listName, ZonedDateTime month) {\n+        var dateStr = DateTimeFormatter.ofPattern(\"yyyy-MMMM\", Locale.US).format(month);\n+        return URIBuilder.base(archive).appendPath(listName + \"\/\" + dateStr + \".txt\").build();\n+    }\n+\n+    @Override\n+    public MailingListReader getListReader(String... listNames) {\n+        return new Mailman2ListReader(this, Arrays.asList(listNames), useEtag);\n+    }\n+}\n","filename":"mailinglist\/src\/main\/java\/org\/openjdk\/skara\/mailinglist\/mailman\/Mailman2Server.java","additions":49,"deletions":0,"binary":false,"changes":49,"status":"added"},{"patch":"@@ -0,0 +1,51 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package org.openjdk.skara.mailinglist.mailman;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+import java.time.ZonedDateTime;\n+import java.util.Arrays;\n+import org.openjdk.skara.mailinglist.MailingListReader;\n+\n+public class Mailman3Server extends MailmanServer {\n+    private final ZonedDateTime startTime;\n+\n+    public Mailman3Server(URI archive, String smtpServer, Duration sendInterval, ZonedDateTime startTime) {\n+        super(archive, smtpServer, sendInterval, false);\n+        this.startTime = startTime;\n+    }\n+\n+    public Mailman3Server(URI archive, String smtpServer, Duration sendInterval) {\n+        this(archive, smtpServer, sendInterval, ZonedDateTime.now());\n+    }\n+\n+    URI getArchiveUri() {\n+        return archive;\n+    }\n+\n+    @Override\n+    public MailingListReader getListReader(String... listNames) {\n+        return new Mailman3ListReader(this, Arrays.asList(listNames), startTime);\n+    }\n+}\n","filename":"mailinglist\/src\/main\/java\/org\/openjdk\/skara\/mailinglist\/mailman\/Mailman3Server.java","additions":51,"deletions":0,"binary":false,"changes":51,"status":"added"},{"patch":"@@ -25,0 +25,3 @@\n+import java.nio.charset.StandardCharsets;\n+import java.time.format.DateTimeFormatter;\n+import java.util.zip.GZIPInputStream;\n@@ -37,0 +40,1 @@\n+import org.openjdk.skara.network.URIBuilder;\n@@ -38,2 +42,1 @@\n-public class MailmanListReader implements MailingListReader {\n-    private final MailmanServer server;\n+public abstract class MailmanListReader implements MailingListReader {\n@@ -41,1 +44,1 @@\n-    private final List<String> names = new ArrayList<>();\n+    protected final List<String> names = new ArrayList<>();\n@@ -43,2 +46,2 @@\n-    private final ConcurrentMap<URI, HttpResponse<String>> pageCache = new ConcurrentHashMap<>();\n-    private List<Conversation> cachedConversations = new ArrayList<>();\n+    protected final ConcurrentMap<URI, HttpResponse<byte[]>> pageCache = new ConcurrentHashMap<>();\n+    protected List<Conversation> cachedConversations = new ArrayList<>();\n@@ -52,2 +55,1 @@\n-    MailmanListReader(MailmanServer server, Collection<String> names, boolean useEtag) {\n-        this.server = server;\n+    MailmanListReader(Collection<String> names, boolean useEtag) {\n@@ -64,23 +66,1 @@\n-    @Override\n-    public String toString() {\n-        return \"MailmanList:\" + String.join(\", \", names);\n-    }\n-\n-    private List<ZonedDateTime> getMonthRange(Duration maxAge) {\n-        var now = ZonedDateTime.now();\n-        var start = now.minus(maxAge);\n-        List<ZonedDateTime> ret = new ArrayList<>();\n-\n-        \/\/ Iterate all the way until start is equal to now\n-        while (!start.isAfter(now)) {\n-            ret.add(start);\n-            var next = start.plus(Duration.ofDays(1));\n-            while (start.getMonthValue() == next.getMonthValue()) {\n-                next = next.plus(Duration.ofDays(1));\n-            }\n-            start = next;\n-        }\n-        return ret;\n-    }\n-\n-    private Optional<HttpResponse<String>> getPage(URI uri) {\n+    protected Optional<HttpResponse<byte[]>> getPage(URI uri) {\n@@ -99,1 +79,1 @@\n-            HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());\n+            HttpResponse<byte[]> response = client.send(request, HttpResponse.BodyHandlers.ofByteArray());\n@@ -121,0 +101,39 @@\n+    protected void updateCachedConversations(ArrayList<Email> emails, Duration maxAge) {\n+        var conversations = Mbox.parseMbox(emails);\n+        var threshold = ZonedDateTime.now().minus(maxAge);\n+        cachedConversations = conversations.stream()\n+                .filter(mail -> mail.first().date().isAfter(threshold))\n+                .collect(Collectors.toList());\n+    }\n+}\n+\n+class Mailman2ListReader extends MailmanListReader {\n+    private final Mailman2Server server;\n+\n+    Mailman2ListReader(Mailman2Server server, Collection<String> names, boolean useEtag) {\n+        super(names, useEtag);\n+        this.server = server;\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return \"Mailman2List:\" + String.join(\", \", names);\n+    }\n+\n+    private List<ZonedDateTime> getMonthRange(Duration maxAge) {\n+        var now = ZonedDateTime.now();\n+        var start = now.minus(maxAge);\n+        List<ZonedDateTime> ret = new ArrayList<>();\n+\n+        \/\/ Iterate all the way until start is equal to now\n+        while (!start.isAfter(now)) {\n+            ret.add(start);\n+            var next = start.plus(Duration.ofDays(1));\n+            while (start.getMonthValue() == next.getMonthValue()) {\n+                next = next.plus(Duration.ofDays(1));\n+            }\n+            start = next;\n+        }\n+        return ret;\n+    }\n+\n@@ -126,1 +145,1 @@\n-                                                  .collect(Collectors.toList());\n+                                                  .toList();\n@@ -133,1 +152,1 @@\n-                URI mboxUri = server.getMbox(name, month);\n+                URI mboxUri = server.getMboxUri(name, month);\n@@ -140,1 +159,1 @@\n-                        emails.addAll(0, Mbox.splitMbox(cachedResponse.body(), sender));\n+                        emails.addAll(0, Mbox.splitMbox(new String(cachedResponse.body(), StandardCharsets.UTF_8), sender));\n@@ -146,1 +165,1 @@\n-                            emails.addAll(0, Mbox.splitMbox(pageCache.get(mboxUri).body(), sender));\n+                            emails.addAll(0, Mbox.splitMbox(new String(pageCache.get(mboxUri).body(), StandardCharsets.UTF_8), sender));\n@@ -148,1 +167,1 @@\n-                            emails.addAll(0, Mbox.splitMbox(mboxResponse.get().body(), sender));\n+                            emails.addAll(0, Mbox.splitMbox(new String(mboxResponse.get().body(), StandardCharsets.UTF_8), sender));\n@@ -158,5 +177,1 @@\n-            var conversations = Mbox.parseMbox(emails);\n-            var threshold = ZonedDateTime.now().minus(maxAge);\n-            cachedConversations = conversations.stream()\n-                                       .filter(mail -> mail.first().date().isAfter(threshold))\n-                                       .collect(Collectors.toList());\n+            updateCachedConversations(emails, maxAge);\n@@ -168,0 +183,104 @@\n+\n+class Mailman3ListReader extends MailmanListReader {\n+    private final Mailman3Server server;\n+    private final ZonedDateTime startTime;\n+\n+    Mailman3ListReader(Mailman3Server server, Collection<String> names, ZonedDateTime startTime) {\n+        \/\/ Mailman3 does not support etag for mbox API\n+        super(names, false);\n+        this.server = server;\n+        this.startTime = startTime;\n+    }\n+\n+    \/**\n+     * Reads all emails newer than maxAge. Reads everything older than start\n+     * time in one go and caches that result. This chunk will always read start\n+     * time minus max age. Emails older than now minus max age are filtered out\n+     * later. Chunks newer than start time are read one day at a time, each day\n+     * getting cached when the next day starts. This means only the current day\n+     * is refreshed each time this method is called.\n+     *\n+     * @param maxAge Maximum age of emails to read relative to the start time.\n+     * @return Emails sorted in conversations\n+     *\/\n+    @Override\n+    public List<Conversation> conversations(Duration maxAge) {\n+        var now = ZonedDateTime.now();\n+        \/\/ First interval is everything before start time\n+        var start = startTime.minus(maxAge);\n+        var end = startTime.plusDays(1);\n+\n+        var emails = new ArrayList<Email>();\n+        var newContent = false;\n+        \/\/ https:\/\/mail-dev.example.com\/archives\/list\/skara-test@mail-dev.example.com\/export\/foo.mbox.gz?start=2024-10-25&end=2025-10-25\n+\n+        while (start.isBefore(now)) {\n+            var query = Map.of(\"start\", List.of(start.format(DateTimeFormatter.ISO_LOCAL_DATE)),\n+                    \"end\", List.of(end.format(DateTimeFormatter.ISO_LOCAL_DATE)));\n+            for (String name : names) {\n+                var mboxUri = URIBuilder.base(server.getArchiveUri()).appendPath(\"list\/\").appendPath(name)\n+                        .appendPath(\"@\").appendPath(server.getArchiveUri().getHost())\n+                        .appendPath(\"\/export\/foo.mbox.gz\").setQuery(query).build();\n+                var sender = EmailAddress.from(name + \"@\" + server.getArchiveUri().getHost());\n+                \/\/ For archives older than today, always use cached results\n+                if (end.isBefore(now) && pageCache.containsKey(mboxUri)) {\n+                    var cachedResponse = pageCache.get(mboxUri);\n+                    if (cachedResponse != null && cachedResponse.statusCode() != 404) {\n+                        emails.addAll(0, Mbox.splitMbox(gunzipToString(cachedResponse.body()), sender));\n+                    }\n+                } else {\n+                    var mboxResponse = getPage(mboxUri);\n+                    if (mboxResponse.isPresent()) {\n+                        emails.addAll(0, Mbox.splitMbox(gunzipToString(mboxResponse.get().body()), sender));\n+                        newContent = true;\n+                    }\n+                }\n+            }\n+            \/\/ Every interval after the first is one day\n+            start = end;\n+            end = end.plusDays(1);\n+        }\n+\n+        if (newContent) {\n+            updateCachedConversations(emails, maxAge);\n+        }\n+\n+        return cachedConversations;\n+    }\n+\n+    private String gunzipToString(byte[] data) {\n+        try (var in = new InputStreamReader(new GZIPInputStream(new ByteArrayInputStream(data)), StandardCharsets.UTF_8)) {\n+            var out = new StringBuilderWriter();\n+            in.transferTo(out);\n+            return out.toString();\n+        } catch (IOException e) {\n+            throw new UncheckedIOException(e);\n+        }\n+    }\n+\n+    \/**\n+     * Simple StringWriter clone that uses a StringBuilder instead of a StringBuffer.\n+     *\/\n+    private static class StringBuilderWriter extends Writer {\n+\n+        private final StringBuilder buf = new StringBuilder();\n+\n+        @Override\n+        public String toString() {\n+            return buf.toString();\n+        }\n+\n+        @Override\n+        public void write(char[] cbuf, int off, int len) {\n+            buf.append(cbuf, off, len);\n+        }\n+\n+        @Override\n+        public void flush() {\n+        }\n+\n+        @Override\n+        public void close() {\n+        }\n+    }\n+}\n","filename":"mailinglist\/src\/main\/java\/org\/openjdk\/skara\/mailinglist\/mailman\/MailmanListReader.java","additions":160,"deletions":41,"binary":false,"changes":201,"status":"modified"},{"patch":"@@ -27,1 +27,0 @@\n-import org.openjdk.skara.network.URIBuilder;\n@@ -32,2 +31,0 @@\n-import java.time.format.DateTimeFormatter;\n-import java.util.*;\n@@ -35,2 +32,2 @@\n-public class MailmanServer implements MailingListServer {\n-    private final URI archive;\n+public abstract class MailmanServer implements MailingListServer {\n+    protected final URI archive;\n@@ -39,1 +36,1 @@\n-    private final boolean useEtag;\n+    protected final boolean useEtag;\n@@ -42,1 +39,1 @@\n-    public MailmanServer(URI archive, String smtpServer, Duration sendInterval, boolean useEtag) {\n+    protected MailmanServer(URI archive, String smtpServer, Duration sendInterval, boolean useEtag) {\n@@ -50,5 +47,0 @@\n-    URI getMbox(String listName, ZonedDateTime month) {\n-        var dateStr = DateTimeFormatter.ofPattern(\"yyyy-MMMM\", Locale.US).format(month);\n-        return URIBuilder.base(archive).appendPath(listName + \"\/\" + dateStr + \".txt\").build();\n-    }\n-\n@@ -75,3 +67,2 @@\n-    @Override\n-    public MailingListReader getListReader(String... listNames) {\n-        return new MailmanListReader(this, Arrays.asList(listNames), useEtag);\n+    public URI archive() {\n+        return archive;\n","filename":"mailinglist\/src\/main\/java\/org\/openjdk\/skara\/mailinglist\/mailman\/MailmanServer.java","additions":6,"deletions":15,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -0,0 +1,40 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package org.openjdk.skara.mailinglist.mailman;\n+\n+import java.time.Duration;\n+import org.openjdk.skara.mailinglist.MailingListReader;\n+\n+\/**\n+ * MailingListServer implementation that only implements the send message API.\n+ *\/\n+public class SendOnlyServer extends MailmanServer {\n+    public SendOnlyServer(String smtpServer, Duration sendInterval) {\n+        super(null, smtpServer, sendInterval, false);\n+    }\n+\n+    @Override\n+    public MailingListReader getListReader(String... listNames) {\n+        throw new UnsupportedOperationException();\n+    }\n+}\n","filename":"mailinglist\/src\/main\/java\/org\/openjdk\/skara\/mailinglist\/mailman\/SendOnlyServer.java","additions":40,"deletions":0,"binary":false,"changes":40,"status":"added"},{"patch":"@@ -35,1 +35,1 @@\n-class MailmanTests {\n+class Mailman2Tests {\n@@ -38,1 +38,1 @@\n-        try (var testServer = new TestMailmanServer()) {\n+        try (var testServer = TestMailmanServer.createV2()) {\n@@ -40,1 +40,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(testServer.getArchive(), testServer.getSMTP(),\n+            var mailmanServer = MailingListServerFactory.createMailman2Server(testServer.getArchive(), testServer.getSMTP(),\n@@ -63,1 +63,1 @@\n-        try (var testServer = new TestMailmanServer()) {\n+        try (var testServer = TestMailmanServer.createV2()) {\n@@ -65,1 +65,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(testServer.getArchive(), testServer.getSMTP(),\n+            var mailmanServer = MailingListServerFactory.createMailman2Server(testServer.getArchive(), testServer.getSMTP(),\n@@ -109,1 +109,1 @@\n-        try (var testServer = new TestMailmanServer()) {\n+        try (var testServer = TestMailmanServer.createV2()) {\n@@ -111,1 +111,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(testServer.getArchive(), testServer.getSMTP(),\n+            var mailmanServer = MailingListServerFactory.createMailman2Server(testServer.getArchive(), testServer.getSMTP(),\n@@ -143,1 +143,1 @@\n-        try (var testServer = new TestMailmanServer()) {\n+        try (var testServer = TestMailmanServer.createV2()) {\n@@ -145,1 +145,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(testServer.getArchive(), testServer.getSMTP(),\n+            var mailmanServer = MailingListServerFactory.createMailman2Server(testServer.getArchive(), testServer.getSMTP(),\n@@ -175,1 +175,1 @@\n-        try (var testServer = new TestMailmanServer()) {\n+        try (var testServer = TestMailmanServer.createV2()) {\n@@ -177,1 +177,1 @@\n-            var mailmanServer = MailingListServerFactory.createMailmanServer(testServer.getArchive(),\n+            var mailmanServer = MailingListServerFactory.createMailman2Server(testServer.getArchive(),\n","filename":"mailinglist\/src\/test\/java\/org\/openjdk\/skara\/mailinglist\/Mailman2Tests.java","additions":11,"deletions":11,"binary":false,"changes":22,"previous_filename":"mailinglist\/src\/test\/java\/org\/openjdk\/skara\/mailinglist\/MailmanTests.java","status":"renamed"},{"patch":"@@ -0,0 +1,53 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package org.openjdk.skara.mailinglist;\n+\n+import java.time.Duration;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.openjdk.skara.network.URIBuilder;\n+import org.openjdk.skara.test.EnabledIfTestProperties;\n+import org.openjdk.skara.test.TestProperties;\n+\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+\n+public class Mailman3IntegrationTests {\n+\n+    private static TestProperties props;\n+\n+    @BeforeAll\n+    static void beforeAll() {\n+        props = TestProperties.load();\n+    }\n+\n+    @Test\n+    @EnabledIfTestProperties({\"mailman3.url\", \"mailman3.list\"})\n+    void testReviews() {\n+        var url = props.get(\"mailman3.url\");\n+        var listName = props.get(\"mailman3.list\");\n+        var mailmanServer = MailingListServerFactory.createMailman3Server(URIBuilder.base(url).build(), null, null);\n+        var listReader = mailmanServer.getListReader(listName);\n+        var conversations = listReader.conversations(Duration.ofDays(365));\n+        assertFalse(conversations.isEmpty());\n+    }\n+}\n","filename":"mailinglist\/src\/test\/java\/org\/openjdk\/skara\/mailinglist\/Mailman3IntegrationTests.java","additions":53,"deletions":0,"binary":false,"changes":53,"status":"added"},{"patch":"@@ -0,0 +1,231 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package org.openjdk.skara.mailinglist;\n+\n+import java.io.IOException;\n+import java.time.Duration;\n+import java.time.ZonedDateTime;\n+import org.junit.jupiter.api.Test;\n+import org.openjdk.skara.email.Email;\n+import org.openjdk.skara.email.EmailAddress;\n+import org.openjdk.skara.mailinglist.mailman.Mailman3Server;\n+import org.openjdk.skara.test.TestMailmanServer;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class Mailman3Tests {\n+    @Test\n+    void simple() throws IOException {\n+        try (var testServer = TestMailmanServer.createV3()) {\n+            var listAddress = testServer.createList(\"test\");\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(testServer.getArchive(), testServer.getSMTP(),\n+                                                                             Duration.ZERO);\n+            var mailmanList = mailmanServer.getListReader(listAddress);\n+            var sender = EmailAddress.from(\"Test\", \"test@test.email\");\n+            var mail = Email.create(sender, \"Subject\", \"Body\")\n+                            .recipient(EmailAddress.parse(listAddress))\n+                            .build();\n+            mailmanServer.post(mail);\n+            var expectedMail = Email.from(mail)\n+                                    .sender(EmailAddress.parse(listAddress))\n+                                    .build();\n+\n+            testServer.processIncoming();\n+\n+            var conversations = mailmanList.conversations(Duration.ofDays(1));\n+            assertEquals(1, conversations.size());\n+            var conversation = conversations.get(0);\n+            assertEquals(expectedMail, conversation.first());\n+        }\n+    }\n+\n+    @Test\n+    void replies() throws IOException {\n+        try (var testServer = TestMailmanServer.createV3()) {\n+            var listAddress = testServer.createList(\"test\");\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(testServer.getArchive(), testServer.getSMTP(),\n+                                                                             Duration.ZERO);\n+            var mailmanList = mailmanServer.getListReader(listAddress);\n+            var sender = EmailAddress.from(\"Test\", \"test@test.email\");\n+            var sentParent = Email.create(sender, \"Subject\", \"Body\")\n+                                  .recipient(EmailAddress.parse(listAddress))\n+                                  .build();\n+            mailmanServer.post(sentParent);\n+            testServer.processIncoming();\n+            var expectedParent = Email.from(sentParent)\n+                                      .sender(EmailAddress.parse(listAddress))\n+                                      .build();\n+\n+            var conversations = mailmanList.conversations(Duration.ofDays(1));\n+            assertEquals(1, conversations.size());\n+            var conversation = conversations.get(0);\n+            assertEquals(expectedParent, conversation.first());\n+\n+            var replier = EmailAddress.from(\"Replier\", \"replier@test.email\");\n+            var sentReply = Email.create(replier, \"Reply subject\", \"Reply body\")\n+                                 .recipient(EmailAddress.parse(listAddress))\n+                                 .header(\"In-Reply-To\", sentParent.id().toString())\n+                                 .build();\n+            mailmanServer.post(sentReply);\n+            var expectedReply = Email.from(sentReply)\n+                                     .sender(EmailAddress.parse(listAddress))\n+                                     .build();\n+\n+            testServer.processIncoming();\n+\n+            conversations = mailmanList.conversations(Duration.ofDays(1));\n+            assertEquals(1, conversations.size());\n+            conversation = conversations.get(0);\n+            assertEquals(expectedParent, conversation.first());\n+\n+            var replies = conversation.replies(conversation.first());\n+            assertEquals(1, replies.size());\n+            var reply = replies.get(0);\n+            assertEquals(expectedReply, reply);\n+        }\n+    }\n+\n+    @Test\n+    void interval() throws IOException {\n+        try (var testServer = TestMailmanServer.createV3()) {\n+            var listAddress = testServer.createList(\"test\");\n+            var mailmanServer = MailingListServerFactory.createMailman3Server(testServer.getArchive(), testServer.getSMTP(),\n+                                                                             Duration.ofDays(1));\n+            var mailmanList = mailmanServer.getListReader(listAddress);\n+            var sender = EmailAddress.from(\"Test\", \"test@test.email\");\n+            var mail1 = Email.create(sender, \"Subject 1\", \"Body 1\")\n+                             .recipient(EmailAddress.parse(listAddress))\n+                             .build();\n+            var mail2 = Email.create(sender, \"Subject 2\", \"Body 2\")\n+                             .recipient(EmailAddress.parse(listAddress))\n+                             .build();\n+            new Thread(() -> {\n+                mailmanServer.post(mail1);\n+                mailmanServer.post(mail2);\n+            }).start();\n+            var expectedMail = Email.from(mail1)\n+                                    .sender(EmailAddress.parse(listAddress))\n+                                    .build();\n+\n+            testServer.processIncoming();\n+            assertThrows(RuntimeException.class, () -> testServer.processIncoming(Duration.ZERO));\n+\n+            var conversations = mailmanList.conversations(Duration.ofDays(1));\n+            assertEquals(1, conversations.size());\n+            var conversation = conversations.get(0);\n+            assertEquals(expectedMail, conversation.first());\n+        }\n+    }\n+\n+    @Test\n+    void poll3days() throws Exception {\n+        try (var testServer = TestMailmanServer.createV3()) {\n+            var listAddress = testServer.createList(\"test\");\n+            var now = ZonedDateTime.now();\n+            var mailmanServer = new Mailman3Server(testServer.getArchive(),\n+                    testServer.getSMTP(), Duration.ZERO, now.minusDays(2));\n+            var mailmanList = mailmanServer.getListReader(listAddress);\n+            var sender = EmailAddress.from(\"Test\", \"test@test.email\");\n+\n+            var duration3Days = Duration.between(now.minusDays(3), now);\n+\n+            {\n+                \/\/ A 2 days old should be picked up\n+                var mail2daysAgo = Email.create(sender, \"Subject 2 day2 ago\", \"Body 1\")\n+                        .recipient(EmailAddress.parse(listAddress))\n+                        .date(now.minusDays(2))\n+                        .build();\n+                mailmanServer.post(mail2daysAgo);\n+                testServer.processIncoming();\n+                testServer.resetCallCount();\n+                var conversations = mailmanList.conversations(duration3Days);\n+                assertEquals(1, conversations.size());\n+                assertEquals(3, testServer.callCount(),\n+                        \"Server wasn't for initial interval plus every day since start time\");\n+            }\n+            {\n+                \/\/ A 2 days old mail should not be picked up now as old results should be cached\n+                var mail2daysAgo2 = Email.create(sender, \"Subject 2 days ago 2\", \"Body 2\")\n+                        .recipient(EmailAddress.parse(listAddress))\n+                        .date(now.minusDays(2))\n+                        .build();\n+                mailmanServer.post(mail2daysAgo2);\n+                testServer.processIncoming();\n+                testServer.resetCallCount();\n+                var conversations = mailmanList.conversations(duration3Days);\n+                assertEquals(1, conversations.size());\n+                assertEquals(1, testServer.callCount(), \"Server wasn't called once\");\n+            }\n+            {\n+                \/\/ A 1-day-old mail should not be picked up now as old results should be cached\n+                var mail1dayAgo = Email.create(sender, \"Subject 1 day ago\", \"Body 2\")\n+                        .recipient(EmailAddress.parse(listAddress))\n+                        .date(now.minusDays(1))\n+                        .build();\n+                mailmanServer.post(mail1dayAgo);\n+                testServer.processIncoming();\n+                testServer.resetCallCount();\n+                var conversations = mailmanList.conversations(duration3Days);\n+                assertEquals(1, conversations.size());\n+                assertEquals(1, testServer.callCount());\n+            }\n+            {\n+                \/\/ A current mail should be found\n+                var mailNow = Email.create(sender, \"Subject now\", \"Body 3\")\n+                        .recipient(EmailAddress.parse(listAddress))\n+                        .build();\n+                mailmanServer.post(mailNow);\n+                testServer.processIncoming();\n+                testServer.resetCallCount();\n+                var conversations = mailmanList.conversations(duration3Days);\n+                assertEquals(2, conversations.size());\n+                assertEquals(1, testServer.callCount());\n+            }\n+            {\n+                \/\/ Another mail from last month should not be found\n+                var mail1dayAgo2 = Email.create(sender, \"Subject 1 day ago 2\", \"Body 2\")\n+                        .recipient(EmailAddress.parse(listAddress))\n+                        .date(now.minusDays(1))\n+                        .build();\n+                mailmanServer.post(mail1dayAgo2);\n+                testServer.processIncoming();\n+                testServer.resetCallCount();\n+                var conversations = mailmanList.conversations(duration3Days);\n+                assertEquals(2, conversations.size());\n+                assertEquals(1, testServer.callCount());\n+            }\n+            {\n+                \/\/ Another current mail should be found\n+                var mailNow2 = Email.create(sender, \"Subject now 2\", \"Body 3\")\n+                        .recipient(EmailAddress.parse(listAddress))\n+                        .build();\n+                mailmanServer.post(mailNow2);\n+                testServer.processIncoming();\n+                testServer.resetCallCount();\n+                var conversations = mailmanList.conversations(duration3Days);\n+                assertEquals(3, conversations.size());\n+                assertEquals(1, testServer.callCount());\n+            }\n+        }\n+    }\n+}\n","filename":"mailinglist\/src\/test\/java\/org\/openjdk\/skara\/mailinglist\/Mailman3Tests.java","additions":231,"deletions":0,"binary":false,"changes":231,"status":"added"},{"patch":"@@ -26,0 +26,3 @@\n+import java.time.LocalDate;\n+import java.time.ZoneId;\n+import java.time.ZonedDateTime;\n@@ -27,0 +30,1 @@\n+import java.util.zip.GZIPOutputStream;\n@@ -39,2 +43,2 @@\n-public class TestMailmanServer implements AutoCloseable {\n-    private final HttpServer httpServer;\n+public abstract class TestMailmanServer implements AutoCloseable {\n+    protected final HttpServer httpServer;\n@@ -42,2 +46,0 @@\n-    private final Map<String, HashMap<String, StringBuilder>> lists = new HashMap<>();\n-\n@@ -45,1 +47,0 @@\n-\n@@ -48,1 +49,7 @@\n-    static private final Pattern listPathPattern = Pattern.compile(\"^\/test\/(.*?)\/(.*)\\\\.txt\");\n+    public static TestMailmanServer createV2() throws IOException {\n+        return new TestMailman2Server();\n+    }\n+\n+    public static TestMailmanServer createV3() throws IOException {\n+        return new TestMailman3Server();\n+    }\n@@ -54,8 +61,2 @@\n-            var listMatcher = listPathPattern.matcher(exchange.getRequestURI().getPath());\n-            if (!listMatcher.matches()) {\n-                throw new RuntimeException();\n-            }\n-            var listPath = listMatcher.group(1);\n-            var datePath = listMatcher.group(2);\n-            var listMap = lists.get(listPath);\n-            if (!listMap.containsKey(datePath)) {\n+            var mboxContents = getMboxContents(exchange);\n+            if (mboxContents == null) {\n@@ -66,1 +67,0 @@\n-            var response = listMap.get(datePath).toString();\n@@ -71,1 +71,1 @@\n-                digest.update(response.getBytes(StandardCharsets.UTF_8));\n+                digest.update(mboxContents);\n@@ -83,2 +83,1 @@\n-                var responseBytes = response.getBytes(StandardCharsets.UTF_8);\n-                exchange.sendResponseHeaders(200, responseBytes.length);\n+                exchange.sendResponseHeaders(200, mboxContents.length);\n@@ -86,1 +85,1 @@\n-                outputStream.write(responseBytes);\n+                outputStream.write(mboxContents);\n@@ -94,2 +93,1 @@\n-    public TestMailmanServer() throws IOException\n-    {\n+    protected TestMailmanServer() throws IOException {\n@@ -105,0 +103,2 @@\n+    protected abstract byte[] getMboxContents(HttpExchange exchange);\n+\n@@ -113,5 +113,1 @@\n-    public String createList(String name) throws IOException {\n-        var listName = EmailAddress.parse(name + \"@\" + httpServer.getAddress().getHostString()).toString();\n-        lists.put(name, new HashMap<>());\n-        return listName;\n-    }\n+    public abstract String createList(String name);\n@@ -119,1 +115,1 @@\n-    public void processIncoming(Duration timeout) throws IOException {\n+    public void processIncoming(Duration timeout) {\n@@ -130,9 +126,1 @@\n-        var listMap = email.recipients().stream()\n-                            .filter(recipient -> lists.containsKey(recipient.localPart()))\n-                            .map(recipient -> lists.get(recipient.localPart()))\n-                            .findAny().orElseThrow();\n-        var datePath = DateTimeFormatter.ofPattern(\"yyyy-MMMM\", Locale.US).format(email.date());\n-        if (!listMap.containsKey(datePath)) {\n-            listMap.put(datePath, new StringBuilder());\n-        }\n-        listMap.get(datePath).append(mboxEntry);\n+        archiveEmail(email, mboxEntry);\n@@ -141,1 +129,3 @@\n-    public void processIncoming() throws IOException {\n+    protected abstract void archiveEmail(Email email, String mboxEntry);\n+\n+    public void processIncoming() {\n@@ -163,0 +153,122 @@\n+\n+class TestMailman2Server extends TestMailmanServer {\n+\n+    private static final Pattern listPathPattern = Pattern.compile(\"^\/test\/(.*?)\/(.*)\\\\.txt\");\n+    \/\/ Map from local part of email list name to map from date string to mbox contents\n+    private final Map<String, Map<String, StringBuilder>> lists = new HashMap<>();\n+\n+    public TestMailman2Server() throws IOException {\n+        super();\n+    }\n+\n+    @Override\n+    protected void archiveEmail(Email email, String mboxEntry) {\n+        var listMap = email.recipients().stream()\n+                            .filter(recipient -> lists.containsKey(recipient.localPart()))\n+                            .map(recipient -> lists.get(recipient.localPart()))\n+                            .findAny().orElseThrow();\n+        var datePath = DateTimeFormatter.ofPattern(\"yyyy-MMMM\", Locale.US).format(email.date());\n+        if (!listMap.containsKey(datePath)) {\n+            listMap.put(datePath, new StringBuilder());\n+        }\n+        listMap.get(datePath).append(mboxEntry);\n+    }\n+\n+    @Override\n+    protected byte[] getMboxContents(HttpExchange exchange) {\n+        var listMatcher = listPathPattern.matcher(exchange.getRequestURI().getPath());\n+        if (!listMatcher.matches()) {\n+            throw new RuntimeException();\n+        }\n+        var listPath = listMatcher.group(1);\n+        var datePath = listMatcher.group(2);\n+        var listMap = lists.get(listPath);\n+        var contents = listMap.get(datePath);\n+        if (contents != null) {\n+            return contents.toString().getBytes(StandardCharsets.UTF_8);\n+        } else {\n+            return null;\n+        }\n+    }\n+\n+    @Override\n+    public String createList(String name) {\n+        var listName = EmailAddress.parse(name + \"@\" + httpServer.getAddress().getHostString()).toString();\n+        lists.put(name, new HashMap<>());\n+        return listName;\n+    }\n+}\n+\n+class TestMailman3Server extends TestMailmanServer {\n+\n+    private record EmailEntry(Email email, String mbox) {}\n+\n+    private Map<String, List<EmailEntry>> lists = new HashMap<>();\n+\n+    private static final Pattern listPathPattern = Pattern.compile(\"^\/test\/list\/(.*?)\/export\/(.*)\\\\.mbox.gz\");\n+\n+    protected TestMailman3Server() throws IOException {\n+        super();\n+    }\n+\n+    @Override\n+    protected byte[] getMboxContents(HttpExchange exchange) {\n+        \/\/ https:\/\/mail-dev.example.com\/archives\/list\/skara-test@mail-dev.example.com\/export\/foo.mbox.gz?start=2024-10-25&end=2025-10-25\n+        var listMatcher = listPathPattern.matcher(exchange.getRequestURI().getPath());\n+        if (!listMatcher.matches()) {\n+            throw new RuntimeException();\n+        }\n+        var listPath = listMatcher.group(1);\n+\n+        var query = exchange.getRequestURI().getRawQuery();\n+        String[] pairs = query.split(\"&\");\n+        ZonedDateTime start = null;\n+        ZonedDateTime end = null;\n+        for (String pair : pairs) {\n+            int i = pair.indexOf(\"=\");\n+            if (i > 0) {\n+                String key = URLDecoder.decode(pair.substring(0, i), StandardCharsets.UTF_8);\n+                String value = URLDecoder.decode(pair.substring(i + 1), StandardCharsets.UTF_8);\n+                if (\"start\".equals(key)) {\n+                    start = LocalDate.parse(value).atStartOfDay(ZoneId.systemDefault());\n+                } else if (\"end\".equals(key)) {\n+                    end = LocalDate.parse(value).atStartOfDay(ZoneId.systemDefault());\n+                }\n+            } else {\n+                throw new RuntimeException();\n+            }\n+        }\n+        var entryList = lists.get(listPath);\n+        var mbox = new StringBuilder();\n+        var startDate = start;\n+        var endDate = end;\n+        entryList.stream()\n+                .filter(e -> startDate == null || startDate.isBefore(e.email.date()))\n+                .filter(e -> endDate == null || endDate.isAfter(e.email.date()))\n+                .forEach(e -> mbox.append(e.mbox));\n+\n+        var zipped = new ByteArrayOutputStream();\n+        try (var out = new OutputStreamWriter(new GZIPOutputStream(zipped))) {\n+            out.write(mbox.toString());\n+        } catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+        return zipped.toByteArray();\n+    }\n+\n+    @Override\n+    public String createList(String name) {\n+        var emailAddress = EmailAddress.parse(name + \"@\" + httpServer.getAddress().getHostString());\n+        lists.put(emailAddress.address(), new ArrayList<>());\n+        return emailAddress.toString();\n+    }\n+\n+    @Override\n+    protected void archiveEmail(Email email, String mboxEntry) {\n+        var entryList = email.recipients().stream()\n+                .filter(recipient -> lists.containsKey(recipient.address()))\n+                .map(recipient -> lists.get(recipient.address()))\n+                .findAny().orElseThrow();\n+        entryList.add(new EmailEntry(email, mboxEntry));\n+    }\n+}\n","filename":"test\/src\/main\/java\/org\/openjdk\/skara\/test\/TestMailmanServer.java","additions":149,"deletions":37,"binary":false,"changes":186,"status":"modified"}]}