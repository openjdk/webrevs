{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -76,0 +76,1 @@\n+    private static final String DIFF_TOO_LARGE_WARNING_MARKER = \"<!-- PullRequestBot diff too large warning comment -->\";\n@@ -462,0 +463,5 @@\n+        if (!backportDiff.complete() || !prDiff.complete()) {\n+            \/\/ Add diff too large warning comment\n+            addDiffTooLargeWarning();\n+            return false;\n+        }\n@@ -1266,0 +1272,13 @@\n+    private void addDiffTooLargeWarning() {\n+        var existing = findComment(DIFF_TOO_LARGE_WARNING_MARKER);\n+        if (existing.isPresent()) {\n+            \/\/ Only add the comment once per PR\n+            return;\n+        }\n+        var message = \"⚠️  @\" + pr.author().username() +\n+                \" This backport pull request is too large to be automatically evaluated as clean. \" +\n+                DIFF_TOO_LARGE_WARNING_MARKER;\n+        log.info(\"Adding diff too large warning comment\");\n+        pr.addComment(message);\n+    }\n+\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":20,"deletions":1,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -2099,0 +2099,67 @@\n+\n+\n+    @Test\n+    void incompleteBackport(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory(false)) {\n+\n+            var author = credentials.getHostedRepository();\n+            var integrator = credentials.getHostedRepository();\n+            var reviewer = credentials.getHostedRepository();\n+            var issues = credentials.getIssueProject();\n+            var censusBuilder = credentials.getCensusBuilder()\n+                    .addCommitter(author.forge().currentUser().id())\n+                    .addReviewer(integrator.forge().currentUser().id())\n+                    .addReviewer(reviewer.forge().currentUser().id());\n+            var bot = PullRequestBot.newBuilder()\n+                    .repo(integrator)\n+                    .censusRepo(censusBuilder.build())\n+                    .issueProject(issues)\n+                    .issuePRMap(new HashMap<>())\n+                    .build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepo = CheckableRepository.init(tempFolder.path(), author.repositoryType());\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            localRepo.push(masterHash, author.authenticatedUrl(), \"master\", true);\n+\n+            var releaseBranch = localRepo.branch(masterHash, \"release\");\n+            localRepo.checkout(releaseBranch);\n+            var newFile = localRepo.root().resolve(\"a_new_file.txt\");\n+            Files.writeString(newFile, \"hello\");\n+            localRepo.add(newFile);\n+            var issue1 = credentials.createIssue(issues, \"An issue\");\n+            var issue1Number = issue1.id().split(\"-\")[1];\n+            var originalMessage = issue1Number + \": An issue\\n\" +\n+                    \"\\n\" +\n+                    \"Reviewed-by: integrationreviewer2\";\n+            var releaseHash = localRepo.commit(originalMessage, \"integrationcommitter1\", \"integrationcommitter1@openjdk.org\");\n+            localRepo.push(releaseHash, author.authenticatedUrl(), \"refs\/heads\/release\", true);\n+\n+            \/\/ \"backport\" the new file to the master branch\n+            localRepo.checkout(localRepo.defaultBranch());\n+            var editBranch = localRepo.branch(masterHash, \"edit\");\n+            localRepo.checkout(editBranch);\n+            var newFile2 = localRepo.root().resolve(\"a_new_file.txt\");\n+            Files.writeString(newFile2, \"hello\");\n+            localRepo.add(newFile2);\n+            var editHash = localRepo.commit(\"Backport\", \"duke\", \"duke@openjdk.org\");\n+            localRepo.push(editHash, author.authenticatedUrl(), \"refs\/heads\/edit\", true);\n+            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"Backport \" + releaseHash.hex(), List.of());\n+            \/\/ Force the pr to return incomplete diff\n+            pr.setReturnCompleteDiff(false);\n+\n+            \/\/ The bot should reply with a backport message\n+            TestBotRunner.runPeriodicItems(bot);\n+            var comments = pr.comments();\n+            var backportComment = comments.get(1).body();\n+            assertTrue(backportComment.contains(\"This backport pull request has now been updated with issue\"));\n+            assertTrue(backportComment.contains(\"<!-- backport \" + releaseHash.hex() + \" -->\"));\n+            assertEquals(issue1Number + \": An issue\", pr.store().title());\n+            assertTrue(pr.store().labelNames().contains(\"backport\"));\n+            assertLastCommentContains(pr, \"This backport pull request is too large to be automatically evaluated as clean.\");\n+\n+            \/\/ The bot should not have added the \"clean\" label\n+            assertFalse(pr.store().labelNames().contains(\"clean\"));\n+        }\n+    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/BackportTests.java","additions":68,"deletions":1,"binary":false,"changes":69,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -754,1 +754,2 @@\n-        return repository.toDiff(targetHash, headHash(), files);\n+        var complete = files.asArray().size() != json.get(\"changed_files\").asInt();\n+        return repository.toDiff(targetHash, headHash(), files, complete);\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/github\/GitHubPullRequest.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -534,1 +534,1 @@\n-    Diff toDiff(Hash from, Hash to, JSONValue files) {\n+    Diff toDiff(Hash from, Hash to, JSONValue files, boolean complete) {\n@@ -556,1 +556,1 @@\n-        return new Diff(from, to, patches);\n+        return new Diff(from, to, patches, complete);\n@@ -582,1 +582,10 @@\n-            diffs = List.of(toDiff(metadata.parents().get(0), hash, o.get(\"files\")));\n+            var totalAdditions = o.get(\"stats\").get(\"additions\").asInt();\n+            var totalDeletions = o.get(\"stats\").get(\"deletions\").asInt();\n+            var sumAdditions = 0;\n+            var sumDeletions = 0;\n+            for (var patch : o.get(\"files\").asArray()) {\n+                sumAdditions += patch.get(\"additions\").asInt();\n+                sumDeletions += patch.get(\"deletions\").asInt();\n+            }\n+            var complete = totalAdditions == sumAdditions && totalDeletions == sumDeletions;\n+            diffs = List.of(toDiff(metadata.parents().get(0), hash, o.get(\"files\"), complete));\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/github\/GitHubRepository.java","additions":12,"deletions":3,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -833,0 +833,6 @@\n+        boolean diffComplete;\n+        if (changes.get(\"overflow\").asBoolean()) {\n+            diffComplete = false;\n+        } else {\n+            diffComplete = !changes.get(\"changes_count\").asString().contains(\"+\");\n+        }\n@@ -834,1 +840,1 @@\n-        return repository.toDiff(targetHash, headHash(), changes.get(\"changes\"));\n+        return repository.toDiff(targetHash, headHash(), changes.get(\"changes\"), diffComplete);\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabMergeRequest.java","additions":8,"deletions":2,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -692,1 +692,1 @@\n-    Diff toDiff(Hash from, Hash to, JSONValue o) {\n+    Diff toDiff(Hash from, Hash to, JSONValue o, boolean complete) {\n@@ -734,1 +734,1 @@\n-        return new Diff(from, to, patches);\n+        return new Diff(from, to, patches, complete);\n@@ -754,1 +754,5 @@\n-                diffs = List.of(toDiff(metadata.parents().get(0), hash, diff));\n+                \/\/ The diff here is limited by diff patch, diff files count, diff lines.\n+                \/\/ There is no feasible way to know if this diff is complete.\n+                \/\/ The diff here is only used to evaluate if a backport PR is clean or not,\n+                \/\/ assuming the diff is complete will not introduce any side effect.\n+                diffs = List.of(toDiff(metadata.parents().get(0), hash, diff, true));\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabRepository.java","additions":7,"deletions":3,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -497,0 +497,15 @@\n+\n+    @Test\n+    @EnabledIfTestProperties({\"github.user\", \"github.pat\", \"github.repository\", \"github.prId\", \"github.repository.commitHash\"})\n+    void testDiffComplete() {\n+        var githubRepoOpt = githubHost.repository(props.get(\"github.repository\"));\n+        assumeTrue(githubRepoOpt.isPresent());\n+        var githubRepo = githubRepoOpt.get();\n+        var commit = githubRepo.commit(new Hash(props.get(\"github.repository.commitHash\")), true);\n+        var diff = commit.get().parentDiffs().get(0);\n+        assertFalse(diff.complete());\n+\n+        var pr = githubRepo.pullRequest(props.get(\"github.prId\"));\n+        var prDiff = pr.diff();\n+        assertFalse(prDiff.complete());\n+    }\n","filename":"forge\/src\/test\/java\/org\/openjdk\/skara\/forge\/github\/GitHubIntegrationTests.java","additions":16,"deletions":1,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -391,0 +391,14 @@\n+\n+    @Test\n+    @EnabledIfTestProperties({\"gitlab.user\", \"gitlab.pat\", \"gitlab.uri\", \"gitlab.group\",\n+            \"gitlab.repository\", \"gitlab.merge.request.id\", \"gitlab.repository.commitHash\"})\n+    void testDiffComplete() {\n+        var gitLabRepo = gitLabHost.repository(props.get(\"gitlab.repository\")).orElseThrow();\n+        var commit = gitLabRepo.commit(new Hash(props.get(\"gitlab.repository.commitHash\")), true);\n+        var diff = commit.get().parentDiffs().get(0);\n+        assertTrue(diff.complete());\n+\n+        var pr = gitLabRepo.pullRequest(props.get(\"gitlab.merge.request.id\"));\n+        var prDiff = pr.diff();\n+        assertFalse(prDiff.complete());\n+    }\n","filename":"forge\/src\/test\/java\/org\/openjdk\/skara\/forge\/gitlab\/GitLabIntegrationTests.java","additions":15,"deletions":1,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -271,8 +271,15 @@\n-        try {\n-            var targetLocalRepository = targetRepository.localRepository();\n-            var sourceLocalRepository = store().sourceRepository().localRepository();\n-            var sourceHash = headHash();\n-            if (!targetLocalRepository.root().equals(sourceLocalRepository.root())) {\n-                \/\/ The target and source repo are not same, fetch the source branch\n-                var sourceUri = URI.create(\"file:\/\/\" + sourceLocalRepository.root().toString());\n-                sourceHash = targetLocalRepository.fetch(sourceUri, sourceRef).orElseThrow();\n+        if (store().returnCompleteDiff()) {\n+            try {\n+                var targetLocalRepository = targetRepository.localRepository();\n+                var sourceLocalRepository = store().sourceRepository().localRepository();\n+                var sourceHash = headHash();\n+                if (!targetLocalRepository.root().equals(sourceLocalRepository.root())) {\n+                    \/\/ The target and source repo are not same, fetch the source branch\n+                    var sourceUri = URI.create(\"file:\/\/\" + sourceLocalRepository.root().toString());\n+                    sourceHash = targetLocalRepository.fetch(sourceUri, sourceRef).orElseThrow();\n+                }\n+                \/\/ Find the base hash of the source and target branches.\n+                var baseHash = targetLocalRepository.mergeBase(sourceHash, targetRepository.branchHash(targetRef()).orElseThrow());\n+                return targetLocalRepository.diff(baseHash, sourceHash);\n+            } catch (IOException e) {\n+                throw new UncheckedIOException(e);\n@@ -280,5 +287,2 @@\n-            \/\/ Find the base hash of the source and target branches.\n-            var baseHash = targetLocalRepository.mergeBase(sourceHash, targetRepository.branchHash(targetRef()).orElseThrow());\n-            return targetLocalRepository.diff(baseHash, sourceHash);\n-        } catch (IOException e) {\n-            throw new UncheckedIOException(e);\n+        } else {\n+            return new Diff(Hash.zero(), Hash.zero(), List.of(), false);\n@@ -353,0 +357,4 @@\n+\n+    public void setReturnCompleteDiff(boolean complete){\n+        this.store().setReturnCompleteDiff(complete);\n+    }\n","filename":"test\/src\/main\/java\/org\/openjdk\/skara\/test\/TestPullRequest.java","additions":22,"deletions":14,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -52,0 +52,1 @@\n+    private boolean returnCompleteDiff;\n@@ -65,0 +66,1 @@\n+        this.returnCompleteDiff = true;\n@@ -116,0 +118,4 @@\n+    public boolean returnCompleteDiff(){\n+        return returnCompleteDiff;\n+    }\n+\n@@ -153,0 +159,4 @@\n+\n+    public void setReturnCompleteDiff(boolean returnCompleteDiff) {\n+        this.returnCompleteDiff = returnCompleteDiff;\n+    }\n","filename":"test\/src\/main\/java\/org\/openjdk\/skara\/test\/TestPullRequestStore.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -39,0 +39,1 @@\n+    private final boolean complete;\n@@ -41,0 +42,4 @@\n+        this(from, to, patches, true);\n+    }\n+\n+    public Diff(Hash from, Hash to, List<Patch> patches, boolean complete) {\n@@ -44,0 +49,1 @@\n+        this.complete = complete;\n@@ -58,0 +64,4 @@\n+    public boolean complete() {\n+        return complete;\n+    }\n+\n","filename":"vcs\/src\/main\/java\/org\/openjdk\/skara\/vcs\/Diff.java","additions":11,"deletions":1,"binary":false,"changes":12,"status":"modified"}]}