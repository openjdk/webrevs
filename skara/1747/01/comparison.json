{"files":[{"patch":"@@ -25,0 +25,1 @@\n+import java.io.UnsupportedEncodingException;\n@@ -50,2 +51,1 @@\n-    private final static Pattern quotedPrintableUtf8Pattern = Pattern.compile(\"=([0-9A-Fa-f]{2})=([0-9A-Fa-f]{2})\");\n-    private final static Pattern quotedPrintablePattern = Pattern.compile(\"=([0-9A-Fa-f]{2})\");\n+    private final static Pattern charsetPattern = Pattern.compile(\"charset=\\\"([a-zA-Z0-9-]+)\\\"\");\n@@ -100,11 +100,6 @@\n-                        \/\/ Remove soft line breaks\n-                        bodySectionBody = bodySectionBody\n-                                .replace(\"=\\r\\n\", \"\")\n-                                .replace(\"=\\n\", \"\");\n-                        if (mimeHeaders.get(\"Content-Type\").contains(\"charset=\\\"utf-8\\\"\")) {\n-                            \/\/ Decode UTF-8 characters which are encoded as pairs of =XX=YY.\n-                            bodySectionBody = quotedPrintableUtf8Pattern.matcher(bodySectionBody).replaceAll(m -> {\n-                                        var bytes = new byte[]{(byte) Integer.parseInt(m.group(1), 16),\n-                                                (byte) Integer.parseInt(m.group(2), 16)};\n-                                        return new String(bytes, StandardCharsets.UTF_8);\n-                                    });\n+                        Matcher encodingMatcher = charsetPattern.matcher(mimeHeaders.get(\"Content-Type\"));\n+                        String charsetName;\n+                        if (encodingMatcher.find()) {\n+                            charsetName = encodingMatcher.group(1);\n+                        } else {\n+                            charsetName = \"utf-8\";\n@@ -112,3 +107,1 @@\n-                        \/\/ Replace all possibly remaining single instances of =XX.\n-                        bodySectionBody = quotedPrintablePattern.matcher(bodySectionBody).replaceAll(m ->\n-                                Character.toString((char) Integer.parseInt(m.group(1), 16)));\n+                        bodySectionBody = decodeQuotedPrintable(bodySectionBody, charsetName);\n@@ -128,0 +121,42 @@\n+    \/**\n+     * Decode quoted printable encoding text. Non ASCII characters are encoded\n+     * as series of `=XX` where `XX` is the hex value of a byte. Newlines in\n+     * the encoding are escaped with `=`.\n+     * @param s The string to be decoded.\n+     * @param charsetName The charset name to use when converting bytes to a\n+     *                    back to a String.\n+     * @return A String with the decoded contents.\n+     *\/\n+    private static String decodeQuotedPrintable(String s, String charsetName) {\n+        byte[] in = s.getBytes(StandardCharsets.US_ASCII);\n+        \/\/ The decoded buffer can never be longer than the encoded buffer as\n+        \/\/ every decoding step reduces bytes.\n+        byte[] out = new byte[in.length];\n+        int j = 0;\n+        for (int i = 0; i < in.length; i++) {\n+            if (in[i] == '=') {\n+                i++;\n+                switch (in[i]) {\n+                    case '\\n' : break;\n+                    case '\\r' : {\n+                        if (in[i + 1] == '\\n') {\n+                            i++;\n+                        }\n+                        break;\n+                    }\n+                    default : {\n+                        out[j++] = (byte) Integer.parseInt(\"\" + (char) in[i++] + (char) in[i], 16);\n+                        break;\n+                    }\n+                }\n+            } else {\n+                out[j++] = in[i];\n+            }\n+        }\n+        try {\n+            return new String(out, 0, j, charsetName);\n+        } catch (UnsupportedEncodingException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n","filename":"email\/src\/main\/java\/org\/openjdk\/skara\/email\/Email.java","additions":51,"deletions":16,"binary":false,"changes":67,"status":"modified"},{"patch":"@@ -193,1 +193,1 @@\n-                characters.\n+                characters=E2=80=A6\n@@ -199,1 +199,1 @@\n-        assertEquals(\"A response with weird characters räksmörgås and a line longer than 76 \\ncharacters.\", mail.body());\n+        assertEquals(\"A response with weird characters räksmörgås and a line longer than 76 \\ncharacters…\", mail.body());\n","filename":"email\/src\/test\/java\/org\/openjdk\/skara\/email\/EmailTests.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+import java.util.logging.Level;\n@@ -66,1 +67,2 @@\n-            } catch (RuntimeException ignored) {\n+            } catch (RuntimeException e) {\n+                log.log(Level.WARNING, \"Failed to parse email: \" + e.getMessage(), e);\n","filename":"mailinglist\/src\/main\/java\/org\/openjdk\/skara\/mailinglist\/Mbox.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"}]}