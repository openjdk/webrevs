{"files":[{"patch":"@@ -116,1 +116,1 @@\n-        reviewCoverage = new ReviewCoverage(workItem.bot.useStaleReviews(), workItem.bot.acceptSimpleMerges(), localRepo);\n+        reviewCoverage = new ReviewCoverage(workItem.bot.useStaleReviews(), workItem.bot.acceptSimpleMerges(), localRepo, pr);\n@@ -610,1 +610,1 @@\n-                                           if (!reviewCoverage.covers(review, pr)) {\n+                                           if (!reviewCoverage.covers(review)) {\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckRun.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -74,1 +74,1 @@\n-                                           .filter(review -> reviewCoverage.covers(review, pr))\n+                                           .filter(reviewCoverage::covers)\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/CheckablePullRequest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -202,1 +202,1 @@\n-                    new ReviewCoverage(bot.useStaleReviews(), bot.acceptSimpleMerges(), localRepo));\n+                    new ReviewCoverage(bot.useStaleReviews(), bot.acceptSimpleMerges(), localRepo, pr));\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/IntegrateCommand.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+import java.util.HashMap;\n@@ -27,0 +28,1 @@\n+import java.util.Map;\n@@ -33,0 +35,1 @@\n+import org.openjdk.skara.vcs.Hash;\n@@ -41,0 +44,3 @@\n+    private final PullRequest pr;\n+    private final Map<Review, Boolean> cachedCoverage = new HashMap<>();\n+    private Hash cachedTargetHash;\n@@ -42,1 +48,4 @@\n-    public ReviewCoverage(boolean useStaleReviews, boolean acceptSimpleMerges, Repository repo) {\n+    public ReviewCoverage(boolean useStaleReviews,\n+                          boolean acceptSimpleMerges,\n+                          Repository repo,\n+                          PullRequest pr) {\n@@ -46,0 +55,1 @@\n+        this.pr = pr;\n@@ -48,1 +58,5 @@\n-    public boolean covers(Review review, PullRequest pr) {\n+    public boolean covers(Review review) {\n+        return cachedCoverage.computeIfAbsent(review, this::covers0);\n+    }\n+\n+    private boolean covers0(Review review) {\n@@ -64,2 +78,1 @@\n-            var targetHash = PullRequestUtils.targetHash(repo);\n-            try (var commits = repo.commits(List.of(pr.headHash()), List.of(r.get(), targetHash))) {\n+            try (var commits = repo.commits(List.of(pr.headHash()), List.of(r.get(), targetHash()))) {\n@@ -76,1 +89,1 @@\n-                    if (!repo.isAncestor(secondParent, targetHash)) {\n+                    if (!repo.isAncestor(secondParent, targetHash())) {\n@@ -85,1 +98,1 @@\n-            log.log(Level.FINE, \"Error while looking for simple merges in a PR \" + pr, e);\n+            log.log(Level.FINE, \"Error while looking for simple merges: \" + pr.repository() + \", \" + pr.id(), e);\n@@ -93,0 +106,14 @@\n+\n+    private Hash targetHash() throws IOException {\n+        if (cachedTargetHash == null) {\n+            cachedTargetHash = PullRequestUtils.targetHash(repo);\n+        } else {\n+            \/\/ main assumption for caching targetHash\n+            if (ReviewCoverage.class.desiredAssertionStatus()) {\n+                var latest = PullRequestUtils.targetHash(repo);\n+                assert cachedTargetHash.equals(latest) :\n+                        cachedTargetHash + \" != \" + latest;\n+            }\n+        }\n+        return cachedTargetHash;\n+    }\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/ReviewCoverage.java","additions":33,"deletions":6,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -105,1 +105,1 @@\n-                    new ReviewCoverage(bot.useStaleReviews(), bot.acceptSimpleMerges(), localRepo));\n+                    new ReviewCoverage(bot.useStaleReviews(), bot.acceptSimpleMerges(), localRepo, pr));\n","filename":"bots\/pr\/src\/main\/java\/org\/openjdk\/skara\/bots\/pr\/SponsorCommand.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}