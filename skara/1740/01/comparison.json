{"files":[{"patch":"@@ -607,65 +607,0 @@\n-\n-    @Test\n-    void autoAdjustLabel(TestInfo testInfo) throws IOException {\n-        try (var credentials = new HostCredentials(testInfo);\n-             var tempFolder = new TemporaryDirectory()) {\n-            var author = credentials.getHostedRepository();\n-            var integrator = credentials.getHostedRepository();\n-\n-            var censusBuilder = credentials.getCensusBuilder()\n-                    .addReviewer(integrator.forge().currentUser().id())\n-                    .addCommitter(author.forge().currentUser().id());\n-            var labelConfiguration = LabelConfigurationJson.builder()\n-                    .addMatchers(\"1\", List.of(Pattern.compile(\"cpp$\")))\n-                    .addMatchers(\"2\", List.of(Pattern.compile(\"hpp$\")))\n-                    .addMatchers(\"3\", List.of(Pattern.compile(\"txt$\")))\n-                    .addGroup(\"group1\", List.of(\"1\", \"2\"))\n-                    .addExtra(\"extra\")\n-                    .build();\n-            var prBot = PullRequestBot.newBuilder()\n-                    .repo(integrator)\n-                    .censusRepo(censusBuilder.build())\n-                    .labelConfiguration(labelConfiguration)\n-                    .build();\n-\n-            \/\/ Populate the projects repository\n-            var localRepoFolder = tempFolder.path().resolve(\"localrepo\");\n-            var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType(), Path.of(\"test.hpp\"));\n-            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n-            assertFalse(CheckableRepository.hasBeenEdited(localRepo));\n-            localRepo.push(masterHash, author.authenticatedUrl(), \"master\", true);\n-\n-            \/\/ Make a change with a corresponding PR\n-            var editHash = CheckableRepository.appendAndCommit(localRepo);\n-            localRepo.push(editHash, author.authenticatedUrl(), \"edit\", true);\n-            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"123: This is a pull request\");\n-\n-            \/\/ The bot should have applied one label automatically\n-            TestBotRunner.runPeriodicItems(prBot);\n-            assertEquals(Set.of(\"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n-            assertLastCommentContains(pr, \"The following label will be automatically applied\");\n-            assertLastCommentContains(pr, \"`2`\");\n-\n-            var test1Cpp = localRepo.root().resolve(\"test1.cpp\");\n-            try (var output = Files.newBufferedWriter(test1Cpp)) {\n-                output.append(\"test\");\n-            }\n-            localRepo.add(test1Cpp);\n-            var addHash = localRepo.commit(\"add cpp file\", \"duke\", \"duke@openjdk.org\");\n-            localRepo.push(addHash, author.authenticatedUrl(), \"edit\", true);\n-            TestBotRunner.runPeriodicItems(prBot);\n-            assertEquals(Set.of(\"group1\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n-\n-            \/\/ Simulate force-push.\n-            localRepo.checkout(editHash);\n-            var test1txt = localRepo.root().resolve(\"test1.txt\");\n-            try (var output = Files.newBufferedWriter(test1txt)) {\n-                output.append(\"test\");\n-            }\n-            localRepo.add(test1txt);\n-            var forcePushHash = localRepo.commit(\"add txt file\", \"duke\", \"duke@openjdk.org\");\n-            localRepo.push(forcePushHash, author.authenticatedUrl(), \"edit\", true);\n-            TestBotRunner.runPeriodicItems(prBot);\n-            assertEquals(Set.of(\"group1\", \"rfr\", \"3\"), new HashSet<>(pr.store().labelNames()));\n-        }\n-    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/LabelTests.java","additions":0,"deletions":65,"binary":false,"changes":65,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import java.nio.file.Path;\n@@ -318,0 +319,138 @@\n+\n+    @Test\n+    void autoAdjustLabel(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var integrator = credentials.getHostedRepository();\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                    .addReviewer(integrator.forge().currentUser().id())\n+                    .addCommitter(author.forge().currentUser().id());\n+            var labelConfiguration = LabelConfigurationJson.builder()\n+                    .addMatchers(\"1\", List.of(Pattern.compile(\"cpp$\")))\n+                    .addMatchers(\"2\", List.of(Pattern.compile(\"hpp$\")))\n+                    .addMatchers(\"3\", List.of(Pattern.compile(\"txt$\")))\n+                    .addGroup(\"group1\", List.of(\"1\", \"2\"))\n+                    .addExtra(\"extra\")\n+                    .build();\n+            var prBot = PullRequestBot.newBuilder()\n+                    .repo(integrator)\n+                    .censusRepo(censusBuilder.build())\n+                    .labelConfiguration(labelConfiguration)\n+                    .build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepoFolder = tempFolder.path().resolve(\"localrepo\");\n+            var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType(), Path.of(\"test.hpp\"));\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            assertFalse(CheckableRepository.hasBeenEdited(localRepo));\n+            localRepo.push(masterHash, author.authenticatedUrl(), \"master\", true);\n+\n+            \/\/ Make a change with a corresponding PR\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, author.authenticatedUrl(), \"edit\", true);\n+            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"123: This is a pull request\");\n+\n+            \/\/ The bot should have applied one label automatically\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(Set.of(\"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+            assertLastCommentContains(pr, \"The following label will be automatically applied\");\n+            assertLastCommentContains(pr, \"`2`\");\n+\n+            var test1Cpp = localRepo.root().resolve(\"test1.cpp\");\n+            try (var output = Files.newBufferedWriter(test1Cpp)) {\n+                output.append(\"test\");\n+            }\n+            localRepo.add(test1Cpp);\n+            var addHash = localRepo.commit(\"add cpp file\", \"duke\", \"duke@openjdk.org\");\n+            localRepo.push(addHash, author.authenticatedUrl(), \"edit\", true);\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(Set.of(\"group1\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+\n+            \/\/ Simulate force-push.\n+            localRepo.checkout(editHash);\n+            var test1txt = localRepo.root().resolve(\"test1.txt\");\n+            try (var output = Files.newBufferedWriter(test1txt)) {\n+                output.append(\"test\");\n+            }\n+            localRepo.add(test1txt);\n+            var forcePushHash = localRepo.commit(\"add txt file\", \"duke\", \"duke@openjdk.org\");\n+            localRepo.push(forcePushHash, author.authenticatedUrl(), \"edit\", true);\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(Set.of(\"group1\", \"rfr\", \"3\"), new HashSet<>(pr.store().labelNames()));\n+        }\n+    }\n+\n+    @Test\n+    void autoAdjustLabelWithMerge(TestInfo testInfo) throws IOException {\n+        try (var credentials = new HostCredentials(testInfo);\n+             var tempFolder = new TemporaryDirectory()) {\n+            var author = credentials.getHostedRepository();\n+            var integrator = credentials.getHostedRepository();\n+\n+            var censusBuilder = credentials.getCensusBuilder()\n+                    .addReviewer(integrator.forge().currentUser().id())\n+                    .addCommitter(author.forge().currentUser().id());\n+            var labelConfiguration = LabelConfigurationJson.builder()\n+                    .addMatchers(\"1\", List.of(Pattern.compile(\"cpp$\")))\n+                    .addMatchers(\"2\", List.of(Pattern.compile(\"hpp$\")))\n+                    .addMatchers(\"3\", List.of(Pattern.compile(\"txt$\")))\n+                    .addGroup(\"group1\", List.of(\"1\", \"2\"))\n+                    .addExtra(\"extra\")\n+                    .build();\n+            var prBot = PullRequestBot.newBuilder()\n+                    .repo(integrator)\n+                    .censusRepo(censusBuilder.build())\n+                    .labelConfiguration(labelConfiguration)\n+                    .build();\n+\n+            \/\/ Populate the projects repository\n+            var localRepoFolder = tempFolder.path().resolve(\"localrepo\");\n+            var localRepo = CheckableRepository.init(localRepoFolder, author.repositoryType(), Path.of(\"test.hpp\"));\n+            var masterHash = localRepo.resolve(\"master\").orElseThrow();\n+            assertFalse(CheckableRepository.hasBeenEdited(localRepo));\n+            localRepo.push(masterHash, author.authenticatedUrl(), \"master\", true);\n+\n+            \/\/ Make a change with a corresponding PR\n+            var editHash = CheckableRepository.appendAndCommit(localRepo);\n+            localRepo.push(editHash, author.authenticatedUrl(), \"edit\", true);\n+            var pr = credentials.createPullRequest(author, \"master\", \"edit\", \"123: This is a pull request\");\n+\n+            \/\/ The bot should have applied one label automatically\n+            TestBotRunner.runPeriodicItems(prBot);\n+            assertEquals(Set.of(\"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+            assertLastCommentContains(pr, \"The following label will be automatically applied\");\n+            assertLastCommentContains(pr, \"`2`\");\n+\n+            \/\/ Update the target branch\n+            localRepo.checkout(masterHash);\n+            var txtFile = localRepo.root().resolve(\"unrelated.txt\");\n+            Files.writeString(txtFile, \"Hello\");\n+            localRepo.add(txtFile);\n+            var updatedMasterHash = localRepo.commit(\"add txt file\", \"duke\", \"duke@openjdk.org\");\n+            localRepo.push(updatedMasterHash, author.authenticatedUrl(), \"master\", true);\n+\n+            TestBotRunner.runPeriodicItems(prBot);\n+            \/\/ Change to master branch shouldn't change labels\n+            assertEquals(Set.of(\"2\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+\n+            \/\/ Merge master into edit\n+            localRepo.checkout(editHash);\n+            localRepo.merge(updatedMasterHash);\n+            var mergeHash = localRepo.commit(\"merge master\", \"duke\", \"duke@openjdk.org\");\n+            localRepo.push(mergeHash, author.authenticatedUrl(), \"edit\", true);\n+            \/\/ Add cpp file\n+            localRepo.checkout(mergeHash);\n+            var cppFile = localRepo.root().resolve(\"test.cpp\");\n+            Files.writeString(cppFile, \"Hello cpp\");\n+            localRepo.add(cppFile);\n+            var updatedEditHash = localRepo.commit(\"add cpp file\", \"duke\", \"duke@openjdk.org\");\n+            localRepo.push(updatedEditHash, author.authenticatedUrl(), \"edit\", true);\n+\n+            TestBotRunner.runPeriodicItems(prBot);\n+            \/\/ The commit brought in by merge shouldn't affect labels, so \"3\" shouldn't be added\n+            \/\/ After adding cpp file, \"1\" should be added and the labels should be upgraded to \"group1\"\n+            assertEquals(Set.of(\"group1\", \"rfr\"), new HashSet<>(pr.store().labelNames()));\n+        }\n+    }\n","filename":"bots\/pr\/src\/test\/java\/org\/openjdk\/skara\/bots\/pr\/LabelerTests.java","additions":139,"deletions":0,"binary":false,"changes":139,"status":"modified"},{"patch":"@@ -212,3 +212,18 @@\n-        var ret = new HashSet<Path>();\n-        var changes = localRepo.diff(from, to);\n-        for (var patch : changes.patches()) {\n+        Set<Path> changedFiles = new HashSet<>();\n+\n+        Set<Path> mergeBaseToFromChangedFiles = getChangedFilesSinceMergeBase(localRepo, from);\n+        Set<Path> mergeBaseToToChangedFiles = getChangedFilesSinceMergeBase(localRepo, to);\n+\n+        for (Path file : mergeBaseToToChangedFiles) {\n+            if (!mergeBaseToFromChangedFiles.contains(file)) {\n+                changedFiles.add(file);\n+            }\n+        }\n+        return changedFiles;\n+    }\n+\n+    private static Set<Path> getChangedFilesSinceMergeBase(Repository localRepo, Hash commit) throws IOException {\n+        Set<Path> changedFiles = new HashSet<>();\n+        Hash mergeBase = localRepo.mergeBase(targetHash(localRepo), commit);\n+        var diff = localRepo.diff(mergeBase, commit);\n+        for (var patch : diff.patches()) {\n@@ -216,1 +231,1 @@\n-                patch.source().path().ifPresent(ret::add);\n+                patch.source().path().ifPresent(changedFiles::add);\n@@ -219,1 +234,1 @@\n-                patch.target().path().ifPresent(ret::add);\n+                patch.target().path().ifPresent(changedFiles::add);\n@@ -222,1 +237,1 @@\n-        return ret;\n+        return changedFiles;\n","filename":"forge\/src\/main\/java\/org\/openjdk\/skara\/forge\/PullRequestUtils.java","additions":21,"deletions":6,"binary":false,"changes":27,"status":"modified"}]}