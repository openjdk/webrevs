{"files":[{"patch":"@@ -86,1 +86,1 @@\n-                .build_builtin_byteCopy()\n+                .unionBfloat16()\n","filename":"hat\/backends\/ffi\/opencl\/src\/main\/java\/hat\/backend\/ffi\/OpenCLHATKernelBuilder.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -203,0 +203,4 @@\n+    public final T bfloat16Type(String identifier) {\n+        return suffix_t(\"BFLOAT16_UNION\").space().identifier(identifier);\n+    }\n+\n@@ -223,0 +227,12 @@\n+\n+    public final T typedefUnion(String name, Consumer<T> consumer) {\n+        return typedefKeyword()\n+                .space()\n+                .union()\n+                .space()\n+                .suffix_s(name)\n+                .braceNlIndented(consumer)\n+                .suffix_t(name)\n+                .semicolonNl();\n+    }\n+\n@@ -227,1 +243,0 @@\n-\n@@ -229,1 +244,8 @@\n-        return typedefStruct(structName,_-> typeName(type).space().identifier(\"value\").semicolonNl());\n+        return typedefStruct(structName,_-> typeName(type).space().identifier(\"value\").semicolon());\n+    }\n+\n+    public final T unionBfloat16() {\n+        return typedefUnion(\"BFLOAT16_UNION\", _ -> {\n+            typeName(\"float\").space().identifier(\"f\").semicolon().nl();\n+            u16Type(\"s\").sizeArray(2).semicolon();\n+        });\n@@ -232,1 +254,1 @@\n-    public final T funcDef(Consumer<T> type,Consumer<T> name, Consumer<T> args, Consumer<T> body){\n+    public final T funcDef(Consumer<T> type, Consumer<T> name, Consumer<T> args, Consumer<T> body){\n@@ -240,0 +262,1 @@\n+\n@@ -250,0 +273,1 @@\n+\n@@ -254,1 +278,1 @@\n-    public final T call(Consumer<T> name,Consumer<T> ...args){\n+    public final T call(Consumer<T> name,Consumer<T> ...args) {\n@@ -258,1 +282,2 @@\n-    public final T call(String name,Consumer<T> ...args){\n+\n+    public final T call(String name,Consumer<T> ...args) {\n@@ -262,1 +287,1 @@\n-    public final T forLoop(Consumer<T> init, Consumer<T> test, Consumer<T>mutate, Consumer<T>body){\n+    public final T forLoop(Consumer<T> init, Consumer<T> test, Consumer<T>mutate, Consumer<T>body) {\n@@ -274,1 +299,0 @@\n-\n@@ -278,0 +302,1 @@\n+\n@@ -281,0 +306,1 @@\n+\n@@ -284,0 +310,1 @@\n+\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/C99HATCodeBuilder.java","additions":34,"deletions":7,"binary":false,"changes":41,"status":"modified"},{"patch":"@@ -523,35 +523,0 @@\n-\n-    \/**\n-     * <code>\n-     *  void byteCopy(void *dest, const void* src, size_t size) {\n-     *      unsigned char *c = (unsigned char*)dest;\n-     *      unsigned char *s = (unsigned char*)src;\n-     *      for (int i = 0; i < size; i++) {\n-     *          *c++ = *s++;\n-     *      }\n-     *  }\n-     * <\/code>\n-     * @return\n-     *\/\n-\n-    public final T build_builtin_byteCopy() {\n-        return funcDef(\n-                _->voidType(),\n-                _->identifier(\"byteCopy\"),\n-                _->args(\n-                        _->voidPtrType(\"dest\"),\n-                        _->voidPtrType(\"src\"),\n-                        _->sizeType(\"size\")\n-                ),\n-                _ ->\n-                    assign(_->u08PtrType(\"c\"), _->cast(_ -> u08PtrType()).identifier(\"dest\")).semicolonNl()\n-                   .assign(_->u08PtrType(\"s\"), _->cast(_ -> u08PtrType()).identifier(\"src\")).semicolonNl()\n-                   .forLoop(\n-                           _->assign(_-> s32Type(\"i\"), _->intConstZero()),\n-                           _->identifier(\"i\").lt().identifier(\"size\"),\n-                           _->identifier(\"i\").plusplus(),\n-                           _->dereference(\"c\").plusplus().equals().dereference(\"s\").plusplus().semicolon()\n-                   )\n-                );\n-    }\n-\n@@ -561,4 +526,4 @@\n-     *      uint bitsRecovered = bf16 << 16;\n-     *      float r = bitsRecovered;\n-     *      byteCopy(&r, &bitsRecovered, sizeof(r));\n-     *      return r;\n+     *      b16_t b;\n+     *      b.s[0] = 0;\n+     *      b.s[1] = s;\n+     *      return b.f;\n@@ -572,8 +537,8 @@\n-        return funcDef(_->f32Type(),\n-                _->builtin_bfloat16ToFloat(),\n-                _-> u16Type(parameterName),\n-                 _ -> assign(_->u32Type(\"bits\"), _->identifier(parameterName).leftShift(16)).semicolonNl()\n-                      .f32Type(\"r\").semicolonNl()\n-                      .call(\"byteCopy\",_->addressOf(\"r\"),_->addressOf(\"bits\"),_->sizeof(\"r\")).semicolonNl()\n-                      .returnKeyword(_->identifier(\"r\"))\n-                );\n+        String identifier = \"b\";\n+        return funcDef(_ -> f32Type(),\n+                       _ -> builtin_bfloat16ToFloat(),\n+                       _ -> u16Type(parameterName),\n+                       _ -> bfloat16Type(identifier).semicolonNl()\n+                               .identifier(identifier).dot().identifier(\"s\").sbrace( _ -> intConstZero()).equals().intConstZero().semicolonNl()\n+                               .identifier(identifier).dot().identifier(\"s\").sbrace( _ -> intConstOne()).equals().constant(parameterName).semicolonNl()\n+                               .returnKeyword(_-> identifier(\"b\").dot().identifier(\"f\")));\n@@ -585,4 +550,2 @@\n-     *      uint bits;\n-     *      byteCopy(&bits, &f, sizeof(bits));\n-     *      short bf16 = bits >> 16;\n-     *      return bf16;\n+     *      b16_t b1 = {f};\n+     *      return b1.s[1];\n@@ -596,8 +559,6 @@\n-                _-> s16Type(),\n-                _->builtin_float2bfloat16(),\n-                _->f32Type(parameterName),\n-                _->\n-                   u32Type(\"bits\").semicolonNl()\n-                   .call(\"byteCopy\", _->addressOf(\"bits\"), _->addressOf(parameterName), _->sizeof(\"bits\")).semicolonNl()\n-                   .returnKeyword(_->identifier(\"bits\").rightShift(16))\n-                );\n+                _ -> u16Type(),\n+                _ -> builtin_float2bfloat16(),\n+                _ -> f32Type(parameterName),\n+                _ -> assign(_ -> bfloat16Type(\"b\"),\n+                        _ ->  brace( _ -> identifier(parameterName)).semicolonNl()\n+                                .returnKeyword(_ ->identifier(\"b\").dot().identifier(\"s\").sbrace(_ -> intConstOne()))));\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/C99HATKernelBuilder.java","additions":20,"deletions":59,"binary":false,"changes":79,"status":"modified"},{"patch":"@@ -37,1 +37,1 @@\n-public abstract class CodeBuilder<T extends CodeBuilder<T>> extends TextBuilder<T>  implements CodeRenderer<T> {\n+public abstract class CodeBuilder<T extends CodeBuilder<T>> extends TextBuilder<T> implements CodeRenderer<T> {\n@@ -42,0 +42,1 @@\n+\n@@ -49,0 +50,1 @@\n+\n@@ -52,0 +54,1 @@\n+\n@@ -63,0 +66,1 @@\n+\n@@ -66,0 +70,1 @@\n+\n@@ -69,0 +74,1 @@\n+\n@@ -76,0 +82,1 @@\n+\n@@ -98,2 +105,2 @@\n-    public T constant(String text ){\n-       return emitText(text);\n+    public T constant(String text) {\n+        return emitText(text);\n@@ -119,0 +126,1 @@\n+\n@@ -126,0 +134,1 @@\n+\n@@ -174,0 +183,1 @@\n+\n@@ -203,0 +213,1 @@\n+\n@@ -206,0 +217,1 @@\n+\n@@ -209,0 +221,1 @@\n+\n@@ -252,0 +265,1 @@\n+\n@@ -291,0 +305,1 @@\n+\n@@ -303,0 +318,1 @@\n+\n@@ -314,0 +330,1 @@\n+\n@@ -333,0 +350,1 @@\n+\n@@ -336,0 +354,1 @@\n+\n@@ -361,0 +380,1 @@\n+\n@@ -364,0 +384,1 @@\n+\n@@ -438,1 +459,0 @@\n-\n@@ -464,3 +484,3 @@\n-        var first  =StreamMutable.of(true);\n-        iterable.forEach(  t -> {\n-            if (first.get()){\n+        var first = StreamMutable.of(true);\n+        iterable.forEach(t -> {\n+            if (first.get()) {\n@@ -468,1 +488,1 @@\n-            }else{\n+            } else {\n@@ -475,2 +495,3 @@\n-    public <I> T commaSpaceSeparated(Iterable<I> iterable,  Consumer<I> consumer) {\n-        return separated(iterable,_->commaSpace(),consumer);\n+\n+    public <I> T commaSpaceSeparated(Iterable<I> iterable, Consumer<I> consumer) {\n+        return separated(iterable, _ -> commaSpace(), consumer);\n@@ -478,3 +499,4 @@\n-    public T commaSpaceSeparated(Consumer<T> ...consumers){\n-        for (int i=0;i<consumers.length;i++){\n-            if (i>0){\n+\n+    public T commaSpaceSeparated(Consumer<T>... consumers) {\n+        for (int i = 0; i < consumers.length; i++) {\n+            if (i > 0) {\n@@ -487,2 +509,3 @@\n-    public T args(Consumer<T> ...consumers){\n-       return  commaSpaceSeparated(consumers);\n+\n+    public T args(Consumer<T>... consumers) {\n+        return commaSpaceSeparated(consumers);\n@@ -490,2 +513,3 @@\n-    public <I> T commaSeparated(Iterable<I> iterable,  Consumer<I> consumer) {\n-        return separated(iterable,_->comma(),consumer);\n+\n+    public <I> T commaSeparated(Iterable<I> iterable, Consumer<I> consumer) {\n+        return separated(iterable, _ -> comma(), consumer);\n@@ -493,2 +517,3 @@\n-    public <I> T commaNlSeparated(Iterable<I> iterable,  Consumer<I> consumer) {\n-        return separated(iterable,_->comma().nl(),consumer);\n+\n+    public <I> T commaNlSeparated(Iterable<I> iterable, Consumer<I> consumer) {\n+        return separated(iterable, _ -> comma().nl(), consumer);\n@@ -496,2 +521,3 @@\n-    public <I> T barSeparated(Iterable<I> iterable,  Consumer<I> consumer) {\n-        return separated(iterable,_->bar(),consumer);\n+\n+    public <I> T barSeparated(Iterable<I> iterable, Consumer<I> consumer) {\n+        return separated(iterable, _ -> bar(), consumer);\n@@ -499,2 +525,3 @@\n-    public <I> T semicolonNlSeparated(Iterable<I> iterable,  Consumer<I> consumer) {\n-        return separated(iterable,_->semicolonNl(),consumer).semicolon();\n+\n+    public <I> T semicolonNlSeparated(Iterable<I> iterable, Consumer<I> consumer) {\n+        return separated(iterable, _ -> semicolonNl(), consumer).semicolon();\n@@ -502,2 +529,3 @@\n-    public <I> T nlSeparated(Iterable<I> iterable,  Consumer<I> consumer) {\n-        return separated(iterable,_->nl(),consumer);\n+\n+    public <I> T nlSeparated(Iterable<I> iterable, Consumer<I> consumer) {\n+        return separated(iterable, _ -> nl(), consumer);\n@@ -505,0 +533,1 @@\n+\n@@ -506,3 +535,3 @@\n-        var first  =StreamMutable.of(true);\n-        stream.forEach(  t -> {\n-            if (first.get()){\n+        var first = StreamMutable.of(true);\n+        stream.forEach(t -> {\n+            if (first.get()) {\n@@ -510,1 +539,1 @@\n-            }else{\n+            } else {\n@@ -517,2 +546,3 @@\n-    public <I> T commaSpaceSeparated(Stream<I> stream,  Consumer<I> consumer) {\n-        return separated(stream,_->commaSpace(),consumer);\n+\n+    public <I> T commaSpaceSeparated(Stream<I> stream, Consumer<I> consumer) {\n+        return separated(stream, _ -> commaSpace(), consumer);\n@@ -520,2 +550,3 @@\n-    public <I> T commaSeparated(Stream<I> stream,  Consumer<I> consumer) {\n-        return separated(stream,_->comma(),consumer);\n+\n+    public <I> T commaSeparated(Stream<I> stream, Consumer<I> consumer) {\n+        return separated(stream, _ -> comma(), consumer);\n@@ -523,2 +554,3 @@\n-    public <I> T nlSeparated(Stream<I> stream,  Consumer<I> consumer) {\n-        return separated(stream,_->nl(),consumer);\n+\n+    public <I> T nlSeparated(Stream<I> stream, Consumer<I> consumer) {\n+        return separated(stream, _ -> nl(), consumer);\n@@ -526,0 +558,1 @@\n+\n@@ -529,0 +562,1 @@\n+\n@@ -536,0 +570,1 @@\n+\n@@ -539,0 +574,1 @@\n+\n@@ -550,0 +586,1 @@\n+\n@@ -557,0 +594,1 @@\n+\n@@ -573,1 +611,0 @@\n-\n@@ -577,0 +614,1 @@\n+\n@@ -582,1 +620,0 @@\n-\n@@ -612,0 +649,1 @@\n+\n@@ -621,0 +659,1 @@\n+\n@@ -623,1 +662,1 @@\n-      return super.nl();\n+        return super.nl();\n@@ -639,2 +678,1 @@\n-\n-    public  String toCamelExceptFirst(String s) {\n+    public String toCamelExceptFirst(String s) {\n@@ -651,0 +689,3 @@\n+    public final T sizeArray(int size) {\n+        return sbrace( _ -> constant(Integer.toString(size)));\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/CodeBuilder.java","additions":81,"deletions":40,"binary":false,"changes":121,"status":"modified"}]}