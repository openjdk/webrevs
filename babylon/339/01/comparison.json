{"files":[{"patch":"@@ -4,0 +4,3 @@\n+import java.lang.foreign.ValueLayout;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.reflect.UndeclaredThrowableException;\n@@ -9,0 +12,1 @@\n+import java.util.stream.LongStream;\n@@ -12,0 +16,1 @@\n+import jdk.incubator.code.type.JavaType;\n@@ -262,0 +267,1 @@\n+    static final JavaType TENSOR_CLASS = JavaType.type(oracle.code.onnx.Tensor.class);\n@@ -267,1 +273,1 @@\n-    static byte[] build(Block block) {\n+    static byte[] build(MethodHandles.Lookup lookup, Block block) {\n@@ -279,0 +285,30 @@\n+                block.ops().stream().<TensorProto>mapMulti((op, opNodes) -> {\n+                    \/\/ @@@ initializers\n+                    if (op instanceof CoreOp.InvokeOp co && co.invokeKind() == CoreOp.InvokeOp.InvokeKind.STATIC\n+                                                         && co.invokeDescriptor().type().parameterTypes().isEmpty()\n+                                                         && co.invokeDescriptor().type().returnType() instanceof JavaType jt\n+                                                         && jt.erasure().equals(TENSOR_CLASS)) {\n+                        try {\n+                            opNodes.accept(tensorProto(\n+                                    indexer.getName(op.result()),\n+                                    (oracle.code.onnx.Tensor)co.invokeDescriptor()\n+                                            .resolveToHandle(lookup, CoreOp.InvokeOp.InvokeKind.STATIC)\n+                                            .invokeExact()));\n+                        } catch (RuntimeException | Error e) {\n+                            throw e;\n+                        } catch (Throwable e) {\n+                            throw new UndeclaredThrowableException(e);\n+                        }\n+                    } else if (op instanceof CoreOp.FieldAccessOp.FieldLoadOp co && co.resultType() instanceof JavaType jt\n+                                                                                 && jt.erasure().equals(TENSOR_CLASS)) {\n+                        try {\n+                            opNodes.accept(tensorProto(\n+                                    indexer.getName(op.result()),\n+                                    (oracle.code.onnx.Tensor)co.fieldDescriptor()\n+                                            .resolveToHandle(lookup)\n+                                            .get()));\n+                        } catch (ReflectiveOperationException e) {\n+                            throw new UndeclaredThrowableException(e);\n+                        }\n+                    }\n+                }).toList(),\n@@ -288,1 +324,1 @@\n-                        case CoreOp.ReturnOp _ -> { \/\/ skip\n+                        case CoreOp.ReturnOp _, CoreOp.InvokeOp _, CoreOp.FieldAccessOp.FieldLoadOp _ -> { \/\/ skip\n@@ -299,1 +335,1 @@\n-    static byte[] build(List<ValueInfoProto> inputs, List<NodeProto> ops, List<String> outputNames) {\n+    static byte[] build(List<TensorProto> initializers, List<ValueInfoProto> inputs, List<NodeProto> ops, List<String> outputNames) {\n@@ -302,1 +338,1 @@\n-                .graph(graph(inputs, ops, outputNames))\n+                .graph(graph(initializers, inputs, ops, outputNames))\n@@ -307,1 +343,1 @@\n-    static GraphProto graph(List<ValueInfoProto> inputs, List<NodeProto> ops, List<String> outputNames) {\n+    static GraphProto graph(List<TensorProto> initializers, List<ValueInfoProto> inputs, List<NodeProto> ops, List<String> outputNames) {\n@@ -309,0 +345,1 @@\n+                .forEach(initializers, (g, i) -> g.initializer(i))\n@@ -339,0 +376,8 @@\n+    static TensorProto tensorProto(String name, oracle.code.onnx.Tensor t) {\n+        return new TensorProto()\n+                .name(name)\n+                .data_type(t.elementType().id)\n+                .forEach(LongStream.of(t.shape()).boxed().toList(), (tp, d) -> tp.dims(d))\n+                .raw_data(t.data().toArray(ValueLayout.JAVA_BYTE));\n+    }\n+\n","filename":"cr-examples\/onnx\/src\/main\/java\/oracle\/code\/onnx\/OnnxProtoBuilder.java","additions":50,"deletions":5,"binary":false,"changes":55,"status":"modified"},{"patch":"@@ -130,1 +130,1 @@\n-                    OnnxProtoBuilder.build(onnxFunc.body().entryBlock())), operandsMapping);\n+                    OnnxProtoBuilder.build(l, onnxFunc.body().entryBlock())), operandsMapping);\n@@ -274,0 +274,1 @@\n+                List.of(),\n@@ -285,2 +286,2 @@\n-    public List<Tensor> run(Arena arena, Block block, List<Tensor> inputValues) {\n-        var protoModel = OnnxProtoBuilder.build(block);\n+    public List<Tensor> run(Arena arena, MethodHandles.Lookup lookup, Block block, List<Tensor> inputValues) {\n+        var protoModel = OnnxProtoBuilder.build(lookup, block);\n","filename":"cr-examples\/onnx\/src\/main\/java\/oracle\/code\/onnx\/OnnxRuntime.java","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -40,0 +40,1 @@\n+import oracle.code.onnx.Tensor;\n@@ -44,0 +45,1 @@\n+    static final JavaType TENSOR_CLASS = JavaType.type(Tensor.class);\n@@ -300,1 +302,1 @@\n-            assert o.operands().subList(0, inputs.size()).stream().noneMatch(oc::isValueDefined);\n+\/\/            assert o.operands().subList(0, inputs.size()).stream().noneMatch(oc::isValueDefined);\n@@ -324,0 +326,12 @@\n+            unevaluatedOperations.add(o);\n+            return null;\n+        } else if (o instanceof CoreOp.InvokeOp co && co.invokeKind() == CoreOp.InvokeOp.InvokeKind.STATIC\n+                                                   && co.invokeDescriptor().type().parameterTypes().isEmpty()\n+                                                   && co.invokeDescriptor().type().returnType() instanceof JavaType jt\n+                                                   && jt.erasure().equals(TENSOR_CLASS)) {\n+            \/\/ @@@ static no-arg method calls returning Tensor are passed as initializers\n+            unevaluatedOperations.add(o);\n+            return null;\n+        } else if (o instanceof CoreOp.FieldAccessOp.FieldLoadOp co && co.fieldDescriptor().type() instanceof JavaType jt\n+                                                                    && jt.erasure().equals(TENSOR_CLASS)) {\n+            \/\/ @@@ Tensor fields are passed as initializers\n","filename":"cr-examples\/onnx\/src\/main\/java\/oracle\/code\/onnx\/compiler\/OnnxPartialEvaluator.java","additions":15,"deletions":1,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -20,0 +20,1 @@\n+                    List.of(),\n@@ -24,4 +25,5 @@\n-             var addOp = ort.createSession(arena, build(\n-                     List.of(tensorInfo(\"a\", FLOAT.id), tensorInfo(\"b\", FLOAT.id)),\n-                     List.of(node(\"Add\", List.of(\"a\", \"b\"), List.of(\"y\"), Map.of())),\n-                     List.of(\"y\")));\n+            var addOp = ort.createSession(arena, build(\n+                    List.of(),\n+                    List.of(tensorInfo(\"a\", FLOAT.id), tensorInfo(\"b\", FLOAT.id)),\n+                    List.of(node(\"Add\", List.of(\"a\", \"b\"), List.of(\"y\"), Map.of())),\n+                    List.of(\"y\")));\n@@ -64,0 +66,1 @@\n+                    List.of(),\n@@ -67,0 +70,1 @@\n+                                    List.of(),\n@@ -71,0 +75,1 @@\n+                                    List.of(),\n@@ -88,0 +93,1 @@\n+                    List.of(),\n@@ -91,0 +97,1 @@\n+                                    List.of(),\n","filename":"cr-examples\/onnx\/src\/test\/java\/oracle\/code\/onnx\/RuntimeTest.java","additions":11,"deletions":4,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -119,0 +119,19 @@\n+    static Tensor<Float> constantOf42f() {\n+        return Tensor.ofScalar(42f);\n+    }\n+\n+    @CodeReflection\n+    public static Tensor<Float> identityOfInitializer() {\n+        return OnnxOperators.Identity(constantOf42f());\n+    }\n+\n+    @Test\n+    public void testIdentityOfInitializer() {\n+        assertEquals(\n+                constantOf42f(),\n+                identityOfInitializer());\n+        assertEquals(\n+                constantOf42f(),\n+                OnnxRuntime.execute(MethodHandles.lookup(), () -> identityOfInitializer()));\n+    }\n+\n","filename":"cr-examples\/onnx\/src\/test\/java\/oracle\/code\/onnx\/SimpleTest.java","additions":19,"deletions":0,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -45,1 +45,1 @@\n-    public static float[] loadConstant(String resource) {\n+    private static Tensor<Float> initialize(String resource, long... shape) {\n@@ -47,2 +47,2 @@\n-            return MemorySegment.ofArray(in.readAllBytes())\n-                    .toArray(ValueLayout.JAVA_FLOAT_UNALIGNED);\n+            return Tensor.ofShape(shape, MemorySegment.ofArray(in.readAllBytes())\n+                    .toArray(ValueLayout.JAVA_FLOAT_UNALIGNED));\n@@ -54,0 +54,12 @@\n+    static final Tensor<Float>\n+            conv1Weights = initialize(\"conv1-weight-float-le\", 6, 1, 5, 5),\n+            conv1Biases = initialize(\"conv1-bias-float-le\", 6),\n+            conv2Weights = initialize(\"conv2-weight-float-le\", 16, 6, 5, 5),\n+            conv2Biases = initialize(\"conv2-bias-float-le\", 16),\n+            fc1Weights = initialize(\"fc1-weight-float-le\", 120, 256),\n+            fc1Biases = initialize(\"fc1-bias-float-le\", 120),\n+            fc2Weights = initialize(\"fc2-weight-float-le\", 84, 120),\n+            fc2Biases = initialize(\"fc2-bias-float-le\", 84),\n+            fc3Weights = initialize(\"fc3-weight-float-le\", 10, 84),\n+            fc3Biases = initialize(\"fc3-bias-float-le\", 10);\n+\n@@ -60,2 +72,0 @@\n-        var conv1Weights = Reshape(Constant(loadConstant(\"conv1-weight-float-le\")), Constant(new long[]{6, 1, 5, 5}), empty());\n-        var conv1Biases = Reshape(Constant(loadConstant(\"conv1-bias-float-le\")), Constant(new long[]{6}), empty());\n@@ -72,2 +82,0 @@\n-        var conv2Weights = Reshape(Constant(loadConstant(\"conv2-weight-float-le\")), Constant(new long[]{16, 6, 5, 5}), empty());\n-        var conv2Biases = Reshape(Constant(loadConstant(\"conv2-bias-float-le\")), Constant(new long[]{16}), empty());\n@@ -87,2 +95,0 @@\n-        var fc1Weights = Reshape(Constant(loadConstant(\"fc1-weight-float-le\")), Constant(new long[]{120, 256}), empty());\n-        var fc1Biases = Reshape(Constant(loadConstant(\"fc1-bias-float-le\")), Constant(new long[]{120}), empty());\n@@ -93,2 +99,0 @@\n-        var fc2Weights = Reshape(Constant(loadConstant(\"fc2-weight-float-le\")), Constant(new long[]{84, 120}), empty());\n-        var fc2Biases = Reshape(Constant(loadConstant(\"fc2-bias-float-le\")), Constant(new long[]{84}), empty());\n@@ -99,2 +103,0 @@\n-        var fc3Weights = Reshape(Constant(loadConstant(\"fc3-weight-float-le\")), Constant(new long[]{10, 84}), empty());\n-        var fc3Biases = Reshape(Constant(loadConstant(\"fc3-bias-float-le\")), Constant(new long[]{10}), empty());\n","filename":"cr-examples\/onnx\/src\/test\/java\/oracle\/code\/onnx\/mnist\/MNISTDemo.java","additions":15,"deletions":13,"binary":false,"changes":28,"status":"modified"}]}