{"files":[{"patch":"@@ -49,2 +49,0 @@\n-\n-    default BF16Impl[] arrayview() {return null;}\n","filename":"hat\/core\/src\/main\/java\/hat\/buffer\/BF16Array.java","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -571,2 +571,2 @@\n-    public final T ptrAccess( HATPtrOp hatPtrOp) {\n-        identifier(hatPtrName(hatPtrOp));\n+    private T ptrAccess(ScopedCodeBuilderContext builderContext, HATPtrOp hatPtrOp) {\n+        identifier(hatPtrOp.name());\n@@ -590,2 +590,2 @@\n-                        paren(_ -> recurse( ((Op.Result) hatPtrOp.operands().get(2)).op()));\n-                        asterisk().identifier(hatPtrName(hatPtrOp));\n+                        paren(_ -> recurse(builderContext, ((Op.Result) hatPtrOp.operands().get(2)).op()));\n+                        asterisk().identifier(hatPtrOp.name());\n@@ -603,10 +603,0 @@\n-    public final String hatPtrName(HATPtrOp hatPtrOp) {\n-        Op op = ((Op.Result) ((Op.Result) (hatPtrOp.operands().getFirst())).op().operands().getFirst()).op();\n-        return switch (op) {\n-            case CoreOp.VarOp varOp -> varOp.varName();\n-            case HATMemoryVarOp.HATLocalVarOp hatLocalVarOp -> hatLocalVarOp.varName();\n-            case HATMemoryVarOp.HATPrivateVarOp hatPrivateVarOp -> hatPrivateVarOp.varName();\n-            case null, default -> \"\";\n-        };\n-    }\n-\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/C99HATKernelBuilder.java","additions":4,"deletions":14,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -41,0 +41,1 @@\n+    private final String name;\n@@ -53,3 +54,2 @@\n-                    retValue = retValue.isEmpty()\n-                            ?retValue\n-                            :retValue.subList(0, retValue.size() - 1); \/\/ is this intended to drop the last one?\n+                    \/\/ remove the \"array\" field from the fields\n+                    if (!retValue.isEmpty()) retValue = retValue.subList(0, retValue.size() - 1);\n@@ -63,1 +63,1 @@\n-    public HATPtrOp(TypeElement resultType, Class<?> bufferClass, List<Value> operands) {\n+    public HATPtrOp(String name, TypeElement resultType, Class<?> bufferClass, List<Value> operands) {\n@@ -68,0 +68,1 @@\n+        this.name = name;\n@@ -75,0 +76,1 @@\n+        this.name = op.name;\n@@ -86,0 +88,4 @@\n+    public String name() {\n+        return name;\n+    }\n+\n@@ -95,2 +101,2 @@\n-        public HATPtrStoreOp(TypeElement resultType, Class<?> bufferClass, List<Value> operands) {\n-            super(resultType, bufferClass, operands);\n+        public HATPtrStoreOp(String name, TypeElement resultType, Class<?> bufferClass, List<Value> operands) {\n+            super(name, resultType, bufferClass, operands);\n@@ -119,2 +125,2 @@\n-        public HATPtrLoadOp(TypeElement resultType, Class<?> bufferClass, List<Value> operands) {\n-            super(resultType, bufferClass, operands);\n+        public HATPtrLoadOp(String name, TypeElement resultType, Class<?> bufferClass, List<Value> operands) {\n+            super(name, resultType, bufferClass, operands);\n@@ -142,2 +148,2 @@\n-        public HATPtrLengthOp(TypeElement resultType, Class<?> bufferClass, List<Value> operands) {\n-            super(resultType, bufferClass, operands);\n+        public HATPtrLengthOp(String name, TypeElement resultType, Class<?> bufferClass, List<Value> operands) {\n+            super(name, resultType, bufferClass, operands);\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATPtrOp.java","additions":16,"deletions":10,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -49,1 +49,0 @@\n-\n@@ -62,1 +61,1 @@\n-                        if (invoke.namedIgnoreCase(\"add\",\"sub\",\"mull\",\"div\")) {\n+                        if (invoke.namedIgnoreCase(\"add\",\"sub\",\"mul\",\"div\")) {\n@@ -68,1 +67,0 @@\n-                                   \/\/ varNameFromInvokeFirstUseOrThrow(invoke),\n@@ -86,1 +84,1 @@\n-                        if (HATPhaseUtils.isBufferInitialize(varOp) && OpHelper.resultFromFirstOperandOrThrow(varOp) instanceof Op.Result result) {\n+                        if (HATPhaseUtils.isBufferInitialize(varOp) && resultFromFirstOperandOrThrow(varOp) instanceof Op.Result result) {\n@@ -107,1 +105,1 @@\n-                        if ((HATPhaseUtils.isBufferInitialize(varLoadOp)) && OpHelper.resultFromFirstOperandOrThrow(varLoadOp) instanceof Op.Result r) {\n+                        if ((HATPhaseUtils.isBufferInitialize(varLoadOp)) && resultFromFirstOperandOrThrow(varLoadOp) instanceof Op.Result r) {\n@@ -117,2 +115,1 @@\n-                                                blockBuilder.context().getValueOrDefault(replaced.get(r), replaced.get(r)))\n-                                             \/\/   getValue(blockBuilder, replaced.get(r)))\n+                                                blockBuilder.context().getValue(replaced.get(r)))\n@@ -133,1 +130,1 @@\n-                                Op vop = opFromFirstOperandOrThrow(buffer.op());\/\/resultFromFirstOperandOrNull(buffer.op())).op();\n+                                Op vop = opFromFirstOperandOrThrow(buffer.op());\n@@ -136,1 +133,1 @@\n-                                    case VarLikeOp varLikeOp -> varLikeOp.varName();\/\/   HATMemoryVarOp.HATLocalVarOp &&  HATMemoryVarOp.HATPrivateVarOp\n+                                    case VarLikeOp varLikeOp -> varLikeOp.varName(); \/\/ HATMemoryVarOp.HATLocalVarOp &&  HATMemoryVarOp.HATPrivateVarOp\n@@ -153,0 +150,1 @@\n+                                        arrayAccessInfo.bufferName(),\n@@ -167,1 +165,1 @@\n-                        if (HATPhaseUtils.isBufferArray(arrayStoreOp) && OpHelper.resultFromFirstOperandOrThrow(arrayStoreOp) instanceof Op.Result r) {\n+                        if (HATPhaseUtils.isBufferArray(arrayStoreOp) && resultFromFirstOperandOrThrow(arrayStoreOp) instanceof Op.Result r) {\n@@ -172,1 +170,0 @@\n-                                       \/\/ findVarOpOrHATVarOP(((Op.Result) arrayStoreOp.operands().getLast()).op());\n@@ -195,0 +192,1 @@\n+                                        arrayAccessInfo.bufferName(),\n@@ -209,1 +207,1 @@\n-                        HATPhaseUtils.isBufferArray(arrayLengthOp) && OpHelper.resultFromFirstOperandOrThrow(arrayLengthOp) instanceof Op.Result ->{\n+                        HATPhaseUtils.isBufferArray(arrayLengthOp) && resultFromFirstOperandOrThrow(arrayLengthOp) != null ->{\n@@ -212,0 +210,1 @@\n+                                    arrayAccessInfo.bufferName(),\n@@ -230,1 +229,1 @@\n-    record ArrayAccessInfo(Op.Result buffer, List<Op.Result> indices) {\n+    record ArrayAccessInfo(Op.Result buffer, String bufferName, List<Op.Result> indices) {\n@@ -250,2 +249,4 @@\n-                        indices.addFirst(res.op() instanceof JavaOp.ArrayAccessOp ? ((Op.Result) res.op().operands().get(1)) : ((Op.Result) res.op().operands().get(0)));\n-\n+                        \/\/ idx location differs between ArrayAccessOp and ArrayLengthOp\n+                        indices.addFirst(res.op() instanceof JavaOp.ArrayAccessOp\n+                                ? resultFromOperandN(res.op(), 1)\n+                                : resultFromFirstOperandOrThrow(res.op()));\n@@ -253,1 +254,0 @@\n-                \/\/ I think we need to comment this.  Not so obvious.\n@@ -255,1 +255,1 @@\n-                    Node<T> next = node.edges().getFirst();\n+                    Node<T> next = node.edges().getFirst(); \/\/ we only traverse through the index-related ops\n@@ -262,1 +262,2 @@\n-            return new ArrayAccessInfo(buffer, indices);\n+            String bufferName = hatPtrName(resultFromFirstOperandOrNull(buffer.op()).op());\n+            return new ArrayAccessInfo(buffer, bufferName, indices);\n@@ -266,1 +267,8 @@\n-\n+    public static String hatPtrName(Op op) {\n+        return switch (op) {\n+            case CoreOp.VarOp varOp -> varOp.varName();\n+            case HATMemoryVarOp.HATLocalVarOp hatLocalVarOp -> hatLocalVarOp.varName();\n+            case HATMemoryVarOp.HATPrivateVarOp hatPrivateVarOp -> hatPrivateVarOp.varName();\n+            case null, default -> \"\";\n+        };\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATArrayViewPhase.java","additions":27,"deletions":19,"binary":false,"changes":46,"status":"modified"}]}