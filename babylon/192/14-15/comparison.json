{"files":[{"patch":"@@ -85,2 +85,1 @@\n-    private static final JavaType ARRAYLIST = JavaType.type(ArrayList.class.describeConstable().get());\n-    private static final FunctionType ARRAYLIST_INIT = FunctionType.functionType(ARRAYLIST);\n+    private static final JavaType CLASS_ARRAY = JavaType.array(JavaType.J_L_CLASS);\n@@ -91,1 +90,0 @@\n-    private static final MethodRef ARRAYLIST_ADD = MethodRef.method(ARRAYLIST, \"add\", JavaType.BOOLEAN, JavaType.J_L_OBJECT);\n@@ -101,1 +99,1 @@\n-    private static final MethodRef METHOD_TYPE_L = MethodRef.method(MT, \"methodType\", MT, JavaType.J_L_CLASS, JavaType.J_U_LIST);\n+    private static final MethodRef METHOD_TYPE_L = MethodRef.method(MT, \"methodType\", MT, JavaType.J_L_CLASS, CLASS_ARRAY);\n@@ -613,7 +611,0 @@\n-                        List<Value> bootstrapArgs = new ArrayList<>();\n-                        bootstrapArgs.add(lookup());\n-                        bootstrapArgs.add(liftConstant(inst.name().toString()));\n-                        bootstrapArgs.add(liftConstant(mtd));\n-                        for (ConstantDesc barg : inst.bootstrapArgs()) {\n-                            bootstrapArgs.add(liftConstant(barg));\n-                        }\n@@ -625,0 +616,19 @@\n+                        Value[] bootstrapArgs = new Value[bsmDesc.parameterCount()];\n+                        bootstrapArgs[0] = lookup();\n+                        bootstrapArgs[1] = liftConstant(inst.name().toString());\n+                        bootstrapArgs[2] = liftConstant(mtd);\n+                        ClassDesc lastArgType = bsmDesc.parameterType(bsmDesc.parameterCount() - 1);\n+                        List<ConstantDesc> bsmArgs = inst.bootstrapArgs();\n+                        if (lastArgType.isArray()) {\n+                            for (int ai = 0; ai < bootstrapArgs.length - 4; ai++) {\n+                                bootstrapArgs[ai + 3] = liftConstant(bsmArgs.get(ai));\n+                            }\n+                            \/\/ Vararg tail of the bootstrap method parameters\n+                            bootstrapArgs[bootstrapArgs.length - 1] =\n+                                    liftConstantsIntoArray(JavaType.type(lastArgType),\n+                                                           bsmArgs.subList(bootstrapArgs.length - 4, bsmArgs.size()).toArray());\n+                        } else {\n+                            for (int ai = 0; ai < bootstrapArgs.length - 3; ai++) {\n+                                bootstrapArgs[ai + 3] = liftConstant(bsmArgs.get(ai));\n+                            }\n+                        }\n@@ -798,0 +808,8 @@\n+    private Op.Result liftConstantsIntoArray(TypeElement arrayType, Object... constants) {\n+        Op.Result array = op(CoreOp.newArray(arrayType, liftConstant(constants.length)));\n+        for (int i = 0; i < constants.length; i++) {\n+            op(CoreOp.arrayStoreOp(array, liftConstant(i), liftConstant(constants[i])));\n+        }\n+        return array;\n+    }\n+\n@@ -837,7 +855,1 @@\n-                    default -> {\n-                        Op.Result list = op(CoreOp._new(ARRAYLIST_INIT));\n-                        for (ClassDesc p : mt.parameterList()) {\n-                            op(CoreOp.invoke(ARRAYLIST_ADD, list, liftConstant(p)));\n-                        }\n-                        yield CoreOp.invoke(METHOD_TYPE_L, liftConstant(mt.returnType()), list);\n-                    }\n+                    default -> CoreOp.invoke(METHOD_TYPE_L, liftConstant(mt.returnType()), liftConstantsIntoArray(CLASS_ARRAY, (Object[])mt.parameterArray()));\n","filename":"src\/java.base\/share\/classes\/java\/lang\/reflect\/code\/bytecode\/BytecodeLift.java","additions":30,"deletions":18,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -97,1 +97,1 @@\n-        Assert.assertTrue(passed > 33700, String.format(\"\"\"\n+        Assert.assertTrue(passed > 33750, String.format(\"\"\"\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/bytecode\/TestSmallCorpus.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}