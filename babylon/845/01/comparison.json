{"files":[{"patch":"@@ -176,1 +176,1 @@\n-        var lambdaOp = ((JavaOp.LambdaOp) q.op());\n+        var lambdaOp = q.op();\n@@ -446,1 +446,1 @@\n-        private Quoted q;\n+        private Quoted<JavaOp.LambdaOp> q;\n@@ -451,1 +451,1 @@\n-                Class<?> lambdaClass, MethodHandles.Lookup l, Quoted q, SessionOptions options) {\n+                Class<?> lambdaClass, MethodHandles.Lookup l, Quoted<JavaOp.LambdaOp> q, SessionOptions options) {\n","filename":"cr-examples\/onnx\/src\/main\/java\/oracle\/code\/onnx\/OnnxRuntime.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -59,2 +59,2 @@\n-    public static ModuleAndInitializers transform(MethodHandles.Lookup l, Quoted quotedLambda) {\n-        JavaOp.LambdaOp lambda = (JavaOp.LambdaOp) quotedLambda.op();\n+    public static ModuleAndInitializers transform(MethodHandles.Lookup l, Quoted<JavaOp.LambdaOp> quotedLambda) {\n+        JavaOp.LambdaOp lambda = quotedLambda.op();\n","filename":"cr-examples\/onnx\/src\/main\/java\/oracle\/code\/onnx\/compiler\/OnnxTransformer.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -194,2 +194,2 @@\n-        Quoted quoted = Op.ofLambda(compute).orElseThrow();\n-        JavaOp.LambdaOp lambda = (JavaOp.LambdaOp) quoted.op();\n+        Quoted<JavaOp.LambdaOp> quoted = Op.ofLambda(compute).orElseThrow();\n+        JavaOp.LambdaOp lambda = quoted.op();\n","filename":"hat\/core\/src\/main\/java\/hat\/Accelerator.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -147,1 +147,1 @@\n-    record KernelCallSite(Quoted quoted, JavaOp.LambdaOp lambdaOp, MethodRef methodRef, KernelCallGraph kernelCallGraph) {}\n+    record KernelCallSite(Quoted<JavaOp.LambdaOp> quoted, JavaOp.LambdaOp lambdaOp, MethodRef methodRef, KernelCallGraph kernelCallGraph) {}\n@@ -157,1 +157,1 @@\n-        Quoted quoted = Op.ofLambda(kernel).orElseThrow();\n+        Quoted<JavaOp.LambdaOp> quoted = Op.ofLambda(kernel).orElseThrow();\n@@ -162,1 +162,1 @@\n-            JavaOp.LambdaOp lambdaOp = (JavaOp.LambdaOp) quoted.op();\n+            JavaOp.LambdaOp lambdaOp = quoted.op();\n","filename":"hat\/core\/src\/main\/java\/hat\/ComputeContext.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -210,2 +210,2 @@\n-    Quoted quoted = Op.ofLambda(compute).orElseThrow();\n-    JavaOp.LambdaOp lambda = (JavaOp.LambdaOp) quoted.op();\n+    Quoted<JavaOp.LambdaOp> quoted = Op.ofLambda(compute).orElseThrow();\n+    JavaOp.LambdaOp lambda = quoted.op();\n","filename":"hat\/docs\/hat-05-accelerator-compute.md","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -133,2 +133,2 @@\n-            Quoted quoted = Op.ofLambda(q).orElseThrow();;\n-            JavaOp.LambdaOp op = (JavaOp.LambdaOp) quoted.op();\n+            Quoted<JavaOp.LambdaOp> quoted = Op.ofLambda(q).orElseThrow();;\n+            JavaOp.LambdaOp op = quoted.op();\n","filename":"hat\/examples\/experiments\/src\/main\/java\/experiments\/TestQuoted.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -685,1 +685,1 @@\n-        default Object[] getQuotedCapturedValues(Quoted quoted, Method method) {\n+        default Object[] getQuotedCapturedValues(Quoted<JavaOp.LambdaOp> quoted, Method method) {\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/OpHelper.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+import jdk.incubator.code.dialect.java.JavaOp;\n@@ -507,1 +508,1 @@\n-    public static Optional<Quoted> ofLambda(Object fiInstance) {\n+    public static Optional<Quoted<JavaOp.LambdaOp>> ofLambda(Object fiInstance) {\n@@ -524,1 +525,1 @@\n-        Quoted quoted;\n+        Quoted<?> q;\n@@ -526,1 +527,1 @@\n-            quoted = (Quoted) method.invoke(oq);\n+            q = (Quoted<?>) method.invoke(oq);\n@@ -534,1 +535,7 @@\n-        return Optional.of(quoted);\n+        if (!(q.op() instanceof JavaOp.LambdaOp)) {\n+            \/\/ This can only happen if the stored model is invalid\n+            throw new RuntimeException(\"Invalid code model for lambda expression : \" + q);\n+        }\n+        @SuppressWarnings(\"unchecked\")\n+        Quoted<JavaOp.LambdaOp> lq = (Quoted<JavaOp.LambdaOp>) q;\n+        return Optional.of(lq);\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/Op.java","additions":11,"deletions":4,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+ * @param <T> the type of operation that is quoted\n@@ -43,2 +44,2 @@\n-public final class Quoted {\n-    private final Op op;\n+public final class Quoted<T extends Op> {\n+    private final T op;\n@@ -53,1 +54,1 @@\n-    public Quoted(Op op) {\n+    public Quoted(T op) {\n@@ -69,1 +70,1 @@\n-    public Quoted(Op op, SequencedMap<Value, Object> operandsAndCapturedValues) {\n+    public Quoted(T op, SequencedMap<Value, Object> operandsAndCapturedValues) {\n@@ -86,1 +87,1 @@\n-    public Op op() {\n+    public T op() {\n@@ -180,1 +181,1 @@\n-        FunctionType ft = CoreType.functionType(CoreOp.QuotedOp.QUOTED_TYPE, params);\n+        FunctionType ft = CoreType.functionType(CoreOp.QuotedOp.QUOTED_OP_TYPE, params);\n@@ -227,1 +228,1 @@\n-    public static Quoted extractOp(CoreOp.FuncOp funcOp, List<Object> args) {\n+    public static Quoted<Op> extractOp(CoreOp.FuncOp funcOp, List<Object> args) {\n@@ -327,1 +328,1 @@\n-        return new Quoted(op, m);\n+        return new Quoted<>(op, m);\n@@ -344,1 +345,1 @@\n-    public static Quoted extractOp(CoreOp.FuncOp funcOp, Object... args) {\n+    public static Quoted<Op> extractOp(CoreOp.FuncOp funcOp, Object... args) {\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/Quoted.java","additions":10,"deletions":9,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -172,1 +172,1 @@\n-            BitSet quotable = new BitSet();\n+            BitSet reflectableLambda = new BitSet();\n@@ -176,1 +176,1 @@\n-                generateMethod(lookup, clName, e.getKey(), lowered, clb, ops, lambdaSink, quotable);\n+                generateMethod(lookup, clName, e.getKey(), lowered, clb, ops, lambdaSink, reflectableLambda);\n@@ -180,1 +180,1 @@\n-                if (quotable.get(i)) {\n+                if (reflectableLambda.get(i)) {\n@@ -190,1 +190,1 @@\n-                generateMethod(lookup, clName, \"lambda$\" + i, lop, clb, ops, lambdaSink, quotable);\n+                generateMethod(lookup, clName, \"lambda$\" + i, lop, clb, ops, lambdaSink, reflectableLambda);\n@@ -205,1 +205,1 @@\n-                                                                     BitSet quotable) {\n+                                                                     BitSet reflectableLambda) {\n@@ -213,1 +213,1 @@\n-                                          iop.body().blocks(), cob, functionTable, lambdaSink, quotable).generate()));\n+                                          iop.body().blocks(), cob, functionTable, lambdaSink, reflectableLambda).generate()));\n@@ -232,1 +232,1 @@\n-    private final BitSet quotable;\n+    private final BitSet reflectableLambda;\n@@ -245,1 +245,1 @@\n-                              BitSet quotable) {\n+                              BitSet reflectableLambda) {\n@@ -260,1 +260,1 @@\n-        this.quotable = quotable;\n+        this.reflectableLambda = reflectableLambda;\n@@ -946,1 +946,1 @@\n-                                quotable.set(lambdaSink.size());\n+                                reflectableLambda.set(lambdaSink.size());\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/bytecode\/BytecodeGenerator.java","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -407,1 +407,6 @@\n-        public static final JavaType QUOTED_TYPE = JavaType.type(Quoted.class);\n+        \/**\n+         * The java type element modelling the parameterized type {@code Quoted<Op>}\n+         * that is the result type of a QuotedOp instance.\n+         *\/\n+        public static final JavaType QUOTED_OP_TYPE = JavaType.parameterized(\n+                JavaType.type(Quoted.class), JavaType.type(Op.class));\n@@ -464,1 +469,1 @@\n-            return QUOTED_TYPE;\n+            return QUOTED_OP_TYPE;\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/dialect\/core\/CoreOp.java","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -191,1 +191,1 @@\n-            public Builder quotable() {\n+            public Builder reflectable() {\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/dialect\/java\/JavaOp.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -523,4 +523,2 @@\n-            MethodType mtype = new MethodType(capturedTypes.toList(), crSyms.quotedType,\n-                    com.sun.tools.javac.util.List.nil(), syms.methodClass);\n-            FunctionType mtDesc = CoreType.functionType(typeToTypeElement(mtype.restype),\n-                    mtype.getParameterTypes().map(ReflectMethods.this::typeToTypeElement));\n+            FunctionType mtDesc = CoreType.functionType(CoreOp.QuotedOp.QUOTED_OP_TYPE,\n+                    capturedTypes.toList().map(ReflectMethods.this::typeToTypeElement));\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/internal\/ReflectMethods.java","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -484,1 +484,1 @@\n-            return new Quoted(qo.quotedOp(), capturedValues);\n+            return new Quoted<>(qo.quotedOp(), capturedValues);\n@@ -495,1 +495,1 @@\n-            \/\/ If a quotable lambda proxy again to add method Quoted quoted()\n+            \/\/ If a reflectable lambda proxy again to add method Quoted quoted()\n@@ -499,1 +499,1 @@\n-                            private final Quoted quoted = new Quoted(lo, capturedValuesAndArguments);\n+                            private final Quoted<JavaOp.LambdaOp> quoted = new Quoted<>(lo, capturedValuesAndArguments);\n@@ -510,1 +510,1 @@\n-                            private Quoted __internal_quoted() {\n+                            private Quoted<JavaOp.LambdaOp> __internal_quoted() {\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/interpreter\/Interpreter.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -52,1 +52,1 @@\n-        return SSA.transform((JavaOp.LambdaOp) Op.ofLambda(ibo).get().op());\n+        return SSA.transform(Op.ofLambda(ibo).get().op());\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestBuild.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -54,1 +54,1 @@\n-        JavaOp.LambdaOp cop = (JavaOp.LambdaOp) Op.ofLambda(q).get().op();\n+        JavaOp.LambdaOp cop = Op.ofLambda(q).get().op();\n@@ -76,1 +76,1 @@\n-        JavaOp.LambdaOp cop = (JavaOp.LambdaOp) Op.ofLambda(q).get().op();\n+        JavaOp.LambdaOp cop = Op.ofLambda(q).get().op();\n@@ -110,1 +110,1 @@\n-        JavaOp.LambdaOp cop = (JavaOp.LambdaOp) Op.ofLambda(q).get().op();\n+        JavaOp.LambdaOp cop = Op.ofLambda(q).get().op();\n@@ -139,1 +139,1 @@\n-        JavaOp.LambdaOp cop = (JavaOp.LambdaOp) Op.ofLambda(q).get().op();\n+        JavaOp.LambdaOp cop = Op.ofLambda(q).get().op();\n@@ -174,1 +174,1 @@\n-        JavaOp.LambdaOp cop = (JavaOp.LambdaOp) Op.ofLambda(q).get().op();\n+        JavaOp.LambdaOp cop = Op.ofLambda(q).get().op();\n@@ -201,1 +201,1 @@\n-        JavaOp.LambdaOp cop = (JavaOp.LambdaOp) Op.ofLambda(q).get().op();\n+        JavaOp.LambdaOp cop = Op.ofLambda(q).get().op();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestInline.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -52,2 +52,1 @@\n-import static jdk.incubator.code.dialect.java.JavaType.INT;\n-import static jdk.incubator.code.dialect.java.JavaType.type;\n+import static jdk.incubator.code.dialect.java.JavaType.*;\n@@ -58,1 +57,1 @@\n-                INT, CoreOp.QuotedOp.QUOTED_TYPE);\n+                INT, CoreOp.QuotedOp.QUOTED_OP_TYPE);\n@@ -60,1 +59,1 @@\n-        static int accept(Quoted l) {\n+        static int accept(Quoted<?> l) {\n@@ -159,1 +158,2 @@\n-        Assertions.assertEquals(fop.invokableType().returnType(), type(Quoted.class));\n+        System.out.println(fop.toText());\n+        Assertions.assertEquals(fop.invokableType().returnType(), parameterized(type(Quoted.class), type(Op.class)));\n@@ -176,1 +176,1 @@\n-            Quoted q = Op.ofLambda(op).get();\n+            Quoted<LambdaOp> q = Op.ofLambda(op).get();\n@@ -181,1 +181,1 @@\n-            int r = (int) Interpreter.invoke(MethodHandles.lookup(), (LambdaOp) q.op(),\n+            int r = (int) Interpreter.invoke(MethodHandles.lookup(), q.op(),\n@@ -185,1 +185,1 @@\n-            r = (int) Interpreter.invoke(MethodHandles.lookup(), (LambdaOp) q.op(),\n+            r = (int) Interpreter.invoke(MethodHandles.lookup(), q.op(),\n@@ -194,1 +194,1 @@\n-            Quoted q = Op.ofLambda(op).get();\n+            Quoted<LambdaOp> q = Op.ofLambda(op).get();\n@@ -200,1 +200,1 @@\n-            int r = (int) Interpreter.invoke(MethodHandles.lookup(), (LambdaOp) q.op(),\n+            int r = (int) Interpreter.invoke(MethodHandles.lookup(), q.op(),\n@@ -204,1 +204,1 @@\n-            r = (int) Interpreter.invoke(MethodHandles.lookup(), (LambdaOp) q.op(),\n+            r = (int) Interpreter.invoke(MethodHandles.lookup(), q.op(),\n@@ -223,1 +223,1 @@\n-        LambdaOp qop = (LambdaOp) Op.ofLambda(f).get().op();\n+        LambdaOp qop = Op.ofLambda(f).get().op();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestLambdaOps.java","additions":12,"deletions":12,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -64,2 +64,2 @@\n-        Quoted quoted = Op.ofLambda(q).get();\n-        JavaOp.LambdaOp lop = (JavaOp.LambdaOp) quoted.op();\n+        Quoted<JavaOp.LambdaOp> quoted = Op.ofLambda(q).get();\n+        JavaOp.LambdaOp lop = quoted.op();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestMethodRefLambda.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -71,1 +71,1 @@\n-        LambdaOp lambdaOp = (LambdaOp) Op.ofLambda(runnable).get().op();\n+        LambdaOp lambdaOp = Op.ofLambda(runnable).get().op();\n@@ -80,1 +80,1 @@\n-        LambdaOp lambdaOp = (LambdaOp) Op.ofLambda(runnable).get().op();\n+        LambdaOp lambdaOp = Op.ofLambda(runnable).get().op();\n@@ -90,1 +90,1 @@\n-        LambdaOp lambdaOp = (LambdaOp) Op.ofLambda(runnable).get().op();\n+        LambdaOp lambdaOp = Op.ofLambda(runnable).get().op();\n@@ -100,1 +100,1 @@\n-        LambdaOp lambdaOp = (LambdaOp) Op.ofLambda(lambda).get().op();\n+        LambdaOp lambdaOp = Op.ofLambda(lambda).get().op();\n@@ -110,1 +110,1 @@\n-        LambdaOp lambdaOp = (LambdaOp) Op.ofLambda(lambda).get().op();\n+        LambdaOp lambdaOp = Op.ofLambda(lambda).get().op();\n@@ -118,1 +118,1 @@\n-        LambdaOp lambdaOp = (LambdaOp) Op.ofLambda(runnable).get().op();\n+        LambdaOp lambdaOp = Op.ofLambda(runnable).get().op();\n@@ -132,1 +132,1 @@\n-        LambdaOp lambdaOp = (LambdaOp) Op.ofLambda(lambda).get().op();\n+        LambdaOp lambdaOp = Op.ofLambda(lambda).get().op();\n@@ -140,1 +140,1 @@\n-        LambdaOp lambdaOp = (LambdaOp) Op.ofLambda(runnable).get().op();\n+        LambdaOp lambdaOp = Op.ofLambda(runnable).get().op();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestModuleOp.java","additions":8,"deletions":8,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -4,0 +4,1 @@\n+import jdk.incubator.code.dialect.java.JavaOp;\n@@ -29,2 +30,2 @@\n-        Quoted quoted1 = Op.ofLambda(q1).orElseThrow();\n-        Quoted quoted2 = Op.ofLambda(q2).orElseThrow();\n+        Quoted<?> quoted1 = Op.ofLambda(q1).orElseThrow();\n+        Quoted<?> quoted2 = Op.ofLambda(q2).orElseThrow();\n@@ -38,1 +39,1 @@\n-        List<Op> ops = Stream.of(q1, q2).parallel().map(q -> Op.ofLambda(q).orElseThrow().op()).toList();\n+        List<JavaOp.LambdaOp> ops = Stream.of(q1, q2).parallel().map(q -> Op.ofLambda(q).orElseThrow().op()).toList();\n@@ -50,2 +51,2 @@\n-        Quoted quoted1 = Op.ofLambda(q1).orElseThrow();\n-        Quoted quoted2 = Op.ofLambda(q2).orElseThrow();\n+        Quoted<?> quoted1 = Op.ofLambda(q1).orElseThrow();\n+        Quoted<?> quoted2 = Op.ofLambda(q2).orElseThrow();\n@@ -59,1 +60,1 @@\n-        List<Op> ops = Stream.of(q1, q2).parallel().map(q -> Op.ofLambda(q).orElseThrow().op()).toList();\n+        List<JavaOp.LambdaOp> ops = Stream.of(q1, q2).parallel().map(q -> Op.ofLambda(q).orElseThrow().op()).toList();\n@@ -67,2 +68,2 @@\n-        Quoted q1 = Op.ofLambda(q).get();\n-        Quoted q2 = Op.ofLambda(q).get();\n+        Quoted<?> q1 = Op.ofLambda(q).get();\n+        Quoted<?> q2 = Op.ofLambda(q).get();\n@@ -76,1 +77,1 @@\n-        List<Quoted> quotedObjects = IntStream.range(1, 3).parallel().mapToObj(_ -> Op.ofLambda(q).get()).toList();\n+        List<Quoted<JavaOp.LambdaOp>> quotedObjects = IntStream.range(1, 3).parallel().mapToObj(_ -> Op.ofLambda(q).get()).toList();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestOpOfLambda.java","additions":10,"deletions":9,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -39,1 +39,1 @@\n-        Quoted quoted = Quoted.extractOp(funcOp, args);\n+        Quoted<?> quoted = Quoted.extractOp(funcOp, args);\n@@ -47,2 +47,2 @@\n-        Assertions.assertEquals(args[0], ((CoreOp.Var) iterator.next()).value());\n-        Assertions.assertEquals(args[1], ((CoreOp.Var) iterator.next()).value());\n+        Assertions.assertEquals(args[0], ((CoreOp.Var<?>) iterator.next()).value());\n+        Assertions.assertEquals(args[1], ((CoreOp.Var<?>) iterator.next()).value());\n@@ -66,1 +66,1 @@\n-        Quoted quoted = Quoted.extractOp(funcOp, args);\n+        Quoted<?> quoted = Quoted.extractOp(funcOp, args);\n@@ -83,1 +83,1 @@\n-        Quoted quoted = Op.ofLambda(q).orElseThrow();\n+        Quoted<?> quoted = Op.ofLambda(q).orElseThrow();\n@@ -89,1 +89,1 @@\n-        Quoted quoted2 = Quoted.extractOp(fop, args);\n+        Quoted<?> quoted2 = Quoted.extractOp(fop, args);\n@@ -93,2 +93,2 @@\n-        Assertions.assertEquals(y, ((CoreOp.Var) iterator.next()).value());\n-        Assertions.assertEquals(args[1], ((CoreOp.Var) iterator.next()).value());\n+        Assertions.assertEquals(y, ((CoreOp.Var<?>) iterator.next()).value());\n+        Assertions.assertEquals(args[1], ((CoreOp.Var<?>) iterator.next()).value());\n@@ -464,1 +464,1 @@\n-        Quoted quoted = Quoted.extractOp(fop, args);\n+        Quoted<?> quoted = Quoted.extractOp(fop, args);\n@@ -472,1 +472,1 @@\n-                Assertions.assertEquals(args[p.index()], ((CoreOp.Var) rv).value());\n+                Assertions.assertEquals(args[p.index()], ((CoreOp.Var<?>) rv).value());\n@@ -554,1 +554,1 @@\n-        new Quoted(op, m);\n+        new Quoted<>(op, m);\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestQuoteOp.java","additions":11,"deletions":11,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -37,1 +37,1 @@\n-        Quoted quoted = Op.ofLambda(q).get();\n+        Quoted<?> quoted = Op.ofLambda(q).get();\n@@ -64,1 +64,1 @@\n-        Quoted quoted = Op.ofLambda(q).get();\n+        Quoted<?> quoted = Op.ofLambda(q).get();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestSealOp.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -49,1 +49,1 @@\n-        return (JavaOp.LambdaOp) Op.ofLambda(ibo).get().op();\n+        return Op.ofLambda(ibo).get().op();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestValueCast.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -61,1 +61,1 @@\n-        return generateF((JavaOp.LambdaOp)Op.ofLambda(q).get().op());\n+        return generateF(Op.ofLambda(q).get().op());\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/ad\/TestExpressionElimination.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -51,1 +51,0 @@\n-import java.lang.invoke.LambdaMetafactory;\n@@ -475,1 +474,1 @@\n-                        \/\/ if ReflectableLambdaMetafactory is used, the lambda is quotable\n+                        \/\/ if ReflectableLambdaMetafactory is used, the lambda is reflectable\n@@ -477,1 +476,1 @@\n-                            lambda = lambda.quotable();\n+                            lambda = lambda.reflectable();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/bytecode\/lift\/BytecodeLift.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -54,1 +54,1 @@\n-        JavaOp.LambdaOp l = (JavaOp.LambdaOp) Op.ofLambda(f).get().op();\n+        JavaOp.LambdaOp l = Op.ofLambda(f).get().op();\n@@ -60,1 +60,1 @@\n-        JavaOp.LambdaOp l = (JavaOp.LambdaOp) Op.ofLambda(f).get().op();\n+        JavaOp.LambdaOp l = Op.ofLambda(f).get().op();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/linq\/Queryable.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -36,1 +36,0 @@\n-import static jdk.incubator.code.dialect.java.JavaOp.continue_;\n@@ -57,5 +56,3 @@\n-            StreamOp(Object quotedLambda) {\n-                if (!(Op.ofLambda(quotedLambda).get().op() instanceof JavaOp.LambdaOp lambdaOp)) {\n-                    throw new IllegalArgumentException(\"Quotable operation is not lambda operation\");\n-                }\n-                if (!(Op.ofLambda(quotedLambda).get().capturedValues().isEmpty())) {\n+            StreamOp(Object reflectableLambda) {\n+                Quoted<JavaOp.LambdaOp> quotedLambda = Op.ofLambda(reflectableLambda).orElseThrow();\n+                if (!(quotedLambda.capturedValues().isEmpty())) {\n@@ -64,1 +61,1 @@\n-                this.lambdaOp = lambdaOp;\n+                this.lambdaOp = quotedLambda.op();\n@@ -73,2 +70,2 @@\n-            public MapStreamOp(Object quotedLambda) {\n-                super(quotedLambda);\n+            public MapStreamOp(Object reflectableLambda) {\n+                super(reflectableLambda);\n@@ -79,2 +76,2 @@\n-            public FlatMapStreamOp(Object quotedLambda) {\n-                super(quotedLambda);\n+            public FlatMapStreamOp(Object reflectableLambda) {\n+                super(reflectableLambda);\n@@ -85,2 +82,2 @@\n-            public FilterStreamOp(Object quotedLambda) {\n-                super(quotedLambda);\n+            public FilterStreamOp(Object reflectableLambda) {\n+                super(reflectableLambda);\n@@ -183,5 +180,3 @@\n-        public FuncOp forEach(Consumer<T> quotableConsumer) {\n-            if (!(Op.ofLambda(quotableConsumer).get().op() instanceof JavaOp.LambdaOp consumer)) {\n-                throw new IllegalArgumentException(\"Quotable consumer is not lambda operation\");\n-            }\n-            if (!(Op.ofLambda(quotableConsumer).get().capturedValues().isEmpty())) {\n+        public FuncOp forEach(Consumer<T> reflectableConsumer) {\n+            Quoted<JavaOp.LambdaOp> quotedConsumer = Op.ofLambda(reflectableConsumer).orElseThrow();\n+            if (!(quotedConsumer.capturedValues().isEmpty())) {\n@@ -190,0 +185,1 @@\n+            JavaOp.LambdaOp consumer = quotedConsumer.op();\n@@ -210,5 +206,3 @@\n-        public <C> FuncOp collect(Supplier<C> quotableSupplier, BiConsumer<C, T> quotableAccumulator) {\n-            if (!(Op.ofLambda(quotableSupplier).get().op() instanceof JavaOp.LambdaOp supplier)) {\n-                throw new IllegalArgumentException(\"Quotable supplier is not lambda operation\");\n-            }\n-            if (!(Op.ofLambda(quotableSupplier).get().capturedValues().isEmpty())) {\n+        public <C> FuncOp collect(Supplier<C> reflectableSupplier, BiConsumer<C, T> reflectableAccumulator) {\n+            Quoted<JavaOp.LambdaOp> quotedSupplier = Op.ofLambda(reflectableSupplier).orElseThrow();\n+            if (!(quotedSupplier.capturedValues().isEmpty())) {\n@@ -217,4 +211,3 @@\n-            if (!(Op.ofLambda(quotableAccumulator).get().op() instanceof JavaOp.LambdaOp accumulator)) {\n-                throw new IllegalArgumentException(\"Quotable accumulator is not lambda operation\");\n-            }\n-            if (!(Op.ofLambda(quotableAccumulator).get().capturedValues().isEmpty())) {\n+            JavaOp.LambdaOp supplier = quotedSupplier.op();\n+            Quoted<JavaOp.LambdaOp> quotedAccumulator = Op.ofLambda(reflectableAccumulator).orElseThrow();\n+            if (!(quotedAccumulator.capturedValues().isEmpty())) {\n@@ -223,0 +216,1 @@\n+            JavaOp.LambdaOp accumulator = quotedAccumulator.op();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/stream\/StreamFuser.java","additions":21,"deletions":27,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -111,1 +111,1 @@\n-        Quoted quoted = Op.ofLambda(quotable).get();\n+        Quoted<?> quoted = Op.ofLambda(quotable).get();\n@@ -139,1 +139,1 @@\n-    static Op getModelOfQuotedOp(Quoted quoted) {\n+    static Op getModelOfQuotedOp(Quoted<?> quoted) {\n","filename":"test\/langtools\/tools\/javac\/reflect\/CodeReflectionTester.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -57,1 +57,1 @@\n-        Quoted quoted = Op.ofLambda(quotable).get();\n+        Quoted<?> quoted = Op.ofLambda(quotable).get();\n@@ -59,1 +59,1 @@\n-        assertEquals(x, ((Var)quoted.capturedValues().values().iterator().next()).value());\n+        assertEquals(x, ((Var<?>)quoted.capturedValues().values().iterator().next()).value());\n@@ -73,1 +73,1 @@\n-        Quoted quoted = Op.ofLambda(f).get();\n+        Quoted<?> quoted = Op.ofLambda(f).get();\n@@ -77,2 +77,2 @@\n-        assertEquals(hello, ((Var)it.next()).value());\n-        assertEquals(x, ((Var)it.next()).value());\n+        assertEquals(hello, ((Var<?>)it.next()).value());\n+        assertEquals(x, ((Var<?>)it.next()).value());\n@@ -90,1 +90,1 @@\n-        Quoted quoted = Op.ofLambda(f).get();\n+        Quoted<?> quoted = Op.ofLambda(f).get();\n@@ -107,1 +107,1 @@\n-        Quoted quoted = Op.ofLambda(f).get();\n+        Quoted<?> quoted = Op.ofLambda(f).get();\n@@ -132,1 +132,1 @@\n-        Quoted quoted = Op.ofLambda(f).get();\n+        Quoted<?> quoted = Op.ofLambda(f).get();\n@@ -138,1 +138,1 @@\n-            int actual = (int) ((Var)it.next()).value();\n+            int actual = (int) ((Var<?>)it.next()).value();\n@@ -160,1 +160,1 @@\n-        Quoted quoted = Op.ofLambda(f).get();\n+        Quoted<?> quoted = Op.ofLambda(f).get();\n@@ -180,1 +180,1 @@\n-        Quoted quoted = Op.ofLambda(f).get();\n+        Quoted<?> quoted = Op.ofLambda(f).get();\n@@ -183,1 +183,1 @@\n-        assertEquals(i, ((Box)((Var)quoted.capturedValues().values().iterator().next()).value()).i);\n+        assertEquals(i, ((Box)((Var<?>)quoted.capturedValues().values().iterator().next()).value()).i);\n","filename":"test\/langtools\/tools\/javac\/reflect\/TestLambdaCapture.java","additions":12,"deletions":12,"binary":false,"changes":24,"status":"modified"}]}