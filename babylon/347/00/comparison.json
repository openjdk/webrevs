{"files":[{"patch":"@@ -243,1 +243,1 @@\n-                shape.length == 0 ? MemorySegment.NULL : arena.allocateFrom(C_LONG_LONG, shape), (long)shape.length,\n+                shape.length == 0 ? MemorySegment.NULL : autoShape(arena, shape, flatData.byteSize() \/ elementType.size()), (long)shape.length,\n@@ -248,0 +248,27 @@\n+    private static MemorySegment autoShape(Arena arena, long[] shape, long elementsCount) {\n+        int auto = -1;\n+        long elCount = 1;\n+        for (int i = 0; i < shape.length; i++) {\n+            long dim = shape[i];\n+            if (dim == -1) {\n+                if (auto == -1) {\n+                    auto = i;\n+                } else {\n+                    throw new IllegalArgumentException(\"Multiple automatic dimensions in shape\");\n+                }\n+            } else {\n+                elCount *= dim;\n+            }\n+        }\n+        var ms = arena.allocateFrom(C_LONG_LONG, shape);\n+        if (auto != -1) {\n+            long autoDim = elementsCount \/ elCount;\n+            ms.setAtIndex(C_LONG, auto, autoDim);\n+            elCount *= autoDim;\n+        }\n+        if (elCount != elementsCount) {\n+            throw new IllegalArgumentException(\"Tensor shape does not match data\");\n+        }\n+        return ms;\n+    }\n+\n","filename":"cr-examples\/onnx\/src\/main\/java\/oracle\/code\/onnx\/OnnxRuntime.java","additions":28,"deletions":1,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -378,0 +378,2 @@\n+    private static final long[] IMAGE_SHAPE = new long[]{-1, 1, 28, 28};\n+\n@@ -385,2 +387,1 @@\n-            long size = imagesF.length() - IMAGES_HEADER_SIZE;\n-            Tensor<Byte> inputImage = new Tensor(arena, imagesIn, Tensor.ElementType.UINT8, new long[]{size \/ (28 * 28), 1, 28, 28});\n+            Tensor<Byte> inputImage = new Tensor(arena, imagesIn, Tensor.ElementType.UINT8, IMAGE_SHAPE);\n","filename":"cr-examples\/onnx\/src\/test\/java\/oracle\/code\/onnx\/CNNTest.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"}]}