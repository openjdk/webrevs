{"files":[{"patch":"@@ -60,1 +60,1 @@\n-        return keyword(\"HAT_KERNEL\").space();\n+        return keyword(\"HAT_KERNEL\");\n@@ -64,1 +64,1 @@\n-        return keyword(\"HAT_FUNC\").space();\n+        return keyword(\"HAT_FUNC\");\n@@ -68,1 +68,1 @@\n-        return keyword(\"HAT_GLOBAL_MEM\").space();\n+        return keyword(\"HAT_GLOBAL_MEM\");\n@@ -72,1 +72,1 @@\n-        return keyword(\"HAT_LOCAL_MEM\").space();\n+        return keyword(\"HAT_LOCAL_MEM\");\n@@ -76,1 +76,1 @@\n-        return keyword(\"HAT_BARRIER\").space();\n+        return keyword(\"HAT_BARRIER\");\n@@ -195,1 +195,1 @@\n-        return HAT_KERNEL().voidType().space().funcName(funcOp);\n+        return HAT_KERNEL().space().voidType().space().funcName(funcOp);\n@@ -199,1 +199,1 @@\n-        return HAT_FUNC().type(codeBuilderContext,javaType).space().funcName(funcOp);\n+        return HAT_FUNC().space().type(codeBuilderContext,javaType).space().funcName(funcOp);\n@@ -322,1 +322,2 @@\n-        return HAT_LOCAL_MEM() \/\/ we should be able to compose-call to privateDeclaration?\n+        return HAT_LOCAL_MEM()\n+                .space() \/\/ we should be able to compose-call to privateDeclaration?\n@@ -365,1 +366,1 @@\n-            HAT_GLOBAL_MEM().suffix_t(classType).asterisk();\n+            HAT_GLOBAL_MEM().space().suffix_t(classType).asterisk();\n@@ -367,1 +368,1 @@\n-            HAT_GLOBAL_MEM().suffix_t(KernelContext.class).asterisk();\n+            HAT_GLOBAL_MEM().space().suffix_t(KernelContext.class).asterisk();\n@@ -369,1 +370,1 @@\n-            HAT_GLOBAL_MEM().suffix_t(F16Impl.class).asterisk();\n+            HAT_GLOBAL_MEM().space().suffix_t(F16Impl.class).asterisk();\n@@ -371,1 +372,1 @@\n-            HAT_GLOBAL_MEM().suffix_t(BF16Array.BF16Impl.class).asterisk();\n+            HAT_GLOBAL_MEM().space().suffix_t(BF16Array.BF16Impl.class).asterisk();\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/C99HATKernelBuilder.java","additions":13,"deletions":12,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import jdk.incubator.code.Op;\n@@ -32,0 +33,2 @@\n+\n+import java.util.HashSet;\n@@ -33,0 +36,2 @@\n+import java.util.Set;\n+import java.util.stream.Collectors;\n@@ -39,6 +44,17 @@\n-        return Trxfmr.of(fromFuncOp)\n-                .transform(\n-                        \/* predicate *\/     ce-> invokeOpHelper(lookup(),ce) instanceof InvokeOpHelper $&&$ .named(HATBarrierOp.NAME),\n-                        \/* transformation *\/c-> c.replace(new HATBarrierOp(List.of())\n-                        ))\n-                .funcOp();\n+         Set<CoreOp.VarAccessOp.VarLoadOp> varLoadOpSet = new HashSet<>();\n+         var trxfmr = Trxfmr.of(fromFuncOp);\n+         trxfmr.transform(\n+                 \/* predicate *\/     ce-> invokeOpHelper(lookup(),ce) instanceof InvokeOpHelper $&&$ .named(HATBarrierOp.NAME),\n+                 \/* transformation *\/c-> {\n+                     varLoadOpSet.add((CoreOp.VarAccessOp.VarLoadOp) ((Op.Result)c.op().operands().getFirst()).op());\n+                     c.replace(new HATBarrierOp(List.of()));\n+                 });\n+         var newSet=     varLoadOpSet.stream().map(varLoadOp ->trxfmr.biMap.getTo(varLoadOp)).collect(Collectors.toSet());\n+         trxfmr.transform(\n+                \/* predicate *\/   ce-> ce instanceof CoreOp.VarAccessOp.VarLoadOp varLoadOp\n+                         \/\/&& trxfmr.biMap.containsFrom(varLoadOp),\n+                         && newSet.contains(varLoadOp),\n+                \/* transformation *\/c-> c.remove()\n+        );\n+\n+         return trxfmr.funcOp();\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATBarrierPhase.java","additions":22,"deletions":6,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -193,1 +193,1 @@\n-        System.out.println( OpCodeBuilder.toText(trxfmr.funcOp));\n+        System.out.println( OpCodeBuilder.toText(trxfmr.funcOp()));\n@@ -201,1 +201,1 @@\n-        System.out.println(\" 1\/abs(100) = \" + BytecodeGenerator.generate(lookup, trxfmr.funcOp).invoke(100));\n+        System.out.println(\" 1\/abs(100) = \" + BytecodeGenerator.generate(lookup, trxfmr.funcOp()).invoke(100));\n","filename":"hat\/examples\/experiments\/src\/main\/java\/experiments\/CreateFuncOp.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+import optkl.util.BiMap;\n@@ -122,1 +123,1 @@\n-         default void remove(Consumer<Mapper<?>> mapperConsumer) {\n+        default void remove(Consumer<Mapper<?>> mapperConsumer) {\n@@ -252,1 +253,1 @@\n-    public final Map<Op, Op> opmap = new HashMap<>();\n+   \/\/ public final Map<Op, Op> opmap = new HashMap<>();\n@@ -254,1 +255,2 @@\n-    public CoreOp.FuncOp funcOp;\n+    private CoreOp.FuncOp funcOp;\n+    public BiMap<Op,Op> biMap = new BiMap<>();\n@@ -294,4 +296,4 @@\n-    private Op opToOp(Op from, Op to){\n-        opmap.put(from,to);\n-        return to;\n-    }\n+    \/\/private Op opToOp(Op from, Op to){\n+\n+      \/\/  return to;\n+    \/\/}\n@@ -299,1 +301,2 @@\n-        opToOp(from, result.op());\n+        biMap.add(from,result.op());\n+        \/\/opToOp(from, result.op());\n@@ -320,1 +323,2 @@\n-                    opToOp(op,cursor.builder().op(op).op());\n+                    biMap.add(op,cursor.builder().op(op).op());\n+                   \/\/ opToOp(op,cursor.builder().op(op).op());\n@@ -323,1 +327,1 @@\n-                opToOp(op,cursor.builder().op(op).op());\n+                biMap.add(op,cursor.builder().op(op).op());\n@@ -328,0 +332,2 @@\n+        biMap.add(funcOp,newFuncOp);\n+       \/\/ opToOp(funcOp,newFuncOp);\n@@ -344,1 +350,1 @@\n-                opToOp(op,cursor.builder().op(op).op());\n+                biMap.add(op,cursor.builder().op(op).op());\n@@ -348,1 +354,1 @@\n-        opmap.put(currentFuncOp, newFuncOp);\n+    \/\/    opmap.put(currentFuncOp, newFuncOp);\n@@ -350,1 +356,1 @@\n-        opmap.forEach((from, to) -> { selected.remove(from);selected.add(to);});\n+      \/\/  opmap.forEach((from, to) -> { selected.remove(from);selected.add(to);});\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/Trxfmr.java","additions":19,"deletions":13,"binary":false,"changes":32,"status":"modified"}]}