{"files":[{"patch":"@@ -27,0 +27,1 @@\n+import hat.optools.OpTk;\n@@ -31,0 +32,1 @@\n+import jdk.incubator.code.dialect.java.JavaOp;\n@@ -34,0 +36,1 @@\n+import java.util.regex.Pattern;\n@@ -36,1 +39,0 @@\n-\n@@ -64,0 +66,7 @@\n+\n+    public final static  Pattern pattern = Pattern.compile(\"bi[xyz]\");\n+\n+\n+    public static HATBlockThreadIdOp of(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n+        return new HATBlockThreadIdOp(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATBlockThreadIdOp.java","additions":10,"deletions":1,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import hat.optools.OpTk;\n@@ -31,0 +32,1 @@\n+import jdk.incubator.code.dialect.java.JavaOp;\n@@ -34,0 +36,1 @@\n+import java.util.regex.Pattern;\n@@ -64,0 +67,6 @@\n+\n+    static final public  Pattern pattern=  Pattern.compile(\"(gs[xyz])\");\n+\n+    static public HATGlobalSizeOp of(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n+        return new HATGlobalSizeOp(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATGlobalSizeOp.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import hat.optools.OpTk;\n@@ -31,0 +32,1 @@\n+import jdk.incubator.code.dialect.java.JavaOp;\n@@ -34,0 +36,1 @@\n+import java.util.regex.Pattern;\n@@ -36,1 +39,0 @@\n-\n@@ -64,0 +66,7 @@\n+\n+    public static final Pattern pattern=  Pattern.compile(\"(gi[xyz])\");\n+\n+\n+    public static  HATGlobalThreadIdOp of(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n+        return new HATGlobalThreadIdOp(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATGlobalThreadIdOp.java","additions":10,"deletions":1,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import hat.optools.OpTk;\n@@ -31,0 +32,1 @@\n+import jdk.incubator.code.dialect.java.JavaOp;\n@@ -34,0 +36,1 @@\n+import java.util.regex.Pattern;\n@@ -64,0 +67,7 @@\n+\n+\n+    public static Pattern  pattern= Pattern.compile(\"ls([xyz])\");\n+\n+    public static HATThreadOp of(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n+        return new HATLocalSizeOp(OpTk.dimIdx(fieldLoadOp.fieldDescriptor().name()), fieldLoadOp.resultType());\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATLocalSizeOp.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import hat.optools.OpTk;\n@@ -31,0 +32,1 @@\n+import jdk.incubator.code.dialect.java.JavaOp;\n@@ -34,0 +36,1 @@\n+import java.util.regex.Pattern;\n@@ -64,0 +67,6 @@\n+\n+    static public  final Pattern pattern= Pattern.compile(\"li([xyz])\");\n+\n+   public static  HATLocalThreadIdOp of(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n+        return new HATLocalThreadIdOp(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATLocalThreadIdOp.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -834,0 +834,10 @@\n+    static int dimIdx(String dim){\n+        return switch (dim.substring(2)){\n+            case \"y\"->1;\n+            case \"z\"->2;\n+            default -> 0;\n+        };\n+    }\n+    static int dimIdx(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n+        return dimIdx(fieldLoadOp.fieldDescriptor().name());\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/optools\/OpTk.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -105,1 +105,1 @@\n-            return replace(op, (m)->{});\n+            return replace(op, _->{});\n@@ -142,3 +142,1 @@\n-\n-                    Op.Result result = builder().op(OpTk.copyLocation(op(), replacement));\n-                    trxfmr.opToOp(op(),result.op());\n+                    var result = trxfmr.opToResultOp(op(),builder().op(OpTk.copyLocation(op(), replacement)));\n@@ -243,1 +241,1 @@\n-    private void opToOp(Op from, Op to){\n+    private Op opToOp(Op from, Op to){\n@@ -245,0 +243,5 @@\n+        return to;\n+    }\n+    private Op.Result opToResultOp(Op from, Op.Result result){\n+        opToOp(from, result.op());\n+        return result;\n@@ -256,2 +259,0 @@\n-\n-\n@@ -263,1 +264,5 @@\n-            if ((selected.isEmpty() || selected.contains(op)) &&  predicate.test(op)) {\n+            boolean isEmpty = selected.isEmpty();\n+            boolean isInSelected = selected.contains(op);\n+            boolean isSelected = isEmpty|isInSelected;\n+            boolean passesPredicate = predicate.test(op);\n+            if (isSelected && passesPredicate) {\n@@ -266,1 +271,0 @@\n-\n","filename":"hat\/core\/src\/main\/java\/hat\/optools\/Trxfmr.java","additions":13,"deletions":9,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -28,1 +28,0 @@\n-import hat.KernelContext;\n@@ -37,3 +36,0 @@\n-import jdk.incubator.code.CodeContext;\n-import jdk.incubator.code.CodeElement;\n-import jdk.incubator.code.Op;\n@@ -42,3 +38,0 @@\n-\n-import java.util.HashSet;\n-import java.util.LinkedHashSet;\n@@ -46,1 +39,0 @@\n-import java.util.Set;\n@@ -48,2 +40,0 @@\n-import java.util.stream.Collectors;\n-import java.util.stream.Stream;\n@@ -51,1 +41,1 @@\n-public abstract class HATDialectifyThreadsPhase implements HATDialect  {\n+public abstract class HATDialectifyThreadsPhase<T extends HATDialectifyThreadsPhase<T,C>,C extends HATThreadOp> implements HATDialect  {\n@@ -56,0 +46,1 @@\n+    final Class<C> clazz;\n@@ -57,1 +48,1 @@\n-    public HATDialectifyThreadsPhase(Accelerator accelerator) {\n+    public HATDialectifyThreadsPhase(Accelerator accelerator, Class<C> clazz) {\n@@ -59,0 +50,1 @@\n+        this.clazz=clazz;\n@@ -66,1 +58,0 @@\n-\n@@ -68,28 +59,16 @@\n-        var here = OpTk.CallSite.of(this.getClass(), \"apply\");\n-        before(here, funcOp);\n-        Set<Op> ops = new LinkedHashSet<>();\n-        funcOp.elements()\n-                .map(ce -> OpTk.asNamedKernelContextFieldAccessOrNull(accelerator.lookup,ce,pattern()))\n-                .filter(Objects::nonNull)\n-                .forEach(fieldLoadOp -> fieldLoadOp.operands().stream()\n-                    .map(OpTk::asResultOrNull)\n-                    .map(OpTk::opOfResultOrNull)\n-                    .map(OpTk::asVarLoadOrNull)\n-                    .filter(Objects::nonNull) \/\/ ((Result)operand).op()) instanceof VarLoad varload && varload is KernelContext.class\n-                    .findFirst()\n-                    .ifPresent(varLoadOp -> ops.addAll(Set.of(fieldLoadOp,varLoadOp)))\n-                );\n-\n-        funcOp = OpTk.transform(here, funcOp, ops::contains, (bb, op) -> {\n-            CodeContext ctx = bb.context();\n-            switch (op){\n-                case CoreOp.VarAccessOp.VarLoadOp  $->\n-                        ctx.mapValue($.result(), ctx.getValue($.operands().getFirst()));\n-                case JavaOp.FieldAccessOp.FieldLoadOp $->\n-                        ctx.mapValue($.result(), bb.op(OpTk.copyLocation($,factory($))).op().result());\n-                default -> throw new RuntimeException(\"We should never get here\");\n-            }\n-            return bb;\n-        });\n-        after(here,funcOp);\n-        return funcOp;\n+        var txfmr = new Trxfmr(OpTk.CallSite.of(this.getClass()),funcOp);\n+        return txfmr.select(\n+                ce->OpTk.asNamedKernelContextFieldAccessOrNull(accelerator.lookup,ce,pattern())!=null,(s,o)->\n+                   OpTk.operandsAsResults(o)\n+                     .map(OpTk::opOfResultOrNull)\n+                     .map(OpTk::asVarLoadOrNull)\n+                     .filter(Objects::nonNull) \/\/ ((Result)operand).op()) instanceof VarLoad varload && varload is KernelContext.class\n+                     .findFirst()\n+                     .ifPresent(varLoadOp -> s.select(o,varLoadOp))\n+                ).transform(txfmr.selected::contains, c->{\n+                   switch (c.op()){\n+                      case JavaOp.FieldAccessOp.FieldLoadOp $  -> c.replace(factory($));\n+                      case CoreOp.VarAccessOp.VarLoadOp _ -> c.remove();\n+                      default -> {}\n+                }\n+        }).funcOp();\n@@ -97,14 +76,0 @@\n-    public CoreOp.FuncOp applyTxform(CoreOp.FuncOp funcOp) {\n-        return new Trxfmr.Edge.Selector<JavaOp.FieldAccessOp.FieldLoadOp, CoreOp.VarAccessOp.VarLoadOp>()\n-        .select(funcOp, ce->ce instanceof JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp\n-                        && Trxfmr.Edge.kernelContextFieldVarLoad(accelerator.lookup,fieldLoadOp, fieldName->pattern().matcher(fieldName).matches())\n-                        instanceof Trxfmr.Edge<JavaOp.FieldAccessOp.FieldLoadOp,CoreOp.VarAccessOp.VarLoadOp> e? e:null)\n-        .transform(funcOp,c->{\n-            switch (c.op()){\n-                case JavaOp.FieldAccessOp.FieldLoadOp $  -> c.replace(factory($));\n-                case CoreOp.VarAccessOp.VarLoadOp _ -> c.remove();\n-                default -> {}\n-            }\n-        });\n-    }\n-\n@@ -112,4 +77,0 @@\n-    \/\/private boolean isMethodFromHatKernelContext(CoreOp.VarAccessOp.VarLoadOp varLoadOp) {\n-     \/\/   String kernelContextCanonicalName = hat.KernelContext.class.getName();\n-      \/\/  return varLoadOp.resultType().toString().equals(kernelContextCanonicalName);\n-   \/\/ }\n@@ -118,1 +79,1 @@\n-    public static class BlockPhase extends HATDialectifyThreadsPhase  {\n+    public static class BlockPhase extends HATDialectifyThreadsPhase<BlockPhase,HATBlockThreadIdOp> {\n@@ -120,1 +81,1 @@\n-            super(accelerator);\n+            super(accelerator, HATBlockThreadIdOp.class);\n@@ -123,1 +84,1 @@\n-            return Pattern.compile(\"bi[xyz]\");\n+            return HATBlockThreadIdOp.pattern;\n@@ -128,5 +89,1 @@\n-                return new HATBlockThreadIdOp(switch (fieldLoadOp.fieldDescriptor().name()){\n-                    case \"biy\"->1;\n-                    case \"biz\"->2;\n-                    default -> 0;\n-                }, fieldLoadOp.resultType());\n+                return HATBlockThreadIdOp.of(fieldLoadOp);\n@@ -136,2 +93,1 @@\n-    public static class GlobalIdPhase extends HATDialectifyThreadsPhase  {\n-\n+    public static class GlobalIdPhase extends HATDialectifyThreadsPhase<GlobalIdPhase,HATGlobalThreadIdOp>  {\n@@ -139,1 +95,1 @@\n-            super(accelerator);\n+            super(accelerator, HATGlobalThreadIdOp.class);\n@@ -142,1 +98,1 @@\n-            return Pattern.compile(\"(gi[xyz])\");\n+            return HATGlobalThreadIdOp.pattern;\n@@ -146,5 +102,1 @@\n-                return new HATGlobalThreadIdOp(switch (fieldLoadOp.fieldDescriptor().name()){\n-                    case \"y\", \"giy\"->1;\n-                    case \"z\", \"giz\"->2;\n-                    default -> 0;\n-                }, fieldLoadOp.resultType());\n+                return new HATGlobalThreadIdOp(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n@@ -154,1 +106,1 @@\n-    public static class GlobalSizePhase extends HATDialectifyThreadsPhase  {\n+    public static class GlobalSizePhase extends HATDialectifyThreadsPhase<GlobalSizePhase,HATGlobalSizeOp>  {\n@@ -156,1 +108,1 @@\n-            super(accelerator);\n+            super(accelerator, HATGlobalSizeOp.class);\n@@ -159,1 +111,1 @@\n-            return Pattern.compile(\"(gs[xyz])\");\n+            return HATGlobalSizeOp.pattern;\n@@ -163,5 +115,1 @@\n-                return new HATGlobalSizeOp(switch (fieldLoadOp.fieldDescriptor().name()){\n-                    case \"gsy\",\"maxY\"->1;\n-                    case \"gsz\",\"maxZ\"->2;\n-                    default -> 0;\n-                }, fieldLoadOp.resultType());\n+                return  HATGlobalSizeOp.of(fieldLoadOp);\n@@ -169,2 +117,0 @@\n-\n-\n@@ -173,1 +119,1 @@\n-    public static class LocalIdPhase extends HATDialectifyThreadsPhase  {\n+    public static class LocalIdPhase extends HATDialectifyThreadsPhase<LocalIdPhase,HATLocalThreadIdOp>  {\n@@ -175,1 +121,1 @@\n-            super(accelerator);\n+            super(accelerator,HATLocalThreadIdOp.class);\n@@ -178,1 +124,1 @@\n-            return  Pattern.compile(\"li([xyz])\");\n+            return HATLocalThreadIdOp.pattern;\n@@ -182,5 +128,1 @@\n-                return new HATLocalThreadIdOp(switch (fieldLoadOp.fieldDescriptor().name()){\n-                    case \"liy\"->1;\n-                    case \"liz\"->2;\n-                    default -> 0;\n-                }, fieldLoadOp.resultType());\n+                return HATLocalThreadIdOp.of(fieldLoadOp);\n@@ -190,1 +132,1 @@\n-    public static class LocalSizePhase extends HATDialectifyThreadsPhase  {\n+    public static class LocalSizePhase extends HATDialectifyThreadsPhase<LocalSizePhase,HATLocalSizeOp>  {\n@@ -192,1 +134,1 @@\n-            super(accelerator);\n+            super(accelerator,HATLocalSizeOp.class);\n@@ -194,2 +136,2 @@\n-        @Override protected Pattern pattern(){\n-            return  Pattern.compile(\"ls([xyz])\");\n+        @Override public Pattern pattern(){\n+           return HATLocalSizeOp.pattern;\n@@ -199,5 +141,1 @@\n-                return new HATLocalSizeOp(switch (fieldLoadOp.fieldDescriptor().name()){\n-                    case \"lsy\"->1;\n-                    case \"lsz\"->2;\n-                    default -> 0;\n-                }, fieldLoadOp.resultType());\n+            return HATLocalSizeOp.of(fieldLoadOp);\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATDialectifyThreadsPhase.java","additions":41,"deletions":103,"binary":false,"changes":144,"status":"modified"}]}