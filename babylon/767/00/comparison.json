{"files":[{"patch":"@@ -44,0 +44,1 @@\n+import java.lang.foreign.Arena;\n@@ -360,1 +361,1 @@\n-        super(\"cuda_backend\", config);\n+        super(Arena.global(), MethodHandles.lookup(),\"cuda_backend\", config);\n@@ -413,1 +414,1 @@\n-            loweredFunc = transformPTXPtrs(kernelCallGraph.computeContext.accelerator.lookup,loweredFunc, argsMap, usedMathFns);\n+            loweredFunc = transformPTXPtrs(kernelCallGraph.computeContext.accelerator.lookup(),loweredFunc, argsMap, usedMathFns);\n@@ -418,1 +419,1 @@\n-        CoreOp.FuncOp loweredPtx = transformPTXPtrs(kernelCallGraph.computeContext.accelerator.lookup,lowered, argsMap, usedMathFns);\n+        CoreOp.FuncOp loweredPtx = transformPTXPtrs(kernelCallGraph.computeContext.accelerator.lookup(),lowered, argsMap, usedMathFns);\n","filename":"hat\/backends\/ffi\/cuda\/src\/main\/java\/hat\/backend\/ffi\/CudaBackend.java","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -33,5 +33,2 @@\n-public class MockBackend extends FFIBackend {\n-    \/\/final FFILib.LongIntMethodPtr getBackend_MPtr;\n-    \/\/public long getBackend(int mode) {\n-      \/\/ return getBackend_MPtr.invoke(mode);\n-   \/\/ }\n+import java.lang.foreign.Arena;\n+import java.lang.invoke.MethodHandles;\n@@ -39,0 +36,1 @@\n+public class MockBackend extends FFIBackend {\n@@ -40,4 +38,2 @@\n-    public MockBackend() {\n-        super(\"mock_backend\", Config.fromIntBits(0));\n-       \/\/ getBackend_MPtr  =  ffiLib.longIntFunc(\"getMockBackend\");\n-       \/\/ getBackend(0);\n+    public MockBackend(Arena arena, MethodHandles.Lookup lookup) {\n+        super(arena,lookup,\"mock_backend\", Config.fromIntBits(0));\n","filename":"hat\/backends\/ffi\/mock\/src\/main\/java\/hat\/backend\/ffi\/MockBackend.java","additions":5,"deletions":9,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -27,0 +27,3 @@\n+import java.lang.foreign.Arena;\n+import java.lang.invoke.MethodHandles;\n+\n@@ -30,1 +33,1 @@\n-        MockBackend mockBackend = new MockBackend();\n+        MockBackend mockBackend = new MockBackend(Arena.global(), MethodHandles.lookup());\n","filename":"hat\/backends\/ffi\/mock\/src\/main\/java\/hat\/backend\/ffi\/MockDeviceInfo.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -33,0 +33,3 @@\n+import java.lang.foreign.Arena;\n+import java.lang.invoke.MethodHandles;\n+\n@@ -35,1 +38,1 @@\n-        super(\"opencl_backend\", config);\n+        super(Arena.global(), MethodHandles.lookup(),\"opencl_backend\", config);\n","filename":"hat\/backends\/ffi\/opencl\/src\/main\/java\/hat\/backend\/ffi\/OpenCLBackend.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -51,0 +51,2 @@\n+import java.lang.foreign.Arena;\n+import java.lang.invoke.MethodHandles;\n@@ -63,2 +65,2 @@\n-    public C99FFIBackend(String libName, Config config) {\n-        super(libName, config);\n+    public C99FFIBackend(Arena arena, MethodHandles.Lookup lookup,String libName, Config config) {\n+        super(arena,lookup,libName, config);\n@@ -263,1 +265,1 @@\n-                    Class<?> clazz = (Class<?>) ((ClassType) typeElement).resolve(kernelCallGraph.computeContext.accelerator.lookup);\n+                    Class<?> clazz = (Class<?>) ((ClassType) typeElement).resolve(kernelCallGraph.computeContext.accelerator.lookup());\n@@ -282,1 +284,1 @@\n-                    new ScopedCodeBuilderContext(kernelCallGraph.entrypoint.callGraph.computeContext.accelerator.lookup,\n+                    new ScopedCodeBuilderContext(kernelCallGraph.entrypoint.callGraph.computeContext.accelerator.lookup(),\n","filename":"hat\/backends\/ffi\/shared\/src\/main\/java\/hat\/backend\/ffi\/C99FFIBackend.java","additions":6,"deletions":4,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -56,1 +56,0 @@\n-    public final Arena arena = Arena.global();\n@@ -58,7 +57,2 @@\n-    @Override\n-    public <T extends MappableIface> T allocate(SegmentMapper<T> segmentMapper, BoundSchema<T> boundSchema) {\n-        return segmentMapper.allocate(arena, boundSchema);\n-    }\n-\n-    public FFIBackend(String libName, Config config) {\n-        super(libName, config);\n+    public FFIBackend(Arena arena,MethodHandles.Lookup lookup,String libName, Config config) {\n+        super(arena, lookup,libName, config);\n@@ -76,1 +70,1 @@\n-            Interpreter.invoke(computeContext.accelerator.lookup, computeContext.computeCallGraph.entrypoint.lowered, args);\n+            Interpreter.invoke(computeContext.accelerator.lookup(), computeContext.computeCallGraph.entrypoint.lowered, args);\n@@ -80,1 +74,1 @@\n-                    computeContext.computeCallGraph.entrypoint.mh = BytecodeGenerator.generate(computeContext.accelerator.lookup, computeContext.computeCallGraph.entrypoint.lowered);\n+                    computeContext.computeCallGraph.entrypoint.mh = BytecodeGenerator.generate(computeContext.accelerator.lookup(), computeContext.computeCallGraph.entrypoint.lowered);\n@@ -139,1 +133,1 @@\n-            var lookup = computeMethod.callGraph.computeContext.accelerator.lookup;\n+            var lookup = computeMethod.callGraph.computeContext.accelerator.lookup();\n","filename":"hat\/backends\/ffi\/shared\/src\/main\/java\/hat\/backend\/ffi\/FFIBackend.java","additions":5,"deletions":11,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+import java.lang.invoke.MethodHandles;\n@@ -166,2 +167,2 @@\n-    public FFIBackendDriver(String libName, Config config) {\n-        super(config);\n+    public FFIBackendDriver(Arena arena, MethodHandles.Lookup lookup,String libName, Config config) {\n+        super(arena,lookup,config);\n","filename":"hat\/backends\/ffi\/shared\/src\/main\/java\/hat\/backend\/ffi\/FFIBackendDriver.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -36,2 +36,0 @@\n-\n-\n","filename":"hat\/backends\/java\/mt\/src\/main\/java\/hat\/backend\/java\/JavaMultiThreadedBackend.java","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+import java.lang.foreign.Arena;\n@@ -35,0 +36,1 @@\n+import java.lang.invoke.MethodHandles;\n@@ -38,0 +40,1 @@\n+\n@@ -49,1 +52,1 @@\n-        super(config,\"opencl_backend\");\n+        super(Arena.global(), MethodHandles.lookup(),config,\"opencl_backend\");\n","filename":"hat\/backends\/jextracted\/opencl\/src\/main\/java\/hat\/backend\/jextracted\/OpenCLBackend.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -41,0 +41,2 @@\n+import java.lang.foreign.Arena;\n+import java.lang.invoke.MethodHandles;\n@@ -48,2 +50,2 @@\n-    public C99JExtractedBackend(Config config,String libName) {\n-        super(config,libName);\n+    public C99JExtractedBackend(Arena arena, MethodHandles.Lookup lookup,Config config, String libName) {\n+        super(arena,lookup,config,libName);\n@@ -95,1 +97,1 @@\n-        ScopedCodeBuilderContext buildContext = new ScopedCodeBuilderContext(kernelCallGraph.computeContext.accelerator.lookup\n+        ScopedCodeBuilderContext buildContext = new ScopedCodeBuilderContext(kernelCallGraph.computeContext.accelerator.lookup()\n","filename":"hat\/backends\/jextracted\/shared\/src\/main\/java\/hat\/backend\/jextracted\/C99JExtractedBackend.java","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -46,0 +46,1 @@\n+import java.lang.invoke.MethodHandles;\n@@ -51,1 +52,0 @@\n-    public final Arena arena = Arena.global();\n@@ -53,7 +53,2 @@\n-    @Override\n-    public <T extends MappableIface> T allocate(SegmentMapper<T> segmentMapper, BoundSchema<T> boundSchema) {\n-        return segmentMapper.allocate(arena, boundSchema);\n-    }\n-\n-    public JExtractedBackend(Config config, String libName) {\n-        super(config,libName);\n+    public JExtractedBackend(Arena arena, MethodHandles.Lookup lookup,Config config, String libName) {\n+        super(arena,lookup,config,libName);\n@@ -70,1 +65,1 @@\n-            Interpreter.invoke(computeContext.accelerator.lookup, computeContext.computeCallGraph.entrypoint.lowered, args);\n+            Interpreter.invoke(computeContext.accelerator.lookup(), computeContext.computeCallGraph.entrypoint.lowered, args);\n@@ -74,1 +69,1 @@\n-                    computeContext.computeCallGraph.entrypoint.mh = BytecodeGenerator.generate(computeContext.accelerator.lookup, computeContext.computeCallGraph.entrypoint.lowered);\n+                    computeContext.computeCallGraph.entrypoint.mh = BytecodeGenerator.generate(computeContext.accelerator.lookup(), computeContext.computeCallGraph.entrypoint.lowered);\n@@ -88,1 +83,1 @@\n-        var lookup = computeMethod.callGraph.computeContext.accelerator.lookup;\n+        var lookup = computeMethod.callGraph.computeContext.accelerator.lookup();\n","filename":"hat\/backends\/jextracted\/shared\/src\/main\/java\/hat\/backend\/jextracted\/JExtractedBackend.java","additions":6,"deletions":11,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -33,0 +33,1 @@\n+import java.lang.invoke.MethodHandles;\n@@ -35,0 +36,1 @@\n+\n@@ -63,2 +65,2 @@\n-    public JExtractedBackendDriver(Config config,String libName) {\n-      super(config);\n+    public JExtractedBackendDriver(Arena arena, MethodHandles.Lookup lookup,Config config, String libName) {\n+      super(arena,lookup,config);\n","filename":"hat\/backends\/jextracted\/shared\/src\/main\/java\/hat\/backend\/jextracted\/JExtractedBackendDriver.java","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+import java.lang.foreign.Arena;\n@@ -44,0 +45,1 @@\n+import optkl.LookupCarrier;\n@@ -78,2 +80,4 @@\n-public class Accelerator implements BufferAllocator, BufferTracker {\n-    public MethodHandles.Lookup lookup;\n+public class Accelerator implements BufferAllocator, BufferTracker, LookupCarrier {\n+\n+    private MethodHandles.Lookup lookup;\n+    @Override public MethodHandles.Lookup lookup(){return lookup;}\n@@ -82,0 +86,1 @@\n+\n@@ -112,5 +117,0 @@\n-    @Override\n-    public <T extends MappableIface> T allocate(SegmentMapper<T> segmentMapper, BoundSchema<T> boundShema) {\n-        return backend.allocate(segmentMapper, boundShema);\n-    }\n-\n@@ -145,0 +145,5 @@\n+    @Override\n+    public Arena arena() {\n+        return backend.arena();\n+    }\n+\n","filename":"hat\/core\/src\/main\/java\/hat\/Accelerator.java","additions":12,"deletions":7,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -41,0 +41,1 @@\n+import java.lang.foreign.Arena;\n@@ -66,0 +67,5 @@\n+    @Override\n+    public Arena arena() {\n+        return accelerator.arena();\n+    }\n+\n@@ -171,5 +177,0 @@\n-    @Override\n-    public <T extends MappableIface> T allocate(SegmentMapper<T> segmentMapper, BoundSchema<T> boundSchema) {\n-        return accelerator.allocate(segmentMapper, boundSchema);\n-    }\n-\n","filename":"hat\/core\/src\/main\/java\/hat\/ComputeContext.java","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+import optkl.LookupCarrier;\n@@ -36,0 +37,2 @@\n+import java.lang.foreign.Arena;\n+import java.lang.invoke.MethodHandles;\n@@ -39,1 +42,1 @@\n-public  abstract class Backend implements BufferAllocator {\n+public  abstract class Backend implements BufferAllocator, LookupCarrier {\n@@ -46,1 +49,12 @@\n-    protected Backend(Config config){\n+    private final Arena arena;\n+    @Override public Arena arena(){\n+        return arena;\n+    }\n+    private final MethodHandles.Lookup lookup;\n+    @Override public MethodHandles.Lookup lookup(){\n+        return lookup;\n+    }\n+\n+    protected Backend(Arena arena, MethodHandles.Lookup lookup,Config config){\n+        this.lookup = lookup;\n+        this.arena =arena;\n","filename":"hat\/core\/src\/main\/java\/hat\/backend\/Backend.java","additions":16,"deletions":2,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+import java.lang.invoke.MethodHandles;\n@@ -40,2 +41,3 @@\n-    BackendAdaptor(Config config) {\n-        super(config);\n+\n+    BackendAdaptor(Arena arena, MethodHandles.Lookup lookup,Config config) {\n+        super(arena,lookup,config);\n@@ -73,4 +75,0 @@\n-    @Override\n-    public <T extends MappableIface> T allocate(SegmentMapper<T> segmentMapper, BoundSchema<T> boundSchema) {\n-        return segmentMapper.allocate(Arena.global(), boundSchema);\n-    }\n","filename":"hat\/core\/src\/main\/java\/hat\/backend\/BackendAdaptor.java","additions":4,"deletions":6,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -33,0 +33,2 @@\n+import java.lang.foreign.Arena;\n+import java.lang.invoke.MethodHandles;\n@@ -42,0 +44,2 @@\n+\n+\n@@ -47,2 +51,2 @@\n-    public DebugBackend(){\n-       this(HowToRunCompute.REFLECT, HowToRunKernel.REFLECT);\n+    public DebugBackend(Arena arena, MethodHandles.Lookup lookup){\n+       this(arena,lookup,HowToRunCompute.REFLECT, HowToRunKernel.REFLECT);\n@@ -51,2 +55,3 @@\n-    public DebugBackend(HowToRunCompute howToRunCompute, HowToRunKernel howToRunKernel){\n-        super(Config.fromEnvOrProperty());\n+    public DebugBackend(Arena arena,MethodHandles.Lookup lookup,HowToRunCompute howToRunCompute, HowToRunKernel howToRunKernel){\n+\n+        super(arena,lookup,Config.fromEnvOrProperty());\n@@ -74,1 +79,1 @@\n-                Interpreter.invoke(computeContext.accelerator.lookup, computeContext.computeCallGraph.entrypoint.lowered, args);\n+                Interpreter.invoke(computeContext.accelerator.lookup(), computeContext.computeCallGraph.entrypoint.lowered, args);\n@@ -83,1 +88,1 @@\n-                        computeContext.computeCallGraph.entrypoint.mh = BytecodeGenerator.generate(computeContext.accelerator.lookup, computeContext.computeCallGraph.entrypoint.lowered);\n+                        computeContext.computeCallGraph.entrypoint.mh = BytecodeGenerator.generate(computeContext.accelerator.lookup(), computeContext.computeCallGraph.entrypoint.lowered);\n@@ -116,1 +121,1 @@\n-                Interpreter.invoke(kernelCallGraph.computeContext.accelerator.lookup, lowered, args);\n+                Interpreter.invoke(kernelCallGraph.computeContext.accelerator.lookup(), lowered, args);\n@@ -121,1 +126,1 @@\n-                var mh = BytecodeGenerator.generate(kernelCallGraph.computeContext.accelerator.lookup, lowered);\n+                var mh = BytecodeGenerator.generate(kernelCallGraph.computeContext.accelerator.lookup(), lowered);\n","filename":"hat\/core\/src\/main\/java\/hat\/backend\/DebugBackend.java","additions":13,"deletions":8,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -36,0 +36,1 @@\n+import java.lang.invoke.MethodHandles;\n@@ -41,1 +42,0 @@\n-    public final Arena arena = Arena.global();\n@@ -43,4 +43,0 @@\n-    @Override\n-    public <T extends MappableIface> T allocate(SegmentMapper<T> segmentMapper, BoundSchema<T> boundSchema){\n-        return segmentMapper.allocate(arena, boundSchema);\n-    }\n@@ -62,1 +58,1 @@\n-        super(config);\n+        super(Arena.global(), MethodHandles.lookup(),config);\n","filename":"hat\/core\/src\/main\/java\/hat\/backend\/java\/JavaBackend.java","additions":2,"deletions":6,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -125,1 +125,1 @@\n-        setModuleOp(OpTk.createTransitiveInvokeModule(computeContext.accelerator.lookup, entrypoint.funcOp(), this));\n+        setModuleOp(OpTk.createTransitiveInvokeModule(computeContext.accelerator.lookup(), entrypoint.funcOp(), this));\n@@ -148,1 +148,1 @@\n-        MethodHandles.Lookup lookup =  computeReachableResolvedMethodCall.callGraph.computeContext.accelerator.lookup;\n+        MethodHandles.Lookup lookup =  computeReachableResolvedMethodCall.callGraph.computeContext.accelerator.lookup();\n@@ -220,2 +220,2 @@\n-        if (entrypoint.method.getDeclaringClass().equals(OpTk.javaRefClassOrThrow(computeContext.accelerator.lookup,invokeOp))\n-                && isKernelDispatch(computeContext.accelerator.lookup,method, f)) {\n+        if (entrypoint.method.getDeclaringClass().equals(OpTk.javaRefClassOrThrow(computeContext.accelerator.lookup(),invokeOp))\n+                && isKernelDispatch(computeContext.accelerator.lookup(),method, f)) {\n","filename":"hat\/core\/src\/main\/java\/hat\/callgraph\/ComputeCallGraph.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -83,1 +83,1 @@\n-        bufferAccessList = BufferTagger.getAccessList(computeContext.accelerator.lookup, entrypoint.funcOp());\n+        bufferAccessList = BufferTagger.getAccessList(computeContext.accelerator.lookup(), entrypoint.funcOp());\n@@ -85,1 +85,1 @@\n-        CoreOp.ModuleOp initialModuleOp = OpTk.createTransitiveInvokeModule(computeContext.accelerator.lookup, entrypoint.funcOp(), this);\n+        CoreOp.ModuleOp initialModuleOp = OpTk.createTransitiveInvokeModule(computeContext.accelerator.lookup(), entrypoint.funcOp(), this);\n@@ -111,2 +111,2 @@\n-                Class<?> javaRefTypeClass = OpTk.javaRefClassOrThrow(kernelReachableResolvedMethodCall.callGraph.computeContext.accelerator.lookup,invokeOp);\n-                Method invokeOpCalledMethod = OpTk.methodOrThrow(kernelReachableResolvedMethodCall.callGraph.computeContext.accelerator.lookup,invokeOp);\n+                Class<?> javaRefTypeClass = OpTk.javaRefClassOrThrow(kernelReachableResolvedMethodCall.callGraph.computeContext.accelerator.lookup(),invokeOp);\n+                Method invokeOpCalledMethod = OpTk.methodOrThrow(kernelReachableResolvedMethodCall.callGraph.computeContext.accelerator.lookup(),invokeOp);\n","filename":"hat\/core\/src\/main\/java\/hat\/callgraph\/KernelCallGraph.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+import java.lang.foreign.Arena;\n@@ -37,1 +38,4 @@\n-\n+     private final Arena arena;\n+    @Override public Arena arena(){\n+        return arena;\n+    }\n@@ -40,0 +44,4 @@\n+\n+    @Override public MethodHandles.Lookup lookup() {\n+        return lookup;\n+    }\n@@ -49,1 +57,1 @@\n-    protected AbstractSegmentMapper(MethodHandles.Lookup lookup,\n+    protected AbstractSegmentMapper(Arena arena,MethodHandles.Lookup lookup,\n@@ -58,0 +66,1 @@\n+        this.arena = arena;\n@@ -63,1 +72,1 @@\n-        this.mapperCache = MapperCache.of(lookup);\n+        this.mapperCache = MapperCache.of(arena,lookup);\n@@ -65,8 +74,0 @@\n-\n-     \/*   List<Method> unsupportedAccessors = accessors.stream(k -> !k.isSupportedFor(valueType))\n-                .map(AccessorInfo::method)\n-                .toList();\n-        if (!unsupportedAccessors.isEmpty()) {\n-            throw new IllegalArgumentException(\n-                    \"The following accessors are not supported for \" + valueType + \": \" + unsupportedAccessors);\n-        } *\/\n@@ -102,3 +103,0 @@\n-    protected final MethodHandles.Lookup lookup() {\n-        return lookup;\n-    }\n","filename":"hat\/core\/src\/main\/java\/hat\/ifacemapper\/AbstractSegmentMapper.java","additions":12,"deletions":14,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import java.lang.foreign.Arena;\n@@ -119,1 +120,1 @@\n-        return bufferAllocator.allocate(SegmentMapper.of(lookup, schema.iface, groupLayout, this), this);\n+        return bufferAllocator.allocates(SegmentMapper.of(bufferAllocator.arena(),lookup, schema.iface, groupLayout, this), this);\n","filename":"hat\/core\/src\/main\/java\/hat\/ifacemapper\/BoundSchema.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -27,2 +27,8 @@\n-public interface BufferAllocator {\n-    <T extends MappableIface>T allocate(SegmentMapper<T> segmentMapper, BoundSchema<T> buffer);\n+import optkl.ArenaCarrier;\n+\n+import java.lang.foreign.Arena;\n+\n+public interface BufferAllocator extends ArenaCarrier {\n+    default  <T extends MappableIface> T allocates(SegmentMapper<T> segmentMapper, BoundSchema<T> boundSchema) {\n+            return segmentMapper.allocate(boundSchema);\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/ifacemapper\/BufferAllocator.java","additions":8,"deletions":2,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import java.lang.foreign.Arena;\n@@ -45,0 +46,1 @@\n+    private final Arena arena;\n@@ -48,1 +50,2 @@\n-    private MapperCache(MethodHandles.Lookup lookup) {\n+    private MapperCache(Arena arena,MethodHandles.Lookup lookup) {\n+        this.arena = arena;\n@@ -64,1 +67,1 @@\n-                SegmentMapper.of(lookup, k.type(), k.layout()));\n+                SegmentMapper.of(arena,lookup, k.type(), k.layout()));\n@@ -80,2 +83,2 @@\n-    static MapperCache of(MethodHandles.Lookup lookup) {\n-        return new MapperCache(lookup);\n+    static MapperCache of(Arena arena,MethodHandles.Lookup lookup) {\n+        return new MapperCache(arena,lookup);\n","filename":"hat\/core\/src\/main\/java\/hat\/ifacemapper\/MapperCache.java","additions":7,"deletions":4,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -72,1 +72,1 @@\n-        T instance = (T) boundSchema.allocate(accelerator.lookup, accelerator);\n+        T instance = (T) boundSchema.allocate(accelerator.lookup(), accelerator);\n","filename":"hat\/core\/src\/main\/java\/hat\/ifacemapper\/Schema.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+import java.lang.foreign.Arena;\n@@ -79,1 +80,2 @@\n-    private SegmentInterfaceMapper(MethodHandles.Lookup lookup,\n+    private SegmentInterfaceMapper(Arena arena,\n+                                   MethodHandles.Lookup lookup,\n@@ -85,1 +87,1 @@\n-        super(lookup, type, layout, boundSchema,leaf,\n+        super(arena,lookup, type, layout, boundSchema,leaf,\n@@ -145,1 +147,1 @@\n-        return new Mapped<>(lookup(), newType ,layout(),boundSchema(), getHandle(), toMapper);\n+        return new Mapped<>(arena(),lookup(), newType ,layout(),boundSchema(), getHandle(), toMapper);\n@@ -420,1 +422,1 @@\n-    public static <T> SegmentInterfaceMapper<T> create(MethodHandles.Lookup lookup,\n+    public static <T> SegmentInterfaceMapper<T> create(Arena arena,MethodHandles.Lookup lookup,\n@@ -424,1 +426,1 @@\n-        return new SegmentInterfaceMapper<>(lookup, type,  layout, boundSchema, false, new ArrayList<>());\n+        return new SegmentInterfaceMapper<>(arena,lookup, type,  layout, boundSchema, false, new ArrayList<>());\n@@ -441,0 +443,1 @@\n+            Arena arena,\n@@ -460,1 +463,1 @@\n-        Mapped(MethodHandles.Lookup lookup,\n+        Mapped(Arena arena,MethodHandles.Lookup lookup,\n@@ -467,0 +470,1 @@\n+            this.arena =arena;\n@@ -484,1 +488,1 @@\n-            return new Mapped<>(lookup, newType,  layout(), boundSchema(), getHandle(), toMapper);\n+            return new Mapped<>(arena(),lookup, newType,  layout(), boundSchema(), getHandle(), toMapper);\n","filename":"hat\/core\/src\/main\/java\/hat\/ifacemapper\/SegmentInterfaceMapper.java","additions":11,"deletions":7,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -29,0 +29,3 @@\n+import optkl.ArenaCarrier;\n+import optkl.LookupCarrier;\n+\n@@ -245,2 +248,1 @@\n- *     SegmentMapper<PointAccessor> mapper =\n- *             SegmentMapper.of(MethodHandles.lookup(), PointAccessor.class, POINT);\n+ *\n@@ -249,0 +251,2 @@\n+ *      SegmentMapper<PointAccessor> mapper =\n+ *  *             SegmentMapper.of(arena,MethodHandles.lookup(), PointAccessor.class, POINT);\n@@ -303,1 +307,1 @@\n-public interface SegmentMapper<T> {\n+public interface SegmentMapper<T>  extends ArenaCarrier, LookupCarrier {\n@@ -332,2 +336,1 @@\n-     * @param arena from which to {@linkplain Arena#allocate(MemoryLayout) allocate} an\n-     *              internal memory segment.\n+\n@@ -346,1 +349,1 @@\n-    default T allocate(Arena arena, BoundSchema<?> boundSchema) {\n+    default T allocate(BoundSchema<?> boundSchema) {\n@@ -351,1 +354,1 @@\n-        var segment = arena.allocate(BufferState.getLayoutSizeAfterPadding(layout()) + BufferState.byteSize(), BufferState.alignment);\n+        var segment = arena().allocate(BufferState.getLayoutSizeAfterPadding(layout()) + BufferState.byteSize(), BufferState.alignment);\n@@ -695,1 +698,1 @@\n-    static <T> SegmentMapper<T> of(MethodHandles.Lookup lookup,\n+    static <T> SegmentMapper<T> of(Arena arena,MethodHandles.Lookup lookup,\n@@ -701,1 +704,1 @@\n-        return SegmentInterfaceMapper.create(lookup, type, layout, null);\n+        return SegmentInterfaceMapper.create(arena,lookup, type, layout, null);\n@@ -704,1 +707,1 @@\n-    static <T extends MappableIface> SegmentMapper<T> of(MethodHandles.Lookup lookup, Class<T> type, GroupLayout layout, BoundSchema<?> boundSchema) {\n+    static <T extends MappableIface> SegmentMapper<T> of(Arena arena,MethodHandles.Lookup lookup, Class<T> type, GroupLayout layout, BoundSchema<?> boundSchema) {\n@@ -708,1 +711,1 @@\n-        return SegmentInterfaceMapper.create(lookup, type, layout, boundSchema);\n+        return SegmentInterfaceMapper.create(arena,lookup, type, layout, boundSchema);\n@@ -713,1 +716,1 @@\n-    static <T> SegmentMapper<T> of(MethodHandles.Lookup lookup,\n+    static <T> SegmentMapper<T> of(Arena arena,MethodHandles.Lookup lookup,\n@@ -718,1 +721,1 @@\n-        return of(lookup, type, structlayout);\n+        return of(arena,lookup, type, structlayout);\n","filename":"hat\/core\/src\/main\/java\/hat\/ifacemapper\/SegmentMapper.java","additions":16,"deletions":13,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -180,1 +180,1 @@\n-                Class<?> javaRefTypeClass = javaRefClassOrThrow(callGraph.computeContext.accelerator.lookup, invokeOp);\n+                Class<?> javaRefTypeClass = javaRefClassOrThrow(callGraph.computeContext.accelerator.lookup(), invokeOp);\n","filename":"hat\/core\/src\/main\/java\/hat\/optools\/OpTk.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -48,1 +48,1 @@\n-        MethodHandles.Lookup l = accelerator.lookup;\n+        MethodHandles.Lookup l = accelerator.lookup();\n@@ -310,1 +310,1 @@\n-                return _V.class.isAssignableFrom((Class<?>) ct.resolve(accelerator.lookup));\n+                return _V.class.isAssignableFrom((Class<?>) ct.resolve(accelerator.lookup()));\n@@ -370,2 +370,2 @@\n-                        (OpTk.isAssignable(accelerator.lookup, javaType, MappableIface.class)\n-                                || OpTk.isAssignable(accelerator.lookup, javaType, DeviceType.class))));\n+                        (OpTk.isAssignable(accelerator.lookup(), javaType, MappableIface.class)\n+                                || OpTk.isAssignable(accelerator.lookup(), javaType, DeviceType.class))));\n@@ -391,1 +391,1 @@\n-                return ((Class<?>) classType.resolve(accelerator.lookup));\n+                return ((Class<?>) classType.resolve(accelerator.lookup()));\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATDialectifyArrayViewPhase.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -43,1 +43,1 @@\n-                \/* filter op                    *\/ ce -> OpTk.isKernelContextInvokeOp(accelerator.lookup, ce,\n+                \/* filter op                    *\/ ce -> OpTk.isKernelContextInvokeOp(accelerator.lookup(), ce,\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATDialectifyBarrierPhase.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -130,1 +130,1 @@\n-            if (OpTk.isIfaceBufferInvokeOpWithName(accelerator.lookup, invokeOp, n->n.equals(HATPrivateVarOp.INTRINSIC_NAME))) {\n+            if (OpTk.isIfaceBufferInvokeOpWithName(accelerator.lookup(), invokeOp, n->n.equals(HATPrivateVarOp.INTRINSIC_NAME))) {\n@@ -134,1 +134,1 @@\n-                        && OpTk.isAssignable(accelerator.lookup,invokeOp.invokeDescriptor().refType(),DeviceType.class);\n+                        && OpTk.isAssignable(accelerator.lookup(),invokeOp.invokeDescriptor().refType(),DeviceType.class);\n@@ -160,1 +160,1 @@\n-            if (OpTk.isIfaceBufferInvokeOpWithName(accelerator.lookup,invokeOp, n->n.equals(HATLocalVarOp.INTRINSIC_NAME))) {\n+            if (OpTk.isIfaceBufferInvokeOpWithName(accelerator.lookup(),invokeOp, n->n.equals(HATLocalVarOp.INTRINSIC_NAME))) {\n@@ -165,1 +165,1 @@\n-                        OpTk.isAssignable(accelerator.lookup,javaType,DeviceType.class));\n+                        OpTk.isAssignable(accelerator.lookup(),javaType,DeviceType.class));\n@@ -191,1 +191,1 @@\n-            return OpTk.isIfaceBufferInvokeOpWithName(accelerator.lookup,invokeOp, n->n.equals(HATLocalVarOp.INTRINSIC_NAME))\n+            return OpTk.isIfaceBufferInvokeOpWithName(accelerator.lookup(),invokeOp, n->n.equals(HATLocalVarOp.INTRINSIC_NAME))\n@@ -194,1 +194,1 @@\n-                    OpTk.isAssignable(accelerator.lookup,javaType,DeviceType.class));\n+                    OpTk.isAssignable(accelerator.lookup(),javaType,DeviceType.class));\n@@ -202,1 +202,1 @@\n-            return OpTk.isInvokeDescriptorSubtypeOf(accelerator.lookup,invokeOp, DeviceType.class)\n+            return OpTk.isInvokeDescriptorSubtypeOf(accelerator.lookup(),invokeOp, DeviceType.class)\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATDialectifyMemoryPhase.java","additions":7,"deletions":7,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -61,1 +61,1 @@\n-                ce->OpTk.asNamedKernelContextFieldAccessOrNull(accelerator.lookup,ce,pattern())!=null,(s,o)->\n+                ce->OpTk.asNamedKernelContextFieldAccessOrNull(accelerator.lookup(),ce,pattern())!=null,(s,o)->\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATDialectifyThreadsPhase.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -114,1 +114,1 @@\n-                   && OpTk.isAssignable(accelerator.lookup, jt, _V.class)\n+                   && OpTk.isAssignable(accelerator.lookup(), jt, _V.class)\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATDialectifyVectorOpPhase.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -145,1 +145,1 @@\n-        var meshDataNew = boundSchema.allocate(accelerator.lookup,accelerator);\n+        var meshDataNew = boundSchema.allocate(accelerator.lookup(),accelerator);\n","filename":"hat\/examples\/experiments\/src\/main\/java\/experiments\/Mesh.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import java.lang.foreign.Arena;\n@@ -37,2 +38,2 @@\n-\n-        Accelerator accelerator = new Accelerator(MethodHandles.lookup(),new DebugBackend());\n+        var lookup =MethodHandles.lookup();\n+        Accelerator accelerator = new Accelerator(lookup,new DebugBackend(Arena.global(),lookup));\n","filename":"hat\/examples\/experiments\/src\/main\/java\/experiments\/S08x3ImageTest.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+import java.lang.foreign.Arena;\n@@ -41,1 +42,2 @@\n-        Accelerator accelerator = new Accelerator(MethodHandles.lookup(),new DebugBackend());\n+        var lookup = MethodHandles.lookup();\n+        Accelerator accelerator = new Accelerator(lookup,new DebugBackend(Arena.global(),MethodHandles.lookup()));\n","filename":"hat\/examples\/experiments\/src\/main\/java\/experiments\/S32ArrayTest.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -6,2 +6,0 @@\n-      <excludeFolder url=\"file:\/\/$MODULE_DIR$\/..\/backends\/ffi\/mock\/cpp\" \/>\n-      <excludeFolder url=\"file:\/\/$MODULE_DIR$\/..\/backends\/ffi\/mock\/include\" \/>\n@@ -10,0 +8,2 @@\n+      <excludeFolder url=\"file:\/\/$MODULE_DIR$\/..\/backends\/ffi\/mock\/cpp\" \/>\n+      <excludeFolder url=\"file:\/\/$MODULE_DIR$\/..\/backends\/ffi\/mock\/include\" \/>\n@@ -15,0 +15,1 @@\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -16,1 +17,1 @@\n-<\/module>\n+<\/module>\n\\ No newline at end of file\n","filename":"hat\/intellij\/backend_ffi_mock.iml","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -12,1 +12,1 @@\n-    <orderEntry type=\"module\" module-name=\"backend_native_shared\" \/>\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -14,1 +14,1 @@\n-<\/module>\n+<\/module>\n\\ No newline at end of file\n","filename":"hat\/intellij\/backend_java_mt.iml","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -12,1 +12,1 @@\n-    <orderEntry type=\"module\" module-name=\"backend_native_shared\" \/>\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -14,1 +14,1 @@\n-<\/module>\n+<\/module>\n\\ No newline at end of file\n","filename":"hat\/intellij\/backend_java_seq.iml","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -12,0 +12,1 @@\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -13,1 +14,1 @@\n-<\/module>\n+<\/module>\n\\ No newline at end of file\n","filename":"hat\/intellij\/example_blackscholes.iml","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -14,0 +14,1 @@\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -15,1 +16,1 @@\n-<\/module>\n+<\/module>\n\\ No newline at end of file\n","filename":"hat\/intellij\/example_heal.iml","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -13,0 +13,1 @@\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -14,1 +15,1 @@\n-<\/module>\n+<\/module>\n\\ No newline at end of file\n","filename":"hat\/intellij\/example_life.iml","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -12,0 +12,1 @@\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -13,1 +14,1 @@\n-<\/module>\n+<\/module>\n\\ No newline at end of file\n","filename":"hat\/intellij\/example_mandel.iml","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -12,0 +12,1 @@\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -13,1 +14,1 @@\n-<\/module>\n+<\/module>\n\\ No newline at end of file\n","filename":"hat\/intellij\/example_matmul.iml","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -16,0 +16,2 @@\n+    <orderEntry type=\"module\" module-name=\"backend_ffi_shared\" \/>\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -19,1 +21,10 @@\n-          <root url=\"jar:\/\/$MODULE_DIR$\/..\/build\/hat-extracted-opengl-1.0.jar!\/\" \/>\n+          <root url=\"jar:\/\/$MODULE_DIR$\/..\/build\/hat-backend-jextracted-opencl-1.0.jar!\/\" \/>\n+        <\/CLASSES>\n+        <JAVADOC \/>\n+        <SOURCES \/>\n+      <\/library>\n+    <\/orderEntry>\n+    <orderEntry type=\"module-library\">\n+      <library>\n+        <CLASSES>\n+          <root url=\"jar:\/\/$MODULE_DIR$\/..\/build\/hat-backend-jextracted-shared-1.0.jar!\/\" \/>\n@@ -28,1 +39,1 @@\n-          <root url=\"jar:\/\/$MODULE_DIR$\/..\/build\/hat-extracted-opencl-1.0.jar!\/\" \/>\n+          <root url=\"jar:\/\/$MODULE_DIR$\/..\/build\/hat-extracted-opengl-1.0.jar!\/\" \/>\n","filename":"hat\/intellij\/example_nbody.iml","additions":13,"deletions":2,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -12,0 +12,1 @@\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -13,1 +14,1 @@\n-<\/module>\n+<\/module>\n\\ No newline at end of file\n","filename":"hat\/intellij\/example_squares.iml","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -13,0 +13,1 @@\n+    <orderEntry type=\"module\" module-name=\"optkl\" \/>\n@@ -14,1 +15,1 @@\n-<\/module>\n+<\/module>\n\\ No newline at end of file\n","filename":"hat\/intellij\/example_violajones.iml","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+package optkl;\n@@ -26,1 +27,1 @@\n-package jdk.jpackage.internal.cli;\n+import java.lang.foreign.Arena;\n@@ -28,4 +29,2 @@\n-\/**\n- * Option scope.\n- *\/\n-interface OptionScope {\n+public interface ArenaCarrier {\n+    Arena arena();\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/ArenaCarrier.java","additions":4,"deletions":5,"binary":false,"changes":9,"previous_filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/OptionScope.java","status":"copied"},{"patch":"@@ -27,6 +27,1 @@\n-public class OpTkl{\n-   public static void main(String[] args){\n-      System.out.println(\"hey\");\n-   }\n-}\n-\n+import java.lang.invoke.MethodHandles;\n@@ -34,0 +29,3 @@\n+public interface LookupCarrier {\n+    MethodHandles.Lookup lookup();\n+}\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/LookupCarrier.java","additions":4,"deletions":6,"binary":false,"changes":10,"previous_filename":"hat\/optkl\/src\/main\/java\/optkl\/OpTkl.java","status":"copied"}]}