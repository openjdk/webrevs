{"files":[{"patch":"@@ -490,2 +490,5 @@\n-                    if (OpTk.javaReturnType(invokeOp) instanceof ClassType) { \/\/ isAssignable?\n-                        oparen();\n+                   \/\/ TODO: extra parenthesis to be removed if we have a dialect to express iface memory access\n+                   boolean needExtraParenthesis = OpTk.needExtraParenthesis(invokeOp);\n+                   when(needExtraParenthesis, _ -> oparen());\n+\n+                   if (OpTk.javaReturnType(invokeOp) instanceof ClassType) { \/\/ isAssignable?\n@@ -496,1 +499,1 @@\n-                    }\n+                   }\n@@ -498,1 +501,4 @@\n-                    recurse(buildContext, instanceResult.op());\n+                   recurse(buildContext, instanceResult.op());\n+\n+                   \/\/ TODO: extra parenthesis to be removed if we have a dialect to express iface memory access\n+                   when(needExtraParenthesis, _ -> cparen());\n@@ -514,4 +520,0 @@\n-                   if (OpTk.javaReturnType(invokeOp) instanceof ClassType) {\n-                       cparen();\n-                   }\n-\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/HATCodeBuilderWithContext.java","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -689,0 +689,23 @@\n+\n+    \/\/ IMPORTANT:\n+    \/\/ When we have patterns like:\n+    \/\/\n+    \/\/ myiFaceArray.array().value(storeAValue);\n+    \/\/\n+    \/\/ We need to generate extra parenthesis to make the struct pointer accessor \"->\" correct.\n+    \/\/ This is a common pattern when we have a IFace type that contains a subtype based on\n+    \/\/ struct or union.\n+    \/\/\n+    \/\/ An example of this is for the type F16Array.\n+    public static boolean needExtraParenthesis(JavaOp.InvokeOp invokeOp) {\n+\n+        \/\/ The following expression checks that the current invokeOp has at least 2 operands:\n+        \/\/ Why 2?\n+        \/\/ - The first one is another invokeOp to load the inner struct from an IFace data structure.\n+        \/\/   The first operand is also assignable.\n+        \/\/ - The second one is the store value, but this depends on the semantics and definition\n+        \/\/   of the user code.\n+        return invokeOp.operands().size() >= 2 && invokeOp.operands().get(0) instanceof Op.Result r1\n+                && r1.op() instanceof JavaOp.InvokeOp invokeOp2\n+                && OpTk.javaReturnType(invokeOp2) instanceof ClassType;\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/optools\/OpTk.java","additions":23,"deletions":0,"binary":false,"changes":23,"status":"modified"}]}