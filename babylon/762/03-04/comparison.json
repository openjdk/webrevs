{"files":[{"patch":"@@ -31,0 +31,1 @@\n+import java.lang.classfile.constantpool.ClassEntry;\n@@ -52,1 +53,0 @@\n-import jdk.incubator.code.CodeTransformer;\n@@ -54,0 +54,1 @@\n+import jdk.incubator.code.CodeTransformer;\n@@ -74,2 +75,1 @@\n-    static byte[] transform(byte[] classBytes) {\n-        ClassModel clm = ClassFile.of().parse(classBytes);\n+    static byte[] transform(ClassModel clm) {\n@@ -197,1 +197,4 @@\n-        for (var arg : args) {\n+        var toUnreflect = new ArrayDeque<>(List.of(args));\n+        var done = new HashSet<String>();\n+        while (!toUnreflect.isEmpty()) {\n+            String arg = toUnreflect.pop();\n@@ -199,3 +202,10 @@\n-            System.out.println(\"unreflecting \" + arg);\n-            Path clsFile = Path.of(Unreflect.class.getResource(arg).toURI());\n-            Files.write(clsFile, transform(Files.readAllBytes(clsFile)));\n+            if (done.add(arg)) {\n+                System.out.println(\"unreflecting \" + arg);\n+                Path clsFile = Path.of(Unreflect.class.getResource(arg).toURI());\n+                ClassModel clm = ClassFile.of().parse(Files.readAllBytes(clsFile));\n+                \/\/ unreflect all nest members\n+                clm.findAttribute(Attributes.nestMembers())\n+                        .ifPresent(nma -> toUnreflect.addAll(\n+                                nma.nestMembers().stream().map(ClassEntry::asInternalName).toList()));\n+                Files.write(clsFile, transform(clm));\n+            }\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/Unreflect.java","additions":17,"deletions":7,"binary":false,"changes":24,"status":"modified"}]}