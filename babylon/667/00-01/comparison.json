{"files":[{"patch":"@@ -0,0 +1,204 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @summary Smoke test for captured values in quotable lambdas.\n+ * @modules jdk.incubator.code\n+ * @run junit TestCaptureQuotable\n+ *\/\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.MethodSource;\n+\n+import jdk.incubator.code.dialect.core.CoreOp.Var;\n+import jdk.incubator.code.Op;\n+import jdk.incubator.code.Quotable;\n+import jdk.incubator.code.Quoted;\n+import jdk.incubator.code.interpreter.Interpreter;\n+import java.lang.invoke.MethodHandles;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.function.IntSupplier;\n+import java.util.function.IntUnaryOperator;\n+import java.util.function.ToIntFunction;\n+import java.util.stream.IntStream;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+public class TestCaptureQuotable {\n+\n+    @ParameterizedTest\n+    @MethodSource(\"ints\")\n+    public void testCaptureIntParam(int x) {\n+        Quotable quotable = (Quotable & IntUnaryOperator)y -> x + y;\n+        Quoted quoted = Op.ofQuotable(quotable).get();\n+        assertEquals(1, quoted.capturedValues().size());\n+        assertEquals(x, ((Var)quoted.capturedValues().values().iterator().next()).value());\n+        List<Object> arguments = new ArrayList<>();\n+        arguments.add(1);\n+        arguments.addAll(quoted.capturedValues().values());\n+        int res = (int)Interpreter.invoke(MethodHandles.lookup(), (Op & Op.Invokable) quoted.op(),\n+                arguments);\n+        assertEquals(x + 1, res);\n+    }\n+\n+    @Test\n+    public void testCaptureThisRefAndIntConstant() {\n+        final int x = 100;\n+        String hello = \"hello\";\n+        Quotable quotable = (Quotable & ToIntFunction<Number>)y -> y.intValue() + hashCode() + hello.length() + x;\n+        Quoted quoted = Op.ofQuotable(quotable).get();\n+        assertEquals(3, quoted.capturedValues().size());\n+        Iterator<Object> it = quoted.capturedValues().values().iterator();\n+        assertEquals(this, it.next());\n+        assertEquals(hello, ((Var)it.next()).value());\n+        assertEquals(x, ((Var)it.next()).value());\n+        List<Object> arguments = new ArrayList<>();\n+        arguments.add(1);\n+        arguments.addAll(quoted.capturedValues().values());\n+        int res = (int)Interpreter.invoke(MethodHandles.lookup(), (Op & Op.Invokable) quoted.op(),\n+                arguments);\n+        assertEquals(x + 1 + hashCode() + hello.length(), res);\n+    }\n+\n+    @Test\n+    public void testCaptureThisInInvocationArg() {\n+        Quotable quotable = (Quotable & ToIntFunction<Number>)y -> y.intValue() + Integer.valueOf(hashCode());\n+        Quoted quoted = Op.ofQuotable(quotable).get();\n+        assertEquals(1, quoted.capturedValues().size());\n+        Iterator<Object> it = quoted.capturedValues().values().iterator();\n+        assertEquals(this, it.next());\n+        List<Object> arguments = new ArrayList<>();\n+        arguments.add(1);\n+        arguments.addAll(quoted.capturedValues().values());\n+        int res = (int)Interpreter.invoke(MethodHandles.lookup(), (Op & Op.Invokable) quoted.op(),\n+                arguments);\n+        assertEquals(1 + hashCode(), res);\n+    }\n+\n+    record R(int i) {}\n+\n+    @Test\n+    public void testCaptureThisInNewArg() {\n+        Quotable quotable = (Quotable & ToIntFunction<Number>)y -> y.intValue() + new R(hashCode()).i;\n+        Quoted quoted = Op.ofQuotable(quotable).get();\n+        assertEquals(1, quoted.capturedValues().size());\n+        Iterator<Object> it = quoted.capturedValues().values().iterator();\n+        assertEquals(this, it.next());\n+        List<Object> arguments = new ArrayList<>();\n+        arguments.add(1);\n+        arguments.addAll(quoted.capturedValues().values());\n+        int res = (int)Interpreter.invoke(MethodHandles.lookup(), (Op & Op.Invokable) quoted.op(),\n+                arguments);\n+        assertEquals(1 + hashCode(), res);\n+    }\n+\n+    @Test\n+    public void testCaptureMany() {\n+        int[] ia = new int[8];\n+        int i1 = ia[0] = 0;\n+        int i2 = ia[1] = 1;\n+        int i3 = ia[2] = 2;\n+        int i4 = ia[3] = 3;\n+        int i5 = ia[4] = 4;\n+        int i6 = ia[5] = 5;\n+        int i7 = ia[6] = 6;\n+        int i8 = ia[7] = 7;\n+\n+        Quotable quotable = (Quotable & IntSupplier) () -> i1 + i2 + i3 + i4 + i5 + i6 + i7 + i8;\n+        Quoted quoted = Op.ofQuotable(quotable).get();\n+        assertEquals(ia.length, quoted.capturedValues().size());\n+        assertEquals(new ArrayList<>(quoted.capturedValues().keySet()), quoted.op().capturedValues());\n+        Iterator<Object> it = quoted.capturedValues().values().iterator();\n+        int i = 0;\n+        while (it.hasNext()) {\n+            int actual = (int) ((Var)it.next()).value();\n+            assertEquals(ia[i++], actual);\n+        }\n+    }\n+\n+    static class Context {\n+        final int x;\n+\n+        Context(int x) {\n+            this.x = x;\n+        }\n+\n+        Quotable quotable() {\n+            return (Quotable & IntUnaryOperator) y -> x + y;\n+        }\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"ints\")\n+    public void testCaptureIntField(int x) {\n+        Context context = new Context(x);\n+        Quotable quotable = context.quotable();\n+        Quoted quoted = Op.ofQuotable(quotable).get();\n+        assertEquals(1, quoted.capturedValues().size());\n+        assertEquals(context, quoted.capturedValues().values().iterator().next());\n+        List<Object> arguments = new ArrayList<>();\n+        arguments.add(1);\n+        arguments.addAll(quoted.capturedValues().values());\n+        int res = (int)Interpreter.invoke(MethodHandles.lookup(), (Op & Op.Invokable) quoted.op(),\n+                arguments);\n+        assertEquals(x + 1, res);\n+    }\n+\n+    public static IntStream ints() {\n+        return IntStream.range(0, 50);\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"ints\")\n+    public void testCaptureReferenceReceiver(int i) {\n+        int prevCount = Box.count;\n+        Quotable quotable = (Quotable & IntUnaryOperator)new Box(i)::add;\n+        Quoted quoted = Op.ofQuotable(quotable).get();\n+        assertEquals(prevCount + 1, Box.count); \/\/ no duplicate receiver computation!\n+        assertEquals(1, quoted.capturedValues().size());\n+        assertEquals(i, ((Box)((Var)quoted.capturedValues().values().iterator().next()).value()).i);\n+        List<Object> arguments = new ArrayList<>();\n+        arguments.add(1);\n+        arguments.addAll(quoted.capturedValues().values());\n+        int res = (int)Interpreter.invoke(MethodHandles.lookup(), (Op & Op.Invokable) quoted.op(),\n+                arguments);\n+        assertEquals(i + 1, res);\n+    }\n+\n+    record Box(int i) {\n+\n+        static int count = 0;\n+\n+        Box {\n+           count++; \/\/ keep track of side-effects\n+        }\n+\n+        int add(int i) {\n+            return i + this.i;\n+        }\n+    }\n+}\n","filename":"test\/langtools\/tools\/javac\/reflect\/TestCaptureQuotable.java","additions":204,"deletions":0,"binary":false,"changes":204,"status":"added"}]}