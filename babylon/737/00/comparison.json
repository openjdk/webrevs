{"files":[{"patch":"@@ -105,2 +105,2 @@\n-        func.traverse(null, (_, op) -> {\n-            if(op instanceof JavaOp.InvokeOp io && resolve(l, io) instanceof CoreOp.FuncOp f) {\n+        func.elements().forEach(e -> {\n+            if (e instanceof JavaOp.InvokeOp io && resolve(l, io) instanceof CoreOp.FuncOp f) {\n@@ -110,1 +110,0 @@\n-            return null;\n@@ -152,1 +151,2 @@\n-        var initializers = module.traverse(new LinkedHashMap<FieldRef, TI>(), (i, op) -> {\n+        LinkedHashMap<FieldRef, TI> initializers = new LinkedHashMap();\n+        module.elements().forEach(op -> {\n@@ -160,2 +160,2 @@\n-                i.compute(flo.fieldDescriptor(), (fd, ti) -> ti == null\n-                        ? new TI(targetType, i.size())\n+                initializers.compute(flo.fieldDescriptor(), (fd, ti) -> ti == null\n+                        ? new TI(targetType, initializers.size())\n@@ -166,1 +166,0 @@\n-            return i;\n","filename":"cr-examples\/onnx\/src\/main\/java\/oracle\/code\/onnx\/compiler\/OnnxTransformer.java","additions":6,"deletions":7,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -69,1 +69,1 @@\n-        f.traverse(null, (_, ce) -> {\n+        f.elements().forEach(ce -> {\n@@ -101,1 +101,0 @@\n-            return null;\n","filename":"cr-examples\/onnx\/src\/main\/java\/oracle\/code\/onnx\/compiler\/TypeConvertor.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -135,1 +135,1 @@\n-        codeModel.traverse(null, (acc, codeElement) -> {\n+        codeModel.elements().forEach(codeElement -> {\n@@ -142,1 +142,0 @@\n-            return acc;\n","filename":"cr-examples\/samples\/src\/main\/java\/oracle\/code\/samples\/HelloCodeReflection.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -217,2 +217,2 @@\n-        codeModel.traverse(null, (map, op) -> {\n-            if (op instanceof JavaOp.InvokeOp invokeOp) {\n+        codeModel.elements().forEach(e -> {\n+            if (e instanceof JavaOp.InvokeOp invokeOp) {\n@@ -237,1 +237,0 @@\n-            return map;\n","filename":"cr-examples\/samples\/src\/main\/java\/oracle\/code\/samples\/MathOptimizer.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -109,1 +109,4 @@\n-        kernel.traverse(null, CodeElement.opVisitor((o, op) -> {\n+        kernel.elements().forEach(e -> {\n+            if (!(e instanceof Op op)) {\n+                return;\n+            }\n@@ -148,2 +151,2 @@\n-                    } catch (ReflectiveOperationException e) {\n-                        throw new IllegalStateException(\"Unsupported field load: \" + flop.fieldDescriptor(), e);\n+                    } catch (ReflectiveOperationException ex) {\n+                        throw new IllegalStateException(\"Unsupported field load: \" + flop.fieldDescriptor(), ex);\n@@ -154,2 +157,2 @@\n-                    } catch (IllegalAccessException e) {\n-                        throw new IllegalStateException(\"Unsupported field load: \" + f, e);\n+                    } catch (IllegalAccessException ex) {\n+                        throw new IllegalStateException(\"Unsupported field load: \" + f, ex);\n@@ -216,3 +219,1 @@\n-\n-            return null;\n-        }));\n+        });\n@@ -1250,1 +1251,1 @@\n-        kernel.traverse(null, (o, codeElement) -> {\n+        kernel.elements().forEach(codeElement -> {\n@@ -1266,1 +1267,0 @@\n-            return null;\n","filename":"cr-examples\/triton\/src\/main\/java\/oracle\/code\/triton\/TritonTransformer.java","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -110,2 +110,2 @@\n-        OpTk.traverse(here, kernelReachableResolvedMethodCall.funcOp(), (map, op) -> {\n-            if (op instanceof JavaOp.InvokeOp invokeOp) {\n+        OpTk.elements(here, kernelReachableResolvedMethodCall.funcOp()).forEach(codeElement -> {\n+            if (codeElement instanceof JavaOp.InvokeOp invokeOp) {\n@@ -137,1 +137,0 @@\n-            return map;\n","filename":"hat\/core\/src\/main\/java\/hat\/callgraph\/KernelCallGraph.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -112,2 +112,2 @@\n-        traverse(here, entry, (map, op) -> {\n-            if (op instanceof JavaOp.InvokeOp invokeOp) {\n+        elements(here, entry).forEach(codeElement -> {\n+            if (codeElement instanceof JavaOp.InvokeOp invokeOp) {\n@@ -127,1 +127,0 @@\n-            return map;\n@@ -570,6 +569,0 @@\n-    public static <T> T traverse(CallSite callSite, CoreOp.FuncOp funcOp, BiFunction<T, CodeElement<?,?>,T> bifunc) {\n-        if (callSite.tracing){\n-            System.out.println(callSite + \" traverse is being deprecated!!\");\n-        }\n-       return  funcOp.traverse(null, bifunc);\n-    }\n","filename":"hat\/core\/src\/main\/java\/hat\/optools\/OpTk.java","additions":2,"deletions":9,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -75,58 +75,0 @@\n-    \/**\n-     * Traverses this code element and any descendant code elements.\n-     * <p>\n-     * Traversal is performed in pre-order, reporting each code element to the visitor.\n-     *\n-     * @param t   the traversing accumulator\n-     * @param v   the code element visitor\n-     * @param <T> accumulator type\n-     * @return the traversing accumulator\n-     *\/\n-    default <T> T traverse(T t, BiFunction<T, CodeElement<?, ?>, T> v) {\n-        t = v.apply(t, this);\n-        for (C r : children()) {\n-            t = r.traverse(t, v);\n-        }\n-\n-        return t;\n-    }\n-\n-    \/**\n-     * Creates a visiting function for bodies.\n-     *\n-     * @param v   the body visitor\n-     * @param <T> accumulator type\n-     * @return the visiting function for bodies\n-     *\/\n-    static <T> BiFunction<T, CodeElement<?, ?>, T> bodyVisitor(BiFunction<T, Body, T> v) {\n-        return (t, e) -> e instanceof Body f\n-                ? v.apply(t, f)\n-                : t;\n-    }\n-\n-    \/**\n-     * Creates a visiting function for blocks.\n-     *\n-     * @param v   the block visitor\n-     * @param <T> accumulator type\n-     * @return the visiting function for blocks\n-     *\/\n-    static <T> BiFunction<T, CodeElement<?, ?>, T> blockVisitor(BiFunction<T, Block, T> v) {\n-        return (t, e) -> e instanceof Block f\n-                ? v.apply(t, f)\n-                : t;\n-    }\n-\n-    \/**\n-     * Creates a visiting function for operations.\n-     *\n-     * @param v   the operation visitor\n-     * @param <T> accumulator type\n-     * @return the visiting function for operations\n-     *\/\n-    static <T> BiFunction<T, CodeElement<?, ?>, T> opVisitor(BiFunction<T, Op, T> v) {\n-        return (t, e) -> e instanceof Op f\n-                ? v.apply(t, f)\n-                : t;\n-    }\n-\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/CodeElement.java","additions":0,"deletions":58,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -250,1 +250,4 @@\n-        op.traverse(null, CodeElement.blockVisitor((_, b) -> {\n+        op.elements().forEach(e -> {\n+            if (!(e instanceof Block b)) {\n+                return;\n+            }\n@@ -265,3 +268,2 @@\n-                return null;\n-            } catch (IOException e) {\n-                throw new UncheckedIOException(e);\n+            } catch (IOException ex) {\n+                throw new UncheckedIOException(ex);\n@@ -269,1 +271,1 @@\n-        }));\n+        });\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/analysis\/Liveness.java","additions":7,"deletions":5,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -34,2 +34,3 @@\n-import java.util.function.BiFunction;\n-import java.util.function.Predicate;\n+import java.util.function.*;\n+import java.util.stream.Gatherer;\n+import java.util.stream.Gatherers;\n@@ -210,1 +211,4 @@\n-            return o.traverse(r, CodeElement.opVisitor(opm));\n+            return o.elements().gather(Gatherers.fold(\n+                    () -> r,\n+                    (r, e) -> e instanceof Op op ? opm.apply(r, op) : r)\n+            ).findFirst().orElseThrow();\n@@ -265,1 +269,1 @@\n-     * @param r         the initial match result\n+     * @param init      the initial match result\n@@ -273,1 +277,1 @@\n-    public static <R> R match(R r, CodeElement<?, ?> t, OpPattern opPattern,\n+    public static <R> R match(R init, CodeElement<?, ?> t, OpPattern opPattern,\n@@ -276,1 +280,4 @@\n-        return t.traverse(r, CodeElement.opVisitor(opm));\n+        return t.elements().gather(Gatherers.fold(\n+                () -> init,\n+                (r, e) -> e instanceof Op op ? opm.apply(r, op) : r)\n+        ).findFirst().orElseThrow();\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/analysis\/Patterns.java","additions":13,"deletions":6,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -84,2 +84,2 @@\n-        nestedOp.traverse(null, CodeElement.opVisitor((_, op) -> {\n-            switch (op) {\n+        nestedOp.elements().forEach(e -> {\n+            switch (e) {\n@@ -98,1 +98,1 @@\n-                case Op.Terminating _ -> {\n+                case Op op when op instanceof Op.Terminating -> {\n@@ -114,2 +114,1 @@\n-            return null;\n-        }));\n+        });\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/analysis\/SSABraun.java","additions":4,"deletions":5,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -207,1 +207,1 @@\n-                    op.traverse(null, (_, ce) -> {\n+                    op.elements().forEach(ce -> {\n@@ -213,1 +213,0 @@\n-                        return null;\n@@ -331,2 +330,3 @@\n-        return r.traverse(new LinkedHashMap<>(), CodeElement.opVisitor((stores, op) -> {\n-            if (op instanceof CoreOp.VarAccessOp.VarStoreOp storeOp) {\n+        LinkedHashMap<CoreOp.VarOp, Set<Block>> stores = new LinkedHashMap<>();\n+        r.elements().forEach(e -> {\n+            if (e instanceof CoreOp.VarAccessOp.VarStoreOp storeOp) {\n@@ -340,2 +340,2 @@\n-            return stores;\n-        }));\n+        });\n+        return stores;\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/analysis\/SSACytron.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -62,3 +62,5 @@\n-        m.traverse(null, CodeElement.blockVisitor((_, b) -> {\n-            for (Block.Parameter p : b.parameters()) {\n-                testBlockParameter(p);\n+        m.elements().forEach(e -> {\n+            if (e instanceof Block b) {\n+                for (Block.Parameter p : b.parameters()) {\n+                    testBlockParameter(p);\n+                }\n@@ -66,3 +68,1 @@\n-\n-            return null;\n-        }));\n+        });\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestBlockParameters.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -283,12 +283,14 @@\n-        return op.traverse(new HashMap<>(),\n-                CodeElement.blockVisitor((m, b) -> {\n-                    if (b.ancestorOp() == op) {\n-                        Liveness.BlockInfo lbi = l.getLiveness(b);\n-                        m.put(blockMap.get(b),\n-                                List.of(\n-                                        lbi.liveIn().stream().map(valueMap::get).collect(Collectors.toSet()),\n-                                        lbi.liveOut().stream().map(valueMap::get).collect(Collectors.toSet())\n-                                ));\n-                    }\n-                    return m;\n-                }));\n+        Map<Integer, List<Set<Integer>>> m = new HashMap<>();\n+        op.elements().forEach(e -> {\n+            if (e instanceof Block b) {\n+                if (b.ancestorOp() == op) {\n+                    Liveness.BlockInfo lbi = l.getLiveness(b);\n+                    m.put(blockMap.get(b),\n+                            List.of(\n+                                    lbi.liveIn().stream().map(valueMap::get).collect(Collectors.toSet()),\n+                                    lbi.liveOut().stream().map(valueMap::get).collect(Collectors.toSet())\n+                            ));\n+                }\n+            }\n+        });\n+        return m;\n@@ -299,4 +301,6 @@\n-        return top.traverse(new HashMap<>(), CodeElement.blockVisitor((m, b) -> {\n-            if (b.ancestorOp() != top) {\n-                return m;\n-            }\n+        Map<Block, Integer> m = new HashMap<>();\n+        top.elements().forEach(e -> {\n+            if (e instanceof Block b) {\n+                if (b.ancestorOp() != top) {\n+                    return;\n+                }\n@@ -304,3 +308,4 @@\n-            m.computeIfAbsent(b, _ -> i.getAndIncrement());\n-            for (Block.Reference s : b.successors()) {\n-                m.computeIfAbsent(s.targetBlock(), _ -> i.getAndIncrement());\n+                m.computeIfAbsent(b, _ -> i.getAndIncrement());\n+                for (Block.Reference s : b.successors()) {\n+                    m.computeIfAbsent(s.targetBlock(), _ -> i.getAndIncrement());\n+                }\n@@ -308,3 +313,2 @@\n-\n-            return m;\n-        }));\n+        });\n+        return m;\n@@ -315,1 +319,2 @@\n-        return top.traverse(new HashMap<>(), (m, e) -> {\n+        Map<Value, Integer> m = new HashMap<>();\n+        top.elements().forEach(e -> {\n@@ -331,1 +336,0 @@\n-            return m;\n@@ -333,0 +337,1 @@\n+        return m;\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestLiveness.java","additions":29,"deletions":24,"binary":false,"changes":53,"status":"modified"},{"patch":"@@ -43,0 +43,1 @@\n+import java.util.function.BiFunction;\n@@ -77,1 +78,1 @@\n-        List<CodeElement<?, ?>> tl = op.traverse(new ArrayList<>(), (l, e) -> {\n+        List<CodeElement<?, ?>> tl = traverse(new ArrayList<>(), op, (l, e) -> {\n@@ -81,1 +82,1 @@\n-        Assertions.assertEquals(tl, op.elements().toList());\n+        Assertions.assertEquals(op.elements().toList(), tl);\n@@ -83,1 +84,10 @@\n-        Assertions.assertEquals(tl.subList(0, 2), op.elements().limit(2).toList());\n+        Assertions.assertEquals(op.elements().limit(2).toList(), tl.subList(0, 2));\n+    }\n+\n+    static <T> T traverse(T t, CodeElement<?, ?> e, BiFunction<T, CodeElement<?, ?>, T> v) {\n+        t = v.apply(t, e);\n+        for (CodeElement<?, ?> c : e.children()) {\n+            t = traverse(t, c, v);\n+        }\n+\n+        return t;\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestTraverse.java","additions":13,"deletions":3,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -125,2 +125,2 @@\n-        return op.traverse(t, (m, codeElement) -> {\n-            return switch (codeElement) {\n+        op.elements().forEach(e -> {\n+            switch (e) {\n@@ -129,1 +129,1 @@\n-                        c.accept(a, m);\n+                        c.accept(a, t);\n@@ -131,2 +131,0 @@\n-\n-                    yield m;\n@@ -136,1 +134,1 @@\n-                        c.accept(o.result(), m);\n+                        c.accept(o.result(), t);\n@@ -138,2 +136,0 @@\n-\n-                    yield m;\n@@ -141,2 +137,2 @@\n-                default -> m;\n-            };\n+                default -> { }\n+            }\n@@ -144,0 +140,1 @@\n+        return t;\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestUsesDependsOn.java","additions":7,"deletions":10,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -50,0 +50,1 @@\n+import java.util.stream.Collectors;\n@@ -130,5 +131,6 @@\n-        ExcStackMap excMap = func.traverse(new ExcStackMap(new ArrayList<>(), new IdentityHashMap<>()),\n-                CodeElement.blockVisitor((map, b) -> map.apply(b)));\n-\n-        List<Var> toInitialize = func.body().traverse(new ArrayList<>(), CodeElement.opVisitor((toInit, op) -> {\n-            if (op instanceof SlotOp slotOp && !varMap.containsKey(slotOp)) {\n+        ExcStackMap excMap = new ExcStackMap(new ArrayList<>(), new IdentityHashMap<>());\n+        func.elements().forEach(e -> {\n+            if (e instanceof Block b) {\n+                excMap.apply(b);\n+            }\n+        });\n@@ -136,0 +138,2 @@\n+        List<Var> toInitialize = func.body().elements().<Var>mapMulti((e, c) -> {\n+            if (e instanceof SlotOp slotOp && !varMap.containsKey(slotOp)) {\n@@ -184,1 +188,1 @@\n-                    toInit.add(varMap.get(stores.getFirst()));\n+                    c.accept(varMap.get(stores.getFirst()));\n@@ -186,2 +190,0 @@\n-\n-\n@@ -189,2 +191,1 @@\n-            return toInit;\n-        }));\n+        }).collect(Collectors.toCollection(ArrayList::new));\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/bytecode\/lift\/SlotToVarTransformer.java","additions":11,"deletions":10,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -57,1 +57,1 @@\n-        ArrayList<Value> unresolved = func.traverse(new ArrayList<>(), (q, e) -> {\n+        List<Value> unresolved = func.elements().<Value>mapMulti((e, c) -> {\n@@ -60,1 +60,1 @@\n-                   if (toResolve(v) != null) q.add(v);\n+                    if (toResolve(v) != null) c.accept(v);\n@@ -63,1 +63,1 @@\n-                   q.add(op.result());\n+                        c.accept(op.result());\n@@ -65,3 +65,3 @@\n-           }\n-           return q;\n-        });\n+            }\n+\n+        }).toList();\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/bytecode\/lift\/UnresolvedTypesTransformer.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -120,2 +120,6 @@\n-        rootOp.traverse(null, CodeElement.opVisitor((_, op) -> {\n-            \/\/ Verify operands declaration dominannce\n+        rootOp.elements().forEach(e -> {\n+            if (!(e instanceof Op op)) {\n+                return;\n+            }\n+\n+            \/\/ Verify operands declaration dominance\n@@ -131,1 +135,1 @@\n-                    verifyBlockReferences(op, br.successors());\n+                        verifyBlockReferences(op, br.successors());\n@@ -133,1 +137,1 @@\n-                    verifyBlockReferences(op, cbr.successors());\n+                        verifyBlockReferences(op, cbr.successors());\n@@ -135,1 +139,1 @@\n-                    verifyOpHandleExists(op, op.externalizeOpName());\n+                        verifyOpHandleExists(op, op.externalizeOpName());\n@@ -142,2 +146,1 @@\n-            return null;\n-        }));\n+        });\n@@ -211,1 +214,5 @@\n-        rootOp.traverse(new HashMap<Block, List<Block>>(), CodeElement.blockVisitor((map, b) -> {\n+        Map<Block, List<Block>> map = new HashMap<>();\n+        rootOp.elements().forEach(e -> {\n+            if (!(e instanceof Block b)) {\n+                return;\n+            }\n@@ -215,1 +222,1 @@\n-                    verifyCatchStack(b, br, br.branch(), catchBlocks, map);\n+                        verifyCatchStack(b, br, br.branch(), catchBlocks, map);\n@@ -239,2 +246,1 @@\n-            return map;\n-        }));\n+        });\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/bytecode\/lift\/Verifier.java","additions":17,"deletions":11,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -50,1 +50,1 @@\n-        f.traverse(null, (o, ce) -> {\n+        f.elements().forEach(ce -> {\n@@ -59,1 +59,0 @@\n-            return null;\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/location\/TestLocation.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"}]}