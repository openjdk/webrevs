{"files":[{"patch":"@@ -46,0 +46,1 @@\n+import oracle.code.onnx.OnnxRuntime;\n@@ -60,0 +61,2 @@\n+    public static final String EMPTY_STRING = \"\";\n+    public static final String RED_ERROR_SPAN = \"<span style='color:red'>Error!<\/span>\";\n@@ -90,1 +93,1 @@\n-            resultLabels[i] = new JLabel(\"\", SwingConstants.CENTER);\n+            resultLabels[i] = new JLabel(EMPTY_STRING, SwingConstants.CENTER);\n@@ -109,3 +112,0 @@\n-        JProgressBar progressBar = new JProgressBar(0, MAX_SELECTIONS);\n-        progressBar.setStringPainted(true);\n-        progressBar.setVisible(false);\n@@ -119,1 +119,1 @@\n-                analyzeSelection(progressBar, analyzeBtn);\n+                analyzeSelection(analyzeBtn);\n@@ -125,3 +125,2 @@\n-        JPanel southPanel = new JPanel(new BorderLayout());\n-        southPanel.add(analyzeBtn, BorderLayout.CENTER);\n-        southPanel.add(progressBar, BorderLayout.SOUTH);\n+        JPanel southPanel = new JPanel();\n+        southPanel.add(analyzeBtn);\n@@ -143,0 +142,1 @@\n+        thumb.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));\n@@ -145,2 +145,2 @@\n-            public void mouseClicked(MouseEvent e) {\n-                if (selectedUrls.size() < MAX_SELECTIONS) {\n+            public void mousePressed(MouseEvent e) {\n+                if (selectedUrls.size() < MAX_SELECTIONS && !selectedUrls.contains(url)) {\n@@ -151,2 +151,2 @@\n-                    imageLabels[idx].setText(\"\");\n-                    resultLabels[idx].setText(\"\");\n+                    imageLabels[idx].setText(EMPTY_STRING);\n+                    resultLabels[idx].setText(EMPTY_STRING);\n@@ -188,4 +188,2 @@\n-    private void analyzeSelection(JProgressBar progressBar, JButton analyzeBtn) {\n-        progressBar.setValue(0);\n-        progressBar.setMaximum(selectedUrls.size());\n-        progressBar.setVisible(true);\n+    private void analyzeSelection(JButton analyzeBtn) {\n+        int size = selectedUrls.size();\n@@ -194,22 +192,33 @@\n-        long startTime = System.nanoTime();\n-\n-        for (int i = 0; i < selectedUrls.size(); i++) {\n-            URL url = selectedUrls.get(i);\n-\n-            try (var arena = Arena.ofConfined()) {\n-                Map<String, String> options = Map.of(\"ModelFormat\", \"MLProgram\",\n-                        \"MLComputeUnits\", \"CPUAndGPU\", \"EnableOnSubgraphs\", \"1\",\n-                        \"AllowLowPrecisionAccumulationOnGPU\", \"1\",\n-                        \"ModelCacheDirectory\", FERCoreMLDemo.class.getResource(BASE_PATH).getPath());\n-                OnnxProvider provider = new OnnxProvider(\"CoreML\", options);\n-                float[] probs = inference.analyzeImage(arena, provider, url, useCondensedModel);\n-                String top3 = formatTopK(probs);\n-\n-                resultLabels[i].setText(\"<html>\" + top3 + \"<\/html>\");\n-                progressBar.setValue(i + 1);\n-                progressBar.setString(\"Processed \" + (i + 1) + \"\/\" + selectedUrls.size());\n-\n-                frame.repaint();\n-            } catch (Exception ex) {\n-                logger.log(Level.SEVERE, \"Error occurred when evaluating images\", ex);\n-                resultLabels[i].setText(\"<html><span style='color:red'>Error!<\/span><\/html>\");\n+        Map<String, String> options = Map.of(\"ModelFormat\", \"MLProgram\",\n+                \"MLComputeUnits\", \"CPUAndGPU\", \"EnableOnSubgraphs\", \"1\",\n+                \"AllowLowPrecisionAccumulationOnGPU\", \"1\",\n+                \"ModelCacheDirectory\", FERCoreMLDemo.class.getResource(BASE_PATH).getPath());\n+        OnnxProvider provider = new OnnxProvider(\"CoreML\", options);\n+\n+        long initStartTime = System.nanoTime();\n+        long initTime = 0;\n+        long totalInferenceTime = 0;\n+\n+        try (var arena = Arena.ofConfined()) {\n+            OnnxRuntime.SessionOptions sessionOptions = inference.prepareSessionOptions(arena, provider);\n+\n+            long initEndTime = System.nanoTime();\n+            initTime = (initEndTime - initStartTime) \/ 1000000;\n+\n+            for (int i = 0; i < size; i++) {\n+                URL url = selectedUrls.get(i);\n+                String result = \"<html>%s<\/html>\";\n+                try {\n+                    long inferenceStart = System.nanoTime();\n+                    float[] probs = inference.analyzeImage(arena, sessionOptions, url, useCondensedModel);\n+                    long inferenceEnd = System.nanoTime();\n+                    long inferenceTime = (inferenceEnd - inferenceStart) \/ 1000000;\n+                    totalInferenceTime += inferenceTime;\n+                    logger.info(\"Finished inference for image %d in %d ms\".formatted(i + 1, inferenceTime));\n+                    String top3 = formatTopK(probs);\n+                    resultLabels[i].setText(result.formatted(top3 ));\n+                    frame.repaint();\n+                } catch (Exception ex) {\n+                    logger.log(Level.SEVERE, \"Error occurred when evaluating images\", ex);\n+                    resultLabels[i].setText(result.formatted(result.formatted(RED_ERROR_SPAN)));\n+                }\n@@ -217,0 +226,8 @@\n+        } catch (Exception initEx) {\n+            logger.log(Level.SEVERE, \"Failed to initialize inference resources\", initEx);\n+        } finally {\n+            logger.info(\"Total time initializing ORT: %d ms\".formatted(initTime));\n+            logger.info(\"Total inference time: %d ms for %d images\".formatted(totalInferenceTime, size));\n+            analyzeBtn.setEnabled(true);\n+            analyzeBtn.setText(\"Restart\");\n+            logger.info(\"=== FER analysis complete ===\");\n@@ -218,6 +235,0 @@\n-        long endTime = System.nanoTime();\n-        logger.info(\"Total time spent in evaluation %s ms\".formatted((endTime - startTime)\/1000000));\n-        analyzeBtn.setEnabled(true);\n-        analyzeBtn.setText(\"Restart\");\n-        progressBar.setString(\"Analysis complete!\");\n-        logger.info(\"=== FER analysis complete ===\");\n@@ -232,1 +243,1 @@\n-            resultLabels[i].setText(\"\");\n+            resultLabels[i].setText(EMPTY_STRING);\n@@ -236,4 +247,0 @@\n-\n-        JProgressBar progressBar = (JProgressBar) analyzeBtn.getParent().getComponent(1);\n-        progressBar.setVisible(false);\n-\n","filename":"cr-examples\/onnx\/src\/test\/java\/oracle\/code\/onnx\/fer\/FERCoreMLDemo.java","additions":56,"deletions":49,"binary":false,"changes":105,"status":"modified"},{"patch":"@@ -48,1 +48,1 @@\n-    public float[] analyzeImage(Arena arena, OnnxProvider provider, URL url, boolean useCondensedModel) throws Exception {\n+    public float[] analyzeImage(Arena arena, OnnxRuntime.SessionOptions sessionOptions, URL url, boolean isCondensed) throws Exception {\n@@ -50,0 +50,6 @@\n+        FERModel ferModel = new FERModel(arena);\n+        float[] rawScores = ferModel.classify(imageData, sessionOptions, isCondensed);\n+        return rawScores;\n+    }\n+\n+    public OnnxRuntime.SessionOptions prepareSessionOptions(Arena arena, OnnxProvider provider) {\n@@ -54,3 +60,1 @@\n-        FERModel ferModel = new FERModel(arena);\n-        float[] rawScores = ferModel.classify(imageData, sessionOptions, useCondensedModel);\n-        return rawScores;\n+        return sessionOptions;\n","filename":"cr-examples\/onnx\/src\/test\/java\/oracle\/code\/onnx\/fer\/FERInference.java","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"}]}