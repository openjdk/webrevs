{"files":[{"patch":"@@ -61,1 +61,0 @@\n-\n@@ -65,1 +64,0 @@\n-\n@@ -82,1 +80,1 @@\n-        private void setGlobalMesh(NDRange.Global global) {\n+        public void dispatch(KernelContext kernelContext, Object[] args) {\n@@ -85,1 +83,1 @@\n-            switch (global) {\n+            switch (kernelContext.ndRange.global()) {\n@@ -102,1 +100,1 @@\n-                    throw new IllegalArgumentException(\"Unknown global range \" + global.getClass());\n+                    throw new IllegalArgumentException(\"Unknown global range \" + kernelContext.ndRange.global().getClass());\n@@ -105,23 +103,22 @@\n-        }\n-\n-        private void setLocalMesh(NDRange.Local local) {\n-            kernelBufferContext.lsy(1);\n-            kernelBufferContext.lsz(1);\n-            switch (local) {\n-                case NDRange.Local1D local1D -> {\n-                    kernelBufferContext.lsx(local1D.x());\n-                    kernelBufferContext.dimensions(local1D.dimension());\n-                }\n-                case NDRange.Local2D local2D -> {\n-                    kernelBufferContext.lsx(local2D.x());\n-                    kernelBufferContext.lsy(local2D.y());\n-                    kernelBufferContext.dimensions(local2D.dimension());\n-                }\n-                case NDRange.Local3D local3D -> {\n-                    kernelBufferContext.lsx(local3D.x());\n-                    kernelBufferContext.lsy(local3D.y());\n-                    kernelBufferContext.lsz(local3D.z());\n-                    kernelBufferContext.dimensions(local3D.dimension());\n-                }\n-                case null, default -> {\n-                    throw new IllegalArgumentException(\"Unknown global range \" + local.getClass());\n+            if (kernelContext.ndRange.hasLocal()) {\n+                kernelBufferContext.lsy(1);\n+                kernelBufferContext.lsz(1);\n+                switch (kernelContext.ndRange.local()) {\n+                    case NDRange.Local1D local1D -> {\n+                        kernelBufferContext.lsx(local1D.x());\n+                        kernelBufferContext.dimensions(local1D.dimension());\n+                    }\n+                    case NDRange.Local2D local2D -> {\n+                        kernelBufferContext.lsx(local2D.x());\n+                        kernelBufferContext.lsy(local2D.y());\n+                        kernelBufferContext.dimensions(local2D.dimension());\n+                    }\n+                    case NDRange.Local3D local3D -> {\n+                        kernelBufferContext.lsx(local3D.x());\n+                        kernelBufferContext.lsy(local3D.y());\n+                        kernelBufferContext.lsz(local3D.z());\n+                        kernelBufferContext.dimensions(local3D.dimension());\n+                    }\n+                    case null, default -> {\n+                        throw new IllegalArgumentException(\"Unknown global range \" + kernelContext.ndRange.local().getClass());\n+                    }\n@@ -129,19 +126,0 @@\n-            }\n-        }\n-\n-        private void setDefaultLocalMesh() {\n-            kernelBufferContext.lsx(0);\n-            kernelBufferContext.lsy(0);\n-            kernelBufferContext.lsz(0);\n-        }\n-\n-        private void setupComputeRange(KernelContext kernelContext) {\n-            NDRange ndRange = kernelContext.getNDRange();\n-            if (!(ndRange instanceof NDRange.Range range)) {\n-                throw new IllegalArgumentException(\"NDRange must be of type NDRange.Range\");\n-            }\n-            boolean isLocalMeshDefined = kernelContext.hasLocalMesh();\n-            NDRange.Global global = range.global();\n-            setGlobalMesh(global);\n-            if (isLocalMeshDefined) {\n-                setLocalMesh(range.local());\n@@ -149,1 +127,3 @@\n-                setDefaultLocalMesh();\n+                kernelBufferContext.lsx(0);\n+                kernelBufferContext.lsy(0);\n+                kernelBufferContext.lsz(0);\n@@ -151,4 +131,0 @@\n-        }\n-\n-        public void dispatch(KernelContext kernelContext, Object[] args) {\n-            setupComputeRange(kernelContext);\n@@ -243,1 +219,0 @@\n-\n@@ -289,0 +264,2 @@\n+                    \/\/ DON'T DO THIS !!!!  we are needlessly allocating a memory segment here pn each dispatch!!!\n+                    \/\/ just to get the bound schema.\n@@ -305,6 +282,3 @@\n-                        Object schema = schemaField.get(schemaField);\n-\n-                        Class<?> deviceSchemaClass = Class.forName(DeviceSchema.class.getName());\n-                        Method toTextMethod = deviceSchemaClass.getDeclaredMethod(\"toText\");\n-                        toTextMethod.setAccessible(true);\n-                        String toText = (String) toTextMethod.invoke(schema);\n+                        var schema = (DeviceSchema<?>)schemaField.get(schemaField);\n+                        \/\/ <1> We are creating text form of DeviceType schema\n+                        String toText = schema.toText();\n@@ -312,0 +286,2 @@\n+                            \/\/ <2> just to then parse the text from above.\n+                            \/\/ Lets get the model in a cleaner form\n@@ -330,0 +306,2 @@\n+\n+                        \/\/  Why are we transforming the callgraph here\n@@ -339,0 +317,1 @@\n+            \/\/ Why are we doing this here we should not be mutating the kernel callgraph at this point\n","filename":"hat\/backends\/ffi\/shared\/src\/main\/java\/hat\/backend\/ffi\/C99FFIBackend.java","additions":38,"deletions":59,"binary":false,"changes":97,"status":"modified"},{"patch":"@@ -110,1 +110,1 @@\n-    public void dispatchKernel(NDRange ndRange, QuotableKernelContextConsumer quotableKernelContextConsumer) {\n+    public void dispatchKernel(NDRange<?,?> ndRange, QuotableKernelContextConsumer quotableKernelContextConsumer) {\n@@ -127,1 +127,1 @@\n-    private void dispatchKernelWithComputeRange(NDRange ndRange, QuotableKernelContextConsumer quotableKernelContextConsumer) {\n+    private void dispatchKernelWithComputeRange(NDRange<?,?> ndRange, QuotableKernelContextConsumer quotableKernelContextConsumer) {\n","filename":"hat\/core\/src\/main\/java\/hat\/ComputeContext.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -42,1 +42,0 @@\n-\n@@ -69,1 +68,1 @@\n-    private NDRange ndRange;\n+    final public NDRange<?,?> ndRange;\n@@ -71,1 +70,1 @@\n-    public KernelContext(NDRange ndRange) {\n+    public KernelContext(NDRange<?,?> ndRange) {\n@@ -75,1 +74,1 @@\n-                this.gsx = ndRange1D.global().x();\n+                this.gsx = ((NDRange._1DX)(ndRange1D.global())).x();\n@@ -78,0 +77,1 @@\n+                this.dimensions = ((NDRange._1DX)(ndRange1D.global())).dimension();\n@@ -80,2 +80,2 @@\n-                this.gsx = ndRange2D.global().x();\n-                this.gsy = ndRange2D.global().y();\n+                this.gsx = ((NDRange._2DXY)(ndRange2D.global())).x();\n+                this.gsy = ((NDRange._2DXY)(ndRange2D.global())).y();\n@@ -83,0 +83,1 @@\n+                this.dimensions = ((NDRange._2DXY)(ndRange2D.global())).dimension();\n@@ -85,3 +86,4 @@\n-                this.gsx = ndRange3D.global().x();\n-                this.gsy = ndRange3D.global().y();\n-                this.gsz = ndRange3D.global().z();\n+                this.gsx = ((NDRange._3DXYZ)(ndRange3D.global())).x();\n+                this.gsy = ((NDRange._3DXYZ)(ndRange3D.global())).y();\n+                this.gsz = ((NDRange._3DXYZ)(ndRange3D.global())).z();\n+                this.dimensions = ((NDRange._3DXYZ)(ndRange3D.global())).dimension();\n@@ -89,1 +91,1 @@\n-            case null, default -> {\n+            case null, default ->\n@@ -91,41 +93,0 @@\n-            }\n-        }\n-        this.dimensions = ndRange.dimension();\n-    }\n-\n-    \/**\n-     * 1D Kernel\n-     * @param maxX Global number of threads for the first dimension (1D)\n-     *\/\n-    public KernelContext(int maxX) {\n-        this.gsx = maxX;\n-        this.gsy = 0;\n-        this.gsz = 0;\n-        this.dimensions = 1;\n-    }\n-\n-    \/**\n-     * 1D Kernel\n-     * @param maxX Global number of threads for the first dimension (1D)\n-     * @param maxY Global number of threads for the second dimension (2D)\n-     *\/\n-    public KernelContext(int maxX, int maxY) {\n-        this.gsx = maxX;\n-        this.gsy = maxY;\n-        this.gsz = 0;\n-        this.dimensions = 2;\n-    }\n-\n-    \/**\n-     * 1D Kernel\n-     * @param maxX Global number of threads for the first dimension (1D)\n-     * @param maxY Global number of threads for the second dimension (2D)\n-     * @param maxZ Global number of threads for the second dimension (3D)\n-     *\/\n-    public KernelContext(int maxX, int maxY, int maxZ) {\n-        this.gsx = maxX;\n-        this.gsy = maxY;\n-        this.gsz = maxZ;\n-\n-        this.dimensions = 3;\n-    }\n@@ -133,2 +94,1 @@\n-    public int getDimensions() {\n-        return this.dimensions;\n+        }\n@@ -137,3 +97,3 @@\n-    public NDRange getNDRange() {\n-        return this.ndRange;\n-    }\n+  \/\/  public int getDimensions() {\n+    \/\/    return this.dimensions;\n+   \/\/ }\n@@ -141,16 +101,3 @@\n-    private boolean isLocalDefined(NDRange.Local local) {\n-        return local != NDRange.Local1D.EMPTY\n-                && local != NDRange.Local2D.EMPTY\n-                && local != NDRange.Local3D.EMPTY;\n-    }\n-\n-    public boolean hasLocalMesh() {\n-        switch (ndRange) {\n-            case NDRange.Range range -> {\n-                return (isLocalDefined(range.local()));\n-            }\n-            case null, default -> {\n-                throw new IllegalArgumentException(\"Unknown NDRange type: \"  + ndRange.getClass());\n-            }\n-        }\n-    }\n+   \/\/ public NDRange<?,?> getNDRange() {\n+     \/\/   return this.ndRange;\n+   \/\/ }\n@@ -158,0 +105,1 @@\n+    \/\/ This is a marker called by kernel code which is mapped to a barrier implementatiom\n@@ -161,1 +109,0 @@\n-\n","filename":"hat\/core\/src\/main\/java\/hat\/KernelContext.java","additions":20,"deletions":73,"binary":false,"changes":93,"status":"modified"},{"patch":"@@ -39,0 +39,4 @@\n+   \/\/ int dimension();\n+    Local local();\n+    Global global();\n+    boolean hasLocal();\n@@ -41,1 +45,0 @@\n-    int dimension();\n@@ -43,4 +46,2 @@\n-    default boolean hasLocal(){\n-        return (this instanceof NDRange.NDRange1D r1 && r1.local() != Local1D.EMPTY)||\n-                (this instanceof NDRange.NDRange2D r2 && r2.local() != Local2D.EMPTY)||\n-                (this instanceof NDRange.NDRange3D r3 && r3.local() != Local3D.EMPTY);\n+    interface Dim{\n+        int dimension();\n@@ -49,1 +50,1 @@\n-    interface _1D extends NDRange<NDRange.Global1D,NDRange.Local1D> {\n+    interface _1D extends Dim {\n@@ -56,1 +57,1 @@\n-    interface _2D extends NDRange<NDRange.Global2D,NDRange.Local2D> {\n+    interface _2D extends Dim {\n@@ -62,1 +63,1 @@\n-    interface _3D extends NDRange<NDRange.Global3D,NDRange.Local3D> {\n+    interface _3D extends Dim{\n@@ -133,4 +134,5 @@\n-    interface Range<G extends NDRange.Global,L extends NDRange.Local> extends NDRange<G,L> {\n-        Global global();\n-        Local local();\n-    }\n+    interface NDRange1D extends NDRange<Global1D,Local1D>, _1D {\n+        @Override\n+        default boolean hasLocal() {\n+            return local()!=Local1D.EMPTY;\n+        }\n@@ -138,3 +140,1 @@\n-    record NDRange1D(Global1D global, Local1D local) implements Range<Global1D,Local1D>, _1D {\n-        public static NDRange1D of(Global1D global, Local1D local) {\n-            return new NDRange1D(global, local);\n+        record Impl(int dimension, Global1D global, Local1D local) implements NDRange1D {\n@@ -142,2 +142,6 @@\n-        public static NDRange1D of(Global1D global) {\n-            return new NDRange1D(global, Local1D.EMPTY);\n+            static NDRange1D of(Global1D global, Local1D local) {\n+                return new Impl(1,global, local);\n+            }\n+             static NDRange1D of(Global1D global) {\n+                return new Impl(1,global, Local1D.EMPTY);\n+            }\n@@ -145,1 +149,0 @@\n-    }\n@@ -147,2 +150,5 @@\n-    static NDRange<Global1D,Local1D> of1D(int gsx,  int lsx) {\n-        return  new NDRange1D(Global1D.of(gsx), Local1D.of(lsx));\n+\n+\n+\n+    static NDRange1D of1D(int gsx,  int lsx) {\n+        return NDRange1D.of(Global1D.of(gsx), Local1D.of(lsx));\n@@ -151,2 +157,2 @@\n-    static NDRange<Global1D,Local1D> of1D(int gsx) {\n-        return new NDRange1D(Global1D.of(gsx), Local1D.EMPTY);\n+    static NDRange1D of1D(int gsx) {\n+        return NDRange1D.of(Global1D.of(gsx), Local1D.EMPTY);\n@@ -155,3 +161,4 @@\n-    record NDRange2D(Global2D global, Local2D local) implements Range<Global2D, Local2D>, _2D {\n-        public static NDRange2D of(Global2D global, Local2D local) {\n-            return new NDRange2D(global, local);\n+    interface NDRange2D extends NDRange<Global2D,Local2D>, _2D {\n+        @Override\n+        default boolean hasLocal() {\n+            return local()!=Local2D.EMPTY;\n@@ -159,3 +166,7 @@\n-\n-        public static NDRange2D of(Global2D global) {\n-            return new NDRange2D(global, Local2D.EMPTY);\n+        record Impl(Global2D global, Local2D local) implements NDRange2D {\n+        }\n+        static NDRange2D of(Global2D global, Local2D local) {\n+            return new Impl(global, local);\n+        }\n+        static NDRange2D of(Global2D global) {\n+            return new Impl(global, Local2D.EMPTY);\n@@ -165,2 +176,3 @@\n-    static NDRange<Global2D,Local2D> of2D(int gsx, int gsy, int lsx, int lsy) {\n-        return new NDRange2D(Global2D.of(gsx,gsy), Local2D.of(lsx,lsy));\n+\n+    static NDRange2D of2D(int gsx, int gsy, int lsx, int lsy) {\n+        return NDRange2D.of(Global2D.of(gsx,gsy), Local2D.of(lsx,lsy));\n@@ -168,2 +180,2 @@\n-    static NDRange<Global2D,Local2D> of2D(int gsx,int gsy) {\n-        return new NDRange2D(Global2D.of(gsx,gsy), Local2D.EMPTY);\n+    static NDRange2D of2D(int gsx,int gsy) {\n+        return NDRange2D.of(Global2D.of(gsx,gsy), Local2D.EMPTY);\n@@ -172,3 +184,10 @@\n-    record NDRange3D(Global3D global, Local3D local) implements Range<Global3D,Local3D>, _3D {\n-        public static NDRange3D of(Global3D global, Local3D local) {\n-            return new NDRange3D(global, local);\n+\n+    interface NDRange3D extends NDRange<Global3D,Local3D>, _3D {\n+        @Override\n+        default boolean hasLocal() {\n+            return local()!=Local3D.EMPTY;\n+        }\n+        record Impl(Global3D global, Local3D local) implements NDRange3D {\n+        }\n+        static NDRange3D of(Global3D global, Local3D local) {\n+            return new Impl(global, local);\n@@ -176,2 +195,2 @@\n-        public static NDRange3D of(Global3D global) {\n-            return new NDRange3D(global, Local3D.EMPTY);\n+        static NDRange3D of(Global3D global) {\n+            return new Impl(global, Local3D.EMPTY);\n@@ -181,2 +200,2 @@\n-    static NDRange<Global3D,Local3D> of3D(int gsx, int gsy, int gsz, int lsx, int lsy, int lsz) {\n-        return new NDRange3D(Global3D.of(gsx,gsy,gsz), Local3D.of(lsx,lsy,lsz));\n+    static NDRange3D of3D(int gsx, int gsy, int gsz, int lsx, int lsy, int lsz) {\n+        return NDRange3D.of(Global3D.of(gsx,gsy,gsz), Local3D.of(lsx,lsy,lsz));\n@@ -184,2 +203,2 @@\n-    static NDRange<Global3D,Local3D> of3D(int gsx,int gsy, int gsz) {\n-        return new NDRange3D(Global3D.of(gsx,gsy,gsz), Local3D.EMPTY);\n+    static NDRange3D of3D(int gsx,int gsy, int gsz) {\n+        return NDRange3D.of(Global3D.of(gsx,gsy,gsz), Local3D.EMPTY);\n","filename":"hat\/core\/src\/main\/java\/hat\/NDRange.java","additions":60,"deletions":41,"binary":false,"changes":101,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import hat.NDRange;\n@@ -63,1 +64,2 @@\n-                ranges[fini] = new KernelContext(range);\n+                var ndRange1D = NDRange.of1D(range);\n+                ranges[fini] = new KernelContext(ndRange1D);\n","filename":"hat\/core\/src\/main\/java\/hat\/backend\/java\/WorkStealer.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"}]}