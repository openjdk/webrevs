{"files":[{"patch":"@@ -134,1 +134,1 @@\n-        either(hatVectorStoreView.isSharedOrPrivate(), CodeBuilder::dot, CodeBuilder::rarrow);\n+        either(hatVectorStoreView instanceof HATVectorOp.Shared, CodeBuilder::dot, CodeBuilder::rarrow);\n@@ -225,1 +225,1 @@\n-        either(hatVectorLoadOp.isSharedOrPrivate(), CodeBuilder::dot, CodeBuilder::rarrow);\n+        either(hatVectorLoadOp instanceof HATVectorOp.Shared, CodeBuilder::dot, CodeBuilder::rarrow);\n@@ -251,1 +251,1 @@\n-        if (hatVSelectStoreOp.resultValue() != null) {\n+        if (hatVSelectStoreOp.resolvedName() != null) {\n@@ -253,1 +253,1 @@\n-            varName(hatVSelectStoreOp.resultValue());\n+            varName(hatVSelectStoreOp.resolvedName());\n","filename":"hat\/backends\/ffi\/cuda\/src\/main\/java\/hat\/backend\/ffi\/CudaHATKernelBuilder.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -116,1 +116,1 @@\n-        either(hatVectorStoreView.isSharedOrPrivate(), CodeBuilder::dot, CodeBuilder::rarrow);\n+        either(hatVectorStoreView instanceof HATVectorOp.Shared, CodeBuilder::dot, CodeBuilder::rarrow);\n@@ -153,1 +153,1 @@\n-            either(hatVectorLoadOp.isSharedOrPrivate(), CodeBuilder::dot, CodeBuilder::rarrow);\n+            either(hatVectorLoadOp instanceof HATVectorOp.Shared, CodeBuilder::dot, CodeBuilder::rarrow);\n@@ -183,1 +183,1 @@\n-        if (hatVSelectStoreOp.resultValue() != null) {\n+        if (hatVSelectStoreOp.resolvedName() != null) {\n@@ -185,1 +185,1 @@\n-            varName(hatVSelectStoreOp.resultValue());\n+            varName(hatVSelectStoreOp.resolvedName());\n","filename":"hat\/backends\/ffi\/opencl\/src\/main\/java\/hat\/backend\/ffi\/OpenCLHATKernelBuilder.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -96,1 +96,1 @@\n-        either(hatVectorStoreView.isSharedOrPrivate(), CodeBuilder::dot, CodeBuilder::rarrow);\n+        either(hatVectorStoreView instanceof HATVectorOp.Shared, CodeBuilder::dot, CodeBuilder::rarrow);\n@@ -142,1 +142,1 @@\n-        either(hatVectorLoadOp.isSharedOrPrivate(), CodeBuilder::dot, CodeBuilder::rarrow);\n+        either(hatVectorLoadOp instanceof HATVectorOp.Shared, CodeBuilder::dot, CodeBuilder::rarrow);\n@@ -165,1 +165,1 @@\n-        if (hatVSelectStoreOp.resultValue() != null) {\n+        if (hatVSelectStoreOp.resolvedName() != null) {\n@@ -167,1 +167,1 @@\n-            varName(hatVSelectStoreOp.resultValue());\n+            varName(hatVSelectStoreOp.resolvedName());\n","filename":"hat\/backends\/jextracted\/opencl\/src\/main\/java\/hat\/backend\/jextracted\/OpenCLJExtractedHATKernelBuilder.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -33,1 +33,0 @@\n-import jdk.incubator.code.dialect.core.CoreOp;\n@@ -178,0 +177,5 @@\n+    public interface Shared{\n+    }\n+\n+    public interface Private{\n+    }\n@@ -179,1 +183,1 @@\n-    public static final class HATVectorLoadOp extends HATVectorOp implements Precedence.LoadOrConv {\n+    public static abstract sealed class HATVectorLoadOp extends HATVectorOp implements Precedence.LoadOrConv permits HATVectorLoadOp.HATPrivateVectorLoadOp, HATVectorLoadOp.HATSharedVectorLoadOp {\n@@ -181,1 +185,0 @@\n-        private final boolean isSharedOrPrivate;\n@@ -183,1 +186,1 @@\n-        public HATVectorLoadOp(String varName, TypeElement typeElement, Vector.Shape vectorShape, boolean isShared, List<Value> operands) {\n+        protected HATVectorLoadOp(String varName, TypeElement typeElement, Vector.Shape vectorShape,  List<Value> operands) {\n@@ -185,2 +188,0 @@\n-\n-            this.isSharedOrPrivate = isShared;\n@@ -189,1 +190,1 @@\n-        public HATVectorLoadOp(HATVectorLoadOp op, CodeContext copyContext) {\n+        protected HATVectorLoadOp(HATVectorLoadOp op, CodeContext copyContext) {\n@@ -191,1 +192,0 @@\n-            this.isSharedOrPrivate = op.isSharedOrPrivate;\n@@ -194,4 +194,0 @@\n-        @Override\n-        public Op transform(CodeContext copyContext, CodeTransformer opTransformer) {\n-            return new HATVectorLoadOp(this, copyContext);\n-        }\n@@ -199,3 +195,17 @@\n-        @Override\n-        public Map<String, Object> externalize() {\n-            return Map.of(\"hat.dialect.vectorLoadView.\" + varName(), resultType());\n+        public static final class HATPrivateVectorLoadOp extends HATVectorLoadOp implements Private{\n+            public HATPrivateVectorLoadOp(String varName, TypeElement typeElement, Vector.Shape vectorShape,  List<Value> operands) {\n+                super(varName, typeElement, vectorShape,  operands);\n+            }\n+            public HATPrivateVectorLoadOp(HATPrivateVectorLoadOp op, CodeContext copyContext) {\n+                super(op, copyContext);\n+            }\n+\n+\n+            @Override\n+            public Op transform(CodeContext cc, CodeTransformer ot) {\n+                return new HATPrivateVectorLoadOp(this, cc);\n+            }\n+            @Override\n+            public Map<String, Object> externalize() {\n+                return Map.of(\"hat.dialect.vectorPrivateLoad.\" + varName(), resultType());\n+            }\n@@ -203,0 +213,17 @@\n+        public static final class HATSharedVectorLoadOp extends HATVectorLoadOp implements Shared{\n+            public HATSharedVectorLoadOp(String varName, TypeElement typeElement, Vector.Shape vectorShape, List<Value> operands) {\n+                super(varName, typeElement, vectorShape, operands);\n+            }\n+            public HATSharedVectorLoadOp(HATSharedVectorLoadOp op, CodeContext copyContext) {\n+                super(op, copyContext);\n+            }\n+\n+\n+            @Override\n+            public Op transform(CodeContext cc, CodeTransformer ot) {\n+                return new HATSharedVectorLoadOp(this,cc);\n+            }\n+            @Override\n+            public Map<String, Object> externalize() {\n+                return Map.of(\"hat.dialect.vectorSharedLoad.\" + varName(), resultType());\n+            }\n@@ -204,2 +231,0 @@\n-        public boolean isSharedOrPrivate() {\n-            return this.isSharedOrPrivate;\n@@ -282,3 +307,1 @@\n-        \/\/ TODO: We should not capture ops in other ops.\n-        \/\/ We might want something captured but not the whole op.\n-        private final CoreOp.VarOp resultVarOp; \/\/ This is a bad idea.\n+        private final String resolvedName;\n@@ -286,2 +309,2 @@\n-        public HATVectorSelectStoreOp(String varName,  int lane, CoreOp.VarOp resultVarOp, List<Value> operands) {\n-            super(varName, JavaType.VOID, Vector.Shape.of(JavaType.VOID, -1), operands);\n+        public HATVectorSelectStoreOp(String varName, int lane, String resolvedName, List<Value> operands) {\n+            super(varName, JavaType.VOID, Vector.Shape.of(JavaType.VOID, -1), operands); \/\/ This seems so wrong.\n@@ -289,1 +312,1 @@\n-            this.resultVarOp = resultVarOp;\n+            this.resolvedName = resolvedName;\n@@ -295,1 +318,1 @@\n-            this.resultVarOp = that.resultVarOp;\n+            this.resolvedName = that.resolvedName;\n@@ -310,4 +333,2 @@\n-\n-        public CoreOp.VarOp resultValue() {\n-           \/\/ System.out.println(\"We should not depend on this!!!! it may have been transformed!\");\n-            return resultVarOp;\n+        public String resolvedName(){\n+            return resolvedName;\n@@ -318,3 +339,2 @@\n-    public static final class HATVectorStoreView extends HATVectorOp {\n-\n-        private final boolean isSharedOrPrivate;\n+    public static abstract sealed class HATVectorStoreView extends HATVectorOp\n+            permits HATVectorStoreView.HATPrivateVectorStoreView, HATVectorStoreView.HATSharedVectorStoreView {\n@@ -322,3 +342,2 @@\n-        public HATVectorStoreView(String varName, TypeElement resultType, int storeN, TypeElement vectorElementType, boolean isSharedOrPrivate, List<Value> operands) {\n-            super(varName, resultType, Vector.Shape.of(vectorElementType, storeN), operands);\n-            this.isSharedOrPrivate = isSharedOrPrivate;\n+        protected HATVectorStoreView(String varName, TypeElement resultType, Vector.Shape vectorShape, \/* boolean isSharedOrPrivate*\/ List<Value> operands) {\n+            super(varName, resultType, vectorShape, operands);\n@@ -327,1 +346,1 @@\n-        public HATVectorStoreView(HATVectorStoreView op, CodeContext copyContext) {\n+        protected HATVectorStoreView(HATVectorStoreView op, CodeContext copyContext) {\n@@ -329,1 +348,0 @@\n-            this.isSharedOrPrivate = op.isSharedOrPrivate;\n@@ -332,4 +350,19 @@\n-        @Override\n-        public Op transform(CodeContext copyContext, CodeTransformer opTransformer) {\n-            return new HATVectorStoreView(this, copyContext);\n-        }\n+        public static final class HATSharedVectorStoreView extends HATVectorStoreView implements Shared{\n+\n+            public HATSharedVectorStoreView(String varName, TypeElement resultType, Vector.Shape vectorShape, List<Value> operands) {\n+                super(varName, resultType, vectorShape, operands);\n+            }\n+\n+            public HATSharedVectorStoreView(HATSharedVectorStoreView op, CodeContext copyContext) {\n+                super(op, copyContext);\n+            }\n+\n+            @Override\n+            public Op transform(CodeContext copyContext, CodeTransformer opTransformer) {\n+                return new HATSharedVectorStoreView(this, copyContext);\n+            }\n+\n+            @Override\n+            public Map<String, Object> externalize() {\n+                return Map.of(\"hat.dialect.\" + vectorShape().typeElement() + \"SharedStoreView.\" + varName(), resultType());\n+            }\n@@ -337,3 +370,0 @@\n-        @Override\n-        public Map<String, Object> externalize() {\n-            return Map.of(\"hat.dialect.\" + vectorShape().typeElement() + \"StoreView.\" + varName(), resultType());\n@@ -341,0 +371,5 @@\n+        public static final class HATPrivateVectorStoreView extends HATVectorStoreView implements Private{\n+\n+            public HATPrivateVectorStoreView(String varName, TypeElement resultType, Vector.Shape vectorShape, List<Value> operands) {\n+                super(varName, resultType, vectorShape, operands);\n+            }\n@@ -342,2 +377,13 @@\n-        public boolean isSharedOrPrivate() {\n-            return this.isSharedOrPrivate;\n+            public HATPrivateVectorStoreView(HATPrivateVectorStoreView op, CodeContext copyContext) {\n+                super(op, copyContext);\n+            }\n+\n+            @Override\n+            public Op transform(CodeContext copyContext, CodeTransformer opTransformer) {\n+                return new HATPrivateVectorStoreView(this, copyContext);\n+            }\n+\n+            @Override\n+            public Map<String, Object> externalize() {\n+                return Map.of(\"hat.dialect.\" + vectorShape().typeElement() + \"PrivateStoreView.\" + varName(), resultType());\n+            }\n@@ -367,1 +413,0 @@\n-\n@@ -372,3 +417,0 @@\n-            if (!resultType.equals(vectorShape.typeElement())){\n-            \/\/    System.out.println(\"Differ \");\n-            }\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATVectorOp.java","additions":91,"deletions":49,"binary":false,"changes":140,"status":"modified"},{"patch":"@@ -132,8 +132,13 @@\n-                                HATVectorOp.HATVectorLoadOp vLoadOp = copyLocation(arrayLoadOp,new HATVectorOp.HATVectorLoadOp(\n-                                        name,\n-                                        CoreType.varType(((ArrayType) OpHelper.firstOperandOrThrow(arrayLoadOp).type()).componentType()),\n-                                        vectorShape, \/\/ seems like we might pass the hatVectorMetaData here...?\n-                                        HATPhaseUtils.isLocalSharedOrPrivate(arrayLoadOp),\n-                                        context.getValues(List.of(buffer, arrayLoadOp.operands().getLast()))\n-                                ));\n-                                context.mapValue(arrayLoadOp.result(), blockBuilder.op(vLoadOp));\n+                                HATVectorOp.HATVectorLoadOp vLoadOp = HATPhaseUtils.isLocalSharedOrPrivate(arrayLoadOp)\n+                                        ? new HATVectorOp.HATVectorLoadOp.HATSharedVectorLoadOp(\n+                                                name,\n+                                                CoreType.varType(((ArrayType) OpHelper.firstOperandOrThrow(arrayLoadOp).type()).componentType()),\n+                                                vectorShape,\n+                                                context.getValues(List.of(buffer, arrayLoadOp.operands().getLast())))\n+                                        :new HATVectorOp.HATVectorLoadOp.HATPrivateVectorLoadOp(\n+                                                name,\n+                                                CoreType.varType(((ArrayType) OpHelper.firstOperandOrThrow(arrayLoadOp).type()).componentType()),\n+                                                vectorShape,\n+                                                context.getValues(List.of(buffer, arrayLoadOp.operands().getLast()))\n+                                        );\n+                                context.mapValue(arrayLoadOp.result(), blockBuilder.op(copyLocation(arrayLoadOp,vLoadOp)));\n@@ -171,10 +176,14 @@\n-                                var vectorMetaData = getVectorShape(lookup(),classType);\n-                                HATVectorOp.HATVectorStoreView vStoreOp = copyLocation(arrayStoreOp,new HATVectorOp.HATVectorStoreView(\n-                                        name,\n-                                        resultType,\n-                                        vectorMetaData.lanes(),\n-                                        vectorMetaData.typeElement(),\n-                                        HATPhaseUtils.isLocalSharedOrPrivate(arrayStoreOp),\n-                                        context.getValues(List.of(buffer, arrayStoreOp.operands().getLast(), arrayStoreOp.operands().get(1)))\n-                                ));\n-                                context.mapValue(arrayStoreOp.result(), blockBuilder.op(vStoreOp));\n+                                var vectorShape = getVectorShape(lookup(),classType);\n+                                HATVectorOp.HATVectorStoreView vStoreOp = HATPhaseUtils.isLocalSharedOrPrivate(arrayStoreOp)\n+                                        ? new HATVectorOp.HATVectorStoreView.HATSharedVectorStoreView(\n+                                                name,\n+                                                resultType,\n+                                                vectorShape,\n+                                                context.getValues(List.of(buffer, arrayStoreOp.operands().getLast(), arrayStoreOp.operands().get(1))))\n+                                        : new HATVectorOp.HATVectorStoreView.HATPrivateVectorStoreView(\n+                                                name,\n+                                                resultType,\n+                                                vectorShape,\n+                                                context.getValues(List.of(buffer, arrayStoreOp.operands().getLast(), arrayStoreOp.operands().get(1)))\n+                                        );\n+                                context.mapValue(arrayStoreOp.result(), blockBuilder.op(copyLocation(arrayStoreOp,vStoreOp)));\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATArrayViewPhase.java","additions":27,"deletions":18,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -111,6 +111,11 @@\n-                HATVectorOp memoryViewOp = new HATVectorOp.HATVectorLoadOp(\n-                        varOp.varName(),\n-                        varOp.resultType(),\n-                        shape,\n-                        HATPhaseUtils.isSharedOrPrivate(invoke.resultFromFirstOperandOrNull()),\n-                        blockBuilder.context().getValues(invoke.op().operands())\n+                HATVectorOp memoryViewOp =  HATPhaseUtils.isSharedOrPrivate(invoke.resultFromFirstOperandOrNull())\n+                        ? new HATVectorOp.HATVectorLoadOp.HATSharedVectorLoadOp(\n+                                varOp.varName(),\n+                                varOp.resultType(),\n+                                shape,\n+                                blockBuilder.context().getValues(invoke.op().operands()))\n+                        : new HATVectorOp.HATVectorLoadOp.HATPrivateVectorLoadOp(\n+                                varOp.varName(),\n+                                varOp.resultType(),\n+                                shape,\n+                                blockBuilder.context().getValues(invoke.op().operands())\n@@ -151,2 +156,0 @@\n-                var varOp = invokeToVar.get(invokeOp);\n-                var vectorShape = vectorShapeMap.get(invokeOp);\n@@ -155,2 +158,1 @@\n-                      \/\/  invokeOp.resultType(),\n-                        vectorShape,\n+                        vectorShapeMap.get(invokeOp),\n@@ -159,1 +161,1 @@\n-                blockBuilder.context().mapValue(invokeOp.result(), blockBuilder.op(copyLocation(varOp,memoryViewOp)));\n+                blockBuilder.context().mapValue(invokeOp.result(), blockBuilder.op(copyLocation(invokeToVar.get(invokeOp),memoryViewOp)));\n@@ -243,2 +245,1 @@\n-                             BinaryOpEnum.of(invokeOp), \/\/ it looks like not all of these ops have varName maybe we need another class in the dialect\n-                           \/\/  invokeOp.resultType(),\n+                             BinaryOpEnum.of(invokeOp),\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATVectorPhase.java","additions":14,"deletions":13,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -110,1 +110,1 @@\n-                                invokeVar.varOpFromOperand(1),\n+                                invokeVar.varOpFromOperand(1) instanceof CoreOp.VarOp varOp?varOp.varName():null,\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATVectorSelectPhase.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -94,8 +94,13 @@\n-                HATVectorOp storeView = new HATVectorOp.HATVectorStoreView(\n-                        findNameVector(invoke.resultFromOperandNOrThrow(1)),\n-                        invoke.returnType(),\n-                        vectorShape.lanes(),\n-                        vectorShape.typeElement(),\n-                        findIsSharedOrPrivateSpace(invoke.op().operands().getFirst()),\n-                        context.getValues(invoke.op().operands())\n-                );\n+                HATVectorOp storeView = findIsSharedOrPrivateSpace(invoke.op().operands().getFirst())\n+                        ? new HATVectorOp.HATVectorStoreView.HATSharedVectorStoreView(\n+                                findNameVector(invoke.resultFromOperandNOrThrow(1)),\n+                                invoke.returnType(),\n+                                vectorShape,\n+                                \/\/vectorShape.typeElement(),\n+                                context.getValues(invoke.op().operands()))\n+                        : new HATVectorOp.HATVectorStoreView.HATPrivateVectorStoreView(\n+                                findNameVector(invoke.resultFromOperandNOrThrow(1)),\n+                                invoke.returnType(),\n+                                vectorShape,\/\/.lanes(),\n+                               \/\/ vectorShape.typeElement(),\n+                                context.getValues(invoke.op().operands()));\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATVectorStorePhase.java","additions":13,"deletions":8,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -730,1 +730,3 @@\n-\n+    public final T varName(String name) {\n+        return identifier(name);\n+    }\n@@ -733,1 +735,1 @@\n-        return identifier(varOp.varName());\n+        return varName(varOp.varName());\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/CodeBuilder.java","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"}]}