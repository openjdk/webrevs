{"files":[{"patch":"@@ -110,0 +110,1 @@\n+import static com.sun.tools.javac.code.TypeTag.ARRAY;\n@@ -1867,1 +1868,0 @@\n-            JavaType eType = typeToTypeElement(var.type);\n@@ -1873,2 +1873,12 @@\n-            pushBody(var, CoreType.functionType(varEType, eType));\n-            Op.Result varEResult = append(CoreOp.var(var.name.toString(), stack.block.parameters().get(0)));\n+            Type exprType = types.cvarUpperBound(tree.expr.type);\n+            Type elemtype = types.elemtype(exprType); \/\/ perhaps expr is an array?\n+            if (elemtype == null) {\n+                Type iterableType = types.asSuper(tree.expr.type, syms.iterableType.tsym);\n+                com.sun.tools.javac.util.List<Type> iterableParams = iterableType.allparams();\n+                elemtype = iterableParams.isEmpty()\n+                        ? syms.objectType\n+                        : types.wildUpperBound(iterableParams.head);\n+            }\n+            pushBody(var, CoreType.functionType(varEType, typeToTypeElement(elemtype)));\n+            var initVarExpr = convert(stack.block.parameters().get(0), var.type);\n+            Op.Result varEResult = append(CoreOp.var(var.name.toString(), initVarExpr));\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/internal\/ReflectMethods.java","additions":13,"deletions":3,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -25,0 +25,2 @@\n+\n+import java.util.List;\n@@ -720,0 +722,142 @@\n+\n+    @Reflect\n+    @IR(\"\"\"\n+            func @\"unboxForEachList\" (%0 : java.type:\"java.util.List<java.lang.Integer>\")java.type:\"int\" -> {\n+                %1 : Var<java.type:\"java.util.List<java.lang.Integer>\"> = var %0 @\"li\";\n+                %2 : java.type:\"int\" = constant @0;\n+                %3 : Var<java.type:\"int\"> = var %2 @\"j\";\n+                java.enhancedFor\n+                    ()java.type:\"java.util.List<java.lang.Integer>\" -> {\n+                        %4 : java.type:\"java.util.List<java.lang.Integer>\" = var.load %1;\n+                        yield %4;\n+                    }\n+                    (%5 : java.type:\"java.lang.Integer\")Var<java.type:\"int\"> -> {\n+                        %6 : java.type:\"int\" = invoke %5 @java.ref:\"java.lang.Integer::intValue():int\";\n+                        %7 : Var<java.type:\"int\"> = var %6 @\"i\";\n+                        yield %7;\n+                    }\n+                    (%8 : Var<java.type:\"int\">)java.type:\"void\" -> {\n+                        %9 : java.type:\"int\" = var.load %3;\n+                        %10 : java.type:\"int\" = var.load %8;\n+                        %11 : java.type:\"int\" = add %9 %10;\n+                        var.store %3 %11;\n+                        java.continue;\n+                    };\n+                %12 : java.type:\"int\" = var.load %3;\n+                return %12;\n+            };\n+            \"\"\")\n+    static int unboxForEachList(List<Integer> li) {\n+        int j = 0;\n+        for (int i : li) {\n+            j += i;\n+        }\n+        return j;\n+    }\n+\n+    @Reflect\n+    @IR(\"\"\"\n+            func @\"unboxForEachArray\" (%0 : java.type:\"java.lang.Integer[]\")java.type:\"int\" -> {\n+                %1 : Var<java.type:\"java.lang.Integer[]\"> = var %0 @\"is\";\n+                %2 : java.type:\"int\" = constant @0;\n+                %3 : Var<java.type:\"int\"> = var %2 @\"j\";\n+                java.enhancedFor\n+                    ()java.type:\"java.lang.Integer[]\" -> {\n+                        %4 : java.type:\"java.lang.Integer[]\" = var.load %1;\n+                        yield %4;\n+                    }\n+                    (%5 : java.type:\"java.lang.Integer\")Var<java.type:\"int\"> -> {\n+                        %6 : java.type:\"int\" = invoke %5 @java.ref:\"java.lang.Integer::intValue():int\";\n+                        %7 : Var<java.type:\"int\"> = var %6 @\"i\";\n+                        yield %7;\n+                    }\n+                    (%8 : Var<java.type:\"int\">)java.type:\"void\" -> {\n+                        %9 : java.type:\"int\" = var.load %3;\n+                        %10 : java.type:\"int\" = var.load %8;\n+                        %11 : java.type:\"int\" = add %9 %10;\n+                        var.store %3 %11;\n+                        java.continue;\n+                    };\n+                %12 : java.type:\"int\" = var.load %3;\n+                return %12;\n+            };\n+            \"\"\")\n+    static int unboxForEachArray(Integer[] is) {\n+        int j = 0;\n+        for (int i : is) {\n+            j += i;\n+        }\n+        return j;\n+    }\n+\n+    @Reflect\n+    @IR(\"\"\"\n+            func @\"unboxListRaw\" (%0 : java.type:\"java.util.List\")java.type:\"int\" -> {\n+                %1 : Var<java.type:\"java.util.List\"> = var %0 @\"li\";\n+                %2 : java.type:\"int\" = constant @0;\n+                %3 : Var<java.type:\"int\"> = var %2 @\"j\";\n+                java.enhancedFor\n+                    ()java.type:\"java.util.List\" -> {\n+                        %4 : java.type:\"java.util.List\" = var.load %1;\n+                        yield %4;\n+                    }\n+                    (%5 : java.type:\"java.lang.Object\")Var<java.type:\"java.lang.Object\"> -> {\n+                        %6 : Var<java.type:\"java.lang.Object\"> = var %5 @\"i\";\n+                        yield %6;\n+                    }\n+                    (%7 : Var<java.type:\"java.lang.Object\">)java.type:\"void\" -> {\n+                        %8 : java.type:\"int\" = var.load %3;\n+                        %9 : java.type:\"java.lang.Object\" = var.load %7;\n+                        %10 : java.type:\"java.lang.Integer\" = cast %9 @java.type:\"java.lang.Integer\";\n+                        %11 : java.type:\"int\" = invoke %10 @java.ref:\"java.lang.Integer::intValue():int\";\n+                        %12 : java.type:\"int\" = add %8 %11;\n+                        var.store %3 %12;\n+                        java.continue;\n+                    };\n+                %13 : java.type:\"int\" = var.load %3;\n+                return %13;\n+            };\n+            \"\"\")\n+    public static int unboxListRaw(List li) {\n+        int j = 0;\n+        for (Object i : li) {\n+            j += (int)i;\n+        }\n+        return j;\n+    }\n+\n+    @Reflect\n+    @IR(\"\"\"\n+            func @\"unboxListTvar\" (%0 : java.type:\"java.util.List<&BoxingConversionTest::unboxListTvar(java.util.List):int::<X extends java.lang.Integer>>\")java.type:\"int\" -> {\n+                %1 : Var<java.type:\"java.util.List<&BoxingConversionTest::unboxListTvar(java.util.List):int::<X extends java.lang.Integer>>\"> = var %0 @\"li\";\n+                %2 : java.type:\"int\" = constant @0;\n+                %3 : Var<java.type:\"int\"> = var %2 @\"j\";\n+                java.enhancedFor\n+                    ()java.type:\"java.util.List<&BoxingConversionTest::unboxListTvar(java.util.List):int::<X extends java.lang.Integer>>\" -> {\n+                        %4 : java.type:\"java.util.List<&BoxingConversionTest::unboxListTvar(java.util.List):int::<X extends java.lang.Integer>>\" = var.load %1;\n+                        yield %4;\n+                    }\n+                    (%5 : java.type:\"&BoxingConversionTest::unboxListTvar(java.util.List):int::<X extends java.lang.Integer>\")Var<java.type:\"int\"> -> {\n+                        %6 : java.type:\"java.lang.Integer\" = cast %5 @java.type:\"java.lang.Integer\";\n+                        %7 : java.type:\"int\" = invoke %6 @java.ref:\"java.lang.Integer::intValue():int\";\n+                        %8 : Var<java.type:\"int\"> = var %7 @\"i\";\n+                        yield %8;\n+                    }\n+                    (%9 : Var<java.type:\"int\">)java.type:\"void\" -> {\n+                        %10 : java.type:\"int\" = var.load %3;\n+                        %11 : java.type:\"int\" = var.load %9;\n+                        %12 : java.type:\"int\" = add %10 %11;\n+                        var.store %3 %12;\n+                        java.continue;\n+                    };\n+                %13 : java.type:\"int\" = var.load %3;\n+                return %13;\n+            };\n+            \"\"\")\n+    public static <X extends Integer> int unboxListTvar(List<X> li) {\n+        int j = 0;\n+        for (int i : li) {\n+            j += i;\n+        }\n+        return j;\n+    }\n","filename":"test\/langtools\/tools\/javac\/reflect\/BoxingConversionTest.java","additions":144,"deletions":0,"binary":false,"changes":144,"status":"modified"}]}