{"files":[{"patch":"@@ -374,0 +374,1 @@\n+            if (lambdaName == null) lambdaName = \"\";\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/dialect\/java\/JavaOp.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -45,4 +45,1 @@\n-import java.util.function.BiFunction;\n-import java.util.function.Function;\n-import java.util.function.IntSupplier;\n-import java.util.function.IntUnaryOperator;\n+import java.util.function.*;\n@@ -234,0 +231,9 @@\n+\n+    @Test\n+    public void testToFuncOp() {\n+        int a = 0, b = 0, c = 0;\n+        Consumer<Integer> lambda = (@Reflect Consumer<Integer>) (d) -> {d += a + b + c;};\n+        LambdaOp qop = (LambdaOp) Op.ofQuotable(lambda).get().op();\n+        FuncOp funcOp = qop.toFuncOp(null);\n+        System.out.println(funcOp.toText());\n+    }\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestLambdaOps.java","additions":10,"deletions":4,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -75,17 +75,2 @@\n-    public static int d(int i) {\n-        return (i \/ 4) + 9;\n-    }\n-\n-    @Reflect\n-    public static int e(int i) {\n-        return f(i) + c(i + 5);\n-    }\n-\n-    @Reflect\n-    public static int f(int i) {\n-        return c(i);\n-    }\n-\n-    @Reflect\n-    public static int g(int i, int j) {\n-        return i + j;\n+    public static int d(int i, int j) {\n+        return (c(i) \/ 4) + j;\n@@ -97,2 +82,2 @@\n-        JavaOp.LambdaOp lambdaOp = SSA.transform((JavaOp.LambdaOp) Op.ofQuotable(runnable).get().op());\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n+        LambdaOp lambdaOp = (LambdaOp) Op.ofQuotable(runnable).get().op();\n+        ModuleOp moduleOp = ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n@@ -106,2 +91,2 @@\n-        JavaOp.LambdaOp lambdaOp = SSA.transform((JavaOp.LambdaOp) Op.ofQuotable(runnable).get().op());\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n+        LambdaOp lambdaOp = (LambdaOp) Op.ofQuotable(runnable).get().op();\n+        ModuleOp moduleOp = ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n@@ -112,105 +97,0 @@\n-    @Test\n-    public void testSingleInvokeWithLambdaParam() {\n-        IntUnaryOperator iuo = (@Reflect IntUnaryOperator) (i) -> b(i);\n-        JavaOp.LambdaOp lambdaOp = SSA.transform((JavaOp.LambdaOp) Op.ofQuotable(iuo).get().op());\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n-        Assertions.assertTrue(moduleOp.functionTable().containsKey(\"b\"));\n-        Assertions.assertFalse(moduleOp.functionTable().containsKey(\"rootLambda\"));\n-    }\n-\n-    @Test\n-    public void testWithCapture() throws NoSuchMethodException {\n-        MethodRef bRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"b\", int.class));\n-        CoreOp.FuncOp f = func(\"f\", CoreType.functionType(VOID, INT))\n-                .body(block -> {\n-                    JavaOp.LambdaOp lambda = JavaOp.lambda(block.parentBody(),\n-                                    CoreType.functionType(VOID), type(IntUnaryOperator.class))\n-                            .body(lblock -> {\n-                                lblock.op(invoke(bRef, block.parameters().get(0)));\n-                                lblock.op(CoreOp.return_());\n-                            });\n-                    block.op(lambda);\n-                    block.op(CoreOp.return_());\n-                });\n-        JavaOp.LambdaOp lambdaOp = (JavaOp.LambdaOp) f.elements().filter(e -> e instanceof JavaOp.LambdaOp).findFirst().get();\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n-        Assertions.assertTrue(moduleOp.functionTable().containsKey(\"b\"));\n-        Assertions.assertFalse(moduleOp.functionTable().containsKey(\"rootLambda\"));\n-    }\n-\n-    \/\/ @Reflect\n-    \/\/ public static void testFunction4(int i) {\n-    \/\/     lambda((_) -> b(c(i * 2) + e(d(i))));\n-    \/\/ }\n-\n-    @Test\n-    public void testNested() throws NoSuchMethodException {\n-        MethodRef bRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"b\", int.class));\n-        MethodRef cRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"c\", int.class));\n-        MethodRef dRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"d\", int.class));\n-        MethodRef eRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"e\", int.class));\n-        CoreOp.FuncOp f = func(\"f\", CoreType.functionType(VOID, INT))\n-                .body(block -> {\n-                    JavaOp.LambdaOp lambda = JavaOp.lambda(block.parentBody(),\n-                                    CoreType.functionType(VOID, INT), type(IntUnaryOperator.class))\n-                            .body(lblock -> {\n-                                Block.Parameter li = block.parameters().get(0);\n-                                Op.Result var = lblock.op(var(li));\n-                                Op.Result constant = lblock.op(constant(INT, 2));\n-                                Op.Result varLoad = lblock.op(varLoad(var));\n-                                Op.Result mul = lblock.op(JavaOp.mul(varLoad, constant));\n-                                Op.Result qRes = lblock.op(invoke(cRef, mul));\n-                                Op.Result varLoad2 = lblock.op(varLoad(var));\n-                                Op.Result pRes = lblock.op(invoke(dRef, varLoad2));\n-                                Op.Result oRes = lblock.op(invoke(eRef, pRes));\n-                                Op.Result sum = lblock.op(add(qRes, oRes));\n-                                lblock.op(invoke(bRef, sum));\n-                                lblock.op(CoreOp.return_());\n-                            });\n-                    block.op(lambda);\n-                    block.op(CoreOp.return_());\n-                });\n-\n-        JavaOp.LambdaOp lambdaOp = (JavaOp.LambdaOp) f.elements().filter(e -> e instanceof JavaOp.LambdaOp).findFirst().get();\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n-        Assertions.assertTrue(moduleOp.functionTable().keySet().containsAll(List.of(\"rootLambda\", \"b\", \"c\", \"d\", \"e\")));\n-    }\n-\n-    \/\/ @Reflect\n-    \/\/ public static void testFunction5(int i) {\n-    \/\/     lambda((_) -> c(b(b(i))));\n-    \/\/ }\n-\n-    @Test\n-    public void testNested2() throws NoSuchMethodException {\n-        MethodRef bRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"b\", int.class));\n-        MethodRef cRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"c\", int.class));\n-        CoreOp.FuncOp f = func(\"f\", CoreType.functionType(VOID, INT))\n-                .body(block -> {\n-                    Block.Parameter i = block.parameters().get(0);\n-                    JavaOp.LambdaOp lambda = JavaOp.lambda(block.parentBody(),\n-                                    CoreType.functionType(VOID, INT), type(IntUnaryOperator.class))\n-                            .body(lblock -> {\n-                                Block.Parameter li = block.parameters().get(0);\n-                                Op.Result var = lblock.op(var(li));\n-                                Op.Result varLoad = lblock.op(varLoad(var));\n-                                Op.Result mRes = lblock.op(invoke(bRef, varLoad));\n-                                Op.Result mRes2 = lblock.op(invoke(bRef, mRes));\n-                                lblock.op(invoke(cRef, mRes2));\n-                                lblock.op(CoreOp.return_());\n-                            });\n-                    block.op(lambda);\n-                    block.op(CoreOp.return_());\n-                });\n-\n-        JavaOp.LambdaOp lambdaOp = (JavaOp.LambdaOp) f.elements().filter(e -> e instanceof JavaOp.LambdaOp).findFirst().get();\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n-        System.out.println(moduleOp.toText());\n-        Assertions.assertTrue(moduleOp.functionTable().keySet().containsAll(List.of(\"rootLambda\", \"b\", \"c\")));\n-    }\n-\n-    \/\/ @Reflect\n-    \/\/ public static void testFunction6(int i, int[] array) {\n-    \/\/     lambda((j) -> c(b(i) + array[j]));\n-    \/\/ }\n-\n@@ -219,29 +99,5 @@\n-        MethodRef bRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"b\", int.class));\n-        MethodRef cRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"c\", int.class));\n-        CoreOp.FuncOp f = func(\"f\", CoreType.functionType(VOID, INT, INT_ARRAY))\n-                .body(block -> {\n-                    JavaOp.LambdaOp lambda = JavaOp.lambda(block.parentBody(),\n-                                    CoreType.functionType(VOID, INT), type(IntUnaryOperator.class))\n-                            .body(lblock -> {\n-                                Block.Parameter li = block.parameters().get(0);\n-                                Block.Parameter larray = block.parameters().get(1);\n-                                Block.Parameter lj = lblock.parameters().get(0);\n-                                Op.Result vari = lblock.op(var(li));\n-                                Op.Result varArray = lblock.op(var(larray));\n-                                Op.Result varJ = lblock.op(var(lj));\n-                                Op.Result varLoad = lblock.op(varLoad(vari));\n-                                Op.Result mRes = lblock.op(invoke(bRef, varLoad));\n-                                Op.Result varArrayLoad = lblock.op(varLoad(varArray));\n-                                Op.Result varJLoad = lblock.op(varLoad(varJ));\n-                                Op.Result arrLoad = lblock.op(arrayLoadOp(varArrayLoad, varJLoad));\n-                                Op.Result sum = lblock.op(add(mRes, arrLoad));\n-                                lblock.op(invoke(cRef, sum));\n-                                lblock.op(CoreOp.return_());\n-                            });\n-                    block.op(lambda);\n-                    block.op(CoreOp.return_());\n-                });\n-\n-        JavaOp.LambdaOp lambdaOp = (JavaOp.LambdaOp) f.elements().filter(e -> e instanceof JavaOp.LambdaOp).findFirst().get();\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n-        System.out.println(moduleOp.toText());\n+        int i = 10;\n+        int[] array = new int[i];\n+        Consumer<Integer> lambda = (@Reflect Consumer<Integer>) (j) -> c(b(i) + array[j]);\n+        LambdaOp lambdaOp = (LambdaOp) Op.ofQuotable(lambda).get().op();\n+        ModuleOp moduleOp = ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n@@ -251,5 +107,0 @@\n-    \/\/ @Reflect\n-    \/\/ public static void testFunction7(int i, int j) {\n-    \/\/     lambda((k) -> c(b(i) + b(j) + b(k)));\n-    \/\/ }\n-\n@@ -257,35 +108,7 @@\n-    public void testNestedSum() throws NoSuchMethodException {\n-        MethodRef bRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"b\", int.class));\n-        MethodRef cRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"c\", int.class));\n-        CoreOp.FuncOp f = func(\"f\", CoreType.functionType(VOID, INT, INT))\n-                .body(block -> {\n-                    Block.Parameter i = block.parameters().get(0);\n-                    JavaOp.LambdaOp lambda = JavaOp.lambda(block.parentBody(),\n-                                    CoreType.functionType(VOID, INT), type(IntUnaryOperator.class))\n-                            .body(lblock -> {\n-                                Block.Parameter li = block.parameters().get(0);\n-                                Block.Parameter lj = block.parameters().get(1);\n-                                Block.Parameter lk = lblock.parameters().get(0);\n-                                Op.Result vari = lblock.op(var(li));\n-                                Op.Result varj = lblock.op(var(lj));\n-                                Op.Result vark = lblock.op(var(lk));\n-                                Op.Result variLoad = lblock.op(varLoad(vari));\n-                                Op.Result iRes = lblock.op(invoke(bRef, variLoad));\n-                                Op.Result varjLoad = lblock.op(varLoad(varj));\n-                                Op.Result jRes = lblock.op(invoke(bRef, varjLoad));\n-\n-                                Op.Result sum = lblock.op(add(iRes, jRes));\n-                                Op.Result varkLoad = lblock.op(varLoad(vark));\n-                                Op.Result kRes = lblock.op(invoke(bRef, varkLoad));\n-                                Op.Result ssum = lblock.op(add(sum, kRes));\n-\n-                                lblock.op(invoke(cRef, ssum));\n-                                lblock.op(CoreOp.return_());\n-                            });\n-                    block.op(lambda);\n-                    block.op(CoreOp.return_());\n-                });\n-\n-        JavaOp.LambdaOp lambdaOp = (JavaOp.LambdaOp) f.elements().filter(e -> e instanceof JavaOp.LambdaOp).findFirst().get();\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n-        Assertions.assertTrue(moduleOp.functionTable().keySet().containsAll(List.of(\"rootLambda\", \"b\", \"c\")));\n+    public void testTernary() throws NoSuchMethodException {\n+        int i = 0;\n+        int j = 0;\n+        Consumer<Integer> lambda = (@Reflect Consumer<Integer>) (k) -> c(i > k ? b(i) : c(d(j, k)));\n+        LambdaOp lambdaOp = (LambdaOp) Op.ofQuotable(lambda).get().op();\n+        ModuleOp moduleOp = ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n+        Assertions.assertTrue(moduleOp.functionTable().keySet().containsAll(List.of(\"rootLambda\", \"b\", \"c\", \"d\")));\n@@ -294,5 +117,0 @@\n-    \/\/ @Reflect\n-    \/\/ public static void testFunction8(int i, int j) {\n-    \/\/     lambda((k) -> c(1));\n-    \/\/ }\n-\n@@ -300,56 +118,4 @@\n-    public void testConstant() throws NoSuchMethodException {\n-        MethodRef cRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"c\", int.class));\n-        CoreOp.FuncOp f = func(\"f\", CoreType.functionType(VOID, INT, INT))\n-                .body(block -> {\n-                    Block.Parameter i = block.parameters().get(0);\n-                    JavaOp.LambdaOp lambda = JavaOp.lambda(block.parentBody(),\n-                                    CoreType.functionType(VOID, INT), type(IntUnaryOperator.class))\n-                            .body(lblock -> {\n-                                Op.Result constant = lblock.op(constant(INT, 1));\n-                                lblock.op(invoke(cRef, constant));\n-                                lblock.op(CoreOp.return_());\n-                            });\n-                    block.op(lambda);\n-                    block.op(CoreOp.return_());\n-                });\n-\n-        JavaOp.LambdaOp lambdaOp = (JavaOp.LambdaOp) f.elements().filter(e -> e instanceof JavaOp.LambdaOp).findFirst().get();\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n-        System.out.println(moduleOp.toText());\n-        Assertions.assertTrue(moduleOp.functionTable().keySet().containsAll(List.of(\"rootLambda\", \"c\")));\n-    }\n-\n-    \/\/ @Reflect\n-    \/\/ public static void testFunction9(int i, int j) {\n-    \/\/     lambda((k) -> c(g(i, k)));\n-    \/\/ }\n-\n-    @Test\n-    public void testSomeUsed() throws NoSuchMethodException {\n-        MethodRef cRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"c\", int.class));\n-        MethodRef gRef = MethodRef.method(TestModuleOp.class.getDeclaredMethod(\"g\", int.class, int.class));\n-        CoreOp.FuncOp f = func(\"f\", CoreType.functionType(VOID, INT, INT))\n-                .body(block -> {\n-                    JavaOp.LambdaOp lambda = JavaOp.lambda(block.parentBody(),\n-                                    CoreType.functionType(VOID, INT), type(IntUnaryOperator.class))\n-                            .body(lblock -> {\n-                                Op.Result vari = lblock.op(var(block.parameters().get(0)));\n-                                Op.Result vark = lblock.op(var(lblock.parameters().get(0)));\n-                                Op.Result variLoad = lblock.op(varLoad(vari));\n-                                Op.Result varkLoad = lblock.op(varLoad(vark));\n-                                Op.Result uRes = lblock.op(invoke(gRef, variLoad, varkLoad));\n-                                lblock.op(invoke(cRef, uRes));\n-                                lblock.op(CoreOp.return_());\n-                            });\n-                    block.op(lambda);\n-                    block.op(CoreOp.return_());\n-                });\n-\n-        JavaOp.LambdaOp lambdaOp = (JavaOp.LambdaOp) f.elements().filter(e -> e instanceof JavaOp.LambdaOp).findFirst().get();\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n-        Assertions.assertTrue(moduleOp.functionTable().keySet().containsAll(List.of(\"rootLambda\", \"c\", \"g\")));\n-    }\n-\n-    @Reflect\n-    public static void testFunction10(int i, int j) {\n-        lambda((k) -> c(i > k ? b(i) : b(j)));\n+    public void testRepeatLambdaName() {\n+        Runnable runnable = (@Reflect Runnable) () -> {};\n+        LambdaOp lambdaOp = (LambdaOp) Op.ofQuotable(runnable).get().op();\n+        Assertions.assertThrows(IllegalArgumentException.class, () -> ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"b\"));\n@@ -359,6 +125,12 @@\n-    public void testTernary() throws NoSuchMethodException {\n-        Method m = TestModuleOp.class.getDeclaredMethod(\"testFunction10\", int.class, int.class);\n-        CoreOp.FuncOp f = Op.ofMethod(m).get();\n-        JavaOp.LambdaOp lambdaOp = (JavaOp.LambdaOp) f.elements().filter(e -> e instanceof JavaOp.LambdaOp).findFirst().get();\n-        CoreOp.ModuleOp moduleOp = CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n-        Assertions.assertTrue(moduleOp.functionTable().keySet().containsAll(List.of(\"rootLambda\", \"b\", \"c\")));\n+    public void testMultipleStatements() throws NoSuchMethodException {\n+        int i = 0;\n+        int j = 0;\n+        Consumer<Integer> lambda = (@Reflect Consumer<Integer>) (k) -> {\n+           int temp = c(i);\n+           a();\n+           b(k * d(temp, j));\n+        };\n+        LambdaOp lambdaOp = (LambdaOp) Op.ofQuotable(lambda).get().op();\n+        ModuleOp moduleOp = ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"rootLambda\");\n+        System.out.println(moduleOp.toText());\n+        Assertions.assertTrue(moduleOp.functionTable().keySet().containsAll(List.of(\"rootLambda\", \"a\", \"b\", \"c\", \"d\")));\n@@ -367,4 +139,0 @@\n-    \/\/ @Reflect\n-    \/\/ public static void testFunction11(int i, int j) {\n-    \/\/     lambda((k) -> rootLambda());\n-    \/\/ }\n@@ -372,6 +140,0 @@\n-    @Test\n-    public void testRepeatLambdaName() {\n-        Runnable runnable = (@Reflect Runnable) () -> {};\n-        JavaOp.LambdaOp lambdaOp = SSA.transform((JavaOp.LambdaOp) Op.ofQuotable(runnable).get().op());\n-        Assertions.assertThrows(IllegalArgumentException.class, () -> CoreOp.ModuleOp.ofLambdaOp(lambdaOp, MethodHandles.lookup(), \"b\"));\n-    }\n","filename":"test\/jdk\/java\/lang\/reflect\/code\/TestModuleOp.java","additions":34,"deletions":272,"binary":false,"changes":306,"status":"modified"}]}