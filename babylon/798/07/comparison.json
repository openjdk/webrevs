{"files":[{"patch":"@@ -51,2 +51,2 @@\n-    public static ArrayList<AccessType> getAccessList(MethodHandles.Lookup lookup, CoreOp.FuncOp funcOp) {\n-        CoreOp.FuncOp inlinedFunc = inlineLoop(lookup, funcOp);\n+    public static ArrayList<AccessType> getAccessList(MethodHandles.Lookup lookup, CoreOp.FuncOp funcOp, Method methodOfFuncOp) {\n+        CoreOp.FuncOp inlinedFunc = inlineLoop(lookup, funcOp, methodOfFuncOp);\n@@ -68,1 +68,1 @@\n-    public static CoreOp.FuncOp inlineLoop(MethodHandles.Lookup lookup, CoreOp.FuncOp funcOp) {\n+     public static CoreOp.FuncOp inlineLoop(MethodHandles.Lookup lookup, CoreOp.FuncOp funcOp, Method methodOfFuncOp) {\n@@ -74,8 +74,8 @@\n-                if (invoke(lookup, op) instanceof Invoke invoke                         \/\/ always but pattern friendly\n-                        && invoke.resolvedMethodOrNull() instanceof Method method\n-                        && Op.ofMethod(method) instanceof Optional<CoreOp.FuncOp> optionalFuncOp \/\/ always but pattern friendly\n-                        && optionalFuncOp.isPresent()\n-                        && optionalFuncOp.get() instanceof CoreOp.FuncOp inline                  \/\/ always we just want var in scope\n-                ){\n-                    var ssaInline =SSA.transform(inline.transform(CodeTransformer.LOWERING_TRANSFORMER));\n-                    var exitBlockBuilder = Inliner.inline(\n+                if (invoke(lookup, op) instanceof Invoke invoke  \/\/ always but pattern friendly\n+                        && invoke.resolvedMethodOrNull() instanceof Method method) {\n+                    Optional<CoreOp.FuncOp> optionalFuncOp = Op.ofMethod(method);        \n+                    if(optionalFuncOp.isPresent() \n+                        && optionalFuncOp.get() instanceof CoreOp.FuncOp inline) {  \/\/ always we just want var in scope\n+\n+                        var ssaInline = SSA.transform(inline.transform(CodeTransformer.LOWERING_TRANSFORMER));\n+                        var exitBlockBuilder = Inliner.inline(\n@@ -89,1 +89,1 @@\n-                            }else{\n+                            } else{\n@@ -92,6 +92,12 @@\n-                    });\n-                    if (!exitBlockBuilder.parameters().isEmpty()) {\n-                        blockbuilder.context().mapValue(invoke.op().result(), exitBlockBuilder.parameters().getFirst());\n-                    }\n-                    changed.set(true);\n-                    return exitBlockBuilder.rebind(blockbuilder.context(), blockbuilder.transformer());\n+                        });\n+                        if (!exitBlockBuilder.parameters().isEmpty()) {\n+                            blockbuilder.context().mapValue(invoke.op().result(), exitBlockBuilder.parameters().getFirst());\n+                        }\n+                        changed.set(true);\n+                        return exitBlockBuilder.rebind(blockbuilder.context(), blockbuilder.transformer());\n+                    } else if (optionalFuncOp.isEmpty() \n+                                && method.getDeclaringClass().equals(methodOfFuncOp.getDeclaringClass())) {\n+                            \/\/ Expect @Reflect annotation to be present on all methods called from the kernel function\n+                            \/\/ that are defined in the same class as the kernel function.\n+                            throw new RuntimeException(\"Failed to inline \"+ method.getName() + \". Did you miss @Reflect annotation?\");\n+                    }            \n@@ -104,1 +110,1 @@\n-    }\n+    }        \n@@ -122,1 +128,1 @@\n-                    var ioh =  invoke(lookup,invokeOp);\n+                    var ioh = invoke(lookup,invokeOp);\n@@ -124,1 +130,1 @@\n-                    if ( ioh.refIs(MappableIface.class)) {\n+                    if (ioh.refIs(MappableIface.class)) {\n@@ -135,1 +141,1 @@\n-                    }else{\n+                    } else {\n@@ -142,1 +148,1 @@\n-                    }else{\n+                    } else {\n@@ -166,1 +172,1 @@\n-                }else{\n+                } else {\n@@ -169,1 +175,1 @@\n-            }else{\n+            } else {\n@@ -188,1 +194,1 @@\n-            }else{\n+            } else {\n","filename":"hat\/core\/src\/main\/java\/hat\/BufferTagger.java","additions":32,"deletions":26,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -85,1 +85,1 @@\n-        this.traits = new Traits(BufferTagger.getAccessList(computeContext.lookup(), entrypoint.funcOp()));\n+        this.traits = new Traits(BufferTagger.getAccessList(computeContext.lookup(), entrypoint.funcOp(), entrypoint.getMethod()));\n","filename":"hat\/core\/src\/main\/java\/hat\/callgraph\/KernelCallGraph.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -44,2 +44,1 @@\n-    @Reflect\n-    public static int squareit(int v) {\n+    public static int squareitWithoutReflectAnnotation(int v) {\n@@ -47,1 +46,0 @@\n-\n@@ -50,2 +48,1 @@\n-    @Reflect\n-    public static void squareKernel(@RO KernelContext kc, @RW S32Array array) {\n+    public static void squareKernelWithoutReflectAnnotation(@RO KernelContext kc, @RW S32Array array) {\n@@ -58,1 +55,8 @@\n-    public static void squareKernelWithoutReflectAnnotation(@RO KernelContext kc, @RW S32Array array) {\n+    public static void squareComputeWithoutReflectAnnotation(@RO ComputeContext cc, @RW S32Array array) {\n+        cc.dispatchKernel(NDRange.of1D(array.length()),\n+                kc -> squareKernel(kc, array)\n+        );\n+    }\n+\n+    @Reflect\n+    public static void squareKernelCallsSquareItWithoutReflectAnnotation(@RO KernelContext kc, @RW S32Array array) {\n@@ -61,1 +65,1 @@\n-            array.array(kc.gix, squareit(value));\n+            array.array(kc.gix, squareitWithoutReflectAnnotation(value));\n@@ -66,1 +70,1 @@\n-    public static void square(@RO ComputeContext cc, @RW S32Array array) {\n+    public static void squareComputeCallsSquareItWithoutReflectAnnotation(@RO ComputeContext cc, @RW S32Array array) {\n@@ -68,1 +72,1 @@\n-                kc -> squareKernelWithoutReflectAnnotation(kc, array)\n+                kc -> squareKernelCallsSquareItWithoutReflectAnnotation(kc, array)\n@@ -72,1 +76,15 @@\n-    public static void squareWithoutReflectAnnotation(@RO ComputeContext cc, @RW S32Array array) {\n+    @Reflect\n+    public static int squareit(int v) {\n+        return  v * v;\n+    }\n+\n+    @Reflect\n+    public static void squareKernel(@RO KernelContext kc, @RW S32Array array) {\n+        if (kc.gix < kc.gsx){\n+            int value = array.array(kc.gix);\n+            array.array(kc.gix, squareit(value));\n+        }\n+    }\n+\n+    @Reflect\n+    public static void square(@RO ComputeContext cc, @RW S32Array array) {\n@@ -74,1 +92,1 @@\n-                kc -> squareKernel(kc, array)\n+                kc -> squareKernelWithoutReflectAnnotation(kc, array)\n@@ -91,1 +109,1 @@\n-            accelerator.compute(cc -> TestMissingReflectAnnotation.squareWithoutReflectAnnotation(cc, array));\n+            accelerator.compute(cc -> TestMissingReflectAnnotation.squareComputeWithoutReflectAnnotation(cc, array));\n@@ -119,0 +137,20 @@\n+\n+    @HatTest\n+    @Reflect\n+    public static void testTransitiveMethodFromKernelWithoutReflectAnnotation() {\n+        final int size = 64;\n+        var accelerator = new Accelerator(MethodHandles.lookup(), Backend.FIRST);\n+        var array = S32Array.create(accelerator, size);\n+\n+        for (int i = 0; i < array.length(); i++) {\n+            array.array(i, i);\n+        }\n+\n+        try {\n+            accelerator.compute(cc -> TestMissingReflectAnnotation.squareComputeCallsSquareItWithoutReflectAnnotation(cc, array));\n+        } catch (RuntimeException e) {\n+            HATAsserts.assertTrue(e.getMessage().contains(\"Failed to inline squareitWithoutReflectAnnotation. Did you miss @Reflect annotation?\"));\n+            return;\n+        }\n+        throw new HATExpectedFailureException(\"Failed to inline squareitWithoutReflectAnnotation. Did you miss @Reflect annotation?\");\n+    }\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestMissingReflectAnnotation.java","additions":50,"deletions":12,"binary":false,"changes":62,"status":"modified"}]}