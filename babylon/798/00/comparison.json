{"files":[{"patch":"@@ -206,1 +206,1 @@\n-        std::cerr << \"buildStatus =failed\" << std::endl;\n+        std::cerr << \"buildStatus = failed\" << std::endl;\n@@ -222,2 +222,0 @@\n-                delete[] log;\n-                log = nullptr;\n@@ -228,0 +226,4 @@\n+                    bool hasImplicitFunctionDeclError = (strstr(log, \"error: implicit declaration of function\") != nullptr);\n+                    if (hasImplicitFunctionDeclError) {\n+                        std::cerr << \"Did you miss @Reflect annotation on the above function?\" << std::endl;\n+                    }\n","filename":"hat\/backends\/ffi\/opencl\/src\/main\/native\/cpp\/opencl_backend.cpp","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -44,2 +44,1 @@\n-    @Reflect\n-    public static int squareit(int v) {\n+    public static int squareitWithoutReflectAnnotation(int v) {\n@@ -47,1 +46,0 @@\n-\n@@ -50,2 +48,1 @@\n-    @Reflect\n-    public static void squareKernel(@RO KernelContext kc, @RW S32Array array) {\n+    public static void squareKernelWithoutReflectAnnotation(@RO KernelContext kc, @RW S32Array array) {\n@@ -58,1 +55,8 @@\n-    public static void squareKernelWithoutReflectAnnotation(@RO KernelContext kc, @RW S32Array array) {\n+    public static void squareComputeWithoutReflectAnnotation(@RO ComputeContext cc, @RW S32Array array) {\n+        cc.dispatchKernel(NDRange.of1D(array.length()),\n+                kc -> squareKernel(kc, array)\n+        );\n+    }\n+\n+    @Reflect\n+    public static void squareKernelCallsSquareItWithoutReflectAnnotation(@RO KernelContext kc, @RW S32Array array) {\n@@ -61,1 +65,1 @@\n-            array.array(kc.gix, squareit(value));\n+            array.array(kc.gix, squareitWithoutReflectAnnotation(value));\n@@ -66,1 +70,1 @@\n-    public static void square(@RO ComputeContext cc, @RW S32Array array) {\n+    public static void squareComputeCallsSquareItWithoutReflectAnnotation(@RO ComputeContext cc, @RW S32Array array) {\n@@ -68,1 +72,1 @@\n-                kc -> squareKernelWithoutReflectAnnotation(kc, array)\n+                kc -> squareKernelCallsSquareItWithoutReflectAnnotation(kc, array)\n@@ -72,1 +76,15 @@\n-    public static void squareWithoutReflectAnnotation(@RO ComputeContext cc, @RW S32Array array) {\n+    @Reflect\n+    public static int squareit(int v) {\n+        return  v * v;\n+    }\n+\n+    @Reflect\n+    public static void squareKernel(@RO KernelContext kc, @RW S32Array array) {\n+        if (kc.gix < kc.gsx){\n+            int value = array.array(kc.gix);\n+            array.array(kc.gix, squareit(value));\n+        }\n+    }\n+\n+    @Reflect\n+    public static void square(@RO ComputeContext cc, @RW S32Array array) {\n@@ -74,1 +92,1 @@\n-                kc -> squareKernel(kc, array)\n+                kc -> squareKernelWithoutReflectAnnotation(kc, array)\n@@ -91,1 +109,1 @@\n-            accelerator.compute(cc -> TestMissingReflectAnnotation.squareWithoutReflectAnnotation(cc, array));\n+            accelerator.compute(cc -> TestMissingReflectAnnotation.squareComputeWithoutReflectAnnotation(cc, array));\n@@ -119,0 +137,20 @@\n+\n+    @HatTest\n+    @Reflect\n+    public static void testTransitiveMethoFromKernelWithoutReflectAnnotation() {\n+        final int size = 64;\n+        var accelerator = new Accelerator(MethodHandles.lookup(), Backend.FIRST);\n+        var array = S32Array.create(accelerator, size);\n+\n+        for (int i = 0; i < array.length(); i++) {\n+            array.array(i, i);\n+        }\n+\n+        try {\n+            accelerator.compute(cc -> TestMissingReflectAnnotation.squareComputeCallsSquareItWithoutReflectAnnotation(cc, array));\n+        } catch (RuntimeException e) {\n+            HATAsserts.assertTrue(e.getMessage().contains(\"OpenCL program failed to compile\"));\n+            return;\n+        }\n+        throw new HATExpectedFailureException(\"OpenCL program failed to compile\");\n+    }\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestMissingReflectAnnotation.java","additions":50,"deletions":12,"binary":false,"changes":62,"status":"modified"}]}