{"files":[{"patch":"@@ -35,0 +35,1 @@\n+import optkl.codebuilders.ScopedCodeBuilderContext;\n@@ -395,1 +396,1 @@\n-        return createCode(kernelCallGraph, new CudaHATKernelBuilder(), args);\n+        return createCode(kernelCallGraph, new CudaHATKernelBuilder(new ScopedCodeBuilderContext(kernelCallGraph.lookup(),kernelCallGraph.entrypoint.funcOp())), args);\n","filename":"hat\/backends\/ffi\/cuda\/src\/main\/java\/hat\/backend\/ffi\/CudaBackend.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -39,0 +39,4 @@\n+    protected CudaHATKernelBuilder(ScopedCodeBuilderContext scopedCodeBuilderContext) {\n+        super(scopedCodeBuilderContext);\n+    }\n+\n@@ -105,2 +109,2 @@\n-    public CudaHATKernelBuilder atomicInc(ScopedCodeBuilderContext buildContext, Op.Result instanceResult, String name){\n-        return identifier(\"atomicAdd\").paren(_ -> ampersand().recurse(buildContext, instanceResult.op()).rarrow().identifier(name).comma().literal(1));\n+    public CudaHATKernelBuilder atomicInc( Op.Result instanceResult, String name){\n+        return identifier(\"atomicAdd\").paren(_ -> ampersand().recurse( instanceResult.op()).rarrow().identifier(name).comma().literal(1));\n@@ -110,1 +114,1 @@\n-    public CudaHATKernelBuilder hatVectorStoreOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorStoreView hatVectorStoreView) {\n+    public CudaHATKernelBuilder hatVectorStoreOp( HATVectorOp.HATVectorStoreView hatVectorStoreView) {\n@@ -123,1 +127,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -130,1 +134,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -137,1 +141,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -146,1 +150,1 @@\n-    public CudaHATKernelBuilder hatBinaryVectorOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorBinaryOp hatVectorBinaryOp) {\n+    public CudaHATKernelBuilder hatBinaryVectorOp( HATVectorOp.HATVectorBinaryOp hatVectorBinaryOp) {\n@@ -159,1 +163,1 @@\n-            recurse(buildContext, hatVectorBinaryOp1);\n+            recurse( hatVectorBinaryOp1);\n@@ -167,1 +171,1 @@\n-            recurse(buildContext, hatVectorBinaryOp2);\n+            recurse( hatVectorBinaryOp2);\n@@ -179,1 +183,1 @@\n-                    recurse(buildContext, r.op());\n+                    recurse( r.op());\n@@ -189,1 +193,1 @@\n-                    recurse(buildContext, r.op());\n+                    recurse( r.op());\n@@ -201,1 +205,1 @@\n-    public CudaHATKernelBuilder hatVectorLoadOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorLoadOp hatVectorLoadOp) {\n+    public CudaHATKernelBuilder hatVectorLoadOp( HATVectorOp.HATVectorLoadOp hatVectorLoadOp) {\n@@ -215,1 +219,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -221,1 +225,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -230,1 +234,1 @@\n-    public CudaHATKernelBuilder hatSelectLoadOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorSelectLoadOp hatVSelectLoadOp) {\n+    public CudaHATKernelBuilder hatSelectLoadOp( HATVectorOp.HATVectorSelectLoadOp hatVSelectLoadOp) {\n@@ -238,1 +242,1 @@\n-    public CudaHATKernelBuilder hatSelectStoreOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorSelectStoreOp hatVSelectStoreOp) {\n+    public CudaHATKernelBuilder hatSelectStoreOp( HATVectorOp.HATVectorSelectStoreOp hatVSelectStoreOp) {\n@@ -250,1 +254,1 @@\n-                recurse(buildContext, r.op());\n+                recurse( r.op());\n@@ -257,1 +261,1 @@\n-    public CudaHATKernelBuilder hatF16ConvOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16ConvOp hatF16ConvOp) {\n+    public CudaHATKernelBuilder hatF16ConvOp( HATF16Op.HATF16ConvOp hatF16ConvOp) {\n@@ -267,1 +271,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -274,1 +278,1 @@\n-    public CudaHATKernelBuilder hatF16ToFloatConvOp(ScopedCodeBuilderContext builderContext, HATF16Op.HATF16ToFloatConvOp hatF16ToFloatConvOp) {\n+    public CudaHATKernelBuilder hatF16ToFloatConvOp( HATF16Op.HATF16ToFloatConvOp hatF16ToFloatConvOp) {\n@@ -279,1 +283,1 @@\n-            recurse(builderContext, r.op());\n+            recurse( r.op());\n@@ -291,1 +295,1 @@\n-    public CudaHATKernelBuilder hatVectorVarOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorVarOp hatVectorVarOp) {\n+    public CudaHATKernelBuilder hatVectorVarOp( HATVectorOp.HATVectorVarOp hatVectorVarOp) {\n@@ -304,1 +308,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -310,1 +314,1 @@\n-    public CudaHATKernelBuilder genVectorIdentifier(ScopedCodeBuilderContext builderContext, HATVectorOp.HATVectorOfOp hatVectorOfOp) {\n+    public CudaHATKernelBuilder genVectorIdentifier( HATVectorOp.HATVectorOfOp hatVectorOfOp) {\n@@ -316,1 +320,1 @@\n-    public CudaHATKernelBuilder hatF16BinaryOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16BinaryOp hatF16BinaryOp) {\n+    public CudaHATKernelBuilder hatF16BinaryOp( HATF16Op.HATF16BinaryOp hatF16BinaryOp) {\n@@ -330,1 +334,1 @@\n-            recurse(buildContext, r.op());\n+            recurse(r.op());\n@@ -349,1 +353,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n","filename":"hat\/backends\/ffi\/cuda\/src\/main\/java\/hat\/backend\/ffi\/CudaHATKernelBuilder.java","additions":31,"deletions":27,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import optkl.codebuilders.ScopedCodeBuilderContext;\n@@ -68,1 +69,1 @@\n-        return createCode(kernelCallGraph, new OpenCLHATKernelBuilder(), args);\n+        return createCode(kernelCallGraph, new OpenCLHATKernelBuilder(new ScopedCodeBuilderContext(kernelCallGraph.lookup(),kernelCallGraph.entrypoint.funcOp())), args);\n","filename":"hat\/backends\/ffi\/opencl\/src\/main\/java\/hat\/backend\/ffi\/OpenCLBackend.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -38,0 +38,4 @@\n+    protected OpenCLHATKernelBuilder(ScopedCodeBuilderContext scopedCodeBuilderContext) {\n+        super(scopedCodeBuilderContext);\n+    }\n+\n@@ -84,2 +88,2 @@\n-    public OpenCLHATKernelBuilder atomicInc(ScopedCodeBuilderContext buildContext, Op.Result instanceResult, String name) {\n-        return identifier(\"atomic_inc\").paren(_ -> ampersand().recurse(buildContext, instanceResult.op()).rarrow().identifier(name));\n+    public OpenCLHATKernelBuilder atomicInc( Op.Result instanceResult, String name) {\n+        return identifier(\"atomic_inc\").paren(_ -> ampersand().recurse( instanceResult.op()).rarrow().identifier(name));\n@@ -89,1 +93,1 @@\n-    public OpenCLHATKernelBuilder hatVectorStoreOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorStoreView hatVectorStoreView) {\n+    public OpenCLHATKernelBuilder hatVectorStoreOp( HATVectorOp.HATVectorStoreView hatVectorStoreView) {\n@@ -97,1 +101,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -108,1 +112,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -114,1 +118,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -122,1 +126,1 @@\n-    public OpenCLHATKernelBuilder hatBinaryVectorOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorBinaryOp hatVectorBinaryOp) {\n+    public OpenCLHATKernelBuilder hatBinaryVectorOp( HATVectorOp.HATVectorBinaryOp hatVectorBinaryOp) {\n@@ -129,1 +133,1 @@\n-            recurse(buildContext, r.op());\n+            recurse(r.op());\n@@ -134,1 +138,1 @@\n-            recurse(buildContext, r.op());\n+            recurse(r.op());\n@@ -141,1 +145,1 @@\n-    public OpenCLHATKernelBuilder hatVectorLoadOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorLoadOp hatVectorLoadOp) {\n+    public OpenCLHATKernelBuilder hatVectorLoadOp( HATVectorOp.HATVectorLoadOp hatVectorLoadOp) {\n@@ -145,1 +149,1 @@\n-                recurse(buildContext, r.op());\n+                recurse( r.op());\n@@ -150,1 +154,1 @@\n-                    recurse(buildContext, r.op());\n+                    recurse( r.op());\n@@ -158,1 +162,1 @@\n-    public OpenCLHATKernelBuilder hatSelectLoadOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorSelectLoadOp hatVSelectLoadOp) {\n+    public OpenCLHATKernelBuilder hatSelectLoadOp( HATVectorOp.HATVectorSelectLoadOp hatVSelectLoadOp) {\n@@ -160,1 +164,1 @@\n-            recurse(buildContext, vLoadOp);\n+            recurse( vLoadOp);\n@@ -169,1 +173,1 @@\n-    public OpenCLHATKernelBuilder hatSelectStoreOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorSelectStoreOp hatVSelectStoreOp) {\n+    public OpenCLHATKernelBuilder hatSelectStoreOp( HATVectorOp.HATVectorSelectStoreOp hatVSelectStoreOp) {\n@@ -171,1 +175,1 @@\n-            recurse(buildContext, vLoadOp);\n+            recurse( vLoadOp);\n@@ -184,1 +188,1 @@\n-                recurse(buildContext, r.op());\n+                recurse(r.op());\n@@ -191,1 +195,1 @@\n-    public OpenCLHATKernelBuilder hatF16ConvOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16ConvOp hatF16ConvOp) {\n+    public OpenCLHATKernelBuilder hatF16ConvOp( HATF16Op.HATF16ConvOp hatF16ConvOp) {\n@@ -209,1 +213,1 @@\n-                recurse(buildContext, r.op());\n+                recurse( r.op());\n@@ -219,1 +223,1 @@\n-    public OpenCLHATKernelBuilder hatVectorVarOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorVarOp hatVectorVarOp) {\n+    public OpenCLHATKernelBuilder hatVectorVarOp( HATVectorOp.HATVectorVarOp hatVectorVarOp) {\n@@ -225,1 +229,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -231,1 +235,1 @@\n-    public OpenCLHATKernelBuilder genVectorIdentifier(ScopedCodeBuilderContext builderContext, HATVectorOp.HATVectorOfOp hatVectorOfOp) {\n+    public OpenCLHATKernelBuilder genVectorIdentifier( HATVectorOp.HATVectorOfOp hatVectorOfOp) {\n@@ -236,1 +240,1 @@\n-    public OpenCLHATKernelBuilder hatF16ToFloatConvOp(ScopedCodeBuilderContext builderContext, HATF16Op.HATF16ToFloatConvOp hatF16ToFloatConvOp) {\n+    public OpenCLHATKernelBuilder hatF16ToFloatConvOp( HATF16Op.HATF16ToFloatConvOp hatF16ToFloatConvOp) {\n@@ -253,1 +257,1 @@\n-            recurse(builderContext, r.op());\n+            recurse( r.op());\n","filename":"hat\/backends\/ffi\/opencl\/src\/main\/java\/hat\/backend\/ffi\/OpenCLHATKernelBuilder.java","additions":28,"deletions":24,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+import optkl.codebuilders.ScopedCodeBuilderContext;\n@@ -72,1 +73,1 @@\n-            String code = createCode(kernelCallGraph, new OpenCLJExtractedHATKernelBuilder(), args);\n+            String code = createCode(kernelCallGraph, new OpenCLJExtractedHATKernelBuilder(new ScopedCodeBuilderContext(kernelCallGraph.lookup(),kernelCallGraph.entrypoint.funcOp())), args);\n","filename":"hat\/backends\/jextracted\/opencl\/src\/main\/java\/hat\/backend\/jextracted\/OpenCLBackend.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -37,0 +37,4 @@\n+    protected OpenCLJExtractedHATKernelBuilder(ScopedCodeBuilderContext scopedCodeBuilderContext) {\n+        super(scopedCodeBuilderContext);\n+    }\n+\n@@ -70,2 +74,2 @@\n-    public OpenCLJExtractedHATKernelBuilder atomicInc(ScopedCodeBuilderContext buildContext, Op.Result instanceResult, String name) {\n-        return identifier(\"atomic_inc\").paren(_ -> ampersand().recurse(buildContext, instanceResult.op()).rarrow().identifier(name));\n+    public OpenCLJExtractedHATKernelBuilder atomicInc( Op.Result instanceResult, String name) {\n+        return identifier(\"atomic_inc\").paren(_ -> ampersand().recurse( instanceResult.op()).rarrow().identifier(name));\n@@ -75,1 +79,1 @@\n-    public OpenCLJExtractedHATKernelBuilder hatVectorStoreOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorStoreView hatVectorStoreView) {\n+    public OpenCLJExtractedHATKernelBuilder hatVectorStoreOp( HATVectorOp.HATVectorStoreView hatVectorStoreView) {\n@@ -90,1 +94,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -96,1 +100,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -104,1 +108,1 @@\n-    public OpenCLJExtractedHATKernelBuilder hatBinaryVectorOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorBinaryOp hatVectorBinaryOp) {\n+    public OpenCLJExtractedHATKernelBuilder hatBinaryVectorOp( HATVectorOp.HATVectorBinaryOp hatVectorBinaryOp) {\n@@ -111,1 +115,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -116,1 +120,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -123,1 +127,1 @@\n-    public OpenCLJExtractedHATKernelBuilder hatVectorLoadOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorLoadOp hatVectorLoadOp) {\n+    public OpenCLJExtractedHATKernelBuilder hatVectorLoadOp( HATVectorOp.HATVectorLoadOp hatVectorLoadOp) {\n@@ -135,1 +139,1 @@\n-            recurse(buildContext, r.op());\n+            recurse(r.op());\n@@ -141,1 +145,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -148,1 +152,1 @@\n-    public OpenCLJExtractedHATKernelBuilder hatSelectLoadOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorSelectLoadOp hatVSelectLoadOp) {\n+    public OpenCLJExtractedHATKernelBuilder hatSelectLoadOp( HATVectorOp.HATVectorSelectLoadOp hatVSelectLoadOp) {\n@@ -156,1 +160,1 @@\n-    public OpenCLJExtractedHATKernelBuilder hatSelectStoreOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorSelectStoreOp hatVSelectStoreOp) {\n+    public OpenCLJExtractedHATKernelBuilder hatSelectStoreOp( HATVectorOp.HATVectorSelectStoreOp hatVSelectStoreOp) {\n@@ -165,1 +169,1 @@\n-                recurse(buildContext, r.op());\n+                recurse( r.op());\n@@ -172,1 +176,1 @@\n-    public OpenCLJExtractedHATKernelBuilder hatF16ConvOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16ConvOp hatF16ConvOp) {\n+    public OpenCLJExtractedHATKernelBuilder hatF16ConvOp( HATF16Op.HATF16ConvOp hatF16ConvOp) {\n@@ -175,1 +179,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -181,1 +185,1 @@\n-    public OpenCLJExtractedHATKernelBuilder hatVectorVarOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorVarOp hatVectorVarOp) {\n+    public OpenCLJExtractedHATKernelBuilder hatVectorVarOp( HATVectorOp.HATVectorVarOp hatVectorVarOp) {\n@@ -189,1 +193,1 @@\n-            recurse(buildContext, r.op());\n+            recurse( r.op());\n@@ -195,1 +199,1 @@\n-    public OpenCLJExtractedHATKernelBuilder genVectorIdentifier(ScopedCodeBuilderContext builderContext, HATVectorOp.HATVectorOfOp hatVectorOfOp) {\n+    public OpenCLJExtractedHATKernelBuilder genVectorIdentifier( HATVectorOp.HATVectorOfOp hatVectorOfOp) {\n@@ -200,1 +204,1 @@\n-    public OpenCLJExtractedHATKernelBuilder hatF16ToFloatConvOp(ScopedCodeBuilderContext builderContext, HATF16Op.HATF16ToFloatConvOp hatF16ToFloatConvOp) {\n+    public OpenCLJExtractedHATKernelBuilder hatF16ToFloatConvOp( HATF16Op.HATF16ToFloatConvOp hatF16ToFloatConvOp) {\n","filename":"hat\/backends\/jextracted\/opencl\/src\/main\/java\/hat\/backend\/jextracted\/OpenCLJExtractedHATKernelBuilder.java","additions":24,"deletions":20,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -34,1 +34,5 @@\n-public abstract class C99HATCodeBuilder<T extends C99HATCodeBuilder<T>> extends C99CodeBuilder<T> implements BabylonOpDispatcher<T, ScopedCodeBuilderContext> {\n+public abstract class C99HATCodeBuilder<T extends C99HATCodeBuilder<T>> extends C99CodeBuilder<T>{\n+\n+    protected C99HATCodeBuilder(ScopedCodeBuilderContext scopedCodeBuilderContext) {\n+        super(scopedCodeBuilderContext);\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/C99HATCodeBuilder.java","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -34,0 +34,4 @@\n+    protected C99HATComputeBuilder(ScopedCodeBuilderContext scopedCodeBuilderContext) {\n+        super(scopedCodeBuilderContext);\n+    }\n+\n@@ -38,2 +42,2 @@\n-    public final  T compute(ScopedCodeBuilderContext buildContext) {\n-        computeDeclaration(buildContext.funcOp.resultType(), buildContext.funcOp.funcName());\n+    public final  T compute() {\n+        computeDeclaration(scopedCodeBuilderContext().funcOp().resultType(), scopedCodeBuilderContext().funcOp().funcName());\n@@ -42,2 +46,2 @@\n-                        buildContext.paramTable.list(),\n-                        param -> declareParam(buildContext, param)\n+                        scopedCodeBuilderContext().paramTable.list(),\n+                        param -> declareParam( param)\n@@ -49,2 +53,2 @@\n-                        OpHelper.Statement.statements(buildContext.funcOp.bodies().getFirst().entryBlock()),\n-                        statement ->statement(buildContext,statement).nl()\n+                        OpHelper.Statement.statements(scopedCodeBuilderContext().funcOp().bodies().getFirst().entryBlock()),\n+                        statement ->statement(statement).nl()\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/C99HATComputeBuilder.java","additions":10,"deletions":6,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+import optkl.codebuilders.ScopedCodeBuilderContext;\n@@ -32,0 +33,1 @@\n+import java.lang.invoke.MethodHandles;\n@@ -37,1 +39,5 @@\n-   public final  C99HATConfigBuilder staticConstInt(String name, int padWidth, int value) {\n+    public C99HATConfigBuilder(ScopedCodeBuilderContext scopedCodeBuilderContext) {\n+        super(scopedCodeBuilderContext);\n+    }\n+\n+    public final  C99HATConfigBuilder staticConstInt(String name, int padWidth, int value) {\n@@ -88,2 +94,1 @@\n-\n-        C99HATConfigBuilder cb = new C99HATConfigBuilder();\n+        C99HATConfigBuilder cb = new C99HATConfigBuilder(new ScopedCodeBuilderContext(MethodHandles.lookup(),null));\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/C99HATConfigBuilder.java","additions":8,"deletions":3,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -68,0 +68,4 @@\n+    protected C99HATKernelBuilder(ScopedCodeBuilderContext scopedCodeBuilderContext) {\n+        super(scopedCodeBuilderContext);\n+    }\n+\n@@ -150,1 +154,1 @@\n-    public final T hatThreadIdOp(ScopedCodeBuilderContext buildContext, HATThreadOp threadOp) {\n+    public final T hatThreadIdOp( HATThreadOp threadOp) {\n@@ -175,2 +179,2 @@\n-    public final  T functionDeclaration(ScopedCodeBuilderContext codeBuilderContext, JavaType javaType, CoreOp.FuncOp funcOp) {\n-        return HAT_FUNC().space().type(codeBuilderContext,javaType).space().funcName(funcOp);\n+    public final  T functionDeclaration( JavaType javaType, CoreOp.FuncOp funcOp) {\n+        return HAT_FUNC().space().type(javaType).space().funcName(funcOp);\n@@ -307,1 +311,1 @@\n-    public final T hatBarrierOp(ScopedCodeBuilderContext buildContext, HATBarrierOp barrierOp) {\n+    public final T hatBarrierOp(HATBarrierOp barrierOp) {\n@@ -312,1 +316,1 @@\n-    public final T hatLocalVarOp(ScopedCodeBuilderContext buildContext, HATMemoryVarOp.HATLocalVarOp hatLocalVarOp) {\n+    public final T hatLocalVarOp( HATMemoryVarOp.HATLocalVarOp hatLocalVarOp) {\n@@ -317,1 +321,1 @@\n-    public final T hatPrivateVarOp(ScopedCodeBuilderContext buildContext, HATMemoryVarOp.HATPrivateVarOp hatLocalVarOp) {\n+    public final T hatPrivateVarOp( HATMemoryVarOp.HATPrivateVarOp hatLocalVarOp) {\n@@ -331,2 +335,2 @@\n-    public final T fieldLoadOp(ScopedCodeBuilderContext buildContext, JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp) {\n-        var fieldAccess = fieldAccess(buildContext.lookup,fieldLoadOp);\n+    public final T fieldLoadOp( JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp) {\n+        var fieldAccess = fieldAccess(scopedCodeBuilderContext().lookup(),fieldLoadOp);\n@@ -342,2 +346,2 @@\n-    public final  T type(ScopedCodeBuilderContext buildContext, JavaType javaType) {\n-        if (javaType instanceof ClassType classType && OpHelper.isAssignable(buildContext.lookup, javaType, MappableIface.class)) {\n+    public final  T type( JavaType javaType) {\n+        if (javaType instanceof ClassType classType && OpHelper.isAssignable(scopedCodeBuilderContext().lookup(), javaType, MappableIface.class)) {\n@@ -345,1 +349,1 @@\n-        } else if (OpHelper.isAssignable(buildContext.lookup, javaType,KernelContext.class)) {\n+        } else if (OpHelper.isAssignable(scopedCodeBuilderContext().lookup(), javaType,KernelContext.class)) {\n@@ -347,1 +351,1 @@\n-        } else if (OpHelper.isAssignable(buildContext.lookup, javaType,F16.class)) {\/\/ TODO: update this with a custom op, to avoid direct use of Impls\n+        } else if (OpHelper.isAssignable(scopedCodeBuilderContext().lookup(), javaType,F16.class)) {\/\/ TODO: update this with a custom op, to avoid direct use of Impls\n@@ -349,1 +353,1 @@\n-        } else if (OpHelper.isAssignable(buildContext.lookup, javaType,BF16.class)) {\/\/ TODO: update this with a custom op, to avoid direct use of Impls\n+        } else if (OpHelper.isAssignable(scopedCodeBuilderContext().lookup(), javaType,BF16.class)) {\/\/ TODO: update this with a custom op, to avoid direct use of Impls\n@@ -361,1 +365,1 @@\n-              functionDeclaration(buildContext,(JavaType) funcOp.body().yieldType(), funcOp);\n+              functionDeclaration((JavaType) funcOp.body().yieldType(), funcOp);\n@@ -365,1 +369,1 @@\n-                            param -> declareParam(buildContext,param)\n+                            this::declareParam\n@@ -372,1 +376,1 @@\n-                        statement->statement(buildContext,statement)\n+                        this::statement\n@@ -381,2 +385,2 @@\n-        buildContext.funcScope(buildContext.funcOp, () ->\n-                kernelDeclaration(buildContext.funcOp)\n+        buildContext.funcScope(buildContext.funcOp(), () ->\n+                kernelDeclaration(buildContext.funcOp())\n@@ -385,1 +389,1 @@\n-                    param -> declareParam(buildContext,param))\n+                        this::declareParam)\n@@ -388,2 +392,2 @@\n-                    OpHelper.Statement.statements(buildContext.funcOp.bodies().getFirst().entryBlock()),\n-                    statement ->statement(buildContext,statement)\n+                    OpHelper.Statement.statements(buildContext.funcOp().bodies().getFirst().entryBlock()),\n+                        this::statement\n@@ -398,1 +402,1 @@\n-    public final T hatVectorVarLoadOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorVarLoadOp hatVectorVarLoadOp) {\n+    public final T hatVectorVarLoadOp( HATVectorOp.HATVectorVarLoadOp hatVectorVarLoadOp) {\n@@ -411,1 +415,1 @@\n-    public final T hatF16VarOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16VarOp hatF16VarOp) {\n+    public final T hatF16VarOp( HATF16Op.HATF16VarOp hatF16VarOp) {\n@@ -419,1 +423,1 @@\n-                _->recurse(buildContext, OpHelper.asResultOrThrow(hatF16VarOp.operands().getFirst()).op()));\n+                _->recurse( OpHelper.asResultOrThrow(hatF16VarOp.operands().getFirst()).op()));\n@@ -438,1 +442,1 @@\n-    private final T binaryOperationsForBfloat16(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16BinaryOp hatf16BinaryOp) {\n+    private final T binaryOperationsForBfloat16( HATF16Op.HATF16BinaryOp hatf16BinaryOp) {\n@@ -448,1 +452,1 @@\n-                recurse(buildContext, OpHelper.asResultOrThrow(hatf16BinaryOp.operands().getFirst()).op());\n+                recurse( OpHelper.asResultOrThrow(hatf16BinaryOp.operands().getFirst()).op());\n@@ -466,1 +470,1 @@\n-                recurse(buildContext, OpHelper.asResultOrThrow(hatf16BinaryOp.operands().get(1)).op());\n+                recurse(OpHelper.asResultOrThrow(hatf16BinaryOp.operands().get(1)).op());\n@@ -483,1 +487,1 @@\n-    public T hatF16BinaryOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16BinaryOp hatF16BinaryOp) {\n+    public T hatF16BinaryOp( HATF16Op.HATF16BinaryOp hatF16BinaryOp) {\n@@ -486,1 +490,1 @@\n-            return binaryOperationsForBfloat16(buildContext, hatF16BinaryOp);\n+            return binaryOperationsForBfloat16( hatF16BinaryOp);\n@@ -491,1 +495,1 @@\n-                recurse(buildContext, OpHelper.asResultOrThrow(hatF16BinaryOp.operands().getFirst()).op());\n+                recurse( OpHelper.asResultOrThrow(hatF16BinaryOp.operands().getFirst()).op());\n@@ -500,1 +504,1 @@\n-                recurse(buildContext, OpHelper.asResultOrThrow(hatF16BinaryOp.operands().get(1)).op());\n+                recurse( OpHelper.asResultOrThrow(hatF16BinaryOp.operands().get(1)).op());\n@@ -513,1 +517,1 @@\n-    public final T hatF16VarLoadOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16VarLoadOp hatF16VarLoadOp) {\n+    public final T hatF16VarLoadOp( HATF16Op.HATF16VarLoadOp hatF16VarLoadOp) {\n@@ -518,1 +522,1 @@\n-    public final T hatVectorMakeOf(ScopedCodeBuilderContext builderContext, HATVectorOp.HATVectorMakeOfOp hatVectorMakeOfOp) {\n+    public final T hatVectorMakeOf( HATVectorOp.HATVectorMakeOfOp hatVectorMakeOfOp) {\n@@ -522,1 +526,1 @@\n-    public abstract T genVectorIdentifier(ScopedCodeBuilderContext builderContext, HATVectorOp.HATVectorOfOp hatVectorOfOp);\n+    public abstract T genVectorIdentifier( HATVectorOp.HATVectorOfOp hatVectorOfOp);\n@@ -525,2 +529,2 @@\n-    public final T hatVectorOfOps(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorOfOp hatVectorOp) {\n-        return genVectorIdentifier(buildContext, hatVectorOp)\n+    public final T hatVectorOfOps( HATVectorOp.HATVectorOfOp hatVectorOp) {\n+        return genVectorIdentifier( hatVectorOp)\n@@ -529,1 +533,1 @@\n-                        operand -> recurse(buildContext, OpHelper.asResultOrThrow(operand).op()))\n+                        operand -> recurse( OpHelper.asResultOrThrow(operand).op()))\n@@ -534,1 +538,1 @@\n-    public final T hatPrivateVarInitOp(ScopedCodeBuilderContext builderContext, HATMemoryVarOp.HATPrivateInitVarOp hatPrivateInitVarOp) {\n+    public final T hatPrivateVarInitOp( HATMemoryVarOp.HATPrivateInitVarOp hatPrivateInitVarOp) {\n@@ -538,1 +542,1 @@\n-                        _->recurse(builderContext,OpHelper.asResultOrThrow(hatPrivateInitVarOp.operands().getFirst()).op()));\n+                        _->recurse(OpHelper.asResultOrThrow(hatPrivateInitVarOp.operands().getFirst()).op()));\n@@ -542,2 +546,2 @@\n-    public final T hatMemoryLoadOp(ScopedCodeBuilderContext builderContext, HATMemoryDefOp.HATMemoryLoadOp hatMemoryLoadOp) {\n-        return recurse(builderContext, OpHelper.asResultOrThrow(hatMemoryLoadOp.operands().getFirst()).op())\n+    public final T hatMemoryLoadOp( HATMemoryDefOp.HATMemoryLoadOp hatMemoryLoadOp) {\n+        return recurse( OpHelper.asResultOrThrow(hatMemoryLoadOp.operands().getFirst()).op())\n@@ -546,1 +550,1 @@\n-                   sbrace(_-> recurse(builderContext, OpHelper.asResultOrThrow(hatMemoryLoadOp.operands().get(1)).op()))\n+                   sbrace(_-> recurse( OpHelper.asResultOrThrow(hatMemoryLoadOp.operands().get(1)).op()))\n@@ -550,2 +554,2 @@\n-    public final T hatPtrLoadOp(ScopedCodeBuilderContext builderContext, HATPtrOp.HATPtrLoadOp hatPtrLoadOp) {\n-        ptrAccess(builderContext, hatPtrLoadOp);\n+    public final T hatPtrLoadOp( HATPtrOp.HATPtrLoadOp hatPtrLoadOp) {\n+        ptrAccess( hatPtrLoadOp);\n@@ -556,2 +560,2 @@\n-    public final T hatPtrStoreOp(ScopedCodeBuilderContext builderContext, HATPtrOp.HATPtrStoreOp hatPtrStoreOp) {\n-        ptrAccess(builderContext, hatPtrStoreOp).equals().recurse(builderContext, ((Op.Result) hatPtrStoreOp.operands().getLast()).op());\n+    public final T hatPtrStoreOp( HATPtrOp.HATPtrStoreOp hatPtrStoreOp) {\n+        ptrAccess( hatPtrStoreOp).equals().recurse( ((Op.Result) hatPtrStoreOp.operands().getLast()).op());\n@@ -562,2 +566,2 @@\n-    public final  T hatPtrLengthOp(ScopedCodeBuilderContext builderContext, HATPtrOp.HATPtrLengthOp hatPtrLengthOp) {\n-        ptrAccess(builderContext, hatPtrLengthOp);\n+    public final  T hatPtrLengthOp( HATPtrOp.HATPtrLengthOp hatPtrLengthOp) {\n+        ptrAccess(hatPtrLengthOp);\n@@ -567,1 +571,1 @@\n-    public final T ptrAccess(ScopedCodeBuilderContext builderContext, HATPtrOp hatPtrOp) {\n+    public final T ptrAccess( HATPtrOp hatPtrOp) {\n@@ -571,1 +575,1 @@\n-            Op resolve = builderContext.scope.resolve(varLoadOp.operands().getFirst());\n+            Op resolve = scopedCodeBuilderContext().resolve(varLoadOp.operands().getFirst());\n@@ -586,1 +590,1 @@\n-                        paren(_ -> recurse(builderContext, ((Op.Result) hatPtrOp.operands().get(2)).op()));\n+                        paren(_ -> recurse( ((Op.Result) hatPtrOp.operands().get(2)).op()));\n@@ -589,1 +593,1 @@\n-                        add().paren(_ -> recurse(builderContext, ((Op.Result) hatPtrOp.operands().get(1)).op()));\n+                        add().paren(_ -> recurse( ((Op.Result) hatPtrOp.operands().get(1)).op()));\n@@ -591,1 +595,1 @@\n-                        recurse(builderContext, ((Op.Result) hatPtrOp.operands().get(1)).op());\n+                        recurse( ((Op.Result) hatPtrOp.operands().get(1)).op());\n@@ -673,2 +677,2 @@\n-    public final T varLoadOp(ScopedCodeBuilderContext buildContext, CoreOp.VarAccessOp.VarLoadOp varLoadOp) {\n-        Op resolve = buildContext.scope.resolve(varLoadOp.operands().getFirst());\n+    public final T varLoadOp( CoreOp.VarAccessOp.VarLoadOp varLoadOp) {\n+        Op resolve = scopedCodeBuilderContext().resolve(varLoadOp.operands().getFirst());\n@@ -689,2 +693,2 @@\n-    public final T varStoreOp(ScopedCodeBuilderContext buildContext, CoreOp.VarAccessOp.VarStoreOp varStoreOp) {\n-        Op op = buildContext.scope.resolve(varStoreOp.operands().getFirst());\n+    public final T varStoreOp( CoreOp.VarAccessOp.VarStoreOp varStoreOp) {\n+        Op op = scopedCodeBuilderContext().resolve(varStoreOp.operands().getFirst());\n@@ -708,1 +712,1 @@\n-        equals().parenthesisIfNeeded(buildContext, varStoreOp, ((Op.Result)varStoreOp.operands().get(1)).op());\n+        equals().parenthesisIfNeeded( varStoreOp, ((Op.Result)varStoreOp.operands().get(1)).op());\n@@ -713,1 +717,1 @@\n-    public final  T convOp(ScopedCodeBuilderContext buildContext, JavaOp.ConvOp convOp) {\n+    public final  T convOp( JavaOp.ConvOp convOp) {\n@@ -716,1 +720,1 @@\n-            paren(_ -> type(buildContext,JavaType.FLOAT)); \/\/ why double to float?\n+            paren(_ -> type(JavaType.FLOAT)); \/\/ why double to float?\n@@ -718,1 +722,1 @@\n-            paren(_ -> type(buildContext,(JavaType)convOp.resultType()));\n+            paren(_ -> type((JavaType)convOp.resultType()));\n@@ -720,1 +724,1 @@\n-        parenthesisIfNeeded(buildContext, convOp, ((Op.Result) convOp.operands().getFirst()).op());\n+        parenthesisIfNeeded( convOp, ((Op.Result) convOp.operands().getFirst()).op());\n@@ -724,1 +728,1 @@\n-    public abstract  T atomicInc(ScopedCodeBuilderContext buildContext, Op.Result instanceResult, String name);\n+    public abstract  T atomicInc( Op.Result instanceResult, String name);\n@@ -729,2 +733,2 @@\n-    public final T invokeOp(ScopedCodeBuilderContext buildContext, JavaOp.InvokeOp invokeOp) {\n-        var invoke = invoke(buildContext.lookup,invokeOp);\n+    public final T invokeOp( JavaOp.InvokeOp invokeOp) {\n+        var invoke = invoke(scopedCodeBuilderContext().lookup(),invokeOp);\n@@ -734,1 +738,1 @@\n-                    atomicInc(buildContext, instanceResult,\n+                    atomicInc( instanceResult,\n@@ -741,1 +745,1 @@\n-                                && invoke(buildContext.lookup,instance.op()) instanceof Invoke invoke0\n+                                && invoke(scopedCodeBuilderContext().lookup(),instance.op()) instanceof Invoke invoke0\n@@ -760,1 +764,1 @@\n-                            recurse(buildContext, instance.op());\n+                            recurse( instance.op());\n@@ -765,1 +769,1 @@\n-                        && buildContext.scope.resolve(varLoadOp.operands().getFirst()) instanceof HATMemoryVarOp);\n+                        && scopedCodeBuilderContext().resolve(varLoadOp.operands().getFirst()) instanceof HATMemoryVarOp);\n@@ -775,1 +779,1 @@\n-                                equals().recurse(buildContext, op);\n+                                equals().recurse( op);\n@@ -781,1 +785,1 @@\n-                                sbrace(_ -> recurse(buildContext, op1)).equals().recurse(buildContext, op2);\n+                                sbrace(_ -> recurse( op1)).equals().recurse( op2);\n@@ -788,1 +792,1 @@\n-                        sbrace(_ -> recurse(buildContext, op));\n+                        sbrace(_ -> recurse( op));\n@@ -797,1 +801,1 @@\n-                            op -> {if (op instanceof Op.Result result) {recurse(buildContext, result.op());}\n+                            op -> {if (op instanceof Op.Result result) {recurse( result.op());}\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/C99HATKernelBuilder.java","additions":77,"deletions":73,"binary":false,"changes":150,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import optkl.codebuilders.ScopeAwareJavaOrC99StyleCodeBuilder;\n@@ -34,1 +35,1 @@\n-public interface HATOpDispatcher<T extends JavaOrC99StyleCodeBuilder<T>> extends BabylonOpDispatcher<T, ScopedCodeBuilderContext> {\n+public interface HATOpDispatcher<T extends ScopeAwareJavaOrC99StyleCodeBuilder<T>> extends BabylonOpDispatcher<T, ScopedCodeBuilderContext> {\n@@ -36,1 +37,1 @@\n-    T hatBarrierOp(ScopedCodeBuilderContext buildContext, HATBarrierOp barrierOp);\n+    T hatBarrierOp( HATBarrierOp barrierOp);\n@@ -38,1 +39,1 @@\n-    T hatLocalVarOp(ScopedCodeBuilderContext buildContext, HATMemoryVarOp.HATLocalVarOp barrierOp);\n+    T hatLocalVarOp( HATMemoryVarOp.HATLocalVarOp barrierOp);\n@@ -40,1 +41,1 @@\n-    T hatPrivateVarOp(ScopedCodeBuilderContext buildContext, HATMemoryVarOp.HATPrivateVarOp hatLocalVarOp);\n+    T hatPrivateVarOp( HATMemoryVarOp.HATPrivateVarOp hatLocalVarOp);\n@@ -42,1 +43,1 @@\n-    T hatThreadIdOp(ScopedCodeBuilderContext buildContext, HATThreadOp hatThreadOp);\n+    T hatThreadIdOp( HATThreadOp hatThreadOp);\n@@ -44,1 +45,1 @@\n-    T hatVectorVarOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorVarOp hatVectorVarOp);\n+    T hatVectorVarOp( HATVectorOp.HATVectorVarOp hatVectorVarOp);\n@@ -46,1 +47,1 @@\n-    T hatVectorStoreOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorStoreView hatFloat4StoreOp);\n+    T hatVectorStoreOp( HATVectorOp.HATVectorStoreView hatFloat4StoreOp);\n@@ -48,1 +49,1 @@\n-    T hatBinaryVectorOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorBinaryOp hatVectorBinaryOp);\n+    T hatBinaryVectorOp( HATVectorOp.HATVectorBinaryOp hatVectorBinaryOp);\n@@ -50,1 +51,1 @@\n-    T hatVectorLoadOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorLoadOp hatVectorLoadOp);\n+    T hatVectorLoadOp( HATVectorOp.HATVectorLoadOp hatVectorLoadOp);\n@@ -52,1 +53,1 @@\n-    T hatSelectLoadOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorSelectLoadOp hatVSelectLoadOp);\n+    T hatSelectLoadOp( HATVectorOp.HATVectorSelectLoadOp hatVSelectLoadOp);\n@@ -54,1 +55,1 @@\n-    T hatSelectStoreOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorSelectStoreOp hatVSelectStoreOp);\n+    T hatSelectStoreOp( HATVectorOp.HATVectorSelectStoreOp hatVSelectStoreOp);\n@@ -56,1 +57,1 @@\n-    T hatVectorVarLoadOp(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorVarLoadOp hatVectorVarLoadOp);\n+    T hatVectorVarLoadOp( HATVectorOp.HATVectorVarLoadOp hatVectorVarLoadOp);\n@@ -58,1 +59,1 @@\n-    T hatF16VarOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16VarOp hatF16VarOp);\n+    T hatF16VarOp( HATF16Op.HATF16VarOp hatF16VarOp);\n@@ -60,1 +61,1 @@\n-    T hatF16BinaryOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16BinaryOp hatF16BinaryOp);\n+    T hatF16BinaryOp( HATF16Op.HATF16BinaryOp hatF16BinaryOp);\n@@ -62,1 +63,1 @@\n-    T hatF16VarLoadOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16VarLoadOp hatF16VarLoadOp);\n+    T hatF16VarLoadOp( HATF16Op.HATF16VarLoadOp hatF16VarLoadOp);\n@@ -64,1 +65,1 @@\n-    T hatF16ConvOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16ConvOp hatF16ConvOp);\n+    T hatF16ConvOp( HATF16Op.HATF16ConvOp hatF16ConvOp);\n@@ -66,1 +67,1 @@\n-    T hatVectorOfOps(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorOfOp hatVectorOp);\n+    T hatVectorOfOps( HATVectorOp.HATVectorOfOp hatVectorOp);\n@@ -68,1 +69,1 @@\n-    T hatVectorMakeOf(ScopedCodeBuilderContext buildContext, HATVectorOp.HATVectorMakeOfOp hatVectorMakeOfOp);\n+    T hatVectorMakeOf( HATVectorOp.HATVectorMakeOfOp hatVectorMakeOfOp);\n@@ -70,1 +71,1 @@\n-    T hatF16ToFloatConvOp(ScopedCodeBuilderContext buildContext, HATF16Op.HATF16ToFloatConvOp hatF16ToFloatConvOp);\n+    T hatF16ToFloatConvOp( HATF16Op.HATF16ToFloatConvOp hatF16ToFloatConvOp);\n@@ -72,1 +73,1 @@\n-    T hatPrivateVarInitOp(ScopedCodeBuilderContext buildContext, HATMemoryVarOp.HATPrivateInitVarOp hatPrivateInitVarOp);\n+    T hatPrivateVarInitOp( HATMemoryVarOp.HATPrivateInitVarOp hatPrivateInitVarOp);\n@@ -74,1 +75,1 @@\n-    T hatMemoryLoadOp(ScopedCodeBuilderContext buildContext, HATMemoryDefOp.HATMemoryLoadOp hatMemoryLoadOp);\n+    T hatMemoryLoadOp( HATMemoryDefOp.HATMemoryLoadOp hatMemoryLoadOp);\n@@ -76,1 +77,1 @@\n-    T hatPtrLoadOp(ScopedCodeBuilderContext builderContext, HATPtrOp.HATPtrLoadOp hatPtrLoadOp);\n+    T hatPtrLoadOp(HATPtrOp.HATPtrLoadOp hatPtrLoadOp);\n@@ -78,1 +79,1 @@\n-    T hatPtrStoreOp(ScopedCodeBuilderContext builderContext, HATPtrOp.HATPtrStoreOp hatPtrStoreOp);\n+    T hatPtrStoreOp( HATPtrOp.HATPtrStoreOp hatPtrStoreOp);\n@@ -80,1 +81,1 @@\n-    T hatPtrLengthOp(ScopedCodeBuilderContext builderContext, HATPtrOp.HATPtrLengthOp hatPtrLengthOp);\n+    T hatPtrLengthOp( HATPtrOp.HATPtrLengthOp hatPtrLengthOp);\n@@ -83,1 +84,1 @@\n-    default T recurse(ScopedCodeBuilderContext buildContext, Op op) {\n+    default T recurse( Op op) {\n@@ -86,23 +87,23 @@\n-                case HATBarrierOp $ -> hatBarrierOp(buildContext, $);\n-                case HATMemoryVarOp.HATLocalVarOp $ -> hatLocalVarOp(buildContext, $);\n-                case HATMemoryVarOp.HATPrivateVarOp $ -> hatPrivateVarOp(buildContext, $);\n-                case HATMemoryVarOp.HATPrivateInitVarOp $ -> hatPrivateVarInitOp(buildContext, $);\n-                case HATThreadOp $ -> hatThreadIdOp(buildContext, $);\n-                case HATVectorOp.HATVectorVarOp $ -> hatVectorVarOp(buildContext, $);\n-                case HATVectorOp.HATVectorStoreView $ -> hatVectorStoreOp(buildContext, $);\n-                case HATVectorOp.HATVectorBinaryOp $ -> hatBinaryVectorOp(buildContext, $);\n-                case HATVectorOp.HATVectorLoadOp $ -> hatVectorLoadOp(buildContext, $);\n-                case HATVectorOp.HATVectorSelectLoadOp $ -> hatSelectLoadOp(buildContext, $);\n-                case HATVectorOp.HATVectorSelectStoreOp $ -> hatSelectStoreOp(buildContext, $);\n-                case HATVectorOp.HATVectorVarLoadOp $ -> hatVectorVarLoadOp(buildContext, $);\n-                case HATVectorOp.HATVectorOfOp $ -> hatVectorOfOps(buildContext, $);\n-                case HATF16Op.HATF16VarOp $ -> hatF16VarOp(buildContext, $);\n-                case HATF16Op.HATF16BinaryOp $ -> hatF16BinaryOp(buildContext, $);\n-                case HATF16Op.HATF16VarLoadOp $ -> hatF16VarLoadOp(buildContext, $);\n-                case HATF16Op.HATF16ConvOp $ -> hatF16ConvOp(buildContext, $);\n-                case HATVectorOp.HATVectorMakeOfOp $ -> hatVectorMakeOf(buildContext, $);\n-                case HATPtrOp.HATPtrLoadOp $ -> hatPtrLoadOp(buildContext, $);\n-                case HATPtrOp.HATPtrStoreOp $ -> hatPtrStoreOp(buildContext, $);\n-                case HATPtrOp.HATPtrLengthOp $ -> hatPtrLengthOp(buildContext, $);\n-                case HATF16Op.HATF16ToFloatConvOp $ -> hatF16ToFloatConvOp(buildContext, $);\n-                case HATMemoryDefOp.HATMemoryLoadOp $ -> hatMemoryLoadOp(buildContext, $);\n+                case HATBarrierOp $ -> hatBarrierOp( $);\n+                case HATMemoryVarOp.HATLocalVarOp $ -> hatLocalVarOp( $);\n+                case HATMemoryVarOp.HATPrivateVarOp $ -> hatPrivateVarOp( $);\n+                case HATMemoryVarOp.HATPrivateInitVarOp $ -> hatPrivateVarInitOp( $);\n+                case HATThreadOp $ -> hatThreadIdOp( $);\n+                case HATVectorOp.HATVectorVarOp $ -> hatVectorVarOp( $);\n+                case HATVectorOp.HATVectorStoreView $ -> hatVectorStoreOp( $);\n+                case HATVectorOp.HATVectorBinaryOp $ -> hatBinaryVectorOp( $);\n+                case HATVectorOp.HATVectorLoadOp $ -> hatVectorLoadOp( $);\n+                case HATVectorOp.HATVectorSelectLoadOp $ -> hatSelectLoadOp( $);\n+                case HATVectorOp.HATVectorSelectStoreOp $ -> hatSelectStoreOp( $);\n+                case HATVectorOp.HATVectorVarLoadOp $ -> hatVectorVarLoadOp( $);\n+                case HATVectorOp.HATVectorOfOp $ -> hatVectorOfOps( $);\n+                case HATF16Op.HATF16VarOp $ -> hatF16VarOp( $);\n+                case HATF16Op.HATF16BinaryOp $ -> hatF16BinaryOp( $);\n+                case HATF16Op.HATF16VarLoadOp $ -> hatF16VarLoadOp( $);\n+                case HATF16Op.HATF16ConvOp $ -> hatF16ConvOp( $);\n+                case HATVectorOp.HATVectorMakeOfOp $ -> hatVectorMakeOf( $);\n+                case HATPtrOp.HATPtrLoadOp $ -> hatPtrLoadOp( $);\n+                case HATPtrOp.HATPtrStoreOp $ -> hatPtrStoreOp( $);\n+                case HATPtrOp.HATPtrLengthOp $ -> hatPtrLengthOp( $);\n+                case HATF16Op.HATF16ToFloatConvOp $ -> hatF16ToFloatConvOp( $);\n+                case HATMemoryDefOp.HATMemoryLoadOp $ -> hatMemoryLoadOp( $);\n@@ -112,1 +113,1 @@\n-            BabylonOpDispatcher.super.recurse(buildContext, op);\n+            BabylonOpDispatcher.super.recurse( op);\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/HATOpDispatcher.java","additions":50,"deletions":49,"binary":false,"changes":99,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import jdk.incubator.code.dialect.core.CoreOp;\n@@ -29,0 +30,1 @@\n+import optkl.codebuilders.ScopedCodeBuilderContext;\n@@ -30,0 +32,1 @@\n+import java.lang.invoke.MethodHandles;\n@@ -45,1 +48,1 @@\n-    private final C99CodeBuilder<?> representationBuilder = new C99CodeBuilder<>();\n+    private final C99CodeBuilder<?> representationBuilder;\n@@ -54,1 +57,2 @@\n-    public DeviceSchema(Class<T> klass) {\n+    public DeviceSchema(MethodHandles.Lookup lookup, CoreOp.FuncOp funcOp,Class<T> klass) {\n+        this.representationBuilder = new C99CodeBuilder<>(new ScopedCodeBuilderContext(lookup,funcOp));\n@@ -59,2 +63,2 @@\n-    public static <T extends DeviceType> DeviceSchema<T> of(Class<T> klass, Consumer<DeviceSchema<T>> schemaBuilder) {\n-        DeviceSchema<T> deviceSchema =  new DeviceSchema<>(klass);\n+    public static <T extends DeviceType> DeviceSchema<T> of(MethodHandles.Lookup lookup, CoreOp.FuncOp funcOp,Class<T> klass, Consumer<DeviceSchema<T>> schemaBuilder) {\n+        DeviceSchema<T> deviceSchema =  new DeviceSchema<>(lookup,funcOp,klass);\n@@ -124,1 +128,1 @@\n-                            C99CodeBuilder<?> depsBuilder = new C99CodeBuilder<>();\n+                            C99CodeBuilder<?> depsBuilder = new C99CodeBuilder<>(new ScopedCodeBuilderContext(builder.scopedCodeBuilderContext().lookup(),builder.scopedCodeBuilderContext().funcOp()));\n","filename":"hat\/core\/src\/main\/java\/hat\/device\/DeviceSchema.java","additions":9,"deletions":5,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -68,1 +68,1 @@\n-        DeviceSchema<SharedS32x256Array> schema = DeviceSchema.of(SharedS32x256Array.class, $ -> $.withArray(\"array\", 32));\n+        DeviceSchema<SharedS32x256Array> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedS32x256Array.class, $ -> $.withArray(\"array\", 32));\n","filename":"hat\/examples\/experiments\/src\/main\/java\/experiments\/PrefixSum.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -125,4 +125,3 @@\n-        DeviceSchema<MyLocalArrayFixedSize> schema = DeviceSchema.of(MyLocalArrayFixedSize.class,\n-                myPrivateArray -> myPrivateArray\n-                        \/\/ It is a bound schema, so we fix the size here\n-                        .withArray(\"array\", 256));\n+        DeviceSchema<MyLocalArrayFixedSize> schema = DeviceSchema.of(MethodHandles.lookup(),null,MyLocalArrayFixedSize.class,\n+                myPrivateArray -> myPrivateArray.withArray(\"array\", 256));\/\/ It is a bound schema, so we fix the size here\n+\n@@ -190,1 +189,1 @@\n-        DeviceSchema<SharedMemory> schema = DeviceSchema.of(SharedMemory.class,\n+        DeviceSchema<SharedMemory> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedMemory.class,\n@@ -207,1 +206,1 @@\n-        DeviceSchema<PrivateArray> schema = DeviceSchema.of(PrivateArray.class,\n+        DeviceSchema<PrivateArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateArray.class,\n@@ -224,1 +223,1 @@\n-        DeviceSchema<FlatPrivate> schema = DeviceSchema.of(FlatPrivate.class,\n+        DeviceSchema<FlatPrivate> schema = DeviceSchema.of(MethodHandles.lookup(),null,FlatPrivate.class,\n@@ -481,1 +480,1 @@\n-        DeviceSchema<SharedMemoryHalf> schema = DeviceSchema.of(SharedMemoryHalf.class,\n+        DeviceSchema<SharedMemoryHalf> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedMemoryHalf.class,\n@@ -497,1 +496,1 @@\n-        DeviceSchema<PrivateArrayHalf> schema = DeviceSchema.of(PrivateArrayHalf.class,\n+        DeviceSchema<PrivateArrayHalf> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateArrayHalf.class,\n@@ -513,1 +512,1 @@\n-        DeviceSchema<FlatPrivateHalf> schema = DeviceSchema.of(FlatPrivateHalf.class,\n+        DeviceSchema<FlatPrivateHalf> schema = DeviceSchema.of(MethodHandles.lookup(),null,FlatPrivateHalf.class,\n","filename":"hat\/examples\/matmul\/src\/main\/java\/matmul\/Main.java","additions":9,"deletions":10,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -102,13 +102,16 @@\n-        funcOp.parameters().forEach(parameter -> {\n-            Optional<Op.Result> optionalResult = parameter.uses().stream().findFirst();\n-            optionalResult.ifPresentOrElse(result -> {\n-                if (result.op() instanceof CoreOp.VarOp varOp) {\n-                    parameterVarOpMap.add(parameter, varOp);\n-                    add(Map.entry(parameter, varOp));\n-                } else if (result.op() instanceof JavaOp.InvokeOp invokeOp) {\n-                    parameterInvokeOpMap.add(parameter, invokeOp);\n-                } else {\n-                    throw new IllegalStateException(\"What kind of parameter is this?\");\n-                }\n-            }, () -> {\n-                throw new IllegalStateException(\"FuncOp has unused params \");\n+        if (funcOp!=null) {\n+            funcOp.parameters().forEach(parameter -> {\n+                Optional<Op.Result> optionalResult = parameter.uses().stream().findFirst();\n+                optionalResult.ifPresentOrElse(result -> {\n+                    if (result.op() instanceof CoreOp.VarOp varOp) {\n+                        parameterVarOpMap.add(parameter, varOp);\n+                        add(Map.entry(parameter, varOp));\n+                    } else if (result.op() instanceof JavaOp.InvokeOp invokeOp) {\n+                        parameterInvokeOpMap.add(parameter, invokeOp);\n+                    } else {\n+                        throw new IllegalStateException(\"What kind of parameter is this?\");\n+                    }\n+                }, () -> {\n+                    throw new IllegalStateException(\"FuncOp has unused params \");\n+                });\n+\n@@ -116,1 +119,1 @@\n-        });\n+        }\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/FuncOpParams.java","additions":17,"deletions":14,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -34,2 +34,2 @@\n-public interface BabylonOpDispatcher<T extends JavaOrC99StyleCodeBuilder<T>, SB extends ScopedCodeBuilderContext> {\n-    T type(SB buildContext, JavaType javaType);\n+public interface BabylonOpDispatcher<T extends JavaOrC99StyleCodeBuilder<T,SCBC>, SCBC extends ScopedCodeBuilderContext> {\n+    T type( JavaType javaType);\n@@ -37,1 +37,1 @@\n-    T varLoadOp(SB buildContext, CoreOp.VarAccessOp.VarLoadOp varLoadOp);\n+    T varLoadOp( CoreOp.VarAccessOp.VarLoadOp varLoadOp);\n@@ -39,1 +39,1 @@\n-    T varStoreOp(SB buildContext, CoreOp.VarAccessOp.VarStoreOp varStoreOp);\n+    T varStoreOp( CoreOp.VarAccessOp.VarStoreOp varStoreOp);\n@@ -41,1 +41,1 @@\n-    T varOp(SB buildContext, CoreOp.VarOp varOp);\n+    T varOp( CoreOp.VarOp varOp);\n@@ -43,1 +43,1 @@\n-    T varOp(SB buildContext, CoreOp.VarOp varOp, ParamVar paramVar );\n+    T varOp( CoreOp.VarOp varOp, ParamVar paramVar );\n@@ -45,1 +45,1 @@\n-    T fieldLoadOp(SB buildContext, JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp);\n+    T fieldLoadOp( JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp);\n@@ -47,1 +47,1 @@\n-    T fieldStoreOp(SB buildContext, JavaOp.FieldAccessOp.FieldStoreOp fieldStoreOp);\n+    T fieldStoreOp( JavaOp.FieldAccessOp.FieldStoreOp fieldStoreOp);\n@@ -49,1 +49,1 @@\n-    T unaryOp(SB buildContext, JavaOp.UnaryOp unaryOp);\n+    T unaryOp( JavaOp.UnaryOp unaryOp);\n@@ -51,1 +51,1 @@\n-    T binaryOp(SB buildContext, JavaOp.BinaryOp binaryOp);\n+    T binaryOp( JavaOp.BinaryOp binaryOp);\n@@ -53,1 +53,1 @@\n-    T conditionalOp(SB buildContext, JavaOp.JavaConditionalOp conditionalOp);\n+    T conditionalOp( JavaOp.JavaConditionalOp conditionalOp);\n@@ -55,1 +55,1 @@\n-    T binaryTestOp(SB buildContext, JavaOp.BinaryTestOp binaryTestOp);\n+    T binaryTestOp( JavaOp.BinaryTestOp binaryTestOp);\n@@ -57,1 +57,1 @@\n-    T convOp(SB buildContext, JavaOp.ConvOp convOp);\n+    T convOp( JavaOp.ConvOp convOp);\n@@ -59,1 +59,1 @@\n-    T constantOp(SB buildContext, CoreOp.ConstantOp constantOp);\n+    T constantOp( CoreOp.ConstantOp constantOp);\n@@ -61,1 +61,1 @@\n-    T yieldOp(SB buildContext, CoreOp.YieldOp yieldOp);\n+    T yieldOp( CoreOp.YieldOp yieldOp);\n@@ -63,1 +63,1 @@\n-    T lambdaOp(SB buildContext, JavaOp.LambdaOp lambdaOp);\n+    T lambdaOp( JavaOp.LambdaOp lambdaOp);\n@@ -65,1 +65,1 @@\n-    T tupleOp(SB buildContext, CoreOp.TupleOp tupleOp);\n+    T tupleOp( CoreOp.TupleOp tupleOp);\n@@ -67,1 +67,1 @@\n-    T funcCallOp(SB buildContext, CoreOp.FuncCallOp funcCallOp);\n+    T funcCallOp( CoreOp.FuncCallOp funcCallOp);\n@@ -69,1 +69,1 @@\n-    T ifOp(SB buildContext, JavaOp.IfOp ifOp);\n+    T ifOp( JavaOp.IfOp ifOp);\n@@ -71,1 +71,1 @@\n-    T whileOp(SB buildContext, JavaOp.WhileOp whileOp);\n+    T whileOp( JavaOp.WhileOp whileOp);\n@@ -73,1 +73,1 @@\n-    T labeledOp(SB buildContext, JavaOp.LabeledOp labeledOp);\n+    T labeledOp( JavaOp.LabeledOp labeledOp);\n@@ -75,1 +75,1 @@\n-    T continueOp(SB buildContext, JavaOp.ContinueOp continueOp);\n+    T continueOp( JavaOp.ContinueOp continueOp);\n@@ -77,1 +77,1 @@\n-    T breakOp(SB buildContext, JavaOp.BreakOp breakOp);\n+    T breakOp( JavaOp.BreakOp breakOp);\n@@ -79,1 +79,1 @@\n-    T forOp(SB buildContext, JavaOp.ForOp forOp);\n+    T forOp( JavaOp.ForOp forOp);\n@@ -81,1 +81,1 @@\n-    T invokeOp(SB buildContext, JavaOp.InvokeOp invokeOp);\n+    T invokeOp( JavaOp.InvokeOp invokeOp);\n@@ -83,1 +83,1 @@\n-    T conditionalExpressionOp(SB buildContext, JavaOp.ConditionalExpressionOp ternaryOp);\n+    T conditionalExpressionOp( JavaOp.ConditionalExpressionOp ternaryOp);\n@@ -85,1 +85,1 @@\n-    T parenthesisIfNeeded(SB buildContext, Op parent, Op child);\n+    T parenthesisIfNeeded( Op parent, Op child);\n@@ -87,1 +87,1 @@\n-    T returnOp(SB buildContext, CoreOp.ReturnOp returnOp);\n+    T returnOp( CoreOp.ReturnOp returnOp);\n@@ -89,7 +89,7 @@\n-    T newOp(SB buildContext, JavaOp.NewOp newOp);\n-    T arrayLoadOp(SB buildContext, JavaOp.ArrayAccessOp.ArrayLoadOp arrayLoadOp);\n-    T arrayStoreOp(SB buildContext, JavaOp.ArrayAccessOp.ArrayStoreOp arrayStoreOp);\n-    T enhancedForOp(SB buildContext, JavaOp.EnhancedForOp enhancedForOp);\n-    T blockOp(SB buildContext, JavaOp.BlockOp blockOp);\n-    T concatOp(SB buildContext, JavaOp.ConcatOp concatOp);\n-    default T recurse(SB buildContext, Op op) {\n+    T newOp( JavaOp.NewOp newOp);\n+    T arrayLoadOp( JavaOp.ArrayAccessOp.ArrayLoadOp arrayLoadOp);\n+    T arrayStoreOp( JavaOp.ArrayAccessOp.ArrayStoreOp arrayStoreOp);\n+    T enhancedForOp( JavaOp.EnhancedForOp enhancedForOp);\n+    T blockOp( JavaOp.BlockOp blockOp);\n+    T concatOp( JavaOp.ConcatOp concatOp);\n+    default T recurse( Op op) {\n@@ -97,31 +97,31 @@\n-            case CoreOp.VarAccessOp.VarLoadOp $ -> varLoadOp(buildContext, $);\n-            case CoreOp.VarAccessOp.VarStoreOp $ -> varStoreOp(buildContext, $);\n-            case JavaOp.FieldAccessOp.FieldLoadOp $ -> fieldLoadOp(buildContext, $);\n-            case JavaOp.FieldAccessOp.FieldStoreOp $ -> fieldStoreOp(buildContext, $);\n-            case JavaOp.ConvOp $ -> convOp(buildContext, $);\n-            case CoreOp.ConstantOp $ -> constantOp(buildContext, $);\n-            case CoreOp.YieldOp $ -> yieldOp(buildContext, $);\n-            case CoreOp.FuncCallOp $ -> funcCallOp(buildContext, $);\n-            case JavaOp.InvokeOp $ -> invokeOp(buildContext, $);\n-            case JavaOp.ConditionalExpressionOp $ -> conditionalExpressionOp(buildContext, $);\n-            case CoreOp.VarOp $ when ParamVar.of($) instanceof ParamVar paramVar -> varOp(buildContext, $,paramVar);\n-            case CoreOp.VarOp $ -> varOp(buildContext, $);\n-            case JavaOp.LambdaOp $ -> lambdaOp(buildContext, $);\n-            case CoreOp.TupleOp $ -> tupleOp(buildContext, $);\n-            case JavaOp.WhileOp $ -> whileOp(buildContext, $);\n-            case JavaOp.IfOp $ -> ifOp(buildContext, $);\n-            case JavaOp.ForOp $ -> forOp(buildContext, $);\n-            case CoreOp.ReturnOp $ -> returnOp(buildContext, $);\n-            case JavaOp.LabeledOp $ -> labeledOp(buildContext, $);\n-            case JavaOp.BreakOp $ -> breakOp(buildContext, $);\n-            case JavaOp.ContinueOp $ -> continueOp(buildContext, $);\n-            case JavaOp.BinaryTestOp $ -> binaryTestOp(buildContext, $);\n-            case JavaOp.BinaryOp $ -> binaryOp(buildContext, $);\n-            case JavaOp.JavaConditionalOp $ -> conditionalOp(buildContext, $);\n-            case JavaOp.UnaryOp $ -> unaryOp(buildContext, $);\n-            case JavaOp.NewOp $ -> newOp(buildContext, $);\n-            case JavaOp.ArrayAccessOp.ArrayStoreOp  $ ->  arrayStoreOp(buildContext,$);\n-            case JavaOp.ArrayAccessOp.ArrayLoadOp  $ ->  arrayLoadOp(buildContext,$);\n-            case JavaOp.EnhancedForOp $ -> enhancedForOp(buildContext,$);\n-            case JavaOp.BlockOp   $ -> blockOp(buildContext,$);\n-            case JavaOp.ConcatOp $ -> concatOp(buildContext,$);\n+            case CoreOp.VarAccessOp.VarLoadOp $ -> varLoadOp( $);\n+            case CoreOp.VarAccessOp.VarStoreOp $ -> varStoreOp( $);\n+            case JavaOp.FieldAccessOp.FieldLoadOp $ -> fieldLoadOp( $);\n+            case JavaOp.FieldAccessOp.FieldStoreOp $ -> fieldStoreOp( $);\n+            case JavaOp.ConvOp $ -> convOp( $);\n+            case CoreOp.ConstantOp $ -> constantOp( $);\n+            case CoreOp.YieldOp $ -> yieldOp( $);\n+            case CoreOp.FuncCallOp $ -> funcCallOp( $);\n+            case JavaOp.InvokeOp $ -> invokeOp( $);\n+            case JavaOp.ConditionalExpressionOp $ -> conditionalExpressionOp( $);\n+            case CoreOp.VarOp $ when ParamVar.of($) instanceof ParamVar paramVar -> varOp( $,paramVar);\n+            case CoreOp.VarOp $ -> varOp( $);\n+            case JavaOp.LambdaOp $ -> lambdaOp( $);\n+            case CoreOp.TupleOp $ -> tupleOp( $);\n+            case JavaOp.WhileOp $ -> whileOp( $);\n+            case JavaOp.IfOp $ -> ifOp( $);\n+            case JavaOp.ForOp $ -> forOp( $);\n+            case CoreOp.ReturnOp $ -> returnOp( $);\n+            case JavaOp.LabeledOp $ -> labeledOp( $);\n+            case JavaOp.BreakOp $ -> breakOp( $);\n+            case JavaOp.ContinueOp $ -> continueOp( $);\n+            case JavaOp.BinaryTestOp $ -> binaryTestOp( $);\n+            case JavaOp.BinaryOp $ -> binaryOp( $);\n+            case JavaOp.JavaConditionalOp $ -> conditionalOp( $);\n+            case JavaOp.UnaryOp $ -> unaryOp( $);\n+            case JavaOp.NewOp $ -> newOp( $);\n+            case JavaOp.ArrayAccessOp.ArrayStoreOp  $ ->  arrayStoreOp($);\n+            case JavaOp.ArrayAccessOp.ArrayLoadOp  $ ->  arrayLoadOp($);\n+            case JavaOp.EnhancedForOp $ -> enhancedForOp($);\n+            case JavaOp.BlockOp   $ -> blockOp($);\n+            case JavaOp.ConcatOp $ -> concatOp($);\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/BabylonOpDispatcher.java","additions":66,"deletions":66,"binary":false,"changes":132,"status":"modified"},{"patch":"@@ -30,1 +30,5 @@\n-public  class C99CodeBuilder<T extends C99CodeBuilder<T>> extends JavaOrC99StyleCodeBuilder<T> {\n+public  class C99CodeBuilder<T extends C99CodeBuilder<T>> extends ScopeAwareJavaOrC99StyleCodeBuilder<T> {\n+\n+    public C99CodeBuilder(ScopedCodeBuilderContext scopedCodeBuilderContext) {\n+        super(scopedCodeBuilderContext);\n+    }\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/C99CodeBuilder.java","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -40,1 +40,2 @@\n-public abstract class CodeBuilder<T extends CodeBuilder<T>> extends TextBuilder<T> implements CodeRenderer<T> {\n+public abstract class CodeBuilder<T extends CodeBuilder<T>>\n+        extends TextBuilder<T> implements CodeRenderer<T> {\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/CodeBuilder.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1,38 +0,0 @@\n-\/*\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.  Oracle designates this\n- * particular file as subject to the \"Classpath\" exception as provided\n- * by Oracle in the LICENSE file that accompanied this code.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-package optkl.codebuilders;\n-\n-import jdk.incubator.code.dialect.core.CoreOp;\n-\n-import java.lang.invoke.MethodHandles;\n-\n-public class CodeBuilderContext {\n-    final public MethodHandles.Lookup lookup;\n-    final public CoreOp.FuncOp funcOp;\n-    public CodeBuilderContext(MethodHandles.Lookup lookup, CoreOp.FuncOp funcOp) {\n-        this.lookup = lookup;\n-        this.funcOp = funcOp;\n-    }\n-}\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/CodeBuilderContext.java","additions":0,"deletions":38,"binary":false,"changes":38,"status":"deleted"},{"patch":"@@ -33,1 +33,1 @@\n-public class JavaCodeBuilder<T extends JavaCodeBuilder<T>> extends JavaOrC99StyleCodeBuilder<T> implements BabylonOpDispatcher<T,ScopedCodeBuilderContext> {\n+public class JavaCodeBuilder<T extends JavaCodeBuilder<T>> extends ScopeAwareJavaOrC99StyleCodeBuilder<T> {\n@@ -35,1 +35,1 @@\n-    public T type(ScopedCodeBuilderContext buildContext, JavaType javaType) {\n+    public T type( JavaType javaType) {\n@@ -44,2 +44,2 @@\n-        buildContext.funcScope(buildContext.funcOp, () -> {\n-            typeName(buildContext.funcOp.resultType().toString()).space().funcName(buildContext.funcOp);\n+        buildContext.funcScope(buildContext.funcOp(), () -> {\n+            typeName(buildContext.funcOp().resultType().toString()).space().funcName(buildContext.funcOp());\n@@ -49,1 +49,1 @@\n-                            param -> declareParam(buildContext, param)\n+                            param -> declareParam( param)\n@@ -53,2 +53,2 @@\n-                    OpHelper.Statement.statements(buildContext.funcOp.bodies().getFirst().entryBlock()),\n-                    statement -> statement(buildContext, statement)\n+                    OpHelper.Statement.statements(buildContext.funcOp().bodies().getFirst().entryBlock()),\n+                    statement -> statement( statement)\n@@ -63,1 +63,1 @@\n-        super();\n+        super(new ScopedCodeBuilderContext(lookup,funcOp));\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/JavaCodeBuilder.java","additions":8,"deletions":8,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -46,1 +46,7 @@\n-public class JavaOrC99StyleCodeBuilder<T extends JavaOrC99StyleCodeBuilder<T>> extends CodeBuilder<T>  implements BabylonOpDispatcher<T,ScopedCodeBuilderContext>{\n+public abstract class JavaOrC99StyleCodeBuilder<T extends JavaOrC99StyleCodeBuilder<T,SCBC>,SCBC extends ScopedCodeBuilderContext>\n+        extends ScopedCodeBuilder<T,SCBC>\n+        implements BabylonOpDispatcher<T,SCBC>{\n+\n+     ScopedCodeBuilderContext scopedCodeBuilderContext(){\n+         throw new RuntimeException(\"we are fake. This should be removed \");\n+     }\n@@ -84,1 +90,1 @@\n-    public T type(ScopedCodeBuilderContext buildContext, JavaType javaType) {\n+    public T type( JavaType javaType) {\n@@ -90,2 +96,2 @@\n-    public T varLoadOp(ScopedCodeBuilderContext buildContext, CoreOp.VarAccessOp.VarLoadOp varLoadOp) {\n-        Op resolve = buildContext.scope.resolve(varLoadOp.operands().getFirst());\n+    public T varLoadOp( CoreOp.VarAccessOp.VarLoadOp varLoadOp) {\n+        Op resolve = scopedCodeBuilderContext().resolve(varLoadOp.operands().getFirst());\n@@ -101,2 +107,2 @@\n-    public T varStoreOp(ScopedCodeBuilderContext buildContext, CoreOp.VarAccessOp.VarStoreOp varStoreOp) {\n-        Op op = buildContext.scope.resolve(varStoreOp.operands().getFirst());\n+    public T varStoreOp( CoreOp.VarAccessOp.VarStoreOp varStoreOp) {\n+        Op op = scopedCodeBuilderContext().resolve(varStoreOp.operands().getFirst());\n@@ -104,1 +110,1 @@\n-        equals().parenthesisIfNeeded(buildContext, varStoreOp, ((Op.Result)varStoreOp.operands().get(1)).op());\n+        equals().parenthesisIfNeeded( varStoreOp, ((Op.Result)varStoreOp.operands().get(1)).op());\n@@ -110,1 +116,1 @@\n-    public final T varOp(ScopedCodeBuilderContext buildContext, CoreOp.VarOp varOp) {\n+    public final T varOp( CoreOp.VarOp varOp) {\n@@ -112,1 +118,1 @@\n-            type(buildContext, (JavaType) varOp.varValueType()).space().varName(varOp);\n+            type( (JavaType) varOp.varValueType()).space().varName(varOp);\n@@ -114,1 +120,1 @@\n-            if (buildContext.isVarOpFinal(varOp)) {\n+            if (scopedCodeBuilderContext().isVarOpFinal(varOp)) {\n@@ -117,1 +123,1 @@\n-            type(buildContext, (JavaType) varOp.varValueType()).space().varName(varOp).space().equals().space();\n+            type( (JavaType) varOp.varValueType()).space().varName(varOp).space().equals().space();\n@@ -120,1 +126,1 @@\n-                parenthesisIfNeeded(buildContext, varOp, result.op());\n+                parenthesisIfNeeded( varOp, result.op());\n@@ -125,1 +131,1 @@\n-                \/\/parenthesisIfNeeded(buildContext, varOp, r.op());\n+                \/\/parenthesisIfNeeded( varOp, r.op());\n@@ -138,1 +144,1 @@\n-    public final T varOp(ScopedCodeBuilderContext buildContext, CoreOp.VarOp varOp, ParamVar paramVar) {\n+    public final T varOp( CoreOp.VarOp varOp, ParamVar paramVar) {\n@@ -144,2 +150,2 @@\n-    public T fieldLoadOp(ScopedCodeBuilderContext buildContext, JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp) {\n-        var fieldAccess = fieldAccess(buildContext.lookup,fieldLoadOp);\n+    public T fieldLoadOp( JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp) {\n+        var fieldAccess = fieldAccess(scopedCodeBuilderContext().lookup(),fieldLoadOp);\n@@ -155,2 +161,2 @@\n-    public final T fieldStoreOp(ScopedCodeBuilderContext buildContext, JavaOp.FieldAccessOp.FieldStoreOp fieldStoreOp) {\n-        var fieldAccess = fieldAccess(buildContext.lookup,fieldStoreOp);\n+    public final T fieldStoreOp( JavaOp.FieldAccessOp.FieldStoreOp fieldStoreOp) {\n+        var fieldAccess = fieldAccess(scopedCodeBuilderContext().lookup(),fieldStoreOp);\n@@ -158,1 +164,1 @@\n-        recurse(buildContext,((Op.Result)fieldAccess.op().operands().get(0)).op());\n+        recurse(((Op.Result)fieldAccess.op().operands().get(0)).op());\n@@ -160,1 +166,1 @@\n-        recurse(buildContext,((Op.Result)fieldAccess.op().operands().get(1)).op());\n+        recurse(((Op.Result)fieldAccess.op().operands().get(1)).op());\n@@ -166,2 +172,2 @@\n-    public final  T unaryOp(ScopedCodeBuilderContext buildContext, JavaOp.UnaryOp unaryOp) {\n-        symbol(unaryOp).parenthesisIfNeeded(buildContext, unaryOp, ((Op.Result)unaryOp.operands().getFirst()).op());\n+    public final  T unaryOp( JavaOp.UnaryOp unaryOp) {\n+        symbol(unaryOp).parenthesisIfNeeded( unaryOp, ((Op.Result)unaryOp.operands().getFirst()).op());\n@@ -172,2 +178,2 @@\n-    public final  T binaryOp(ScopedCodeBuilderContext buildContext, JavaOp.BinaryOp binaryOp) {\n-        parenthesisIfNeeded(buildContext, binaryOp, OpHelper.lhsResult(binaryOp).op());\n+    public final  T binaryOp( JavaOp.BinaryOp binaryOp) {\n+        parenthesisIfNeeded( binaryOp, OpHelper.lhsResult(binaryOp).op());\n@@ -175,1 +181,1 @@\n-        parenthesisIfNeeded(buildContext, binaryOp, OpHelper.rhsResult(binaryOp).op());\n+        parenthesisIfNeeded( binaryOp, OpHelper.rhsResult(binaryOp).op());\n@@ -181,2 +187,2 @@\n-    public final T conditionalOp(ScopedCodeBuilderContext buildContext, JavaOp.JavaConditionalOp logicalOp) {\n-        OpHelper.lhsOps(logicalOp).stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o ->  recurse(buildContext, o));\n+    public final T conditionalOp( JavaOp.JavaConditionalOp logicalOp) {\n+        OpHelper.lhsOps(logicalOp).stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o ->  recurse( o));\n@@ -184,1 +190,1 @@\n-        OpHelper.rhsOps(logicalOp).stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o-> recurse(buildContext, o));\n+        OpHelper.rhsOps(logicalOp).stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o-> recurse( o));\n@@ -189,2 +195,2 @@\n-    public final T binaryTestOp(ScopedCodeBuilderContext buildContext, JavaOp.BinaryTestOp binaryTestOp) {\n-        parenthesisIfNeeded(buildContext, binaryTestOp, OpHelper.lhsResult(binaryTestOp).op());\n+    public final T binaryTestOp( JavaOp.BinaryTestOp binaryTestOp) {\n+        parenthesisIfNeeded( binaryTestOp, OpHelper.lhsResult(binaryTestOp).op());\n@@ -192,1 +198,1 @@\n-        parenthesisIfNeeded(buildContext, binaryTestOp, OpHelper.rhsResult(binaryTestOp).op());\n+        parenthesisIfNeeded( binaryTestOp, OpHelper.rhsResult(binaryTestOp).op());\n@@ -197,1 +203,1 @@\n-    public T convOp(ScopedCodeBuilderContext buildContext, JavaOp.ConvOp convOp) {\n+    public T convOp( JavaOp.ConvOp convOp) {\n@@ -200,1 +206,1 @@\n-            paren(_ -> type(buildContext,JavaType.FLOAT)); \/\/ why double to float?\n+            paren(_ -> type(JavaType.FLOAT)); \/\/ why double to float?\n@@ -202,1 +208,1 @@\n-            paren(_ -> type(buildContext,(JavaType)convOp.resultType()));\n+            paren(_ -> type((JavaType)convOp.resultType()));\n@@ -204,1 +210,1 @@\n-        parenthesisIfNeeded(buildContext, convOp, ((Op.Result) convOp.operands().getFirst()).op());\n+        parenthesisIfNeeded( convOp, ((Op.Result) convOp.operands().getFirst()).op());\n@@ -209,1 +215,1 @@\n-    public final T constantOp(ScopedCodeBuilderContext buildContext, CoreOp.ConstantOp constantOp) {\n+    public final T constantOp( CoreOp.ConstantOp constantOp) {\n@@ -219,1 +225,1 @@\n-    public final  T yieldOp(ScopedCodeBuilderContext buildContext, CoreOp.YieldOp yieldOp) {\n+    public final  T yieldOp( CoreOp.YieldOp yieldOp) {\n@@ -221,1 +227,1 @@\n-            recurse(buildContext, result.op());\n+            recurse( result.op());\n@@ -229,1 +235,1 @@\n-    public final  T tupleOp(ScopedCodeBuilderContext buildContext, CoreOp.TupleOp tupleOp) {\n+    public final  T tupleOp( CoreOp.TupleOp tupleOp) {\n@@ -232,1 +238,1 @@\n-                recurse(buildContext, result.op());\n+                recurse( result.op());\n@@ -242,1 +248,1 @@\n-    public final T funcCallOp(ScopedCodeBuilderContext buildContext, CoreOp.FuncCallOp funcCallOp) {\n+    public final T funcCallOp( CoreOp.FuncCallOp funcCallOp) {\n@@ -247,1 +253,1 @@\n-                        result -> recurse(buildContext,result.op())\n+                        result -> recurse(result.op())\n@@ -254,1 +260,1 @@\n-    public final T labeledOp(ScopedCodeBuilderContext buildContext, JavaOp.LabeledOp labeledOp) {\n+    public final T labeledOp( JavaOp.LabeledOp labeledOp) {\n@@ -259,1 +265,1 @@\n-        recurse(buildContext,forLoopOp);\n+        recurse(forLoopOp);\n@@ -264,1 +270,1 @@\n-    public final T breakOp(ScopedCodeBuilderContext buildContext, JavaOp.BreakOp breakOp) {\n+    public final T breakOp( JavaOp.BreakOp breakOp) {\n@@ -276,1 +282,1 @@\n-    public final T continueOp(ScopedCodeBuilderContext buildContext, JavaOp.ContinueOp continueOp) {\n+    public final T continueOp( JavaOp.ContinueOp continueOp) {\n@@ -282,1 +288,1 @@\n-        } else if (buildContext.scope.parent instanceof ScopedCodeBuilderContext.ForScope) {\n+        } else if (scopedCodeBuilderContext().isInFor()) {\n@@ -292,2 +298,2 @@\n-    public final T ifOp(ScopedCodeBuilderContext buildContext, JavaOp.IfOp ifOp) {\n-        buildContext.ifScope(ifOp, () -> {\n+    public final T ifOp( JavaOp.IfOp ifOp) {\n+        scopedCodeBuilderContext().ifScope(ifOp, () -> {\n@@ -306,1 +312,1 @@\n-                                        root-> statement(buildContext,root)\n+                                        root-> statement(root)\n@@ -315,1 +321,1 @@\n-                                    .forEach((yield) -> recurse(buildContext, yield))\n+                                    .forEach((yield) -> recurse( yield))\n@@ -326,1 +332,1 @@\n-    public final T whileOp(ScopedCodeBuilderContext buildContext, JavaOp.WhileOp whileOp) {\n+    public final T whileOp( JavaOp.WhileOp whileOp) {\n@@ -330,1 +336,1 @@\n-                        .forEach(o -> recurse(buildContext, o))\n+                        .forEach(o -> recurse( o))\n@@ -334,1 +340,1 @@\n-                        statement->statement(buildContext,statement)\n+                        statement->statement(statement)\n@@ -341,2 +347,2 @@\n-    public final T forOp(ScopedCodeBuilderContext buildContext, JavaOp.ForOp forOp) {\n-        buildContext.forScope(forOp, () ->\n+    public final T forOp( JavaOp.ForOp forOp) {\n+        scopedCodeBuilderContext().forScope(forOp, () ->\n@@ -344,1 +350,1 @@\n-                    forOp.init().entryBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse(buildContext, o));\n+                    forOp.init().entryBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse( o));\n@@ -346,1 +352,1 @@\n-                    forOp.cond().entryBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse(buildContext, o));\n+                    forOp.cond().entryBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse( o));\n@@ -350,1 +356,1 @@\n-                            op -> recurse(buildContext, op)\n+                            op -> recurse( op)\n@@ -354,1 +360,1 @@\n-                                statement ->statement(buildContext,statement)\n+                                statement ->statement(statement)\n@@ -362,2 +368,2 @@\n-    public T invokeOp(ScopedCodeBuilderContext buildContext, JavaOp.InvokeOp invokeOp) {\n-        var invoke = invoke(buildContext.lookup,invokeOp);\n+    public T invokeOp( JavaOp.InvokeOp invokeOp) {\n+        var invoke = invoke(scopedCodeBuilderContext().lookup(),invokeOp);\n@@ -367,1 +373,1 @@\n-                            op -> {if (op instanceof Op.Result result) {recurse(buildContext, result.op());}\n+                            op -> {if (op instanceof Op.Result result) {recurse( result.op());}\n@@ -375,3 +381,3 @@\n-    public final T conditionalExpressionOp(ScopedCodeBuilderContext buildContext, JavaOp.ConditionalExpressionOp ternaryOp) {\n-        OpHelper.Ternary ternary = ternary(buildContext.lookup,ternaryOp);\n-        ternary.condBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse(buildContext, o));\n+    public final T conditionalExpressionOp( JavaOp.ConditionalExpressionOp ternaryOp) {\n+        OpHelper.Ternary ternary = ternary(scopedCodeBuilderContext().lookup(),ternaryOp);\n+        ternary.condBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse( o));\n@@ -379,1 +385,1 @@\n-        ternary.thenBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse(buildContext, o));\n+        ternary.thenBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse( o));\n@@ -381,1 +387,1 @@\n-        ternary.elseBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse(buildContext, o));\n+        ternary.elseBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse( o));\n@@ -388,1 +394,1 @@\n-     * @param buildContext\n+\n@@ -393,2 +399,2 @@\n-    public final  T parenthesisIfNeeded(ScopedCodeBuilderContext buildContext, Op parent, Op child) {\n-        return parenWhen(Precedence.needsParenthesis(parent,child), _ -> recurse(buildContext, child));\n+    public final  T parenthesisIfNeeded( Op parent, Op child) {\n+        return parenWhen(Precedence.needsParenthesis(parent,child), _ -> recurse( child));\n@@ -398,1 +404,1 @@\n-    public final  T returnOp(ScopedCodeBuilderContext buildContext, CoreOp.ReturnOp returnOp) {\n+    public final  T returnOp( CoreOp.ReturnOp returnOp) {\n@@ -400,1 +406,1 @@\n-                $-> $.space().parenthesisIfNeeded(buildContext, returnOp, ((Op.Result) returnOp.operands().getFirst()).op())\n+                $-> $.space().parenthesisIfNeeded( returnOp, ((Op.Result) returnOp.operands().getFirst()).op())\n@@ -405,2 +411,2 @@\n-    public final  T statement(ScopedCodeBuilderContext buildContext,Op op) {\n-        recurse(buildContext, op);\n+    public final  T statement(Op op) {\n+        recurse( op);\n@@ -422,2 +428,2 @@\n-    public final  T declareParam(ScopedCodeBuilderContext buildContext, FuncOpParams.Info param){\n-        return  type(buildContext,(JavaType) param.parameter.type()).space().varName(param.varOp);\n+    public final  T declareParam( FuncOpParams.Info param){\n+        return  type((JavaType) param.parameter.type()).space().varName(param.varOp);\n@@ -427,2 +433,2 @@\n-    public T newOp(ScopedCodeBuilderContext buildContext, JavaOp.NewOp newOp) {\n-         newKeyword().space().type(buildContext,(JavaType) newOp.type());\n+    public T newOp( JavaOp.NewOp newOp) {\n+         newKeyword().space().type((JavaType) newOp.type());\n@@ -437,1 +443,1 @@\n-                                   recurse(buildContext, result.op());\n+                                   recurse( result.op());\n@@ -446,1 +452,1 @@\n-                                   recurse(buildContext, result.op());\n+                                   recurse( result.op());\n@@ -455,3 +461,3 @@\n-    public T arrayLoadOp(ScopedCodeBuilderContext buildContext, JavaOp.ArrayAccessOp.ArrayLoadOp arrayLoadOp){\n-        recurse(buildContext,((Op.Result)arrayLoadOp.operands().get(0)).op());\n-        sbrace(_-> recurse(buildContext,((Op.Result)arrayLoadOp.operands().get(1)).op()));\n+    public T arrayLoadOp( JavaOp.ArrayAccessOp.ArrayLoadOp arrayLoadOp){\n+        recurse(((Op.Result)arrayLoadOp.operands().get(0)).op());\n+        sbrace(_-> recurse(((Op.Result)arrayLoadOp.operands().get(1)).op()));\n@@ -462,3 +468,3 @@\n-    public T arrayStoreOp(ScopedCodeBuilderContext buildContext, JavaOp.ArrayAccessOp.ArrayStoreOp arrayStoreOp){\n-        recurse(buildContext,((Op.Result)arrayStoreOp.operands().get(0)).op());\n-        sbrace(_-> recurse(buildContext,((Op.Result)arrayStoreOp.operands().get(1)).op()));\n+    public T arrayStoreOp( JavaOp.ArrayAccessOp.ArrayStoreOp arrayStoreOp){\n+        recurse(((Op.Result)arrayStoreOp.operands().get(0)).op());\n+        sbrace(_-> recurse(((Op.Result)arrayStoreOp.operands().get(1)).op()));\n@@ -466,1 +472,1 @@\n-        recurse(buildContext,((Op.Result)arrayStoreOp.operands().get(2)).op());\n+        recurse(((Op.Result)arrayStoreOp.operands().get(2)).op());\n@@ -471,1 +477,1 @@\n-    public T enhancedForOp(ScopedCodeBuilderContext builderContext, JavaOp.EnhancedForOp enhancedForOp){\n+    public T enhancedForOp(JavaOp.EnhancedForOp enhancedForOp){\n@@ -473,1 +479,1 @@\n-            enhancedForOp.initialization().entryBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse(builderContext, o));\n+            enhancedForOp.initialization().entryBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse( o));\n@@ -475,1 +481,1 @@\n-            enhancedForOp.expression().entryBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse(builderContext, o));\n+            enhancedForOp.expression().entryBlock().ops().stream().filter(o -> o instanceof CoreOp.YieldOp).forEach(o -> recurse( o));\n@@ -478,1 +484,1 @@\n-                    statement ->statement(builderContext,statement)\n+                    this::statement\n@@ -486,2 +492,2 @@\n-    public T blockOp(ScopedCodeBuilderContext buildContext, JavaOp.BlockOp blockOp) {\n-      return braceNlIndented(_-> nlSeparated(OpHelper.Statement.statements(blockOp.body().entryBlock()), statement ->statement(buildContext,statement)));\n+    public T blockOp( JavaOp.BlockOp blockOp) {\n+      return braceNlIndented(_-> nlSeparated(OpHelper.Statement.statements(blockOp.body().entryBlock()), this::statement));\n@@ -491,1 +497,1 @@\n-    public T concatOp(ScopedCodeBuilderContext buildContext, JavaOp.ConcatOp concatOp) {\n+    public T concatOp( JavaOp.ConcatOp concatOp) {\n@@ -493,3 +499,2 @@\n-                recurse(buildContext, ((Op.Result)concatOp.operands().get(0)).op()).\n-        add().recurse(buildContext, ((Op.Result)concatOp.operands().get(1)).op());\n-      \/\/  blockInlineComment(\"concat\");\n+                recurse( ((Op.Result)concatOp.operands().get(0)).op()).\n+        add().recurse( ((Op.Result)concatOp.operands().get(1)).op());\n@@ -499,2 +504,3 @@\n-    public final T lambdaOp(ScopedCodeBuilderContext buildContext, JavaOp.LambdaOp lambdaOp) {\n-        braceNlIndented(_-> {\n+    public final T lambdaOp( JavaOp.LambdaOp lambdaOp) {\n+        scopedCodeBuilderContext().lambdaScope(lambdaOp,()->\n+          braceNlIndented(_-> {\n@@ -503,1 +509,1 @@\n-                    statement -> statement(buildContext, statement)\n+                    this::statement\n@@ -506,1 +512,2 @@\n-        });\n+          })\n+        );\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/JavaOrC99StyleCodeBuilder.java","additions":109,"deletions":102,"binary":false,"changes":211,"status":"modified"},{"patch":"@@ -0,0 +1,41 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package optkl.codebuilders;\n+\n+\n+public abstract class ScopeAwareJavaOrC99StyleCodeBuilder<T extends ScopeAwareJavaOrC99StyleCodeBuilder<T>>\n+        extends JavaOrC99StyleCodeBuilder<T,ScopedCodeBuilderContext>\n+        implements BabylonOpDispatcher<T,ScopedCodeBuilderContext>{\n+    final ScopedCodeBuilderContext scopedCodeBuilderContext;\n+    protected ScopeAwareJavaOrC99StyleCodeBuilder(ScopedCodeBuilderContext scopedCodeBuilderContext){\n+        if (scopedCodeBuilderContext == null){\n+            throw new RuntimeException(\"Where did this come from \");\n+        }\n+        this.scopedCodeBuilderContext = scopedCodeBuilderContext;\n+    }\n+    final public ScopedCodeBuilderContext scopedCodeBuilderContext(){\n+        return scopedCodeBuilderContext;\n+    }\n+}\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/ScopeAwareJavaOrC99StyleCodeBuilder.java","additions":41,"deletions":0,"binary":false,"changes":41,"status":"added"},{"patch":"@@ -0,0 +1,43 @@\n+\/*\n+ * Copyright (c) 2024-2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package optkl.codebuilders;\n+\n+import jdk.incubator.code.Op;\n+import jdk.incubator.code.dialect.core.CoreOp;\n+import jdk.incubator.code.dialect.java.JavaOp;\n+import optkl.util.StreamMutable;\n+\n+import java.util.function.Consumer;\n+import java.util.stream.Stream;\n+\n+\/**\n+ * Extends the base CodeBuilder to allow builder to track scope\n+ *\n+ * @author Gary Frost\n+ *\/\n+public abstract class ScopedCodeBuilder<T extends ScopedCodeBuilder<T,SCBC>, SCBC extends ScopedCodeBuilderContext>\n+        extends CodeBuilder<T> implements CodeRenderer<T> {\n+\n+}\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/ScopedCodeBuilder.java","additions":43,"deletions":0,"binary":false,"changes":43,"status":"added"},{"patch":"@@ -28,1 +28,1 @@\n-import jdk.incubator.code.dialect.core.VarType;\n+import optkl.util.carriers.LookupCarrier;\n@@ -42,1 +42,1 @@\n-public class ScopedCodeBuilderContext extends CodeBuilderContext {\n+public class ScopedCodeBuilderContext implements LookupCarrier {\n@@ -45,1 +45,5 @@\n-    public static class Scope<O extends Op> {\n+    public boolean isInFor() {\n+        return (scope != null && scope.parent instanceof ForScope);\n+    }\n+\n+    public static sealed abstract class Scope<O extends Op> permits ForScope, FuncScope, IfScope, LambdaScope, RootScope {\n@@ -58,2 +62,0 @@\n-\n-\n@@ -73,1 +75,1 @@\n-    public static class FuncScope extends Scope<CoreOp.FuncOp> {\n+    public static final class FuncScope extends Scope<CoreOp.FuncOp> {\n@@ -87,1 +89,0 @@\n-                    \/\/throw new IllegalStateException(\"what ?\");\n@@ -95,1 +96,1 @@\n-    public static class ForScope extends Scope<JavaOp.ForOp> {\n+    public static final class ForScope extends Scope<JavaOp.ForOp> {\n@@ -208,1 +209,1 @@\n-    public static class IfScope extends Scope<JavaOp.IfOp> {\n+    public static final class IfScope extends Scope<JavaOp.IfOp> {\n@@ -214,0 +215,14 @@\n+    public static final class RootScope extends Scope<Op> {\n+        RootScope() {\n+            super(null,null);\n+        }\n+    }\n+    public static final class LambdaScope extends Scope<JavaOp.LambdaOp> {\n+        LambdaScope(Scope<?> parent, JavaOp.LambdaOp lambdaOp) {\n+            super(parent,lambdaOp);\n+        }\n+        @Override public Op resolve(Value value){\n+            return super.resolve(value);\n+        }\n+    }\n+\n@@ -223,0 +238,5 @@\n+    public  void lambdaScope(JavaOp.LambdaOp lambdaOp, Runnable r) {\n+        scope = new LambdaScope(scope, lambdaOp);\n+        r.run();\n+        popScope();\n+    }\n@@ -236,1 +256,6 @@\n-    public Scope<?> scope = null;\n+    private final  MethodHandles.Lookup lookup;\n+    private final CoreOp.FuncOp funcOp;\n+    private  Scope<?> scope = new RootScope();\n+    @Override public MethodHandles.Lookup lookup(){\n+        return lookup;\n+    }\n@@ -238,0 +263,6 @@\n+    public Op resolve(Value value){\n+        return scope.resolve(value);\n+    }\n+    public CoreOp.FuncOp funcOp(){\n+        return funcOp;\n+    }\n@@ -239,1 +270,2 @@\n-        super(lookup,funcOp);\n+        this.lookup = lookup;\n+        this.funcOp= funcOp;\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/ScopedCodeBuilderContext.java","additions":43,"deletions":11,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -49,2 +49,0 @@\n-\n-\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/codebuilders\/TextBuilder.java","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -592,1 +592,1 @@\n-        DeviceSchema<SharedMemory> schema = DeviceSchema.of(SharedMemory.class,\n+        DeviceSchema<SharedMemory> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedMemory.class,\n@@ -609,1 +609,1 @@\n-        DeviceSchema<PrivateArray> schema = DeviceSchema.of(PrivateArray.class,\n+        DeviceSchema<PrivateArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateArray.class,\n@@ -673,1 +673,1 @@\n-        DeviceSchema<SharedDeviceType> schema = DeviceSchema.of(SharedDeviceType.class,\n+        DeviceSchema<SharedDeviceType> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedDeviceType.class,\n@@ -690,1 +690,1 @@\n-        DeviceSchema<PrivateDeviceType> schema = DeviceSchema.of(PrivateDeviceType.class,\n+        DeviceSchema<PrivateDeviceType> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateDeviceType.class,\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestArrayView.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -148,1 +148,1 @@\n-        DeviceSchema<LocalArray> schema = DeviceSchema.of(LocalArray.class,\n+        DeviceSchema<LocalArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,LocalArray.class,\n@@ -211,1 +211,1 @@\n-        DeviceSchema<PrivateArray> schema = DeviceSchema.of(PrivateArray.class,\n+        DeviceSchema<PrivateArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateArray.class,\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestBFloat16Type.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -35,0 +35,2 @@\n+import java.lang.invoke.MethodHandles;\n+\n@@ -58,1 +60,1 @@\n-        DeviceSchema<MyDeviceArray> schema = DeviceSchema.of(MyDeviceArray.class, builder ->\n+        DeviceSchema<MyDeviceArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,MyDeviceArray.class, builder ->\n@@ -100,1 +102,1 @@\n-        DeviceSchema<MyNDRAnge> schema = DeviceSchema.of(MyNDRAnge.class, builder ->\n+        DeviceSchema<MyNDRAnge> schema = DeviceSchema.of(MethodHandles.lookup(),null,MyNDRAnge.class, builder ->\n@@ -143,1 +145,1 @@\n-        DeviceSchema<MultiDim> schema = DeviceSchema.of(MultiDim.class, builder ->\n+        DeviceSchema<MultiDim> schema = DeviceSchema.of(MethodHandles.lookup(),null,MultiDim.class, builder ->\n@@ -183,1 +185,1 @@\n-        DeviceSchema<MultiDimFix> schema = DeviceSchema.of(MultiDimFix.class, builder ->\n+        DeviceSchema<MultiDimFix> schema = DeviceSchema.of(MethodHandles.lookup(),null,MultiDimFix.class, builder ->\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestDeviceType.java","additions":6,"deletions":4,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -151,1 +151,1 @@\n-        DeviceSchema<DeviceLocalArray> schema = DeviceSchema.of(DeviceLocalArray.class,\n+        DeviceSchema<DeviceLocalArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,DeviceLocalArray.class,\n@@ -217,1 +217,1 @@\n-        DeviceSchema<DevicePrivateArray> schema = DeviceSchema.of(DevicePrivateArray.class,\n+        DeviceSchema<DevicePrivateArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,DevicePrivateArray.class,\n@@ -249,1 +249,1 @@\n-        DeviceSchema<DevicePrivateArray2> schema = DeviceSchema.of(DevicePrivateArray2.class,\n+        DeviceSchema<DevicePrivateArray2> schema = DeviceSchema.of(MethodHandles.lookup(),null,DevicePrivateArray2.class,\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestF16Type.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -161,1 +161,1 @@\n-        DeviceSchema<SharedArray> schema = DeviceSchema.of(SharedArray.class,\n+        DeviceSchema<SharedArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedArray.class,\n@@ -193,1 +193,1 @@\n-        DeviceSchema<PrivateMemory> schema = DeviceSchema.of(PrivateMemory.class,\n+        DeviceSchema<PrivateMemory> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateMemory.class,\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestFloat2.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -48,1 +48,1 @@\n-        DeviceSchema<MySharedArray> schema = DeviceSchema.of(MySharedArray.class,\n+        DeviceSchema<MySharedArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,MySharedArray.class,\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestLocal.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -104,1 +104,1 @@\n-        DeviceSchema<MyLocalArrayFixedSize> schema = DeviceSchema.of(MyLocalArrayFixedSize.class,\n+        DeviceSchema<MyLocalArrayFixedSize> schema = DeviceSchema.of(MethodHandles.lookup(),null,MyLocalArrayFixedSize.class,\n@@ -512,1 +512,1 @@\n-        DeviceSchema<SharedMemory> schema = DeviceSchema.of(SharedMemory.class,\n+        DeviceSchema<SharedMemory> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedMemory.class,\n@@ -527,1 +527,1 @@\n-        DeviceSchema<PrivateArray> schema = DeviceSchema.of(PrivateArray.class,\n+        DeviceSchema<PrivateArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateArray.class,\n@@ -540,1 +540,1 @@\n-        DeviceSchema<FlatPrivate> schema = DeviceSchema.of(FlatPrivate.class,\n+        DeviceSchema<FlatPrivate> schema = DeviceSchema.of(MethodHandles.lookup(),null,FlatPrivate.class,\n@@ -840,1 +840,1 @@\n-        DeviceSchema<SharedMemoryHalf> schema = DeviceSchema.of(SharedMemoryHalf.class,\n+        DeviceSchema<SharedMemoryHalf> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedMemoryHalf.class,\n@@ -856,1 +856,1 @@\n-        DeviceSchema<PrivateArrayHalf> schema = DeviceSchema.of(PrivateArrayHalf.class,\n+        DeviceSchema<PrivateArrayHalf> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateArrayHalf.class,\n@@ -872,1 +872,1 @@\n-        DeviceSchema<FlatPrivateHalf> schema = DeviceSchema.of(FlatPrivateHalf.class,\n+        DeviceSchema<FlatPrivateHalf> schema = DeviceSchema.of(MethodHandles.lookup(),null,FlatPrivateHalf.class,\n@@ -978,1 +978,1 @@\n-        DeviceSchema<SharedMemoryBfloat16> schema = DeviceSchema.of(SharedMemoryBfloat16.class,\n+        DeviceSchema<SharedMemoryBfloat16> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedMemoryBfloat16.class,\n@@ -994,1 +994,1 @@\n-        DeviceSchema<PrivateArrayBfloat16> schema = DeviceSchema.of(PrivateArrayBfloat16.class,\n+        DeviceSchema<PrivateArrayBfloat16> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateArrayBfloat16.class,\n@@ -1010,1 +1010,1 @@\n-        DeviceSchema<FlatPrivateBfloat16> schema = DeviceSchema.of(FlatPrivateBfloat16.class,\n+        DeviceSchema<FlatPrivateBfloat16> schema = DeviceSchema.of(MethodHandles.lookup(),null,FlatPrivateBfloat16.class,\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestMatMul.java","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -50,1 +50,1 @@\n-        DeviceSchema<PrivateArray> schema = DeviceSchema.of(PrivateArray.class,\n+        DeviceSchema<PrivateArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateArray.class,\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestPrivate.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -48,1 +48,1 @@\n-        DeviceSchema<MySharedArray> schema = DeviceSchema.of(MySharedArray.class,\n+        DeviceSchema<MySharedArray> schema = DeviceSchema.of(MethodHandles.lookup(),null,MySharedArray.class,\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestReductions.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -224,1 +224,1 @@\n-        DeviceSchema<SharedMemory> schema = DeviceSchema.of(SharedMemory.class,\n+        DeviceSchema<SharedMemory> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedMemory.class,\n@@ -256,1 +256,1 @@\n-        DeviceSchema<PrivateMemory> schema = DeviceSchema.of(PrivateMemory.class,\n+        DeviceSchema<PrivateMemory> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateMemory.class,\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestVectorArrayView.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -165,1 +165,1 @@\n-        DeviceSchema<SharedMemory> schema = DeviceSchema.of(SharedMemory.class,\n+        DeviceSchema<SharedMemory> schema = DeviceSchema.of(MethodHandles.lookup(),null,SharedMemory.class,\n@@ -197,1 +197,1 @@\n-        DeviceSchema<PrivateMemory> schema = DeviceSchema.of(PrivateMemory.class,\n+        DeviceSchema<PrivateMemory> schema = DeviceSchema.of(MethodHandles.lookup(),null,PrivateMemory.class,\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestVectorTypes.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}