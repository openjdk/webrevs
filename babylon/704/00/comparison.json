{"files":[{"patch":"@@ -0,0 +1,34 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package hat.codebuilders;\n+\n+public class C99CodeBuilder<T extends HATCodeBuilder<T>> extends CodeBuilder<T> {\n+\n+    public C99CodeBuilder() {}\n+\n+    public C99CodeBuilder(String text) {\n+        this.emitText(text);\n+    }\n+}\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/C99CodeBuilder.java","additions":34,"deletions":0,"binary":false,"changes":34,"status":"added"},{"patch":"@@ -28,0 +28,1 @@\n+import hat.codebuilders.C99CodeBuilder;\n@@ -44,2 +45,1 @@\n-    private final Map<Class<?>, Consumer<DeviceSchema<T>>> deps = new HashMap<>();\n-    private final StringBuilder representationBuilder = new StringBuilder();\n+    private final C99CodeBuilder representationBuilder = new C99CodeBuilder<>();\n@@ -87,1 +87,0 @@\n-        deps.put(klass, depConsumer);\n@@ -108,1 +107,1 @@\n-    private void materialize(StringBuilder sb, Class<?> klass) {\n+    private void materialize(C99CodeBuilder builder, Class<?> klass) {\n@@ -112,3 +111,1 @@\n-            sb.append(\"<\");\n-            sb.append(klass.getName());\n-            sb.append(':');\n+            builder.lt().identifier(klass.getName()).colon();\n@@ -129,1 +126,1 @@\n-                            StringBuilder depsBuilder = new StringBuilder();\n+                            C99CodeBuilder depsBuilder = new C99CodeBuilder<>(builder.getText());\n@@ -131,1 +128,1 @@\n-                            sb = depsBuilder.append(sb);\n+                            builder = depsBuilder;\n@@ -140,8 +137,8 @@\n-                            sb.append(\"[\");                        \/\/ Array indicator\n-                            sb.append(\":\");                        \/\/ separator\n-                            sb.append(type);                       \/\/ type\n-                            sb.append(\":\");                        \/\/ separator\n-                            sb.append(method.getName());           \/\/ variableName\n-                            sb.append(\":\");                        \/\/ separator\n-                            sb.append(arraySize.get(method.getName()));  \/\/ Array size\n-                            sb.append(\";\");                        \/\/ member separator\n+                            builder.osbrace()                       \/\/ Array indicator\n+                                    .colon()                        \/\/ separator\n+                                    .typeName(type)                 \/\/ type\n+                                    .colon()                        \/\/ separator\n+                                    .identifier(method.getName())   \/\/ variableName\n+                                    .colon()                        \/\/ separator\n+                                    .identifier(Integer.toString(arraySize.get(method.getName()))) \/\/ Array size\n+                                    .semicolon();                   \/\/ member separator\n@@ -149,6 +146,6 @@\n-                            sb.append(\"s\");                         \/\/ scalar indicator\n-                            sb.append(\":\");                         \/\/ separator\n-                            sb.append(type);                        \/\/ type\n-                            sb.append(\":\");                         \/\/ separator\n-                            sb.append(method.getName());            \/\/ var name\n-                            sb.append(\";\");                         \/\/ member separator\n+                            builder.identifier(\"s\")            \/\/ scalar indicator\n+                                    .colon()                        \/\/ separator\n+                                    .typeName(type)                 \/\/ type\n+                                    .colon()                        \/\/ separator\n+                                    .identifier(method.getName())   \/\/ var name\n+                                    .semicolon();                   \/\/ member separator\n@@ -168,1 +165,1 @@\n-        sb.append(\">\");\n+        builder.gt();\n@@ -172,1 +169,1 @@\n-        return this.representationBuilder.toString();\n+        return this.representationBuilder.getText();\n","filename":"hat\/core\/src\/main\/java\/hat\/device\/DeviceSchema.java","additions":22,"deletions":25,"binary":false,"changes":47,"status":"modified"},{"patch":"@@ -163,0 +163,39 @@\n+\n+    public interface MultiDimFix extends DeviceType {\n+        _2D array(int index);\n+        void array(int index, _2D value);\n+\n+        interface _2D {\n+            _3D _range2(int index);\n+            void _range2(int index, _3D val);\n+\n+            interface _3D {\n+                int value(int index);\n+                void value(int index, int val);\n+            }\n+        }\n+\n+        DeviceSchema<MultiDimFix> schema = DeviceSchema.of(MultiDimFix.class, builder ->\n+                builder.withArray(\"array\", 2048)\n+                        .withDeps(_2D.class,subrange -> subrange.withArray(\"_range2\", 64)\n+                                .withDeps(_2D._3D.class, f -> f.withArray(\"value\", 32))));\n+\n+        static MultiDimFix create() {\n+            return null;\n+        }\n+    }\n+\n+    @HatTest\n+    public void testdevice_type_04() {\n+        \/\/ Same test as the previous one with the correct field names\n+        try {\n+            MultiDimFix myDeviceArray = MultiDimFix.create();\n+            String text = MultiDimFix.schema.toText();\n+            \/\/ If we request the correct method, the result should be as follows:\n+            IO.println(text);\n+            boolean isEquals = text.equals(\"<hat.test.TestDeviceType$MultiDim$_2D$_3D:[:int:value:32;><hat.test.TestDeviceType$MultiDim$_2D:[:hat.test.TestDeviceType$MultiDim$_2D$_3D:_range2:64;><hat.test.TestDeviceType$MultiDim:[:hat.test.TestDeviceType$MultiDim$_2D:array:2048;>\");\n+            HATAsserts.assertFalse(isEquals);\n+        } catch (ExceptionInInitializerError e) {\n+            HATAsserts.assertTrue(true);\n+        }\n+    }\n","filename":"hat\/tests\/src\/main\/java\/hat\/test\/TestDeviceType.java","additions":39,"deletions":0,"binary":false,"changes":39,"status":"modified"}]}