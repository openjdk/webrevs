{"files":[{"patch":"@@ -209,1 +209,1 @@\n-                OpNode n = new CodeModelParser(cm.bodies()).parseOpNode(cm.funcOp());\n+                OpNode n = new CodeModelParser(cm.bodies(), cm.types()).parseOpNode(cm.funcOp());\n@@ -223,0 +223,1 @@\n+        final CodeModel.Type[] allTypes;\n@@ -225,1 +226,1 @@\n-        public CodeModelParser(CodeModel.Body[] allBodies) {\n+        public CodeModelParser(CodeModel.Body[] allBodies, CodeModel.Type[] allTypes) {\n@@ -227,0 +228,1 @@\n+            this.allTypes = allTypes;\n@@ -245,1 +247,1 @@\n-                    op.resultType().isEmpty() ? null : new ValueNode(String.valueOf(++valueIndex), parseExTypeElem(op.resultType())),\n+                    op.resultType() < 0 ? null : new ValueNode(String.valueOf(++valueIndex), parseExTypeElem(op.resultType())),\n@@ -259,1 +261,1 @@\n-                            Stream.of(bl.paramTypes()).map(pt -> new ValueNode(String.valueOf(++valueIndex), parseExTypeElem(pt))).toList(),\n+                            IntStream.of(bl.paramTypes()).mapToObj(pt -> new ValueNode(String.valueOf(++valueIndex), parseExTypeElem(pt))).toList(),\n@@ -262,0 +264,5 @@\n+\n+        ExternalizedTypeElement parseExTypeElem(int typeIndex) {\n+            var type = allTypes[typeIndex];\n+            return new ExternalizedTypeElement(type.identifier(), IntStream.of(type.arguments()).mapToObj(this::parseExTypeElem).toList());\n+        }\n@@ -268,4 +275,0 @@\n-    static ExternalizedTypeElement parseExTypeElem(String desc) {\n-        return JavaTypeUtils.inflate(DescParser.parseExTypeElem(desc));\n-    }\n-\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/extern\/OpParser.java","additions":11,"deletions":8,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -48,0 +48,6 @@\n+    \/**\n+     * The collection of types referenced by operations, blocks, bodies and types in this model. The indexing of these\n+     * entries is local to this array.\n+     *\/\n+    Type[] types();\n+\n@@ -53,0 +59,1 @@\n+     * @see jdk.incubator.code.extern.ExternalizedOp\n@@ -80,1 +87,1 @@\n-         * Result type for this operation, if applicable.\n+         * Index of the result type for this operation within the enclosing {@link Body#types()} array.\n@@ -84,1 +91,1 @@\n-        String resultType() default \"\";\n+        int resultType() default -1;\n@@ -134,1 +141,1 @@\n-         * Type produced by this body.\n+         * Index of the type produced by this body within the enclosing {@link Body#types()} array.\n@@ -138,1 +145,1 @@\n-        String yieldType();\n+        int yieldType();\n@@ -156,1 +163,1 @@\n-         * Types of block parameters, if any.\n+         * Indexes of the block parameter types within the enclosing {@link Body#types()} array.\n@@ -160,1 +167,1 @@\n-        String[] paramTypes() default {};\n+        int[] paramTypes() default {};\n@@ -192,0 +199,26 @@\n+\n+    \/**\n+     * Describes a type used in the code reflection model. A type is identified by an externalized name and may\n+     * carry zero or more nested type arguments to represent parameterized or composite types.\n+     *\n+     * @see jdk.incubator.code.TypeElement\n+     * @see jdk.incubator.code.extern.ExternalizedTypeElement\n+     *\/\n+    @interface Type {\n+\n+        \/**\n+         * Fully qualified, stable identifier of the type. This is the externalized form used to serialize and restore\n+         * the type.\n+         *\n+         * @return the externalized type identifier\n+         *\/\n+        String identifier();\n+\n+        \/**\n+         * Indexes of the of type arguments within the enclosing {@link Body#types()} array.\n+         * For non-parameterized types, this array is empty.\n+         *\n+         * @return the type arguments, or an empty array if none\n+         *\/\n+        int[] arguments();\n+    }\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/internal\/CodeModel.java","additions":39,"deletions":6,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -28,1 +28,0 @@\n-import java.util.IdentityHashMap;\n@@ -47,0 +46,1 @@\n+import java.util.HashMap;\n@@ -52,0 +52,1 @@\n+import jdk.incubator.code.TypeElement;\n@@ -55,0 +56,1 @@\n+import jdk.incubator.code.extern.ExternalizedTypeElement;\n@@ -70,1 +72,1 @@\n-        final Map<T, Integer> map = new IdentityHashMap<>();\n+        final Map<T, Integer> map = new HashMap<>();\n@@ -90,0 +92,2 @@\n+               typeType,\n+               typeArrayType,\n@@ -95,0 +99,1 @@\n+                       modelTypes,\n@@ -110,0 +115,2 @@\n+                       typeIdentifier,\n+                       typeArguments,\n@@ -134,0 +141,2 @@\n+        typeType = syms.enterClass(jdk_incubator_code, \"jdk.incubator.code.internal.CodeModel$Type\");\n+        typeArrayType = types.makeArrayType(typeType);\n@@ -146,1 +155,2 @@\n-        bodyYieldType = atypes.methodType(\"yieldType\", syms.stringType, bodyType);\n+        modelTypes = atypes.methodType(\"types\", typeArrayType, codeModelType);\n+        bodyYieldType = atypes.methodType(\"yieldType\", syms.intType, bodyType);\n@@ -148,1 +158,1 @@\n-        blockParamTypes = atypes.methodType(\"paramTypes\", stringArrayType, blockType);\n+        blockParamTypes = atypes.methodType(\"paramTypes\", intArrayType, blockType);\n@@ -155,1 +165,1 @@\n-        opResultType = atypes.methodType(\"resultType\", syms.stringType, opType);\n+        opResultType = atypes.methodType(\"resultType\", syms.intType, opType);\n@@ -161,0 +171,2 @@\n+        typeIdentifier = atypes.methodType(\"identifier\", syms.stringType, typeType);\n+        typeArguments = atypes.methodType(\"arguments\", intArrayType, typeType);\n@@ -181,1 +193,3 @@\n-        ListBuffer<Attribute> bodies = new ListBuffer<>();\n+        Indexer<ExternalizedTypeElement> typeIndexer = new Indexer<>();\n+        ListBuffer<Attribute> allBodies = new ListBuffer<>();\n+        ListBuffer<Attribute> allTypes = new ListBuffer<>();\n@@ -183,2 +197,3 @@\n-                Pair.of(modelFuncOp, op(funcOp, valueIndexer, blockIndexer, bodyIndexer, bodies)),\n-                Pair.of(modelBodies, new Attribute.Array(bodyArrayType, bodies.toList()))));\n+                Pair.of(modelFuncOp, op(funcOp, valueIndexer, blockIndexer, bodyIndexer, typeIndexer, allBodies, allTypes)),\n+                Pair.of(modelBodies, new Attribute.Array(bodyArrayType, allBodies.toList())),\n+                Pair.of(modelTypes, new Attribute.Array(typeArrayType, allTypes.toList()))));\n@@ -211,1 +226,7 @@\n-    Attribute.Compound op(Op op, Indexer<Value> valueIndexer, Indexer<Block> blockIndexer, Indexer<Body> bodyIndexer, ListBuffer<Attribute> bodyAttributes) {\n+    Attribute.Compound op(Op op,\n+                          Indexer<Value> valueIndexer,\n+                          Indexer<Block> blockIndexer,\n+                          Indexer<Body> bodyIndexer,\n+                          Indexer<ExternalizedTypeElement> typeIndexer,\n+                          ListBuffer<Attribute> allBodies,\n+                          ListBuffer<Attribute> allTypes) {\n@@ -222,1 +243,1 @@\n-            lb.add(Pair.of(opResultType, stringConstant(op.resultType().externalize().toString())));\n+            lb.add(Pair.of(opResultType, type(op.resultType().externalize(), typeIndexer, allTypes)));\n@@ -244,1 +265,1 @@\n-            bodies(bodies, valueIndexer, blockIndexer, bodyIndexer, bodyAttributes);\n+            bodies(bodies, valueIndexer, blockIndexer, bodyIndexer, typeIndexer, allBodies, allTypes);\n@@ -250,2 +271,8 @@\n-    void bodies(List<Body> bodies, Indexer<Value> valueIndexer, Indexer<Block> blockIndexer, Indexer<Body> bodyIndexer, ListBuffer<Attribute> bodyAttributes) {\n-        for (Body body : bodies) {\n+    void bodies(List<Body> opBodies,\n+                Indexer<Value> valueIndexer,\n+                Indexer<Block> blockIndexer,\n+                Indexer<Body> bodyIndexer,\n+                Indexer<ExternalizedTypeElement> typeIndexer,\n+                ListBuffer<Attribute> allBodies,\n+                ListBuffer<Attribute> allTypes) {\n+        for (Body body : opBodies) {\n@@ -254,3 +281,3 @@\n-            bodyAttributes.add(new Attribute.Compound(bodyType, List.of(Pair.of(bodyYieldType, stringConstant(body.yieldType().externalize().toString())),\n-                Pair.of(bodyBlocks, new Attribute.Array(blockArrayType, blocks(List.from(body.blocks()), valueIndexer, blockIndexer, bodyIndexer, nested))))));\n-            bodyAttributes.appendList(nested);\n+            allBodies.add(new Attribute.Compound(bodyType, List.of(Pair.of(bodyYieldType, type(body.yieldType().externalize(), typeIndexer, allTypes)),\n+                Pair.of(bodyBlocks, new Attribute.Array(blockArrayType, blocks(List.from(body.blocks()), valueIndexer, blockIndexer, bodyIndexer, typeIndexer, nested, allTypes))))));\n+            allBodies.appendList(nested);\n@@ -260,1 +287,7 @@\n-    List<Attribute> blocks(List<Block> blocks, Indexer<Value> valueIndexer, Indexer<Block> blockIndexer, Indexer<Body> bodyIndexer, ListBuffer<Attribute> bodyAttributes) {\n+    List<Attribute> blocks(List<Block> blocks,\n+                           Indexer<Value> valueIndexer,\n+                           Indexer<Block> blockIndexer,\n+                           Indexer<Body> bodyIndexer,\n+                           Indexer<ExternalizedTypeElement> typeIndexer,\n+                           ListBuffer<Attribute> allBodies,\n+                           ListBuffer<Attribute> allTypes) {\n@@ -266,1 +299,1 @@\n-            args.add(Pair.of(blockOps, new Attribute.Array(opArrayType, List.from(block.ops()).map(op -> op(op, valueIndexer, blockIndexer, bodyIndexer, bodyAttributes)))));\n+            args.add(Pair.of(blockOps, new Attribute.Array(opArrayType, List.from(block.ops()).map(op -> op(op, valueIndexer, blockIndexer, bodyIndexer, typeIndexer, allBodies, allTypes)))));\n@@ -268,1 +301,1 @@\n-                args.add(Pair.of(blockParamTypes, new Attribute.Array(stringArrayType, List.from(block.parameterTypes()).map(pt -> stringConstant(pt.externalize().toString())))));\n+                args.add(Pair.of(blockParamTypes, new Attribute.Array(stringArrayType, List.from(block.parameterTypes()).map(pt -> type(pt.externalize(), typeIndexer, allTypes)))));\n@@ -275,1 +308,14 @@\n-    List<Attribute> successors(List<Block.Reference> successors, Indexer<Value> valueIndexer, Indexer<Block> blockIndexer) {\n+    Attribute.Constant type(ExternalizedTypeElement type,\n+                            Indexer<ExternalizedTypeElement> typeIndexer,\n+                            ListBuffer<Attribute> allTypes) {\n+        var args = type.arguments().stream().map(et -> type(et, typeIndexer, allTypes)).toArray(Attribute[]::new);\n+        int index = allTypes.size();\n+        allTypes.add(new Attribute.Compound(typeType, List.of(\n+                Pair.of(typeIdentifier, stringConstant(type.identifier())),\n+                Pair.of(typeArguments, new Attribute.Array(intArrayType, args)))));\n+        return new Attribute.Constant(syms.intType, index);\n+    }\n+\n+    List<Attribute> successors(List<Block.Reference> successors,\n+                               Indexer<Value> valueIndexer,\n+                               Indexer<Block> blockIndexer) {\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/internal\/CodeModelSymbols.java","additions":66,"deletions":20,"binary":false,"changes":86,"status":"modified"}]}