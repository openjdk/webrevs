{"files":[{"patch":"@@ -36,0 +36,1 @@\n+import java.util.function.Supplier;\n@@ -107,2 +108,4 @@\n-    static final MethodRef EX_TYPE_ELEM_OF_LIST = MethodRef.method(EX_TYPE_ELEM, \"of\",\n-            EX_TYPE_ELEM, J_L_STRING, J_U_LIST);\n+    static final FunctionType EXTER_TYPE_BUILDER_F_TYPE = functionType(EX_TYPE_ELEM);\n+\n+    static final MethodRef EX_TYPE_ELEM_OF_ARRAY = MethodRef.method(ExternalizedTypeElement.class, \"of\",\n+            ExternalizedTypeElement.class, String.class, ExternalizedTypeElement[].class);\n@@ -190,1 +193,10 @@\n-    final Block.Builder builder;\n+    Block.Builder builder;\n+\n+    final Stack<Block.Builder> lambdaStack = new Stack<>();\n+\n+    \/\/ limit of the operations built by a single method\/lambda body\n+    static final int OP_LIMIT = 1000;\n+    \/\/ limit of types built by a single type builder method\n+    static final int TYPE_LIMIT = 1000;\n+\n+    int opCounter = 0;\n@@ -213,1 +225,1 @@\n-        funcs.add(createExternTypeHelperFunc(registeredExternalizedTypes));\n+        funcs.addAll(createExternTypeHelperFuncs(registeredExternalizedTypes));\n@@ -343,1 +355,1 @@\n-                func(TYPE_BUILDER_F_NAME, CoreType.functionType(type(TypeElement.class))).body(b -> {\n+func(TYPE_BUILDER_F_NAME, CoreType.functionType(type(TypeElement.class))).body(b -> {\n@@ -346,1 +358,1 @@\n-                    var exterType = b.op(funcCall(EXTER_TYPE_BUILDER_F_NAME, functionType(type(ExternalizedTypeElement.class)), i));\n+                    var exterType = b.op(funcCall(EXTER_TYPE_BUILDER_F_NAME, EXTER_TYPE_BUILDER_F_TYPE, i));\n@@ -375,1 +387,1 @@\n-    private static FuncOp createExternTypeHelperFunc(Map<ExternalizedTypeElement, List<Integer>> registeredExterTypes) {\n+    private static List<FuncOp> createExternTypeHelperFuncs(SequencedMap<ExternalizedTypeElement, List<Integer>> registeredExterTypes) {\n@@ -385,17 +397,38 @@\n-        return func(EXTER_TYPE_BUILDER_F_NAME, functionType(type(ExternalizedTypeElement.class))).body(b -> {\n-            Block.Parameter i = b.parameter(INT);\n-            List<Body.Builder> swBodies = new ArrayList<>();\n-            for (Map.Entry<ExternalizedTypeElement, List<Integer>> e : registeredExterTypes.entrySet()) {\n-                Body.Builder l = Body.Builder.of(b.parentBody(), functionType(BOOLEAN));\n-                Block.Parameter target = l.entryBlock().parameter(INT);\n-                Integer typeIndex = e.getValue().getLast();\n-                Result p = l.entryBlock().op(eq(target, l.entryBlock().op(constant(INT, typeIndex))));\n-                l.entryBlock().op(core_yield(p));\n-\n-                Body.Builder expr = Body.Builder.of(b.parentBody(), functionType(type(ExternalizedTypeElement.class)));\n-                List<Value> args = new ArrayList<>();\n-                args.add(expr.entryBlock().op(constant(J_L_STRING, e.getKey().identifier())));\n-                for (int j = 0; j < e.getValue().size() - 1; j++) {\n-                    Value index = expr.entryBlock().op(constant(INT, e.getValue().get(j)));\n-                    Result opr = expr.entryBlock().op(funcCall(EXTER_TYPE_BUILDER_F_NAME, functionType(type(ExternalizedTypeElement.class)), index));\n-                    args.add(opr);\n+        List<FuncOp> funcs = new ArrayList<>();\n+        Iterator<Map.Entry<ExternalizedTypeElement, List<Integer>>> typesEnntryIterator = registeredExterTypes.sequencedEntrySet().iterator();\n+        for (int mc = 0; mc <= registeredExterTypes.size() \/ TYPE_LIMIT; mc++) {\n+            String followUpBuilderName = EXTER_TYPE_BUILDER_F_NAME + (mc + 1);\n+            funcs.add(func(EXTER_TYPE_BUILDER_F_NAME + (mc > 0 ? mc : \"\"), EXTER_TYPE_BUILDER_F_TYPE).body(b -> {\n+                Block.Parameter i = b.parameter(INT);\n+                List<Body.Builder> swBodies = new ArrayList<>();\n+                for (int counter = 0; counter < TYPE_LIMIT && typesEnntryIterator.hasNext(); counter++) {\n+                    Map.Entry<ExternalizedTypeElement, List<Integer>> e = typesEnntryIterator.next();\n+                    Body.Builder l = Body.Builder.of(b.parentBody(), functionType(BOOLEAN));\n+                    Block.Parameter target = l.entryBlock().parameter(INT);\n+                    Integer typeIndex = e.getValue().getLast();\n+                    Result p = l.entryBlock().op(eq(target, l.entryBlock().op(constant(INT, typeIndex))));\n+                    l.entryBlock().op(core_yield(p));\n+\n+                    Body.Builder expr = Body.Builder.of(b.parentBody(), EXTER_TYPE_BUILDER_F_TYPE);\n+                    List<Value> args = new ArrayList<>();\n+                    args.add(expr.entryBlock().op(constant(J_L_STRING, e.getKey().identifier())));\n+                    for (int j = 0; j < e.getValue().size() - 1; j++) {\n+                        Value index = expr.entryBlock().op(constant(INT, e.getValue().get(j)));\n+                        Result opr = expr.entryBlock().op(funcCall(EXTER_TYPE_BUILDER_F_NAME, EXTER_TYPE_BUILDER_F_TYPE, index));\n+                        args.add(opr);\n+                    }\n+                    MethodRef mr;\n+                    Result type;\n+                    if (e.getKey().arguments().size() < 5) {\n+                        List<Class<?>> params = new ArrayList<>();\n+                        params.add(String.class);\n+                        params.addAll(Collections.nCopies(e.getKey().arguments().size(), ExternalizedTypeElement.class));\n+                        mr = MethodRef.method(ExternalizedTypeElement.class, \"of\", ExternalizedTypeElement.class, params);\n+                        type = expr.entryBlock().op(invoke(mr, args));\n+                    } else {\n+                        type = expr.entryBlock().op(invoke(InvokeOp.InvokeKind.STATIC, true, EX_TYPE_ELEM, EX_TYPE_ELEM_OF_ARRAY, args));\n+                    }\n+                    expr.entryBlock().op(core_yield(type));\n+\n+                    swBodies.add(l);\n+                    swBodies.add(expr);\n@@ -403,8 +436,9 @@\n-                MethodRef mr;\n-                Result type;\n-                if (e.getKey().arguments().size() < 5) {\n-                    List<Class<?>> params = new ArrayList<>();\n-                    params.add(String.class);\n-                    params.addAll(Collections.nCopies(e.getKey().arguments().size(), ExternalizedTypeElement.class));\n-                    mr = MethodRef.method(ExternalizedTypeElement.class, \"of\", ExternalizedTypeElement.class, params);\n-                    type = expr.entryBlock().op(invoke(mr, args));\n+\n+                \/\/ default case\n+                Body.Builder dl = Body.Builder.of(b.parentBody(), functionType(BOOLEAN));\n+                dl.entryBlock().parameter(INT);\n+                dl.entryBlock().op(core_yield(dl.entryBlock().op(constant(BOOLEAN, true))));\n+                Body.Builder de = Body.Builder.of(b.parentBody(), EXTER_TYPE_BUILDER_F_TYPE);\n+                if (typesEnntryIterator.hasNext()) {\n+                    \/\/ forward to a follow-up builder method (we are over TYPE_LIMIT)\n+                    de.entryBlock().op(core_yield(de.entryBlock().op(funcCall(followUpBuilderName, EXTER_TYPE_BUILDER_F_TYPE, i))));\n@@ -412,3 +446,2 @@\n-                    mr = MethodRef.method(ExternalizedTypeElement.class, \"of\", ExternalizedTypeElement.class,\n-                            String.class, ExternalizedTypeElement[].class);\n-                    type = expr.entryBlock().op(invoke(InvokeOp.InvokeKind.STATIC, true, type(ExternalizedTypeElement.class), mr, args));\n+                    \/\/ throw\n+                    de.entryBlock().op(throw_(de.entryBlock().op(new_(MethodRef.constructor(IllegalStateException.class)))));\n@@ -416,1 +449,2 @@\n-                expr.entryBlock().op(core_yield(type));\n+                swBodies.add(dl);\n+                swBodies.add(de);\n@@ -418,16 +452,5 @@\n-                swBodies.add(l);\n-                swBodies.add(expr);\n-            }\n-\n-            \/\/ default case\n-            Body.Builder dl = Body.Builder.of(b.parentBody(), functionType(BOOLEAN));\n-            Block.Parameter target = dl.entryBlock().parameter(INT);\n-            dl.entryBlock().op(core_yield(dl.entryBlock().op(constant(BOOLEAN, true))));\n-            Body.Builder de = Body.Builder.of(b.parentBody(), functionType(type(ExternalizedTypeElement.class)));\n-            de.entryBlock().op(throw_(de.entryBlock().op(new_(MethodRef.constructor(IllegalStateException.class)))));\n-            swBodies.add(dl);\n-            swBodies.add(de);\n-\n-            var r = b.op(switchExpression(i, swBodies));\n-            b.op(return_(r));\n-        });\n+                var r = b.op(switchExpression(i, swBodies));\n+                b.op(return_(r));\n+            }));\n+        }\n+        return funcs;\n@@ -455,0 +478,8 @@\n+        \/\/ return from lambdas on stack\n+        while (!lambdaStack.isEmpty()) {\n+            var lambdaBuilder = builder;\n+            builder = lambdaStack.pop();\n+            var l = builder.op(lambda(JavaType.parameterized(JavaType.type(Supplier.class), JavaType.type(Op.class)), lambdaBuilder.parentBody()));\n+            builder.op(return_(builder.op(cast(JavaType.type(Op.class), builder.op(invoke(MethodRef.method(Supplier.class, \"get\", Object.class), l))))));\n+        }\n+\n@@ -460,0 +491,6 @@\n+        if (++opCounter == OP_LIMIT) {\n+            \/\/ continue building in a lambda\n+            opCounter = 0;\n+            lambdaStack.push(builder);\n+            builder = Body.Builder.of(builder.parentBody(), functionType(JavaType.type(Supplier.class))).entryBlock();\n+        }\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/internal\/OpBuilder.java","additions":89,"deletions":52,"binary":false,"changes":141,"status":"modified"}]}