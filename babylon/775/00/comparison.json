{"files":[{"patch":"@@ -45,10 +45,7 @@\n-\n-\n-    interface Dim{\n-        int dimension();\n-    }\n-\n-    interface _1D extends Dim {\n-        @Override\n-        default int dimension() {\n-            return 1;\n+    sealed interface Dim permits _1D,_2D,_3D{\n+        default int dimension(){\n+            return switch ((Dim)this){\n+                case _1D _ -> 1;\n+                case _2D _ -> 2;\n+                case _3D _ -> 3;\n+            };\n@@ -56,0 +53,1 @@\n+    }\n@@ -57,0 +55,1 @@\n+    sealed interface _1D extends Dim  {\n@@ -58,5 +57,2 @@\n-    interface _2D extends Dim {\n-        @Override\n-        default int dimension() {\n-            return 2;\n-        }\n+\n+    sealed interface _2D extends Dim {\n@@ -64,5 +60,2 @@\n-    interface _3D extends Dim{\n-        @Override\n-        default int dimension() {\n-            return 3;\n-        }\n+\n+    sealed interface _3D extends Dim {\n@@ -71,1 +64,1 @@\n-    interface _1DX extends _1D {\n+    sealed  interface _1DX extends _1D {\n@@ -75,1 +68,1 @@\n-    interface _2DXY extends _2D {\n+    sealed interface _2DXY extends _2D {\n@@ -80,1 +73,1 @@\n-    interface _3DXYZ extends _3D {\n+    sealed interface _3DXYZ extends _3D {\n@@ -86,1 +79,15 @@\n-    interface Global {\n+    sealed interface Range permits Local, Global, Block {\n+    }\n+    sealed interface Local extends Range {\n+        Pattern szPattern = Pattern.compile(\"ls([xyz])\");\n+        Pattern idxPattern = Pattern.compile(\"li([xyz])\");\n+    }\n+\n+    sealed interface Block extends Range{\n+        \/\/ We need this to seal the interface hierarchy\n+        record Impl() implements Block {\n+        }\n+        Pattern idxPattern = Pattern.compile(\"bi([xyz])\");\n+    }\n+\n+    sealed interface Global extends Range {\n@@ -91,1 +98,3 @@\n-    interface Global1D extends  _1DX, Global {\n+    sealed interface Global1D extends _1DX, Global {\n+        record Impl(int x) implements Global1D {\n+        }\n@@ -93,1 +102,1 @@\n-            record Impl(int x) implements Global1D{ }\n+\n@@ -98,3 +107,4 @@\n-    interface Global2D extends  _2DXY, Global {\n-        static Global2D of(int x,int y) {\n-            record Impl(int x, int y) implements Global2D {};\n+    sealed interface Global2D extends _2DXY, Global {\n+        record Impl(int x, int y) implements Global2D {\n+        }\n+        static Global2D of(int x, int y) {\n@@ -105,1 +115,3 @@\n-    interface Global3D extends  _3DXYZ, Global {\n+    sealed interface Global3D extends _3DXYZ, Global {\n+        record Impl(int x, int y, int z) implements Global3D {\n+        }\n@@ -107,2 +119,1 @@\n-            record Impl(int x, int y, int z) implements Global3D{};\n-            return new Impl(x,y,z);\n+            return new Impl(x, y, z);\n@@ -112,4 +123,0 @@\n-    interface Local{\n-        Pattern szPattern= Pattern.compile(\"ls([xyz])\");\n-        Pattern idxPattern= Pattern.compile(\"li([xyz])\");\n-    }\n@@ -118,1 +125,4 @@\n-    interface Local1D extends  _1DX, Local {\n+\n+  sealed  interface Local1D extends _1DX, Local {\n+      record Impl(int x) implements Local1D {\n+      }\n@@ -120,1 +130,1 @@\n-            record Impl(int x) implements Local1D{};\n+\n@@ -123,0 +133,1 @@\n+\n@@ -125,3 +136,6 @@\n-    interface Local2D extends  _2DXY, Local {\n-        static Local2D of(int x,int y) {\n-            record Impl(int x, int y) implements Local2D{};\n+\n+    sealed interface Local2D extends _2DXY, Local {\n+        record Impl(int x, int y) implements Local2D {\n+        }\n+        static Local2D of(int x, int y) {\n+\n@@ -130,0 +144,1 @@\n+\n@@ -134,1 +149,3 @@\n-    interface Local3D extends  _3DXYZ, Local {\n+    sealed interface Local3D extends _3DXYZ, Local {\n+        record Impl(int x, int y, int z) implements Local3D {\n+        }\n@@ -136,2 +153,2 @@\n-            record Impl(int x, int y, int z) implements Local3D{};\n-            return new Impl(x,y,z);\n+\n+            return new Impl(x, y, z);\n@@ -139,0 +156,1 @@\n+\n@@ -142,1 +160,1 @@\n-    interface NDRange1D extends NDRange<Global1D,Local1D>, _1D {\n+    sealed interface NDRange1D extends NDRange<Global1D, Local1D>, _1D {\n@@ -145,1 +163,1 @@\n-            return local()!=Local1D.EMPTY;\n+            return local() != Local1D.EMPTY;\n@@ -150,7 +168,0 @@\n-            static NDRange1D of(Global1D global, Local1D local) {\n-                return new Impl(1,global, local);\n-            }\n-             static NDRange1D of(Global1D global) {\n-                return new Impl(1,global, Local1D.EMPTY);\n-            }\n-        }\n@@ -158,0 +169,3 @@\n+        static NDRange1D of(Global1D global, Local1D local) {\n+            return new Impl(1, global, local);\n+        }\n@@ -159,0 +173,4 @@\n+        static NDRange1D of(Global1D global) {\n+            return new Impl(1, global, Local1D.EMPTY);\n+        }\n+    }\n@@ -161,1 +179,1 @@\n-    static NDRange1D of1D(int gsx,  int lsx) {\n+    static NDRange1D of1D(int gsx, int lsx) {\n@@ -169,1 +187,1 @@\n-    interface NDRange2D extends NDRange<Global2D,Local2D>, _2D {\n+    sealed interface NDRange2D extends NDRange<Global2D, Local2D>, _2D {\n@@ -172,1 +190,1 @@\n-            return local()!=Local2D.EMPTY;\n+            return local() != Local2D.EMPTY;\n@@ -174,0 +192,1 @@\n+\n@@ -176,0 +195,1 @@\n+\n@@ -179,0 +199,1 @@\n+\n@@ -186,4 +207,1 @@\n-        return NDRange2D.of(Global2D.of(gsx,gsy), Local2D.of(lsx,lsy));\n-    }\n-    static NDRange2D of2D(int gsx,int gsy) {\n-        return NDRange2D.of(Global2D.of(gsx,gsy), Local2D.EMPTY);\n+        return NDRange2D.of(Global2D.of(gsx, gsy), Local2D.of(lsx, lsy));\n@@ -192,0 +210,3 @@\n+    static NDRange2D of2D(int gsx, int gsy) {\n+        return NDRange2D.of(Global2D.of(gsx, gsy), Local2D.EMPTY);\n+    }\n@@ -193,1 +214,1 @@\n-    interface NDRange3D extends NDRange<Global3D,Local3D>, _3D {\n+   sealed interface NDRange3D extends NDRange<Global3D, Local3D>, _3D {\n@@ -196,1 +217,1 @@\n-            return local()!=Local3D.EMPTY;\n+            return local() != Local3D.EMPTY;\n@@ -198,0 +219,1 @@\n+\n@@ -200,0 +222,1 @@\n+\n@@ -203,0 +226,1 @@\n+\n@@ -209,1 +233,1 @@\n-        return NDRange3D.of(Global3D.of(gsx,gsy,gsz), Local3D.of(lsx,lsy,lsz));\n+        return NDRange3D.of(Global3D.of(gsx, gsy, gsz), Local3D.of(lsx, lsy, lsz));\n@@ -211,2 +235,3 @@\n-    static NDRange3D of3D(int gsx,int gsy, int gsz) {\n-        return NDRange3D.of(Global3D.of(gsx,gsy,gsz), Local3D.EMPTY);\n+\n+    static NDRange3D of3D(int gsx, int gsy, int gsz) {\n+        return NDRange3D.of(Global3D.of(gsx, gsy, gsz), Local3D.EMPTY);\n@@ -214,0 +239,1 @@\n+\n","filename":"hat\/core\/src\/main\/java\/hat\/NDRange.java","additions":91,"deletions":65,"binary":false,"changes":156,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import hat.NDRange;\n@@ -35,1 +36,0 @@\n-import java.util.Map;\n@@ -39,3 +39,0 @@\n-    private final TypeElement resultType;\n-    private static final String NAME = \"BlockThreadId\";\n-\n@@ -43,2 +40,1 @@\n-        super(dimension, List.of());\n-        this.resultType = resultType;\n+        super(\"BlockThreadId\", resultType,dimension, List.of());\n@@ -49,1 +45,0 @@\n-        this.resultType = op.resultType;\n@@ -57,12 +52,1 @@\n-    @Override\n-    public TypeElement resultType() {\n-        return resultType;\n-    }\n-\n-    @Override\n-    public Map<String, Object> externalize() {\n-        return Map.of(\"hat.dialect.\" + NAME, this.getDimension());\n-    }\n-\n-    public final static  Pattern pattern = Pattern.compile(\"bi[xyz]\");\n-\n+    public final static  Pattern pattern = NDRange.Block.idxPattern;\n@@ -70,2 +54,2 @@\n-    public static HATBlockThreadIdOp of(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n-        return new HATBlockThreadIdOp(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n+    public static HATBlockThreadIdOp of(int dimension, TypeElement resultType){\n+        return new HATBlockThreadIdOp(dimension,resultType);\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATBlockThreadIdOp.java","additions":5,"deletions":21,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -40,4 +40,0 @@\n-\n-    private final TypeElement resultType;\n-    private static final String NAME = \"GlobalThreadSize\";\n-\n@@ -45,2 +41,1 @@\n-        super(dimension, List.of());\n-        this.resultType = resultType;\n+        super(\"GlobalThreadSize\",resultType,dimension, List.of());\n@@ -51,1 +46,0 @@\n-        this.resultType = op.resultType;\n@@ -59,10 +53,0 @@\n-    @Override\n-    public TypeElement resultType() {\n-        return resultType;\n-    }\n-\n-    @Override\n-    public Map<String, Object> externalize() {\n-        return Map.of(\"hat.dialect.\" + NAME, this.getDimension());\n-    }\n-\n@@ -71,2 +55,2 @@\n-    static public HATGlobalSizeOp of(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n-        return new HATGlobalSizeOp(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n+    static public HATGlobalSizeOp of(int dimension, TypeElement resultType){\n+        return new HATGlobalSizeOp(dimension,resultType);\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATGlobalSizeOp.java","additions":3,"deletions":19,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -40,2 +40,0 @@\n-    private final TypeElement resultType;\n-    private static final String NAME = \"GlobalThreadId\";\n@@ -44,2 +42,1 @@\n-        super(dimension, List.of());\n-        this.resultType = resultType;\n+        super(\"GlobalThreadId\",resultType,dimension, List.of());\n@@ -50,1 +47,0 @@\n-        this.resultType = op.resultType;\n@@ -58,10 +54,0 @@\n-    @Override\n-    public TypeElement resultType() {\n-        return resultType;\n-    }\n-\n-    @Override\n-    public Map<String, Object> externalize() {\n-        return Map.of(\"hat.dialect.\" + NAME, this.getDimension());\n-    }\n-\n@@ -70,3 +56,2 @@\n-\n-    public static  HATGlobalThreadIdOp of(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n-        return new HATGlobalThreadIdOp(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n+    public static  HATGlobalThreadIdOp of(int dimension, TypeElement resultType){\n+        return new HATGlobalThreadIdOp(dimension, resultType);\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATGlobalThreadIdOp.java","additions":3,"deletions":18,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -41,3 +41,0 @@\n-    private final TypeElement resultType;\n-    private static final String NAME = \"GlobalThreadSize\";\n-\n@@ -45,2 +42,1 @@\n-        super(dimension, List.of());\n-        this.resultType = resultType;\n+        super(\"GlobalThreadSize\",resultType,dimension, List.of());\n@@ -51,1 +47,0 @@\n-        this.resultType = op.resultType;\n@@ -59,11 +54,0 @@\n-    @Override\n-    public TypeElement resultType() {\n-        return resultType;\n-    }\n-\n-    @Override\n-    public Map<String, Object> externalize() {\n-        return Map.of(\"hat.dialect.\" + NAME, this.getDimension());\n-    }\n-\n-\n@@ -72,2 +56,2 @@\n-    public static HATThreadOp of(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n-        return new HATLocalSizeOp(OpTk.dimIdx(fieldLoadOp.fieldDescriptor().name()), fieldLoadOp.resultType());\n+    public static HATThreadOp of(int dimension, TypeElement resultType){\n+        return new HATLocalSizeOp(dimension, resultType);\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATLocalSizeOp.java","additions":3,"deletions":19,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -41,3 +41,0 @@\n-    private final TypeElement resultType;\n-    private static final String NAME = \"LocalThreadId\";\n-\n@@ -45,2 +42,1 @@\n-        super(dimension, List.of());\n-        this.resultType = resultType;\n+        super(\"LocalThreadId\",resultType,dimension, List.of());\n@@ -51,1 +47,0 @@\n-        this.resultType = op.resultType;\n@@ -59,10 +54,0 @@\n-    @Override\n-    public TypeElement resultType() {\n-        return resultType;\n-    }\n-\n-    @Override\n-    public Map<String, Object> externalize() {\n-        return Map.of(\"hat.dialect.\" + NAME, this.getDimension());\n-    }\n-\n@@ -71,2 +56,2 @@\n-   public static  HATLocalThreadIdOp of(JavaOp.FieldAccessOp.FieldLoadOp fieldLoadOp){\n-        return new HATLocalThreadIdOp(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n+    public static  HATLocalThreadIdOp of(int dimension, TypeElement resultType){\n+        return new HATLocalThreadIdOp(dimension,resultType);\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATLocalThreadIdOp.java","additions":3,"deletions":18,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import jdk.incubator.code.TypeElement;\n@@ -31,0 +32,1 @@\n+import java.util.Map;\n@@ -33,0 +35,3 @@\n+   final  private String name;\n+   final  private TypeElement resultType;\n+   final  private int dimension;\n@@ -34,3 +39,1 @@\n-    private final int dimension;\n-\n-    public HATThreadOp(int dimension, List<Value> operands) {\n+    public HATThreadOp(String name, TypeElement resultType,int dimension, List<Value> operands) {\n@@ -38,0 +41,2 @@\n+        this.name = name;\n+        this.resultType = resultType;\n@@ -43,0 +48,2 @@\n+        this.name =that.name;\n+        this.resultType = that.resultType;\n@@ -49,0 +56,12 @@\n+\n+\n+    @Override\n+    final public TypeElement resultType() {\n+        return resultType;\n+    }\n+\n+    @Override\n+    final public Map<String, Object> externalize() {\n+        return Map.of(\"hat.dialect.\" + name, this.getDimension());\n+    }\n+\n","filename":"hat\/core\/src\/main\/java\/hat\/dialect\/HATThreadOp.java","additions":22,"deletions":3,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -852,6 +852,6 @@\n-    static int dimIdx(String dim){\n-        return switch (dim.substring(2)){\n-            case \"y\"->1;\n-            case \"z\"->2;\n-            default -> 0;\n-        };\n+    static int dimIdx(String name){\n+            int dim = name.length()==3?name.charAt(2)-'x':-1;\n+            if (dim <0||dim>3){\n+                throw new IllegalStateException();\/\/'x'=1,'y'=2....\n+            }\n+            return dim;\n","filename":"hat\/core\/src\/main\/java\/hat\/optools\/OpTk.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -77,2 +77,0 @@\n-\n-\n@@ -89,1 +87,1 @@\n-                return HATBlockThreadIdOp.of(fieldLoadOp);\n+                return HATBlockThreadIdOp.of(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n@@ -102,1 +100,1 @@\n-                return new HATGlobalThreadIdOp(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n+                return HATGlobalThreadIdOp.of(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n@@ -115,1 +113,1 @@\n-                return  HATGlobalSizeOp.of(fieldLoadOp);\n+                return  HATGlobalSizeOp.of(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n@@ -128,1 +126,1 @@\n-                return HATLocalThreadIdOp.of(fieldLoadOp);\n+                return HATLocalThreadIdOp.of(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n@@ -141,1 +139,1 @@\n-            return HATLocalSizeOp.of(fieldLoadOp);\n+            return HATLocalSizeOp.of(OpTk.dimIdx(fieldLoadOp), fieldLoadOp.resultType());\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATDialectifyThreadsPhase.java","additions":5,"deletions":7,"binary":false,"changes":12,"status":"modified"}]}