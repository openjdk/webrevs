{"files":[{"patch":"@@ -2797,0 +2797,11 @@\n+            int defLabelIndex = -1;\n+            for (int i = 0; i < bodies().size(); i+=2) {\n+                Block eb = bodies().get(i).entryBlock();\n+                \/\/ @@@ confusing YieldOp with Core.YieldOp in checks\n+                if (eb.terminatingOp() instanceof CoreOp.YieldOp yop && yop.yieldValue() instanceof Op.Result r\n+                        && r.op() instanceof ConstantOp cop && cop.resultType().equals(BOOLEAN)) {\n+                    defLabelIndex = i;\n+                    break;\n+                }\n+            }\n+\n@@ -2799,3 +2810,6 @@\n-                Block.Builder bb = b.block();\n-                if (i == 0) {\n-                    bb = b;\n+                Block.Builder bb;\n+                if (i == defLabelIndex) {\n+                    \/\/ we don't need a block for default label\n+                    bb = null;\n+                } else {\n+                    bb = b.block();\n@@ -2805,0 +2819,8 @@\n+            \/\/ append ops of the first non default label to b\n+            for (int i = 0; i < blocks.size(); i+=2) {\n+                if (blocks.get(i) == null) {\n+                    continue;\n+                }\n+                blocks.set(i, b);\n+                break;\n+            }\n@@ -2810,2 +2832,2 @@\n-                exit = b.block(resultType());\n-                if (this instanceof SwitchExpressionOp) {\n+                exit = resultType() == VOID ? b.block() : b.block(resultType());\n+                if (!exit.parameters().isEmpty()) {\n@@ -2823,35 +2845,3 @@\n-            for (int i = 0; i < bodies().size(); i++) {\n-                boolean isLabelBody = i % 2 == 0;\n-                Block.Builder curr = blocks.get(i);\n-                if (isLabelBody) {\n-                    Block.Builder statement = blocks.get(i + 1);\n-                    boolean isLastLabel = i == blocks.size() - 2;\n-                    Block.Builder nextLabel = isLastLabel ? null : blocks.get(i + 2);\n-                    curr.body(bodies().get(i), List.of(selectorExpression), andThenLowering(opT,\n-                            (block, op) -> switch (op) {\n-                                case CoreOp.YieldOp _ when isLastLabel && this instanceof SwitchExpressionOp -> {\n-                                    block.op(branch(statement.successor()));\n-                                    yield block;\n-                                }\n-                                case CoreOp.YieldOp yop -> {\n-                                    block.op(conditionalBranch(\n-                                        block.context().getValue(yop.yieldValue()),\n-                                        statement.successor(),\n-                                        isLastLabel ? exit.successor() : nextLabel.successor()));\n-                                    yield block;\n-                                }\n-                                default -> null;\n-                            }));\n-                } else { \/\/ statement body\n-                    curr.body(bodies().get(i), blocks.get(i).parameters(), andThenLowering(opT,\n-                            (block, op) -> switch (op) {\n-                                case CoreOp.YieldOp _ when this instanceof SwitchStatementOp -> {\n-                                    block.op(branch(exit.successor()));\n-                                    yield block;\n-                                }\n-                                case CoreOp.YieldOp yop when this instanceof SwitchExpressionOp -> {\n-                                    block.op(branch(exit.successor(block.context().getValue(yop.yieldValue()))));\n-                                    yield block;\n-                                }\n-                                default -> null;\n-                            }));\n+            for (int i = 0; i < bodies().size(); i+=2) {\n+                if (i == defLabelIndex) {\n+                    continue;\n@@ -2859,0 +2849,43 @@\n+                Block.Builder statement = blocks.get(i + 1);\n+                boolean isLastLabel = i == blocks.size() - 2;\n+                Block.Builder nextLabel = isLastLabel ? null : blocks.get(i + 2);\n+                int finalDefLabelIndex = defLabelIndex;\n+                blocks.get(i).body(bodies().get(i), List.of(selectorExpression), andThenLowering(opT,\n+                        (block, op) -> switch (op) {\n+                            case CoreOp.YieldOp yop -> {\n+                                Block.Reference falseTarget;\n+                                if (nextLabel != null) {\n+                                    falseTarget = nextLabel.successor();\n+                                } else if (finalDefLabelIndex != -1) {\n+                                    falseTarget = blocks.get(finalDefLabelIndex + 1).successor();\n+                                } else {\n+                                    falseTarget = exit.successor();\n+                                }\n+                                block.op(conditionalBranch(block.context().getValue(yop.yieldValue()),\n+                                        statement.successor(), falseTarget));\n+                                yield block;\n+                            }\n+                            default -> null;\n+                        }));\n+\n+                blocks.get(i + 1).body(bodies().get(i + 1), List.of(), andThenLowering(opT,\n+                        (block, op) -> switch (op) {\n+                            case CoreOp.YieldOp yop -> {\n+                                List<Value> args = yop.yieldValue() == null ? List.of() : List.of(block.context().getValue(yop.yieldValue()));\n+                                block.op(branch(exit.successor(args)));\n+                                yield block;\n+                            }\n+                            default -> null;\n+                        }));\n+            }\n+\n+            if (defLabelIndex != -1) {\n+                blocks.get(defLabelIndex + 1).body(bodies().get(defLabelIndex + 1), List.of(), andThenLowering(opT,\n+                        (block, op) -> switch (op) {\n+                            case CoreOp.YieldOp yop -> {\n+                                List<Value> args = yop.yieldValue() == null ? List.of() : List.of(block.context().getValue(yop.yieldValue()));\n+                                block.op(branch(exit.successor(args)));\n+                                yield block;\n+                            }\n+                            default -> null;\n+                        }));\n","filename":"src\/jdk.incubator.code\/share\/classes\/jdk\/incubator\/code\/dialect\/java\/JavaOp.java","additions":73,"deletions":40,"binary":false,"changes":113,"status":"modified"}]}