{"files":[{"patch":"@@ -86,0 +86,12 @@\n+    static Float4 add(Float4 vA, float scalar) {\n+        return Float4.of(vA.x()+scalar,vA.y()+scalar, vA.z()+scalar,vA.w()+scalar);\n+    }\n+    static Float4 sub(Float4 vA, float scalar) {\n+        return Float4.of(vA.x()-scalar,vA.y()-scalar, vA.z()-scalar,vA.w()-scalar);\n+    }\n+    static Float4 mul(Float4 vA, float scalar) {\n+        return Float4.of(vA.x()*scalar,vA.y()*scalar, vA.z()*scalar,vA.w()*scalar);\n+    }\n+    static Float4 sqr(Float4 vA) {\n+        return Float4.mul(vA,vA);\n+    }\n@@ -102,1 +114,6 @@\n-\n+    default Float4 add(float scalar) {\n+        return Float4.add(this, scalar);\n+    }\n+    default Float4 sqr() {\n+        return Float4.sqr(this);\n+    }\n@@ -106,1 +123,3 @@\n-\n+    default Float4 sub(float scalar) {\n+        return Float4.sub(this, scalar);\n+    }\n@@ -110,1 +129,3 @@\n-\n+    default Float4 mul(float scalar) {\n+        return Float4.mul(this, scalar);\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/buffer\/Float4.java","additions":24,"deletions":3,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import hat.buffer.Float4;\n@@ -33,1 +34,6 @@\n-\n+    default Float4[] posArrView(){\n+        return null;\n+    }\n+    default Float4[] velArrView(){\n+        return null;\n+    }\n","filename":"hat\/examples\/nbody\/src\/main\/java\/nbody\/Universe.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import hat.buffer.Float4;\n@@ -37,0 +38,1 @@\n+import wrap.Wrap;\n@@ -98,0 +100,24 @@\n+    interface F32x4Arr {\n+\n+    }\n+    @Reflect\n+    static public void nbodyKernelf4(@RO KernelContext kc, @RW Universe universe, float mass, float delT, float espSqr) {\n+        var acc = Float4.of(0,0,0,0);\n+        var posArr = universe.posArrView();\n+        var velArr = universe.velArrView();\n+        var pos = posArr[kc.gix];\n+        var vel = velArr[kc.gix];\n+        for (int i = 0; i < kc.gix; i++) {\n+            var delta = posArr[i].sub(pos);\n+            var delSqr = delta.sqr();\n+            var delSqrSum = delSqr.x() + delSqr.y() + delSqr.z();\n+            var invDist = 1f \/ (float) Math.sqrt(delSqrSum + espSqr);\n+            var invDistCubed = invDist * invDist * invDist;\n+            acc = acc.add(delta.mul(mass * invDistCubed));\n+        }\n+        acc = acc.mul(delT);\n+        pos = pos.add(vel.mul(delT).add(acc.mul(.5f * delT)));\n+        vel = vel.add(acc);\n+        posArr[kc.gix] = pos;\n+        velArr[kc.gix] = vel;\n+    }\n","filename":"hat\/examples\/nbody\/src\/main\/java\/nbody\/opencl\/OpenCLNBodyGLWindow.java","additions":26,"deletions":0,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -87,1 +87,9 @@\n-        var hat = new Project(Path.of(System.getProperty(\"user.dir\")), Reporter.progressAndErrors);\n+        \/\/ We need these to build\n+        var javacOpts = Jar.JavacOpts.of(vm->vm.add(\"--source=26\",\"--enable-preview\",\"--add-modules=jdk.incubator.code\", \"-g\"));\n+        \/\/ These to run\n+        var javaOpts = Jar.JavaOpts.of(v->v.add(\"--enable-preview\", \"--enable-native-access=ALL-UNNAMED\", \"--add-modules=jdk.incubator.code\"));\n+\n+        var hat = new Project(\n+                Path.of(System.getProperty(\"user.dir\")),\n+                javacOpts, \/\/ These opts are applied to all javac compilations in the project\n+                Reporter.progressAndErrors);\n@@ -212,1 +220,1 @@\n-                        var vmOpts = new ArrayList<String>(List.of());\n+                        \/\/ We transfer all command line opts starting with - across as opts to java\n@@ -214,1 +222,1 @@\n-                            vmOpts.add(args.removeFirst());\n+                            javaOpts.opts().add(args.removeFirst());\n@@ -216,0 +224,1 @@\n+                        \/\/ Next should be the runnable name\n@@ -219,4 +228,6 @@\n-                                if (runnableName.equals(\"nbody\") && mac.isAvailable()) {  \/\/ nbody (anything on mac using OpenGL\n-                                    vmOpts.add(\"-XstartOnFirstThread\");\n-                                }\n-                                runnable.run(runnableName + \".Main\", new job.Dag(runnable, backend).ordered(), vmOpts,args);\n+                                \/\/ we conditionally add this if we need OpenGL on MAC\n+                                javaOpts.opts().add(runnableName.equals(\"nbody\") && mac.isAvailable()?\"-XstartOnFirstThread\":\"\");\n+                                \/\/ move the rest of command line args to the args of the vm\n+                                javaOpts.args().addAll(args);args.clear();\n+\n+                                runnable.run(runnableName + \".Main\", new job.Dag(runnable, backend).ordered(), javaOpts);\n@@ -232,1 +243,0 @@\n-                    args.clear(); \/\/!! :)\n@@ -237,1 +247,0 @@\n-\n@@ -239,4 +248,4 @@\n-                           var vmOpts = new ArrayList<String>(List.of());\n-                           while (!args.isEmpty() && args.getFirst() instanceof String  possibleVmOpt &&  possibleVmOpt.startsWith(\"-\")){\n-                               vmOpts.add(args.removeFirst());\n-                           }\n+                            \/\/ We transfer all command line opts starting with - across as opts to java\n+                            while (!args.isEmpty() && args.getFirst() instanceof String  possibleVmOpt &&  possibleVmOpt.startsWith(\"-\")){\n+                                javaOpts.opts().add(args.removeFirst());\n+                            }\n@@ -251,1 +260,4 @@\n-                                  tests.run(testEngine, orderedDag, vmOpts,List.of(matched.group(1).replace('\/','.')));\n+                                  javaOpts.args().clear();\n+                                  javaOpts.args().addAll(args);\/\/ so we have all the trailing args to pass to all tests\n+                                  javaOpts.args().add(matched.group(1).replace('\/','.'));\n+                                  tests.run(testEngine, orderedDag, javaOpts);\n@@ -254,0 +266,1 @@\n+                            args.clear();\n@@ -277,1 +290,0 @@\n-                    args.clear(); \/\/!! :)\n@@ -282,1 +294,1 @@\n-                        var classAndMethod = args.removeFirst();\n+\n@@ -284,1 +296,1 @@\n-                            var vmOpts = new ArrayList<String>(List.of());\n+                                 \/\/ We transfer all command line opts starting with - across as opts to java\n@@ -286,1 +298,1 @@\n-                                vmOpts.add(args.removeFirst());\n+                                javaOpts.opts().add(args.removeFirst());\n@@ -288,1 +300,5 @@\n-\n+                            \/\/ This should be the class name\n+                            var classAndMethod = args.removeFirst();\n+                            javaOpts.args().add(classAndMethod);\n+                            \/\/ move the rest of command line args to the args of the vm\n+                            javaOpts.args().addAll(args);args.clear();\n@@ -290,1 +306,1 @@\n-                            tests.run(testEngine, orderedDag, vmOpts, List.of(classAndMethod));\n+                            tests.run(testEngine, orderedDag, javaOpts);\n","filename":"hat\/hat.java","additions":36,"deletions":20,"binary":false,"changes":56,"status":"modified"},{"filename":"hat\/hat\/job.jar","binary":true,"status":"modified"},{"patch":"@@ -69,1 +69,4 @@\n-            this.opts.addAll(List.of(opts));\n+            return add(List.of(opts));\n+        }\n+        Opts add(List<String>opts){\n+            this.opts.addAll(opts);\n","filename":"hat\/hat\/job\/src\/main\/java\/job\/ForkExec.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -33,2 +33,2 @@\n-    private JExtract(Project.Id id, Set<Path> exclude, Set<Dependency> dependencies) {\n-        super(id, exclude, dependencies);\n+    private JExtract(Project.Id id, JavacOpts javacOpts, Set<Path> exclude, Set<Dependency> dependencies) {\n+        super(id,javacOpts, exclude, dependencies);\n@@ -74,1 +74,3 @@\n-\n+    static public JExtract extract(Project.Id id, JavacOpts javacOpts, Set<Dependency> dependencies) {\n+        return new JExtract(id, javacOpts,Set.of(), dependencies);\n+    }\n@@ -76,1 +78,4 @@\n-        return new JExtract(id, Set.of(), dependencies);\n+        return new JExtract(id, JavacOpts.of(),Set.of(), dependencies);\n+    }\n+    static public JExtract extract(Project.Id id,JavacOpts javacOpts, Dependency... dependencies) {\n+        return new JExtract(id, javacOpts,Set.of(), Set.of(dependencies));\n@@ -78,1 +83,0 @@\n-\n@@ -80,1 +84,1 @@\n-        return new JExtract(id, Set.of(), Set.of(dependencies));\n+        return new JExtract(id, JavacOpts.of(),Set.of(), Set.of(dependencies));\n","filename":"hat\/hat\/job\/src\/main\/java\/job\/JExtract.java","additions":10,"deletions":6,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -44,0 +44,1 @@\n+import java.util.function.Consumer;\n@@ -52,0 +53,90 @@\n+    final JavacOpts javacOpts;\n+    public interface StringListBuilder {\n+        List<String> strings();\n+        StringListBuilder add(String ...s);\n+        StringListBuilder add(List<String> list);\n+        StringListBuilder addIf(boolean c, String ...s);\n+        StringListBuilder addIf(boolean c, List<String> list);\n+        static StringListBuilder of(){\n+            record StringListBuilderImpl (List<String> strings) implements StringListBuilder{\n+                @Override\n+                public StringListBuilder add(String ...s) {\n+                    return add(List.of(s));\n+                }\n+                @Override\n+                public StringListBuilder add(List<String> list) {\n+                    strings.addAll(list);\n+                    return this;\n+                }\n+                @Override\n+                public StringListBuilder addIf(boolean c, List<String> list) {\n+                    if (c){\n+                        strings.addAll(list);\n+                    }\n+                    return this;\n+                }\n+                @Override\n+                public StringListBuilder addIf(boolean c, String ...s) {\n+                   return addIf(c, List.of(s));\n+                }\n+            }\n+            return new StringListBuilderImpl(new ArrayList<>());\n+        }\n+    }\n+    public interface JavacOpts{\n+        List<String> vmOpts();\n+        List<String> opts();\n+\n+        static JavacOpts of(List<String> vmOpts, List<String> opts){\n+            record JavacOptsImpl(List<String> vmOpts, List<String> opts) implements JavacOpts{\n+            }\n+            return new JavacOptsImpl(vmOpts,opts);\n+        }\n+        static JavacOpts of(Consumer<StringListBuilder> v){\n+            StringListBuilder vmOptBuilder = StringListBuilder.of();\n+            StringListBuilder optBuilder = StringListBuilder.of();\n+            v.accept(vmOptBuilder);\n+            return of(vmOptBuilder.strings(),optBuilder.strings());\n+        }\n+\n+        static JavacOpts of(Consumer<StringListBuilder> v, Consumer<StringListBuilder> o){\n+            StringListBuilder vmOptBuilder = StringListBuilder.of();\n+            StringListBuilder optBuilder = StringListBuilder.of();\n+            v.accept(vmOptBuilder);\n+            o.accept(optBuilder);\n+            return of(vmOptBuilder.strings(),optBuilder.strings());\n+        }\n+\n+        static JavacOpts of(){\n+            return of(new ArrayList<>(),new ArrayList<>());\n+        }\n+    }\n+\n+    public interface JavaOpts{\n+        List<String> opts();\n+        List<String> args();\n+\n+        static JavaOpts of(List<String> opts, List<String> args){\n+            record JavaOptsImpl(List<String>opts, List<String> args) implements JavaOpts{\n+            }\n+            return new JavaOptsImpl(opts,args);\n+        }\n+        static JavaOpts of(Consumer<StringListBuilder> v){\n+            StringListBuilder vmOptBuilder = StringListBuilder.of();\n+            StringListBuilder optBuilder = StringListBuilder.of();\n+            v.accept(vmOptBuilder);\n+            return of(vmOptBuilder.strings(),optBuilder.strings());\n+        }\n+\n+        static JavaOpts of(Consumer<StringListBuilder> v, Consumer<StringListBuilder> o){\n+            StringListBuilder vmOptBuilder = StringListBuilder.of();\n+            StringListBuilder optBuilder = StringListBuilder.of();\n+            v.accept(vmOptBuilder);\n+            o.accept(optBuilder);\n+            return of(vmOptBuilder.strings(),optBuilder.strings());\n+        }\n+\n+        static JavaOpts of(){\n+            return of(new ArrayList<>(),new ArrayList<>());\n+        }\n+    }\n@@ -53,1 +144,1 @@\n-    protected Jar(Project.Id id, Set<Path> exclude, Set<Dependency> dependencies) {\n+    protected Jar(Project.Id id, JavacOpts javacOpts,Set<Path> exclude, Set<Dependency> dependencies) {\n@@ -55,0 +146,1 @@\n+        this.javacOpts = javacOpts;\n@@ -65,0 +157,3 @@\n+    public static Jar of(Project.Id id, JavacOpts javacOpts, Set<Path> exclude, Set<Dependency> dependencies) {\n+        return new Jar(id, javacOpts,exclude, dependencies);\n+    }\n@@ -67,1 +162,4 @@\n-        return new Jar(id, exclude, dependencies);\n+        return new Jar(id, JavacOpts.of(), exclude, dependencies);\n+    }\n+    public static Jar of(Project.Id id, JavacOpts javacOpts, Set<Dependency> dependencies) {\n+        return new Jar(id, javacOpts,Set.of(), dependencies);\n@@ -70,0 +168,1 @@\n+\n@@ -71,1 +170,1 @@\n-        return new Jar(id, Set.of(), dependencies);\n+        return new Jar(id,JavacOpts.of(), Set.of(), dependencies);\n@@ -118,8 +217,7 @@\n-        List<String> opts = new ArrayList<>(\n-                List.of(\n-                        \"--source=26\",\n-                        \"--enable-preview\",\n-                        \"--add-modules=jdk.incubator.code\",\n-                        \"-g\",\n-                        \"-d\", classesDirName()\n-                ));\n+        List<String> opts = new ArrayList<>();\n+        opts.addAll(id().project().javacOpts().vmOpts());\n+        opts.addAll(javacOpts.vmOpts());\n+        opts.addAll(List.of(\n+                \"-d\", classesDirName()\n+                )\n+        );\n@@ -128,0 +226,1 @@\n+\n@@ -129,3 +228,1 @@\n-            opts.addAll(List.of(\n-                    \"--class-path=\" + deps\n-            ));\n+            opts.add(\"--class-path=\" + deps);\n@@ -133,4 +230,4 @@\n-        opts.addAll(List.of(\n-                        \"--source-path=\" + javaSourcePathName()\n-                )\n-        );\n+        opts.addAll(id.project().javacOpts().opts());\n+        opts.addAll(javacOpts.opts());\n+        opts.add(\"--source-path=\" + javaSourcePathName());\n+        \/\/System.out.println(\"javac opts \"+ String.join(\" \", opts));\n@@ -278,4 +375,1 @@\n-                .orElseThrow()).add(\n-                \"--enable-preview\",\n-                \"--enable-native-access=ALL-UNNAMED\"\n-        );\n+                .orElseThrow()).add(vmOpts);\n@@ -283,1 +377,0 @@\n-                \"--add-modules=jdk.incubator.code\",\n@@ -288,3 +381,1 @@\n-        opts.add(\n-                mainClassName\n-        );\n+        opts.add(mainClassName);\n@@ -304,0 +395,4 @@\n+    public boolean run(String mainClassName, Set<Dependency> depsInOrder, JavaOpts javaOpts) {\n+        return run(mainClassName,depsInOrder,javaOpts.opts(),javaOpts.args());\n+\n+    }\n","filename":"hat\/hat\/job\/src\/main\/java\/job\/Jar.java","additions":121,"deletions":26,"binary":false,"changes":147,"status":"modified"},{"patch":"@@ -209,1 +209,1 @@\n-\n+    private final Jar.JavacOpts javacOpts;\n@@ -215,1 +215,1 @@\n-\n+    public Jar.JavacOpts javacOpts() {return javacOpts;}\n@@ -230,1 +230,1 @@\n-    public Project(Path root, Reporter reporter) {\n+    public Project(Path root, Jar.JavacOpts javacOpts,Reporter reporter) {\n@@ -232,0 +232,1 @@\n+        this.javacOpts = javacOpts;\n@@ -238,1 +239,3 @@\n-\n+    }\n+    public Project(Path root, Reporter reporter) {\n+        this(root, Jar.JavacOpts.of(),reporter);\n","filename":"hat\/hat\/job\/src\/main\/java\/job\/Project.java","additions":7,"deletions":4,"binary":false,"changes":11,"status":"modified"}]}