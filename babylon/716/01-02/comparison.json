{"files":[{"patch":"@@ -88,23 +88,3 @@\n-                .identifier(\"\"\"\n-                        void byteCopy(void *dest, const void* src, size_t size) {\n-                            unsigned char *c = (unsigned char*)dest;\n-                            unsigned char *s = (unsigned char*)src;\n-                            for (int i = 0; i < size; i++) {\n-                                *c++ = *s++;\n-                            }\n-                        }\n-\n-                        float bfloat162float(ushort bf16) {\n-                            uint bitsRecovered = bf16 << 16;\n-                            float r = bitsRecovered;\n-                            byteCopy(&r, &bitsRecovered, sizeof(r));\n-                            return r;\n-                        }\n-\n-                        ushort float2bfloat16(float f) {\n-                            uint bits;\n-                            byteCopy(&bits, &f, sizeof(bits));\n-                            short bf16 = bits >> 16;\n-                            return bf16;\n-                        }\n-                        \"\"\");\n+                .buildByteKernelFunction()\n+                .build_builtin_bfloat162float(\"bf16\")\n+                .build_builtin_float2bfloat16(\"f\");\n","filename":"hat\/backends\/ffi\/opencl\/src\/main\/java\/hat\/backend\/ffi\/OpenCLHATKernelBuilder.java","additions":3,"deletions":23,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -575,0 +575,8 @@\n+\n+    public T sizeof() {\n+        return emitText(\"sizeof\");\n+    }\n+\n+    public T sizeof(Consumer<T> consumer) {\n+        return emitText(\"sizeof\").paren(consumer);\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/CodeBuilder.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -40,0 +40,4 @@\n+    public static final String HAT_BUILT_IN_FLOAT_TO_BFLOAT16 = \"floatTobfloat16\";\n+    public static final String HAT_BUILT_IN_BFLOAT16_TO_FLOAT = \"bfloat16Tofloat\";\n+    public static final String HAT_BUILT_IN_COPY_BYTES = \"byteCopy\";\n+\n@@ -204,1 +208,1 @@\n-        identifier(\"float2bfloat16\");\n+        identifier(HAT_BUILT_IN_FLOAT_TO_BFLOAT16);\n@@ -209,1 +213,1 @@\n-        identifier(\"bfloat162float\");\n+        identifier(HAT_BUILT_IN_BFLOAT16_TO_FLOAT);\n@@ -399,0 +403,81 @@\n+\n+    public T buildForLoopHeader(String loopVar, String init, String loopBound) {\n+        forKeyword().paren(_ -> intType().space().identifier(loopVar).space().equals().identifier(init).semicolon().space()\n+                        .identifier(loopVar).lt().identifier(loopBound).semicolon().space()\n+                        .identifier(loopVar).plusplus());\n+        return self();\n+    }\n+\n+    \/**\n+     * <code>\n+     *  void byteCopy(void *dest, const void* src, size_t size) {\n+     *      unsigned char *c = (unsigned char*)dest;\n+     *      unsigned char *s = (unsigned char*)src;\n+     *      for (int i = 0; i < size; i++) {\n+     *          *c++ = *s++;\n+     *      }\n+     *  }\n+     * <\/code>\n+     * @return\n+     *\/\n+    public T buildByteKernelFunction() {\n+        voidType().space().identifier(HAT_BUILT_IN_COPY_BYTES)\n+                .paren(_-> voidType().space().asterisk().identifier(\"dest\").comma()\n+                            .voidType().space().asterisk().identifier(\"src\").comma()\n+                            .typeName(\"size_t\").space().asterisk().identifier(\"size\"));\n+        braceNlIndented(_ ->\n+                semicolonNlTerminated( _ -> unsignedCharType().space().asterisk().identifier(\"c\").space()\n+                        .equals().space().paren( _ -> unsignedCharType().asterisk()).identifier(\"dest\"))\n+                .semicolonNlTerminated( _ ->unsignedCharType().space().asterisk().identifier(\"s\").space()\n+                        .equals().space().paren( _ -> unsignedCharType().asterisk()).identifier(\"src\"))\n+                    .buildForLoopHeader(\"i\", \"0\", \"size\")\n+                            .braceNlIndented(_ -> semicolonNlTerminated( _ -> asterisk().identifier(\"c\").plusplus().space().equals().space().asterisk().identifier(\"s\").plusplus())));\n+        return self();\n+    }\n+\n+    \/**\n+     * <code>\n+     *  float bfloat16Tofloat(ushort bf16) {\n+     *      uint bitsRecovered = bf16 << 16;\n+     *      float r = bitsRecovered;\n+     *      byteCopy(&r, &bitsRecovered, sizeof(r));\n+     *      return r;\n+     * }\n+     * <\/code>\n+     *\n+     * @param parameterName\n+     * @return\n+     *\/\n+    public T build_builtin_bfloat162float(String parameterName) {\n+        floatType().space().identifier(HAT_BUILT_IN_BFLOAT16_TO_FLOAT).paren(_ -> unsignedShortType().space().identifier(parameterName))\n+                .brace( _ ->\n+                        semicolonNlTerminated( _ -> nl().unsignedIntType().space().identifier(\"bits\").space().equals().space().identifier(parameterName).leftShift().constant(\"16\"))\n+                        .semicolonNlTerminated( _ -> floatType().space().identifier(\"r\").space().equals().space().identifier(\"bits\"))\n+                        .semicolonNlTerminated(_ -> identifier(HAT_BUILT_IN_COPY_BYTES).paren( _ -> ampersand().identifier(\"r\").comma().space().ampersand().identifier(\"bits\").comma().sizeof(_ -> identifier(\"r\"))))\n+                        .semicolonNlTerminated(_-> returnKeyword().space().identifier(\"r\"))\n+                );\n+        return self();\n+    }\n+\n+    \/**\n+     * <code>\n+     * ushort floatTobfloat16(float f) {\n+     *      uint bits;\n+     *      byteCopy(&bits, &f, sizeof(bits));\n+     *      short bf16 = bits >> 16;\n+     *      return bf16;\n+     * }\n+     * <\/code>\n+     * @param parameterName\n+     * @return\n+     *\/\n+    public T build_builtin_float2bfloat16(String parameterName) {\n+        shortType().space().identifier(HAT_BUILT_IN_FLOAT_TO_BFLOAT16).paren(_ -> floatType().space().identifier(parameterName))\n+                .brace( _ ->\n+                             semicolonNlTerminated( _ -> nl().unsignedIntType().space().identifier(\"bits\"))\n+                            .semicolonNlTerminated(_ -> identifier(HAT_BUILT_IN_COPY_BYTES).paren( _ -> ampersand().identifier(\"bits\").comma().space().ampersand().identifier(parameterName).comma().sizeof(_ -> identifier(\"bits\"))))\n+                            .semicolonNlTerminated( _ -> shortType().space().identifier(\"bf16\").space().equals().space().identifier(\"bits\").rightShift().constant(\"16\"))\n+                            .semicolonNlTerminated(_-> returnKeyword().space().identifier(\"bf16\"))\n+                        );\n+        return self();\n+    }\n","filename":"hat\/core\/src\/main\/java\/hat\/codebuilders\/HATCodeBuilder.java","additions":87,"deletions":2,"binary":false,"changes":89,"status":"modified"}]}