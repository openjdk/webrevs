{"files":[{"patch":"@@ -270,3 +270,3 @@\n-    public static Vector.Shape getVectorShapeFromInvokeReturnType(MethodHandles.Lookup lookup, JavaOp.InvokeOp invokeOp) {\n-        return getVectorShape(lookup,invokeOp.resultType());\n-    }\n+    \/\/public static Vector.Shape getVectorShapeFromInvokeReturnType(OpHelper.Invoke invoke) {\n+       \/\/ return ;\n+    \/\/}\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATPhaseUtils.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -34,1 +34,0 @@\n-import jdk.incubator.code.TypeElement;\n@@ -98,6 +97,8 @@\n-        OpHelper.Named.Variable.stream(lookup(),funcOp).forEach(v ->{\n-             if (v.firstOperandAsInvoke() instanceof Invoke i && i.returns(Vector.class) && i.named(vectorOperation.methodName)){\n-                 Vector.Shape vectorShape = HATPhaseUtils.getVectorShapeFromInvokeReturnType(lookup(), i.op());\n-                 vectorShapeMap.put(i.op(), vectorShape);\n-                 vectorShapeMap.put(v.op(), vectorShape);\n-                 invokeToVar.put(i.op(),v.op());\n+        OpHelper.Named.Variable.stream(lookup(),funcOp).forEach(variable ->{\n+             if (variable.firstOperandAsInvoke() instanceof Invoke invoke\n+                     && invoke.returns(Vector.class)\n+                     && invoke.named(vectorOperation.methodName)){\n+                 Vector.Shape vectorShape = HATPhaseUtils.getVectorShape(invoke.lookup(),invoke.returnType());\n+                 vectorShapeMap.put(invoke.op(), vectorShape);\n+                 vectorShapeMap.put(variable.op(), vectorShape);\n+                 invokeToVar.put(invoke.op(),variable.op());\n@@ -110,1 +111,1 @@\n-                Vector.Shape shape = HATPhaseUtils.getVectorShapeFromInvokeReturnType(lookup(),invoke.op());\n+                Vector.Shape shape = HATPhaseUtils.getVectorShape(invoke.lookup(),invoke.returnType());\n@@ -145,6 +146,8 @@\n-        OpHelper.Named.Variable.stream(lookup(),funcOp).forEach(v -> {\n-            if (v.firstOperandAsInvoke() instanceof Invoke i && i.named(vectorOperation.methodName) && i.returns(Vector.class)) {\n-                Vector.Shape vectorShape = HATPhaseUtils.getVectorShapeFromInvokeReturnType(lookup(), i.op());\n-                vectorShapeMap.put(i.op(), vectorShape);\n-                vectorShapeMap.put(v.op(), vectorShape);\n-                invokeToVar.put(i.op(), v.op());\n+        OpHelper.Named.Variable.stream(lookup(),funcOp).forEach(variable -> {\n+            if (variable.firstOperandAsInvoke() instanceof Invoke invoke\n+                    && invoke.named(vectorOperation.methodName)\n+                    && invoke.returns(Vector.class)) {\n+                Vector.Shape vectorShape = HATPhaseUtils.getVectorShape(invoke.lookup(),invoke.returnType());\n+                vectorShapeMap.put(invoke.op(), vectorShape);\n+                vectorShapeMap.put(variable.op(), vectorShape);\n+                invokeToVar.put(invoke.op(), variable.op());\n@@ -171,1 +174,1 @@\n-    private  Map<Op, Vector.Shape> getVectorMetaDataMap(CoreOp.FuncOp funcOp){\n+    private  Map<Op, Vector.Shape> getVectorShapeMap(CoreOp.FuncOp funcOp){\n@@ -174,1 +177,3 @@\n-                filter(i -> i.returns(Vector.class) && i.named(vectorOperation.methodName) && i.onlyUse() instanceof CoreOp.VarOp)\n+                filter(i -> i.returns(Vector.class)\n+                        && i.named(vectorOperation.methodName)\n+                        && i.opFromOnlyUseOrNull() instanceof CoreOp.VarOp)\n@@ -176,1 +181,1 @@\n-                    Vector.Shape vectorShape = HATPhaseUtils.getVectorShapeFromInvokeReturnType(lookup(), i.op());\n+                    Vector.Shape vectorShape = HATPhaseUtils.getVectorShape(i.lookup(),i.returnType());\n@@ -178,1 +183,1 @@\n-                    vectorShapeMap.put(i.onlyUse(), vectorShape);\n+                    vectorShapeMap.put(i.opFromOnlyUseOrNull(), vectorShape);\n@@ -185,1 +190,1 @@\n-        Map<Op, Vector.Shape> vectorShapeMap = getVectorMetaDataMap(funcOp);\n+        Map<Op, Vector.Shape> vectorShapeMap = getVectorShapeMap(funcOp);\n@@ -204,1 +209,1 @@\n-        Map<Op, Vector.Shape> vectorShapeMap = getVectorMetaDataMap(funcOp);\n+        Map<Op, Vector.Shape> vectorShapeMap = getVectorShapeMap(funcOp);\n@@ -227,1 +232,2 @@\n-                    if (invoke(lookup(),codeElement) instanceof Invoke invoke && invoke.returns(Vector.class) && invoke.named(vectorOperation.methodName)) {\n+                    if (invoke(lookup(),codeElement) instanceof Invoke invoke\n+                            && invoke.returns(Vector.class) && invoke.named(vectorOperation.methodName)) {\n@@ -245,1 +251,1 @@\n-                 if (op instanceof JavaOp.InvokeOp invokeOp) {\n+                 if (invoke(lookup(),op)  instanceof Invoke invoke) {\n@@ -247,4 +253,4 @@\n-                             HATPhaseUtils.findVectorVarNameOrNull(invokeOp.operands().getFirst()),\n-                             BinaryOpEnum.of(invokeOp),\n-                             HATPhaseUtils.getVectorShapeFromInvokeReturnType(lookup(),invokeOp),\n-                             blockBuilder.context().getValues(invokeOp.operands())\n+                             HATPhaseUtils.findVectorVarNameOrNull(invoke.op().operands().getFirst()),\n+                             BinaryOpEnum.of(invoke.op()),\n+                             HATPhaseUtils.getVectorShape(invoke.lookup(),invoke.returnType()),\n+                             blockBuilder.context().getValues(invoke.op().operands())\n@@ -252,1 +258,1 @@\n-                     blockBuilder.context().mapValue(invokeOp.result(), blockBuilder.op(copyLocation(invokeOp,memoryViewOp)));\n+                     blockBuilder.context().mapValue(invoke.op().result(), blockBuilder.op(copyLocation(invoke.op(),memoryViewOp)));\n","filename":"hat\/core\/src\/main\/java\/hat\/phases\/HATVectorPhase.java","additions":33,"deletions":27,"binary":false,"changes":60,"status":"modified"},{"patch":"@@ -5,0 +5,1 @@\n+    <mapping directory=\"$PROJECT_DIR$\/..\/..\/..\/beehive-spirv-toolkit\" vcs=\"Git\" \/>\n","filename":"hat\/intellij\/.idea\/vcs.xml","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -72,0 +72,12 @@\n+\n+\n+    default Op opFromOnlyUseOrNull() {\n+        return onlyUseOrNull() instanceof Op.Result result?result.op():null;\n+    }\n+    default Op.Result onlyUseOrNull() {\n+        if (op().result().uses().size() == 1) {\n+            return op().result().uses().iterator().next();\n+        } else {\n+            return null;\n+        }\n+    }\n@@ -97,1 +109,0 @@\n-\n@@ -101,1 +112,1 @@\n-            throw new RuntimeException(\"No funcop\/method model for \" + method + \" did you forget @Reflec\");\n+            throw new RuntimeException(\"No funcop\/method model for \" + method + \" did you forget @Reflect\");\n@@ -151,1 +162,0 @@\n-\n@@ -201,2 +211,18 @@\n-        return opFromFirstOperandOrThrow()\n-                instanceof CoreOp.VarAccessOp.VarLoadOp varLoadOp ? varLoadOp : null;\n+        return opFromFirstOperandOrNull() instanceof CoreOp.VarAccessOp.VarLoadOp varLoadOp ? varLoadOp : null;\n+    }\n+    default CoreOp.VarOp varOpFromFirstOperandOrNull() {\n+        return opFromFirstOperandOrNull() instanceof CoreOp.VarOp varOp ? varOp : null;\n+    }\n+    default CoreOp varAccessOrVarOpFromFirstOperandOrNull() {\n+        return switch (opFromFirstOperandOrNull()) {\n+            case CoreOp.VarAccessOp.VarLoadOp varLoadOp -> varLoadOp;\n+            case CoreOp.VarOp varOp -> varOp;\n+            default -> null;\n+        };\n+    }\n+    default String varNameFromFirstOperandOrNull() {\n+        return switch (varAccessOrVarOpFromFirstOperandOrNull()){\n+            case CoreOp.VarOp varOp->varOp.varName();\n+            case CoreOp.VarAccessOp varAccessOp->varAccessOp.varOp().varName();\n+            default -> null;\n+        };\n@@ -621,7 +647,2 @@\n-        default Op onlyUse() {\n-            if (op().result().uses().size() == 1) {\n-                return op().result().uses().iterator().next().op();\n-            } else {\n-                return null;\n-            }\n-        }\n+\n+\n","filename":"hat\/optkl\/src\/main\/java\/optkl\/OpHelper.java","additions":33,"deletions":12,"binary":false,"changes":45,"status":"modified"}]}