{"files":[{"patch":"@@ -173,0 +173,4 @@\n+\/\/ A stronger version of the above that checks that we are at a safepoint if the vm thread\n+#define shenandoah_assert_control_or_vm_thread_at_safepoint()                                                                                                               \\\n+                    assert(Thread::current() == ShenandoahHeap::heap()->control_thread() || (SafepointSynchronize::is_at_safepoint() && Thread::current()->is_VM_thread()), \\\n+                    \"Expected control thread, or vm thread at a safepoint\")\n@@ -176,0 +180,11 @@\n+\n+\/\/ Some limited sanity checking of the _gc_generation and _active_generation fields of ShenandoahHeap\n+#define shenandoah_assert_generations_reconciled()                                                             \\\n+                    if (SafepointSynchronize::is_at_safepoint()) {                                             \\\n+                      ShenandoahHeap* heap = ShenandoahHeap::heap();                                           \\\n+                      ShenandoahGeneration* ggen = heap->gc_generation();                                      \\\n+                      ShenandoahGeneration* agen = heap->active_generation();                                  \\\n+                      assert(agen == ggen, \"active_gen(%d) should be reconciled with gc_gen(%d)at safepoint\",  \\\n+                             agen->type(), ggen->type());                                                      \\\n+                    }\n+\n@@ -228,0 +243,1 @@\n+#define shenandoah_assert_control_or_vm_thread_at_safepoint()\n@@ -229,0 +245,1 @@\n+#define shenandoah_assert_generations_reconciled()                                                             \\\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAsserts.hpp","additions":17,"deletions":0,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -931,0 +931,1 @@\n+      shenandoah_assert_generations_reconciled();\n@@ -1054,0 +1055,3 @@\n+  \/\/ We can only toggle concurrent_weak_root_in_progress flag\n+  \/\/ at a safepoint, so that mutators see a consistent\n+  \/\/ value. The flag will be cleared at the next safepoint.\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahConcurrentGC.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -66,1 +66,5 @@\n-    ShenandoahReferenceProcessor* rp = heap->active_generation()->ref_processor();\n+    \/\/ Do not use active_generation() : we must use the gc_generation() set by\n+    \/\/ ShenandoahGCScope on the ControllerThread's stack; no safepoint may\n+    \/\/ intervene to update active_generation, so we can't\n+    \/\/ shenandoah_assert_generations_reconciled() here.\n+    ShenandoahReferenceProcessor* rp = heap->gc_generation()->ref_processor();\n@@ -114,1 +118,2 @@\n-    ShenandoahReferenceProcessor* rp = heap->active_generation()->ref_processor();\n+    ShenandoahReferenceProcessor* rp = heap->gc_generation()->ref_processor();\n+    shenandoah_assert_generations_reconciled();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahConcurrentMark.cpp","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -445,0 +445,1 @@\n+      ShenandoahGCSession session(cause, old_generation);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalControlThread.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -134,1 +134,2 @@\n-    assert(_heap->active_generation()->is_mark_complete(), \"sanity\");\n+    assert(_heap->gc_generation()->is_mark_complete(), \"sanity\");\n+    shenandoah_assert_generations_reconciled();\n@@ -217,1 +218,2 @@\n-  assert(_heap->active_generation()->is_mark_complete(), \"sanity\");\n+  assert(_heap->gc_generation()->is_mark_complete(), \"sanity\");\n+  shenandoah_assert_generations_reconciled();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalEvacuationTask.cpp","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -57,0 +57,1 @@\n+  heap->set_active_generation();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalFullGC.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -165,1 +165,4 @@\n-  if (active_generation()->is_young() && target_gen == YOUNG_GENERATION) {\n+  shenandoah_assert_generations_reconciled();\n+  assert(gc_generation() != nullptr, \"Error\");\n+  assert(active_generation() != nullptr, \"Error\");\n+  if (gc_generation()->is_young() && target_gen == YOUNG_GENERATION) {\n@@ -749,0 +752,1 @@\n+\n@@ -761,1 +765,3 @@\n-    assert(_heap->active_generation()->is_mark_complete(), \"Expected complete marking\");\n+    ShenandoahGeneration* const gc_generation = _heap->gc_generation();\n+    shenandoah_assert_generations_reconciled();\n+    assert(gc_generation->is_mark_complete(), \"Expected complete marking\");\n@@ -775,1 +781,1 @@\n-          if (_heap->active_generation()->is_global()) {\n+          if (gc_generation->is_global()) {\n@@ -812,1 +818,1 @@\n-    if (!_heap->active_generation()->is_global()) {\n+    if (!gc_generation->is_global()) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalHeap.cpp","additions":10,"deletions":4,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -561,0 +561,1 @@\n+  _active_generation(nullptr),\n@@ -1575,0 +1576,12 @@\n+void ShenandoahHeap::set_gc_generation(ShenandoahGeneration* generation) {\n+  shenandoah_assert_control_or_vm_thread_at_safepoint();\n+  _gc_generation = generation;\n+}\n+\n+\/\/ Active generation may only be set by the VM thread at a safepoint.\n+void ShenandoahHeap::set_active_generation() {\n+  assert(Thread::current()->is_VM_thread(), \"Only the VM Thread\");\n+  assert(SafepointSynchronize::is_at_safepoint(), \"Only at a safepoint!\");\n+  _active_generation = _gc_generation;\n+}\n+\n@@ -1578,0 +1591,3 @@\n+  assert(gc_cause()  == GCCause::_no_gc, \"Over-writing cause\");\n+  assert(_gc_generation == nullptr, \"Over-writing _gc_generation\");\n+\n@@ -1585,0 +1601,3 @@\n+  assert(gc_cause() != GCCause::_no_gc, \"cause wasn't set\");\n+  assert(_gc_generation != nullptr, \"_gc_generation wasn't set\");\n+\n@@ -1591,0 +1610,2 @@\n+\n+  set_gc_generation(nullptr);\n@@ -1943,1 +1964,2 @@\n-  active_generation()->ref_processor()->process_references(phase, workers(), false \/* concurrent *\/);\n+  shenandoah_assert_generations_reconciled();\n+  gc_generation()->ref_processor()->process_references(phase, workers(), false \/* concurrent *\/);\n@@ -1975,0 +1997,3 @@\n+  \/\/ Check that if concurrent weak root is set then active_gen isn't null\n+  assert(!is_concurrent_weak_root_in_progress() || active_generation() != nullptr, \"Error\");\n+  shenandoah_assert_generations_reconciled();\n@@ -2268,1 +2293,2 @@\n-    if (active_generation()->contains(r)) {\n+    shenandoah_assert_generations_reconciled();\n+    if (gc_generation()->contains(r)) {\n@@ -2448,1 +2474,1 @@\n-    ShenandoahFinalUpdateRefsUpdateRegionStateClosure cl (active_generation()->complete_marking_context());\n+    ShenandoahFinalUpdateRefsUpdateRegionStateClosure cl (gc_generation()->complete_marking_context());\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.cpp","additions":29,"deletions":3,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -154,0 +154,3 @@\n+\n+  \/\/ Indicates the generation whose collection is in\n+  \/\/ proress\n@@ -156,0 +159,8 @@\n+  \/\/ This is set and cleared by only the VMThread\n+  \/\/ at each STW pause (safepoint) to the value seen in\n+  \/\/ _gc_generation. This allows the value to be always consistently\n+  \/\/ seen by all mutators as well as all GC worker threads.\n+  \/\/ In that sense, it's a stable snapshot of _gc_generation that is\n+  \/\/ updated at each STW pause associated with a ShenandoahVMOp.\n+  ShenandoahGeneration* _active_generation;\n+\n@@ -161,2 +172,2 @@\n-  ShenandoahGeneration* active_generation() const {\n-    \/\/ last or latest generation might be a better name here.\n+  ShenandoahGeneration* gc_generation() const {\n+    \/\/ value of _gc_generation field, see above\n@@ -166,2 +177,3 @@\n-  void set_gc_generation(ShenandoahGeneration* generation) {\n-    _gc_generation = generation;\n+  ShenandoahGeneration* active_generation() const {\n+    \/\/ value of _active_generation field, see above\n+    return _active_generation;\n@@ -170,0 +182,8 @@\n+  \/\/ Set the _gc_generation field\n+  void set_gc_generation(ShenandoahGeneration* generation);\n+\n+  \/\/ Copy the value in the _gc_generation field into\n+  \/\/ the _active_generation field: can only be called at\n+  \/\/ a safepoint by the VMThread.\n+  void set_active_generation();\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.hpp","additions":24,"deletions":4,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -363,0 +363,1 @@\n+    assert(is_in(obj), \"Otherwise shouldn't return true below\");\n@@ -366,2 +367,4 @@\n-  if (active_generation() == nullptr) {\n-    \/\/ no collection is happening, only expect this to be called\n+  ShenandoahGeneration* const gen = active_generation();\n+\n+  if (gen == nullptr) {\n+    \/\/ no collection is happening: only expect this to be called\n@@ -373,3 +376,2 @@\n-  assert((active_generation() == (ShenandoahGeneration*) old_generation()) ||\n-         (active_generation() == (ShenandoahGeneration*) young_generation()) ||\n-         (active_generation() == global_generation()), \"Active generation must be old, young, or global\");\n+  assert(gen == (ShenandoahGeneration*)old_generation() || gen == (ShenandoahGeneration*)young_generation() || gen == (ShenandoahGeneration*)global_generation(),\n+         \"Active generation must be old, young, or global\");\n@@ -378,0 +380,4 @@\n+\n+  \/\/ No flickering!\n+  assert(gen == active_generation(), \"Race?\");\n+\n@@ -384,1 +390,1 @@\n-    return (active_generation() != (ShenandoahGeneration*) old_generation());\n+    return gen != (ShenandoahGeneration*)old_generation();\n@@ -387,1 +393,1 @@\n-    return (active_generation() != (ShenandoahGeneration*) young_generation());\n+    return gen != (ShenandoahGeneration*)young_generation();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.inline.hpp","additions":13,"deletions":7,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -321,1 +321,2 @@\n-  assert(ShenandoahHeap::heap()->active_generation()->is_mark_complete(), \"Marking should be complete here.\");\n+  assert(ShenandoahHeap::heap()->gc_generation()->is_mark_complete(), \"Marking should be complete here.\");\n+  shenandoah_assert_generations_reconciled();\n@@ -471,1 +472,2 @@\n-  assert(heap->active_generation()->is_mark_complete(), \"sanity\");\n+  assert(heap->gc_generation()->is_mark_complete(), \"sanity\");\n+  shenandoah_assert_generations_reconciled();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.cpp","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -152,2 +152,6 @@\n-  assert(heap->active_generation()->type() == GENERATION, \"Sanity\");\n-  heap->active_generation()->ref_processor()->set_mark_closure(worker_id, cl);\n+  \/\/ Do not use active_generation() : we must use the gc_generation() set by\n+  \/\/ ShenandoahGCScope on the ControllerThread's stack; no safepoint may\n+  \/\/ intervene to update active_generation, so we can't\n+  \/\/ shenandoah_assert_generations_reconciled() here.\n+  assert(heap->gc_generation()->type() == GENERATION, \"Sanity: %d != %d\", heap->gc_generation()->type(), GENERATION);\n+  heap->gc_generation()->ref_processor()->set_mark_closure(worker_id, cl);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahMark.cpp","additions":6,"deletions":2,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -107,1 +107,3 @@\n-  ShenandoahReferenceProcessor* rp = heap->active_generation()->ref_processor();\n+  ShenandoahReferenceProcessor* rp = heap->gc_generation()->ref_processor();\n+  shenandoah_assert_generations_reconciled();\n+  assert(heap->gc_generation() == heap->active_generation(), \"Should be identical at stw phases\");\n@@ -175,1 +177,2 @@\n-  ShenandoahReferenceProcessor* rp = ShenandoahHeap::heap()->active_generation()->ref_processor();\n+  ShenandoahReferenceProcessor* rp = ShenandoahHeap::heap()->gc_generation()->ref_processor();\n+  shenandoah_assert_generations_reconciled();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahSTWMark.cpp","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+#include \"logging\/log.hpp\"\n@@ -40,0 +41,1 @@\n+  log_active_generation(\"Prologue\");\n@@ -45,0 +47,1 @@\n+  log_active_generation(\"Epilogue\");\n@@ -48,0 +51,15 @@\n+void VM_ShenandoahOperation::log_active_generation(const char* prefix) {\n+  ShenandoahGeneration* agen = ShenandoahHeap::heap()->active_generation();\n+  ShenandoahGeneration* ggen = ShenandoahHeap::heap()->gc_generation();\n+  log_debug(gc, heap)(\"%s: active_generation is %s, gc_generation is %s\", prefix,\n+                      agen == nullptr ? \"nullptr\" : shenandoah_generation_name(agen->type()),\n+                      ggen == nullptr ? \"nullptr\" : shenandoah_generation_name(ggen->type()));\n+}\n+\n+void VM_ShenandoahOperation::set_active_generation() {\n+  if (evaluate_at_safepoint()) {\n+    assert(SafepointSynchronize::is_at_safepoint(), \"Error??\");\n+    ShenandoahHeap::heap()->set_active_generation();\n+  }\n+}\n+\n@@ -65,0 +83,1 @@\n+  set_active_generation();\n@@ -71,0 +90,1 @@\n+  set_active_generation();\n@@ -77,0 +97,1 @@\n+  set_active_generation();\n@@ -83,0 +104,1 @@\n+  set_active_generation();\n@@ -89,0 +111,1 @@\n+  set_active_generation();\n@@ -95,0 +118,1 @@\n+  set_active_generation();\n@@ -101,0 +125,1 @@\n+  set_active_generation();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVMOperations.cpp","additions":25,"deletions":0,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -41,0 +41,1 @@\n+\/\/   - VM_ShenandoahFinalRoots\n@@ -47,1 +48,3 @@\n-  uint         _gc_id;\n+  uint _gc_id;\n+\n+  void set_active_generation();\n@@ -51,0 +54,2 @@\n+\n+  void log_active_generation(const char* prefix);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVMOperations.hpp","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -97,1 +97,1 @@\n-      _generation = _heap->active_generation();\n+      _generation = _heap->gc_generation();\n@@ -99,0 +99,1 @@\n+      shenandoah_assert_generations_reconciled();\n@@ -192,1 +193,1 @@\n-                (obj_reg->is_old() && _heap->active_generation()->is_young()),\n+                (obj_reg->is_old() && _heap->gc_generation()->is_young()),\n@@ -194,0 +195,1 @@\n+          shenandoah_assert_generations_reconciled();\n@@ -637,1 +639,1 @@\n-      _generation = _heap->active_generation();\n+      _generation = _heap->gc_generation();\n@@ -639,0 +641,1 @@\n+      shenandoah_assert_generations_reconciled();\n@@ -878,1 +881,1 @@\n-    generation = _heap->active_generation();\n+    generation = _heap->gc_generation();\n@@ -880,0 +883,1 @@\n+    shenandoah_assert_generations_reconciled();\n@@ -1352,1 +1356,2 @@\n-  if (old_generation->is_mark_complete() || _heap->active_generation()->is_global()) {\n+  shenandoah_assert_generations_reconciled();\n+  if (old_generation->is_mark_complete() || _heap->gc_generation()->is_global()) {\n@@ -1432,1 +1437,2 @@\n-  if (_heap->old_generation()->is_mark_complete() || _heap->active_generation()->is_global()) {\n+  shenandoah_assert_generations_reconciled();\n+  if (_heap->old_generation()->is_mark_complete() || _heap->gc_generation()->is_global()) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVerifier.cpp","additions":12,"deletions":6,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -81,0 +81,1 @@\n+                    \/\/ \"-XX:+UnlockExperimentalVMOptions\", \"-XX:ShenandoahNoProgressThreshold=12\", \"-XX:+ShowMessageBoxOnError\",\n","filename":"test\/hotspot\/jtreg\/gc\/shenandoah\/oom\/TestThreadFailure.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}