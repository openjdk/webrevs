{"files":[{"patch":"@@ -46,1 +46,1 @@\n- private:\n+private:\n@@ -49,1 +49,1 @@\n- public:\n+public:\n@@ -55,4 +55,0 @@\n-    if (_heap->is_bitmap_slice_committed(r)) {\n-      _ctx->clear_bitmap(r);\n-    }\n-\n@@ -70,12 +66,18 @@\n-class ShenandoahResetBitmapTask : public ShenandoahHeapRegionClosure {\n- private:\n-  ShenandoahHeap* _heap;\n-  ShenandoahMarkingContext* const _ctx;\n- public:\n-  ShenandoahResetBitmapTask() :\n-    _heap(ShenandoahHeap::heap()),\n-    _ctx(_heap->marking_context()) {}\n-\n-  void heap_region_do(ShenandoahHeapRegion* region) {\n-    if (_heap->is_bitmap_slice_committed(region)) {\n-      _ctx->clear_bitmap(region);\n+class ShenandoahResetBitmapTask : public WorkerTask {\n+private:\n+  ShenandoahRegionIterator _regions;\n+  ShenandoahGeneration* _generation;\n+\n+public:\n+  ShenandoahResetBitmapTask(ShenandoahGeneration* generation) :\n+    WorkerTask(\"Shenandoah Reset Bitmap\"), _generation(generation) {}\n+\n+  void work(uint worker_id) {\n+    ShenandoahHeapRegion* region = _regions.next();\n+    ShenandoahHeap* heap = ShenandoahHeap::heap();\n+    ShenandoahMarkingContext* const ctx = heap->marking_context();\n+    while (region != nullptr) {\n+      if (_generation->contains(region) && heap->is_bitmap_slice_committed(region)) {\n+        ctx->clear_bitmap(region);\n+      }\n+      region = _regions.next();\n@@ -84,2 +86,0 @@\n-\n-  bool is_thread_safe() { return true; }\n@@ -91,1 +91,1 @@\n- private:\n+private:\n@@ -93,1 +93,1 @@\n- public:\n+public:\n@@ -107,1 +107,1 @@\n- private:\n+private:\n@@ -109,1 +109,1 @@\n- public:\n+public:\n@@ -196,2 +196,2 @@\n-  ShenandoahResetBitmapTask task;\n-  parallel_heap_region_iterate(&task);\n+  ShenandoahResetBitmapTask task(this);\n+  heap->workers()->run_task(&task);\n@@ -230,2 +230,2 @@\n-  \/\/ Invalidate the marking context\n-  set_mark_incomplete();\n+\n+  reset_mark_bitmap();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGeneration.cpp","additions":28,"deletions":28,"binary":false,"changes":56,"status":"modified"}]}