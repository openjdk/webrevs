{"files":[{"patch":"@@ -435,2 +435,2 @@\n-    \/\/ The heuristic old_is_fragmented trigger may be seeking to achieve up to 7\/8 density.  Allow ourselves to overshoot\n-    \/\/ that target (at 15\/16) so we will not have to do another defragmenting old collection right away.\n+    \/\/ The heuristic old_is_fragmented trigger may be seeking to achieve up to 75% density.  Allow ourselves to overshoot\n+    \/\/ that target (at 7\/8) so we will not have to do another defragmenting old collection right away.\n@@ -438,1 +438,1 @@\n-           (total_uncollected_old_regions < 15 * span_of_uncollected_regions \/ 16)) {\n+           (total_uncollected_old_regions < 7 * span_of_uncollected_regions \/ 8)) {\n@@ -549,1 +549,2 @@\n-void ShenandoahOldHeuristics::trigger_collection_if_fragmented(size_t first_old_region, size_t last_old_region, size_t old_region_count, size_t num_regions) {\n+void ShenandoahOldHeuristics::trigger_collection_if_fragmented(size_t first_old_region, size_t last_old_region,\n+                                                               size_t old_region_count, size_t num_regions) {\n@@ -554,13 +555,3 @@\n-    \/\/ Tolerate lower density if total span is small.  Here's the implementation:\n-    \/\/   if old_gen spans more than 100% and density < 75%, trigger old-defrag\n-    \/\/   else if old_gen spans more than 87.5% and density < 62.5%, trigger old-defrag\n-    \/\/   else if old_gen spans more than 75% and density < 50%, trigger old-defrag\n-    \/\/   else if old_gen spans more than 62.5% and density < 37.5%, trigger old-defrag\n-    \/\/   else if old_gen spans more than 50% and density < 25%, trigger old-defrag\n-    \/\/\n-    \/\/ A previous implementation was more aggressive in triggering, resulting in degraded throughput when\n-    \/\/ humongous allocation was not required.\n-\n-    size_t old_available = _old_gen->available();\n-    size_t region_size_bytes = ShenandoahHeapRegion::region_size_bytes();\n-    size_t old_unaffiliated_available = _old_gen->free_unaffiliated_regions() * region_size_bytes;\n+    size_t old_available = _old_gen->available() \/ HeapWordSize;\n+    size_t region_size_words = ShenandoahHeapRegion::region_size_words();\n+    size_t old_unaffiliated_available = _old_gen->free_unaffiliated_regions() * region_size_words;\n@@ -570,13 +561,16 @@\n-    size_t old_bytes_consumed = old_region_count * region_size_bytes - old_fragmented_available;\n-    size_t old_bytes_spanned = old_region_span * region_size_bytes;\n-    double old_density = ((double) old_bytes_consumed) \/ old_bytes_spanned;\n-\n-    uint eighths = 8;\n-    for (uint i = 0; i < 5; i++) {\n-      size_t span_threshold = eighths * allowed_old_gen_span \/ 8;\n-      double density_threshold = (eighths - 2) \/ 8.0;\n-      if ((old_region_span >= span_threshold) && (old_density < density_threshold)) {\n-        trigger_old_is_fragmented(old_density, first_old_region, last_old_region);\n-        return;\n-      }\n-      eighths--;\n+    size_t old_words_consumed = old_region_count * region_size_words - old_fragmented_available;\n+    size_t old_words_spanned = old_region_span * region_size_words;\n+    double old_density = ((double) old_words_consumed) \/ old_words_spanned;\n+\n+    double old_span_percent = ((double) old_region_span) \/ allowed_old_gen_span;\n+    double old_span_percent_squared = old_span_percent * old_span_percent;\n+\n+    if (old_density \/ old_span_percent_squared < 0.75) {\n+      \/\/ We trigger old defragmentation, for example, if:\n+      \/\/  old_span_percent is 100% and old_density is below 75.0%, or\n+      \/\/  old_span_percent is  90% and old_density is below 60.8%, or\n+      \/\/  old_span_percent is  80% and old_density is below 48.0%, or\n+      \/\/  old_span_percent is  70% and old_density is below 36.8%, or\n+      \/\/  old_span_percent is  60% and old_density is below 27.0%, or\n+      \/\/  old_span_percent is  50% and old_density is below 18.8%, or ...\n+      trigger_old_is_fragmented(old_density, first_old_region, last_old_region);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahOldHeuristics.cpp","additions":24,"deletions":30,"binary":false,"changes":54,"status":"modified"}]}