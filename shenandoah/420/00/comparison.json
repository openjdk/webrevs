{"files":[{"patch":"@@ -73,1 +73,0 @@\n-  auto heap = ShenandoahGenerationalHeap::heap();\n@@ -89,1 +88,1 @@\n-  const size_t old_evacuation_reserve = heap->old_generation()->get_evacuation_reserve();\n+  const size_t old_evacuation_reserve = _old_generation->get_evacuation_reserve();\n@@ -313,1 +312,0 @@\n-  size_t total_garbage = 0;\n@@ -321,1 +319,1 @@\n-    if (!_old_generation->contains(region)) {\n+    if (!region->is_old()) {\n@@ -327,1 +325,0 @@\n-    total_garbage += garbage;\n@@ -330,13 +327,4 @@\n-    \/\/ Only place regular regions into the candidate set\n-    if (region->is_regular()) {\n-      if (!region->has_live()) {\n-        assert(!region->is_pinned(), \"Pinned region should have live (pinned) objects.\");\n-        region->make_trash_immediate();\n-        immediate_regions++;\n-        immediate_garbage += garbage;\n-      } else {\n-        region->begin_preemptible_coalesce_and_fill();\n-        candidates[cand_idx]._region = region;\n-        candidates[cand_idx]._u._live_data = live_bytes;\n-        cand_idx++;\n-      }\n+    if (region->is_trash()) {\n+      \/\/ Count humongous objects made into trash here.\n+      immediate_regions++;\n+      immediate_garbage += garbage;\n@@ -344,0 +332,3 @@\n+      \/\/ This will handle humongous start regions whether they are also pinned, or not.\n+      \/\/ If they are pinned, we expect them to hold live data, so they will not be\n+      \/\/ turned into immediate garbage.\n@@ -355,4 +346,16 @@\n-    } else if (region->is_trash()) {\n-      \/\/ Count humongous objects made into trash here.\n-      immediate_regions++;\n-      immediate_garbage += garbage;\n+    } else if (region->is_regular() || region->is_pinned()) {\n+      if (!region->has_live()) {\n+        assert(!region->is_pinned(), \"Pinned region should have live (pinned) objects.\");\n+        region->make_trash_immediate();\n+        immediate_regions++;\n+        immediate_garbage += garbage;\n+      } else {\n+        \/\/ Only place regular or pinned regions with live data into the candidate set.\n+        \/\/ Pinned regions cannot be evacuated, but we are not actually choosing candidates\n+        \/\/ for the collection set here. That happens later during the next young GC cycle,\n+        \/\/ by which time, the pinned region may no longer be pinned.\n+        region->begin_preemptible_coalesce_and_fill();\n+        candidates[cand_idx]._region = region;\n+        candidates[cand_idx]._u._live_data = live_bytes;\n+        cand_idx++;\n+      }\n@@ -388,1 +391,0 @@\n-  size_t candidates_garbage = 0;\n@@ -394,0 +396,1 @@\n+  size_t candidates_garbage = 0;\n@@ -409,0 +412,2 @@\n+  size_t total_uncollected_old_regions = _last_old_region - _last_old_collection_candidate;\n+\n@@ -428,1 +433,0 @@\n-    size_t total_uncollected_old_regions = cand_idx - _last_old_collection_candidate;\n@@ -439,1 +443,2 @@\n-      assert (r->is_regular(), \"Only regular regions are in the candidate set\");\n+      assert((r->is_regular() || r->is_pinned()) && !r->is_humongous(), \"Region \" SIZE_FORMAT \" has wrong state for collection: %s\",\n+             r->index(), ShenandoahHeapRegion::region_state_to_string(r->state()));\n@@ -460,7 +465,6 @@\n-  log_info(gc)(\"Old-Gen Collectable Garbage: \" SIZE_FORMAT \"%s \"\n-               \"consolidated with free: \" SIZE_FORMAT \"%s, over \" SIZE_FORMAT \" regions (humongous defragmentation: \"\n-               SIZE_FORMAT \" regions), Old-Gen Immediate Garbage: \" SIZE_FORMAT \"%s over \" SIZE_FORMAT \" regions.\",\n-               byte_size_in_proper_unit(collectable_garbage), proper_unit_for_byte_size(collectable_garbage),\n-               byte_size_in_proper_unit(unfragmented),        proper_unit_for_byte_size(unfragmented),\n-               old_candidates, defrag_count,\n-               byte_size_in_proper_unit(immediate_garbage),   proper_unit_for_byte_size(immediate_garbage), immediate_regions);\n+  log_info(gc)(\"Old-Gen Collectable Garbage: \" PROPERFMT \" consolidated with free: \" PROPERFMT \", over \" SIZE_FORMAT \" regions\",\n+               PROPERFMTARGS(collectable_garbage), PROPERFMTARGS(unfragmented), old_candidates);\n+  log_info(gc)(\"Old-Gen Immediate Garbage: \" PROPERFMT \" over \" SIZE_FORMAT \" regions\",\n+              PROPERFMTARGS(immediate_garbage), immediate_regions);\n+  log_info(gc)(\"Old regions selected for defragmentation: \" SIZE_FORMAT, defrag_count);\n+  log_info(gc)(\"Old regions not selected: \" SIZE_FORMAT, total_uncollected_old_regions);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahOldHeuristics.cpp","additions":36,"deletions":32,"binary":false,"changes":68,"status":"modified"},{"patch":"@@ -127,0 +127,1 @@\n+public:\n@@ -145,0 +146,1 @@\n+private:\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -57,1 +57,1 @@\n-  void do_thread(Thread* thread) {\n+  void do_thread(Thread* thread) override {\n@@ -77,1 +77,1 @@\n-  void do_buffer(void** buffer, size_t size) {\n+  void do_buffer(void** buffer, size_t size) override {\n@@ -114,1 +114,1 @@\n-  void work(uint worker_id) {\n+  void work(uint worker_id) override {\n@@ -146,1 +146,1 @@\n-  void work(uint worker_id) {\n+  void work(uint worker_id) override {\n@@ -308,2 +308,0 @@\n-  log_debug(gc)(\"Starting (or resuming) coalesce-and-fill of old heap regions\");\n-\n@@ -317,0 +315,1 @@\n+  log_info(gc)(\"Starting (or resuming) coalesce-and-fill of \" UINT32_FORMAT \" old heap regions\", coalesce_and_fill_regions_count);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahOldGeneration.cpp","additions":5,"deletions":6,"binary":false,"changes":11,"status":"modified"}]}