{"files":[{"patch":"@@ -36,1 +36,5 @@\n-import java.io.*;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.OutputStream;\n@@ -44,0 +48,1 @@\n+\n@@ -45,0 +50,1 @@\n+\n@@ -58,1 +64,10 @@\n-import java.util.*;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Base64;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.TimeZone;\n+import java.util.concurrent.CountDownLatch;\n@@ -95,4 +110,0 @@\n-    \/*\n-     * Is the server ready to serve?\n-     *\/\n-    volatile static boolean serverReady = false;\n@@ -167,1 +178,1 @@\n-        serverReady = false;\n+        CountDownLatch serverReady = new CountDownLatch(1);\n@@ -195,1 +206,1 @@\n-                servParams);\n+                servParams, serverReady);\n@@ -222,1 +233,1 @@\n-     * If the server prematurely exits, serverReady will be set to true\n+     * If the server prematurely exits, serverReady will be counted down\n@@ -225,1 +236,2 @@\n-    void doServerSide(ServerParameters servParams) throws Exception {\n+    void doServerSide(ServerParameters servParams, CountDownLatch serverReady)\n+            throws Exception {\n@@ -277,1 +289,1 @@\n-        serverReady = true;\n+        serverReady.countDown();\n@@ -309,1 +321,1 @@\n-     * If the server prematurely exits, serverReady will be set to true\n+     * If the server prematurely exits, serverReady will be counted down\n@@ -312,1 +324,2 @@\n-    void doClientSide(ClientParameters cliParams) throws Exception {\n+    void doClientSide(ClientParameters cliParams, CountDownLatch serverReady)\n+            throws Exception {\n@@ -314,7 +327,1 @@\n-        \/\/ Wait 5 seconds for server ready\n-        for (int i = 0; (i < 100 && !serverReady); i++) {\n-            Thread.sleep(50);\n-        }\n-        if (!serverReady) {\n-            throw new RuntimeException(\"Server not ready yet\");\n-        }\n+        serverReady.await();\n@@ -376,2 +383,2 @@\n-    HttpsUrlConnClient(ClientParameters cliParams,\n-            ServerParameters servParams) throws Exception {\n+    HttpsUrlConnClient(ClientParameters cliParams, ServerParameters servParams,\n+            CountDownLatch serverReady) throws Exception {\n@@ -381,2 +388,2 @@\n-                startServer(servParams, true);\n-                startClient(cliParams, false);\n+                startServer(servParams, true, serverReady);\n+                startClient(cliParams, false, serverReady);\n@@ -384,2 +391,2 @@\n-                startClient(cliParams, true);\n-                startServer(servParams, false);\n+                startClient(cliParams, true, serverReady);\n+                startServer(servParams, false, serverReady);\n@@ -456,2 +463,2 @@\n-    final void startServer(ServerParameters servParams, boolean newThread)\n-            throws Exception {\n+    final void startServer(ServerParameters servParams, boolean newThread,\n+            CountDownLatch serverReady) throws IOException {\n@@ -463,1 +470,1 @@\n-                        doServerSide(servParams);\n+                        doServerSide(servParams, serverReady);\n@@ -470,2 +477,1 @@\n-                        System.err.println(\"Server died...\");\n-                        serverReady = true;\n+                        System.err.println(\"Server died: \" + e);\n@@ -473,0 +479,2 @@\n+                    } finally {\n+                        serverReady.countDown();\n@@ -479,1 +487,1 @@\n-                doServerSide(servParams);\n+                doServerSide(servParams, serverReady);\n@@ -481,0 +489,1 @@\n+                System.err.println(\"Server died: \" + e);\n@@ -483,1 +492,1 @@\n-                serverReady = true;\n+                serverReady.countDown();\n@@ -488,2 +497,2 @@\n-    final void startClient(ClientParameters cliParams, boolean newThread)\n-            throws Exception {\n+    final void startClient(ClientParameters cliParams, boolean newThread,\n+            CountDownLatch serverReady) throws Exception {\n@@ -495,1 +504,1 @@\n-                        doClientSide(cliParams);\n+                        doClientSide(cliParams, serverReady);\n@@ -500,1 +509,1 @@\n-                        System.err.println(\"Client died...\");\n+                        System.err.println(\"Client died: \" + e);\n@@ -508,1 +517,1 @@\n-                doClientSide(cliParams);\n+                doClientSide(cliParams, serverReady);\n@@ -511,0 +520,1 @@\n+                System.err.println(\"Client died: \" + e);\n","filename":"test\/jdk\/javax\/net\/ssl\/Stapling\/HttpsUrlConnClient.java","additions":48,"deletions":38,"binary":false,"changes":86,"status":"modified"}]}