{"files":[{"patch":"@@ -3367,1 +3367,1 @@\n-    current->push_cont_fastpath(sender.sp());\n+    current->push_cont_fastpath(sender.unextended_sp());\n","filename":"src\/hotspot\/share\/runtime\/sharedRuntime.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,90 @@\n+\/*\n+* Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+* DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+*\n+* This code is free software; you can redistribute it and\/or modify it\n+* under the terms of the GNU General Public License version 2 only, as\n+* published by the Free Software Foundation.\n+*\n+* This code is distributed in the hope that it will be useful, but WITHOUT\n+* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+* FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+* version 2 for more details (a copy is included in the LICENSE file that\n+* accompanied this code).\n+*\n+* You should have received a copy of the GNU General Public License version\n+* 2 along with this work; if not, write to the Free Software Foundation,\n+* Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+*\n+* Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+* or visit www.oracle.com if you need additional information or have any\n+* questions.\n+*\/\n+\n+\/**\n+* @test\n+* @bug 8372591\n+* @summary Test freeze\/thaw of OSR frame from method with many locals\n+* @requires vm.continuations\n+* @requires vm.compMode != \"Xint\" & vm.compMode != \"Xcomp\"\n+* @modules java.base\/jdk.internal.vm\n+* @library \/test\/lib \/test\/hotspot\/jtreg\n+* @build jdk.test.whitebox.WhiteBox\n+* @run driver jdk.test.lib.helpers.ClassFileInstaller jdk.test.whitebox.WhiteBox\n+* @run main\/othervm -Xbootclasspath\/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI OSRWithManyLocals\n+*\/\n+\n+import jdk.internal.vm.Continuation;\n+import jdk.internal.vm.ContinuationScope;\n+\n+import jdk.test.lib.Asserts;\n+import java.lang.reflect.Method;\n+import jdk.test.whitebox.WhiteBox;\n+\n+public class OSRWithManyLocals {\n+    static final WhiteBox wb = WhiteBox.getWhiteBox();\n+    static final ContinuationScope FOO = new ContinuationScope() {};\n+    static final Method foo = getMethod(\"foo\");\n+\n+    public static void main(String[] args) throws Exception {\n+        runCont(new Continuation(FOO, () -> warmUp()));\n+        runCont(new Continuation(FOO, () -> foo()));\n+    }\n+\n+    public static void runCont(Continuation cont) {\n+        while (!cont.isDone()) {\n+            cont.run();\n+        }\n+    }\n+\n+    public static void warmUp() {\n+        \/\/ Trigger compilation of Continuation.yield\/yield0\n+        for (int i = 0; i < 10_000; i++) {\n+            Continuation.yield(FOO);\n+        }\n+    }\n+\n+    public static void foo() {\n+        \/\/ Declare lots of locals so that size of OSR foo + Continuation.yield\/yield0\n+        \/\/ frames is less than (foo_sender.unextended_sp() - foo_sender.sp()).\n+        double d1=1,d2=2,d3=3,d4=4,d5=5,d6=6,d7=7,d8=8,d9=9,d10=10,d11=11,d12=12,d13=13,d14=14,d15=15,d16=16,d17=17,d18=18;\n+        double d19=19,d20=20,d21=21,d22=22,d23=23,d24=24,d25=25,d26=26,d27=27,d28=28,d29=29,d30=30,d31=31,d32=32,d33=33,d34=34;\n+        double d35=35,d36=36,d37=37,d38=38,d39=39,d40=40,d41=41,d42=42,d43=43,d44=44,d45=45,d46=46,d47=47,d48=48,d49=49,d50=50;\n+        double d51=51,d52=52,d53=53,d54=54,d55=55,d56=56,d57=57,d58=58,d59=59,d60=60,d61=61,d62=62,d63=63,d64=64,d65=65,d66=66;\n+        double d67=67,d68=68,d69=69,d70=70,d71=71,d72=72,d73=73,d74=74,d75=75,d76=76,d77=77,d78=78,d79=79,d80=80,d81=81,d82=82;\n+\n+        \/\/ Provoke OSR compilation. After we verified the method was compiled keep looping\n+        \/\/ until we trigger the _backedge_counter overflow to actually trigger OSR.\n+        for (int i = 0; !wb.isMethodCompiled(foo, true) || i++ < 2_000;) {\n+        }\n+        Continuation.yield(FOO);\n+    }\n+\n+    static Method getMethod(String method) {\n+        try {\n+            return OSRWithManyLocals.class.getMethod(method);\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Exception: couldn't found method \" + method + \". \" + e.getMessage());\n+        }\n+    }\n+}\n","filename":"test\/jdk\/jdk\/internal\/vm\/Continuation\/OSRWithManyLocals.java","additions":90,"deletions":0,"binary":false,"changes":90,"status":"added"}]}