{"files":[{"patch":"@@ -38,0 +38,2 @@\n+\n+import java.net.SocketTimeoutException;\n@@ -85,8 +87,4 @@\n-            futures.add(executorService.submit(() -> { attemptConnect(env); return null; }));\n-            futures.add(executorService.submit(() -> { attemptConnect(env); return null; }));\n-            futures.add(executorService.submit(() -> { attemptConnect(env); return null; }));\n-            futures.add(executorService.submit(() -> { attemptConnect(env); return null; }));\n-            futures.add(executorService.submit(() -> { attemptConnect(env); return null; }));\n-            futures.add(executorService.submit(() -> { attemptConnect(env); return null; }));\n-            futures.add(executorService.submit(() -> { attemptConnect(env); return null; }));\n-            futures.add(executorService.submit(() -> { attemptConnect(env); return null; }));\n+            \/\/ launch a few concurrent connection attempts\n+            for (int i = 0; i < 8; i++) {\n+                futures.add(executorService.submit(() -> { attemptConnect(env); return null; }));\n+            }\n@@ -112,15 +110,29 @@\n-            LdapTimeoutTest.assertCompletion(CONNECT_MILLIS - 1000,\n-                   2 * CONNECT_MILLIS + TOLERANCE,\n-                   () -> new InitialDirContext(env));\n-        } catch (RuntimeException e) {\n-            final String msg = e.getCause() == null ? e.getMessage() : e.getCause().getMessage();\n-            \/\/ assertCompletion may wrap a CommunicationException in an RTE\n-            if (msg != null &&\n-                    (msg.contains(\"Network is unreachable\")\n-                            || msg.contains(\"No route to host\")\n-                            || msg.contains(\"Connection timed out\"))) {\n-                \/\/ got the expected exception\n-                System.out.println(\"Received expected RuntimeException message: \" + msg);\n-            } else {\n-                \/\/ propagate the unexpected exception\n-                throw e;\n+            final InitialDirContext unexpectedCtx =\n+                    LdapTimeoutTest.assertCompletion(CONNECT_MILLIS - 1000,\n+                            2 * CONNECT_MILLIS + TOLERANCE,\n+                            () -> new InitialDirContext(env));\n+            throw new RuntimeException(\"InitialDirContext construction was expected to fail,\" +\n+                    \" but returned \" + unexpectedCtx);\n+        } catch (Throwable t) {\n+            final NamingException namingEx = findNamingException(t);\n+            if (namingEx != null) {\n+                \/\/ found the NamingException, verify it's the right reason\n+                if (namingEx.getCause() instanceof SocketTimeoutException ste) {\n+                    \/\/ got the expected exception\n+                    System.out.println(\"Received expected SocketTimeoutException: \" + ste);\n+                    return;\n+                }\n+                \/\/ rely on the exception message to verify the expected exception\n+                final String msg = namingEx.getCause() == null\n+                        ? namingEx.getMessage()\n+                        : namingEx.getCause().getMessage();\n+                if (msg != null &&\n+                        (msg.contains(\"Network is unreachable\")\n+                                || msg.contains(\"No route to host\")\n+                                || msg.contains(\"Timed out waiting for lock\")\n+                                || msg.contains(\"Connect timed out\")\n+                                || msg.contains(\"Timeout exceeded while waiting for a connection\"))) {\n+                    \/\/ got the expected exception\n+                    System.out.println(\"Received expected NamingException with message: \" + msg);\n+                    return;\n+                }\n@@ -128,9 +140,3 @@\n-        } catch (NamingException ex) {\n-            final String msg = ex.getCause() == null ? ex.getMessage() : ex.getCause().getMessage();\n-            if (msg != null &&\n-                    (msg.contains(\"Network is unreachable\")\n-                        || msg.contains(\"Timed out waiting for lock\")\n-                        || msg.contains(\"Connect timed out\")\n-                        || msg.contains(\"Timeout exceeded while waiting for a connection\"))) {\n-                \/\/ got the expected exception\n-                System.out.println(\"Received expected NamingException message: \" + msg);\n+            \/\/ unexpected exception, propagate it\n+            if (t instanceof Exception e) {\n+                throw e;\n@@ -138,2 +144,1 @@\n-                \/\/ propagate the unexpected exception\n-                throw ex;\n+                throw new Exception(t);\n@@ -141,2 +146,0 @@\n-        } catch (Throwable t) {\n-            throw new RuntimeException(t);\n@@ -146,0 +149,12 @@\n+    \/\/ Find and return the NamingException from the given Throwable. Returns null if none found.\n+    private static NamingException findNamingException(final Throwable t) {\n+        Throwable cause = t;\n+        while (cause != null) {\n+            if (cause instanceof NamingException ne) {\n+                return ne;\n+            }\n+            cause = cause.getCause();\n+        }\n+        return null;\n+    }\n+\n","filename":"test\/jdk\/com\/sun\/jndi\/ldap\/LdapPoolTimeoutTest.java","additions":51,"deletions":36,"binary":false,"changes":87,"status":"modified"}]}