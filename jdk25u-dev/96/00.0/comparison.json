{"files":[{"patch":"@@ -1973,1 +1973,1 @@\n-void nmethod::log_state_change(ChangeReason change_reason) const {\n+void nmethod::log_state_change(InvalidationReason invalidation_reason) const {\n@@ -1978,1 +1978,1 @@\n-                       os::current_thread_id(), change_reason_to_string(change_reason));\n+                       os::current_thread_id(), invalidation_reason_to_string(invalidation_reason));\n@@ -1987,1 +1987,1 @@\n-  ss.print(\"made not entrant: %s\", change_reason_to_string(change_reason));\n+  ss.print(\"made not entrant: %s\", invalidation_reason_to_string(invalidation_reason));\n@@ -2002,1 +2002,1 @@\n-bool nmethod::make_not_entrant(ChangeReason change_reason) {\n+bool nmethod::make_not_entrant(InvalidationReason invalidation_reason) {\n@@ -2060,1 +2060,1 @@\n-    log_state_change(change_reason);\n+    log_state_change(invalidation_reason);\n@@ -2071,1 +2071,1 @@\n-    nmethod_data->invalidate_nmethod_mirror(this);\n+    nmethod_data->invalidate_nmethod_mirror(this, invalidation_reason);\n@@ -2109,1 +2109,3 @@\n-    nmethod_data->invalidate_nmethod_mirror(this);\n+    nmethod_data->invalidate_nmethod_mirror(this, is_cold() ?\n+            nmethod::InvalidationReason::UNLOADING_COLD :\n+            nmethod::InvalidationReason::UNLOADING);\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":9,"deletions":7,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -474,23 +474,26 @@\n-  enum class ChangeReason : u1 {\n-    C1_codepatch,\n-    C1_deoptimize,\n-    C1_deoptimize_for_patching,\n-    C1_predicate_failed_trap,\n-    CI_replay,\n-    JVMCI_invalidate_nmethod,\n-    JVMCI_invalidate_nmethod_mirror,\n-    JVMCI_materialize_virtual_object,\n-    JVMCI_new_installation,\n-    JVMCI_register_method,\n-    JVMCI_replacing_with_new_code,\n-    JVMCI_reprofile,\n-    marked_for_deoptimization,\n-    missing_exception_handler,\n-    not_used,\n-    OSR_invalidation_back_branch,\n-    OSR_invalidation_for_compiling_with_C1,\n-    OSR_invalidation_of_lower_level,\n-    set_native_function,\n-    uncommon_trap,\n-    whitebox_deoptimization,\n-    zombie,\n+  \/\/ If you change anything in this enum please patch\n+  \/\/ vmStructs_jvmci.cpp accordingly.\n+  enum class InvalidationReason : s1 {\n+    NOT_INVALIDATED = -1,\n+    C1_CODEPATCH,\n+    C1_DEOPTIMIZE,\n+    C1_DEOPTIMIZE_FOR_PATCHING,\n+    C1_PREDICATE_FAILED_TRAP,\n+    CI_REPLAY,\n+    UNLOADING,\n+    UNLOADING_COLD,\n+    JVMCI_INVALIDATE,\n+    JVMCI_MATERIALIZE_VIRTUAL_OBJECT,\n+    JVMCI_REPLACED_WITH_NEW_CODE,\n+    JVMCI_REPROFILE,\n+    MARKED_FOR_DEOPTIMIZATION,\n+    MISSING_EXCEPTION_HANDLER,\n+    NOT_USED,\n+    OSR_INVALIDATION_BACK_BRANCH,\n+    OSR_INVALIDATION_FOR_COMPILING_WITH_C1,\n+    OSR_INVALIDATION_OF_LOWER_LEVEL,\n+    SET_NATIVE_FUNCTION,\n+    UNCOMMON_TRAP,\n+    WHITEBOX_DEOPTIMIZATION,\n+    ZOMBIE,\n+    INVALIDATION_REASONS_COUNT\n@@ -500,3 +503,3 @@\n-  static const char* change_reason_to_string(ChangeReason change_reason) {\n-    switch (change_reason) {\n-      case ChangeReason::C1_codepatch:\n+  static const char* invalidation_reason_to_string(InvalidationReason invalidation_reason) {\n+    switch (invalidation_reason) {\n+      case InvalidationReason::C1_CODEPATCH:\n@@ -504,1 +507,1 @@\n-      case ChangeReason::C1_deoptimize:\n+      case InvalidationReason::C1_DEOPTIMIZE:\n@@ -506,1 +509,1 @@\n-      case ChangeReason::C1_deoptimize_for_patching:\n+      case InvalidationReason::C1_DEOPTIMIZE_FOR_PATCHING:\n@@ -508,1 +511,1 @@\n-      case ChangeReason::C1_predicate_failed_trap:\n+      case InvalidationReason::C1_PREDICATE_FAILED_TRAP:\n@@ -510,1 +513,1 @@\n-      case ChangeReason::CI_replay:\n+      case InvalidationReason::CI_REPLAY:\n@@ -512,5 +515,3 @@\n-      case ChangeReason::JVMCI_invalidate_nmethod:\n-        return \"JVMCI invalidate nmethod\";\n-      case ChangeReason::JVMCI_invalidate_nmethod_mirror:\n-        return \"JVMCI invalidate nmethod mirror\";\n-      case ChangeReason::JVMCI_materialize_virtual_object:\n+      case InvalidationReason::JVMCI_INVALIDATE:\n+        return \"JVMCI invalidate\";\n+      case InvalidationReason::JVMCI_MATERIALIZE_VIRTUAL_OBJECT:\n@@ -518,7 +519,3 @@\n-      case ChangeReason::JVMCI_new_installation:\n-        return \"JVMCI new installation\";\n-      case ChangeReason::JVMCI_register_method:\n-        return \"JVMCI register method\";\n-      case ChangeReason::JVMCI_replacing_with_new_code:\n-        return \"JVMCI replacing with new code\";\n-      case ChangeReason::JVMCI_reprofile:\n+      case InvalidationReason::JVMCI_REPLACED_WITH_NEW_CODE:\n+        return \"JVMCI replaced with new code\";\n+      case InvalidationReason::JVMCI_REPROFILE:\n@@ -526,1 +523,1 @@\n-      case ChangeReason::marked_for_deoptimization:\n+      case InvalidationReason::MARKED_FOR_DEOPTIMIZATION:\n@@ -528,1 +525,1 @@\n-      case ChangeReason::missing_exception_handler:\n+      case InvalidationReason::MISSING_EXCEPTION_HANDLER:\n@@ -530,1 +527,1 @@\n-      case ChangeReason::not_used:\n+      case InvalidationReason::NOT_USED:\n@@ -532,1 +529,1 @@\n-      case ChangeReason::OSR_invalidation_back_branch:\n+      case InvalidationReason::OSR_INVALIDATION_BACK_BRANCH:\n@@ -534,1 +531,1 @@\n-      case ChangeReason::OSR_invalidation_for_compiling_with_C1:\n+      case InvalidationReason::OSR_INVALIDATION_FOR_COMPILING_WITH_C1:\n@@ -536,1 +533,1 @@\n-      case ChangeReason::OSR_invalidation_of_lower_level:\n+      case InvalidationReason::OSR_INVALIDATION_OF_LOWER_LEVEL:\n@@ -538,1 +535,1 @@\n-      case ChangeReason::set_native_function:\n+      case InvalidationReason::SET_NATIVE_FUNCTION:\n@@ -540,1 +537,1 @@\n-      case ChangeReason::uncommon_trap:\n+      case InvalidationReason::UNCOMMON_TRAP:\n@@ -542,1 +539,1 @@\n-      case ChangeReason::whitebox_deoptimization:\n+      case InvalidationReason::WHITEBOX_DEOPTIMIZATION:\n@@ -544,1 +541,1 @@\n-      case ChangeReason::zombie:\n+      case InvalidationReason::ZOMBIE:\n@@ -715,2 +712,2 @@\n-  bool  make_not_entrant(ChangeReason change_reason);\n-  bool  make_not_used() { return make_not_entrant(ChangeReason::not_used); }\n+  bool  make_not_entrant(InvalidationReason invalidation_reason);\n+  bool  make_not_used() { return make_not_entrant(InvalidationReason::NOT_USED); }\n@@ -1030,1 +1027,1 @@\n-  void log_state_change(ChangeReason change_reason) const;\n+  void log_state_change(InvalidationReason invalidation_reason) const;\n","filename":"src\/hotspot\/share\/code\/nmethod.hpp","additions":52,"deletions":55,"binary":false,"changes":107,"status":"modified"},{"patch":"@@ -805,1 +805,1 @@\n-                nm->make_not_entrant(nmethod::ChangeReason::whitebox_deoptimization);\n+                nm->make_not_entrant(nmethod::InvalidationReason::WHITEBOX_DEOPTIMIZATION);\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1835,1 +1835,1 @@\n-  nm->make_not_entrant(nmethod::ChangeReason::missing_exception_handler);\n+  nm->make_not_entrant(nmethod::InvalidationReason::MISSING_EXCEPTION_HANDLER);\n@@ -2464,1 +2464,1 @@\n-      if (!nm->make_not_entrant(nmethod::ChangeReason::uncommon_trap)) {\n+      if (!nm->make_not_entrant(nmethod::InvalidationReason::UNCOMMON_TRAP)) {\n","filename":"src\/hotspot\/share\/runtime\/deoptimization.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}