{"files":[{"patch":"@@ -920,1 +920,1 @@\n-#endif\n+#endif \/\/ AMD64\n@@ -922,1 +922,1 @@\n-#endif \/\/ !LINUX\n+#endif \/\/ LINUX\n@@ -956,1 +956,1 @@\n-#endif\n+#endif \/\/ LINUX\n@@ -2588,1 +2588,1 @@\n-                \"If you are sure it will not crash you can override this check by -XX:+UnlockExperimentalVMOptions -XX:+IgnoreCPUFeatures .\",\n+                \"If you are sure it will not crash you can override this check by -XX:+UnlockExperimentalVMOptions -XX:CheckCPUFeatures=ignore .\",\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -584,0 +584,1 @@\n+  { \"IgnoreCPUFeatures\",            JDK_Version::jdk(26), JDK_Version::jdk(29), JDK_Version::undefined() },\n@@ -4072,0 +4073,9 @@\n+\n+  if (IgnoreCPUFeatures) {\n+    if (FLAG_IS_DEFAULT(CheckCPUFeatures)) {\n+      FLAG_SET_ERGO(CheckCPUFeatures, \"skip\");\n+    } else {\n+      vm_exit_during_initialization(err_msg(\"Cannot set both -XX:+IgnoreCPUFeatures and -XX:CheckCPUFeatures=%s\", CheckCPUFeatures));\n+    }\n+  }\n+\n","filename":"src\/hotspot\/share\/runtime\/arguments.cpp","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -815,1 +815,17 @@\n-  if (!VM_Version::ignore_cpu_features() && !IgnoreCPUFeatures) {\n+  bool ignore = VM_Version::ignore_cpu_features();\n+  bool exact = false;\n+  if (CheckCPUFeatures == nullptr) {\n+    \/\/ default, compatible\n+  } else if (!strcmp(CheckCPUFeatures, \"skip\")) {\n+    if (!UnlockExperimentalVMOptions) {\n+      log_error(crac)(\"-XX:CheckCPUFeatures=skip is allowed only with -XX:+UnlockExperimentalVMOptions\");\n+      return;\n+    }\n+    ignore = true;\n+  } else if (!strcmp(CheckCPUFeatures, \"exact\")) {\n+    exact = true;\n+  } else if (strcmp(CheckCPUFeatures, \"compatible\")) {\n+    log_error(crac)(\"Invalid value for -XX:CheckCPUFeatures=%s; available are 'compatible', 'exact' or 'skip'\", CheckCPUFeatures);\n+    return;\n+  }\n+  if (!ignore) {\n@@ -820,1 +836,1 @@\n-          engine.require_cpuinfo(&data);\n+          engine.require_cpuinfo(&data, exact);\n","filename":"src\/hotspot\/share\/runtime\/crac.cpp","additions":18,"deletions":2,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -439,1 +439,1 @@\n-void CracEngine::require_cpuinfo(const VM_Version::VM_Features *datap) const {\n+void CracEngine::require_cpuinfo(const VM_Version::VM_Features *datap, bool exact) const {\n@@ -443,1 +443,1 @@\n-    reinterpret_cast<const unsigned char *>(datap), sizeof(*datap), SUBSET);\n+    reinterpret_cast<const unsigned char *>(datap), sizeof(*datap), exact ? EQUALS : SUBSET);\n","filename":"src\/hotspot\/share\/runtime\/crac_engine.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -73,1 +73,1 @@\n-  void require_cpuinfo(const VM_Version::VM_Features *datap) const;\n+  void require_cpuinfo(const VM_Version::VM_Features *datap, bool exact) const;\n","filename":"src\/hotspot\/share\/runtime\/crac_engine.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2048,0 +2048,7 @@\n+  product(ccstr, CheckCPUFeatures, nullptr, RESTORE_SETTABLE,                \\\n+          \"Set requirements for CPU features check: \"                       \\\n+          \"compatible: image must be runnable on this CPU (default), \"      \\\n+          \"exact: image must use the very same features as this CPU, \"      \\\n+          \"skip: don't check features at all (requires \"                    \\\n+          \"-XX:+UnlockExperimentalVMOptions).\")                             \\\n+                                                                            \\\n","filename":"src\/hotspot\/share\/runtime\/globals.hpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -1907,4 +1907,12 @@\n-`-XX:+IgnoreCPUFeatures`\n-:   Skip any verifications of `-XX:CPUFeatures`. It may lead to a crash\n-    if `-XX:CRaCRestoreFrom` is used on a CPU with less features than the CPU\n-    where `-XX:CRaCCheckpointTo` was made.\n+`-XX:CheckCPUFeatures=`*check*\n+:   Set requirements for CPU features check:\n+\n+    `compatible`\n+    :   The image must be runnable on this CPU (default).\n+\n+    `exact`\n+    :   The image must use the very same features as this CPU.\n+\n+    `skip`\n+    :   Don't check features at all. This option is allowed only when\n+        `-XX:+UnlockExperimentalVMOptions` is used.\n","filename":"src\/java.base\/share\/man\/java.md","additions":12,"deletions":4,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023,2025, Azul Systems, Inc. All rights reserved.\n+ * Copyright (c) 2023, 2025, Azul Systems, Inc. All rights reserved.\n","filename":"test\/jdk\/jdk\/crac\/CPUFeatures\/SimpleCPUFeaturesTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,96 @@\n+\/*\n+ * Copyright (c) 2025, Azul Systems, Inc. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Azul Systems, 385 Moffett Park Drive, Suite 115, Sunnyvale\n+ * CA 94089 USA or visit www.azul.com if you need additional information or\n+ * have any questions.\n+ *\/\n+\n+import jdk.crac.Core;\n+import jdk.test.lib.Platform;\n+import jdk.test.lib.crac.CracBuilder;\n+import jdk.test.lib.crac.CracEngine;\n+import jdk.test.lib.crac.CracProcess;\n+import jdk.test.lib.crac.CracTest;\n+import jdk.test.lib.crac.CracTestArg;\n+import jdk.test.lib.util.FileUtils;\n+\n+import static jdk.test.lib.Asserts.*;\n+\n+\/*\n+ * @test\n+ * @summary Check combinations of CPUFeatures and CheckCPUFeatures VM options\n+ * @requires (os.family == \"linux\")\n+ * @library \/test\/lib\n+ * @build CheckCPUFeaturesTest\n+ * @run driver jdk.test.lib.crac.CracTest native  compatible        pass\n+ * @run driver jdk.test.lib.crac.CracTest native  exact             pass\n+ * @run driver jdk.test.lib.crac.CracTest native  skip              fail\n+ * @run driver jdk.test.lib.crac.CracTest native  skip-experimental pass\n+ * @run driver jdk.test.lib.crac.CracTest generic compatible        pass\n+ * @run driver jdk.test.lib.crac.CracTest generic exact             fail-x86\n+ * @run driver jdk.test.lib.crac.CracTest generic skip              fail\n+ * @run driver jdk.test.lib.crac.CracTest generic skip-experimental pass\n+ * @run driver jdk.test.lib.crac.CracTest ignore  compatible        fail-x86\n+ * @run driver jdk.test.lib.crac.CracTest ignore  exact             fail-x86\n+ * @run driver jdk.test.lib.crac.CracTest ignore  skip              fail\n+ * @run driver jdk.test.lib.crac.CracTest ignore  skip-experimental pass\n+ *\/\n+public class CheckCPUFeaturesTest implements CracTest {\n+    @CracTestArg(0)\n+    private String features;\n+\n+    @CracTestArg(1)\n+    private String check;\n+\n+    @CracTestArg(2)\n+    private String result;\n+\n+    @Override\n+    public void test() throws Exception {\n+        CracBuilder builder = new CracBuilder().engine(CracEngine.PAUSE);\n+        if (builder.imageDir().toFile().exists()) {\n+            FileUtils.deleteFileTreeWithRetry(builder.imageDir());\n+        }\n+        CracProcess checkpoint = builder.vmOption(\"-XX:CPUFeatures=\" + features).startCheckpoint();\n+        checkpoint.waitForPausePid();\n+\n+        builder.clearVmOptions();\n+        if (\"skip-experimental\".equals(check)) {\n+            builder.vmOption(\"-XX:+UnlockExperimentalVMOptions\");\n+            check = \"skip\";\n+        }\n+        CracProcess restore = builder.vmOption(\"-XX:CheckCPUFeatures=\" + check).startRestore();\n+        boolean success = \"pass\".equals(result);\n+        if (!Platform.isX86() && !Platform.isX64()) {\n+            success = success || \"fail-x86\".equals(result);\n+        }\n+        if (success) {\n+            restore.waitForSuccess();\n+            checkpoint.waitForSuccess();\n+        } else {\n+            assertEquals(1, restore.waitFor());\n+            checkpoint.destroyForcibly();\n+        }\n+    }\n+\n+    @Override\n+    public void exec() throws Exception {\n+        Core.checkpointRestore();\n+    }\n+}\n","filename":"test\/jdk\/jdk\/crac\/engine\/CheckCPUFeaturesTest.java","additions":96,"deletions":0,"binary":false,"changes":96,"status":"added"}]}