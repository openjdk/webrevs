{"files":[{"patch":"@@ -66,0 +66,3 @@\n+\n+  \/\/ For failed require_bitmap it will copy the expected value to the provided buffer.\n+  bool (*get_failed_bitmap)(crlib_conf_t *, const char *name, unsigned char *value_return, size_t value_size);\n","filename":"src\/hotspot\/share\/include\/crlib\/crlib_image_constraints.h","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -455,2 +455,7 @@\n-    ResourceMark rm;\n-    log_error(crac)(\"Restore failed due to incompatible or missing CPU features, try using -XX:CPUFeatures=%s on checkpoint.\", datap->print_numbers());\n+    VM_Version::VM_Features intersection;\n+    if (_image_constraints_api->get_failed_bitmap(_conf, cpufeatures_name, reinterpret_cast<unsigned char *>(&intersection), sizeof(intersection))) {\n+      ResourceMark rm;\n+      log_error(crac)(\"Restore failed due to incompatible or missing CPU features, try using -XX:CPUFeatures=%s on checkpoint.\", intersection.print_numbers());\n+    } else {\n+      log_error(crac)(\"Restore failed due to incompatible or missing CPU features.\");\n+    }\n","filename":"src\/hotspot\/share\/runtime\/crac_engine.cpp","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -83,0 +83,1 @@\n+static bool get_failed_bitmap(crlib_conf_t *, const char *name, unsigned char *value_return, size_t value_size);\n@@ -140,0 +141,1 @@\n+  get_failed_bitmap,\n@@ -633,0 +635,4 @@\n+static bool get_failed_bitmap(crlib_conf_t *conf, const char *name, unsigned char *value_return, size_t value_size) {\n+  return conf->image_constraints().get_failed_bitmap(name, value_return, value_size);\n+}\n+\n","filename":"src\/java.base\/share\/native\/libcrexec\/crexec.cpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -284,2 +284,12 @@\n-      print_bitmap(\"Constraint: \", static_cast<const unsigned char*>(c.data), c.data_size);\n-      print_bitmap(\"Image:      \", static_cast<const unsigned char*>(t->data), t->data_size);\n+      print_bitmap(\"Constraint:   \", static_cast<const unsigned char*>(c.data), c.data_size);\n+      print_bitmap(\"Image:        \", static_cast<const unsigned char*>(t->data), t->data_size);\n+      if (c.comparison == SUBSET) {\n+        free((void *) c.intersection);\n+        c.intersection = malloc(c.data_size);\n+        for (size_t ix = 0; ix < c.data_size; ++ix) {\n+          const_cast<unsigned char*>(static_cast<const unsigned char*>(c.intersection))[ix]\n+            = static_cast<const unsigned char*>(c.data)[ix]\n+            & (ix >= t->data_size ? 0 : static_cast<const unsigned char*>(t->data)[ix]);\n+        }\n+        print_bitmap(\"Intersection: \", static_cast<const unsigned char*>(c.intersection), c.data_size);\n+      }\n","filename":"src\/java.base\/share\/native\/libcrexec\/image_constraints.cpp","additions":12,"deletions":2,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -83,0 +83,1 @@\n+    const void* intersection; \/\/ data_size\n@@ -86,1 +87,1 @@\n-      type(t), failed(false), name(n), data(d), data_size(ds), comparison(c) {}\n+      type(t), failed(false), name(n), data(d), data_size(ds), intersection(nullptr), comparison(c) {}\n@@ -93,0 +94,1 @@\n+      intersection = o.intersection;\n@@ -101,0 +103,1 @@\n+      free((void *) intersection);\n@@ -139,0 +142,13 @@\n+  bool get_failed_bitmap(const char* name, unsigned char *value_return, size_t value_size) const {\n+    bool result = false;\n+    _constraints.foreach([&](Constraint &c) {\n+      if (!strcmp(c.name, name) && c.failed) {\n+        result = true;\n+        if (value_return && c.intersection && value_size == c.data_size) {\n+          memcpy(value_return, c.intersection, c.data_size);\n+        }\n+      }\n+    });\n+    return result;\n+  }\n+\n","filename":"src\/java.base\/share\/native\/libcrexec\/image_constraints.hpp","additions":17,"deletions":1,"binary":false,"changes":18,"status":"modified"}]}