{"files":[{"patch":"@@ -65,0 +65,2 @@\n+  bool (*is_failed)(crlib_conf_t *, const char *name);\n+\n@@ -66,1 +68,1 @@\n-  bool (*is_failed)(crlib_conf_t *, const char *name, unsigned char *value_return);\n+  bool (*get_failed_bitmap)(crlib_conf_t *, const char *name, unsigned char *value_return, size_t value_size);\n","filename":"src\/hotspot\/share\/include\/crlib\/crlib_image_constraints.h","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -451,1 +451,1 @@\n-  if (_image_constraints_api->is_failed(_conf, cpuarch_name, nullptr)) {\n+  if (_image_constraints_api->is_failed(_conf, cpuarch_name)) {\n@@ -454,4 +454,8 @@\n-  VM_Version::VM_Features conjunction;\n-  if (_image_constraints_api->is_failed(_conf, cpufeatures_name, reinterpret_cast<unsigned char *>(&conjunction))) {\n-    ResourceMark rm;\n-    log_error(crac)(\"Restore failed due to incompatible or missing CPU features, try using -XX:CPUFeatures=%s on checkpoint.\", conjunction.print_numbers());\n+  if (_image_constraints_api->is_failed(_conf, cpufeatures_name)) {\n+    VM_Version::VM_Features intersection;\n+    if (_image_constraints_api->get_failed_bitmap(_conf, cpufeatures_name, reinterpret_cast<unsigned char *>(&intersection), sizeof(intersection))) {\n+      ResourceMark rm;\n+      log_error(crac)(\"Restore failed due to incompatible or missing CPU features, try using -XX:CPUFeatures=%s on checkpoint.\", intersection.print_numbers());\n+    } else {\n+      log_error(crac)(\"Restore failed due to incompatible or missing CPU features.\");\n+    }\n","filename":"src\/hotspot\/share\/runtime\/crac_engine.cpp","additions":9,"deletions":5,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -82,1 +82,2 @@\n-static bool is_failed(crlib_conf_t *, const char *name, unsigned char *value_return);\n+static bool is_failed(crlib_conf_t *, const char *name);\n+static bool get_failed_bitmap(crlib_conf_t *, const char *name, unsigned char *value_return, size_t value_size);\n@@ -140,0 +141,1 @@\n+  get_failed_bitmap,\n@@ -629,2 +631,6 @@\n-static bool is_failed(crlib_conf_t *conf, const char *name, unsigned char *value_return) {\n-  return conf->image_constraints().is_failed(name, value_return);\n+static bool is_failed(crlib_conf_t *conf, const char *name) {\n+  return conf->image_constraints().is_failed(name);\n+}\n+\n+static bool get_failed_bitmap(crlib_conf_t *conf, const char *name, unsigned char *value_return, size_t value_size) {\n+  return conf->image_constraints().get_failed_bitmap(name, value_return, value_size);\n","filename":"src\/java.base\/share\/native\/libcrexec\/crexec.cpp","additions":9,"deletions":3,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -284,5 +284,5 @@\n-      print_bitmap(\"Constraint:  \", static_cast<const unsigned char*>(c.data), c.data_size);\n-      print_bitmap(\"Image:       \", static_cast<const unsigned char*>(t->data), t->data_size);\n-      if (c.comparison != EQUALS) {\n-        free((void *) c.conjunction);\n-        c.conjunction = malloc(c.data_size);\n+      print_bitmap(\"Constraint:   \", static_cast<const unsigned char*>(c.data), c.data_size);\n+      print_bitmap(\"Image:        \", static_cast<const unsigned char*>(t->data), t->data_size);\n+      if (c.comparison == SUBSET) {\n+        free((void *) c.intersection);\n+        c.intersection = malloc(c.data_size);\n@@ -290,1 +290,1 @@\n-          const_cast<unsigned char*>(static_cast<const unsigned char*>(c.conjunction))[ix]\n+          const_cast<unsigned char*>(static_cast<const unsigned char*>(c.intersection))[ix]\n@@ -294,1 +294,1 @@\n-        print_bitmap(\"Conjunction: \", static_cast<const unsigned char*>(c.conjunction), c.data_size);\n+        print_bitmap(\"Intersection: \", static_cast<const unsigned char*>(c.intersection), c.data_size);\n","filename":"src\/java.base\/share\/native\/libcrexec\/image_constraints.cpp","additions":7,"deletions":7,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -83,1 +83,1 @@\n-    const void* conjunction; \/\/ data_size\n+    const void* intersection; \/\/ data_size\n@@ -87,1 +87,1 @@\n-      type(t), failed(false), name(n), data(d), data_size(ds), conjunction(nullptr), comparison(c) {}\n+      type(t), failed(false), name(n), data(d), data_size(ds), intersection(nullptr), comparison(c) {}\n@@ -94,1 +94,1 @@\n-      conjunction = o.conjunction;\n+      intersection = o.intersection;\n@@ -103,1 +103,1 @@\n-      free((void *) conjunction);\n+      free((void *) intersection);\n@@ -132,1 +132,1 @@\n-  bool is_failed(const char* name, unsigned char *value_return) const {\n+  bool is_failed(const char* name) const {\n@@ -137,2 +137,12 @@\n-        if (value_return && c.conjunction) {\n-          memcpy(value_return, c.conjunction, c.data_size);\n+      }\n+    });\n+    return result;\n+  }\n+\n+  bool get_failed_bitmap(const char* name, unsigned char *value_return, size_t value_size) const {\n+    bool result = false;\n+    _constraints.foreach([&](Constraint &c) {\n+      if (!strcmp(c.name, name) && c.failed) {\n+        result = true;\n+        if (value_return && c.intersection && value_size == c.data_size) {\n+          memcpy(value_return, c.intersection, c.data_size);\n","filename":"src\/java.base\/share\/native\/libcrexec\/image_constraints.hpp","additions":17,"deletions":7,"binary":false,"changes":24,"status":"modified"}]}