{"files":[{"patch":"@@ -711,1 +711,1 @@\n-  return _engine->prepare_image_constraints_api() == CracEngine::ApiStatus::OK;\n+  return _engine != nullptr && _engine->prepare_image_constraints_api() == CracEngine::ApiStatus::OK;\n@@ -715,1 +715,1 @@\n-  if (_engine->prepare_image_constraints_api() != CracEngine::ApiStatus::OK) {\n+  if (_engine == nullptr || _engine->prepare_image_constraints_api() != CracEngine::ApiStatus::OK) {\n@@ -722,1 +722,2 @@\n-  return _engine->prepare_image_score_api() == CracEngine::ApiStatus::OK;\n+  \/\/ The engine is not initialized when CRaCCheckpointTo is not set\n+  return _engine != nullptr && _engine->prepare_image_score_api() == CracEngine::ApiStatus::OK;\n@@ -726,1 +727,1 @@\n-  if (_engine->prepare_image_score_api() != CracEngine::ApiStatus::OK) {\n+  if (_engine == nullptr || _engine->prepare_image_score_api() != CracEngine::ApiStatus::OK) {\n@@ -781,1 +782,1 @@\n-  if (_engine->prepare_image_score_api() != CracEngine::ApiStatus::OK) {\n+  if (_engine == nullptr || _engine->prepare_image_score_api() != CracEngine::ApiStatus::OK) {\n","filename":"src\/hotspot\/share\/runtime\/crac.cpp","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -200,0 +200,4 @@\n+  if (_constraints.size() == 0) {\n+    \/\/ If there are no constraints don't even try to open the file (it's fine if it is missing)\n+    return true;\n+  }\n","filename":"src\/java.base\/share\/native\/libcrexec\/image_constraints.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -0,0 +1,137 @@\n+\/*\n+ * Copyright (c) 2022, Azul Systems, Inc. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import jdk.crac.Core;\n+import jdk.test.lib.crac.CracBuilder;\n+import jdk.test.lib.crac.CracEngine;\n+import jdk.test.lib.crac.CracTest;\n+import jdk.test.lib.crac.CracTestArg;\n+import jdk.test.lib.util.FileUtils;\n+\n+import java.io.File;\n+import java.lang.reflect.Method;\n+import java.nio.file.Path;\n+import java.util.concurrent.Callable;\n+\n+import static jdk.test.lib.Asserts.assertEquals;\n+import static jdk.test.lib.Asserts.assertTrue;\n+\n+\/**\n+ * @test id=CHECKPOINT\n+ * @library \/test\/lib\n+ * @build CheckpointRestorePathTest\n+ * @run driver jdk.test.lib.crac.CracTest testEmpty\n+ * @run driver jdk.test.lib.crac.CracTest testNone\n+ * @run driver jdk.test.lib.crac.CracTest testDeep\n+ *\/\n+\/**\n+ * @test id=RESTORE\n+ * @library \/test\/lib\n+ * @requires (os.family == \"linux\")\n+ * @build CheckpointRestorePathTest\n+ * @run driver jdk.test.lib.crac.CracTest testRestoreEmpty\n+ * @run driver jdk.test.lib.crac.CracTest testRestoreNoDir\n+ * @run driver jdk.test.lib.crac.CracTest testRestoreNoImage\n+ * @run driver jdk.test.lib.crac.CracTest testRestoreNoImageSkipCpuFeaturesCheck\n+ *\/\n+public class CheckpointRestorePathTest implements CracTest {\n+    static final String DEEPLY_NESTED_CR = \"deeply\/nested\/cr\";\n+    static final String NON_EXISTENT_CR = \"non\/existent\/cr\";\n+\n+    @CracTestArg\n+    Method variant;\n+\n+    @Override\n+    public void test() throws Exception {\n+        variant.invoke(this);\n+    }\n+\n+    void testEmpty() throws Exception {\n+        checkNotConfigured(new CracBuilder().engine(CracEngine.SIMULATE).imageDir(\"\"));\n+    }\n+\n+    void testNone() throws Exception {\n+        checkNotConfigured(new CracBuilder().engine(CracEngine.SIMULATE).imageDir(null));\n+    }\n+\n+    void checkNotConfigured(CracBuilder builder) throws Exception {\n+        builder.captureOutput(true)\n+                .startCheckpoint().outputAnalyzer()\n+                .shouldHaveExitValue(1)\n+                .stderrShouldContain(\"C\/R is not configured\");\n+    }\n+\n+    void testDeep() throws Exception {\n+        new CracBuilder().engine(CracEngine.SIMULATE).imageDir(DEEPLY_NESTED_CR).captureOutput(true)\n+                .startCheckpoint().outputAnalyzer()\n+                .shouldHaveExitValue(1)\n+                \/\/ unified logging going to standard output rather than stderr by default\n+                .stdoutShouldContain(\"Cannot create CRaCCheckpointTo=\" + DEEPLY_NESTED_CR);\n+    }\n+\n+    void testRestoreEmpty() throws Exception {\n+        \/\/ Empty CRaCRestoreFrom should result in default java usage output\n+        \/\/ as if the VM option was missing (we won't test that case)\n+        new CracBuilder().engine(CracEngine.PAUSE).imageDir(\"\").captureOutput(true)\n+                .startRestore().outputAnalyzer()\n+                .shouldHaveExitValue(1)\n+                .stderrShouldContain(\"Usage: java\");\n+    }\n+\n+    void testRestoreNoDir() throws Exception {\n+        new CracBuilder().engine(CracEngine.PAUSE).imageDir(NON_EXISTENT_CR).captureOutput(true)\n+                .startRestore().outputAnalyzer()\n+                .shouldHaveExitValue(1)\n+                .stdoutShouldContain(\"Cannot open CRaCRestoreFrom=\" + NON_EXISTENT_CR)\n+                .stdoutShouldContain(\"Failed to restore from \" + NON_EXISTENT_CR);\n+    }\n+\n+    void testRestoreNoImage() throws Exception {\n+        testRestoreNoImage(false, \"cannot open cr\/tags\");\n+    }\n+\n+    void testRestoreNoImageSkipCpuFeaturesCheck() throws Exception {\n+        testRestoreNoImage(true, \"pauseengine: fopen pidfile: No such file or directory\");\n+    }\n+\n+    void testRestoreNoImage(boolean skipCpuFeatures, String errMessage) throws Exception {\n+        CracBuilder builder = new CracBuilder().engine(CracEngine.PAUSE);\n+        if (builder.imageDir().toFile().exists()) {\n+            FileUtils.deleteFileTreeWithRetry(builder.imageDir());\n+        }\n+        assertTrue(new File(\"cr\").mkdir());\n+        if (skipCpuFeatures) {\n+            builder.vmOption(\"-XX:+UnlockExperimentalVMOptions\").vmOption(\"-XX:CheckCPUFeatures=skip\");\n+        }\n+        builder.captureOutput(true).startRestore().outputAnalyzer()\n+                .shouldHaveExitValue(1)\n+                .stderrShouldContain(errMessage);\n+    }\n+\n+    @Override\n+    public void exec() throws Exception {\n+        Core.checkpointRestore();\n+    }\n+}\n","filename":"test\/jdk\/jdk\/crac\/CheckpointRestorePathTest.java","additions":137,"deletions":0,"binary":false,"changes":137,"status":"added"},{"patch":"@@ -264,1 +264,3 @@\n-        cmd.add(\"-XX:CRaCCheckpointTo=\" + imageDir);\n+        if (imageDir != null) {\n+            cmd.add(\"-XX:CRaCCheckpointTo=\" + imageDir);\n+        }\n@@ -433,1 +435,3 @@\n-        cmd.add(\"-XX:CRaCRestoreFrom=\" + imageDir);\n+        if (imageDir != null) {\n+            cmd.add(\"-XX:CRaCRestoreFrom=\" + imageDir);\n+        }\n","filename":"test\/lib\/jdk\/test\/lib\/crac\/CracBuilder.java","additions":6,"deletions":2,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -161,0 +161,4 @@\n+            } else if (t == Method.class) {\n+                Method m = testInstance.getClass().getDeclaredMethod(arg);\n+                m.setAccessible(true);\n+                value = m;\n","filename":"test\/lib\/jdk\/test\/lib\/crac\/CracTest.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"}]}