{"files":[{"patch":"@@ -1,35 +0,0 @@\n-\/*\n- * Copyright (c) 2025, Azul Systems, Inc. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-public class CPUFeatures {\n-  public static void main(String[] args) {\n-    for (int i = 0;; ++i) {\n-      System.out.println(\"CPUFeaturesCheck \" + i);\n-      try {\n-        Thread.sleep(1000);\n-      } catch (InterruptedException e) {\n-        Thread.currentThread().interrupt();\n-      }\n-    }\n-  }\n-}\n","filename":"test\/jdk\/jdk\/crac\/CPUFeatures\/CPUFeatures.java","additions":0,"deletions":35,"binary":false,"changes":35,"status":"deleted"},{"patch":"@@ -1,394 +0,0 @@\n-#! \/bin\/sh\n-# Copyright (c) 2025, Azul Systems, Inc. All rights reserved.\n-# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n-#\n-# This code is free software; you can redistribute it and\/or modify it\n-# under the terms of the GNU General Public License version 2 only, as\n-# published by the Free Software Foundation.\n-#\n-# This code is distributed in the hope that it will be useful, but WITHOUT\n-# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n-# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n-# version 2 for more details (a copy is included in the LICENSE file that\n-# accompanied this code).\n-#\n-# You should have received a copy of the GNU General Public License version\n-# 2 along with this work; if not, write to the Free Software Foundation,\n-# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n-#\n-# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n-# or visit www.oracle.com if you need additional information or have any\n-# questions.\n-\n-# @test\n-# @compile CPUFeatures.java\n-# @comment It will be always skipped unless you use jtreg option \"-manual\" which conflicts with JDK's default option \"-automatic\".\n-# @comment Therefore either change it in make\/RunTests.gmk or run jtreg by hand.\n-# @comment Also consider using -J-Djavatest.maxOutputSize=999999999 to capture the whole log.\n-# @run shell\/manual CPUFeatures.sh\n-\n-set -ex\n-# JTReg does not respect shebang, and 'pipefail' is not available in dash: set -o pipefail\n-exec >&2\n-\n-JAVA_HOME=$TESTJAVA\n-javafiles=\"bin\/java bin\/jcmd lib\/jvm.cfg lib\/libcrexec.so lib\/libjava.so lib\/libjimage.so lib\/libjli.so lib\/libjsvml.so lib\/libnet.so lib\/libnio.so lib\/libattach.so lib\/libzip.so lib\/modules lib\/tzdb.dat lib\/server\/classes.jsa lib\/server\/libjvm.so lib\/criuengine lib\/criu conf\/security\/java.security\"\n-qemuimgurl=https:\/\/download.fedoraproject.org\/pub\/fedora\/linux\/releases\/41\/Cloud\/x86_64\/images\/Fedora-Cloud-Base-Generic-41-1.4.x86_64.qcow2\n-qemuimgsumurl=https:\/\/download.fedoraproject.org\/pub\/fedora\/linux\/releases\/41\/Cloud\/x86_64\/images\/Fedora-Cloud-41-1.4-x86_64-CHECKSUM\n-# FIXME: criu need an update for new kernels:\n-#qemuimgurl=https:\/\/download.fedoraproject.org\/pub\/fedora\/linux\/releases\/42\/Cloud\/x86_64\/images\/Fedora-Cloud-Base-Generic-42-1.1.x86_64.qcow2\n-#qemuimgsumurl=https:\/\/download.fedoraproject.org\/pub\/fedora\/linux\/releases\/42\/Cloud\/x86_64\/images\/Fedora-Cloud-42-1.1-x86_64-CHECKSUM\n-qemuimgdir=\/tmp\n-qemuimgfile=$qemuimgdir\/$(basename $qemuimgurl)\n-qemuimgsumfile=$qemuimgdir\/$(basename $qemuimgsumurl)\n-# SHA256 (Fedora-Cloud-Base-Generic.x86_64-40-1.14.qcow2) = ac58f3c35b73272d5986fa6d3bc44fd246b45df4c334e99a07b3bbd00684adee\n-qemuimgsumgrep=\"^SHA256 ($(basename $qemuimgurl)) = \"\n-if ! grep \"$qemuimgsumgrep\" $qemuimgsumfile;then\n-  flock $qemuimgsumfile.lock -c \"wget -O $qemuimgsumfile $qemuimgsumurl\"\n-  if ! grep \"$qemuimgsumgrep\" $qemuimgsumfile;then\n-    echo >&2 \"Failed to download: $qemuimgsumurl\"\n-    exit 1\n-  fi\n-fi\n-\n-checksum()\n-{\n-  (cd $qemuimgdir\n-    grep \"^[^#].*$(basename $qemuimgfile)\" $qemuimgsumfile|sha256sum -c -|grep \"^$(basename $qemuimgurl): OK$\"\n-  )\n-}\n-if ! checksum;then\n-  flock $qemuimgfile.lock -c \"wget -O $qemuimgfile $qemuimgurl\"\n-  if ! checksum;then\n-    echo >&2 \"Failed to download: $qemuimgurl\"\n-    exit 1\n-  fi\n-fi\n-tmpdir=\/tmp\/CPUFeatures.$$\n-rm -rf $tmpdir\n-mkdir $tmpdir\n-qemuimg=$tmpdir\/CPUFeatures.qcow2\n-sshkey=$qemuimg.key\n-mountdir=$qemuimg.d\n-\n-test ! -e $mountdir\n-test ! -e $qemuimg\n-test ! -e $sshkey\n-test ! -e $sshkey.pub\n-ssh-keygen -f $sshkey -N \"\"\n-test -f $sshkey\n-test -f $sshkey.pub\n-qemu-img create -b $qemuimgfile -F qcow2 -f qcow2 $qemuimg\n-test -f $qemuimg\n-mkdir $mountdir\n-LIBGUESTFS_BACKEND=direct guestmount -a $qemuimg -i $mountdir\n-sed -i -e 's\/^options \/&selinux=0 \/' $mountdir\/boot\/loader\/entries\/*.conf\n-sed -i -e 's\/^root:x:\/root::\/' $mountdir\/etc\/passwd\n-cat $sshkey.pub >>$mountdir\/root\/.ssh\/authorized_keys\n-chmod 600 $mountdir\/root\/.ssh\/authorized_keys\n-rm -f $mountdir\/usr\/lib\/systemd\/zram-generator.conf\n-echo kernel.core_pattern=core >>$mountdir\/etc\/sysctl.d\/CPUFeatures.conf\n-guestunmount $mountdir\n-rmdir $mountdir\n-\n-# -nographic may not be suitable for every OS\/image\n-for try in $(seq 1 10);do\n-  # Dash does not have $RANDOM\n-  MY_RANDOM=$(awk 'BEGIN { srand(); printf \"%d\\n\", 32768 * rand() }')\n-  sshport=$(($MY_RANDOM+1024))\n-  sshporthex=$(printf %04X $sshport)\n-  if ! grep -q \"^..............:$sshporthex 00000000:0000 0A \" \/proc\/net\/tcp \\\n-  && ! grep -q \"^....: 00000000000000000000000000000000:$sshporthex 00000000000000000000000000000000:0000 0A \" \/proc\/net\/tcp6 \\\n-  ;then\n-    break\n-  fi\n-  unset sshport\n-done\n-test -n \"$sshport\"\n-\n-qemuimg2=$tmpdir\/CPUFeatures-run.qcow2\n-qemuargs=\"-m 4096 -net nic -net user,hostfwd=tcp::$sshport-:22 -drive format=qcow2,media=disk,cache=unsafe,file=$qemuimg2 -nographic\"\n-\n-runssh() {\n-  ssh -i $sshkey -p $sshport -o \"UserKnownHostsFile \/dev\/null\" -o \"StrictHostKeyChecking no\" -o \"ConnectTimeout $((10*$timeoutmultiply))\" root@127.0.0.1 \"$@\"\n-}\n-# Do not use \/tmp as that may not survive a reboot on some Linux distributions.\n-qemudir=\"\/root\/CPUFeatures\"\n-# in reality it is about 20\n-qemustarttimeout=120\n-for file in $javafiles; do\n-  test -e $JAVA_HOME\/$file\n-done\n-rm -f $qemuimg2\n-\n-missingfiles=true\n-\n-qemucopyfiles() {\n-  missingfiles=false\n-  (cd $JAVA_HOME;tar chf - $(eval echo $javafiles))|runssh \"set -ex;mkdir $qemudir;cd $qemudir;tar xf -;JAVA_HOME=\\$PWD bin\/java -XX:+ShowCPUFeatures --version\"\n-  (cd $TESTCLASSES;tar cf - CPUFeatures.class)|runssh \"set -ex;cd $qemudir;tar xf -\"\n-}\n-qemustarted=\"\"\n-\n-qemustart() {\n-  type=$1\n-  cpu=$2\n-  accel=\"\"\n-  case $type in\n-    kvm)\n-      timeoutmultiply=1\n-      accel=\"-accel kvm\"\n-      ;;\n-    system-x86_64)\n-      timeoutmultiply=6\n-      ;;\n-    *)\n-      fatal \"internal error: unknown type: $1\"\n-      ;;\n-  esac\n-  qemustarted_check=\"$type $cpu\"\n-  if [ \"$qemustarted\" != \"$qemustarted_check\" ];then\n-    if [ ! -e $qemuimg2 ];then\n-      qemuimg2rebuild\n-    fi\n-    qemustop\n-    qemu-system-x86_64 $accel $qemuargs -cpu $cpu <\/dev\/null & qemupid=$!\n-    # If SSH times out it may be a 32-bit arch but still qemu is already running.\n-    qemustarted=\"$qemustarted_check\"\n-    t0=$(date +%s)\n-    while true;do\n-      if [ $(($(date +%s)-$t0)) -ge $(($qemustarttimeout*$timeoutmultiply)) ];then\n-\techo >&2 \"qemu timeout, qemu PID=$qemupid\"\n-\treturn 1\n-      fi\n-      runssh true && break\n-      sleep 1\n-    done\n-  fi\n-  if $missingfiles;then\n-    qemucopyfiles\n-  fi\n-}\n-\n-qemustop() {\n-  if [ -z \"$qemustarted\" ];then\n-    return\n-  fi\n-  runssh poweroff || :\n-  # || kill $qemupid || :\n-  wait || :\n-  qemustarted=\"\"\n-}\n-\n-qemuimg2rebuild() {\n-  qemustop\n-  qemu-img create -b $qemuimg -F qcow2 -f qcow2 $qemuimg2\n-  test -e $qemuimg2\n-  # FIXME: why?\n-  # qemu-kvm: -drive format=qcow2,media=disk,cache=unsafe,file=\/tmp\/CPUFeatures.3035545\/CPUFeatures-run.qcow2: Could not open backing file: Failed to get shared \"write\" lock\n-  # Is another process using the image [\/tmp\/CPUFeatures.3035545\/CPUFeatures.qcow2]?\n-  sleep 1\n-  missingfiles=true\n-}\n-javasetup=\"cd $qemudir;export JAVA_HOME=\\$PWD;ulimit -c unlimited\"\n-\n-checkpoint() {\n-  checkpoint_args=\"$1\"\n-  runssh \"$javasetup;rm -rf cr || exit 1; \\\n-    $(: 'Prevent on CRIU: Error (criu\/pie\/restorer.c:2057): Unable to create a thread: -17') \\\n-    for i in \\$(seq 1 1000);do \/bin\/true;done; \\\n-    bin\/java -XX:CRaCCheckpointTo=cr -XX:+ShowCPUFeatures $checkpoint_args CPUFeatures&p=\\$!;sleep $((3*$timeoutmultiply));bin\/jcmd CPUFeatures JDK.checkpoint; \\\n-    wait \\$p;true\"\n-}\n-\n-restore() {\n-  restore_args=\"$1\"\n-  restore=\"$(runssh \"$javasetup;bin\/java -XX:CRaCRestoreFrom=cr $restore_args&p=\\$!;(sleep $((6*$timeoutmultiply));kill \\$p)&wait \\$p;echo RC=\\$?\" 2>&1|tee \/proc\/self\/fd\/2)\"\n-}\n-failfile=$tmpdir\/failfile\n-rm -f $failfile\n-\n-checkpoint_restore() {\n-  kind_checkpoint=\"$1\"\n-  kind_restore=\"$2\"\n-  check=\"${3:-CPUFeaturesCheck }\"\n-  checkpoint_args=\"$4\"\n-  restore_args=\"$5\"\n-  qemuimg2rebuild\n-  qemustart $kind_checkpoint\n-  checkpoint \"$checkpoint_args\"\n-  qemustart $kind_restore\n-  restore \"$restore_args\"\n-  if [ \"$check\" != - ];then\n-    (set +e;echo $restore|grep \"$check\";checkpoint_restore_result)\n-  fi\n-}\n-# SIGTERM+128; see 'kill \\$p' above\n-expectRC=143\n-errorMsg=\"Bitmap mismatch for tag cpu.features\"\n-\n-checkpoint_restore_result() {\n-  rc=$?\n-  if ! echo $restore|grep RC=$expectRC;then\n-    rc=99\n-  fi\n-  set +x\n-  echo\n-  if [ $rc -eq 0 ];then\n-    echo -n \"PASS\";\n-  else\n-    echo -n \"FAIL\"\n-    echo \"$restore\" > $failfile\n-    exit 255 # fail fast\n-  fi\n-  echo \": criu: \"\n-  set -x\n-}\n-\n-get_features() {\n-  runssh \"set -ex;cd $qemudir;JAVA_HOME=\\$PWD bin\/java -XX:+ShowCPUFeatures --version\"|sed -n 's\/^This machine.s CPU features are: -XX:CPUFeatures=\/\/p'\n-}\n-exitcode=0\n-shutdown_done=false\n-\n-shutdown() {\n-  if $shutdown_done;then return;fi\n-  shutdown_done=true\n-  qemustop\n-  #rm -f $qemuimg2 # CPUFeatures.class\n-  #rm -f $qemuimg $sshkey $sshkey.pub\n-  if [ -e $failfile ]; then\n-    ls -l $failfile || true\n-    exitcode=1;\n-  fi\n-  #rm -f $failfile\n-  #rmdir $tmpdir\n-}\n-trap shutdown EXIT\n-\n-fatal() {\n-  shutdown\n-  echo >&2 \"$*\"\n-  exit 1\n-}\n-\n-if [ -z \"$*\" ];then\n-\n-# Verify reproducibility of: https:\/\/jira.azulsystems.com\/browse\/ZULU-53749\n-qemuimg2rebuild\n-qemustart kvm host\n-# if ! get_features|perl -lne '\n-#   $a=0x4ff7fff9dfcfbf7;\n-#   $b=0x1e6;\n-#   \/^(.*),(.*)$\/ or die;\n-#   die sprintf \"FA\".\"IL: 0x%x required vs. 0x%x found. 0x%x required vs. 0x%x found.\\n\",$a,eval $1,$b,eval $2 if $a&~eval $1||$b&~eval $2;\n-#   print \"PA\".\"SS: Initial CPU check\"\n-# ';then\n-#   # One could verify whether lower CPU isn't sufficient. E5-2630v3 is too old, it does not reproduce ZULU-53749.\n-#   fatal \"FA$(: )IL: CPU i7-1165G7 or higher required\"\n-# fi\n-\n-# Opteron_G1 is the most basic CPU (x86_64)\n-# SandyBridge is the first CPU with OSXSAVE+XSAVE (0x0,0x24)\n-expectRC_save=$expectRC\n-expectRC=1\n-checkpoint_restore \"kvm           SandyBridge\" \"kvm           Opteron_G1\" \"x86: FPU xsave area present, but host cpu doesn't support it\" \"\" \"-XX:+UnlockExperimentalVMOptions -XX:+IgnoreCPUFeatures\"\n-expectRC=$expectRC_save\n-checkpoint_restore \"kvm           Opteron_G1\"  \"kvm           Opteron_G1\"\n-checkpoint_restore \"kvm           Opteron_G1\"  \"kvm           host\"\n-checkpoint_restore \"kvm           host\"        \"kvm           host\"\n-# \"kvm max\" works only as \"kvm host\"\n-# \"system-x86_64 host\" is unsupported by qemu\n-# These may be too slow to run and they do not test much.\n-#checkpoint_restore \"system-x86_64 SandyBridge\" \"system-x86_64 SandyBridge\"\n-#checkpoint_restore \"system-x86_64 max\"         \"system-x86_64 max\"\n-\n-# IvyBridge is the first superset of SandyBridge\n-expectRC_save=$expectRC\n-expectRC=1\n-checkpoint_restore \"kvm           IvyBridge\"   \"kvm           SandyBridge\" -\n-(set +e;  echo \"$restore\"|grep \"$errorMsg\" && ! echo \"$restore\"|grep \"CPUFeaturesCheck \";checkpoint_restore_result)\n-expectRC=$expectRC_save\n-\n-# Don't set movbe and shstk in CPU features...\n-checkpoint_restore \"kvm           IvyBridge\"   \"kvm           SandyBridge\" - \"-XX:CPUFeatures=0x142100054bbd7,0xc0\"\n-(set +e;! echo \"$restore\"|grep \"$errorMsg\" &&   echo \"$restore\"|grep \"CPUFeaturesCheck \";checkpoint_restore_result)\n-\n-# This does not crash (or print errors) despite it could.\n-checkpoint_restore \"kvm           IvyBridge\"   \"kvm           SandyBridge\" - \"\" \"-XX:+UnlockExperimentalVMOptions -XX:+IgnoreCPUFeatures\"\n-(set +e;! echo \"$restore\"|grep \"$errorMsg\" &&   echo \"$restore\"|grep \"CPUFeaturesCheck \";checkpoint_restore_result)\n-\n-# IgnoreCPUFeatures is not inherited from snapshot to restore.\n-expectRC_save=$expectRC\n-expectRC=1\n-checkpoint_restore \"kvm           IvyBridge\"   \"kvm           SandyBridge\" - \"-XX:+UnlockExperimentalVMOptions -XX:+IgnoreCPUFeatures\" \"\"\n-(set +e;  echo \"$restore\"|grep \"$errorMsg\" && ! echo \"$restore\"|grep \"CPUFeaturesCheck \";checkpoint_restore_result)\n-expectRC=$expectRC_save\n-\n-checkpoint_restore \"kvm           IvyBridge\"   \"kvm           SandyBridge\" - \"-XX:+UnlockExperimentalVMOptions -XX:-IgnoreCPUFeatures\" \\\n-                                                                             \"-XX:+UnlockExperimentalVMOptions -XX:+IgnoreCPUFeatures\"\n-(set +e;! echo \"$restore\"|grep \"$errorMsg\" &&   echo \"$restore\"|grep \"CPUFeaturesCheck \";checkpoint_restore_result)\n-checkpoint_restore \"kvm           IvyBridge\"   \"kvm           SandyBridge\" - \"-XX:+UnlockExperimentalVMOptions -XX:+IgnoreCPUFeatures\" \\\n-                                                                             \"-XX:+UnlockExperimentalVMOptions -XX:-IgnoreCPUFeatures\"\n-expectRC=1\n-(set +e;  echo \"$restore\"|grep \"$errorMsg\" && ! echo \"$restore\"|grep \"CPUFeaturesCheck \";checkpoint_restore_result)\n-expectRC=$expectRC_save\n-\n-# FAIL: https:\/\/jira.azulsystems.com\/browse\/ZULU-53749\n-# reproducible on i7-1165G7, not reproducible on E5-2630v3\n-checkpoint_restore \"kvm host\"                  \"kvm           SandyBridge\" - # verified, fastest\n-#checkpoint_restore \"kvm host\"                  \"system-x86_64 SandyBridge\" - # verified, slower\n-#checkpoint_restore \"system-x86_64 max\"         \"kvm           SandyBridge\" - # it does not work\n-# The crash was RC=139\n-expectRC=1\n-(set +e;echo \"$restore\"|grep \"$errorMsg\" && ! echo \"$restore\"|grep \"CPUFeaturesCheck \";checkpoint_restore_result)\n-expectRC=$expectRC_save\n-\n-# What's the point of host -> VM tests when this can be run on arbitrary host? Works for me...\n-if false; then\n-checkpoint_restore \"kvm host\"                  \"kvm           SandyBridge\" - \"\" \"-XX:+UnlockExperimentalVMOptions -XX:+IgnoreCPUFeatures\"\n-expectRC=139\n-(set +e;echo \"$restore\"|grep \"$errorMsg\" && ! echo \"$restore\"|grep \"CPUFeaturesCheck \";checkpoint_restore_result)\n-expectRC=$expectRC_save\n-fi\n-\n-checkpoint_restore \"kvm IvyBridge\"             \"kvm           IvyBridge\"   \"\" \"-XX:CPUFeatures=native\"\n-\n-# Setting -XX:CPUFeatures=ignore on checkpoint means that we're not writing the features at all,\n-# and subsequent restore requires \"-XX:+UnlockExperimentalVMOptions -XX:+IgnoreCPUFeatures\"\n-expectRC=1\n-checkpoint_restore \"kvm IvyBridge\"             \"kvm           IvyBridge\"   -  \"-XX:CPUFeatures=ignore\"\n-(set +e;echo \"$restore\"|grep \"Restore failed due to incompatible or missing CPU features\" && ! echo \"$restore\"|grep \"CPUFeaturesCheck \";checkpoint_restore_result)\n-expectRC=$expectRC_save\n-\n-checkpoint_restore \"kvm IvyBridge\"             \"kvm           IvyBridge\"   \"\" \"-XX:CPUFeatures=ignore\" \"-XX:+UnlockExperimentalVMOptions -XX:+IgnoreCPUFeatures\"\n-\n-checkpoint_restore \"kvm IvyBridge\"             \"kvm           SandyBridge\" \"\" \"-XX:CPUFeatures=generic\"\n-\n-if false;then # too slow, failing\n-checkpoint_restore \"system-x86_64 max\"         \"kvm           SandyBridge\" \"\" \"-XX:CPUFeatures=0x142100054bbd7,0xe4\"\n-checkpoint_restore \"system-x86_64 max\"         \"system-x86_64 SandyBridge\" \"\" \"-XX:CPUFeatures=0x4200000081d7,0x0\"\n-fi\n-\n-elif [ $# -eq 2 -a \"$1\" = \"--cpu-list\" ];then\n-  list=\"\"\n-  for cpu in $(qemu-$2 -cpu help|sed -n 's\/^x86 \\([^ ]*\\) .*\/\\1\/p');do\n-    qemustart $2 $cpu && list=\"$list$(echo \"$(get_features) $cpu\")\n-\" || kill $qemupid || :\n-    qemustop\n-  done\n-  set +x\n-  echo\n-  echo -n \"$list\"|perl -lne '\/^(\\S+),(\\S+)( \\S+)$\/ or die;$x{sprintf \"0x%016x,0x%03x\",eval $1,eval $2,$3}.=$3;END{print $_.$x{$_} for sort keys %x}'\n-  echo\n-else\n-  set +x\n-  echo\n-  echo >&2 \"$0: [--cpu-list {kvm|system-x86_64}]\"\n-  echo\n-fi\n-set -x\n-\n-shutdown\n-echo done, exitcode=$exitcode\n-exit $exitcode\n","filename":"test\/jdk\/jdk\/crac\/CPUFeatures\/CPUFeatures.sh","additions":0,"deletions":394,"binary":false,"changes":394,"status":"deleted"}]}