{"files":[{"patch":"@@ -1378,0 +1378,4 @@\n+  if (!backing_store_file_name) {\n+    return true;\n+  }\n+\n","filename":"src\/hotspot\/os\/posix\/perfMemory_posix.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -28,0 +28,2 @@\n+import jdk.test.lib.crac.CracTestArg;\n+import jdk.test.lib.process.OutputAnalyzer;\n@@ -32,0 +34,1 @@\n+import java.time.Duration;\n@@ -41,1 +44,2 @@\n- * @run driver\/timeout=30 jdk.test.lib.crac.CracTest\n+ * @run driver\/timeout=30 jdk.test.lib.crac.CracTest false\n+ * @run driver\/timeout=30 jdk.test.lib.crac.CracTest true\n@@ -45,0 +49,4 @@\n+\n+    @CracTestArg(0)\n+    boolean perfDisableSharedMem;\n+\n@@ -48,0 +56,6 @@\n+        builder.captureOutput(true);\n+        if (perfDisableSharedMem) {\n+            builder.vmOption(\"-XX:+PerfDisableSharedMem\");\n+        } else {\n+            builder.vmOption(\"-XX:-PerfDisableSharedMem\");\n+        }\n@@ -56,1 +70,5 @@\n-                throw new IllegalStateException(\"Perf data file did not appear within time limit in the checkpointed process: \" + perfdata);\n+                if (perfDisableSharedMem) {\n+                    break;\n+                } else {\n+                    throw new IllegalStateException(\"Perf data file did not appear within time limit in the checkpointed process: \" + perfdata);\n+                }\n@@ -59,1 +77,8 @@\n-            Thread.sleep(10);\n+            Thread.sleep(perfDisableSharedMem == true ? Duration.ofSeconds(10) : Duration.ofMillis(10));\n+        }\n+        if (perfDisableSharedMem) {\n+            if (perfdata.toFile().exists()) {\n+                throw new IllegalStateException(\"Perf data file exists altough we run with -XX:+PerfDisableSharedMem\");\n+            }\n+        } else {\n+            checkMapped(pid, perfdata.toString());\n@@ -61,1 +86,0 @@\n-        checkMapped(pid, perfdata.toString());\n@@ -68,0 +92,1 @@\n+        builder.clearVmOptions();\n@@ -72,1 +97,5 @@\n-                throw new IllegalStateException(\"Perf data file did not appear within time limit in the restored process: \" + perfdata);\n+                if (perfDisableSharedMem) {\n+                    break;\n+                } else {\n+                    throw new IllegalStateException(\"Perf data file did not appear within time limit in the restored process: \" + perfdata);\n+                }\n@@ -75,1 +104,1 @@\n-            Thread.sleep(10);\n+            Thread.sleep(perfDisableSharedMem == true ? Duration.ofSeconds(10) : Duration.ofMillis(10));\n@@ -80,4 +109,10 @@\n-        checkMapped(pidString, perfdata.toString());\n-        builder.runJcmd(pidString, \"PerfCounter.print\")\n-                .shouldHaveExitValue(0)\n-                .shouldContain(\"sun.perfdata.size=\");\n+        if (perfDisableSharedMem) {\n+            if (perfdata.toFile().exists()) {\n+                throw new IllegalStateException(\"Perf data file exists altough we run with -XX:+PerfDisableSharedMem\");\n+            }\n+        } else {\n+            checkMapped(pidString, perfdata.toString());\n+            builder.runJcmd(pidString, \"PerfCounter.print\")\n+                    .shouldHaveExitValue(0)\n+                    .shouldContain(\"sun.perfdata.size=\");\n+        }\n@@ -87,0 +122,3 @@\n+        OutputAnalyzer out = restored.outputAnalyzer();\n+        out.stderrShouldBeEmpty();\n+        out.stdoutShouldBeEmpty();\n","filename":"test\/jdk\/jdk\/crac\/PerfMemoryRestoreTest.java","additions":48,"deletions":10,"binary":false,"changes":58,"status":"modified"}]}