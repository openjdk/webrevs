{"files":[{"patch":"@@ -904,1 +904,1 @@\n-      \/\/ GLIBC_MOVBE is disabled in 'gcc -Q --help=target' and some CPUs do not support it: https:\/\/stackoverflow.com\/a\/5246553\/2995591\n+      \/\/ GLIBC_MOVBE is disabled in 'gcc -Q --help=target' and for example i7-720QM does not support it\n@@ -1033,1 +1033,1 @@\n-void VM_Version::glibc_not_using(uint64_t excessive_CPU, uint64_t excessive_GLIBC) {\n+void VM_Version::glibc_not_using(uint64_t shouldnotuse_CPU, uint64_t shouldnotuse_GLIBC) {\n@@ -1035,1 +1035,1 @@\n-  if (!excessive_CPU && !excessive_GLIBC)\n+  if (!shouldnotuse_CPU && !shouldnotuse_GLIBC)\n@@ -1053,2 +1053,2 @@\n-    if (excessive_CPU & (CPU_FXSR | CPU_MMX | CPU_SSE)) {\n-      assert(!(excessive_CPU & CPU_SSE2), \"CPU_SSE2 in both _features and excessive_CPU cannot happen\");\n+    if (shouldnotuse_CPU & (CPU_FXSR | CPU_MMX | CPU_SSE)) {\n+      assert(!(shouldnotuse_CPU & CPU_SSE2), \"CPU_SSE2 in both _features and shouldnotuse_CPU cannot happen\");\n@@ -1057,1 +1057,1 @@\n-      excessive_CPU |= CPU_SSE2;\n+      shouldnotuse_CPU |= CPU_SSE2;\n@@ -1074,3 +1074,3 @@\n-        if ((excessive_CPU & CPU_SSE3) ||\n-            (excessive_GLIBC & (GLIBC_CMPXCHG16 | GLIBC_LAHFSAHF))) {\n-          assert(!(excessive_CPU & CPU_SSE4_2), \"CPU_SSE4_2 in both _features and excessive_CPU cannot happen\");\n+        if ((shouldnotuse_CPU & CPU_SSE3) ||\n+            (shouldnotuse_GLIBC & (GLIBC_CMPXCHG16 | GLIBC_LAHFSAHF))) {\n+          assert(!(shouldnotuse_CPU & CPU_SSE4_2), \"CPU_SSE4_2 in both _features and shouldnotuse_CPU cannot happen\");\n@@ -1078,1 +1078,1 @@\n-          excessive_CPU |= CPU_SSE4_2;\n+          shouldnotuse_CPU |= CPU_SSE4_2;\n@@ -1099,2 +1099,2 @@\n-            if (excessive_GLIBC & GLIBC_F16C) {\n-              assert(!(excessive_GLIBC & GLIBC_MOVBE), \"GLIBC_MOVBE in both _glibc_features and excessive_GLIBC cannot happen\");\n+            if (shouldnotuse_GLIBC & GLIBC_F16C) {\n+              assert(!(shouldnotuse_GLIBC & GLIBC_MOVBE), \"GLIBC_MOVBE in both _glibc_features and shouldnotuse_GLIBC cannot happen\");\n@@ -1102,1 +1102,1 @@\n-              excessive_GLIBC |= GLIBC_MOVBE;\n+              shouldnotuse_GLIBC |= GLIBC_MOVBE;\n@@ -1111,1 +1111,1 @@\n-              \/\/ All these flags are supported by GLIBC_DISABLE below.\n+              \/\/ All these flags are supported by disable() below.\n@@ -1118,2 +1118,1 @@\n-  uint64_t disable_CPU   = 0;\n-  uint64_t disable_GLIBC = 0;\n+\n@@ -1121,0 +1120,15 @@\n+  enum kind { KIND_CPU = 0, KIND_GLIBC, KIND_COUNT };\n+\n+  static const size_t tunables_size_max = 17;\n+  \/\/ 64 is # of bits in uint64_t VM_Version::_glibc_features.\n+  char disable_str[KIND_COUNT * 64 * (1\/*','*\/ + 1\/*'-'*\/ + tunables_size_max) + 1\/*'\\0'*\/];\n+  strcpy(disable_str, glibc_prefix);\n+  char *disable_end = disable_str + glibc_prefix_len;\n+  auto disable = [&](enum kind kind, uint64_t value, const char *tunables) {\n+    size_t remains = disable_str + sizeof(disable_str) - disable_end;\n+    guarantee(2 + strlen(tunables) < remains, \"internal error: disable_str overflow\");\n+    *disable_end++ = ',';\n+    *disable_end++ = '-';\n+    disable_end = stpcpy(disable_end, tunables);\n+  };\n+\n@@ -1122,4 +1136,1 @@\n-  uint64_t excessive_handled_CPU   = 0;\n-  uint64_t excessive_handled_GLIBC = 0;\n-  uint64_t disable_handled_CPU   = 0;\n-  uint64_t disable_handled_GLIBC = 0;\n+  uint64_t handled[KIND_COUNT] = { 0 };\n@@ -1127,4 +1138,7 @@\n-#define EXCESSIVE_HANDLED(kind, hotspot) do {                                                                                         \\\n-    assert(!(PASTE_TOKENS(excessive_handled_, kind) & PASTE_TOKENS3(kind, _, hotspot)), \"already used \" STR(kind) \"_\" STR(hotspot) ); \\\n-    DEBUG_ONLY(PASTE_TOKENS(excessive_handled_, kind) |= PASTE_TOKENS3(kind, _, hotspot));                                            \\\n-  } while (0)\n+  auto shouldnotuse_handled = [&](enum kind kind, uint64_t value, const char *kindstr, const char *tunables) {\n+    assert(strlen(tunables) <= tunables_size_max, \"Too long string %s\", tunables);\n+    assert((handled[kind] & value) == 0, \"already used %s_%s\", kindstr, tunables);\n+    DEBUG_ONLY(handled[kind] |= value);\n+  };\n+#define EXCESSIVE_HANDLED(kind, tunables) shouldnotuse_handled(PASTE_TOKENS(KIND_, kind), PASTE_TOKENS3(kind, _, tunables), STR(kind), STR(tunables))\n+\n@@ -1132,1 +1146,1 @@\n-# define FEATURE_ACTIVE(glibc) CPU_FEATURE_ACTIVE(glibc)\n+# define FEATURE_ACTIVE(tunables) CPU_FEATURE_ACTIVE(tunables)\n@@ -1134,1 +1148,1 @@\n-# define FEATURE_ACTIVE(glibc) true\n+# define FEATURE_ACTIVE(tunables) true\n@@ -1136,7 +1150,12 @@\n-#define EXCESSIVE3(kind, hotspot, glibc) do {                                                        \\\n-    EXCESSIVE_HANDLED(kind, hotspot);                                                                \\\n-    if (PASTE_TOKENS(excessive_, kind) & PASTE_TOKENS3(kind, _, hotspot) && FEATURE_ACTIVE(glibc)) { \\\n-      PASTE_TOKENS(disable_, kind) |= PASTE_TOKENS3(kind, _, hotspot);                               \\\n-    }                                                                                                \\\n-  } while (0)\n-#define EXCESSIVE(kind, hotspotglibc) EXCESSIVE3(kind, hotspotglibc, hotspotglibc)\n+\n+  const uint64_t shouldnotuseval[KIND_COUNT] = { shouldnotuse_CPU, shouldnotuse_GLIBC };\n+  auto shouldnotuse = [&](enum kind kind, uint64_t value, const char *kindstr, const char *tunables, bool feature_active) {\n+    shouldnotuse_handled(kind, value, kindstr, tunables);\n+    if ((shouldnotuseval[kind] & value) != 0 && feature_active) {\n+      disable(kind, value, tunables);\n+    }\n+  };\n+#define EXCESSIVE3(kind, hotspot, tunables) \\\n+    shouldnotuse(PASTE_TOKENS(KIND_, kind), PASTE_TOKENS3(kind, _, hotspot), STR(kind), STR(tunables), FEATURE_ACTIVE(tunables))\n+#define EXCESSIVE(kind, tunables) EXCESSIVE3(kind, tunables, tunables)\n+\n@@ -1175,50 +1194,0 @@\n-  char disable_str[64 * (10 + 3) + 1];\n-  strcpy(disable_str, glibc_prefix);\n-  char *disable_end = disable_str + glibc_prefix_len;\n-#define GLIBC_DISABLE2(kind, hotspot, glibc) do {                                                                                   \\\n-    assert(!(PASTE_TOKENS(disable_handled_, kind) & PASTE_TOKENS3(kind, _, hotspot)), \"already used \" STR(kind) \"_\" STR(hotspot) ); \\\n-    DEBUG_ONLY(PASTE_TOKENS(disable_handled_, kind) |= PASTE_TOKENS3(kind, _, hotspot));                                            \\\n-    if (PASTE_TOKENS(disable_, kind) & PASTE_TOKENS3(kind, _, hotspot)) {                                                           \\\n-      const char str[] = \",-\" STR(glibc);                                                                                           \\\n-      size_t remains = disable_str + sizeof(disable_str) - disable_end;                                                             \\\n-      strncpy(disable_end, str, remains);                                                                                           \\\n-      size_t len = strnlen(disable_end, remains);                                                                                   \\\n-      remains -= len;                                                                                                               \\\n-      assert(remains > 0, \"internal error: disable_str overflow\");                                                                  \\\n-      disable_end += len;                                                                                                           \\\n-    }                                                                                                                               \\\n-  } while (0);\n-#define GLIBC_DISABLE(kind, hotspot_glibc) GLIBC_DISABLE2(kind, hotspot_glibc, hotspot_glibc)\n-  GLIBC_DISABLE(CPU  , AVX)\n-  GLIBC_DISABLE(CPU  , CX8)\n-  GLIBC_DISABLE(CPU  , FMA)\n-  GLIBC_DISABLE(CPU  , RTM)\n-  GLIBC_DISABLE(CPU  , AVX2)\n-  GLIBC_DISABLE(CPU  , BMI1)\n-  GLIBC_DISABLE(CPU  , BMI2)\n-  GLIBC_DISABLE(CPU  , CMOV)\n-  GLIBC_DISABLE(CPU  , ERMS)\n-  GLIBC_DISABLE(CPU  , SSE2)\n-  GLIBC_DISABLE(CPU  , LZCNT)\n-  GLIBC_DISABLE(CPU  , SSSE3)\n-  GLIBC_DISABLE(CPU  , POPCNT)\n-  GLIBC_DISABLE(CPU  , SSE4_1)\n-  GLIBC_DISABLE(CPU  , SSE4_2)\n-  GLIBC_DISABLE(CPU  , AVX512F)\n-  GLIBC_DISABLE(CPU  , AVX512CD)\n-  GLIBC_DISABLE(CPU  , AVX512BW)\n-  GLIBC_DISABLE(CPU  , AVX512DQ)\n-  GLIBC_DISABLE(CPU  , AVX512ER)\n-  GLIBC_DISABLE(CPU  , AVX512PF)\n-  GLIBC_DISABLE(CPU  , AVX512VL)\n-  GLIBC_DISABLE2(CPU , CET_IBT, IBT)\n-  GLIBC_DISABLE2(CPU , CET_SS , SHSTK)\n-  GLIBC_DISABLE(GLIBC, FMA4)\n-  GLIBC_DISABLE(GLIBC, MOVBE)\n-  GLIBC_DISABLE(GLIBC, XSAVE)\n-  GLIBC_DISABLE(GLIBC, OSXSAVE)\n-  GLIBC_DISABLE(GLIBC, HTT)\n-#undef GLIBC_DISABLE\n-#undef GLIBC_DISABLE2\n-  *disable_end = 0;\n-\n@@ -1226,9 +1195,0 @@\n-#define CHECK_KIND(kind) do {                                                                                                            \\\n-    if (PASTE_TOKENS(disable_handled_, kind) != PASTE_TOKENS(excessive_handled_, kind))                                                  \\\n-      vm_exit_during_initialization(err_msg(\"internal error: Unsupported disabling of \" STR(kind) \"_* 0x%\" PRIx64 \" != used 0x%\" PRIx64, \\\n-                                            PASTE_TOKENS(disable_handled_, kind), PASTE_TOKENS(excessive_handled_, kind)));              \\\n-  } while (0)\n-  CHECK_KIND(CPU  );\n-  CHECK_KIND(GLIBC);\n-#undef CHECK_KIND\n-\n@@ -1277,5 +1237,7 @@\n-#define CHECK_KIND(kind) do {                                                                                                                 \\\n-    if (PASTE_TOKENS(excessive_handled_, kind) != PASTE_TOKENS(MAX_, kind) - 1)                                                               \\\n-      vm_exit_during_initialization(err_msg(\"internal error: Unsupported disabling of some \" STR(kind) \"_* 0x%\" PRIx64 \" != full 0x%\" PRIx64, \\\n-                                            PASTE_TOKENS(excessive_handled_, kind), PASTE_TOKENS(MAX_, kind) - 1));                           \\\n-  } while (0)\n+\n+  auto check_kind = [&](enum kind kind, const char *kindstr, uint64_t mask) {\n+    if (handled[kind] != mask) {\n+      vm_exit_during_initialization(err_msg(\"internal error: Unsupported disabling of some %s_* 0x%\" PRIx64 \" != full 0x%\" PRIx64, kindstr, handled[kind], mask));\n+    }\n+  };\n+#define CHECK_KIND(kind) check_kind(PASTE_TOKENS(KIND_, kind), STR(kind), PASTE_TOKENS(MAX_, kind) - 1)\n@@ -1287,0 +1249,1 @@\n+  *disable_end = 0;\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.cpp","additions":60,"deletions":97,"binary":false,"changes":157,"status":"modified"}]}