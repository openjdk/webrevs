{"files":[{"patch":"@@ -410,1 +410,1 @@\n-      vm_exit_during_initialization(\"This architecture does not support arch-specific -XX:CPUFeatures option\");\n+      vm_exit_during_initialization(\"This architecture does not support any arch-specific -XX:CPUFeatures options\");\n@@ -414,1 +414,1 @@\n-    tty->print_cr(\"This architecture does not support any arch-specific strings.\");\n+    tty->print_cr(\"Do not use -XX:ShowCPUFeatures: this architecture does not support any arch-specific strings.\");\n","filename":"src\/hotspot\/share\/runtime\/abstract_vm_version.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1885,2 +1885,2 @@\n-:   Limit set of CPU features to make the CRaC image compatible for running\n-    on a machine with different CPU:\n+:   Limit the set of CPU features to make the CRaC image compatible for running\n+    on a machine with a different CPU:\n","filename":"src\/java.base\/share\/man\/java.md","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1,49 +0,0 @@\n-#! \/bin\/bash\n-# Copyright (c) 2023, 2025, Azul Systems, Inc. All rights reserved.\n-# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n-#\n-# This code is free software; you can redistribute it and\/or modify it\n-# under the terms of the GNU General Public License version 2 only, as\n-# published by the Free Software Foundation.\n-#\n-# This code is distributed in the hope that it will be useful, but WITHOUT\n-# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n-# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n-# version 2 for more details (a copy is included in the LICENSE file that\n-# accompanied this code).\n-#\n-# You should have received a copy of the GNU General Public License version\n-# 2 along with this work; if not, write to the Free Software Foundation,\n-# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n-#\n-# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n-# or visit www.oracle.com if you need additional information or have any\n-# questions.\n-\n-# @test\n-# @requires os.family == \"linux\"\n-# @requires os.arch==\"amd64\" | os.arch==\"x86_64\"\n-# @run shell SimpleCPUFeatures.sh\n-# @summary On old glibc (without INCLUDE_CPU_FEATURE_ACTIVE) one could get an internal error.\n-# Error occurred during initialization of VM\n-# internal error: GLIBC_TUNABLES=:glibc.cpu.hwcaps=,-AVX,-FMA,-AVX2,-BMI1,-BMI2,-ERMS,-LZCNT,-SSSE3,-POPCNT,-SSE4_1,-SSE4_2,-AVX512F,-AVX512CD,-AVX512BW,-AVX512DQ,-AVX512VL,-IBT,-MOVBE,-SHSTK,-XSAVE,-OSXSAVE,-HTT failed and HOTSPOT_GLIBC_TUNABLES_REEXEC is set\n-\n-set -ex\n-export JAVA_HOME=$TESTJAVA\n-\n-unset GLIBC_TUNABLES\n-$JAVA_HOME\/bin\/java -XX:CPUFeatures=generic -XX:+ShowCPUFeatures -version 2>&1 | tee \/proc\/self\/fd\/2 | grep -q 'openjdk version'\n-\n-# The test from summary:\n-export GLIBC_TUNABLES=glibc.pthread.rseq=0\n-$JAVA_HOME\/bin\/java -XX:CPUFeatures=generic -XX:+ShowCPUFeatures -version 2>&1 | tee \/proc\/self\/fd\/2 | grep -q 'openjdk version'\n-\n-for GLIBC_TUNABLES in \\\n-                       glibc.cpu.hwcaps=-AVX                      \\\n-  glibc.pthread.rseq=0:glibc.cpu.hwcaps=-AVX                      \\\n-                       glibc.cpu.hwcaps=-AVX:glibc.pthread.rseq=0 \\\n-  ; do\n-  $JAVA_HOME\/bin\/java -XX:CPUFeatures=generic -XX:+ShowCPUFeatures -version 2>&1 | tee \/proc\/self\/fd\/2 | grep -q 'openjdk version'\n-done\n-\n-exit 0\n","filename":"test\/jdk\/jdk\/crac\/CPUFeatures\/SimpleCPUFeatures.sh","additions":0,"deletions":49,"binary":false,"changes":49,"status":"deleted"},{"patch":"@@ -0,0 +1,119 @@\n+\/*\n+ * Copyright (c) 2023,2025, Azul Systems, Inc. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Azul Systems, 385 Moffett Park Drive, Suite 115, Sunnyvale\n+ * CA 94089 USA or visit www.azul.com if you need additional information or\n+ * have any questions.\n+ *\/\n+\n+import jdk.test.lib.crac.*;\n+import jdk.test.lib.process.OutputAnalyzer;\n+\n+\/*\n+ * @test id=NAMED\n+ * @library \/test\/lib\n+ * @build SimpleCPUFeaturesTest\n+ * @run driver jdk.test.lib.crac.CracTest native\n+ * @run driver jdk.test.lib.crac.CracTest generic\n+ * @run driver jdk.test.lib.crac.CracTest ignore\n+ *\/\n+\/*\n+ * @test id=TUNABLES\n+ * @requires os.family == \"linux\"\n+ * @requires os.arch==\"amd64\" | os.arch==\"x86_64\"\n+ * @library \/test\/lib\n+ * @build SimpleCPUFeaturesTest\n+ * @summary On old glibc (without INCLUDE_CPU_FEATURE_ACTIVE) one could get an internal error.\n+ * @comment   Error occurred during initialization of VM\n+ * @comment   internal error: GLIBC_TUNABLES=:glibc.cpu.hwcaps=,-AVX,-FMA,-AVX2,-BMI1,-BMI2,-ERMS,-LZCNT,-SSSE3,-POPCNT,-SSE4_1,-SSE4_2,-AVX512F,-AVX512CD,-AVX512BW,-AVX512DQ,-AVX512VL,-IBT,-MOVBE,-SHSTK,-XSAVE,-OSXSAVE,-HTT failed and HOTSPOT_GLIBC_TUNABLES_REEXEC is set\n+ * @run driver jdk.test.lib.crac.CracTest generic glibc.pthread.rseq=0\n+ * @run driver jdk.test.lib.crac.CracTest generic                      glibc.cpu.hwcaps=-AVX\n+ * @run driver jdk.test.lib.crac.CracTest generic glibc.pthread.rseq=0:glibc.cpu.hwcaps=-AVX\n+ * @run driver jdk.test.lib.crac.CracTest generic                      glibc.cpu.hwcaps=-AVX:glibc.pthread.rseq=0\n+ *\/\n+\/*\n+ * @test id=X86\n+ * @requires os.arch==\"amd64\" | os.arch==\"x86_64\"\n+ * @library \/test\/lib\n+ * @build SimpleCPUFeaturesTest\n+ * @comment FLUSH and SSE2 must be present\n+ * @run driver jdk.test.lib.crac.CracTest 0x20000000080,0x0\n+ * @run driver jdk.test.lib.crac.CracTest foobar        -- INVALID_FORMAT\n+ * @run driver jdk.test.lib.crac.CracTest 0xfffff,0x0   -- MISSING_FEATURES\n+ * @run driver jdk.test.lib.crac.CracTest 0x20000000080,0xfff -- MISSING_FEATURES\n+ *\/\n+\/*\n+ * @test id=AARCH64\n+ * @requires os.arch==\"aarch64\"\n+ * @library \/test\/lib\n+ * @build SimpleCPUFeaturesTest\n+ * @run driver jdk.test.lib.crac.CracTest 0x0,0x0 -- UNSUPPORTED_ARCH\n+ * @run driver jdk.test.lib.crac.CracTest foobar  -- UNSUPPORTED_ARCH\n+ *\/\n+\n+public class SimpleCPUFeaturesTest implements CracTest {\n+    private static final String SUCCESS = \"SUCCESS\";\n+\n+    \/\/ jtreg does not respect quoted strings\n+    private enum ErrorMsg {\n+        INVALID_FORMAT(\"must be of the form: 0xNUM,0xNUM\"),\n+        MISSING_FEATURES(\"missing features of this CPU are\"),\n+        UNSUPPORTED_ARCH(\"This architecture does not support any arch-specific\")\n+        ;\n+        final String msg;\n+\n+        ErrorMsg(String msg) {\n+            this.msg = msg;\n+        }\n+    }\n+\n+    @CracTestArg(0)\n+    String cpuFeatures;\n+\n+    @CracTestArg(value = 1, optional = true)\n+    String glibcTunables;\n+\n+    @CracTestArg(value = 2, optional = true)\n+    ErrorMsg error;\n+\n+    @Override\n+    public void test() throws Exception {\n+        CracBuilder builder = new CracBuilder()\n+                .captureOutput(true)\n+                .vmOption(\"-XX:CPUFeatures=\" + cpuFeatures)\n+                .vmOption(\"-XX:+ShowCPUFeatures\");\n+        if (glibcTunables != null && !\"--\".equals(glibcTunables)) {\n+            builder.env(\"GLIBC_TUNABLES\", glibcTunables);\n+        }\n+        CracProcess process = builder.startPlain();\n+        process.waitFor();\n+        OutputAnalyzer oa = process.outputAnalyzer();\n+        if (error == null) {\n+            oa.shouldHaveExitValue(0)\n+                    .stdoutShouldContain(SUCCESS);\n+        } else {\n+            oa.shouldNotHaveExitValue(0)\n+                    .stdoutShouldContain(error.msg);\n+        }\n+    }\n+\n+    @Override\n+    public void exec() {\n+        System.out.println(SUCCESS);\n+    }\n+}\n","filename":"test\/jdk\/jdk\/crac\/CPUFeatures\/SimpleCPUFeaturesTest.java","additions":119,"deletions":0,"binary":false,"changes":119,"status":"added"}]}