{"files":[{"patch":"@@ -639,0 +639,2 @@\n+  check_cpufeatures_vmoptions();\n+\n","filename":"src\/hotspot\/cpu\/aarch64\/vm_version_aarch64.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -69,1 +69,1 @@\n-  static bool ignore_cpu_features(bool is_checkpoint) { return true; }\n+  static bool ignore_cpu_features() { return true; }\n","filename":"src\/hotspot\/cpu\/aarch64\/vm_version_aarch64.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -46,1 +46,1 @@\n-  static bool ignore_cpu_features(bool is_checkpoint) { return true; }\n+  static bool ignore_cpu_features() { return true; }\n","filename":"src\/hotspot\/cpu\/arm\/vm_version_arm.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -353,0 +353,2 @@\n+  check_cpufeatures_vmoptions();\n+\n","filename":"src\/hotspot\/cpu\/arm\/vm_version_arm_32.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -334,0 +334,2 @@\n+\n+  check_cpufeatures_vmoptions();\n","filename":"src\/hotspot\/cpu\/ppc\/vm_version_ppc.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -58,1 +58,1 @@\n-  static bool ignore_cpu_features(bool is_checkpoint) { return true; }\n+  static bool ignore_cpu_features() { return true; }\n","filename":"src\/hotspot\/cpu\/ppc\/vm_version_ppc.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -65,0 +65,2 @@\n+\n+  check_cpufeatures_vmoptions();\n","filename":"src\/hotspot\/cpu\/riscv\/vm_version_riscv.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -312,1 +312,1 @@\n-  static bool ignore_cpu_features(bool is_checkpoint) { return true; }\n+  static bool ignore_cpu_features() { return true; }\n","filename":"src\/hotspot\/cpu\/riscv\/vm_version_riscv.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -331,0 +331,2 @@\n+\n+  check_cpufeatures_vmoptions();\n","filename":"src\/hotspot\/cpu\/s390\/vm_version_s390.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -419,1 +419,1 @@\n-  static bool ignore_cpu_features(bool is_checkpoint) { return true; }\n+  static bool ignore_cpu_features() { return true; }\n","filename":"src\/hotspot\/cpu\/s390\/vm_version_s390.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -185,14 +185,0 @@\n-  product(ccstr, CPUFeatures, nullptr, \"CPU feature set, \"                  \\\n-          \"use -XX:CPUFeatures=0xnumber with -XX:CRaCCheckpointTo when you \"\\\n-          \"get an error during -XX:CRaCRestoreFrom on a different machine; \"\\\n-          \"-XX:CPUFeatures=native is the default; \"                         \\\n-          \"-XX:CPUFeatures=ignore will disable the CPU features check; \"    \\\n-          \"-XX:CPUFeatures=generic is compatible but not as slow as 0\")     \\\n-                                                                            \\\n-  product(bool, ShowCPUFeatures, false, \"Show features of this CPU \"        \\\n-          \"to be possibly used for the -XX:CPUFeatures=0xnumber option\")    \\\n-                                                                            \\\n-  product(bool, IgnoreCPUFeatures, false, RESTORE_SETTABLE | EXPERIMENTAL,  \\\n-          \"Do not refuse to run after -XX:CRaCRestoreFrom finds out some \"  \\\n-          \"CPU features are missing\")                                       \\\n-                                                                            \\\n","filename":"src\/hotspot\/cpu\/x86\/globals_x86.hpp","additions":0,"deletions":14,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -894,2 +894,1 @@\n-  return _features;\n-#else\n+#endif \/\/ !LINUX\n@@ -904,0 +903,3 @@\n+#ifndef LINUX\n+    return _features;\n+#else\n@@ -920,0 +922,1 @@\n+#endif \/\/ !LINUX\n@@ -921,0 +924,4 @@\n+#ifndef LINUX\n+  vm_exit_during_initialization(\"This OS does not support any arch-specific -XX:CPUFeatures options\");\n+  return {};\n+#else \/\/ LINUX\n@@ -949,1 +956,1 @@\n-#endif \/\/ LINUX\n+#endif\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.cpp","additions":10,"deletions":3,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -940,1 +940,1 @@\n-  static bool ignore_cpu_features(bool is_checkpoint) {\n+  static bool ignore_cpu_features() {\n@@ -944,1 +944,1 @@\n-    return _ignore_glibc_not_using || (!is_checkpoint && IgnoreCPUFeatures);\n+    return _ignore_glibc_not_using;\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -142,0 +142,2 @@\n+\n+  check_cpufeatures_vmoptions();\n","filename":"src\/hotspot\/cpu\/zero\/vm_version_zero.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -37,1 +37,1 @@\n-  static bool ignore_cpu_features(bool is_checkpoint) { return true; }\n+  static bool ignore_cpu_features() { return true; }\n","filename":"src\/hotspot\/cpu\/zero\/vm_version_zero.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/globals_extension.hpp\"\n@@ -405,0 +406,11 @@\n+\n+void Abstract_VM_Version::check_cpufeatures_vmoptions() {\n+  if (!FLAG_IS_DEFAULT(CPUFeatures)) {\n+    if (strcmp(CPUFeatures, \"native\") && strcmp(CPUFeatures, \"generic\") && strcmp(CPUFeatures, \"ignore\")) {\n+      vm_exit_during_initialization(\"This architecture does not support any arch-specific -XX:CPUFeatures options\");\n+    }\n+  }\n+  if (!FLAG_IS_DEFAULT(ShowCPUFeatures)) {\n+    tty->print_cr(\"Do not use -XX:ShowCPUFeatures: this architecture does not support any arch-specific strings.\");\n+  }\n+}\n","filename":"src\/hotspot\/share\/runtime\/abstract_vm_version.cpp","additions":12,"deletions":0,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -230,0 +230,3 @@\n+  \/\/ Default check for non-x86_64 architectures on VM options sanity\n+  static void check_cpufeatures_vmoptions();\n+\n","filename":"src\/hotspot\/share\/runtime\/abstract_vm_version.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -320,1 +320,1 @@\n-  if (_generation == 1 && !VM_Version::ignore_cpu_features(true)) {\n+  if (_generation == 1 && !VM_Version::ignore_cpu_features()) {\n@@ -798,1 +798,1 @@\n-  if (!VM_Version::ignore_cpu_features(false)) {\n+  if (!VM_Version::ignore_cpu_features() && !IgnoreCPUFeatures) {\n","filename":"src\/hotspot\/share\/runtime\/crac.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2032,0 +2032,16 @@\n+  product(ccstr, CPUFeatures, nullptr, \"CPU feature set, \"                  \\\n+          \"Limit set of CPU features to make the CRaC image compatible \"    \\\n+          \"for running on a machine with different CPU:\"                    \\\n+          \"native: use all available features (default), \"                  \\\n+          \"generic: compatible with most CPUs, \"                            \\\n+          \"ignore: do not store CPU features at all, \"                      \\\n+          \"<arch-specific>: use -XX:+ShowCPUFeatures to find a suitable \"   \\\n+          \"architecture-specific string, e.g. 0xnumber,0xnumber on x86_64.\")\\\n+                                                                            \\\n+  product(bool, ShowCPUFeatures, false, \"Show features of this CPU \"        \\\n+          \"to be possibly used for the -XX:CPUFeatures=0xnumber option\")    \\\n+                                                                            \\\n+  product(bool, IgnoreCPUFeatures, false, RESTORE_SETTABLE | EXPERIMENTAL,  \\\n+          \"Do not refuse to run after -XX:CRaCRestoreFrom finds out some \"  \\\n+          \"CPU features are missing\")                                       \\\n+                                                                            \\\n","filename":"src\/hotspot\/share\/runtime\/globals.hpp","additions":16,"deletions":0,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -1884,5 +1884,18 @@\n-`-XX:CPUFeatures=`*0xnumber,0xnumber*\n-:   CPU feature set, use `-XX:CPUFeatures=`*0xnumber,0xnumber* with\n-    `-XX:CRaCCheckpointTo` when you get an error during `-XX:CRaCRestoreFrom`\n-    on a different machine. `-XX:CPUFeatures=native` is the default.\n-    `-XX:CPUFeatures=generic` is compatible with any CPU.\n+`-XX:CPUFeatures=`*features*\n+:   Limit the set of CPU features to make the CRaC image compatible for running\n+    on a machine with a different CPU:\n+\n+    `native`\n+    :   Use all available CPU features (default).\n+\n+    `generic`\n+    :   This option is compatible with most CPUs and faster than disabling\n+        all optional features.\n+\n+    `ignore`\n+    :   Do not store CPU features at all.\n+\n+    *arch-specific*\n+    :   Architecture specific string, e.g. *0xnumber,0xnumber* on x86_64.\n+        Use `-XX:+ShowCPUFeatures` to find a suitable architecture-specific\n+        string.\n","filename":"src\/java.base\/share\/man\/java.md","additions":18,"deletions":5,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -1,49 +0,0 @@\n-#! \/bin\/bash\n-# Copyright (c) 2023, 2025, Azul Systems, Inc. All rights reserved.\n-# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n-#\n-# This code is free software; you can redistribute it and\/or modify it\n-# under the terms of the GNU General Public License version 2 only, as\n-# published by the Free Software Foundation.\n-#\n-# This code is distributed in the hope that it will be useful, but WITHOUT\n-# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n-# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n-# version 2 for more details (a copy is included in the LICENSE file that\n-# accompanied this code).\n-#\n-# You should have received a copy of the GNU General Public License version\n-# 2 along with this work; if not, write to the Free Software Foundation,\n-# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n-#\n-# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n-# or visit www.oracle.com if you need additional information or have any\n-# questions.\n-\n-# @test\n-# @requires os.family == \"linux\"\n-# @requires os.arch==\"amd64\" | os.arch==\"x86_64\"\n-# @run shell SimpleCPUFeatures.sh\n-# @summary On old glibc (without INCLUDE_CPU_FEATURE_ACTIVE) one could get an internal error.\n-# Error occurred during initialization of VM\n-# internal error: GLIBC_TUNABLES=:glibc.cpu.hwcaps=,-AVX,-FMA,-AVX2,-BMI1,-BMI2,-ERMS,-LZCNT,-SSSE3,-POPCNT,-SSE4_1,-SSE4_2,-AVX512F,-AVX512CD,-AVX512BW,-AVX512DQ,-AVX512VL,-IBT,-MOVBE,-SHSTK,-XSAVE,-OSXSAVE,-HTT failed and HOTSPOT_GLIBC_TUNABLES_REEXEC is set\n-\n-set -ex\n-export JAVA_HOME=$TESTJAVA\n-\n-unset GLIBC_TUNABLES\n-$JAVA_HOME\/bin\/java -XX:CPUFeatures=generic -XX:+ShowCPUFeatures -version 2>&1 | tee \/proc\/self\/fd\/2 | grep -q 'openjdk version'\n-\n-# The test from summary:\n-export GLIBC_TUNABLES=glibc.pthread.rseq=0\n-$JAVA_HOME\/bin\/java -XX:CPUFeatures=generic -XX:+ShowCPUFeatures -version 2>&1 | tee \/proc\/self\/fd\/2 | grep -q 'openjdk version'\n-\n-for GLIBC_TUNABLES in \\\n-                       glibc.cpu.hwcaps=-AVX                      \\\n-  glibc.pthread.rseq=0:glibc.cpu.hwcaps=-AVX                      \\\n-                       glibc.cpu.hwcaps=-AVX:glibc.pthread.rseq=0 \\\n-  ; do\n-  $JAVA_HOME\/bin\/java -XX:CPUFeatures=generic -XX:+ShowCPUFeatures -version 2>&1 | tee \/proc\/self\/fd\/2 | grep -q 'openjdk version'\n-done\n-\n-exit 0\n","filename":"test\/jdk\/jdk\/crac\/CPUFeatures\/SimpleCPUFeatures.sh","additions":0,"deletions":49,"binary":false,"changes":49,"status":"deleted"},{"patch":"@@ -0,0 +1,129 @@\n+\/*\n+ * Copyright (c) 2023,2025, Azul Systems, Inc. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Azul Systems, 385 Moffett Park Drive, Suite 115, Sunnyvale\n+ * CA 94089 USA or visit www.azul.com if you need additional information or\n+ * have any questions.\n+ *\/\n+\n+import jdk.test.lib.crac.*;\n+import jdk.test.lib.process.OutputAnalyzer;\n+\n+\/*\n+ * @test id=NAMED\n+ * @library \/test\/lib\n+ * @build SimpleCPUFeaturesTest\n+ * @run driver jdk.test.lib.crac.CracTest native\n+ * @run driver jdk.test.lib.crac.CracTest generic\n+ * @run driver jdk.test.lib.crac.CracTest ignore\n+ *\/\n+\/*\n+ * @test id=TUNABLES\n+ * @requires os.family == \"linux\"\n+ * @requires os.arch==\"amd64\" | os.arch==\"x86_64\"\n+ * @library \/test\/lib\n+ * @build SimpleCPUFeaturesTest\n+ * @summary On old glibc (without INCLUDE_CPU_FEATURE_ACTIVE) one could get an internal error.\n+ * @comment   Error occurred during initialization of VM\n+ * @comment   internal error: GLIBC_TUNABLES=:glibc.cpu.hwcaps=,-AVX,-FMA,-AVX2,-BMI1,-BMI2,-ERMS,-LZCNT,-SSSE3,-POPCNT,-SSE4_1,-SSE4_2,-AVX512F,-AVX512CD,-AVX512BW,-AVX512DQ,-AVX512VL,-IBT,-MOVBE,-SHSTK,-XSAVE,-OSXSAVE,-HTT failed and HOTSPOT_GLIBC_TUNABLES_REEXEC is set\n+ * @run driver jdk.test.lib.crac.CracTest generic glibc.pthread.rseq=0\n+ * @run driver jdk.test.lib.crac.CracTest generic                      glibc.cpu.hwcaps=-AVX\n+ * @run driver jdk.test.lib.crac.CracTest generic glibc.pthread.rseq=0:glibc.cpu.hwcaps=-AVX\n+ * @run driver jdk.test.lib.crac.CracTest generic                      glibc.cpu.hwcaps=-AVX:glibc.pthread.rseq=0\n+ *\/\n+\/*\n+ * @test id=X86-LINUX\n+ * @requires os.family == \"linux\"\n+ * @requires os.arch==\"amd64\" | os.arch==\"x86_64\"\n+ * @library \/test\/lib\n+ * @build SimpleCPUFeaturesTest\n+ * @comment FLUSH and SSE2 must be present\n+ * @run driver jdk.test.lib.crac.CracTest 0x20000000080,0x0\n+ * @run driver jdk.test.lib.crac.CracTest foobar              -- INVALID_FORMAT\n+ * @run driver jdk.test.lib.crac.CracTest 0xfffff,0x0         -- MISSING_FEATURES\n+ * @run driver jdk.test.lib.crac.CracTest 0x20000000080,0xfff -- MISSING_FEATURES\n+ *\/\n+\/*\n+ * @test id=x86-NON-LINUX\n+ * @requires os.arch==\"amd64\" | os.arch==\"x86_64\"\n+ * @requires os.family != \"linux\"\n+ * @library \/test\/lib\n+ * @build SimpleCPUFeaturesTest\n+ * @run driver jdk.test.lib.crac.CracTest foobar            -- OS_DOES_NOT_SUPPORT\n+ * @run driver jdk.test.lib.crac.CracTest 0x20000000080,0x0 -- OS_DOES_NOT_SUPPORT\n+ *\/\n+\/*\n+ * @test id=AARCH64\n+ * @requires os.arch==\"aarch64\"\n+ * @library \/test\/lib\n+ * @build SimpleCPUFeaturesTest\n+ * @run driver jdk.test.lib.crac.CracTest 0x0,0x0 -- ARCH_DOES_NOT_SUPPORT\n+ * @run driver jdk.test.lib.crac.CracTest foobar  -- ARCH_DOES_NOT_SUPPORT\n+ *\/\n+public class SimpleCPUFeaturesTest implements CracTest {\n+    private static final String SUCCESS = \"SUCCESS\";\n+\n+    \/\/ jtreg does not respect quoted strings\n+    private enum ErrorMsg {\n+        INVALID_FORMAT(\"must be of the form: 0xNUM,0xNUM\"),\n+        MISSING_FEATURES(\"missing features of this CPU are\"),\n+        ARCH_DOES_NOT_SUPPORT(\"This architecture does not support any arch-specific\"),\n+        OS_DOES_NOT_SUPPORT(\"This OS does not support\"),\n+        ;\n+        final String msg;\n+\n+        ErrorMsg(String msg) {\n+            this.msg = msg;\n+        }\n+    }\n+\n+    @CracTestArg(0)\n+    String cpuFeatures;\n+\n+    @CracTestArg(value = 1, optional = true)\n+    String glibcTunables;\n+\n+    @CracTestArg(value = 2, optional = true)\n+    ErrorMsg error;\n+\n+    @Override\n+    public void test() throws Exception {\n+        CracBuilder builder = new CracBuilder()\n+                .captureOutput(true)\n+                .vmOption(\"-XX:CPUFeatures=\" + cpuFeatures)\n+                .vmOption(\"-XX:+ShowCPUFeatures\");\n+        if (glibcTunables != null && !\"--\".equals(glibcTunables)) {\n+            builder.env(\"GLIBC_TUNABLES\", glibcTunables);\n+        }\n+        CracProcess process = builder.startPlain();\n+        process.waitFor();\n+        OutputAnalyzer oa = process.outputAnalyzer();\n+        if (error == null) {\n+            oa.shouldHaveExitValue(0)\n+                    .stdoutShouldContain(SUCCESS);\n+        } else {\n+            oa.shouldNotHaveExitValue(0)\n+                    .stdoutShouldContain(error.msg);\n+        }\n+    }\n+\n+    @Override\n+    public void exec() {\n+        System.out.println(SUCCESS);\n+    }\n+}\n","filename":"test\/jdk\/jdk\/crac\/CPUFeatures\/SimpleCPUFeaturesTest.java","additions":129,"deletions":0,"binary":false,"changes":129,"status":"added"}]}