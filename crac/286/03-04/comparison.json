{"files":[{"patch":"@@ -36,7 +36,12 @@\n-\/\/ Applicability of the option: setting the value in non-applicable context\n-\/\/ may result in warnings or errors.\n-typedef enum {\n-  CHECKPOINT = 1 << 0,\n-  RESTORE    = 1 << 1,\n-  DEPRECATED = 1 << 2,\n-} crlib_conf_option_flag_t;\n+typedef unsigned int crlib_conf_option_flag_t;\n+\/\/ This option is applicable on checkpoint. Using option that does not have this\n+\/\/ flag set on checkpoint may result in warnings or errors.\n+#define CRLIB_OPTION_FLAG_CHECKPOINT (1 << 0)\n+\/\/ This option is applicable on restore. Using option that does not have this\n+\/\/ flag set on restore may result in warnings or errors.\n+#define CRLIB_OPTION_FLAG_RESTORE    (1 << 1)\n+\/\/ This option is deprecated and should not be used. Warning may be printed when this is used.\n+\/\/ It might be excluded from crlib_description_t.configuration_doc string.\n+#define CRLIB_OPTION_FLAG_DEPRECATED (1 << 2)\n+\/\/ Setting this option has no effect. Warning may be printed when this is used.\n+#define CRLIB_OPTION_FLAG_OBSOLETE   (1 << 3)\n@@ -46,0 +51,1 @@\n+  \/\/ Not null, unless used as a sentinel\n@@ -47,0 +53,1 @@\n+  \/\/ Bitwise combination of CRLIB_OPTION_FLAG_* values\n@@ -48,0 +55,1 @@\n+  \/\/ Human-readable info about the type. Must not be null.\n@@ -49,0 +57,1 @@\n+  \/\/ String representation of the default value. Must not be null (use empty string instead).\n@@ -50,0 +59,1 @@\n+  \/\/ Human-readable description of the option. Must not be null.\n@@ -88,2 +98,1 @@\n-  \/\/ The array is terminated with an option with null key.\n-  \/\/ Set to null if this method is not supported.\n+  \/\/ The array is terminated with a sentinel option with null key.\n","filename":"src\/hotspot\/share\/include\/crlib\/crlib_description.h","additions":18,"deletions":9,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -533,5 +533,0 @@\n-  if (pattern == nullptr) {\n-    tty->print_raw_cr(\"Configuration options:\");\n-  } else {\n-    tty->print_cr(\"Configuration options matching *%s*:\", pattern);\n-  }\n@@ -541,0 +536,5 @@\n+    if (pattern == nullptr) {\n+      tty->print_raw_cr(\"Configuration options:\");\n+    } else {\n+      tty->print_cr(\"Configuration options matching *%s*:\", pattern);\n+    }\n@@ -548,1 +548,1 @@\n-    if (matched == 0) {\n+    if (pattern != nullptr && matched == 0) {\n@@ -552,0 +552,1 @@\n+    tty->print_raw_cr(\"Configuration options:\");\n","filename":"src\/hotspot\/share\/runtime\/crac.cpp","additions":7,"deletions":6,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -234,1 +234,1 @@\n-CracEngine::CracEngine() {\n+CracEngine::CracEngine(): _options(nullptr) {\n@@ -329,0 +329,1 @@\n+  FREE_C_HEAP_ARRAY(crlib_conf_option_t, _options);\n@@ -375,0 +376,3 @@\n+#define has_method(_ext_api, _func) \\\n+  (_ext_api->header.size >= offsetof(std::remove_reference<decltype(*_ext_api)>::type, _func) + sizeof(_ext_api->_func))\n+\n@@ -376,1 +380,1 @@\n-  if (ext_api->_func == nullptr) { \\\n+  if (has_method(ext_api, _func) && ext_api->_func == nullptr) { \\\n@@ -409,1 +413,1 @@\n-  \/\/ configuration_options is not mandatory\n+  require_method(configuration_options);\n@@ -423,4 +427,3 @@\n-const crlib_conf_option_t *CracEngine::configuration_options() const {\n-  static crlib_conf_option_t *all_options = nullptr;\n-  if (all_options != nullptr) {\n-    return all_options;\n+const crlib_conf_option_t *CracEngine::configuration_options() {\n+  if (_options != nullptr) {\n+    return _options;\n@@ -428,1 +431,1 @@\n-  if (_description_api->header.size < sizeof(crlib_description_t) || _description_api->configuration_options == nullptr) {\n+  if (!has_method(_description_api, configuration_options)) {\n@@ -437,2 +440,2 @@\n-  all_options = NEW_C_HEAP_ARRAY(crlib_conf_option_t, src - options + 1, mtInternal);\n-  crlib_conf_option_t *dst = all_options;\n+  _options = NEW_C_HEAP_ARRAY(crlib_conf_option_t, src - options + 1, mtInternal);\n+  crlib_conf_option_t *dst = _options;\n@@ -440,1 +443,0 @@\n-    memcpy(dst, src, sizeof(*src));\n@@ -449,1 +451,1 @@\n-      --dst; \/\/ next iteration will overwrite\n+      --dst;\n@@ -452,0 +454,1 @@\n+    memcpy(dst, src, sizeof(*src));\n@@ -459,1 +462,1 @@\n-  return all_options;\n+  return _options;\n","filename":"src\/hotspot\/share\/runtime\/crac_engine.cpp","additions":16,"deletions":13,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -69,1 +69,1 @@\n-  const crlib_conf_option_t *configuration_options() const;\n+  const crlib_conf_option_t *configuration_options();\n@@ -89,0 +89,2 @@\n+\n+  crlib_conf_option_t *_options;\n","filename":"src\/hotspot\/share\/runtime\/crac_engine.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -184,2 +184,2 @@\n-#define CONFIGURE_OPTIONS(OPT) \\\n-  OPT(image_location, const char *, nullptr, CHECKPOINT | RESTORE, \"path\", \"no default\", \\\n+#define UNCHECKED_OPTIONS(OPT) \\\n+  OPT(image_location, const char *, nullptr, CRLIB_OPTION_FLAG_CHECKPOINT | CRLIB_OPTION_FLAG_RESTORE, \"path\", \"no default\", \\\n@@ -187,2 +187,6 @@\n-  OPT(exec_location, const char *, nullptr, CHECKPOINT | RESTORE, \"path\", \"no default\", \"path to the engine executable.\") \\\n-  OPT(keep_running, bool, false, CHECKPOINT, \"true\/false\", \"false\", \\\n+  OPT(exec_location, const char *, nullptr, CRLIB_OPTION_FLAG_CHECKPOINT | CRLIB_OPTION_FLAG_RESTORE, \"path\", \"no default\", \"path to the engine executable.\") \\\n+  OPT(args, const char *, nullptr, CRLIB_OPTION_FLAG_CHECKPOINT | CRLIB_OPTION_FLAG_RESTORE, \"string\", \"\\\"\\\"\", \\\n+    \"free space-separated arguments passed directly to the engine executable, e.g. \\\"--arg1 --arg2 --arg3\\\".\") \\\n+\n+#define CHECKED_OPTIONS(OPT) \\\n+  OPT(keep_running, bool, false, CRLIB_OPTION_FLAG_CHECKPOINT, \"true\/false\", \"false\", \\\n@@ -190,1 +194,1 @@\n-  OPT(direct_map, bool, true, RESTORE, \"true\/false\", \"true\", \\\n+  OPT(direct_map, bool, true, CRLIB_OPTION_FLAG_RESTORE, \"true\/false\", \"true\", \\\n@@ -193,2 +197,2 @@\n-  OPT(args, const char *, nullptr, CHECKPOINT | RESTORE, \"string\", \"\\\"\\\"\", \\\n-    \"free space-separated arguments passed directly to the engine executable, e.g. \\\"--arg1 --arg2 --arg3\\\".\") \\\n+\n+#define CONFIGURE_OPTIONS(OPT) UNCHECKED_OPTIONS(OPT) CHECKED_OPTIONS(OPT)\n@@ -200,1 +204,1 @@\n-static const char *configure_options_names[] = { CONFIGURE_OPTIONS(ADD_ARR_ELEM) nullptr };\n+static constexpr const char *configure_options_names[] = { CONFIGURE_OPTIONS(ADD_ARR_ELEM) nullptr };\n@@ -203,1 +207,1 @@\n-static const crlib_conf_option_t configure_options[] = { CONFIGURE_OPTIONS(ADD_ARR_ELEM) {} };\n+static constexpr const crlib_conf_option_t configure_options[] = { CONFIGURE_OPTIONS(ADD_ARR_ELEM) {} };\n@@ -248,3 +252,4 @@\n-\/\/ Note: image_location, exec_location and args from this are ignored\n-#define DEFINE_DEFAULT(id, ctype, cdef, ...) Option<ctype> _##id = { cdef, true };\n-  CONFIGURE_OPTIONS(DEFINE_DEFAULT)\n+#define DEFINE_DEFAULT(id, ctype, cdef, ...) \\\n+  private: Option<ctype> _##id = { cdef, true }; \\\n+  public: inline ctype id() const { return _##id.value; }\n+  CHECKED_OPTIONS(DEFINE_DEFAULT)\n@@ -253,0 +258,1 @@\n+private:\n@@ -281,2 +287,0 @@\n-  bool keep_running() const { return _keep_running.value; }\n-  bool direct_map() const { return _direct_map.value; }\n@@ -287,1 +291,2 @@\n-#define CHECK_OPT(id, ctype, cdef, flags, ...) if (!_##id.is_default && !((flags) & flag)) { \\\n+#define CHECK_OPT(id, ctype, cdef, flags, ...) \\\n+  if (!_##id.is_default && !((flags) & flag)) { \\\n@@ -290,1 +295,1 @@\n-    CONFIGURE_OPTIONS(CHECK_OPT)\n+    CHECKED_OPTIONS(CHECK_OPT)\n@@ -797,1 +802,1 @@\n-  conf->require_defaults(CHECKPOINT, \"checkpoint\");\n+  conf->require_defaults(CRLIB_OPTION_FLAG_CHECKPOINT, \"checkpoint\");\n@@ -857,1 +862,1 @@\n-  conf->require_defaults(RESTORE, \"restore\");\n+  conf->require_defaults(CRLIB_OPTION_FLAG_RESTORE, \"restore\");\n","filename":"src\/java.base\/share\/native\/libcrexec\/crexec.cpp","additions":23,"deletions":18,"binary":false,"changes":41,"status":"modified"}]}