{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Azul Systems, Inc. All rights reserved.\n+ * Copyright (c) 2025, 2026, Azul Systems, Inc. All rights reserved.\n@@ -36,0 +36,18 @@\n+\/\/ Applicability of the option: setting the value in non-applicable context\n+\/\/ may result in warnings or errors.\n+typedef enum {\n+  CHECKPOINT = 1 << 0,\n+  RESTORE    = 1 << 1,\n+} crlib_conf_option_flag_t;\n+\n+\/\/ Structured information about the configuration option\n+typedef struct crlib_conf_option {\n+  const char *key;\n+  crlib_conf_option_flag_t flags;\n+  \/\/ Null-terminated array of deprecated names, or null.\n+  const char **deprecated_names;\n+  const char *value_type;\n+  const char *default_value;\n+  const char *description;\n+} crlib_conf_option_t;\n+\n@@ -53,0 +71,3 @@\n+  \/\/ Some keys can be excluded if these are not supposed to be set by a user but rather by the\n+  \/\/ application the engine is linked to.\n+  \/\/\n@@ -66,0 +87,5 @@\n+\n+  \/\/ Returns an array of all configuration options supported by the engine.\n+  \/\/ The array is terminated with an option with NULL key.\n+  \/\/ Set to null if this method is not supported.\n+  const crlib_conf_option_t *(*configuration_options)(crlib_conf_t *);\n","filename":"src\/hotspot\/share\/include\/crlib\/crlib_description.h","additions":27,"deletions":1,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -3144,2 +3144,6 @@\n-  if (CRaCEngineOptions && strcmp(CRaCEngineOptions, \"help\") == 0) {\n-    crac::print_engine_info_and_exit(); \/\/ Does not return on success\n+  if (CRaCEngineOptions && (!strcmp(CRaCEngineOptions, \"help\") || !strncmp(CRaCEngineOptions, \"help=\", 5))) {\n+    const char *pattern = nullptr;\n+    if (CRaCEngineOptions[4] == '=') {\n+      pattern = CRaCEngineOptions + 5;\n+    }\n+    crac::print_engine_info_and_exit(pattern); \/\/ Does not return on success\n","filename":"src\/hotspot\/share\/runtime\/arguments.cpp","additions":6,"deletions":2,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -509,1 +509,1 @@\n-void crac::print_engine_info_and_exit() {\n+void crac::print_engine_info_and_exit(const char *pattern) {\n@@ -532,6 +532,0 @@\n-\n-  const char *conf_doc = engine.configuration_doc();\n-  if (conf_doc == nullptr) {\n-    log_error(crac)(\"CRaC engine failed to provide documentation of its configuration options\");\n-    return;\n-  }\n@@ -539,2 +533,5 @@\n-  tty->print_raw_cr(\"Configuration options:\");\n-  tty->print_raw(conf_doc); \/\/ Doc string ends with CR by convention\n+  if (pattern == nullptr) {\n+    tty->print_raw_cr(\"Configuration options:\");\n+  } else {\n+    tty->print_cr(\"Configuration options matching *%s*:\", pattern);\n+  }\n@@ -542,8 +539,6 @@\n-  const GrowableArrayCHeap<const char *, MemTag::mtInternal> *controlled_opts = engine.vm_controlled_options();\n-  tty->cr();\n-  tty->print_raw(\"Configuration options controlled by the JVM: \");\n-  for (int i = 0; i < controlled_opts->length(); i++) {\n-    const char *opt = controlled_opts->at(i);\n-    tty->print_raw(opt);\n-    if (i < controlled_opts->length() - 1) {\n-      tty->print_raw(\", \");\n+  const crlib_conf_option_t *options = engine.configuration_options();\n+  if (options != nullptr) {\n+    for (; options->key != NULL; ++options) {\n+      if (pattern == nullptr || strstr(options->key, pattern)) {\n+        tty->print_cr(\"* %s=<%s> (default: %s) - %s\", options->key, options->value_type, options->default_value, options->description);\n+      }\n@@ -551,0 +546,23 @@\n+  } else {\n+    if (pattern != nullptr) {\n+      log_warning(crac)(\"Option filtering by pattern not available\");\n+    }\n+    const char *conf_doc = engine.configuration_doc();\n+    if (conf_doc == nullptr) {\n+      log_error(crac)(\"CRaC engine failed to provide documentation of its configuration options\");\n+      return;\n+    }\n+    tty->print_raw(conf_doc); \/\/ Doc string ends with CR by convention\n+\n+    const GrowableArrayCHeap<const char *, MemTag::mtInternal> *controlled_opts = engine.vm_controlled_options();\n+    tty->cr();\n+    tty->print_raw(\"Configuration options controlled by the JVM: \");\n+    for (int i = 0; i < controlled_opts->length(); i++) {\n+      const char *opt = controlled_opts->at(i);\n+      tty->print_raw(opt);\n+      if (i < controlled_opts->length() - 1) {\n+        tty->print_raw(\", \");\n+      }\n+    }\n+    tty->cr();\n+    delete controlled_opts;\n@@ -552,2 +570,0 @@\n-  tty->cr();\n-  delete controlled_opts;\n","filename":"src\/hotspot\/share\/runtime\/crac.cpp","additions":35,"deletions":19,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -38,1 +38,1 @@\n-  static void print_engine_info_and_exit();\n+  static void print_engine_info_and_exit(const char *pattern);\n","filename":"src\/hotspot\/share\/runtime\/crac.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -48,0 +48,2 @@\n+#define DIRECT_MAP \"direct_map\"\n+\n@@ -169,1 +171,1 @@\n-  if (CRaCEngineOptions != nullptr && strcmp(CRaCEngineOptions, \"help\") == 0) {\n+  if (CRaCEngineOptions != nullptr && (!strcmp(CRaCEngineOptions, \"help\") || !strncmp(CRaCEngineOptions, \"help=\", 5))) {\n@@ -183,0 +185,8 @@\n+  if (api.can_configure(conf, DIRECT_MAP)) {\n+    if (!api.configure(conf, DIRECT_MAP, \"true\")) {\n+      log_error(crac)(\"CRaC engine failed to configure: '\" DIRECT_MAP \"' = 'true'\");\n+      api.destroy_conf(conf);\n+      return nullptr;\n+    }\n+  }\n+\n@@ -399,0 +409,1 @@\n+  \/\/ configuration_options is not mandatory\n@@ -412,0 +423,35 @@\n+const crlib_conf_option_t *CracEngine::configuration_options() const {\n+  static crlib_conf_option_t *all_options = nullptr;\n+  if (all_options != nullptr) {\n+    return all_options;\n+  }\n+  if (_description_api->header.size < sizeof(crlib_description_t) || _description_api->configuration_options == nullptr) {\n+    return nullptr;\n+  }\n+  const crlib_conf_option_t *options = _description_api->configuration_options(_conf);\n+  if (options == nullptr) {\n+    return nullptr;\n+  }\n+  const crlib_conf_option_t *src = options;\n+  for (; src->key != nullptr; ++src);\n+  all_options = NEW_C_HEAP_ARRAY(crlib_conf_option_t, src - options + 1, mtInternal);\n+  crlib_conf_option_t *dst = all_options;\n+  for (src = options; src->key != nullptr; ++src, ++dst) {\n+    *dst = *src;\n+    for (const char *opt : vm_controlled_engine_opts) {\n+      if (!strcmp(src->key, opt)) {\n+        \/\/ override, do not expose\n+        --dst;\n+        continue;\n+      }\n+    }\n+    if (!strcmp(dst->key, DIRECT_MAP)) {\n+      \/\/ JVM is overriding the direct_map default in all engines\n+      dst->default_value = \"true\";\n+    }\n+  }\n+  \/\/ last element should be zeroes\n+  memset(dst, 0, sizeof(*dst));\n+  return all_options;\n+}\n+\n","filename":"src\/hotspot\/share\/runtime\/crac_engine.cpp","additions":47,"deletions":1,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -69,0 +69,1 @@\n+  const crlib_conf_option_t *configuration_options() const;\n","filename":"src\/hotspot\/share\/runtime\/crac_engine.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -69,0 +69,1 @@\n+static const crlib_conf_option_t *configuration_options(crlib_conf_t *conf);\n@@ -108,0 +109,1 @@\n+  configuration_options,\n@@ -177,3 +179,2 @@\n-\/\/ When adding a new option also add its description into the help message,\n-\/\/ ensure the proper default value is set for it in the configuration struct and\n-\/\/ consider checking for inappropriate use on checkpoint\/restore.\n+\/\/ When adding a new option ensure the proper default value is set for it\n+\/\/ in the configuration struct.\n@@ -184,7 +185,12 @@\n-  OPT(image_location) \\\n-  OPT(exec_location) \\\n-  OPT(keep_running) \\\n-  OPT(direct_map) \\\n-  OPT(args) \\\n-\n-#define DEFINE_OPT(id) static constexpr char opt_##id[] = #id;\n+  OPT(image_location, const char *, nullptr, CHECKPOINT | RESTORE, nullptr, \"path\", \"no default\", \\\n+    \"path to a directory with checkpoint\/restore files.\") \\\n+  OPT(exec_location, const char *, nullptr, CHECKPOINT | RESTORE, nullptr, \"path\", \"no default\", \"path to the engine executable.\") \\\n+  OPT(keep_running, bool, false, CHECKPOINT, nullptr, \"true\/false\", \"false\", \\\n+    \"keep the process running after the checkpoint or kill it.\") \\\n+  OPT(direct_map, bool, true, RESTORE, nullptr, \"true\/false\", \"true\", \\\n+    \"on restore, map process data directly from saved files. This may speedup the restore \" \\\n+    \"but the resulting process will not be the same as before the checkpoint.\") \\\n+  OPT(args, const char *, nullptr, CHECKPOINT | RESTORE, nullptr, \"string\", \"\\\"\\\"\", \\\n+    \"free space-separated arguments passed directly to the engine executable, e.g. \\\"--arg1 --arg2 --arg3\\\".\") \\\n+\n+#define DEFINE_OPT(id, ...) static constexpr char opt_##id[] = #id;\n@@ -193,2 +199,5 @@\n-#define ADD_ARR_ELEM(id) opt_##id,\n-static constexpr const char *configure_options[] = { CONFIGURE_OPTIONS(ADD_ARR_ELEM) nullptr };\n+#define ADD_ARR_ELEM(id, ...) opt_##id,\n+static const char *configure_options_names[] = { CONFIGURE_OPTIONS(ADD_ARR_ELEM) nullptr };\n+#undef ADD_ARR_ELEM\n+#define ADD_ARR_ELEM(id, ctype, cdef, flags, ...) { opt_##id, static_cast<crlib_conf_option_flag_t>(flags), __VA_ARGS__ },\n+static const crlib_conf_option_t configure_options[] = { CONFIGURE_OPTIONS(ADD_ARR_ELEM) {} };\n@@ -205,3 +214,2 @@\n-\/\/ Value of a boolean configuration option.\n-struct BoolOption {\n-  bool value;\n+template <typename T> struct Option {\n+  T value;\n@@ -211,1 +219,1 @@\n-static bool parse_bool(const char *str, BoolOption *result) {\n+static bool parse_bool(const char *str, Option<bool> *result) {\n@@ -237,1 +245,1 @@\n-    configure_options, ARRAY_SIZE(configure_options) - 1 \/* omit nullptr *\/\n+    configure_options_names, ARRAY_SIZE(configure_options_names) - 1 \/* omit nullptr *\/\n@@ -240,2 +248,5 @@\n-  BoolOption _keep_running{false};\n-  BoolOption _direct_map{true};\n+\/\/ Note: image_location, exec_location and args from this are ignored\n+#define DEFINE_DEFAULT(id, ctype, cdef, ...) Option<ctype> _##id = { .value = cdef };\n+  CONFIGURE_OPTIONS(DEFINE_DEFAULT)\n+#undef DEFINE_DEFAULT\n+\n@@ -254,1 +265,1 @@\n-#define PUT_HANDLER(id) _options.put(opt_##id, &crlib_conf::configure_##id);\n+#define PUT_HANDLER(id, ...) _options.put(opt_##id, &crlib_conf::configure_##id);\n@@ -270,2 +281,2 @@\n-  BoolOption keep_running() const { return _keep_running; }\n-  BoolOption direct_map() const { return _direct_map; }\n+  bool keep_running() const { return _keep_running.value; }\n+  bool direct_map() const { return _direct_map.value; }\n@@ -275,0 +286,8 @@\n+  void require_defaults(crlib_conf_option_flag_t flag, const char *event) const {\n+#define CHECK_OPT(id, ctype, cdef, flags, ...) if (!_##id.is_default && !((flags) & flag)) { \\\n+    fprintf(stderr, CREXEC #id \" has no effect on %s\\n\", event); \\\n+  }\n+    CONFIGURE_OPTIONS(CHECK_OPT)\n+#undef CHECK_OPT\n+  }\n+\n@@ -426,10 +445,4 @@\n-  return\n-    \"* image_location=<path> (no default) - path to a directory with checkpoint\/restore files.\\n\"\n-    \"* exec_location=<path> (no default) - path to the engine executable.\\n\"\n-    \"* keep_running=<true\/false> (default: false) - keep the process running after the checkpoint \"\n-    \"or kill it.\\n\"\n-    \"* direct_map=<true\/false> (default: true) - on restore, map process data directly from saved \"\n-    \"files. This may speedup the restore but the resulting process will not be the same as before \"\n-    \"the checkpoint.\\n\"\n-    \"* args=<string> (default: \\\"\\\") - free space-separated arguments passed directly to the \"\n-    \"engine executable, e.g. \\\"--arg1 --arg2 --arg3\\\".\\n\";\n+#define DOC_ITEM(name, ctype, cdef, flags, deprecated, type, _default, description) \\\n+  \"* \" #name \"=<\" type \"> (default: \" _default \") - \" description \"\\n\"\n+  return CONFIGURE_OPTIONS(DOC_ITEM);\n+#undef DOC_ITEM\n@@ -439,1 +452,1 @@\n-  return configure_options;\n+  return configure_options_names;\n@@ -446,0 +459,4 @@\n+static const crlib_conf_option_t *configuration_options(crlib_conf_t *conf) {\n+   return configure_options;\n+}\n+\n@@ -780,4 +797,1 @@\n-\n-  if (!conf->direct_map().is_default) {\n-    fprintf(stderr, CREXEC \"%s has no effect on checkpoint\\n\", opt_direct_map);\n-  }\n+  conf->require_defaults(CHECKPOINT, \"checkpoint\");\n@@ -797,1 +811,1 @@\n-        (conf->keep_running().value && !env.append(\"CRAC_CRIU_LEAVE_RUNNING\", \"\"))) {\n+        (conf->keep_running() && !env.append(\"CRAC_CRIU_LEAVE_RUNNING\", \"\"))) {\n@@ -843,4 +857,1 @@\n-\n-  if (!conf->keep_running().is_default) {\n-    fprintf(stderr, CREXEC \"%s has no effect on restore\\n\", opt_keep_running);\n-  }\n+  conf->require_defaults(RESTORE, \"restore\");\n@@ -862,1 +873,1 @@\n-      (!conf->direct_map().value && !env.add_criu_option(\"--no-mmap-page-image\"))) {\n+      (!conf->direct_map() && !env.add_criu_option(\"--no-mmap-page-image\"))) {\n","filename":"src\/java.base\/share\/native\/libcrexec\/crexec.cpp","additions":54,"deletions":43,"binary":false,"changes":97,"status":"modified"}]}