{"files":[{"patch":"@@ -35,0 +35,1 @@\n+import java.io.File;\n@@ -36,0 +37,2 @@\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n@@ -83,0 +86,1 @@\n+        private static int MAX_BACKUPS = Integer.getInteger(\"jdk.jfr.max_backups\", 20);\n@@ -127,0 +131,33 @@\n+                    WriteableUserPath destination = r.getDestination();\n+                    \/\/ The backup recording has to be moved before creating WriteableUserPath\n+                    \/\/ (and touching the recording output file)\n+                    try {\n+                        destination.doPrivilegedIO(() -> {\n+                            File destFile = destination.getReal().toFile();\n+                            if (!destFile.exists()) {\n+                                return null;\n+                            }\n+                            Path backup = null;\n+                            for (int i = 0; backup == null && i < MAX_BACKUPS; ++i) {\n+                                String name = destFile.getName();\n+                                \/\/ Mission Control has issues opening recording files\n+                                \/\/ that don't end with .jfr\n+                                if (name.endsWith(\".jfr\")) {\n+                                    name = name.substring(0, name.length() - 4) + \".\" + i + \".jfr\";\n+                                } else {\n+                                    name = name + \".\" + i;\n+                                }\n+                                backup = destination.getReal().getParent().resolve(name);\n+                                if (backup.toFile().exists()) {\n+                                    backup = null;\n+                                }\n+                            }\n+                            if (backup != null) {\n+                                Files.move(destFile.toPath(), backup);\n+                                Logger.log(JFR, INFO, \"Backed up \" + destFile + \" to \" + backup);\n+                            }\n+                            return null;\n+                        });\n+                    } catch (IOException e) {\n+                        Logger.log(JFR, ERROR, \"Cannot backup previous recording: \" + e);\n+                    }\n@@ -130,1 +167,1 @@\n-                        r.setDestination(new WriteableUserPath(r.getDestination().getPotentiallyMaliciousOriginal()));\n+                        r.setDestination(new WriteableUserPath(destination.getPotentiallyMaliciousOriginal()));\n","filename":"src\/jdk.jfr\/share\/classes\/jdk\/jfr\/internal\/PlatformRecorder.java","additions":38,"deletions":1,"binary":false,"changes":39,"status":"modified"}]}