{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2012, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -62,3 +62,3 @@\n-    private String filename;\n-    private File file;\n-    private File stopFile;\n+    private final String filename;\n+    private final File file;\n+    private final File stopFile;\n@@ -66,1 +66,0 @@\n-    private FileChannel channel;\n@@ -72,1 +71,1 @@\n-    private Semaphore lockSem = new Semaphore(1);\n+    private final Semaphore lockSem = new Semaphore(1);\n@@ -101,1 +100,0 @@\n-        channel = rwfile.getChannel();\n@@ -108,3 +106,0 @@\n-        if (channel == null) {\n-            initializeChannel();\n-        }\n@@ -112,0 +107,5 @@\n+        if (rwfile != null) {\n+            throw new IllegalStateException(\"rwfile not null\");\n+        }\n+        initializeChannel();\n+        FileChannel channel = rwfile.getChannel();\n@@ -122,2 +122,1 @@\n-            \/\/ Not locked, remain ignorant about port file contents.\n-            return;\n+            throw new IllegalStateException(\"Must lock before calling getValues\");\n@@ -170,0 +169,3 @@\n+        if (lock == null) {\n+            throw new IllegalStateException(\"Must lock before calling setValues\");\n+        }\n@@ -184,6 +186,4 @@\n-        \/\/ Access to file must be closed before deleting.\n-        rwfile.close();\n-\n-        file.delete();\n-\n-        \/\/ Wait until file has been deleted (deletes are asynchronous on Windows!) otherwise we\n+        if (!file.exists()) { \/\/ file deleted already\n+            return;\n+        }\n+        \/\/ Keep trying until file has been deleted, otherwise we\n@@ -191,1 +191,1 @@\n-        for (int i = 0; i < 10 && file.exists(); i++) {\n+        for (int i = 0; i < 10 && file.exists() && !file.delete(); i++) {\n@@ -197,0 +197,2 @@\n+        \/\/ allow some time for late clients to connect\n+        Thread.sleep(1000);\n@@ -225,1 +227,1 @@\n-            return;\n+            throw new IllegalStateException(\"Not locked\");\n@@ -229,0 +231,2 @@\n+        rwfile.close();\n+        rwfile = null;\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/sjavac\/server\/PortFile.java","additions":24,"deletions":20,"binary":false,"changes":44,"status":"modified"}]}