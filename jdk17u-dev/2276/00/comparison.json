{"files":[{"patch":"@@ -722,1 +722,1 @@\n-  jlong enabled_bits = 0;\n+  jlong enabled_bits = env->env_event_enable()->_event_callback_enabled.get_bits();\n@@ -725,0 +725,1 @@\n+    jlong bit_for = JvmtiEventEnabled::bit_for(evt_t);\n@@ -726,1 +727,3 @@\n-      enabled_bits |= JvmtiEventEnabled::bit_for(evt_t);\n+      enabled_bits |= bit_for;\n+    } else {\n+      enabled_bits &= ~bit_for;\n","filename":"src\/hotspot\/share\/prims\/jvmtiEventController.cpp","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -0,0 +1,62 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, Azul Systems, Inc. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ *\n+ * @summary Tests subscribing ClassUnload JVMTI extension event after unsubscribing all events.\n+ * @bug 8286490\n+ * @requires vm.jvmti\n+ * @library \/vmTestbase\n+ *          \/test\/lib\n+ * @run driver nsk.share.ExtraClassesBuilder loadClass\n+ * @run main\/othervm\/native nsk.jvmti.unit.extcallback.Test\n+ *\/\n+\n+package nsk.jvmti.unit.extcallback;\n+\n+import jdk.test.lib.process.ProcessTools;\n+\n+public class Test {\n+\n+    public static void main(String[] args) throws Exception {\n+        ProcessTools.executeTestJvm(\"-agentlib:extcallback\", Test1.class.getName())\n+                    .shouldHaveExitValue(0)\n+                    .shouldContain(\"callbackClassUnload called\");\n+    }\n+\n+    public static class Test1 {\n+        public static void main(String[] args) throws Exception {\n+            System.out.println(\"App started\");\n+            {\n+                var unloader = new nsk.share.ClassUnloader();\n+                unloader.loadClass(\"nsk.jvmti.unit.extcallback.Test2\", \".\/bin\/loadClass\");\n+                unloader.unloadClass();\n+                unloader = null;\n+            }\n+            System.gc();\n+            System.out.println(\"App finished\");\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/jvmti\/unit\/extcallback\/Test.java","additions":62,"deletions":0,"binary":false,"changes":62,"status":"added"},{"patch":"@@ -0,0 +1,70 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, Azul Systems, Inc. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#include <jvmti.h>\n+#include <string.h>\n+\n+void JNICALL callbackClassUnload(jvmtiEnv* jvmti_env, ...) {\n+    printf(\"callbackClassUnload called\\n\");\n+    fflush(NULL);\n+}\n+\n+void JNICALL callbackClassLoad(jvmtiEnv* jvmti_env, JNIEnv* jni_env, jthread thread, jclass klass) {\n+    \/\/ nothing to do, just a stub\n+}\n+\n+JNIEXPORT jint JNICALL Agent_OnLoad(JavaVM* jvm, char* options, void* reserved) {\n+    printf(\"%s:%d : %s : JVMTI agent loading...\\n\", __FILE__, __LINE__, __FUNCTION__);\n+\n+    jvmtiEnv* jvmti = NULL;\n+    jint extensionEventCount = 0;\n+    jvmtiExtensionEventInfo* extensionEvents = NULL;\n+    (*jvm)->GetEnv(jvm, (void**)&jvmti, JVMTI_VERSION_1_0);\n+\n+    \/\/ Set extension event callback\n+    (*jvmti)->GetExtensionEvents(jvmti, &extensionEventCount, &extensionEvents);\n+    for (int i = 0; i < extensionEventCount; ++i) {\n+        if (0 == strcmp(\"com.sun.hotspot.events.ClassUnload\", extensionEvents[i].id)) {\n+            (*jvmti)->SetExtensionEventCallback(jvmti, extensionEvents[i].extension_event_index, &callbackClassUnload);\n+        }\n+    }\n+\n+    {\n+        \/\/ Set some event callbacks\n+        jvmtiEventCallbacks callbacks;\n+        memset(&callbacks, 0, sizeof(callbacks));\n+        callbacks.ClassLoad = &callbackClassLoad;\n+        (*jvmti)->SetEventCallbacks(jvmti, &callbacks, sizeof(callbacks));\n+\n+        \/\/ Clear event callbacks\n+        memset(&callbacks, 0, sizeof(callbacks));\n+        (*jvmti)->SetEventCallbacks(jvmti, &callbacks, sizeof(callbacks));\n+    }\n+\n+    return JNI_OK;\n+}\n+\n+JNIEXPORT void JNICALL Agent_OnUnload(JavaVM* jvm) {\n+    printf(\"%s:%d : %s : JVMTI agent unloading...\\n\", __FILE__, __LINE__, __FUNCTION__);\n+}\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/jvmti\/unit\/extcallback\/libextcallback.c","additions":70,"deletions":0,"binary":false,"changes":70,"status":"added"},{"patch":"@@ -0,0 +1,29 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, Azul Systems, Inc. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package nsk.jvmti.unit.extcallback;\n+\n+public class Test2 {\n+    public Test2() {}\n+}\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/jvmti\/unit\/extcallback\/loadClass\/Test2.java","additions":29,"deletions":0,"binary":false,"changes":29,"status":"added"}]}