{"files":[{"patch":"@@ -216,1 +216,0 @@\n-        synchronized (this) {stopping = true;}\n@@ -220,0 +219,1 @@\n+        synchronized (this) {stopping = true;}\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2ClientImpl.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -31,0 +31,2 @@\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.VarHandle;\n@@ -290,1 +292,4 @@\n-    volatile boolean closed;\n+    private static final int HALF_CLOSED_LOCAL  = 1;\n+    private static final int HALF_CLOSED_REMOTE = 2;\n+    private static final int SHUTDOWN_REQUESTED = 4;\n+    volatile int closedState;\n@@ -706,7 +711,9 @@\n-        Log.logTrace(\"Closing HTTP\/2 connection: to {0}\", connection.address());\n-        if (connection.channel().isOpen()) {\n-            GoAwayFrame f = new GoAwayFrame(0,\n-                    ErrorFrame.NO_ERROR,\n-                    \"Requested by user\".getBytes(UTF_8));\n-            \/\/ TODO: set last stream. For now zero ok.\n-            sendFrame(f);\n+        if (markHalfClosedLocal()) {\n+            if (connection.channel().isOpen()) {\n+                Log.logTrace(\"Closing HTTP\/2 connection: to {0}\", connection.address());\n+                GoAwayFrame f = new GoAwayFrame(0,\n+                        ErrorFrame.NO_ERROR,\n+                        \"Requested by user\".getBytes(UTF_8));\n+                \/\/ TODO: set last stream. For now zero ok.\n+                sendFrame(f);\n+            }\n@@ -774,6 +781,3 @@\n-        if (debug.on()) debug.log(() -> \"Shutting down h2c (closed=\"+closed+\"): \" + t);\n-        if (closed == true) return;\n-        synchronized (this) {\n-            if (closed == true) return;\n-            closed = true;\n-        }\n+        int state = closedState;\n+        if (debug.on()) debug.log(() -> \"Shutting down h2c (state=\"+describeClosedState(state)+\"): \" + t);\n+        if (!markShutdownRequested()) return;\n@@ -782,1 +786,1 @@\n-            if (!(t instanceof EOFException) || isActive()) {\n+            if (t!= null && (!(t instanceof EOFException) || isActive())) {\n@@ -786,0 +790,2 @@\n+            } else {\n+                Log.logError(\"Shutting down connection\");\n@@ -969,1 +975,1 @@\n-        if (closed) return;\n+        if (isMarked(closedState, SHUTDOWN_REQUESTED)) return;\n@@ -979,1 +985,1 @@\n-            if (closed) return;\n+            if (isMarked(closedState, SHUTDOWN_REQUESTED)) return;\n@@ -1079,1 +1085,2 @@\n-        return !closed && connection.channel().isOpen();\n+        return !isMarked(closedState, SHUTDOWN_REQUESTED)\n+                && connection.channel().isOpen();\n@@ -1192,5 +1199,7 @@\n-        framesDecoder.close(protocolError);\n-        subscriber.stop(protocolException);\n-        if (debug.on()) debug.log(\"Sending GOAWAY due to \" + protocolException);\n-        GoAwayFrame frame = new GoAwayFrame(0, errorCode);\n-        sendFrame(frame);\n+        if (markHalfClosedLocal()) {\n+            framesDecoder.close(protocolError);\n+            subscriber.stop(protocolException);\n+            if (debug.on()) debug.log(\"Sending GOAWAY due to \" + protocolException);\n+            GoAwayFrame frame = new GoAwayFrame(0, errorCode);\n+            sendFrame(frame);\n+        }\n@@ -1229,3 +1238,5 @@\n-        shutdown(new IOException(\n-                        connection.channel().getLocalAddress()\n-                        +\": GOAWAY received\"));\n+        if (markHalfClosedLRemote()) {\n+            shutdown(new IOException(\n+                    connection.channel().getLocalAddress()\n+                            + \": GOAWAY received\"));\n+        }\n@@ -1345,1 +1356,1 @@\n-            if (!closed) {\n+            if (!isMarked(closedState, SHUTDOWN_REQUESTED)) {\n@@ -1356,1 +1367,0 @@\n-\n@@ -1494,1 +1504,1 @@\n-            if (!closed) {\n+            if (!isMarked(closedState, SHUTDOWN_REQUESTED)) {\n@@ -1512,1 +1522,1 @@\n-            if (!closed) {\n+            if (!isMarked(closedState, SHUTDOWN_REQUESTED)) {\n@@ -1530,1 +1540,1 @@\n-            if (!closed) {\n+            if (!isMarked(closedState, SHUTDOWN_REQUESTED)) {\n@@ -1696,0 +1706,56 @@\n+\n+    private boolean isMarked(int state, int mask) {\n+        return (state & mask) == mask;\n+    }\n+\n+    private boolean markShutdownRequested() {\n+        return markClosedState(SHUTDOWN_REQUESTED);\n+    }\n+\n+    private boolean markHalfClosedLocal() {\n+        return markClosedState(HALF_CLOSED_LOCAL);\n+    }\n+\n+    private boolean markHalfClosedLRemote() {\n+        return markClosedState(HALF_CLOSED_REMOTE);\n+    }\n+\n+    private boolean markClosedState(int flag) {\n+        int state, desired;\n+        do {\n+            state = desired = closedState;\n+            if ((state & flag) == flag) return false;\n+            desired = state | flag;\n+        } while (!CLOSED_STATE.compareAndSet(this, state, desired));\n+        return true;\n+    }\n+\n+    String describeClosedState(int state) {\n+        if (state == 0) return \"active\";\n+        String desc = null;\n+        if (isMarked(state, SHUTDOWN_REQUESTED)) {\n+            desc = \"shutdown\";\n+        }\n+        if (isMarked(state, HALF_CLOSED_LOCAL | HALF_CLOSED_REMOTE)) {\n+            if (desc == null) return \"closed\";\n+            else return desc + \"+closed\";\n+        }\n+        if (isMarked(state, HALF_CLOSED_LOCAL)) {\n+            if (desc == null) return \"half-closed-local\";\n+            else return desc + \"+half-closed-local\";\n+        }\n+        if (isMarked(state, HALF_CLOSED_REMOTE)) {\n+            if (desc == null) return \"half-closed-remote\";\n+            else return desc + \"+half-closed-remote\";\n+        }\n+        return \"0x\" + Integer.toString(state, 16);\n+    }\n+\n+    private static final VarHandle CLOSED_STATE;\n+    static {\n+        try {\n+            CLOSED_STATE = MethodHandles.lookup().findVarHandle(Http2Connection.class, \"closedState\", int.class);\n+        } catch (Exception x) {\n+            throw new ExceptionInInitializerError(x);\n+        }\n+    }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2Connection.java","additions":97,"deletions":31,"binary":false,"changes":128,"status":"modified"},{"patch":"@@ -29,1 +29,3 @@\n- * @run testng\/othervm -Djdk.httpclient.HttpClient.log=ssl,requests,responses,errors NoBodyTest\n+ * @run testng\/othervm -Djdk.httpclient.HttpClient.log=ssl,requests,responses,errors\n+ *                     -Djdk.internal.httpclient.debug=true\n+ *                     NoBodyTest\n","filename":"test\/jdk\/java\/net\/httpclient\/http2\/NoBodyTest.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"}]}