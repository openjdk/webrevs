{"files":[{"patch":"@@ -2093,8 +2093,11 @@\n-      nbr_files.rlim_cur = nbr_files.rlim_max;\n-\n-#ifdef __APPLE__\n-      \/\/ Darwin returns RLIM_INFINITY for rlim_max, but fails with EINVAL if\n-      \/\/ you attempt to use RLIM_INFINITY. As per setrlimit(2), OPEN_MAX must\n-      \/\/ be used instead\n-      nbr_files.rlim_cur = MIN(OPEN_MAX, nbr_files.rlim_cur);\n-#endif\n+      rlim_t rlim_original = nbr_files.rlim_cur;\n+\n+      \/\/ On macOS according to setrlimit(2), OPEN_MAX must be used instead\n+      \/\/ of RLIM_INFINITY, but testing on macOS >= 10.6, reveals that\n+      \/\/ we can, in fact, use even RLIM_INFINITY, so try the max value\n+      \/\/ that the system claims can be used first, same as other BSD OSes.\n+      \/\/ However, some terminals (ksh) will internally use \"int\" type\n+      \/\/ to store this value and since RLIM_INFINITY overflows an \"int\"\n+      \/\/ we might end up with a negative value, so cap the system limit max\n+      \/\/ at INT_MAX instead, just in case, for everyone.\n+      nbr_files.rlim_cur = MIN(INT_MAX, nbr_files.rlim_max);\n@@ -2103,0 +2106,6 @@\n+      if (status != 0) {\n+        \/\/ If that fails then try lowering the limit to either OPEN_MAX\n+        \/\/ (which is safe) or the original limit, whichever was greater.\n+        nbr_files.rlim_cur = MAX(OPEN_MAX, rlim_original);\n+        status = setrlimit(RLIMIT_NOFILE, &nbr_files);\n+      }\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":17,"deletions":8,"binary":false,"changes":25,"status":"modified"}]}