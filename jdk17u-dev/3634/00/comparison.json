{"files":[{"patch":"@@ -151,2 +151,9 @@\n-            this.subscription = subscription;\n-            whenSubscribed.complete(subscription);\n+            Flow.Subscription sub;\n+            synchronized (this) {\n+                if ((sub = this.subscription) == null) {\n+                    this.subscription = sub = subscription;\n+                }\n+            }\n+            if (sub == subscription) {\n+                whenSubscribed.complete(subscription);\n+            } else subscription.cancel();\n@@ -157,1 +164,7 @@\n-                subscription.cancel();\n+                Flow.Subscription sub;\n+                synchronized (this) {\n+                    if ((sub = this.subscription) == null) {\n+                        this.subscription = sub = HttpBodySubscriberWrapper.NOP;\n+                    }\n+                }\n+                sub.cancel();\n@@ -782,1 +795,1 @@\n-                if (debug.on()) debug.log(() -> \"hasOutgoing = \" + hasOutgoing());\n+                if (debug.on()) debug.log(() -> \"hasOutgoing = \" + hasOutgoing() + \", demand = \" + demand.get());\n@@ -785,0 +798,1 @@\n+                    if (debug.on()) debug.log(\"outgoing: \" + dp);\n@@ -806,1 +820,4 @@\n-                            if (checkRequestCancelled()) return;\n+                            if (checkRequestCancelled()) {\n+                                if (debug.on()) debug.log(\"Request cancelled!\");\n+                                return;\n+                            }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http1Exchange.java","additions":22,"deletions":5,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -341,0 +341,1 @@\n+                subscription.cancel();\n@@ -405,0 +406,1 @@\n+                subscription.cancel();\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http1Request.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -707,5 +707,7 @@\n-        GoAwayFrame f = new GoAwayFrame(0,\n-                                        ErrorFrame.NO_ERROR,\n-                                        \"Requested by user\".getBytes(UTF_8));\n-        \/\/ TODO: set last stream. For now zero ok.\n-        sendFrame(f);\n+        if (connection.channel().isOpen()) {\n+            GoAwayFrame f = new GoAwayFrame(0,\n+                    ErrorFrame.NO_ERROR,\n+                    \"Requested by user\".getBytes(UTF_8));\n+            \/\/ TODO: set last stream. For now zero ok.\n+            sendFrame(f);\n+        }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2Connection.java","additions":7,"deletions":5,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -1035,10 +1035,14 @@\n-        synchronized void register(AsyncEvent e) {\n-            if (closed) e.abort(selectorClosedException());\n-            registrations.add(e);\n-            selector.wakeup();\n-        }\n-\n-        synchronized void cancel(SocketChannel e) {\n-            SelectionKey key = e.keyFor(selector);\n-            if (key != null) {\n-                key.cancel();\n+        void register(AsyncEvent e) {\n+            var closed = this.closed;\n+            if (!closed) {\n+                synchronized (this) {\n+                    closed = this.closed;\n+                    if (!closed) {\n+                        registrations.add(e);\n+                    }\n+                }\n+            }\n+            if (closed) {\n+                e.abort(selectorClosedException());\n+            } else {\n+                selector.wakeup();\n@@ -1046,1 +1050,0 @@\n-            selector.wakeup();\n@@ -1095,4 +1098,2 @@\n-        synchronized void shutdown() {\n-            Log.logTrace(\"{0}: shutting down\", getName());\n-            if (debug.on()) debug.log(\"SelectorManager shutting down\");\n-            closed = true;\n+        \/\/ Only called by the selector manager thread\n+        private void shutdown() {\n@@ -1100,1 +1101,6 @@\n-                selector.close();\n+                synchronized (this) {\n+                    Log.logTrace(\"{0}: shutting down\", getName());\n+                    if (debug.on()) debug.log(\"SelectorManager shutting down\");\n+                    closed = true;\n+                    selector.close();\n+                }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/HttpClientImpl.java","additions":22,"deletions":16,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -798,0 +798,1 @@\n+                    if (scheduler.isStopped()) return;\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/common\/SSLFlowDelegate.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -347,0 +347,1 @@\n+        if (pushScheduler.isStopped()) return;\n@@ -382,0 +383,1 @@\n+        if (pushScheduler.isStopped()) return;\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/common\/SubscriberWrapper.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import java.lang.management.LockInfo;\n@@ -29,0 +30,2 @@\n+import java.lang.management.MonitorInfo;\n+import java.lang.management.ThreadInfo;\n@@ -92,0 +95,73 @@\n+    \/\/ This method is copied from ThreadInfo::toString, but removes the\n+    \/\/ limit on the stack trace depth (8 frames max) that ThreadInfo::toString\n+    \/\/ forcefully implement. We want to print all frames for better diagnosis.\n+    private static String toString(ThreadInfo info) {\n+        StringBuilder sb = new StringBuilder(\"\\\"\" + info.getThreadName() + \"\\\"\" +\n+                (info.isDaemon() ? \" daemon\" : \"\") +\n+                \" prio=\" + info.getPriority() +\n+                \" Id=\" + info.getThreadId() + \" \" +\n+                info.getThreadState());\n+        if (info.getLockName() != null) {\n+            sb.append(\" on \" + info.getLockName());\n+        }\n+        if (info.getLockOwnerName() != null) {\n+            sb.append(\" owned by \\\"\" + info.getLockOwnerName() +\n+                    \"\\\" Id=\" + info.getLockOwnerId());\n+        }\n+        if (info.isSuspended()) {\n+            sb.append(\" (suspended)\");\n+        }\n+        if (info.isInNative()) {\n+            sb.append(\" (in native)\");\n+        }\n+        sb.append('\\n');\n+        int i = 0;\n+        var stackTrace = info.getStackTrace();\n+        for (; i < stackTrace.length ; i++) {\n+            StackTraceElement ste = stackTrace[i];\n+            sb.append(\"\\tat \" + ste.toString());\n+            sb.append('\\n');\n+            if (i == 0 && info.getLockInfo() != null) {\n+                Thread.State ts = info.getThreadState();\n+                switch (ts) {\n+                    case BLOCKED:\n+                        sb.append(\"\\t-  blocked on \" + info.getLockInfo());\n+                        sb.append('\\n');\n+                        break;\n+                    case WAITING:\n+                        sb.append(\"\\t-  waiting on \" + info.getLockInfo());\n+                        sb.append('\\n');\n+                        break;\n+                    case TIMED_WAITING:\n+                        sb.append(\"\\t-  waiting on \" + info.getLockInfo());\n+                        sb.append('\\n');\n+                        break;\n+                    default:\n+                }\n+            }\n+\n+            for (MonitorInfo mi : info.getLockedMonitors()) {\n+                if (mi.getLockedStackDepth() == i) {\n+                    sb.append(\"\\t-  locked \" + mi);\n+                    sb.append('\\n');\n+                }\n+            }\n+        }\n+        if (i < stackTrace.length) {\n+            sb.append(\"\\t...\");\n+            sb.append('\\n');\n+        }\n+\n+        LockInfo[] locks = info.getLockedSynchronizers();\n+        if (locks.length > 0) {\n+            sb.append(\"\\n\\tNumber of locked synchronizers = \" + locks.length);\n+            sb.append('\\n');\n+            for (LockInfo li : locks) {\n+                sb.append(\"\\t- \" + li);\n+                sb.append('\\n');\n+            }\n+        }\n+        sb.append('\\n');\n+        return sb.toString();\n+    }\n+\n@@ -96,0 +172,1 @@\n+                .map(ReferenceTracker::toString)\n","filename":"test\/jdk\/java\/net\/httpclient\/ReferenceTracker.java","additions":77,"deletions":0,"binary":false,"changes":77,"status":"modified"}]}