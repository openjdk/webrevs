{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2012, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -42,0 +42,1 @@\n+  #include <sys\/times.h>\n@@ -49,1 +50,1 @@\n-  long _total_cpu_nanos;\n+  uint64_t _jvm_real;\n@@ -51,2 +52,2 @@\n-  long _jvm_user_nanos;\n-  long _jvm_system_nanos;\n+  uint64_t _jvm_user;\n+  uint64_t _jvm_system;\n@@ -86,2 +87,2 @@\n-  _total_cpu_nanos= 0;\n-  _total_csr_nanos= 0;\n+  _jvm_real = 0;\n+  _total_csr_nanos = 0;\n@@ -89,2 +90,2 @@\n-  _jvm_user_nanos = 0;\n-  _jvm_system_nanos = 0;\n+  _jvm_user = 0;\n+  _jvm_system = 0;\n@@ -151,5 +152,4 @@\n-  mach_port_t task = mach_task_self();\n-  mach_msg_type_number_t task_info_count = TASK_INFO_MAX;\n-  task_info_data_t task_info_data;\n-  kern_return_t kr = task_info(task, TASK_ABSOLUTETIME_INFO, (task_info_t)task_info_data, &task_info_count);\n-  if (kr != KERN_SUCCESS) {\n+\n+  struct tms buf;\n+  clock_t jvm_real = times(&buf);\n+  if (jvm_real == (clock_t) (-1)) {\n@@ -158,1 +158,0 @@\n-  task_absolutetime_info_t absolutetime_info = (task_absolutetime_info_t)task_info_data;\n@@ -161,2 +160,2 @@\n-  long jvm_user_nanos = absolutetime_info->total_user;\n-  long jvm_system_nanos = absolutetime_info->total_system;\n+  uint64_t jvm_user = buf.tms_utime;\n+  uint64_t jvm_system = buf.tms_stime;\n@@ -164,7 +163,2 @@\n-  long total_cpu_nanos;\n-  if(!now_in_nanos(&total_cpu_nanos)) {\n-    return OS_ERR;\n-  }\n-\n-  if (_total_cpu_nanos == 0 || active_processor_count != _active_processor_count) {\n-    \/\/ First call or change in active processor count\n+  if (active_processor_count != _active_processor_count) {\n+    \/\/ Change in active processor count\n@@ -172,1 +166,6 @@\n-  }\n+  } else {\n+    uint64_t delta = active_processor_count * (jvm_real - _jvm_real);\n+    if (delta == 0) {\n+      \/\/ Avoid division by zero\n+      return OS_ERR;\n+    }\n@@ -174,4 +173,2 @@\n-  long delta_nanos = active_processor_count * (total_cpu_nanos - _total_cpu_nanos);\n-  if (delta_nanos == 0) {\n-    \/\/ Avoid division by zero\n-    return OS_ERR;\n+    *pjvmUserLoad = normalize((double)(jvm_user - _jvm_user) \/ delta);\n+    *pjvmKernelLoad = normalize((double)(jvm_system - _jvm_system) \/ delta);\n@@ -180,3 +177,0 @@\n-  *pjvmUserLoad = normalize((double)(jvm_user_nanos - _jvm_user_nanos)\/delta_nanos);\n-  *pjvmKernelLoad = normalize((double)(jvm_system_nanos - _jvm_system_nanos)\/delta_nanos);\n-\n@@ -184,3 +178,3 @@\n-  _total_cpu_nanos = total_cpu_nanos;\n-  _jvm_user_nanos = jvm_user_nanos;\n-  _jvm_system_nanos = jvm_system_nanos;\n+  _jvm_real = jvm_real;\n+  _jvm_user = jvm_user;\n+  _jvm_system = jvm_system;\n","filename":"src\/hotspot\/os\/bsd\/os_perf_bsd.cpp","additions":28,"deletions":34,"binary":false,"changes":62,"status":"modified"}]}