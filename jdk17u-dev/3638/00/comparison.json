{"files":[{"patch":"@@ -77,1 +77,1 @@\n-                sendQuitTo(pid);\n+                checkCatchesAndSendQuitTo(pid, false);\n@@ -82,1 +82,1 @@\n-                long time_spend = 0;\n+                long time_spent = 0;\n@@ -84,0 +84,2 @@\n+\n+                boolean timedout = false;\n@@ -91,2 +93,3 @@\n-                    time_spend += delay;\n-                    if (time_spend > timeout\/2 && !socket_file.exists()) {\n+                    timedout = (time_spent += delay) > timeout;\n+\n+                    if (time_spent > timeout\/2 && !socket_file.exists()) {\n@@ -94,1 +97,1 @@\n-                        sendQuitTo(pid);\n+                        checkCatchesAndSendQuitTo(pid, !timedout);\n@@ -96,1 +99,1 @@\n-                } while (time_spend <= timeout && !socket_file.exists());\n+                } while (!timedout && !socket_file.exists());\n@@ -102,1 +105,1 @@\n-                                      pid, time_spend));\n+                                      pid, time_spent));\n@@ -299,1 +302,1 @@\n-    static native void sendQuitTo(int pid) throws IOException;\n+    static native boolean checkCatchesAndSendQuitTo(int pid, boolean throwIfNotReady) throws IOException, AttachNotSupportedException;\n","filename":"src\/jdk.attach\/macosx\/classes\/sun\/tools\/attach\/VirtualMachineImpl.java","additions":11,"deletions":8,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+#include <sys\/sysctl.h>\n@@ -36,0 +37,1 @@\n+#include <stdbool.h>\n@@ -119,1 +121,1 @@\n- * Method:    sendQuitTo\n+ * Method:    checkCatchesAndSendQuitTo\n@@ -122,2 +124,2 @@\n-JNIEXPORT void JNICALL Java_sun_tools_attach_VirtualMachineImpl_sendQuitTo\n-  (JNIEnv *env, jclass cls, jint pid)\n+JNIEXPORT jboolean JNICALL Java_sun_tools_attach_VirtualMachineImpl_checkCatchesAndSendQuitTo\n+  (JNIEnv *env, jclass cls, jint pid, jboolean throwIfNotReady)\n@@ -125,2 +127,39 @@\n-    if (kill((pid_t)pid, SIGQUIT)) {\n-        JNU_ThrowIOExceptionWithLastError(env, \"kill\");\n+    int mib[] = { CTL_KERN, KERN_PROC, KERN_PROC_PID, (int)pid };\n+\n+    struct kinfo_proc kiproc;\n+    size_t            kipsz = sizeof(struct kinfo_proc);\n+\n+   \/*\n+    * Early in the lifetime of a JVM it has not yet initialized its signal handlers, in particular the QUIT\n+    * handler, note that the default behavior of QUIT is to terminate the receiving process, if unhandled.\n+    *\n+    * Since we use QUIT to initiate an attach operation, if we signal a JVM during this period early in its\n+    * lifetime before it has initialized its QUIT handler, such a signal delivery will terminate the JVM we\n+    * are attempting to attach to!\n+    *\n+    * The following code guards the QUIT delivery by testing the current signal masks. It is okay to send QUIT\n+    * if the signal is caught but not ignored, as that implies a handler has been installed.\n+    *\/\n+\n+    if (sysctl(mib, sizeof(mib) \/ sizeof(int), &kiproc, &kipsz, NULL, 0) == 0) {\n+        const bool ignored = (kiproc.kp_proc.p_sigignore & sigmask(SIGQUIT)) != 0;\n+        const bool caught  = (kiproc.kp_proc.p_sigcatch & sigmask(SIGQUIT))  != 0;\n+\n+        \/\/ note: obviously the masks could change between testing and signalling however this is not the\n+        \/\/ observed behavior of the current JVM implementation.\n+\n+        if (caught && !ignored) {\n+            if (kill((pid_t)pid, SIGQUIT) != 0) {\n+                JNU_ThrowIOExceptionWithLastError(env, \"kill\");\n+            } else {\n+                return JNI_TRUE;\n+            }\n+        } else if (throwIfNotReady) {\n+            char msg[100];\n+\n+            snprintf(msg, sizeof(msg), \"pid: %d, state is not ready to participate in attach handshake!\", (int)pid);\n+\n+            JNU_ThrowByName(env, \"com\/sun\/tools\/attach\/AttachNotSupportedException\", msg);\n+        }\n+    } else {\n+        JNU_ThrowIOExceptionWithLastError(env, \"sysctl\");\n@@ -128,0 +167,2 @@\n+\n+    return JNI_FALSE;\n","filename":"src\/jdk.attach\/macosx\/native\/libattach\/VirtualMachineImpl.c","additions":46,"deletions":5,"binary":false,"changes":51,"status":"modified"}]}