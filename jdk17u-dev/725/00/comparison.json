{"files":[{"patch":"@@ -525,1 +525,0 @@\n-  JavaThread* thread;\n@@ -527,3 +526,4 @@\n-  if (trace->env_id == NULL ||\n-    (thread = JavaThread::thread_from_jni_environment(trace->env_id)) == NULL ||\n-    thread->is_exiting()) {\n+  \/\/ Can't use thread_from_jni_environment as it may also perform a VM exit check that is unsafe to\n+  \/\/ do from this context.\n+  Thread* raw_thread = Thread::current_or_null_safe();\n+  JavaThread* thread;\n@@ -531,0 +531,2 @@\n+  if (trace->env_id == NULL || raw_thread == NULL || !raw_thread->is_Java_thread() ||\n+     (thread = ((JavaThread*)raw_thread))->is_exiting()) {\n@@ -542,1 +544,2 @@\n-  assert(JavaThread::current() == thread,\n+  \/\/ This is safe now as the thread has not terminated and so no VM exit check occurs.\n+  assert(thread == JavaThread::thread_from_jni_environment(trace->env_id),\n","filename":"src\/hotspot\/share\/prims\/forte.cpp","additions":8,"deletions":5,"binary":false,"changes":13,"status":"modified"}]}