{"files":[{"patch":"@@ -153,2 +153,13 @@\n-            this.connection = connection;\n-            if (closeRequested) closeConnection();\n+            boolean closeRequested;\n+            synchronized (this) {\n+                \/\/ check whether this new connection should be\n+                \/\/ closed\n+                closeRequested = this.closeRequested;\n+                if (!closeRequested) {\n+                    this.connection = connection;\n+                } else {\n+                    \/\/ assert this.connection == null\n+                    this.closeRequested = false;\n+                }\n+            }\n+            if (closeRequested) closeConnection(connection);\n@@ -158,3 +169,23 @@\n-            closeRequested = true;\n-            HttpConnection connection = this.connection;\n-            this.connection = null;\n+            HttpConnection connection;\n+            synchronized (this) {\n+                connection = this.connection;\n+                if (connection == null) {\n+                    closeRequested = true;\n+                } else {\n+                    this.connection = null;\n+                }\n+            }\n+            closeConnection(connection);\n+        }\n+\n+        HttpConnection disable() {\n+            HttpConnection connection;\n+            synchronized (this) {\n+                connection = this.connection;\n+                this.connection = null;\n+                this.closeRequested = false;\n+            }\n+            return connection;\n+        }\n+\n+        private static void closeConnection(HttpConnection connection) {\n@@ -169,5 +200,0 @@\n-\n-        void disable() {\n-            connection = null;\n-            closeRequested = false;\n-        }\n@@ -617,0 +643,1 @@\n+                            HttpConnection connection = connectionAborter.disable();\n@@ -618,1 +645,3 @@\n-                            if (cached) connectionAborter.disable();\n+                            if (!cached && connection != null) {\n+                                connectionAborter.connection(connection);\n+                            }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Exchange.java","additions":40,"deletions":11,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -31,1 +31,0 @@\n-import java.net.ConnectException;\n@@ -103,1 +102,1 @@\n-                    if (connection.closed\n+                    if (connection.isOpen()\n@@ -159,1 +158,1 @@\n-        if (c.closed || c.finalStream()) {\n+        if (!c.isOpen() || c.finalStream()) {\n@@ -167,0 +166,5 @@\n+            if (!c.isOpen()) {\n+                if (debug.on())\n+                    debug.log(\"skipping offered closed or closing connection: %s\", c);\n+                return false;\n+            }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2ClientImpl.java","additions":7,"deletions":3,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -1076,0 +1076,4 @@\n+    boolean isOpen() {\n+        return !closed && connection.channel().isOpen();\n+    }\n+\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2Connection.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8245462 8229822\n+ * @bug 8245462 8229822 8254786\n","filename":"test\/jdk\/java\/net\/httpclient\/CancelRequestTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}