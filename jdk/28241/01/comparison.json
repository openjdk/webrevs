{"files":[{"patch":"@@ -88,1 +88,1 @@\n-  assert(pd_call_destination(addr()) == x, \"fail in reloc\");\n+  guarantee(pd_call_destination(addr()) == x, \"fail in reloc\");\n","filename":"src\/hotspot\/cpu\/aarch64\/relocInfo_aarch64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -93,1 +93,1 @@\n-CodeBuffer::CodeBuffer(CodeBlob* blob) DEBUG_ONLY(: Scrubber(this, sizeof(*this))) {\n+CodeBuffer::CodeBuffer(const CodeBlob* blob) DEBUG_ONLY(: Scrubber(this, sizeof(*this))) {\n","filename":"src\/hotspot\/share\/asm\/codeBuffer.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -675,1 +675,1 @@\n-  CodeBuffer(CodeBlob* blob);\n+  CodeBuffer(const CodeBlob* blob);\n","filename":"src\/hotspot\/share\/asm\/codeBuffer.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1501,0 +1501,34 @@\n+  \/\/ Fix relocation\n+  RelocIterator iter(this);\n+  CodeBuffer src(&nm);\n+  CodeBuffer dst(this);\n+  while (iter.next()) {\n+#ifdef USE_TRAMPOLINE_STUB_FIX_OWNER\n+    \/\/ After an nmethod is moved, some direct call sites may end up out of range.\n+    \/\/ CallRelocation::fix_relocation_after_move() assumes the target is always\n+    \/\/ reachable and does not check branch range. Calling it without range checks\n+    \/\/ could cause us to write an offset too large for the instruction.\n+    \/\/\n+    \/\/ If a call site has a trampoline, we skip the normal call relocation. The\n+    \/\/ associated trampoline_stub_Relocation will handle the call and the\n+    \/\/ trampoline, including range checks and updating the branch as needed.\n+    \/\/\n+    \/\/ If no trampoline exists, we can assume the call target is always\n+    \/\/ reachable and therefore within direct branch range, so calling\n+    \/\/ CallRelocation::fix_relocation_after_move() is safe.\n+    if (iter.reloc()->is_call()) {\n+      address trampoline = trampoline_stub_Relocation::get_trampoline_for(iter.reloc()->addr(), this);\n+      if (trampoline != nullptr) {\n+        continue;\n+      }\n+    }\n+#endif\n+\n+    iter.reloc()->fix_relocation_after_move(&src, &dst);\n+  }\n+\n+  {\n+    MutexLocker ml(NMethodState_lock, Mutex::_no_safepoint_check_flag);\n+    clear_inline_caches();\n+  }\n+\n@@ -1524,19 +1558,0 @@\n-  \/\/ Fix relocation\n-  RelocIterator iter(nm_copy);\n-  CodeBuffer src(this);\n-  CodeBuffer dst(nm_copy);\n-  while (iter.next()) {\n-#ifdef USE_TRAMPOLINE_STUB_FIX_OWNER\n-    \/\/ Direct calls may no longer be in range and the use of a trampoline may now be required.\n-    \/\/ Instead, allow trampoline relocations to update their owners and perform the necessary checks.\n-    if (iter.reloc()->is_call()) {\n-      address trampoline = trampoline_stub_Relocation::get_trampoline_for(iter.reloc()->addr(), nm_copy);\n-      if (trampoline != nullptr) {\n-        continue;\n-      }\n-    }\n-#endif\n-\n-    iter.reloc()->fix_relocation_after_move(&src, &dst);\n-  }\n-\n@@ -1572,2 +1587,0 @@\n-    nm_copy->clear_inline_caches();\n-\n@@ -1581,1 +1594,1 @@\n-      make_not_used();\n+      make_not_entrant(InvalidationReason::RELOCATED);\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":35,"deletions":22,"binary":false,"changes":57,"status":"modified"},{"patch":"@@ -502,0 +502,1 @@\n+    RELOCATED,\n@@ -546,0 +547,2 @@\n+      case InvalidationReason::RELOCATED:\n+        return \"relocated\";\n","filename":"src\/hotspot\/share\/code\/nmethod.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -588,0 +588,1 @@\n+  declare_constant(nmethod::InvalidationReason::RELOCATED)                                \\\n","filename":"src\/hotspot\/share\/jvmci\/vmStructs_jvmci.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -1681,1 +1681,1 @@\n-    if (code->is_in_use()) {\n+    if (code->is_in_use() && !code->is_unloading()) {\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}