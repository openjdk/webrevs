{"files":[{"patch":"@@ -129,11 +129,7 @@\n-    transient private PropertyChangeListener propListener =\n-        new PropertyChangeListener() {\n-            public void propertyChange(PropertyChangeEvent e) {\n-                String propertyName = e.getPropertyName();\n-                if (propertyName == \"ancestor\") {\n-                    if (e.getOldValue() != null &&\n-                            e.getNewValue() == null) {\n-                        if (isVisible()) {\n-                            setVisible(false);\n-                        }\n-                    }\n+\n+    private transient PropertyChangeListener propListener =\n+            (e) -> {\n+                if (e.getOldValue() != null\n+                    && e.getNewValue() == null\n+                    && isVisible()) {\n+                    setVisible(false);\n@@ -141,2 +137,1 @@\n-            }\n-        };\n+            };\n@@ -958,1 +953,0 @@\n-        PropertyChangeListener oldPropListener = propListener;\n@@ -963,1 +957,1 @@\n-                oldInvoker.removePropertyChangeListener(oldPropListener);\n+                oldInvoker.removePropertyChangeListener(\"ancestor\", propListener);\n@@ -965,1 +959,1 @@\n-            invoker.addPropertyChangeListener(propListener);\n+            invoker.addPropertyChangeListener(\"ancestor\", propListener);\n@@ -1429,1 +1423,1 @@\n-                equals(\"propListener\")) {\n+           equals(\"propListener\")) {\n","filename":"src\/java.desktop\/share\/classes\/javax\/swing\/JPopupMenu.java","additions":11,"deletions":17,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import java.awt.BorderLayout;\n@@ -33,2 +34,0 @@\n-import java.awt.Point;\n-import java.awt.Rectangle;\n@@ -36,2 +35,2 @@\n-import java.awt.BorderLayout;\n-import javax.swing.JPopupMenu;\n+import java.util.concurrent.CountDownLatch;\n+\n@@ -40,1 +39,1 @@\n-import javax.swing.JTextField;\n+import javax.swing.JPopupMenu;\n@@ -42,0 +41,4 @@\n+import javax.swing.event.PopupMenuEvent;\n+import javax.swing.event.PopupMenuListener;\n+\n+import static java.util.concurrent.TimeUnit.SECONDS;\n@@ -44,1 +47,1 @@\n-    static JPopupMenu jpm;\n+    static JPopupMenu popupMenu;\n@@ -48,1 +51,3 @@\n-    static volatile boolean isVisible;\n+\n+    private static final CountDownLatch popupShown = new CountDownLatch(1);\n+    private static final CountDownLatch popupHidden = new CountDownLatch(1);\n@@ -51,1 +56,1 @@\n-        frame = new JFrame(\"My frame\");\n+        frame = new JFrame(\"TestPopupInvoker\");\n@@ -56,0 +61,22 @@\n+\n+        popupMenu = new JPopupMenu(\"Popup\");\n+        popupMenu.add(\"One\");\n+        popupMenu.add(\"Two\");\n+        popupMenu.add(\"Three\");\n+\n+        popupMenu.addPopupMenuListener(new PopupMenuListener() {\n+            @Override\n+            public void popupMenuWillBecomeVisible(PopupMenuEvent e) {\n+                popupShown.countDown();\n+            }\n+\n+            @Override\n+            public void popupMenuWillBecomeInvisible(PopupMenuEvent e) {\n+                popupHidden.countDown();\n+            }\n+\n+            @Override\n+            public void popupMenuCanceled(PopupMenuEvent e) {\n+            }\n+        });\n+\n@@ -68,7 +95,5 @@\n-            SwingUtilities.invokeAndWait(() -> {\n-                jpm = new JPopupMenu(\"Popup\");\n-                jpm.add(\"One\");\n-                jpm.add(\"Two\");\n-                jpm.add(\"Three\");\n-                jpm.show(label, 0, 0);\n-            });\n+            SwingUtilities.invokeAndWait(() -> popupMenu.show(label, 0, 0));\n+\n+            if (!popupShown.await(2, SECONDS)) {\n+                throw new RuntimeException(\"Popup isn't displayed\");\n+            }\n@@ -76,1 +101,0 @@\n-            robot.delay(1000);\n@@ -81,1 +105,0 @@\n-                isVisible = jpm.isVisible();\n@@ -83,2 +106,2 @@\n-            if (isVisible) {\n-                throw new RuntimeException(\"popup is visible after component is removed\");\n+            if (!popupHidden.await(1, SECONDS)) {\n+                throw new RuntimeException(\"Popup is visible after component is removed\");\n","filename":"test\/jdk\/javax\/swing\/JPopupMenu\/TestPopupInvoker.java","additions":42,"deletions":19,"binary":false,"changes":61,"status":"modified"}]}