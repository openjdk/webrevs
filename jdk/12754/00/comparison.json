{"files":[{"patch":"@@ -44,0 +44,2 @@\n+import java.nio.file.Files;\n+import java.nio.file.NoSuchFileException;\n@@ -135,0 +137,3 @@\n+    \/\/ This is non-null when output file clash detection is enabled\n+    private HashSet<Path> outputFilesWritten;\n+\n@@ -277,0 +282,4 @@\n+            case DETECT_OUTPUT_FILE_CLASHES:\n+                outputFilesWritten = new HashSet<>();\n+                return true;\n+\n@@ -514,0 +523,28 @@\n+\n+\/\/ Output File Clash Detection\n+\n+    \/** Record the fact that we have started writing to an output file.\n+     *\/\n+    synchronized void newOutputToPath(Path path) throws IOException {\n+\n+        \/\/ Is output file clash detection enabled?\n+        if (outputFilesWritten == null)\n+            return;\n+\n+        \/\/ Individual files can be access concurrently, so synchronize here\n+        synchronized (this) {\n+\n+            \/\/ Get the \"canonical\" version of the file's path; we are assuming\n+            \/\/ here that two clashing files will resolve to the same real path.\n+            Path realPath;\n+            try {\n+                realPath = path.toRealPath();\n+            } catch (NoSuchFileException e) {\n+                return;         \/\/ should never happen except on broken filesystems\n+            }\n+\n+            \/\/ Check whether we've already opened this file for output\n+            if (!outputFilesWritten.add(realPath))\n+                throw new IOException(\"output file clash: \" + path);\n+        }\n+    }\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/BaseFileManager.java","additions":37,"deletions":0,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -451,1 +451,3 @@\n-        return Files.newOutputStream(path);\n+        OutputStream output = Files.newOutputStream(path);\n+        fileManager.newOutputToPath(path);\n+        return output;\n@@ -486,1 +488,3 @@\n-        return new OutputStreamWriter(Files.newOutputStream(path), fileManager.getEncodingName());\n+        Writer writer = new OutputStreamWriter(Files.newOutputStream(path), fileManager.getEncodingName());\n+        fileManager.newOutputToPath(path);\n+        return writer;\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/PathFileObject.java","additions":6,"deletions":2,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -616,0 +616,2 @@\n+    DETECT_OUTPUT_FILE_CLASHES(\"--detect-output-file-clashes\", \"opt.detect.output.file.clashes\", EXTENDED, FILEMANAGER),\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/main\/Option.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -356,0 +356,3 @@\n+javac.opt.detect.output.file.clashes=\\\n+    Generate an error if any output file is overwritten during compilation. This can occur, for example,\\n\\\n+    on case-insensitive filesystems. This applies to class files, native header files, and source files.\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/resources\/javac.properties","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,155 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * @test\n+ * @bug 8287885 8296656 7016187\n+ * @summary Verify proper function of the \"--detect-output-file-clashes\" compiler flag\n+ * @requires os.family == \"mac\"\n+ * @library \/tools\/lib\n+ * @modules jdk.compiler\/com.sun.tools.javac.api\n+ *          jdk.compiler\/com.sun.tools.javac.main\n+ *          jdk.compiler\/com.sun.tools.javac.util\n+ * @build toolbox.ToolBox toolbox.JavacTask\n+ * @run main OutputFileClashTest\n+*\/\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.List;\n+import java.util.regex.Pattern;\n+\n+import toolbox.TestRunner;\n+import toolbox.ToolBox;\n+import toolbox.JavacTask;\n+import toolbox.Task;\n+\n+public class OutputFileClashTest extends TestRunner {\n+\n+    protected ToolBox tb;\n+\n+    public OutputFileClashTest() {\n+        super(System.err);\n+        tb = new ToolBox();\n+    }\n+\n+    protected void runTests() throws Exception {\n+        runTests(m -> new Object[] { Paths.get(m.getName()) });\n+    }\n+\n+    Path[] findJavaFiles(Path... paths) throws IOException {\n+        return tb.findJavaFiles(paths);\n+    }\n+\n+\/\/ Note: in these tests, it's indeterminate which output file gets written first.\n+\/\/ So we compare the log output to a regex that matches the error either way.\n+\n+    @Test\n+    public void testBug8287885(Path base) throws Exception {\n+        testClash(base,\n+                \"\"\"\n+                public class Test {\n+                    void method1() {\n+                        enum ABC { A, B, C; };  \/\/ becomes \"Test$1ABC.class\"\n+                    }\n+                    void method2() {\n+                        enum Abc { A, B, C; };  \/\/ becomes \"Test$1Abc.class\"\n+                    }\n+                }\n+                \"\"\",\n+            \"^Test\\\\.java:(3:9|6:9): compiler\\\\.err\\\\.class\\\\.cant\\\\.write: (ABC|Abc), output file clash: .*Test\\\\$1(ABC|Abc)\\\\.class$\");\n+    }\n+\n+    @Test\n+    public void testBug8296656(Path base) throws Exception {\n+        testClash(base,\n+                \"\"\"\n+                public class Test {\n+                    @interface Annotation {\n+                        interface foo { }\n+                        @interface Foo { }\n+                    }\n+                }\n+                \"\"\",\n+            \"Test\\\\.java:(3:9|4:10): compiler\\\\.err\\\\.class\\\\.cant\\\\.write: Test\\\\.Annotation\\\\.(foo|Foo), output file clash: .*Test\\\\$Annotation\\\\$(foo|Foo)\\\\.class$\");\n+    }\n+\n+    @Test\n+    public void testCombiningAcuteAccent(Path base) throws Exception {\n+        testClash(base,\n+                \"\"\"\n+                public class Test {\n+                    interface Cafe\\u0301 {      \/\/ macos normalizes \"e\" + U0301 -> U00e9\n+                    }\n+                    interface Caf\\u00e9 {\n+                    }\n+                }\n+                \"\"\",\n+            \"Test\\\\.java:(2:5|4:5): compiler\\\\.err\\\\.class\\\\.cant\\\\.write: Test.Caf.*, output file clash: .*Test\\\\$Caf.*\\\\.class$\");\n+    }\n+\n+    @Test\n+    public void testBug7016187(Path base) throws Exception {\n+        testClash(base,\n+                \"\"\"\n+                public class Foo {\n+                    public static class Bar {\n+                        public static native void method1();\n+                    }\n+                }\n+                class Foo_Bar {\n+                    public static native void method2();\n+                }\n+                \"\"\",\n+            \"Foo\\\\.java:(2:8|6:1): compiler\\\\.err\\\\.class\\\\.cant\\\\.write: Foo.Bar, output file clash: .*Foo_Bar\\\\.h$\");\n+    }\n+\n+    private void testClash(Path base, String javaSource, String regex) throws Exception {\n+\n+        \/\/ Compile source\n+        Path src = base.resolve(\"src\");\n+        tb.writeJavaFiles(src, javaSource);\n+        Path classes = base.resolve(\"classes\");\n+        tb.createDirectories(classes);\n+        Path headers = base.resolve(\"headers\");\n+        tb.createDirectories(headers);\n+        List<String> log = new JavacTask(tb)\n+                .options(\"-XDrawDiagnostics\", \"--detect-output-file-clashes\")\n+                .outdir(classes)\n+                .headerdir(headers)\n+                .files(findJavaFiles(src))\n+                .run(Task.Expect.FAIL)\n+                .writeAll()\n+                .getOutputLines(Task.OutputKind.DIRECT);\n+\n+        \/\/ Find expected error line\n+        Pattern pattern = Pattern.compile(regex);\n+        if (!log.stream().anyMatch(line -> pattern.matcher(line).matches()))\n+            throw new Exception(\"expected error not found: \\\"\" + regex + \"\\\"\");\n+    }\n+\n+    public static void main(String... args) throws Exception {\n+        new OutputFileClashTest().runTests();\n+    }\n+}\n","filename":"test\/langtools\/tools\/javac\/file\/OutputFileClashTest.java","additions":155,"deletions":0,"binary":false,"changes":155,"status":"added"},{"patch":"@@ -58,0 +58,1 @@\n+    private Path headerdir;\n@@ -172,0 +173,20 @@\n+    \/**\n+     * Sets the native header output directory.\n+     * @param headerdir the native header output directory\n+     * @return this task object\n+     *\/\n+    public JavacTask headerdir(String headerdir) {\n+        this.headerdir = Paths.get(headerdir);\n+        return this;\n+    }\n+\n+    \/**\n+     * Sets the native header output directory.\n+     * @param headerdir the native header output directory\n+     * @return this task object\n+     *\/\n+    public JavacTask headerdir(Path headerdir) {\n+        this.headerdir = headerdir;\n+        return this;\n+    }\n+\n@@ -356,0 +377,2 @@\n+            if (headerdir != null)\n+                setLocationFromPaths(StandardLocation.NATIVE_HEADER_OUTPUT, Collections.singletonList(headerdir));\n@@ -425,0 +448,4 @@\n+        if (headerdir != null) {\n+            args.add(\"-h\");\n+            args.add(headerdir.toString());\n+        }\n","filename":"test\/langtools\/tools\/lib\/toolbox\/JavacTask.java","additions":27,"deletions":0,"binary":false,"changes":27,"status":"modified"}]}