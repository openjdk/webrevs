{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -106,1 +106,0 @@\n-    dlerror(); \/* clear any old error message not fetched *\/\n@@ -127,3 +126,0 @@\n-    \/\/ clear any old error message not fetched\n-    dlerror();\n-\n@@ -161,1 +157,14 @@\n-    if (jGetFunctionList != NULL) {\n+    \/\/ if none specified, then we try 3.0 API first before trying 2.40\n+    if (jGetFunctionList == NULL) {\n+        C_GetInterface = (CK_C_GetInterface) dlsym(hModule, \"C_GetInterface\");\n+        if (C_GetInterface != NULL) {\n+            TRACE0(\"Connect: Found C_GetInterface func\\n\");\n+            rv = (C_GetInterface)(NULL, NULL, &interface, 0L);\n+            \/\/ don't use ckAssertReturnValueOK as we want to continue trying\n+            \/\/ C_GetFunctionList() or method named by \"getFunctionListStr\"\n+            if (rv == CKR_OK) {\n+                goto setModuleData;\n+            }\n+        }\n+        getFunctionListStr = \"C_GetFunctionList\";\n+    } else {\n@@ -167,1 +176,4 @@\n-        C_GetFunctionList = (CK_C_GetFunctionList) dlsym(hModule,\n+    }\n+\n+    dlerror(); \/\/ clear any old error message not fetched\n+    C_GetFunctionList = (CK_C_GetFunctionList) dlsym(hModule,\n@@ -169,0 +181,1 @@\n+    if (C_GetFunctionList == NULL) {\n@@ -170,0 +183,2 @@\n+            TRACE2(\"Connect: error finding %s func: %s\\n\", getFunctionListStr,\n+                systemErrorMessage);\n@@ -171,3 +186,1 @@\n-            goto cleanup;\n-        }\n-        if (C_GetFunctionList == NULL) {\n+        } else {\n@@ -176,1 +189,0 @@\n-            goto cleanup;\n@@ -178,23 +190,1 @@\n-        TRACE1(\"Connect: Found %s func\\n\", getFunctionListStr);\n-    } else {\n-        \/\/ if none specified, then we try 3.0 API first before trying 2.40\n-        C_GetInterface = (CK_C_GetInterface) dlsym(hModule, \"C_GetInterface\");\n-        if ((C_GetInterface != NULL) && (dlerror() == NULL)) {\n-            TRACE0(\"Connect: Found C_GetInterface func\\n\");\n-            rv = (C_GetInterface)(NULL, NULL, &interface, 0L);\n-            if (ckAssertReturnValueOK(env, rv) == CK_ASSERT_OK) {\n-                goto setModuleData;\n-            }\n-        }\n-        C_GetFunctionList = (CK_C_GetFunctionList) dlsym(hModule,\n-                \"C_GetFunctionList\");\n-        if ((systemErrorMessage = dlerror()) != NULL){\n-            p11ThrowIOException(env, systemErrorMessage);\n-            goto cleanup;\n-        }\n-        if (C_GetFunctionList == NULL) {\n-            TRACE0(\"Connect: No C_GetFunctionList func\\n\");\n-            p11ThrowIOException(env, \"ERROR: C_GetFunctionList == NULL\");\n-            goto cleanup;\n-        }\n-        TRACE0(\"Connect: Found C_GetFunctionList func\\n\");\n+        goto cleanup;\n@@ -202,0 +192,1 @@\n+    TRACE1(\"Connect: Found %s func\\n\", getFunctionListStr);\n","filename":"src\/jdk.crypto.cryptoki\/unix\/native\/libj2pkcs11\/p11_md.c","additions":25,"deletions":34,"binary":false,"changes":59,"status":"modified"}]}