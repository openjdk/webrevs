{"files":[{"patch":"@@ -159,3 +159,4 @@\n-                Log.error(I18N.format(\"error.multiple.certs.found\", certificateSelector.signingIdentities().getFirst(),\n-                        keychain.map(Keychain::name).orElse(\"\")));\n-                return certs.getFirst();\n+                throw I18N.buildConfigException(\"error.multiple.certs.found\",\n+                        certificateSelector.signingIdentities().getFirst(),\n+                        keychain.map(Keychain::name).orElse(\"\")\n+                ).create();\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/SigningIdentityBuilder.java","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -39,1 +39,1 @@\n-error.multiple.certs.found=WARNING: Multiple certificates found matching [{0}] using keychain [{1}], using first one\n+error.multiple.certs.found=Multiple certificates matching name [{0}] found in keychain [{1}]\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/resources\/MacResources.properties","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+import jdk.jpackage.test.MacSign.CertificateType;\n@@ -158,14 +159,7 @@\n-    \/\/ Case \"--mac-signing-key-user-name\": jpackage selects first certificate\n-    \/\/ found with warning message. Certificate hash is pass to \"codesign\" in this\n-    \/\/ case.\n-    @Parameter({\"IMAGE\", \"0\", \"GOOD_SIGNING_KEY_USER_NAME\"})\n-    @Parameter({\"MAC_DMG\", \"0\", \"GOOD_SIGNING_KEY_USER_NAME\"})\n-    @Parameter({\"MAC_PKG\", \"0\", \"GOOD_SIGNING_KEY_USER_NAME_PKG\", \"GOOD_SIGNING_KEY_USER_NAME\"})\n-\n-    \/\/ Case \"--mac-app-image-sign-identity\": sign identity will be pass to\n-    \/\/ \"codesign\" and \"codesign\" should fail due to multiple certificates with\n-    \/\/ same common name found.\n-    @Parameter({\"IMAGE\", \"1\", \"GOOD_CODESIGN_SIGN_IDENTITY\"})\n-    @Parameter({\"MAC_PKG\", \"1\", \"GOOD_CODESIGN_SIGN_IDENTITY\", \"GOOD_PKG_SIGN_IDENTITY\"})\n-    @Parameter({\"MAC_PKG\", \"1\", \"GOOD_PKG_SIGN_IDENTITY\"})\n-    public static void testMultipleCertificates(PackageType type, int jpackageExitCode, SignOption... options) {\n+    @Parameter({\"IMAGE\", \"GOOD_SIGNING_KEY_USER_NAME\"})\n+    @Parameter({\"MAC_DMG\", \"GOOD_SIGNING_KEY_USER_NAME\"})\n+    @Parameter({\"MAC_PKG\", \"GOOD_SIGNING_KEY_USER_NAME_PKG\", \"GOOD_SIGNING_KEY_USER_NAME\"})\n+    @Parameter({\"IMAGE\", \"GOOD_CODESIGN_SIGN_IDENTITY\"})\n+    @Parameter({\"MAC_PKG\", \"GOOD_CODESIGN_SIGN_IDENTITY\", \"GOOD_PKG_SIGN_IDENTITY\"})\n+    @Parameter({\"MAC_PKG\", \"GOOD_PKG_SIGN_IDENTITY\"})\n+    public static void testMultipleCertificates(PackageType type, SignOption... options) {\n@@ -179,1 +173,11 @@\n-            SignOption.configureOutputValidation(cmd, List.of(options), opt -> {\n+            Predicate<SignOption> filter = opt -> {\n+                if (type == PackageType.MAC_PKG && options.length > 1) {\n+                    \/\/ Only the first error will be reported and it should always be\n+                    \/\/ for the app image signing, not for the PKG signing.\n+                    return opt.identityType() == CertificateType.CODE_SIGN;\n+                } else {\n+                    return true;\n+                }\n+            };\n+\n+            SignOption.configureOutputValidation(cmd, Stream.of(options).filter(filter).toList(), opt -> {\n@@ -181,1 +185,1 @@\n-            }).execute(jpackageExitCode);\n+            }).execute(1);\n@@ -247,0 +251,4 @@\n+        CertificateType identityType() {\n+            return cert.type();\n+        }\n+\n","filename":"test\/jdk\/tools\/jpackage\/macosx\/MacSignTest.java","additions":24,"deletions":16,"binary":false,"changes":40,"status":"modified"}]}