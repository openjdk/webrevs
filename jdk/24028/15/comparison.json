{"files":[{"patch":"@@ -94,1 +94,1 @@\n-        _stack_storage.get(prev->val().out.stack()).print_on(stream);\n+        _stack_storage.get(prev->val().out.reserved_stack()).print_on(stream);\n","filename":"src\/hotspot\/share\/nmt\/memoryFileTracker.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -46,2 +46,0 @@\n-\n-private:\n@@ -50,1 +48,0 @@\n-public:\n","filename":"src\/hotspot\/share\/nmt\/nmtNativeCallStackStorage.hpp","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -31,1 +31,1 @@\n-const VMATree::RegionData VMATree::empty_regiondata{NativeCallStackStorage::StackIndex{}, mtNone};\n+const VMATree::RegionData VMATree::empty_regiondata{NativeCallStackStorage::invalid, mtNone};\n@@ -37,0 +37,149 @@\n+NativeCallStackStorage::StackIndex VMATree::get_new_reserve_callstack(NativeCallStackStorage::StackIndex es, StateType ex, const RequestInfo& req){\n+  using SIndex = NativeCallStackStorage::StackIndex;\n+  const SIndex ES = NativeCallStackStorage::invalid; \/\/ Empty Stack\n+  const SIndex rq = req.callstack;\n+  auto st_to_index = [&](StateType st) -> int {\n+    return\n+      st == StateType::Released ? 0 :\n+      st == StateType::Reserved ? 1 :\n+      st == StateType::Committed ? 2 : -1;\n+  };\n+  const int op = req.op_to_index();\n+  assert(op >= 0 && op < 4, \"should be\");\n+                            \/\/ existing state\n+  SIndex result[4][3] = {\/\/ Rl  Rs   C\n+                           {ES, ES, ES},   \/\/ op == Release\n+                           {rq, rq, rq},   \/\/ op == Reserve\n+                           {es, es, es},   \/\/ op == Commit\n+                           {es, es, es}    \/\/ op == Uncommit\n+                           };\n+  return result[op][st_to_index(ex)];\n+}\n+\n+NativeCallStackStorage::StackIndex VMATree::get_new_commit_callstack(NativeCallStackStorage::StackIndex es, StateType ex, const RequestInfo& req){\n+  using SIndex = NativeCallStackStorage::StackIndex;\n+  const SIndex ES = NativeCallStackStorage::invalid; \/\/ Empty Stack\n+  const SIndex rq = req.callstack;\n+  auto st_to_index = [&](StateType st) -> int {\n+    return\n+      st == StateType::Released ? 0 :\n+      st == StateType::Reserved ? 1 :\n+      st == StateType::Committed ? 2 : -1;\n+  };\n+  const int op = req.op_to_index();\n+  assert(op >= 0 && op < 4, \"should be\");\n+                            \/\/ existing state\n+  SIndex result[4][3] = {\/\/ Rl  Rs   C\n+                           {ES, ES, ES},   \/\/ op == Release\n+                           {ES, ES, ES},   \/\/ op == Reserve\n+                           {rq, rq, rq},   \/\/ op == Commit\n+                           {ES, ES, ES}    \/\/ op == Uncommit\n+                           };\n+  return result[op][st_to_index(ex)];\n+}\n+\n+VMATree::StateType VMATree::get_new_state(StateType ex, const RequestInfo& req) {\n+  const StateType Rl = StateType::Released;\n+  const StateType Rs = StateType::Reserved;\n+  const StateType C = StateType::Committed;\n+  auto st_to_index = [&](StateType st) -> int {\n+    return\n+      st == StateType::Released ? 0 :\n+      st == StateType::Reserved ? 1 :\n+      st == StateType::Committed ? 2 : -1;\n+  };\n+  const int op = req.op_to_index();\n+  assert(op >= 0 && op < 4, \"should be\");\n+                            \/\/ existing state\n+  StateType result[4][3] = {\/\/ Rl  Rs   C\n+                              {Rl, Rl, Rl},   \/\/ op == Release\n+                              {Rs, Rs, Rs},   \/\/ op == Reserve\n+                              { C,  C,  C},   \/\/ op == Commit\n+                              {Rl, Rs, Rs}    \/\/ op == Uncommit\n+                           };\n+  return result[op][st_to_index(ex)];\n+}\n+\n+void VMATree::compute_summary_diff(SingleDiff::delta region_size, MemTag t1, const StateType& ex, const RequestInfo& req, MemTag t2, SummaryDiff& diff) {\n+  const StateType Rl = StateType::Released;\n+  const StateType Rs = StateType::Reserved;\n+  const StateType C = StateType::Committed;\n+  auto st_to_index = [&](StateType st) -> int {\n+    return\n+      st == StateType::Released ? 0 :\n+      st == StateType::Reserved ? 1 :\n+      st == StateType::Committed ? 2 : -1;\n+  };\n+  const int op = req.op_to_index();\n+  assert(op >= 0 && op < 4, \"should be\");\n+\n+  SingleDiff::delta a = region_size;\n+  \/\/ A region with size `a` has a state as <column> and an operation is requested as in <row>\n+  \/\/ The region has tag `t1` and the operation has tag `t2`.\n+  \/\/ For each state, we decide how much to be added\/subtracted from t1 to t2. Two tables for reserve and commit.\n+  \/\/ Each pair of <x,y> in the table means add `x` to t1 and add `y` to t2. There are 3 pairs in each row for 3 states.\n+  \/\/ For example, `reserve[1][4,5]` says `-a,a` means:\n+  \/\/    - we are reserving with t2 a region which is already commited with t1\n+  \/\/    - since we are reserving, then `a` will be added to t2. (`y` is `a`)\n+  \/\/    - since we uncommitting (by reserving) then `a` is to be subtracted from t1. (`x` is `-a`).\n+  \/\/    - amount of uncommitted size is in table `commit[1][4,5]` which is `-a,0` that means subtract `a` from t1.\n+                                       \/\/ existing state\n+  SingleDiff::delta reserve[4][3*2] = {\/\/ Rl    Rs     C\n+                                         {0,0, -a,0, -a,0 },   \/\/ op == Release\n+                                         {0,a, -a,a, -a,a },   \/\/ op == Reserve\n+                                         {0,a,  0,0,  0,0 },   \/\/ op == Commit\n+                                         {0,0,  0,0,  0,0 }    \/\/ op == Uncommit\n+                                      };\n+  SingleDiff::delta commit[4][3*2] = {\/\/ Rl    Rs     C\n+                                        {0,0,  0,0, -a,0 },   \/\/ op == Release\n+                                        {0,a,  0,a, -a,0 },   \/\/ op == Reserve\n+                                        {0,a,  0,a, -a,a },   \/\/ op == Commit\n+                                        {0,0,  0,0, -a,0 }    \/\/ op == Uncommit\n+                                     };\n+  SingleDiff& from_rescom = diff.tag[NMTUtil::tag_to_index(t1)];\n+  SingleDiff&   to_rescom = diff.tag[NMTUtil::tag_to_index(t2)];\n+  int st = st_to_index(ex);\n+  tty->print_cr(\"%d %d %d %d %ld %ld\", (int)t1, (int)t2, op, st, from_rescom.reserve, to_rescom.reserve);\n+  from_rescom.reserve += reserve[op][st * 2    ];\n+    to_rescom.reserve += reserve[op][st * 2 + 1];\n+  from_rescom.commit  +=  commit[op][st * 2    ];\n+    to_rescom.commit  +=  commit[op][st * 2 + 1];\n+\n+}\n+\n+void VMATree::update_region(TreapNode* n1, TreapNode* n2, const RequestInfo& req, SummaryDiff& diff) {\n+  using SIndex = NativeCallStackStorage::StackIndex;\n+  IntervalState exSt; \/\/ existing state info\n+  assert(n1 != nullptr,\"sanity\");\n+  assert(n2 != nullptr,\"sanity\");\n+  if (n1->key() == req.A) {\n+    exSt = n1->val().in;\n+  } else {\n+    exSt = n1->val().out;\n+  }\n+\n+  StateType existing_state              = exSt.type();\n+  MemTag    existing_tag                = exSt.mem_tag();\n+  SIndex    existing_reserve_callstack  = exSt.reserved_stack();\n+  SIndex    existing_commit_callstack   = exSt.committed_stack();\n+\n+  StateType new_state                   = get_new_state(existing_state, req);\n+  MemTag    new_tag                     = req.use_tag_inplace ? existing_tag : req.tag;\n+  SIndex    new_reserve_callstack       = get_new_reserve_callstack(existing_reserve_callstack, existing_state, req);\n+  SIndex    new_committ_callstack       = get_new_reserve_callstack(existing_reserve_callstack, existing_state, req);\n+\n+  n1->val().out.set_tag(new_tag);\n+  n1->val().out.set_type(new_state);\n+  n1->val().out.set_commit_stack(new_committ_callstack);\n+  n1->val().out.set_reserve_stack(new_reserve_callstack);\n+\n+  n2->val().in.set_tag(new_tag);\n+  n2->val().in.set_type(new_state);\n+  n2->val().in.set_commit_stack(new_committ_callstack);\n+  n2->val().in.set_reserve_stack(new_reserve_callstack);\n+\n+  SingleDiff::delta region_size = n2->key() - n1->key();\n+  compute_summary_diff(region_size, existing_tag, existing_state, req, new_tag, diff);\n+}\n+\n+\n@@ -39,0 +188,184 @@\n+\n+  if (A == B) {\n+    return SummaryDiff();\n+  }\n+  assert(A < B, \"should be\");\n+  SummaryDiff diff;\n+  RequestInfo req{A, B, state, metadata.mem_tag, metadata.stack_idx, use_tag_inplace};\n+  IntervalChange stA{\n+      IntervalState{StateType::Released, empty_regiondata},\n+      IntervalState{              state,   metadata}\n+  };\n+  IntervalChange stB{\n+      IntervalState{              state,   metadata},\n+      IntervalState{StateType::Released, empty_regiondata}\n+  };\n+  VMATreap::Range rA = _tree.find_enclosing_range(A);\n+  VMATreap::Range rB = _tree.find_enclosing_range(B);\n+  \/\/ nodes:          .....X.......Y...Z......W........U\n+  \/\/ request:                 A------------------B\n+  \/\/ X,Y = enclosing_nodes(A)\n+  \/\/ W,U = enclosing_nodes(B)\n+  \/\/ The cases are whether or not X and Y exists and X == A. (A == Y doesn't happen since it is searched by 'lt' predicate)\n+  \/\/ The cases are whether or not W and U exists and W == B. (B == U doesn't happen since it is searched by 'lt' predicate)\n+\n+  \/\/ We update regions in 3 sections: 1) X..A..Y, 2) Y....W, 3) W..B..U\n+  \/\/ The regons in [Y,W) are updated in a loop. We update X..A..Y before the loop and W..B..U after the loop.\n+  \/\/ The table below summarizes the cases and what to do.\n+  \/\/ 'update'  for a region [a,b) means call 'update_region(node a, node b, req, diff)' to update the region based on existing State and the request.\n+\n+\n+  \/\/                                                                                              Regions before loop                                         Regions in\n+  \/\/                                                             X exists     Y exists    X == A   [X,A)         [A,Y)    remove X if        upsert A if       the loop                                    to do after loop\n+  \/\/                                                             --------     --------    ------   ------        -----    ---------------    --------------   -------------  ----------------------------------------------------------------\n+  \/\/ row  0: nodes:          .........A..................B.....  no             no        --       --            --        --                 !A_is_noop()        --\n+  \/\/ row  1: nodes:          .....X...A..................B.....  yes            no        no       A.in = X.out  --        --                 !A_is_noop()        --\n+  \/\/ row  2: nodes:          .....XA.....................B.....  yes            no        yes      A.in = X.in   --        X.in == A.out      !remove_X           --\n+  \/\/ row  3: nodes:          .........A...Y...Z......W...B....U  no             yes       --       --            update    --                 !A_is_noop()       [Y,W)\n+  \/\/ row  4: nodes:          .....X...A...Y...Z......W...B....U  yes            yes       no       A.in = X.out  update    --                 !A_is_noop()       [Y,W)\n+  \/\/ row  5: nodes:          .....XA......Y...Z......W...B....U  yes            yes       yes      A.in = X.in   update    X.in == A.out      !remove_X          [Y,W)\n+  \/\/       :\n+  \/\/       :                                                     W exists     U exists    W == B                                                                             [W,B)         [B,U)            remove W if       upsert B if\n+  \/\/       :                                                     --------     --------    ------   ------------------------------------------------------------------------  -----         ------          ----------------  ---------------\n+  \/\/ row  6: nodes:          .........A..................B.....   no            no          --                                                                                --            --              --                !B.is_noop()\n+  \/\/ row  7: nodes:          .........A..................B....U   no            yes         --                                                                                --           B.out = U.in     --                !B.is_noop()\n+  \/\/ row  8: nodes:          .....X...A...Y...Z......W...B.....   yes           no          no                                                                                update        --              W.is_noop()       !B.is_noop()\n+  \/\/ row  9: nodes:          .....X...A...Y...Z......WB........   yes           no          yes                                                                               --            --              W.in == B.out     !remove_W\n+  \/\/ row 10: nodes:          .....X...A...Y...Z......W...B....U   yes           yes         no                                                                                update       B.out = U.in     W.is_noop()       !B.is_noop()\n+  \/\/ row 11: nodes:          .....X...A...Y...Z......WB.......U   yes           yes         yes                                                                               --            --              W.in == B.out     !remove_W\n+\n+  \/\/ We intentionally did not summarize\/compress the cases to have them as separate. This expanded way of describing the cases helps us to understand\/analyze\/verify\/debug\/maintain the corresponding code more easily.\n+  \/\/ Mapping of table to row, row to switch-case, 'what to do' to code should be consistent. If one changes, the others have to be updated accordingly.\n+  \/\/ The sequence of dependecies is: table -> row no -> switch(row)-case -> code. Meaning that whenever any of one item in this sequence is changed, the rest of the consequent items to be checked\/changed.\n+\n+  TreapNode* X = rA.start;\n+  TreapNode* Y = rA.end;\n+  TreapNode nA{A, stA, 0}; \/\/ the node that represents A\n+  bool X_exists = X != nullptr;\n+  bool Y_exists = Y != nullptr;\n+  bool X_eq_A = X_exists && rA.start->key() == A;\n+  int row = -1;\n+  if (!X_exists && !Y_exists           ) { row = 0; }\n+  if ( X_exists && !Y_exists && !X_eq_A) { row = 1; }\n+  if ( X_exists && !Y_exists &&  X_eq_A) { row = 2; }\n+  if (!X_exists &&  Y_exists           ) { row = 3; }\n+  if (!X_exists &&  Y_exists && !X_eq_A) { row = 4; }\n+  if ( X_exists &&  Y_exists &&  X_eq_A) { row = 5; }\n+\n+  \/\/ ************************************************************************************ Before loop\n+  switch(row) {\n+    case 0:\n+      if (!stA.is_noop()) { _tree.upsert(A, stA); }\n+      break;\n+    case 1:\n+      stA.in = X->val().out;\n+      if (!stA.is_noop()) { _tree.upsert(A, stA); }\n+      break;\n+    case 2:\n+      stA.in = X->val().in;\n+      if (X->val().in.equals(stA.out)) {\n+        _tree.remove(X->key());\n+      } else {\n+        _tree.upsert(A, stA);\n+      }\n+      break;\n+    case 3:\n+      update_region(&nA, Y, req, diff);\n+      if (!nA.val().is_noop()) { _tree.upsert(A, nA.val()); }\n+      break;\n+    case 4:\n+      stA.in = X->val().out;\n+      update_region(&nA, Y, req, diff);\n+      if (!nA.val().is_noop()) { _tree.upsert(A, nA.val()); }\n+      break;\n+    case 5:\n+      stA.in = X->val().in;\n+      update_region(&nA, Y, req, diff);\n+      if (X->val().in.equals(stA.out)) {\n+        _tree.remove(X->key());\n+      } else {\n+        _tree.upsert(A, nA.val());\n+      }\n+      break;\n+    default:\n+      break;\n+  }\n+\n+  \/\/ ************************************************************************************ Loop\n+  GrowableArrayCHeap<position, mtNMT> to_be_removed;\n+  TreapNode* prev = nullptr;\n+  _tree.visit_range_in_order(Y->key(), B + 1, [&](TreapNode* curr){\n+    if (prev != nullptr) {\n+      update_region(prev, curr, req, diff);\n+      \/\/ during visit, structure of the tree should not be changed\n+      \/\/ keep the keys to be removed, and remove them later\n+      if (prev->val().is_noop()) {\n+        to_be_removed.push(prev->key());\n+      }\n+    }\n+    prev = curr;\n+  });\n+\n+  \/\/ ************************************************************************************ After loop\n+  TreapNode* W = rB.start;\n+  TreapNode* U = rB.end;\n+  TreapNode nB{B, stB, 0}; \/\/ the node that represents B\n+  bool W_exists = W != nullptr;\n+  bool U_exists = U != nullptr;\n+  bool W_eq_B = W_exists && W->key() == B;\n+  if (!W_exists && !U_exists           ) { row = 6; }\n+  if (!W_exists &&  U_exists           ) { row = 7; }\n+  if ( W_exists && !U_exists && !W_eq_B) { row = 8; }\n+  if ( W_exists && !U_exists &&  W_eq_B) { row = 9; }\n+  if ( W_exists &&  U_exists && !W_eq_B) { row = 10; }\n+  if ( W_exists &&  U_exists &&  W_eq_B) { row = 11; }\n+  switch(row) {\n+    case 6:\n+      if (!stB.is_noop()) { _tree.upsert(B, stB); }\n+      break;\n+    case 7:\n+      stB.out = U->val().in;\n+      if (!stB.is_noop()) { _tree.upsert(B, stB); }\n+      break;\n+    case 8:\n+      update_region(W, &nB, req, diff);\n+      if (W->val().is_noop()) { _tree.remove(W->key()); }\n+      if (!nB.val().is_noop()) { _tree.upsert(B, nB.val()); }\n+      break;\n+    case 9:\n+      if (W->val().in.equals(stB.out)) {\n+        _tree.remove(W->key());\n+      } else {\n+        _tree.upsert(B, stB);\n+      }\n+      break;\n+    case 10:\n+      stB.out = U->val().in;\n+      update_region(W, &nB, req, diff);\n+      if (W->val().in.equals(stB.out)) {\n+        _tree.remove(W->key());\n+      } else {\n+        _tree.upsert(B, stB);\n+      }\n+      break;\n+    case 11:\n+      if (W->val().in.equals(stB.out)) {\n+        _tree.remove(W->key());\n+      } else {\n+        _tree.upsert(B, stB);\n+      }\n+      break;\n+    default:\n+      break;\n+  }\n+\n+\n+  \/\/ ************************************************************************************ Delete noop nodes found in the loop\n+  while(to_be_removed.length() != 0) {\n+    _tree.remove(to_be_removed.pop());\n+  }\n+\n+  return diff;\n+}\n+VMATree::SummaryDiff VMATree::register_mapping_new(position A, position B, StateType state,\n+                                                   const RegionData& metadata, bool use_tag_inplace) {\n@@ -55,0 +388,15 @@\n+  bool is_reserve_operation = state == StateType::Reserved && !use_tag_inplace;\n+  bool is_uncommit_operation = state == StateType::Reserved && use_tag_inplace;\n+  bool is_commit_operation = state == StateType::Committed;\n+  stA.out.set_reserve_stack(NativeCallStackStorage::invalid);\n+  stB.in.set_reserve_stack(NativeCallStackStorage::invalid);\n+  stA.out.set_commit_stack(NativeCallStackStorage::invalid);\n+  stA.in.set_commit_stack(NativeCallStackStorage::invalid);\n+  if (is_reserve_operation) {\n+    stA.out.set_reserve_stack(metadata.stack_idx);\n+    stB.in.set_reserve_stack(metadata.stack_idx);\n+  }\n+  if (is_commit_operation) {\n+    stA.out.set_commit_stack(metadata.stack_idx);\n+    stB.in.set_commit_stack(metadata.stack_idx);\n+  }\n@@ -65,0 +413,3 @@\n+    stA.out.set_reserve_stack(metadata.stack_idx);\n+    stB.in.set_reserve_stack(metadata.stack_idx);\n+\n@@ -89,0 +440,11 @@\n+      if (is_commit_operation) {\n+        if (leqA_n->val().out.has_reserved_stack()) {\n+          stA.out.set_reserve_stack(leqA_n->val().out.reserved_stack());\n+        } else {\n+          stA.out.set_reserve_stack(metadata.stack_idx);\n+        }\n+      }\n+      if (is_uncommit_operation) {\n+        stA.out.set_reserve_stack(leqA_n->val().out.reserved_stack());\n+        stA.out.set_commit_stack(NativeCallStackStorage::invalid);\n+      }\n@@ -112,0 +474,13 @@\n+      if (is_commit_operation) {\n+        if (leqA_n->val().out.has_reserved_stack()) {\n+          stA.out.set_reserve_stack(leqA_n->val().out.reserved_stack());\n+          stB.in.set_reserve_stack(leqA_n->val().out.reserved_stack());\n+        } else {\n+          stA.out.set_reserve_stack(metadata.stack_idx);\n+          stB.in.set_reserve_stack(metadata.stack_idx);\n+        }\n+      }\n+      if (is_uncommit_operation) {\n+        stA.out.set_reserve_stack(leqA_n->val().out.reserved_stack());\n+        stB.in.set_reserve_stack(leqA_n->val().out.reserved_stack());\n+      }\n@@ -222,2 +597,3 @@\n-    out->print(\"%zu (%s) - %s - \", current->key(), NMTUtil::tag_to_name(out_state(current).mem_tag()),\n-               statetype_to_string(out_state(current).type()));\n+    out->print(\"%zu (%s) - %s [%d, %d]- \", current->key(), NMTUtil::tag_to_name(out_state(current).mem_tag()),\n+               statetype_to_string(out_state(current).type()), current->val().out.reserved_stack(), current->val().out.committed_stack());\n+\n@@ -271,1 +647,1 @@\n-    RegionData new_data = RegionData(out.stack(), tag);\n+    RegionData new_data = RegionData(out.reserved_stack(), tag);\n@@ -292,1 +668,1 @@\n-      RegionData new_data = RegionData(out.stack(), tag);\n+      RegionData new_data = RegionData(out.reserved_stack(), tag);\n","filename":"src\/hotspot\/share\/nmt\/vmatree.cpp","additions":381,"deletions":5,"binary":false,"changes":386,"status":"modified"},{"patch":"@@ -94,1 +94,2 @@\n-    NativeCallStackStorage::StackIndex sidx;\n+    NativeCallStackStorage::StackIndex _reserved_stack;\n+    NativeCallStackStorage::StackIndex _committed_stack;\n@@ -97,1 +98,1 @@\n-    IntervalState() : type_tag{0,0}, sidx() {}\n+    IntervalState() : type_tag{0,0}, _reserved_stack(NativeCallStackStorage::invalid), _committed_stack(NativeCallStackStorage::invalid) {}\n@@ -102,1 +103,2 @@\n-      sidx = data.stack_idx;\n+      _reserved_stack = data.stack_idx;\n+      _committed_stack = NativeCallStackStorage::invalid;\n@@ -113,2 +115,5 @@\n-    RegionData regiondata() const {\n-      return RegionData{sidx, mem_tag()};\n+    RegionData reserved_regiondata() const {\n+      return RegionData{_reserved_stack, mem_tag()};\n+    }\n+    RegionData committed_regiondata() const {\n+      return RegionData{_committed_stack, mem_tag()};\n@@ -121,2 +126,33 @@\n-    NativeCallStackStorage::StackIndex stack() const {\n-     return sidx;\n+    NativeCallStackStorage::StackIndex reserved_stack() const {\n+      return _reserved_stack;\n+    }\n+\n+    NativeCallStackStorage::StackIndex committed_stack() const {\n+      return _committed_stack;\n+    }\n+\n+    void set_reserve_stack(NativeCallStackStorage::StackIndex idx) {\n+      _reserved_stack = idx;\n+    }\n+\n+    void set_commit_stack(NativeCallStackStorage::StackIndex idx) {\n+      _committed_stack = idx;\n+    }\n+\n+    bool has_reserved_stack() {\n+      return _reserved_stack != NativeCallStackStorage::invalid;\n+    }\n+\n+    bool has_committed_stack() {\n+      return _committed_stack != NativeCallStackStorage::invalid;\n+    }\n+\n+    void set_type(StateType t) {\n+      type_tag[0] = static_cast<uint8_t>(t);\n+    }\n+\n+    bool equals(const IntervalState& other) const {\n+      return mem_tag()          == other.mem_tag()          &&\n+             type()             == other.type()             &&\n+             reserved_stack()   == other.reserved_stack()   &&\n+             committed_stack()  == other.committed_stack();\n@@ -133,0 +169,5 @@\n+      if (in.type() == StateType::Released &&\n+          in.type() == out.type() &&\n+          in.mem_tag() == out.mem_tag()) {\n+        return true;\n+      }\n@@ -134,1 +175,2 @@\n-             RegionData::equals(in.regiondata(), out.regiondata());\n+             RegionData::equals(in.reserved_regiondata(), out.reserved_regiondata()) &&\n+             RegionData::equals(in.committed_regiondata(), out.committed_regiondata());\n@@ -166,0 +208,14 @@\n+  struct RequestInfo {\n+    position A, B;\n+    StateType op;\n+    MemTag tag;\n+    NativeCallStackStorage::StackIndex callstack;\n+    bool use_tag_inplace;\n+    int op_to_index() const {\n+      return\n+            op == StateType::Released ? 0 :\n+            op == StateType::Reserved && !use_tag_inplace ? 1 :\n+            op == StateType::Committed ? 2 :\n+            op == StateType::Reserved && use_tag_inplace ? 3 : -1;\n+    }\n+  };\n@@ -198,0 +254,6 @@\n+  SummaryDiff register_mapping_new(position A, position B, StateType state, const RegionData& metadata, bool use_tag_inplace = false);\n+  StateType get_new_state(StateType existinting_state, const RequestInfo& req);\n+  NativeCallStackStorage::StackIndex get_new_reserve_callstack(NativeCallStackStorage::StackIndex existinting_stack, StateType ex, const RequestInfo& req);\n+  NativeCallStackStorage::StackIndex get_new_commit_callstack(NativeCallStackStorage::StackIndex existinting_stack, StateType ex, const RequestInfo& req);\n+  void compute_summary_diff(SingleDiff::delta region_size, MemTag t1, const StateType& ex, const RequestInfo& req, MemTag new_tag, SummaryDiff& diff);\n+  void update_region(TreapNode* n1, TreapNode* n2, const RequestInfo& req, SummaryDiff& diff);\n","filename":"src\/hotspot\/share\/nmt\/vmatree.hpp","additions":70,"deletions":8,"binary":false,"changes":78,"status":"modified"},{"patch":"@@ -39,1 +39,1 @@\n-  constexpr static const int si_len = 2;\n+  constexpr static const int si_len = 4;\n@@ -46,0 +46,2 @@\n+    stacks[2] = make_stack(0xC);\n+    stacks[3] = make_stack(0xD);\n@@ -47,1 +49,3 @@\n-    si[1] = ncs.push(stacks[0]);\n+    si[1] = ncs.push(stacks[1]);\n+    si[2] = ncs.push(stacks[2]);\n+    si[3] = ncs.push(stacks[3]);\n@@ -175,0 +179,1 @@\n+  return;\n@@ -232,1 +237,1 @@\n-        EXPECT_EQ(x->val().out.regiondata().mem_tag, mtTest);\n+        EXPECT_EQ(x->val().out.reserved_regiondata().mem_tag, mtTest);\n@@ -268,1 +273,1 @@\n-        EXPECT_EQ(mtTest, x->val().out.regiondata().mem_tag);\n+        EXPECT_EQ(mtTest, x->val().out.reserved_regiondata().mem_tag);\n@@ -271,1 +276,1 @@\n-        EXPECT_EQ(mtTest, x->val().in.regiondata().mem_tag);\n+        EXPECT_EQ(mtTest, x->val().in.reserved_regiondata().mem_tag);\n@@ -292,1 +297,1 @@\n-    NCS::StackIndex stack;\n+    NCS::StackIndex reserve_stack;\n@@ -297,1 +302,1 @@\n-  auto expect_equivalent_form = [&](auto& expected, VMATree& tree) {\n+  auto expect_equivalent_form = [&](auto& expected, VMATree& tree, int line_no) {\n@@ -317,2 +322,2 @@\n-      EXPECT_EQ(expect.stack, found.start->val().out.stack());\n-      EXPECT_EQ(expect.stack, found.end->val().in.stack());\n+      EXPECT_EQ(expect.reserve_stack, found.start->val().out.reserved_stack()) << \"Unexpected stack at region: \" << i << \" and at test-line: \" << line_no;\n+      EXPECT_EQ(expect.reserve_stack, found.end->val().in.reserved_stack()) << \"Unexpected stack at region: \" << i << \" and at test-line: \" << line_no;\n@@ -327,0 +332,2 @@\n+  NCS::StackIndex es = NCS::invalid; \/\/ empty or no stack is stored\n+\n@@ -340,1 +347,1 @@\n-    expect_equivalent_form(expected, tree);\n+    expect_equivalent_form(expected, tree, __LINE__);\n@@ -364,1 +371,1 @@\n-    expect_equivalent_form(expected, tree);\n+    expect_equivalent_form(expected, tree, __LINE__);\n@@ -377,1 +384,1 @@\n-    expect_equivalent_form(expected, tree);\n+    expect_equivalent_form(expected, tree, __LINE__);\n@@ -393,1 +400,1 @@\n-    expect_equivalent_form(expected, tree);\n+    expect_equivalent_form(expected, tree, __LINE__);\n@@ -406,1 +413,1 @@\n-    expect_equivalent_form(expected, tree);\n+    expect_equivalent_form(expected, tree, __LINE__);\n@@ -421,1 +428,1 @@\n-    expect_equivalent_form(expected, tree);\n+    expect_equivalent_form(expected, tree, __LINE__);\n@@ -427,1 +434,1 @@\n-        {50,  75,        mtNone, si, State::Released},\n+        {50,  75,        mtNone, es, State::Released},\n@@ -436,1 +443,1 @@\n-    expect_equivalent_form(expected, tree);\n+    expect_equivalent_form(expected, tree, __LINE__);\n@@ -447,1 +454,1 @@\n-    expect_equivalent_form(expected, tree);\n+    expect_equivalent_form(expected, tree, __LINE__);\n@@ -453,1 +460,1 @@\n-        { 1,  50, mtNone, si, State::Released},\n+        { 1,  50, mtNone, es, State::Released},\n@@ -455,1 +462,1 @@\n-        {75,  99, mtNone, si, State::Released},\n+        {75,  99, mtNone, es, State::Released},\n@@ -464,1 +471,1 @@\n-    expect_equivalent_form(expected, tree);\n+    expect_equivalent_form(expected, tree, __LINE__);\n@@ -499,0 +506,1 @@\n+    tree.print_on(tty);\n@@ -500,0 +508,1 @@\n+    tree.print_on(tty);\n@@ -716,4 +725,15 @@\n-        const NativeCallStack& start_stack = ncss.get(startn->val().out.stack());\n-        const NativeCallStack& end_stack = ncss.get(endn->val().in.stack());\n-        ASSERT_TRUE(starti.stack.equals(start_stack));\n-        ASSERT_TRUE(endi.stack.equals(end_stack));\n+        const NativeCallStack& start_stack = ncss.get(startn->val().out.reserved_stack());\n+        const NativeCallStack& end_stack = ncss.get(endn->val().in.reserved_stack());\n+        \/\/ If start-node of a reserved region is committed, the stack is stored in the second_stack of the node.\n+        if (startn->val().out.has_committed_stack()) {\n+          const NativeCallStack& start_second_stack = ncss.get(startn->val().out.committed_stack());\n+          ASSERT_TRUE(starti.stack.equals(start_stack) || starti.stack.equals(start_second_stack));\n+        } else {\n+          ASSERT_TRUE(starti.stack.equals(start_stack));\n+        }\n+        if (endn->val().in.has_committed_stack()) {\n+          const NativeCallStack& end_second_stack = ncss.get(endn->val().in.committed_stack());\n+          ASSERT_TRUE(endi.stack.equals(end_stack) || endi.stack.equals(end_second_stack));\n+        } else {\n+          ASSERT_TRUE(endi.stack.equals(end_stack));\n+        }\n@@ -742,0 +762,1180 @@\n+}\n+\n+template<int NodeCount> struct ExpectedTree {\n+  int nodes[NodeCount];\n+  MemTag tags[NodeCount + 1];\n+  VMATree::StateType states[NodeCount + 1];\n+  NativeCallStackStorage::StackIndex res_si[NodeCount + 1];\n+  NativeCallStackStorage::StackIndex com_si[NodeCount + 1];\n+};\n+template <int N>\n+void check_tree(Tree& tree,const ExpectedTree<N>& et, int line_no) {\n+  using Node = VMATree::TreapNode;\n+  auto left_released = [&](Node n) -> bool {\n+    return n.val().in.type() == VMATree::StateType::Released and\n+           n.val().in.mem_tag() == mtNone;\n+  };\n+  auto right_released = [&](Node n) -> bool {\n+    return n.val().out.type() == VMATree::StateType::Released and\n+           n.val().out.mem_tag() == mtNone;\n+  };\n+  for (int i = 0; i < N; i++) {\n+    VMATree::VMATreap::Range r = tree.tree().find_enclosing_range(et.nodes[i]);\n+    ASSERT_TRUE(r.start != nullptr);\n+    Node node = *r.start;\n+    ASSERT_EQ(node.key(), (VMATree::position)et.nodes[i]) << \"at line \" << line_no;\n+    if (i == (N -1)) { \/\/ last node\n+      EXPECT_TRUE(right_released(node)) << \"right-of last node is not Released\";\n+      break;\n+    }\n+    if (i == 0) { \/\/ first node\n+      EXPECT_TRUE(left_released(node)) << \"left-of first node is not Released\";\n+    }\n+    stringStream ss(50);\n+    ss.print(\"test at line: %d, for node: %d\", line_no, et.nodes[i]);\n+    const char* for_this_node = ss.base();\n+    EXPECT_EQ(node.val().out.type(), et.states[i+1]) << for_this_node;\n+    EXPECT_EQ(node.val().out.mem_tag(), et.tags[i+1]) << for_this_node;\n+    if (et.res_si[i+1] >= 0) {\n+      EXPECT_EQ(node.val().out.reserved_stack(), et.res_si[i+1]) << for_this_node;\n+      EXPECT_EQ(r.end->val().in.reserved_stack(), et.res_si[i+1]) << for_this_node;\n+    } else {\n+      EXPECT_FALSE(node.val().out.has_reserved_stack()) << for_this_node;\n+      EXPECT_FALSE(r.end->val().in.has_reserved_stack()) << for_this_node;\n+    }\n+    if (et.com_si[i+1] >= 0) {\n+      EXPECT_EQ(node.val().out.committed_stack(), et.com_si[i+1]) << for_this_node;\n+      EXPECT_EQ(r.end->val().in.committed_stack(), et.com_si[i+1]) << for_this_node;\n+    } else {\n+      EXPECT_FALSE(node.val().out.has_committed_stack()) << for_this_node;\n+      EXPECT_FALSE(r.end->val().in.has_committed_stack()) << for_this_node;\n+    }\n+  }\n+}\n+\n+TEST_VM_F(NMTVMATreeTest, SeparateStacksForCommitAndReserve) {\n+  using SIndex = NativeCallStackStorage::StackIndex;\n+  using State = VMATree::StateType;\n+  SIndex si_1 = si[0];\n+  SIndex si_2 = si[1];\n+\n+  const State Rs = State::Reserved;\n+  const State Rl = State::Released;\n+  const State C = State::Committed;\n+  VMATree::RegionData call_stack_1(si_1, mtTest);\n+  VMATree::RegionData call_stack_2(si_2, mtNone);\n+\n+  \/\/ Visualization guide\n+  \/\/ Nodes in the tree are shown in ascending order as:\n+  \/\/ A....B-----C*****D---E... means:\n+  \/\/   [A,B) is released\n+  \/\/   [B,C) is reserved, same as [D,E)\n+  \/\/   [C,D) is committed\n+  \/\/ Each node A in the tree has this metada (MemTag, State, Reserve Call-Stack, Commit Call-Stack);\n+  \/\/  one for the region to its left (called 'in'), and one for the region to its right (called 'out').\n+  \/\/ For every adjacent nodes of [A,B), always A.out == B.in (required).\n+  \/\/ In visualizations, we can avoid repeating metadata of A.out for B.in and write them once.\n+  \/\/ So for example, we write:\n+  \/\/                     A....B-----C*****D-----E...\n+  \/\/ MemTag:               mt1   mt2   mt3  mt4\n+  \/\/ State:                Rl    Rs    C    Rs\n+  \/\/ Reserve Call-Stack:   -     CS2   CS3  CS4\n+  \/\/ Commit Call-Stack:    -     CS2   CS5  CS4\n+  \/\/\n+  \/\/ where Rl = Released, Rs = Reserved and C = Committed.\n+  \/\/ '-' for call-stack means 'empty'\n+\n+\n+\n+  {\/\/ Check committing into a reserved region inherits the call stacks\n+    Tree tree;\n+    tree.reserve_mapping(0, 100, call_stack_1); \/\/ reserve in an empty tree\n+    \/\/ Pre: empty tree.\n+    \/\/ Post: .........0---------100.........\n+    \/\/        mtNone    mtTest       mtNone\n+    \/\/        Rl        Rs           Rl\n+    \/\/        -         si_1         -\n+    \/\/        -         -            -\n+    ExpectedTree<2> et1 = {{      0  , 100        },\n+                           {mtNone, mtTest, mtNone},\n+                           {Rl    , Rs    , Rl    },\n+                           {-1    , si_1  , -1    },\n+                           {-1    , -1    , -1    }};\n+    check_tree(tree, et1, __LINE__);\n+\n+    tree.commit_mapping(25, 25, call_stack_2, true); \/\/ commit at the middle of the region\n+    \/\/ Pre : .........0------------------------------100.........\n+    \/\/ Post: .........0---------25*********50--------100.........\n+    \/\/        mtNone    mtTest       mtTest   mtTest     mtNone\n+    \/\/        Rl        Rs           C        Rs         Rl\n+    \/\/        -         si_1         si_1     si_1       -\n+    \/\/        -         -            si_2     -          -\n+    ExpectedTree<4> et2 = {{      0  , 25,      50,    100        },\n+                           {mtNone, mtTest, mtTest, mtTest, mtNone},\n+                           {Rl    , Rs    , C     , Rs    , Rl    },\n+                           {-1    , si_1  , si_1  , si_1  , -1    },\n+                           {-1    , -1    , si_2  , -1    , -1    }};\n+    check_tree(tree, et2, __LINE__);\n+\n+    tree.commit_mapping(0, 20, call_stack_2, true); \/\/ commit at the beginning of the region\n+    \/\/ Pre:  .........0-------------------25********50--------100.........\n+    \/\/ Post: .........0********20---------25********50--------100.........\n+    \/\/        mtNone    mtTest    mtTest      mtTest   mtTest     mtNone\n+    \/\/        Rl        C         Rs          C        Rs         Rl\n+    \/\/        -         si_1      si_1        si_1     si_1       -\n+    \/\/        -         si_2      -           si_2     -          -\n+    ExpectedTree<5> et3 = {{     0,     20,     25,     50,    100        },\n+                           {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone},\n+                           {Rl    , C     , Rs    , C     , Rs    , Rl    },\n+                           {-1    , si_1  , si_1  , si_1  , si_1  , -1    },\n+                           {-1    , si_2  , -1    , si_2  , -1    , -1    }};\n+    check_tree(tree, et3, __LINE__);\n+\n+    tree.commit_mapping(80, 20, call_stack_2, true); \/\/ commit at the end of the region\n+    \/\/ Pre:  .........0********20---------25********50------------------100.........\n+    \/\/ Post: .........0********20---------25********50--------80********100.........\n+    \/\/        mtNone    mtTest    mtTest      mtTest   mtTest     mtTest    mtNone\n+    \/\/        Rl        C         Rs          C        Rs         C         Rl\n+    \/\/        -         si_1      si_1        si_1     si_1       si_1      -\n+    \/\/        -         si_2      -           si_2     -          si_2      -\n+    ExpectedTree<6> et4 = {{     0,     20,     25,     50,     80,    100        },\n+                           {mtNone, mtTest, mtTest, mtTest, mtTest, mtTest, mtNone},\n+                           {Rl    , C     , Rs    , C     , Rs    , C     , Rl    },\n+                           {-1    , si_1  , si_1  , si_1  , si_1  , si_1  , -1    },\n+                           {-1    , si_2  , -1    , si_2  , -1    , si_2  , -1    }};\n+    check_tree(tree, et4, __LINE__);\n+  }\n+  {\/\/ committing overlapped regions does not destroy the old call-stacks\n+    Tree tree;\n+    tree.reserve_mapping(0, 100, call_stack_1); \/\/ reserving in an empty tree\n+    \/\/ Pre: empty tree.\n+    \/\/ Post: .........0---------100.........\n+    \/\/        mtNone    mtTest       mtNone\n+    \/\/        Rl        Rs           Rl\n+    \/\/        -         si_1         -\n+    \/\/        -         -            -\n+    ExpectedTree<2> et1 = {{      0  , 100        },\n+                           {mtNone, mtTest, mtNone},\n+                           {Rl    , Rs    , Rl    },\n+                           {-1    , si_1  , -1    },\n+                           {-1    , -1    , -1    }};\n+    check_tree(tree, et1, __LINE__);\n+\n+    tree.commit_mapping(20, 20, call_stack_2, true);\n+    \/\/ Pre:  .........0----------------------------100.........\n+    \/\/ Post: .........0---------20********40-------100.........\n+    \/\/        mtNone    mtTest     mtTest    mtTest    mtNone\n+    \/\/        Rl        Rs           C       Rs        Rl\n+    \/\/        -         si_1         si_1    si_1      -\n+    \/\/        -         -            si_2     -        -\n+    ExpectedTree<4> et2 = {{     0,     20,     40,    100        },\n+                           {mtNone, mtTest, mtTest, mtTest, mtNone},\n+                           {Rl    , Rs    , C     , Rs    , Rl    },\n+                           {-1    , si_1  , si_1  , si_1  , -1    },\n+                           {-1    , -1    , si_2  , -1    , -1    }};\n+    check_tree(tree, et2, __LINE__);\n+\n+    SIndex si_3 = si[2];\n+    VMATree::RegionData call_stack_3(si_3, mtTest);\n+    \/\/ commit with overlap at the region's start\n+    tree.commit_mapping(10, 20, call_stack_3);\n+    \/\/ Pre:  .........0-------------20**************40-------100.........\n+    \/\/ Post: .........0---------10********30********40-------100.........\n+    \/\/        mtNone    mtTest     mtTest    mtTest    mtTest    mtNone\n+    \/\/        Rl        Rs           C       C         Rs        Rl\n+    \/\/        -         si_1         si_1    si_1      si_1      -\n+    \/\/        -         -            si_3    si_2        -       -\n+    ExpectedTree<5> et3 = {{     0,     10,     30,     40,    100        },\n+                           {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone},\n+                           {Rl    , Rs    , C     , C     , Rs    , Rl    },\n+                           {-1    , si_1  , si_1  , si_1  , si_1  , -1    },\n+                           {-1    , -1    , si_3  , si_2  , -1    , -1    }};\n+    check_tree(tree, et3, __LINE__);\n+\n+    SIndex si_4 = si[3];\n+    VMATree::RegionData call_stack_4(si_4, mtTest);\n+    \/\/ commit with overlap at the region's end\n+    tree.commit_mapping(30, 20, call_stack_4);\n+    \/\/ Pre:  .........0---------10********30**40-------------100.........\n+    \/\/ Post: .........0---------10********30********50-------100.........\n+    \/\/        mtNone    mtTest     mtTest    mtTest    mtTest    mtNone\n+    \/\/        Rl        Rs           C       C         Rs        Rl\n+    \/\/        -         si_1         si_1    si_1      si_1      -\n+    \/\/        -         -            si_3    si_4        -       -\n+    ExpectedTree<5> et4 = {{     0,     10,     30,     50,    100        },\n+                           {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone},\n+                           {Rl    , Rs    , C     , C     , Rs    , Rl    },\n+                           {-1    , si_1  , si_1  , si_1  , si_1  , -1    },\n+                           {-1    , -1    , si_3  , si_4  , -1    , -1    }};\n+    check_tree(tree, et4, __LINE__);\n+  }\n+  {\/\/ uncommit should not store any call-stack\n+    Tree tree;\n+    tree.reserve_mapping(0, 100, call_stack_1);\n+\n+    tree.commit_mapping(20, 20, call_stack_2, true);\n+\n+    tree.commit_mapping(0, 10, call_stack_2, true);\n+\n+    tree.uncommit_mapping(0, 5, call_stack_2);\n+    \/\/ Pre:  .........0*****************10--------20********40-------100.........\n+    \/\/        mtNone         mtTest        mtTest    mtTest    mtTest    mtNone\n+    \/\/        Rl             C             Rs        C         Rs        Rl\n+    \/\/        -              si_1          si_1      si_1      si_1      -\n+    \/\/        -              si_2          -         si_2      -         -\n+    \/\/ Post: .........0--------5********10--------20********40-------100.........\n+    \/\/        mtNone    mtTest   mtTest    mtTest    mtTest    mtTest    mtNone\n+    \/\/        Rl        Rs       C         Rs        C         Rs        Rl\n+    \/\/        -         si_1     si_1      si_1      si_1      si_1      -\n+    \/\/        -         -        si_2      -         si_2      -         -\n+    ExpectedTree<6> et1 = {{     0,     5,      10,     20,     40,    100        },\n+                           {mtNone, mtTest, mtTest, mtTest, mtTest, mtTest, mtNone},\n+                           {Rl    , Rs    , C     , Rs    , C     , Rs    , Rl    },\n+                           {-1    , si_1  , si_1  , si_1  , si_1  , si_1  , -1    },\n+                           {-1    , -1    , si_2  , -1    , si_2  , -1    , -1    }};\n+    check_tree(tree, et1, __LINE__);\n+\n+    tree.uncommit_mapping(20, 10, call_stack_2);\n+    \/\/ Pre:  .........0--------5********10---20*************40-------100.........\n+    \/\/ Post: .........0--------5********10--------30********40-------100.........\n+    \/\/        mtNone    mtTest   mtTest    mtTest    mtTest    mtTest    mtNone\n+    \/\/        Rl        Rs       C         Rs        C         Rs        Rl\n+    \/\/        -         si_1     si_1      si_1      si_1      si_1      -\n+    \/\/        -         -        si_2      -         si_2      -         -\n+    ExpectedTree<6> et2 = {{     0,     5,      10,     30,     40,    100        },\n+                           {mtNone, mtTest, mtTest, mtTest, mtTest, mtTest, mtNone},\n+                           {Rl    , Rs    , C     , Rs    , C     , Rs    , Rl    },\n+                           {-1    , si_1  , si_1  , si_1  , si_1  , si_1  , -1    },\n+                           {-1    , -1    , si_2  , -1    , si_2  , -1    , -1    }};\n+    check_tree(tree, et2, __LINE__);\n+  }\n+  {\/\/ reserve after reserve, but only different call-stacks\n+    SIndex si_4 = si[3];\n+    VMATree::RegionData call_stack_4(si_4, mtTest);\n+\n+    Tree tree;\n+    tree.reserve_mapping(0, 100, call_stack_1);\n+    tree.reserve_mapping(10, 10, call_stack_4);\n+    \/\/ Pre:  .........0----------------------------100.........\n+    \/\/ Post: .........0--------10--------20--------100.........\n+    \/\/        mtNone   mtTest    mtTest    mtTest    mtNone\n+    \/\/        Rl       Rs        Rs         Rs       Rl\n+    \/\/        -        si_1      si_2      si_1      -\n+    \/\/        -        -         -         -         -\n+    ExpectedTree<4> et1 = {{     0,     10,     20,     100       },\n+                           {mtNone, mtTest, mtTest, mtTest, mtNone},\n+                           {Rl    , Rs    , Rs    , Rs    , Rl    },\n+                           {-1    , si_1  , si_4  , si_1  , -1    },\n+                           {-1    , -1    , -1    , -1    , -1    }};\n+    check_tree(tree, et1, __LINE__);\n+  }\n+  {\/\/ commit without reserve\n+    Tree tree;\n+    tree.commit_mapping(0, 100, call_stack_1);\n+    ExpectedTree<2> et = {{     0,     100       },\n+                          {mtNone, mtTest, mtNone},\n+                          {Rl    , C     , Rl    },\n+                          {-1    , si_1  , -1    },\n+                          {-1    , si_1  , -1    }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  {\/\/ reserve after commit\n+    Tree tree;\n+    tree.commit_mapping(0, 100, call_stack_2);\n+    tree.reserve_mapping(0, 100, call_stack_1);\n+    ExpectedTree<2> et = {{     0,     100       },\n+                          {mtNone, mtTest, mtNone},\n+                          {Rl    , Rs    , Rl    },\n+                          {-1    , si_1  , -1    },\n+                          {-1    , -1    , -1    }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+}\n+\n+\/\/ Nodes in the tree :   R.....X......W......U....Z\n+\/\/ New request (A!=X):           A-------B\n+\/\/ New request (A==X):         A-------B\n+\/\/ Operations: {Reserve, Commit, Uncommit, Release}\n+\/\/ State of [X, W) region: {released, reserved, committed}\n+\/\/ total number of cases:\n+\/\/  no.of(Operations) x no.of(States) x no.of{A == X | A != X} =\n+\/\/        4           x     3         x        2               = 24\n+\/\/ AllCases_A_eq_X contains 12 cases for A == X\n+\/\/ AllCases_A_neq_X contains 12 cases for A != X\n+TEST_VM_F(NMTVMATreeTest, AllCases_A_eq_X) {\n+  using SIndex = NativeCallStackStorage::StackIndex;\n+  using State = VMATree::StateType;\n+  SIndex si_1 = si[0];\n+  SIndex si_2 = si[1];\n+  SIndex si_3 = si[2];\n+\n+  const bool ok_to_run = false;\n+  const State Rs = State::Reserved;\n+  const State Rl = State::Released;\n+  const State C = State::Committed;\n+  VMATree::RegionData call_stack_1(si_1, mtTest);\n+  VMATree::RegionData call_stack_1_mtNone(si_1, mtNone);\n+  VMATree::RegionData call_stack_2(si_2, mtTest);\n+  VMATree::RegionData call_stack_2_mtNone(si_2, mtNone);\n+  VMATree::RegionData call_stack_3(si_3, mtTest);\n+\n+  { \/\/ Do 'Reserve' for a released region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.release_mapping(100, 100);\n+    \/\/ New request\n+    tree.reserve_mapping(100, 150, call_stack_2);\n+    \/\/ Pre:  ........0--------100................200------------------------300********400........\n+    \/\/ Request:               100--------------------------------250\n+    \/\/ Post: ........0--------100--------------------------------250--------300********400........\n+    \/\/        mtNone   mtTest                 mtTest                 mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs                     Rs                     Rs         C          Rl\n+    \/\/        -        si_1                   si_2                   si_1       si_1       -\n+    \/\/        -        -                      -                      -          si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,    400         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Commit' for a released region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.release_mapping(100, 100);\n+    \/\/ New request\n+    tree.commit_mapping(100, 150, call_stack_2);\n+    \/\/ Pre:  ........0--------100................200------------------------300********400........\n+    \/\/ Request:               100********************************250\n+    \/\/ Post: ........0--------100********************************250--------300********400........\n+    \/\/        mtNone   mtTest                 mtTest                 mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs                     C                      Rs         C          Rl\n+    \/\/        -        si_1                   si_2                   si_1       si_1       -\n+    \/\/        -        -                      si_2                   -          si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,    400         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , C     , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , si_2  , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Uncommit' for a released region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.release_mapping(100, 100);\n+    \/\/ New request\n+    \/\/ 8354115\n+    if (ok_to_run) tree.uncommit_mapping(100, 150, call_stack_2);\n+    \/\/\n+    \/\/ to be re-written after 8354115\n+    \/\/ Pre:  ........0--------100................200------------------------300********400........\n+    \/\/ Request:               100--------------------------------250\n+    \/\/ Post: ........0--------100????????????????200?????????????250--------300********400........\n+    \/\/        mtNone   mtTest                 mtTest                 mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs                     Rs                     Rs         C          Rl\n+    \/\/        -        si_1                   si_2                   si_1       si_1       -\n+    \/\/        -        -                      -                      -          si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,    400         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , si_1  , -1     }};\n+    if (ok_to_run) check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Release' for a released region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.release_mapping(100, 100);\n+    \/\/ New request\n+    tree.release_mapping(100, 150);\n+    \/\/ Pre:  ........0--------100................200------------------------300********400........\n+    \/\/ Request:               100................................250\n+    \/\/ Post: ........0--------100................................250--------300********400........\n+    \/\/        mtNone   mtTest                 mtNone                 mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs                     Rl                     Rs         C          Rl\n+    \/\/        -        si_1                   -                      si_1       si_1       -\n+    \/\/        -        -                      -                      -          si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,    400         },\n+                          {mtNone, mtTest, mtNone, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , -1    , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Reserve' for a reserved region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.reserve_mapping(100, 100, call_stack_1);\n+    \/\/ New request\n+    tree.reserve_mapping(100, 150, call_stack_2);\n+    \/\/ Pre:  ........0--------100----------------200------------------------300********400........\n+    \/\/ Request:               100--------------------------------250\n+    \/\/ Post: ........0--------100--------------------------------250--------300********400........\n+    \/\/        mtNone   mtTest                 mtTest                 mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs                     Rs                     Rs         C          Rl\n+    \/\/        -        si_1                   si_2                   si_1       si_1       -\n+    \/\/        -        -                      -                      -          si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,    400         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Commit' for a reserved region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.reserve_mapping(100, 100, call_stack_1);\n+    \/\/ New request\n+    tree.commit_mapping(100, 150, call_stack_2);\n+    \/\/ Pre:  ........0--------100----------------200------------------------300********400........\n+    \/\/ Request:               100********************************250\n+    \/\/ Post: ........0--------100********************************250--------300********400........\n+    \/\/        mtNone   mtTest                 mtTest                 mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs                     C                      Rs         C          Rl\n+    \/\/        -        si_1                   si_2                   si_1       si_1       -\n+    \/\/        -        -                      si_2                   -          si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,    400         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , C     , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_1  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , si_2  , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Uncommit' over two different reserved regions\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.reserve_mapping(100, 100, call_stack_2);\n+    \/\/ New request\n+    tree.uncommit_mapping(100, 150, call_stack_1_mtNone);\n+    \/\/ Pre:  ........0--------100----------------200------------------------300********400........\n+    \/\/ Request:               100--------------------------------250\n+    \/\/ Post: ........0--------100----------------200-------------250--------300********400........\n+    \/\/        mtNone   mtTest        mtTest             mtTest       mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs            Rs                 Rs           Rs         C          Rl\n+    \/\/        -        si_1          si_2               si_1         si_1       si_1       -\n+    \/\/        -        -             -                  -            -          si_1       -\n+    ExpectedTree<6> et = {{     0,    100,    200,    250,    300,    400         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rs    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_2  , si_1  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , -1    , si_1  , -1     }};\n+    if (ok_to_run) check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Release' for a reserved region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.reserve_mapping(100, 100, call_stack_1);\n+    \/\/ New request\n+    tree.release_mapping(100, 150);\n+    \/\/ Pre:  ........0--------100----------------200------------------------300********400........\n+    \/\/ Request:               100................................250\n+    \/\/ Post: ........0--------100................................250--------300********400........\n+    \/\/        mtNone   mtTest                 mtNone                 mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs                     Rl                     Rs         C          Rl\n+    \/\/        -        si_1                   -                      si_1       si_1       -\n+    \/\/        -        -                      -                      -          si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,    400         },\n+                          {mtNone, mtTest, mtNone, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , -1    , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Reserve' for a committed region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.reserve_mapping(100, 150, call_stack_2);\n+    \/\/ Pre:  ........0--------100****************200------------------------300********400........\n+    \/\/ Request:               100--------------------------------250\n+    \/\/ Post: ........0--------100--------------------------------250--------300********400........\n+    \/\/        mtNone   mtTest                 mtTest                 mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs                     Rs                     Rs         C          Rl\n+    \/\/        -        si_1                   si_2                   si_1       si_1       -\n+    \/\/        -        -                      -                      -          si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,    400         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Commit' for a committed region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.commit_mapping(100, 150, call_stack_2);\n+    \/\/ Pre:  ........0--------100****************200------------------------300********400........\n+    \/\/ Request:               100********************************250\n+    \/\/ Post: ........0--------100********************************250--------300********400........\n+    \/\/        mtNone   mtTest                 mtTest                 mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs                     C                      Rs         C          Rl\n+    \/\/        -        si_1                   si_1                   si_1       si_1       -\n+    \/\/        -        -                      si_2                   -          si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,    400         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , C     , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_1  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , si_2  , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Uncommit' for a committed region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.uncommit_mapping(100, 150, call_stack_1_mtNone);\n+    \/\/ Pre:  ........0--------100****************200------------------300********400........\n+    \/\/ Request:               100--------------------------250\n+    \/\/ Post: ........0------------------------------------------------300********400........\n+    \/\/        mtNone                    mtTest                            mtTest     mtNone\n+    \/\/        Rl                        Rs                                C          Rl\n+    \/\/        -                         si_1                              si_1       -\n+    \/\/        -                         -                                 si_1       -\n+    ExpectedTree<3> et = {{     0,    300,    400         },\n+                          {mtNone, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_1  , -1     },\n+                          {-1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Release' for a committed region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.release_mapping(100, 150);\n+    \/\/ Pre:  ........0--------100****************200------------------------300********400........\n+    \/\/ Request:               100................................250\n+    \/\/ Post: ........0--------100................................250--------300********400........\n+    \/\/        mtNone   mtTest                 mtNone                 mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs                     Rl                     Rs         C          Rl\n+    \/\/        -        si_1                   -                      si_1       si_1       -\n+    \/\/        -        -                      -                      -          si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,    400          },\n+                          {mtNone, mtTest, mtNone, mtTest, mtTest, mtNone  },\n+                          {Rl    , Rs    , Rl    , Rs    , C     , Rl      },\n+                          {-1    , si_1  , -1    , si_1  , si_1  , -1      },\n+                          {-1    , -1    , -1    , -1    , si_1  , -1      }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+}\n+\n+TEST_VM_F(NMTVMATreeTest, AllCases_A_neq_X) {\n+  using SIndex = NativeCallStackStorage::StackIndex;\n+  using State = VMATree::StateType;\n+  SIndex si_1 = si[0];\n+  SIndex si_2 = si[1];\n+  SIndex si_3 = si[2];\n+\n+  const bool ok_to_run = false;\n+  const State Rs = State::Reserved;\n+  const State Rl = State::Released;\n+  const State C = State::Committed;\n+  VMATree::RegionData call_stack_1(si_1, mtTest);\n+  VMATree::RegionData call_stack_1_mtNone(si_1, mtNone);\n+  VMATree::RegionData call_stack_2(si_2, mtTest);\n+  VMATree::RegionData call_stack_3(si_3, mtTest);\n+\n+  { \/\/ Do 'Reserve' for a released region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.release_mapping(100, 100);\n+    \/\/ New request\n+    tree.reserve_mapping(150, 100, call_stack_2);\n+    \/\/ Pre:  ........0--------100................200-----------------------300*********400........\n+    \/\/ Request:                          150----------------250\n+    \/\/ Post: ........0--------100........150----------------250------------300*********400........\n+    \/\/        mtNone   mtTest     mtNone         mtTest           mtTest        mtTest     mtNone\n+    \/\/        Rl       Rs         Rl             Rs               Rs            C          Rl\n+    \/\/        -        si_1       -              si_2             si_1          si_1       -\n+    \/\/        -        -          -              -                -             si_1       -\n+    ExpectedTree<6> et = {{     0,    100,    150,    250,    300,   400          },\n+                          {mtNone, mtTest, mtNone, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl    , Rs    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , -1    , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Commit' for a released region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.release_mapping(100, 100);\n+    \/\/ New request\n+    tree.commit_mapping(150, 100, call_stack_2);\n+    \/\/ Pre:  ........0--------100................200-----------------------300********400........\n+    \/\/ Request:                          150****************250\n+    \/\/ Post: ........0--------100........150****************250------------300********400........\n+    \/\/        mtNone   mtTest     mtNone         mtTest           mtTest       mtTest     mtNone\n+    \/\/        Rl       Rs         Rl             C                Rs           C          Rl\n+    \/\/        -        si_1       -1             si_2             si_1         si_1       -\n+    \/\/        -        -          -1             si_2             -            si_1       -\n+    ExpectedTree<6> et = {{     0,    100,    150,    250,    300,   400          },\n+                          {mtNone, mtTest, mtNone, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl    , C     , Rs    , C     , Rl     },\n+                          {-1    , si_1  , -1    , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , si_2  , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Uncommit' for a released region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.release_mapping(100, 100);\n+    \/\/ New request\n+    \/\/ 8354115\n+    if (ok_to_run) tree.uncommit_mapping(150, 100, call_stack_2);\n+    \/\/ To be re-written after 8354115\n+    \/\/ Pre:  ........0--------100................200-----------------------300********400........\n+    \/\/ Request:                          150----------------250\n+    \/\/ Post: ........0--------100........150----------------250------------300********400........\n+    \/\/        mtNone   mtTest     mtNone         mtTest           mtTest       mtTest     mtNone\n+    \/\/        Rl       Rs         Rl             Rs               Rs           C          Rl\n+    \/\/        -        si_1       -              si_2             si_1         si_1       -\n+    \/\/        -        -          -              -                -            si_1       -\n+    ExpectedTree<6> et = {{     0,    100,    150,    250,    300,   400          },\n+                          {mtNone, mtTest, mtNone, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl    , Rs    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , -1    , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , -1    , si_1  , -1     }};\n+    if (ok_to_run) check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Release' for a released region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.release_mapping(100, 100);\n+    \/\/ New request\n+    tree.release_mapping(150, 100);\n+    \/\/ Pre:  ........0--------100................200--------------------300********400........\n+    \/\/ Request:                           150............250\n+    \/\/ Post: ........0--------100........................250------------300********400........\n+    \/\/        mtNone   mtTest             mtNone               mtTest       mtTest     mtNone\n+    \/\/        Rl       Rs                 Rl                   Rs           C          Rl\n+    \/\/        -        si_1               -                    si_1         si_1       -\n+    \/\/        -        -                  -                    -            si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    250,    300,   400          },\n+                          {mtNone, mtTest,  mtNone, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    ,  Rl   , Rs    , C     , Rl     },\n+                          {-1    , si_1  ,  -1   , si_1  , si_1  , -1     },\n+                          {-1    , -1    ,  -1   , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Reserve' for a reserved region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.reserve_mapping(100, 100, call_stack_3);\n+    \/\/ New request\n+    tree.reserve_mapping(150, 100, call_stack_2);\n+    \/\/ Pre:  ........0--------100----------------200-----------------------300********400........\n+    \/\/ Request:                          150----------------250\n+    \/\/ Post: ........0--------100--------150----------------250------------300********400........\n+    \/\/        mtNone   mtTest     mtTest         mtTest           mtTest       mtTest     mtNone\n+    \/\/        Rl       Rs         Rs             Rs               Rs           C          Rl\n+    \/\/        -        si_1       si_3           si_2             si_1         si_1       -\n+    \/\/        -        -          -              -                -            si_1       -\n+    ExpectedTree<6> et = {{     0,    100,    150,    250,    300,   400          },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rs    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_3  , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Commit' over two different reserved regions\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.reserve_mapping(100, 100, call_stack_3);\n+    \/\/ New request\n+    tree.commit_mapping(150, 100, call_stack_2);\n+    \/\/ Pre:  ........0--------100-------------------200--------------------300********400........\n+    \/\/                   si_1         si_3                  si_1                si_1\n+    \/\/\n+    \/\/ Request:                          150*******************250\n+    \/\/ Post: ........0--------100--------150********200********250---------300********400........\n+    \/\/        mtNone   mtTest     mtTest     mtTest     mtTest      mtTest     mtTest     mtNone\n+    \/\/        Rl       Rs         Rs         C          C           Rs         C          Rl\n+    \/\/        -        si_1       si_3       si_3       si_1        si_1       si_1       -\n+    \/\/        -        -          -          si_2       si_2        -          si_1       -\n+    ExpectedTree<7> et = {{     0,    100,    150,    200,    250,    300,   400          },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , C     , C     , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_3  , si_3  , si_1  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , si_2  , si_2  , -1    , si_1  , -1     }};\n+    if (ok_to_run) check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Uncommit' over two different reserved regions\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.reserve_mapping(100, 100, call_stack_2);\n+    \/\/ New request\n+    tree.uncommit_mapping(150, 100, call_stack_1_mtNone);\n+    \/\/ Pre:  ........0--------100----------------200-----------------------300********400........\n+    \/\/                  si_1          si_2                 si_1                  si_1\n+    \/\/\n+    \/\/ Reqquest:                      150-------------------250\n+    \/\/ Pre:  ........0--------100----------------200-----------------------300********400........\n+    \/\/        mtNone   mtTest        mtTest                mtTest              mtTest     mtNone\n+    \/\/        Rl       Rs            Rs                    Rs                  C          Rl\n+    \/\/        -        si_1          si_2                  si_1                si_1       -\n+    \/\/        -        -             -                     -                   si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    200,    300,   400          },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , si_1  , -1     }};\n+    if (ok_to_run) check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Release' for a reserved region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.reserve_mapping(100, 100, call_stack_2);\n+    \/\/ New request\n+    tree.release_mapping(150, 100);\n+    \/\/ Pre:  ........0--------100----------------200-----------------------300********400........\n+    \/\/ Request:                          150................250\n+    \/\/ Post: ........0--------100--------150................250------------300********400........\n+    \/\/        mtNone   mtTest     mtTest         mtNone           mtTest       mtTest     mtNone\n+    \/\/        Rl       Rs         Rs             Rl               Rs           C          Rl\n+    \/\/        -        si_1       si_2           -                si_1         si_1       -\n+    \/\/        -        -          -              -                -            si_1       -\n+    ExpectedTree<6> et = {{     0,    100,    150,    250,    300,   400          },\n+                          {mtNone, mtTest, mtTest, mtNone, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rl    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_2  , -1    , si_1  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Reserve' for a committed region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.reserve_mapping(150, 100, call_stack_2);\n+    \/\/ Pre:  ........0--------100****************200-----------------------300********400........\n+    \/\/ Request:                          150----------------250\n+    \/\/ Post: ........0--------100********150----------------250------------300********400........\n+    \/\/        mtNone   mtTest     mtTest         mtTest           mtTest       mtTest     mtNone\n+    \/\/        Rl       Rs         C              Rs               Rs           C          Rl\n+    \/\/        -        si_1       si_1           si_2             si_1         si_1       -\n+    \/\/        -        -          si_1           -                -            si_1       -\n+    ExpectedTree<6> et = {{     0,    100,    150,    250,    300,   400          },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , C     , Rs    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_1  , si_2  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , si_1  , -1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Commit' for a committed region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.commit_mapping(150, 100, call_stack_2);\n+    \/\/ Pre:  ........0--------100****************200-----------------------300********400........\n+    \/\/ Request:                          150****************250\n+    \/\/ Post: ........0--------100********150****************250------------300********400........\n+    \/\/        mtNone   mtTest     mtTest         mtTest           mtTest       mtTest     mtNone\n+    \/\/        Rl       Rs         C              C                Rs           C          Rl\n+    \/\/        -        si_1       si_1           si_1             si_1         si_1       -\n+    \/\/        -        -          si_1           si_2             -            si_1       -\n+    ExpectedTree<6> et = {{     0,    100,    150,    250,    300,   400          },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , C     , C     , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_1  , si_1  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , si_1  , si_2  , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Uncommit' for a committed region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.uncommit_mapping(150, 100, call_stack_1_mtNone);\n+    \/\/ Pre:  ........0--------100*******************200--------------------300********400........\n+    \/\/ Request:                          150--------------------250\n+    \/\/ Post: ........0--------100********150-------------------------------300********400........\n+    \/\/        mtNone   mtTest     mtTest                mtTest                 mtTest     mtNone\n+    \/\/        Rl       Rs         C                     Rs                     C          Rl\n+    \/\/        -        si_1       si_1                  si_1                   si_1       -\n+    \/\/        -        -          si_1                  -                      si_1       -\n+    ExpectedTree<5> et = {{     0,    100,    150,    300,   400          },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , C     , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_1  , si_1  , si_1  , -1     },\n+                          {-1    , -1    , si_1  , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Release' for a committed region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 400, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.release_mapping(150, 100);\n+    \/\/ Pre:  ........0--------100****************200-----------------------300********400........\n+    \/\/ Request:                          150................250\n+    \/\/ Post: ........0--------100********150................250------------300********400........\n+    \/\/        mtNone   mtTest     mtTest         mtNone           mtTest       mtTest     mtNone\n+    \/\/        Rl       Rs         C              Rl               Rs           C          Rl\n+    \/\/        -        si_1       si_1           -                si_1         si_1       -\n+    \/\/        -        -          si_1           -                -            si_1       -\n+    ExpectedTree<6> et = {{     0,    100,    150,    250,    300,   400          },\n+                          {mtNone, mtTest, mtTest, mtNone, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , C     , Rl    , Rs    , C     , Rl     },\n+                          {-1    , si_1  , si_1  , -1    , si_1  , si_1  , -1     },\n+                          {-1    , -1    , si_1  , -1    , -1    , si_1  , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+}\n+\n+TEST_VM_F(NMTVMATreeTest, MultipleRegionsAllWithSameTag) {\n+  using SIndex = NativeCallStackStorage::StackIndex;\n+  using State = VMATree::StateType;\n+  SIndex si_1 = si[0];\n+  SIndex si_2 = si[1];\n+  SIndex si_3 = si[2];\n+\n+  const bool ok_to_run = false;\n+  const State Rs = State::Reserved;\n+  const State Rl = State::Released;\n+  const State C = State::Committed;\n+  VMATree::RegionData call_stack_1(si_1, mtTest);\n+  VMATree::RegionData call_stack_1_mtNone(si_1, mtNone);\n+  VMATree::RegionData call_stack_2(si_2, mtTest);\n+  VMATree::RegionData call_stack_2_mtNone(si_2, mtNone);\n+  VMATree::RegionData call_stack_3_mtNone(si_3, mtNone);\n+\n+  { \/\/ Do 'Reserve' over multiple committed\/reserved regions\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(500, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.reserve_mapping(50, 900, call_stack_2);\n+    \/\/ Pre:     ........0----------------100*********200--------300********400--------500********600-------------------1000........\n+    \/\/ Request: (reserve)        50-------------------------------------------------------------------------950\n+    \/\/ Post:    ........0--------50-------------------------------------------------------------------------950--------1000........\n+    \/\/           mtNone   mtTest                                 mtTest                                         mtTest      mtNone\n+    \/\/           Rl       Rs                                     Rs                                             Rs          Rl\n+    \/\/           -        si_1                                   si_2                                           si_1        -\n+    \/\/           -        -                                      -                                              -           -\n+    ExpectedTree<4> et = {{     0,    50,    950,    1000         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rs    , Rl     },\n+                          {-1    , si_1  , si_2  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Reserve' [A, B) over multiple committed\/reserved regions where B already exists in nodes\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(500, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.reserve_mapping(50, 550, call_stack_2);\n+    \/\/ Pre:     ........0----------------100*********200--------300********400--------500********600-------------------1000........\n+    \/\/ Request:                  50--------------------------------------------------------------600\n+    \/\/ Post:    ........0--------50--------------------------------------------------------------600-------------------1000........\n+    \/\/           mtNone                                          mtTest                                   mtTest            mtNone\n+    \/\/           Rl                                              Rs                                       Rs                Rl\n+    \/\/           -                                               si_2                                     si_1              -\n+    \/\/           -                                               -                                        -                 -\n+    ExpectedTree<4> et = {{     0,    50,    600,    1000         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rs    , Rl     },\n+                          {-1    , si_1  , si_2  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Reserve' [A, B) over multiple committed\/reserved regions where A already exists in nodes\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(500, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.reserve_mapping(0, 950, call_stack_2);\n+    \/\/ Pre:     ........0----------------100*********200--------300********400--------500********600-------------------1000........\n+    \/\/ Request:         0-----------------------------------------------------------------------------------950\n+    \/\/ Post:    ........0-----------------------------------------------------------------------------------950--------1000........\n+    \/\/           mtNone                                          mtTest                                         mtTest      mtNone\n+    \/\/           Rl                                              Rs                                             Rs          Rl\n+    \/\/           -                                               si_2                                           si_1        -\n+    \/\/           -                                               -                                              -           -\n+    ExpectedTree<3> et = {{     0,    950,    1000        },\n+                          {mtNone, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rl     },\n+                          {-1    , si_2  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Uncommit' over multiple committed\/reserved regions\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(500, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.uncommit_mapping(50, 900, call_stack_1_mtNone);\n+    \/\/ Pre:     ........0----------------100*********200--------300********400--------500********600-------------------1000........\n+    \/\/ Request: (uncommit)       50-------------------------------------------------------------------------950\n+    \/\/ Post:    ........0----------------------------------------------------------------------------------------------1000........\n+    \/\/           mtNone                                           mtTest                                                    mtNone\n+    \/\/           Rl                                               Rs                                                        Rl\n+    \/\/           -                                                si_1                                                      -\n+    \/\/           -                                                -                                                         -\n+    ExpectedTree<2> et = {{     0,   1000         },\n+                          {mtNone, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl     },\n+                          {-1    , si_1  , -1     },\n+                          {-1    , -1    , -1     }};\n+    check_tree(tree, et, __LINE__);\n+    VMATree::VMATreap::Range r = tree.tree().find_enclosing_range(50);\n+    EXPECT_EQ((int)r.start->key(), 0);\n+    EXPECT_EQ((int)r.end->key(), 1000);\n+  }\n+  { \/\/ Do 'Uncommit' over multiple committed\/reserved regions with different call-stacks\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.reserve_mapping(100, 100, call_stack_2);\n+    tree.reserve_mapping(300, 100, call_stack_2);\n+    tree.reserve_mapping(500, 100, call_stack_2);\n+    \/\/ New request\n+    tree.uncommit_mapping(50, 900, call_stack_3_mtNone); \/\/ The call-stack should not be taken into account\n+\n+    \/\/ Pre:     ........0----------------100---------200--------300--------400--------500--------600-------------------1000........\n+    \/\/                         si_1             si_2       si_1      si_2       si_1       si_2          si_1               -\n+    \/\/\n+    \/\/ Request: (uncommit)       50-----------------------------------------------------------------------------950\n+    \/\/                                                       si_3\n+    \/\/\n+    \/\/ Post:    ........0----------------100---------200--------300--------400--------500--------600-------------------1000........\n+    \/\/           mtNone       mtTest         mtTest      mtTest     mtTest     mtTest     mtTest        mtTest              mtNone                                      mtNone\n+    \/\/           Rl           Rs             Rs          Rs         Rs         Rs         Rs            Rs                  Rl\n+    \/\/           -            si_1           si_2        si_1       si_2       si_1       si_2          si_1                -\n+    \/\/           -            -              -           -          -          -          -             -                   -\n+    ExpectedTree<8> et = {{     0,    100,    200,    300,    400,    500,    600,   1000         },\n+                          {mtNone, mtTest, mtTest, mtTest, mtTest, mtTest, mtTest, mtTest, mtNone },\n+                          {Rl    , Rs    , Rs    , Rs    , Rs    , Rs    , Rs    , Rs    , Rl     },\n+                          {-1    , si_1  , si_2  , si_1  , si_2  , si_1  , si_2  , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , -1    , -1    , -1    , -1    , -1     }};\n+    if (ok_to_run) check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Uncommit' [A,B) over multiple committed\/reserved regions where B already exists in the nodes\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(500, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.uncommit_mapping(50, 550, call_stack_1_mtNone);\n+    \/\/ Pre:     ........0----------------100*********200--------300********400--------500********600-------------------1000........\n+    \/\/ Request: (uncommit)       50--------------------------------------------------------------600\n+    \/\/ Post:    ........0----------------------------------------------------------------------------------------------1000........\n+    \/\/           mtNone                                           mtTest                                                    mtNone\n+    \/\/           Rl                                               Rs                                                        Rl\n+    \/\/           -                                                si_1                                                      -\n+    \/\/           -                                                -                                                         -\n+    ExpectedTree<2> et = {{     0,   1000         },\n+                          {mtNone, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl     },\n+                          {-1    , si_1  , -1     },\n+                          {-1    , -1    , -1     }};\n+    check_tree(tree, et, __LINE__);\n+    VMATree::VMATreap::Range r = tree.tree().find_enclosing_range(50);\n+    EXPECT_EQ((int)r.start->key(), 0);  \/\/ make sure 600 is removed\n+    EXPECT_EQ((int)r.end->key(), 1000);\n+  }\n+  { \/\/ Do 'Uncommit' [A,B) over multiple committed\/reserved regions where A already exists in the nodes\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(500, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.uncommit_mapping(100, 850, call_stack_1_mtNone);\n+    \/\/ Pre:     ........0----------------100*********200--------300********400--------500********600-------------------1000........\n+    \/\/ Request: (uncommit)               100--------------------------------------------------------------950\n+    \/\/ Post:    ........0----------------------------------------------------------------------------------------------1000........\n+    \/\/           mtNone                                           mtTest                                                    mtNone\n+    \/\/           Rl                                               Rs                                                        Rl\n+    \/\/           -                                                si_1                                                      -\n+    \/\/           -                                                -                                                         -\n+    ExpectedTree<2> et = {{     0,   1000         },\n+                          {mtNone, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl     },\n+                          {-1    , si_1  , -1     },\n+                          {-1    , -1    , -1     }};\n+    check_tree(tree, et, __LINE__);\n+    VMATree::VMATreap::Range r = tree.tree().find_enclosing_range(50);\n+    EXPECT_EQ((int)r.start->key(), 0);  \/\/ make sure both 50 and 600 are removed\n+    EXPECT_EQ((int)r.end->key(), 1000);\n+  }\n+  { \/\/ Do 'Release' over multiple committed\/reserved regions\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(500, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.release_mapping(50, 900);\n+    \/\/ Pre:     ........0----------------100*********200--------300********400--------500********600-------------------1000........\n+    \/\/ Request:                  50-------------------------------------------------------------------------950\n+    \/\/ Post:    ........0--------50.........................................................................950--------1000........\n+    \/\/           mtNone   mtTest                                 mtNone                                         mtTest      mtNone\n+    \/\/           Rl       Rs                                     Rl                                             Rs          Rl\n+    \/\/           -        si_1                                   -                                              si_1        -\n+    \/\/           -        -                                      -                                              -           -\n+    ExpectedTree<4> et = {{     0,    50,    950,    1000         },\n+                          {mtNone, mtTest, mtNone, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl    , Rs    , Rl     },\n+                          {-1    , si_1  , -1    , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Release' [A,B) over multiple committed\/reserved regions where B already exists in the nodes\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(500, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.release_mapping(50, 550);\n+    \/\/ Pre:     ........0----------------100*********200--------300********400--------500********600-------------------1000........\n+    \/\/ Request:                  50..............................................................600\n+    \/\/ Post:    ........0--------50..............................................................600-------------------1000........\n+    \/\/           mtNone   mtTest                                 mtNone                                    mtTest           mtNone\n+    \/\/           Rl       Rs                                     Rl                                        Rs               Rl\n+    \/\/           -        si_1                                   -                                         si_1             -\n+    \/\/           -        -                                      -                                         -               -\n+    ExpectedTree<4> et = {{     0,    50,    600,    1000         },\n+                          {mtNone, mtTest, mtNone, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl    , Rs    , Rl     },\n+                          {-1    , si_1  , -1    , si_1  , -1     },\n+                          {-1    , -1    , -1    , -1    , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Release' [A,B) over multiple committed\/reserved regions where B is start of a released region\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(500, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.release_mapping(50, 950);\n+    \/\/ Pre:     ........0----------------100*********200--------300********400--------500********600-------------------1000........\n+    \/\/ Request:                  50....................................................................................1000\n+    \/\/ Post:    ........0--------50.........\n+    \/\/           mtNone   mtTest    mtNone\n+    \/\/           Rl       Rs        Rl\n+    \/\/           -        si_1      -\n+    \/\/           -        -         -\n+    ExpectedTree<2> et = {{     0,    50,         },\n+                          {mtNone, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl     },\n+                          {-1    , si_1  , -1     },\n+                          {-1    , -1    , -1     }};\n+    check_tree(tree, et, __LINE__);\n+  }\n+  { \/\/ Do 'Release' [A,B) over multiple committed\/reserved regions where A already exists in the nodes\n+    Tree tree;\n+    \/\/ Prepare pre-cond\n+    tree.reserve_mapping(0, 1000, call_stack_1);\n+    tree.commit_mapping(100, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(300, 100, call_stack_1_mtNone, true);\n+    tree.commit_mapping(500, 100, call_stack_1_mtNone, true);\n+    \/\/ New request\n+    tree.release_mapping(0, 700);\n+    \/\/ Pre:     ........0----------------100*********200--------300********400--------500********600-------------------1000........\n+    \/\/ Request:         0..................................................................................700\n+    \/\/ Post:    ...........................................................................................700---------1000........\n+    \/\/                                                   mtNone                                                 mtTest      mtNone\n+    \/\/                                                   Rl                                                     Rs          Rl\n+    \/\/                                                   -                                                      si_1        -\n+    \/\/                                                   -                                                      -           -\n+    ExpectedTree<2> et = {{   700,   1000,        },\n+                          {mtNone, mtTest, mtNone },\n+                          {Rl    , Rs    , Rl     },\n+                          {-1    , si_1  , -1     },\n+                          {-1    , -1    , -1     }};\n+    check_tree(tree, et, __LINE__);\n+    VMATree::VMATreap::Range r = tree.tree().find_enclosing_range(0);\n+    EXPECT_EQ(r.start, nullptr);  \/\/ make sure 0 is removed\n+    EXPECT_EQ((int)r.end->key(), 700);\n+ }\n","filename":"test\/hotspot\/gtest\/nmt\/test_vmatree.cpp","additions":1225,"deletions":25,"binary":false,"changes":1250,"status":"modified"}]}