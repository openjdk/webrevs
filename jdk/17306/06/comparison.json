{"files":[{"patch":"@@ -90,0 +90,1 @@\n+        this.doneFullScan = true;\n@@ -192,1 +193,1 @@\n-            for (int i=1; i<parentSize; i++) {\n+            for (int i=1; i<parentSize;) {\n@@ -194,1 +195,4 @@\n-                if (cpi != null)\n+                if (cpi == null) {\n+                    doneFullScan = false;\n+                    i++;\n+                } else {\n@@ -196,0 +200,2 @@\n+                    i += cpi.width();\n+                }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/SplitConstantPool.java","additions":8,"deletions":2,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,2 +28,0 @@\n-import java.lang.constant.ClassDesc;\n-import java.lang.constant.MethodTypeDesc;\n@@ -32,1 +30,0 @@\n-import java.util.LinkedHashMap;\n@@ -34,1 +31,0 @@\n-import java.util.stream.Collectors;\n@@ -40,0 +36,3 @@\n+import java.lang.constant.MethodTypeDesc;\n+import java.util.ArrayDeque;\n+import java.util.Queue;\n@@ -44,0 +43,2 @@\n+    private record Target(int bci, int stack) {}\n+\n@@ -47,1 +48,0 @@\n-                buf.thisClass().asSymbol(),\n@@ -62,1 +62,1 @@\n-    private final LinkedHashMap<Integer, Integer> map;\n+    private final Queue<Target> targets;\n@@ -67,1 +67,1 @@\n-            map.put(targetBci, stack);\n+            targets.add(new Target(targetBci, stack));\n@@ -81,7 +81,5 @@\n-        var it = map.entrySet().iterator();\n-        while (it.hasNext()) {\n-            var en = it.next();\n-            it.remove();\n-            if (!visited.get(en.getKey())) {\n-                bcs.nextBci = en.getKey();\n-                stack = en.getValue();\n+        Target en;\n+        while ((en = targets.poll()) != null) {\n+            if (!visited.get(en.bci)) {\n+                bcs.nextBci = en.bci;\n+                stack = en.stack;\n@@ -96,1 +94,0 @@\n-                     ClassDesc thisClass,\n@@ -106,1 +103,1 @@\n-        map = new LinkedHashMap<>();\n+        targets = new ArrayDeque<>();\n@@ -108,1 +105,1 @@\n-        for (var h : handlers) map.put(labelContext.labelToBci(h.handler), 1);\n+        for (var h : handlers) targets.add(new Target(labelContext.labelToBci(h.handler), 1));\n@@ -110,3 +107,1 @@\n-        for (var cd : methodDesc.parameterList()) {\n-            maxLocals += Util.slotSize(cd);\n-        }\n+        maxLocals += Util.parameterSlots(methodDesc);\n@@ -115,1 +110,1 @@\n-        map.put(0, 0);\n+        targets.add(new Target(0, 0));\n@@ -310,4 +305,2 @@\n-                        var mDesc = MethodTypeDesc.ofDescriptor(nameAndType.type().stringValue());\n-                        for (var arg : mDesc.parameterList()) {\n-                            addStackSlot(-TypeKind.from(arg).slotSize());\n-                        }\n+                        var mtd = Util.methodTypeSymbol(nameAndType);\n+                        addStackSlot(Util.slotSize(mtd.returnType()) - Util.parameterSlots(mtd));\n@@ -317,1 +310,0 @@\n-                        addStackSlot(TypeKind.from(mDesc.returnType()).slotSize());\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/StackCounter.java","additions":19,"deletions":27,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -83,1 +83,2 @@\n-        for(var arg : methodType.parameterList()) {\n+        for (int pi = 0; pi < methodType.parameterCount(); pi++) {\n+            var arg = methodType.parameterType(pi);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/StackMapDecoder.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,131 @@\n+\/*\n+ * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package org.openjdk.bench.jdk.classfile;\n+\n+import java.io.IOException;\n+import java.lang.constant.ClassDesc;\n+import java.net.URI;\n+import java.nio.ByteBuffer;\n+import java.nio.file.FileSystems;\n+import java.nio.file.Files;\n+import java.util.Iterator;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.lang.classfile.ClassFile;\n+import java.lang.classfile.ClassReader;\n+import java.lang.classfile.MethodModel;\n+import java.lang.classfile.constantpool.ConstantPool;\n+import java.lang.classfile.constantpool.ConstantPoolBuilder;\n+import java.lang.constant.MethodTypeDesc;\n+import jdk.internal.classfile.impl.AbstractPseudoInstruction;\n+import jdk.internal.classfile.impl.CodeImpl;\n+import jdk.internal.classfile.impl.LabelContext;\n+import jdk.internal.classfile.impl.ClassFileImpl;\n+import jdk.internal.classfile.impl.SplitConstantPool;\n+import jdk.internal.classfile.impl.StackCounter;\n+import jdk.internal.classfile.impl.StackMapGenerator;\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Level;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+@BenchmarkMode(Mode.Throughput)\n+@State(Scope.Benchmark)\n+@Fork(value = 1, jvmArgsAppend = {\n+        \"--enable-preview\",\n+        \"--add-exports\", \"java.base\/jdk.internal.classfile.impl=ALL-UNNAMED\"})\n+@Warmup(iterations = 2)\n+@Measurement(iterations = 8)\n+public class CodeAttributeTools {\n+\n+    record GenData(LabelContext labelContext,\n+                    ClassDesc thisClass,\n+                    String methodName,\n+                    MethodTypeDesc methodDesc,\n+                    boolean isStatic,\n+                    ByteBuffer bytecode,\n+                    ConstantPoolBuilder constantPool,\n+                    List<AbstractPseudoInstruction.ExceptionCatchImpl> handlers) {}\n+\n+    List<GenData> data;\n+\n+    @Setup(Level.Invocation)\n+    public void setup() throws IOException {\n+        data = new ArrayList<>();\n+        Files.walk(FileSystems.getFileSystem(URI.create(\"jrt:\/\")).getPath(\"modules\/java.base\/java\")).forEach(p ->  {\n+            if (Files.isRegularFile(p) && p.toString().endsWith(\".class\")) try {\n+                var clm = ClassFile.of().parse(p);\n+                var thisCls = clm.thisClass().asSymbol();\n+                var cp = new SplitConstantPool((ClassReader)clm.constantPool());\n+                for (var m : clm.methods()) {\n+                    m.code().ifPresent(com -> {\n+                        var bb = ByteBuffer.wrap(((CodeImpl)com).contents());\n+                        data.add(new GenData(\n+                                (LabelContext)com,\n+                                thisCls,\n+                                m.methodName().stringValue(),\n+                                m.methodTypeSymbol(),\n+                                (m.flags().flagsMask() & ClassFile.ACC_STATIC) != 0,\n+                                bb.slice(8, bb.getInt(4)),\n+                                cp,\n+                                com.exceptionHandlers().stream().map(eh -> (AbstractPseudoInstruction.ExceptionCatchImpl)eh).toList()));\n+                    });\n+                }\n+            } catch (IOException e) {\n+                throw new RuntimeException(e);\n+            }\n+        });\n+    }\n+\n+    @Benchmark\n+    public void benchmarkStackMapsGenerator() {\n+        for (var d : data) new StackMapGenerator(\n+                d.labelContext(),\n+                d.thisClass(),\n+                d.methodName(),\n+                d.methodDesc(),\n+                d.isStatic(),\n+                d.bytecode().rewind(),\n+                (SplitConstantPool)d.constantPool(),\n+                (ClassFileImpl)ClassFile.of(),\n+                d.handlers());\n+    }\n+\n+    @Benchmark\n+    public void benchmarkStackCounter() {\n+        for (var d : data) new StackCounter(\n+                d.labelContext(),\n+                d.methodName(),\n+                d.methodDesc(),\n+                d.isStatic(),\n+                d.bytecode().rewind(),\n+                (SplitConstantPool)d.constantPool(),\n+                d.handlers());\n+    }\n+}\n","filename":"test\/micro\/org\/openjdk\/bench\/jdk\/classfile\/CodeAttributeTools.java","additions":131,"deletions":0,"binary":false,"changes":131,"status":"added"},{"patch":"@@ -1,123 +0,0 @@\n-\/*\n- * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-package org.openjdk.bench.jdk.classfile;\n-\n-import java.io.IOException;\n-import java.lang.constant.ClassDesc;\n-import java.lang.constant.MethodTypeDesc;\n-import java.net.URI;\n-import java.nio.ByteBuffer;\n-import java.nio.file.FileSystems;\n-import java.nio.file.Files;\n-import java.util.Iterator;\n-import java.util.ArrayList;\n-import java.util.List;\n-import java.lang.classfile.ClassFile;\n-import java.lang.classfile.ClassReader;\n-import java.lang.classfile.constantpool.ConstantPoolBuilder;\n-import jdk.internal.classfile.impl.AbstractPseudoInstruction;\n-import jdk.internal.classfile.impl.CodeImpl;\n-import jdk.internal.classfile.impl.LabelContext;\n-import jdk.internal.classfile.impl.ClassFileImpl;\n-import jdk.internal.classfile.impl.SplitConstantPool;\n-import jdk.internal.classfile.impl.StackMapGenerator;\n-import org.openjdk.jmh.annotations.Benchmark;\n-import org.openjdk.jmh.annotations.BenchmarkMode;\n-import org.openjdk.jmh.annotations.Fork;\n-import org.openjdk.jmh.annotations.Level;\n-import org.openjdk.jmh.annotations.Measurement;\n-import org.openjdk.jmh.annotations.Mode;\n-import org.openjdk.jmh.annotations.Scope;\n-import org.openjdk.jmh.annotations.Setup;\n-import org.openjdk.jmh.annotations.State;\n-import org.openjdk.jmh.annotations.Warmup;\n-\n-@BenchmarkMode(Mode.Throughput)\n-@State(Scope.Benchmark)\n-@Fork(value = 1, jvmArgsAppend = {\n-        \"--enable-preview\",\n-        \"--add-exports\", \"java.base\/jdk.internal.classfile.impl=ALL-UNNAMED\"})\n-@Warmup(iterations = 2)\n-@Measurement(iterations = 10)\n-public class GenerateStackMaps {\n-\n-    record GenData(LabelContext labelContext,\n-                    ClassDesc thisClass,\n-                    String methodName,\n-                    MethodTypeDesc methodDesc,\n-                    boolean isStatic,\n-                    ByteBuffer bytecode,\n-                    ConstantPoolBuilder constantPool,\n-                    List<AbstractPseudoInstruction.ExceptionCatchImpl> handlers) {}\n-\n-    List<GenData> data;\n-    Iterator<GenData> it;\n-    GenData d;\n-    ClassFile cc;\n-\n-    @Setup(Level.Trial)\n-    public void setup() throws IOException {\n-        cc = ClassFile.of();\n-        data = new ArrayList<>();\n-        Files.walk(FileSystems.getFileSystem(URI.create(\"jrt:\/\")).getPath(\"modules\/java.base\/java\")).forEach(p ->  {\n-            if (Files.isRegularFile(p) && p.toString().endsWith(\".class\")) try {\n-                var clm = cc.parse(p);\n-                var thisCls = clm.thisClass().asSymbol();\n-                var cp = new SplitConstantPool((ClassReader)clm.constantPool());\n-                for (var m : clm.methods()) {\n-                    m.code().ifPresent(com -> {\n-                        var bb = ByteBuffer.wrap(((CodeImpl)com).contents());\n-                        data.add(new GenData(\n-                                (LabelContext)com,\n-                                thisCls,\n-                                m.methodName().stringValue(),\n-                                m.methodTypeSymbol(),\n-                                (m.flags().flagsMask() & ClassFile.ACC_STATIC) != 0,\n-                                bb.slice(8, bb.getInt(4)),\n-                                cp,\n-                                com.exceptionHandlers().stream().map(eh -> (AbstractPseudoInstruction.ExceptionCatchImpl)eh).toList()));\n-                    });\n-                }\n-            } catch (IOException e) {\n-                throw new RuntimeException(e);\n-            }\n-        });\n-    }\n-\n-    @Benchmark\n-    public void benchmark() {\n-        if (it == null || !it.hasNext())\n-            it = data.iterator();\n-        var d = it.next();\n-        new StackMapGenerator(\n-                d.labelContext(),\n-                d.thisClass(),\n-                d.methodName(),\n-                d.methodDesc(),\n-                d.isStatic(),\n-                d.bytecode().rewind(),\n-                (SplitConstantPool)d.constantPool(),\n-                (ClassFileImpl)cc,\n-                d.handlers());\n-    }\n-}\n","filename":"test\/micro\/org\/openjdk\/bench\/jdk\/classfile\/GenerateStackMaps.java","additions":0,"deletions":123,"binary":false,"changes":123,"status":"deleted"}]}