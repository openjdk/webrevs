{"files":[{"patch":"@@ -1090,1 +1090,0 @@\n-  volatile size_t                           _numa_local_forwardings;\n@@ -1107,2 +1106,1 @@\n-      _total_forwardings(relocation_set->nforwardings()),\n-      _numa_local_forwardings(0) {\n+      _total_forwardings(relocation_set->nforwardings()) {\n@@ -1127,5 +1125,0 @@\n-\n-    if (ZNUMA::is_enabled()) {\n-      log_debug(gc, reloc, numa)(\"Forwardings relocated NUMA-locally: %zu \/ %zu (%.0f%%)\",\n-                                 _numa_local_forwardings, _total_forwardings, percent_of(_numa_local_forwardings, _total_forwardings));\n-    }\n@@ -1137,0 +1130,1 @@\n+\n@@ -1138,1 +1132,3 @@\n-    uint32_t numa_local_forwardings_worker = 0;\n+    const uint32_t start_node_id = ZNUMA::id();\n+    uint32_t current_node_id = start_node_id;\n+    int current_node_affinity = -1;\n@@ -1170,10 +1166,8 @@\n-      const uint32_t start_node = ZNUMA::id();\n-      uint32_t current_node = start_node;\n-\n-      for (uint32_t i = 0; i < num_nodes; i++) {\n-        if (_iters->get(current_node).next_if(&forwarding, check_numa_local, current_node)) {\n-          claim_and_do_forwarding(forwarding);\n-\n-          if (current_node == start_node) {\n-            \/\/ Track if this forwarding was relocated on the local NUMA node\n-            numa_local_forwardings_worker++;\n+      if (_iters->get(current_node_id).next_if(&forwarding, check_numa_local, current_node_id)) {\n+        if (UseNUMA) {\n+          \/\/ Set thread affinity for NUMA-local processing (if needed)\n+          const int current_node = ZNUMA::numa_id_to_node(current_node_id);\n+\n+          if (current_node_affinity != current_node) {\n+            os::numa_set_thread_affinity(Thread::current(), current_node);\n+            current_node_affinity = current_node;\n@@ -1181,2 +1175,0 @@\n-\n-          return true;\n@@ -1185,2 +1177,3 @@\n-        \/\/ Check next node.\n-        current_node = (current_node + 1) % num_nodes;\n+        \/\/ Perform the forwarding task\n+        claim_and_do_forwarding(forwarding);\n+        return true;\n@@ -1189,1 +1182,5 @@\n-      return false;\n+      \/\/ No work found on the current node, move to the next node\n+      current_node_id = (current_node_id + 1) % num_nodes;\n+\n+      \/\/ If we wrapped around to the start node there is no more work\n+      return current_node_id != start_node_id;\n@@ -1212,4 +1209,0 @@\n-    if (ZNUMA::is_enabled()) {\n-      AtomicAccess::add(&_numa_local_forwardings, numa_local_forwardings_worker, memory_order_relaxed);\n-    }\n-\n@@ -1217,0 +1210,7 @@\n+\n+    if (current_node_affinity != -1) {\n+      assert(UseNUMA, \"Should only happen with NUMA\");\n+      \/\/ Restore the affinity of the thread so that it isn't bound to a specific\n+      \/\/ node any more\n+      os::numa_set_thread_affinity(Thread::current(), -1);\n+    }\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocate.cpp","additions":28,"deletions":28,"binary":false,"changes":56,"status":"modified"}]}