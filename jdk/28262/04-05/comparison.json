{"files":[{"patch":"@@ -1132,3 +1132,4 @@\n-    const uint32_t start_node_id = ZNUMA::id();\n-    uint32_t current_node_id = start_node_id;\n-    int current_node_affinity = -1;\n+    const uint32_t start_node = ZNUMA::id();\n+    uint32_t current_node = start_node;\n+    bool has_affinity = false;\n+    bool has_affinity_current_node = false;\n@@ -1166,4 +1167,0 @@\n-      if (_iters->get(current_node_id).next_if(&forwarding, check_numa_local, current_node_id)) {\n-        if (UseNUMA) {\n-          \/\/ Set thread affinity for NUMA-local processing (if needed)\n-          const int current_node = ZNUMA::numa_id_to_node(current_node_id);\n@@ -1171,3 +1168,7 @@\n-          if (current_node_affinity != current_node) {\n-            os::numa_set_thread_affinity(Thread::current(), current_node);\n-            current_node_affinity = current_node;\n+      while (true) {\n+        if (_iters->get(current_node).next_if(&forwarding, check_numa_local, current_node)) {\n+          \/\/ Set thread affinity for NUMA-local processing (if needed)\n+          if (UseNUMA && !has_affinity_current_node) {\n+            os::numa_set_thread_affinity(Thread::current(), ZNUMA::numa_id_to_node(current_node));\n+            has_affinity = true;\n+            has_affinity_current_node = true;\n@@ -1175,0 +1176,4 @@\n+\n+          \/\/ Perform the forwarding task\n+          claim_and_do_forwarding(forwarding);\n+          return true;\n@@ -1177,4 +1182,3 @@\n-        \/\/ Perform the forwarding task\n-        claim_and_do_forwarding(forwarding);\n-        return true;\n-      }\n+        \/\/ No work found on the current node, move to the next node\n+        current_node = (current_node + 1) % num_nodes;\n+        has_affinity_current_node = false;\n@@ -1182,2 +1186,5 @@\n-      \/\/ No work found on the current node, move to the next node\n-      current_node_id = (current_node_id + 1) % num_nodes;\n+        \/\/ If we've looped back to the starting node there's no more work to do\n+        if (current_node == start_node) {\n+          return false;\n+        }\n+      }\n@@ -1185,2 +1192,2 @@\n-      \/\/ If we wrapped around to the start node there is no more work\n-      return current_node_id != start_node_id;\n+      \/\/ No more work\n+      return false;\n@@ -1211,2 +1218,1 @@\n-    if (current_node_affinity != -1) {\n-      assert(UseNUMA, \"Should only happen with NUMA\");\n+    if (UseNUMA && has_affinity) {\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocate.cpp","additions":26,"deletions":20,"binary":false,"changes":46,"status":"modified"}]}