{"files":[{"patch":"@@ -1090,1 +1090,0 @@\n-  volatile size_t                           _numa_local_forwardings;\n@@ -1107,2 +1106,1 @@\n-      _total_forwardings(relocation_set->nforwardings()),\n-      _numa_local_forwardings(0) {\n+      _total_forwardings(relocation_set->nforwardings()) {\n@@ -1127,5 +1125,0 @@\n-\n-    if (ZNUMA::is_enabled()) {\n-      log_debug(gc, reloc, numa)(\"Forwardings relocated NUMA-locally: %zu \/ %zu (%.0f%%)\",\n-                                 _numa_local_forwardings, _total_forwardings, percent_of(_numa_local_forwardings, _total_forwardings));\n-    }\n@@ -1137,0 +1130,1 @@\n+\n@@ -1138,1 +1132,4 @@\n-    uint32_t numa_local_forwardings_worker = 0;\n+    const uint32_t start_node = ZNUMA::id();\n+    uint32_t current_node = start_node;\n+    bool has_affinity = false;\n+    bool has_affinity_current_node = false;\n@@ -1170,2 +1167,0 @@\n-      const uint32_t start_node = ZNUMA::id();\n-      uint32_t current_node = start_node;\n@@ -1173,1 +1168,1 @@\n-      for (uint32_t i = 0; i < num_nodes; i++) {\n+      while (true) {\n@@ -1175,5 +1170,5 @@\n-          claim_and_do_forwarding(forwarding);\n-\n-          if (current_node == start_node) {\n-            \/\/ Track if this forwarding was relocated on the local NUMA node\n-            numa_local_forwardings_worker++;\n+          \/\/ Set thread affinity for NUMA-local processing (if needed)\n+          if (UseNUMA && !has_affinity_current_node) {\n+            os::numa_set_thread_affinity(Thread::current(), ZNUMA::numa_id_to_node(current_node));\n+            has_affinity = true;\n+            has_affinity_current_node = true;\n@@ -1182,0 +1177,2 @@\n+          \/\/ Perform the forwarding task\n+          claim_and_do_forwarding(forwarding);\n@@ -1185,1 +1182,1 @@\n-        \/\/ Check next node.\n+        \/\/ No work found on the current node, move to the next node\n@@ -1187,0 +1184,6 @@\n+        has_affinity_current_node = false;\n+\n+        \/\/ If we've looped back to the starting node there's no more work to do\n+        if (current_node == start_node) {\n+          return false;\n+        }\n@@ -1189,0 +1192,1 @@\n+      \/\/ No more work\n@@ -1212,4 +1216,0 @@\n-    if (ZNUMA::is_enabled()) {\n-      AtomicAccess::add(&_numa_local_forwardings, numa_local_forwardings_worker, memory_order_relaxed);\n-    }\n-\n@@ -1217,0 +1217,6 @@\n+\n+    if (UseNUMA && has_affinity) {\n+      \/\/ Restore the affinity of the thread so that it isn't bound to a specific\n+      \/\/ node any more\n+      os::numa_set_thread_affinity(Thread::current(), -1);\n+    }\n","filename":"src\/hotspot\/share\/gc\/z\/zRelocate.cpp","additions":28,"deletions":22,"binary":false,"changes":50,"status":"modified"}]}