{"files":[{"patch":"@@ -27,0 +27,1 @@\n+ * @key headful\n@@ -28,3 +29,1 @@\n- * @library \/java\/awt\/regtesthelpers\n- * @build PassFailJFrame\n- * @run main\/manual DefRendererSerialize\n+ * @run main DefRendererSerialize\n@@ -33,4 +32,4 @@\n-import java.io.ByteArrayOutputStream;\n-import java.io.IOException;\n-import java.io.ObjectOutputStream;\n-\n+import java.awt.Color;\n+import java.awt.Point;\n+import java.awt.Rectangle;\n+import java.awt.Robot;\n@@ -39,1 +38,0 @@\n-import javax.swing.UIManager;\n@@ -41,0 +39,7 @@\n+import javax.swing.SwingUtilities;\n+import java.util.*;\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.ObjectOutputStream;\n@@ -44,15 +49,15 @@\n-    static final String INSTRUCTIONS = \"\"\"\n-        A JTable is shown\n-        If the table text is black on white and not black on gray,\n-        then test passed, otherwise it failed.\"\"\";\n-\n-    public static void main(String[] args) throws Exception {\n-        UIManager.setLookAndFeel(\"javax.swing.plaf.metal.MetalLookAndFeel\");\n-        PassFailJFrame.builder()\n-                .title(\"DefRendererSerialize Instructions\")\n-                .instructions(INSTRUCTIONS)\n-                .columns(20)\n-                .testUI(DefRendererSerialize::createTestUI)\n-                .build()\n-                .awaitAndCheck();\n-    }\n+    private static JFrame frame;\n+    private static JTable table;\n+    private static volatile DefaultTableCellRenderer tcr;\n+    private static String[][] rowData = { {\"1-1\",\"1-2\",\"1-3\"},\n+                                          {\"2-1\",\"\",\"2-3\"},\n+                                          {\"3-1\",\"3-2\",\"3-3\"} };\n+\n+    private static String[] columnData = {\"Column 1\", \"Column 2\", \"Column 3\"};\n+    private static volatile Rectangle tableRect;\n+    private static volatile Point tableOnScreen;\n+    private static volatile Point p;\n+    private static Color fg, bg;\n+\n+    public static void main (String[] args) throws Exception {\n+        try {\n@@ -60,4 +65,3 @@\n-    static JFrame createTestUI() {\n-      String[][] rowData = { {\"1-1\",\"1-2\",\"1-3\"},\n-                             {\"2-1\",\"2-2\",\"2-3\"},\n-                             {\"3-1\",\"3-2\",\"3-3\"} };\n+            SwingUtilities.invokeAndWait(() -> {\n+                frame = new JFrame();\n+                table = new JTable(rowData, columnData);\n@@ -65,1 +69,2 @@\n-      String[] columnData = {\"Column 1\", \"Column 2\", \"Column 3\"};\n+                DefaultTableCellRenderer tcr = new DefaultTableCellRenderer();\n+                table.setDefaultRenderer(table.getColumnClass(1), tcr);\n@@ -67,1 +72,1 @@\n-      JTable table = new JTable(rowData, columnData);\n+                \/\/ If this try block is removed, table text remains black on white.\n@@ -69,2 +74,4 @@\n-      table.setDefaultRenderer(table.getColumnClass(1),\n-                               new DefaultTableCellRenderer());\n+                fg = tcr.getForeground();\n+                bg = tcr.getBackground();\n+                System.out.println(\"renderer fg \" + fg + \" bg \" + bg);\n+                tcr = (DefaultTableCellRenderer) table.getDefaultRenderer(table.getColumnClass(1));\n@@ -72,1 +79,10 @@\n-      \/\/ If this try block is removed, table text remains black on white.\n+                byte[] serializedObject = null;\n+                try {\n+                    ByteArrayOutputStream bytes = new ByteArrayOutputStream();\n+                    ObjectOutputStream ostream = new ObjectOutputStream(bytes);\n+                    ostream.writeObject(tcr);\n+                    ostream.flush();\n+                    serializedObject = bytes.toByteArray();\n+                } catch (IOException ioex) {\n+                    ioex.printStackTrace();\n+                }\n@@ -74,6 +90,14 @@\n-      try {\n-         ObjectOutputStream ostream = new ObjectOutputStream(new ByteArrayOutputStream());\n-         ostream.writeObject(table.getDefaultRenderer(table.getColumnClass(1)));\n-      } catch (IOException ioex) {\n-         ioex.printStackTrace();\n-      }\n+                if (serializedObject == null) {\n+                    throw new RuntimeException(\"FAILED: Serialized byte array in null\");\n+                }\n+                try {\n+                    DefaultTableCellRenderer destcr;\n+                    try (ObjectInputStream inputStream =\n+                            new ObjectInputStream(new ByteArrayInputStream(serializedObject))) {\n+                        destcr = (DefaultTableCellRenderer) inputStream.readObject();\n+                    }\n+                    System.out.println(\"deserialized renderer fg \" + fg + \" bg \" + bg);\n+                    if (!(fg == destcr.getForeground()) || !(bg == destcr.getBackground())) {\n+                        throw new RuntimeException(\"Desrialized foreground and background color not same\");\n+                    }\n+                } catch (IOException | ClassNotFoundException e) {}\n@@ -81,2 +105,1 @@\n-      JFrame frame = new JFrame(\"DefRendererSerialize\");\n-      frame.add(table);\n+                frame.add(table);\n@@ -84,3 +107,28 @@\n-      frame.pack();\n-      return frame;\n-   }\n+                frame.pack();\n+                frame.setLocationRelativeTo(null);\n+                frame.setVisible(true);\n+            });\n+            Robot robot = new Robot();\n+            robot.waitForIdle();\n+            robot.delay(1000);\n+            SwingUtilities.invokeAndWait(() -> {\n+                tableRect = table.getCellRect(1, 1, true);\n+                tableOnScreen = table.getLocationOnScreen();\n+\n+                p = new Point(tableOnScreen.x + tableRect.x + tableRect.width \/ 2,\n+                                tableOnScreen.y + tableRect.y + tableRect.height \/ 2);\n+\n+            });\n+            Color pixelColor = robot.getPixelColor(p.x, p.y);\n+            System.out.println(\"pixelColor \" + pixelColor);\n+            if (!pixelColor.equals(Color.white)) {\n+                throw new RuntimeException(\"Serializing DefaultTableCellRenderer changes colors\");\n+            }\n+        } finally {\n+            SwingUtilities.invokeAndWait(() -> {\n+                if (frame != null) {\n+                    frame.dispose();\n+                }\n+            });\n+        }\n+    }\n","filename":"test\/jdk\/javax\/swing\/DefaultTableCellRenderer\/DefRendererSerialize.java","additions":91,"deletions":43,"binary":false,"changes":134,"status":"modified"}]}