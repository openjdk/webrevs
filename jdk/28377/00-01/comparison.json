{"files":[{"patch":"@@ -123,3 +123,2 @@\n-            if (next instanceof ClassMethodTransform(var nextTransform, var nextFilter))\n-                return new ClassMethodTransform(transform.andThen(nextTransform),\n-                                                mm -> filter.test(mm) || nextFilter.test(mm));\n+            if (next instanceof ClassMethodTransform(var nextTransform, var nextFilter) && filter == nextFilter)\n+                return new ClassMethodTransform(transform.andThen(nextTransform), filter);\n@@ -146,3 +145,2 @@\n-            if (next instanceof ClassFieldTransform(var nextTransform, var nextFilter))\n-                return new ClassFieldTransform(transform.andThen(nextTransform),\n-                                               mm -> filter.test(mm) || nextFilter.test(mm));\n+            if (next instanceof ClassFieldTransform(var nextTransform, var nextFilter) && filter == nextFilter)\n+                return new ClassFieldTransform(transform.andThen(nextTransform), filter);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/TransformImpl.java","additions":4,"deletions":6,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -31,14 +31,4 @@\n-import java.lang.classfile.ClassBuilder;\n-import java.lang.classfile.ClassElement;\n-import java.lang.classfile.ClassFile;\n-import java.lang.classfile.ClassModel;\n-import java.lang.classfile.ClassTransform;\n-import java.lang.classfile.CodeBuilder;\n-import java.lang.classfile.CodeElement;\n-import java.lang.classfile.CodeModel;\n-import java.lang.classfile.CodeTransform;\n-import java.lang.classfile.FieldModel;\n-import java.lang.classfile.FieldTransform;\n-import java.lang.classfile.Label;\n-import java.lang.classfile.MethodModel;\n-import java.lang.classfile.MethodTransform;\n+import java.lang.classfile.*;\n+import java.lang.classfile.attribute.AnnotationDefaultAttribute;\n+import java.lang.classfile.attribute.ConstantValueAttribute;\n+import java.lang.classfile.attribute.SourceDebugExtensionAttribute;\n@@ -344,4 +334,4 @@\n-                .withField(\"one\", CD_int, _ -> {})\n-                .withField(\"two\", CD_int, _ -> {})\n-                .withMethodBody(\"one\", MTD_void, 0, CodeBuilder::return_)\n-                .withMethodBody(\"two\", MTD_void, 0, CodeBuilder::return_)));\n+                .withField(\"one\", CD_int, fb -> fb.with(ConstantValueAttribute.of(1)))\n+                .withField(\"two\", CD_int, fb -> fb.with(ConstantValueAttribute.of(2)))\n+                .withMethod(\"one\", MTD_void, 0, mb -> mb.with(AnnotationDefaultAttribute.of(AnnotationValue.ofInt(1))).withCode(CodeBuilder::return_))\n+                .withMethod(\"two\", MTD_void, 0, mb -> mb.with(AnnotationDefaultAttribute.of(AnnotationValue.ofInt(2))).withCode(CodeBuilder::return_))));\n@@ -350,2 +340,7 @@\n-        var oneFieldTransform = new TransformImpl.ClassFieldTransform(FieldTransform.endHandler(_ -> oneFieldCalled.set(true)),\n-                fm -> fm.fieldName().equalsString(\"one\"));\n+        var oneFieldTransform = new TransformImpl.ClassFieldTransform((fb, fe) -> {\n+            if (fe instanceof ConstantValueAttribute cv) {\n+                assertEquals(1, ((Integer) cv.constant().constantValue()), \"Should only transform one\");\n+            }\n+            oneFieldCalled.set(true);\n+            fb.with(fe);\n+        }, fm -> fm.fieldName().equalsString(\"one\"));\n@@ -353,2 +348,7 @@\n-        var twoFieldTransform = new TransformImpl.ClassFieldTransform(FieldTransform.endHandler(_ -> twoFieldCalled.set(true)),\n-                fm -> fm.fieldName().equalsString(\"two\"));\n+        var twoFieldTransform = new TransformImpl.ClassFieldTransform((fb, fe) -> {\n+            if (fe instanceof ConstantValueAttribute cv) {\n+                assertEquals(2, ((Integer) cv.constant().constantValue()), \"Should only transform two\");\n+            }\n+            twoFieldCalled.set(true);\n+            fb.with(fe);\n+        }, fm -> fm.fieldName().equalsString(\"two\"));\n@@ -360,2 +360,7 @@\n-        var oneMethodTransform = ClassTransform.transformingMethods(mm -> mm.methodName().equalsString(\"one\"),\n-                MethodTransform.endHandler(_ -> oneMethodCalled.set(true)));\n+        var oneMethodTransform = ClassTransform.transformingMethods(mm -> mm.methodName().equalsString(\"one\"), (mb, me) -> {\n+            if (me instanceof AnnotationDefaultAttribute ada) {\n+                assertEquals(1, ((AnnotationValue.OfInt) ada.defaultValue()).intValue(), \"Should only transform one\");\n+            }\n+            oneMethodCalled.set(true);\n+            mb.with(me);\n+        });\n@@ -363,2 +368,7 @@\n-        var twoMethodTransform = ClassTransform.transformingMethods(mm -> mm.methodName().equalsString(\"two\"),\n-                MethodTransform.endHandler(_ -> twoMethodCalled.set(true)));\n+        var twoMethodTransform = ClassTransform.transformingMethods(mm -> mm.methodName().equalsString(\"two\"), (mb, me) -> {\n+            if (me instanceof AnnotationDefaultAttribute ada) {\n+                assertEquals(2, ((AnnotationValue.OfInt) ada.defaultValue()).intValue(), \"Should only transform two\");\n+            }\n+            twoMethodCalled.set(true);\n+            mb.with(me);\n+        });\n","filename":"test\/jdk\/jdk\/classfile\/TransformTests.java","additions":36,"deletions":26,"binary":false,"changes":62,"status":"modified"}]}