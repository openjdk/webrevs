{"files":[{"patch":"@@ -823,4 +823,4 @@\n-        if (checkCloseNotify && !conContext.isInputCloseNotified &&\n-            (conContext.isNegotiated || conContext.handshakeContext != null)) {\n-\n-            throw conContext.fatal(Alert.INTERNAL_ERROR,\n+        try {\n+            if (checkCloseNotify && !conContext.isInputCloseNotified &&\n+                (conContext.isNegotiated || conContext.handshakeContext != null)) {\n+            throw new SSLException(\n@@ -828,5 +828,6 @@\n-        }\n-\n-        conContext.closeInbound();\n-        if ((autoClose || !isLayered()) && !super.isInputShutdown()) {\n-            super.shutdownInput();\n+            }\n+        } finally {\n+            conContext.closeInbound();\n+            if ((autoClose || !isLayered()) && !super.isInputShutdown()) {\n+                super.shutdownInput();\n+            }\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/SSLSocketImpl.java","additions":10,"deletions":9,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2020, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug 8184328\n+ * @bug 8184328 8253368\n@@ -29,0 +29,1 @@\n+ * @run main\/othervm SSLSocketCloseHang shutdownInputTest\n@@ -75,0 +76,2 @@\n+    static boolean shutdownInputTest = false;\n+\n@@ -148,1 +151,20 @@\n-        sslSocket.close();\n+        if (shutdownInputTest) {\n+            try {\n+                sslSocket.shutdownInput();\n+            } catch (SSLException e) {\n+                if (!e.getMessage().contains\n+                        (\"closing inbound before receiving peer's close_notify\")) {\n+                    throw new RuntimeException(\"expected different exception message. \" +\n+                        e.getMessage());\n+                }\n+            }\n+            if (!sslSocket.getSession().isValid()) {\n+                throw new RuntimeException(\"expected session to remain valid\");\n+            }\n+\n+        } else {\n+            sslSocket.close();\n+        }\n+\n+\n+\n@@ -182,0 +204,2 @@\n+        shutdownInputTest = args.length > 0 ? true : false;\n+\n","filename":"test\/jdk\/sun\/security\/ssl\/SSLSocketImpl\/SSLSocketCloseHang.java","additions":27,"deletions":3,"binary":false,"changes":30,"status":"modified"}]}