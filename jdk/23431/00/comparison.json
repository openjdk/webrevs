{"files":[{"patch":"@@ -883,1 +883,0 @@\n-BUILD_HOTSPOT_JTREG_LIBRARIES_JDK_LIBS_libatExit := java.base:libjvm\n","filename":"make\/test\/JtregNativeHotspot.gmk","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -27,0 +27,6 @@\n+#ifdef WINDOWS\n+#include <windows.h>\n+#else\n+#include <dlfcn.h>\n+#endif \/\/ WINDOWS\n+\n@@ -55,0 +61,42 @@\n+typedef jint (JNICALL *GetDefaultJavaVMInitArgs_t)(void *args);\n+typedef jint (JNICALL *GetCreatedJavaVMs_t)(JavaVM **vmBuf, jsize bufLen, jsize *nVMs);\n+typedef jint (JNICALL *CreateJavaVM_t)(JavaVM **pvm, void **penv, void *args);\n+\n+GetDefaultJavaVMInitArgs_t GetDefaultJavaVMInitArgs = NULL;\n+GetCreatedJavaVMs_t GetCreatedJavaVMs = NULL;\n+CreateJavaVM_t CreateJavaVM = NULL;\n+\n+\/\/ VM is already loaded.\n+jboolean getJavaVMfunctions() {\n+#ifdef WINDOWS\n+    HMODULE handle;\n+    handle = GetModuleHandle(\"jvm.dll\");\n+    if (handle == NULL) {\n+      \/\/ No loaded jvm.dll. Get the handle to the executable.\n+      handle = GetModuleHandle(NULL);\n+    }\n+#endif\n+\n+#ifdef WINDOWS\n+#define GET_VM_FUNCTION(f) GetProcAddress(handle, f)\n+#else\n+#define GET_VM_FUNCTION(f) dlsym(RTLD_DEFAULT, f)\n+#endif\n+    GetDefaultJavaVMInitArgs = (GetDefaultJavaVMInitArgs_t)GET_VM_FUNCTION(\"JNI_GetDefaultJavaVMInitArgs\");\n+    if (GetDefaultJavaVMInitArgs == NULL) {\n+      fprintf(stderr, \"Failed to find JNI_GetDefaultJavaVMInitArgs\");\n+      return JNI_FALSE;\n+    }\n+    GetCreatedJavaVMs = (GetCreatedJavaVMs_t)GET_VM_FUNCTION(\"JNI_GetCreatedJavaVMs\");\n+    if (GetCreatedJavaVMs == NULL) {\n+      fprintf(stderr, \"Failed to find JNI_GetCreatedJavaVMs\");\n+      return JNI_FALSE;\n+    }\n+    CreateJavaVM = (CreateJavaVM_t)GET_VM_FUNCTION(\"JNI_CreateJavaVM\");\n+    if (CreateJavaVM == NULL) {\n+      fprintf(stderr, \"Failed to find JNI_CreateJavaVM\");\n+      return JNI_FALSE;\n+    }\n+    return JNI_TRUE;\n+}\n+\n@@ -63,0 +111,4 @@\n+  if (!getJavaVMfunctions()) {\n+    return;\n+  }\n+\n@@ -81,1 +133,1 @@\n-    res = JNI_GetDefaultJavaVMInitArgs(&args);\n+    res = (*GetDefaultJavaVMInitArgs)(&args);\n@@ -86,1 +138,1 @@\n-    res = JNI_GetCreatedJavaVMs(jvm_p, 1, &nVMs);\n+    res = (*GetCreatedJavaVMs)(jvm_p, 1, &nVMs);\n@@ -101,1 +153,1 @@\n-    res = JNI_CreateJavaVM(jvm_p, (void**)&env, &args);\n+    res = (*CreateJavaVM)(jvm_p, (void**)&env, &args);\n","filename":"test\/hotspot\/jtreg\/runtime\/jni\/atExit\/libatExit.c","additions":55,"deletions":3,"binary":false,"changes":58,"status":"modified"}]}