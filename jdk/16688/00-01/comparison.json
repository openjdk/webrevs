{"files":[{"patch":"@@ -232,1 +232,1 @@\n-int JvmtiVTMSTransitionDisabler::_sync_protocol_enabled_count = 0;\n+volatile int JvmtiVTMSTransitionDisabler::_sync_protocol_enabled_count = 0;\n@@ -235,1 +235,1 @@\n-bool JvmtiVTMSTransitionDisabler::_sync_protocol_enabled_permanently = false;\n+volatile bool JvmtiVTMSTransitionDisabler::_sync_protocol_enabled_permanently = false;\n@@ -264,1 +264,1 @@\n-  if (!_sync_protocol_enabled_permanently) {\n+  if (!sync_protocol_enabled_permanently()) {\n@@ -284,1 +284,1 @@\n-  if (!_sync_protocol_enabled_permanently) {\n+  if (!sync_protocol_enabled_permanently()) {\n@@ -287,1 +287,1 @@\n-      _sync_protocol_enabled_permanently = true;\n+      Atomic::store(&_sync_protocol_enabled_permanently, true);\n@@ -305,1 +305,1 @@\n-  if (!_sync_protocol_enabled_permanently) {\n+  if (!sync_protocol_enabled_permanently()) {\n@@ -430,1 +430,1 @@\n-     java_lang_Thread::set_is_in_VTMS_transition(vt, true);\n+    java_lang_Thread::set_is_in_VTMS_transition(vt, true);\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.cpp","additions":7,"deletions":7,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -86,2 +86,2 @@\n-  static int  _sync_protocol_enabled_count;              \/\/ current number of JvmtiVTMSTransitionDisablers enabled sync protocol\n-  static bool _sync_protocol_enabled_permanently;        \/\/ seen a suspender: JvmtiVTMSTraansitionDisabler protocol is enabled permanently\n+  static volatile int _sync_protocol_enabled_count;      \/\/ current number of JvmtiVTMSTransitionDisablers enabled sync protocol\n+  static volatile bool _sync_protocol_enabled_permanently; \/\/ seen a suspender: JvmtiVTMSTraansitionDisabler protocol is enabled permanently\n@@ -105,3 +105,6 @@\n-  static void inc_sync_protocol_enabled_count()      { _sync_protocol_enabled_count++; }\n-  static void dec_sync_protocol_enabled_count()      { _sync_protocol_enabled_count--; }\n-  static bool sync_protocol_enabled()                { return _sync_protocol_enabled_count > 0 || _sync_protocol_enabled_permanently; }\n+  static void inc_sync_protocol_enabled_count()      { Atomic::inc(&_sync_protocol_enabled_count); }\n+  static void dec_sync_protocol_enabled_count()      { Atomic::dec(&_sync_protocol_enabled_count); }\n+  static int  sync_protocol_enabled_count()          { return Atomic::load(&_sync_protocol_enabled_count); }\n+  static bool sync_protocol_enabled_permanently()    { return Atomic::load(&_sync_protocol_enabled_permanently); }\n+\n+  static bool sync_protocol_enabled()                { return sync_protocol_enabled_permanently() || sync_protocol_enabled_count() > 0; }\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.hpp","additions":8,"deletions":5,"binary":false,"changes":13,"status":"modified"}]}