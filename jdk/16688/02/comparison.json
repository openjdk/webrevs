{"files":[{"patch":"@@ -231,0 +231,6 @@\n+\/\/ The JvmtiVTMSTransitionDisabler sync protocol is enabled if this count > 0.\n+volatile int JvmtiVTMSTransitionDisabler::_sync_protocol_enabled_count = 0;\n+\n+\/\/ JvmtiVTMSTraansitionDisabler sync protocol is enabled permanently after seeing a suspender.\n+volatile bool JvmtiVTMSTransitionDisabler::_sync_protocol_enabled_permanently = false;\n+\n@@ -258,0 +264,3 @@\n+  if (!sync_protocol_enabled_permanently()) {\n+    JvmtiVTMSTransitionDisabler::inc_sync_protocol_enabled_count();\n+  }\n@@ -275,0 +284,6 @@\n+  if (!sync_protocol_enabled_permanently()) {\n+    JvmtiVTMSTransitionDisabler::inc_sync_protocol_enabled_count();\n+    if (is_SR) {\n+      Atomic::store(&_sync_protocol_enabled_permanently, true);\n+    }\n+  }\n@@ -290,0 +305,3 @@\n+  if (!sync_protocol_enabled_permanently()) {\n+    JvmtiVTMSTransitionDisabler::dec_sync_protocol_enabled_count();\n+  }\n@@ -407,3 +425,2 @@\n-  HandleMark hm(thread);\n-  Handle vth = Handle(thread, JNIHandles::resolve_external_guard(vthread));\n-  int attempts = 50000;\n+  oop vt = JNIHandles::resolve_external_guard(vthread);\n+  assert(!thread->is_in_VTMS_transition(), \"VTMS_transition sanity check\");\n@@ -414,1 +431,9 @@\n-  java_lang_Thread::set_is_in_VTMS_transition(vth(), true);\n+  java_lang_Thread::set_is_in_VTMS_transition(vt, true);\n+\n+  if (!sync_protocol_enabled()) {\n+    thread->set_is_in_VTMS_transition(true);\n+    return;\n+  }\n+  HandleMark hm(thread);\n+  Handle vth = Handle(thread, vt);\n+  int attempts = 50000;\n@@ -461,1 +486,0 @@\n-  assert(!thread->is_in_VTMS_transition(), \"VTMS_transition sanity check\");\n@@ -472,1 +496,0 @@\n-  int64_t thread_id = java_lang_Thread::thread_id(vt);\n@@ -474,1 +497,0 @@\n-\n@@ -477,0 +499,5 @@\n+  if (!sync_protocol_enabled()) {\n+    return;\n+  }\n+  int64_t thread_id = java_lang_Thread::thread_id(vt);\n+\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.cpp","additions":34,"deletions":7,"binary":false,"changes":41,"status":"modified"},{"patch":"@@ -86,0 +86,2 @@\n+  static volatile int _sync_protocol_enabled_count;      \/\/ current number of JvmtiVTMSTransitionDisablers enabled sync protocol\n+  static volatile bool _sync_protocol_enabled_permanently; \/\/ seen a suspender: JvmtiVTMSTraansitionDisabler protocol is enabled permanently\n@@ -103,0 +105,7 @@\n+  static void inc_sync_protocol_enabled_count()      { Atomic::inc(&_sync_protocol_enabled_count); }\n+  static void dec_sync_protocol_enabled_count()      { Atomic::dec(&_sync_protocol_enabled_count); }\n+  static int  sync_protocol_enabled_count()          { return Atomic::load(&_sync_protocol_enabled_count); }\n+  static bool sync_protocol_enabled_permanently()    { return Atomic::load(&_sync_protocol_enabled_permanently); }\n+\n+  static bool sync_protocol_enabled()                { return sync_protocol_enabled_permanently() || sync_protocol_enabled_count() > 0; }\n+\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.hpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"}]}