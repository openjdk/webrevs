{"files":[{"patch":"@@ -493,1 +493,2 @@\n-        return canonicalize0(path);\n+        String canonicalPath = canonicalize0(path);\n+        return getFinalPath(canonicalPath);\n@@ -499,0 +500,7 @@\n+    private String getFinalPath(String path) throws IOException {\n+        return getFinalPath0(path);\n+    }\n+\n+    private native String getFinalPath0(String path)\n+            throws IOException;\n+\n","filename":"src\/java.base\/windows\/classes\/java\/io\/WinNTFileSystem.java","additions":9,"deletions":1,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2001, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -49,6 +49,0 @@\n-\/**\n- * GetFinalPathNameByHandle is available on Windows Vista and newer\n- *\/\n-typedef BOOL (WINAPI* GetFinalPathNameByHandleProc) (HANDLE, LPWSTR, DWORD, DWORD);\n-static GetFinalPathNameByHandleProc GetFinalPathNameByHandle_func;\n-\n@@ -58,1 +52,0 @@\n-    HMODULE handle;\n@@ -65,9 +58,0 @@\n-\n-    \/\/ GetFinalPathNameByHandle requires Windows Vista or newer\n-    if (GetModuleHandleExW((GET_MODULE_HANDLE_EX_FLAG_FROM_ADDRESS |\n-                            GET_MODULE_HANDLE_EX_FLAG_UNCHANGED_REFCOUNT),\n-                           (LPCWSTR)&CreateFileW, &handle) != 0)\n-    {\n-        GetFinalPathNameByHandle_func = (GetFinalPathNameByHandleProc)\n-            GetProcAddress(handle, \"GetFinalPathNameByHandleW\");\n-    }\n@@ -91,4 +75,0 @@\n-    \/* Need Windows Vista or newer to get the final path *\/\n-    if (GetFinalPathNameByHandle_func == NULL)\n-        return NULL;\n-\n@@ -112,1 +92,1 @@\n-        DWORD len = (*GetFinalPathNameByHandle_func)(h, result, MAX_PATH, 0);\n+        DWORD len = GetFinalPathNameByHandleW(h, result, MAX_PATH, 0);\n@@ -118,1 +98,1 @@\n-                len = (*GetFinalPathNameByHandle_func)(h, result, len, 0);\n+                len = GetFinalPathNameByHandleW(h, result, len, 0);\n@@ -354,0 +334,19 @@\n+JNIEXPORT jstring JNICALL\n+Java_java_io_WinNTFileSystem_getFinalPath0(JNIEnv* env, jobject this, jstring pathname) {\n+    jstring rv = NULL;\n+\n+    WITH_UNICODE_STRING(env, pathname, path) {\n+        WCHAR* finalPath = getFinalPath(env, path);\n+        if (finalPath != NULL) {\n+            rv = (*env)->NewString(env, finalPath, (jsize)wcslen(finalPath));\n+            free(finalPath);\n+        }\n+    } END_UNICODE_STRING(env, path);\n+\n+    if (rv == NULL && !(*env)->ExceptionCheck(env)) {\n+        JNU_ThrowIOExceptionWithLastError(env, \"Bad pathname\"); \/\/ XXX message?\n+    }\n+\n+    return rv;\n+}\n+\n","filename":"src\/java.base\/windows\/native\/libjava\/WinNTFileSystem_md.c","additions":22,"deletions":23,"binary":false,"changes":45,"status":"modified"}]}