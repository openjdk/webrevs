{"files":[{"patch":"@@ -524,1 +524,12 @@\n-static void rewrite_nofast_bytecode(const methodHandle& method) {\n+\/\/ In AOTCache workflow, when dumping preimage, the constant pool entries are stored in unresolved state.\n+\/\/ So the fast version of getfield\/putfield needs to be converted to nofast version.\n+\/\/ When dumping the final image in the assembly phase, these nofast versions are converted back to fast versions\n+\/\/ if the constant pool entry refered by these bytecodes is stored in resolved state.\n+\/\/ Same principle applies to static and dynamic archives. If the constant pool entry is in resolved state, then\n+\/\/ the fast version of the bytecodes can be preserved, else use the nofast version.\n+\/\/\n+\/\/ The fast versions of aload_0 (i.e. _fast_Xaccess_0) merges the bytecode pair (aload_0, fast_Xgetfield).\n+\/\/ If the fast version of aload_0 is preserved in AOTCache, then the JVMTI notifications for field access and\n+\/\/ breakpoint events will be skipped for the second bytecode (fast_Xgetfield) in the pair.\n+\/\/ Same holds for fast versions of iload_0. So for these bytecodes, nofast version is used.\n+static void rewrite_bytecodes(const methodHandle& method) {\n@@ -544,5 +555,0 @@\n-#ifdef ASSERT\n-      if (CDSConfig::is_dumping_preimage_static_archive()) {\n-        assert(!is_resolved, \"preimage should not have resolved field references\");\n-      }\n-#endif \/\/ ASSERT\n@@ -550,0 +556,1 @@\n+        assert(!CDSConfig::is_dumping_preimage_static_archive(), \"preimage should not have resolved field references\");\n@@ -554,24 +561,8 @@\n-        case ztos:\n-          new_code = Bytecodes::_fast_bgetfield;\n-          break;\n-        case atos:\n-          new_code = Bytecodes::_fast_agetfield;\n-          break;\n-        case itos:\n-          new_code = Bytecodes::_fast_igetfield;\n-          break;\n-        case ctos:\n-          new_code = Bytecodes::_fast_cgetfield;\n-          break;\n-        case stos:\n-          new_code = Bytecodes::_fast_sgetfield;\n-          break;\n-        case ltos:\n-          new_code = Bytecodes::_fast_lgetfield;\n-          break;\n-        case ftos:\n-          new_code = Bytecodes::_fast_fgetfield;\n-          break;\n-        case dtos:\n-          new_code = Bytecodes::_fast_dgetfield;\n-          break;\n+        case ztos: new_code = Bytecodes::_fast_bgetfield; break;\n+        case atos: new_code = Bytecodes::_fast_agetfield; break;\n+        case itos: new_code = Bytecodes::_fast_igetfield; break;\n+        case ctos: new_code = Bytecodes::_fast_cgetfield; break;\n+        case stos: new_code = Bytecodes::_fast_sgetfield; break;\n+        case ltos: new_code = Bytecodes::_fast_lgetfield; break;\n+        case ftos: new_code = Bytecodes::_fast_fgetfield; break;\n+        case dtos: new_code = Bytecodes::_fast_dgetfield; break;\n@@ -590,5 +581,0 @@\n-#ifdef ASSERT\n-      if (CDSConfig::is_dumping_preimage_static_archive()) {\n-        assert(!is_resolved, \"preimage should not have resolved field references\");\n-      }\n-#endif \/\/ ASSERT\n@@ -596,0 +582,1 @@\n+        assert(!CDSConfig::is_dumping_preimage_static_archive(), \"preimage should not have resolved field references\");\n@@ -598,27 +585,9 @@\n-        case btos:\n-          new_code = Bytecodes::_fast_bputfield;\n-          break;\n-        case ztos:\n-          new_code = Bytecodes::_fast_zputfield;\n-          break;\n-        case atos:\n-          new_code = Bytecodes::_fast_aputfield;\n-          break;\n-        case itos:\n-          new_code = Bytecodes::_fast_iputfield;\n-          break;\n-        case ctos:\n-          new_code = Bytecodes::_fast_cputfield;\n-          break;\n-        case stos:\n-          new_code = Bytecodes::_fast_sputfield;\n-          break;\n-        case ltos:\n-          new_code = Bytecodes::_fast_lputfield;\n-          break;\n-        case ftos:\n-          new_code = Bytecodes::_fast_fputfield;\n-          break;\n-        case dtos:\n-          new_code = Bytecodes::_fast_dputfield;\n-          break;\n+        case btos: new_code = Bytecodes::_fast_bputfield; break;\n+        case ztos: new_code = Bytecodes::_fast_zputfield; break;\n+        case atos: new_code = Bytecodes::_fast_aputfield; break;\n+        case itos: new_code = Bytecodes::_fast_iputfield; break;\n+        case ctos: new_code = Bytecodes::_fast_cputfield; break;\n+        case stos: new_code = Bytecodes::_fast_sputfield; break;\n+        case ltos: new_code = Bytecodes::_fast_lputfield; break;\n+        case ftos: new_code = Bytecodes::_fast_fputfield; break;\n+        case dtos: new_code = Bytecodes::_fast_dputfield; break;\n@@ -635,0 +604,1 @@\n+      \/\/ Revert _fast_Xaccess_0 or _aload_0 to _nofast_aload_0\n@@ -657,1 +627,1 @@\n-void AOTMetaspace::rewrite_nofast_bytecodes_and_calculate_fingerprints(Thread* thread, InstanceKlass* ik) {\n+void AOTMetaspace::rewrite_bytecodes_and_calculate_fingerprints(Thread* thread, InstanceKlass* ik) {\n@@ -661,1 +631,1 @@\n-      rewrite_nofast_bytecode(m);\n+      rewrite_bytecodes(m);\n","filename":"src\/hotspot\/share\/cds\/aotMetaspace.cpp","additions":34,"deletions":64,"binary":false,"changes":98,"status":"modified"},{"patch":"@@ -147,1 +147,1 @@\n-  static void rewrite_nofast_bytecodes_and_calculate_fingerprints(Thread* thread, InstanceKlass* ik);\n+  static void rewrite_bytecodes_and_calculate_fingerprints(Thread* thread, InstanceKlass* ik);\n","filename":"src\/hotspot\/share\/cds\/aotMetaspace.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -955,1 +955,1 @@\n-      AOTMetaspace::rewrite_nofast_bytecodes_and_calculate_fingerprints(Thread::current(), ik);\n+      AOTMetaspace::rewrite_bytecodes_and_calculate_fingerprints(Thread::current(), ik);\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}