{"files":[{"patch":"@@ -80,0 +80,1 @@\n+#include \"oops\/constantPool.inline.hpp\"\n@@ -85,0 +86,1 @@\n+#include \"oops\/resolvedFieldEntry.hpp\"\n@@ -523,0 +525,1 @@\n+  ConstantPool* cp = method->constants();\n@@ -524,0 +527,9 @@\n+  Bytecodes::Code new_code;\n+\n+  LogStreamHandle(Trace, aot, resolve) lsh;\n+  if (lsh.is_enabled()) {\n+    lsh.print(\"Rewriting bytecodes for \");\n+    method()->print_external_name(&lsh);\n+    lsh.print(\"\\n\");\n+  }\n+\n@@ -526,5 +538,100 @@\n-    switch (opcode) {\n-    case Bytecodes::_getfield:      *bcs.bcp() = Bytecodes::_nofast_getfield;      break;\n-    case Bytecodes::_putfield:      *bcs.bcp() = Bytecodes::_nofast_putfield;      break;\n-    case Bytecodes::_aload_0:       *bcs.bcp() = Bytecodes::_nofast_aload_0;       break;\n-    case Bytecodes::_iload: {\n+    \/\/ Use current opcode as the default value of new_code\n+    new_code = opcode;\n+    switch(opcode) {\n+    case Bytecodes::_getfield: {\n+      uint rfe_index = bcs.get_index_u2();\n+      bool is_resolved = cp->is_resolved(rfe_index, opcode);\n+#ifdef ASSERT\n+      if (CDSConfig::is_dumping_preimage_static_archive()) {\n+        assert(!is_resolved, \"preimage should not have resolved field references\");\n+      }\n+#endif \/\/ ASSERT\n+      if (is_resolved) {\n+        ResolvedFieldEntry* rfe = cp->resolved_field_entry_at(bcs.get_index_u2());\n+        switch(rfe->tos_state()) {\n+        case btos:\n+          \/\/ fallthrough\n+        case ztos:\n+          new_code = Bytecodes::_fast_bgetfield;\n+          break;\n+        case atos:\n+          new_code = Bytecodes::_fast_agetfield;\n+          break;\n+        case itos:\n+          new_code = Bytecodes::_fast_igetfield;\n+          break;\n+        case ctos:\n+          new_code = Bytecodes::_fast_cgetfield;\n+          break;\n+        case stos:\n+          new_code = Bytecodes::_fast_sgetfield;\n+          break;\n+        case ltos:\n+          new_code = Bytecodes::_fast_lgetfield;\n+          break;\n+        case ftos:\n+          new_code = Bytecodes::_fast_fgetfield;\n+          break;\n+        case dtos:\n+          new_code = Bytecodes::_fast_dgetfield;\n+          break;\n+        default:\n+          ShouldNotReachHere();\n+          break;\n+        }\n+      } else {\n+        new_code = Bytecodes::_nofast_getfield;\n+      }\n+      break;\n+    }\n+    case Bytecodes::_putfield: {\n+      uint rfe_index = bcs.get_index_u2();\n+      bool is_resolved = cp->is_resolved(rfe_index, opcode);\n+#ifdef ASSERT\n+      if (CDSConfig::is_dumping_preimage_static_archive()) {\n+        assert(!is_resolved, \"preimage should not have resolved field references\");\n+      }\n+#endif \/\/ ASSERT\n+      if (is_resolved) {\n+        ResolvedFieldEntry* rfe = cp->resolved_field_entry_at(bcs.get_index_u2());\n+        switch(rfe->tos_state()) {\n+        case btos:\n+          new_code = Bytecodes::_fast_bputfield;\n+          break;\n+        case ztos:\n+          new_code = Bytecodes::_fast_zputfield;\n+          break;\n+        case atos:\n+          new_code = Bytecodes::_fast_aputfield;\n+          break;\n+        case itos:\n+          new_code = Bytecodes::_fast_iputfield;\n+          break;\n+        case ctos:\n+          new_code = Bytecodes::_fast_cputfield;\n+          break;\n+        case stos:\n+          new_code = Bytecodes::_fast_sputfield;\n+          break;\n+        case ltos:\n+          new_code = Bytecodes::_fast_lputfield;\n+          break;\n+        case ftos:\n+          new_code = Bytecodes::_fast_fputfield;\n+          break;\n+        case dtos:\n+          new_code = Bytecodes::_fast_dputfield;\n+          break;\n+        default:\n+          ShouldNotReachHere();\n+          break;\n+        }\n+      } else {\n+        new_code = Bytecodes::_nofast_putfield;\n+      }\n+      break;\n+    }\n+    case Bytecodes::_aload_0:\n+      new_code = Bytecodes::_nofast_aload_0;\n+      break;\n+    case Bytecodes::_iload:\n@@ -532,1 +639,1 @@\n-        *bcs.bcp() = Bytecodes::_nofast_iload;\n+        new_code = Bytecodes::_nofast_iload;\n@@ -535,0 +642,2 @@\n+    default:\n+      break;\n@@ -536,1 +645,5 @@\n-    default: break;\n+    if (opcode != new_code) {\n+      *bcs.bcp() = new_code;\n+      if (lsh.is_enabled()) {\n+        lsh.print_cr(\"%d:%s -> %s\", bcs.bci(), Bytecodes::name(opcode), Bytecodes::name(new_code));\n+      }\n","filename":"src\/hotspot\/share\/cds\/aotMetaspace.cpp","additions":120,"deletions":7,"binary":false,"changes":127,"status":"modified"}]}