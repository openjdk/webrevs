{"files":[{"patch":"@@ -2665,0 +2665,3 @@\n+  \/\/ Vector GHASH (Zvkg) Extension\n+  INSN(vghsh_vv,    0b1110111, 0b010, 0b1, 0b101100);\n+\n","filename":"src\/hotspot\/cpu\/riscv\/assembler_riscv.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -126,1 +126,2 @@\n-          \"Use PR_RISCV_CTX_SW_FENCEI_ON to avoid explicit icache flush\")\n+          \"Use PR_RISCV_CTX_SW_FENCEI_ON to avoid explicit icache flush\")        \\\n+  product(bool, UseZvkg, false, EXPERIMENTAL, \"Use Zvkg instructions\")\n","filename":"src\/hotspot\/cpu\/riscv\/globals_riscv.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2658,2 +2658,1 @@\n-    assert(UseAESIntrinsics, \"Must be\");\n-    assert(UseZvkn, \"need AES instructions (Zvkned extension) support\");\n+    assert(UseAESIntrinsics, \"need AES instructions (Zvkned extension) support\");\n@@ -2748,2 +2747,1 @@\n-    assert(UseAESIntrinsics, \"Must be\");\n-    assert(UseZvkn, \"need AES instructions (Zvkned extension) support\");\n+    assert(UseAESIntrinsics, \"need AES instructions (Zvkned extension) support\");\n@@ -2953,3 +2951,1 @@\n-    assert(UseAESCTRIntrinsics, \"Must be\");\n-    assert(UseZvkn, \"need AES instructions (Zvkned extension) support\");\n-    assert(UseZbb, \"need basic bit manipulation (Zbb extension) support\");\n+    assert(UseAESCTRIntrinsics, \"need AES instructions (Zvkned extension) and Zbb extension support\");\n@@ -3004,0 +3000,57 @@\n+  \/**\n+   *  Arguments:\n+   *\n+   *  Input:\n+   *  c_rarg0   - current state address\n+   *  c_rarg1   - H key address\n+   *  c_rarg2   - data address\n+   *  c_rarg3   - number of blocks\n+   *\n+   *  Output:\n+   *  Updated state at c_rarg0\n+   *\/\n+  address generate_ghash_processBlocks() {\n+    assert(UseGHASHIntrinsics, \"need GHASH instructions (Zvkg extension) and Zvbb support\");\n+\n+    __ align(CodeEntryAlignment);\n+    StubId stub_id = StubId::stubgen_ghash_processBlocks_id;\n+    StubCodeMark mark(this, stub_id);\n+\n+    address start = __ pc();\n+    __ enter();\n+\n+    Register state   = c_rarg0;\n+    Register subkeyH = c_rarg1;\n+    Register data    = c_rarg2;\n+    Register blocks  = c_rarg3;\n+\n+    VectorRegister partial_hash = v1;\n+    VectorRegister hash_subkey  = v2;\n+    VectorRegister cipher_text  = v3;\n+\n+    const unsigned int BLOCK_SIZE = 16;\n+\n+    __ vsetivli(x0, 2, Assembler::e64, Assembler::m1);\n+    __ vle64_v(hash_subkey, subkeyH);\n+    __ vrev8_v(hash_subkey, hash_subkey);\n+    __ vle64_v(partial_hash, state);\n+    __ vrev8_v(partial_hash, partial_hash);\n+\n+    __ vsetivli(x0, 4, Assembler::e32, Assembler::m1);\n+    Label L_ghash_loop;\n+    __ bind(L_ghash_loop);\n+      __ vle32_v(cipher_text, data);\n+      __ addi(data, data, BLOCK_SIZE);\n+      __ vghsh_vv(partial_hash, hash_subkey, cipher_text);\n+      __ subi(blocks, blocks, 1);\n+      __ bnez(blocks, L_ghash_loop);\n+\n+    __ vsetivli(x0, 2, Assembler::e64, Assembler::m1);\n+    __ vrev8_v(partial_hash, partial_hash);\n+    __ vse64_v(partial_hash, state);\n+    __ leave();\n+    __ ret();\n+\n+    return start;\n+  }\n+\n@@ -7230,0 +7283,4 @@\n+    if (UseGHASHIntrinsics) {\n+      StubRoutines::_ghash_processBlocks = generate_ghash_processBlocks();\n+    }\n+\n","filename":"src\/hotspot\/cpu\/riscv\/stubGenerator_riscv.cpp","additions":64,"deletions":7,"binary":false,"changes":71,"status":"modified"},{"patch":"@@ -460,0 +460,16 @@\n+\n+  if (UseZvkg) {\n+    if (FLAG_IS_DEFAULT(UseGHASHIntrinsics) && UseZvbb) {\n+      FLAG_SET_DEFAULT(UseGHASHIntrinsics, true);\n+    }\n+\n+    if (UseGHASHIntrinsics && !UseZvbb) {\n+      warning(\"Cannot enable UseGHASHIntrinsics on cpu without UseZvbb support\");\n+      FLAG_SET_DEFAULT(UseGHASHIntrinsics, false);\n+    }\n+  } else {\n+    if (UseGHASHIntrinsics) {\n+      warning(\"Cannot enable UseGHASHIntrinsics on cpu without UseZvkg support\");\n+      FLAG_SET_DEFAULT(UseGHASHIntrinsics, false);\n+    }\n+  }\n","filename":"src\/hotspot\/cpu\/riscv\/vm_version_riscv.cpp","additions":16,"deletions":0,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -292,0 +292,2 @@\n+  \/* Zvkg crypto extension for ghash and gcm *\/                                                        \\\n+  decl(Zvkg        ,  RV_NO_FLAG_BIT,  true ,  UPDATE_DEFAULT_DEP(UseZvkg, &ext_v, nullptr))           \\\n","filename":"src\/hotspot\/cpu\/riscv\/vm_version_riscv.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -259,0 +259,3 @@\n+  if (is_set(RISCV_HWPROBE_KEY_IMA_EXT_0, RISCV_HWPROBE_EXT_ZVKG)) {\n+    VM_Version::ext_Zvkg.enable_feature();\n+  }\n","filename":"src\/hotspot\/os_cpu\/linux_riscv\/riscv_hwprobe.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"}]}