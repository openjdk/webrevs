{"files":[{"patch":"@@ -29,0 +29,1 @@\n+import static jdk.jpackage.internal.OptionUtils.isRuntimeInstaller;\n@@ -33,0 +34,1 @@\n+import static jdk.jpackage.internal.cli.StandardOption.APP_VERSION;\n@@ -55,0 +57,1 @@\n+import java.util.Arrays;\n@@ -64,0 +67,1 @@\n+import jdk.jpackage.internal.model.Application;\n@@ -213,1 +217,24 @@\n-        final var app = superAppBuilder.create();\n+        var app = superAppBuilder.create();\n+\n+        if (isRuntimeInstaller(options) && !APP_VERSION.containsIn(options)) {\n+            \/\/ User didn't explicitly specify the version on the command line. jpackage derived it from the input.\n+            \/\/ In this case it should ensure the derived value is valid MacOS version.\n+            var ver = normalizeVersion(app.version());\n+            if (!ver.equals(app.version())) {\n+                Log.verbose(I18N.format(\"message.version-normalized\",\n+                        ver, app.version()));\n+            }\n+\n+            app = new Application.Stub(\n+                    app.name(),\n+                    app.description(),\n+                    ver,\n+                    app.vendor(),\n+                    app.copyright(),\n+                    app.srcDir(),\n+                    app.contentDirs(),\n+                    app.imageLayout(),\n+                    app.runtimeBuilder(),\n+                    app.launchers(),\n+                    app.extraAppImageFileData());\n+        }\n@@ -330,0 +357,13 @@\n+\n+    static String normalizeVersion(String version) {\n+        \/\/ macOS requires 1, 2 or 3 components version string.\n+        \/\/ When reading from release file it can be 1 or 3 or maybe more.\n+        \/\/ We always normalize to 3 components.\n+        String[] components = version.split(\"\\\\.\");\n+        if (components.length >= 4) {\n+            components = version.split(\"\\\\.\", 4);\n+            return String.join(\".\", Arrays.copyOf(components, components.length - 1));\n+        }\n+\n+        return version;\n+    }\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/MacFromOptions.java","additions":41,"deletions":1,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -49,0 +49,1 @@\n+import java.util.Arrays;\n@@ -56,0 +57,1 @@\n+import jdk.jpackage.internal.util.RuntimeVersionReader;\n@@ -143,1 +145,0 @@\n-\n@@ -176,0 +177,9 @@\n+            if (!APP_VERSION.containsIn(options)) {\n+                \/\/ Version is not specified explicitly. Try to get it from the release file.\n+                RuntimeVersionReader.readVersion(PREDEFINED_RUNTIME_IMAGE.getFrom(options))\n+                        .ifPresent(version -> {\n+                            appBuilder.version(version);\n+                            Log.verbose(I18N.format(\"message.release-version\",\n+                                    version, PREDEFINED_RUNTIME_IMAGE.getFrom(options)));\n+                        });\n+            }\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/FromOptions.java","additions":12,"deletions":2,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -55,0 +55,2 @@\n+message.release-version=Using version \"{0}\" from \"release\" file located under \"{1}\" as a package version\n+message.version-normalized=Using version \"{0}\" normalized to platform supported format from \"{1}\"\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/resources\/MainResources.properties","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,84 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package jdk.jpackage.internal.util;\n+\n+import java.io.IOException;\n+import java.io.Reader;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import java.util.Properties;\n+\n+import jdk.jpackage.internal.Log;\n+import jdk.internal.util.OperatingSystem;\n+\n+public final class RuntimeVersionReader {\n+\n+    public static Optional<String> readVersion(Path runtimeImage) {\n+        Optional<Path> releasePath = getRuntimeReleaseFile(runtimeImage);\n+        Optional<String> releaseVersion = Optional.empty();\n+\n+        if (releasePath.isPresent()) {\n+            try (Reader reader = Files.newBufferedReader(releasePath.get())) {\n+                Properties props = new Properties();\n+                props.load(reader);\n+                String version = props.getProperty(\"JAVA_VERSION\");\n+                if (version != null) {\n+                    version = version.replaceAll(\"^\\\"|\\\"$\", \"\");\n+                }\n+                releaseVersion = Optional.ofNullable(version);\n+            } catch (IOException ex) {\n+                Log.verbose(ex);\n+            }\n+        };\n+\n+        return releaseVersion;\n+    }\n+\n+    private static Optional<Path> checkReleaseFilePath(Path releaseFilePath) {\n+        if (Files.isRegularFile(releaseFilePath)) {\n+            return Optional.of(releaseFilePath);\n+        } else {\n+            return Optional.empty();\n+        }\n+    }\n+\n+    private static Optional<Path> getRuntimeReleaseFile(Path runtimeImage) {\n+        Optional<Path> releasePath = Optional.empty();\n+\n+        \/\/ Try special case for macOS first (\"Contents\/Home\/release\").\n+        if (OperatingSystem.isMacOS()) {\n+            releasePath = checkReleaseFilePath(runtimeImage.resolve(\"Contents\/Home\/release\"));\n+        }\n+\n+        \/\/ Try root for all platforms including macOS if releasePath is not set\n+        if (releasePath.isEmpty()) {\n+            releasePath = checkReleaseFilePath(runtimeImage.resolve(\"release\"));\n+        }\n+\n+        return releasePath;\n+    }\n+}\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/util\/RuntimeVersionReader.java","additions":84,"deletions":0,"binary":false,"changes":84,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,0 +29,1 @@\n+import static jdk.jpackage.internal.OptionUtils.isRuntimeInstaller;\n@@ -30,0 +31,1 @@\n+import static jdk.jpackage.internal.cli.StandardOption.APP_VERSION;\n@@ -44,0 +46,2 @@\n+import java.util.Arrays;\n+\n@@ -45,0 +49,1 @@\n+import jdk.jpackage.internal.model.Application;\n@@ -76,1 +81,26 @@\n-        return WinApplication.create(appBuilder.create());\n+        var app = appBuilder.create();\n+\n+        if (isRuntimeInstaller(options) && !APP_VERSION.containsIn(options)) {\n+            \/\/ User didn't explicitly specify the version on the command line. jpackage derived it from the input.\n+            \/\/ In this case it should ensure the derived value is valid Windows version.\n+            var ver = normalizeVersion(app.version());\n+            if (!ver.equals(app.version())) {\n+                Log.verbose(I18N.format(\"message.version-normalized\",\n+                        ver, app.version()));\n+            }\n+\n+            app = new Application.Stub(\n+                    app.name(),\n+                    app.description(),\n+                    ver,\n+                    app.vendor(),\n+                    app.copyright(),\n+                    app.srcDir(),\n+                    app.contentDirs(),\n+                    app.imageLayout(),\n+                    app.runtimeBuilder(),\n+                    app.launchers(),\n+                    app.extraAppImageFileData());\n+        }\n+\n+        return WinApplication.create(app);\n@@ -115,0 +145,17 @@\n+\n+    static String normalizeVersion(String version) {\n+        \/\/ Windows requires 2 or 4 components version string.\n+        \/\/ When reading from release file it can be 1 or 3 or maybe more.\n+        \/\/ We always normalize to 4 components.\n+        String[] components = version.split(\"\\\\.\");\n+        if (components.length == 1) {\n+            return version.concat(\".0.0.0\");\n+        } else if (components.length == 3) {\n+            return version.concat(\".0\");\n+        } else if (components.length >= 5) {\n+            components = version.split(\"\\\\.\", 5);\n+            return String.join(\".\", Arrays.copyOf(components, components.length - 1));\n+        }\n+\n+        return version;\n+    }\n","filename":"src\/jdk.jpackage\/windows\/classes\/jdk\/jpackage\/internal\/WinFromOptions.java","additions":49,"deletions":2,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+import java.io.Writer;\n@@ -53,0 +54,1 @@\n+import java.util.Properties;\n@@ -64,0 +66,1 @@\n+import jdk.jpackage.internal.util.RuntimeVersionReader;\n@@ -248,0 +251,19 @@\n+         if (isRuntime()) {\n+            String appVersion = getArgumentValue(\"--app-version\");\n+            if (appVersion != null) {\n+                return appVersion;\n+            } else {\n+                Optional<String> releaseVersion = RuntimeVersionReader\n+                        .readVersion(Path.of(getArgumentValue(\"--runtime-image\")));\n+                if (releaseVersion.isPresent()) {\n+                    if (TKit.isWindows()) {\n+                        return WindowsHelper.getNormalizedVersion(this, releaseVersion.get());\n+                    } else if (TKit.isOSX()) {\n+                        return MacHelper.getNormalizedVersion(this, releaseVersion.get());\n+                    }\n+\n+                    return releaseVersion.get();\n+                }\n+            }\n+        }\n+\n@@ -296,0 +318,4 @@\n+        return setFakeRuntime(Optional.empty());\n+    }\n+\n+    public JPackageCommand setFakeRuntime(Optional<String> version) {\n@@ -324,0 +350,13 @@\n+            \/\/ Create release file with version if provided\n+            version.ifPresent(ver -> {\n+                Properties props = new Properties();\n+                props.setProperty(\"JAVA_VERSION\", ver);\n+                try (Writer writer = Files.newBufferedWriter(fakeRuntimeDir.resolve(\"release\"))) {\n+                    props.store(writer, null);\n+                } catch (IOException ex) {\n+                    TKit.trace(String.format(\n+                            \"Failed to create [%s] file: %s\",\n+                            fakeRuntimeDir.resolve(\"release\"), ex));\n+                    }\n+            });\n+\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/JPackageCommand.java","additions":39,"deletions":0,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -764,0 +764,13 @@\n+    static String getNormalizedVersion(JPackageCommand cmd, String version) {\n+        cmd.verifyIsOfType(PackageType.MAC);\n+        \/\/ macOS requires 1, 2 or 3 components version string.\n+        \/\/ We always normalize to 3 components.\n+        String[] components = version.split(\"\\\\.\");\n+        if (components.length >= 4) {\n+            components = version.split(\"\\\\.\", 4);\n+            return String.join(\".\", Arrays.copyOf(components, components.length - 1));\n+        }\n+\n+        return version;\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/MacHelper.java","additions":13,"deletions":0,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+import java.util.Arrays;\n@@ -57,0 +58,17 @@\n+    static String getNormalizedVersion(JPackageCommand cmd, String version) {\n+        cmd.verifyIsOfType(PackageType.WINDOWS);\n+        \/\/ Windows requires 2 or 4 components version string.\n+        \/\/ We always normalize to 4 components.\n+        String[] components = version.split(\"\\\\.\");\n+        if (components.length == 1) {\n+            return version.concat(\".0.0.0\");\n+        } else if (components.length == 3) {\n+            return version.concat(\".0\");\n+        } else if (components.length >= 5) {\n+            components = version.split(\"\\\\.\", 5);\n+            return String.join(\".\", Arrays.copyOf(components, components.length - 1));\n+        }\n+\n+        return version;\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/WindowsHelper.java","additions":18,"deletions":0,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,1 +28,0 @@\n-\n@@ -32,0 +31,1 @@\n+import java.util.Optional;\n@@ -113,0 +113,13 @@\n+    @Test\n+    @Parameter(\"27\")\n+    @Parameter(\"27.1\")\n+    @Parameter(\"27.1.2\")\n+    @Parameter(\"27.1.2.3\")\n+    @Parameter(\"27.1.2.3.4\")\n+    public static void testReleaseFileVersion(String version) {\n+        init()\n+        .addInitializer(cmd -> cmd.setFakeRuntime(Optional.of(version)))\n+        \/\/ Just create package. It is enough to verify version in bundle name.\n+        .run(Action.CREATE);\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/share\/RuntimePackageTest.java","additions":15,"deletions":2,"binary":false,"changes":17,"status":"modified"}]}