{"files":[{"patch":"@@ -56,0 +56,1 @@\n+import java.math.BigInteger;\n@@ -61,0 +62,1 @@\n+import java.util.function.UnaryOperator;\n@@ -68,0 +70,1 @@\n+import jdk.jpackage.internal.model.DottedVersion;\n@@ -222,18 +225,4 @@\n-            var ver = normalizeVersion(app.version());\n-            if (!ver.equals(app.version())) {\n-                Log.verbose(I18N.format(\"message.version-normalized\",\n-                        ver, app.version()));\n-            }\n-\n-            app = new Application.Stub(\n-                    app.name(),\n-                    app.description(),\n-                    ver,\n-                    app.vendor(),\n-                    app.copyright(),\n-                    app.srcDir(),\n-                    app.contentDirs(),\n-                    app.imageLayout(),\n-                    app.runtimeBuilder(),\n-                    app.launchers(),\n-                    app.extraAppImageFileData());\n+            UnaryOperator<String> versionNormalizer = version -> {\n+                return normalizeVersion(version);\n+            };\n+            app = ApplicationBuilder.normalizeVersion(app, app.version(), versionNormalizer);\n@@ -362,1 +351,2 @@\n-        String[] components = version.split(\"\\\\.\");\n+        DottedVersion ver = DottedVersion.greedy(version);\n+        BigInteger[] components = ver.getComponents();\n@@ -364,2 +354,1 @@\n-            components = version.split(\"\\\\.\", 4);\n-            return String.join(\".\", Arrays.copyOf(components, components.length - 1));\n+            return ver.toComponentsStringWithPadding(3);\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/MacFromOptions.java","additions":10,"deletions":21,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,0 +38,1 @@\n+import java.util.function.UnaryOperator;\n@@ -230,0 +231,22 @@\n+    static Application normalizeVersion(Application app, String version,\n+            UnaryOperator<String> versionNormalizer) {\n+        final var ver = versionNormalizer.apply(version);\n+        if (!ver.equals(app.version())) {\n+            Log.verbose(I18N.format(\"message.version-normalized\",\n+                    ver, app.version()));\n+        }\n+\n+        return new Application.Stub(\n+                app.name(),\n+                app.description(),\n+                ver,\n+                app.vendor(),\n+                app.copyright(),\n+                app.srcDir(),\n+                app.contentDirs(),\n+                app.imageLayout(),\n+                app.runtimeBuilder(),\n+                app.launchers(),\n+                app.extraAppImageFileData());\n+    }\n+\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/ApplicationBuilder.java","additions":24,"deletions":1,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -48,0 +48,2 @@\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n@@ -57,0 +59,1 @@\n+import jdk.jpackage.internal.util.RuntimeImageUtils;\n@@ -179,6 +182,12 @@\n-                RuntimeVersionReader.readVersion(PREDEFINED_RUNTIME_IMAGE.getFrom(options))\n-                        .ifPresent(version -> {\n-                            appBuilder.version(version);\n-                            Log.verbose(I18N.format(\"message.release-version\",\n-                                    version, PREDEFINED_RUNTIME_IMAGE.getFrom(options)));\n-                        });\n+                final Path releaseFile = RuntimeImageUtils.getReleaseFilePath(\n+                        PREDEFINED_RUNTIME_IMAGE.getFrom(options));\n+                try {\n+                    RuntimeVersionReader.readVersion(releaseFile)\n+                            .ifPresent(version -> {\n+                                appBuilder.version(version);\n+                                Log.verbose(I18N.format(\"message.release-version\",\n+                                        version, PREDEFINED_RUNTIME_IMAGE.getFrom(options)));\n+                            });\n+                } catch (IOException ex) {\n+                    throw new UncheckedIOException(ex);\n+                }\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/FromOptions.java","additions":15,"deletions":6,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,1 +38,1 @@\n-import jdk.internal.util.OperatingSystem;\n+import jdk.jpackage.internal.util.RuntimeImageUtils;\n@@ -64,12 +64,1 @@\n-        final Path releaseFile;\n-        if (!OperatingSystem.isMacOS()) {\n-            releaseFile = cookedRuntime.resolve(\"release\");\n-        } else {\n-            \/\/ On Mac `cookedRuntime` can be runtime root or runtime home.\n-            Path runtimeHome = cookedRuntime.resolve(\"Contents\/Home\");\n-            if (!Files.isDirectory(runtimeHome)) {\n-                runtimeHome = cookedRuntime;\n-            }\n-            releaseFile = runtimeHome.resolve(\"release\");\n-        }\n-\n+        final Path releaseFile = RuntimeImageUtils.getReleaseFilePath(cookedRuntime);\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/ModuleInfo.java","additions":3,"deletions":14,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -227,0 +227,10 @@\n+    public String toComponentsStringWithPadding(int numberOfComponents) {\n+        if (components.length >= numberOfComponents) {\n+            return Stream.of(components).map(BigInteger::toString)\n+                    .limit(numberOfComponents).collect(Collectors.joining(\".\"));\n+        } else {\n+            return toComponentsString()\n+                    .concat(\".0\".repeat(numberOfComponents - components.length));\n+        }\n+    }\n+\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/DottedVersion.java","additions":11,"deletions":1,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -0,0 +1,49 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package jdk.jpackage.internal.util;\n+\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import jdk.internal.util.OperatingSystem;\n+\n+public final class RuntimeImageUtils {\n+\n+    public static Path getReleaseFilePath(Path runtimePath) {\n+        final Path releaseFile;\n+        if (!OperatingSystem.isMacOS()) {\n+            releaseFile = runtimePath.resolve(\"release\");\n+        } else {\n+            \/\/ On Mac `runtimePath` can be runtime root or runtime home.\n+            Path runtimeHome = runtimePath.resolve(\"Contents\/Home\");\n+            if (!Files.isDirectory(runtimeHome)) {\n+                runtimeHome = runtimePath;\n+            }\n+            releaseFile = runtimeHome.resolve(\"release\");\n+        }\n+\n+        return releaseFile;\n+    }\n+}\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/util\/RuntimeImageUtils.java","additions":49,"deletions":0,"binary":false,"changes":49,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -35,3 +35,0 @@\n-import jdk.jpackage.internal.Log;\n-import jdk.internal.util.OperatingSystem;\n-\n@@ -40,25 +37,2 @@\n-    public static Optional<String> readVersion(Path runtimeImage) {\n-        Optional<Path> releasePath = getRuntimeReleaseFile(runtimeImage);\n-        Optional<String> releaseVersion = Optional.empty();\n-\n-        if (releasePath.isPresent()) {\n-            try (Reader reader = Files.newBufferedReader(releasePath.get())) {\n-                Properties props = new Properties();\n-                props.load(reader);\n-                String version = props.getProperty(\"JAVA_VERSION\");\n-                if (version != null) {\n-                    version = version.replaceAll(\"^\\\"|\\\"$\", \"\");\n-                }\n-                releaseVersion = Optional.ofNullable(version);\n-            } catch (IOException ex) {\n-                Log.verbose(ex);\n-            }\n-        };\n-\n-        return releaseVersion;\n-    }\n-\n-    private static Optional<Path> checkReleaseFilePath(Path releaseFilePath) {\n-        if (Files.isRegularFile(releaseFilePath)) {\n-            return Optional.of(releaseFilePath);\n-        } else {\n+    public static Optional<String> readVersion(Path releaseFilePath) throws IOException {\n+        if (!Files.isRegularFile(releaseFilePath)) {\n@@ -67,9 +41,0 @@\n-    }\n-\n-    private static Optional<Path> getRuntimeReleaseFile(Path runtimeImage) {\n-        Optional<Path> releasePath = Optional.empty();\n-\n-        \/\/ Try special case for macOS first (\"Contents\/Home\/release\").\n-        if (OperatingSystem.isMacOS()) {\n-            releasePath = checkReleaseFilePath(runtimeImage.resolve(\"Contents\/Home\/release\"));\n-        }\n@@ -77,3 +42,8 @@\n-        \/\/ Try root for all platforms including macOS if releasePath is not set\n-        if (releasePath.isEmpty()) {\n-            releasePath = checkReleaseFilePath(runtimeImage.resolve(\"release\"));\n+        try (Reader reader = Files.newBufferedReader(releaseFilePath)) {\n+            Properties props = new Properties();\n+            props.load(reader);\n+            String version = props.getProperty(\"JAVA_VERSION\");\n+            if (version != null) {\n+                version = version.replaceAll(\"^\\\"|\\\"$\", \"\");\n+            }\n+            return Optional.ofNullable(version);\n@@ -81,2 +51,0 @@\n-\n-        return releasePath;\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/util\/RuntimeVersionReader.java","additions":11,"deletions":43,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -46,0 +46,1 @@\n+import java.math.BigInteger;\n@@ -47,0 +48,1 @@\n+import java.util.function.UnaryOperator;\n@@ -50,0 +52,1 @@\n+import jdk.jpackage.internal.model.DottedVersion;\n@@ -86,18 +89,4 @@\n-            var ver = normalizeVersion(app.version());\n-            if (!ver.equals(app.version())) {\n-                Log.verbose(I18N.format(\"message.version-normalized\",\n-                        ver, app.version()));\n-            }\n-\n-            app = new Application.Stub(\n-                    app.name(),\n-                    app.description(),\n-                    ver,\n-                    app.vendor(),\n-                    app.copyright(),\n-                    app.srcDir(),\n-                    app.contentDirs(),\n-                    app.imageLayout(),\n-                    app.runtimeBuilder(),\n-                    app.launchers(),\n-                    app.extraAppImageFileData());\n+            UnaryOperator<String> versionNormalizer = version -> {\n+                return normalizeVersion(version);\n+            };\n+            app = ApplicationBuilder.normalizeVersion(app, app.version(), versionNormalizer);\n@@ -150,8 +139,5 @@\n-        String[] components = version.split(\"\\\\.\");\n-        if (components.length == 1) {\n-            return version.concat(\".0.0.0\");\n-        } else if (components.length == 3) {\n-            return version.concat(\".0\");\n-        } else if (components.length >= 5) {\n-            components = version.split(\"\\\\.\", 5);\n-            return String.join(\".\", Arrays.copyOf(components, components.length - 1));\n+        DottedVersion ver = DottedVersion.greedy(version);\n+        BigInteger[] components = ver.getComponents();\n+        if (components.length == 1 || components.length == 3 ||\n+                components.length >= 5) {\n+            return ver.toComponentsStringWithPadding(4);\n","filename":"src\/jdk.jpackage\/windows\/classes\/jdk\/jpackage\/internal\/WinFromOptions.java","additions":12,"deletions":26,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -66,0 +66,1 @@\n+import jdk.jpackage.internal.util.RuntimeImageUtils;\n@@ -251,15 +252,16 @@\n-         if (isRuntime()) {\n-            String appVersion = getArgumentValue(\"--app-version\");\n-            if (appVersion != null) {\n-                return appVersion;\n-            } else {\n-                Optional<String> releaseVersion = RuntimeVersionReader\n-                        .readVersion(Path.of(getArgumentValue(\"--runtime-image\")));\n-                if (releaseVersion.isPresent()) {\n-                    if (TKit.isWindows()) {\n-                        return WindowsHelper.getNormalizedVersion(this, releaseVersion.get());\n-                    } else if (TKit.isOSX()) {\n-                        return MacHelper.getNormalizedVersion(this, releaseVersion.get());\n-                    }\n-\n-                    return releaseVersion.get();\n+        return Optional.ofNullable(getArgumentValue(\"--app-version\")).or(() -> {\n+            if (isRuntime()) {\n+                final Path releaseFile = RuntimeImageUtils.getReleaseFilePath(\n+                        Path.of(getArgumentValue(\"--runtime-image\")));\n+                try {\n+                    return RuntimeVersionReader.readVersion(releaseFile).map(releaseVersion -> {\n+                        if (TKit.isWindows()) {\n+                            return WindowsHelper.getNormalizedVersion(releaseVersion);\n+                        } else if (TKit.isOSX()) {\n+                            return MacHelper.getNormalizedVersion(releaseVersion);\n+                        } else {\n+                            return releaseVersion;\n+                        }\n+                    });\n+                } catch (IOException ex) {\n+                    throw new UncheckedIOException(ex);\n@@ -267,0 +269,2 @@\n+            } else {\n+                return Optional.empty();\n@@ -268,3 +272,1 @@\n-        }\n-\n-        return getArgumentValue(\"--app-version\", () -> \"1.0\");\n+        }).orElse(\"1.0\");\n@@ -318,4 +320,0 @@\n-        return setFakeRuntime(Optional.empty());\n-    }\n-\n-    public JPackageCommand setFakeRuntime(Optional<String> version) {\n@@ -350,13 +348,0 @@\n-            \/\/ Create release file with version if provided\n-            version.ifPresent(ver -> {\n-                Properties props = new Properties();\n-                props.setProperty(\"JAVA_VERSION\", ver);\n-                try (Writer writer = Files.newBufferedWriter(fakeRuntimeDir.resolve(\"release\"))) {\n-                    props.store(writer, null);\n-                } catch (IOException ex) {\n-                    TKit.trace(String.format(\n-                            \"Failed to create [%s] file: %s\",\n-                            fakeRuntimeDir.resolve(\"release\"), ex));\n-                    }\n-            });\n-\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/JPackageCommand.java","additions":20,"deletions":35,"binary":false,"changes":55,"status":"modified"},{"patch":"@@ -45,0 +45,1 @@\n+import java.math.BigInteger;\n@@ -75,0 +76,1 @@\n+import jdk.jpackage.internal.model.DottedVersion;\n@@ -764,2 +766,1 @@\n-    static String getNormalizedVersion(JPackageCommand cmd, String version) {\n-        cmd.verifyIsOfType(PackageType.MAC);\n+    static String getNormalizedVersion(String version) {\n@@ -768,1 +769,2 @@\n-        String[] components = version.split(\"\\\\.\");\n+        DottedVersion ver = DottedVersion.greedy(version);\n+        BigInteger[] components = ver.getComponents();\n@@ -770,2 +772,1 @@\n-            components = version.split(\"\\\\.\", 4);\n-            return String.join(\".\", Arrays.copyOf(components, components.length - 1));\n+            return ver.toComponentsStringWithPadding(3);\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/MacHelper.java","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import java.math.BigInteger;\n@@ -47,0 +48,1 @@\n+import jdk.jpackage.internal.model.DottedVersion;\n@@ -58,2 +60,1 @@\n-    static String getNormalizedVersion(JPackageCommand cmd, String version) {\n-        cmd.verifyIsOfType(PackageType.WINDOWS);\n+    static String getNormalizedVersion(String version) {\n@@ -62,8 +63,5 @@\n-        String[] components = version.split(\"\\\\.\");\n-        if (components.length == 1) {\n-            return version.concat(\".0.0.0\");\n-        } else if (components.length == 3) {\n-            return version.concat(\".0\");\n-        } else if (components.length >= 5) {\n-            components = version.split(\"\\\\.\", 5);\n-            return String.join(\".\", Arrays.copyOf(components, components.length - 1));\n+        DottedVersion ver = DottedVersion.greedy(version);\n+        BigInteger[] components = ver.getComponents();\n+        if (components.length == 1 || components.length == 3 ||\n+                components.length >= 5) {\n+            return ver.toComponentsStringWithPadding(4);\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/WindowsHelper.java","additions":8,"deletions":10,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -44,1 +44,1 @@\n-            int expectedComponentCount, String expectedToComponent) {\n+            int expectedComponentCount, String expectedToComponent, int numberOfComponents) {\n@@ -47,1 +47,1 @@\n-            this(input, type.createVersion, \"\", expectedComponentCount, expectedToComponent);\n+            this(input, type.createVersion, \"\", expectedComponentCount, expectedToComponent, -1);\n@@ -51,1 +51,5 @@\n-            this(input, type.createVersion, \"\", expectedComponentCount, input);\n+            this(input, type.createVersion, \"\", expectedComponentCount, input, -1);\n+        }\n+\n+        TestConfig(String input, Type type, String expectedToComponent, int numberOfComponents) {\n+            this(input, type.createVersion, \"\", -1, expectedToComponent, numberOfComponents);\n@@ -55,1 +59,1 @@\n-            return new TestConfig(input, Type.GREEDY.createVersion, \"\", expectedComponentCount, expectedToComponent);\n+            return new TestConfig(input, Type.GREEDY.createVersion, \"\", expectedComponentCount, expectedToComponent, -1);\n@@ -59,1 +63,1 @@\n-            return new TestConfig(input, Type.GREEDY.createVersion, \"\", expectedComponentCount, input);\n+            return new TestConfig(input, Type.GREEDY.createVersion, \"\", expectedComponentCount, input, -1);\n@@ -63,1 +67,1 @@\n-            return new TestConfig(input, Type.LAZY.createVersion, expectedSuffix, expectedComponentCount, expectedToComponent);\n+            return new TestConfig(input, Type.LAZY.createVersion, expectedSuffix, expectedComponentCount, expectedToComponent, -1);\n@@ -117,0 +121,23 @@\n+    @ParameterizedTest\n+    @MethodSource\n+    public void testComponentsStringWithPadding(TestConfig cfg) {\n+        var dv = cfg.createVersion.apply(cfg.input());\n+        assertEquals(cfg.expectedToComponent(),\n+                dv.toComponentsStringWithPadding(cfg.numberOfComponents()));\n+    }\n+\n+    private static List<TestConfig> testComponentsStringWithPadding() {\n+        List<TestConfig> data = new ArrayList<>();\n+        for (var type : Type.values()) {\n+            data.addAll(List.of(\n+                    new TestConfig(\"1\", type, \"1.0.0.0\", 4),\n+                    new TestConfig(\"1.2\", type, \"1.2.0.0\", 4),\n+                    new TestConfig(\"1.2.3\", type, \"1.2.3.0\", 4),\n+                    new TestConfig(\"1.2.3.4\", type, \"1.2.3.4\", 4),\n+                    new TestConfig(\"1.2.3.4.5\", type, \"1.2.3.4\", 4)\n+            ));\n+        }\n+\n+        return data;\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/model\/DottedVersionTest.java","additions":34,"deletions":7,"binary":false,"changes":41,"status":"modified"},{"patch":"@@ -0,0 +1,94 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package jdk.jpackage.internal.util;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.io.Writer;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Optional;\n+import java.util.Properties;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+public class RuntimeVersionReaderTest {\n+\n+    @Test\n+    public void test_release_file_with_version(@TempDir Path workdir) {\n+        final Optional<String> version;\n+        try {\n+            version = RuntimeVersionReader.readVersion(\n+                    createPropFileWithValue(workdir, \"JAVA_VERSION\", \"27.1.2\"));\n+        } catch (IOException ex) {\n+            throw new UncheckedIOException(ex);\n+        }\n+        assertTrue(version.isPresent());\n+        version.ifPresent(ver -> {\n+            assertEquals(\"27.1.2\", version.get());\n+        });\n+    }\n+\n+    @Test\n+    public void test_release_file_without_version(@TempDir Path workdir) {\n+        final Optional<String> version;\n+        try {\n+            version = RuntimeVersionReader.readVersion(\n+                    createPropFileWithValue(workdir, \"JDK_VERSION\", \"27.1.2\"));\n+        } catch (IOException ex) {\n+            throw new UncheckedIOException(ex);\n+        }\n+        assertFalse(version.isPresent());\n+    }\n+\n+    @Test\n+    public void test_release_file_invalid_input(@TempDir Path workdir) {\n+        final Optional<String> version;\n+        try {\n+            version = RuntimeVersionReader.readVersion(workdir);\n+        } catch (IOException ex) {\n+            throw new UncheckedIOException(ex);\n+        }\n+        assertFalse(version.isPresent());\n+    }\n+\n+    private Path createPropFileWithValue(Path workdir, String name, String value)\n+            throws IOException {\n+        Path releaseFile = workdir.resolve(\"release\");\n+        Properties props = new Properties();\n+        props.setProperty(name, \"\\\"\" + value + \"\\\"\");\n+        try (Writer writer = Files.newBufferedWriter(releaseFile)) {\n+            props.store(writer, null);\n+        }\n+\n+        return releaseFile;\n+    }\n+\n+\n+}\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/util\/RuntimeVersionReaderTest.java","additions":94,"deletions":0,"binary":false,"changes":94,"status":"added"},{"patch":"@@ -26,0 +26,1 @@\n+import static jdk.internal.util.OperatingSystem.WINDOWS;\n@@ -28,0 +29,2 @@\n+import java.io.IOException;\n+import java.io.Writer;\n@@ -32,0 +35,1 @@\n+import java.util.Properties;\n@@ -37,0 +41,1 @@\n+import jdk.jpackage.test.JPackageStringBundle;\n@@ -82,4 +87,4 @@\n-    @Test\n-    public static void test() {\n-        init().run();\n-    }\n+    \/\/ @Test\n+    \/\/ public static void test() {\n+    \/\/     init().run();\n+    \/\/ }\n@@ -87,4 +92,4 @@\n-    @Test(ifOS = MACOS)\n-    public static void testFromBundle() {\n-        init(MacHelper::createRuntimeBundle).run();\n-    }\n+    \/\/ @Test(ifOS = MACOS)\n+    \/\/ public static void testFromBundle() {\n+    \/\/     init(MacHelper::createRuntimeBundle).run();\n+    \/\/ }\n@@ -101,11 +106,11 @@\n-    @Test\n-    public static void testName() {\n-        \/\/ Test that jpackage can derive package name from the path to runtime image.\n-        init()\n-        .addInitializer(cmd -> cmd.removeArgumentWithValue(\"--name\"))\n-        \/\/ Don't attempt to install this package as it may have an odd name derived from\n-        \/\/ the runtime image path. Say, on Linux for `--runtime-image foo\/bar\/sed`\n-        \/\/ command line jpackage will create a package named 'sed' that will conflict\n-        \/\/ with the default 'sed' package.\n-        .run(Action.CREATE_AND_UNPACK);\n-    }\n+    \/\/ @Test\n+    \/\/ public static void testName() {\n+    \/\/     \/\/ Test that jpackage can derive package name from the path to runtime image.\n+    \/\/     init()\n+    \/\/     .addInitializer(cmd -> cmd.removeArgumentWithValue(\"--name\"))\n+    \/\/     \/\/ Don't attempt to install this package as it may have an odd name derived from\n+    \/\/     \/\/ the runtime image path. Say, on Linux for `--runtime-image foo\/bar\/sed`\n+    \/\/     \/\/ command line jpackage will create a package named 'sed' that will conflict\n+    \/\/     \/\/ with the default 'sed' package.\n+    \/\/     .run(Action.CREATE_AND_UNPACK);\n+    \/\/ }\n@@ -114,8 +119,47 @@\n-    @Parameter(\"27\")\n-    @Parameter(\"27.1\")\n-    @Parameter(\"27.1.2\")\n-    @Parameter(\"27.1.2.3\")\n-    @Parameter(\"27.1.2.3.4\")\n-    public static void testReleaseFileVersion(String version) {\n-        init()\n-        .addInitializer(cmd -> cmd.setFakeRuntime(Optional.of(version)))\n+    \/\/ 27\n+    @Parameter(value = {\"27\", \"\"}, ifOS = {LINUX, MACOS})\n+    @Parameter(value = {\"27\", \"27.0.0.0\"}, ifOS = WINDOWS)\n+    \/\/ 27.1\n+    @Parameter(value = {\"27.1\", \"\"})\n+    \/\/ 27.1.2\n+    @Parameter(value = {\"27.1.2\", \"\"}, ifOS = {LINUX, MACOS})\n+    @Parameter(value = {\"27.1.2\", \"27.1.2.0\"}, ifOS = WINDOWS)\n+    \/\/ 27.1.2.3\n+    @Parameter(value = {\"27.1.2.3\", \"\"}, ifOS = {LINUX, WINDOWS})\n+    @Parameter(value = {\"27.1.2.3\", \"27.1.2\"}, ifOS = MACOS)\n+    \/\/ 27.1.2.3.4\n+    @Parameter(value = {\"27.1.2.3.4\", \"\"}, ifOS = LINUX)\n+    @Parameter(value = {\"27.1.2.3.4\", \"27.1.2\"}, ifOS = MACOS)\n+    @Parameter(value = {\"27.1.2.3.4\", \"27.1.2.3\"}, ifOS = WINDOWS)\n+    public static void testReleaseFileVersion(String version, String normalizedVersion) {\n+        new PackageTest()\n+        .addInitializer(cmd -> {\n+            \/\/ Remove --input parameter from jpackage command line as we don't\n+            \/\/ create input directory in the test and jpackage fails\n+            \/\/ if --input references non existant directory.\n+            cmd.removeArgumentWithValue(\"--input\");\n+\n+            cmd.setFakeRuntime();\n+\n+            \/\/ Execute prerequisite actions, so fake runtime gets created\n+            cmd.executePrerequisiteActions();\n+\n+            \/\/ Create release file with version in fake runtime\n+            Path runtimeImage = Path.of(cmd.getArgumentValue(\"--runtime-image\"));\n+            Path releaseFile = runtimeImage.resolve(\"release\");\n+            Properties props = new Properties();\n+            props.setProperty(\"JAVA_VERSION\", \"\\\"\" + version + \"\\\"\");\n+            try (Writer writer = Files.newBufferedWriter(releaseFile)) {\n+                props.store(writer, null);\n+            }\n+\n+            \/\/ Validate output\n+            cmd.validateOutput(JPackageStringBundle.MAIN\n+                    .cannedFormattedString(\"message.release-version\",\n+                    version, runtimeImage.toString()));\n+            if (!normalizedVersion.isEmpty()) {\n+                cmd.validateOutput(JPackageStringBundle.MAIN\n+                    .cannedFormattedString(\"message.version-normalized\",\n+                    normalizedVersion, version));\n+            }\n+        })\n","filename":"test\/jdk\/tools\/jpackage\/share\/RuntimePackageTest.java","additions":71,"deletions":27,"binary":false,"changes":98,"status":"modified"}]}