{"files":[{"patch":"@@ -86,1 +86,0 @@\n-        return \"\";\n@@ -92,1 +91,1 @@\n-  size_t _min_size;\n+  size_t const _min_size;\n@@ -95,1 +94,1 @@\n-  size_t _requested_size;\n+  size_t const _requested_size;\n@@ -107,1 +106,1 @@\n-  Type _alloc_type;\n+  Type const _alloc_type;\n@@ -212,0 +211,4 @@\n+  inline bool is_cds() const {\n+    return _alloc_type == _alloc_cds;\n+  }\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocRequest.hpp","additions":7,"deletions":4,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -1372,1 +1372,1 @@\n-    size_t min_size = (req.type() == ShenandoahAllocRequest::_alloc_tlab) ? req.min_size() : req.size();\n+    size_t min_size = req.is_lab_alloc() ? req.min_size() : req.size();\n@@ -1504,1 +1504,1 @@\n-                        r->index(), ShenandoahAllocRequest::alloc_type_to_string(req.type()), p2i(&req));\n+                        r->index(), req.type_string(), p2i(&req));\n@@ -1523,1 +1523,1 @@\n-                        r->index(), ShenandoahAllocRequest::alloc_type_to_string(req.type()), p2i(&req));\n+                        r->index(), req.type_string(), p2i(&req));\n@@ -1537,2 +1537,2 @@\n-    if (req.type() == ShenandoahAllocRequest::_alloc_plab) {\n-      \/\/ This is a PLAB allocation\n+    if (req.is_old()) {\n+      \/\/ This is a PLAB allocation(lab alloc in old gen)\n@@ -1599,2 +1599,0 @@\n-        assert(req.type() != ShenandoahAllocRequest::_alloc_gclab, \"old-gen allocations use PLAB or shared allocation\");\n-        \/\/ for plabs, we'll sort the difference between evac and promotion usage when we retire the plab\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahFreeSet.cpp","additions":5,"deletions":7,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -988,1 +988,1 @@\n-            ShenandoahAllocRequest::alloc_type_to_string(req.type()), requested, actual);\n+            req.type_string(), requested, actual);\n@@ -1017,2 +1017,3 @@\n-    old_generation()->configure_plab_for_current_thread(req);\n-    if (!req.is_lab_alloc()) {\n+    if (req.is_lab_alloc()) {\n+      old_generation()->configure_plab_for_current_thread(req);\n+    } else {\n@@ -1038,0 +1039,7 @@\n+\n+      if (req.is_promotion()) {\n+        \/\/ Shared promotion.\n+        const size_t actual_size = req.actual_size() * HeapWordSize;\n+        log_debug(gc, plab)(\"Expend shared promotion of %zu bytes\", actual_size);\n+        old_generation()->expend_promoted(actual_size);\n+      }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.cpp","additions":11,"deletions":3,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -450,1 +450,1 @@\n-  inline void adjust_alloc_metadata(ShenandoahAllocRequest::Type type, size_t);\n+  inline void adjust_alloc_metadata(const ShenandoahAllocRequest &req, size_t);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -74,1 +74,1 @@\n-    adjust_alloc_metadata(req.type(), size);\n+    adjust_alloc_metadata(req, size);\n@@ -114,1 +114,1 @@\n-    adjust_alloc_metadata(req.type(), size);\n+    adjust_alloc_metadata(req, size);\n@@ -128,10 +128,4 @@\n-inline void ShenandoahHeapRegion::adjust_alloc_metadata(ShenandoahAllocRequest::Type type, size_t size) {\n-  switch (type) {\n-    case ShenandoahAllocRequest::_alloc_shared:\n-    case ShenandoahAllocRequest::_alloc_shared_gc:\n-    case ShenandoahAllocRequest::_alloc_shared_gc_old:\n-    case ShenandoahAllocRequest::_alloc_shared_gc_promotion:\n-    case ShenandoahAllocRequest::_alloc_cds:\n-      \/\/ Counted implicitly by tlab\/gclab allocs\n-      break;\n-    case ShenandoahAllocRequest::_alloc_tlab:\n+inline void ShenandoahHeapRegion::adjust_alloc_metadata(const ShenandoahAllocRequest &req, size_t size) {\n+  \/\/ Only need to update alloc metadata for lab alloc, shared alloc is counted implicitly by tlab\/gclab allocs\n+  if (req.is_lab_alloc()) {\n+    if (req.is_mutator_alloc()) {\n@@ -139,5 +133,1 @@\n-      break;\n-    case ShenandoahAllocRequest::_alloc_gclab:\n-      _gclab_allocs += size;\n-      break;\n-    case ShenandoahAllocRequest::_alloc_plab:\n+    } else if (req.is_old()) {\n@@ -145,3 +135,3 @@\n-      break;\n-    default:\n-      ShouldNotReachHere();\n+    } else {\n+      _gclab_allocs += size;\n+    }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.inline.hpp","additions":10,"deletions":20,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -171,1 +171,1 @@\n-  assert(req.type() != ShenandoahAllocRequest::_alloc_gclab, \"GCLAB pertains only to young-gen memory\");\n+  assert(req.is_old(), \"Must be old allocation request\");\n@@ -183,1 +183,1 @@\n-  if (req.type() == ShenandoahAllocRequest::_alloc_plab) {\n+  if (req.is_lab_alloc()) {\n@@ -199,30 +199,23 @@\n-  if (req.is_gc_alloc()) {\n-    const size_t actual_size = req.actual_size() * HeapWordSize;\n-    if (req.type() ==  ShenandoahAllocRequest::_alloc_plab) {\n-      \/\/ We've created a new plab. Now we configure it whether it will be used for promotions\n-      \/\/ and evacuations - or just evacuations.\n-      Thread* thread = Thread::current();\n-      ShenandoahThreadLocalData::reset_plab_promoted(thread);\n-\n-      \/\/ The actual size of the allocation may be larger than the requested bytes (due to alignment on card boundaries).\n-      \/\/ If this puts us over our promotion budget, we need to disable future PLAB promotions for this thread.\n-      if (can_promote(actual_size)) {\n-        \/\/ Assume the entirety of this PLAB will be used for promotion.  This prevents promotion from overreach.\n-        \/\/ When we retire this plab, we'll unexpend what we don't really use.\n-        log_debug(gc, plab)(\"Thread can promote using PLAB of %zu bytes. Expended: %zu, available: %zu\",\n-                            actual_size, get_promoted_expended(), get_promoted_reserve());\n-        expend_promoted(actual_size);\n-        ShenandoahThreadLocalData::enable_plab_promotions(thread);\n-        ShenandoahThreadLocalData::set_plab_actual_size(thread, actual_size);\n-      } else {\n-        \/\/ Disable promotions in this thread because entirety of this PLAB must be available to hold old-gen evacuations.\n-        ShenandoahThreadLocalData::disable_plab_promotions(thread);\n-        ShenandoahThreadLocalData::set_plab_actual_size(thread, 0);\n-        log_debug(gc, plab)(\"Thread cannot promote using PLAB of %zu bytes. Expended: %zu, available: %zu, mixed evacuations? %s\",\n-                            actual_size, get_promoted_expended(), get_promoted_reserve(), BOOL_TO_STR(ShenandoahHeap::heap()->collection_set()->has_old_regions()));\n-      }\n-    } else if (req.is_promotion()) {\n-      \/\/ Shared promotion.\n-      log_debug(gc, plab)(\"Expend shared promotion of %zu bytes\", actual_size);\n-      expend_promoted(actual_size);\n-    }\n+  assert(req.is_gc_alloc() && req.is_old() && req.is_lab_alloc(), \"Must be a plab alloc request\");\n+  const size_t actual_size = req.actual_size() * HeapWordSize;\n+  \/\/ We've created a new plab. Now we configure it whether it will be used for promotions\n+  \/\/ and evacuations - or just evacuations.\n+  Thread* thread = Thread::current();\n+  ShenandoahThreadLocalData::reset_plab_promoted(thread);\n+\n+  \/\/ The actual size of the allocation may be larger than the requested bytes (due to alignment on card boundaries).\n+  \/\/ If this puts us over our promotion budget, we need to disable future PLAB promotions for this thread.\n+  if (can_promote(actual_size)) {\n+    \/\/ Assume the entirety of this PLAB will be used for promotion.  This prevents promotion from overreach.\n+    \/\/ When we retire this plab, we'll unexpend what we don't really use.\n+    log_debug(gc, plab)(\"Thread can promote using PLAB of %zu bytes. Expended: %zu, available: %zu\",\n+                        actual_size, get_promoted_expended(), get_promoted_reserve());\n+    expend_promoted(actual_size);\n+    ShenandoahThreadLocalData::enable_plab_promotions(thread);\n+    ShenandoahThreadLocalData::set_plab_actual_size(thread, actual_size);\n+  } else {\n+    \/\/ Disable promotions in this thread because entirety of this PLAB must be available to hold old-gen evacuations.\n+    ShenandoahThreadLocalData::disable_plab_promotions(thread);\n+    ShenandoahThreadLocalData::set_plab_actual_size(thread, 0);\n+    log_debug(gc, plab)(\"Thread cannot promote using PLAB of %zu bytes. Expended: %zu, available: %zu, mixed evacuations? %s\",\n+                        actual_size, get_promoted_expended(), get_promoted_reserve(), BOOL_TO_STR(ShenandoahHeap::heap()->collection_set()->has_old_regions()));\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahOldGeneration.cpp","additions":25,"deletions":32,"binary":false,"changes":57,"status":"modified"}]}