{"files":[{"patch":"@@ -6806,0 +6806,1 @@\n+  block_comment(\"spin_wait {\");\n@@ -6824,0 +6825,1 @@\n+  block_comment(\"}\");\n","filename":"src\/hotspot\/cpu\/aarch64\/macroAssembler_aarch64.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -85,2 +85,0 @@\n-compiler\/onSpinWait\/TestOnSpinWaitAArch64.java 8360936 linux-aarch64,macosx-aarch64\n-\n","filename":"test\/hotspot\/jtreg\/ProblemList.txt","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+ * @requires vm.debug\n@@ -52,0 +53,1 @@\n+\n@@ -94,1 +96,1 @@\n-          return \"1f20 03d5\";\n+          return \"1f2003d5\";\n@@ -96,1 +98,1 @@\n-          return \"df3f 03d5\";\n+          return \"df3f03d5\";\n@@ -98,1 +100,1 @@\n-          return \"3f20 03d5\";\n+          return \"3f2003d5\";\n@@ -100,1 +102,1 @@\n-          return \"ff30 03d5\";\n+          return \"ff3003d5\";\n@@ -106,3 +108,28 @@\n-    private static void addInstrs(String line, ArrayList<String> instrs) {\n-        for (String instr : line.split(\"\\\\|\")) {\n-            instrs.add(instr.trim());\n+    private static int countInstructions(Iterator<String> iter, String instr) {\n+        String line = null;\n+        int foundInstCount = 0;\n+        while (iter.hasNext()) {\n+            line = iter.next().trim();\n+            if (line.startsWith(\";; }\")) {\n+                break;\n+            }\n+\n+            if (!line.startsWith(\"0x\")) {\n+                continue;\n+            }\n+            int pos = line.indexOf(':');\n+            if (pos == -1 || pos == line.length() - 1) {\n+                continue;\n+            }\n+\n+            line = line.substring(pos + 1).replaceAll(\"\\\\s\", \"\");\n+            if (line.startsWith(\";\")) {\n+                continue;\n+            }\n+\n+            for (String s : line.split(\"\\\\|\")) {\n+                if (!s.startsWith(instr)) {\n+                    return foundInstCount;\n+                }\n+                foundInstCount++;\n+            }\n@@ -110,0 +137,1 @@\n+        return foundInstCount;\n@@ -112,9 +140,2 @@\n-    \/\/ The expected output of PrintAssembly for example for a spin wait with three NOPs:\n-    \/\/\n-    \/\/ # {method} {0x0000ffff6ac00370} 'test' '()V' in 'compiler\/onSpinWait\/TestOnSpinWaitAArch64$Launcher'\n-    \/\/ #           [sp+0x40]  (sp of caller)\n-    \/\/ 0x0000ffff9d557680: 1f20 03d5 | e953 40d1 | 3f01 00f9 | ff03 01d1 | fd7b 03a9 | 1f20 03d5 | 1f20 03d5\n-    \/\/\n-    \/\/ 0x0000ffff9d5576ac: ;*invokestatic onSpinWait {reexecute=0 rethrow=0 return_oop=0}\n-    \/\/                     ; - compiler.onSpinWait.TestOnSpinWaitAArch64$Launcher::test@0 (line 161)\n-    \/\/ 0x0000ffff9d5576ac: 1f20 03d5 | fd7b 43a9 | ff03 0191\n+    \/\/ The expected output for a spin wait with three NOPs\n+    \/\/ if the hsdis library is available:\n@@ -122,2 +143,5 @@\n-    \/\/ The checkOutput method adds hex instructions before 'invokestatic onSpinWait' and from the line after\n-    \/\/ it to a list. The list is traversed from the end to count spin wait instructions.\n+    \/\/ ;; spin_wait {\n+    \/\/ 0x0000000111dfa58c:   nop\n+    \/\/ 0x0000000111dfa590:   nop\n+    \/\/ 0x0000000111dfa594:   nop\n+    \/\/ ;; }\n@@ -125,16 +149,4 @@\n-    \/\/ If JVM finds the hsdis library the output is like:\n-    \/\/\n-    \/\/ # {method} {0x0000ffff63000370} 'test' '()V' in 'compiler\/onSpinWait\/TestOnSpinWaitAArch64$Launcher'\n-    \/\/ #           [sp+0x20]  (sp of caller)\n-    \/\/ 0x0000ffffa409da80:   nop\n-    \/\/ 0x0000ffffa409da84:   sub sp, sp, #0x20\n-    \/\/ 0x0000ffffa409da88:   stp x29, x30, [sp, #16]         ;*synchronization entry\n-    \/\/                                                       ; - compiler.onSpinWait.TestOnSpinWaitAArch64$Launcher::test@-1 (line 187)\n-    \/\/ 0x0000ffffa409da8c:   nop\n-    \/\/ 0x0000ffffa409da90:   nop\n-    \/\/ 0x0000ffffa409da94:   nop\n-    \/\/ 0x0000ffffa409da98:   nop\n-    \/\/ 0x0000ffffa409da9c:   nop\n-    \/\/ 0x0000ffffa409daa0:   nop\n-    \/\/ 0x0000ffffa409daa4:   nop                                 ;*invokestatic onSpinWait {reexecute=0 rethrow=0 return_oop=0}\n-    \/\/                                                           ; - compiler.onSpinWait.TestOnSpinWaitAArch64$Launcher::test@0 (line 187)\n+    \/\/ We work as follows:\n+    \/\/ 1. Check whether printed instructions are disassembled (\"[Disassembly]\").\n+    \/\/ 2. Look for the block comment ';; spin_wait {'.\n+    \/\/ 3. Count spin wait instructions.\n@@ -143,7 +155,0 @@\n-\n-        String match = skipTo(iter, \"'test' '()V' in 'compiler\/onSpinWait\/TestOnSpinWaitAArch64$Launcher'\");\n-        if (match == null) {\n-            throw new RuntimeException(\"Missing compiler output for the method compiler.onSpinWait.TestOnSpinWaitAArch64$Launcher::test\");\n-        }\n-\n-        ArrayList<String> instrs = new ArrayList<String>();\n@@ -151,1 +156,1 @@\n-        boolean hasHexInstInOutput = false;\n+        boolean isDisassembled = false;\n@@ -154,1 +159,2 @@\n-            if (line.contains(\"*invokestatic onSpinWait\")) {\n+            if (line.contains(\"[Disassembly]\")) {\n+                isDisassembled = true;\n@@ -157,25 +163,0 @@\n-            if (!hasHexInstInOutput) {\n-                hasHexInstInOutput = line.contains(\"|\");\n-            }\n-            if (line.contains(\"0x\") && !line.contains(\";\")) {\n-                addInstrs(line, instrs);\n-            }\n-        }\n-\n-        if (!iter.hasNext() || !iter.next().contains(\"- compiler.onSpinWait.TestOnSpinWaitAArch64$Launcher::test@0\") || !iter.hasNext()) {\n-            throw new RuntimeException(\"Missing compiler output for Thread.onSpinWait intrinsic\");\n-        }\n-\n-        String strToSearch = null;\n-        if (!hasHexInstInOutput) {\n-            instrs.add(line.split(\";\")[0].trim());\n-            strToSearch = spinWaitInst;\n-        } else {\n-            line = iter.next();\n-            if (!line.contains(\"0x\") || line.contains(\";\")) {\n-                throw new RuntimeException(\"Expected hex instructions\");\n-            }\n-\n-            addInstrs(line, instrs);\n-            strToSearch = getSpinWaitInstHex(spinWaitInst);\n-        }\n@@ -183,6 +164,1 @@\n-        int foundInstCount = 0;\n-\n-        ListIterator<String> instrReverseIter = instrs.listIterator(instrs.size());\n-        while (instrReverseIter.hasPrevious()) {\n-            if (instrReverseIter.previous().endsWith(strToSearch)) {\n-                foundInstCount = 1;\n+            if (line.contains(\"[MachCode]\")) {\n@@ -193,2 +169,5 @@\n-        while (instrReverseIter.hasPrevious()) {\n-            if (!instrReverseIter.previous().endsWith(strToSearch)) {\n+        boolean foundSpinWaitBlock = false;\n+        while (iter.hasNext()) {\n+            line = iter.next();\n+            if (line.contains(\";; spin_wait {\")) {\n+                foundSpinWaitBlock = true;\n@@ -197,1 +176,0 @@\n-            ++foundInstCount;\n@@ -200,2 +178,2 @@\n-        if (foundInstCount != spinWaitInstCount) {\n-            throw new RuntimeException(\"Wrong instruction \" + strToSearch + \" count \" + foundInstCount + \"!\\n  -- expecting \" + spinWaitInstCount);\n+        if (!foundSpinWaitBlock) {\n+            throw new RuntimeException(\"Block comment ';; spin_wait {' not found\");\n@@ -203,1 +181,0 @@\n-    }\n@@ -205,6 +182,5 @@\n-    private static String skipTo(Iterator<String> iter, String substring) {\n-        while (iter.hasNext()) {\n-            String nextLine = iter.next();\n-            if (nextLine.contains(substring)) {\n-                return nextLine;\n-            }\n+        final String expectedInstInOutput = isDisassembled ? spinWaitInst : getSpinWaitInstHex(spinWaitInst);\n+        final int foundInstCount = countInstructions(iter, expectedInstInOutput);\n+\n+        if (foundInstCount != spinWaitInstCount) {\n+            throw new RuntimeException(\"Expect \" + spinWaitInstCount + \" \" + spinWaitInst + \" instructions. Found: \" + foundInstCount);\n@@ -212,1 +188,0 @@\n-        return null;\n","filename":"test\/hotspot\/jtreg\/compiler\/onSpinWait\/TestOnSpinWaitAArch64.java","additions":62,"deletions":87,"binary":false,"changes":149,"status":"modified"}]}