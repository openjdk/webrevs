{"files":[{"patch":"@@ -83,1 +83,0 @@\n-#ifdef _LP64\n@@ -86,0 +85,1 @@\n+#ifdef _LP64\n@@ -88,0 +88,9 @@\n+#else\n+  const Register tmp1 = rcx;\n+  const Register tmp2 = rdx;\n+  __ push(tmp1);\n+  __ push(tmp2);\n+\n+  __ lea(tmp1, safepoint_pc);\n+  __ get_thread(tmp2);\n+  __ movptr(Address(tmp2, JavaThread::saved_exception_pc_offset()), tmp1);\n@@ -89,0 +98,3 @@\n+  __ pop(tmp2);\n+  __ pop(tmp1);\n+#endif \/* _LP64 *\/\n@@ -91,0 +103,1 @@\n+\n@@ -93,3 +106,0 @@\n-#else\n-  ShouldNotReachHere();\n-#endif \/* _LP64 *\/\n","filename":"src\/hotspot\/cpu\/x86\/c1_CodeStubs_x86.cpp","additions":14,"deletions":4,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -538,3 +538,1 @@\n-  code_stub->set_safepoint_offset(__ offset());\n-  __ relocate(relocInfo::poll_return_type);\n-  __ safepoint_poll(*code_stub->entry(), r15_thread, true \/* at_return *\/, true \/* in_nmethod *\/);\n+  const Register thread = r15_thread;\n@@ -542,6 +540,2 @@\n-  const Register poll_addr = rbx;\n-  assert(FrameMap::is_caller_save_register(poll_addr), \"will overwrite\");\n-  __ get_thread(poll_addr);\n-  __ movptr(poll_addr, Address(poll_addr, Thread::polling_page_offset()));\n-  __ relocate(relocInfo::poll_return_type);\n-  __ testl(rax, Address(poll_addr, 0));\n+  const Register thread = rbx;\n+  __ get_thread(thread);\n@@ -549,0 +543,3 @@\n+  code_stub->set_safepoint_offset(__ offset());\n+  __ relocate(relocInfo::poll_return_type);\n+  __ safepoint_poll(*code_stub->entry(), thread, true \/* at_return *\/, true \/* in_nmethod *\/);\n","filename":"src\/hotspot\/cpu\/x86\/c1_LIRAssembler_x86.cpp","additions":6,"deletions":9,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -34,1 +34,0 @@\n-#ifdef _LP64\n@@ -43,0 +42,1 @@\n+#ifdef _LP64\n@@ -45,1 +45,0 @@\n-  __ jump(callback_addr);\n@@ -47,1 +46,11 @@\n-  ShouldNotReachHere();\n+  const Register tmp1 = rcx;\n+  const Register tmp2 = rdx;\n+  __ push(tmp1);\n+  __ push(tmp2);\n+\n+  __ lea(tmp1, safepoint_pc);\n+  __ get_thread(tmp2);\n+  __ movptr(Address(tmp2, JavaThread::saved_exception_pc_offset()), tmp1);\n+\n+  __ pop(tmp2);\n+  __ pop(tmp1);\n@@ -49,0 +58,1 @@\n+  __ jump(callback_addr);\n","filename":"src\/hotspot\/cpu\/x86\/c2_safepointPollStubTable_x86.cpp","additions":13,"deletions":3,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2764,1 +2764,0 @@\n-#ifdef _LP64\n@@ -2768,1 +2767,1 @@\n-    cmpq(in_nmethod ? rsp : rbp, Address(thread_reg, Thread::polling_word_offset()));\n+    cmpptr(in_nmethod ? rsp : rbp, Address(thread_reg, Thread::polling_word_offset()));\n@@ -2772,1 +2771,0 @@\n-#endif\n","filename":"src\/hotspot\/cpu\/x86\/macroAssembler_x86.cpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1026,1 +1026,1 @@\n-    return LP64_ONLY(true) NOT_LP64(false);\n+    return true;\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -656,2 +656,3 @@\n-    st->print(\"TEST   PollPage,EAX\\t! Poll Safepoint\");\n-    st->cr(); st->print(\"\\t\");\n+    st->print(\"cmpptr   rsp, poll_offset[thread]  \\n\\t\"\n+              \"ja       #safepoint_stub\\t\"\n+              \"# Safepoint: poll for GC\");\n@@ -700,1 +701,1 @@\n-    Register pollReg = as_Register(EBX_enc);\n+    Register thread = as_Register(EBX_enc);\n@@ -702,4 +703,8 @@\n-    masm.get_thread(pollReg);\n-    masm.movl(pollReg, Address(pollReg, in_bytes(Thread::polling_page_offset())));\n-    masm.relocate(relocInfo::poll_return_type);\n-    masm.testl(rax, Address(pollReg, 0));\n+    __ get_thread(thread);\n+    Label dummy_label;\n+    Label* code_stub = &dummy_label;\n+    if (!C->output()->in_scratch_emit_size()) {\n+      code_stub = &C->output()->safepoint_poll_table()->add_safepoint(__ offset());\n+    }\n+    __ relocate(relocInfo::poll_return_type);\n+    __ safepoint_poll(*code_stub, thread, true \/* at_return *\/, true \/* in_nmethod *\/);\n","filename":"src\/hotspot\/cpu\/x86\/x86_32.ad","additions":12,"deletions":7,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -933,2 +933,2 @@\n-    st->print_cr(\"cmpq    poll_offset[r15_thread], rsp\\n\\t\"\n-                 \"ja      #safepoint_stub\\t\"\n+    st->print_cr(\"cmpptr   rsp, poll_offset[r15_thread] \\n\\t\"\n+                 \"ja       #safepoint_stub\\t\"\n","filename":"src\/hotspot\/cpu\/x86\/x86_64.ad","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}