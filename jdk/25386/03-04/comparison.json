{"files":[{"patch":"@@ -2171,1 +2171,16 @@\n-    \/\/ inputs a chance to optimize and possibly end up with identical inputs.\n+    \/\/ inputs a chance to optimize and possibly end up with identical inputs (casts included).\n+    \/\/ Say we have:\n+    \/\/ (Phi region (Cast#1 c uin) (Cast#2 c uin))\n+    \/\/ and Cast#1 and Cast#2 have not had a chance to common yet\n+    \/\/ if the unique_input() transformation below proceeds, then PhiNode::Ideal returns:\n+    \/\/ (Cast#3 region uin) (1)\n+    \/\/ If PhiNode::Ideal is delayed until Cast#1 and Cast#2 common, then it returns:\n+    \/\/ (Cast#1 c uin) (2)\n+    \/\/\n+    \/\/ In (1) the resulting cast is conservatively pinned at a later control and while Cast#3 and Cast#1\/Cast#2 still\n+    \/\/ have a chance to common, that requires proving that c dominates region in ConstraintCastNode::dominating_cast()\n+    \/\/ which may not happen if control flow is too complicated and another pass of loop opts doesn't run. Delaying the\n+    \/\/ transformation here should allow a more optimal result.\n+    \/\/ Beyond the efficiency concern, there is a risk, if the casts are CastPPs, to end up with a chain of AddPs with\n+    \/\/ different base inputs (but a unique uncasted base input). This breaks an invariant in the shape of address\n+    \/\/ subtrees.\n","filename":"src\/hotspot\/share\/opto\/cfgnode.cpp","additions":16,"deletions":1,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -2068,8 +2068,9 @@\n-    if (!addp->is_AddP()) {\n-      return false;\n-    }\n-    if (addp->in(AddPNode::Base)->is_top()) {\n-      return false;\n-    }\n-    if (addp->in(AddPNode::Base) == n->in(AddPNode::Base)) {\n-      return false;\n+    if (addp->is_AddP() &&\n+        !addp->in(AddPNode::Base)->is_top() &&\n+        addp->in(AddPNode::Base) != n->in(AddPNode::Base)) {\n+      stringStream ss; \/\/ Print as a block without tty lock.\n+      ss.cr();\n+      ss.print_cr(\"Base pointers must match for AddP chain:\");\n+      n->dump_bfs(2, nullptr, \"\", &ss);\n+      tty->print_cr(\"%s\", ss.as_string());\n+      return true;\n@@ -2077,6 +2078,0 @@\n-    stringStream ss; \/\/ Print as a block without tty lock.\n-    ss.cr();\n-    ss.print_cr(\"Base pointers must match for AddP chain:\");\n-    n->dump_bfs(2, nullptr, \"\", &ss);\n-    tty->print_cr(\"%s\", ss.as_string());\n-    return true;\n","filename":"src\/hotspot\/share\/opto\/phaseX.cpp","additions":9,"deletions":14,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -30,1 +30,2 @@\n- *                   -XX:+StressIGVN -XX:StressSeed=383593806 TestMismatchedAddPAfterMaxUnroll\n+ *                   -XX:+StressIGVN -XX:StressSeed=383593806 -XX:VerifyIterativeGVN=10000\n+ *                   TestMismatchedAddPAfterMaxUnroll\n@@ -33,1 +34,1 @@\n- *                   -XX:+StressIGVN TestMismatchedAddPAfterMaxUnroll\n+ *                   -XX:+StressIGVN  -XX:VerifyIterativeGVN=10000 TestMismatchedAddPAfterMaxUnroll\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/TestMismatchedAddPAfterMaxUnroll.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"}]}