{"files":[{"patch":"@@ -30,1 +30,0 @@\n-import java.net.http.HttpClient.Version;\n@@ -710,2 +709,1 @@\n-                                final Throwable terminationException = c.getTerminationException()\n-                                        .orElse(null);\n+                                final Http2TerminationCause tc = c.getTerminationCause();\n@@ -713,3 +711,2 @@\n-                                if (terminationException != null) {\n-                                    ioe = new IOException(\"Can't get stream 1: \" + terminationException,\n-                                            terminationException);\n+                                if (tc != null) {\n+                                    ioe = new IOException(\"Can't get stream 1\", tc.getCloseCause());\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Exchange.java","additions":3,"deletions":6,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -47,1 +47,0 @@\n-import java.util.Optional;\n@@ -884,26 +883,0 @@\n-    \/**\n-     * Returns the exception which caused the connection to be terminated. Even a normal termination\n-     * of a connection will have a {@code IOException} associated with it.\n-     * If the connection hasn't yet been terminated then this method returns an empty Optional.\n-     *\/\n-    final Optional<IOException> getTerminationException() {\n-        final Http2TerminationCause terminationCause = this.connTerminator.getTerminationCause();\n-        if (terminationCause != null) {\n-            return Optional.of(terminationCause.getCloseCause());\n-        }\n-        \/\/ there can be window of race where the termination cause isn't yet set\n-        \/\/ but the connection isn't open. that can happen when the underlying SocketChannel\n-        \/\/ is closed behind the scenes and the Http2Connection isn't aware of it and hasn't\n-        \/\/ set a termination cause for it.\n-        \/\/ so here we check if the connection isn't open and if it isn't then we call\n-        \/\/ Terminator.getTerminationCause() which has the necessary infrastructure to create\n-        \/\/ and return a termination cause for that situation.\n-        if (!isOpen()) {\n-            final Http2TerminationCause tc = this.connTerminator.getTerminationCause();\n-            assert tc != null : \"termination cause is null for a closed connection\";\n-            return Optional.of(tc.getCloseCause());\n-        }\n-        \/\/ connection isn't terminated\n-        return Optional.empty();\n-    }\n-\n@@ -1610,1 +1583,1 @@\n-        final Http2TerminationCause terminationCause = this.connTerminator.getTerminationCause();\n+        final Http2TerminationCause terminationCause = getTerminationCause();\n@@ -1716,1 +1689,1 @@\n-                final Http2TerminationCause terminationCause = this.connTerminator.getTerminationCause();\n+                final Http2TerminationCause terminationCause = getTerminationCause();\n@@ -2019,2 +1992,3 @@\n-        Log.logTrace(\"{0} sending GOAWAY {1}\", connection, goAway);\n-        if (debug.on()) {\n+        if (Log.trace()) {\n+            Log.logTrace(\"{0} sending GOAWAY {1}\", connection, goAway);\n+        } else if (debug.on()) {\n@@ -2027,0 +2001,7 @@\n+    \/**\n+     * Returns the termination cause if the connection is closed, else returns null.\n+     *\/\n+    final Http2TerminationCause getTerminationCause() {\n+        return this.connTerminator.determineTerminationCause();\n+    }\n+\n@@ -2075,3 +2056,1 @@\n-            if (Log.errors()) {\n-                Log.logError(\"Closing connection due to: {0}\", tc);\n-            } else if (debug.on()) {\n+            if (Log.errors() || debug.on()) {\n@@ -2082,1 +2061,6 @@\n-                debug.log(\"Closing connection (\" + stateStr + \") due to: \" + tc);\n+                if (Log.errors()) {\n+                    Log.logError(\"Closing connection {0} ({1}) due to: {2}\",\n+                            connection, stateStr, tc);\n+                } else {\n+                    debug.log(\"Closing connection (\" + stateStr + \") due to: \" + tc);\n+                }\n@@ -2119,3 +2103,3 @@\n-         * Returns the termination cause for the connection. This method guarantees\n-         * that if the {@linkplain Http2Connection#isOpen() connection is not open}\n-         * then this returns a non-null termination cause.\n+         * Returns the termination cause for the connection. This method guarantees that if the\n+         * {@linkplain Http2Connection#isOpen() connection is not open}, when this method is called,\n+         * then it returns a non-null termination cause. Returns null if the connection is open.\n@@ -2123,1 +2107,1 @@\n-        private Http2TerminationCause getTerminationCause() {\n+        private Http2TerminationCause determineTerminationCause() {\n@@ -2126,0 +2110,1 @@\n+                \/\/ already terminated, return the cause\n@@ -2137,1 +2122,1 @@\n-            return null;\n+            return null; \/\/ connection still open\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2Connection.java","additions":25,"deletions":40,"binary":false,"changes":65,"status":"modified"},{"patch":"@@ -35,1 +35,1 @@\n- * Termination cause for a {@linkplain Http2Connection HTTP\/2 connection}\n+ * Termination cause for an {@linkplain Http2Connection HTTP\/2 connection}\n@@ -69,1 +69,1 @@\n-     * Returns the IOException that is considered the cause of the connection termination.\n+     * Returns the {@link IOException} that is considered the cause of the connection termination.\n@@ -71,1 +71,1 @@\n-     * a IOException associated with it, so this method will always return a non-null instance.\n+     * an {@code IOException} associated with it, so this method will always return a non-null instance.\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2TerminationCause.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -42,1 +42,0 @@\n-import javax.net.ssl.SSLContext;\n@@ -52,1 +51,0 @@\n-import jdk.test.lib.net.SimpleSSLContext;\n@@ -102,2 +100,2 @@\n-    private static SSLContext sslContext;\n-    private static Http2TestServer h2server;\n+    \/\/ we use a h2c server but it doesn't matter if it is h2c or h2\n+    private static Http2TestServer http2Server;\n@@ -111,6 +109,5 @@\n-        sslContext = new SimpleSSLContext().get();\n-        h2server = new Http2TestServer(true, sslContext);\n-        h2server.setExchangeSupplier(new ExchangeSupplier());\n-        h2server.addHandler(new Handler(), HANDLER_PATH);\n-        h2server.start();\n-        System.err.println(\"started HTTP\/2 server \" + h2server.getAddress());\n+        http2Server = new Http2TestServer(false, 0);\n+        http2Server.setExchangeSupplier(new ExchangeSupplier());\n+        http2Server.addHandler(new Handler(), HANDLER_PATH);\n+        http2Server.start();\n+        System.err.println(\"started HTTP\/2 server \" + http2Server.getAddress());\n@@ -121,3 +118,3 @@\n-        if (h2server != null) {\n-            System.err.println(\"stopping server \" + h2server.getAddress());\n-            h2server.stop();\n+        if (http2Server != null) {\n+            System.err.println(\"stopping server \" + http2Server.getAddress());\n+            http2Server.stop();\n@@ -136,3 +133,3 @@\n-                .scheme(\"https\")\n-                .host(h2server.getAddress().getAddress())\n-                .port(h2server.getAddress().getPort())\n+                .scheme(\"http\")\n+                .host(http2Server.getAddress().getAddress())\n+                .port(http2Server.getAddress().getPort())\n@@ -150,1 +147,0 @@\n-                     .sslContext(sslContext)\n","filename":"test\/jdk\/java\/net\/httpclient\/http2\/BurstyRequestsTest.java","additions":13,"deletions":17,"binary":false,"changes":30,"status":"modified"}]}