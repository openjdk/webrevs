{"files":[{"patch":"@@ -25,0 +25,1 @@\n+import java.lang.reflect.Field;\n@@ -29,0 +30,2 @@\n+import java.util.Objects;\n+import java.util.Set;\n@@ -30,0 +33,1 @@\n+\n@@ -35,0 +39,11 @@\n+    private static final Field openedConnections; \/\/ Set<> jdk.internal.net.http.HttpClientImpl#openedConnections\n+\n+    static {\n+        try {\n+            openedConnections = Class.forName(\"jdk.internal.net.http.HttpClientImpl\")\n+                    .getDeclaredField(\"openedConnections\");\n+        } catch (Exception e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n@@ -64,0 +79,11 @@\n+\n+    public static Set<?> getOpenedConnections(final HttpClient client)\n+            throws IllegalAccessException {\n+        Objects.requireNonNull(client, \"client\");\n+        final HttpClientImpl clientImpl = impl(client);\n+        if (clientImpl == null) {\n+            return null;\n+        }\n+        openedConnections.setAccessible(true);\n+        return (Set<?>) openedConnections.get(clientImpl);\n+    }\n","filename":"test\/jdk\/java\/net\/httpclient\/access\/java.net.http\/jdk\/internal\/net\/http\/Http3ConnectionAccess.java","additions":26,"deletions":0,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -26,1 +26,0 @@\n-import java.lang.reflect.Field;\n@@ -50,0 +49,1 @@\n+import jdk.internal.net.http.Http3ConnectionAccess;\n@@ -65,22 +65,1 @@\n- * @modules java.net.http\/jdk.internal.net.http:+open\n- *          java.net.http\/jdk.internal.net.http.common\n- *          java.net.http\/jdk.internal.net.http.frame\n- *          java.net.http\/jdk.internal.net.http.hpack\n- *          java.net.http\/jdk.internal.net.http.quic\n- *          java.net.http\/jdk.internal.net.http.quic.packets\n- *          java.net.http\/jdk.internal.net.http.quic.frames\n- *          java.net.http\/jdk.internal.net.http.quic.streams\n- *          java.net.http\/jdk.internal.net.http.http3.streams\n- *          java.net.http\/jdk.internal.net.http.http3.frames\n- *          java.net.http\/jdk.internal.net.http.http3\n- *          java.net.http\/jdk.internal.net.http.qpack\n- *          java.net.http\/jdk.internal.net.http.qpack.readers\n- *          java.net.http\/jdk.internal.net.http.qpack.writers\n- *          java.logging\n- *          java.base\/jdk.internal.net.quic\n- *          java.base\/jdk.internal.util\n- *          java.base\/sun.net.www.http\n- *          java.base\/sun.net.www\n- *          java.base\/sun.net\n- *\n- * @library \/test\/lib \/test\/jdk\/java\/net\/httpclient\/lib\n+ * @library \/test\/lib \/test\/jdk\/java\/net\/httpclient\/lib ..\/access\n@@ -92,0 +71,1 @@\n+ *        java.net.http\/jdk.internal.net.http.Http3ConnectionAccess\n@@ -98,2 +78,0 @@\n-    private static Field openConnections; \/\/ Set<> jdk.internal.net.http.HttpClientImpl#openedConnections\n-\n@@ -105,4 +83,0 @@\n-        openConnections = Class.forName(\"jdk.internal.net.http.HttpClientImpl\")\n-                .getDeclaredField(\"openedConnections\");\n-        openConnections.setAccessible(true);\n-\n@@ -152,2 +126,2 @@\n-            final Object clientImpl = reflectHttpClientImplInstance(client);\n-            assumeTrue(clientImpl != null,\n+            final Set<?> openedConnections = Http3ConnectionAccess.getOpenedConnections(client);\n+            assumeTrue(openedConnections != null,\n@@ -171,3 +145,2 @@\n-            final Set<?> currentOpenConns = (Set<?>) openConnections.get(clientImpl);\n-            int size = currentOpenConns.size();\n-            System.err.println(\"currently \" + size + \" open connections: \" + currentOpenConns);\n+            int size = openedConnections.size();\n+            System.err.println(\"currently \" + size + \" open connections: \" + openedConnections);\n@@ -178,1 +151,1 @@\n-                size = currentOpenConns.size();\n+                size = openedConnections.size();\n@@ -180,1 +153,1 @@\n-                    System.err.println(\"currently \" + size + \" open connections: \" + currentOpenConns);\n+                    System.err.println(\"currently \" + size + \" open connections: \" + openedConnections);\n@@ -189,18 +162,0 @@\n-    \/\/ using reflection, return the jdk.internal.net.http.HttpClientImpl instance held\n-    \/\/ by the given client\n-    private static Object reflectHttpClientImplInstance(final HttpClient client) throws Exception {\n-        if (!client.getClass().getName().equals(\"jdk.internal.net.http.HttpClientFacade\")) {\n-            return null;\n-        }\n-        final Field implField = client.getClass().getDeclaredField(\"impl\");\n-        implField.setAccessible(true);\n-        final Object clientImpl = implField.get(client);\n-        if (clientImpl == null) {\n-            return null;\n-        }\n-        if (!clientImpl.getClass().getName().equals(\"jdk.internal.net.http.HttpClientImpl\")) {\n-            return null;\n-        }\n-        return clientImpl; \/\/ the expected HttpClientImpl instance\n-    }\n-\n","filename":"test\/jdk\/java\/net\/httpclient\/http2\/BurstyRequestsTest.java","additions":9,"deletions":54,"binary":false,"changes":63,"status":"modified"}]}