{"files":[{"patch":"@@ -117,0 +117,1 @@\n+FileMapInfo* AOTMetaspace::_output_mapinfo = nullptr;\n@@ -325,0 +326,18 @@\n+  if (CDSConfig::is_dumping_preimage_static_archive()) {\n+    \/\/ We are in the AOT training run. User code is executed.\n+    \/\/\n+    \/\/ On Windows, if the user code closes System.out and we open the AOT config file for output\n+    \/\/ only at VM exit, we might get back the same file HANDLE as stdout, and the AOT config\n+    \/\/ file may get corrupted by UL logs. By opening early, we ensure that the output\n+    \/\/ HANDLE is different than stdout so we can avoid such corruption.\n+    open_output_mapinfo();\n+  } else {\n+    \/\/ No need for the above as we won't execute any user code.\n+  }\n+}\n+\n+void AOTMetaspace::open_output_mapinfo() {\n+  const char* static_archive = CDSConfig::output_archive_path();\n+  assert(static_archive != nullptr, \"sanity\");\n+  _output_mapinfo = new FileMapInfo(static_archive, true);\n+  _output_mapinfo->open_as_output();\n@@ -658,2 +677,2 @@\n-  VM_PopulateDumpSharedSpace(StaticArchiveBuilder& b) :\n-    VM_Operation(), _mapped_heap_info(), _streamed_heap_info(), _map_info(nullptr), _builder(b) {}\n+  VM_PopulateDumpSharedSpace(StaticArchiveBuilder& b, FileMapInfo* map_info) :\n+    VM_Operation(), _mapped_heap_info(), _streamed_heap_info(), _map_info(map_info), _builder(b) {}\n@@ -666,1 +685,0 @@\n-  FileMapInfo* map_info() const { return _map_info; }\n@@ -798,6 +816,0 @@\n-  if (CDSConfig::is_dumping_final_static_archive()) {\n-    FileMapInfo::free_current_info(); \/\/ FIXME: should not free current info\n-  }\n-  const char* static_archive = CDSConfig::output_archive_path();\n-  assert(static_archive != nullptr, \"sanity\");\n-  _map_info = new FileMapInfo(static_archive, true);\n@@ -1141,1 +1153,8 @@\n-  VM_PopulateDumpSharedSpace op(builder);\n+  if (!CDSConfig::is_dumping_preimage_static_archive()) {\n+    if (CDSConfig::is_dumping_final_static_archive()) {\n+      FileMapInfo::free_current_info(); \/\/ FIXME: should not free current info\n+    }\n+    open_output_mapinfo();\n+  }\n+\n+  VM_PopulateDumpSharedSpace op(builder, _output_mapinfo);\n@@ -1155,1 +1174,3 @@\n-  bool status = write_static_archive(&builder, op.map_info(), op.mapped_heap_info(), op.streamed_heap_info());\n+  bool status = write_static_archive(&builder, _output_mapinfo, op.mapped_heap_info(), op.streamed_heap_info());\n+  assert(!_output_mapinfo->is_open(), \"Must be closed already\");\n+  _output_mapinfo = nullptr;\n@@ -1176,2 +1197,0 @@\n-\n-  map_info->open_as_output();\n@@ -1181,0 +1200,1 @@\n+  map_info->prepare_for_writing();\n","filename":"src\/hotspot\/share\/cds\/aotMetaspace.cpp","additions":33,"deletions":13,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -63,0 +63,1 @@\n+  static FileMapInfo* _output_mapinfo;\n@@ -188,0 +189,1 @@\n+  static void open_output_mapinfo();\n","filename":"src\/hotspot\/share\/cds\/aotMetaspace.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -356,0 +356,1 @@\n+  dynamic_info->prepare_for_writing();\n","filename":"src\/hotspot\/share\/cds\/dynamicArchive.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -780,0 +780,1 @@\n+}\n@@ -781,0 +782,1 @@\n+void FileMapInfo::prepare_for_writing() {\n","filename":"src\/hotspot\/share\/cds\/filemap.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -368,0 +368,1 @@\n+  void  prepare_for_writing();\n","filename":"src\/hotspot\/share\/cds\/filemap.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -0,0 +1,82 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+\/*\n+ * @test\n+ * @summary AOT configuration should not be corrupted even if the app closes System.out in the training run\n+ * @bug 8371944\n+ * @library \/test\/jdk\/lib\/testlibrary \/test\/lib\n+ * @build CloseSystemOut\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller -jar app.jar CloseSystemOutApp\n+ * @run driver CloseSystemOut\n+ *\/\n+\n+import java.io.PrintWriter;\n+import jdk.test.lib.cds.CDSAppTester;\n+import jdk.test.lib.helpers.ClassFileInstaller;\n+import jdk.test.lib.process.OutputAnalyzer;\n+\n+public class CloseSystemOut {\n+    static final String appJar = ClassFileInstaller.getJarPath(\"app.jar\");\n+    static final String mainClass = \"CloseSystemOutApp\";\n+\n+    public static void main(String[] args) throws Exception {\n+        Tester tester = new Tester();\n+        tester.run(new String[] {\"AOT\", \"--two-step-training\"} );\n+    }\n+\n+    static class Tester extends CDSAppTester {\n+        public Tester() {\n+            super(mainClass);\n+        }\n+\n+        @Override\n+        public String classpath(RunMode runMode) {\n+            return appJar;\n+        }\n+\n+        @Override\n+        public String[] appCommandLine(RunMode runMode) {\n+            return new String[] {mainClass};\n+        }\n+\n+        @Override\n+        public void checkExecution(OutputAnalyzer out, RunMode runMode) {\n+            if (runMode != RunMode.ASSEMBLY) {\n+                out.shouldContain(\"Hello Confused World\");\n+            }\n+        }\n+    }\n+}\n+\n+class CloseSystemOutApp {\n+    public static void main(String args[]) {\n+        \/\/ Naive code that ends up closing System.out\/err when we\n+        \/\/ leave the \"try\" block\n+        try (var err = new PrintWriter(System.err);\n+             var out = new PrintWriter(System.out)) {\n+            out.println(\"Hello Confused World\");\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/aotCache\/CloseSystemOut.java","additions":82,"deletions":0,"binary":false,"changes":82,"status":"added"}]}