{"files":[{"patch":"@@ -38,1 +38,0 @@\n-import javax.crypto.spec.SecretKeySpec;\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/DHasKEM.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -41,1 +41,0 @@\n-import java.security.InvalidParameterException;\n@@ -135,10 +134,2 @@\n-\n-            try {\n-                left.initialize(leftSpec, random);\n-                right.initialize(rightSpec, random);\n-            } catch (InvalidAlgorithmParameterException iape) {\n-                throw iape;\n-            } catch (Exception e) {\n-                throw new ProviderException(\"Failed to initialize hybrid \" +\n-                        \"keypair generator\", e);\n-            }\n+            left.initialize(leftSpec, random);\n+            right.initialize(rightSpec, random);\n@@ -328,8 +319,2 @@\n-            var left = le.encapsulate();\n-            var right = re.encapsulate();\n-            if (from == 0 && to == le.secretSize() + re.secretSize()) {\n-                return new KEM.Encapsulated(\n-                        new SecretKeyImpl(left.key(), right.key()),\n-                        concat(left.encapsulation(), right.encapsulation()),\n-                        null);\n-            } else {\n+            int expectedSecretSize = le.secretSize() + re.secretSize();\n+            if (!(from == 0 && to == expectedSecretSize)) {\n@@ -339,1 +324,1 @@\n-                        (le.secretSize() + re.secretSize()));\n+                        expectedSecretSize);\n@@ -341,0 +326,21 @@\n+\n+            var left  = le.encapsulate();\n+            var right = re.encapsulate();\n+            byte[] leftEnc  = left.encapsulation();\n+            byte[] rightEnc = right.encapsulation();\n+\n+            int expectedEncSize = le.encapsulationSize() +\n+                    re.encapsulationSize();\n+            int actualEncSize = leftEnc.length + rightEnc.length;\n+\n+            if (actualEncSize != expectedEncSize) {\n+                throw new IllegalStateException(\n+                        \"Invalid key encapsulation message length: \" +\n+                        actualEncSize +\n+                        \", expected = \" + expectedEncSize);\n+            }\n+\n+            return new KEM.Encapsulated(\n+                    new SecretKeyImpl(left.key(), right.key()),\n+                    concat(leftEnc, rightEnc),\n+                    null);\n@@ -364,7 +370,13 @@\n-            var left = Arrays.copyOf(encapsulation, ld.encapsulationSize());\n-            var right = Arrays.copyOfRange(encapsulation,\n-                    ld.encapsulationSize(), encapsulation.length);\n-            if (from == 0 && ld.secretSize() + rd.secretSize() == to) {\n-                return new SecretKeyImpl(ld.decapsulate(left),\n-                        rd.decapsulate(right));\n-            } else {\n+            int leftEncSize = ld.encapsulationSize();\n+            int rightEncSize = rd.encapsulationSize();\n+            int expectedEncSize = leftEncSize + rightEncSize;\n+\n+            if (encapsulation.length != expectedEncSize) {\n+                throw new IllegalArgumentException(\n+                        \"Invalid key encapsulation message length: \" +\n+                        encapsulation.length +\n+                        \", expected = \" + expectedEncSize);\n+            }\n+\n+            int expectedSecretSize = ld.secretSize() + rd.secretSize();\n+            if (!(from == 0 && to == expectedSecretSize)) {\n@@ -374,1 +386,1 @@\n-                        (ld.secretSize() + rd.secretSize()));\n+                        expectedSecretSize);\n@@ -376,0 +388,8 @@\n+\n+            var left = Arrays.copyOf(encapsulation, leftEncSize);\n+            var right = Arrays.copyOfRange(encapsulation,\n+                    leftEncSize, encapsulation.length);\n+            return new SecretKeyImpl(\n+                    ld.decapsulate(left),\n+                    rd.decapsulate(right)\n+            );\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/Hybrid.java","additions":48,"deletions":28,"binary":false,"changes":76,"status":"modified"}]}