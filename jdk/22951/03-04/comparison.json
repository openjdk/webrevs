{"files":[{"patch":"@@ -28,16 +28,2 @@\n- * @run main\/manual Password\n- *\/\n-\n-\/*\n- * This test should not be run with JTreg. If it is run using JTreg the test will fail.\n- * Please use the following instructions:\n- *\n- * This scenario cannot be automated because util\/Password.java verifies the given input stream is\n- * equal to the initialSystemIn. This prevents the test from providing a custom input stream.\n- *\n- *  Steps to run the test:\n- *  1) Compile the class using the JDK version being tested: '<JdkBin>\/javac Password.java'\n- *  2) Run the test using the JDK version being tested: '<JdkBin>\/java -cp . Password'\n- *  3) Type in the first password, it should not be visible in the console\n- *  4) Type in the second password, it should be visible in the console\n- *  5) The final output line displays the entered passwords, both should be visible\n+ * @modules java.base\/java.lang:+open\n+ * @run main\/othervm Password\n@@ -47,0 +33,2 @@\n+\n+\n@@ -48,0 +36,5 @@\n+import java.io.*;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.VarHandle;\n+\n+import jdk.test.lib.Asserts;\n@@ -50,1 +43,9 @@\n-   public static void main(String args[]) throws Exception {\n+    private static final String VISIBLE_LINE = \"lineVisible\";\n+\n+    public static void main(String args[]) throws Exception {\n+\n+        InputStream originalInput = System.in;\n+\n+        \/\/ setting the initial input stream from the System class\n+        MethodHandles.Lookup lookup = MethodHandles.privateLookupIn(System.class, MethodHandles.lookup());\n+        VarHandle initialIn = lookup.findStaticVarHandle(System.class, \"initialIn\", InputStream.class);\n@@ -52,4 +53,4 @@\n-        if (System.getProperty(\"java.class.path\").contains(\"jtreg\")){\n-            throw new RuntimeException(\"This test is designated as manual and will fail if run with jtreg. \" +\n-                    \"Please read the instruction\/steps in the file comments before proceeding with manual execution.\");\n-        }\n+        \/\/ setting the input stream and the output stream\n+        ByteArrayInputStream inputStream = (new ByteArrayInputStream((VISIBLE_LINE + \"\\nlineInvisible\\n\").getBytes()));\n+        System.setIn(inputStream);\n+        initialIn.set(inputStream);\n@@ -57,0 +58,1 @@\n+        \/\/ handling the password callbacks, as the input stream is here the invisible should not echo and should be null\n@@ -61,3 +63,3 @@\n-        System.out.println(\"Two passwords will be prompted for. The first one \" +\n-                \"should have echo off, the second one on. Otherwise, this test fails\");\n-        Callback[] callbacks = { nc, nc2 };\n+        System.out.println(\"Two passwords will be prompted for. They will automatically be populated. \" +\n+                \"The invisible password will remain null with this input stream configuration.\");\n+        Callback[] callbacks = {nc, nc2};\n@@ -65,3 +67,9 @@\n-        System.out.println(\"You input \" + new String(nc.getPassword()) +\n-                \" and \" + new String(nc2.getPassword()));\n-   }\n+\n+        \/\/reverting everything back\n+        initialIn.set(originalInput);\n+        System.setIn(originalInput);\n+\n+\n+        Asserts.assertNull(nc.getPassword());\n+        Asserts.assertEquals(VISIBLE_LINE, new String(nc2.getPassword()));\n+    }\n","filename":"test\/jdk\/com\/sun\/security\/auth\/callback\/TextCallbackHandler\/Password.java","additions":35,"deletions":27,"binary":false,"changes":62,"status":"modified"}]}