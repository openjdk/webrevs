{"files":[{"patch":"@@ -1323,1 +1323,0 @@\n-  _cm_thread(nullptr),\n@@ -1567,1 +1566,0 @@\n-  _cm_thread = _cm->cm_thread();\n@@ -1639,1 +1637,3 @@\n-  return _cm_thread->should_terminate();\n+  assert(_cm != nullptr, \"_cm must have been created\");\n+  assert(_cm->is_fully_initialized(), \"thread must exist in order to check if mark is terminating\");\n+  return _cm->cm_thread()->should_terminate();\n@@ -1648,1 +1648,3 @@\n-  _cm_thread->stop();\n+  if (_cm->is_fully_initialized()) {\n+    _cm->cm_thread()->stop();\n+  }\n@@ -1845,1 +1847,1 @@\n-    _cm_thread->set_idle();\n+    _cm->cm_thread()->set_idle();\n@@ -2424,1 +2426,0 @@\n-  tc->do_thread(_cm_thread);\n@@ -2545,2 +2546,2 @@\n-  assert(!_cm_thread->in_progress(), \"Can not start concurrent operation while in progress\");\n-\n+  assert(_cm->is_fully_initialized(), \"sanity\");\n+  assert(!_cm->in_progress(), \"Can not start concurrent operation while in progress\");\n@@ -2550,1 +2551,1 @@\n-    _cm_thread->start_full_mark();\n+    _cm->cm_thread()->start_full_mark();\n@@ -2553,1 +2554,1 @@\n-    _cm_thread->start_undo_mark();\n+    _cm->cm_thread()->start_undo_mark();\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CollectedHeap.cpp","additions":11,"deletions":10,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -828,1 +828,0 @@\n-  G1ConcurrentMarkThread* _cm_thread;\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CollectedHeap.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -476,1 +476,1 @@\n-  \/\/ _cm_thread set inside the constructor\n+  _cm_thread(nullptr),\n@@ -487,1 +487,1 @@\n-  \/\/ _finger set in set_non_marking_state\n+  _finger(nullptr), \/\/ _finger set in set_non_marking_state\n@@ -491,3 +491,2 @@\n-  \/\/ _num_active_tasks set in set_non_marking_state()\n-  \/\/ _tasks set inside the constructor\n-\n+  _num_active_tasks(0), \/\/ _num_active_tasks set in set_non_marking_state()\n+  _tasks(nullptr), \/\/ _tasks set inside late_init()\n@@ -528,0 +527,6 @@\n+}\n+\n+void G1ConcurrentMark::fully_initialize() {\n+  if (is_fully_initialized()) {\n+    return;\n+  }\n@@ -563,0 +568,4 @@\n+bool G1ConcurrentMark::in_progress() const {\n+  return is_fully_initialized() ? _cm_thread->in_progress() : false;\n+}\n+\n@@ -768,1 +777,1 @@\n-        assert(!suspendible() || _cm->cm_thread()->in_progress(), \"invariant\");\n+        assert(!suspendible() || _cm->in_progress(), \"invariant\");\n@@ -824,1 +833,2 @@\n-  guarantee(cm_thread()->in_progress(), \"invariant\");\n+  guarantee(is_fully_initialized(), \"should be initializd\");\n+  guarantee(in_progress(), \"invariant\");\n@@ -837,1 +847,2 @@\n-  guarantee(cm_thread()->in_progress(), \"invariant\");\n+  guarantee(is_fully_initialized(), \"should be initializd\");\n+  guarantee(in_progress(), \"invariant\");\n@@ -1928,1 +1939,2 @@\n-  if (!cm_thread()->in_progress() && !_g1h->concurrent_mark_is_terminating()) {\n+\n+  if (!is_fully_initialized() || (!cm_thread()->in_progress() && !_g1h->concurrent_mark_is_terminating())) {\n@@ -1990,0 +2002,4 @@\n+  if (!is_fully_initialized()) {\n+    log.trace(\"    has not been initialized yet\");\n+    return;\n+  }\n@@ -2006,1 +2022,4 @@\n-  _concurrent_workers->threads_do(tc);\n+  if (is_fully_initialized()) { \/\/ they are initialized late\n+    tc->do_thread(_cm_thread);\n+    _concurrent_workers->threads_do(tc);\n+  }\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentMark.cpp","additions":29,"deletions":10,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -558,0 +558,3 @@\n+  void fully_initialize();\n+  bool is_fully_initialized() const { return _cm_thread != nullptr; }\n+  bool in_progress() const;\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentMark.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -42,1 +42,1 @@\n-  if (g1h->concurrent_mark()->cm_thread()->in_progress()) {\n+  if (g1h->concurrent_mark()->in_progress()) {\n","filename":"src\/hotspot\/share\/gc\/g1\/g1PeriodicGCTask.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -742,1 +742,1 @@\n-  return _g1h->concurrent_mark()->cm_thread()->in_progress() || collector_state()->in_young_gc_before_mixed();\n+  return _g1h->concurrent_mark()->in_progress() || collector_state()->in_young_gc_before_mixed();\n@@ -1238,1 +1238,1 @@\n-  bool during_cycle = _g1h->concurrent_mark()->cm_thread()->in_progress();\n+  bool during_cycle = _g1h->concurrent_mark()->in_progress();\n","filename":"src\/hotspot\/share\/gc\/g1\/g1Policy.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+  _cache(NEW_C_HEAP_ARRAY(G1RegionMarkStatsCacheEntry, num_cache_entries, mtGC)),\n@@ -37,1 +38,0 @@\n-  _cache = NEW_C_HEAP_ARRAY(G1RegionMarkStatsCacheEntry, _num_cache_entries, mtGC);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1RegionMarkStatsCache.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -88,1 +88,1 @@\n-  _cycle_already_in_progress = g1h->concurrent_mark()->cm_thread()->in_progress();\n+  _cycle_already_in_progress = g1h->concurrent_mark()->in_progress();\n","filename":"src\/hotspot\/share\/gc\/g1\/g1VMOperations.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1128,0 +1128,1 @@\n+  _g1h->_cm->fully_initialize();\n","filename":"src\/hotspot\/share\/gc\/g1\/g1YoungCollector.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -581,1 +581,1 @@\n-    return g1h->concurrent_mark()->cm_thread()->in_progress();\n+    return g1h->concurrent_mark()->in_progress();\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}