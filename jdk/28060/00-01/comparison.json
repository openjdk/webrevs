{"files":[{"patch":"@@ -117,1 +117,1 @@\n-  NOT_PRODUCT(if (C->igv_printer()) C->igv_printer()->set_congraph(congraph);)\n+  NOT_PRODUCT(if (C->igv_printer() != nullptr) C->igv_printer()->set_congraph(congraph);)\n@@ -123,1 +123,1 @@\n-  NOT_PRODUCT(if (C->igv_printer()) C->igv_printer()->set_congraph(nullptr);)\n+  NOT_PRODUCT(if (C->igv_printer() != nullptr) C->igv_printer()->set_congraph(nullptr);)\n@@ -323,1 +323,1 @@\n-    _compile->print_method(PHASE_EA_ADJUST_SCALAR_REPLACEABLE_ITER, 6);\n+    _compile->print_method(PHASE_EA_ADJUST_SCALAR_REPLACEABLE_ITER, 6, n);\n@@ -1320,1 +1320,1 @@\n-  _compile->print_method(PHASE_EA_BEFORE_PHI_REDUCTION, 5);\n+  _compile->print_method(PHASE_EA_BEFORE_PHI_REDUCTION, 5, ophi);\n@@ -1327,1 +1327,1 @@\n-    _compile->print_method(PHASE_EA_AFTER_PHI_CASTPP_REDUCTION, 6);\n+    _compile->print_method(PHASE_EA_AFTER_PHI_CASTPP_REDUCTION, 6, castpps.at(i));\n@@ -1335,0 +1335,1 @@\n+      _compile->print_method(PHASE_EA_AFTER_PHI_ADDPP_REDUCTION, 6, use);\n@@ -1337,0 +1338,1 @@\n+      _compile->print_method(PHASE_EA_AFTER_PHI_CMP_REDUCTION, 6, use);\n@@ -1339,1 +1341,0 @@\n-    _compile->print_method(PHASE_EA_AFTER_PHI_ADDPP_CMP_REDUCTION, 6);\n@@ -2576,1 +2577,1 @@\n-        _compile->print_method(PHASE_EA_CONNECTION_GRAPH_PROPAGATE_ITER, 6);\n+        _compile->print_method(PHASE_EA_CONNECTION_GRAPH_PROPAGATE_ITER, 6, e->ideal_node());\n@@ -3153,1 +3154,0 @@\n-              _compile->print_method(PHASE_EA_PROPAGATE_NSR_ITER, 5);\n@@ -3166,0 +3166,1 @@\n+        _compile->print_method(PHASE_EA_PROPAGATE_NSR_ITER, 5, jobj->ideal_node());\n@@ -5044,0 +5045,4 @@\n+const char* PointsToNode::esc_name() const {\n+  return esc_names[(int)escape_state()];\n+}\n+\n@@ -5204,0 +5209,1 @@\n+\n","filename":"src\/hotspot\/share\/opto\/escape.cpp","additions":14,"deletions":8,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -239,0 +239,1 @@\n+  const char* esc_name() const;\n","filename":"src\/hotspot\/share\/opto\/escape.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -645,9 +645,9 @@\n-       if (alloc->_is_scalar_replaceable) {\n-         print_prop(\"is_scalar_replaceable\", \"true\");\n-       }\n-       if (alloc->_is_non_escaping) {\n-         print_prop(\"is_non_escaping\", \"true\");\n-       }\n-       if (alloc->does_not_escape_thread()) {\n-         print_prop(\"does_not_escape_thread\", \"true\");\n-       }\n+      if (alloc->_is_scalar_replaceable) {\n+        print_prop(\"is_scalar_replaceable\", \"true\");\n+      }\n+      if (alloc->_is_non_escaping) {\n+        print_prop(\"is_non_escaping\", \"true\");\n+      }\n+      if (alloc->does_not_escape_thread()) {\n+        print_prop(\"does_not_escape_thread\", \"true\");\n+      }\n@@ -761,10 +761,8 @@\n-      if (ptn) {\n-        print_prop(\"ea_node\", ptn->is_JavaObject() ? \"javaobject\" :\n-                              ptn->is_LocalVar() ? \"localvar\" :\n-                              ptn->is_Field() ? \"field\" :\n-                              \"\");\n-        print_prop(\"escape\", ptn->escape_state() == PointsToNode::EscapeState::NoEscape ? \"no_escape\" :\n-                             ptn->escape_state() == PointsToNode::EscapeState::ArgEscape ? \"arg_escape\" :\n-                             ptn->escape_state() == PointsToNode::EscapeState::GlobalEscape ? \"global_escape\" :\n-                             \"\");\n-        print_prop(\"replaceable\", ptn->scalar_replaceable() ? \"true\" : \"\");\n+      if (ptn != nullptr) {\n+        stringStream node_head;\n+        ptn->dump_header(false, &node_head);\n+        print_prop(\"ea_node\", node_head.freeze());\n+        print_prop(\"escape_state\", ptn->esc_name());\n+        if (ptn->scalar_replaceable()) {\n+          print_prop(\"scalar_replaceable\", \"true\");\n+        }\n","filename":"src\/hotspot\/share\/opto\/idealGraphPrinter.cpp","additions":17,"deletions":19,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -68,1 +68,2 @@\n-  flags(EA_AFTER_PHI_ADDPP_CMP_REDUCTION,   \"EA: 5. Phi -> AddPP\/Cmp Reduction\") \\\n+  flags(EA_AFTER_PHI_ADDPP_REDUCTION,       \"EA: 5. Phi -> AddPP Reduction\") \\\n+  flags(EA_AFTER_PHI_CMP_REDUCTION,         \"EA: 5. Phi -> Cmp Reduction\") \\\n","filename":"src\/hotspot\/share\/opto\/phasetype.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1,1 +1,2 @@\n-\/\/ Color allocation nodes to indicate the result of scape analysis.\n+\/\/ Color those nodes present in the escape analysis connection graph\n+\/\/ to indicate the result of scape analysis.\n@@ -10,0 +11,2 @@\n+\/\/ Apply first colors based on persistent node attributes\n+\n@@ -14,3 +17,0 @@\n-colorize(and([matches(\"escape\", \"no_escape\"),\n-              hasProperty(\"replaceable\")]),\n-         bestColor);\n@@ -23,3 +23,0 @@\n-colorize(and([matches(\"escape\", \"no_escape\"),\n-              not(hasProperty(\"replaceable\"))]),\n-         betterColor);\n@@ -32,3 +29,0 @@\n-colorize(and([matches(\"escape\", \"arg_escape\"),\n-              not(hasProperty(\"replaceable\"))]),\n-         worseColor);\n@@ -41,2 +35,16 @@\n-colorize(and([matches(\"escape\", \"global_escape\"),\n-              not(hasProperty(\"replaceable\"))]),\n+\n+\/\/ Apply colors again based on connection graph-derived attributes\n+\n+colorize(and([matches(\"escape_state\", \"NoEscape\"),\n+              hasProperty(\"scalar_replaceable\")]),\n+         bestColor);\n+\n+colorize(and([matches(\"escape_state\", \"NoEscape\"),\n+              not(hasProperty(\"scalar_replaceable\"))]),\n+         betterColor);\n+\n+colorize(and([matches(\"escape_state\", \"ArgEscape\"),\n+              not(hasProperty(\"scalar_replaceable\"))]),\n+         worseColor);\n+\n+colorize(matches(\"escape_state\", \"GlobalEscape\"),\n","filename":"src\/utils\/IdealGraphVisualizer\/ServerCompiler\/src\/main\/resources\/com\/sun\/hotspot\/igv\/servercompiler\/filters\/colorEscapeAnalysis.filter","additions":20,"deletions":12,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -0,0 +1,6 @@\n+\/\/ This filter shows only the nodes that are present in the escape analysis\n+\/\/ connection graph. This can be used to visualize the connection graph inside\n+\/\/ IGV.\n+\/\/ This filter is only relevant during the escape analysis phases.\n+\n+remove(not(hasProperty(\"ea_node\")));\n","filename":"src\/utils\/IdealGraphVisualizer\/ServerCompiler\/src\/main\/resources\/com\/sun\/hotspot\/igv\/servercompiler\/filters\/showConnectionGraphNodesOnly.filter","additions":6,"deletions":0,"binary":false,"changes":6,"status":"added"},{"patch":"@@ -0,0 +1,16 @@\n+\/\/ This filter appends escape analysis connection graph node information to the\n+\/\/ (possibly already existing) extra-label line.\n+\/\/ This is only carried out for those nodes that are relevant to escape\n+\/\/ analysis (and therefore represented in the connection graph).\n+\n+\/\/ Merge a possibly existing extra label with the escape analysis node type into a\n+\/\/ new, single extra label.\n+function mergeAndAppendTypeInfo(extra_label, ea_node) {\n+  new_extra_label = extra_label == null ? \"\" : (extra_label + \" \");\n+  return new_extra_label + ea_node;\n+}\n+\n+editProperty(hasProperty(\"ea_node\"),\n+             [\"extra_label\", \"ea_node\"],\n+             \"extra_label\",\n+             function(propertyValues) {return mergeAndAppendTypeInfo(propertyValues[0], propertyValues[1]);});\n","filename":"src\/utils\/IdealGraphVisualizer\/ServerCompiler\/src\/main\/resources\/com\/sun\/hotspot\/igv\/servercompiler\/filters\/showConnectionInfo.filter","additions":16,"deletions":0,"binary":false,"changes":16,"status":"added"},{"patch":"@@ -1,20 +0,0 @@\n-\/\/ This filter appends simplified type information to the (possibly already\n-\/\/ existing) extra-label line.\n-\/\/ If the phase type is available, show it. If the bottom type is available and\n-\/\/ differs from the bottom type, show it too (prefixed with 'B:').\n-\n-\/\/ Merge a possibly existing extra label, bottom type, and phase type into a\n-\/\/ new, single extra label. For memory nodes, add an extra label with the memory\n-\/\/ slice, extracted from the dump_spec field.\n-function mergeAndAppendTypeInfo(extra_label, ea_node) {\n-  new_extra_label = extra_label == null ? \"\" : (extra_label + \" \");\n-  return new_extra_label + ea_node;\n-}\n-\n-editProperty(or([matches(\"ea_node\", \"javaobject\"),\n-                 matches(\"ea_node\", \"localvar\"),\n-                 matches(\"ea_node\", \"field\")]),\n-             [\"extra_label\", \"ea_node\"],\n-             \"extra_label\",\n-             function(propertyValues) {return mergeAndAppendTypeInfo(propertyValues[0], propertyValues[1]);});\n-\n","filename":"src\/utils\/IdealGraphVisualizer\/ServerCompiler\/src\/main\/resources\/com\/sun\/hotspot\/igv\/servercompiler\/filters\/showConnectionNodes.filter","additions":0,"deletions":20,"binary":false,"changes":20,"status":"deleted"},{"patch":"@@ -24,4 +24,0 @@\n-        <file name=\"Show connection graph nodes.js\" url=\"filters\/showConnectionNodes.filter\">\n-            <attr name=\"enabled\" boolvalue=\"false\"\/>\n-            <attr name=\"after\" stringvalue=\"Show connection node types\"\/>\n-        <\/file>\n@@ -92,0 +88,8 @@\n+        <file name=\"Show connection graph info.js\" url=\"filters\/showConnectionInfo.filter\">\n+            <attr name=\"enabled\" boolvalue=\"false\"\/>\n+            <attr name=\"after\" stringvalue=\"Hide exception blocks\"\/>\n+        <\/file>\n+        <file name=\"Show connection graph nodes only.js\" url=\"filters\/showConnectionGraphNodesOnly.filter\">\n+            <attr name=\"enabled\" boolvalue=\"false\"\/>\n+            <attr name=\"after\" stringvalue=\"Show connection graph info\"\/>\n+        <\/file>\n@@ -94,1 +98,1 @@\n-            <attr name=\"after\" stringvalue=\"Color by escape analysis state\"\/>\n+            <attr name=\"after\" stringvalue=\"Show connection graph nodes only\"\/>\n@@ -98,1 +102,1 @@\n-            <attr name=\"after\" stringvalue=\"Hide exception blocks\"\/>\n+            <attr name=\"after\" stringvalue=\"Color by escape analysis state\"\/>\n","filename":"src\/utils\/IdealGraphVisualizer\/ServerCompiler\/src\/main\/resources\/com\/sun\/hotspot\/igv\/servercompiler\/layer.xml","additions":10,"deletions":6,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -63,0 +63,17 @@\n+    EA_AFTER_INITIAL_CONGRAPH(         \"EA: 1. Intial Connection Graph\"),\n+    EA_CONNECTION_GRAPH_PROPAGATE_ITER(\"EA: 2. Connection Graph Propagate Iter\"),\n+    EA_COMPLETE_CONNECTION_GRAPH_ITER( \"EA: 2. Complete Connection Graph Iter\"),\n+    EA_AFTER_COMPLETE_CONGRAPH(        \"EA: 2. Complete Connection Graph\"),\n+    EA_ADJUST_SCALAR_REPLACEABLE_ITER( \"EA: 3. Adjust scalar_replaceable State Iter\"),\n+    EA_PROPAGATE_NSR_ITER(             \"EA: 3. Propagate NSR Iter\"),\n+    EA_AFTER_PROPAGATE_NSR(            \"EA: 3. Propagate NSR\"),\n+    EA_AFTER_GRAPH_OPTIMIZATION(       \"EA: 4. After Graph Optimization\"),\n+    EA_AFTER_SPLIT_UNIQUE_TYPES_1(     \"EA: 5. After split_unique_types Phase 1\"),\n+    EA_AFTER_SPLIT_UNIQUE_TYPES_3(     \"EA: 5. After split_unique_types Phase 3\"),\n+    EA_AFTER_SPLIT_UNIQUE_TYPES_4(     \"EA: 5. After split_unique_types Phase 4\"),\n+    EA_AFTER_SPLIT_UNIQUE_TYPES(       \"EA: 5. After split_unique_types\"),\n+    EA_AFTER_REDUCE_PHI_ON_SAFEPOINTS( \"EA: 6. After reduce_phi_on_safepoints\"),\n+    EA_BEFORE_PHI_REDUCTION(           \"EA: 5. Before Phi Reduction\"),\n+    EA_AFTER_PHI_CASTPP_REDUCTION(     \"EA: 5. Phi -> CastPP Reduction\"),\n+    EA_AFTER_PHI_ADDPP_REDUCTION(      \"EA: 5. Phi -> AddPP Reduction\"),\n+    EA_AFTER_PHI_CMP_REDUCTION(        \"EA: 5. Phi -> Cmp Reduction\"),\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/CompilePhase.java","additions":17,"deletions":0,"binary":false,"changes":17,"status":"modified"}]}