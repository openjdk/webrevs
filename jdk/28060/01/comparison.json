{"files":[{"patch":"@@ -117,0 +117,1 @@\n+  NOT_PRODUCT(if (C->igv_printer() != nullptr) C->igv_printer()->set_congraph(congraph);)\n@@ -122,0 +123,1 @@\n+  NOT_PRODUCT(if (C->igv_printer() != nullptr) C->igv_printer()->set_congraph(nullptr);)\n@@ -129,0 +131,2 @@\n+\n+  C->print_method(PHASE_AFTER_EA, 2);\n@@ -284,0 +288,2 @@\n+  _compile->print_method(PHASE_EA_AFTER_INITIAL_CONGRAPH, 4);\n+\n@@ -294,0 +300,2 @@\n+  _compile->print_method(PHASE_EA_AFTER_COMPLETE_CONGRAPH, 4);\n+\n@@ -315,0 +323,1 @@\n+    _compile->print_method(PHASE_EA_ADJUST_SCALAR_REPLACEABLE_ITER, 6, n);\n@@ -353,0 +362,1 @@\n+  _compile->print_method(PHASE_EA_AFTER_PROPAGATE_NSR, 4);\n@@ -390,0 +400,2 @@\n+  _compile->print_method(PHASE_EA_AFTER_GRAPH_OPTIMIZATION, 4);\n+\n@@ -401,1 +413,0 @@\n-    C->print_method(PHASE_AFTER_EA, 2);\n@@ -416,0 +427,2 @@\n+  _compile->print_method(PHASE_EA_AFTER_SPLIT_UNIQUE_TYPES, 4);\n+\n@@ -457,0 +470,2 @@\n+  _compile->print_method(PHASE_EA_AFTER_REDUCE_PHI_ON_SAFEPOINTS, 4);\n+\n@@ -1305,0 +1320,2 @@\n+  _compile->print_method(PHASE_EA_BEFORE_PHI_REDUCTION, 5, ophi);\n+\n@@ -1310,0 +1327,1 @@\n+    _compile->print_method(PHASE_EA_AFTER_PHI_CASTPP_REDUCTION, 6, castpps.at(i));\n@@ -1317,0 +1335,1 @@\n+      _compile->print_method(PHASE_EA_AFTER_PHI_ADDPP_REDUCTION, 6, use);\n@@ -1319,0 +1338,1 @@\n+      _compile->print_method(PHASE_EA_AFTER_PHI_CMP_REDUCTION, 6, use);\n@@ -1320,0 +1340,1 @@\n+\n@@ -2420,0 +2441,1 @@\n+      _compile->print_method(PHASE_EA_COMPLETE_CONNECTION_GRAPH_ITER, 5);\n@@ -2493,1 +2515,2 @@\n-                                               GrowableArray<JavaObjectNode*>& non_escaped_allocs_worklist) {\n+                                               GrowableArray<JavaObjectNode*>& non_escaped_allocs_worklist,\n+                                               bool verify) {\n@@ -2553,0 +2576,3 @@\n+      if (!verify) {\n+        _compile->print_method(PHASE_EA_CONNECTION_GRAPH_PROPAGATE_ITER, 6, e->ideal_node());\n+      }\n@@ -3140,0 +3166,1 @@\n+        _compile->print_method(PHASE_EA_PROPAGATE_NSR_ITER, 5, jobj->ideal_node());\n@@ -3162,1 +3189,1 @@\n-  find_non_escaped_objects(ptnodes_worklist, non_escaped_allocs_worklist);\n+  find_non_escaped_objects(ptnodes_worklist, non_escaped_allocs_worklist, \/*verify=*\/ true);\n@@ -4723,0 +4750,2 @@\n+  _compile->print_method(PHASE_EA_AFTER_SPLIT_UNIQUE_TYPES_1, 5);\n+\n@@ -4923,0 +4952,2 @@\n+  _compile->print_method(PHASE_EA_AFTER_SPLIT_UNIQUE_TYPES_3, 5);\n+\n@@ -4991,0 +5022,1 @@\n+  _compile->print_method(PHASE_EA_AFTER_SPLIT_UNIQUE_TYPES_4, 5);\n@@ -5013,0 +5045,4 @@\n+const char* PointsToNode::esc_name() const {\n+  return esc_names[(int)escape_state()];\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/escape.cpp","additions":39,"deletions":3,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"opto\/idealGraphPrinter.hpp\"\n@@ -238,0 +239,1 @@\n+  const char* esc_name() const;\n@@ -324,0 +326,1 @@\n+  friend class IdealGraphPrinter;\n@@ -470,1 +473,2 @@\n-                                GrowableArray<JavaObjectNode*>& non_escaped_worklist);\n+                                GrowableArray<JavaObjectNode*>& non_escaped_worklist,\n+                                bool verify = false);\n","filename":"src\/hotspot\/share\/opto\/escape.hpp","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+#include \"opto\/escape.hpp\"\n@@ -164,0 +165,1 @@\n+  _congraph = nullptr;\n@@ -640,0 +642,23 @@\n+    \/\/ Dump escape analysis state for relevant nodes.\n+    if (node->is_Allocate()) {\n+      AllocateNode* alloc = node->as_Allocate();\n+      if (alloc->_is_scalar_replaceable) {\n+        print_prop(\"is_scalar_replaceable\", \"true\");\n+      }\n+      if (alloc->_is_non_escaping) {\n+        print_prop(\"is_non_escaping\", \"true\");\n+      }\n+      if (alloc->does_not_escape_thread()) {\n+        print_prop(\"does_not_escape_thread\", \"true\");\n+      }\n+    }\n+    if (node->is_SafePoint() && node->as_SafePoint()->has_ea_local_in_scope()) {\n+      print_prop(\"has_ea_local_in_scope\", \"true\");\n+    }\n+    if (node->is_CallJava() && node->as_CallJava()->arg_escape()) {\n+      print_prop(\"arg_escape\", \"true\");\n+    }\n+    if (node->is_Initialize() && node->as_Initialize()->does_not_escape()) {\n+      print_prop(\"does_not_escape\", \"true\");\n+    }\n+\n@@ -734,0 +759,13 @@\n+    if (_congraph && node->_idx < _congraph->nodes_size()) {\n+      PointsToNode* ptn = _congraph->ptnode_adr(node->_idx);\n+      if (ptn != nullptr) {\n+        stringStream node_head;\n+        ptn->dump_header(false, &node_head);\n+        print_prop(\"ea_node\", node_head.freeze());\n+        print_prop(\"escape_state\", ptn->esc_name());\n+        if (ptn->scalar_replaceable()) {\n+          print_prop(\"scalar_replaceable\", \"true\");\n+        }\n+      }\n+    }\n+\n","filename":"src\/hotspot\/share\/opto\/idealGraphPrinter.cpp","additions":38,"deletions":0,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -45,0 +45,1 @@\n+class ConnectionGraph;\n@@ -119,0 +120,1 @@\n+  ConnectionGraph* _congraph;\n@@ -168,0 +170,1 @@\n+  void set_congraph(ConnectionGraph* congraph) { _congraph = congraph; }\n","filename":"src\/hotspot\/share\/opto\/idealGraphPrinter.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -53,0 +53,17 @@\n+  flags(EA_AFTER_INITIAL_CONGRAPH,          \"EA: 1. Intial Connection Graph\") \\\n+  flags(EA_CONNECTION_GRAPH_PROPAGATE_ITER, \"EA: 2. Connection Graph Propagate Iter\") \\\n+  flags(EA_COMPLETE_CONNECTION_GRAPH_ITER,  \"EA: 2. Complete Connection Graph Iter\") \\\n+  flags(EA_AFTER_COMPLETE_CONGRAPH,         \"EA: 2. Complete Connection Graph\") \\\n+  flags(EA_ADJUST_SCALAR_REPLACEABLE_ITER,  \"EA: 3. Adjust scalar_replaceable State Iter\") \\\n+  flags(EA_PROPAGATE_NSR_ITER,              \"EA: 3. Propagate NSR Iter\") \\\n+  flags(EA_AFTER_PROPAGATE_NSR,             \"EA: 3. Propagate NSR\") \\\n+  flags(EA_AFTER_GRAPH_OPTIMIZATION,        \"EA: 4. After Graph Optimization\") \\\n+  flags(EA_AFTER_SPLIT_UNIQUE_TYPES_1,      \"EA: 5. After split_unique_types Phase 1\") \\\n+  flags(EA_AFTER_SPLIT_UNIQUE_TYPES_3,      \"EA: 5. After split_unique_types Phase 3\") \\\n+  flags(EA_AFTER_SPLIT_UNIQUE_TYPES_4,      \"EA: 5. After split_unique_types Phase 4\") \\\n+  flags(EA_AFTER_SPLIT_UNIQUE_TYPES,        \"EA: 5. After split_unique_types\") \\\n+  flags(EA_AFTER_REDUCE_PHI_ON_SAFEPOINTS,  \"EA: 6. After reduce_phi_on_safepoints\") \\\n+  flags(EA_BEFORE_PHI_REDUCTION,            \"EA: 5. Before Phi Reduction\") \\\n+  flags(EA_AFTER_PHI_CASTPP_REDUCTION,      \"EA: 5. Phi -> CastPP Reduction\") \\\n+  flags(EA_AFTER_PHI_ADDPP_REDUCTION,       \"EA: 5. Phi -> AddPP Reduction\") \\\n+  flags(EA_AFTER_PHI_CMP_REDUCTION,         \"EA: 5. Phi -> Cmp Reduction\") \\\n","filename":"src\/hotspot\/share\/opto\/phasetype.hpp","additions":17,"deletions":0,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -0,0 +1,51 @@\n+\/\/ Color those nodes present in the escape analysis connection graph\n+\/\/ to indicate the result of scape analysis.\n+\/\/ This filter is relevant between the first EA phase and \"After Macro\n+\/\/ Expansion\".\n+\n+var bestColor   = java.awt.Color.decode(\"#6aa84f\"); \/\/ Green.\n+var betterColor = java.awt.Color.decode(\"#f1c232\"); \/\/ Yellow.\n+var worseColor  = java.awt.Color.decode(\"#e69138\"); \/\/ Orange.\n+var worstColor  = java.awt.Color.decode(\"#cc0000\"); \/\/ Red.\n+\n+\/\/ Apply first colors based on persistent node attributes\n+\n+\/\/ Object does not escape compilation unit and is scalar replaceable.\n+colorize(and([hasProperty(\"is_non_escaping\"),\n+              hasProperty(\"is_scalar_replaceable\")]),\n+         bestColor);\n+\n+\/\/ Object does not escape compilation unit but is not scalar replaceable,\n+\/\/ due to of scalar replacement limitations. We can at least elide locks.\n+colorize(and([hasProperty(\"is_non_escaping\"),\n+              not(hasProperty(\"is_scalar_replaceable\"))]),\n+         betterColor);\n+\n+\/\/ Object may escape compilation unit but does not escape thread.\n+\/\/ We can at least elide locks.\n+colorize(and([hasProperty(\"does_not_escape_thread\"),\n+              not(hasProperty(\"is_non_escaping\"))]),\n+         worseColor);\n+\n+\/\/ Object may escape compilation unit and thread. Nothing to do.\n+colorize(and([matches(\"name\", \"Allocate\"),\n+              not(hasProperty(\"is_non_escaping\")),\n+              not(hasProperty(\"does_not_escape_thread\"))]),\n+         worstColor);\n+\n+\/\/ Apply colors again based on connection graph-derived attributes\n+\n+colorize(and([matches(\"escape_state\", \"NoEscape\"),\n+              hasProperty(\"scalar_replaceable\")]),\n+         bestColor);\n+\n+colorize(and([matches(\"escape_state\", \"NoEscape\"),\n+              not(hasProperty(\"scalar_replaceable\"))]),\n+         betterColor);\n+\n+colorize(and([matches(\"escape_state\", \"ArgEscape\"),\n+              not(hasProperty(\"scalar_replaceable\"))]),\n+         worseColor);\n+\n+colorize(matches(\"escape_state\", \"GlobalEscape\"),\n+         worstColor);\n","filename":"src\/utils\/IdealGraphVisualizer\/ServerCompiler\/src\/main\/resources\/com\/sun\/hotspot\/igv\/servercompiler\/filters\/colorEscapeAnalysis.filter","additions":51,"deletions":0,"binary":false,"changes":51,"status":"added"},{"patch":"@@ -0,0 +1,6 @@\n+\/\/ This filter shows only the nodes that are present in the escape analysis\n+\/\/ connection graph. This can be used to visualize the connection graph inside\n+\/\/ IGV.\n+\/\/ This filter is only relevant during the escape analysis phases.\n+\n+remove(not(hasProperty(\"ea_node\")));\n","filename":"src\/utils\/IdealGraphVisualizer\/ServerCompiler\/src\/main\/resources\/com\/sun\/hotspot\/igv\/servercompiler\/filters\/showConnectionGraphNodesOnly.filter","additions":6,"deletions":0,"binary":false,"changes":6,"status":"added"},{"patch":"@@ -0,0 +1,16 @@\n+\/\/ This filter appends escape analysis connection graph node information to the\n+\/\/ (possibly already existing) extra-label line.\n+\/\/ This is only carried out for those nodes that are relevant to escape\n+\/\/ analysis (and therefore represented in the connection graph).\n+\n+\/\/ Merge a possibly existing extra label with the escape analysis node type into a\n+\/\/ new, single extra label.\n+function mergeAndAppendTypeInfo(extra_label, ea_node) {\n+  new_extra_label = extra_label == null ? \"\" : (extra_label + \" \");\n+  return new_extra_label + ea_node;\n+}\n+\n+editProperty(hasProperty(\"ea_node\"),\n+             [\"extra_label\", \"ea_node\"],\n+             \"extra_label\",\n+             function(propertyValues) {return mergeAndAppendTypeInfo(propertyValues[0], propertyValues[1]);});\n","filename":"src\/utils\/IdealGraphVisualizer\/ServerCompiler\/src\/main\/resources\/com\/sun\/hotspot\/igv\/servercompiler\/filters\/showConnectionInfo.filter","additions":16,"deletions":0,"binary":false,"changes":16,"status":"added"},{"patch":"@@ -88,0 +88,12 @@\n+        <file name=\"Show connection graph info.js\" url=\"filters\/showConnectionInfo.filter\">\n+            <attr name=\"enabled\" boolvalue=\"false\"\/>\n+            <attr name=\"after\" stringvalue=\"Hide exception blocks\"\/>\n+        <\/file>\n+        <file name=\"Show connection graph nodes only.js\" url=\"filters\/showConnectionGraphNodesOnly.filter\">\n+            <attr name=\"enabled\" boolvalue=\"false\"\/>\n+            <attr name=\"after\" stringvalue=\"Show connection graph info\"\/>\n+        <\/file>\n+        <file name=\"Color by escape analysis state.js\" url=\"filters\/colorEscapeAnalysis.filter\">\n+            <attr name=\"enabled\" boolvalue=\"false\"\/>\n+            <attr name=\"after\" stringvalue=\"Show connection graph nodes only\"\/>\n+        <\/file>\n@@ -90,1 +102,1 @@\n-            <attr name=\"after\" stringvalue=\"Hide exception blocks\"\/>\n+            <attr name=\"after\" stringvalue=\"Color by escape analysis state\"\/>\n","filename":"src\/utils\/IdealGraphVisualizer\/ServerCompiler\/src\/main\/resources\/com\/sun\/hotspot\/igv\/servercompiler\/layer.xml","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -63,0 +63,17 @@\n+    EA_AFTER_INITIAL_CONGRAPH(         \"EA: 1. Intial Connection Graph\"),\n+    EA_CONNECTION_GRAPH_PROPAGATE_ITER(\"EA: 2. Connection Graph Propagate Iter\"),\n+    EA_COMPLETE_CONNECTION_GRAPH_ITER( \"EA: 2. Complete Connection Graph Iter\"),\n+    EA_AFTER_COMPLETE_CONGRAPH(        \"EA: 2. Complete Connection Graph\"),\n+    EA_ADJUST_SCALAR_REPLACEABLE_ITER( \"EA: 3. Adjust scalar_replaceable State Iter\"),\n+    EA_PROPAGATE_NSR_ITER(             \"EA: 3. Propagate NSR Iter\"),\n+    EA_AFTER_PROPAGATE_NSR(            \"EA: 3. Propagate NSR\"),\n+    EA_AFTER_GRAPH_OPTIMIZATION(       \"EA: 4. After Graph Optimization\"),\n+    EA_AFTER_SPLIT_UNIQUE_TYPES_1(     \"EA: 5. After split_unique_types Phase 1\"),\n+    EA_AFTER_SPLIT_UNIQUE_TYPES_3(     \"EA: 5. After split_unique_types Phase 3\"),\n+    EA_AFTER_SPLIT_UNIQUE_TYPES_4(     \"EA: 5. After split_unique_types Phase 4\"),\n+    EA_AFTER_SPLIT_UNIQUE_TYPES(       \"EA: 5. After split_unique_types\"),\n+    EA_AFTER_REDUCE_PHI_ON_SAFEPOINTS( \"EA: 6. After reduce_phi_on_safepoints\"),\n+    EA_BEFORE_PHI_REDUCTION(           \"EA: 5. Before Phi Reduction\"),\n+    EA_AFTER_PHI_CASTPP_REDUCTION(     \"EA: 5. Phi -> CastPP Reduction\"),\n+    EA_AFTER_PHI_ADDPP_REDUCTION(      \"EA: 5. Phi -> AddPP Reduction\"),\n+    EA_AFTER_PHI_CMP_REDUCTION(        \"EA: 5. Phi -> Cmp Reduction\"),\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/CompilePhase.java","additions":17,"deletions":0,"binary":false,"changes":17,"status":"modified"}]}