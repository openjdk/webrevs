{"files":[{"patch":"@@ -289,1 +289,28 @@\n-    private static final String SHA512TRUNCATED = \"SHA512\/2\";\n+    \/\/ for special handling SHA-512\/224, SHA-512\/256, SHA512\/224, SHA512\/256\n+    private static final String SHA512TRUNCATED = \"512\/2\";\n+\n+    static int indexOfRealSlash(String s, int fromIndex) {\n+        while (true) {\n+            int pos = s.indexOf('\/', fromIndex);\n+            \/\/ 512\/2\n+            if (pos > 3 && pos + 1 < s.length()\n+                    && s.charAt(pos - 3) == '5'\n+                    && s.charAt(pos - 2) == '1'\n+                    && s.charAt(pos - 1) == '2'\n+                    && s.charAt(pos + 1) == '2') {\n+                fromIndex = pos + 1;\n+                \/\/ see 512\/2, find next\n+            } else {\n+                return pos;\n+            }\n+        }\n+    }\n+\n+    static String reqNonEmpty(String in, String msg)\n+            throws NoSuchAlgorithmException {\n+        in = in.trim();\n+        if (in.isEmpty()) {\n+            throw new NoSuchAlgorithmException(msg);\n+        }\n+        return in;\n+    }\n@@ -308,16 +335,15 @@\n-\n-        \/\/ check if the transformation contains algorithms with \"\/\" in their\n-        \/\/ name which can cause the parsing logic to go wrong\n-        int sha512Idx = transformation.toUpperCase(Locale.ENGLISH)\n-                .indexOf(SHA512TRUNCATED);\n-        int startIdx = (sha512Idx == -1 ? 0 :\n-                sha512Idx + SHA512TRUNCATED.length());\n-        int endIdx = transformation.indexOf('\/', startIdx);\n-\n-        boolean algorithmOnly = (endIdx == -1);\n-        String algo = (algorithmOnly ? transformation.trim() :\n-                transformation.substring(0, endIdx).trim());\n-        if (algo.isEmpty()) {\n-            throw new NoSuchAlgorithmException(\"Invalid transformation: \" +\n-                                   \"algorithm not specified-\"\n-                                   + transformation);\n+        int endIdx = indexOfRealSlash(transformation, 0);\n+        if (endIdx == -1) { \/\/ algo only, done\n+            return new String[] { reqNonEmpty(transformation,\n+                        \"Invalid transformation: algorithm not specified\")\n+            };\n+        }\n+        \/\/ must be algo\/mode\/padding\n+        String algo = reqNonEmpty(transformation.substring(0, endIdx),\n+                    \"Invalid transformation: algorithm not specified\");\n+\n+        int startIdx = endIdx + 1;\n+        endIdx = indexOfRealSlash(transformation, startIdx);\n+        if (endIdx == -1) {\n+            throw new NoSuchAlgorithmException(\n+                    \"Invalid transformation format: \" + transformation);\n@@ -325,2 +351,9 @@\n-        if (algorithmOnly) { \/\/ done\n-            return new String[] { algo };\n+        String mode = reqNonEmpty(transformation.substring(startIdx,\n+                endIdx), \"Invalid transformation: missing mode\");\n+\n+        startIdx = endIdx + 1;\n+        endIdx = indexOfRealSlash(transformation, startIdx);\n+        if (endIdx == -1) {\n+            return new String[] { algo, mode,\n+                    reqNonEmpty(transformation.substring(startIdx),\n+                            \"Invalid transformation: missing padding\") };\n@@ -328,16 +361,2 @@\n-            \/\/ continue parsing mode and padding\n-            startIdx = endIdx+1;\n-            endIdx = transformation.indexOf('\/', startIdx);\n-            if (endIdx == -1) {\n-                throw new NoSuchAlgorithmException(\"Invalid transformation\"\n-                            + \" format:\" + transformation);\n-            }\n-            String mode = transformation.substring(startIdx, endIdx).trim();\n-            String padding = transformation.substring(endIdx+1).trim();\n-            \/\/ ensure mode and padding are specified\n-            if (mode.isEmpty() || padding.isEmpty()) {\n-                throw new NoSuchAlgorithmException(\"Invalid transformation: \" +\n-                                   \"missing mode and\/or padding-\"\n-                                   + transformation);\n-            }\n-            return new String[] { algo, mode, padding };\n+            throw new NoSuchAlgorithmException(\n+                    \"Invalid transformation format: \" + transformation);\n","filename":"src\/java.base\/share\/classes\/javax\/crypto\/Cipher.java","additions":54,"deletions":35,"binary":false,"changes":89,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8153029 8360463\n+ * @bug 8153029 8360463 8368984\n@@ -75,2 +75,1 @@\n-        checkTransformation(\"ChaCha20-Poly1305\", null);\n-        checkTransformation(\"ChaCha20-Poly1305\/None\/NoPadding\", null);\n+        checkTransformation(\"ChaCha20\/None\/\/\", NSAE);\n@@ -79,0 +78,3 @@\n+        checkTransformation(\"ChaCha20-Poly1305\", null);\n+        checkTransformation(\"ChaCha20-Poly1305\/None\/NoPadding\", null);\n+        checkTransformation(\"ChaCha20-Poly1305\/None\/\/\", NSAE);\n","filename":"test\/jdk\/com\/sun\/crypto\/provider\/Cipher\/ChaCha20\/unittest\/ChaCha20CipherUnitTest.java","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -27,1 +27,1 @@\n- * @bug 8359388\n+ * @bug 8359388 8368984\n@@ -70,0 +70,3 @@\n+            \/\/ 4 or more components transformations\n+            \"PBEWithHmacSHA512\/\/\/PKCS5Padding\",\n+            \"AES\/GCM\/NoPadding\/\/\/\",\n","filename":"test\/jdk\/javax\/crypto\/Cipher\/TestEmptyModePadding.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug 4898428\n+ * @bug 4898428 8368984\n@@ -29,0 +29,1 @@\n+ * @library \/test\/lib\n@@ -38,0 +39,1 @@\n+import jdk.test.lib.Utils;\n@@ -51,2 +53,2 @@\n-        Provider p = Security.getProvider(\n-                System.getProperty(\"test.provider.name\", \"SunJCE\"));\n+        String pName = System.getProperty(\"test.provider.name\", \"SunJCE\");\n+        Provider p = Security.getProvider(pName);\n@@ -71,19 +73,10 @@\n-        try {\n-            c = Cipher.getInstance(algo + \"\/XYZ\/PKCS5Padding\");\n-            throw new AssertionError();\n-        } catch (NoSuchAlgorithmException e) {\n-            System.out.println(e);\n-        }\n-        try {\n-            c = Cipher.getInstance(algo + \"\/XYZ\/PKCS5Padding\",\n-                    System.getProperty(\"test.provider.name\", \"SunJCE\"));\n-            throw new AssertionError();\n-        } catch (NoSuchAlgorithmException e) {\n-            System.out.println(e);\n-        }\n-        try {\n-            c = Cipher.getInstance(algo + \"\/XYZ\/PKCS5Padding\", p);\n-            throw new AssertionError();\n-        } catch (NoSuchAlgorithmException e) {\n-            System.out.println(e);\n-        }\n+        \/\/ invalid transformations or transformations containing unsupported\n+        \/\/ modes which should lead to NSAE\n+        String[] nsaeTransformations = {\n+            (algo + \"\/XYZ\/PKCS5Padding\"),\n+            (algo + \"\/CBC\/XYZWithSHA512\/224Padding\/\"),\n+            (algo + \"\/CBC\/XYZWithSHA512\/256Padding\/\"),\n+            (pbeAlgo + \"\/CBC\/XYZWithSHA512\/224Padding\/\"),\n+            (pbeAlgo + \"\/CBC\/XYZWithSHA512\/256Padding\/\"),\n+            \"foo\",\n+        };\n@@ -91,18 +84,8 @@\n-        try {\n-            c = Cipher.getInstance(algo + \"\/CBC\/XYZPadding\");\n-            throw new AssertionError();\n-        } catch (NoSuchAlgorithmException e) {\n-            System.out.println(e);\n-        }\n-        try {\n-            c = Cipher.getInstance(algo + \"\/CBC\/XYZPadding\",\n-                    System.getProperty(\"test.provider.name\", \"SunJCE\"));\n-            throw new AssertionError();\n-        } catch (NoSuchPaddingException e) {\n-            System.out.println(e);\n-        }\n-        try {\n-            c = Cipher.getInstance(algo + \"\/CBC\/XYZPadding\", p);\n-            throw new AssertionError();\n-        } catch (NoSuchPaddingException e) {\n-            System.out.println(e);\n+        for (String t : nsaeTransformations) {\n+            System.out.println(\"Testing NSAE on \" + t);\n+            Utils.runAndCheckException(() -> Cipher.getInstance(t),\n+                    NoSuchAlgorithmException.class);\n+            Utils.runAndCheckException(() -> Cipher.getInstance(t, pName),\n+                    NoSuchAlgorithmException.class);\n+            Utils.runAndCheckException(() -> Cipher.getInstance(t, p),\n+                    NoSuchAlgorithmException.class);\n@@ -111,19 +94,9 @@\n-        try {\n-            c = Cipher.getInstance(\"foo\");\n-            throw new AssertionError();\n-        } catch (NoSuchAlgorithmException e) {\n-            System.out.println(e);\n-        }\n-        try {\n-            c = Cipher.getInstance(\"foo\",\n-                    System.getProperty(\"test.provider.name\", \"SunJCE\"));\n-            throw new AssertionError();\n-        } catch (NoSuchAlgorithmException e) {\n-            System.out.println(e);\n-        }\n-        try {\n-            c = Cipher.getInstance(\"foo\", p);\n-            throw new AssertionError();\n-        } catch (NoSuchAlgorithmException e) {\n-            System.out.println(e);\n-        }\n+        \/\/ transformations containing unsupported paddings for SunJCE provider\n+        \/\/ which should lead to NSPE\n+        String[] nspeTransformations = {\n+            (algo + \"\/CBC\/XYZPadding\"),\n+            (algo + \"\/CBC\/XYZWithSHA512\/224Padding\"),\n+            (algo + \"\/CBC\/XYZWithSHA512\/256Padding\"),\n+            (pbeAlgo + \"\/CBC\/XYZWithSHA512\/224Padding\"),\n+            (pbeAlgo + \"\/CBC\/XYZWithSHA512\/256Padding\"),\n+        };\n@@ -131,19 +104,6 @@\n-        try {\n-            c = Cipher.getInstance(\"foo\",\n-                    System.getProperty(\"test.provider.name\", \"SUN\"));\n-            throw new AssertionError();\n-        } catch (NoSuchAlgorithmException e) {\n-            System.out.println(e);\n-        }\n-        try {\n-            c = Cipher.getInstance(\"foo\", Security.getProvider(\n-                    System.getProperty(\"test.provider.name\", \"SUN\")));\n-            throw new AssertionError();\n-        } catch (NoSuchAlgorithmException e) {\n-            System.out.println(e);\n-        }\n-        try {\n-            c = Cipher.getInstance(\"foo\", \"bar\");\n-            throw new AssertionError();\n-        } catch (NoSuchProviderException e) {\n-            System.out.println(e);\n+        for (String t : nspeTransformations) {\n+            System.out.println(\"Testing NSPE on \" + t);\n+            Utils.runAndCheckException(() -> Cipher.getInstance(t, pName),\n+                    NoSuchPaddingException.class);\n+            Utils.runAndCheckException(() -> Cipher.getInstance(t, p),\n+                    NoSuchPaddingException.class);\n@@ -152,0 +112,10 @@\n+        \/\/ additional misc tests\n+        Utils.runAndCheckException(() -> Cipher.getInstance(\"foo\",\n+                System.getProperty(\"test.provider.name\", \"SUN\")),\n+                NoSuchAlgorithmException.class);\n+        Utils.runAndCheckException(() -> Cipher.getInstance(\"foo\",\n+                Security.getProvider(System.getProperty(\"test.provider.name\",\n+                \"SUN\"))), NoSuchAlgorithmException.class);\n+        Utils.runAndCheckException(() -> Cipher.getInstance(\"foo\", \"bar\"),\n+                NoSuchProviderException.class);\n+\n","filename":"test\/jdk\/javax\/crypto\/Cipher\/TestGetInstance.java","additions":49,"deletions":79,"binary":false,"changes":128,"status":"modified"}]}