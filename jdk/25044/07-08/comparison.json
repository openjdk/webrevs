{"files":[{"patch":"@@ -0,0 +1,152 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import javax.imageio.IIOImage;\n+import javax.imageio.ImageIO;\n+import javax.imageio.ImageTypeSpecifier;\n+import javax.imageio.ImageWriter;\n+import javax.imageio.ImageWriteParam;\n+import javax.imageio.metadata.IIOMetadata;\n+import javax.imageio.metadata.IIOMetadataNode;\n+import javax.imageio.stream.ImageOutputStream;\n+import java.awt.AlphaComposite;\n+import java.awt.Color;\n+import java.awt.Graphics2D;\n+import java.awt.image.BufferedImage;\n+import java.awt.image.IndexColorModel;\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+\n+\/**\n+ * This constructs sample gif files used to test different combinations\n+ * of gif frame disposal methods and transparent pixel indices.\n+ *\/\n+public class GifBuilder {\n+\n+    \/**\n+     * Different disposal methods for gif frames. These names exactly\n+     * correspond to the String identifier ImageIO uses.\n+     *\/\n+    public enum Disposal {none, doNotDispose, restoreToBackgroundColor, restoreToPrevious};\n+\n+\n+    \/**\n+     * @param disposal the frame disposal method\n+     * @param isFirstTableIndexTransparent if true then the transparent pixel\n+     *                                     is set to 0. If false then the\n+     *                                     transparent pixel is set to the\n+     *                                     last index.\n+     *\/\n+    public record FrameDescription(Disposal disposal, boolean isFirstTableIndexTransparent) {}\n+\n+    \/**\n+     * This creates a sample gif image based on a series of FrameDescriptions, and the\n+     * calls {@link GifComparison#run(URL)}\n+     *\/\n+    public static void test(FrameDescription... frameDescriptions) throws Throwable {\n+        File file = createTestFile(frameDescriptions);\n+        try {\n+            GifComparison.run(file.toURI().toURL());\n+        } finally {\n+            file.delete();\n+        }\n+    }\n+\n+    private static File createTestFile(FrameDescription... frameDescriptions) throws IOException {\n+        Color[] colors = new Color[] {\n+                Color.red,\n+                Color.yellow,\n+                Color.green,\n+                Color.cyan\n+        };\n+        File file = File.createTempFile(\"GifBuilder\", \".gif\");\n+        ImageOutputStream ios = ImageIO.createImageOutputStream(file);\n+        ImageWriter gifWriter = ImageIO.getImageWritersByFormatName(\"GIF\").next();\n+        gifWriter.setOutput(ios);\n+        ImageWriteParam wparam = gifWriter.getDefaultWriteParam();\n+        IIOMetadata streamMetadata = gifWriter.getDefaultStreamMetadata(wparam);\n+        gifWriter.prepareWriteSequence(streamMetadata);\n+\n+        IndexColorModel icm = createIndexColorModel(colors, colors.length - 1);\n+\n+        ImageTypeSpecifier s = ImageTypeSpecifier.createFromBufferedImageType(BufferedImage.TYPE_BYTE_INDEXED);\n+        IIOMetadata metadata = gifWriter.getDefaultImageMetadata(s, wparam);\n+        String metaFormatName = metadata.getNativeMetadataFormatName();\n+\n+        for (FrameDescription frameDescription : frameDescriptions) {\n+\n+            \/\/ prepare the image:\n+            int width = 100 + 50 * (icm.getMapSize() - 2);\n+            BufferedImage bi = new BufferedImage(width, 100,\n+                    BufferedImage.TYPE_BYTE_INDEXED, icm);\n+            Graphics2D g = bi.createGraphics();\n+            g.setComposite(AlphaComposite.Clear);\n+            g.fillRect(0, 0, bi.getWidth(), bi.getHeight());\n+            g.setComposite(AlphaComposite.SrcOver);\n+            int x = 0;\n+            for (int a = 0; a < icm.getMapSize() - 1; a++) {\n+                if (a != icm.getTransparentPixel()) {\n+                    Color color = new Color(icm.getRGB(a));\n+                    g.setColor(color);\n+                    g.fillOval(x, 0, 100, 100);\n+                    x += 50;\n+                }\n+            }\n+            g.dispose();\n+\n+            \/\/ wrap attributes for gifWriter:\n+            int transparentPixel = frameDescription.isFirstTableIndexTransparent ? 0 : icm.getMapSize() - 1;\n+            IIOMetadata frameMetadata = gifWriter.getDefaultImageMetadata(ImageTypeSpecifier.createFromRenderedImage(bi), wparam);\n+            IIOMetadataNode root = new IIOMetadataNode(metaFormatName);\n+            IIOMetadataNode gce = new IIOMetadataNode(\"GraphicControlExtension\");\n+            gce.setAttribute(\"disposalMethod\", frameDescription.disposal.name());\n+            gce.setAttribute(\"userInputFlag\", \"FALSE\");\n+            gce.setAttribute(\"transparentColorFlag\", \"TRUE\");\n+            gce.setAttribute(\"delayTime\", \"0\");\n+            gce.setAttribute(\"transparentColorIndex\", Integer.toString(transparentPixel));\n+            root.appendChild(gce);\n+            frameMetadata.mergeTree(metaFormatName, root);\n+            IIOImage img = new IIOImage(bi,  null, frameMetadata);\n+            gifWriter.writeToSequence(img, wparam);\n+        }\n+        gifWriter.endWriteSequence();\n+        ios.flush();\n+        ios.close();\n+\n+        return file;\n+    }\n+\n+    private static IndexColorModel createIndexColorModel(Color[] colors, int transparentIndex) {\n+        byte[] r = new byte[colors.length];\n+        byte[] g = new byte[colors.length];\n+        byte[] b = new byte[colors.length];\n+        for (int a = 0; a < colors.length; a++) {\n+            r[a] = (byte) colors[a].getRed();\n+            g[a] = (byte) colors[a].getGreen();\n+            b[a] = (byte) colors[a].getBlue();\n+        }\n+        int bits = (int)(Math.log(colors.length) \/ Math.log(2) + .5);\n+        return new IndexColorModel(bits, colors.length, r, g, b, transparentIndex);\n+    }\n+}\n","filename":"test\/jdk\/sun\/awt\/image\/gif\/GifBuilder.java","additions":152,"deletions":0,"binary":false,"changes":152,"status":"added"},{"patch":"@@ -31,4 +31,0 @@\n-import java.awt.Color;\n-import java.awt.image.BufferedImage;\n-import java.net.URL;\n-\n@@ -37,2 +33,4 @@\n-        URL srcURL = GifEmptyBackgroundTest.class.getResource(\"clyde.gif\");\n-        BufferedImage bi = GifComparison.run(srcURL);\n+        GifBuilder.test(\n+                new GifBuilder.FrameDescription(GifBuilder.Disposal.restoreToBackgroundColor, false),\n+                new GifBuilder.FrameDescription(GifBuilder.Disposal.doNotDispose, false),\n+                new GifBuilder.FrameDescription(GifBuilder.Disposal.doNotDispose, false) );\n","filename":"test\/jdk\/sun\/awt\/image\/gif\/GifEmptyBackgroundTest.java","additions":4,"deletions":6,"binary":false,"changes":10,"status":"modified"},{"filename":"test\/jdk\/sun\/awt\/image\/gif\/clyde.gif","binary":true,"status":"deleted"}]}