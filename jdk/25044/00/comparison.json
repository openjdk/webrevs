{"files":[{"patch":"@@ -414,0 +414,9 @@\n+\n+                \/\/ the saved_image is initially filled with zeroes.\n+                \/\/ If this is our first time updating it, and if zeroes\n+                \/\/ are NOT the transparent pixel: we need to replace it\n+                \/\/ with the appropriate transparent pixel.\n+                boolean replaceTransPixelsInSavedImage = save &&\n+                        saved_model == null &&\n+                        trans_pixel > 0;\n+\n@@ -427,0 +436,3 @@\n+                        if (replaceTransPixelsInSavedImage) {\n+                            saved_image[off] = pixel;\n+                        }\n","filename":"src\/java.desktop\/share\/classes\/sun\/awt\/image\/GifImageDecoder.java","additions":12,"deletions":0,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -0,0 +1,143 @@\n+\/*\n+ * Copyright (c) 2002, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8356137\n+ * @summary This test verifies a non-zero transparent pixel in gifs works when\n+ * the disposal method changes from 2 to 1, and when the\n+ *\/\n+\n+import java.awt.Color;\n+import java.awt.Graphics2D;\n+import java.awt.Image;\n+import java.awt.Toolkit;\n+import java.awt.image.BufferedImage;\n+import java.awt.image.ColorModel;\n+import java.awt.image.ImageConsumer;\n+import java.awt.image.IndexColorModel;\n+import java.net.URL;\n+import java.util.ArrayList;\n+import java.util.Hashtable;\n+import java.util.concurrent.Semaphore;\n+\n+public class GifEmptyBackgroundTest {\n+    public static void main(String[] args) throws Exception {\n+        URL srcURL = GifEmptyBackgroundTest.class.getResource(\"clyde.gif\");\n+        BufferedImage[] frames = getFrames(srcURL, 4);\n+\n+        boolean pass = true;\n+        if (new Color(frames[3].getRGB(20, 20), true).getAlpha() != 0) {\n+            System.err.println(\"Sampling at (20,20) failed\");\n+            pass = false;\n+        }\n+\n+        if (!pass)\n+            throw new Error(\"See System.err for details\");\n+    }\n+\n+    private static BufferedImage[] getFrames(URL gifURL, int numberOfFrames) {\n+        Image image = Toolkit.getDefaultToolkit().createImage(gifURL);\n+        ArrayList<BufferedImage> returnValue = new ArrayList<>(numberOfFrames);\n+\n+        Semaphore semaphore = new Semaphore(1);\n+        semaphore.acquireUninterruptibly();\n+        image.getSource().startProduction(new ImageConsumer() {\n+            BufferedImage bi;\n+            int frameCtr = 0;\n+\n+            @Override\n+            public void setDimensions(int width, int height) {\n+                bi = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);\n+            }\n+\n+            @Override\n+            public void setProperties(Hashtable<?, ?> props) {}\n+\n+            @Override\n+            public void setColorModel(ColorModel model) {}\n+\n+            @Override\n+            public void setHints(int hintflags) {}\n+\n+            @Override\n+            public void setPixels(int x, int y, int w, int h, ColorModel model, byte[] pixels, int off, int scansize) {\n+                try {\n+                    final int yMax = y + h;\n+                    final int xMax = x + w;\n+\n+                    IndexColorModel icm = (IndexColorModel) model;\n+                    int[] colorModelRGBs = new int[icm.getMapSize()];\n+                    icm.getRGBs(colorModelRGBs);\n+                    int[] argbRow = new int[bi.getWidth()];\n+\n+                    for (int y_ = y; y_ < yMax; y_++) {\n+                        int i = y_ * scansize + off;\n+                        for (int x_ = x; x_ < xMax; x_++, i++) {\n+                            int pixel = pixels[i] & 0xff;\n+                            argbRow[x_ - x] = colorModelRGBs[pixel];\n+                        }\n+                        bi.getRaster().setDataElements(x, y_, w, 1, argbRow);\n+                    }\n+                } catch (RuntimeException e) {\n+                    \/\/ we don't expect this to happen, but if something goes\n+                    \/\/ wrong nobody else will print our stacktrace for us:\n+                    e.printStackTrace();\n+                    throw e;\n+                }\n+            }\n+\n+            @Override\n+            public void setPixels(int x, int y, int w, int h, ColorModel model, int[] pixels, int off, int scansize) {}\n+\n+            @Override\n+            public void imageComplete(int status) {\n+                try {\n+                    frameCtr++;\n+\n+                    BufferedImage copy = new BufferedImage(bi.getWidth(),\n+                            bi.getHeight(), BufferedImage.TYPE_INT_ARGB);\n+                    Graphics2D g = copy.createGraphics();\n+                    g.drawImage(bi, 0, 0, null);\n+                    g.dispose();\n+                    returnValue.add(copy);\n+\n+                    if (frameCtr == numberOfFrames) {\n+                        semaphore.release();\n+                        \/\/ if we don't detach this consumer the producer will\n+                        \/\/ loop forever\n+                        image.getSource().removeConsumer(this);\n+                        image.flush();\n+                    }\n+                } catch(Exception e) {\n+                    e.printStackTrace();\n+                    throw new RuntimeException(e);\n+                }\n+            }\n+        });\n+\n+        semaphore.acquireUninterruptibly();\n+\n+        return returnValue.toArray(new BufferedImage[0]);\n+    }\n+}\n\\ No newline at end of file\n","filename":"test\/jdk\/sun\/awt\/image\/gif\/bug8356137\/GifEmptyBackgroundTest.java","additions":143,"deletions":0,"binary":false,"changes":143,"status":"added"},{"filename":"test\/jdk\/sun\/awt\/image\/gif\/bug8356137\/clyde.gif","binary":true,"status":"added"}]}