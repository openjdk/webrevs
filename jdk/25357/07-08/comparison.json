{"files":[{"patch":"@@ -2375,4 +2375,13 @@\n-          oop obj = cast_to_oop(region->bottom());\n-          size_t byte_size = obj->size() * HeapWordSize;\n-          size_t region_span = ShenandoahHeapRegion::required_regions(byte_size);\n-          humongous_waste_bytes = region_span * ShenandoahHeapRegion::region_size_bytes() - byte_size;\n+          \/\/ Since rebuild does not necessarily happen at a safepoint, a newly allocated humongous object may not have been\n+          \/\/ fully initialized.  Therefore, we cannot safely consult its header.\n+          ShenandoahHeapRegion* last_of_humongous_continuation = region;\n+          size_t next_idx;\n+          for (next_idx = idx + 1; next_idx < num_regions; next_idx++) {\n+            ShenandoahHeapRegion* humongous_cont_candidate = _heap->get_region(next_idx);\n+            if (!humongous_cont_candidate->is_humongous_continuation()) {\n+              break;\n+            }\n+            last_of_humongous_continuation = humongous_cont_candidate;\n+          }\n+          \/\/ For humongous regions, used() is established while holding the global heap lock so it is reliable here\n+          humongous_waste_bytes = ShenandoahHeapRegion::region_size_bytes() - last_of_humongous_continuation->used();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahFreeSet.cpp","additions":13,"deletions":4,"binary":false,"changes":17,"status":"modified"}]}