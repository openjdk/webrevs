{"files":[{"patch":"@@ -182,1 +182,1 @@\n-  ssize_t regions_to_xfer = 0;\n+  ssize_t add_regions_to_old = 0;\n@@ -198,1 +198,1 @@\n-      need_to_finalize_mixed |= heap->old_generation()->heuristics()->top_off_collection_set(regions_to_xfer);\n+      need_to_finalize_mixed |= heap->old_generation()->heuristics()->top_off_collection_set(add_regions_to_old);\n@@ -219,1 +219,1 @@\n-  return regions_to_xfer;\n+  return add_regions_to_old;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahGenerationalHeuristics.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -415,1 +415,1 @@\n-bool ShenandoahOldHeuristics::top_off_collection_set(ssize_t &regions_to_xfer) {\n+bool ShenandoahOldHeuristics::top_off_collection_set(ssize_t &add_regions_to_old) {\n@@ -468,1 +468,1 @@\n-      regions_to_xfer = regions_for_old_expansion;\n+      add_regions_to_old = regions_for_old_expansion;\n@@ -486,1 +486,1 @@\n-      regions_to_xfer = 0;\n+      add_regions_to_old = 0;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahOldHeuristics.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -171,1 +171,1 @@\n-  bool top_off_collection_set(ssize_t &regions_to_xfer);\n+  bool top_off_collection_set(ssize_t &add_regions_to_old);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahOldHeuristics.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2757,0 +2757,1 @@\n+#ifdef KELVIN_DEPRECATE\n@@ -2762,0 +2763,1 @@\n+#endif\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahFreeSet.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -731,0 +731,1 @@\n+#ifdef KELVIN_DEPRECATE\n@@ -736,0 +737,1 @@\n+#endif\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahFreeSet.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1127,0 +1127,1 @@\n+    heap->old_generation()->set_region_balance(0);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahFullGC.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -393,1 +393,1 @@\n-                                                     ShenandoahCollectionSet* const collection_set, ssize_t regions_to_xfer) {\n+                                                     ShenandoahCollectionSet* const collection_set, ssize_t add_regions_to_old) {\n@@ -451,1 +451,1 @@\n-  size_t total_young_available = young_generation->available_with_reserve() - regions_to_xfer * region_size_bytes;;\n+  size_t total_young_available = young_generation->available_with_reserve() - add_regions_to_old * region_size_bytes;;\n@@ -455,1 +455,1 @@\n-               young_generation->available_with_reserve(), regions_to_xfer, region_size_bytes);\n+               young_generation->available_with_reserve(), add_regions_to_old, region_size_bytes);\n@@ -467,1 +467,1 @@\n-    old_generation->available() + regions_to_xfer * region_size_bytes - collection_set->get_old_available_bytes_collected();\n+    old_generation->available() + add_regions_to_old * region_size_bytes - collection_set->get_old_available_bytes_collected();\n@@ -470,1 +470,1 @@\n-               old_available, regions_to_xfer, region_size_bytes, old_generation->available(), collection_set->get_old_available_bytes_collected());\n+               old_available, add_regions_to_old, region_size_bytes, old_generation->available(), collection_set->get_old_available_bytes_collected());\n@@ -506,0 +506,1 @@\n+    \/\/ TODO: reserve for full promotion reserve, not just for advance (preselected) promotion\n@@ -512,1 +513,1 @@\n-  size_t unaffiliated_old_regions = old_generation->free_unaffiliated_regions() + regions_to_xfer;\n+  size_t unaffiliated_old_regions = old_generation->free_unaffiliated_regions() + add_regions_to_old;\n@@ -541,1 +542,1 @@\n-  regions_to_xfer = 0;\n+  ssize_t add_regions_to_young = 0;\n@@ -545,1 +546,1 @@\n-      regions_to_xfer = unaffiliated_old_regions;\n+      add_regions_to_young = unaffiliated_old_regions;\n@@ -554,1 +555,1 @@\n-    regions_to_xfer = MIN2(excess_regions, unaffiliated_old_regions);\n+    add_regions_to_young = MIN2(excess_regions, unaffiliated_old_regions);\n@@ -561,3 +562,3 @@\n-  if (regions_to_xfer > 0) {\n-    assert(excess_old >= regions_to_xfer * region_size_bytes, \"Cannot xfer more than excess old\");\n-    excess_old -= regions_to_xfer * region_size_bytes;\n+  if (add_regions_to_young > 0) {\n+    assert(excess_old >= add_regions_to_young * region_size_bytes, \"Cannot xfer more than excess old\");\n+    excess_old -= add_regions_to_young * region_size_bytes;\n@@ -574,1 +575,1 @@\n-  log_info(gc)(\"   (regions are transferred to young because we shrunk the old evacuation reserve above)\");\n+  log_info(gc)(\"   (regions are relinquished for mutator because we shrunk the old evacuation reserve above)\");\n@@ -889,1 +890,1 @@\n-      ssize_t regions_to_xfer = _heuristics->choose_collection_set(collection_set);\n+      ssize_t add_regions_to_old = _heuristics->choose_collection_set(collection_set);\n@@ -891,1 +892,1 @@\n-      adjust_evacuation_budgets(heap, collection_set, regions_to_xfer);\n+      adjust_evacuation_budgets(heap, collection_set, add_regions_to_old);\n@@ -918,0 +919,6 @@\n+    if (heap->mode()->is_generational()) {\n+      ShenandoahGenerationalHeap* gen_heap = ShenandoahGenerationalHeap::heap();\n+    size_t allocation_runway =\n+      gen_heap->young_generation()->heuristics()->bytes_of_allocation_runway_before_gc_trigger(young_trashed_regions);\n+      gen_heap->compute_old_generation_balance(allocation_runway, old_trashed_regions, young_trashed_regions);\n+    }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGeneration.cpp","additions":22,"deletions":15,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -451,0 +451,3 @@\n+    if (mode()->is_generational()) {\n+     old_generation()->set_region_balance(0);\n+    }\n@@ -2557,0 +2560,1 @@\n+    old_gen->set_region_balance(0);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -483,0 +483,1 @@\n+  \/\/ The following two functions rebuild the free set at the of GC, in preparation for an idle phase.\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -425,0 +425,1 @@\n+    heap->old_generation()->set_region_balance(0);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahOldGeneration.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}