{"files":[{"patch":"@@ -152,1 +152,5 @@\n-            pkg.addInstallVerifier(this::verifyLauncherExecuted);\n+            pkg.addInstallVerifier(cmd -> {\n+                if (!MacHelper.isForAppStore(cmd)) {\n+                    verifyLauncherExecuted(cmd);\n+                }\n+            });\n@@ -165,1 +169,3 @@\n-                verify(cmd, launcherName, launcherAsService);\n+                \/\/ Launcher should not be a service with \"--launcher-as-service\"\n+                \/\/ and \"--mac-app-store\" specified.\n+                verify(cmd, launcherName, launcherAsService && !cmd.hasArgument(\"--mac-app-store\"));\n@@ -196,1 +202,1 @@\n-        if (launcherAsServiceNames.isEmpty() || cmd.isRuntime()) {\n+        if (launcherAsServiceNames.isEmpty() || cmd.isRuntime() || cmd.hasArgument(\"--mac-app-store\")) {\n@@ -228,1 +234,5 @@\n-        return Objects.requireNonNull(partitionLaunchers(cmd).get(true));\n+        if (MacHelper.isForAppStore(cmd)) {\n+            return List.of();\n+        } else {\n+            return Objects.requireNonNull(partitionLaunchers(cmd).get(true));\n+        }\n@@ -242,1 +252,3 @@\n-        if (cmd.isMainLauncher(launcherName)) {\n+        if (MacHelper.isForAppStore(cmd)) {\n+            return false;\n+        } else if (cmd.isMainLauncher(launcherName)) {\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/LauncherAsServiceVerifier.java","additions":17,"deletions":5,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -798,0 +798,9 @@\n+    }\n+\n+    public static boolean isForAppStore(JPackageCommand cmd) {\n+        return PropertyFinder.findAppProperty(cmd,\n+                PropertyFinder.cmdlineBooleanOption(\"--mac-app-store\"),\n+                PropertyFinder.appImageFile(appImageFile -> {\n+                    return Boolean.toString(appImageFile.macAppStore());\n+                })\n+        ).map(Boolean::parseBoolean).orElse(false);\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/MacHelper.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+import java.util.ArrayList;\n@@ -35,0 +36,1 @@\n+import jdk.jpackage.test.MacHelper;\n@@ -53,13 +55,12 @@\n-    public static Collection<?> input() {\n-        return List.of(new Object[][]{\n-            { new PkgInstallScript[]{\n-                    PkgInstallScript.PREINSTALL,\n-                    PkgInstallScript.POSTINSTALL },\n-            },\n-            { new PkgInstallScript[]{\n-                    PkgInstallScript.PREINSTALL },\n-            },\n-            { new PkgInstallScript[]{\n-                    PkgInstallScript.POSTINSTALL },\n-            },\n-        });\n+    public static Collection<Object[]> input() {\n+        List<Object[]> data = new ArrayList<>();\n+        for (var appStore : List.of(true, false)) {\n+            for (var scriptRoles : List.of(\n+                    List.of(PkgInstallScript.PREINSTALL, PkgInstallScript.POSTINSTALL),\n+                    List.of(PkgInstallScript.PREINSTALL),\n+                    List.of(PkgInstallScript.POSTINSTALL)\n+            )) {\n+                data.add(new Object[] {scriptRoles.toArray(PkgInstallScript[]::new), appStore});\n+            }\n+        }\n+        return data;\n@@ -70,1 +71,1 @@\n-    public void test(PkgInstallScript[] customScriptRoles) {\n+    public void test(PkgInstallScript[] customScriptRoles, boolean appStore) {\n@@ -83,0 +84,3 @@\n+                if (appStore) {\n+                    cmd.addArgument(\"--mac-app-store\");\n+                }\n@@ -159,0 +163,1 @@\n+            var scriptsEnabled = !MacHelper.isForAppStore(cmd);\n@@ -160,2 +165,2 @@\n-                role.verifyExists(cmd, true);\n-            } else {\n+                role.verifyExists(cmd, scriptsEnabled);\n+            } else if (scriptsEnabled) {\n@@ -163,0 +168,2 @@\n+            } else {\n+                TKit.assertPathExists(responseFilePath(cmd), false);\n","filename":"test\/jdk\/tools\/jpackage\/macosx\/PkgScriptsTest.java","additions":23,"deletions":16,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -36,0 +36,1 @@\n+import jdk.internal.util.OperatingSystem;\n@@ -158,3 +159,5 @@\n-    @Parameter(\"true\")\n-    @Parameter(\"false\")\n-    public void testAddL(boolean mainLauncherAsService) {\n+    @Parameter(value = {\"true\", \"false\"})\n+    @Parameter(value = {\"false\", \"false\"})\n+    @Parameter(value = {\"true\", \"true\"}, ifOS = OperatingSystem.MACOS)\n+    @Parameter(value = {\"false\", \"true\"}, ifOS = OperatingSystem.MACOS)\n+    public void testAddL(boolean mainLauncherAsService, boolean isMacAppStore) {\n@@ -166,0 +169,5 @@\n+                .addInitializer(cmd -> {\n+                    if (isMacAppStore) {\n+                        cmd.addArgument(\"--mac-app-store\");\n+                    }\n+                })\n@@ -202,3 +210,5 @@\n-    @Parameter(\"true\")\n-    @Parameter(\"false\")\n-    public void testAddLFromAppImage(boolean mainLauncherAsService) {\n+    @Parameter(value = {\"true\", \"false\"})\n+    @Parameter(value = {\"false\", \"false\"})\n+    @Parameter(value = {\"true\", \"true\"}, ifOS = OperatingSystem.MACOS)\n+    @Parameter(value = {\"false\", \"true\"}, ifOS = OperatingSystem.MACOS)\n+    public void testAddLFromAppImage(boolean mainLauncherAsService, boolean isMacAppStore) {\n@@ -216,0 +226,4 @@\n+        if (isMacAppStore) {\n+            appImageCmd.cmd().orElseThrow().addArgument(\"--mac-app-store\");\n+        }\n+\n@@ -251,0 +265,3 @@\n+                    if (isMacAppStore) {\n+                        cmd.addArgument(\"--mac-app-store\");\n+                    }\n","filename":"test\/jdk\/tools\/jpackage\/share\/ServiceTest.java","additions":23,"deletions":6,"binary":false,"changes":29,"status":"modified"}]}