{"files":[{"patch":"@@ -551,2 +551,2 @@\n-        } else if (nesting > 0 && load_type->isa_narrowklass()) {\n-          NOT_PRODUCT(if (TraceReduceAllocationMerges) tty->print_cr(\"Can NOT reduce Phi %d on invocation %d. Nested NarrowKlass Load: %s\", n->_idx, _invocation, use_use->Name());)\n+        } else if (load_type->isa_narrowklass() || load_type->isa_klassptr()) {\n+          NOT_PRODUCT(if (TraceReduceAllocationMerges) tty->print_cr(\"Can NOT reduce Phi %d on invocation %d. [Narrow] Klass Load: %s\", n->_idx, _invocation, use_use->Name());)\n","filename":"src\/hotspot\/share\/opto\/escape.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -650,1 +650,0 @@\n-  _const_basic_type[T_METADATA]    = Type::BOTTOM;\n@@ -675,1 +674,0 @@\n-  _zero_type[T_METADATA]    = TypePtr::NULL_PTR;\n","filename":"src\/hotspot\/share\/opto\/type.cpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -27,1 +27,2 @@\n- * @summary Check that Reduce Allocation Merges can load Klass when CompressedClassPointers is disabled.\n+ * @summary Check that Reduce Allocation Merges doesn't crash when CompressedClassPointers\n+ *          is disabled and there is an access to Klass \"field\" through the phi.\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/TestReduceAllocationAndLoadKlass.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -34,1 +34,1 @@\n- * @requires vm.debug == true & vm.bits == 64 & vm.compiler2.enabled & vm.opt.final.UseCompressedOops & vm.opt.final.EliminateAllocations\n+ * @requires vm.debug == true & vm.flagless & vm.bits == 64 & vm.compiler2.enabled & vm.opt.final.EliminateAllocations\n@@ -42,9 +42,38 @@\n-        TestFramework.runWithFlags(\"-XX:+UnlockDiagnosticVMOptions\",\n-                                   \"-XX:+ReduceAllocationMerges\",\n-                                   \"-XX:+TraceReduceAllocationMerges\",\n-                                   \"-XX:+DeoptimizeALot\",\n-                                   \"-XX:CompileCommand=inline,*::charAt*\",\n-                                   \"-XX:CompileCommand=inline,*PicturePositions::*\",\n-                                   \"-XX:CompileCommand=inline,*Point::*\",\n-                                   \"-XX:CompileCommand=inline,*Nested::*\",\n-                                   \"-XX:CompileCommand=exclude,*::dummy*\");\n+        TestFramework framework = new TestFramework();\n+\n+        Scenario scenario0 = new Scenario(0, \"-XX:+UnlockDiagnosticVMOptions\",\n+                                             \"-XX:+ReduceAllocationMerges\",\n+                                             \"-XX:+TraceReduceAllocationMerges\",\n+                                             \"-XX:+DeoptimizeALot\",\n+                                             \"-XX:+UseCompressedOops\",\n+                                             \"-XX:+UseCompressedClassPointers\",\n+                                             \"-XX:CompileCommand=inline,*::charAt*\",\n+                                             \"-XX:CompileCommand=inline,*PicturePositions::*\",\n+                                             \"-XX:CompileCommand=inline,*Point::*\",\n+                                             \"-XX:CompileCommand=inline,*Nested::*\",\n+                                             \"-XX:CompileCommand=exclude,*::dummy*\");\n+\n+        Scenario scenario1 = new Scenario(1, \"-XX:+UnlockDiagnosticVMOptions\",\n+                                             \"-XX:+ReduceAllocationMerges\",\n+                                             \"-XX:+TraceReduceAllocationMerges\",\n+                                             \"-XX:+DeoptimizeALot\",\n+                                             \"-XX:+UseCompressedOops\",\n+                                             \"-XX:-UseCompressedClassPointers\",\n+                                             \"-XX:CompileCommand=inline,*::charAt*\",\n+                                             \"-XX:CompileCommand=inline,*PicturePositions::*\",\n+                                             \"-XX:CompileCommand=inline,*Point::*\",\n+                                             \"-XX:CompileCommand=inline,*Nested::*\",\n+                                             \"-XX:CompileCommand=exclude,*::dummy*\");\n+\n+        Scenario scenario2 = new Scenario(2, \"-XX:+UnlockDiagnosticVMOptions\",\n+                                             \"-XX:+ReduceAllocationMerges\",\n+                                             \"-XX:+TraceReduceAllocationMerges\",\n+                                             \"-XX:+DeoptimizeALot\",\n+                                             \"-XX:-UseCompressedOops\",\n+                                             \"-XX:CompileCommand=inline,*::charAt*\",\n+                                             \"-XX:CompileCommand=inline,*PicturePositions::*\",\n+                                             \"-XX:CompileCommand=inline,*Point::*\",\n+                                             \"-XX:CompileCommand=inline,*Nested::*\",\n+                                             \"-XX:CompileCommand=exclude,*::dummy*\");\n+\n+        framework.addScenarios(scenario0, scenario1, scenario2).start();\n@@ -97,1 +126,2 @@\n-                 \"testLoadNarrowKlass_C2\",\n+                 \"testLoadKlassFromCast_C2\",\n+                 \"testLoadKlassFromPhi_C2\",\n@@ -153,1 +183,2 @@\n-        Asserts.assertEQ(testLoadNarrowKlass_Interp(cond1),                         testLoadNarrowKlass_C2(cond1));\n+        Asserts.assertEQ(testLoadKlassFromCast_Interp(cond1),                       testLoadKlassFromCast_C2(cond1));\n+        Asserts.assertEQ(testLoadKlassFromPhi_Interp(cond1),                        testLoadKlassFromPhi_C2(cond1));\n@@ -774,1 +805,2 @@\n-    @IR(counts = { IRNode.ALLOC, \"2\" } )\n+    @IR(counts = { IRNode.ALLOC, \"2\" }, applyIf = {\"UseCompressedOops\", \"true\"} )\n+    @IR(failOn = { IRNode.ALLOC }, applyIf = {\"UseCompressedOops\", \"false\"} )\n@@ -776,2 +808,2 @@\n-    \/\/ be removed because the Phi merging them will have a DecodeN user - which\n-    \/\/ currently isn't supported.\n+    \/\/ be removed, if CompressedOops is enabled, because the Phi merging them will\n+    \/\/ have a DecodeN user - which currently isn't supported.\n@@ -1261,1 +1293,1 @@\n-    Class testLoadNarrowKlass(boolean cond1) {\n+    Class testLoadKlassFromCast(boolean cond1) {\n@@ -1273,3 +1305,2 @@\n-    \/\/ The allocation won't be reduced because we don't support NarrowKlass\n-    \/\/ loads under CastPPs.\n-    Class testLoadNarrowKlass_C2(boolean cond1) { return testLoadNarrowKlass(cond1); }\n+    \/\/ The allocation won't be reduced because we don't support [Narrow]Klass loads\n+    Class testLoadKlassFromCast_C2(boolean cond1) { return testLoadKlassFromCast(cond1); }\n@@ -1278,1 +1309,22 @@\n-    Class testLoadNarrowKlass_Interp(boolean cond1) { return testLoadNarrowKlass(cond1); }\n+    Class testLoadKlassFromCast_Interp(boolean cond1) { return testLoadKlassFromCast(cond1); }\n+\n+    \/\/ -------------------------------------------------------------------------\n+\n+    @ForceInline\n+    Class testLoadKlassFromPhi(boolean cond1) {\n+        Shape p = new Square(20);\n+\n+        if (cond1) {\n+            p = new Circle(10);\n+        }\n+\n+        return p.getClass();\n+    }\n+\n+    @Test\n+    @IR(counts = { IRNode.ALLOC, \"2\" })\n+    \/\/ The allocation won't be reduced because we don't support [Narrow]Klass loads\n+    Class testLoadKlassFromPhi_C2(boolean cond1) { return testLoadKlassFromPhi(cond1); }\n+\n+    @DontCompile\n+    Class testLoadKlassFromPhi_Interp(boolean cond1) { return testLoadKlassFromPhi(cond1); }\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/scalarReplacement\/AllocationMergesTests.java","additions":72,"deletions":20,"binary":false,"changes":92,"status":"modified"}]}