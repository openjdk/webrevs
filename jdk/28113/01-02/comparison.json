{"files":[{"patch":"@@ -859,10 +859,0 @@\n-  \/\/ The Phi's inputs may have been modified from scalar to vector,\n-  \/\/ and we need to update the type of the phi.\n-  const Type* t = in1->bottom_type();\n-  if (t->isa_vect() != nullptr &&\n-      _node->bottom_type()->isa_vect() == nullptr) {\n-    assert(!t->singleton(), \"sanity\");\n-    _node->as_Type()->set_type(t);\n-    phase->igvn().set_type(_node, t);\n-  }\n-\n@@ -886,0 +876,10 @@\n+\n+    \/\/ The type of the phi may have been modified, for example by moving\n+    \/\/ from scalar to vector phi.\n+    Node* in1 = _node->in(1);\n+    const Type* t1 = phase->igvn().type(in1);\n+    const Type* t2 = phase->igvn().type(in2);\n+    const Type* t = t1->meet_speculative(t2);\n+    assert(!t->singleton(), \"sanity\");\n+    _node->as_Type()->set_type(t);\n+    phase->igvn().set_type(_node, t);\n","filename":"src\/hotspot\/share\/opto\/vtransform.cpp","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -25,1 +25,1 @@\n- * @test id=all-flags\n+ * @test id=all-flags-1\n@@ -33,1 +33,1 @@\n- *      -XX:CompileCommand=compileonly,*TestLoopPhiApplyBadType::test\n+ *      -XX:CompileCommand=compileonly,*TestLoopPhiApplyBadType::test*\n@@ -47,1 +47,1 @@\n- * @test id=fewer-flags\n+ * @test id=fewer-flags-1\n@@ -51,1 +51,1 @@\n- *      -XX:CompileCommand=compileonly,*TestLoopPhiApplyBadType::test\n+ *      -XX:CompileCommand=compileonly,*TestLoopPhiApplyBadType::test*\n@@ -63,0 +63,27 @@\n+\/*\n+ * @test id=all-flags-2\n+ * @bug 8371065 8371472\n+ * @run main\/othervm\n+ *      -XX:+IgnoreUnrecognizedVMOptions\n+ *      -XX:CompileCommand=compileonly,*TestLoopPhiApplyBadType::test*\n+ *      -XX:CompileCommand=dontinline,*TestLoopPhiApplyBadType::notInlined\n+ *      -XX:-TieredCompilation\n+ *      -Xbatch\n+ *      -XX:+StressIGVN\n+ *      -XX:StressSeed=3497198372\n+ *      compiler.loopopts.superword.TestLoopPhiApplyBadType\n+ *\/\n+\n+\/*\n+ * @test id=fewer-flags-2\n+ * @bug 8371065 8371472\n+ * @run main\/othervm\n+ *      -XX:+IgnoreUnrecognizedVMOptions\n+ *      -XX:CompileCommand=compileonly,*TestLoopPhiApplyBadType::test*\n+ *      -XX:CompileCommand=dontinline,*TestLoopPhiApplyBadType::notInlined\n+ *      -XX:-TieredCompilation\n+ *      -Xbatch\n+ *      -XX:+StressIGVN\n+ *      compiler.loopopts.superword.TestLoopPhiApplyBadType\n+ *\/\n+\n@@ -68,1 +95,1 @@\n- *      -XX:CompileCommand=compileonly,*TestLoopPhiApplyBadType::test\n+ *      -XX:CompileCommand=compileonly,*TestLoopPhiApplyBadType::test*\n@@ -84,1 +111,1 @@\n-            int[] array = test();\n+            int[] array = test1();\n@@ -103,0 +130,8 @@\n+\n+        int gold2 = test2();\n+        for (int i = 0; i < 10; i++) {\n+            int res = test2();\n+            if (gold2 != res) {\n+                throw new RuntimeException(\"Wrong value: \" + res + \" vs \" + gold2);\n+            }\n+        }\n@@ -105,1 +140,1 @@\n-    private static int[] test() {\n+    private static int[] test1() {\n@@ -136,0 +171,11 @@\n+    static int test2() {\n+        int arr[] = new int[400];\n+        int x = 34;\n+        for (int i = 1; i < 50; i++) {\n+            for (int k = 3; 201 > k; ++k) {\n+                x += Math.min(k, arr[k - 1]);\n+            }\n+        }\n+        return x;\n+    }\n+\n","filename":"test\/hotspot\/jtreg\/compiler\/loopopts\/superword\/TestLoopPhiApplyBadType.java","additions":53,"deletions":7,"binary":false,"changes":60,"status":"modified"}]}