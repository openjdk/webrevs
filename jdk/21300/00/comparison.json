{"files":[{"patch":"@@ -302,1 +302,0 @@\n-    private boolean isWide;\n@@ -344,1 +343,1 @@\n-        return opcode;\n+        return opcode & 0xFF;\n@@ -351,1 +350,1 @@\n-        return isWide;\n+        return (opcode & (WIDE << 8)) != 0;\n@@ -414,1 +413,1 @@\n-        return isWide ? getU2Unchecked(bci + 2) : getIndexU1();\n+        return isWide() ? getU2Unchecked(bci + 2) : getIndexU1();\n@@ -446,1 +445,0 @@\n-        isWide = false;\n@@ -451,1 +449,1 @@\n-        if (len <= 0 || (nextBci += len) > end) {\n+        if ((nextBci += len) > end) {\n@@ -460,0 +458,1 @@\n+        int len = -1;\n@@ -461,2 +460,4 @@\n-            if (bci + 1 >= end) {\n-                return -1;\n+            if (bci + 1 < end) {\n+                opcode = (WIDE << 8) | (code = getIndexU1());\n+                \/\/ Validated in UtilTest.testOpcodeLengthTable\n+                len = LENGTHS[code] * 2;\n@@ -464,6 +465,1 @@\n-            opcode = code = getIndexU1();\n-            isWide = true;\n-            \/\/ Validated in UtilTest.testOpcodeLengthTable\n-            return LENGTHS[code] * 2;\n-        }\n-        if (code == TABLESWITCH) {\n+        } else if (code == TABLESWITCH) {\n@@ -471,2 +467,5 @@\n-            if (alignedBci + 3 * 4 >= end) {\n-                return -1;\n+            if (alignedBci + 3 * 4 < end) {\n+                int lo = getIntUnchecked(alignedBci + 1 * 4);\n+                int hi = getIntUnchecked(alignedBci + 2 * 4);\n+                long l = alignedBci - bci + (3L + (long) hi - lo + 1L) * 4L;\n+                len = l > 0 && ((int) l == l) ? (int) l : -1;\n@@ -474,6 +473,1 @@\n-            int lo = getIntUnchecked(alignedBci + 1 * 4);\n-            int hi = getIntUnchecked(alignedBci + 2 * 4);\n-            long l = alignedBci - bci + (3L + (long) hi - lo + 1L) * 4L;\n-            return l > 0 && ((int) l == l) ? (int) l : -1;\n-        }\n-        if (code == LOOKUPSWITCH) {\n+        } else if (code == LOOKUPSWITCH) {\n@@ -481,6 +475,6 @@\n-            if (alignedBci + 2 * 4 >= end) {\n-                return -1;\n-            }\n-            int npairs = getIntUnchecked(alignedBci + 4);\n-            if (npairs < 0) {\n-                return -1;\n+            if (alignedBci + 2 * 4 < end) {\n+                int npairs = getIntUnchecked(alignedBci + 4);\n+                if (npairs >= 0) {\n+                    long l = alignedBci - bci + (2L + 2L * npairs) * 4L;\n+                    len = l > 0 && ((int) l == l) ? (int) l : -1;\n+                }\n@@ -488,2 +482,0 @@\n-            long l = alignedBci - bci + (2L + 2L * npairs) * 4L;\n-            return l > 0 && ((int) l == l) ? (int) l : -1;\n@@ -491,1 +483,4 @@\n-        return -1;\n+        if (len <= 0) {\n+            opcode = ILLEGAL;\n+        }\n+        return len;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/RawBytecodeHelper.java","additions":26,"deletions":31,"binary":false,"changes":57,"status":"modified"}]}