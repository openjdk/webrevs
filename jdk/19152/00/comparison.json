{"files":[{"patch":"@@ -1263,6 +1263,0 @@\n-  \/\/ If a base address is given, it must have valid alignment and be suitable as encoding base.\n-  if (base_address != nullptr) {\n-    assert(is_aligned(base_address, archive_space_alignment),\n-           \"Archive base address invalid: \" PTR_FORMAT \".\", p2i(base_address));\n-  }\n-\n@@ -1272,0 +1266,6 @@\n+\n+    \/\/ When running without class space, requested archive base should be aligned to cds core alignment.\n+    assert(is_aligned(base_address, archive_space_alignment),\n+             \"Archive base address unaligned: \" PTR_FORMAT \", needs alignment: %zu.\",\n+             p2i(base_address), archive_space_alignment);\n+\n@@ -1292,6 +1292,6 @@\n-  \/\/ To simplify matters, lets assume that metaspace alignment will always be\n-  \/\/  equal or a multiple of archive alignment.\n-  assert(is_power_of_2(class_space_alignment) &&\n-                       is_power_of_2(archive_space_alignment) &&\n-                       class_space_alignment >= archive_space_alignment,\n-                       \"Sanity\");\n+  \/\/ When running with class space, requested archive base must satisfy both cds core alignment\n+  \/\/ and class space alignment.\n+  const size_t base_address_alignment = MAX2(class_space_alignment, archive_space_alignment);\n+  assert(is_aligned(base_address, base_address_alignment),\n+           \"Archive base address unaligned: \" PTR_FORMAT \", needs alignment: %zu.\",\n+           p2i(base_address), base_address_alignment);\n@@ -1305,2 +1305,1 @@\n-  const size_t ccs_begin_offset = align_up(base_address + archive_space_size,\n-                                           class_space_alignment) - base_address;\n+  const size_t ccs_begin_offset = align_up(archive_space_size, class_space_alignment);\n@@ -1310,1 +1309,1 @@\n-      align_up(archive_space_size + gap_size + class_space_size, core_region_alignment());\n+      archive_space_size + gap_size + class_space_size;\n@@ -1335,1 +1334,1 @@\n-      total_space_rs = ReservedSpace(total_range_size, archive_space_alignment,\n+      total_space_rs = ReservedSpace(total_range_size, base_address_alignment,\n@@ -1353,1 +1352,1 @@\n-    assert(is_aligned(total_space_rs.base(), archive_space_alignment), \"Sanity\");\n+    assert(is_aligned(total_space_rs.base(), base_address_alignment), \"Sanity\");\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":16,"deletions":17,"binary":false,"changes":33,"status":"modified"}]}