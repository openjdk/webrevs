{"files":[{"patch":"@@ -51,1 +51,0 @@\n-import java.util.concurrent.ConcurrentHashMap;\n@@ -53,0 +52,1 @@\n+import java.util.function.Supplier;\n@@ -736,1 +736,1 @@\n-    public static enum IsoCountryCode {\n+    public enum IsoCountryCode {\n@@ -741,6 +741,1 @@\n-        PART1_ALPHA2 {\n-            @Override\n-            Set<String> createCountryCodeSet() {\n-                return Set.of(Locale.getISOCountries());\n-            }\n-        },\n+        PART1_ALPHA2,\n@@ -753,6 +748,1 @@\n-        PART1_ALPHA3 {\n-            @Override\n-            Set<String> createCountryCodeSet() {\n-                return LocaleISOData.computeISO3166_1Alpha3Countries();\n-            }\n-        },\n+        PART1_ALPHA3,\n@@ -763,25 +753,1 @@\n-        PART3 {\n-            @Override\n-            Set<String> createCountryCodeSet() {\n-                return Set.of(LocaleISOData.ISO3166_3);\n-            }\n-        };\n-\n-        \/**\n-         * Concrete implementation of this method attempts to compute value\n-         * for iso3166CodesMap for each IsoCountryCode type key.\n-         *\/\n-        abstract Set<String> createCountryCodeSet();\n-\n-        \/**\n-         * Map to hold country codes for each ISO3166 part.\n-         *\/\n-        private static final Map<IsoCountryCode, Set<String>> iso3166CodesMap = new ConcurrentHashMap<>();\n-\n-        \/**\n-         * This method is called from Locale class to retrieve country code set\n-         * for getISOCountries(type)\n-         *\/\n-        static Set<String> retrieveISOCountryCodes(IsoCountryCode type) {\n-            return iso3166CodesMap.computeIfAbsent(type, IsoCountryCode::createCountryCodeSet);\n-        }\n+        PART3\n@@ -1007,1 +973,0 @@\n-\n@@ -1014,1 +979,1 @@\n-            return LocaleCache.cache(baseloc);\n+            return LOCALE_CACHE.get().computeIfAbsent(baseloc, LOCALE_CREATOR);\n@@ -1017,1 +982,1 @@\n-            return LocaleCache.cache(key);\n+            return LOCALE_CACHE.get().computeIfAbsent(key, LOCALE_CREATOR);\n@@ -1021,9 +986,7 @@\n-    private static final class LocaleCache implements Function<Object, Locale> {\n-        private static final ReferencedKeyMap<Object, Locale> LOCALE_CACHE\n-                = ReferencedKeyMap.create(true, ReferencedKeyMap.concurrentHashMapSupplier());\n-\n-        private static final Function<Object, Locale> LOCALE_CREATOR = new LocaleCache();\n-\n-        public static Locale cache(Object key) {\n-            return LOCALE_CACHE.computeIfAbsent(key, LOCALE_CREATOR);\n-        }\n+    private static final Supplier<ReferencedKeyMap<Object, Locale>> LOCALE_CACHE =\n+            StableValue.supplier(new Supplier<>() {\n+                @Override\n+                public ReferencedKeyMap<Object, Locale> get() {\n+                    return ReferencedKeyMap.create(true, ReferencedKeyMap.concurrentHashMapSupplier());\n+                }\n+            });\n@@ -1031,0 +994,1 @@\n+    private static final Function<Object, Locale> LOCALE_CREATOR = new Function<>() {\n@@ -1039,1 +1003,1 @@\n-    }\n+    };\n@@ -1304,6 +1268,2 @@\n-        if (isoCountries == null) {\n-            isoCountries = getISO2Table(LocaleISOData.isoCountryTable);\n-        }\n-        String[] result = new String[isoCountries.length];\n-        System.arraycopy(isoCountries, 0, result, 0, isoCountries.length);\n-        return result;\n+        String[] countries = LocaleISOData.ISO_3166_1_ALPHA2.get();\n+        return Arrays.copyOf(countries, countries.length);\n@@ -1322,1 +1282,5 @@\n-        return IsoCountryCode.retrieveISOCountryCodes(type);\n+        return switch (type) {\n+            case PART1_ALPHA2 -> Set.of(LocaleISOData.ISO_3166_1_ALPHA2.get());\n+            case PART1_ALPHA3 -> LocaleISOData.ISO_3166_1_ALPHA3.get();\n+            case PART3 -> LocaleISOData.ISO_3166_3.get();\n+        };\n@@ -1342,16 +1306,2 @@\n-        String[] languages = Locale.isoLanguages;\n-        if (languages == null) {\n-            Locale.isoLanguages = languages = getISO2Table(LocaleISOData.isoLanguageTable);\n-        }\n-        String[] result = new String[languages.length];\n-        System.arraycopy(languages, 0, result, 0, languages.length);\n-        return result;\n-    }\n-\n-    private static String[] getISO2Table(String table) {\n-        int len = table.length() \/ 5;\n-        String[] isoTable = new String[len];\n-        for (int i = 0, j = 0; i < len; i++, j += 5) {\n-            isoTable[i] = table.substring(j, j + 2);\n-        }\n-        return isoTable;\n+        String[] languages = LocaleISOData.ISO_639.get();\n+        return Arrays.copyOf(languages, languages.length);\n@@ -1686,4 +1636,2 @@\n-        String lTag = this.languageTag;\n-        if (lTag != null) {\n-            return lTag;\n-        }\n+        return languageTag.get();\n+    }\n@@ -1691,0 +1639,1 @@\n+    private String computeLanguageTag() {\n@@ -1692,1 +1641,1 @@\n-        StringBuilder buf = new StringBuilder();\n+        StringBuilder bldr = new StringBuilder();\n@@ -1696,1 +1645,1 @@\n-            buf.append(LanguageTag.canonicalizeLanguage(subtag));\n+            bldr.append(LanguageTag.canonicalizeLanguage(subtag));\n@@ -1701,2 +1650,2 @@\n-            buf.append(LanguageTag.SEP);\n-            buf.append(LanguageTag.canonicalizeScript(subtag));\n+            bldr.append(LanguageTag.SEP);\n+            bldr.append(LanguageTag.canonicalizeScript(subtag));\n@@ -1707,2 +1656,2 @@\n-            buf.append(LanguageTag.SEP);\n-            buf.append(LanguageTag.canonicalizeRegion(subtag));\n+            bldr.append(LanguageTag.SEP);\n+            bldr.append(LanguageTag.canonicalizeRegion(subtag));\n@@ -1713,1 +1662,1 @@\n-            buf.append(LanguageTag.SEP);\n+            bldr.append(LanguageTag.SEP);\n@@ -1715,1 +1664,1 @@\n-            buf.append(s);\n+            bldr.append(s);\n@@ -1720,2 +1669,2 @@\n-            buf.append(LanguageTag.SEP);\n-            buf.append(LanguageTag.canonicalizeExtension(s));\n+            bldr.append(LanguageTag.SEP);\n+            bldr.append(LanguageTag.canonicalizeExtension(s));\n@@ -1726,2 +1675,2 @@\n-            if (buf.length() > 0) {\n-                buf.append(LanguageTag.SEP);\n+            if (bldr.length() > 0) {\n+                bldr.append(LanguageTag.SEP);\n@@ -1729,1 +1678,1 @@\n-            buf.append(LanguageTag.PRIVATEUSE).append(LanguageTag.SEP);\n+            bldr.append(LanguageTag.PRIVATEUSE).append(LanguageTag.SEP);\n@@ -1731,1 +1680,1 @@\n-            buf.append(subtag);\n+            bldr.append(subtag);\n@@ -1734,7 +1683,1 @@\n-        String langTag = buf.toString();\n-        synchronized (this) {\n-            if (this.languageTag == null) {\n-                this.languageTag = langTag;\n-            }\n-        }\n-        return langTag;\n+        return bldr.toString();\n@@ -1964,1 +1907,1 @@\n-        String language3 = getISO3Code(lang, LocaleISOData.isoLanguageTable);\n+        String language3 = LocaleISOData.getISO3LangCode(lang);\n@@ -1986,1 +1929,1 @@\n-        String country3 = getISO3Code(baseLocale.getRegion(), LocaleISOData.isoCountryTable);\n+        String country3 = LocaleISOData.getISO3CtryCode(baseLocale.getRegion());\n@@ -1994,21 +1937,0 @@\n-    private static String getISO3Code(String iso2Code, String table) {\n-        int codeLength = iso2Code.length();\n-        if (codeLength == 0) {\n-            return \"\";\n-        }\n-\n-        int tableLength = table.length();\n-        int index = tableLength;\n-        if (codeLength == 2) {\n-            char c1 = iso2Code.charAt(0);\n-            char c2 = iso2Code.charAt(1);\n-            for (index = 0; index < tableLength; index += 5) {\n-                if (table.charAt(index) == c1\n-                    && table.charAt(index + 1) == c2) {\n-                    break;\n-                }\n-            }\n-        }\n-        return index < tableLength ? table.substring(index + 2, index + 5) : null;\n-    }\n-\n@@ -2396,1 +2318,7 @@\n-    private transient volatile String languageTag;\n+    private final transient Supplier<String> languageTag =\n+            StableValue.supplier(new Supplier<>() {\n+                @Override\n+                public String get() {\n+                    return computeLanguageTag();\n+                }\n+            });\n@@ -2590,4 +2518,0 @@\n-    private static volatile String[] isoLanguages;\n-\n-    private static volatile String[] isoCountries;\n-\n","filename":"src\/java.base\/share\/classes\/java\/util\/Locale.java","additions":52,"deletions":128,"binary":false,"changes":180,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,3 @@\n+import java.util.function.Supplier;\n+\n+\/\/ Methods and suppliers for producing ISO 639\/3166 resources used by Locale.\n@@ -29,0 +32,33 @@\n+\n+    static final Supplier<String[]> ISO_639 =\n+            StableValue.supplier(new Supplier<>() {\n+                @Override\n+                public String[] get() {\n+                    return getISO2Table(isoLanguageTable);\n+                }\n+            });\n+\n+    static final Supplier<String[]> ISO_3166_1_ALPHA2 =\n+            StableValue.supplier(new Supplier<>() {\n+                @Override\n+                public String[] get() {\n+                    return getISO2Table(isoCountryTable);\n+                }\n+            });\n+\n+    static final Supplier<Set<String>> ISO_3166_1_ALPHA3 =\n+            StableValue.supplier(new Supplier<>() {\n+                @Override\n+                public Set<String> get() {\n+                    return computeISO3166_1Alpha3Countries();\n+                }\n+            });\n+\n+    static final Supplier<Set<String>> ISO_3166_3 =\n+            StableValue.supplier(new Supplier<>() {\n+                @Override\n+                public Set<String> get() {\n+                    return Set.of(ISO3166_3);\n+                }\n+            });\n+\n@@ -32,1 +68,1 @@\n-    static final String isoLanguageTable =\n+    private static final String isoLanguageTable =\n@@ -226,1 +262,1 @@\n-    static final String isoCountryTable =\n+    private static final String isoCountryTable =\n@@ -483,1 +519,1 @@\n-    static final String[] ISO3166_3 = {\n+    private static final String[] ISO3166_3 = {\n@@ -490,0 +526,42 @@\n+    static String getISO3LangCode(String language) {\n+        return getISO3Code(language, isoLanguageTable);\n+    }\n+\n+    static String getISO3CtryCode(String country) {\n+        return getISO3Code(country, isoCountryTable);\n+    }\n+\n+    private static String getISO3Code(String iso2Code, String table) {\n+        int codeLength = iso2Code.length();\n+        if (codeLength == 0) {\n+            return \"\";\n+        }\n+\n+        int tableLength = table.length();\n+        int index = tableLength;\n+        if (codeLength == 2) {\n+            char c1 = iso2Code.charAt(0);\n+            char c2 = iso2Code.charAt(1);\n+            for (index = 0; index < tableLength; index += 5) {\n+                if (table.charAt(index) == c1\n+                        && table.charAt(index + 1) == c2) {\n+                    break;\n+                }\n+            }\n+        }\n+        return index < tableLength ? table.substring(index + 2, index + 5) : null;\n+    }\n+\n+    \/**\n+     * This method computes an array of alpha-2 codes from either ISO639 or\n+     * ISO3166.\n+     *\/\n+    private static String[] getISO2Table(String table) {\n+        int len = table.length() \/ 5;\n+        String[] isoTable = new String[len];\n+        for (int i = 0, j = 0; i < len; i++, j += 5) {\n+            isoTable[i] = table.substring(j, j + 2);\n+        }\n+        return isoTable;\n+    }\n+\n@@ -494,1 +572,1 @@\n-    static Set<String> computeISO3166_1Alpha3Countries() {\n+    private static Set<String> computeISO3166_1Alpha3Countries() {\n@@ -503,2 +581,1 @@\n-    private LocaleISOData() {\n-    }\n+    private LocaleISOData() {}\n","filename":"src\/java.base\/share\/classes\/java\/util\/LocaleISOData.java","additions":84,"deletions":7,"binary":false,"changes":91,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -41,0 +41,1 @@\n+import java.util.function.Supplier;\n@@ -93,0 +94,9 @@\n+    \/\/ Interned BaseLocale cache\n+    private static final Supplier<ReferencedKeySet<BaseLocale>> CACHE =\n+            StableValue.supplier(new Supplier<>() {\n+                @Override\n+                public ReferencedKeySet<BaseLocale> get() {\n+                    return ReferencedKeySet.create(true, ReferencedKeySet.concurrentHashMapSupplier());\n+                }\n+            });\n+\n@@ -167,5 +177,1 @@\n-        class InterningCache { \/\/ TODO: StableValue\n-            private static final ReferencedKeySet<BaseLocale> CACHE =\n-                    ReferencedKeySet.create(true, ReferencedKeySet.concurrentHashMapSupplier());\n-        }\n-        return InterningCache.CACHE.intern(new BaseLocale(\n+        return CACHE.get().intern(new BaseLocale(\n","filename":"src\/java.base\/share\/classes\/sun\/util\/locale\/BaseLocale.java","additions":12,"deletions":6,"binary":false,"changes":18,"status":"modified"}]}