{"files":[{"patch":"@@ -128,7 +128,0 @@\n-          # Rename full pdb files for symbols bundle\n-          ifeq ($(call isTargetOs, windows)+$(SHIP_DEBUG_SYMBOLS), true+public)\n-\t    for f in `$(FIND) $(SUPPORT_OUTPUTDIR)\/bundles\/$1\/$$($1_SUBDIR) -name \"*.full.pdb\"`; do \\\n-\t      $(ECHO) Renaming $$$${f} to $$$${f%full.pdb}pdb $(LOG_INFO); \\\n-\t      $(MV) $$$${f} $$$${f%full.pdb}pdb; \\\n-\t    done\n-          endif\n@@ -225,5 +218,0 @@\n-    else\n-      ifeq ($(SHIP_DEBUG_SYMBOLS), public)\n-        JDK_SYMBOLS_EXCLUDE_PATTERN := \\\n-            $(filter %.full.pdb, $(ALL_JDK_FILES))\n-      endif\n@@ -244,4 +232,1 @@\n-      $(filter-out \\\n-          %.stripped.pdb, \\\n-          $(call FindFiles, $(SYMBOLS_IMAGE_DIR)) \\\n-      )\n+      $(call FindFiles, $(SYMBOLS_IMAGE_DIR))\n@@ -267,5 +252,0 @@\n-    else\n-      ifeq ($(SHIP_DEBUG_SYMBOLS), public)\n-        JRE_SYMBOLS_EXCLUDE_PATTERN := \\\n-            $(filter %.full.pdb, $(ALL_JRE_FILES))\n-      endif\n","filename":"make\/Bundles.gmk","additions":1,"deletions":21,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -70,0 +70,1 @@\n+        NAME_MACRO := rename_stripped \\\n@@ -87,0 +88,1 @@\n+        NAME_MACRO := rename_stripped \\\n","filename":"make\/CreateJmods.gmk","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -285,1 +285,32 @@\n-# Param 1 - either JDK or JRE\n+# In case of Windows and --with-external-symbols-in-bundles=public:\n+# Copy *.stripped.pdb files to images, renamed to *.pdb.\n+ifeq ($(call isTargetOs, windows)+$(SHIP_DEBUG_SYMBOLS), true+public)\n+  rename_stripped = $(patsubst %.stripped.pdb,%.pdb,$1)\n+\n+  SetupCopyStrippedDebuginfo = \\\n+      $(foreach m, $(ALL_$1_MODULES), \\\n+        $(eval $(call SetupCopyFiles, COPY_$1_LIBS_DEBUGINFO_$m, \\\n+            SRC := $(SUPPORT_OUTPUTDIR)\/modules_libs\/$m, \\\n+            DEST := $($1_IMAGE_DIR)\/$(LIBS_TARGET_SUBDIR), \\\n+            FILES := $(filter %.stripped.pdb, \\\n+                $(call FindDebuginfoFiles,$(SUPPORT_OUTPUTDIR)\/modules_libs\/$m)), \\\n+            NAME_MACRO := rename_stripped \\\n+        )) \\\n+        $(eval $1_TARGETS += $$(COPY_$1_LIBS_DEBUGINFO_$m)) \\\n+        $(eval $(call SetupCopyFiles, COPY_$1_CMDS_DEBUGINFO_$m, \\\n+            SRC := $(SUPPORT_OUTPUTDIR)\/modules_cmds\/$m, \\\n+            DEST := $($1_IMAGE_DIR)\/$(CMDS_TARGET_SUBDIR), \\\n+            FILES := $(filter %.stripped.pdb, \\\n+                $(call FindDebuginfoFiles,$(SUPPORT_OUTPUTDIR)\/modules_cmds\/$m)), \\\n+            NAME_MACRO := rename_stripped \\\n+        )) \\\n+        $(eval $1_TARGETS += $$(COPY_$1_CMDS_DEBUGINFO_$m)) \\\n+      )\n+\n+  # No space before argument to avoid having to put $(strip ) everywhere in implementation above.\n+  $(call SetupCopyStrippedDebuginfo,JDK)\n+  $(call SetupCopyStrippedDebuginfo,JRE)\n+endif\n+\n+# Copy debug info files into symbols bundle.\n+# In case of Windows and --with-external-symbols-in-bundles=public, take care to remove *.stripped.pdb files\n@@ -288,0 +319,4 @@\n+      $(eval DBGFILES := $(call FindDebuginfoFiles, $(SUPPORT_OUTPUTDIR)\/modules_libs\/$m)) \\\n+      $(eval DBGFILES := $(if $(filter true+public,$(call isTargetOs,windows)+$(SHIP_DEBUG_SYMBOLS)), \\\n+        $(filter-out %.stripped.pdb,$(DBGFILES)),$(DBGFILES)) \\\n+      ) \\\n@@ -291,2 +326,1 @@\n-          FILES := $(call FindDebuginfoFiles, \\\n-              $(SUPPORT_OUTPUTDIR)\/modules_libs\/$m), \\\n+          FILES := $(DBGFILES), \\\n@@ -295,0 +329,4 @@\n+      $(eval DBGFILES := $(call FindDebuginfoFiles, $(SUPPORT_OUTPUTDIR)\/modules_cmds\/$m)) \\\n+      $(eval DBGFILES := $(if $(filter true+public,$(call isTargetOs,windows)+$(SHIP_DEBUG_SYMBOLS)), \\\n+        $(filter-out %.stripped.pdb,$(DBGFILES)),$(DBGFILES)) \\\n+      ) \\\n@@ -298,2 +336,1 @@\n-          FILES := $(call FindDebuginfoFiles, \\\n-              $(SUPPORT_OUTPUTDIR)\/modules_cmds\/$m), \\\n+          FILES := $(DBGFILES), \\\n@@ -304,4 +341,1 @@\n-# No space before argument to avoid having to put $(strip ) everywhere in\n-# implementation above.\n-$(call SetupCopyDebuginfo,JDK)\n-$(call SetupCopyDebuginfo,JRE)\n+# No space before argument to avoid having to put $(strip ) everywhere in implementation above.\n","filename":"make\/Images.gmk","additions":43,"deletions":9,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -154,0 +154,6 @@\n+ifeq ($(SHIP_DEBUG_SYMBOLS), full)\n+  CFLAGS_SHIP_DEBUGINFO := -DSHIP_DEBUGINFO_FULL\n+else ifeq ($(SHIP_DEBUG_SYMBOLS), public)\n+  CFLAGS_SHIP_DEBUGINFO := -DSHIP_DEBUGINFO_PUBLIC\n+endif\n+\n@@ -161,4 +167,0 @@\n-  ifeq ($(SHIP_DEBUG_SYMBOLS), public)\n-    CFLAGS_STRIPPED_DEBUGINFO := -DHAS_STRIPPED_DEBUGINFO\n-  endif\n-\n@@ -190,1 +192,1 @@\n-    whitebox.cpp_CXXFLAGS := $(CFLAGS_STRIPPED_DEBUGINFO), \\\n+    whitebox.cpp_CXXFLAGS := $(CFLAGS_SHIP_DEBUGINFO), \\\n","filename":"make\/hotspot\/lib\/CompileJvm.gmk","additions":7,"deletions":5,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -511,2 +511,10 @@\n-WB_ENTRY(jboolean, WB_HasExternalSymbolsStripped(JNIEnv* env, jobject o))\n-#if defined(HAS_STRIPPED_DEBUGINFO)\n+WB_ENTRY(jboolean, WB_ShipDebugInfoFull(JNIEnv* env, jobject o))\n+#if defined(SHIP_DEBUGINFO_FULL)\n+  return true;\n+#else\n+  return false;\n+#endif\n+WB_END\n+\n+WB_ENTRY(jboolean, WB_ShipDebugInfoPublic(JNIEnv* env, jobject o))\n+#if defined(SHIP_DEBUGINFO_PUBLIC)\n@@ -2843,1 +2851,2 @@\n-  {CC\"hasExternalSymbolsStripped\",       CC\"()Z\",                   (void*)&WB_HasExternalSymbolsStripped},\n+  {CC\"shipsFullDebugInfo\",               CC\"()Z\",                   (void*)&WB_ShipDebugInfoFull},\n+  {CC\"shipsPublicDebugInfo\",             CC\"()Z\",                   (void*)&WB_ShipDebugInfoPublic},\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":12,"deletions":3,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -66,4 +66,3 @@\n-    \/\/ Windows has source information only in full pdbs, not in stripped pdbs\n-    private static boolean expectSourceInformation = Platform.isLinux() || Platform.isWindows();\n-\n-    static WhiteBox wb = WhiteBox.getWhiteBox();\n+    \/\/ Windows could have stripped pdbs in some configurations which do not have source information\n+    private static boolean expectSourceInformation = Platform.isLinux() ||\n+        (Platform.isWindows() && !WhiteBox.getWhiteBox().shipsPublicDebugInfo());\n@@ -148,5 +147,0 @@\n-        if (wb.hasExternalSymbolsStripped()) {\n-            expectSourceInformation = false;\n-        }\n-\n-        System.out.println(\"Looking for source information:\");\n@@ -154,0 +148,1 @@\n+            System.out.println(\"Looking for source information:\");\n","filename":"test\/hotspot\/jtreg\/runtime\/NMT\/CheckForProperDetailStackTrace.java","additions":4,"deletions":9,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+ * @library \/test\/lib\n@@ -29,2 +30,4 @@\n- * @run main JmodExcludedFiles\n- * @summary Test that JDK JMOD files do not include native debug symbols\n+ * @build jdk.test.whitebox.WhiteBox\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller jdk.test.whitebox.WhiteBox\n+ * @run main\/othervm -Xbootclasspath\/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI JmodExcludedFiles\n+ * @summary Test that JDK JMOD files do not include native debug symbols when it is not configured\n@@ -40,0 +43,1 @@\n+import jdk.test.whitebox.WhiteBox;\n@@ -43,0 +47,1 @@\n+    private static final boolean expectSymbols = WhiteBox.getWhiteBox().shipsDebugInfo();\n@@ -79,1 +84,1 @@\n-                            return true;\n+                            return expectSymbols ? false: true;\n@@ -84,7 +89,2 @@\n-                    \/\/ on Windows we check if we should have public symbols through --with-external-symbols-in-bundles=public (JDK-8237192)\n-                    String fullpdb = javaHome + \"\/bin\/\" + name.substring(index + 1, name.length() - 4) + \".full.pdb\";\n-                    if (!Files.exists(Paths.get(fullpdb))) {\n-                        System.err.println(\"Found symbols in \" + jmod + \": \" + name +\n-                                \". No full pdb file \" + fullpdb + \" exists.\");\n-                        return true;\n-                    }\n+                    System.err.println(\"Found symbols in \" + jmod + \": \" + name);\n+                    return expectSymbols ? false: true;\n@@ -96,1 +96,1 @@\n-                    return true;\n+                    return expectSymbols ? false: true;\n","filename":"test\/jdk\/jdk\/modules\/etc\/JmodExcludedFiles.java","additions":11,"deletions":11,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -69,1 +69,1 @@\n-  public           long getObjectAddress(Object o) {\n+  public         long getObjectAddress(Object o) {\n@@ -81,1 +81,6 @@\n-  public native boolean  hasExternalSymbolsStripped();\n+  public native boolean  shipsFullDebugInfo();\n+  public native boolean  shipsPublicDebugInfo();\n+\n+  public        boolean  shipsDebugInfo() {\n+    return shipsFullDebugInfo() || shipsPublicDebugInfo();\n+  }\n","filename":"test\/lib\/jdk\/test\/whitebox\/WhiteBox.java","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"}]}