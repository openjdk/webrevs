{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -92,1 +92,3 @@\n-            certCache.clear();\n+            synchronized (certCache) {\n+                certCache.clear();\n+            }\n@@ -115,3 +117,4 @@\n-        cert = new X509CertImpl(encoding);\n-        addToCache(certCache, cert.getEncodedInternal(), cert);\n-        return cert;\n+        \/\/ Build outside lock\n+        X509CertImpl newCert = new X509CertImpl(encoding);\n+        byte[] enc = newCert.getEncodedInternal();\n+        return addToCache(certCache, enc, newCert);\n@@ -159,1 +162,1 @@\n-    public static synchronized X509CertImpl intern(X509Certificate c)\n+    public static X509CertImpl intern(X509Certificate c)\n@@ -171,9 +174,4 @@\n-        X509CertImpl newC = getFromCache(certCache, encoding);\n-        if (newC != null) {\n-            return newC;\n-        }\n-        if (isImpl) {\n-            newC = (X509CertImpl)c;\n-        } else {\n-            newC = new X509CertImpl(encoding);\n-            encoding = newC.getEncodedInternal();\n+        \/\/ First check under per-cache lock\n+        X509CertImpl cached = getFromCache(certCache, encoding);\n+        if (cached != null) {\n+            return cached;\n@@ -181,2 +179,5 @@\n-        addToCache(certCache, encoding, newC);\n-        return newC;\n+\n+        \/\/ Build outside lock\n+        X509CertImpl newC = isImpl ? (X509CertImpl) c : new X509CertImpl(encoding);\n+        byte[] enc = isImpl ? encoding : newC.getEncodedInternal();\n+        return addToCache(certCache, enc, newC);\n@@ -195,1 +196,1 @@\n-    public static synchronized X509CRLImpl intern(X509CRL c)\n+    public static X509CRLImpl intern(X509CRL c)\n@@ -207,9 +208,3 @@\n-        X509CRLImpl newC = getFromCache(crlCache, encoding);\n-        if (newC != null) {\n-            return newC;\n-        }\n-        if (isImpl) {\n-            newC = (X509CRLImpl)c;\n-        } else {\n-            newC = new X509CRLImpl(encoding);\n-            encoding = newC.getEncodedInternal();\n+        X509CRLImpl cached = getFromCache(crlCache, encoding);\n+        if (cached != null) {\n+            return cached;\n@@ -217,2 +212,4 @@\n-        addToCache(crlCache, encoding, newC);\n-        return newC;\n+\n+        X509CRLImpl newC = isImpl ? (X509CRLImpl) c : new X509CRLImpl(encoding);\n+        byte[] enc = isImpl ? encoding : newC.getEncodedInternal();\n+        return addToCache(crlCache, enc, newC);\n@@ -224,4 +221,4 @@\n-    private static synchronized <K,V> V getFromCache(Cache<K,V> cache,\n-            byte[] encoding) {\n-        Object key = new Cache.EqualByteArray(encoding);\n-        return cache.get(key);\n+    private static <V> V getFromCache(Cache<Object, V> cache, byte[] encoding) {\n+        synchronized (cache) {\n+            return cache.get(new Cache.EqualByteArray(encoding));\n+        }\n@@ -233,2 +230,1 @@\n-    private static synchronized <V> void addToCache(Cache<Object, V> cache,\n-            byte[] encoding, V value) {\n+    private static <V> V addToCache(Cache<Object, V> cache, byte[] encoding, V value) {\n@@ -236,1 +232,10 @@\n-            return;\n+            return value;\n+        }\n+        synchronized (cache) {\n+            Object key = new Cache.EqualByteArray(encoding);\n+            V existing = cache.get(key);\n+            if (existing != null) {\n+                return existing;\n+            }\n+            cache.put(key, value);\n+            return value;\n@@ -238,2 +243,0 @@\n-        Object key = new Cache.EqualByteArray(encoding);\n-        cache.put(key, value);\n@@ -242,0 +245,1 @@\n+\n@@ -386,1 +390,3 @@\n-            crlCache.clear();\n+            synchronized (crlCache) {\n+                crlCache.clear();\n+            }\n@@ -392,3 +398,3 @@\n-                X509CRLImpl crl = getFromCache(crlCache, encoding);\n-                if (crl != null) {\n-                    return crl;\n+                X509CRLImpl cached = getFromCache(crlCache, encoding);\n+                if (cached != null) {\n+                    return cached;\n@@ -396,3 +402,4 @@\n-                crl = new X509CRLImpl(encoding);\n-                addToCache(crlCache, crl.getEncodedInternal(), crl);\n-                return crl;\n+                \/\/ Build outside lock\n+                X509CRLImpl crl = new X509CRLImpl(encoding);\n+                byte[] enc = crl.getEncodedInternal();\n+                return addToCache(crlCache, enc, crl);\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/X509Factory.java","additions":52,"deletions":45,"binary":false,"changes":97,"status":"modified"}]}