{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -115,3 +115,4 @@\n-        cert = new X509CertImpl(encoding);\n-        addToCache(certCache, cert.getEncodedInternal(), cert);\n-        return cert;\n+        \/\/ Build outside lock\n+        X509CertImpl newCert = new X509CertImpl(encoding);\n+        byte[] enc = newCert.getEncodedInternal();\n+        return addIfNotPresent(certCache, enc, newCert);\n@@ -159,1 +160,1 @@\n-    public static synchronized X509CertImpl intern(X509Certificate c)\n+    public static X509CertImpl intern(X509Certificate c)\n@@ -171,3 +172,4 @@\n-        X509CertImpl newC = getFromCache(certCache, encoding);\n-        if (newC != null) {\n-            return newC;\n+        \/\/ First check under per-cache lock\n+        X509CertImpl cached = getFromCache(certCache, encoding);\n+        if (cached != null) {\n+            return cached;\n@@ -175,0 +177,4 @@\n+\n+        \/\/ Build outside lock\n+        X509CertImpl newC;\n+        byte[] enc;\n@@ -176,1 +182,2 @@\n-            newC = (X509CertImpl)c;\n+            newC = (X509CertImpl) c;\n+            enc = encoding;\n@@ -179,1 +186,1 @@\n-            encoding = newC.getEncodedInternal();\n+            enc = newC.getEncodedInternal();\n@@ -181,2 +188,1 @@\n-        addToCache(certCache, encoding, newC);\n-        return newC;\n+        return addIfNotPresent(certCache, enc, newC);\n@@ -195,1 +201,1 @@\n-    public static synchronized X509CRLImpl intern(X509CRL c)\n+    public static X509CRLImpl intern(X509CRL c)\n@@ -207,3 +213,3 @@\n-        X509CRLImpl newC = getFromCache(crlCache, encoding);\n-        if (newC != null) {\n-            return newC;\n+        X509CRLImpl cached = getFromCache(crlCache, encoding);\n+        if (cached != null) {\n+            return cached;\n@@ -211,0 +217,3 @@\n+\n+        X509CRLImpl newC;\n+        byte[] enc;\n@@ -212,1 +221,2 @@\n-            newC = (X509CRLImpl)c;\n+            newC = (X509CRLImpl) c;\n+            enc = encoding;\n@@ -215,1 +225,1 @@\n-            encoding = newC.getEncodedInternal();\n+            enc = newC.getEncodedInternal();\n@@ -217,2 +227,1 @@\n-        addToCache(crlCache, encoding, newC);\n-        return newC;\n+        return addIfNotPresent(crlCache, enc, newC);\n@@ -224,4 +233,4 @@\n-    private static synchronized <K,V> V getFromCache(Cache<K,V> cache,\n-            byte[] encoding) {\n-        Object key = new Cache.EqualByteArray(encoding);\n-        return cache.get(key);\n+    private static <V> V getFromCache(Cache<Object, V> cache, byte[] encoding) {\n+        synchronized (cache) {\n+            return cache.get(new Cache.EqualByteArray(encoding));\n+        }\n@@ -233,2 +242,1 @@\n-    private static synchronized <V> void addToCache(Cache<Object, V> cache,\n-            byte[] encoding, V value) {\n+    private static <V> V addIfNotPresent(Cache<Object, V> cache, byte[] encoding, V value) {\n@@ -236,1 +244,10 @@\n-            return;\n+            return value;\n+        }\n+        synchronized (cache) {\n+            Object key = new Cache.EqualByteArray(encoding);\n+            V existing = cache.get(key);\n+            if (existing != null) {\n+                return existing;\n+            }\n+            cache.put(key, value);\n+            return value;\n@@ -238,2 +255,0 @@\n-        Object key = new Cache.EqualByteArray(encoding);\n-        cache.put(key, value);\n@@ -392,3 +407,3 @@\n-                X509CRLImpl crl = getFromCache(crlCache, encoding);\n-                if (crl != null) {\n-                    return crl;\n+                X509CRLImpl cached = getFromCache(crlCache, encoding);\n+                if (cached != null) {\n+                    return cached;\n@@ -396,3 +411,4 @@\n-                crl = new X509CRLImpl(encoding);\n-                addToCache(crlCache, crl.getEncodedInternal(), crl);\n-                return crl;\n+                \/\/ Build outside lock\n+                X509CRLImpl crl = new X509CRLImpl(encoding);\n+                byte[] enc = crl.getEncodedInternal();\n+                return addIfNotPresent(crlCache, enc, crl);\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/X509Factory.java","additions":51,"deletions":35,"binary":false,"changes":86,"status":"modified"}]}