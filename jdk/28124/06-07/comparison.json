{"files":[{"patch":"@@ -402,1 +402,1 @@\n-        Preconditions.checkFromIndexSize(offset, length, this.length, new BoundsCheckHandler(this, BoundPolicy.SLICE));\n+        checkBounds(offset, length, BoundPolicy.SLICE);\n@@ -407,1 +407,10 @@\n-        Preconditions.checkFromIndexSize(offset, length, this.length, new BoundsCheckHandler(this, BoundPolicy.ACCESS));\n+        checkBounds(offset, length, BoundPolicy.ACCESS);\n+    }\n+\n+    @ForceInline\n+    private void checkBounds(long offset, long length, BoundPolicy policy) {\n+        if (length > 0) {\n+            Preconditions.checkIndex(offset, this.length - length + 1, new BoundsCheckHandler(this, policy));\n+        } else if (length < 0 || offset < 0 || offset > this.length - length) {\n+            throw policy.outOfBoundException(this, offset, length, this.length);\n+        }\n@@ -521,0 +530,5 @@\n+        private IndexOutOfBoundsException outOfBoundException(AbstractMemorySegmentImpl segment, long offset, long size,\n+                                                              long length) {\n+            return new IndexOutOfBoundsException(format(segment, offset, size, length));\n+        }\n+\n@@ -534,4 +548,3 @@\n-        public IndexOutOfBoundsException apply(String s, List<Number> args) {\n-            long offset = args.get(0).longValue();\n-            long size   = args.get(1).longValue();\n-            long length = args.get(2).longValue();\n+        public IndexOutOfBoundsException apply(String s, List<Number> numbers) {\n+            long offset = numbers.get(0).longValue();\n+            long length = segment.byteSize() - numbers.get(1).longValue() + 1;\n@@ -539,2 +552,1 @@\n-            String msg = policy.format(segment, offset, size, length);\n-            return new IndexOutOfBoundsException(msg);\n+            return policy.outOfBoundException(segment, offset, length, segment.byteSize());\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/AbstractMemorySegmentImpl.java","additions":20,"deletions":8,"binary":false,"changes":28,"status":"modified"}]}