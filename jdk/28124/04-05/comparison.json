{"files":[{"patch":"@@ -400,14 +400,0 @@\n-    @ForceInline\n-    private void checkBounds(long offset, long length, BoundPolicy policy) {\n-        if (length > 0) {\n-            Preconditions.checkIndex(offset, this.length - length + 1, (s, nums) -> {\n-                        long off = nums.get(0).longValue();\n-                        long len = this.byteSize() - nums.get(1).longValue() + 1;\n-                        return policy.makeException(this, off, len);\n-                    }\n-            );\n-        } else {\n-            policy.validate(this, offset, length);\n-        }\n-    }\n-\n@@ -416,1 +402,1 @@\n-        checkBounds(offset, length, SLICE_POLICY);\n+        Preconditions.checkFromIndexSize(offset, length, this.length, this::sliceOutOfBoundException);\n@@ -421,1 +407,1 @@\n-        checkBounds(offset, length, ACCESS_POLICY);\n+        Preconditions.checkFromIndexSize(offset, length, this.length, this::accessOutOfBoundException);\n@@ -439,0 +425,24 @@\n+    private IndexOutOfBoundsException sliceOutOfBoundException(String s, List<Number> numbers) {\n+        return outOfBoundException(BoundPolicy.SLICE, numbers);\n+    }\n+\n+    private IndexOutOfBoundsException accessOutOfBoundException(String s, List<Number> numbers) {\n+        return outOfBoundException(BoundPolicy.ACCESS, numbers);\n+    }\n+\n+    private IndexOutOfBoundsException outOfBoundException(BoundPolicy policy, List<Number> numbers) {\n+        long offset = numbers.get(0).longValue();\n+        long length = numbers.get(1).longValue();\n+        long totalLength = numbers.get(2).longValue();\n+\n+        String msg = switch (policy) {\n+            case BoundPolicy.SLICE  -> \"attempting to get slice of length\";\n+            case BoundPolicy.ACCESS -> \"attempting to access an element of length\";\n+        };\n+\n+        return new IndexOutOfBoundsException(String.format(\"Out of bound access on segment %s; \" +\n+                        \"%s %d at offset %d \" +\n+                        \"which is outside the valid range 0 <= offset+length < byteSize (=%d)\",\n+                this, msg, length, offset, totalLength));\n+    }\n+\n@@ -513,16 +523,2 @@\n-    private interface BoundPolicy {\n-        default void validate(AbstractMemorySegmentImpl segment, long offset, long length) {\n-            if (!isValid(offset, length, segment.length)) {\n-                throw makeException(segment, offset, length);\n-            }\n-        }\n-\n-        default boolean isValid(long offset, long length, long totalLength) {\n-            return length >= 0 && offset >= 0 && offset <= totalLength - length;\n-        }\n-\n-        String formatExceptionMessage(AbstractMemorySegmentImpl segment, long offset, long length);\n-\n-        default IndexOutOfBoundsException makeException(AbstractMemorySegmentImpl segment, long offset, long length) {\n-            return new IndexOutOfBoundsException(formatExceptionMessage(segment, offset, length));\n-        }\n+    private enum BoundPolicy {\n+        SLICE, ACCESS\n@@ -531,20 +527,0 @@\n-    private static final BoundPolicy ACCESS_POLICY = new BoundPolicy() {\n-        @Override\n-        public String formatExceptionMessage(AbstractMemorySegmentImpl segment, long offset, long length) {\n-            return String.format(\"Out of bound access on segment %s; \" +\n-                            \"attempting to access an element of length %d at offset %d \" +\n-                            \"which is outside the valid range 0 <= offset+length < byteSize (=%d)\",\n-                    segment, length, offset, segment.byteSize());\n-        }\n-    };\n-\n-    private final static BoundPolicy SLICE_POLICY = new BoundPolicy() {\n-        @Override\n-        public String formatExceptionMessage(AbstractMemorySegmentImpl segment, long offset, long length) {\n-            return String.format(\"Out of bound access on segment %s; \" +\n-                            \"attempting to get slice of length %d at offset %d \" +\n-                            \"which is outside the valid range 0 <= offset+length < byteSize (=%d)\",\n-                    segment, length, offset, segment.byteSize());\n-        }\n-    };\n-\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/AbstractMemorySegmentImpl.java","additions":28,"deletions":52,"binary":false,"changes":80,"status":"modified"}]}