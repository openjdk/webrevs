{"files":[{"patch":"@@ -71,1 +71,1 @@\n-        implements MemorySegment, SegmentAllocator, BiFunction<String, List<Number>, RuntimeException>\n+        implements MemorySegment, SegmentAllocator\n@@ -103,1 +103,1 @@\n-        checkBounds(offset, newSize);\n+        checkSliceBounds(offset, newSize);\n@@ -109,1 +109,1 @@\n-        checkBounds(offset, 0);\n+        checkSliceBounds(offset, 0);\n@@ -115,1 +115,1 @@\n-        checkBounds(offset, newSize);\n+        checkSliceBounds(offset, newSize);\n@@ -357,1 +357,1 @@\n-        checkBounds(offset, length);\n+        checkAccessBounds(offset, length);\n@@ -401,1 +401,1 @@\n-    void checkBounds(long offset, long length) {\n+    private void checkBounds(long offset, long length, BoundPolicy policy) {\n@@ -403,4 +403,8 @@\n-            Preconditions.checkIndex(offset, this.length - length + 1, this);\n-        } else if (length < 0 || offset < 0 ||\n-                offset > this.length - length) {\n-            throw outOfBoundException(offset, length);\n+            Preconditions.checkIndex(offset, this.length - length + 1, (s, nums) -> {\n+                        long off = nums.get(0).longValue();\n+                        long len = this.byteSize() - nums.get(1).longValue() + 1;\n+                        return policy.makeException(this, off, len);\n+                    }\n+            );\n+        } else if (!policy.isValid(offset, length, this.length)) {\n+            throw policy.makeException(this, offset, length);\n@@ -410,5 +414,8 @@\n-    @Override\n-    public RuntimeException apply(String s, List<Number> numbers) {\n-        long offset = numbers.get(0).longValue();\n-        long length = byteSize() - numbers.get(1).longValue() + 1;\n-        return outOfBoundException(offset, length);\n+    @ForceInline\n+    void checkSliceBounds(long offset, long length) {\n+        checkBounds(offset, length, SLICE_POLICY);\n+    }\n+\n+    @ForceInline\n+    void checkAccessBounds(long offset, long length) {\n+        checkBounds(offset, length, ACCESS_POLICY);\n@@ -432,7 +439,0 @@\n-    private IndexOutOfBoundsException outOfBoundException(long offset, long length) {\n-        return new IndexOutOfBoundsException(String.format(\"Out of bound access on segment %s; \" +\n-                        \"attempting to access an element of length %d at offset %d \" +\n-                        \"which is outside the valid range 0 <= offset+length < byteSize (=%d)\",\n-                        this, length, offset, byteSize()));\n-    }\n-\n@@ -513,0 +513,40 @@\n+    private interface BoundPolicy {\n+        boolean isValid(long offset, long length, long totalLength);\n+\n+        String formatExceptionMessage(AbstractMemorySegmentImpl segment, long offset, long length);\n+\n+        default IndexOutOfBoundsException makeException(AbstractMemorySegmentImpl segment, long offset, long length) {\n+            return new IndexOutOfBoundsException(formatExceptionMessage(segment, offset, length));\n+        }\n+    }\n+\n+    private static final BoundPolicy ACCESS_POLICY = new BoundPolicy() {\n+        @Override\n+        public boolean isValid(long offset, long length, long totalLength) {\n+            return length > 0 && offset >= 0 && offset <= totalLength - length;\n+        }\n+\n+        @Override\n+        public String formatExceptionMessage(AbstractMemorySegmentImpl segment, long offset, long length) {\n+            return String.format(\"Out of bound access on segment %s; \" +\n+                            \"attempting to access an element of length %d at offset %d \" +\n+                            \"which is outside the valid range 0 < offset+length < byteSize (=%d)\",\n+                    segment, length, offset, segment.byteSize());\n+        }\n+    };\n+\n+    private final static BoundPolicy SLICE_POLICY = new BoundPolicy() {\n+        @Override\n+        public boolean isValid(long offset, long length, long totalLength) {\n+            return length >= 0 && offset >= 0 && offset <= totalLength - length;\n+        }\n+\n+        @Override\n+        public String formatExceptionMessage(AbstractMemorySegmentImpl segment, long offset, long length) {\n+            return String.format(\"Out of bound access on segment %s; \" +\n+                            \"attempting to get slice of length %d at offset %d \" +\n+                            \"which is outside the valid range 0 <= offset+length < byteSize (=%d)\",\n+                    segment, length, offset, segment.byteSize());\n+        }\n+    };\n+\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/AbstractMemorySegmentImpl.java","additions":62,"deletions":22,"binary":false,"changes":84,"status":"modified"},{"patch":"@@ -197,1 +197,1 @@\n-        segment.checkBounds(fromOffset, length);\n+        segment.checkSliceBounds(fromOffset, length);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/SegmentBulkOperations.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -148,1 +148,1 @@\n-        segment.checkBounds(fromOffset, length);\n+        segment.checkSliceBounds(fromOffset, length);\n@@ -182,1 +182,1 @@\n-        segment.checkBounds(fromOffset, length);\n+        segment.checkSliceBounds(fromOffset, length);\n@@ -218,1 +218,1 @@\n-        segment.checkBounds(fromOffset, length);\n+        segment.checkSliceBounds(fromOffset, length);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/StringSupport.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -215,1 +215,1 @@\n-    public void testSegmentOOBMessage() {\n+    public void testSegmentAccessOOBMessage() {\n@@ -219,0 +219,1 @@\n+            fail(\"Expected IndexOutOfBoundsException was not thrown\");\n@@ -220,3 +221,20 @@\n-            assertTrue(ex.getMessage().contains(\"Out of bound access\"));\n-            assertTrue(ex.getMessage().contains(\"offset = 8\"));\n-            assertTrue(ex.getMessage().contains(\"length = 4\"));\n+            assertTrue(ex.getMessage().startsWith(\"Out of bound access\"));\n+            assertTrue(ex.getMessage().endsWith(\"attempting to access an element of length 4 at offset 8 \" +\n+                    \"which is outside the valid range 0 < offset+length < byteSize (=10)\"));\n+        } catch (Exception ex) {\n+            fail(\"Unexpected exception type thrown: \" + ex);\n+        }\n+    }\n+\n+    @Test\n+    public void testSegmentSliceOOBMessage() {\n+        try {\n+            var segment = Arena.global().allocate(10, 1);\n+            var slice = segment.asSlice(8, 4);\n+            fail(\"Expected IndexOutOfBoundsException was not thrown\");\n+        } catch (IndexOutOfBoundsException ex) {\n+            assertTrue(ex.getMessage().startsWith(\"Out of bound access\"));\n+            assertTrue(ex.getMessage().endsWith(\"attempting to get slice of length 4 at offset 8 \" +\n+                    \"which is outside the valid range 0 <= offset+length < byteSize (=10)\"));\n+        } catch (Exception ex) {\n+            fail(\"Unexpected exception type thrown: \" + ex);\n","filename":"test\/jdk\/java\/foreign\/TestSegments.java","additions":22,"deletions":4,"binary":false,"changes":26,"status":"modified"}]}