{"files":[{"patch":"@@ -28,0 +28,1 @@\n+import jdk.test.lib.Utils;\n@@ -35,0 +36,2 @@\n+import java.util.concurrent.TimeUnit;\n+import java.util.ArrayList;\n@@ -47,0 +50,1 @@\n+ * @library \/test\/lib\n@@ -80,1 +84,1 @@\n-            lsofForAll();\n+            lsofForAll(new ArrayList<>());\n@@ -93,1 +97,1 @@\n-        List<String> lsofLines = lsofForAll();\n+        List<String> lsofLines = lsofForAll(new ArrayList<>());\n@@ -112,0 +116,3 @@\n+        ArrayList<Long> pids = new ArrayList<>();\n+        processes.forEach(p -> pids.add(p.pid()));\n+\n@@ -129,1 +136,1 @@\n-        lsofLines = lsofForAll();\n+        lsofLines = lsofForAll(pids);\n@@ -162,1 +169,3 @@\n-            List<String> lsofLines = lsofForAll();\n+            ArrayList<Long> pids = new ArrayList<>();\n+            pids.add(p.pid());\n+            List<String> lsofLines = lsofForAll(pids);\n@@ -205,1 +214,1 @@\n-        var lines = lsofForAll();\n+        var lines = lsofForAll(new ArrayList<>());\n@@ -229,1 +238,1 @@\n-    private static List<String> lsofForAll() throws IOException {\n+    private static List<String> lsofForAll(List<Long> pids) throws IOException {\n@@ -234,1 +243,4 @@\n-        try (Process p = new ProcessBuilder(\"lsof\")\n+        StringBuilder command = new StringBuilder(\"lsof -p \" + MY_PID);\n+        pids.forEach(pid -> command.append(\",\").append(pid));\n+        System.out.println(\"Running lsof command: \" + command);\n+        try (Process p = new ProcessBuilder(command.toString().split(\" \"))\n@@ -239,4 +251,13 @@\n-            int status = p.waitFor();\n-            assertEquals(0, status, \"Process 'lsof' failed\");\n-\n-            return Files.readAllLines(lsofOutput);\n+            boolean status = p.waitFor(Utils.adjustTimeout(60), TimeUnit.SECONDS);\n+            if (!status) {\n+                p.destroyForcibly();\n+                Thread.sleep(100);\n+                if (p.isAlive()) {\n+                    p.destroyForcibly();\n+                }\n+            }\n+            assertTrue(status, \"Process 'lsof' failed\");\n+            List<String> lines = Files.readAllLines(lsofOutput);\n+            lsofEmptyInput.toFile().delete();\n+            lsofOutput.toFile().delete();\n+            return lines;\n","filename":"test\/jdk\/java\/lang\/ProcessBuilder\/PipelineLeaksFD.java","additions":32,"deletions":11,"binary":false,"changes":43,"status":"modified"}]}