{"files":[{"patch":"@@ -1659,6 +1659,18 @@\n-  nmethod* code = (nmethod*) addr;\n-  if (code != nullptr) {\n-    MutexLocker ml_Compile_lock(Compile_lock);\n-    CompiledICLocker ic_locker(code);\n-    MutexLocker ml_CodeCache_lock(CodeCache_lock, Mutex::_no_safepoint_check_flag);\n-    code->relocate(static_cast<CodeBlobType>(blob_type));\n+  void* address = (void*) addr;\n+\n+  if (address == nullptr) {\n+    return;\n+  }\n+\n+  MutexLocker ml_Compile_lock(Compile_lock);\n+  MutexLocker ml_CompiledIC_lock(CompiledIC_lock, Mutex::_no_safepoint_check_flag);\n+  MutexLocker ml_CodeCache_lock(CodeCache_lock, Mutex::_no_safepoint_check_flag);\n+\n+  \/\/ Verify that nmethod address is still valid\n+  CodeBlob* blob = CodeCache::find_blob(address);\n+  if (blob != nullptr && blob->is_nmethod()) {\n+    nmethod* code = blob->as_nmethod();\n+    if (code->is_in_use()) {\n+      CompiledICLocker ic_locker(code);\n+      code->relocate(static_cast<CodeBlobType>(blob_type));\n+    }\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":18,"deletions":6,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -34,2 +34,2 @@\n- *                   -XX:+SegmentedCodeCache -XX:-UseCodeCacheFlushing -XX:-MethodFlushing\n- *                   -XX:+UnlockExperimentalVMOptions -XX:+NMethodRelocation compiler.whitebox.StressNMethodRelocation\n+ *                   -XX:+SegmentedCodeCache -XX:+UnlockExperimentalVMOptions\n+ *                   -XX:+NMethodRelocation compiler.whitebox.StressNMethodRelocation\n","filename":"test\/hotspot\/jtreg\/compiler\/whitebox\/StressNMethodRelocation.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -94,1 +94,1 @@\n-        WHITE_BOX.relocateNMethodFromAddr(originalNMethod.address, BlobType.MethodNonProfiled.id);\n+        WHITE_BOX.relocateNMethodFromMethod(method, BlobType.MethodNonProfiled.id);\n","filename":"test\/hotspot\/jtreg\/vmTestbase\/nsk\/jvmti\/NMethodRelocation\/nmethodrelocation.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}