{"files":[{"patch":"@@ -45,1 +45,1 @@\n-  return SafepointSynchronize::is_at_safepoint() || CompiledIC_lock->owned_by_self() || nm->is_not_installed();\n+  return SafepointSynchronize::is_at_safepoint() || CompiledIC_lock->owned_by_self() || (NMethodState_lock->owned_by_self() && nm->is_not_installed());\n","filename":"src\/hotspot\/share\/code\/codeBehaviours.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -765,1 +765,1 @@\n-  assert(SafepointSynchronize::is_at_safepoint() || is_not_installed(), \"clearing of IC's only allowed at safepoint or when not installed\");\n+  assert(SafepointSynchronize::is_at_safepoint() || (NMethodState_lock->owned_by_self() && is_not_installed()), \"clearing of IC's only allowed at safepoint or when not installed\");\n@@ -1558,2 +1558,0 @@\n-  nm_copy->clear_inline_caches();\n-\n@@ -1589,0 +1587,2 @@\n+    nm_copy->clear_inline_caches();\n+\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -106,1 +106,1 @@\n-    if (SafepointSynchronize::is_at_safepoint() || nm->is_unloading() || nm->is_not_installed()) {\n+    if (SafepointSynchronize::is_at_safepoint() || nm->is_unloading() || (NMethodState_lock->owned_by_self() && nm->is_not_installed())) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahUnload.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -103,1 +103,1 @@\n-    if (SafepointSynchronize::is_at_safepoint() || nm->is_unloading() || nm->is_not_installed()) {\n+    if (SafepointSynchronize::is_at_safepoint() || nm->is_unloading() || (NMethodState_lock->owned_by_self() && nm->is_not_installed())) {\n","filename":"src\/hotspot\/share\/gc\/z\/zUnload.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}