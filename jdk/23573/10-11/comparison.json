{"files":[{"patch":"@@ -1138,2 +1138,5 @@\n-    VM_RelocateNMethod relocate(nm, CodeBlobType::MethodNonProfiled);\n-    VMThread::execute(&relocate);\n+    if (nm != nullptr) {\n+      methodHandle mh(Thread::current(), nm->method());\n+      VM_RelocateNMethod relocate(&mh, CodeBlobType::MethodNonProfiled);\n+      VMThread::execute(&relocate);\n+    }\n","filename":"src\/hotspot\/share\/ci\/ciEnv.cpp","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -1632,6 +1632,1 @@\n-  nmethod* code = mh->code();\n-  if (code == nullptr) {\n-    return;\n-  }\n-\n-  VM_RelocateNMethod relocate(code, static_cast<CodeBlobType>(blob_type));\n+  VM_RelocateNMethod relocate(&mh, static_cast<CodeBlobType>(blob_type));\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":1,"deletions":6,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -106,2 +106,5 @@\n-  if (_nm != nullptr && _nm->is_relocatable()) {\n-    _nm_copy = _nm->relocate(_code_blob_type);\n+  if (_mh != nullptr) {\n+    nmethod* nm = (*_mh)()->code();\n+    if (nm != nullptr && nm->is_relocatable()) {\n+      _nm_copy = nm->relocate(_code_blob_type);\n+    }\n","filename":"src\/hotspot\/share\/runtime\/vmOperations.cpp","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -87,1 +87,1 @@\n-   nmethod* _nm;\n+   methodHandle* _mh;\n@@ -91,3 +91,8 @@\n-   VM_RelocateNMethod(nmethod* nm, CodeBlobType code_blob_type)\n-    : _nm(nm), _nm_copy(nullptr), _code_blob_type(code_blob_type)\n-   {}\n+   VM_RelocateNMethod(methodHandle* mh, CodeBlobType code_blob_type)\n+     : _mh(mh), _nm_copy(nullptr), _code_blob_type(code_blob_type)\n+   {\n+    Compile_lock->lock();\n+   }\n+   ~VM_RelocateNMethod() {\n+    Compile_lock->unlock();\n+   }\n","filename":"src\/hotspot\/share\/runtime\/vmOperations.hpp","additions":9,"deletions":4,"binary":false,"changes":13,"status":"modified"}]}