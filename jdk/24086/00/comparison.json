{"files":[{"patch":"@@ -321,1 +321,2 @@\n-static OnLoadEntry_t lookup_On_Load_entry_point(JvmtiAgent* agent, const char* on_load_symbol) {\n+static OnLoadEntry_t lookup_On_Load_entry_point(JvmtiAgent* agent, const char* on_load_symbol,\n+                                                bool vm_exit_on_error) {\n@@ -325,4 +326,10 @@\n-      void* const library = load_library(agent, \/* vm exit on error *\/ true);\n-      assert(library != nullptr, \"invariant\");\n-      agent->set_os_lib(library);\n-      agent->set_loaded();\n+      void* const library = load_library(agent, vm_exit_on_error);\n+      assert(library != nullptr || !vm_exit_on_error, \"invariant\");\n+      if (library != nullptr) {\n+        agent->set_os_lib(library);\n+        agent->set_loaded();\n+      } else {\n+        \/\/ Did not load agent from the executable or library.\n+        assert(!vm_exit_on_error, \"invariant\");\n+        return nullptr;\n+      }\n@@ -336,2 +343,2 @@\n-static OnLoadEntry_t lookup_JVM_OnLoad_entry_point(JvmtiAgent* lib) {\n-  return lookup_On_Load_entry_point(lib, \"JVM_OnLoad\");\n+static OnLoadEntry_t lookup_JVM_OnLoad_entry_point(JvmtiAgent* lib, bool vm_exit_on_error) {\n+  return lookup_On_Load_entry_point(lib, \"JVM_OnLoad\", vm_exit_on_error);\n@@ -340,2 +347,2 @@\n-static OnLoadEntry_t lookup_Agent_OnLoad_entry_point(JvmtiAgent* agent) {\n-  return lookup_On_Load_entry_point(agent, \"Agent_OnLoad\");\n+static OnLoadEntry_t lookup_Agent_OnLoad_entry_point(JvmtiAgent* agent, bool vm_exit_on_error) {\n+  return lookup_On_Load_entry_point(agent, \"Agent_OnLoad\", vm_exit_on_error);\n@@ -348,1 +355,6 @@\n-  OnLoadEntry_t on_load_entry = lookup_JVM_OnLoad_entry_point(this);\n+\n+  \/\/ Don't report any error and bail out too early in\n+  \/\/ lookup_JVM_OnLoad_entry_point if it does not succeed, since we want\n+  \/\/ to try lookup_Agent_OnLoad_entry_point for Agent_OnLoad as well.\n+  OnLoadEntry_t on_load_entry = lookup_JVM_OnLoad_entry_point(\n+    this, \/* vm exit on error *\/ false);\n@@ -352,4 +364,3 @@\n-    on_load_entry = lookup_Agent_OnLoad_entry_point(this);\n-    if (on_load_entry == nullptr) {\n-      vm_exit_during_initialization(\"Could not find JVM_OnLoad or Agent_OnLoad function in the library\", name());\n-    }\n+    on_load_entry = lookup_Agent_OnLoad_entry_point(\n+      this, \/* vm exit on error *\/ true);\n+    assert(on_load_entry != nullptr, \"invariant\");\n@@ -365,4 +376,2 @@\n-  OnLoadEntry_t on_load_entry = lookup_JVM_OnLoad_entry_point(agent);\n-  if (on_load_entry == nullptr) {\n-    vm_exit_during_initialization(\"Could not find JVM_OnLoad function in -Xrun library\", agent->name());\n-  }\n+  OnLoadEntry_t on_load_entry = lookup_JVM_OnLoad_entry_point(agent, \/* vm exit on error *\/ true);\n+  assert(on_load_entry != nullptr, \"invariant\");\n@@ -597,4 +606,2 @@\n-  OnLoadEntry_t on_load_entry = lookup_Agent_OnLoad_entry_point(agent);\n-  if (on_load_entry == nullptr) {\n-    vm_exit_during_initialization(\"Could not find Agent_OnLoad function in the agent library\", agent->name());\n-  }\n+  OnLoadEntry_t on_load_entry = lookup_Agent_OnLoad_entry_point(agent, \/* vm exit on error *\/ true);\n+  assert(on_load_entry != nullptr, \"invariant\");\n","filename":"src\/hotspot\/share\/prims\/jvmtiAgent.cpp","additions":29,"deletions":22,"binary":false,"changes":51,"status":"modified"}]}