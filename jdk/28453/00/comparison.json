{"files":[{"patch":"@@ -1375,5 +1375,12 @@\n-            for (Node<K,V> p; (p = it.advance()) != null; ) {\n-                V val = p.val;\n-                Object v = m.get(p.key);\n-                if (v == null || (v != val && !v.equals(val)))\n-                    return false;\n+\n+            try {\n+                for (Node<K,V> p; (p = it.advance()) != null; ) {\n+                    V val = p.val;\n+                    Object v = m.get(p.key);\n+                    if (v == null || (v != val && !v.equals(val)))\n+                        return false;\n+                }\n+            } catch (ClassCastException | NullPointerException _) {\n+                \/\/ m.get(p.key) is contractually allowed to throw CCE or NPE\n+                \/\/ but CHM doesn't allow null keys, so NPE shouldn't occur in practice\n+                return false;\n@@ -1381,0 +1388,1 @@\n+\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ConcurrentHashMap.java","additions":13,"deletions":5,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -43,0 +43,1 @@\n+import java.util.HashMap;\n@@ -881,0 +882,18 @@\n+    public void testMapEqualsIfClassCastExceptionOccurs() {\n+        class MonotypeKeyMap extends HashMap<Byte, Object> {\n+            @Override public Object get(Object key) {\n+                return super.get((Byte)key); \/\/ Force cast, allowed by spec\n+            }\n+        }\n+\n+        var mkm = new MonotypeKeyMap();\n+        mkm.put((byte)1, \"value1\");\n+        var similar = new ConcurrentHashMap<Byte, Object>();\n+        similar.put((byte)1, \"value1\");\n+        var different = new ConcurrentHashMap<String, String>();\n+        different.put(\"test1\", \"value1\");\n+\n+        assertTrue(similar.equals(mkm));\n+        assertFalse(different.equals(mkm));\n+    }\n+\n","filename":"test\/jdk\/java\/util\/concurrent\/tck\/ConcurrentHashMapTest.java","additions":19,"deletions":0,"binary":false,"changes":19,"status":"modified"}]}