{"files":[{"patch":"@@ -208,0 +208,1 @@\n+        boolean stopping = false;\n@@ -212,10 +213,2 @@\n-            } else if (stopped) {\n-                conn.close();\n-                return;\n-            }\n-            if (MAX_POOL_SIZE > 0 && expiryList.size() >= MAX_POOL_SIZE) {\n-                toClose = expiryList.removeOldest();\n-                if (toClose != null) removeFromPool(toClose);\n-            }\n-            if (conn instanceof PlainHttpConnection) {\n-                putConnection(conn, plainPool);\n+            } else if (stopping = stopped) {\n+                toClose = conn;\n@@ -223,2 +216,11 @@\n-                assert conn.isSecure();\n-                putConnection(conn, sslPool);\n+                if (MAX_POOL_SIZE > 0 && expiryList.size() >= MAX_POOL_SIZE) {\n+                    toClose = expiryList.removeOldest();\n+                    if (toClose != null) removeFromPool(toClose);\n+                }\n+                if (conn instanceof PlainHttpConnection) {\n+                    putConnection(conn, plainPool);\n+                } else {\n+                    assert conn.isSecure();\n+                    putConnection(conn, sslPool);\n+                }\n+                expiryList.add(conn, now, keepAlive);\n@@ -226,1 +228,0 @@\n-            expiryList.add(conn, now, keepAlive);\n@@ -232,2 +233,7 @@\n-                debug.log(\"Maximum pool size reached: removing oldest connection %s\",\n-                          toClose.dbgString());\n+                if (stopping) {\n+                    debug.log(\"Stopping: close connection %s\",\n+                            toClose.dbgString());\n+                } else {\n+                    debug.log(\"Maximum pool size reached: removing oldest connection %s\",\n+                            toClose.dbgString());\n+                }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/ConnectionPool.java","additions":21,"deletions":15,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -1336,0 +1336,7 @@\n+            \/\/ first stop the client to avoid seeing exceptions\n+            \/\/ about \"selector manager closed\"\n+            Log.logTrace(\"{0}: stopping\", owner.dbgTag);\n+            try {\n+                owner.stop();\n+            } catch (Throwable ignored) {\n+            }\n@@ -1348,0 +1355,1 @@\n+                \/\/ cleanup anything that might have been left behind\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/HttpClientImpl.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -314,9 +314,9 @@\n-            if (Log.channel()) {\n-                Log.logChannel(\"Closing channel: \" + chan);\n-            }\n-            try {\n-                tube.signalClosed(errorRef.get());\n-                chan.close();\n-            } finally {\n-                client().connectionClosed(this);\n-            }\n+        } finally {\n+            stateLock.unlock();\n+        }\n+        if (Log.channel()) {\n+            Log.logChannel(\"Closing channel: \" + chan);\n+        }\n+        try {\n+            tube.signalClosed(errorRef.get());\n+            chan.close();\n@@ -327,1 +327,1 @@\n-            stateLock.unlock();\n+            client().connectionClosed(this);\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/PlainHttpConnection.java","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"}]}