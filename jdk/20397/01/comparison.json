{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -50,0 +50,1 @@\n+static jrawMonitorID event_mon = NULL;\n@@ -71,1 +72,1 @@\n-        exit(err);\n+        abort();\n@@ -320,1 +321,1 @@\n-VMInit(jvmtiEnv *jvmti, JNIEnv* jnii, jthread thread) {\n+VMInit(jvmtiEnv *jvmti, JNIEnv* jni, jthread thread) {\n@@ -332,0 +333,14 @@\n+static void JNICALL\n+VMDeath(jvmtiEnv *jvmti, JNIEnv* jni) {\n+    jvmtiError err;\n+\n+    \/\/ Block ClassPrepare events while this callback is executed.\n+    err  = (*jvmti)->RawMonitorEnter(jvmti, event_mon);\n+    check_jvmti_error(jvmti, \"VMDeath event: Failed in RawMonitorEnter\", err);\n+\n+    printf(\"VMDeath event\\n\");\n+\n+    err = (*jvmti)->RawMonitorExit(jvmti, event_mon);\n+    check_jvmti_error(jvmti, \"VMDeath event: Failed in RawMonitorExit\", err);\n+}\n+\n@@ -336,1 +351,0 @@\n-    jthread cur_thread = get_cur_thread(jvmti);\n@@ -340,0 +354,6 @@\n+    jvmtiError err;\n+\n+    \/\/ Block VMDeath event and other ClassPrepare events while this callback is executed.\n+    \/\/ Sync with VMDeath event guards against JVMTI_ERROR WRONG_PHASE.\n+    err = (*jvmti)->RawMonitorEnter(jvmti, event_mon);\n+    check_jvmti_error(jvmti, \"ClassPrepare event: Failed in RawMonitorEnter\", err);\n@@ -343,2 +363,7 @@\n-        printf(\"  ## Error: unexpected phase: %d, expected: %d or %d\\n\",\n-               phase, JVMTI_PHASE_START, JVMTI_PHASE_LIVE);\n+        if (phase != JVMTI_PHASE_DEAD) {\n+            printf(\"  ## Error: unexpected phase: %d, expected: %d or %d or %d\\n\",\n+                   phase, JVMTI_PHASE_START, JVMTI_PHASE_LIVE, JVMTI_PHASE_DEAD);\n+            result = FAILED;\n+        }\n+        err = (*jvmti)->RawMonitorExit(jvmti, event_mon);\n+        check_jvmti_error(jvmti, \"ClassPrepare event: Failed in RawMonitorExit\", err);\n@@ -348,0 +373,1 @@\n+        jthread cur_thread = get_cur_thread(jvmti);\n@@ -363,0 +389,2 @@\n+    err = (*jvmti)->RawMonitorExit(jvmti, event_mon);\n+    check_jvmti_error(jvmti, \"ClassPrepare event: Failed in RawMonitorExit\", err);\n@@ -403,0 +431,3 @@\n+    err = (*jvmti)->CreateRawMonitor(jvmti, \"Events Monitor\", &event_mon);\n+    check_jvmti_error(jvmti, \"## Agent_Initialize: CreateRawMonitor\", err);\n+\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/StartPhase\/AllowedFunctions\/libAllowedFunctions.c","additions":37,"deletions":6,"binary":false,"changes":43,"status":"modified"}]}