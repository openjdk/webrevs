{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2001, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -99,1 +99,1 @@\n-  int numberOfEntries()  { return maskSize; }\n+  public int numberOfEntries()  { return maskSize; }\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/interpreter\/OopMapCacheEntry.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -256,0 +256,4 @@\n+  private int invokedynamicBootstrapRefIndexAt(int indyIndex) {\n+    return getCache().getIndyEntryAt(indyIndex).getConstantPoolIndex();\n+  }\n+\n@@ -261,2 +265,1 @@\n-        int poolIndex = getCache().getIndyEntryAt(index).getConstantPoolIndex();\n-        return invokeDynamicNameAndTypeRefIndexAt(poolIndex);\n+        return invokedynamicBootstrapRefIndexAt(index);\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/oops\/ConstantPool.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2016, Oracle and\/or its affiliates. All rights reserved.\n@@ -40,1 +40,2 @@\n-    Method m = getMethod();\n+    \/\/ Get oopmap describing oops and int for current bci\n+    OopMapCacheEntry oopMask = getMethod().getMaskFor(getBCI());\n@@ -42,1 +43,4 @@\n-    int length = (int) m.getMaxLocals();\n+    \/\/ If the method is native, method()->max_locals() is not telling the truth.\n+    \/\/ For our purposes, max locals instead equals the size of parameters.\n+    Method method = getMethod();\n+    int maxLocals = method.isNative() ? (int)method.getSizeOfParameters() : (int)method.getMaxLocals();\n@@ -44,5 +48,1 @@\n-    if (m.isNative()) {\n-      \/\/ If the method is native, getMaxLocals is not telling the truth.\n-      \/\/ maxlocals then equals the size of parameters\n-      length = (int) m.getSizeOfParameters();\n-    }\n+    int length = maxLocals;\n@@ -52,3 +52,0 @@\n-    \/\/ Get oopmap describing oops and int for current bci\n-    OopMapCacheEntry oopMask = getMethod().getMaskFor(getBCI());\n-\n@@ -77,1 +74,2 @@\n-    int length = getFrame().getInterpreterFrameExpressionStackSize();\n+    \/\/ Get oopmap describing oops and int for current bci\n+    OopMapCacheEntry oopMask = getMethod().getMaskFor(getBCI());\n@@ -79,4 +77,1 @@\n-    if (getMethod().isNative()) {\n-      \/\/ If the method is native, there is no expression stack\n-      length = 0;\n-    }\n+    int maskLen = oopMask.numberOfEntries();\n@@ -84,2 +79,4 @@\n-    int nofLocals = (int) getMethod().getMaxLocals();\n-    StackValueCollection result = new StackValueCollection(length);\n+    \/\/ If the method is native, method()->max_locals() is not telling the truth.\n+    \/\/ For our purposes, max locals instead equals the size of parameters.\n+    Method method = getMethod();\n+    int maxLocals = method.isNative() ? (int)method.getSizeOfParameters() : (int)method.getMaxLocals();\n@@ -87,2 +84,3 @@\n-    \/\/ Get oopmap describing oops and int for current bci\n-    OopMapCacheEntry oopMask = getMethod().getMaskFor(getBCI());\n+    int length = maskLen - maxLocals;\n+\n+    StackValueCollection result = new StackValueCollection(length);\n@@ -96,1 +94,1 @@\n-      if (oopMask.isOop(i + nofLocals)) {\n+      if (oopMask.isOop(i + maxLocals)) {\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/runtime\/InterpretedVFrame.java","additions":19,"deletions":21,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2004, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2004, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -891,0 +891,10 @@\n+\n+        int depth = 0;\n+        var jvf = jt.getLastJavaVFrameDbg();\n+        while (jvf != null) {\n+            writeStackRefs(index, depth, jvf.getLocals());\n+            writeStackRefs(index, depth, jvf.getExpressions());\n+\n+            depth++;\n+            jvf = jvf.javaSender();\n+        }\n@@ -929,0 +939,17 @@\n+    protected void writeStackRefs(int threadIndex, int frameIndex, StackValueCollection values) throws IOException {\n+        for (int index = 0; index < values.size(); index++) {\n+            if (values.get(index).getType() == BasicType.getTObject()) {\n+                OopHandle oopHandle = values.oopHandleAt(index);\n+                Oop oop = objectHeap.newOop(oopHandle);\n+                if (oop != null) {\n+                    int size = BYTE_SIZE + OBJ_ID_SIZE + INT_SIZE * 2;\n+                    writeHeapRecordPrologue(size);\n+                    out.writeByte((byte) HPROF_GC_ROOT_JAVA_FRAME);\n+                    writeObjectID(oop);\n+                    out.writeInt(threadIndex);\n+                    out.writeInt(frameIndex);\n+                }\n+            }\n+        }\n+    }\n+\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/utilities\/HeapHprofBinWriter.java","additions":28,"deletions":1,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,0 +30,1 @@\n+import java.io.IOException;\n@@ -33,0 +34,1 @@\n+import static jdk.test.lib.Asserts.fail;\n@@ -35,0 +37,1 @@\n+import jdk.test.lib.hprof.model.Root;\n@@ -69,0 +72,12 @@\n+    private static void verifyLocalRefs(String file) throws IOException {\n+        try (var snapshot = HprofReader.readFile(file, false, 0)) {\n+            for (var root = snapshot.getRoots(); root.hasMoreElements();) {\n+                if (root.nextElement().getType() == Root.JAVA_LOCAL) {\n+                    \/\/ expected\n+                    return;\n+                }\n+            }\n+        }\n+        fail(\"HPROF_GC_ROOT_JAVA_FRAME not found\");\n+    }\n+\n@@ -72,0 +87,1 @@\n+        verifyLocalRefs(dump.getAbsolutePath());\n","filename":"test\/hotspot\/jtreg\/serviceability\/sa\/ClhsdbDumpheap.java","additions":17,"deletions":1,"binary":false,"changes":18,"status":"modified"}]}