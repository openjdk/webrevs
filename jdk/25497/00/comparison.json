{"files":[{"patch":"@@ -552,1 +552,4 @@\n-    SafepointMechanism::process_if_requested_with_exit_check(thread, true \/* check asyncs *\/);\n+    ResourceMark rm;\n+    HandshakeOperationFilter operation_filter;\n+    operation_filter.put(HandshakeOperationProperty::check_async_exception, true); \/* check asyncs *\/\n+    SafepointMechanism::process_if_requested_with_exit_check(thread, operation_filter);\n","filename":"src\/hotspot\/share\/prims\/jni.cpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -493,1 +493,1 @@\n-HandshakeOperation* HandshakeState::get_op_for_self(bool allow_suspend, bool check_async_exception) {\n+HandshakeOperation* HandshakeState::get_op_for_self(HandshakeOperationFilter& operation_filter) {\n@@ -496,0 +496,4 @@\n+\n+  bool allow_suspend = operation_filter.get(HandshakeOperationProperty::allow_suspend) != nullptr ? *operation_filter.get(HandshakeOperationProperty::allow_suspend) : false;\n+  const bool check_async_exception = operation_filter.get(HandshakeOperationProperty::check_async_exception) != nullptr ? *operation_filter.get(HandshakeOperationProperty::check_async_exception) : false;\n+\n@@ -512,1 +516,1 @@\n-bool HandshakeState::has_operation(bool allow_suspend, bool check_async_exception) {\n+bool HandshakeState::has_operation(HandshakeOperationFilter& operation_filter) {\n@@ -520,1 +524,2 @@\n-    ret = get_op_for_self(allow_suspend, check_async_exception) != nullptr;\n+\n+    ret = get_op_for_self(operation_filter) != nullptr;\n@@ -561,1 +566,1 @@\n-bool HandshakeState::process_by_self(bool allow_suspend, bool check_async_exception) {\n+bool HandshakeState::process_by_self(HandshakeOperationFilter& operation_filter) {\n@@ -578,1 +583,1 @@\n-    HandshakeOperation* op = get_op_for_self(allow_suspend, check_async_exception);\n+    HandshakeOperation* op = get_op_for_self(operation_filter);\n","filename":"src\/hotspot\/share\/runtime\/handshake.cpp","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+#include \"utilities\/resourceHash.hpp\"\n@@ -67,0 +68,4 @@\n+enum class HandshakeOperationProperty {check_async_exception, allow_suspend};\n+\n+typedef ResourceHashtable<HandshakeOperationProperty, bool> HandshakeOperationFilter;\n+\n@@ -111,1 +116,1 @@\n-  HandshakeOperation* get_op_for_self(bool allow_suspend, bool check_async_exception);\n+  HandshakeOperation* get_op_for_self(HandshakeOperationFilter& operation_filter);\n@@ -133,1 +138,1 @@\n-  bool has_operation(bool allow_suspend, bool check_async_exception);\n+  bool has_operation(HandshakeOperationFilter& operation_filter);\n@@ -142,1 +147,1 @@\n-  bool process_by_self(bool allow_suspend, bool check_async_exception);\n+  bool process_by_self(HandshakeOperationFilter& operation_filter);\n","filename":"src\/hotspot\/share\/runtime\/handshake.hpp","additions":8,"deletions":3,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -106,1 +106,4 @@\n-    SafepointMechanism::process_if_requested_with_exit_check(thread, to != _thread_in_Java ? false : check_asyncs);\n+    ResourceMark rm;\n+    HandshakeOperationFilter operation_filter;\n+    operation_filter.put(HandshakeOperationProperty::check_async_exception, to != _thread_in_Java ? false : check_asyncs);\n+    SafepointMechanism::process_if_requested_with_exit_check(thread, operation_filter);\n@@ -113,1 +116,4 @@\n-      SafepointMechanism::process_if_requested_with_exit_check(thread, check_asyncs);\n+      ResourceMark rm;\n+      HandshakeOperationFilter operation_filter;\n+      operation_filter.put(HandshakeOperationProperty::check_async_exception, check_asyncs);\n+      SafepointMechanism::process_if_requested_with_exit_check(thread, operation_filter);\n@@ -218,1 +224,5 @@\n-      SafepointMechanism::process_if_requested(_thread, _allow_suspend, false \/* check_async_exception *\/);\n+      ResourceMark rm;\n+      HandshakeOperationFilter operation_filter;\n+      operation_filter.put(HandshakeOperationProperty::allow_suspend, _allow_suspend);\n+      operation_filter.put(HandshakeOperationProperty::check_async_exception, false);\n+      SafepointMechanism::process_if_requested(_thread, operation_filter);\n","filename":"src\/hotspot\/share\/runtime\/interfaceSupport.inline.hpp","additions":13,"deletions":3,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -1273,1 +1273,4 @@\n-  SafepointMechanism::process_if_requested_with_exit_check(thread, true \/* check asyncs *\/);\n+  ResourceMark rm;\n+  HandshakeOperationFilter operation_filter;\n+  operation_filter.put(HandshakeOperationProperty::check_async_exception, true); \/* check asyncs *\/\n+  SafepointMechanism::process_if_requested_with_exit_check(thread, operation_filter);\n","filename":"src\/hotspot\/share\/runtime\/javaThread.cpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -805,1 +805,4 @@\n-    SafepointMechanism::process_if_requested_with_exit_check(self, true \/* check asyncs *\/);\n+    ResourceMark rm;\n+    HandshakeOperationFilter operation_filter;\n+    operation_filter.put(HandshakeOperationProperty::check_async_exception, true); \/* check asyncs *\/\n+    SafepointMechanism::process_if_requested_with_exit_check(self, operation_filter);\n@@ -828,1 +831,4 @@\n-    SafepointMechanism::process_if_requested_with_exit_check(self, false \/* check asyncs *\/);\n+    ResourceMark rm;\n+    HandshakeOperationFilter operation_filter;\n+    operation_filter.put(HandshakeOperationProperty::check_async_exception, false); \/* check asyncs *\/\n+    SafepointMechanism::process_if_requested_with_exit_check(self, operation_filter);\n","filename":"src\/hotspot\/share\/runtime\/safepoint.cpp","additions":8,"deletions":2,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -135,1 +135,1 @@\n-void SafepointMechanism::process(JavaThread *thread, bool allow_suspend, bool check_async_exception) {\n+void SafepointMechanism::process(JavaThread *thread, HandshakeOperationFilter& operation_filter) {\n@@ -160,2 +160,1 @@\n-\n-    need_rechecking = thread->handshake_state()->has_operation() && thread->handshake_state()->process_by_self(allow_suspend, check_async_exception);\n+    need_rechecking = thread->handshake_state()->has_operation() && thread->handshake_state()->process_by_self(operation_filter);\n","filename":"src\/hotspot\/share\/runtime\/safepointMechanism.cpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/handshake.hpp\"\n@@ -32,0 +33,1 @@\n+#include \"utilities\/resourceHash.hpp\"\n@@ -54,1 +56,1 @@\n-  static void process(JavaThread *thread, bool allow_suspend, bool check_async_exception);\n+  static void process(JavaThread *thread, HandshakeOperationFilter& operation_filter);\n@@ -84,2 +86,2 @@\n-  static inline void process_if_requested(JavaThread* thread, bool allow_suspend, bool check_async_exception);\n-  static inline void process_if_requested_with_exit_check(JavaThread* thread, bool check_async_exception);\n+  static inline void process_if_requested(JavaThread* thread, HandshakeOperationFilter& operation_filter);\n+  static inline void process_if_requested_with_exit_check(JavaThread* thread, HandshakeOperationFilter& operation_filter);\n","filename":"src\/hotspot\/share\/runtime\/safepointMechanism.hpp","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -70,1 +70,4 @@\n-\n+  ResourceMark rm;\n+  HandshakeOperationFilter operation_filter;\n+  operation_filter.put(HandshakeOperationProperty::allow_suspend, allow_suspend);\n+  operation_filter.put(HandshakeOperationProperty::check_async_exception, false);\n@@ -72,1 +75,1 @@\n-      thread->handshake_state()->has_operation(allow_suspend, false \/* check_async_exception *\/) || \/\/ Handshake\n+      thread->handshake_state()->has_operation(operation_filter) || \/\/ Handshake\n@@ -85,1 +88,1 @@\n-void SafepointMechanism::process_if_requested(JavaThread* thread, bool allow_suspend, bool check_async_exception) {\n+void SafepointMechanism::process_if_requested(JavaThread* thread, HandshakeOperationFilter& operation_filter) {\n@@ -88,1 +91,0 @@\n-\n@@ -90,1 +92,1 @@\n-    process(thread, allow_suspend, check_async_exception);\n+    process(thread, operation_filter);\n@@ -94,2 +96,3 @@\n-void SafepointMechanism::process_if_requested_with_exit_check(JavaThread* thread, bool check_async_exception) {\n-  process_if_requested(thread, true \/* allow_suspend *\/, check_async_exception);\n+void SafepointMechanism::process_if_requested_with_exit_check(JavaThread* thread, HandshakeOperationFilter& operation_filter) {\n+  operation_filter.put(HandshakeOperationProperty::allow_suspend, true);\n+  process_if_requested(thread, operation_filter);\n","filename":"src\/hotspot\/share\/runtime\/safepointMechanism.inline.hpp","additions":10,"deletions":7,"binary":false,"changes":17,"status":"modified"}]}