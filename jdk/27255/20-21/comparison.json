{"files":[{"patch":"@@ -62,0 +62,15 @@\n+ * Explanations:\n+ *  - Generally, every scope has a CodeFrame and a TemplateFrame. There can be multiple\n+ *    scopes inside a Template, and so there can be multiple CodeFrames and TemplateFrames.\n+ *    In the drawing below, we draw the frames vertically, and give each a unique id.\n+ *  - When we nest scopes inside scopes, we create a new CodeFrame and a new TemplateFrame,\n+ *    and so they grow the same nested structure. Example: t3 is nested inside t2 and\n+ *    c3 is nested inside c2b.\n+ *  - The exception to this:\n+ *    - At a hook.anchor, there are two CodeFrames. The first one (e.g. c2a) we call the\n+ *      hook CodeFrame, it is kept empty until we insert code to the hook. The second\n+ *      (e.g. c2b) we call the inner CodeFrame of the anchoring, into which we keep\n+ *      generating the code that is inside the scope of the hook.anchor.\n+ *    - At a hook.insert, the TemplateFrame (e.g. t4) is nested into the caller (e.g. t3),\n+ *      while the CodeFrame (e.g. c4) is nested into the anchoring CodeFrame (e.g. c2a).\n+ *\n@@ -63,40 +78,44 @@\n- *   t c\n- *   t c\n- *   t c  Anchoring Scope\n- *   t c  hook.anchor(scope(\n- *   t c  t c\n- *   t c  t c  <----- CodeFrame -------------+\n- *   t c  t c         with Names             |\n- *   t c  t                                  |\n- *   t c  t c                                |\n- *   t c  t c                                |\n- *   t c  t c     Caller Scope               |\n- *   t c  t c ... scope(                     |\n- *   t c  t c ... t c                        |     Insertion Scope\n- *   t c  t c ... t c                        |     hook.insert(transparentScope(\n- *   t c  t c ... t c                        |     t c\n- *   t c  t c ... t c                        +---  t c\n- *   t c  t c ... t c                              t c\n- *   t c  t c ... t c  <----- TemplateFrame -----  t c\n- *   t c  t c ... t c         with hashtag and     t c\n- *   t c  t c ... t c         setFuelCost          t c\n- *   t c  t c ... t c                              t c \"use hashtag #x\"           -> t: hashtag queried in insertion and caller scope\n- *   t c  t c ... t c                              t c                               c: code added to anchoring scope\n- *   t c  t c ... t c                              t c\n- *   t c  t c ... t c                              t c let(\"x\", 42)               -> t: hashtag escapes to caller scope because\n- *   t c  t c ... t c                              t c                                  insertion scope is transparent\n- *   t c  t c ... t c                              t c\n- *   t c  t c ... t c                              t c dataNames(...)...sample()  -> c: sample from insertion and anchoring scope\n- *   t c  t c ... t c                              t c\n- *   t c  t c ... t c                              t c addDataName(...)           -> c: names escape to the caller scope because\n- *   t c  t c ... t c                              t c                                  insertion scope is transparent\n- *   t c  t c ... t c                              t c\n- *   t c  t c ... t c                              ))\n- *   t c  t c ... t c\n- *   t c  t c ... t c\n- *   t c  t c ... )\n- *   t c  t c\n- *   t c  t c\n- *   t c  ))\n- *   t c\n- *   t c\n+ *   t1 c1\n+ *   t1 c1\n+ *   t1 c1  Anchoring Scope\n+ *   t1 c1  hook.anchor(scope(\n+ *   t1 c1  t2 c2a\n+ *   t1 c1  t2 c2a <------ CodeFrame nesting--------+\n+ *   t1 c1  t2 c2a         with generated code      |\n+ *   t1 c1  t2             and Names                |\n+ *   t1 c1  t2  ^                                   |\n+ *   t1 c1  t2  +- Two CodeFramees                  |\n+ *   t1 c1  t2  v                                   |\n+ *   t1 c1  t2                                      |\n+ *   t1 c1  t2 c2b                                  |\n+ *   t1 c1  t2 c2b                                  |\n+ *   t1 c1  t2 c2b     Caller Scope                 |\n+ *   t1 c1  t2 c2b ... scope(                       |\n+ *   t1 c1  t2 c2b ... t3 c3                        |     Insertion Scope\n+ *   t1 c1  t2 c2b ... t3 c3                        |     hook.insert(transparentScope(\n+ *   t1 c1  t2 c2b ... t3 c3                        |     t4     c4\n+ *   t1 c1  t2 c2b ... t3 c3                        +---- t4 ----c4\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4\n+ *   t1 c1  t2 c2b ... t3 c3 <-- TemplateFrame nesting ---t4     c4\n+ *   t1 c1  t2 c2b ... t3 c3     with hashtag             t4     c4\n+ *   t1 c1  t2 c2b ... t3 c3     and setFuelCost          t4     c4\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4 \"use hashtag #x\"           -> t: hashtag queried in insertion and caller scope\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4                               c: code added to anchoring scope\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4 let(\"x\", 42)               -> t: hashtag escapes to caller scope because\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4                                  insertion scope is transparent\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4 dataNames(...)...sample()  -> c: sample from insertion and anchoring scope\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4 addDataName(...)           -> c: names escape to the caller scope because\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4                                  insertion scope is transparent\n+ *   t1 c1  t2 c2b ... t3 c3                              t4     c4\n+ *   t1 c1  t2 c2b ... t3 c3                              ))\n+ *   t1 c1  t2 c2b ... t3 c3\n+ *   t1 c1  t2 c2b ... t3 c3\n+ *   t1 c1  t2 c2b ... )\n+ *   t1 c1  t2 c2b\n+ *   t1 c1  t2 c2b\n+ *   t1 c1  ))\n+ *   t1 c1\n+ *   t1 c1\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/template_framework\/CodeFrame.java","additions":59,"deletions":40,"binary":false,"changes":99,"status":"modified"},{"patch":"@@ -30,5 +30,24 @@\n- * The {@link TemplateFrame} is the frame for a single rendering of a {@link Template} and\n- * its inner {@link Template#scope}s. It ensures that each {@link Template} use has its own\n- * unique {@link #id} used to deconflict names using {@link Template#$}. It also has a set\n- * of hashtag replacements, which combine the key-value pairs from the template argument and\n- * the {@link Template#let} definitions. Inner scopes of a {@link Template} have access to\n+ * The {@link TemplateFrame} keeps track of the nested hashtag replacements available\n+ * inside the {@link Template}, as well as the unique id of the {@link Template} use,\n+ * and how much fuel is available for recursive {@link Template} calls. The name of\n+ * the {@link TemplateFrame} indicates that it corresponds to the structure of the\n+ * {@link Template}, whereas the {@link CodeFrame} corresponds to the structure of\n+ * the generated code.\n+ *\n+ * <p>\n+ * The unique id is used to deconflict names using {@link Template#$}.\n+ *\n+ * <p>\n+ * A {@link Template} can have multiple {@link TemplateFrame}s, if there are nested\n+ * scopes. The outermost {@link TemplateFrame} determines the id of the {@link Tmeplate}\n+ * use and performs the subtraction of fuel from the outer {@link Template}. Inner\n+ * {@link TemplateFrame}s ensure the correct availability of hashtag replacement and\n+ * {@link Template#setFuelCost} definitions, so that they are local to their scope and\n+ * nested scopes, and only escape if the scope is transparent.\n+ *\n+ * <p>\n+ * The hashtag replacements are a set of key-value pairs from the template arguments\n+ * and queries such as {@link Template#let} definitions. Each {@link TemplateFrame}\n+ * has such a set of hashtag replacements, and implicitly provides access to the\n+ * hashtag replacmeents of the outer {@link TemplateFrame}s, up to the outermost\n+ * of the current {@link Template}. Inner scopes of a {@link Template} have access to\n@@ -36,5 +55,7 @@\n- * inner scope is local and disappears once we leave the scope. The {@link #parent} relationship\n- * provides a trace for the use chain of templates and their inner scopes. The {@link #fuel}\n- * is reduced over this chain to give a heuristic on how much time is spent on the code\n- * from the template corresponding to the frame, and to give a termination criterion to avoid\n- * nesting templates too deeply.\n+ * inner scope is local and disappears once we leave the scope.\n+ *\n+ * <p>\n+ * The {@link #parent} relationship provides a trace for the use chain of templates and\n+ * their inner scopes. The {@link #fuel} is reduced over this chain to give a heuristic\n+ * on how much time is spent on the code from the template corresponding to the frame,\n+ * and to give a termination criterion to avoid nesting templates too deeply.\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/template_framework\/TemplateFrame.java","additions":31,"deletions":10,"binary":false,"changes":41,"status":"modified"}]}