{"files":[{"patch":"@@ -354,1 +354,2 @@\n-                    public void verifyIsOfType(PackageType ... types) {\n+                    public JPackageCommand verifyIsOfType(Set<PackageType> types) {\n+                        return this;\n","filename":"test\/jdk\/tools\/jpackage\/helpers-test\/jdk\/jpackage\/test\/PackageTestTest.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -168,1 +168,1 @@\n-        cmd.addVerifyAction(createVerifierAsConsumer());\n+        cmd.addVerifyAction(createVerifierAsConsumer(), JPackageCommand.ActionRole.LAUNCHER_VERIFIER);\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/AdditionalLauncher.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -195,3 +195,1 @@\n-        if (cmd.isRuntime()) {\n-            throw new UnsupportedOperationException();\n-        }\n+        cmd.verifyNotRuntime();\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/ConfigFilesStasher.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import static java.util.stream.Collectors.toCollection;\n@@ -35,0 +36,1 @@\n+import java.io.UncheckedIOException;\n@@ -38,0 +40,1 @@\n+import java.nio.file.LinkOption;\n@@ -51,0 +54,1 @@\n+import java.util.TreeSet;\n@@ -59,0 +63,1 @@\n+import java.util.stream.StreamSupport;\n@@ -88,1 +93,0 @@\n-        dmgInstallDir = cmd.dmgInstallDir;\n@@ -168,5 +172,0 @@\n-    public String getArgumentValue(String argName,\n-            Function<JPackageCommand, String> defaultValueSupplier) {\n-        return getArgumentValue(argName, defaultValueSupplier, v -> v);\n-    }\n-\n@@ -335,0 +334,5 @@\n+    public JPackageCommand usePredefinedAppImage(Path predefinedAppImagePath) {\n+        return setArgumentValue(\"--app-image\", Objects.requireNonNull(predefinedAppImagePath))\n+                .removeArgumentWithValue(\"--input\");\n+    }\n+\n@@ -341,1 +345,11 @@\n-        verifyActions.add(action);\n+        return addVerifyAction(action, ActionRole.DEFAULT);\n+    }\n+\n+    enum ActionRole {\n+        DEFAULT,\n+        LAUNCHER_VERIFIER,\n+        ;\n+    }\n+\n+    JPackageCommand addVerifyAction(ThrowingConsumer<JPackageCommand> action, ActionRole actionRole) {\n+        verifyActions.add(action, actionRole);\n@@ -345,0 +359,4 @@\n+    Stream<ThrowingConsumer<JPackageCommand>> getVerifyActionsWithRole(ActionRole actionRole) {\n+        return verifyActions.actionsWithRole(actionRole);\n+    }\n+\n@@ -553,5 +571,1 @@\n-            if (packageType() == PackageType.MAC_DMG && dmgInstallDir != null) {\n-                return dmgInstallDir;\n-            } else {\n-                return MacHelper.getInstallationDirectory(this);\n-            }\n+            return MacHelper.getInstallationDirectory(this);\n@@ -679,1 +693,1 @@\n-    private void verifyNotRuntime() {\n+    JPackageCommand verifyNotRuntime() {\n@@ -681,1 +695,1 @@\n-            throw new IllegalArgumentException(\"Java runtime packaging\");\n+            throw new UnsupportedOperationException(\"Java runtime packaging\");\n@@ -683,0 +697,1 @@\n+        return this;\n@@ -1215,0 +1230,46 @@\n+        PREDEFINED_APP_IMAGE_COPY(cmd -> {\n+            Optional.ofNullable(cmd.getArgumentValue(\"--app-image\")).filter(_ -> {\n+                return !TKit.isOSX() || !MacHelper.signPredefinedAppImage(cmd);\n+            }).map(Path::of).ifPresent(predefinedAppImage -> {\n+\n+                TKit.trace(String.format(\n+                        \"Check contents of the predefined app image [%s] copied verbatim\",\n+                        predefinedAppImage));\n+\n+                var outputAppImageDir = cmd.pathToUnpackedPackageFile(cmd.appInstallationDirectory());\n+\n+                try (var walk = Files.walk(predefinedAppImage)) {\n+                    var filteredWalk = walk;\n+                    if (!cmd.expectAppImageFile()) {\n+                        var appImageFile = AppImageFile.getPathInAppImage(predefinedAppImage);\n+                        \/\/ Exclude \".jpackage.xml\" as it should no be in the output bundle.\n+                        var pred = Predicate.<Path>isEqual(appImageFile).negate();\n+                        if (TKit.isOSX()) {\n+                            \/\/ On MacOS exclude files that can be signed as their digests change.\n+                            pred = pred.and(path -> {\n+                                return MacHelper.isVerbatimCopyFromPredefinedAppImage(cmd, path);\n+                            });\n+                        }\n+\n+                        filteredWalk = walk.filter(pred);\n+                    }\n+\n+                    var verbatimPaths = filteredWalk.collect(toCollection(TreeSet::new));\n+\n+                    \/\/ Remove nonempty directories for the collection of paths copied verbatim.\n+                    verbatimPaths.removeAll(verbatimPaths.stream().map(Path::getParent).toList());\n+\n+                    verbatimPaths.forEach(ThrowingConsumer.toConsumer(p -> {\n+                        if (Files.isDirectory(p, LinkOption.NOFOLLOW_LINKS)) {\n+                            TKit.assertDirectoryExists(p);\n+                        } else {\n+                            TKit.assertSameFileContent(p, outputAppImageDir.resolve(predefinedAppImage.relativize(p)));\n+                        }\n+                    }));\n+                } catch (IOException ex) {\n+                    throw new UncheckedIOException(ex);\n+                }\n+\n+                TKit.trace(\"Done\");\n+            });\n+        })\n@@ -1223,1 +1284,0 @@\n-            copy.immutable = false;\n@@ -1225,1 +1285,0 @@\n-            copy.dmgInstallDir = cmd.appInstallationDirectory();\n@@ -1443,2 +1502,2 @@\n-    public void verifyIsOfType(Collection<PackageType> types) {\n-        verifyIsOfType(types.toArray(PackageType[]::new));\n+    final public JPackageCommand verifyIsOfType(PackageType ... types) {\n+        return verifyIsOfType(Set.of(types));\n@@ -1447,2 +1506,6 @@\n-    public void verifyIsOfType(PackageType ... types) {\n-        final var typesSet = Stream.of(types).collect(Collectors.toSet());\n+    final public JPackageCommand verifyIsOfType(Iterable<PackageType> types) {\n+        return verifyIsOfType(StreamSupport.stream(types.spliterator(), false).collect(toSet()));\n+    }\n+\n+    public JPackageCommand verifyIsOfType(Set<PackageType> types) {\n+        Objects.requireNonNull(types);\n@@ -1451,2 +1514,2 @@\n-                if ((TKit.isLinux() && typesSet.equals(PackageType.LINUX)) || (TKit.isWindows() && typesSet.equals(PackageType.WINDOWS))) {\n-                    return;\n+                if ((TKit.isLinux() && types.equals(PackageType.LINUX)) || (TKit.isWindows() && types.equals(PackageType.WINDOWS))) {\n+                    return this;\n@@ -1455,2 +1518,2 @@\n-                if (TKit.isOSX() && typesSet.equals(PackageType.MAC)) {\n-                    return;\n+                if (TKit.isOSX() && types.equals(PackageType.MAC)) {\n+                    return this;\n@@ -1458,2 +1521,2 @@\n-            } else if (typesSet.equals(Set.of(PackageType.IMAGE))) {\n-                return;\n+            } else if (types.equals(Set.of(PackageType.IMAGE))) {\n+                return this;\n@@ -1463,2 +1526,2 @@\n-        if (!typesSet.contains(packageType())) {\n-            throw new IllegalArgumentException(\"Unexpected type\");\n+        if (!types.contains(packageType())) {\n+            throw new UnsupportedOperationException(String.format(\"Unsupported operation for type [%s]\", packageType().getType()));\n@@ -1466,0 +1529,2 @@\n+\n+        return this;\n@@ -1561,1 +1626,4 @@\n-            Objects.requireNonNull(action);\n+            add(action, ActionRole.DEFAULT);\n+        }\n+\n+        void add(ThrowingConsumer<JPackageCommand> action, ActionRole role) {\n@@ -1563,7 +1631,30 @@\n-            actions.add(new Consumer<JPackageCommand>() {\n-                @Override\n-                public void accept(JPackageCommand t) {\n-                    if (!executed) {\n-                        executed = true;\n-                        ThrowingConsumer.toConsumer(action).accept(t);\n-                    }\n+            actions.add(new Action(action, role));\n+        }\n+\n+        Stream<ThrowingConsumer<JPackageCommand>> actionsWithRole(ActionRole role) {\n+            Objects.requireNonNull(role);\n+            return actions.stream().filter(action -> {\n+                return Objects.equals(action.role(), role);\n+            }).map(Action::impl);\n+        }\n+\n+        private static final class Action implements Consumer<JPackageCommand> {\n+\n+            Action(ThrowingConsumer<JPackageCommand> impl, ActionRole role) {\n+                this.impl = Objects.requireNonNull(impl);\n+                this.role = Objects.requireNonNull(role);\n+            }\n+\n+            ActionRole role() {\n+                return role;\n+            }\n+\n+            ThrowingConsumer<JPackageCommand> impl() {\n+                return impl;\n+            }\n+\n+            @Override\n+            public void accept(JPackageCommand cmd) {\n+                if (!executed) {\n+                    executed = true;\n+                    ThrowingConsumer.toConsumer(impl).accept(cmd);\n@@ -1571,2 +1662,5 @@\n-                private boolean executed;\n-            });\n+            }\n+\n+            private final ActionRole role;\n+            private final ThrowingConsumer<JPackageCommand> impl;\n+            private boolean executed;\n@@ -1581,1 +1675,1 @@\n-        private final List<Consumer<JPackageCommand>> actions;\n+        private final List<Action> actions;\n@@ -1592,1 +1686,0 @@\n-    private Path dmgInstallDir;\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/JPackageCommand.java","additions":133,"deletions":40,"binary":false,"changes":173,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import static jdk.jpackage.test.AdditionalLauncher.getAdditionalLauncherProperties;\n@@ -37,0 +38,1 @@\n+import java.util.function.BiFunction;\n@@ -75,0 +77,6 @@\n+    static String launcherDescription(JPackageCommand cmd, String launcherName) {\n+        return launcherDescription(cmd, launcherName, (theCmd, theLauncherName) -> {\n+            return getAdditionalLauncherProperties(theCmd, theLauncherName);\n+        });\n+    }\n+\n@@ -140,2 +148,2 @@\n-        return findProperty(\"description\").orElseGet(() -> {\n-            return cmd.getArgumentValue(\"--description\", cmd::name);\n+        return launcherDescription(cmd, name, (theCmd, theLauncherName) -> {\n+            return properties.orElseThrow();\n@@ -275,1 +283,5 @@\n-        if (TKit.isWindows()) {\n+        if (TKit.isWindows() && !cmd.hasArgument(\"--app-image\")) {\n+            \/\/ On Windows, check the description if the predefined app image is not configured.\n+            \/\/ The description and the icon are encoded in the launcher executable, which should be\n+            \/\/ copied verbatim from the predefined app image into the output bundle.\n+            \/\/ This check is done in the JPackageCommand class, so there is no need to duplicate it here.\n@@ -427,0 +439,18 @@\n+    private static String launcherDescription(\n+            JPackageCommand cmd,\n+            String launcherName,\n+            BiFunction<JPackageCommand, String, PropertyFile> addLauncherPropertyFileGetter) {\n+\n+        return PropertyFinder.findLauncherProperty(cmd, launcherName,\n+                PropertyFinder.cmdlineOptionWithValue(\"--description\"),\n+                PropertyFinder.launcherPropertyFile(\"description\"),\n+                PropertyFinder.nop()\n+        ).orElseGet(() -> {\n+            if (cmd.isMainLauncher(launcherName)) {\n+                return cmd.mainLauncherName();\n+            } else {\n+                return launcherDescription(cmd, null, addLauncherPropertyFileGetter);\n+            }\n+        });\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/LauncherVerifier.java","additions":33,"deletions":3,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -29,1 +29,0 @@\n-import static jdk.jpackage.test.AdditionalLauncher.getAdditionalLauncherProperties;\n@@ -563,8 +562,1 @@\n-        final String launcherDescription;\n-        if (cmd.name().equals(launcherName) || predefinedAppImage.isPresent()) {\n-            launcherDescription = Optional.ofNullable(cmd.getArgumentValue(\"--description\")).orElseGet(cmd::name);\n-        } else {\n-            launcherDescription = getAdditionalLauncherProperties(cmd, launcherName).findProperty(\"description\").or(() -> {\n-                return Optional.ofNullable(cmd.getArgumentValue(\"--description\"));\n-            }).orElseGet(cmd::name);\n-        }\n+        final var launcherDescription = LauncherVerifier.launcherDescription(cmd, launcherName);\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/LinuxHelper.java","additions":1,"deletions":9,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -548,0 +548,37 @@\n+    static boolean isVerbatimCopyFromPredefinedAppImage(JPackageCommand cmd, Path path) {\n+        cmd.verifyIsOfType(PackageType.MAC);\n+\n+        final var predefinedAppImage = Path.of(cmd.getArgumentValue(\"--app-image\"));\n+\n+        final var appLayout = ApplicationLayout.macAppImage().resolveAt(predefinedAppImage);\n+\n+        if (!path.startsWith(predefinedAppImage)) {\n+            throw new IllegalArgumentException(\n+                    String.format(\"Path [%s] is not in directory [%s]\", path, predefinedAppImage));\n+        }\n+\n+        if (path.startsWith(appLayout.contentDirectory().resolve(\"_CodeSignature\"))) {\n+            \/\/ A file in the \"Contents\/_CodeSignature\" directory.\n+            return false;\n+        }\n+\n+        final var outputAppImageDir = cmd.pathToUnpackedPackageFile(cmd.appInstallationDirectory());\n+\n+        final var outputAppImagePath = outputAppImageDir.resolve(predefinedAppImage.relativize(path));\n+\n+        if (path.startsWith(appLayout.launchersDirectory()) &&\n+                cmd.launcherNames(true).stream().map(cmd::appLauncherPath).collect(toSet()).contains(outputAppImagePath)) {\n+            \/\/ The `path` references a launcher.\n+            \/\/ It can be signed and its digest may change.\n+            return false;\n+        }\n+\n+        if (path.startsWith(appLayout.runtimeHomeDirectory().resolve(\"bin\"))) {\n+            \/\/ The `path` references an executable native command in JDK's \"bin\" subdirectory.\n+            \/\/ It can be signed and its digest may change.\n+            return false;\n+        }\n+\n+        return true;\n+    }\n+\n@@ -719,6 +756,2 @@\n-        final Path installLocation;\n-        if (cmd.packageType() == PackageType.MAC_DMG) {\n-            installLocation = defaultInstallLocation;\n-        } else {\n-            installLocation = cmd.getArgumentValue(\"--install-dir\", () -> defaultInstallLocation, Path::of);\n-        }\n+        final Path installLocation = Optional.ofNullable(cmd.getArgumentValue(\"--install-dir\"))\n+                .map(Path::of).orElse(defaultInstallLocation);\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/MacHelper.java","additions":39,"deletions":6,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -63,0 +63,1 @@\n+import jdk.jpackage.test.JPackageCommand.ActionRole;\n@@ -236,0 +237,9 @@\n+    public PackageTest usePredefinedAppImage(JPackageCommand appImageCmd) {\n+        appImageCmd.verifyIsOfType(PackageType.IMAGE);\n+        addInitializer(cmd -> {\n+            cmd.usePredefinedAppImage(appImageCmd.outputBundle());\n+        });\n+        appImageCmd.getVerifyActionsWithRole(ActionRole.LAUNCHER_VERIFIER).forEach(this::addInstallVerifier);\n+        return this;\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/PackageTest.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import java.util.function.BiFunction;\n@@ -30,0 +31,1 @@\n+import java.util.function.Supplier;\n@@ -45,0 +47,6 @@\n+        default Finder<T> defaultValue(Supplier<String> v) {\n+            return target -> {\n+                return Optional.of(find(target).orElseGet(v));\n+            };\n+        }\n+\n@@ -137,0 +145,19 @@\n+        return findLauncherProperty(\n+                cmd,\n+                launcherName,\n+                (theCmd, theLauncherName) -> {\n+                    return getAdditionalLauncherProperties(theCmd, theLauncherName);\n+                },\n+                cmdlineFinder,\n+                addLauncherPropertyFileFinder,\n+                appImageFileFinder);\n+    }\n+\n+    static Optional<String> findLauncherProperty(\n+            JPackageCommand cmd,\n+            String launcherName,\n+            BiFunction<JPackageCommand, String, PropertyFile> addLauncherPropertyFileGetter,\n+            Finder<JPackageCommand> cmdlineFinder,\n+            Finder<PropertyFile> addLauncherPropertyFileFinder,\n+            Finder<AppImageFile> appImageFileFinder) {\n+\n@@ -138,0 +165,1 @@\n+        Objects.requireNonNull(addLauncherPropertyFileGetter);\n@@ -151,1 +179,1 @@\n-            var props = getAdditionalLauncherProperties(cmd, launcherName);\n+            var props = addLauncherPropertyFileGetter.apply(cmd, launcherName);\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/PropertyFinder.java","additions":29,"deletions":1,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -202,1 +202,1 @@\n-            }).addInitializer(cmd -> {\n+            }).usePredefinedAppImage(appImageCmd).addInitializer(cmd -> {\n@@ -204,2 +204,0 @@\n-                cmd.addArguments(\"--app-image\", appImageCmd.outputBundle());\n-                cmd.removeArgumentWithValue(\"--input\");\n","filename":"test\/jdk\/tools\/jpackage\/macosx\/SigningPackageTwoStepTest.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -199,1 +199,3 @@\n-        Path[] predefinedAppImage = new Path[1];\n+        var appImageCmd = JPackageCommand.helloAppImage()\n+                .setArgumentValue(\"--name\", \"foo\")\n+                .setFakeRuntime();\n@@ -201,12 +203,5 @@\n-        new PackageTest().addRunOnceInitializer(() -> {\n-            var cmd = JPackageCommand.helloAppImage()\n-                    .setArgumentValue(\"--name\", \"foo\")\n-                    .setFakeRuntime();\n-\n-            for (var i = 1; i != cfgs.length; ++i) {\n-                var al = new AdditionalLauncher(\"launcher-\" + i);\n-                cfgs[i].applyToAdditionalLauncher(al);\n-                al.withoutVerifyActions(Action.EXECUTE_LAUNCHER).applyTo(cmd);\n-            }\n-\n-            cmd.execute();\n+        for (var i = 1; i != cfgs.length; ++i) {\n+            var al = new AdditionalLauncher(\"launcher-\" + i);\n+            cfgs[i].applyToAdditionalLauncher(al);\n+            al.withoutVerifyActions(Action.EXECUTE_LAUNCHER).applyTo(appImageCmd);\n+        }\n@@ -214,2 +209,4 @@\n-            predefinedAppImage[0] = cmd.outputBundle();\n-        }).addInitializer(cmd -> {\n+        new PackageTest()\n+        .addRunOnceInitializer(appImageCmd::execute)\n+        .usePredefinedAppImage(appImageCmd)\n+        .addInitializer(cmd -> {\n@@ -217,1 +214,0 @@\n-            cmd.removeArgumentWithValue(\"--input\");\n@@ -219,1 +215,0 @@\n-            cmd.addArguments(\"--app-image\", predefinedAppImage[0]);\n@@ -240,6 +235,3 @@\n-        Path[] predefinedAppImage = new Path[1];\n-\n-        new PackageTest().addRunOnceInitializer(() -> {\n-            var cmd = JPackageCommand.helloAppImage()\n-                    .setArgumentValue(\"--name\", \"foo\")\n-                    .setFakeRuntime();\n+        var appImageCmd = JPackageCommand.helloAppImage()\n+                .setArgumentValue(\"--name\", \"foo\")\n+                .setFakeRuntime();\n@@ -247,5 +239,4 @@\n-            cmd.execute();\n-\n-            predefinedAppImage[0] = cmd.outputBundle();\n-        }).addInitializer(cmd -> {\n-            cmd.removeArgumentWithValue(\"--input\");\n+        new PackageTest()\n+        .addRunOnceInitializer(appImageCmd::execute)\n+        .usePredefinedAppImage(appImageCmd)\n+        .addInitializer(cmd -> {\n@@ -253,1 +244,0 @@\n-            cmd.addArguments(\"--app-image\", predefinedAppImage[0]);\n","filename":"test\/jdk\/tools\/jpackage\/share\/AddLShortcutTest.java","additions":19,"deletions":29,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -278,1 +278,1 @@\n-                \/\/ Should not have impact of launcher descriptions, but it does.\n+                \/\/ Should not have impact on launcher descriptions, but it does.\n@@ -280,2 +280,1 @@\n-                cmd.removeArgumentWithValue(\"--input\").setArgumentValue(\"--app-image\", target.cmd().orElseThrow().outputBundle());\n-            }).mutate(addLinuxShortcuts()).run(Action.CREATE_AND_UNPACK);\n+            }).usePredefinedAppImage(target.cmd().orElseThrow()).mutate(addLinuxShortcuts()).run(Action.CREATE_AND_UNPACK);\n","filename":"test\/jdk\/tools\/jpackage\/share\/AddLauncherTest.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -502,1 +502,1 @@\n-            for (var textFile : Map.ofEntries(\n+            for (var textFile : List.of(\n@@ -506,1 +506,1 @@\n-            ).entrySet()) {\n+            )) {\n","filename":"test\/jdk\/tools\/jpackage\/share\/AppContentTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -65,2 +65,1 @@\n-        var appImageCmd = JPackageCommand.helloAppImage()\n-                .setArgumentValue(\"--dest\", TKit.createTempDirectory(\"appimage\"));\n+        final var appImageCmd = createAppImageCommand();\n@@ -70,4 +69,2 @@\n-        .addInitializer(cmd -> {\n-            cmd.addArguments(\"--app-image\", appImageCmd.outputBundle());\n-            cmd.removeArgumentWithValue(\"--input\");\n-        }).addBundleDesktopIntegrationVerifier(false).run();\n+        .usePredefinedAppImage(appImageCmd)\n+        .addBundleDesktopIntegrationVerifier(false).run();\n@@ -88,4 +85,1 @@\n-        var appImageCmd = JPackageCommand.helloAppImage()\n-                .setFakeRuntime()\n-                .setArgumentValue(\"--name\", \"EmptyAppImagePackageTest\")\n-                .setArgumentValue(\"--dest\", TKit.createTempDirectory(\"appimage\"));\n+        final var appImageCmd = createAppImageCommand();\n@@ -119,0 +113,1 @@\n+        .usePredefinedAppImage(appImageCmd)\n@@ -120,1 +115,0 @@\n-            cmd.addArguments(\"--app-image\", appImageCmd.outputBundle());\n@@ -122,1 +116,1 @@\n-                cmd.addArguments(\"--icon\", iconPath(\"icon\"));\n+                cmd.setArgumentValue(\"--icon\", iconPath(\"icon\"));\n@@ -124,1 +118,0 @@\n-            cmd.removeArgumentWithValue(\"--input\");\n@@ -163,1 +156,0 @@\n-        Path appImageDir = TKit.createTempDirectory(\"appimage\");\n@@ -165,2 +157,1 @@\n-        JPackageCommand appImageCmd = JPackageCommand.helloAppImage().\n-                setFakeRuntime().setArgumentValue(\"--dest\", appImageDir);\n+        final var appImageCmd = createAppImageCommand();\n@@ -179,1 +170,0 @@\n-        final var appImageRoot = TKit.createTempDirectory(\"appimage\");\n@@ -181,2 +171,1 @@\n-        final var appImageCmd = JPackageCommand.helloAppImage().\n-                setFakeRuntime().setArgumentValue(\"--dest\", appImageRoot);\n+        final var appImageCmd = createAppImageCommand();\n@@ -205,2 +194,1 @@\n-            cmd.addArguments(\"--app-image\", appImageDir);\n-            cmd.removeArgumentWithValue(\"--input\");\n+            cmd.usePredefinedAppImage(appImageDir);\n@@ -212,0 +200,5 @@\n+    private static JPackageCommand createAppImageCommand() {\n+        final var appImageRoot = TKit.createTempDirectory(\"appimage\");\n+        return JPackageCommand.helloAppImage().setFakeRuntime().setArgumentValue(\"--dest\", appImageRoot);\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/share\/AppImagePackageTest.java","additions":14,"deletions":21,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -37,2 +37,0 @@\n-import jdk.jpackage.test.TKit;\n-import jdk.jpackage.test.TKit.TextStreamVerifier;\n@@ -116,1 +114,1 @@\n-    record DmgTestSpec(Path installDir, boolean runtimeInstaller) {\n+    record TestSpec(Path installDir, boolean runtimeInstaller) {\n@@ -118,1 +116,1 @@\n-        DmgTestSpec {\n+        TestSpec {\n@@ -138,2 +136,2 @@\n-            DmgTestSpec create() {\n-                return new DmgTestSpec(installDir, runtimeInstaller);\n+            TestSpec create() {\n+                return new TestSpec(installDir, runtimeInstaller);\n@@ -157,1 +155,1 @@\n-            final var test = new PackageTest().forTypes(PackageType.MAC_DMG).ignoreBundleOutputDir();\n+            final var test = new PackageTest().ignoreBundleOutputDir();\n@@ -167,1 +165,1 @@\n-                cmd.addArguments(\"--install-dir\", installDir);\n+                cmd.setArgumentValue(\"--install-dir\", installDir);\n@@ -174,1 +172,1 @@\n-    public static void testDmg(DmgTestSpec testSpec) {\n+    public static void testMac(TestSpec testSpec) {\n@@ -178,1 +176,1 @@\n-    public static List<Object[]> testDmg() {\n+    public static List<Object[]> testMac() {\n@@ -180,4 +178,4 @@\n-                DmgTestSpec.build().acceptedInstallDir(\"\/foo\"),\n-                DmgTestSpec.build().acceptedInstallDir(\"\/foo\/bar\"),\n-                DmgTestSpec.build().acceptedInstallDir(\"\/foo\").runtimeInstaller(),\n-                DmgTestSpec.build().acceptedInstallDir(\"\/foo\/bar\").runtimeInstaller(),\n+                TestSpec.build().acceptedInstallDir(\"\/foo\"),\n+                TestSpec.build().acceptedInstallDir(\"\/foo\/bar\"),\n+                TestSpec.build().acceptedInstallDir(\"\/foo\").runtimeInstaller(),\n+                TestSpec.build().acceptedInstallDir(\"\/foo\/bar\").runtimeInstaller(),\n@@ -185,2 +183,2 @@\n-                DmgTestSpec.build().acceptedInstallDir(\"\/Library\/Java\/JavaVirtualMachines\"),\n-                DmgTestSpec.build().acceptedInstallDir(\"\/Applications\").runtimeInstaller(),\n+                TestSpec.build().acceptedInstallDir(\"\/Library\/Java\/JavaVirtualMachines\"),\n+                TestSpec.build().acceptedInstallDir(\"\/Applications\").runtimeInstaller(),\n@@ -188,2 +186,2 @@\n-                DmgTestSpec.build().acceptedInstallDir(\"\/Applications\"),\n-                DmgTestSpec.build().acceptedInstallDir(\"\/Applications\/foo\/bar\/buz\"),\n+                TestSpec.build().acceptedInstallDir(\"\/Applications\"),\n+                TestSpec.build().acceptedInstallDir(\"\/Applications\/foo\/bar\/buz\"),\n@@ -191,3 +189,3 @@\n-                DmgTestSpec.build().runtimeInstaller().acceptedInstallDir(\"\/Library\/Java\/JavaVirtualMachines\"),\n-                DmgTestSpec.build().runtimeInstaller().acceptedInstallDir(\"\/Library\/Java\/JavaVirtualMachines\/foo\/bar\/buz\")\n-        ).map(DmgTestSpec.Builder::create).map(testSpec -> {\n+                TestSpec.build().runtimeInstaller().acceptedInstallDir(\"\/Library\/Java\/JavaVirtualMachines\"),\n+                TestSpec.build().runtimeInstaller().acceptedInstallDir(\"\/Library\/Java\/JavaVirtualMachines\/foo\/bar\/buz\")\n+        ).map(TestSpec.Builder::create).map(testSpec -> {\n","filename":"test\/jdk\/tools\/jpackage\/share\/InstallDirTest.java","additions":19,"deletions":21,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -25,1 +25,0 @@\n-import java.io.IOException;\n@@ -27,0 +26,2 @@\n+import jdk.jpackage.test.Annotations.Test;\n+import jdk.jpackage.test.JPackageCommand;\n@@ -30,2 +31,0 @@\n-import jdk.jpackage.test.Annotations.Test;\n-import jdk.jpackage.test.JPackageCommand;\n@@ -58,1 +57,1 @@\n-    public static void test() throws IOException {\n+    public static void test() {\n@@ -71,1 +70,1 @@\n-                .addRunOnceInitializer(() -> appImageCmd.execute())\n+                .addRunOnceInitializer(appImageCmd::execute)\n@@ -73,4 +72,1 @@\n-                .addInitializer(cmd -> {\n-                    cmd.addArguments(\"--app-image\", appImageCmd.outputBundle());\n-                    cmd.removeArgumentWithValue(\"--input\");\n-                })\n+                .usePredefinedAppImage(appImageCmd)\n","filename":"test\/jdk\/tools\/jpackage\/share\/MultiLauncherTwoPhaseTest.java","additions":5,"deletions":9,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -25,1 +25,3 @@\n-import java.io.IOException;\n+import jdk.jpackage.test.Annotations.Parameter;\n+import jdk.jpackage.test.Annotations.Test;\n+import jdk.jpackage.test.JPackageCommand;\n@@ -29,3 +31,0 @@\n-import jdk.jpackage.test.Annotations.Test;\n-import jdk.jpackage.test.Annotations.Parameter;\n-import jdk.jpackage.test.JPackageCommand;\n@@ -61,3 +60,1 @@\n-    public static void test(String... testArgs) throws IOException {\n-        String appName = testArgs[0];\n-        String installName = testArgs[1];\n+    public static void test(String appName, String installName) {\n@@ -77,0 +74,1 @@\n+                .usePredefinedAppImage(appImageCmd)\n@@ -78,2 +76,0 @@\n-                    cmd.addArguments(\"--app-image\", appImageCmd.outputBundle());\n-                    cmd.removeArgumentWithValue(\"--input\");\n","filename":"test\/jdk\/tools\/jpackage\/share\/MultiNameTwoPhaseTest.java","additions":5,"deletions":9,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -110,4 +110,1 @@\n-                    test.addInitializer(cmd -> {\n-                        cmd.removeArgumentWithValue(\"--input\");\n-                        cmd.addArguments(\"--app-image\", appImageCmd.outputBundle());\n-                    });\n+                    test.usePredefinedAppImage(appImageCmd);\n","filename":"test\/jdk\/tools\/jpackage\/share\/PostImageScriptTest.java","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -246,4 +246,1 @@\n-                .addInitializer(cmd -> {\n-                    cmd.removeArgumentWithValue(\"--input\");\n-                    cmd.addArguments(\"--app-image\", appImageCmd.cmd().orElseThrow().outputBundle());\n-                })\n+                .usePredefinedAppImage(appImageCmd.cmd().orElseThrow())\n","filename":"test\/jdk\/tools\/jpackage\/share\/ServiceTest.java","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -27,2 +27,2 @@\n-import jdk.jpackage.test.PackageTest;\n-import jdk.jpackage.test.JPackageCommand;\n+import java.util.List;\n+import java.util.stream.Stream;\n@@ -30,0 +30,2 @@\n+import jdk.jpackage.test.JPackageCommand;\n+import jdk.jpackage.test.PackageTest;\n@@ -51,1 +53,1 @@\n-    public void test() throws IOException {\n+    public void test() {\n@@ -57,1 +59,1 @@\n-        String[] filesWithDollarCharsInNames = new String[]{\n+        var filesWithDollarCharsInNames = Stream.of(\n@@ -66,1 +68,1 @@\n-        };\n+        ).map(Path::of).toList();\n@@ -68,3 +70,3 @@\n-        String[] dirsWithDollarCharsInNames = new String[]{\n-            Path.of(\"foo\", String.join(\"\/\", filesWithDollarCharsInNames)).toString()\n-        };\n+        var dirsWithDollarCharsInNames = List.of(\n+                filesWithDollarCharsInNames.stream().reduce(Path.of(\"foo\"), Path::resolve)\n+        );\n@@ -78,1 +80,1 @@\n-                        createImageFile(appImageCmd, Path.of(path));\n+                        createImageFile(appImageCmd, path);\n@@ -86,0 +88,1 @@\n+                .usePredefinedAppImage(appImageCmd)\n@@ -88,2 +91,0 @@\n-                    cmd.addArguments(\"--app-image\", appImageCmd.outputBundle());\n-                    cmd.removeArgumentWithValue(\"--input\");\n@@ -95,1 +96,1 @@\n-                        verifyImageFile(appImageCmd, Path.of(path));\n+                        verifyImageFile(appImageCmd, path);\n","filename":"test\/jdk\/tools\/jpackage\/windows\/Win8282351Test.java","additions":13,"deletions":12,"binary":false,"changes":25,"status":"modified"}]}