{"files":[{"patch":"@@ -27,0 +27,1 @@\n+COPY += endianness.properties\n","filename":"make\/modules\/jdk.jlink\/Java.gmk","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -66,1 +66,0 @@\n-import jdk.tools.jlink.plugin.ResourcePoolModule;\n@@ -147,1 +146,1 @@\n-    private Platform platform;\n+    private final Platform platform;\n@@ -153,0 +152,1 @@\n+     * @param launchers mapping of launcher command name to their module\/main class\n@@ -154,0 +154,1 @@\n+     * @throws NullPointerException If any of the params is null\n@@ -156,0 +157,15 @@\n+        this(root, launchers, Platform.UNKNOWN);\n+    }\n+\n+    \/**\n+     * Default image builder constructor.\n+     *\n+     * @param root The image root directory.\n+     * @param launchers mapping of launcher command name to their module\/main class\n+     * @param targetPlatform target platform of the image\n+     * @throws IOException\n+     * @throws NullPointerException If any of the params is null\n+     * @since 21\n+     *\/\n+    public DefaultImageBuilder(Path root, Map<String, String> launchers, Platform targetPlatform)\n+            throws IOException {\n@@ -157,0 +173,1 @@\n+        this.platform = Objects.requireNonNull(targetPlatform);\n@@ -170,9 +187,0 @@\n-            String value = files.moduleView()\n-                                .findModule(\"java.base\")\n-                                .map(ResourcePoolModule::targetPlatform)\n-                                .orElse(null);\n-            if (value == null) {\n-                throw new PluginException(\"ModuleTarget attribute is missing for java.base module\");\n-            }\n-            this.platform = Platform.parsePlatform(value);\n-\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/builder\/DefaultImageBuilder.java","additions":20,"deletions":12,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -390,1 +390,1 @@\n-        PluginsConfiguration config = taskHelper.getPluginsConfig(null, null);\n+        PluginsConfiguration config = taskHelper.getPluginsConfig(null, null, null);\n@@ -441,1 +441,1 @@\n-        ImageProvider imageProvider = createImageProvider(config,\n+        ImageHelper imageProvider = createImageProvider(config,\n@@ -450,1 +450,2 @@\n-            taskHelper.getPluginsConfig(options.output, options.launchers));\n+            taskHelper.getPluginsConfig(options.output, options.launchers,\n+                    imageProvider.targetPlatform));\n@@ -544,1 +545,1 @@\n-    private static ImageProvider createImageProvider(JlinkConfiguration config,\n+    private static ImageHelper createImageProvider(JlinkConfiguration config,\n@@ -811,0 +812,1 @@\n+        final Platform targetPlatform;\n@@ -820,0 +822,1 @@\n+                this.targetPlatform = Platform.runtime();\n@@ -829,0 +832,1 @@\n+                    this.targetPlatform = Platform.runtime();\n@@ -837,1 +841,1 @@\n-                    String targetPlatform = null;\n+                    String targetPlatformVal = null;\n@@ -840,1 +844,1 @@\n-                        targetPlatform = modRefImpl.moduleTarget().targetPlatform();\n+                        targetPlatformVal = modRefImpl.moduleTarget().targetPlatform();\n@@ -842,1 +846,1 @@\n-                    if (targetPlatform == null) {\n+                    if (targetPlatformVal == null) {\n@@ -847,2 +851,3 @@\n-                    ByteOrder targetByteOrder = getNativeEndianOfTargetPlatform(targetPlatform);\n-                    if (targetByteOrder == null) {\n+                    this.targetPlatform = Platform.parsePlatform(targetPlatformVal);\n+                    this.order = this.targetPlatform.getNativeByteOrder();\n+                    if (this.order == null) {\n@@ -852,1 +857,1 @@\n-                                        targetPlatform));\n+                                        targetPlatformVal));\n@@ -854,1 +859,0 @@\n-                    this.order = targetByteOrder;\n@@ -857,1 +861,1 @@\n-                                        \" %s%n\", this.order, targetPlatform);\n+                                        \" %s%n\", this.order, targetPlatformVal);\n@@ -950,21 +954,0 @@\n-        \/\/ returns the endianness of the target platform, if the target platform is known\n-        \/\/ and supported for creating an image through jlink. Else returns null.\n-        private static ByteOrder getNativeEndianOfTargetPlatform(String targetPlatform) {\n-            int index = targetPlatform.indexOf(\"-\"); \/\/ of the form <operating system>-<arch>\n-            if (index < 0) {\n-                \/\/ unknown arch\n-                return null;\n-            }\n-            String archName = targetPlatform.substring(index + 1);\n-            return switch (archName) {\n-                case \"x86\", \"x86_64\",\n-                        \"amd64\", \"arm\", \"aarch64\",\n-                        \"loongarch64\", \"ppc64le\",\n-                        \"riscv32\", \"riscv64\" -> ByteOrder.LITTLE_ENDIAN;\n-                case \"ppc\", \"ppc64\",\n-                        \"s390\", \"s390x\",\n-                        \"sparc\", \"sparcv9\" -> ByteOrder.BIG_ENDIAN;\n-                default -> null;\n-            };\n-        }\n-\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/JlinkTask.java","additions":16,"deletions":33,"binary":false,"changes":49,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -27,0 +27,4 @@\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteOrder;\n+import java.util.HashMap;\n@@ -28,0 +32,2 @@\n+import java.util.Map;\n+import java.util.Properties;\n@@ -34,0 +40,29 @@\n+    private static final Map<Architecture, ByteOrder> endianness;\n+\n+    static {\n+        Properties p;\n+        try (InputStream is = Platform.class.getResourceAsStream(\"endianness.properties\")) {\n+            p = new Properties();\n+            p.load(is);\n+        } catch (IOException e) {\n+            throw new ExceptionInInitializerError(e);\n+        }\n+        Map<Architecture, ByteOrder> byteOrders = new HashMap<>();\n+        for (String k : p.stringPropertyNames()) {\n+            Architecture arch = toArch(k);\n+            if (arch == Architecture.UNKNOWN) {\n+                \/\/ skip unknown arch\n+                continue;\n+            }\n+            String v = p.getProperty(k);\n+            ByteOrder endian = switch (v.trim().toLowerCase(Locale.ROOT)) {\n+                case \"little\" -> ByteOrder.LITTLE_ENDIAN;\n+                case \"big\" -> ByteOrder.BIG_ENDIAN;\n+                default -> throw new ExceptionInInitializerError(\"Unrecognized endian value '\"\n+                        + v + \"' for arch '\" + k + \"'\");\n+            };\n+            byteOrders.put(arch, endian);\n+        }\n+        endianness = byteOrders;\n+    }\n+\n@@ -47,0 +82,10 @@\n+        LOONGARCH64,\n+        PPC,\n+        PPC64,\n+        PPC64LE,\n+        RISCV32,\n+        RISCV64,\n+        s390,\n+        s390x,\n+        SPARC,\n+        SPARCv9,\n@@ -91,0 +136,7 @@\n+    \/**\n+     * {@return the native {@link ByteOrder} of this {@code Platform} or null if not known}\n+     *\/\n+    public ByteOrder getNativeByteOrder() {\n+        return endianness.get(arch);\n+    }\n+\n@@ -131,0 +183,10 @@\n+            case \"loongarch64\"     -> Architecture.LOONGARCH64;\n+            case \"ppc\"             -> Architecture.PPC;\n+            case \"ppc64\"           -> Architecture.PPC64;\n+            case \"ppc64le\"         -> Architecture.PPC64LE;\n+            case \"riscv32\"         -> Architecture.RISCV32;\n+            case \"riscv64\"         -> Architecture.RISCV64;\n+            case \"s390\"            -> Architecture.s390;\n+            case \"s390x\"           -> Architecture.s390x;\n+            case \"sparc\"           -> Architecture.SPARC;\n+            case \"sparcv9\"         -> Architecture.SPARCv9;\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/Platform.java","additions":63,"deletions":1,"binary":false,"changes":64,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -420,2 +420,3 @@\n-        private PluginsConfiguration getPluginsConfig(Path output, Map<String, String> launchers\n-                    ) throws IOException, BadArgs {\n+        private PluginsConfiguration getPluginsConfig(Path output, Map<String, String> launchers,\n+                                                      Platform targetPlatform)\n+                throws IOException, BadArgs {\n@@ -468,1 +469,1 @@\n-                builder = new DefaultImageBuilder(output, launchers);\n+                builder = new DefaultImageBuilder(output, launchers, targetPlatform);\n@@ -719,1 +720,2 @@\n-    public PluginsConfiguration getPluginsConfig(Path output, Map<String, String> launchers)\n+    public PluginsConfiguration getPluginsConfig(Path output, Map<String, String> launchers,\n+                                                 Platform targetPlatform)\n@@ -721,1 +723,1 @@\n-        return pluginOptions.getPluginsConfig(output, launchers);\n+        return pluginOptions.getPluginsConfig(output, launchers, targetPlatform);\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/TaskHelper.java","additions":8,"deletions":6,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -0,0 +1,40 @@\n+#\n+# Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+#\n+# This code is free software; you can redistribute it and\/or modify it\n+# under the terms of the GNU General Public License version 2 only, as\n+# published by the Free Software Foundation.  Oracle designates this\n+# particular file as subject to the \"Classpath\" exception as provided\n+# by Oracle in the LICENSE file that accompanied this code.\n+#\n+# This code is distributed in the hope that it will be useful, but WITHOUT\n+# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+# version 2 for more details (a copy is included in the LICENSE file that\n+# accompanied this code).\n+#\n+# You should have received a copy of the GNU General Public License version\n+# 2 along with this work; if not, write to the Free Software Foundation,\n+# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+#\n+# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+# or visit www.oracle.com if you need additional information or have any\n+# questions.\n+#\n+# architecture mapped to their endianness\n+x86=little\n+x86_64=little\n+amd64=little\n+arm=little\n+aarch64=little\n+loongarch64=little\n+ppc64le=little\n+riscv32=little\n+riscv64=little\n+ppc=big\n+ppc64=big\n+s390=big\n+s390x=big\n+sparc=big\n+sparcv9=big\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/endianness.properties","additions":40,"deletions":0,"binary":false,"changes":40,"status":"added"}]}