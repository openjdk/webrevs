{"files":[{"patch":"@@ -2498,1 +2498,1 @@\n-    __ blt(keylen, t2, L_aes128);\n+    __ bltu(keylen, t2, L_aes128);\n@@ -2577,1 +2577,1 @@\n-    __ blt(keylen, t2, L_aes128);\n+    __ bltu(keylen, t2, L_aes128);\n@@ -2610,14 +2610,23 @@\n-  \/\/ Big-endian 128-bit + 64-bit -> 128-bit addition.\n-  void be_inc_counter_128(Register counter, Register tmp1, Register tmp2) {\n-    assert_different_registers(counter, tmp1, tmp2, t0);\n-    __ ld(tmp1, Address(counter, 8)); \/\/ Load 128-bits from counter\n-    __ ld(tmp2, Address(counter));\n-    __ rev8(tmp1, tmp1);              \/\/ Convert big-endian to little-endian\n-    __ rev8(tmp2, tmp2);\n-    __ addi(tmp1, tmp1, 1);\n-    __ seqz(t0, tmp1);                \/\/ Check for result overflow\n-    __ add(tmp2, tmp2, t0);           \/\/ Add 1 if overflow otherwise 0\n-    __ rev8(tmp1, tmp1);              \/\/ Convert little-endian to big-endian\n-    __ rev8(tmp2, tmp2);\n-    __ sd(tmp1, Address(counter, 8)); \/\/ Store 128-bits to counter\n-    __ sd(tmp2, Address(counter));\n+  \/\/ Load big-endian 128-bit from memory.\n+  void be_load_counter_128(Register counter_hi, Register counter_lo, Register counter) {\n+    __ ld(counter_lo, Address(counter, 8)); \/\/ Load 128-bits from counter\n+    __ ld(counter_hi, Address(counter));\n+    __ rev8(counter_lo, counter_lo);        \/\/ Convert big-endian to little-endian\n+    __ rev8(counter_hi, counter_hi);\n+  }\n+\n+  \/\/ Little-endian 128-bit + 64-bit -> 128-bit addition.\n+  void add_counter_128(Register counter_hi, Register counter_lo) {\n+    assert_different_registers(counter_hi, counter_lo, t0);\n+    __ addi(counter_lo, counter_lo, 1);\n+    __ seqz(t0, counter_lo);                \/\/ Check for result overflow\n+    __ add(counter_hi, counter_hi, t0);     \/\/ Add 1 if overflow otherwise 0\n+  }\n+\n+  \/\/ Store big-endian 128-bit to memory.\n+  void be_store_counter_128(Register counter_hi, Register counter_lo, Register counter) {\n+    assert_different_registers(counter_hi, counter_lo, t0, t1);\n+    __ rev8(t0, counter_lo);                \/\/ Convert little-endian to big-endian\n+    __ rev8(t1, counter_hi);\n+    __ sd(t0, Address(counter, 8));         \/\/ Store 128-bits to counter\n+    __ sd(t1, Address(counter));\n@@ -2657,1 +2666,1 @@\n-    const Register keylen              = x28;\n+    const Register keylen              = c_rarg7; \/\/ temporary register\n@@ -2667,2 +2676,1 @@\n-    __ lw(keylen, Address(key, arrayOopDesc::length_offset_in_bytes() - arrayOopDesc::base_offset_in_bytes(T_INT)));\n-    __ vsetivli(x0, 4, Assembler::e32, Assembler::m1);\n+    __ lwu(keylen, Address(key, arrayOopDesc::length_offset_in_bytes() - arrayOopDesc::base_offset_in_bytes(T_INT)));\n@@ -2670,1 +2678,1 @@\n-    __ blt(keylen, t0, L_aes128);\n+    __ bltu(keylen, t0, L_aes128);\n@@ -2708,2 +2716,2 @@\n-    \/\/     saved_encrypted_ctr = aes_encrypt(counter);\n-    \/\/     increase_counter(counter);\n+    \/\/     saved_encrypted_ctr = generate_aes_encrypt();\n+    \/\/     be_inc_counter_128(counter);\n@@ -2728,5 +2736,5 @@\n-    const Register used                = x29;\n-    const Register len                 = x30;\n-    const Register block_size          = x31;\n-    const Register tmp1                = t1;\n-    const Register tmp2                = t2;\n+    const Register used                = x28;\n+    const Register len                 = x29;\n+    const Register counter_hi          = x30;\n+    const Register counter_lo          = x31;\n+    const Register block_size          = t2;\n@@ -2741,0 +2749,2 @@\n+    __ vsetivli(x0, 4, Assembler::e32, Assembler::m1);\n+\n@@ -2748,0 +2758,3 @@\n+    \/\/ 128-bit big-endian load\n+    be_load_counter_128(counter_hi, counter_lo, counter);\n+\n@@ -2754,5 +2767,5 @@\n-    __ add(tmp1, saved_encrypted_ctr, used);\n-    __ lbu(tmp2, Address(tmp1));\n-    __ lbu(tmp1, Address(in));\n-    __ xorr(tmp2, tmp2, tmp1);\n-    __ sb(tmp2, Address(out));\n+    __ add(t0, saved_encrypted_ctr, used);\n+    __ lbu(t1, Address(t0));\n+    __ lbu(t0, Address(in));\n+    __ xorr(t1, t1, t0);\n+    __ sb(t1, Address(out));\n@@ -2776,2 +2789,4 @@\n-    \/\/ big-endian Increase counter 128\n-    be_inc_counter_128(counter, tmp1, tmp2);\n+    \/\/ 128-bit little-endian increment\n+    add_counter_128(counter_hi, counter_lo);\n+    \/\/ 128-bit big-endian store\n+    be_store_counter_128(counter_hi, counter_lo, counter);\n","filename":"src\/hotspot\/cpu\/riscv\/stubGenerator_riscv.cpp","additions":49,"deletions":34,"binary":false,"changes":83,"status":"modified"}]}