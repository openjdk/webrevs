{"files":[{"patch":"@@ -36,3 +36,3 @@\n-    GrowableArray<StackMapFrame*>* tmp_frame_array = new GrowableArray<StackMapFrame*>();\n-    while(!reader->at_end()) {\n-      StackMapFrame* frame = reader->next(CHECK_VERIFY(reader->pre_frame()->verifier()));\n+    _frame_array = new GrowableArray<StackMapFrame*>();\n+    while (!reader->at_end()) {\n+      StackMapFrame* frame = reader->next(CHECK_VERIFY(reader->prev_frame()->verifier()));\n@@ -40,1 +40,1 @@\n-        tmp_frame_array->push(frame);\n+        _frame_array->push(frame);\n@@ -44,6 +44,24 @@\n-    \/\/ Remake frame array with correct size\n-    _frame_count = tmp_frame_array->length();\n-    _frame_array = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, StackMapFrame*, _frame_count);\n-    for (int i = 0; i < tmp_frame_array->length(); i++) {\n-      _frame_array[i] = tmp_frame_array->at(i);\n-    }\n+    \/\/ Correct frame count based on how many actual frames are generated\n+    _frame_count = _frame_array->length();\n+  }\n+}\n+\n+void StackMapReader::check_offset(StackMapFrame* frame, TRAPS) {\n+  int offset = frame->offset();\n+  if (offset >= _code_length || _code_data[offset] == 0) {\n+    _verifier->verify_error(\n+        ErrorContext::bad_stackmap(0, frame),\n+        \"StackMapTable error: bad offset\");\n+  }\n+}\n+\n+void StackMapReader::check_size(TRAPS) {\n+  if (_frame_count < _parsed_frame_count) {\n+    StackMapStream::stackmap_format_error(\"wrong attribute size\", CHECK);\n+  }\n+}\n+\n+void StackMapReader::check_end(TRAPS) {\n+  assert(_stream->at_end(), \"must be\");\n+  if (_frame_count != _parsed_frame_count) {\n+    StackMapStream::stackmap_format_error(\"wrong attribute size\", CHECK);\n@@ -57,1 +75,1 @@\n-    if (_frame_array[i]->offset() == offset) {\n+    if (_frame_array->at(i)->offset() == offset) {\n@@ -92,1 +110,1 @@\n-  StackMapFrame *stackmap_frame = _frame_array[frame_index];\n+  StackMapFrame *stackmap_frame = _frame_array->at(frame_index);\n@@ -134,1 +152,1 @@\n-      _frame_array[i]->print_on(str);\n+      _frame_array->at(i)->print_on(str);\n@@ -144,4 +162,4 @@\n-                               _verifier(v), _stream(stream), _code_data(code_data),\n-                               _code_length(code_len), _parsed_frame_count(0),\n-                               _pre_frame(init_frame), _max_locals(max_locals),\n-                               _max_stack(max_stack), _first(true) {\n+                                  _verifier(v), _stream(stream), _code_data(code_data),\n+                                  _code_length(code_len), _parsed_frame_count(0),\n+                                  _prev_frame(init_frame), _max_locals(max_locals),\n+                                  _max_stack(max_stack), _first(true) {\n@@ -217,1 +235,1 @@\n-    _pre_frame = frame;\n+    _prev_frame = frame;\n@@ -232,1 +250,1 @@\n-      if (_pre_frame->locals_size() > 0) {\n+      if (_prev_frame->locals_size() > 0) {\n@@ -234,1 +252,1 @@\n-          THREAD, VerificationType, _pre_frame->locals_size());\n+          THREAD, VerificationType, _prev_frame->locals_size());\n@@ -237,2 +255,2 @@\n-      offset = _pre_frame->offset() + frame_type + 1;\n-      locals = _pre_frame->locals();\n+      offset = _prev_frame->offset() + frame_type + 1;\n+      locals = _prev_frame->locals();\n@@ -241,1 +259,1 @@\n-      offset, _pre_frame->flags(), _pre_frame->locals_size(), 0,\n+      offset, _prev_frame->flags(), _prev_frame->locals_size(), 0,\n@@ -244,1 +262,1 @@\n-      frame->copy_locals(_pre_frame);\n+      frame->copy_locals(_prev_frame);\n@@ -254,1 +272,1 @@\n-      if (_pre_frame->locals_size() > 0) {\n+      if (_prev_frame->locals_size() > 0) {\n@@ -256,1 +274,1 @@\n-          THREAD, VerificationType, _pre_frame->locals_size());\n+          THREAD, VerificationType, _prev_frame->locals_size());\n@@ -259,2 +277,2 @@\n-      offset = _pre_frame->offset() + frame_type - 63;\n-      locals = _pre_frame->locals();\n+      offset = _prev_frame->offset() + frame_type - 63;\n+      locals = _prev_frame->locals();\n@@ -273,1 +291,1 @@\n-      offset, _pre_frame->flags(), _pre_frame->locals_size(), stack_size,\n+      offset, _prev_frame->flags(), _prev_frame->locals_size(), stack_size,\n@@ -276,1 +294,1 @@\n-      frame->copy_locals(_pre_frame);\n+      frame->copy_locals(_prev_frame);\n@@ -295,1 +313,1 @@\n-      if (_pre_frame->locals_size() > 0) {\n+      if (_prev_frame->locals_size() > 0) {\n@@ -297,1 +315,1 @@\n-          THREAD, VerificationType, _pre_frame->locals_size());\n+          THREAD, VerificationType, _prev_frame->locals_size());\n@@ -300,2 +318,2 @@\n-      offset = _pre_frame->offset() + offset_delta + 1;\n-      locals = _pre_frame->locals();\n+      offset = _prev_frame->offset() + offset_delta + 1;\n+      locals = _prev_frame->locals();\n@@ -314,1 +332,1 @@\n-      offset, _pre_frame->flags(), _pre_frame->locals_size(), stack_size,\n+      offset, _prev_frame->flags(), _prev_frame->locals_size(), stack_size,\n@@ -317,1 +335,1 @@\n-      frame->copy_locals(_pre_frame);\n+      frame->copy_locals(_prev_frame);\n@@ -325,2 +343,2 @@\n-    locals = _pre_frame->locals();\n-    int length = _pre_frame->locals_size();\n+    locals = _prev_frame->locals();\n+    int length = _prev_frame->locals_size();\n@@ -329,1 +347,1 @@\n-    u1 flags = _pre_frame->flags();\n+    u1 flags = _prev_frame->flags();\n@@ -353,1 +371,1 @@\n-      offset = _pre_frame->offset() + offset_delta + 1;\n+      offset = _prev_frame->offset() + offset_delta + 1;\n@@ -359,1 +377,1 @@\n-      frame->copy_locals(_pre_frame);\n+      frame->copy_locals(_prev_frame);\n@@ -366,1 +384,1 @@\n-    int real_length = _pre_frame->locals_size();\n+    int real_length = _prev_frame->locals_size();\n@@ -369,3 +387,2 @@\n-    VerificationType* pre_locals = _pre_frame->locals();\n-    int i;\n-    for (i=0; i<_pre_frame->locals_size(); i++) {\n+    VerificationType* pre_locals = _prev_frame->locals();\n+    for (int i = 0; i < _prev_frame->locals_size(); i++) {\n@@ -374,2 +391,2 @@\n-    u1 flags = _pre_frame->flags();\n-    for (i=0; i<appends; i++) {\n+    u1 flags = _prev_frame->flags();\n+    for (int i = 0; i < appends; i++) {\n@@ -388,1 +405,1 @@\n-      offset = _pre_frame->offset() + offset_delta + 1;\n+      offset = _prev_frame->offset() + offset_delta + 1;\n@@ -405,2 +422,1 @@\n-    int i;\n-    for (i=0; i<locals_size; i++) {\n+    for (int i = 0; i < locals_size; i++) {\n@@ -424,1 +440,1 @@\n-    for (i=0; i<stack_size; i++) {\n+    for (int i = 0; i < stack_size; i++) {\n@@ -437,1 +453,1 @@\n-      offset = _pre_frame->offset() + offset_delta + 1;\n+      offset = _prev_frame->offset() + offset_delta + 1;\n@@ -447,1 +463,1 @@\n-    \"reserved frame type\", CHECK_VERIFY_(_pre_frame->verifier(), nullptr));\n+    \"reserved frame type\", CHECK_VERIFY_(_prev_frame->verifier(), nullptr));\n","filename":"src\/hotspot\/share\/classfile\/stackMapTable.cpp","additions":69,"deletions":53,"binary":false,"changes":122,"status":"modified"},{"patch":"@@ -47,1 +47,1 @@\n-  StackMapFrame**       _frame_array;\n+  GrowableArray<StackMapFrame*>* _frame_array;\n@@ -54,1 +54,1 @@\n-    return _frame_array[index]->offset();\n+    return _frame_array->at(index)->offset();\n@@ -123,3 +123,2 @@\n-  \/\/ Previous and current frame buffers\n-  StackMapFrame* _pre_frame;\n-  StackMapFrame* _frame_buf;\n+  \/\/ Previous frame buffer\n+  StackMapFrame* _prev_frame;\n@@ -134,0 +133,3 @@\n+  StackMapFrame* next_helper(TRAPS);\n+  void check_offset(StackMapFrame* frame, TRAPS);\n+  void check_size(TRAPS);\n@@ -162,2 +164,1 @@\n-  inline StackMapFrame* frame()     const { return _frame_buf; }\n-  inline StackMapFrame* pre_frame() const { return _pre_frame; }\n+  inline StackMapFrame* prev_frame() const { return _prev_frame; }\n@@ -168,2 +169,0 @@\n-  inline void set_pre_frame(StackMapFrame* frame) { _pre_frame = frame; }\n-  StackMapFrame* next_helper(TRAPS);\n@@ -171,22 +170,1 @@\n-\n-  void check_offset(StackMapFrame* frame, TRAPS) {\n-    int offset = frame->offset();\n-    if (offset >= _code_length || _code_data[offset] == 0) {\n-      _verifier->verify_error(\n-          ErrorContext::bad_stackmap(0, frame),\n-          \"StackMapTable error: bad offset\");\n-    }\n-  }\n-\n-  void check_size(TRAPS) {\n-    if (_frame_count < _parsed_frame_count) {\n-      StackMapStream::stackmap_format_error(\"wrong attribute size\", CHECK);\n-    }\n-  }\n-\n-  void check_end(TRAPS) {\n-    assert(_stream->at_end(), \"must be\");\n-    if (_frame_count != _parsed_frame_count) {\n-      StackMapStream::stackmap_format_error(\"wrong attribute size\", CHECK);\n-    }\n-  }\n+  void check_end(TRAPS);\n","filename":"src\/hotspot\/share\/classfile\/stackMapTable.hpp","additions":9,"deletions":31,"binary":false,"changes":40,"status":"modified"}]}