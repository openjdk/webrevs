{"files":[{"patch":"@@ -207,3 +207,8 @@\n-  CHeapBitMap _ptrmap;    \/\/ bitmap used by ArchivePtrMarker\n-  CHeapBitMap _rw_ptrmap;    \/\/ bitmap used by ArchivePtrMarker\n-  CHeapBitMap _ro_ptrmap;    \/\/ bitmap used by ArchivePtrMarker\n+\n+  \/\/ Combined bitmap to track pointers in both RW and RO regions. This is updated\n+  \/\/ as objects are copied into RW and RO.\n+  CHeapBitMap _ptrmap;\n+\n+  \/\/ _ptrmap is split into these two bitmaps which are written into the archive.\n+  CHeapBitMap _rw_ptrmap;   \/\/ marks pointers in the RW region\n+  CHeapBitMap _ro_ptrmap;   \/\/ marks pointers in the RO region\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.hpp","additions":8,"deletions":3,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -102,1 +102,0 @@\n-  \/\/ Free _ptrmap?\n","filename":"src\/hotspot\/share\/cds\/archiveUtils.cpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -37,1 +37,0 @@\n-\n","filename":"src\/hotspot\/share\/cds\/archiveUtils.inline.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -297,1 +297,2 @@\n-  st->print_cr(\"- ptrmap_size_in_bits:            \" SIZE_FORMAT, _ptrmap_size_in_bits);\n+  st->print_cr(\"- rw_ptrmap_size_in_bits:         \" SIZE_FORMAT, region_at(MetaspaceShared::rw)->ptrmap_size_in_bits());\n+  st->print_cr(\"- ro_ptrmap_size_in_bits:         \" SIZE_FORMAT, region_at(MetaspaceShared::ro)->ptrmap_size_in_bits());\n@@ -1612,0 +1613,2 @@\n+\n+  region_at(MetaspaceShared::rw)->init_ptrmap(0, rw_ptrmap->size());\n@@ -1613,1 +1616,2 @@\n-  header()->set_rw_ptrmap_size_in_bits(rw_ptrmap->size());\n+\n+  region_at(MetaspaceShared::ro)->init_ptrmap(written, ro_ptrmap->size());\n@@ -1615,1 +1619,0 @@\n-  header()->set_ro_ptrmap_size_in_bits(ro_ptrmap->size());\n@@ -1910,4 +1913,1 @@\n-    size_t rw_ptrmap_size_in_bits = header()->rw_ptrmap_size_in_bits();\n-    size_t ro_ptrmap_size_in_bits = header()->ro_ptrmap_size_in_bits();\n-\n-    BitMapView rw_ptrmap((BitMap::bm_word_t*)bitmap_base, rw_ptrmap_size_in_bits);\n+    BitMapView rw_ptrmap = region_at(MetaspaceShared::rw)->ptrmap_view();\n@@ -1915,1 +1915,1 @@\n-    BitMapView ro_ptrmap((BitMap::bm_word_t*)ro_bitmap_base, ro_ptrmap_size_in_bits);\n+    BitMapView ro_ptrmap = region_at(MetaspaceShared::ro)->ptrmap_view();\n@@ -1918,1 +1918,1 @@\n-                          p2i(bitmap_base), rw_ptrmap_size_in_bits);\n+                          p2i(bitmap_base), rw_ptrmap.size());\n@@ -1920,1 +1920,1 @@\n-                          p2i(ro_bitmap_base), ro_ptrmap_size_in_bits);\n+                          p2i(ro_bitmap_base), ro_ptrmap.size());\n","filename":"src\/hotspot\/share\/cds\/filemap.cpp","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -161,0 +161,1 @@\n+  size_t ptrmap_size_in_bits()      const { return _ptrmap_size_in_bits; }\n@@ -228,3 +229,0 @@\n-  size_t _ptrmap_size_in_bits;          \/\/ Size of pointer relocation bitmap\n-  size_t _rw_ptrmap_size_in_bits;       \/\/ Size of pointer relocation map for read-write region\n-  size_t _ro_ptrmap_size_in_bits;       \/\/ Size of pointer relocation map for read-only region\n@@ -272,3 +270,0 @@\n-  size_t ptrmap_size_in_bits()             const { return _ptrmap_size_in_bits; }\n-  size_t rw_ptrmap_size_in_bits()          const { return _rw_ptrmap_size_in_bits; }\n-  size_t ro_ptrmap_size_in_bits()          const { return _ro_ptrmap_size_in_bits; }\n@@ -289,3 +284,0 @@\n-  void set_ptrmap_size_in_bits(size_t s)         { _ptrmap_size_in_bits = s; }\n-  void set_rw_ptrmap_size_in_bits(size_t s)      { _rw_ptrmap_size_in_bits = s; }\n-  void set_ro_ptrmap_size_in_bits(size_t s)      { _ro_ptrmap_size_in_bits = s; }\n","filename":"src\/hotspot\/share\/cds\/filemap.hpp","additions":1,"deletions":9,"binary":false,"changes":10,"status":"modified"}]}