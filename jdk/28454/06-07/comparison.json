{"files":[{"patch":"@@ -1158,0 +1158,22 @@\n+    \/\/ This follows the implementation of encode8859_1\n+    private static int encodedLength8859_1(byte coder, byte[] val) {\n+        if (coder == LATIN1) {\n+            return val.length;\n+        }\n+        int len = val.length >> 1;\n+        int dp = 0;\n+        int sp = 0;\n+        int sl = len;\n+        while (sp < sl) {\n+            char c = StringUTF16.getChar(val, sp++);\n+            if (c > 0x80) {\n+                if (Character.isHighSurrogate(c) && sp < sl &&\n+                        Character.isLowSurrogate(StringUTF16.getChar(val, sp))) {\n+                    sp++;\n+                }\n+            }\n+            dp++;\n+        }\n+        return dp;\n+    }\n+\n@@ -1495,5 +1517,1 @@\n-            long length = encodedLengthUTF8_UTF16(val, null);\n-            if (length > (long)Integer.MAX_VALUE) {\n-                throw new IllegalStateException(\"Required length exceeds implementation limit\");\n-            }\n-            return (int) length;\n+            return encodedLengthUTF8_UTF16(val, null);\n@@ -1534,5 +1552,2 @@\n-        long allocLen = (sl * 3 < 0) ? encodedLengthUTF8_UTF16(val, exClass) : sl * 3;\n-        if (allocLen > (long)Integer.MAX_VALUE) {\n-            throw new OutOfMemoryError(\"Required length exceeds implementation limit\");\n-        }\n-        byte[] dst = new byte[(int) allocLen];\n+        int allocLen = (sl * 3 < 0) ? encodedLengthUTF8_UTF16(val, exClass) : sl * 3;\n+        byte[] dst = new byte[allocLen];\n@@ -1597,1 +1612,1 @@\n-    private static <E extends Exception> long encodedLengthUTF8_UTF16(byte[] val, Class<E> exClass) throws E {\n+    private static <E extends Exception> int encodedLengthUTF8_UTF16(byte[] val, Class<E> exClass) throws E {\n@@ -1639,1 +1654,4 @@\n-        return dp;\n+        if (dp > (long)Integer.MAX_VALUE) {\n+            throw new OutOfMemoryError(\"Required length exceeds implementation limit\");\n+        }\n+        return (int) dp;\n@@ -2107,1 +2125,1 @@\n-     * <p>The result will be the same value as {@linkplain #getBytes(Charset) {@code getBytes(cs).length}}.\n+     * <p>The result will be the same value as {@link #getBytes(Charset) getBytes(cs).length}.\n@@ -2112,1 +2130,0 @@\n-     * @throws NullPointerException If {@code cs} is {@code null}\n@@ -2120,3 +2137,1 @@\n-            if (isLatin1()) {\n-                return value.length;\n-            }\n+            return encodedLength8859_1(coder, value);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/String.java","additions":32,"deletions":17,"binary":false,"changes":49,"status":"modified"}]}