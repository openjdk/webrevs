{"files":[{"patch":"@@ -1495,1 +1495,5 @@\n-            return encodedLengthUTF8_UTF16(val);\n+            long length = encodedLengthUTF8_UTF16(val, null);\n+            if (length > (long)Integer.MAX_VALUE) {\n+                throw new IllegalStateException(\"Required length exceeds implementation limit\");\n+            }\n+            return (int) length;\n@@ -1530,1 +1534,1 @@\n-        long allocLen = (sl * 3 < 0) ? computeSizeUTF8_UTF16(val, exClass) : sl * 3;\n+        long allocLen = (sl * 3 < 0) ? encodedLengthUTF8_UTF16(val, exClass) : sl * 3;\n@@ -1584,41 +1588,0 @@\n-    \/\/ This follows the implementation of encodeUTF8_UTF16\n-    private static int encodedLengthUTF8_UTF16(byte[] val) {\n-        int dp = 0;\n-        int sp = 0;\n-        int sl = val.length >> 1;\n-        while (sp < sl) {\n-            \/\/ ascii fast loop;\n-            char c = StringUTF16.getChar(val, sp);\n-            if (c >= '\\u0080') {\n-                break;\n-            }\n-            dp++;\n-            sp++;\n-        }\n-        while (sp < sl) {\n-            char c = StringUTF16.getChar(val, sp++);\n-            if (c < 0x80) {\n-                dp++;\n-            } else if (c < 0x800) {\n-                dp += 2;\n-            } else if (Character.isSurrogate(c)) {\n-                int uc = -1;\n-                char c2;\n-                if (Character.isHighSurrogate(c) && sp < sl &&\n-                        Character.isLowSurrogate(c2 = StringUTF16.getChar(val, sp))) {\n-                    uc = Character.toCodePoint(c, c2);\n-                }\n-                if (uc < 0) {\n-                    dp++;\n-                } else {\n-                    dp += 4;\n-                    sp++;  \/\/ 2 chars\n-                }\n-            } else {\n-                \/\/ 3 bytes, 16 bits\n-                dp += 3;\n-            }\n-        }\n-        return dp;\n-    }\n-\n@@ -1634,1 +1597,1 @@\n-    private static <E extends Exception> long computeSizeUTF8_UTF16(byte[] val, Class<E> exClass) throws E {\n+    private static <E extends Exception> long encodedLengthUTF8_UTF16(byte[] val, Class<E> exClass) throws E {\n@@ -1639,0 +1602,9 @@\n+        while (sp < sl) {\n+            \/\/ ascii fast loop;\n+            char c = StringUTF16.getChar(val, sp);\n+            if (c >= '\\u0080') {\n+                break;\n+            }\n+            dp++;\n+            sp++;\n+        }\n@@ -2139,1 +2111,2 @@\n-     * @param cs the {@link Charset} used to the compute the length\n+     * @param cs The {@link Charset} used to the compute the length\n+     * @throws NullPointerException If {@code cs} is {@code null}\n@@ -2143,0 +2116,1 @@\n+        Objects.requireNonNull(cs);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/String.java","additions":19,"deletions":45,"binary":false,"changes":64,"status":"modified"}]}