{"files":[{"patch":"@@ -3087,0 +3087,3 @@\n+        <error id=\"JVMTI_ERROR_DUPLICATE\">\n+          There is already a frame pop event request at the specified depth.\n+        <\/error>\n","filename":"src\/hotspot\/share\/prims\/jvmti.xml","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1362,1 +1362,5 @@\n-  state->env_thread_state((JvmtiEnvBase*)this)->set_frame_pop(frame_number);\n+  JvmtiEnvThreadState* ets = state->env_thread_state(this);\n+  if (ets->is_frame_pop(frame_number)) {\n+    return JVMTI_ERROR_DUPLICATE;\n+  }\n+  ets->set_frame_pop(frame_number);\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -455,0 +455,2 @@\n+  print_frame_event_info(jvmti, jni, thread, method, \"VirtualThreadMount\", ++vthread_mounted_count);\n+\n@@ -456,1 +458,1 @@\n-         brkptBreakpointHit, ++vthread_mounted_count, cname, mname, (void*)thread);\n+         brkptBreakpointHit, vthread_mounted_count, cname, mname, (void*)thread);\n@@ -461,1 +463,11 @@\n-  print_frame_event_info(jvmti, jni, thread, method, \"VirtualThreadMount\", vthread_mounted_count);\n+  LOG(\"\\nHit #%d: VirtualThreadMount #%d: enabling duplicated FramePop for method: %s::%s on virtual thread: %p\\n\",\n+         brkptBreakpointHit, vthread_mounted_count, cname, mname, (void*)thread);\n+\n+  err = jvmti->NotifyFramePop(thread, 0);\n+  if (err == JVMTI_ERROR_DUPLICATE) {\n+    LOG(\"NotifyFramePop at VirtualThreadUnmount event returned expected JVMTI_ERROR_DUPLICATE\\n\");\n+  } else {\n+    LOG(\"Failed: NotifyFramePop at VirtualThreadUnmount returned %s(%d) instead of expected JVMTI_ERROR_DUPLICATE\\n\",\n+           TranslateError(err), err);\n+    jni->FatalError(\"NotifyFramePop error: expected error code JVMTI_ERROR_DUPLICATE\");\n+  }\n@@ -500,7 +512,1 @@\n-  LOG(\"\\nHit #%d: VirtualThreadUnmount #%d: enabling FramePop for method: %s::%s on virtual thread: %p\\n\",\n-         brkptBreakpointHit, ++vthread_unmounted_count, cname, mname, (void*)thread);\n-\n-  err = jvmti->NotifyFramePop(thread, 0);\n-  check_jvmti_status(jni, err, \"VirtualThreadUnmount: error in JVMTI NotifyFramePop\");\n-\n-  print_frame_event_info(jvmti, jni, thread, method, \"VirtualThreadUnmount\", vthread_unmounted_count);\n+  print_frame_event_info(jvmti, jni, thread, method, \"VirtualThreadUnmount\", ++vthread_unmounted_count);\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/vthread\/MethodExitTest\/libMethodExitTest.cpp","additions":16,"deletions":10,"binary":false,"changes":26,"status":"modified"}]}