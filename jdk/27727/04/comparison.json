{"files":[{"patch":"@@ -293,1 +293,2 @@\n-        sb.append(request.method())\n+        String method = request.method();\n+        sb.append(method)\n@@ -303,1 +304,0 @@\n-        \/\/ GET, HEAD and DELETE with no request body should not set the Content-Length header\n@@ -307,1 +307,6 @@\n-                systemHeadersBuilder.setHeader(\"Content-Length\", \"0\");\n+                \/\/ PUT and POST with no request body should set the Content-Length header\n+                \/\/ even when the content is empty.\n+                \/\/ Other methods defined in RFC 9110 should not send the header in that case.\n+                if (\"POST\".equals(method) || \"PUT\".equals(method)) {\n+                    systemHeadersBuilder.setHeader(\"Content-Length\", \"0\");\n+                }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http1Request.java","additions":8,"deletions":3,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -32,1 +32,1 @@\n- * @bug 8283544\n+ * @bug 8283544 8358942\n@@ -34,0 +34,1 @@\n+ *          -Djdk.httpclient.allowRestrictedHeaders=content-length\n@@ -98,2 +99,2 @@\n-        testContentLengthServerH2.addHandler(new OptionalContentLengthHandler(), BODY_PATH);\n-        testContentLengthServerH3.addHandler(new OptionalContentLengthHandler(), BODY_PATH);\n+        testContentLengthServerH2.addHandler(new ContentLengthHandler(), BODY_PATH);\n+        testContentLengthServerH3.addHandler(new ContentLengthHandler(), BODY_PATH);\n@@ -166,0 +167,7 @@\n+    @DataProvider(name = \"h1body\")\n+    Object[][] h1body() {\n+        return new Object[][]{\n+                {HTTP_1_1, URI.create(testContentLengthURIH1 + BODY_PATH)}\n+        };\n+    }\n+\n@@ -189,0 +197,29 @@\n+    @Test(dataProvider = \"nobodies\")\n+    \/\/ A GET request with empty request body should have no Content-length header\n+    public void getWithEmptyBody(Version version, URI uri) throws IOException, InterruptedException {\n+        testLog.println(version + \" Checking GET with no request body\");\n+        HttpRequest req = HttpRequest.newBuilder()\n+                .version(version)\n+                .method(\"GET\", HttpRequest.BodyPublishers.noBody())\n+                .uri(uri)\n+                .build();\n+        HttpResponse<String> resp = hc.send(req, HttpResponse.BodyHandlers.ofString(UTF_8));\n+        assertEquals(resp.statusCode(), 200, resp.body());\n+        assertEquals(resp.version(), version);\n+    }\n+\n+    @Test(dataProvider = \"bodies\")\n+    \/\/ A GET request with empty request body and explicitly added Content-length header\n+    public void getWithZeroContentLength(Version version, URI uri) throws IOException, InterruptedException {\n+        testLog.println(version + \" Checking GET with no request body\");\n+        HttpRequest req = HttpRequest.newBuilder()\n+                .version(version)\n+                .method(\"GET\", HttpRequest.BodyPublishers.noBody())\n+                .header(\"Content-length\", \"0\")\n+                .uri(uri)\n+                .build();\n+        HttpResponse<String> resp = hc.send(req, HttpResponse.BodyHandlers.ofString(UTF_8));\n+        assertEquals(resp.statusCode(), 200, resp.body());\n+        assertEquals(resp.version(), version);\n+    }\n+\n@@ -218,0 +255,14 @@\n+    @Test(dataProvider = \"nobodies\")\n+    \/\/ A DELETE request with empty request body should have no Content-length header\n+    public void deleteWithEmptyBody(Version version, URI uri) throws IOException, InterruptedException {\n+        testLog.println(version + \" Checking DELETE with no request body\");\n+        HttpRequest req = HttpRequest.newBuilder()\n+                .version(version)\n+                .method(\"DELETE\", HttpRequest.BodyPublishers.noBody())\n+                .uri(uri)\n+                .build();\n+        HttpResponse<String> resp = hc.send(req, HttpResponse.BodyHandlers.ofString(UTF_8));\n+        assertEquals(resp.statusCode(), 200, resp.body());\n+        assertEquals(resp.version(), version);\n+    }\n+\n@@ -247,0 +298,14 @@\n+    @Test(dataProvider = \"nobodies\")\n+    \/\/ A HEAD request with empty request body should have no Content-length header\n+    public void headWithEmptyBody(Version version, URI uri) throws IOException, InterruptedException {\n+        testLog.println(version + \" Checking HEAD with no request body\");\n+        HttpRequest req = HttpRequest.newBuilder()\n+                .version(version)\n+                .method(\"HEAD\", HttpRequest.BodyPublishers.noBody())\n+                .uri(uri)\n+                .build();\n+        HttpResponse<String> resp = hc.send(req, HttpResponse.BodyHandlers.ofString(UTF_8));\n+        assertEquals(resp.statusCode(), 200, resp.body());\n+        assertEquals(resp.version(), version);\n+    }\n+\n@@ -264,0 +329,60 @@\n+    @Test(dataProvider = \"h1body\")\n+    \/\/ A POST request with empty request body should have a Content-length header\n+    \/\/ in HTTP\/1.1\n+    public void postWithEmptyBody(Version version, URI uri) throws IOException, InterruptedException {\n+        testLog.println(version + \" Checking POST with request body\");\n+        HttpRequest req = HttpRequest.newBuilder()\n+                .version(version)\n+                .method(\"POST\", HttpRequest.BodyPublishers.noBody())\n+                .uri(uri)\n+                .build();\n+        HttpResponse<String> resp = hc.send(req, HttpResponse.BodyHandlers.ofString(UTF_8));\n+        assertEquals(resp.statusCode(), 200, resp.body());\n+        assertEquals(resp.version(), version);\n+    }\n+\n+    @Test(dataProvider = \"bodies\")\n+    \/\/ A POST request with a request body should have a Content-length header\n+    \/\/ in HTTP\/1.1\n+    public void postWithBody(Version version, URI uri) throws IOException, InterruptedException {\n+        testLog.println(version + \" Checking POST with request body\");\n+        HttpRequest req = HttpRequest.newBuilder()\n+                .version(version)\n+                .POST(HttpRequest.BodyPublishers.ofString(\"POST Body\"))\n+                .uri(uri)\n+                .build();\n+        HttpResponse<String> resp = hc.send(req, HttpResponse.BodyHandlers.ofString(UTF_8));\n+        assertEquals(resp.statusCode(), 200, resp.body());\n+        assertEquals(resp.version(), version);\n+    }\n+\n+    @Test(dataProvider = \"h1body\")\n+    \/\/ A PUT request with empty request body should have a Content-length header\n+    \/\/ in HTTP\/1.1\n+    public void putWithEmptyBody(Version version, URI uri) throws IOException, InterruptedException {\n+        testLog.println(version + \" Checking PUT with request body\");\n+        HttpRequest req = HttpRequest.newBuilder()\n+                .version(version)\n+                .method(\"PUT\", HttpRequest.BodyPublishers.noBody())\n+                .uri(uri)\n+                .build();\n+        HttpResponse<String> resp = hc.send(req, HttpResponse.BodyHandlers.ofString(UTF_8));\n+        assertEquals(resp.statusCode(), 200, resp.body());\n+        assertEquals(resp.version(), version);\n+    }\n+\n+    @Test(dataProvider = \"bodies\")\n+    \/\/ A PUT request with a request body should have a Content-length header\n+    \/\/ in HTTP\/1.1\n+    public void putWithBody(Version version, URI uri) throws IOException, InterruptedException {\n+        testLog.println(version + \" Checking PUT with request body\");\n+        HttpRequest req = HttpRequest.newBuilder()\n+                .version(version)\n+                .PUT(HttpRequest.BodyPublishers.ofString(\"PUT Body\"))\n+                .uri(uri)\n+                .build();\n+        HttpResponse<String> resp = hc.send(req, HttpResponse.BodyHandlers.ofString(UTF_8));\n+        assertEquals(resp.statusCode(), 200, resp.body());\n+        assertEquals(resp.version(), version);\n+    }\n+\n@@ -327,23 +452,0 @@\n-\n-    \/**\n-     * A handler used for cases where the presence of a Content-Length\n-     * header is optional. If present, its value must match the number of\n-     * bytes sent in the request body.\n-     *\/\n-    static class OptionalContentLengthHandler implements HttpTestHandler {\n-\n-        @Override\n-        public void handle(HttpTestExchange exchange) throws IOException {\n-            testLog.println(\"OptionalContentLengthHandler: Received Headers \"\n-                    + exchange.getRequestHeaders().entrySet() +\n-                    \" from \" + exchange.getRequestMethod() + \" request.\");\n-            Optional<String> contentLength = exchange.getRequestHeaders().firstValue(\"Content-Length\");\n-\n-            \/\/ Check Content-length header was set\n-            if (contentLength.isPresent()) {\n-                handleResponse(Long.parseLong(contentLength.get()), exchange, \"Request completed\", 200);\n-            } else {\n-                handleResponse(-1, exchange, \"Request completed, no content length\", 200);\n-            }\n-        }\n-    }\n","filename":"test\/jdk\/java\/net\/httpclient\/ContentLengthHeaderTest.java","additions":128,"deletions":26,"binary":false,"changes":154,"status":"modified"}]}