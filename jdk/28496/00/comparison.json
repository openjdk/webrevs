{"files":[{"patch":"@@ -211,2 +211,2 @@\n-  ShenandoahHeapRegion* r = heap_region_containing(p);\n-  assert(!r->is_humongous(), \"never evacuate humongous objects\");\n+  ShenandoahHeapRegion* from_region = heap_region_containing(p);\n+  assert(!from_region->is_humongous(), \"never evacuate humongous objects\");\n@@ -214,4 +214,4 @@\n-  ShenandoahAffiliation target_gen = r->affiliation();\n-  \/\/ gc_generation() can change asynchronously and should not be used here.\n-  assert(active_generation() != nullptr, \"Error\");\n-  if (active_generation()->is_young() && target_gen == YOUNG_GENERATION) {\n+  \/\/ Try to keep the object in the same generation\n+  const ShenandoahAffiliation target_gen = from_region->affiliation();\n+\n+  if (target_gen == YOUNG_GENERATION) {\n@@ -227,2 +227,5 @@\n-    } else if (age_census()->is_tenurable(r->age() + mark.age())) {\n-      oop result = try_evacuate_object(p, thread, r, OLD_GENERATION);\n+    } else if (age_census()->is_tenurable(from_region->age() + mark.age())) {\n+      \/\/ If the object is tenurable, try to promote it\n+      oop result = try_evacuate_object<YOUNG_GENERATION, OLD_GENERATION>(p, thread, from_region->age());\n+\n+      \/\/ If we failed to promote this aged object, we'll fall through to code below and evacuate to young-gen.\n@@ -232,1 +235,0 @@\n-      \/\/ If we failed to promote this aged object, we'll fall through to code below and evacuate to young-gen.\n@@ -234,0 +236,1 @@\n+    return try_evacuate_object<YOUNG_GENERATION, YOUNG_GENERATION>(p, thread, from_region->age());\n@@ -235,1 +238,3 @@\n-  return try_evacuate_object(p, thread, r, target_gen);\n+\n+  assert(target_gen == OLD_GENERATION, \"Expected evacuation to old\");\n+  return try_evacuate_object<OLD_GENERATION, OLD_GENERATION>(p, thread, from_region->age());\n@@ -240,2 +245,2 @@\n-oop ShenandoahGenerationalHeap::try_evacuate_object(oop p, Thread* thread, ShenandoahHeapRegion* from_region,\n-                                        ShenandoahAffiliation target_gen) {\n+template<ShenandoahAffiliation FROM_GENERATION, ShenandoahAffiliation TO_GENERATION>\n+oop ShenandoahGenerationalHeap::try_evacuate_object(oop p, Thread* thread, uint from_region_age) {\n@@ -246,1 +251,1 @@\n-  bool is_promotion = (target_gen == OLD_GENERATION) && from_region->is_young();\n+  constexpr bool is_promotion = (TO_GENERATION == OLD_GENERATION) && (FROM_GENERATION == YOUNG_GENERATION);\n@@ -255,1 +260,1 @@\n-      switch (target_gen) {\n+      switch (TO_GENERATION) {\n@@ -303,1 +308,1 @@\n-        ShenandoahAllocRequest req = ShenandoahAllocRequest::for_shared_gc(size, target_gen, is_promotion);\n+        ShenandoahAllocRequest req = ShenandoahAllocRequest::for_shared_gc(size, TO_GENERATION, is_promotion);\n@@ -317,2 +322,2 @@\n-    if (target_gen == OLD_GENERATION) {\n-      if (from_region->is_young()) {\n+    if (TO_GENERATION == OLD_GENERATION) {\n+      if (FROM_GENERATION == YOUNG_GENERATION) {\n@@ -330,1 +335,0 @@\n-\n@@ -332,1 +336,0 @@\n-\n@@ -337,1 +340,1 @@\n-    evac_tracker()->begin_evacuation(thread, size * HeapWordSize, from_region->affiliation(), target_gen);\n+    evac_tracker()->begin_evacuation(thread, size * HeapWordSize, FROM_GENERATION, TO_GENERATION);\n@@ -345,2 +348,2 @@\n-  if (target_gen == YOUNG_GENERATION && is_aging_cycle()) {\n-    ShenandoahHeap::increase_object_age(copy_val, from_region->age() + 1);\n+  if (TO_GENERATION == YOUNG_GENERATION && is_aging_cycle()) {\n+    increase_object_age(copy_val, from_region_age + 1);\n@@ -363,1 +366,1 @@\n-      evac_tracker()->end_evacuation(thread, size * HeapWordSize, from_region->affiliation(), target_gen);\n+      evac_tracker()->end_evacuation(thread, size * HeapWordSize, FROM_GENERATION, TO_GENERATION);\n@@ -366,6 +369,2 @@\n-    if (target_gen == OLD_GENERATION) {\n-      old_generation()->handle_evacuation(copy, size, from_region->is_young());\n-    } else {\n-      \/\/ When copying to the old generation above, we don't care\n-      \/\/ about recording object age in the census stats.\n-      assert(target_gen == YOUNG_GENERATION, \"Error\");\n+    if (TO_GENERATION == OLD_GENERATION) {\n+      old_generation()->handle_evacuation(copy, size);\n@@ -373,2 +372,0 @@\n-    shenandoah_assert_correct(nullptr, copy_val);\n-    return copy_val;\n@@ -385,1 +382,1 @@\n-      switch (target_gen) {\n+      switch (TO_GENERATION) {\n@@ -408,2 +405,0 @@\n-      shenandoah_assert_correct(nullptr, copy_val);\n-      \/\/ For non-LAB allocations, the object has already been registered\n@@ -411,2 +406,0 @@\n-    shenandoah_assert_correct(nullptr, result);\n-    return result;\n@@ -414,0 +407,2 @@\n+  shenandoah_assert_correct(nullptr, result);\n+  return result;\n@@ -416,0 +411,4 @@\n+template oop ShenandoahGenerationalHeap::try_evacuate_object<YOUNG_GENERATION, YOUNG_GENERATION>(oop p, Thread* thread, uint from_region_age);\n+template oop ShenandoahGenerationalHeap::try_evacuate_object<YOUNG_GENERATION, OLD_GENERATION>(oop p, Thread* thread, uint from_region_age);\n+template oop ShenandoahGenerationalHeap::try_evacuate_object<OLD_GENERATION, OLD_GENERATION>(oop p, Thread* thread, uint from_region_age);\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalHeap.cpp","additions":35,"deletions":36,"binary":false,"changes":71,"status":"modified"},{"patch":"@@ -90,1 +90,3 @@\n-  oop try_evacuate_object(oop p, Thread* thread, ShenandoahHeapRegion* from_region, ShenandoahAffiliation target_gen);\n+\n+  template<ShenandoahAffiliation FROM_REGION, ShenandoahAffiliation TO_REGION>\n+  oop try_evacuate_object(oop p, Thread* thread, uint from_region_age);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalHeap.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalHeap.inline.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -622,1 +622,1 @@\n-void ShenandoahOldGeneration::handle_evacuation(HeapWord* obj, size_t words, bool promotion) {\n+void ShenandoahOldGeneration::handle_evacuation(HeapWord* obj, size_t words) const {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahOldGeneration.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -182,1 +182,1 @@\n-  void handle_evacuation(HeapWord* obj, size_t words, bool promotion);\n+  void handle_evacuation(HeapWord* obj, size_t words) const;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahOldGeneration.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}