{"files":[{"patch":"@@ -97,1 +97,3 @@\n-                    setEcho(false);\n+                    synchronized(restoreEchoLock) {\n+                        restoreEcho = echo(false);\n+                    }\n@@ -110,2 +112,4 @@\n-                        if (restoreEcho) {\n-                            setEcho(true);\n+                        synchronized(restoreEchoLock) {\n+                            if (restoreEcho) {\n+                                restoreEcho = echo(true);\n+                            }\n@@ -149,2 +153,4 @@\n-                                        if (restoreEcho) {\n-                                            setEcho(true);\n+                                        synchronized(restoreEchoLock) {\n+                                            if (restoreEcho) {\n+                                                echo(true);\n+                                            }\n@@ -180,0 +186,1 @@\n+    private final Object restoreEchoLock;\n@@ -185,1 +192,1 @@\n-    private final boolean restoreEcho;\n+    private boolean restoreEcho;\n@@ -220,7 +227,3 @@\n-    \/**\n-     * {@return true if the console echo status is on}\n-     *\/\n-    private static native boolean getEcho() throws IOException;\n-\n-    \/**\n-     * Sets the console echo status to {@code on}\n+    \/*\n+     * Sets the console echo status to {@code on} and returns the previous\n+     * console on\/off status.\n@@ -229,0 +232,1 @@\n+     * @return true if the previous console echo status is on\n@@ -230,1 +234,1 @@\n-    private static native void setEcho(boolean on) throws IOException;\n+    private static native boolean echo(boolean on) throws IOException;\n@@ -353,0 +357,1 @@\n+        restoreEchoLock = new Object();\n@@ -367,5 +372,0 @@\n-        var echo = false;\n-        try {\n-            echo = getEcho();\n-        } catch (IOException _) {}\n-        restoreEcho = echo;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/io\/JdkConsoleImpl.java","additions":19,"deletions":19,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -36,14 +36,1 @@\n-Java_jdk_internal_io_JdkConsoleImpl_getEcho(JNIEnv *env,\n-                          jclass cls)\n-{\n-    struct termios tio;\n-    int tty = fileno(stdin);\n-    if (tcgetattr(tty, &tio) == -1) {\n-        JNU_ThrowIOExceptionWithLastError(env, \"tcgetattr failed\");\n-        return JNI_FALSE;\n-    }\n-    return (tio.c_lflag & ECHO) != 0;\n-}\n-\n-JNIEXPORT void JNICALL\n-Java_jdk_internal_io_JdkConsoleImpl_setEcho(JNIEnv *env,\n+Java_jdk_internal_io_JdkConsoleImpl_echo(JNIEnv *env,\n@@ -54,0 +41,1 @@\n+    jboolean old;\n@@ -57,1 +45,1 @@\n-        return;\n+        return !on;\n@@ -59,0 +47,1 @@\n+    old = (tio.c_lflag & ECHO) != 0;\n@@ -67,0 +56,1 @@\n+    return old;\n","filename":"src\/java.base\/unix\/native\/libjava\/JdkConsoleImpl_md.c","additions":6,"deletions":16,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -35,1 +35,1 @@\n-Java_jdk_internal_io_JdkConsoleImpl_getEcho(JNIEnv *env, jclass cls)\n+Java_jdk_internal_io_JdkConsoleImpl_echo(JNIEnv *env, jclass cls, jboolean on)\n@@ -38,0 +38,1 @@\n+    jboolean old;\n@@ -42,14 +43,1 @@\n-        return JNI_FALSE;\n-    }\n-    return (fdwMode & ENABLE_ECHO_INPUT) != 0;\n-}\n-\n-JNIEXPORT void JNICALL\n-Java_jdk_internal_io_JdkConsoleImpl_setEcho(JNIEnv *env, jclass cls, jboolean on)\n-{\n-    DWORD fdwMode;\n-    HANDLE hStdIn = GetStdHandle(STD_INPUT_HANDLE);\n-\n-    if (! GetConsoleMode(hStdIn, &fdwMode)) {\n-        JNU_ThrowIOExceptionWithLastError(env, \"GetConsoleMode failed\");\n-        return;\n+        return !on;\n@@ -57,0 +45,1 @@\n+    old = (fdwMode & ENABLE_ECHO_INPUT) != 0;\n@@ -65,0 +54,1 @@\n+    return old;\n","filename":"src\/java.base\/windows\/native\/libjava\/JdkConsoleImpl_md.c","additions":6,"deletions":16,"binary":false,"changes":22,"status":"modified"}]}