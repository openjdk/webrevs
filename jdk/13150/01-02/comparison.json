{"files":[{"patch":"@@ -178,7 +178,19 @@\n-        byte[] buffer = buf;\n-        if (buffer == null)\n-            throw new IOException(\"Stream closed\");\n-        if (buffer == EMPTY) {\n-            buf = buffer = new byte[size];\n-        }\n-        return buffer;\n+        byte[] allocated = null;\n+        do {\n+            byte[] buffer = buf;\n+            if (buffer == null) {\n+                throw new IOException(\"Stream closed\");\n+            }\n+            if (buffer == EMPTY) {\n+                if (allocated == null) {\n+                    allocated = new byte[size];\n+                }\n+                \/\/ defend against asynchronous close\n+                if (U.compareAndSetReference(this, BUF_OFFSET, EMPTY, allocated)) {\n+                    return allocated;\n+                } else{\n+                    continue;\n+                }\n+            }\n+            return buffer;\n+        } while (true);\n","filename":"src\/java.base\/share\/classes\/java\/io\/BufferedInputStream.java","additions":19,"deletions":7,"binary":false,"changes":26,"status":"modified"}]}