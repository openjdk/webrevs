{"files":[{"patch":"@@ -70,0 +70,2 @@\n+    private static final byte[] EMPTY = new byte[0];\n+\n@@ -157,0 +159,2 @@\n+    private final int size;\n+\n@@ -169,2 +173,3 @@\n-     * Check to make sure that buffer has not been nulled out due to\n-     * close; if not return it;\n+     * Return the buffer if already allocated, or allocate one, or throw {@link IOException} if this stream is closed.\n+     * If a caller simply wants to ensure whether this BufferedInputStream is open\n+     * they should call {@link #getInIfOpen()} instead.\n@@ -173,4 +178,19 @@\n-        byte[] buffer = buf;\n-        if (buffer == null)\n-            throw new IOException(\"Stream closed\");\n-        return buffer;\n+        byte[] allocated = null;\n+        do {\n+            byte[] buffer = buf;\n+            if (buffer == null) {\n+                throw new IOException(\"Stream closed\");\n+            }\n+            if (buffer == EMPTY) {\n+                if (allocated == null) {\n+                    allocated = new byte[size];\n+                }\n+                \/\/ defend against asynchronous close\n+                if (U.compareAndSetReference(this, BUF_OFFSET, EMPTY, allocated)) {\n+                    return allocated;\n+                } else{\n+                    continue;\n+                }\n+            }\n+            return buffer;\n+        } while (true);\n@@ -208,3 +228,3 @@\n-        buf = new byte[size];\n-\n-        \/\/ use monitors when BufferedInputStream is sub-classed\n+        this.size = size;\n+        \/\/ keep using monitors and initializing buf when BufferedInputStream is sub-classed\n+        \/\/ for compatibility\n@@ -213,0 +233,1 @@\n+            buf = EMPTY;\n@@ -215,0 +236,1 @@\n+            buf = new byte[size];\n@@ -310,1 +332,1 @@\n-            if (len >= getBufIfOpen().length && markpos == -1) {\n+            if (len >= size && markpos == -1) {\n@@ -377,1 +399,1 @@\n-        getBufIfOpen(); \/\/ Check for closed stream\n+        getInIfOpen(); \/\/ Check for closed stream\n@@ -424,1 +446,1 @@\n-        getBufIfOpen(); \/\/ Check for closed stream\n+        InputStream input = getInIfOpen();\/\/ Check for closed stream\n@@ -433,1 +455,1 @@\n-                return getInIfOpen().skip(n);\n+                return input.skip(n);\n@@ -547,1 +569,1 @@\n-        getBufIfOpen(); \/\/ Cause exception if closed\n+        getInIfOpen(); \/\/ Cause exception if closed\n","filename":"src\/java.base\/share\/classes\/java\/io\/BufferedInputStream.java","additions":36,"deletions":14,"binary":false,"changes":50,"status":"modified"}]}