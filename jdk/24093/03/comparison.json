{"files":[{"patch":"@@ -716,0 +716,22 @@\n+\n+void AllocateNode::dump_spec(outputStream* st) const {\n+  st->print(\" \");\n+  if (tf() != nullptr) {\n+    tf()->dump_on(st);\n+  }\n+  if (_cnt != COUNT_UNKNOWN) {\n+    st->print(\" C=%f\", _cnt);\n+  }\n+  const Node* const klass_node = in(KlassNode);\n+  if (klass_node != nullptr) {\n+    const TypeKlassPtr* const klass_ptr = klass_node->bottom_type()->isa_klassptr();\n+\n+    if (klass_ptr != nullptr && klass_ptr->klass_is_exact()) {\n+      st->print(\" allocationKlass:\");\n+      klass_ptr->exact_klass()->print_name_on(st);\n+    }\n+  }\n+  if (jvms() != nullptr) {\n+    jvms()->dump_spec(st);\n+  }\n+}\n","filename":"src\/hotspot\/share\/opto\/callnode.cpp","additions":22,"deletions":0,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -1065,0 +1065,4 @@\n+\n+#ifndef PRODUCT\n+  virtual void dump_spec(outputStream* st) const;\n+#endif\n","filename":"src\/hotspot\/share\/opto\/callnode.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -345,2 +345,2 @@\n-        String optoRegex = \"(.*precise .*\\\\R((.*(?i:mov|mv|xorl|nop|spill).*|\\\\s*)\\\\R)*.*(?i:call,static).*wrapper for: C2 Runtime new_instance\" + END;\n-        allocNodes(ALLOC, \"Allocate\", optoRegex);\n+        String regex = START + \"Allocate\\\\b\" + MID + END;\n+        macroNodes(ALLOC, regex);\n@@ -351,2 +351,2 @@\n-        String regex = \"(.*precise .*\" + IS_REPLACED + \":.*\\\\R((.*(?i:mov|mv|xorl|nop|spill).*|\\\\s*)\\\\R)*.*(?i:call,static).*wrapper for: C2 Runtime new_instance\" + END;\n-        optoOnly(ALLOC_OF, regex);\n+        String regex = START + \"Allocate\\\\b\" + MID + \"allocationKlass:.*\\\\b\" + IS_REPLACED + \"\\\\s.*\" + END;\n+        macroNodes(ALLOC_OF, regex);\n@@ -357,2 +357,2 @@\n-        String optoRegex = \"(.*precise \\\\[.*\\\\R((.*(?i:mov|mv|xor|nop|spill).*|\\\\s*|.*(LGHI|LI).*)\\\\R)*.*(?i:call,static).*wrapper for: C2 Runtime new_array\" + END;\n-        allocNodes(ALLOC_ARRAY, \"AllocateArray\", optoRegex);\n+        String regex = START + \"AllocateArray\\\\b\" + MID + END;\n+        macroNodes(ALLOC_ARRAY,  regex);\n@@ -363,2 +363,21 @@\n-        String regex = \"(.*precise \\\\[.*\" + IS_REPLACED + \":.*\\\\R((.*(?i:mov|mv|xorl|nop|spill).*|\\\\s*|.*(LGHI|LI).*)\\\\R)*.*(?i:call,static).*wrapper for: C2 Runtime new_array\" + END;\n-        optoOnly(ALLOC_ARRAY_OF, regex);\n+        \/\/ Assuming we are looking for an array of \"some\/package\/MyClass\". The printout is\n+        \/\/ [Lsome\/package\/MyClass;\n+        \/\/ or, with more dimensions\n+        \/\/ [[[Lsome\/package\/MyClass;\n+\n+        \/\/ Case where the searched string is a not fully qualified name (but maybe partially qualified):\n+        \/\/ package\/MyClass or MyClass\n+        \/\/ The \".*\\\\b\" will eat the \"some\/\" and \"some\/package\/\" resp.\n+        String partial_name_prefix = \".+\\\\b\";\n+\n+        \/\/ The thing after \"allocationKlass:\" (the name of the allocated class) is a sequence of:\n+        \/\/ - a non-empty sequence of \"[\"\n+        \/\/ - a single character (\"L\"),\n+        \/\/ - maybe a non-empty sequence of characters ending on a word boundary\n+        \/\/   this sequence is omitted if the given name is already fully qualified (exact match)\n+        \/\/   but will eat the package path prefix in the cases described above\n+        \/\/ - the name we are looking for\n+        \/\/ - the final \";\".\n+        String name_part = \"\\\\[+.(\" + partial_name_prefix + \")?\" + IS_REPLACED + \";\";\n+        String regex = START + \"AllocateArray\\\\b\" + MID + \"allocationKlass:\" + name_part + \".*\" + END;\n+        macroNodes(ALLOC_ARRAY_OF, regex);\n@@ -2561,1 +2580,2 @@\n-        macroNodes(MOD_F, \"ModF\");\n+        String regex = START + \"ModF\" + MID + END;\n+        macroNodes(MOD_F, regex);\n@@ -2566,1 +2586,2 @@\n-        macroNodes(MOD_D, \"ModD\");\n+        String regex = START + \"ModD\" + MID + END;\n+        macroNodes(MOD_D, regex);\n@@ -2604,10 +2625,0 @@\n-    private static void allocNodes(String irNode, String irNodeName, String optoRegex) {\n-        String idealIndependentRegex = START + irNodeName + \"\\\\b\" + MID + END;\n-        Map<PhaseInterval, String> intervalToRegexMap = new HashMap<>();\n-        intervalToRegexMap.put(new PhaseInterval(CompilePhase.BEFORE_REMOVEUSELESS, CompilePhase.PHASEIDEALLOOP_ITERATIONS),\n-                               idealIndependentRegex);\n-        intervalToRegexMap.put(new PhaseInterval(CompilePhase.PRINT_OPTO_ASSEMBLY), optoRegex);\n-        MultiPhaseRangeEntry entry = new MultiPhaseRangeEntry(CompilePhase.PRINT_OPTO_ASSEMBLY, intervalToRegexMap);\n-        IR_NODE_MAPPINGS.put(irNode, entry);\n-    }\n-\n@@ -2617,2 +2628,1 @@\n-    private static void macroNodes(String irNodePlaceholder, String irNodeRegex) {\n-        String regex = START + irNodeRegex + MID + END;\n+    private static void macroNodes(String irNodePlaceholder, String regex) {\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/IRNode.java","additions":32,"deletions":22,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -78,1 +78,0 @@\n-        String[] allocMatches = { \"MyClass\", \"wrapper for: C2 Runtime new_instance\" };\n@@ -91,1 +90,1 @@\n-                 BadFailOnConstraint.create(MultipleFailOnBad.class, \"fail6()\", 1,  2, allocMatches),\n+                 BadFailOnConstraint.create(MultipleFailOnBad.class, \"fail6()\", 1,  2, \"MyClass\"),\n@@ -94,1 +93,1 @@\n-                 BadFailOnConstraint.create(MultipleFailOnBad.class, \"fail7()\", 1,  2, allocMatches),\n+                 BadFailOnConstraint.create(MultipleFailOnBad.class, \"fail7()\", 1,  2, \"MyClass\"),\n@@ -96,1 +95,1 @@\n-                 BadFailOnConstraint.create(MultipleFailOnBad.class, \"fail8()\", 1,  2, allocMatches),\n+                 BadFailOnConstraint.create(MultipleFailOnBad.class, \"fail8()\", 1,  2, \"MyClass\"),\n@@ -117,3 +116,14 @@\n-        String[] allocArrayMatches = { \"MyClass\", \"wrapper for: C2 Runtime new_array\"};\n-        runCheck(BadFailOnConstraint.create(AllocArray.class, \"allocArray()\", 1, allocArrayMatches),\n-                 BadFailOnConstraint.create(AllocArray.class, \"allocArray()\", 2,  allocArrayMatches),\n+        runCheck(BadFailOnConstraint.create(AllocInstance.class, \"allocInstance()\", 1),\n+                BadFailOnConstraint.create(AllocInstance.class, \"allocInstance()\", 2),\n+                GoodFailOnConstraint.create(AllocInstance.class, \"allocInstance()\", 3),\n+                GoodFailOnConstraint.create(AllocInstance.class, \"allocInstance()\", 4),\n+                GoodFailOnConstraint.create(AllocInstance.class, \"allocInstance()\", 5),\n+                BadFailOnConstraint.create(AllocInstance.class, \"allocInstance()\", 6),\n+                BadFailOnConstraint.create(AllocInstance.class, \"allocInstance()\", 7),\n+                GoodFailOnConstraint.create(AllocInstance.class, \"allocInstance()\", 8),\n+                GoodFailOnConstraint.create(AllocInstance.class, \"allocInstance()\", 9),\n+                GoodFailOnConstraint.create(AllocInstance.class, \"allocInstance()\", 10)\n+        );\n+\n+        runCheck(BadFailOnConstraint.create(AllocArray.class, \"allocArray()\", 1),\n+                 BadFailOnConstraint.create(AllocArray.class, \"allocArray()\", 2),\n@@ -122,1 +132,18 @@\n-                 BadFailOnConstraint.create(AllocArray.class, \"allocArray()\", 5,  allocArrayMatches)\n+                 GoodFailOnConstraint.create(AllocArray.class, \"allocArray()\", 5),\n+                 BadFailOnConstraint.create(AllocArray.class, \"allocArray()\", 6),\n+                 BadFailOnConstraint.create(AllocArray.class, \"allocArray()\", 7),\n+                 GoodFailOnConstraint.create(AllocArray.class, \"allocArray()\", 8),\n+                 GoodFailOnConstraint.create(AllocArray.class, \"allocArray()\", 9),\n+                 GoodFailOnConstraint.create(AllocArray.class, \"allocArray()\", 10)\n+        );\n+\n+        runCheck(BadFailOnConstraint.create(AllocArray.class, \"allocMultiArray()\", 1),\n+                 BadFailOnConstraint.create(AllocArray.class, \"allocMultiArray()\", 2),\n+                 GoodFailOnConstraint.create(AllocArray.class, \"allocMultiArray()\", 3),\n+                 GoodFailOnConstraint.create(AllocArray.class, \"allocMultiArray()\", 4),\n+                 GoodFailOnConstraint.create(AllocArray.class, \"allocMultiArray()\", 5),\n+                 BadFailOnConstraint.create(AllocArray.class, \"allocMultiArray()\", 6),\n+                 BadFailOnConstraint.create(AllocArray.class, \"allocMultiArray()\", 7),\n+                 GoodFailOnConstraint.create(AllocArray.class, \"allocMultiArray()\", 8),\n+                 GoodFailOnConstraint.create(AllocArray.class, \"allocMultiArray()\", 9),\n+                 GoodFailOnConstraint.create(AllocArray.class, \"allocMultiArray()\", 10)\n@@ -269,2 +296,3 @@\n-                pattern = Pattern.compile(compilationPrefix() + \".*opto\\\\d.*\\\\R> Phase \\\"PrintOptoAssembly\\\":(?:(?!\"\n-                                          + compilationPrefix()  + \")[\\\\S\\\\s])+\");\n+                pattern = Pattern.compile(compilationPrefix() + \".*macro\\\\d.*\\\\R> Phase \\\"\"\n+                        + CompilePhase.BEFORE_MACRO_EXPANSION.getName()\n+                        + \"\\\":(?:(?!\" + compilationPrefix() + \")[\\\\S\\\\s])+\");\n@@ -281,1 +309,1 @@\n-                    failures.append(\"- Could not find all opto() methods, expected 7 but found \").append(count).append(System.lineSeparator());\n+                    failures.append(\"- Could not find all macro() methods, expected 7 but found \").append(count).append(System.lineSeparator());\n@@ -921,0 +949,19 @@\n+class AllocInstance {\n+    MyClass myClass;\n+\n+    @Test\n+    @IR(failOn = {IRNode.ALLOC})\n+    @IR(failOn = {IRNode.ALLOC_OF, \"MyClass\"})\n+    @IR(failOn = {IRNode.ALLOC_OF, \"Class\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_OF, \"MyClasss\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_OF, \"ir_framework\/tests\/MySubClass\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_OF, \"ir_framework\/tests\/MyClass\"})\n+    @IR(failOn = {IRNode.ALLOC_OF, \"tests\/MyClass\"})\n+    @IR(failOn = {IRNode.ALLOC_OF, \"ests\/MyClass\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_OF, \"Atests\/MyClass\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_OF, \"tests\"}) \/\/ Does not fail\n+    public void allocInstance() {\n+        myClass = new MyClass();\n+    }\n+}\n+\n@@ -923,0 +970,1 @@\n+    MyClass[][] myClassMultiArray;\n@@ -927,0 +975,1 @@\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"Class\"}) \/\/ Does not fail\n@@ -930,0 +979,4 @@\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"tests\/MyClass\"})\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"ests\/MyClass\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"Atests\/MyClass\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"tests\"}) \/\/ Does not fail\n@@ -933,0 +986,15 @@\n+\n+    @Test\n+    @IR(failOn = {IRNode.ALLOC_ARRAY})\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"MyClass\"})\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"Class\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"MyClasss\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"ir_framework\/tests\/MySubClass\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"ir_framework\/tests\/MyClass\"})\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"tests\/MyClass\"})\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"ests\/MyClass\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"Atests\/MyClass\"}) \/\/ Does not fail\n+    @IR(failOn = {IRNode.ALLOC_ARRAY_OF, \"tests\"}) \/\/ Does not fail\n+    public void allocMultiArray() {\n+        myClassMultiArray = new MyClass[2][3];\n+    }\n@@ -1395,1 +1463,1 @@\n-    public void opto1() {\n+    public void macro1() {\n@@ -1402,1 +1470,1 @@\n-    public void opto2() {\n+    public void macro2() {\n@@ -1409,1 +1477,1 @@\n-    public void opto3() {\n+    public void macro3() {\n@@ -1417,1 +1485,1 @@\n-    public void opto4() {\n+    public void macro4() {\n@@ -1424,1 +1492,1 @@\n-    public void opto5() {\n+    public void macro5() {\n@@ -1431,1 +1499,1 @@\n-    public void opto6() {\n+    public void macro6() {\n@@ -1438,1 +1506,1 @@\n-    public void opto7() {\n+    public void macro7() {\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/tests\/TestIRMatching.java","additions":86,"deletions":18,"binary":false,"changes":104,"status":"modified"}]}