{"files":[{"patch":"@@ -83,0 +83,1 @@\n+  derandomizeServiceTestCfgFiles\n@@ -97,0 +98,7 @@\n+derandomizeServiceTestCfgFiles() {\n+  # Convert variable part of 'java-options=-Djpackage.test.appOutput=\/tmp\/AddLServiceTest-0000019a5a3fac9c-launcher-as-service.txt'\n+  # in '*.cfg' files of the ServiceTest test.\n+  find \"$stash_dir\" -path '*\/ServiceTest\/*.cfg' -type f | xargs -I {} sed $sed_inplace_option \\\n+      -e 's|ServiceTest-[[:xdigit:]]\\{1,\\}-\\([^ ]*\\.txt\\)|ServiceTest-<SEED>-\\1|g' \\\n+      '{}'\n+}\n@@ -123,1 +131,1 @@\n-      -e 's|\/jdk.jpackage[0-9]\\{1,\\}\/|\/jdk.jpackage\/|' \\\n+      -e 's|\/jdk\\.jpackage[0-9]\\{1,\\}\/|\/jdk.jpackage\/|' \\\n","filename":"test\/jdk\/tools\/jpackage\/clean_stashed_files.sh","additions":9,"deletions":1,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -117,0 +117,3 @@\n+\n+      # Convert variable part of 'ServiceTest-0000019a5516cf7a-A2-launcher-as-service.txt' path\n+      -e 's|ServiceTest-[[:xdigit:]]\\{1,\\}-\\([^ ]*\\.txt\\)|ServiceTest-<SEED>-\\1|g'\n","filename":"test\/jdk\/tools\/jpackage\/clean_test_output.sh","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -25,1 +25,0 @@\n-import static jdk.jpackage.internal.util.function.ThrowingSupplier.toSupplier;\n@@ -31,1 +30,0 @@\n-import java.nio.file.Files;\n@@ -42,1 +40,0 @@\n-import java.util.Properties;\n@@ -45,0 +42,1 @@\n+import jdk.jpackage.internal.util.Slot;\n@@ -208,1 +206,1 @@\n-        PropertyFile shell[] = new PropertyFile[1];\n+        var result = Slot.<PropertyFile>createEmpty();\n@@ -211,3 +209,1 @@\n-                shell[0] = toSupplier(() -> {\n-                    return new PropertyFile(propertiesFilePath);\n-                }).get();\n+                result.set(new PropertyFile(propertiesFilePath));\n@@ -216,1 +212,1 @@\n-        return Objects.requireNonNull(shell[0]);\n+        return result.get();\n@@ -248,26 +244,0 @@\n-    public static final class PropertyFile {\n-\n-        PropertyFile(Map<String, String> data) {\n-            this.data = new Properties();\n-            this.data.putAll(data);\n-        }\n-\n-        PropertyFile(Path path) throws IOException {\n-            data = new Properties();\n-            try (var reader = Files.newBufferedReader(path)) {\n-                data.load(reader);\n-            }\n-        }\n-\n-        public Optional<String> findProperty(String name) {\n-            Objects.requireNonNull(name);\n-            return Optional.ofNullable(data.getProperty(name));\n-        }\n-\n-        public Optional<Boolean> findBooleanProperty(String name) {\n-            return findProperty(name).map(Boolean::parseBoolean);\n-        }\n-\n-        private final Properties data;\n-    }\n-\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/AdditionalLauncher.java","additions":4,"deletions":34,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -23,0 +23,1 @@\n+package jdk.jpackage.test;\n@@ -24,4 +25,3 @@\n-public class CustomLoadee5 {\n-    public String toString() {\n-        return \"this is CustomLoadee5\";\n-    }\n+@FunctionalInterface\n+public interface CannedArgument {\n+    public String getValue();\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/CannedArgument.java","additions":4,"deletions":4,"binary":false,"changes":8,"previous_filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/customLoader\/test-classes\/CustomLoadee5.java","status":"copied"},{"patch":"@@ -26,0 +26,1 @@\n+import java.util.Arrays;\n@@ -30,0 +31,1 @@\n+import java.util.function.UnaryOperator;\n@@ -32,1 +34,1 @@\n-public record CannedFormattedString(BiFunction<String, Object[], String> formatter, String key, Object[] args) {\n+public record CannedFormattedString(BiFunction<String, Object[], String> formatter, String key, Object[] args) implements CannedArgument {\n@@ -34,6 +36,1 @@\n-    @FunctionalInterface\n-    public interface CannedArgument {\n-        public String value();\n-    }\n-\n-    public static Object cannedArgument(Supplier<Object> supplier, String label) {\n+    public static CannedArgument cannedArgument(Supplier<Object> supplier, String label) {\n@@ -45,1 +42,1 @@\n-            public String value() {\n+            public String getValue() {\n@@ -64,0 +61,4 @@\n+    public CannedFormattedString mapArgs(UnaryOperator<Object> mapper) {\n+        return new CannedFormattedString(formatter, key, Stream.of(args).map(mapper).toArray());\n+    }\n+\n@@ -74,1 +75,1 @@\n-                return cannedArg.value();\n+                return cannedArg.getValue();\n@@ -81,0 +82,8 @@\n+    public CannedFormattedString addPrefix(String prefixKey) {\n+        Objects.requireNonNull(prefixKey);\n+        return new CannedFormattedString((theKey, theArgs) -> {\n+            var str = formatter.apply((String)theArgs[0], Arrays.copyOfRange(theArgs, 1, theArgs.length));\n+            return formatter.apply(theKey, new Object[] {str});\n+        }, prefixKey, Stream.concat(Stream.of(key), Stream.of(args)).toArray());\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/CannedFormattedString.java","additions":18,"deletions":9,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -214,1 +214,1 @@\n-        return cmd.launcherNames(true).stream().anyMatch(launcherName -> {\n+        return !cmd.isImagePackageType() && cmd.launcherNames(true).stream().anyMatch(launcherName -> {\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/ConfigFilesStasher.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import static java.util.stream.Collectors.toCollection;\n@@ -31,1 +32,0 @@\n-import static java.util.stream.Collectors.toCollection;\n@@ -867,0 +867,8 @@\n+    public static CannedFormattedString makeError(CannedFormattedString v) {\n+        return v.addPrefix(\"message.error-header\");\n+    }\n+\n+    public static CannedFormattedString makeAdvice(CannedFormattedString v) {\n+        return v.addPrefix(\"message.advice-header\");\n+    }\n+\n@@ -1243,0 +1251,3 @@\n+            }).filter(_ -> {\n+                \/\/ Don't examine the contents of the output app image if this is Linux package installing in the \"\/usr\" subtree.\n+                return Optional.<Boolean>ofNullable(cmd.onLinuxPackageInstallDir(null, _ -> false)).orElse(true);\n@@ -1285,1 +1296,6 @@\n-        })\n+        }),\n+        LINUX_APPLAUNCHER_LIB(cmd -> {\n+            if (TKit.isLinux() && !cmd.isRuntime()) {\n+                TKit.assertFileExists(cmd.appLayout().libapplauncher());\n+            }\n+        }),\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/JPackageCommand.java","additions":18,"deletions":2,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -249,7 +249,1 @@\n-            var mainLauncherValue = PropertyFinder.findLauncherProperty(cmd, null,\n-                    PropertyFinder.cmdlineBooleanOption(\"--launcher-as-service\"),\n-                    PropertyFinder.nop(),\n-                    PropertyFinder.nop()\n-            ).map(Boolean::parseBoolean).orElse(false);\n-\n-            var value = PropertyFinder.findLauncherProperty(cmd, launcherName,\n+            return PropertyFinder.findLauncherProperty(cmd, launcherName,\n@@ -259,3 +253,3 @@\n-            ).map(Boolean::parseBoolean);\n-\n-            return value.orElse(mainLauncherValue);\n+            ).map(Boolean::parseBoolean).orElseGet(() -> {\n+                return launcherAsService(cmd, null);\n+            });\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/LauncherAsServiceVerifier.java","additions":4,"deletions":10,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -35,1 +35,0 @@\n-import jdk.jpackage.test.AdditionalLauncher.PropertyFile;\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/LauncherShortcut.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -47,1 +47,0 @@\n-import jdk.jpackage.test.AdditionalLauncher.PropertyFile;\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/LauncherVerifier.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -0,0 +1,82 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package jdk.jpackage.test;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.Properties;\n+import java.util.stream.Collectors;\n+\n+public final class PropertyFile {\n+\n+    PropertyFile(Map<String, String> data) {\n+        this.data = new Properties();\n+        this.data.putAll(data);\n+        path = Optional.empty();\n+    }\n+\n+    PropertyFile(Path path) {\n+        data = new Properties();\n+        try (var reader = Files.newBufferedReader(path)) {\n+            data.load(reader);\n+        } catch (IOException ex) {\n+            throw new UncheckedIOException(ex);\n+        }\n+        this.path = Optional.of(path);\n+    }\n+\n+    public Optional<String> findProperty(String name) {\n+        Objects.requireNonNull(name);\n+        return Optional.ofNullable(data.getProperty(name));\n+    }\n+\n+    public Optional<Boolean> findBooleanProperty(String name) {\n+        return findProperty(name).map(Boolean::parseBoolean);\n+    }\n+\n+    public Optional<Path> path() {\n+        return path;\n+    }\n+\n+    public Path getPath() {\n+        return path().orElseThrow();\n+    }\n+\n+    public Map<String, String> toMap() {\n+        return data.entrySet().stream().collect(Collectors.toUnmodifiableMap(e -> {\n+            return (String)e.getKey();\n+        }, e -> {\n+            return (String)e.getValue();\n+        }));\n+    }\n+\n+    private final Properties data;\n+    private final Optional<Path> path;\n+}\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/PropertyFile.java","additions":82,"deletions":0,"binary":false,"changes":82,"status":"added"},{"patch":"@@ -33,1 +33,0 @@\n-import jdk.jpackage.test.AdditionalLauncher.PropertyFile;\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/PropertyFinder.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import jdk.internal.util.OperatingSystem;\n@@ -188,0 +189,18 @@\n+    \/**\n+     * Test building Linux package from the predefined app image with installation\n+     * directory in the \"\/usr\" subtree.\n+     *\/\n+    @Test(ifOS = OperatingSystem.LINUX)\n+    public static void testUsrInstallDir() {\n+        final var appImageCmd = createAppImageCommand();\n+\n+        new PackageTest()\n+        .addRunOnceInitializer(appImageCmd::execute)\n+        .usePredefinedAppImage(appImageCmd)\n+        .addBundleDesktopIntegrationVerifier(false)\n+        .addInitializer(cmd -> {\n+            cmd.addArguments(\"--install-dir\", \"\/usr\");\n+        })\n+        .run();\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/share\/AppImagePackageTest.java","additions":19,"deletions":0,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -30,1 +30,0 @@\n-import static jdk.jpackage.test.CannedFormattedString.cannedAbsolutePath;\n@@ -49,0 +48,1 @@\n+import jdk.jpackage.test.CannedArgument;\n@@ -144,1 +144,1 @@\n-    record PackageTypeSpec(Optional<PackageType> type, boolean anyNativeType) implements CannedFormattedString.CannedArgument {\n+    record PackageTypeSpec(Optional<PackageType> type, boolean anyNativeType) implements CannedArgument {\n@@ -169,1 +169,1 @@\n-        public String value() {\n+        public String getValue() {\n","filename":"test\/jdk\/tools\/jpackage\/share\/ErrorTest.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"}]}