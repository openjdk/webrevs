{"files":[{"patch":"@@ -133,1 +133,2 @@\n-  -serviceability\/jvmti\/negative\n+  -serviceability\/jvmti\/negative \\\n+  -serviceability\/jvmti\/HeapMonitor\/MyPackage\/HeapMonitorVMEventsTest.java\n","filename":"test\/hotspot\/jtreg\/TEST.groups","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -67,0 +67,2 @@\n+java\/lang\/Thread\/virtual\/ThreadAPI.java#default 0000000 generic-all\n+java\/lang\/Thread\/virtual\/ThreadAPI.java#no-vmcontinuations 0000000 generic-all\n","filename":"test\/jdk\/ProblemList-Virtual.txt","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -79,1 +79,0 @@\n-        assertNull(Thread.getDefaultUncaughtExceptionHandler());\n","filename":"test\/jdk\/java\/util\/concurrent\/tck\/ThreadTest.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+@SuppressWarnings(\"removal\")\n@@ -29,1 +30,0 @@\n-        \/\/ This property is used by ProcessTools and some tests\n@@ -31,0 +31,1 @@\n+            \/\/ This property is used by ProcessTools and some tests\n@@ -39,0 +40,10 @@\n+    private static volatile Throwable uncaughtException;\n+\n+    private static synchronized void handleException(Throwable e) {\n+        if (e instanceof ThreadDeath) {\n+            return;\n+        }\n+        e.printStackTrace(System.err);\n+        uncaughtException = e;\n+    }\n+\n@@ -41,1 +52,27 @@\n-        return VIRTUAL_TF.newThread(task);\n+        return VIRTUAL_TF.newThread(() -> {\n+                \/\/ Temporary workaround until CODETOOLS-7903526 is fixed in jtreg.\n+                \/\/ The jtreg run main() in the ThreadGroup and catch only exceptions in this group.\n+                \/\/ However with test thread factory all platform threads started from virtual main thread\n+                \/\/ don't belong to any group and need global handler.\n+                try {\n+                    Thread.setDefaultUncaughtExceptionHandler((t, e) -> {\n+                            handleException(e);\n+                        });\n+                } catch (Throwable t) {\n+                    \/\/ might be thrown by security manager\n+                }\n+\n+\n+                try {\n+                    task.run();\n+\n+                    if (uncaughtException != null) {\n+                        throw new RuntimeException(uncaughtException);\n+                    }\n+                } finally {\n+                    synchronized (Virtual.class) {\n+                        uncaughtException = null;\n+                        Thread.setDefaultUncaughtExceptionHandler(null);\n+                    }\n+                }\n+            });\n@@ -43,0 +80,1 @@\n+\n","filename":"test\/jtreg_test_thread_factory\/src\/share\/classes\/Virtual.java","additions":40,"deletions":2,"binary":false,"changes":42,"status":"modified"}]}