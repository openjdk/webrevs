{"files":[{"patch":"@@ -33,10 +33,0 @@\n-            \/\/ Temporary workaround until CODETOOLS-7903526 is fixed in jtreg\n-            \/\/ The jtreg run main() in the ThreadGroup and catch only exceptions in this group.\n-            \/\/ The virtual threads don't belong to any group and need global handler.\n-            Thread.setDefaultUncaughtExceptionHandler((t, e) -> {\n-                    if (e instanceof ThreadDeath) {\n-                        return;\n-                    }\n-                    e.printStackTrace(System.err);\n-                    System.exit(1);\n-                });\n@@ -50,0 +40,10 @@\n+    private static volatile Throwable uncaughtException;\n+\n+    private static synchronized void handleException(Throwable e) {\n+        if (e instanceof ThreadDeath) {\n+            return;\n+        }\n+        e.printStackTrace(System.err);\n+        uncaughtException = e;\n+    }\n+\n@@ -52,1 +52,27 @@\n-        return VIRTUAL_TF.newThread(task);\n+        return VIRTUAL_TF.newThread(() -> {\n+                \/\/ Temporary workaround until CODETOOLS-7903526 is fixed in jtreg.\n+                \/\/ The jtreg run main() in the ThreadGroup and catch only exceptions in this group.\n+                \/\/ However with test thread factory all platform threads started from virtual main thread\n+                \/\/ don't belong to any group and need global handler.\n+                try {\n+                    Thread.setDefaultUncaughtExceptionHandler((t, e) -> {\n+                            handleException(e);\n+                        });\n+                } catch (Throwable t) {\n+                    \/\/ might be thrown by security manager\n+                }\n+\n+\n+                try {\n+                    task.run();\n+\n+                    if (uncaughtException != null) {\n+                        throw new RuntimeException(uncaughtException);\n+                    }\n+                } finally {\n+                    synchronized (Virtual.class) {\n+                        uncaughtException = null;\n+                        Thread.setDefaultUncaughtExceptionHandler(null);\n+                    }\n+                }\n+            });\n@@ -54,0 +80,1 @@\n+\n","filename":"test\/jtreg_test_thread_factory\/src\/share\/classes\/Virtual.java","additions":38,"deletions":11,"binary":false,"changes":49,"status":"modified"}]}