{"files":[{"patch":"@@ -171,2 +171,1 @@\n-  const NativeCallStack& stack)\n-{\n+  const NativeCallStack& stack, void* old_malloc_base) {\n@@ -182,0 +181,2 @@\n+  NMT_MemoryLogRecorder::log_malloc(mem_tag, size, malloc_base, &stack, old_malloc_base);\n+\n@@ -212,0 +213,2 @@\n+  NMT_MemoryLogRecorder::log_free(header);\n+\n","filename":"src\/hotspot\/share\/nmt\/mallocTracker.cpp","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -284,1 +284,1 @@\n-    const NativeCallStack& stack);\n+    const NativeCallStack& stack, void* old_base = nullptr);\n","filename":"src\/hotspot\/share\/nmt\/mallocTracker.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -497,0 +497,1 @@\n+\n@@ -499,1 +500,2 @@\n-    fprintf(stderr, \"\\n\\n\\nSummary:\\n\\n\");\n+    size_t overhead_NMT = count * MemTracker::overhead_per_malloc();\n+    fprintf(stderr, \"\\n\\n\\nmalloc summary:\\n\\n\");\n@@ -501,2 +503,2 @@\n-    fprintf(stderr, \"memory overhead=%'zu bytes [%2.2f%%]\\n\", overhead, overheadPercentage);\n-    fprintf(stderr, \"requestedTotal=%'zu actualTotal=%'zu\\n\", requestedTotal, actualTotal);\n+    fprintf(stderr, \"memory requested:%'zu bytes, allocated:%'zu bytes, overhead=%'zu bytes [%2.2f%%]\\n\", requestedTotal, actualTotal, overhead, overheadPercentage);\n+    fprintf(stderr, \"requested total=%'zu, actual total=%'zu, NMT headers=%'zu\\n\", requestedTotal, actualTotal, overhead_NMT);\n@@ -540,2 +542,1 @@\n-      if (MemTracker::is_initialized())\n-      {\n+      if (MemTracker::is_initialized()) {\n@@ -548,0 +549,3 @@\n+      if (entry.requested > 0) {\n+        entry.requested += MemTracker::overhead_per_malloc();\n+      }\n@@ -549,2 +553,1 @@\n-      if (entry.requested > 0)\n-      {\n+      if (entry.requested > 0) {\n@@ -574,2 +577,2 @@\n-void NMT_MemoryLogRecorder::log_free(void *ptr)\n-{\n+void NMT_MemoryLogRecorder::log_free(void *ptr) {\n+  \/\/fprintf(stderr, \"NMT_MemoryLogRecorder::log(%16p)\\n\", ptr);\n@@ -579,9 +582,2 @@\n-void NMT_MemoryLogRecorder::log_malloc(MemTag mem_tag, size_t requested, void* ptr, const NativeCallStack *stack)\n-{\n-  NMT_MemoryLogRecorder::_log(mem_tag, requested, (address)ptr, nullptr, stack);\n-}\n-\n-void NMT_MemoryLogRecorder::log_realloc(MemTag mem_tag, size_t requested, void* ptr, void* old, const NativeCallStack *stack)\n-{\n-  if (old == nullptr)\n-  {\n+void NMT_MemoryLogRecorder::log_malloc(MemTag mem_tag, size_t requested, void* ptr, const NativeCallStack *stack, void* old) {\n+  if (old == nullptr) {\n@@ -633,1 +629,0 @@\n-      fprintf(stderr, \">> _memLogRecorder._log_fd:%d\\n\", recorder->_log_fd);\n@@ -643,1 +638,0 @@\n-  fprintf(stderr, \"NMT_VirtualMemoryLogRecorder::finish()\\n\");\n@@ -653,1 +647,0 @@\n-  fprintf(stderr, \" info_fd:%d\\n\", info_fd);\n@@ -660,1 +653,0 @@\n-    fprintf(stderr, \" info_fd:%d\\n\", info_fd);\n@@ -754,0 +746,1 @@\n+    fprintf(stderr, \"\\n\\n\\nVirtualMemoryTracker summary:\\n\\n\\n\");\n","filename":"src\/hotspot\/share\/nmt\/memLogRecorder.cpp","additions":15,"deletions":22,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -101,2 +101,1 @@\n-  static void log_malloc(MemTag mem_tag, size_t requested, void* ptr, const NativeCallStack *stack);\n-  static void log_realloc(MemTag mem_tag, size_t requested, void* ptr, void* old, const NativeCallStack *stack);\n+  static void log_malloc(MemTag mem_tag, size_t requested, void* ptr, const NativeCallStack *stack, void* old = nullptr);\n","filename":"src\/hotspot\/share\/nmt\/memLogRecorder.hpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -80,1 +80,1 @@\n-    const NativeCallStack& stack) {\n+    const NativeCallStack& stack, void* old_base = nullptr) {\n@@ -83,1 +83,1 @@\n-      return MallocTracker::record_malloc(mem_base, size, mem_tag, stack);\n+      return MallocTracker::record_malloc(mem_base, size, mem_tag, stack, old_base);\n","filename":"src\/hotspot\/share\/nmt\/memTracker.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -665,2 +665,0 @@\n-  NMT_MemoryLogRecorder::log_malloc(mem_tag, outer_size, outer_ptr, &stack);\n-\n@@ -684,1 +682,0 @@\n-\n@@ -738,2 +735,0 @@\n-    NMT_MemoryLogRecorder::log_realloc(mem_tag, new_outer_size, new_outer_ptr, header, &stack);\n-\n@@ -745,1 +740,1 @@\n-    void* const new_inner_ptr = MemTracker::record_malloc(new_outer_ptr, size, mem_tag, stack);\n+    void* const new_inner_ptr = MemTracker::record_malloc(new_outer_ptr, size, mem_tag, stack, memblock);\n@@ -773,1 +768,0 @@\n-\n@@ -788,2 +782,0 @@\n-  NMT_MemoryLogRecorder::log_free(old_outer_ptr);\n-\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":1,"deletions":9,"binary":false,"changes":10,"status":"modified"}]}