{"files":[{"patch":"@@ -105,1 +105,2 @@\n-  _threads_names = nullptr;\n+  _threads_names_counter = 1;\n+  _threads_names = (thread_name_info*)permit_forbidden_function::calloc(_threads_names_counter, sizeof(thread_name_info));\n@@ -135,2 +136,7 @@\n-void NMT_LogRecorder::logThreadName(const char* name) {\n-  NMT_MemoryLogRecorder::instance()->_logThreadName(name);\n+intx NMT_LogRecorder::thread_id() {\n+#if defined(LINUX) || defined(__APPLE__)\n+  return (intx)pthread_self();\n+#elif defined(WINDOWS)\n+  \/\/ TODO\n+  return 0;\n+#endif\n@@ -138,6 +144,7 @@\n-void NMT_LogRecorder::_logThreadName(const char* name) {\n-  if (_done) {\n-    return;\n-  }\n-  if (_threads_names == nullptr) {\n-    _threads_names = (thread_name_info*)permit_forbidden_function::calloc(_threads_names_capacity, sizeof(thread_name_info));\n+\n+void NMT_LogRecorder::thread_name(char* buf) {\n+#if defined(__APPLE__)\n+  if (pthread_main_np()) {\n+    strcpy(buf, \"main\");\n+  } else {\n+    pthread_getname_np(pthread_self(), buf, MAXTHREADNAMESIZE);\n@@ -145,5 +152,12 @@\n-  if (_threads_names_counter < _threads_names_capacity) {\n-    volatile size_t counter = _threads_names_counter++;\n-    if (counter < _threads_names_capacity) {\n-      strncpy((char*)_threads_names[counter].name, name, _threads_name_length-1);\n-      _threads_names[counter].thread = os::current_thread_id();\n+#elif defined(LINUX)\n+  \/\/ TODO\n+#elif defined(WINDOWS)\n+  \/\/ TODO\n+  return 0;\n+#endif\n+}\n+\n+void NMT_LogRecorder::logThreadName() {\n+  for (size_t i = 0; i < _threads_names_counter; i++) {\n+    if (_threads_names[i].thread == thread_id()) {\n+      return;\n@@ -151,4 +165,8 @@\n-  } else {\n-    _threads_names_capacity *= 2;\n-    _threads_names = (thread_name_info*)permit_forbidden_function::realloc((void*)_threads_names, _threads_names_capacity*sizeof(thread_name_info));\n-      logThreadName(name);\n+  }\n+  static char name[MAXTHREADNAMESIZE];\n+  thread_name(name);\n+  if (strlen(name) > 0) {\n+    _threads_names_counter++;\n+    _threads_names = (thread_name_info*)permit_forbidden_function::realloc((void*)_threads_names, (_threads_names_counter+1)*sizeof(thread_name_info));\n+    _threads_names[_threads_names_counter-1].thread = thread_id();\n+    strncpy((char*)_threads_names[_threads_names_counter-1].name, name, MAXTHREADNAMESIZE-1);\n@@ -307,1 +325,1 @@\n-  fprintf(stderr, \"NMT_MemoryLogRecorder::finish() %p\\n\", NMT_MemoryLogRecorder::instance());\n+  \/\/fprintf(stderr, \"NMT_MemoryLogRecorder::finish() %p\\n\", NMT_MemoryLogRecorder::instance());\n@@ -311,1 +329,1 @@\n-    fprintf(stderr, \" log_fd:%d\\n\", log_fd);\n+    \/\/fprintf(stderr, \" log_fd:%d\\n\", log_fd);\n@@ -313,1 +331,1 @@\n-    fprintf(stderr, \" log_fd:%d\\n\", log_fd);\n+    \/\/fprintf(stderr, \" log_fd:%d\\n\", log_fd);\n@@ -316,1 +334,1 @@\n-    fprintf(stderr, \" threads_fd:%d\\n\", threads_fd);\n+    \/\/fprintf(stderr, \" threads_fd:%d\\n\", threads_fd);\n@@ -320,1 +338,1 @@\n-      fprintf(stderr, \" threads_fd:%d\\n\", threads_fd);\n+      \/\/fprintf(stderr, \" threads_fd:%d\\n\", threads_fd);\n@@ -324,1 +342,1 @@\n-    fprintf(stderr, \" info_fd:%d\\n\", info_fd);\n+    \/\/fprintf(stderr, \" info_fd:%d\\n\", info_fd);\n@@ -331,1 +349,1 @@\n-      fprintf(stderr, \" info_fd:%d\\n\", info_fd);\n+      \/\/fprintf(stderr, \" info_fd:%d\\n\", info_fd);\n@@ -562,0 +580,2 @@\n+\n+      recorder->logThreadName();\n","filename":"src\/hotspot\/share\/nmt\/memLogRecorder.cpp","additions":45,"deletions":25,"binary":false,"changes":70,"status":"modified"},{"patch":"@@ -43,2 +43,0 @@\n-  static constexpr size_t _threads_name_length = 32;\n-  volatile size_t _threads_names_capacity = 128;\n@@ -47,1 +45,1 @@\n-    char name[_threads_name_length];\n+    char name[MAXTHREADNAMESIZE];\n@@ -64,0 +62,2 @@\n+  intx thread_id();\n+  void thread_name(char* buf);\n@@ -67,3 +67,1 @@\n-\n-private:\n-  void _logThreadName(const char* name);\n+  void logThreadName();\n","filename":"src\/hotspot\/share\/nmt\/memLogRecorder.hpp","additions":4,"deletions":6,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -359,1 +359,0 @@\n-    NMT_LogRecorder::logThreadName(name);\n","filename":"src\/hotspot\/share\/runtime\/thread.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -928,2 +928,0 @@\n-  NMT_LogRecorder::finish();\n-\n","filename":"src\/hotspot\/share\/runtime\/threads.cpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}