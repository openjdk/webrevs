{"files":[{"patch":"@@ -28,0 +28,1 @@\n+import jdk.internal.misc.CDS;\n@@ -31,0 +32,1 @@\n+import sun.util.logging.PlatformLogger;\n@@ -139,3 +141,1 @@\n-                if (mt.parameterCount() < 2 ||\n-                        mt.parameterType(0) != Object.class ||\n-                        mt.parameterType(lastParam) != Object.class) {\n+                if (!checkInvokerTypeParams(mt)) {\n@@ -193,1 +193,1 @@\n-        private static MethodType asMethodType(String basicSignatureString) {\n+        public static MethodType asMethodType(String basicSignatureString) {\n@@ -210,0 +210,7 @@\n+        public static boolean checkInvokerTypeParams(MethodType mt) {\n+            final int lastParam = mt.parameterCount() - 1;\n+            return (mt.parameterCount() >= 2 &&\n+                    mt.parameterType(0) == Object.class &&\n+                    mt.parameterType(lastParam) == Object.class);\n+        }\n+\n@@ -318,1 +325,9 @@\n-                                    builder.addInvokerType(methodType);\n+                                    MethodType mt = HolderClassBuilder.asMethodType(methodType);\n+                                    if (HolderClassBuilder.checkInvokerTypeParams(mt)) {\n+                                        builder.addInvokerType(methodType);\n+                                    } else {\n+                                        if (CDS.isDumpingArchive()) {\n+                                            PlatformLogger.getLogger(\"java.lang.invoke\")\n+                                                    .warning(\"Invalid LF_RESOLVE \" + parts[1] + \" \" + parts[2] + \" \" + parts[3]);\n+                                        }\n+                                    }\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/GenerateJLIClassesHelper.java","additions":20,"deletions":5,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -138,1 +138,1 @@\n-            CDS.traceLambdaFormInvoker(\"[LF_RESOLVE]\", holder.getName(), name, shortenSignature(basicTypeSignature(type)));\n+            CDS.traceLambdaFormInvoker(\"[LF_RESOLVE]\", holder.getName(), name, shortenSignature(basicTypeSignature(type)), type);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/MethodHandleStatics.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+import java.lang.invoke.MethodType;\n@@ -112,0 +113,10 @@\n+    \/**\n+     * Checks if the lambda form invoker is archivable. This is to avoid RuntimeException\n+     * during CDS archive dumping.\n+     *\/\n+    private static boolean isInvokerArchivable(MethodType mt, String holder) {\n+        final int lastParam = mt.parameterCount() - 1;\n+        return ((mt.parameterCount() >= 2 && mt.parameterType(0) == Object.class\n+                && mt.parameterType(lastParam) == Object.class) || isValidHolderName(holder));\n+    }\n+\n@@ -115,2 +126,2 @@\n-    public static void traceLambdaFormInvoker(String prefix, String holder, String name, String type) {\n-        if (isDumpingClassList) {\n+    public static void traceLambdaFormInvoker(String prefix, String holder, String name, String type, MethodType mt) {\n+        if (isDumpingClassList && isInvokerArchivable(mt, holder)) {\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/misc\/CDS.java","additions":13,"deletions":2,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -84,0 +84,1 @@\n+import jdk.test.lib.process.OutputAnalyzer;\n@@ -101,0 +102,6 @@\n+    static void checkError(OutputAnalyzer output) throws Exception {\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Was the base archive generated with an outdated classlist?\");\n+        }\n+    }\n+\n@@ -114,0 +121,1 @@\n+            .assertNormalExit(output -> checkError(output))\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/methodHandles\/CDSMHTest_generate.sh","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -52,0 +52,1 @@\n+import jdk.test.lib.process.OutputAnalyzer;\n@@ -69,0 +70,6 @@\n+    static void checkError(OutputAnalyzer output) throws Exception {\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Was the base archive generated with an outdated classlist?\");\n+        }\n+    }\n+\n@@ -82,0 +89,1 @@\n+            .assertNormalExit(output -> checkError(output))\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/methodHandles\/MethodHandlesAsCollectorTest.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -52,0 +52,1 @@\n+import jdk.test.lib.process.OutputAnalyzer;\n@@ -69,0 +70,6 @@\n+    static void checkError(OutputAnalyzer output) throws Exception {\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Was the base archive generated with an outdated classlist?\");\n+        }\n+    }\n+\n@@ -82,0 +89,1 @@\n+            .assertNormalExit(output -> checkError(output))\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/methodHandles\/MethodHandlesCastFailureTest.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -52,0 +52,1 @@\n+import jdk.test.lib.process.OutputAnalyzer;\n@@ -69,0 +70,6 @@\n+    static void checkError(OutputAnalyzer output) throws Exception {\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Was the base archive generated with an outdated classlist?\");\n+        }\n+    }\n+\n@@ -82,0 +89,1 @@\n+            .assertNormalExit(output -> checkError(output))\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/methodHandles\/MethodHandlesGeneralTest.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -52,0 +52,1 @@\n+import jdk.test.lib.process.OutputAnalyzer;\n@@ -69,0 +70,6 @@\n+    static void checkError(OutputAnalyzer output) throws Exception {\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Was the base archive generated with an outdated classlist?\");\n+        }\n+    }\n+\n@@ -82,0 +89,1 @@\n+            .assertNormalExit(output -> checkError(output))\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/methodHandles\/MethodHandlesInvokersTest.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -52,0 +52,1 @@\n+import jdk.test.lib.process.OutputAnalyzer;\n@@ -69,0 +70,6 @@\n+    static void checkError(OutputAnalyzer output) throws Exception {\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Was the base archive generated with an outdated classlist?\");\n+        }\n+    }\n+\n@@ -82,0 +89,1 @@\n+            .assertNormalExit(output -> checkError(output))\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/methodHandles\/MethodHandlesPermuteArgumentsTest.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -52,0 +52,1 @@\n+import jdk.test.lib.process.OutputAnalyzer;\n@@ -69,0 +70,6 @@\n+    static void checkError(OutputAnalyzer output) throws Exception {\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Was the base archive generated with an outdated classlist?\");\n+        }\n+    }\n+\n@@ -82,0 +89,1 @@\n+            .assertNormalExit(output -> checkError(output))\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/dynamicArchive\/methodHandles\/MethodHandlesSpreadArgumentsTest.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -124,1 +124,4 @@\n-        CDSTestUtils.createArchiveAndCheck(opts);\n+        OutputAnalyzer output = CDSTestUtils.createArchiveAndCheck(opts);\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Is your classlist out of date?\");\n+        }\n@@ -132,1 +135,1 @@\n-        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n+        output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/CDSMHTest_generate.sh","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -92,1 +92,4 @@\n-        CDSTestUtils.createArchiveAndCheck(opts);\n+        OutputAnalyzer output = CDSTestUtils.createArchiveAndCheck(opts);\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Is your classlist out of date?\");\n+        }\n@@ -100,1 +103,1 @@\n-        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n+        output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesAsCollectorTest.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -92,1 +92,4 @@\n-        CDSTestUtils.createArchiveAndCheck(opts);\n+        OutputAnalyzer output = CDSTestUtils.createArchiveAndCheck(opts);\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Is your classlist out of date?\");\n+        }\n@@ -100,1 +103,1 @@\n-        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n+        output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesCastFailureTest.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -92,1 +92,4 @@\n-        CDSTestUtils.createArchiveAndCheck(opts);\n+        OutputAnalyzer output = CDSTestUtils.createArchiveAndCheck(opts);\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Is your classlist out of date?\");\n+        }\n@@ -100,1 +103,1 @@\n-        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n+        output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesGeneralTest.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -92,1 +92,4 @@\n-        CDSTestUtils.createArchiveAndCheck(opts);\n+        OutputAnalyzer output = CDSTestUtils.createArchiveAndCheck(opts);\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Is your classlist out of date?\");\n+        }\n@@ -100,1 +103,1 @@\n-        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n+        output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesInvokersTest.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -92,1 +92,4 @@\n-        CDSTestUtils.createArchiveAndCheck(opts);\n+        OutputAnalyzer output = CDSTestUtils.createArchiveAndCheck(opts);\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Is your classlist out of date?\");\n+        }\n@@ -100,1 +103,1 @@\n-        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n+        output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesPermuteArgumentsTest.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2022, Oracle and\/or its affiliates. All rights reserved.\n@@ -92,1 +92,4 @@\n-        CDSTestUtils.createArchiveAndCheck(opts);\n+        OutputAnalyzer output = CDSTestUtils.createArchiveAndCheck(opts);\n+        if (testClassName.equals(\"MethodHandlesInvokersTest\")) {\n+            output.shouldNotContain(\"Failed to generate LambdaForm holder classes. Is your classlist out of date?\");\n+        }\n@@ -100,1 +103,1 @@\n-        OutputAnalyzer output = CDSTestUtils.runWithArchive(runOpts);\n+        output = CDSTestUtils.runWithArchive(runOpts);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/methodHandles\/MethodHandlesSpreadArgumentsTest.java","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"}]}