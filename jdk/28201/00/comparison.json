{"files":[{"patch":"@@ -80,1 +80,1 @@\n-        if (isPodman() & !Platform.isRoot()) {\n+        if (DockerTestUtils.isPodman() & !Platform.isRoot()) {\n@@ -225,6 +225,0 @@\n-    static boolean isPodman() {\n-        String[] parts = Container.ENGINE_COMMAND\n-            .toLowerCase()\n-            .split(File.pathSeparator);\n-        return \"podman\".equals(parts[parts.length - 1]);\n-    }\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestJFRWithJMX.java","additions":1,"deletions":7,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -60,1 +60,1 @@\n-    private static final boolean IS_PODMAN = Container.ENGINE_COMMAND.contains(\"podman\");\n+    private static final boolean IS_PODMAN = DockerTestUtils.isPodman();\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestJcmd.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,117 @@\n+\/*\n+ * Copyright (C) 2025, IBM\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import jdk.test.lib.Container;\n+import jdk.test.lib.containers.docker.Common;\n+import jdk.test.lib.containers.docker.DockerTestUtils;\n+import jdk.test.lib.containers.docker.ContainerRuntimeVersionTestUtils;\n+import jdk.test.lib.containers.docker.DockerRunOptions;\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.internal.platform.Metrics;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Files;\n+import java.util.ArrayList;\n+\n+import jtreg.SkippedException;\n+\n+\/*\n+ * @test\n+ * @bug 8370966\n+ * @requires os.family == \"linux\"\n+ * @requires !vm.asan\n+ * @modules java.base\/jdk.internal.platform\n+ * @library \/test\/lib\n+ * @run main TestMemoryInvisibleParent\n+ *\/\n+public class TestMemoryInvisibleParent {\n+    private static final String UNLIMITED = \"-1\";\n+    private static final String imageName = Common.imageName(\"invisible-parent\");\n+\n+    public static void main(String[] args) throws Exception {\n+        Metrics metrics = Metrics.systemMetrics();\n+        if (metrics == null) {\n+            System.out.println(\"Cgroup not configured.\");\n+            return;\n+        }\n+        if (!DockerTestUtils.canTestDocker()) {\n+            System.out.println(\"Unable to run docker tests.\");\n+            return;\n+        }\n+\n+        ContainerRuntimeVersionTestUtils.checkContainerVersionSupported();\n+\n+        if (DockerTestUtils.isRootless()) {\n+            throw new SkippedException(\"Test skipped in rootless mode\");\n+        }\n+        DockerTestUtils.buildJdkContainerImage(imageName);\n+\n+        if (\"cgroupv1\".equals(metrics.getProvider())) {\n+            try {\n+                testMemoryLimitHiddenParent(\"104857600\", \"104857600\");\n+                testMemoryLimitHiddenParent(\"209715200\", \"209715200\");\n+            } finally {\n+                DockerTestUtils.removeDockerImage(imageName);\n+            }\n+        } else {\n+            throw new SkippedException(\"cgroup v1 - only test! This is \" + metrics.getProvider());\n+        }\n+    }\n+\n+    private static void testMemoryLimitHiddenParent(String valueToSet, String expectedValue)\n+            throws Exception {\n+\n+        Common.logNewTestCase(\"Cgroup V1 hidden parent memory limit: \" + valueToSet);\n+\n+        try {\n+        String cgroupParent = setParentWithLimit(valueToSet);\n+        DockerRunOptions opts = new DockerRunOptions(imageName, \"\/jdk\/bin\/java\", \"-version\", \"-Xlog:os+container=trace\");\n+        opts.appendTestJavaOptions = false;\n+        if (DockerTestUtils.isPodman()) {\n+            \/\/ Podman needs to run this test with engine option --cgroup-manager=cgroupfs\n+            opts.addEngineOpts(\"--cgroup-manager\", \"cgroupfs\");\n+        }\n+        opts.addDockerOpts(\"--cgroup-parent=\/\" + cgroupParent);\n+        Common.run(opts)\n+            .shouldContain(\"Hierarchical Memory Limit is: \" + expectedValue);\n+        } finally {\n+            \/\/ Reset the parent memory limit to unlimited (-1)\n+            setParentWithLimit(UNLIMITED);\n+        }\n+    }\n+\n+    private static String setParentWithLimit(String memLimit) throws Exception {\n+        String cgroupParent = \"hidden-parent-\" + TestMemoryInvisibleParent.class.getSimpleName() + Runtime.version().feature();\n+        Path sysFsMemory = Path.of(\"\/\", \"sys\", \"fs\", \"cgroup\", \"memory\");\n+        Path cgroupParentPath = sysFsMemory.resolve(cgroupParent);\n+        ProcessBuilder pb = new ProcessBuilder(\"mkdir\", \"-p\", cgroupParentPath.toString());\n+        OutputAnalyzer out = new OutputAnalyzer(pb.start())\n+            .shouldHaveExitValue(0);\n+        Path memoryLimitsFile = cgroupParentPath.resolve(\"memory.limit_in_bytes\");\n+        Files.writeString(memoryLimitsFile, memLimit);\n+        System.out.println(\"Cgroup parent is: \/\" + cgroupParentPath.getFileName() +\n+                           \" at \" + sysFsMemory.toString());\n+        return cgroupParent;\n+    }\n+\n+}\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestMemoryInvisibleParent.java","additions":117,"deletions":0,"binary":false,"changes":117,"status":"added"},{"patch":"@@ -49,13 +49,0 @@\n-    static String getEngineInfo(String format) throws Exception {\n-        return DockerTestUtils.execute(Container.ENGINE_COMMAND, \"info\", \"-f\", format)\n-            .getStdout();\n-    }\n-\n-    static boolean isRootless() throws Exception {\n-        \/\/ Docker and Podman have different INFO structures.\n-        \/\/ The node path for Podman is .Host.Security.Rootless, that also holds for\n-        \/\/ Podman emulating Docker CLI. The node path for Docker is .SecurityOptions.\n-        return (getEngineInfo(\"{{.Host.Security.Rootless}}\").contains(\"true\") ||\n-                getEngineInfo(\"{{.SecurityOptions}}\").contains(\"name=rootless\"));\n-    }\n-\n@@ -75,1 +62,1 @@\n-        if (isRootless()) {\n+        if (DockerTestUtils.isRootless()) {\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestMemoryWithSubgroups.java","additions":1,"deletions":14,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -50,1 +50,1 @@\n-    private static final boolean IS_PODMAN = Container.ENGINE_COMMAND.contains(\"podman\");\n+    private static final boolean IS_PODMAN = DockerTestUtils.isPodman();\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestPids.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -55,13 +55,0 @@\n-    static String getEngineInfo(String format) throws Exception {\n-        return DockerTestUtils.execute(Container.ENGINE_COMMAND, \"info\", \"-f\", format)\n-                .getStdout();\n-    }\n-\n-    static boolean isRootless() throws Exception {\n-        \/\/ Docker and Podman have different INFO structures.\n-        \/\/ The node path for Podman is .Host.Security.Rootless, that also holds for\n-        \/\/ Podman emulating Docker CLI. The node path for Docker is .SecurityOptions.\n-        return (getEngineInfo(\"{{.Host.Security.Rootless}}\").contains(\"true\") ||\n-                getEngineInfo(\"{{.SecurityOptions}}\").contains(\"name=rootless\"));\n-    }\n-\n@@ -81,1 +68,1 @@\n-        if (isRootless()) {\n+        if (DockerTestUtils.isRootless()) {\n","filename":"test\/jdk\/jdk\/internal\/platform\/docker\/TestDockerMemoryMetricsSubgroup.java","additions":1,"deletions":14,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+    public ArrayList<String> engineOpts = new ArrayList<>();\n@@ -73,0 +74,5 @@\n+    public final DockerRunOptions addEngineOpts(String... opts) {\n+        Collections.addAll(engineOpts, opts);\n+        return this;\n+    }\n+\n","filename":"test\/lib\/jdk\/test\/lib\/containers\/docker\/DockerRunOptions.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -86,0 +86,8 @@\n+    \/**\n+     * Checks if the actual engine command is podman.\n+     *\n+     * @return {@code true} if engine is podman. {@code false} otherwise.\n+     *\/\n+    public static boolean isPodman() {\n+        return Container.ENGINE_COMMAND.contains(\"podman\");\n+    }\n@@ -124,0 +132,20 @@\n+    private static String getEngineInfo(String format) throws Exception {\n+        return execute(Container.ENGINE_COMMAND, \"info\", \"-f\", format).getStdout();\n+    }\n+\n+    \/**\n+     * Determine if the engine is running in root-less mode.\n+     *\n+     * @return {@code true} when running root-less (podman or docker). {@code false}\n+     *         otherwise.\n+     *\n+     * @throws Exception\n+     *\/\n+    public static boolean isRootless() throws Exception {\n+        \/\/ Docker and Podman have different INFO structures.\n+        \/\/ The node path for Podman is .Host.Security.Rootless, that also holds for\n+        \/\/ Podman emulating Docker CLI. The node path for Docker is .SecurityOptions.\n+        return (getEngineInfo(\"{{.Host.Security.Rootless}}\").contains(\"true\") ||\n+                getEngineInfo(\"{{.SecurityOptions}}\").contains(\"name=rootless\"));\n+    }\n+\n@@ -205,0 +233,3 @@\n+        if (!opts.engineOpts.isEmpty()) {\n+            cmd.addAll(opts.engineOpts);\n+        }\n","filename":"test\/lib\/jdk\/test\/lib\/containers\/docker\/DockerTestUtils.java","additions":31,"deletions":0,"binary":false,"changes":31,"status":"modified"}]}