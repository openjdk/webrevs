{"files":[{"patch":"@@ -277,1 +277,1 @@\n-static void addIdentitiesToKeystore(JNIEnv *env, jobject keyStore)\n+static void addIdentitiesToKeystore(JNIEnv *env, jobject keyStore, jmethodID jm_createKeyEntry)\n@@ -287,9 +287,0 @@\n-    jclass jc_KeychainStore = (*env)->FindClass(env, \"apple\/security\/KeychainStore\");\n-    if (jc_KeychainStore == NULL) {\n-        goto errOut;\n-    }\n-    jmethodID jm_createKeyEntry = (*env)->GetMethodID(env, jc_KeychainStore, \"createKeyEntry\", \"(Ljava\/lang\/String;JJ[J[[B)V\");\n-    if (jm_createKeyEntry == NULL) {\n-        goto errOut;\n-    }\n-\n@@ -651,7 +642,0 @@\n-    \/\/ Look for 'identities' -- private key and certificate chain pairs -- and add those.\n-    \/\/ Search for these first, because a certificate that's found here as part of an identity will show up\n-    \/\/ again later as a certificate.\n-    addIdentitiesToKeystore(env, this);\n-\n-    JNU_CHECK_EXCEPTION(env);\n-\n@@ -666,0 +650,5 @@\n+        jmethodID jm_createKeyEntry = (*env)->GetMethodID(env, jc_KeychainStore, \"createKeyEntry\", \"(Ljava\/lang\/String;JJ[J[[B)V\");\n+        if (jm_createKeyEntry == NULL) {\n+            return;\n+        }\n+\n@@ -695,0 +684,7 @@\n+            \/\/ Look for 'identities' -- private key and certificate chain pairs -- and add those.\n+            \/\/ Search for these first, because a certificate that's found here as part of an identity will show up\n+            \/\/ again later as a certificate.\n+            addIdentitiesToKeystore(env, this, jm_createKeyEntry);\n+\n+            JNU_CHECK_EXCEPTION(env);\n+\n","filename":"src\/java.base\/macosx\/native\/libosxsecurity\/KeystoreImpl.m","additions":13,"deletions":17,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -35,1 +35,1 @@\n- * @bug 8303465\n+ * @bug 8303465 8320362\n@@ -40,0 +40,2 @@\n+ * @run main CheckMacOSKeyChainTrust KEYCHAINSTORE\n+ * @run main CheckMacOSKeyChainTrust KEYCHAINSTORE-ROOT\n@@ -46,2 +48,10 @@\n-        loadUser();\n-        loadAdmin();\n+        String keystore = args[0];\n+        if (keystore.equals(\"KEYCHAINSTORE\")) {\n+            loadUser(true);\n+            loadAdmin(true);\n+        } else {\n+            \/\/ check user and admin trustsettings to find distrusted certs\n+            loadUser(false);\n+            loadAdmin(false);\n+            loadSystem(true);\n+        }\n@@ -50,1 +60,1 @@\n-        KeyStore ks = KeyStore.getInstance(\"KEYCHAINSTORE\");\n+        KeyStore ks = KeyStore.getInstance(keystore);\n@@ -64,2 +74,6 @@\n-    private static void loadUser() throws Throwable {\n-        populate(ProcessTools.executeProcess(\"security\", \"dump-trust-settings\"));\n+    private static void loadUser(boolean addTrusted) throws Throwable {\n+        populate(ProcessTools.executeProcess(\"security\", \"dump-trust-settings\"), addTrusted);\n+    }\n+\n+    private static void loadAdmin(boolean addTrusted) throws Throwable {\n+        populate(ProcessTools.executeProcess(\"security\", \"dump-trust-settings\", \"-d\"), addTrusted);\n@@ -68,2 +82,2 @@\n-    private static void loadAdmin() throws Throwable {\n-        populate(ProcessTools.executeProcess(\"security\", \"dump-trust-settings\", \"-d\"));\n+    private static void loadSystem(boolean addTrusted) throws Throwable {\n+        populate(ProcessTools.executeProcess(\"security\", \"dump-trust-settings\", \"-s\"), addTrusted);\n@@ -72,1 +86,1 @@\n-    private static void populate(OutputAnalyzer output) throws Throwable {\n+    private static void populate(OutputAnalyzer output, boolean addTrusted) throws Throwable {\n@@ -87,1 +101,3 @@\n-                        trusted.add(certName);\n+                        if (addTrusted) {\n+                            trusted.add(certName);\n+                        }\n@@ -112,1 +128,3 @@\n-                trusted.add(certName);\n+                if (addTrusted) {\n+                    trusted.add(certName);\n+                }\n","filename":"test\/jdk\/java\/security\/KeyStore\/CheckMacOSKeyChainTrust.java","additions":29,"deletions":11,"binary":false,"changes":40,"status":"modified"}]}