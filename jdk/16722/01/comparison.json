{"files":[{"patch":"@@ -71,0 +71,1 @@\n+        boolean isReadOnly; \/\/ kSecTrustSettingsDomainSystem certificates\n@@ -140,0 +141,8 @@\n+    private void readOnlyCheck(String alias) throws KeyStoreException {\n+        String lowerAlias = alias.toLowerCase();\n+        if (entries.get(lowerAlias) instanceof TrustedCertEntry oldEntry) {\n+            if (oldEntry.isReadOnly) {\n+                throw new KeyStoreException(\"Trusted entry <\" + alias + \"> can not be modified\");\n+            }\n+        }\n+    }\n@@ -405,0 +414,2 @@\n+                readOnlyCheck(alias);\n+\n@@ -437,0 +448,2 @@\n+            } catch (KeyStoreException kse) {\n+                throw kse;\n@@ -475,0 +488,2 @@\n+            readOnlyCheck(alias);\n+\n@@ -526,0 +541,1 @@\n+            readOnlyCheck(alias);\n@@ -796,1 +812,1 @@\n-            long keychainItemRef, long creationDate, byte[] derStream) {\n+            long keychainItemRef, long creationDate, boolean isReadOnly, byte[] derStream) {\n@@ -806,0 +822,1 @@\n+            tce.isReadOnly = isReadOnly;\n","filename":"src\/java.base\/macosx\/classes\/apple\/security\/KeychainStore.java","additions":18,"deletions":1,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -422,0 +422,3 @@\n+    SecTrustSettingsDomain domains[] = {kSecTrustSettingsDomainUser, kSecTrustSettingsDomainAdmin, kSecTrustSettingsDomainSystem};\n+    int numDomains = (int)sizeof(domains);\n+    CFArrayRef currAnchors = NULL;\n@@ -429,1 +432,1 @@\n-            env, jc_KeychainStore, \"createTrustedCertEntry\", \"(Ljava\/lang\/String;Ljava\/util\/List;JJ[B)V\");\n+            env, jc_KeychainStore, \"createTrustedCertEntry\", \"(Ljava\/lang\/String;Ljava\/util\/List;JJZ[B)V\");\n@@ -474,5 +477,12 @@\n-\n-            \/\/ Load user trustSettings into inputTrust\n-            if (SecTrustSettingsCopyTrustSettings(certRef, kSecTrustSettingsDomainUser, &trustSettings) == errSecSuccess && trustSettings != NULL) {\n-                inputTrust = (*env)->NewObject(env, jc_arrayListClass, jm_arrayListCons);\n-                if (inputTrust == NULL) {\n+            for (int n = 0; n < numDomains-1; n++) {\n+                trustSettings = NULL;\n+                \/\/ Load user trustSettings into inputTrust\n+                if (SecTrustSettingsCopyTrustSettings(certRef, domains[n], &trustSettings) == errSecSuccess && trustSettings != NULL) {\n+                    if(inputTrust == NULL) {\n+                        inputTrust = (*env)->NewObject(env, jc_arrayListClass, jm_arrayListCons);\n+                    }\n+                    if (inputTrust == NULL) {\n+                        CFRelease(trustSettings);\n+                        goto errOut;\n+                    }\n+                    addTrustSettingsToInputTrust(env, jm_listAdd, trustSettings, inputTrust);\n@@ -480,1 +490,0 @@\n-                    goto errOut;\n@@ -482,2 +491,0 @@\n-                addTrustSettingsToInputTrust(env, jm_listAdd, trustSettings, inputTrust);\n-                CFRelease(trustSettings);\n@@ -485,15 +492,0 @@\n-            \/\/ Load admin trustSettings into inputTrust\n-            trustSettings = NULL;\n-            if (SecTrustSettingsCopyTrustSettings(certRef, kSecTrustSettingsDomainAdmin, &trustSettings) == errSecSuccess && trustSettings != NULL) {\n-                if (inputTrust == NULL) {\n-                    inputTrust = (*env)->NewObject(env, jc_arrayListClass, jm_arrayListCons);\n-                }\n-                if (inputTrust == NULL) {\n-                    CFRelease(trustSettings);\n-                    goto errOut;\n-                }\n-                addTrustSettingsToInputTrust(env, jm_listAdd, trustSettings, inputTrust);\n-                CFRelease(trustSettings);\n-            }\n-\n-            \/\/ Only add certificates with trust settings\n@@ -509,1 +501,1 @@\n-            (*env)->CallVoidMethod(env, keyStore, jm_createTrustedCertEntry, alias, inputTrust, nativeRef, creationDate, certData);\n+            (*env)->CallVoidMethod(env, keyStore, jm_createTrustedCertEntry, alias, inputTrust, nativeRef, creationDate, JNI_FALSE, certData);\n@@ -516,0 +508,57 @@\n+    \/\/ Read Trust Anchors\n+    if(SecTrustCopyAnchorCertificates(&currAnchors) == errSecSuccess) {\n+        CFIndex i, nAnchors = CFArrayGetCount(currAnchors);\n+\n+        for (i = 0; i < nAnchors; i++) {\n+            SecCertificateRef certRef = (SecCertificateRef)CFArrayGetValueAtIndex(currAnchors, i);\n+            CSSM_DATA currCertificate;\n+            err = SecCertificateGetData(certRef, &currCertificate);\n+            jbyteArray certData = (*env)->NewByteArray(env, currCertificate.Length);\n+            if (certData == NULL) {\n+                goto errOut;\n+            }\n+            (*env)->SetByteArrayRegion(env, certData, 0, currCertificate.Length, (jbyte *)currCertificate.Data);\n+\n+            \/\/ Find the label.  It's a 'blob', but we interpret as characters.\n+            jstring alias = getLabelFromItem(env, (SecKeychainItemRef)certRef);\n+            if (alias == NULL) {\n+                goto errOut;\n+            }\n+\n+            \/\/ See KeychainStore::createTrustedCertEntry for content of inputTrust for system root certs\n+            \/\/ This time we load trust settings from domains kSecTrustSettingsDomainUser,\n+            \/\/ kSecTrustSettingsDomainAdmin and kSecTrustSettingsDomainSystem\n+            jobject inputTrust = NULL;\n+            CFArrayRef trustSettings = NULL;\n+            for (int n = 0; n < numDomains; n++) {\n+                trustSettings = NULL;\n+                \/\/ Load user trustSettings into inputTrust\n+                if (SecTrustSettingsCopyTrustSettings(certRef, domains[n], &trustSettings) == errSecSuccess && trustSettings != NULL) {\n+                    if(inputTrust == NULL) {\n+                        inputTrust = (*env)->NewObject(env, jc_arrayListClass, jm_arrayListCons);\n+                    }\n+                    if (inputTrust == NULL) {\n+                        CFRelease(trustSettings);\n+                        goto errOut;\n+                    }\n+                    addTrustSettingsToInputTrust(env, jm_listAdd, trustSettings, inputTrust);\n+                    CFRelease(trustSettings);\n+                }\n+            }\n+            if (inputTrust == NULL)\n+                continue;\n+\n+            \/\/ Find the creation date.\n+            jlong creationDate = getModDateFromItem(env, theItem);\n+\n+            \/\/ Call back to the Java object to create Java objects corresponding to this security object.\n+            jlong nativeRef = ptr_to_jlong(certRef);\n+            (*env)->CallVoidMethod(env, keyStore, jm_createTrustedCertEntry, alias, inputTrust, nativeRef, creationDate, JNI_TRUE, certData);\n+            if ((*env)->ExceptionCheck(env)) {\n+                goto errOut;\n+            }\n+            CFRetain(certRef);\n+        }\n+\n+    }\n+\n@@ -520,0 +569,3 @@\n+    if (currAnchors != NULL) {\n+        CFRelease(currAnchors);\n+    }\n","filename":"src\/java.base\/macosx\/native\/libosxsecurity\/KeystoreImpl.m","additions":77,"deletions":25,"binary":false,"changes":102,"status":"modified"}]}