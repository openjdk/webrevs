{"files":[{"patch":"@@ -136,4 +136,7 @@\n-        long rss = WhiteBox.getWhiteBox().rss();\n-        System.out.println(\"RSS: \" + rss);\n-        long available = WhiteBox.getWhiteBox().hostAvailableMemory();\n-        System.out.println(\"Host available memory: \" + available);\n+        int maxIter = 20;\n+        \/\/ RSS values we get are sometimes somewhat delayed or inaccurate\n+        for (int iter=0; iter < maxIter; iter++) {\n+            long rss = WhiteBox.getWhiteBox().rss();\n+            System.out.println(\"RSS: \" + rss);\n+            long available = WhiteBox.getWhiteBox().hostAvailableMemory();\n+            System.out.println(\"Host available memory: \" + available);\n@@ -141,1 +144,1 @@\n-        long heapSize = 256 * 1024 * 1024;\n+            long heapSize = 256 * 1024 * 1024;\n@@ -143,4 +146,4 @@\n-        \/\/ On Linux, a JVM that runs with 256M pre-committed heap will use about 60MB (release JVM) RSS. Barring\n-        \/\/ memory pressure that causes us to lose RSS, pretouching should increase RSS to >256MB. So there should be a\n-        \/\/ clear distinction between non-pretouched and pretouched.\n-        long minRequiredRss = heapSize;\n+            \/\/ On Linux, a JVM that runs with 256M pre-committed heap will use about 60MB (release JVM) RSS. Barring\n+            \/\/ memory pressure that causes us to lose RSS, pretouching should increase RSS to >256MB. So there should be a\n+            \/\/ clear distinction between non-pretouched and pretouched.\n+            long minRequiredRss = heapSize;\n@@ -148,11 +151,17 @@\n-        \/\/ The minimum required available memory size to count test errors as errors (to somewhat safely disregard\n-        \/\/ outside memory pressure as the culprit). We are over-cautious and require at least 1G free. We rather err\n-        \/\/ on the side of disregarding true errors than to produce false positives (if pretouching is broken, at least\n-        \/\/ some of the runs of this test will run on beefy enough machines and show the test as failed).\n-        long requiredAvailable = 1024 * 1024 * 1024;\n-        if (rss == 0) {\n-            throw new SkippedException(\"cannot get RSS?\");\n-        }\n-        if (available > requiredAvailable) {\n-            Asserts.assertGreaterThan(rss, minRequiredRss, \"RSS of this process(\" + rss + \"b) should be bigger \" +\n-                                      \"than or equal to heap size(\" + heapSize + \"b) (available memory: \" + available + \"). On Linux Kernel < 4.14 RSS can be inaccurate\");\n+            \/\/ The minimum required available memory size to count test errors as errors (to somewhat safely disregard\n+            \/\/ outside memory pressure as the culprit). We are over-cautious and require at least 1G free. We rather err\n+            \/\/ on the side of disregarding true errors than to produce false positives (if pretouching is broken, at least\n+            \/\/ some of the runs of this test will run on beefy enough machines and show the test as failed).\n+            long requiredAvailable = 1024 * 1024 * 1024;\n+            if (rss == 0) {\n+                throw new SkippedException(\"cannot get RSS?\");\n+            }\n+            if (available > requiredAvailable) {\n+                if ((rss < minRequiredRss) && iter < maxIter-1) {\n+                    System.out.println(\"We got only an RSS value of \" + rss + \" but require \" + minRequiredRss + \", let's retry!\");\n+                } else {\n+                    Asserts.assertGreaterThan(rss, minRequiredRss, \"RSS of this process(\" + rss + \"b) should be bigger \" +\n+                                              \"than or equal to heap size(\" + heapSize + \"b) (available memory: \" + available + \"). On Linux Kernel < 4.14 RSS can be inaccurate\");\n+                    break;\n+                }\n+            }\n","filename":"test\/hotspot\/jtreg\/gc\/TestAlwaysPreTouchBehavior.java","additions":29,"deletions":20,"binary":false,"changes":49,"status":"modified"}]}