{"files":[{"patch":"@@ -58,0 +58,3 @@\n+                                                                            \\\n+  product(bool, StressMacroExpansion, false, DIAGNOSTIC,                    \\\n+          \"Randomize macro node expansion order\")                           \\\n","filename":"src\/hotspot\/share\/opto\/c2_globals.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -847,1 +847,2 @@\n-  if (StressLCM || StressGCM || StressIGVN || StressCCP || StressIncrementalInlining) {\n+  if (StressLCM || StressGCM || StressIGVN || StressCCP ||\n+      StressIncrementalInlining || StressMacroExpansion) {\n@@ -2454,0 +2455,1 @@\n+    print_method(PHASE_BEFORE_MACRO_EXPANSION, 3);\n@@ -2459,1 +2461,1 @@\n-    print_method(PHASE_MACRO_EXPANSION, 2);\n+    print_method(PHASE_AFTER_MACRO_EXPANSION, 2);\n@@ -5124,0 +5126,10 @@\n+void Compile::shuffle_macro_nodes() {\n+  if (_macro_nodes.length() < 2) {\n+    return;\n+  }\n+  for (uint i = _macro_nodes.length() - 1; i >= 1; i--) {\n+    uint j = C->random() % (i + 1);\n+    swap(_macro_nodes.at(i), _macro_nodes.at(j));\n+  }\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/compile.cpp","additions":14,"deletions":2,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -797,0 +797,1 @@\n+  void shuffle_macro_nodes();\n","filename":"src\/hotspot\/share\/opto\/compile.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -2433,0 +2433,3 @@\n+  if (StressMacroExpansion) {\n+    C->shuffle_macro_nodes();\n+  }\n@@ -2514,0 +2517,3 @@\n+      if (success) {\n+        C->print_method(PHASE_AFTER_MACRO_EXPANSION_ELIMINATE, 4, n);\n+      }\n@@ -2574,0 +2580,1 @@\n+    C->print_method(PHASE_AFTER_MACRO_EXPANSION_ARRAYCOPY, 4, n);\n@@ -2616,0 +2623,1 @@\n+    C->print_method(PHASE_AFTER_MACRO_EXPANSION_ALLOCATE, 4, n);\n","filename":"src\/hotspot\/share\/opto\/macro.cpp","additions":9,"deletions":1,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2012, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2012, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -31,71 +31,75 @@\n-  flags(BEFORE_STRINGOPTS,              \"Before StringOpts\") \\\n-  flags(AFTER_STRINGOPTS,               \"After StringOpts\") \\\n-  flags(BEFORE_REMOVEUSELESS,           \"Before RemoveUseless\") \\\n-  flags(AFTER_PARSING,                  \"After Parsing\") \\\n-  flags(BEFORE_ITER_GVN,                \"Before Iter GVN\") \\\n-  flags(ITER_GVN1,                      \"Iter GVN 1\") \\\n-  flags(AFTER_ITER_GVN_STEP,            \"After Iter GVN Step\") \\\n-  flags(AFTER_ITER_GVN,                 \"After Iter GVN\") \\\n-  flags(INCREMENTAL_INLINE_STEP,        \"Incremental Inline Step\") \\\n-  flags(INCREMENTAL_INLINE_CLEANUP,     \"Incremental Inline Cleanup\") \\\n-  flags(INCREMENTAL_INLINE,             \"Incremental Inline\") \\\n-  flags(INCREMENTAL_BOXING_INLINE,      \"Incremental Boxing Inline\") \\\n-  flags(EXPAND_VUNBOX,                  \"Expand VectorUnbox\") \\\n-  flags(SCALARIZE_VBOX,                 \"Scalarize VectorBox\") \\\n-  flags(INLINE_VECTOR_REBOX,            \"Inline Vector Rebox Calls\") \\\n-  flags(EXPAND_VBOX,                    \"Expand VectorBox\") \\\n-  flags(ELIMINATE_VBOX_ALLOC,           \"Eliminate VectorBoxAllocate\") \\\n-  flags(ITER_GVN_BEFORE_EA,             \"Iter GVN before EA\") \\\n-  flags(ITER_GVN_AFTER_VECTOR,          \"Iter GVN after vector box elimination\") \\\n-  flags(BEFORE_BEAUTIFY_LOOPS,          \"Before beautify loops\") \\\n-  flags(AFTER_BEAUTIFY_LOOPS,           \"After beautify loops\") \\\n-  flags(BEFORE_LOOP_UNROLLING,          \"Before Loop Unrolling\") \\\n-  flags(AFTER_LOOP_UNROLLING,           \"After Loop Unrolling\") \\\n-  flags(BEFORE_SPLIT_IF,                \"Before Split-If\") \\\n-  flags(AFTER_SPLIT_IF,                 \"After Split-If\") \\\n-  flags(BEFORE_LOOP_PREDICATION_IC,     \"Before Loop Predication IC\") \\\n-  flags(AFTER_LOOP_PREDICATION_IC,      \"After Loop Predication IC\") \\\n-  flags(BEFORE_LOOP_PREDICATION_RC,     \"Before Loop Predication RC\") \\\n-  flags(AFTER_LOOP_PREDICATION_RC,      \"After Loop Predication RC\") \\\n-  flags(BEFORE_PARTIAL_PEELING,         \"Before Partial Peeling\") \\\n-  flags(AFTER_PARTIAL_PEELING,          \"After Partial Peeling\") \\\n-  flags(BEFORE_LOOP_PEELING,            \"Before Loop Peeling\") \\\n-  flags(AFTER_LOOP_PEELING,             \"After Loop Peeling\") \\\n-  flags(BEFORE_LOOP_UNSWITCHING,        \"Before Loop Unswitching\") \\\n-  flags(AFTER_LOOP_UNSWITCHING,         \"After Loop Unswitching\") \\\n-  flags(BEFORE_RANGE_CHECK_ELIMINATION, \"Before Range Check Elimination\") \\\n-  flags(AFTER_RANGE_CHECK_ELIMINATION,  \"After Range Check Elimination\") \\\n-  flags(BEFORE_PRE_MAIN_POST,           \"Before Pre\/Main\/Post Loops\") \\\n-  flags(AFTER_PRE_MAIN_POST,            \"After Pre\/Main\/Post Loops\") \\\n-  flags(SUPERWORD1_BEFORE_SCHEDULE,     \"Superword 1, Before Schedule\") \\\n-  flags(SUPERWORD2_BEFORE_OUTPUT,       \"Superword 2, Before Output\") \\\n-  flags(SUPERWORD3_AFTER_OUTPUT,        \"Superword 3, After Output\") \\\n-  flags(BEFORE_CLOOPS,                  \"Before CountedLoop\") \\\n-  flags(AFTER_CLOOPS,                   \"After CountedLoop\") \\\n-  flags(PHASEIDEAL_BEFORE_EA,           \"PhaseIdealLoop before EA\") \\\n-  flags(AFTER_EA,                       \"After Escape Analysis\") \\\n-  flags(ITER_GVN_AFTER_EA,              \"Iter GVN after EA\") \\\n-  flags(ITER_GVN_AFTER_ELIMINATION,     \"Iter GVN after eliminating allocations and locks\") \\\n-  flags(PHASEIDEALLOOP1,                \"PhaseIdealLoop 1\") \\\n-  flags(PHASEIDEALLOOP2,                \"PhaseIdealLoop 2\") \\\n-  flags(PHASEIDEALLOOP3,                \"PhaseIdealLoop 3\") \\\n-  flags(BEFORE_CCP1,                    \"Before PhaseCCP 1\") \\\n-  flags(CCP1,                           \"PhaseCCP 1\") \\\n-  flags(ITER_GVN2,                      \"Iter GVN 2\") \\\n-  flags(PHASEIDEALLOOP_ITERATIONS,      \"PhaseIdealLoop iterations\") \\\n-  flags(MACRO_EXPANSION,                \"Macro expand\") \\\n-  flags(BARRIER_EXPANSION,              \"Barrier expand\") \\\n-  flags(OPTIMIZE_FINISHED,              \"Optimize finished\") \\\n-  flags(BEFORE_MATCHING,                \"Before matching\") \\\n-  flags(MATCHING,                       \"After matching\") \\\n-  flags(GLOBAL_CODE_MOTION,             \"Global code motion\") \\\n-  flags(REGISTER_ALLOCATION,            \"Register Allocation\") \\\n-  flags(BLOCK_ORDERING,                 \"Block Ordering\") \\\n-  flags(PEEPHOLE,                       \"Peephole\") \\\n-  flags(POSTALLOC_EXPAND,               \"Post-Allocation Expand\") \\\n-  flags(MACH_ANALYSIS,                  \"After mach analysis\") \\\n-  flags(FINAL_CODE,                     \"Final Code\") \\\n-  flags(END,                            \"End\") \\\n-  flags(FAILURE,                        \"Failure\") \\\n-  flags(ALL,                            \"All\") \\\n-  flags(DEBUG,                          \"Debug\")\n+  flags(BEFORE_STRINGOPTS,               \"Before StringOpts\") \\\n+  flags(AFTER_STRINGOPTS,                \"After StringOpts\") \\\n+  flags(BEFORE_REMOVEUSELESS,            \"Before RemoveUseless\") \\\n+  flags(AFTER_PARSING,                   \"After Parsing\") \\\n+  flags(BEFORE_ITER_GVN,                 \"Before Iter GVN\") \\\n+  flags(ITER_GVN1,                       \"Iter GVN 1\") \\\n+  flags(AFTER_ITER_GVN_STEP,             \"After Iter GVN Step\") \\\n+  flags(AFTER_ITER_GVN,                  \"After Iter GVN\") \\\n+  flags(INCREMENTAL_INLINE_STEP,         \"Incremental Inline Step\") \\\n+  flags(INCREMENTAL_INLINE_CLEANUP,      \"Incremental Inline Cleanup\") \\\n+  flags(INCREMENTAL_INLINE,              \"Incremental Inline\") \\\n+  flags(INCREMENTAL_BOXING_INLINE,       \"Incremental Boxing Inline\") \\\n+  flags(EXPAND_VUNBOX,                   \"Expand VectorUnbox\") \\\n+  flags(SCALARIZE_VBOX,                  \"Scalarize VectorBox\") \\\n+  flags(INLINE_VECTOR_REBOX,             \"Inline Vector Rebox Calls\") \\\n+  flags(EXPAND_VBOX,                     \"Expand VectorBox\") \\\n+  flags(ELIMINATE_VBOX_ALLOC,            \"Eliminate VectorBoxAllocate\") \\\n+  flags(ITER_GVN_BEFORE_EA,              \"Iter GVN before EA\") \\\n+  flags(ITER_GVN_AFTER_VECTOR,           \"Iter GVN after vector box elimination\") \\\n+  flags(BEFORE_BEAUTIFY_LOOPS,           \"Before beautify loops\") \\\n+  flags(AFTER_BEAUTIFY_LOOPS,            \"After beautify loops\") \\\n+  flags(BEFORE_LOOP_UNROLLING,           \"Before Loop Unrolling\") \\\n+  flags(AFTER_LOOP_UNROLLING,            \"After Loop Unrolling\") \\\n+  flags(BEFORE_SPLIT_IF,                 \"Before Split-If\") \\\n+  flags(AFTER_SPLIT_IF,                  \"After Split-If\") \\\n+  flags(BEFORE_LOOP_PREDICATION_IC,      \"Before Loop Predication IC\") \\\n+  flags(AFTER_LOOP_PREDICATION_IC,       \"After Loop Predication IC\") \\\n+  flags(BEFORE_LOOP_PREDICATION_RC,      \"Before Loop Predication RC\") \\\n+  flags(AFTER_LOOP_PREDICATION_RC,       \"After Loop Predication RC\") \\\n+  flags(BEFORE_PARTIAL_PEELING,          \"Before Partial Peeling\") \\\n+  flags(AFTER_PARTIAL_PEELING,           \"After Partial Peeling\") \\\n+  flags(BEFORE_LOOP_PEELING,             \"Before Loop Peeling\") \\\n+  flags(AFTER_LOOP_PEELING,              \"After Loop Peeling\") \\\n+  flags(BEFORE_LOOP_UNSWITCHING,         \"Before Loop Unswitching\") \\\n+  flags(AFTER_LOOP_UNSWITCHING,          \"After Loop Unswitching\") \\\n+  flags(BEFORE_RANGE_CHECK_ELIMINATION,  \"Before Range Check Elimination\") \\\n+  flags(AFTER_RANGE_CHECK_ELIMINATION,   \"After Range Check Elimination\") \\\n+  flags(BEFORE_PRE_MAIN_POST,            \"Before Pre\/Main\/Post Loops\") \\\n+  flags(AFTER_PRE_MAIN_POST,             \"After Pre\/Main\/Post Loops\") \\\n+  flags(SUPERWORD1_BEFORE_SCHEDULE,      \"Superword 1, Before Schedule\") \\\n+  flags(SUPERWORD2_BEFORE_OUTPUT,        \"Superword 2, Before Output\") \\\n+  flags(SUPERWORD3_AFTER_OUTPUT,         \"Superword 3, After Output\") \\\n+  flags(BEFORE_CLOOPS,                   \"Before CountedLoop\") \\\n+  flags(AFTER_CLOOPS,                    \"After CountedLoop\") \\\n+  flags(PHASEIDEAL_BEFORE_EA,            \"PhaseIdealLoop before EA\") \\\n+  flags(AFTER_EA,                        \"After Escape Analysis\") \\\n+  flags(ITER_GVN_AFTER_EA,               \"Iter GVN after EA\") \\\n+  flags(ITER_GVN_AFTER_ELIMINATION,      \"Iter GVN after eliminating allocations and locks\") \\\n+  flags(PHASEIDEALLOOP1,                 \"PhaseIdealLoop 1\") \\\n+  flags(PHASEIDEALLOOP2,                 \"PhaseIdealLoop 2\") \\\n+  flags(PHASEIDEALLOOP3,                 \"PhaseIdealLoop 3\") \\\n+  flags(BEFORE_CCP1,                     \"Before PhaseCCP 1\") \\\n+  flags(CCP1,                            \"PhaseCCP 1\") \\\n+  flags(ITER_GVN2,                       \"Iter GVN 2\") \\\n+  flags(PHASEIDEALLOOP_ITERATIONS,       \"PhaseIdealLoop iterations\") \\\n+  flags(BEFORE_MACRO_EXPANSION ,         \"Before Macro Expansion\") \\\n+  flags(AFTER_MACRO_EXPANSION_ELIMINATE, \"After Eliminate Macro Expansion\") \\\n+  flags(AFTER_MACRO_EXPANSION_ARRAYCOPY, \"After ArrayCopy Macro Expansion\") \\\n+  flags(AFTER_MACRO_EXPANSION_ALLOCATE,  \"After Allocate Macro Expansion\") \\\n+  flags(AFTER_MACRO_EXPANSION,           \"After Macro Expansion\") \\\n+  flags(BARRIER_EXPANSION,               \"Barrier expand\") \\\n+  flags(OPTIMIZE_FINISHED,               \"Optimize finished\") \\\n+  flags(BEFORE_MATCHING,                 \"Before matching\") \\\n+  flags(MATCHING,                        \"After matching\") \\\n+  flags(GLOBAL_CODE_MOTION,              \"Global code motion\") \\\n+  flags(REGISTER_ALLOCATION,             \"Register Allocation\") \\\n+  flags(BLOCK_ORDERING,                  \"Block Ordering\") \\\n+  flags(PEEPHOLE,                        \"Peephole\") \\\n+  flags(POSTALLOC_EXPAND,                \"Post-Allocation Expand\") \\\n+  flags(MACH_ANALYSIS,                   \"After mach analysis\") \\\n+  flags(FINAL_CODE,                      \"Final Code\") \\\n+  flags(END,                             \"End\") \\\n+  flags(FAILURE,                         \"Failure\") \\\n+  flags(ALL,                             \"All\") \\\n+  flags(DEBUG,                           \"Debug\")\n","filename":"src\/hotspot\/share\/opto\/phasetype.hpp","additions":76,"deletions":72,"binary":false,"changes":148,"status":"modified"},{"patch":"@@ -33,1 +33,2 @@\n-* `N=4`: additionally, after every loop optimization\n+* `N=4`: additionally, after individual steps within phases. Currently: loop\n+  optimizations, macro expansions.\n","filename":"src\/utils\/IdealGraphVisualizer\/README.md","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -27,1 +27,1 @@\n- * @bug 8252219 8256535\n+ * @bug 8252219 8256535 8317349\n@@ -47,0 +47,4 @@\n+ * @run main\/othervm -XX:+UnlockDiagnosticVMOptions -XX:+StressMacroExpansion\n+ *      compiler.arguments.TestStressOptions\n+ * @run main\/othervm -XX:+UnlockDiagnosticVMOptions -XX:+StressMacroExpansion -XX:StressSeed=42\n+ *      compiler.arguments.TestStressOptions\n","filename":"test\/hotspot\/jtreg\/compiler\/arguments\/TestStressOptions.java","additions":6,"deletions":2,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/TestModDivTopInput.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -73,1 +73,1 @@\n-    @IR(phase = { CompilePhase.MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"2\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\" })\n+    @IR(phase = { CompilePhase.AFTER_MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"2\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\" })\n@@ -106,1 +106,1 @@\n-    @IR(phase = { CompilePhase.MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"2\", IRNode.LOAD_KLASS_OR_NKLASS, \"1\" })\n+    @IR(phase = { CompilePhase.AFTER_MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"2\", IRNode.LOAD_KLASS_OR_NKLASS, \"1\" })\n@@ -124,1 +124,1 @@\n-    @IR(phase = { CompilePhase.MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"3\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\", IRNode.PARTIAL_SUBTYPE_CHECK, \"1\" })\n+    @IR(phase = { CompilePhase.AFTER_MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"3\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\", IRNode.PARTIAL_SUBTYPE_CHECK, \"1\" })\n@@ -141,1 +141,1 @@\n-    @IR(phase = { CompilePhase.MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"5\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\", IRNode.PARTIAL_SUBTYPE_CHECK, \"1\" })\n+    @IR(phase = { CompilePhase.AFTER_MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"5\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\", IRNode.PARTIAL_SUBTYPE_CHECK, \"1\" })\n@@ -156,1 +156,1 @@\n-    @IR(phase = { CompilePhase.MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"2\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\" }, failOn = { IRNode.PARTIAL_SUBTYPE_CHECK })\n+    @IR(phase = { CompilePhase.AFTER_MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"2\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\" }, failOn = { IRNode.PARTIAL_SUBTYPE_CHECK })\n@@ -172,1 +172,1 @@\n-    @IR(phase = { CompilePhase.MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"5\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\", IRNode.PARTIAL_SUBTYPE_CHECK, \"1\" })\n+    @IR(phase = { CompilePhase.AFTER_MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"5\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\", IRNode.PARTIAL_SUBTYPE_CHECK, \"1\" })\n@@ -187,1 +187,1 @@\n-    @IR(phase = { CompilePhase.MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"5\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\", IRNode.PARTIAL_SUBTYPE_CHECK, \"1\" })\n+    @IR(phase = { CompilePhase.AFTER_MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"5\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\", IRNode.PARTIAL_SUBTYPE_CHECK, \"1\" })\n@@ -397,1 +397,1 @@\n-    @IR(phase = { CompilePhase.MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"5\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\", IRNode.PARTIAL_SUBTYPE_CHECK, \"1\" })\n+    @IR(phase = { CompilePhase.AFTER_MACRO_EXPANSION }, counts = { IRNode.CMP_P, \"5\", IRNode.LOAD_KLASS_OR_NKLASS, \"2\", IRNode.PARTIAL_SUBTYPE_CHECK, \"1\" })\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/ProfileAtTypeCheck.java","additions":8,"deletions":8,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -42,0 +42,1 @@\n+ * @run driver compiler.debug.TestGenerateStressSeed StressMacroExpansion\n","filename":"test\/hotspot\/jtreg\/compiler\/debug\/TestGenerateStressSeed.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,91 @@\n+\/*\n+ * Copyright (c) 2020, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package compiler.debug;\n+\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+import jdk.test.lib.Asserts;\n+\n+\/*\n+ * @test\n+ * @key stress randomness\n+ * @bug 8252219 8256535 8317349\n+ * @requires vm.debug == true & vm.compiler2.enabled\n+ * @summary Tests that stress compilations with the same seed yield the same\n+ *          IGVN, CCP, and macro expansion traces.\n+ * @library \/test\/lib \/\n+ * @run driver compiler.debug.TestStress\n+ *\/\n+\n+public class TestStress {\n+\n+    static String phaseTrace(String stressOption, String traceOption,\n+                             int stressSeed) throws Exception {\n+        String className = TestStress.class.getName();\n+        String[] procArgs = {\n+            \"-Xcomp\", \"-XX:-TieredCompilation\", \"-XX:-Inline\", \"-XX:+CICountNative\",\n+            \"-XX:CompileOnly=\" + className + \"::sum\", \"-XX:\" + traceOption,\n+            \"-XX:+\" + stressOption, \"-XX:StressSeed=\" + stressSeed,\n+            className, \"10\"};\n+        ProcessBuilder pb  = ProcessTools.createLimitedTestJavaProcessBuilder(procArgs);\n+        OutputAnalyzer out = new OutputAnalyzer(pb.start());\n+        out.shouldHaveExitValue(0);\n+        return out.getStdout();\n+    }\n+\n+    static String igvnTrace(int stressSeed) throws Exception {\n+        return phaseTrace(\"StressIGVN\", \"+TraceIterativeGVN\", stressSeed);\n+    }\n+\n+    static String ccpTrace(int stressSeed) throws Exception {\n+        return phaseTrace(\"StressCCP\", \"+TracePhaseCCP\", stressSeed);\n+    }\n+\n+    static String macroExpansionTrace(int stressSeed) throws Exception {\n+        return phaseTrace(\"StressMacroExpansion\",\n+                          \"CompileCommand=PrintIdealPhase,*::*,AFTER_MACRO_EXPANSION_ELIMINATE,AFTER_MACRO_EXPANSION_ARRAYCOPY,AFTER_MACRO_EXPANSION_ALLOCATE\",\n+                          stressSeed);\n+    }\n+\n+    static void sum(int n) {\n+        int acc = 0;\n+        for (int i = 0; i < n; i++) acc += i;\n+        System.out.println(acc);\n+    }\n+\n+    public static void main(String[] args) throws Exception {\n+        if (args.length == 0) {\n+            for (int s = 0; s < 10; s++) {\n+                Asserts.assertEQ(igvnTrace(s), igvnTrace(s),\n+                    \"got different IGVN traces for the same seed\");\n+                Asserts.assertEQ(ccpTrace(s), ccpTrace(s),\n+                    \"got different CCP traces for the same seed\");\n+                Asserts.assertEQ(macroExpansionTrace(s), macroExpansionTrace(s),\n+                    \"got different macro expansion traces for the same seed\");\n+            }\n+        } else if (args.length > 0) {\n+            sum(Integer.parseInt(args[0]));\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/compiler\/debug\/TestStress.java","additions":91,"deletions":0,"binary":false,"changes":91,"status":"added"},{"patch":"@@ -1,83 +0,0 @@\n-\/*\n- * Copyright (c) 2020, 2023, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-package compiler.debug;\n-\n-import jdk.test.lib.process.OutputAnalyzer;\n-import jdk.test.lib.process.ProcessTools;\n-import jdk.test.lib.Asserts;\n-\n-\/*\n- * @test\n- * @key stress randomness\n- * @bug 8252219 8256535\n- * @requires vm.debug == true & vm.compiler2.enabled\n- * @summary Tests that stress compilations with the same seed yield the same\n- *          IGVN and CCP traces.\n- * @library \/test\/lib \/\n- * @run driver compiler.debug.TestStressIGVNAndCCP\n- *\/\n-\n-public class TestStressIGVNAndCCP {\n-\n-    static String phaseTrace(String stressOption, String traceOption,\n-                             int stressSeed) throws Exception {\n-        String className = TestStressIGVNAndCCP.class.getName();\n-        String[] procArgs = {\n-            \"-Xcomp\", \"-XX:-TieredCompilation\", \"-XX:-Inline\", \"-XX:+CICountNative\",\n-            \"-XX:CompileOnly=\" + className + \"::sum\", \"-XX:+\" + traceOption,\n-            \"-XX:+\" + stressOption, \"-XX:StressSeed=\" + stressSeed,\n-            className, \"10\"};\n-        ProcessBuilder pb  = ProcessTools.createLimitedTestJavaProcessBuilder(procArgs);\n-        OutputAnalyzer out = new OutputAnalyzer(pb.start());\n-        out.shouldHaveExitValue(0);\n-        return out.getStdout();\n-    }\n-\n-    static String igvnTrace(int stressSeed) throws Exception {\n-        return phaseTrace(\"StressIGVN\", \"TraceIterativeGVN\", stressSeed);\n-    }\n-\n-    static String ccpTrace(int stressSeed) throws Exception {\n-        return phaseTrace(\"StressCCP\", \"TracePhaseCCP\", stressSeed);\n-    }\n-\n-    static void sum(int n) {\n-        int acc = 0;\n-        for (int i = 0; i < n; i++) acc += i;\n-        System.out.println(acc);\n-    }\n-\n-    public static void main(String[] args) throws Exception {\n-        if (args.length == 0) {\n-            for (int s = 0; s < 10; s++) {\n-                Asserts.assertEQ(igvnTrace(s), igvnTrace(s),\n-                    \"got different IGVN traces for the same seed\");\n-                Asserts.assertEQ(ccpTrace(s), ccpTrace(s),\n-                    \"got different CCP traces for the same seed\");\n-            }\n-        } else if (args.length > 0) {\n-            sum(Integer.parseInt(args[0]));\n-        }\n-    }\n-}\n","filename":"test\/hotspot\/jtreg\/compiler\/debug\/TestStressIGVNAndCCP.java","additions":0,"deletions":83,"binary":false,"changes":83,"status":"deleted"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -98,1 +98,5 @@\n-    MACRO_EXPANSION(\"Macro expand\"),\n+    BEFORE_MACRO_EXPANSION(\"Before Macro Expansion\"),\n+    AFTER_MACRO_EXPANSION_ELIMINATE(\"After Eliminate Macro Expansion\"),\n+    AFTER_MACRO_EXPANSION_ARRAYCOPY(\"After ArrayCopy Macro Expansion\"),\n+    AFTER_MACRO_EXPANSION_ALLOCATE(\"After Allocate Macro Expansion\"),\n+    AFTER_MACRO_EXPANSION(\"After Macro Expansion\"),\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/CompilePhase.java","additions":6,"deletions":2,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2236,1 +2236,1 @@\n-                                                                          CompilePhase.MACRO_EXPANSION,\n+                                                                          CompilePhase.AFTER_MACRO_EXPANSION,\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/IRNode.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n","filename":"test\/hotspot\/jtreg\/compiler\/loopopts\/TestPeelingSkeletonPredicateInitialization.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -301,0 +301,1 @@\n+                \"-XX:+StressMacroExpansion\",\n","filename":"test\/hotspot\/jtreg\/testlibrary\/ctw\/src\/sun\/hotspot\/tools\/ctw\/CtwRunner.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -1098,1 +1098,1 @@\n-    @IR(failOn = IRNode.ALLOC, phase = {CompilePhase.FINAL_CODE, CompilePhase.MACRO_EXPANSION})\n+    @IR(failOn = IRNode.ALLOC, phase = {CompilePhase.FINAL_CODE, CompilePhase.AFTER_MACRO_EXPANSION})\n@@ -1102,1 +1102,1 @@\n-    @IR(failOn = IRNode.ALLOC_ARRAY, phase = {CompilePhase.FINAL_CODE, CompilePhase.MACRO_EXPANSION})\n+    @IR(failOn = IRNode.ALLOC_ARRAY, phase = {CompilePhase.FINAL_CODE, CompilePhase.AFTER_MACRO_EXPANSION})\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/tests\/TestBadFormat.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"}]}