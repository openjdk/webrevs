{"files":[{"patch":"@@ -165,2 +165,2 @@\n-     * @throws IllegalStateException if recording is already started, is in the\n-     *         {@code CLOSED} state, or if the flight recorder is shutdown\n+     * @throws IllegalStateException if recording is already started or is in the\n+     *         {@code CLOSED} state\n","filename":"src\/jdk.jfr\/share\/classes\/jdk\/jfr\/Recording.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -560,0 +560,1 @@\n+        copy.setDummyRecording(r.isDummyRecording());\n","filename":"src\/jdk.jfr\/share\/classes\/jdk\/jfr\/internal\/PlatformRecorder.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -96,0 +96,1 @@\n+    private boolean dummyRecording = false;\n@@ -107,4 +108,0 @@\n-            if (PlatformRecorder.isInShutDown()) {\n-                throw new IllegalStateException(\"Flight recorder is already shutdown\");\n-            }\n-\n@@ -120,0 +117,10 @@\n+\n+            if (PlatformRecorder.isInShutDown()) {\n+                dummyRecording = true;\n+                startTime = Instant.now();\n+                newState = RecordingState.RUNNING;\n+                setState(newState);\n+                notifyIfStateChanged(oldState, newState);\n+                return (startTime.getEpochSecond() * 1_000_000_000) + startTime.getNano();\n+            }\n+\n@@ -166,0 +173,6 @@\n+            if (dummyRecording) {\n+                newState = RecordingState.STOPPED;\n+                setState(newState);\n+                notifyIfStateChanged(oldState, newState);\n+                return true;\n+            }\n@@ -364,0 +377,1 @@\n+        clone.setDummyRecording(isDummyRecording());\n@@ -515,1 +529,1 @@\n-            if (getState() == RecordingState.RUNNING && update) {\n+            if (getState() == RecordingState.RUNNING && update && !dummyRecording) {\n@@ -571,1 +585,1 @@\n-            if (!toDisk) {\n+            if (!toDisk || dummyRecording) {\n@@ -724,0 +738,8 @@\n+    boolean isDummyRecording() {\n+        return dummyRecording;\n+    }\n+\n+    void setDummyRecording(boolean dummyRecording) {\n+        this.dummyRecording = dummyRecording;\n+    }\n+\n@@ -727,0 +749,3 @@\n+            if (dummyRecording) {\n+                return;\n+            }\n@@ -735,0 +760,3 @@\n+            if (dummyRecording) {\n+                return;\n+            }\n@@ -752,0 +780,4 @@\n+        if (dummyRecording) {\n+            return;\n+        }\n+\n","filename":"src\/jdk.jfr\/share\/classes\/jdk\/jfr\/internal\/PlatformRecording.java","additions":38,"deletions":6,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -34,0 +34,4 @@\n+import java.time.Duration;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n@@ -35,0 +39,1 @@\n+\n@@ -47,0 +52,2 @@\n+            Path temp;\n+\n@@ -49,1 +56,9 @@\n-                new Recording().start();\n+\n+                Recording recording = new Recording();\n+                recording.scheduleStart(Duration.ofSeconds(100));\n+                recording.start();\n+                temp = Files.createTempFile(\"\", \".tmp\");\n+                temp.toFile().deleteOnExit();\n+                recording.dump(temp);\n+                recording.copy(false);\n+                recording.stop();\n@@ -52,0 +67,1 @@\n+                e.printStackTrace(System.err);\n@@ -53,3 +69,1 @@\n-            Asserts.assertNotNull(thrownException);\n-            Asserts.assertEquals(thrownException.getClass(), IllegalStateException.class);\n-            Asserts.assertEquals(thrownException.getMessage(), \"Flight recorder is already shutdown\");\n+            Asserts.assertNull(thrownException);\n","filename":"test\/jdk\/jdk\/jfr\/api\/recording\/deadlock\/TestShutdownDeadLock.java","additions":18,"deletions":4,"binary":false,"changes":22,"status":"modified"}]}