{"files":[{"patch":"@@ -601,0 +601,1 @@\n+  log_info(aot)(\"Disabled all JVMTI agents during -XX:AOTMode=create\");\n@@ -705,0 +706,7 @@\n+  if (is_dumping_classic_static_archive() && AOTClassLinking) {\n+    if (JvmtiAgentList::disable_agent_list()) {\n+      FLAG_SET_ERGO(AllowArchivingWithJavaAgent, false);\n+      log_warning(cds)(\"Disabled all JVMTI agents with -Xshare:dump -XX:+AOTClassLinking\");\n+    }\n+  }\n+\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.cpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -276,1 +276,1 @@\n-void JvmtiAgentList::disable_agent_list() {\n+bool JvmtiAgentList::disable_agent_list() {\n@@ -278,1 +278,0 @@\n-  assert(CDSConfig::is_dumping_final_static_archive(), \"use this only for -XX:AOTMode=create!\");\n@@ -280,2 +279,4 @@\n-  log_info(aot)(\"Disabled all JVMTI agents during -XX:AOTMode=create\");\n-  _head = nullptr; \/\/ Pretend that no agents have been added.\n+  if (_head != nullptr) {\n+    _head = nullptr; \/\/ Pretend that no agents have been added.\n+    return true;\n+  }\n@@ -283,0 +284,1 @@\n+  return false;\n","filename":"src\/hotspot\/share\/prims\/jvmtiAgentList.cpp","additions":6,"deletions":4,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -86,1 +86,1 @@\n-  static void disable_agent_list() NOT_JVMTI_RETURN;\n+  static bool disable_agent_list() NOT_JVMTI_RETURN_(false);\n","filename":"src\/hotspot\/share\/prims\/jvmtiAgentList.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -27,1 +27,12 @@\n- * @test\n+ * @test id=static\n+ * @bug 8361725\n+ * @summary -javaagent should be disabled with -Xshare:dump -XX:+AOTClassLinking\n+ * @requires vm.cds.supports.aot.class.linking\n+ * @library \/test\/lib \/test\/hotspot\/jtreg\/runtime\/cds\/appcds\/test-classes\n+ * @build JavaAgent JavaAgentTransformer Util\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller -jar app.jar JavaAgentApp JavaAgentApp$ShouldBeTransformed\n+ * @run driver JavaAgent STATIC\n+ *\/\n+\n+\/*\n+ * @test id=aot\n@@ -71,1 +82,7 @@\n-            return new String[] { \"-javaagent:\" + agentJar, \"-Xlog:aot,cds\"};\n+            return new String[] {\n+                \"-XX:+UnlockDiagnosticVMOptions\",\n+                \"-XX:+AllowArchivingWithJavaAgent\",\n+                \"-javaagent:\" + agentJar,\n+                \"-Xlog:aot,cds\",\n+                \"-XX:+AOTClassLinking\",\n+            };\n@@ -83,1 +100,12 @@\n-            String agentLoadedMsg = \"JavaAgentTransformer.premain() is called\";\n+            if (isAOTWorkflow()) {\n+                checkExecutionForAOTWorkflow(out, runMode);\n+            } else {\n+                checkExecutionForStaticWorkflow(out, runMode);\n+            }\n+        }\n+\n+        static String agentLoadedMsg = \"JavaAgentTransformer.premain() is called\";\n+        static String agentPremainFinished = \"JavaAgentTransformer::premain() is finished\";\n+\n+        public void checkExecutionForAOTWorkflow(OutputAnalyzer out, RunMode runMode) throws Exception {\n+\n@@ -94,0 +122,1 @@\n+                out.shouldContain(agentPremainFinished);\n@@ -99,0 +128,11 @@\n+                out.shouldNotContain(agentPremainFinished);\n+                break;\n+            }\n+\n+        }\n+\n+        public void checkExecutionForStaticWorkflow(OutputAnalyzer out, RunMode runMode) throws Exception {\n+            switch (runMode) {\n+            case RunMode.DUMP_STATIC:\n+                out.shouldContain(\"Disabled all JVMTI agents with -Xshare:dump -XX:+AOTClassLinking\");\n+                out.shouldNotContain(agentPremainFinished);\n@@ -100,0 +140,2 @@\n+            default:\n+                out.shouldContain(agentPremainFinished);\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/aotCache\/JavaAgent.java","additions":45,"deletions":3,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+import java.lang.System.Logger.Level;\n@@ -33,0 +34,1 @@\n+    private static final System.Logger LOGGER = System.getLogger(JavaAgentTransformer.class.getName());\n@@ -38,0 +40,2 @@\n+\n+        LOGGER.log(Level.WARNING, \"JavaAgentTransformer::premain() is finished\");\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/aotCache\/JavaAgentTransformer.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"}]}