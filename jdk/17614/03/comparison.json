{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2001, 2013, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -95,0 +95,21 @@\n+\/\/ Only monitors where CreateDC does not fail are valid\n+static BOOL IsValidMonitor(HMONITOR hMon)\n+{\n+    MONITORINFOEX mieInfo;\n+    memset((void*)(&mieInfo), 0, sizeof(MONITORINFOEX));\n+    mieInfo.cbSize = sizeof(MONITORINFOEX);\n+    if (!::GetMonitorInfo(hMon, (LPMONITORINFOEX)(&mieInfo))) {\n+        J2dTraceLn1(J2D_TRACE_INFO, \"Devices::IsValidMonitor: GetMonitorInfo failed for monitor with handle %p\", hMon);\n+        return FALSE;\n+    }\n+\n+    HDC hDC = CreateDC(mieInfo.szDevice, NULL, NULL, NULL);\n+    if (NULL == hDC) {\n+        J2dTraceLn2(J2D_TRACE_INFO, \"Devices::IsValidMonitor: CreateDC failed for monitor with handle %p, device: %S\", hMon, mieInfo.szDevice);\n+        return FALSE;\n+    }\n+\n+    ::DeleteDC(hDC);\n+    return TRUE;\n+}\n+\n@@ -96,1 +117,1 @@\n-BOOL WINAPI clb_fCountMonitors(HMONITOR hMon, HDC hDC, LPRECT rRect, LPARAM lP)\n+static BOOL WINAPI clb_fCountMonitors(HMONITOR hMon, HDC hDC, LPRECT rRect, LPARAM lP)\n@@ -98,1 +119,4 @@\n-    g_nMonitorCounter ++;\n+    if (IsValidMonitor(hMon)) {\n+        g_nMonitorCounter++;\n+    }\n+\n@@ -102,1 +126,1 @@\n-int WINAPI CountMonitors(void)\n+static int WINAPI CountMonitors(void)\n@@ -107,1 +131,0 @@\n-\n@@ -111,1 +134,1 @@\n-BOOL WINAPI clb_fCollectMonitors(HMONITOR hMon, HDC hDC, LPRECT rRect, LPARAM lP)\n+static BOOL WINAPI clb_fCollectMonitors(HMONITOR hMon, HDC hDC, LPRECT rRect, LPARAM lP)\n@@ -113,2 +136,1 @@\n-\n-    if ((g_nMonitorCounter < g_nMonitorLimit) && (NULL != g_hmpMonitors)) {\n+    if ((g_nMonitorCounter < g_nMonitorLimit) && (IsValidMonitor(hMon))) {\n@@ -116,1 +138,1 @@\n-        g_nMonitorCounter ++;\n+        g_nMonitorCounter++;\n@@ -122,1 +144,1 @@\n-int WINAPI CollectMonitors(HMONITOR* hmpMonitors, int nNum)\n+static int WINAPI CollectMonitors(HMONITOR* hmpMonitors, int nNum)\n@@ -124,8 +146,4 @@\n-    int retCode = 0;\n-\n-    if (NULL != hmpMonitors) {\n-\n-        g_nMonitorCounter   = 0;\n-        g_nMonitorLimit     = nNum;\n-        g_hmpMonitors       = hmpMonitors;\n-\n+    g_nMonitorCounter = 0;\n+    g_hmpMonitors = hmpMonitors;\n+    g_nMonitorLimit = nNum;\n+    if (NULL != g_hmpMonitors) {\n@@ -133,7 +151,0 @@\n-\n-        retCode             = g_nMonitorCounter;\n-\n-        g_nMonitorCounter   = 0;\n-        g_nMonitorLimit     = 0;\n-        g_hmpMonitors       = NULL;\n-\n@@ -141,1 +152,1 @@\n-    return retCode;\n+    return g_nMonitorCounter;\n","filename":"src\/java.desktop\/windows\/native\/libawt\/windows\/Devices.cpp","additions":37,"deletions":26,"binary":false,"changes":63,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -182,0 +182,4 @@\n+    VERIFY(hBMDC != NULL);\n+    if (hBMDC == NULL) {\n+        return;\n+    }\n@@ -183,1 +187,12 @@\n-    VERIFY(::GetDIBits(hBMDC, hBM, 0, 1, NULL, gpBitmapInfo, DIB_RGB_COLORS));\n+    VERIFY(hBM != NULL);\n+    if (hBM == NULL) {\n+        VERIFY(::DeleteDC(hBMDC));\n+        return;\n+    }\n+    int getDiBitsRC = ::GetDIBits(hBMDC, hBM, 0, 1, NULL, gpBitmapInfo, DIB_RGB_COLORS);\n+    VERIFY(getDiBitsRC);\n+    if (getDiBitsRC == 0) {\n+        VERIFY(::DeleteObject(hBM));\n+        VERIFY(::DeleteDC(hBMDC));\n+        return;\n+    }\n","filename":"src\/java.desktop\/windows\/native\/libawt\/windows\/awt_Win32GraphicsDevice.cpp","additions":17,"deletions":2,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -36,1 +36,0 @@\n- * @requires !vm.debug | os.family != \"windows\"\n","filename":"test\/jdk\/javax\/swing\/reliability\/HangDuringStaticInitialization.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"}]}