{"files":[{"patch":"@@ -44,0 +44,2 @@\n+import sun.jvmstat.monitor.MonitoredHost;\n+\n@@ -231,1 +233,1 @@\n-        return new File(findTargetProcessTmpDirectory(pid, ns_pid), \".java_pid\" + ns_pid);\n+        return new File(findTargetProcessTmpDirectory(pid), \".java_pid\" + ns_pid);\n@@ -246,1 +248,1 @@\n-            f = new File(findTargetProcessTmpDirectory(pid, ns_pid), fn.toString());\n+            f = new File(findTargetProcessTmpDirectory(pid), fn.toString());\n@@ -252,2 +254,2 @@\n-    private String findTargetProcessTmpDirectory(long pid, long ns_pid) throws AttachNotSupportedException, IOException {\n-        final var procPidRoot = PROC.resolve(Long.toString(pid)).resolve(ROOT_TMP);\n+    private String findTargetProcessTmpDirectory(long pid) throws AttachNotSupportedException {\n+        final var tmpOnProcPidRoot = PROC.resolve(Long.toString(pid)).resolve(ROOT_TMP);\n@@ -264,6 +266,2 @@\n-         * with the target\/attachee process, we can try, except in the case where the ns_pid also exists in this pid ns\n-         * which is ambiguous, if we share \/tmp with the intended target, the attach will succeed, if we do not,\n-         * then we will potentially attempt to attach to some arbitrary process with the same pid (in this pid ns)\n-         * as that of the intended target (in its * pid ns).\n-         *\n-         * so in that case we should prehaps throw - or risk sending SIGQUIT to some arbitrary process... which could kill it\n+         * with the target\/attachee process, so we should check whether \/tmp on both is same. This method would throw\n+         * AttachNotSupportedException if they are different because we cannot make a connection with target VM.\n@@ -271,1 +269,1 @@\n-         * however we can also check the target pid's signal masks to see if it catches SIGQUIT and only do so if in\n+         * In addition, we can also check the target pid's signal masks to see if it catches SIGQUIT and only do so if in\n@@ -274,2 +272,0 @@\n-         *\n-         * note that if pid == ns_pid we are in a shared pid ns with the target and may (potentially) share \/tmp\n@@ -278,1 +274,20 @@\n-        return (Files.isWritable(procPidRoot) ? procPidRoot : TMPDIR).toString();\n+        try {\n+            if (Files.isWritable(tmpOnProcPidRoot)) {\n+                return tmpOnProcPidRoot.toString();\n+            } else if (Files.isSameFile(tmpOnProcPidRoot, TMPDIR)) {\n+                return TMPDIR.toString();\n+            } else {\n+                boolean found = MonitoredHost.getMonitoredHost(\"\/\/localhost\")\n+                                             .activeVms()\n+                                             .stream()\n+                                             .anyMatch(i -> pid == i.intValue());\n+                if (found) {\n+                    \/\/ We can use \/tmp because target process is on same host\n+                    return TMPDIR.toString();\n+                } else {\n+                    throw new AttachNotSupportedException(\"Unable to access the filesystem of the target process\");\n+                }\n+            }\n+        } catch (Exception e) {\n+            throw new AttachNotSupportedException(\"Unable to access the filesystem of the target process\", e);\n+        }\n","filename":"src\/jdk.attach\/linux\/classes\/sun\/tools\/attach\/VirtualMachineImpl.java","additions":29,"deletions":14,"binary":false,"changes":43,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -65,0 +65,11 @@\n+    \/**\n+     * Constructs an <code>AttachNotSupportedException<\/code> with\n+     * the specified cause.\n+     *\n+     * @param   message the detail message.\n+     * @param   cause   the cause of this exception.\n+     *\/\n+    public AttachNotSupportedException(String message, Throwable cause) {\n+        super(message, cause);\n+    }\n+\n","filename":"src\/jdk.attach\/share\/classes\/com\/sun\/tools\/attach\/AttachNotSupportedException.java","additions":12,"deletions":1,"binary":false,"changes":13,"status":"modified"}]}