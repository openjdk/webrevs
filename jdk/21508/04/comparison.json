{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2001, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -41,0 +41,1 @@\n+import jdk.internal.vm.annotation.Stable;\n@@ -56,0 +57,4 @@\n+    \/\/ if isOther is true, then the file being read is not a regular file,\n+    \/\/ nor a directory, nor a symbolic link, hence possibly not seekable\n+    private @Stable Boolean isOther;\n+\n@@ -63,0 +68,11 @@\n+    private boolean isOther() throws IOException {\n+        Boolean isOther = this.isOther;\n+        if (isOther == null) {\n+            if (ch instanceof FileChannelImpl fci)\n+                this.isOther = isOther = fci.isOther();\n+            else\n+                this.isOther = isOther = Boolean.FALSE;\n+        }\n+        return isOther;\n+    }\n+\n@@ -108,1 +124,2 @@\n-        if (!(ch instanceof SeekableByteChannel sbc))\n+        if (!(ch instanceof SeekableByteChannel sbc) ||\n+             (ch instanceof FileChannelImpl fci && isOther()))\n@@ -159,1 +176,2 @@\n-        if (!(ch instanceof SeekableByteChannel sbc))\n+        if (!(ch instanceof SeekableByteChannel sbc) ||\n+             (ch instanceof FileChannelImpl fci && isOther()))\n@@ -195,1 +213,3 @@\n-        if (ch instanceof SeekableByteChannel sbc) {\n+        if (ch instanceof FileChannelImpl fci) {\n+            return fci.available();\n+        } else if (ch instanceof SeekableByteChannel sbc) {\n@@ -205,1 +225,2 @@\n-        if (ch instanceof SeekableByteChannel sbc) {\n+        if (ch instanceof SeekableByteChannel sbc &&\n+            !(ch instanceof FileChannelImpl fci && isOther())) {\n@@ -227,1 +248,2 @@\n-        if (ch instanceof FileChannel fc) {\n+        if (ch instanceof FileChannel fc &&\n+            !(fc instanceof FileChannelImpl fci && isOther())) {\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/ChannelInputStream.java","additions":28,"deletions":6,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -457,0 +457,1 @@\n+\n@@ -532,0 +533,43 @@\n+    \/**\n+     * Returns an estimate of the number of remaining bytes that can be read\n+     * from this channel without blocking.\n+     *\/\n+    int available() throws IOException {\n+        ensureOpen();\n+        synchronized (positionLock) {\n+            int a = -1;\n+            int ti = -1;\n+            try {\n+                beginBlocking();\n+                ti = threads.add();\n+                if (!isOpen())\n+                    return -1;\n+                a = nd.available(fd);\n+            } finally {\n+                threads.remove(ti);\n+                endBlocking(a > -1);\n+            }\n+            return a;\n+        }\n+    }\n+\n+    \/**\n+     * Tells whether the channel represents something other than a regular\n+     * file, directory, or symbolic link.\n+     *\/\n+    boolean isOther() throws IOException {\n+        ensureOpen();\n+        int ti = -1;\n+        Boolean isOther = null;\n+        try {\n+            beginBlocking();\n+            ti = threads.add();\n+            if (!isOpen())\n+                return false;\n+            return isOther = nd.isOther(fd);\n+        } finally {\n+            threads.remove(ti);\n+            endBlocking(isOther != null);\n+        }\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/FileChannelImpl.java","additions":44,"deletions":0,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2007, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2007, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -52,0 +52,4 @@\n+    abstract int available(FileDescriptor fd) throws IOException;\n+\n+    abstract boolean isOther(FileDescriptor fd) throws IOException;\n+\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/FileDispatcher.java","additions":5,"deletions":1,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -96,0 +96,8 @@\n+    int available(FileDescriptor fd) throws IOException {\n+        return available0(fd);\n+    }\n+\n+    boolean isOther(FileDescriptor fd) throws IOException {\n+        return isOther0(fd);\n+    }\n+\n@@ -199,0 +207,4 @@\n+    static native int available0(FileDescriptor fd) throws IOException;\n+\n+    static native boolean isOther0(FileDescriptor fd) throws IOException;\n+\n","filename":"src\/java.base\/unix\/classes\/sun\/nio\/ch\/UnixFileDispatcherImpl.java","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+#include <sys\/ioctl.h>\n@@ -44,0 +45,1 @@\n+#include \"java_lang_Integer.h\"\n@@ -46,0 +48,1 @@\n+#include \"io_util_md.h\"\n@@ -181,0 +184,51 @@\n+JNIEXPORT jint JNICALL\n+Java_sun_nio_ch_UnixFileDispatcherImpl_available0(JNIEnv *env, jobject this, jobject fdo)\n+{\n+    jint fd = fdval(env, fdo);\n+    struct stat fbuf;\n+    jlong size = -1;\n+\n+    if (fstat(fd, &fbuf) != -1) {\n+        int mode = fbuf.st_mode;\n+        if (S_ISCHR(mode) || S_ISFIFO(mode) || S_ISSOCK(mode)) {\n+            int n = ioctl(fd, FIONREAD, &n);\n+            if (n >= 0) {\n+                return n;\n+            }\n+        } else if (S_ISREG(mode)) {\n+            size = fbuf.st_size;\n+        }\n+    }\n+\n+    jlong position;\n+    if ((position = lseek(fd, 0, SEEK_CUR)) == -1) {\n+        return 0;\n+    }\n+\n+    if (size < position) {\n+        if ((size = lseek(fd, 0, SEEK_END)) == -1)\n+            return 0;\n+        else if (lseek(fd, position, SEEK_SET) == -1)\n+            return 0;\n+    }\n+\n+    jlong available = size - position;\n+    return available > java_lang_Integer_MAX_VALUE ?\n+        java_lang_Integer_MAX_VALUE : (jint)available;\n+}\n+\n+JNIEXPORT jboolean JNICALL\n+Java_sun_nio_ch_UnixFileDispatcherImpl_isOther0(JNIEnv *env, jobject this, jobject fdo)\n+{\n+    jint fd = fdval(env, fdo);\n+    struct stat fbuf;\n+\n+    if (fstat(fd, &fbuf) == -1)\n+        handle(env, -1, \"isOther failed\");\n+\n+    if (S_ISREG(fbuf.st_mode) || S_ISDIR(fbuf.st_mode) || S_ISLNK(fbuf.st_mode))\n+        return JNI_FALSE;\n+\n+    return JNI_TRUE;\n+}\n+\n","filename":"src\/java.base\/unix\/native\/libnio\/ch\/UnixFileDispatcherImpl.c","additions":54,"deletions":0,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -104,0 +104,8 @@\n+    int available(FileDescriptor fd) throws IOException {\n+        return available0(fd);\n+    }\n+\n+    boolean isOther(FileDescriptor fd) throws IOException {\n+        return isOther0(fd);\n+    }\n+\n@@ -225,0 +233,4 @@\n+\n+    static native int available0(FileDescriptor fd) throws IOException;\n+\n+    static native boolean isOther0(FileDescriptor fd) throws IOException;\n","filename":"src\/java.base\/windows\/classes\/sun\/nio\/ch\/FileDispatcherImpl.java","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -27,0 +27,1 @@\n+#include <winioctl.h>\n@@ -36,0 +37,1 @@\n+#include \"io_util_md.h\"\n@@ -395,0 +397,69 @@\n+JNIEXPORT jint JNICALL\n+Java_sun_nio_ch_FileDispatcherImpl_available0(JNIEnv *env, jobject this, jobject fdo)\n+{\n+    HANDLE handle = (HANDLE)(handleval(env, fdo));\n+    DWORD type = GetFileType(handle);\n+    jlong available = 0;\n+\n+    \/\/ Calculate the number of bytes available for a regular file,\n+    \/\/ and return the default (zero) for other types.\n+    if (type == FILE_TYPE_DISK) {\n+        jlong current, end;\n+        LARGE_INTEGER distance, pos, filesize;\n+        distance.QuadPart = 0;\n+        if (SetFilePointerEx(handle, distance, &pos, FILE_CURRENT) == 0) {\n+            JNU_ThrowIOExceptionWithLastError(env, \"Available failed\");\n+            return IOS_THROWN;\n+        }\n+        current = (jlong)pos.QuadPart;\n+        if (GetFileSizeEx(handle, &filesize) == 0) {\n+            JNU_ThrowIOExceptionWithLastError(env, \"Available failed\");\n+            return IOS_THROWN;\n+        }\n+        end = (jlong)filesize.QuadPart;\n+        available = end - current;\n+        if (available > java_lang_Integer_MAX_VALUE) {\n+            available = java_lang_Integer_MAX_VALUE;\n+        } else if (available < 0) {\n+            available = 0;\n+        }\n+    }\n+\n+    return (jint)available;\n+}\n+\n+\n+JNIEXPORT jboolean JNICALL\n+Java_sun_nio_ch_FileDispatcherImpl_isOther0(JNIEnv *env, jobject this, jobject fdo)\n+{\n+    HANDLE handle = (HANDLE)(handleval(env, fdo));\n+\n+    BY_HANDLE_FILE_INFORMATION finfo;\n+    if (!GetFileInformationByHandle(handle, &finfo))\n+        JNU_ThrowIOExceptionWithLastError(env, \"isOther failed\");\n+    DWORD fattr = finfo.dwFileAttributes;\n+\n+    if ((fattr & FILE_ATTRIBUTE_DEVICE) != 0)\n+        return (jboolean)JNI_TRUE;\n+\n+    if ((fattr & FILE_ATTRIBUTE_REPARSE_POINT) != 0) {\n+        int size = MAXIMUM_REPARSE_DATA_BUFFER_SIZE;\n+        void* lpOutBuffer = (void*)malloc(size*sizeof(char));\n+        if (lpOutBuffer == NULL)\n+            JNU_ThrowOutOfMemoryError(env, \"isOther failed\");\n+\n+        DWORD bytesReturned;\n+        if (!DeviceIoControl(handle, FSCTL_GET_REPARSE_POINT, NULL, 0,\n+                             lpOutBuffer, (DWORD)size, &bytesReturned, NULL)) {\n+            free(lpOutBuffer);\n+            JNU_ThrowIOExceptionWithLastError(env, \"isOther failed\");\n+        }\n+        ULONG reparseTag = (*((PULONG)lpOutBuffer));\n+        free(lpOutBuffer);\n+        return reparseTag == IO_REPARSE_TAG_SYMLINK ?\n+            (jboolean)JNI_FALSE : (jboolean)JNI_TRUE;\n+    }\n+\n+    return (jboolean)JNI_FALSE;\n+}\n+\n","filename":"src\/java.base\/windows\/native\/libnio\/ch\/FileDispatcherImpl.c","additions":72,"deletions":1,"binary":false,"changes":73,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -25,1 +25,1 @@\n- * @bug 8227609\n+ * @bug 8227609 8233451\n@@ -27,1 +27,3 @@\n- * @library ..\n+ * @library .. \/test\/lib\n+ * @build jdk.test.lib.Platform\n+ * @run junit\/othervm --enable-native-access=ALL-UNNAMED InputStreamTest\n@@ -30,0 +32,2 @@\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n@@ -31,0 +35,1 @@\n+import java.io.IOException;\n@@ -32,0 +37,7 @@\n+import java.lang.foreign.Arena;\n+import java.lang.foreign.FunctionDescriptor;\n+import java.lang.foreign.Linker;\n+import java.lang.foreign.MemorySegment;\n+import java.lang.foreign.SymbolLookup;\n+import java.lang.foreign.ValueLayout;\n+import java.lang.invoke.MethodHandle;\n@@ -33,6 +45,11 @@\n-import java.nio.file.*;\n-import static java.nio.file.Files.*;\n-import static java.nio.file.LinkOption.*;\n-import java.nio.file.attribute.*;\n-import java.io.IOException;\n-import java.util.*;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import jdk.test.lib.Platform;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.DisabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+import static org.junit.jupiter.api.Assertions.*;\n@@ -42,2 +59,27 @@\n-    public static void main(String[] args) throws IOException {\n-        Path dir = TestUtil.createTemporaryDirectory();\n+    private static final String PIPE = \"pipe\";\n+    private static final Path PIPE_PATH = Path.of(PIPE);\n+    private static final String SENTENCE =\n+        \"Tout est permis mais rien nâ€™est possible\";\n+\n+    private static Path TMPDIR;\n+\n+    private static class mkfifo {\n+        public static final FunctionDescriptor DESC = FunctionDescriptor.of(\n+            ValueLayout.JAVA_INT,\n+            ValueLayout.ADDRESS,\n+            ValueLayout.JAVA_SHORT\n+        );\n+\n+        public static final MemorySegment ADDR;\n+        static {\n+            Linker linker = Linker.nativeLinker();\n+            SymbolLookup stdlib = linker.defaultLookup();\n+            ADDR = stdlib.find(\"mkfifo\").orElseThrow();\n+        }\n+\n+        public static final MethodHandle HANDLE =\n+            Linker.nativeLinker().downcallHandle(ADDR, DESC);\n+    }\n+\n+    public static int mkfifo(MemorySegment x0, short x1) {\n+        var mh$ = mkfifo.HANDLE;\n@@ -45,3 +87,34 @@\n-            testSkip(dir);\n-        } finally {\n-            TestUtil.removeAll(dir);\n+            return (int)mh$.invokeExact(x0, x1);\n+        } catch (Throwable ex$) {\n+           throw new AssertionError(\"should not reach here\", ex$);\n+        }\n+    }\n+\n+    private static Thread createWriteThread() {\n+        Thread t = new Thread(\n+            new Runnable() {\n+                public void run() {\n+                    try (FileOutputStream fos = new FileOutputStream(PIPE);) {\n+                        fos.write(SENTENCE.getBytes());\n+                    } catch (IOException e) {\n+                        throw new RuntimeException(e);\n+                    }\n+                }\n+            }\n+        );\n+        t.start();\n+        return t;\n+    }\n+\n+    @BeforeAll\n+    static void before() throws InterruptedException, IOException {\n+        TMPDIR = TestUtil.createTemporaryDirectory();\n+\n+        if (Platform.isWindows())\n+            return;\n+\n+        Files.deleteIfExists(PIPE_PATH);\n+        try (var newArena = Arena.ofConfined()) {\n+            var addr = newArena.allocateFrom(PIPE);\n+            short mode = 0666;\n+            assertEquals(0, mkfifo(addr, mode));\n@@ -49,0 +122,12 @@\n+        if (Files.notExists(PIPE_PATH))\n+            throw new RuntimeException(\"Failed to create \" + PIPE);\n+    }\n+\n+    @AfterAll\n+    static void after() throws IOException {\n+        TestUtil.removeAll(TMPDIR);\n+\n+        if (Platform.isWindows())\n+            return;\n+\n+        Files.deleteIfExists(PIPE_PATH);\n@@ -54,2 +139,3 @@\n-    static void testSkip(Path tmpdir) throws IOException {\n-        Path file = createFile(tmpdir.resolve(\"foo\"));\n+    @Test\n+    void skip() throws IOException {\n+        Path file = Files.createFile(TMPDIR.resolve(\"foo\"));\n@@ -126,3 +212,63 @@\n-    static void assertTrue(boolean okay) {\n-        if (!okay)\n-            throw new RuntimeException(\"Assertion Failed\");\n+    \/**\n+     * Tests that Files.newInputStream(Path).available() does not throw\n+     *\/\n+    @Test\n+    @DisabledOnOs(OS.WINDOWS)\n+    void availableStdin() throws IOException {\n+        Path stdin = Path.of(\"\/dev\", \"stdin\");\n+        if (Files.exists(stdin)) {\n+            try (InputStream s = Files.newInputStream(stdin);) {\n+                s.available();\n+            }\n+        }\n+    }\n+\n+    \/**\n+     * Tests that Files.newInputStream(Path).skip(0) does not throw\n+     *\/\n+    @Test\n+    @DisabledOnOs(OS.WINDOWS)\n+    void skipStdin() throws IOException {\n+        Path stdin = Path.of(\"\/dev\", \"stdin\");\n+        if (Files.exists(stdin)) {\n+            try (InputStream s = Files.newInputStream(stdin);) {\n+                s.skip(0);\n+            }\n+        }\n+    }\n+\n+    \/**\n+     * Tests Files.newInputStream(Path).readAllBytes().\n+     *\/\n+    @Test\n+    @DisabledOnOs(OS.WINDOWS)\n+    void readAllBytes() throws InterruptedException, IOException {\n+        Thread t = createWriteThread();\n+        try (InputStream in = Files.newInputStream(Path.of(PIPE))) {\n+            String s = new String(in.readAllBytes());\n+            System.out.println(s);\n+            assertEquals(SENTENCE, s);\n+        } finally {\n+            t.join();\n+        }\n+    }\n+\n+    \/**\n+     * Tests Files.newInputStream(Path).readNBytes().\n+     *\/\n+    @Test\n+    @DisabledOnOs(OS.WINDOWS)\n+    void readNBytes() throws InterruptedException, IOException {\n+        Thread t = createWriteThread();\n+        try (InputStream in = Files.newInputStream(Path.of(PIPE))) {\n+            final int offset = 11;\n+            final int length = 17;\n+            assert length <= SENTENCE.length();\n+            byte[] b = new byte[offset + length];\n+            int n = in.readNBytes(b, offset, length);\n+            String s = new String(b, offset, length);\n+            System.out.println(s);\n+            assertEquals(SENTENCE.substring(0, length), s);\n+        } finally {\n+            t.join();\n+        }\n","filename":"test\/jdk\/java\/nio\/file\/Files\/InputStreamTest.java","additions":165,"deletions":19,"binary":false,"changes":184,"status":"modified"}]}