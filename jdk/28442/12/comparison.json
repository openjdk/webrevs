{"files":[{"patch":"@@ -5798,1 +5798,1 @@\n-                                   Register rtmp, XMMRegister xtmp) {\n+                                   Register rtmp, Register rtmp2, XMMRegister xtmp) {\n@@ -5800,1 +5800,1 @@\n-  assert_different_registers(to, value, count, rtmp);\n+  assert_different_registers(to, value, count, rtmp, rtmp2);\n@@ -5808,1 +5808,1 @@\n-    generate_fill_avx3(t, to, value, count, rtmp, xtmp);\n+    generate_fill_avx3(t, to, value, count, rtmp, rtmp2, xtmp);\n@@ -9231,0 +9231,4 @@\n+void MacroAssembler::fill32(Register dst, Register disp, XMMRegister xmm) {\n+  fill32(Address(dst, disp), xmm);\n+}\n+\n@@ -9245,12 +9249,45 @@\n-void MacroAssembler::generate_fill_avx3(BasicType type, Register to, Register value,\n-                                        Register count, Register rtmp, XMMRegister xtmp) {\n-  Label L_exit;\n-  Label L_fill_start;\n-  Label L_fill_64_bytes;\n-  Label L_fill_96_bytes;\n-  Label L_fill_128_bytes;\n-  Label L_fill_128_bytes_loop;\n-  Label L_fill_128_loop_header;\n-  Label L_fill_128_bytes_loop_header;\n-  Label L_fill_128_bytes_loop_pre_header;\n-  Label L_fill_zmm_sequence;\n+void MacroAssembler::fill32_tail(uint shift, Register dst, Register disp, XMMRegister xmm,\n+                                      Register length, Register temp) {\n+  \/\/ This stub assumes that fill size <= 32 bytes (i.e. length <= (32 >> shift))\n+  assert(MaxVectorSize >= 32, \"vector length should be >= 32\");\n+  Label L16, L8, L4, L2, L1, L_done;\n+  \/\/ Fastpath for fill size <= 4 bytes\n+  cmpq(length, 4 >> shift);\n+  jcc(Assembler::lessEqual, L4);\n+\n+  \/\/ 32-byte store\n+  cmpq(length, 32 >> shift);\n+  jcc(Assembler::less, L16);\n+  vmovdqu(Address(dst, disp), xmm);\n+  addq(disp, 32);\n+  subq(length, 32 >> shift);\n+  jcc(Assembler::zero, L_done);\n+\n+  \/\/ 16-byte store\n+  bind(L16);\n+  cmpq(length, 16 >> shift);\n+  jcc(Assembler::less, L8);\n+  movdqu(Address(dst, disp), xmm);\n+  addq(disp, 16);\n+  subq(length, 16 >> shift);\n+  jcc(Assembler::zero, L_done);\n+\n+  \/\/ 8-byte store\n+  bind(L8);\n+  cmpq(length, 8 >> shift);\n+  jcc(Assembler::less, L4);\n+  movq(Address(dst, disp), xmm);\n+  addq(disp, 8);\n+  subq(length, 8 >> shift);\n+  jcc(Assembler::zero, L_done);\n+\n+  \/\/ 4-byte store\n+  bind(L4);\n+  \/\/ temp holds low 8 bytes of xmm for 4\/2\/1B stores\n+  movq(temp, xmm);\n+  cmpq(length, 4 >> shift);\n+  jcc(Assembler::less, L2);\n+  movl(Address(dst, disp), temp);\n+  addq(disp, 4);\n+  subq(length, 4 >> shift);\n+  jcc(Assembler::zero, L_done);\n@@ -9258,0 +9295,42 @@\n+  bind(L2);\n+  if (shift < 2) {\n+    \/\/ 2-byte store\n+    cmpq(length, 2 >> shift);\n+    jcc(Assembler::less, L1);\n+    movw(Address(dst, disp), temp);\n+    addq(disp, 2);\n+    subq(length, 2 >> shift);\n+    jcc(Assembler::zero, L_done);\n+\n+    bind(L1);\n+    if (shift == 0) {\n+      \/\/ 1-byte store\n+      testq(length, length);\n+      jcc(Assembler::zero, L_done);\n+      movb(Address(dst, disp), temp);\n+      subq(length, 1 >> shift);\n+    }\n+  }\n+\n+  bind(L_done);\n+}\n+\n+void MacroAssembler::fill64_tail(uint shift, Register dst, Register disp,\n+                                     XMMRegister xmm, Register length,\n+                                     Register temp) {\n+  assert(MaxVectorSize >= 32, \"vector length should be >= 32\");\n+  Label L32, L_exit;\n+  \/\/ Check if size > 32B\n+  cmpq(length, 32 >> shift);\n+  jcc(Assembler::less, L32);\n+  fill32(dst, disp, xmm);\n+  subq(length, 32 >> shift);\n+  jcc(Assembler::zero, L_exit);\n+  addq(disp, 32);\n+  bind(L32);\n+  fill32_tail(shift, dst, disp, xmm, length, temp);\n+  bind(L_exit);\n+}\n+\n+void MacroAssembler::generate_fill_avx3(BasicType type, Register to, Register value,\n+                                        Register count, Register rtmp, Register rtmp2, XMMRegister xtmp) {\n@@ -9259,1 +9338,0 @@\n-  int avx3threshold = VM_Version::avx3_threshold();\n@@ -9275,1 +9353,19 @@\n-  if ((avx3threshold != 0)  || (MaxVectorSize == 32)) {\n+  Label L_exit;\n+  \/\/ Fastpath for fill count <= 4 bytes.\n+  if (type == T_BYTE) {\n+    Label L_done;\n+    cmpq(count, 4);\n+    jccb(Assembler::greater, L_done);\n+    movb(Address(to, 0), value);\n+    cmpq(count, 1);\n+    jcc(Assembler::equal, L_exit);\n+    movb(Address(to, 1), value);\n+    cmpq(count, 2);\n+    jcc(Assembler::equal, L_exit);\n+    movb(Address(to, 2), value);\n+    cmpq(count, 3);\n+    jcc(Assembler::equal, L_exit);\n+    movb(Address(to, 3), value);\n+    jmp(L_exit);\n+    bind(L_done);\n+  }\n@@ -9277,4 +9373,13 @@\n-    if (MaxVectorSize == 64) {\n-      cmpq(count, avx3threshold >> shift);\n-      jcc(Assembler::greater, L_fill_zmm_sequence);\n-    }\n+  Label L_fill_32_tail;\n+  Label L_fill_zmm_sequence;\n+  Register disp = rtmp2;\n+  int avx3threshold = VM_Version::avx3_threshold();\n+\n+  if ((avx3threshold != 0)  || (MaxVectorSize == 32)) {\n+    Label L_fill_start;\n+    Label L_fill_96_bytes;\n+    Label L_fill_128_bytes;\n+    Label L_fill_128_bytes_loop;\n+    Label L_fill_128_loop_header;\n+    Label L_fill_128_bytes_loop_header;\n+    Label L_fill_128_bytes_loop_pre_header;\n@@ -9285,1 +9390,0 @@\n-\n@@ -9287,3 +9391,7 @@\n-    jccb(Assembler::greater, L_fill_64_bytes);\n-    fill32_masked(shift, to, 0, xtmp, k2, count, rtmp);\n-    jmp(L_exit);\n+    movq(disp, 0);\n+    jcc(Assembler::lessEqual, L_fill_32_tail);\n+\n+    if (MaxVectorSize == 64) {\n+      cmpq(count, avx3threshold >> shift);\n+      jcc(Assembler::greater, L_fill_zmm_sequence);\n+    }\n@@ -9291,1 +9399,0 @@\n-    bind(L_fill_64_bytes);\n@@ -9294,2 +9401,4 @@\n-    fill64_masked(shift, to, 0, xtmp, k2, count, rtmp);\n-    jmp(L_exit);\n+    fill32(to, 0, xtmp);\n+    subq(count, 32 >> shift);\n+    movq(disp, 32);\n+    jmp(L_fill_32_tail);\n@@ -9302,2 +9411,2 @@\n-    fill32_masked(shift, to, 64, xtmp, k2, count, rtmp);\n-    jmp(L_exit);\n+    movq(disp, 64);\n+    jmp(L_fill_32_tail);\n@@ -9311,2 +9420,2 @@\n-    fill32_masked(shift, to, 96, xtmp, k2, count, rtmp);\n-    jmp(L_exit);\n+    movq(disp, 96);\n+    jmp(L_fill_32_tail);\n@@ -9351,0 +9460,1 @@\n+    Label L_fill_64_tail;\n@@ -9364,2 +9474,2 @@\n-    fill64_masked(shift, to, 0, xtmp, k2, count, rtmp, true);\n-    jmp(L_exit);\n+    movq(disp, 0);\n+    jmp(L_fill_64_tail);\n@@ -9372,2 +9482,2 @@\n-    fill64_masked(shift, to, 64, xtmp, k2, count, rtmp, true);\n-    jmp(L_exit);\n+    movq(disp, 64);\n+    jmp(L_fill_64_tail);\n@@ -9381,2 +9491,2 @@\n-    fill64_masked(shift, to, 128, xtmp, k2, count, rtmp, true);\n-    jmp(L_exit);\n+    movq(disp, 128);\n+    jmp(L_fill_64_tail);\n@@ -9418,0 +9528,8 @@\n+\n+    bind(L_fill_64_tail);\n+    cmpq(count, 32 >> shift);\n+    jcc(Assembler::less, L_fill_32_tail);\n+    fill32(to, disp, xtmp);\n+    jcc(Assembler::equal, L_exit);\n+    subq(count, 32 >> shift);\n+    addq(disp, 32);\n@@ -9419,0 +9537,4 @@\n+\n+  bind(L_fill_32_tail);\n+  fill32_tail(shift, to, disp, xtmp, count, rtmp);\n+\n","filename":"src\/hotspot\/cpu\/x86\/macroAssembler_x86.cpp","additions":160,"deletions":38,"binary":false,"changes":198,"status":"modified"},{"patch":"@@ -1918,1 +1918,1 @@\n-                     Register rtmp, XMMRegister xtmp);\n+                     Register rtmp, Register rtmp2, XMMRegister xtmp);\n@@ -2031,0 +2031,6 @@\n+  void fill64_tail(uint shift, Register dst, Register disp,\n+                         XMMRegister xmm, Register length, Register temp);\n+\n+  void fill32_tail(uint shift, Register dst, Register disp,\n+                         XMMRegister xmm, Register length, Register temp);\n+\n@@ -2035,0 +2041,2 @@\n+  void fill32(Register dst, Register disp, XMMRegister xmm);\n+\n@@ -2051,1 +2059,1 @@\n-                          Register count, Register rtmp, XMMRegister xtmp);\n+                          Register count, Register rtmp, Register rtmp2, XMMRegister xtmp);\n","filename":"src\/hotspot\/cpu\/x86\/macroAssembler_x86.hpp","additions":10,"deletions":2,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -1759,1 +1759,1 @@\n-    __ generate_fill(t, aligned, to, value, r11, rax, xmm0);\n+    __ generate_fill(t, aligned, to, value, r11, rax, r10, xmm0);\n","filename":"src\/hotspot\/cpu\/x86\/stubGenerator_x86_64_arraycopy.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -72,1 +72,1 @@\n-    public void testCharFill() {\n+    public char testCharFill() {\n@@ -74,0 +74,1 @@\n+        return (char) (testCharArray[0] + testCharArray[size - 1]);\n@@ -77,1 +78,1 @@\n-    public void testByteFill() {\n+    public byte testByteFill() {\n@@ -79,0 +80,1 @@\n+        return (byte) (testByteArray[0] + testByteArray[size - 1]);\n@@ -82,1 +84,1 @@\n-    public void testShortFill() {\n+    public short testShortFill() {\n@@ -84,0 +86,1 @@\n+        return (short) (testShortArray[0] + testShortArray[size - 1]);\n@@ -87,1 +90,1 @@\n-    public void testIntFill() {\n+    public int testIntFill() {\n@@ -89,0 +92,1 @@\n+        return testIntArray[0] + testIntArray[size - 1];\n@@ -92,1 +96,1 @@\n-    public void testLongFill() {\n+    public long testLongFill() {\n@@ -94,0 +98,1 @@\n+        return testLongArray[0] + testLongArray[size - 1];\n@@ -97,1 +102,1 @@\n-    public void testFloatFill() {\n+    public float testFloatFill() {\n@@ -99,0 +104,1 @@\n+        return testFloatArray[0] + testFloatArray[size - 1];\n@@ -102,1 +108,1 @@\n-    public void testDoubleFill() {\n+    public double testDoubleFill() {\n@@ -104,0 +110,1 @@\n+        return testDoubleArray[0] + testDoubleArray[size - 1];\n","filename":"test\/micro\/org\/openjdk\/bench\/java\/util\/ArraysFill.java","additions":14,"deletions":7,"binary":false,"changes":21,"status":"modified"}]}