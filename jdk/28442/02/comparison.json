{"files":[{"patch":"@@ -9245,0 +9245,78 @@\n+void MacroAssembler::fill32_tail(uint shift, Register dst, int disp, XMMRegister xmm,\n+                                      Register length, Register temp) {\n+  \/\/ This stub assumes that fill size <= 32 bytes (i.e. length <= (32 >> shift))\n+  assert(MaxVectorSize >= 32, \"vector length should be >= 32\");\n+  Label L16, L8, L4, L2, L1, L_done;\n+  \/\/ Fastpath for fill size <= 4 bytes\n+  cmpq(length, 4 >> shift);\n+  jcc(Assembler::lessEqual, L4);\n+\n+  \/\/ 32-byte store\n+  cmpq(length, 32 >> shift);\n+  jcc(Assembler::less, L16);\n+  vmovdqu(Address(dst, disp), xmm);\n+  addq(dst, 32);\n+  subq(length, 32 >> shift);\n+  jcc(Assembler::equal, L_done);\n+\n+  \/\/ 16-byte store\n+  bind(L16);\n+  cmpq(length, 16 >> shift);\n+  jcc(Assembler::less, L8);\n+  movdqu(Address(dst, disp), xmm);\n+  addq(dst, 16);\n+  subq(length, 16 >> shift);\n+\n+  \/\/ 8-byte store\n+  bind(L8);\n+  cmpq(length, 8 >> shift);\n+  jcc(Assembler::less, L4);\n+  movq(Address(dst, disp), xmm);\n+  addq(dst, 8);\n+  subq(length, 8 >> shift);\n+\n+  \/\/ 4-byte store\n+  bind(L4);\n+  \/\/ temp holds low 8 bytes of xmm for 4\/2\/1B stores\n+  movq(temp, xmm);\n+  cmpq(length, 4 >> shift);\n+  jcc(Assembler::less, L2);\n+  movl(Address(dst, disp), temp);\n+  addq(dst, 4);\n+  subq(length, 4 >> shift);\n+\n+  \/\/ 2-byte store\n+  bind(L2);\n+  cmpq(length, 2 >> shift);\n+  jcc(Assembler::less, L1);\n+  movw(Address(dst, disp), temp);\n+  addq(dst, 2);\n+  subq(length, 2 >> shift);\n+\n+  \/\/ 1-byte store\n+  bind(L1);\n+  testq(length, length);\n+  jcc(Assembler::zero, L_done);\n+  movb(Address(dst, disp), temp);\n+\n+  bind(L_done);\n+}\n+\n+void MacroAssembler::fill64_tail(uint shift, Register dst, int disp,\n+                                     XMMRegister xmm, Register length,\n+                                     Register temp) {\n+  assert(MaxVectorSize >= 32, \"vector length should be >= 32\");\n+  Label L32, L_exit;\n+  \/\/ Check if size > 32B\n+  cmpq(length, 32 >> shift);\n+  jcc(Assembler::lessEqual, L32);\n+  fill32(dst, disp, xmm);\n+  subq(length, 32 >> shift);\n+  fill32_tail(shift, dst, disp + 32, xmm, length, temp);\n+  jmp(L_exit);\n+  \/\/ Size <= 32B\n+  bind(L32);\n+  fill32_tail(shift, dst, disp, xmm, length, temp);\n+  bind(L_exit);\n+}\n+\n@@ -9249,0 +9327,2 @@\n+  Label L_fill_32_tail;\n+  Label L_fill_64_tail;\n@@ -9277,5 +9357,0 @@\n-    if (MaxVectorSize == 64) {\n-      cmpq(count, avx3threshold >> shift);\n-      jcc(Assembler::greater, L_fill_zmm_sequence);\n-    }\n-\n@@ -9287,3 +9362,1 @@\n-    jccb(Assembler::greater, L_fill_64_bytes);\n-    fill32_masked(shift, to, 0, xtmp, k2, count, rtmp);\n-    jmp(L_exit);\n+    jcc(Assembler::lessEqual, L_fill_32_tail);\n@@ -9292,0 +9365,6 @@\n+\n+    if (MaxVectorSize == 64) {\n+      cmpq(count, avx3threshold >> shift);\n+      jcc(Assembler::greater, L_fill_zmm_sequence);\n+    }\n+\n@@ -9293,3 +9372,5 @@\n-    jccb(Assembler::greater, L_fill_96_bytes);\n-    fill64_masked(shift, to, 0, xtmp, k2, count, rtmp);\n-    jmp(L_exit);\n+    jcc(Assembler::greater, L_fill_96_bytes);\n+    fill32(to, 0, xtmp);\n+    addptr(to, 32);\n+    subq(count, 32 >> shift);\n+    jmp(L_fill_32_tail);\n@@ -9299,1 +9380,1 @@\n-    jccb(Assembler::greater, L_fill_128_bytes);\n+    jcc(Assembler::greater, L_fill_128_bytes);\n@@ -9301,0 +9382,1 @@\n+    addptr(to, 64);\n@@ -9302,2 +9384,1 @@\n-    fill32_masked(shift, to, 64, xtmp, k2, count, rtmp);\n-    jmp(L_exit);\n+    jmp(L_fill_32_tail);\n@@ -9307,1 +9388,1 @@\n-    jccb(Assembler::greater, L_fill_128_bytes_loop_pre_header);\n+    jcc(Assembler::greater, L_fill_128_bytes_loop_pre_header);\n@@ -9310,0 +9391,1 @@\n+    addptr(to, 96);\n@@ -9311,2 +9393,1 @@\n-    fill32_masked(shift, to, 96, xtmp, k2, count, rtmp);\n-    jmp(L_exit);\n+    jmp(L_fill_32_tail);\n@@ -9363,3 +9444,2 @@\n-    jccb(Assembler::greater, L_fill_128_bytes_zmm);\n-    fill64_masked(shift, to, 0, xtmp, k2, count, rtmp, true);\n-    jmp(L_exit);\n+    jcc(Assembler::greater, L_fill_128_bytes_zmm);\n+    jmp(L_fill_64_tail);\n@@ -9369,1 +9449,1 @@\n-    jccb(Assembler::greater, L_fill_192_bytes_zmm);\n+    jcc(Assembler::greater, L_fill_192_bytes_zmm);\n@@ -9371,0 +9451,1 @@\n+    addptr(to, 64);\n@@ -9372,2 +9453,1 @@\n-    fill64_masked(shift, to, 64, xtmp, k2, count, rtmp, true);\n-    jmp(L_exit);\n+    jmp(L_fill_64_tail);\n@@ -9377,1 +9457,1 @@\n-    jccb(Assembler::greater, L_fill_192_bytes_loop_pre_header_zmm);\n+    jcc(Assembler::greater, L_fill_192_bytes_loop_pre_header_zmm);\n@@ -9380,0 +9460,1 @@\n+    addptr(to, 128);\n@@ -9381,2 +9462,1 @@\n-    fill64_masked(shift, to, 128, xtmp, k2, count, rtmp, true);\n-    jmp(L_exit);\n+    jmp(L_fill_64_tail);\n@@ -9418,0 +9498,8 @@\n+\n+    bind(L_fill_64_tail);\n+    cmpq(count, 32 >> shift);\n+    jcc(Assembler::less, L_fill_32_tail);\n+    fill32(to, 0, xtmp);\n+    jcc(Assembler::equal, L_exit);\n+    subq(count, 32 >> shift);\n+    addptr(to, 32);\n@@ -9419,0 +9507,4 @@\n+\n+  bind(L_fill_32_tail);\n+  fill32_tail(shift, to, 0, xtmp, count, rtmp);\n+\n","filename":"src\/hotspot\/cpu\/x86\/macroAssembler_x86.cpp","additions":118,"deletions":26,"binary":false,"changes":144,"status":"modified"},{"patch":"@@ -2026,0 +2026,3 @@\n+  void fill64_tail(uint shift, Register dst, int disp,\n+                         XMMRegister xmm, Register length, Register temp);\n+\n@@ -2030,0 +2033,3 @@\n+  void fill32_tail(uint shift, Register dst, int disp,\n+                         XMMRegister xmm, Register length, Register temp);\n+\n","filename":"src\/hotspot\/cpu\/x86\/macroAssembler_x86.hpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"}]}