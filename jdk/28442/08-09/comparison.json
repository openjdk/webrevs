{"files":[{"patch":"@@ -5625,1 +5625,1 @@\n-    fill64_tail(3, base, 0, xtmp, cnt, rtmp);\n+    fill64_masked(3, base, 0, xtmp, mask, cnt, rtmp, true);\n@@ -5642,1 +5642,1 @@\n-  jcc(Assembler::lessEqual, L_end);\n+  jccb(Assembler::lessEqual, L_end);\n@@ -5644,1 +5644,1 @@\n-    fill32_tail(3, base, 0, xtmp, cnt, rtmp);\n+    fill32_masked(3, base, 0, xtmp, mask, cnt, rtmp);\n@@ -5768,1 +5768,1 @@\n-    jcc(Assembler::negative, DONE); \/\/ Zero length\n+    jccb(Assembler::negative, DONE); \/\/ Zero length\n@@ -5775,1 +5775,1 @@\n-    jmp(DONE);\n+    jmpb(DONE);\n@@ -5798,1 +5798,1 @@\n-                                   Register rtmp, XMMRegister xtmp) {\n+                                   Register rtmp, Register rtmp2, XMMRegister xtmp) {\n@@ -5808,1 +5808,1 @@\n-    generate_fill_avx3(t, to, value, count, rtmp, xtmp);\n+    generate_fill_avx3(t, to, value, count, rtmp, rtmp2, xtmp);\n@@ -9187,0 +9187,35 @@\n+void MacroAssembler::fill_masked(BasicType bt, Address dst, XMMRegister xmm, KRegister mask,\n+                                 Register length, Register temp, int vec_enc) {\n+  \/\/ Computing mask for predicated vector store.\n+  movptr(temp, -1);\n+  bzhiq(temp, temp, length);\n+  kmov(mask, temp);\n+  evmovdqu(bt, mask, dst, xmm, true, vec_enc);\n+}\n+\n+\/\/ Set memory operation for length \"less than\" 64 bytes.\n+void MacroAssembler::fill64_masked(uint shift, Register dst, int disp,\n+                                       XMMRegister xmm, KRegister mask, Register length,\n+                                       Register temp, bool use64byteVector) {\n+  assert(MaxVectorSize >= 32, \"vector length should be >= 32\");\n+  const BasicType type[] = { T_BYTE, T_SHORT, T_INT, T_LONG};\n+  if (!use64byteVector) {\n+    fill32(dst, disp, xmm);\n+    subptr(length, 32 >> shift);\n+    fill32_masked(shift, dst, disp + 32, xmm, mask, length, temp);\n+  } else {\n+    assert(MaxVectorSize == 64, \"vector length != 64\");\n+    fill_masked(type[shift], Address(dst, disp), xmm, mask, length, temp, Assembler::AVX_512bit);\n+  }\n+}\n+\n+\n+void MacroAssembler::fill32_masked(uint shift, Register dst, int disp,\n+                                       XMMRegister xmm, KRegister mask, Register length,\n+                                       Register temp) {\n+  assert(MaxVectorSize >= 32, \"vector length should be >= 32\");\n+  const BasicType type[] = { T_BYTE, T_SHORT, T_INT, T_LONG};\n+  fill_masked(type[shift], Address(dst, disp), xmm, mask, length, temp, Assembler::AVX_256bit);\n+}\n+\n+\n@@ -9196,0 +9231,4 @@\n+void MacroAssembler::fill32(Register dst, Register disp, XMMRegister xmm) {\n+  fill32(Address(dst, disp), xmm);\n+}\n+\n@@ -9210,1 +9249,1 @@\n-void MacroAssembler::fill32_tail(uint shift, Register dst, int disp, XMMRegister xmm,\n+void MacroAssembler::fill32_tail(uint shift, Register dst, Register disp, XMMRegister xmm,\n@@ -9223,1 +9262,1 @@\n-  addq(dst, 32);\n+  addq(disp, 32);\n@@ -9225,1 +9264,1 @@\n-  jcc(Assembler::equal, L_done);\n+  jcc(Assembler::zero, L_done);\n@@ -9232,1 +9271,1 @@\n-  addq(dst, 16);\n+  addq(disp, 16);\n@@ -9234,0 +9273,1 @@\n+  jcc(Assembler::zero, L_done);\n@@ -9240,1 +9280,1 @@\n-  addq(dst, 8);\n+  addq(disp, 8);\n@@ -9242,0 +9282,1 @@\n+  jcc(Assembler::zero, L_done);\n@@ -9250,1 +9291,1 @@\n-  addq(dst, 4);\n+  addq(disp, 4);\n@@ -9252,0 +9293,1 @@\n+  jcc(Assembler::zero, L_done);\n@@ -9253,1 +9295,0 @@\n-  \/\/ 2-byte store\n@@ -9255,13 +9296,18 @@\n-  cmpq(length, 2 >> shift);\n-  jcc(Assembler::less, L1);\n-  movw(Address(dst, disp), temp);\n-  addq(dst, 2);\n-  subq(length, 2 >> shift);\n-\n-  \/\/ 1-byte store\n-  bind(L1);\n-  testq(length, length);\n-  jcc(Assembler::zero, L_done);\n-  movb(Address(dst, disp), temp);\n-  addq(dst, 1);\n-  subq(length, 1 >> shift);\n+  if (shift < 2) {\n+    \/\/ 2-byte store\n+    cmpq(length, 2 >> shift);\n+    jcc(Assembler::less, L1);\n+    movw(Address(dst, disp), temp);\n+    addq(disp, 2);\n+    subq(length, 2 >> shift);\n+    jcc(Assembler::zero, L_done);\n+\n+    bind(L1);\n+    if (shift == 0) {\n+      \/\/ 1-byte store\n+      testq(length, length);\n+      jcc(Assembler::zero, L_done);\n+      movb(Address(dst, disp), temp);\n+      subq(length, 1 >> shift);\n+    }\n+  }\n@@ -9272,1 +9318,1 @@\n-void MacroAssembler::fill64_tail(uint shift, Register dst, int disp,\n+void MacroAssembler::fill64_tail(uint shift, Register dst, Register disp,\n@@ -9279,1 +9325,1 @@\n-  jcc(Assembler::lessEqual, L32);\n+  jcc(Assembler::less, L32);\n@@ -9282,1 +9328,2 @@\n-  addq(dst, 32);\n+  jcc(Assembler::zero, L_exit);\n+  addq(disp, 32);\n@@ -9289,1 +9336,1 @@\n-                                        Register count, Register rtmp, XMMRegister xtmp) {\n+                                        Register count, Register rtmp, Register rtmp2, XMMRegister xtmp) {\n@@ -9302,0 +9349,1 @@\n+  Register disp = rtmp2;\n@@ -9344,1 +9392,0 @@\n-\n@@ -9346,0 +9393,1 @@\n+    movq(disp, 0);\n@@ -9358,1 +9406,0 @@\n-    addptr(to, 32);\n@@ -9360,0 +9407,1 @@\n+    movq(disp, 32);\n@@ -9366,1 +9414,0 @@\n-    addptr(to, 64);\n@@ -9368,0 +9415,1 @@\n+    movq(disp, 64);\n@@ -9375,1 +9423,0 @@\n-    addptr(to, 96);\n@@ -9377,0 +9424,1 @@\n+    movq(disp, 96);\n@@ -9429,0 +9477,1 @@\n+    movq(disp, 0);\n@@ -9435,1 +9484,0 @@\n-    addptr(to, 64);\n@@ -9437,0 +9485,1 @@\n+    movq(disp, 64);\n@@ -9444,1 +9493,0 @@\n-    addptr(to, 128);\n@@ -9446,0 +9494,1 @@\n+    movq(disp, 128);\n@@ -9486,1 +9535,1 @@\n-    fill32(to, 0, xtmp);\n+    fill32(to, disp, xtmp);\n@@ -9489,1 +9538,1 @@\n-    addptr(to, 32);\n+    addq(disp, 32);\n@@ -9493,1 +9542,1 @@\n-  fill32_tail(shift, to, 0, xtmp, count, rtmp);\n+  fill32_tail(shift, to, disp, xtmp, count, rtmp);\n","filename":"src\/hotspot\/cpu\/x86\/macroAssembler_x86.cpp","additions":89,"deletions":40,"binary":false,"changes":129,"status":"modified"},{"patch":"@@ -1918,1 +1918,1 @@\n-                     Register rtmp, XMMRegister xtmp);\n+                     Register rtmp, Register rtmp2, XMMRegister xtmp);\n@@ -2020,1 +2020,12 @@\n-  void fill64_tail(uint shift, Register dst, int disp,\n+  void fill_masked(BasicType bt, Address dst, XMMRegister xmm, KRegister mask,\n+                   Register length, Register temp, int vec_enc);\n+\n+  void fill64_masked(uint shift, Register dst, int disp,\n+                         XMMRegister xmm, KRegister mask, Register length,\n+                         Register temp, bool use64byteVector = false);\n+\n+  void fill32_masked(uint shift, Register dst, int disp,\n+                         XMMRegister xmm, KRegister mask, Register length,\n+                         Register temp);\n+\n+  void fill64_tail(uint shift, Register dst, Register disp,\n@@ -2023,1 +2034,1 @@\n-  void fill32_tail(uint shift, Register dst, int disp,\n+  void fill32_tail(uint shift, Register dst, Register disp,\n@@ -2030,0 +2041,2 @@\n+  void fill32(Register dst, Register disp, XMMRegister xmm);\n+\n@@ -2046,1 +2059,1 @@\n-                          Register count, Register rtmp, XMMRegister xtmp);\n+                          Register count, Register rtmp, Register rtmp2, XMMRegister xtmp);\n","filename":"src\/hotspot\/cpu\/x86\/macroAssembler_x86.hpp","additions":17,"deletions":4,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -1759,1 +1759,1 @@\n-    __ generate_fill(t, aligned, to, value, r11, rax, xmm0);\n+    __ generate_fill(t, aligned, to, value, r11, rax, r10, xmm0);\n","filename":"src\/hotspot\/cpu\/x86\/stubGenerator_x86_64_arraycopy.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}