{"files":[{"patch":"@@ -97,1 +97,1 @@\n-    ClassLoaderData* _scanned_cld;\n+    DefNewGeneration* _g;\n@@ -99,2 +99,8 @@\n-    template <typename T>\n-    void do_oop_work(T* p) {\n+  public:\n+    \/\/ Records whether this CLD contains oops pointing into young-gen after scavenging.\n+    bool _has_oops_into_young_gen;\n+\n+    CLDOopClosure(DefNewGeneration* g) : OffHeapScanClosure(g),\n+      _has_oops_into_young_gen(false) {}\n+\n+    void do_oop(oop* p) {\n@@ -104,3 +110,2 @@\n-        assert(_scanned_cld != nullptr, \"inv\");\n-        if (is_in_young_gen(new_obj) && !_scanned_cld->has_modified_oops()) {\n-          _scanned_cld->record_modified_oops();\n+        if (is_in_young_gen(new_obj) && !_has_oops_into_young_gen) {\n+          _has_oops_into_young_gen = true;\n@@ -111,10 +116,0 @@\n-  public:\n-    CLDOopClosure(DefNewGeneration* g) : OffHeapScanClosure(g),\n-      _scanned_cld(nullptr) {}\n-\n-    void set_scanned_cld(ClassLoaderData* cld) {\n-      assert(cld == nullptr || _scanned_cld == nullptr, \"Must be\");\n-      _scanned_cld = cld;\n-    }\n-\n-    void do_oop(oop* p)       { do_oop_work(p); }\n@@ -124,1 +119,1 @@\n-  CLDOopClosure _oop_closure;\n+  DefNewGeneration* _g;\n@@ -126,1 +121,1 @@\n-  CLDScanClosure(DefNewGeneration* g) : _oop_closure(g) {}\n+  CLDScanClosure(DefNewGeneration* g) : _g(g) {}\n@@ -131,1 +126,3 @@\n-    if (cld->has_modified_oops()) {\n+    if (!cld->has_modified_oops()) {\n+      return;\n+    }\n@@ -133,3 +130,1 @@\n-      \/\/ Tell the closure which CLD is being scanned so that it can be dirtied\n-      \/\/ if oops are left pointing into the young gen.\n-      _oop_closure.set_scanned_cld(cld);\n+    CLDOopClosure oop_closure{_g};\n@@ -137,2 +132,2 @@\n-      \/\/ Clean the cld since we're going to scavenge all the metadata.\n-      cld->oops_do(&_oop_closure, ClassLoaderData::_claim_none, \/*clear_modified_oops*\/true);\n+    \/\/ Clean the cld since we're going to scavenge all the metadata.\n+    cld->oops_do(&oop_closure, ClassLoaderData::_claim_none, \/*clear_modified_oops*\/true);\n@@ -140,1 +135,2 @@\n-      _oop_closure.set_scanned_cld(nullptr);\n+    if (oop_closure._has_oops_into_young_gen) {\n+      cld->record_modified_oops();\n","filename":"src\/hotspot\/share\/gc\/serial\/defNewGeneration.cpp","additions":21,"deletions":25,"binary":false,"changes":46,"status":"modified"}]}