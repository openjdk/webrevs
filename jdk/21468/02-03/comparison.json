{"files":[{"patch":"@@ -26,1 +26,1 @@\n- * @summary Verifies NotifyFramePop request is cleared if JVMTI_EVENT_FRAME_POP is disabled\n+ * @summary JVMTI FRAME_POP event is sometimes missed if NotifyFramePop is called as a method is returning\n@@ -37,12 +37,0 @@\n-    static volatile int notifyCount = 0;\n-\n-    static {\n-        try {\n-            System.loadLibrary(\"NotifyFramePopStressTest\");\n-        } catch (UnsatisfiedLinkError ex) {\n-            System.err.println(\"Could not load NotifyFramePopStressTest library\");\n-            System.err.println(\"java.library.path:\"\n-                + System.getProperty(\"java.library.path\"));\n-            throw ex;\n-        }\n-    }\n@@ -87,1 +75,3 @@\n-        System.out.println(\"control has started\");\n+        int notifyCount = 0;\n+\n+        log(\"control has started\");\n@@ -92,1 +82,1 @@\n-                System.out.println(\"control incremented notifyCount to \" + notifyCount);\n+                log(\"control incremented notifyCount to \" + notifyCount);\n@@ -103,3 +93,2 @@\n-            if (waitCount > 50) {\n-                System.out.println(\"About to fail. notifyCount=\" + notifyCount +\n-                                   \" getPopCount()=\" + getPopCount());\n+            if (waitCount > 100) {\n+                log(\"About to fail. notifyCount=\" + notifyCount + \" getPopCount()=\" + getPopCount());\n@@ -109,1 +98,1 @@\n-        System.out.println(\"control has finished: \" + notifyCount);\n+        log(\"control has finished: \" + notifyCount);\n@@ -124,1 +113,1 @@\n-    private static int fetchInt() {\n+    private static int fetchIntFoo() {\n@@ -128,0 +117,4 @@\n+    private static int fetchIntBar() {\n+        return 33;\n+    }\n+\n@@ -129,1 +122,1 @@\n-        return fetchInt();\n+        return fetchIntFoo();\n@@ -133,1 +126,1 @@\n-        return fetchInt();\n+        return fetchIntBar();\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/events\/NotifyFramePopStressTest\/NotifyFramePopStressTest.java","additions":15,"deletions":22,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -33,13 +33,1 @@\n-#ifndef JNI_ENV_ARG\n-\n-#ifdef __cplusplus\n-#define JNI_ENV_ARG(x, y) y\n-#define JNI_ENV_PTR(x) x\n-#else\n-#define JNI_ENV_ARG(x,y) x, y\n-#define JNI_ENV_PTR(x) (*x)\n-#endif\n-\n-#endif\n-\n-static jvmtiEnv *jvmti = NULL;\n+static jvmtiEnv *jvmti = nullptr;\n@@ -48,2 +36,3 @@\n-static volatile jint popCount = 0;\n-static char* lastNotifyMethod;\n+static volatile jint pop_count = 0;\n+static char* volatile last_notify_method;\n+static volatile jboolean failed = JNI_FALSE;\n@@ -51,1 +40,0 @@\n-static jboolean failed = JNI_FALSE;\n@@ -74,3 +62,3 @@\n-  jclass cls = NULL;\n-  char* csig = NULL;\n-  char* name = NULL;\n+  jclass cls = nullptr;\n+  char* csig = nullptr;\n+  char* name = nullptr;\n@@ -78,1 +66,1 @@\n-  popCount++;\n+  pop_count++;\n@@ -83,1 +71,1 @@\n-  err =jvmti->GetClassSignature(cls, &csig, NULL);\n+  err =jvmti->GetClassSignature(cls, &csig, nullptr);\n@@ -87,1 +75,1 @@\n-  LOG(\"FramePop(%d) event from method: %s %s\\n\", popCount, csig, name);\n+  LOG(\"FramePop(%d) event from method: %s %s\\n\", pop_count, csig, name);\n@@ -90,2 +78,2 @@\n-    if (strcmp(name, lastNotifyMethod) != 0) {\n-      LOG(\"ERROR: FramePop event is for wrong method: expected %s, got %s\\n\", lastNotifyMethod, name);\n+    if (strcmp(name, (char*)last_notify_method) != 0) {\n+      LOG(\"ERROR: FramePop event is for wrong method: expected %s, got %s\\n\", last_notify_method, name);\n@@ -93,1 +81,4 @@\n-      fatal(jni, \"DBG: FramePop event in wrong method\\n\");\n+      deallocate(jvmti, jni, csig);\n+      deallocate(jvmti, jni, name);\n+      deallocate(jvmti, jni, (void*)last_notify_method);\n+      fatal(jni, \"FramePop event in wrong method\\n\");\n@@ -95,1 +86,0 @@\n-    deallocate(jvmti, jni, lastNotifyMethod);\n@@ -97,0 +87,1 @@\n+  deallocate(jvmti, jni, (void*)last_notify_method);\n@@ -106,2 +97,2 @@\n-  res = JNI_ENV_PTR(jvm)->GetEnv(JNI_ENV_ARG(jvm, (void **) &jvmti), JVMTI_VERSION_9);\n-  if (res != JNI_OK || jvmti == NULL) {\n+  res = jvm->GetEnv((void **) &jvmti, JVMTI_VERSION_9);\n+  if (res != JNI_OK || jvmti == nullptr) {\n@@ -160,0 +151,1 @@\n+      deallocate(jvmti, jni, name);\n@@ -168,0 +160,2 @@\n+    LOG(\"\\nNotifyFramePop for method %d returned acceptable error: %s\\n\", name, TranslateError(err));\n+    deallocate(jvmti, jni, name);\n@@ -178,1 +172,1 @@\n-    lastNotifyMethod = name;\n+    last_notify_method = name;\n@@ -195,1 +189,1 @@\n-  return popCount;\n+  return pop_count;\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/events\/NotifyFramePopStressTest\/libNotifyFramePopStressTest.cpp","additions":24,"deletions":30,"binary":false,"changes":54,"status":"modified"}]}