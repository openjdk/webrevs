{"files":[{"patch":"@@ -37,1 +37,0 @@\n-import java.util.HashSet;\n@@ -39,0 +38,1 @@\n+import java.util.regex.Matcher;\n@@ -40,0 +40,1 @@\n+import java.util.stream.Collectors;\n@@ -42,0 +43,2 @@\n+    private static final Pattern optPattern = Pattern.compile(\"\\\\s*\\\\w+\\\\s\\\\w+\\\\s+=\");\n+\n@@ -43,2 +46,0 @@\n-        Set<String> optNameSet = new HashSet<>();\n-        var optPattern = Pattern.compile(\"\\\\s*\\\\w+\\\\s\\\\w+\\\\s+=\");\n@@ -46,11 +47,1 @@\n-        var output = new OutputAnalyzer(pb.start());\n-        for (var line : output.asLines()) {\n-            var m = optPattern.matcher(line);\n-            if (m.find()) {\n-                optNameSet.add(m.group());\n-            }\n-        }\n-        if (optNameSet.isEmpty()) {\n-            throw new RuntimeException(\"Sanity test failed: no match for option pattern in first output\");\n-        }\n-\n+        var flagsFinal = makeOptionNameSet(new OutputAnalyzer(pb.start()));\n@@ -59,12 +50,5 @@\n-        output = new OutputAnalyzer(pb.start());\n-        for (var line : output.asLines()) {\n-            var m = optPattern.matcher(line);\n-            if (m.find()) {\n-                if (!optNameSet.contains(m.group())) {\n-                    output.reportDiagnosticSummary();\n-                    System.err.println(\"VMOption names from first run:\");\n-                    optNameSet.forEach(System.err::println);\n-                    throw new RuntimeException(\"'\" + m.group() +\n-                            \"' not expected in PrintFlagsFinal output without vs with unlocked options\");\n-                }\n-            }\n+        var flagsFinalUnlocked = makeOptionNameSet(new OutputAnalyzer(pb.start()));\n+\n+        if (!flagsFinal.equals(flagsFinalUnlocked)) {\n+            throw new RuntimeException(\"+PrintFlagsFinal should produce the same output\" +\n+                    \" whether or not UnlockExperimentalVMOptions and UnlockDiagnosticVMOptions are set\");\n@@ -72,0 +56,1 @@\n+    }\n@@ -73,0 +58,10 @@\n+    private static Set<String> makeOptionNameSet(OutputAnalyzer output) {\n+        Set<String> optNameSet = output.asLines().stream()\n+                .map(optPattern::matcher)\n+                .filter(Matcher::find)\n+                .map(Matcher::group)\n+                .collect(Collectors.toSet());\n+        if (optNameSet.isEmpty()) {\n+            throw new RuntimeException(\"Sanity test failed: no match for option pattern in process output\");\n+        }\n+        return optNameSet;\n@@ -74,0 +69,1 @@\n+\n","filename":"test\/hotspot\/jtreg\/runtime\/CommandLine\/PrintAllFlags.java","additions":22,"deletions":26,"binary":false,"changes":48,"status":"modified"}]}