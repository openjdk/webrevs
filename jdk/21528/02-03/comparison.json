{"files":[{"patch":"@@ -576,1 +576,1 @@\n-        long start = SocketConnectEvent.timestamp();\n+        long connectStart = 0L;\n@@ -578,0 +578,1 @@\n+\n@@ -586,0 +587,1 @@\n+                    connectStart = SocketConnectEvent.timestamp();\n@@ -620,2 +622,2 @@\n-        if (SocketConnectEvent.enabled()) {\n-            SocketConnectEvent.offer(start, isa.getHostString(), address, port, connectEx);\n+        if (connectStart != 0L && SocketConnectEvent.enabled()) {\n+            SocketConnectEvent.offer(connectStart, isa.getHostString(), address, port, connectEx);\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/NioSocketImpl.java","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -136,2 +136,3 @@\n-    \/\/ timestamp for socket connect event\n-    private long connectStartTimestamp;\n+    \/\/ JFR support, start time of non-blocking connect\n+    private long nonBlockingConnectStart;\n+\n@@ -863,1 +864,1 @@\n-     * @param isa the remote address\n+     * @param sa the remote socket address\n@@ -956,0 +957,2 @@\n+        SocketAddress sa = checkRemote(remote);\n+\n@@ -957,0 +960,1 @@\n+        long connectStart = 0L;\n@@ -958,2 +962,1 @@\n-        long start = SocketConnectEvent.timestamp();\n-        SocketAddress sa = checkRemote(remote);\n+\n@@ -965,1 +968,0 @@\n-                    connectStartTimestamp = start;\n@@ -971,0 +973,1 @@\n+                        connectStart = SocketConnectEvent.timestamp();\n@@ -987,0 +990,3 @@\n+                        } else {\n+                            \/\/ non-blocking and not connected\n+                            this.nonBlockingConnectStart = connectStart;\n@@ -991,1 +997,0 @@\n-                    return connected;\n@@ -1002,0 +1007,13 @@\n+        }\n+\n+        \/\/ record JFR event\n+        if (connectStart != 0L\n+                && SocketConnectEvent.enabled()\n+                && (connected || connectEx != null)) {\n+            SocketConnectEvent.offer(connectStart, sa, connectEx);\n+        }\n+\n+        if (connectEx == null) {\n+            return connected;\n+        } else {\n+            assert !connected;\n@@ -1003,4 +1021,0 @@\n-        } finally {\n-            if (SocketConnectEvent.enabled() && (connected || connectEx != null)) {\n-                SocketConnectEvent.offer(start, sa, connectEx);\n-            }\n@@ -1060,0 +1074,1 @@\n+        long connectStart = 0L;\n@@ -1062,1 +1077,0 @@\n-        long start = 0;\n@@ -1065,1 +1079,0 @@\n-            start = connectStartTimestamp;\n@@ -1070,5 +1083,2 @@\n-                    if (isConnected()) {\n-                        connected = true;\n-                        return connected;\n-                    }\n-\n+                    if (isConnected())\n+                        return true;\n@@ -1079,0 +1089,1 @@\n+                        connectStart = this.nonBlockingConnectStart;\n@@ -1091,1 +1102,0 @@\n-                    return connected;\n@@ -1102,0 +1112,11 @@\n+        }\n+\n+        \/\/ record JFR event\n+        if (connectStart != 0L\n+                && SocketConnectEvent.enabled()\n+                && (connected || connectEx != null)) {\n+            SocketConnectEvent.offer(connectStart, remoteAddress(), connectEx);\n+        }\n+\n+        if (connectEx != null) {\n+            assert !connected;\n@@ -1103,4 +1124,2 @@\n-        } finally {\n-            if (SocketConnectEvent.enabled() && (connected || connectEx != null)) {\n-                SocketConnectEvent.offer(start, remoteAddress, connectEx);\n-            }\n+        } else {\n+            return connected;\n@@ -1330,0 +1349,3 @@\n+\n+        long connectStart = 0L;\n+        IOException connectEx = null;\n@@ -1343,0 +1365,1 @@\n+                            connectStart = SocketConnectEvent.timestamp();\n@@ -1366,1 +1389,10 @@\n-            throw SocketExceptions.of(ioe, sa);\n+            connectEx = SocketExceptions.of(ioe, sa);\n+        }\n+\n+        \/\/ record JFR event\n+        if (connectStart != 0L && SocketConnectEvent.enabled()) {\n+            SocketConnectEvent.offer(connectStart, sa, connectEx);\n+        }\n+\n+        if (connectEx != null) {\n+            throw connectEx;\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/SocketChannelImpl.java","additions":56,"deletions":24,"binary":false,"changes":80,"status":"modified"}]}