{"files":[{"patch":"@@ -586,4 +586,1 @@\n-  \/\/ There should not be any VTMS transition here. This is for safety.\n-  if (java_thread->is_in_VTMS_transition()) {\n-    jvf = JvmtiEnvBase::check_and_skip_hidden_frames(java_thread, jvf);\n-  }\n+  jvf = JvmtiEnvBase::check_and_skip_hidden_frames(java_thread, jvf);\n@@ -659,1 +656,2 @@\n-  \/\/ The yield and yield0 may appear in an unmounted continuation.\n+  \/\/ The yield and yield0 may appear in an unmounted virtual thread.\n+  \/\/ The notifyJvmti* may appear in both carrier or virtual threads.\n@@ -691,2 +689,2 @@\n-    jvf = check_and_skip_hidden_frames(jt->is_in_VTMS_transition(), jvf);\n-  } else if (is_virtual) { \/\/ filter out pure continuations\n+    jvf = check_and_skip_hidden_frames(true, jvf);\n+  } else if (is_virtual || jt->last_continuation() == nullptr) { \/\/ filter out pure continuations\n@@ -703,1 +701,1 @@\n-      jvf = check_and_skip_hidden_frames(java_lang_Thread::is_in_VTMS_transition(vthread), jvf);\n+      jvf = check_and_skip_hidden_frames(true, jvf);\n@@ -749,6 +747,2 @@\n-  \/\/ There should not be any VTMS transition here. This is for safety.\n-  if (jt->is_in_VTMS_transition()) {\n-    \/\/ Skip hidden frames only for carrier threads\n-    \/\/ which are in non-temporary VTMS transition.\n-    jvf = check_and_skip_hidden_frames(jt, jvf);\n-  }\n+  \/\/ Skip hidden frames for carrier threads only.\n+  jvf = check_and_skip_hidden_frames(jt, jvf);\n@@ -2015,11 +2009,1 @@\n-  oop thread_oop = JNIHandles::resolve_external_guard(target);\n-  bool is_virtual = java_lang_VirtualThread::is_instance(thread_oop);\n-\n-  \/\/ Target can be virtual or platform thread.\n-  \/\/ Disable VTMS transition for one thread if it is virtual.\n-  \/\/ Otherwise, disable VTMS transitions for all threads.\n-  \/\/ For the latter, VTMS transitions are disabled for all threads by several reasons:\n-  \/\/ - carrier threads can mount virtual threads which may cause incorrect behavior\n-  \/\/ - it is a good invariant when a thread's handshake can't be impacted by a VTMS transition\n-  \/\/ - there is no mechanism to disable transitions of a specific carrier thread yet\n-  JvmtiVTMSTransitionDisabler disabler(is_virtual ? target : nullptr); \/\/ nullptr is to disable all\n+  JvmtiVTMSTransitionDisabler disabler(target);\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":9,"deletions":25,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -1814,1 +1814,2 @@\n-  if ((mh->jvmti_mount_transition() && state->is_virtual()) || thread->is_in_any_VTMS_transition()) {\n+  if ((mh->jvmti_mount_transition() && (state->is_virtual() || thread->last_continuation() == nullptr)) ||\n+    thread->is_in_any_VTMS_transition()) {\n@@ -1899,1 +1900,2 @@\n-  if ((mh->jvmti_mount_transition() && state->is_virtual()) || thread->is_in_any_VTMS_transition()) {\n+  if ((mh->jvmti_mount_transition() && (state->is_virtual() || thread->last_continuation() == nullptr)) ||\n+    thread->is_in_any_VTMS_transition()) {\n@@ -1976,1 +1978,2 @@\n-  if ((mh->jvmti_mount_transition() && state->is_virtual()) || thread->is_in_any_VTMS_transition()) {\n+  if ((mh->jvmti_mount_transition() && (state->is_virtual() || thread->last_continuation() == nullptr)) ||\n+      thread->is_in_any_VTMS_transition()) {\n@@ -2141,1 +2144,2 @@\n-      if ((mh->jvmti_mount_transition() && state->is_virtual()) || thread->is_in_any_VTMS_transition()) {\n+      if ((mh->jvmti_mount_transition() && (state->is_virtual() || thread->last_continuation() == nullptr)) ||\n+        thread->is_in_any_VTMS_transition()) {\n","filename":"src\/hotspot\/share\/prims\/jvmtiExport.cpp","additions":8,"deletions":4,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -268,0 +268,11 @@\n+  oop thread_oop = JNIHandles::resolve_external_guard(thread);\n+\n+  \/\/ Target can be virtual or platform thread.\n+  \/\/ If traget is a platform thread then we have to disable VTMS transitions for all threads.\n+  \/\/ It is by several reasons:\n+  \/\/ - carrier threads can mount virtual threads which may cause incorrect behavior\n+  \/\/ - there is no mechanism to disable transitions for a specific carrier thread yet\n+  if (!java_lang_VirtualThread::is_instance(thread_oop)) {\n+    _thread = nullptr; \/\/ target is a platform thread, switch to disabling VTMS transitions for all threads\n+  }\n+\n","filename":"src\/hotspot\/share\/prims\/jvmtiThreadState.cpp","additions":11,"deletions":0,"binary":false,"changes":11,"status":"modified"}]}