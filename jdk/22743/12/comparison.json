{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -1511,0 +1511,1 @@\n+  _in_reserved_space = false;\n@@ -1892,1 +1893,1 @@\n-  assert(r->mapped_base() == nullptr, \"must be not mapped yet\");\n+  assert(!is_mapped(), \"must be not mapped yet\");\n@@ -1896,0 +1897,1 @@\n+  r->set_in_reserved_space(false);\n@@ -1920,1 +1922,0 @@\n-      return MAP_ARCHIVE_SUCCESS;\n@@ -1942,0 +1943,1 @@\n+  }\n@@ -1943,1 +1945,6 @@\n-    return MAP_ARCHIVE_SUCCESS;\n+  if (rs.is_reserved()) {\n+    char* mapped_base = r->mapped_base();\n+    assert(rs.base() <= mapped_base && mapped_base + size <= rs.end(),\n+           PTR_FORMAT \" <= \" PTR_FORMAT \" < \" PTR_FORMAT \" <= \" PTR_FORMAT,\n+           p2i(rs.base()), p2i(mapped_base), p2i(mapped_base + size), p2i(rs.end()));\n+    r->set_in_reserved_space(rs.is_reserved());\n@@ -1945,0 +1952,1 @@\n+  return MAP_ARCHIVE_SUCCESS;\n@@ -2362,1 +2370,0 @@\n-      unmap_region(MetaspaceShared::hp);\n@@ -2431,2 +2438,8 @@\n-      if (!os::unmap_memory(mapped_base, size)) {\n-        fatal(\"os::unmap_memory failed\");\n+      if (r->in_reserved_space()) {\n+        \/\/ This region was mapped inside a ReservedSpace. Its memory will be freed when the ReservedSpace\n+        \/\/ is released. Zero it so that we don't accidentally read its content.\n+        log_info(cds)(\"Region #%d (%s) is in a reserved space, it will be freed when the space is released\", i, shared_region_name[i]);\n+      } else {\n+        if (!os::unmap_memory(mapped_base, size)) {\n+          fatal(\"os::unmap_memory failed\");\n+        }\n","filename":"src\/hotspot\/share\/cds\/filemap.cpp","additions":20,"deletions":7,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -166,0 +166,1 @@\n+  bool   in_reserved_space()        const { return _in_reserved_space; }\n@@ -171,0 +172,1 @@\n+  void set_in_reserved_space(bool is_reserved) { _in_reserved_space = is_reserved; }\n","filename":"src\/hotspot\/share\/cds\/filemap.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -73,0 +73,1 @@\n+  bool    _in_reserved_space; \/\/ Is this region in a ReservedSpace\n","filename":"src\/hotspot\/share\/include\/cds.h","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}