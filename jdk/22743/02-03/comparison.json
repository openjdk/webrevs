{"files":[{"patch":"@@ -1892,1 +1892,1 @@\n-  assert(r->mapped_base() == nullptr, \"must be not mapped yet\");\n+  assert(!is_mapped(), \"must be not mapped yet\");\n@@ -2362,1 +2362,1 @@\n-      unmap_region(MetaspaceShared::hp);\n+      unmap_non_reserved_region(MetaspaceShared::hp);\n@@ -2418,1 +2418,1 @@\n-    \/\/ freed when the ReservedSpace is released.\n+    \/\/ freed when the ReservedSpace is released. Skip unmap here to avoid a double release\n@@ -2420,2 +2420,8 @@\n-      \/\/ Treat this region as if it has been unmapped\n-      region_at(idx)->set_mapped_base(nullptr);\n+      FileMapRegion* r = region_at(idx);\n+      char* mapped_base = r->mapped_base();\n+      size_t size = r->used_aligned();\n+\n+      assert(rs.is_reserved(), \"must be\");\n+      assert(rs.base() <= mapped_base && mapped_base + size <= rs.end(),\n+            PTR_FORMAT \" <= \" PTR_FORMAT \" < \" PTR_FORMAT \" <= \" PTR_FORMAT,\n+            p2i(rs.base()), p2i(mapped_base), p2i(mapped_base + size), p2i(rs.end()));\n@@ -2423,1 +2429,1 @@\n-      unmap_region(idx);\n+      unmap_non_reserved_region(idx);\n@@ -2447,0 +2453,6 @@\n+\/\/ The mapped region is not within a reserved space so it can be\n+\/\/ released directly\n+void FileMapInfo::unmap_non_reserved_region(int i) {\n+  unmap_region(i);\n+}\n+\n","filename":"src\/hotspot\/share\/cds\/filemap.cpp","additions":18,"deletions":6,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -370,0 +370,1 @@\n+  void  unmap_region(int i);\n@@ -481,1 +482,1 @@\n-  void  unmap_region(int i);\n+  void unmap_non_reserved_region(int i);\n","filename":"src\/hotspot\/share\/cds\/filemap.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1351,0 +1351,2 @@\n+    \/\/ The RW and RO regions are in a reserved space so they must only be\n+    \/\/ unmapped when the reserved space is released\n@@ -1634,1 +1636,1 @@\n-    mapinfo->unmap_region(MetaspaceShared::bm);\n+    mapinfo->unmap_non_reserved_region(MetaspaceShared::bm);\n@@ -1674,1 +1676,1 @@\n-  static_mapinfo->unmap_region(MetaspaceShared::bm);\n+  static_mapinfo->unmap_non_reserved_region(MetaspaceShared::bm);\n@@ -1683,1 +1685,1 @@\n-    dynamic_mapinfo->unmap_region(MetaspaceShared::bm);\n+    dynamic_mapinfo->unmap_non_reserved_region(MetaspaceShared::bm);\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"}]}