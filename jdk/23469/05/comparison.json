{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2011, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -25,1 +25,1 @@\n- * @test\n+ * @test id=\"separateServerThread\"\n@@ -29,1 +29,1 @@\n- * @run main\/othervm CloseKeepAliveCached\n+ * @library \/test\/lib\n@@ -31,2 +31,2 @@\n- *     SunJSSE does not support dynamic system properties, no way to re-use\n- *     system properties in samevm\/agentvm mode.\n+ * @run main\/othervm -Dtest.separateThreads=true CloseKeepAliveCached false\n+ * @run main\/othervm -Dtest.separateThreads=true CloseKeepAliveCached true\n@@ -34,2 +34,2 @@\n- * @ignore\n- *    After run the test manually, at the end of the debug output,\n+ * @comment SunJSSE does not support dynamic system properties, no way to re-use\n+ *    system properties in samevm\/agentvm mode.\n@@ -40,4 +40,33 @@\n-import java.net.*;\n-import java.util.*;\n-import java.io.*;\n-import javax.net.ssl.*;\n+\/*\n+ * @test id=\"separateClientThread\"\n+ * @bug 6618387\n+ * @summary SSL client sessions do not close cleanly. A TCP reset occurs\n+ *      instead of a close_notify alert.\n+ * @library \/test\/lib\n+ *\n+ * @run main\/othervm -Dtest.separateThreads=false CloseKeepAliveCached false\n+ * @run main\/othervm -Dtest.separateThreads=false CloseKeepAliveCached true\n+ *\n+ * @comment SunJSSE does not support dynamic system properties, no way to re-use\n+ *    system properties in samevm\/agentvm mode.\n+ *    if \"MainThread, called close()\" found, the test passed. Otherwise,\n+ *    if \"Keep-Alive-Timer: called close()\", the test failed.\n+ *\/\n+\n+import jdk.test.lib.Asserts;\n+\n+import java.io.BufferedOutputStream;\n+import java.io.BufferedReader;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.InputStreamReader;\n+import java.io.PrintStream;\n+import java.net.URI;\n+import java.net.URL;\n+import javax.net.ssl.HostnameVerifier;\n+import javax.net.ssl.HttpsURLConnection;\n+import javax.net.ssl.SSLServerSocket;\n+import javax.net.ssl.SSLServerSocketFactory;\n+import javax.net.ssl.SSLSession;\n+import javax.net.ssl.SSLSocket;\n@@ -46,2 +75,1 @@\n-    static Map cookies;\n-    ServerSocket ss;\n+    public static final String CLOSE_THE_SSL_CONNECTION_PASSIVE = \"close the SSL connection (passive)\";\n@@ -60,1 +88,1 @@\n-    static boolean separateServerThread = true;\n+    static boolean separateServerThread = Boolean.getBoolean(\"test.separateThreads\");\n@@ -75,5 +103,0 @@\n-    \/*\n-     * Turn on SSL debugging?\n-     *\/\n-    static boolean debug = false;\n-\n@@ -89,5 +112,2 @@\n-        SSLServerSocketFactory sslssf =\n-            (SSLServerSocketFactory) SSLServerSocketFactory.getDefault();\n-        sslServerSocket =\n-            (SSLServerSocket) sslssf.createServerSocket(serverPort);\n-        serverPort = sslServerSocket.getLocalPort();\n+        SSLServerSocketFactory sslSsf =\n+                (SSLServerSocketFactory) SSLServerSocketFactory.getDefault();\n@@ -95,10 +115,3 @@\n-        \/*\n-         * Signal Client, we're ready for his connect.\n-         *\/\n-        serverReady = true;\n-        SSLSocket sslSocket = null;\n-        try {\n-            sslSocket = (SSLSocket) sslServerSocket.accept();\n-            for (int i = 0; i < 3 && !sslSocket.isClosed(); i++) {\n-                \/\/ read request\n-                InputStream is = sslSocket.getInputStream ();\n+        \/\/ autoclose sslServerSocket, but keeping it global to be used by the client\n+        try (var _ = this.sslServerSocket = (SSLServerSocket) sslSsf.createServerSocket(serverPort)) {\n+            serverPort = sslServerSocket.getLocalPort();\n@@ -106,0 +119,8 @@\n+            \/*\n+             * Signal Client, we're ready for his connect.\n+             *\/\n+            serverReady = true;\n+            try (SSLSocket sslSocket = (SSLSocket) sslServerSocket.accept()) {\n+\n+                \/\/ getting input and output streams\n+                InputStream is = sslSocket.getInputStream();\n@@ -107,5 +128,12 @@\n-                                                new InputStreamReader(is));\n-                String x;\n-                while ((x=r.readLine()) != null) {\n-                    if (x.length() ==0) {\n-                        break;\n+                        new InputStreamReader(is));\n+                PrintStream out = new PrintStream(\n+                        new BufferedOutputStream(\n+                                sslSocket.getOutputStream()));\n+\n+                for (int i = 0; i < 3 && !sslSocket.isClosed(); i++) {\n+                    \/\/ read request\n+                    String x;\n+                    while ((x = r.readLine()) != null) {\n+                        if (x.isEmpty()) {\n+                            break;\n+                        }\n@@ -113,1 +141,0 @@\n-                }\n@@ -115,0 +142,9 @@\n+                    \/* send the response headers and body *\/\n+                    out.print(\"HTTP\/1.1 200 OK\\r\\n\");\n+                    out.print(\"Keep-Alive: timeout=15, max=100\\r\\n\");\n+                    out.print(\"Connection: Keep-Alive\\r\\n\");\n+                    out.print(\"Content-Type: text\/html; charset=iso-8859-1\\r\\n\");\n+                    out.print(\"Content-Length: 9\\r\\n\");\n+                    out.print(\"\\r\\n\");\n+                    out.print(\"Testing\\r\\n\");\n+                    out.flush();\n@@ -116,15 +152,1 @@\n-                PrintStream out = new PrintStream(\n-                                 new BufferedOutputStream(\n-                                    sslSocket.getOutputStream() ));\n-\n-                \/* send the header *\/\n-                out.print(\"HTTP\/1.1 200 OK\\r\\n\");\n-                out.print(\"Keep-Alive: timeout=15, max=100\\r\\n\");\n-                out.print(\"Connection: Keep-Alive\\r\\n\");\n-                out.print(\"Content-Type: text\/html; charset=iso-8859-1\\r\\n\");\n-                out.print(\"Content-Length: 9\\r\\n\");\n-                out.print(\"\\r\\n\");\n-                out.print(\"Testing\\r\\n\");\n-                out.flush();\n-\n-                Thread.sleep(50);\n+                }\n@@ -132,4 +154,0 @@\n-            sslSocket.close();\n-            sslServerSocket.close();\n-        } catch (Exception e) {\n-            e.printStackTrace();\n@@ -137,0 +155,1 @@\n+\n@@ -154,1 +173,1 @@\n-            HttpsURLConnection.getDefaultHostnameVerifier();\n+                HttpsURLConnection.getDefaultHostnameVerifier();\n@@ -156,1 +175,1 @@\n-            HttpsURLConnection http = null;\n+            HttpsURLConnection http;\n@@ -159,1 +178,1 @@\n-            URL url = new URL(\"https:\/\/localhost:\" + serverPort+\"\/\");\n+            URL url = new URI(\"https:\/\/localhost:\" + serverPort + \"\/\").toURL();\n@@ -161,4 +180,4 @@\n-            http = (HttpsURLConnection)url.openConnection();\n-            InputStream is = http.getInputStream ();\n-            while (is.read() != -1);\n-            is.close();\n+            http = (HttpsURLConnection) url.openConnection();\n+            try (InputStream is = http.getInputStream()) {\n+                while (is.read() != -1) ;\n+            }\n@@ -166,4 +185,4 @@\n-            url = new URL(\"https:\/\/localhost:\" + serverPort+\"\/\");\n-            http = (HttpsURLConnection)url.openConnection();\n-            is = http.getInputStream ();\n-            while (is.read() != -1);\n+            url = new URI(\"https:\/\/localhost:\" + serverPort + \"\/\").toURL();\n+            http = (HttpsURLConnection) url.openConnection();\n+            InputStream is = http.getInputStream(); \/\/ not closed by design\n+            while (is.read() != -1) ;\n@@ -173,1 +192,1 @@\n-            \/\/ wanna close the keep-alive cached connection immediately\n+            \/\/ want to close the keep-alive cached connection immediately\n@@ -183,1 +202,0 @@\n-            \/\/ Thread.sleep(5000);\n@@ -185,1 +203,1 @@\n-            if (sslServerSocket != null)\n+            if (sslServerSocket != null) {\n@@ -187,0 +205,1 @@\n+            }\n@@ -210,1 +229,4 @@\n-    public static void main(String args[]) throws Exception {\n+    public static void main(String[] args) throws Exception {\n+        separateServerThread = Boolean.parseBoolean(args[0]);\n+        System.out.printf(\"separateServerThread: %s%n\", separateServerThread);\n+\n@@ -212,1 +234,1 @@\n-            System.getProperty(\"test.src\", \".\/\") + \"\/\" + pathToStores +\n+                System.getProperty(\"test.src\", \".\/\") + \"\/\" + pathToStores +\n@@ -215,1 +237,1 @@\n-            System.getProperty(\"test.src\", \".\/\") + \"\/\" + pathToStores +\n+                System.getProperty(\"test.src\", \".\/\") + \"\/\" + pathToStores +\n@@ -223,2 +245,7 @@\n-        if (debug)\n-            System.setProperty(\"javax.net.debug\", \"all\");\n+        System.setProperty(\"javax.net.debug\", \"all\");\n+\n+        \/\/ setting up the error stream for further analysis\n+        var errorCapture = new ByteArrayOutputStream();\n+        var errorStream = new PrintStream(errorCapture);\n+        var originalErr = System.err; \/\/ saving the initial error stream, so it can be restored\n+        System.setErr(errorStream);\n@@ -229,1 +256,34 @@\n-        new CloseKeepAliveCached();\n+        try {\n+            new CloseKeepAliveCached();\n+        } finally {\n+            \/\/ this will allow the error stream to be printed in case of an exception inside for debugging purposes\n+            System.setErr(originalErr);\n+            if (Boolean.getBoolean(\"test.debug\")) {\n+                System.err.println(errorCapture);\n+            }\n+        }\n+\n+        \/\/ Parses the captured error stream, which is used by debug, to find out who closed the SSL connection\n+        \/\/ example of pass: javax.net.ssl|DEBUG|91|MainThread|...|close the SSL connection (passive)\n+        \/\/ example of fail: javax.net.ssl|DEBUG|C1|Keep-Alive-Timer|...|close the SSL connection (passive)\n+        var isTestPassed = false;\n+        for (final String line : errorCapture.toString().split(\"\\n\")) {\n+            if (line.contains(CLOSE_THE_SSL_CONNECTION_PASSIVE) &&\n+                line.contains(\"MainThread\")) {\n+\n+                System.out.println(\"close was called by the MainThread: \");\n+                System.out.println(line);\n+\n+                isTestPassed = true;\n+                break;\n+            } else if (line.contains(CLOSE_THE_SSL_CONNECTION_PASSIVE) &&\n+                       line.contains(\"Keep-Alive-Timer\")) {\n+\n+                System.out.println(\"close was called by the Keep-Alive-Timer: \");\n+                System.out.println(line);\n+\n+                throw new RuntimeException(\"SSL connection was closed by the Keep-Alive-Timer. Should have been MainThread\");\n+            }\n+        }\n+\n+        Asserts.assertTrue(isTestPassed, \"Test pass result\");\n@@ -234,0 +294,1 @@\n+\n@@ -272,14 +333,12 @@\n-            serverThread = new Thread() {\n-                public void run() {\n-                    try {\n-                        doServerSide();\n-                    } catch (Exception e) {\n-                        \/*\n-                         * Our server thread just died.\n-                         *\n-                         * Release the client, if not active already...\n-                         *\/\n-                        System.err.println(\"Server died...\");\n-                        serverReady = true;\n-                        serverException = e;\n-                    }\n+            serverThread = new Thread(() -> {\n+                try {\n+                    doServerSide();\n+                } catch (Exception e) {\n+                    \/*\n+                     * Our server thread just died.\n+                     *\n+                     * Release the client, if not active already...\n+                     *\/\n+                    System.err.println(\"Server died...\");\n+                    serverReady = true;\n+                    serverException = e;\n@@ -287,1 +346,1 @@\n-            };\n+            });\n@@ -296,11 +355,9 @@\n-            clientThread = new Thread() {\n-                public void run() {\n-                    try {\n-                        doClientSide();\n-                    } catch (Exception e) {\n-                        \/*\n-                         * Our client thread just died.\n-                         *\/\n-                        System.err.println(\"Client died...\");\n-                        clientException = e;\n-                    }\n+            clientThread = new Thread(() -> {\n+                try {\n+                    doClientSide();\n+                } catch (Exception e) {\n+                    \/*\n+                     * Our client thread just died.\n+                     *\/\n+                    System.err.println(\"Client died...\");\n+                    clientException = e;\n@@ -308,1 +365,1 @@\n-            };\n+            });\n","filename":"test\/jdk\/sun\/net\/www\/protocol\/https\/HttpsURLConnection\/CloseKeepAliveCached.java","additions":163,"deletions":106,"binary":false,"changes":269,"status":"modified"}]}