{"files":[{"patch":"@@ -658,2 +658,2 @@\n-  int aligned_byte_size = src_info->size_in_bytes();\n-  precond(is_aligned(aligned_byte_size, SharedSpaceObjectAlignment));\n+  int bytes = src_info->size_in_bytes(); \/\/ word-aligned\n+  size_t alignment = SharedSpaceObjectAlignment; \/\/ alignment for the dest pointer\n@@ -661,1 +661,0 @@\n-  char* dest;\n@@ -673,2 +672,0 @@\n-    \/\/ Allocate space for the future InstanceKlass with proper alignment\n-    const size_t klass_alignment =\n@@ -676,5 +673,4 @@\n-      UseCompressedClassPointers ?\n-        nth_bit(ArchiveBuilder::precomputed_narrow_klass_shift()) :\n-        SharedSpaceObjectAlignment;\n-#else\n-      SharedSpaceObjectAlignment;\n+    \/\/ More strict alignments needed for UseCompressedClassPointers\n+    if (UseCompressedClassPointers) {\n+      alignment = nth_bit(ArchiveBuilder::precomputed_narrow_klass_shift());\n+    }\n@@ -682,3 +678,4 @@\n-    dest = dump_region->allocate(aligned_byte_size, klass_alignment);\n-  } else {\n-    dest = dump_region->allocate(aligned_byte_size);\n+  } else if (src_info->msotype() == MetaspaceObj::SymbolType) {\n+    \/\/ Symbols may be allocated by using AllocateHeap, so their sizes\n+    \/\/ may be less than size_in_bytes() indicates.\n+    bytes = ((Symbol*)src)->byte_size();\n@@ -686,1 +683,0 @@\n-  char* newtop = dump_region->top();\n@@ -688,10 +684,2 @@\n-  \/\/ dest contains all zeros, so it's OK to copy fewer bytes than allocated from dump_region\n-  if (src_info->msotype() == MetaspaceObj::SymbolType) {\n-    \/\/ Symbols may be allocated using AllocateHeap, so their sizes may be less than aligned_byte_size\n-    int exact_byte_size = ((Symbol*)src)->byte_size();\n-    precond(exact_byte_size <= aligned_byte_size);\n-    memcpy(dest, src, exact_byte_size);\n-  } else {\n-    \/\/ For all other types, the memory for src was allocated with aligned_byte_size.\n-    memcpy(dest, src, aligned_byte_size);\n-  }\n+  char* dest = dump_region->allocate(bytes, alignment);\n+  memcpy(dest, src, bytes);\n@@ -721,1 +709,1 @@\n-  log_trace(aot)(\"Copy: \" PTR_FORMAT \" ==> \" PTR_FORMAT \" %d\", p2i(src), p2i(dest), aligned_byte_size);\n+  log_trace(aot)(\"Copy: \" PTR_FORMAT \" ==> \" PTR_FORMAT \" %d\", p2i(src), p2i(dest), bytes);\n@@ -724,0 +712,1 @@\n+  char* newtop = dump_region->top();\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.cpp","additions":14,"deletions":25,"binary":false,"changes":39,"status":"modified"}]}