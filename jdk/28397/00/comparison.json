{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,1 @@\n+import java.util.Arrays;\n@@ -37,0 +38,1 @@\n+import java.util.Objects;\n@@ -406,4 +408,3 @@\n-        for (String ng : sslConfig.namedGroups) {\n-            NamedGroup namedGroup = NamedGroup.nameOf(ng);\n-            if (namedGroup != null &&\n-                namedGroup.isAvailable && namedGroup.spec == type) {\n+        for (NamedGroup namedGroup :\n+                SupportedGroups.getGroupsFromConfig(sslConfig)) {\n+            if (namedGroup.isAvailable && namedGroup.spec == type) {\n@@ -444,2 +445,2 @@\n-        for (String ng : sslConfig.namedGroups) {\n-            if (namedGroup.name.equalsIgnoreCase(ng)) {\n+        for (NamedGroup ng : SupportedGroups.getGroupsFromConfig(sslConfig)) {\n+            if (namedGroup.equals(ng)) {\n@@ -459,6 +460,4 @@\n-        for (String name : sslConfig.namedGroups) {\n-            NamedGroup ng = NamedGroup.nameOf(name);\n-            if (ng != null && ng.isAvailable &&\n-                    (NamedGroupSpec.arrayContains(types, ng.spec)) &&\n-                    ng.isAvailable(negotiatedProtocol) &&\n-                    ng.isPermitted(constraints)) {\n+        for (NamedGroup ng : SupportedGroups.getGroupsFromConfig(sslConfig)) {\n+            if (ng.isAvailable && NamedGroupSpec.arrayContains(types, ng.spec)\n+                    && ng.isAvailable(negotiatedProtocol)\n+                    && ng.isPermitted(constraints)) {\n@@ -742,0 +741,1 @@\n+    \/\/ Inner class encapsulating supported named groups.\n@@ -743,1 +743,41 @@\n-        \/\/ the supported named groups, non-null immutable list\n+\n+        \/\/ Default named groups.\n+        private static final NamedGroup[] defaultGroups = new NamedGroup[]{\n+\n+                \/\/ Primary XDH (RFC 7748) curves\n+                X25519,\n+\n+                \/\/ Primary NIST Suite B curves\n+                SECP256_R1,\n+                SECP384_R1,\n+                SECP521_R1,\n+\n+                \/\/ Secondary XDH curves\n+                X448,\n+\n+                \/\/ FFDHE (RFC 7919)\n+                FFDHE_2048,\n+                FFDHE_3072,\n+                FFDHE_4096,\n+                FFDHE_6144,\n+                FFDHE_8192\n+        };\n+\n+        private static final String[] defaultNames = Arrays.stream(\n+                        defaultGroups)\n+                .filter(ng -> ng.isAvailable)\n+                \/\/ Filter default groups names against default constraints.\n+                .filter(ng -> ng.isPermitted(SSLAlgorithmConstraints.DEFAULT))\n+                .map(ng -> ng.name)\n+                .toArray(String[]::new);\n+\n+        private static final NamedGroup[] customizedGroups =\n+                getCustomizedNamedGroups();\n+\n+        private static final String[] customizedNames =\n+                customizedGroups == null ?\n+                        null : Arrays.stream(customizedGroups)\n+                        .map(ng -> ng.name)\n+                        .toArray(String[]::new);\n+\n+        \/\/ Named group names for SSLConfiguration.\n@@ -747,7 +787,32 @@\n-            \/\/ The value of the System Property defines a list of enabled named\n-            \/\/ groups in preference order, separated with comma.  For example:\n-            \/\/\n-            \/\/      jdk.tls.namedGroups=\"secp521r1, secp256r1, ffdhe2048\"\n-            \/\/\n-            \/\/ If the System Property is not defined or the value is empty, the\n-            \/\/ default groups and preferences will be used.\n+            if (customizedNames != null) {\n+                namedGroups = customizedNames;\n+            } else {\n+                if (defaultNames.length == 0) {\n+                    SSLLogger.logWarning(\"ssl\", \"No default named groups\");\n+                }\n+                namedGroups = defaultNames;\n+            }\n+        }\n+\n+        \/\/ Avoid the group lookup for default and customized groups.\n+        static NamedGroup[] getGroupsFromConfig(SSLConfiguration sslConfig) {\n+            if (sslConfig.namedGroups == defaultNames) {\n+                return defaultGroups;\n+            } else if (sslConfig.namedGroups == customizedNames) {\n+                return customizedGroups;\n+            } else {\n+                return Arrays.stream(sslConfig.namedGroups)\n+                        .map(NamedGroup::nameOf)\n+                        .filter(Objects::nonNull)\n+                        .toArray(NamedGroup[]::new);\n+            }\n+        }\n+\n+        \/\/ The value of the System Property defines a list of enabled named\n+        \/\/ groups in preference order, separated with comma.  For example:\n+        \/\/\n+        \/\/      jdk.tls.namedGroups=\"secp521r1, secp256r1, ffdhe2048\"\n+        \/\/\n+        \/\/ If the System Property is not defined or the value is empty, the\n+        \/\/ default groups and preferences will be used.\n+        private static NamedGroup[] getCustomizedNamedGroups() {\n@@ -755,0 +820,1 @@\n+\n@@ -763,1 +829,0 @@\n-            ArrayList<String> groupList;\n@@ -765,15 +830,8 @@\n-                String[] groups = property.split(\",\");\n-                groupList = new ArrayList<>(groups.length);\n-                for (String group : groups) {\n-                    group = group.trim();\n-                    if (!group.isEmpty()) {\n-                        NamedGroup namedGroup = nameOf(group);\n-                        if (namedGroup != null) {\n-                            if (namedGroup.isAvailable) {\n-                                groupList.add(namedGroup.name);\n-                            }\n-                        }   \/\/ ignore unknown groups\n-                    }\n-                }\n-\n-                if (groupList.isEmpty()) {\n+                NamedGroup[] ret = Arrays.stream(property.split(\",\"))\n+                        .map(String::trim)\n+                        .map(NamedGroup::nameOf)\n+                        .filter(Objects::nonNull)\n+                        .filter(ng -> ng.isAvailable)\n+                        .toArray(NamedGroup[]::new);\n+\n+                if (ret.length == 0) {\n@@ -782,29 +840,2 @@\n-                            property + \") contains no supported named groups\");\n-                }\n-            } else {        \/\/ default groups\n-                NamedGroup[] groups = new NamedGroup[] {\n-\n-                        \/\/ Primary XDH (RFC 7748) curves\n-                        X25519,\n-\n-                        \/\/ Primary NIST Suite B curves\n-                        SECP256_R1,\n-                        SECP384_R1,\n-                        SECP521_R1,\n-\n-                        \/\/ Secondary XDH curves\n-                        X448,\n-\n-                        \/\/ FFDHE (RFC 7919)\n-                        FFDHE_2048,\n-                        FFDHE_3072,\n-                        FFDHE_4096,\n-                        FFDHE_6144,\n-                        FFDHE_8192,\n-                    };\n-\n-                groupList = new ArrayList<>(groups.length);\n-                for (NamedGroup group : groups) {\n-                    if (group.isAvailable) {\n-                        groupList.add(group.name);\n-                    }\n+                                    property\n+                                    + \") contains no supported named groups\");\n@@ -813,4 +844,1 @@\n-                if (groupList.isEmpty() &&\n-                        SSLLogger.isOn && SSLLogger.isOn(\"ssl\")) {\n-                    SSLLogger.warning(\"No default named groups\");\n-                }\n+                return ret;\n@@ -819,1 +847,1 @@\n-            namedGroups = groupList.toArray(new String[0]);\n+            return null;\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/NamedGroup.java","additions":99,"deletions":71,"binary":false,"changes":170,"status":"modified"},{"patch":"@@ -0,0 +1,84 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import static jdk.test.lib.Asserts.assertFalse;\n+import static jdk.test.lib.Asserts.assertTrue;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Stream;\n+import javax.net.ssl.SSLEngine;\n+import jdk.test.lib.security.SecurityUtils;\n+\n+\/*\n+ * @test\n+ * @bug 8370885\n+ * @summary Default namedGroups values are not being filtered against\n+ *          algorithm constraints\n+ * @library \/javax\/net\/ssl\/templates\n+ *          \/test\/lib\n+ * @run main\/othervm DefaultNamedGroups\n+ *\/\n+\n+public class DefaultNamedGroups extends SSLEngineTemplate {\n+\n+    protected static final String DISABLED_NG = \"secp256r1\";\n+    protected static final List<String> REFERENCE_NG = Stream.of(\n+                    \"x25519\",\n+                    \"secp256r1\",\n+                    \"secp384r1\",\n+                    \"secp521r1\",\n+                    \"x448\",\n+                    \"ffdhe2048\",\n+                    \"ffdhe3072\",\n+                    \"ffdhe4096\",\n+                    \"ffdhe6144\",\n+                    \"ffdhe8192\")\n+            .sorted()\n+            .toList();\n+\n+    protected DefaultNamedGroups() throws Exception {\n+        super();\n+    }\n+\n+    public static void main(String[] args) throws Exception {\n+        SecurityUtils.addToDisabledTlsAlgs(DISABLED_NG);\n+        var test = new DefaultNamedGroups();\n+\n+        for (SSLEngine engine :\n+                new SSLEngine[]{test.serverEngine, test.clientEngine}) {\n+            checkEngineDefaultNG(engine);\n+        }\n+    }\n+\n+    private static void checkEngineDefaultNG(SSLEngine engine) {\n+        var defaultConfigNG = new ArrayList<>(List.of(\n+                engine.getSSLParameters().getNamedGroups()));\n+\n+        assertFalse(defaultConfigNG.contains(DISABLED_NG));\n+        defaultConfigNG.add(DISABLED_NG);\n+        assertTrue(REFERENCE_NG.equals(\n+                        defaultConfigNG.stream().sorted().toList()),\n+                \"Named groups returned by engine: \" + defaultConfigNG);\n+    }\n+}\n","filename":"test\/jdk\/sun\/security\/ssl\/CipherSuite\/DefaultNamedGroups.java","additions":84,"deletions":0,"binary":false,"changes":84,"status":"added"}]}