{"files":[{"patch":"@@ -53,1 +53,8 @@\n-  return ::fgets(_line, _linelen, _f) != nullptr;\n+\n+  if (::fgets(_line, _linelen, _f) == nullptr) {\n+    \/\/ On error or EOF, ensure deterministic empty buffer\n+    _line[0] = '\\0';\n+    return false;\n+  } else {\n+    return true;\n+  }\n@@ -104,2 +111,0 @@\n-\/\/ Starts or continues parsing. Returns true on success,\n-\/\/ false on EOF or on error.\n@@ -120,7 +125,4 @@\n-  \/\/ Now read until we encounter the next header line or EOF or an error.\n-  bool ok = false, stop = false;\n-  do {\n-    ok = read_line();\n-    stop = !ok || is_header_line();\n-    if (!stop) {\n-      scan_additional_line(out);\n+  while (true) {\n+    bool ok = read_line();\n+    if (!ok || is_header_line()) {\n+      break;  \/\/ EOF or next header\n@@ -128,1 +130,2 @@\n-  } while (!stop);\n+    scan_additional_line(out);\n+  }\n@@ -130,1 +133,1 @@\n-  return ok;\n+  return true;  \/\/ always return true if a mapping was parsed\n","filename":"src\/hotspot\/os\/linux\/procMapsParser.cpp","additions":15,"deletions":12,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -87,2 +87,1 @@\n-  \/\/ Starts or continues parsing. Returns true on success,\n-  \/\/ false on EOF or on error.\n+  \/\/ Starts or continues parsing. Returns true iff a mapping was parsed.\n","filename":"src\/hotspot\/os\/linux\/procMapsParser.hpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,109 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+#ifdef LINUX\n+\n+#include \"procMapsParser.hpp\"\n+#include \"unittest.hpp\"\n+\n+#include <stdio.h>\n+\n+TEST(ProcSmapsParserTest, ParseMappings) {\n+  const char* smaps_content =\n+    \"7f5a00000000-7f5a00001000 r--p 00000000 00:00 0                          [anon]\\n\"\n+    \"Size:                  4 kB\\n\"\n+    \"KernelPageSize:        4 kB\\n\"\n+    \"MMUPageSize:           4 kB\\n\"\n+    \"Rss:                   0 kB\\n\"\n+    \"Pss:                   0 kB\\n\"\n+    \"Shared_Clean:          0 kB\\n\"\n+    \"Shared_Dirty:          0 kB\\n\"\n+    \"Private_Clean:         0 kB\\n\"\n+    \"Private_Dirty:         0 kB\\n\"\n+    \"Referenced:            0 kB\\n\"\n+    \"Anonymous:             0 kB\\n\"\n+    \"LazyFree:              0 kB\\n\"\n+    \"AnonHugePages:         0 kB\\n\"\n+    \"ShmemPmdMapped:        0 kB\\n\"\n+    \"FilePmdMapped:         0 kB\\n\"\n+    \"Shared_Hugetlb:        0 kB\\n\"\n+    \"Private_Hugetlb:       0 kB\\n\"\n+    \"Swap:                  0 kB\\n\"\n+    \"SwapPss:               0 kB\\n\"\n+    \"Locked:                0 kB\\n\"\n+    \"THPeligible:    0\\n\"\n+    \"VmFlags: rd mr mw me ac \\n\"\n+    \"7f5a00001000-7f5a00002000 rw-p 00000000 00:00 0                          [anon]\\n\"\n+    \"Size:                  4 kB\\n\"\n+    \"KernelPageSize:        4 kB\\n\"\n+    \"MMUPageSize:           4 kB\\n\"\n+    \"Rss:                   4 kB\\n\"\n+    \"Pss:                   4 kB\\n\"\n+    \"Shared_Clean:          0 kB\\n\"\n+    \"Shared_Dirty:          0 kB\\n\"\n+    \"Private_Clean:         0 kB\\n\"\n+    \"Private_Dirty:         4 kB\\n\"\n+    \"Referenced:            4 kB\\n\"\n+    \"Anonymous:             4 kB\\n\"\n+    \"LazyFree:              0 kB\\n\"\n+    \"AnonHugePages:         0 kB\\n\"\n+    \"ShmemPmdMapped:        0 kB\\n\"\n+    \"FilePmdMapped:         0 kB\\n\"\n+    \"Shared_Hugetlb:        0 kB\\n\"\n+    \"Private_Hugetlb:       0 kB\\n\"\n+    \"Swap:                  0 kB\\n\"\n+    \"SwapPss:               0 kB\\n\"\n+    \"Locked:                0 kB\\n\"\n+    \"THPeligible:    0\\n\"\n+    \"VmFlags: rd wr mr mw me ac \\n\";\n+\n+  FILE* f = fmemopen((void*)smaps_content, strlen(smaps_content), \"r\");\n+  ASSERT_TRUE(f != nullptr);\n+\n+  ProcSmapsParser parser(f);\n+  ProcSmapsInfo info;\n+\n+  \/\/ First mapping\n+  ASSERT_TRUE(parser.parse_next(info));\n+  EXPECT_EQ((uintptr_t)info.from, 0x7f5a00000000ULL);\n+  EXPECT_EQ((uintptr_t)info.to, 0x7f5a00001000ULL);\n+  EXPECT_STREQ(info.prot, \"r--p\");\n+  EXPECT_TRUE(info.rd);\n+  EXPECT_FALSE(info.wr);\n+\n+  \/\/ Second mapping\n+  ASSERT_TRUE(parser.parse_next(info));\n+  EXPECT_EQ((uintptr_t)info.from, 0x7f5a00001000ULL);\n+  EXPECT_EQ((uintptr_t)info.to, 0x7f5a00002000ULL);\n+  EXPECT_STREQ(info.prot, \"rw-p\");\n+  EXPECT_TRUE(info.rd);\n+  EXPECT_TRUE(info.wr);\n+\n+  \/\/ End of file\n+  ASSERT_FALSE(parser.parse_next(info));\n+\n+  fclose(f);\n+}\n+\n+#endif \/\/ LINUX\n","filename":"test\/hotspot\/gtest\/runtime\/test_procMapsParser_linux.cpp","additions":109,"deletions":0,"binary":false,"changes":109,"status":"added"}]}