{"files":[{"patch":"@@ -38,0 +38,2 @@\n+import java.util.Arrays;\n+import java.util.Comparator;\n@@ -40,1 +42,0 @@\n-import java.util.TreeMap;\n@@ -49,0 +50,1 @@\n+    private static final StackMapFrameInfo[] NO_STACK_FRAME_INFOS = new StackMapFrameInfo[0];\n@@ -106,1 +108,2 @@\n-        var map = new TreeMap<Integer, StackMapFrameInfo>();\n+        \/\/ avoid using method handles due to early bootstrap\n+        StackMapFrameInfo[] infos = entries.toArray(NO_STACK_FRAME_INFOS);\n@@ -108,2 +111,13 @@\n-        for (var fr : entries) {\n-            map.put(dcb.labelToBci(fr.target()), fr);\n+        Arrays.sort(infos, new Comparator<StackMapFrameInfo>() {\n+            public int compare(final StackMapFrameInfo o1, final StackMapFrameInfo o2) {\n+                return Integer.compare(dcb.labelToBci(o1.target()), dcb.labelToBci(o2.target()));\n+            }\n+        });\n+        \/\/ count uniques\n+        int cnt = 0;\n+        for (var fr : infos) {\n+            int offset = dcb.labelToBci(fr.target());\n+            if (offset > prevOffset) {\n+                cnt ++;\n+                prevOffset = offset;\n+            }\n@@ -111,7 +125,11 @@\n-        b.writeU2(map.size());\n-        for (var me : map.entrySet()) {\n-            int offset = me.getKey();\n-            var fr = me.getValue();\n-            writeFrame(buf, offset - prevOffset - 1, prevLocals, fr);\n-            prevOffset = offset;\n-            prevLocals = fr.locals();\n+        \/\/ reset\n+        prevOffset = -1;\n+        b.writeU2(cnt);\n+        for (var fr : infos) {\n+            int offset = dcb.labelToBci(fr.target());\n+            \/\/ skip duplicates\n+            if (offset > prevOffset) {\n+                writeFrame(buf, offset - prevOffset - 1, prevLocals, fr);\n+                prevOffset = offset;\n+                prevLocals = fr.locals();\n+            }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/StackMapDecoder.java","additions":29,"deletions":11,"binary":false,"changes":40,"status":"modified"}]}