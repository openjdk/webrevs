{"files":[{"patch":"@@ -42,1 +42,0 @@\n-import static sun.nio.ch.Streams.MAX_BUFFER_SIZE;\n@@ -113,1 +112,1 @@\n-        len = Math.min(len, MAX_BUFFER_SIZE);\n+        len = Math.min(len, Streams.MAX_BUFFER_SIZE);\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/ChannelInputStream.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -35,1 +35,0 @@\n-import static sun.nio.ch.Streams.MAX_BUFFER_SIZE;\n@@ -68,5 +67,4 @@\n-        int limit = bb.limit();\n-        while (bb.remaining() > 0) {\n-            if (bb.remaining() > MAX_BUFFER_SIZE) {\n-                bb.limit(bb.position() + MAX_BUFFER_SIZE);\n-            }\n+        int pos = bb.position();\n+        int rem = bb.limit() - pos;\n+        while (rem > 0) {\n+            bb.limit(pos + Math.min(Streams.MAX_BUFFER_SIZE, rem));\n@@ -75,2 +73,3 @@\n-                throw new RuntimeException(\"no bytes written\");\n-            bb.limit(limit);\n+                throw new IOException(\"Write failed\");\n+            pos += n;\n+            rem -= n;\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/ChannelOutputStream.java","additions":7,"deletions":8,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -81,4 +81,0 @@\n-    \/\/ The maximum number of bytes to read\/write per syscall to avoid needing\n-    \/\/ a huge buffer from the temporary buffer cache\n-    private static final int MAX_BUFFER_SIZE = 128 * 1024;\n-\n@@ -358,2 +354,2 @@\n-                \/\/ read up to MAX_BUFFER_SIZE bytes\n-                int size = Math.min(len, MAX_BUFFER_SIZE);\n+                \/\/ read up to Streams.MAX_BUFFER_SIZE bytes\n+                int size = Math.min(len, Streams.MAX_BUFFER_SIZE);\n@@ -456,2 +452,2 @@\n-                    \/\/ write up to MAX_BUFFER_SIZE bytes\n-                    int size = Math.min((end - pos), MAX_BUFFER_SIZE);\n+                    \/\/ write up to Streams.MAX_BUFFER_SIZE bytes\n+                    int size = Math.min((end - pos), Streams.MAX_BUFFER_SIZE);\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/NioSocketImpl.java","additions":4,"deletions":8,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -61,1 +61,0 @@\n-import static sun.nio.ch.Streams.MAX_BUFFER_SIZE;\n@@ -1377,1 +1376,1 @@\n-        len = Math.min(len, MAX_BUFFER_SIZE);\n+        len = Math.min(len, Streams.MAX_BUFFER_SIZE);\n@@ -1474,1 +1473,1 @@\n-                    int size = Math.min(end - pos, MAX_BUFFER_SIZE);\n+                    int size = Math.min(end - pos, Streams.MAX_BUFFER_SIZE);\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/SocketChannelImpl.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -28,2 +28,0 @@\n- * @library \/test\/lib\n- * @build jdk.test.lib.RandomFactory\n@@ -44,1 +42,0 @@\n-import java.util.Arrays;\n@@ -46,1 +43,0 @@\n-import java.util.Random;\n@@ -53,2 +49,0 @@\n-import jdk.test.lib.RandomFactory;\n-\n@@ -60,1 +54,0 @@\n-    private static Random RND = RandomFactory.getRandom();\n@@ -73,17 +66,0 @@\n-    \/**\n-     * Test writing and reading an array of bytes.\n-     *\/\n-    public void testWriteRead() throws Exception {\n-        final int size = 512*1024;\n-        byte[] b = new byte[size];\n-        int off = RND.nextInt(1024);\n-        int len = RND.nextInt(size - off);\n-        RND.nextBytes(b);\n-        withConnection((sc, peer) -> {\n-            Channels.newOutputStream(peer).write(b, off, len);\n-            byte[] data = new byte[len];\n-            int n = Channels.newInputStream(sc).read(data, 0, len);\n-            assertTrue(Arrays.equals(data, 0, n, b, off, off + n));\n-        });\n-    }\n-\n","filename":"test\/jdk\/java\/nio\/channels\/Channels\/SocketChannelStreams.java","additions":0,"deletions":24,"binary":false,"changes":24,"status":"modified"}]}