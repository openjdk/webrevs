{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,11 @@\n+import java.lang.foreign.Arena;\n+import java.lang.foreign.MemorySegment;\n+import java.lang.foreign.ValueLayout;\n+import java.lang.ref.Reference;\n+import java.util.HashMap;\n+\n+import jdk.internal.misc.Unsafe;\n+\n+import static java.nio.charset.StandardCharsets.ISO_8859_1;\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+\n@@ -34,1 +45,1 @@\n- * atoms are defined in the Inter client communications converntions manual.\n+ * atoms are defined in the Inter client communications conventions manual.\n@@ -37,1 +48,1 @@\n- * by using a pre-exisiting atom like {@code XA_WM_CLASS}. A {@code display} has to be specified\n+ * by using a pre-existing atom like {@code XA_WM_CLASS}. A {@code display} has to be specified\n@@ -61,7 +72,0 @@\n-import java.util.HashMap;\n-\n-import jdk.internal.misc.Unsafe;\n-\n-import static java.nio.charset.StandardCharsets.ISO_8859_1;\n-import static java.nio.charset.StandardCharsets.UTF_8;\n-\n@@ -294,3 +298,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -311,3 +313,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -325,3 +325,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -342,3 +340,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -360,3 +356,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -392,3 +386,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -414,0 +406,35 @@\n+    \/**\n+     * Gets uninterpreted set of data from property and stores them in the data segment.\n+     * Property type is the same as current atom, property is current atom.\n+     * Property format is 32. Property 'delete' is false.\n+     * Returns boolean if requested type, format, length match returned values\n+     * and returned data pointer is not null.\n+     *\/\n+    public boolean getAtomData(long window, Arena arena, MemorySegment data) {\n+        assertAtomInitialized();\n+        checkWindow(window);\n+        int length = Math.toIntExact(data.byteSize() \/ ValueLayout.JAVA_INT.byteSize());\n+        WindowPropertyGetter getter =\n+                new WindowPropertyGetter(window, this, 0, length,\n+                        false, this);\n+        try {\n+            int status = getter.execute();\n+            if (status != XConstants.Success || getter.getData() == 0) {\n+                return false;\n+            }\n+            if (getter.getActualType() != atom\n+                    || getter.getActualFormat() != 32\n+                    || getter.getNumberOfItems() != length) {\n+                return false;\n+            }\n+            long bytes = (long) length * getAtomSize();\n+            @SuppressWarnings(\"restricted\")\n+            MemorySegment source = MemorySegment.ofAddress(getter.getData())\n+                    .reinterpret(bytes, arena, null);\n+            MemorySegment.copy(source, 0, data, 0, bytes);\n+            return true;\n+        } finally {\n+            getter.dispose();\n+        }\n+    }\n+\n@@ -422,3 +449,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -456,3 +481,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -489,3 +512,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -510,3 +531,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -531,3 +550,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -549,3 +566,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -565,3 +580,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -592,3 +605,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -663,3 +674,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -788,3 +797,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -811,3 +818,1 @@\n-        if (atom == 0) {\n-            throw new IllegalStateException(\"Atom should be initialized\");\n-        }\n+        assertAtomInitialized();\n@@ -831,0 +836,6 @@\n+\n+    private void assertAtomInitialized() {\n+        if (atom == 0) {\n+            throw new IllegalStateException(\"Atom should be initialized\");\n+        }\n+    }\n","filename":"src\/java.desktop\/unix\/classes\/sun\/awt\/X11\/XAtom.java","additions":72,"deletions":61,"binary":false,"changes":133,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2014, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -34,0 +34,5 @@\n+import java.lang.foreign.MemoryLayout;\n+import java.lang.foreign.MemoryLayout.PathElement;\n+import java.lang.foreign.StructLayout;\n+import java.lang.foreign.ValueLayout;\n+import java.lang.invoke.VarHandle;\n@@ -79,0 +84,8 @@\n+    static StructLayout X_EMBED_INFO_LAYOUT = MemoryLayout.structLayout(\n+            ValueLayout.JAVA_INT.withName(\"protocol\"),\n+            ValueLayout.JAVA_INT.withName(\"flags\")\n+    );\n+\n+    static VarHandle X_EMBED_INFO_PROTOCOL = X_EMBED_INFO_LAYOUT.varHandle(PathElement.groupElement(\"protocol\"));\n+    static VarHandle X_EMBED_INFO_FLAGS = X_EMBED_INFO_LAYOUT.varHandle(PathElement.groupElement(\"flags\"));\n+\n@@ -80,0 +93,1 @@\n+\n","filename":"src\/java.desktop\/unix\/classes\/sun\/awt\/X11\/XEmbedHelper.java","additions":15,"deletions":1,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2015, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,0 +29,4 @@\n+import java.lang.foreign.Arena;\n+import java.lang.foreign.MemorySegment;\n+import java.lang.foreign.ValueLayout;\n+import java.lang.ref.Reference;\n@@ -34,1 +38,1 @@\n-    HashMap<Long, java.awt.peer.ComponentPeer> children = new HashMap<>();\n+    private final HashMap<Long, java.awt.peer.ComponentPeer> children = new HashMap<>();\n@@ -71,5 +75,5 @@\n-        long data = unsafe.allocateMemory(8);\n-        try {\n-            if (XEmbedInfo.getAtomData(child, data, 2)) {\n-                int protocol = unsafe.getInt(data);\n-                int flags = unsafe.getInt(data);\n+        try (Arena arena = Arena.ofConfined()){\n+            MemorySegment data = arena.allocate(X_EMBED_INFO_LAYOUT);\n+            if (XEmbedInfo.getAtomData(child, arena, data)) {\n+                int protocol = (int)X_EMBED_INFO_PROTOCOL.get(data, 0L);\n+                int flags = (int)X_EMBED_INFO_FLAGS.get(data, 0L);\n@@ -78,2 +82,0 @@\n-        } finally {\n-            unsafe.freeMemory(data);\n@@ -133,2 +135,1 @@\n-        long data = Native.toData(bdata);\n-        if (data == 0) {\n+        if (bdata == null) {\n@@ -137,8 +138,14 @@\n-        XKeyEvent ke = new XKeyEvent(data);\n-        ke.set_window(child);\n-        XToolkit.awtLock();\n-        try {\n-            XlibWrapper.XSendEvent(XToolkit.getDisplay(), child, false, XConstants.NoEventMask, data);\n-        }\n-        finally {\n-            XToolkit.awtUnlock();\n+        try (Arena arena = Arena.ofConfined()) {\n+            var data = arena.allocateFrom(ValueLayout.JAVA_BYTE, bdata);\n+            try {\n+                XKeyEvent ke = new XKeyEvent(data.address());\n+                ke.set_window(child);\n+                XToolkit.awtLock();\n+                try {\n+                    XlibWrapper.XSendEvent(XToolkit.getDisplay(), child, false, XConstants.NoEventMask, data.address());\n+                } finally {\n+                    XToolkit.awtUnlock();\n+                }\n+            } finally {\n+                Reference.reachabilityFence(data);\n+            }\n@@ -146,1 +153,0 @@\n-        XlibWrapper.unsafe.freeMemory(data);\n","filename":"src\/java.desktop\/unix\/classes\/sun\/awt\/X11\/XEmbeddingContainer.java","additions":26,"deletions":20,"binary":false,"changes":46,"status":"modified"}]}