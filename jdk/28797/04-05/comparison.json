{"files":[{"patch":"@@ -1434,1 +1434,25 @@\n-                task = (fifo != 0) ? localPoll() : localPop();\n+                task = null;\n+                int p = top, cap; ForkJoinTask<?>[] a;\n+                if ((a = array) == null || (cap = a.length) <= 0)\n+                    break;        \/\/ currently impossible\n+                if (fifo == 0) {  \/\/ specialized localPop\n+                    int s = p - 1; long k;\n+                    if (U.getReference(\n+                            a, k = slotOffset((cap - 1) & s)) != null &&\n+                        (task = (ForkJoinTask<?>)\n+                         U.getAndSetReference(a, k, null)) != null)\n+                        top = s;\n+                } else {          \/\/ specialized localPoll\n+                    for (int b = base; p - b > 0; ) {\n+                        int nb = b + 1;\n+                        if ((task = (ForkJoinTask<?>)U.getAndSetReference(\n+                                 a, slotOffset((cap - 1) & b), null)) != null) {\n+                            base = nb;\n+                            break;\n+                        }\n+                        if (nb == p)\n+                            break;\n+                        while (b == (b = U.getIntAcquire(this, BASE)))\n+                            Thread.onSpinWait();\n+                    }\n+                }\n@@ -1651,0 +1675,3 @@\n+    private long getCtlAcquire() {\n+        return U.getLongAcquire(this, CTL);\n+    }\n@@ -1824,1 +1851,1 @@\n-            long c = ctl;                  \/\/ decrement counts\n+            long c = getCtlAcquire();      \/\/ decrement counts\n@@ -1861,1 +1888,1 @@\n-        for (long c = ctl;;) {\n+        for (long c = getCtlAcquire();;) {\n@@ -1900,1 +1927,1 @@\n-        for (long c = ctl;;) {\n+        for (long c = getCtlAcquire();;) {\n@@ -1927,1 +1954,1 @@\n-                long c = ctl;\n+                long c = getCtlAcquire();\n@@ -1970,0 +1997,1 @@\n+            int src = -1;                                 \/\/ last queue taken from\n@@ -2004,2 +2032,1 @@\n-                                    Object nt = U.getReference(a, np);\n-                                    w.source = qid;\n+                                    Object nt = U.getReferenceAcquire(a, np);\n@@ -2007,2 +2034,3 @@\n-                                    ++taken;\n-                                    if (nt != null)\n+                                    if (taken++ == 0 || qid != src)\n+                                        w.source = src = qid;\n+                                    if (nt != null && q.base == nb)\n@@ -2042,1 +2070,1 @@\n-            w.stackPred = (int)(pc = ctl);    \/\/ set ctl stack link\n+            w.stackPred = (int)(pc = getCtlAcquire());    \/\/ set ctl stack link\n@@ -2077,1 +2105,1 @@\n-                (int)(c = ctl) == (activePhase = phase + IDLE) &&\n+                (int)(c = getCtlAcquire()) == (activePhase = phase + IDLE) &&\n@@ -2105,1 +2133,1 @@\n-                    if (((c = ctl) & RC_MASK) == 0L && (int)c == activePhase) {\n+                    if (((c = getCtlAcquire()) & RC_MASK) == 0L && (int)c == activePhase) {\n@@ -2266,1 +2294,1 @@\n-                    if (sctl == (sctl = ctl) && (s = tryCompensate(sctl)) >= 0)\n+                    if (sctl == (sctl = getCtlAcquire()) && (s = tryCompensate(sctl)) >= 0)\n@@ -2346,1 +2374,1 @@\n-                    if (sctl == (sctl = ctl) &&\n+                    if (sctl == (sctl = getCtlAcquire()) &&\n@@ -4006,1 +4034,1 @@\n-        long c = ctl;\n+        long c = getCtlAcquire();\n@@ -4300,1 +4328,1 @@\n-            long c = ctl;\n+            long c = getCtlAcquire();\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":44,"deletions":16,"binary":false,"changes":60,"status":"modified"}]}