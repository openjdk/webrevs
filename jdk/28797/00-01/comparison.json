{"files":[{"patch":"@@ -1431,0 +1431,7 @@\n+         *\n+         * @param task the top-level task\n+         * @param q the WorkQueue from which task was taken\n+         * @param fifo nonzero if fifo mode\n+         * @param qbase the next base index of q to take;\n+         *        returning if no such task or already taken\n+         * @return number of top-level tasks stolen from q\n@@ -1434,0 +1441,2 @@\n+            if (task == null || q == null)\n+                return 0;        \/\/ currently impossible\n@@ -1435,28 +1444,22 @@\n-            if (task != null && q != null) {\n-                outer: for (;;) {\n-                    task.doExec();\n-                    task = null;\n-                    int p = top, cap; ForkJoinTask<?>[] a;\n-                    if ((a = array) == null || (cap = a.length) <= 0)\n-                        break;\n-                    if (fifo == 0) {  \/\/ specialized localPop\n-                        int s = p - 1; long k;\n-                        if (U.getReference(\n-                                a, k = slotOffset((cap - 1) & s)) != null &&\n-                            (task = (ForkJoinTask<?>)\n-                             U.getAndSetReference(a, k, null)) != null) {\n-                            top = s;\n-                            continue;\n-                        }\n-                    } else {         \/\/ specialized localPoll\n-                        for (int b = base; p - b > 0; ) {\n-                            int nb = b + 1;\n-                            if ((task = (ForkJoinTask<?>)U.getAndSetReference(\n-                                     a, slotOffset((cap - 1) & b), null)) != null) {\n-                                base = nb;\n-                                continue outer;\n-                            }\n-                            if (nb == p)\n-                                break;\n-                            while (b == (b = U.getIntAcquire(this, BASE)))\n-                                Thread.onSpinWait();\n+            outer: for (;;) {\n+                task.doExec();\n+                task = null;\n+                int p = top, cap; ForkJoinTask<?>[] a;\n+                if ((a = array) == null || (cap = a.length) <= 0)\n+                    break;        \/\/ currently impossible\n+                if (fifo == 0) {  \/\/ specialized localPop\n+                    int s = p - 1; long k;\n+                    if (U.getReference(\n+                            a, k = slotOffset((cap - 1) & s)) != null &&\n+                        (task = (ForkJoinTask<?>)\n+                         U.getAndSetReference(a, k, null)) != null) {\n+                        top = s;\n+                        continue;\n+                    }\n+                } else {         \/\/ specialized localPoll\n+                    for (int b = base; p - b > 0; ) {\n+                        int nb = b + 1;\n+                        if ((task = (ForkJoinTask<?>)U.getAndSetReference(\n+                                 a, slotOffset((cap - 1) & b), null)) != null) {\n+                            base = nb;\n+                            continue outer;\n@@ -1464,0 +1467,4 @@\n+                        if (nb == p)\n+                            break;\n+                        while (b == (b = U.getIntAcquire(this, BASE)))\n+                            Thread.onSpinWait();\n@@ -1465,12 +1472,0 @@\n-                    \/\/ one-shot steal attempt\n-                    ForkJoinTask<?> t; int qcap; long qk;\n-                    ForkJoinTask<?>[] qa = q.array;\n-                    if (q.base != qbase || qa == null || (qcap = qa.length) <= 0 ||\n-                        (t = (ForkJoinTask<?>)U.getReferenceAcquire(\n-                            qa, qk = slotOffset((qcap - 1) & qbase))) == null ||\n-                        q.base != qbase ||\n-                        !U.compareAndSetReference(qa, qk, t, null))\n-                        break;\n-                    q.base = ++qbase;\n-                    ++stolen;\n-                    task = t;\n@@ -1478,0 +1473,10 @@\n+                \/\/ try (once) to steal at q's next base index\n+                ForkJoinTask<?>[] qa = q.array; int qcap; long qk;\n+                if (q.base != qbase || qa == null || (qcap = qa.length) <= 0 ||\n+                    (task = (ForkJoinTask<?>)U.getReferenceAcquire(\n+                        qa, qk = slotOffset((qcap - 1) & qbase))) == null ||\n+                    q.base != qbase || \/\/ ensure valid read\n+                    !U.compareAndSetReference(qa, qk, task, null))\n+                    break;\n+                q.base = ++qbase;\n+                ++stolen;\n@@ -1899,0 +1904,3 @@\n+     *\n+     * @param q, if nonnull, the WorkQueue containing signalled task\n+     * @param qbase q's base index for the task\n@@ -1923,1 +1931,1 @@\n-                    break;\n+                break;\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":49,"deletions":41,"binary":false,"changes":90,"status":"modified"}]}