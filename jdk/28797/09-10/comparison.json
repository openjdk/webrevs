{"files":[{"patch":"@@ -1257,12 +1257,11 @@\n-            int s = top++;                      \/\/ back out on failure\n-            ForkJoinTask<?>[] a = array;\n-            int size = s - base + 1, room, cap, m;\n-            if (a != null &&\n-                ((room = a.length - size) > 0 || (a = growArray(s)) != null) &&\n-                (cap = a.length) > 0) {\n-                long pos = slotOffset((m = cap - 1) & s);\n-                if (internal)\n-                    U.getAndSetReference(a, pos, task); \/\/ fully fenced\n-                else {\n-                    U.putReference(a, pos, task);       \/\/ inside lock\n-                    unlockPhase();\n+            int s = top, b = base, m, cap, room; ForkJoinTask<?>[] a;\n+            if ((a = array) != null && (cap = a.length) > 0) { \/\/ else disabled\n+                if ((room = (m = cap - 1) - (s - b)) >= 0) {\n+                    top = s + 1;\n+                    long pos = slotOffset(m & s);\n+                    if (!internal)\n+                        U.putReference(a, pos, task);       \/\/ inside lock\n+                    else\n+                        U.getAndSetReference(a, pos, task); \/\/ fully fenced\n+                    if (room == 0)\n+                        growArray(a, cap, s);\n@@ -1270,3 +1269,8 @@\n-                if ((U.getReferenceAcquire(a, slotOffset(m & (s - 1))) == null ||\n-                     room <= 0) && pool != null)\n-                    pool.signalWork(this, s);   \/\/ may have appeared empty\n+                if (!internal)\n+                    unlockPhase();\n+                if (room < 0)\n+                    throw new RejectedExecutionException(\"Queue capacity exceeded\");\n+                if (pool != null &&\n+                    (room == 0 ||\n+                     U.getReferenceAcquire(a, slotOffset(m & (s - 1))) == null))\n+                    pool.signalWork(this, s);    \/\/ may have appeared empty\n@@ -1278,2 +1282,3 @@\n-         * @param s current (in-progress) top\n-         * @return new array (or throws on OOME)\n+         * @param a old array\n+         * @param cap old array capacity\n+         * @param s current top\n@@ -1281,5 +1286,4 @@\n-        private ForkJoinTask<?>[] growArray(int s) {\n-            ForkJoinTask<?>[] a; int cap, newCap;\n-            if ((a = array) != null && (cap = a.length) > 0 &&\n-                (newCap = (cap >= 1 << 16) ? cap << 1 : cap << 2) > 0) {\n-                ForkJoinTask<?>[] newArray = null;\n+        private void growArray(ForkJoinTask<?>[] a, int cap, int s) {\n+            int newCap = (cap >= 1 << 16) ? cap << 1 : cap << 2;\n+            ForkJoinTask<?>[] newArray = null;\n+            if (a != null && a.length == cap && cap > 0 && newCap > 0) {\n@@ -1290,1 +1294,1 @@\n-                if (newArray != null) {\n+                if (newArray != null) {               \/\/ else throw on next push\n@@ -1292,1 +1296,1 @@\n-                    for (int k = s - 1, j = cap; j > 0; --j, --k) {\n+                    for (int k = s, j = cap; j > 0; --j, --k) {\n@@ -1299,2 +1303,1 @@\n-                    updateArray(newArray);            \/\/ fully fenced\n-                    return newArray;\n+                    updateArray(newArray);           \/\/ fully fenced\n@@ -1303,4 +1306,0 @@\n-            top = s;                                  \/\/ back out\n-            if ((phase & 1) == 0)                     \/\/ unlock if external\n-                unlockPhase();\n-            throw new RejectedExecutionException(\"Queue capacity exceeded\");\n@@ -1676,3 +1675,0 @@\n-    private long getCtlAcquire() {\n-        return U.getLongAcquire(this, CTL);\n-    }\n@@ -1852,1 +1848,1 @@\n-            long c = getCtlAcquire();      \/\/ decrement counts\n+            long c = ctl;                  \/\/ decrement counts\n@@ -1889,1 +1885,1 @@\n-        for (long c = getCtlAcquire();;) {\n+        for (long c = ctl;;) {\n@@ -1928,1 +1924,1 @@\n-        for (long c = getCtlAcquire();;) {\n+        for (long c = ctl;;) {\n@@ -1955,1 +1951,1 @@\n-                long c = getCtlAcquire();\n+                long c = ctl;\n@@ -1998,1 +1994,0 @@\n-            int src = -1;                                 \/\/ last queue taken from\n@@ -2032,3 +2027,2 @@\n-                                    q.updateBase(nb);\n-                                    if (qid != src)\n-                                        w.source = src = qid;\n+                                    q.base = nb;\n+                                    w.source = qid;\n@@ -2051,1 +2045,1 @@\n-                else if (awaitWork(w) == 0) {\n+                else if (awaitWork(w) == 0)\n@@ -2053,2 +2047,0 @@\n-                    src = -1;\n-                }\n@@ -2073,1 +2065,1 @@\n-            w.stackPred = (int)(pc = getCtlAcquire());    \/\/ set ctl stack link\n+            w.stackPred = (int)(pc = ctl);    \/\/ set ctl stack link\n@@ -2108,1 +2100,1 @@\n-                (int)(c = getCtlAcquire()) == (activePhase = phase + IDLE) &&\n+                (int)(c = ctl) == (activePhase = phase + IDLE) &&\n@@ -2136,1 +2128,1 @@\n-                    if (((c = getCtlAcquire()) & RC_MASK) == 0L && (int)c == activePhase) {\n+                    if (((c = ctl) & RC_MASK) == 0L && (int)c == activePhase) {\n@@ -2297,1 +2289,1 @@\n-                    if (sctl == (sctl = getCtlAcquire()) && (s = tryCompensate(sctl)) >= 0)\n+                    if (sctl == (sctl = ctl) && (s = tryCompensate(sctl)) >= 0)\n@@ -2377,1 +2369,1 @@\n-                    if (sctl == (sctl = getCtlAcquire()) &&\n+                    if (sctl == (sctl = ctl) &&\n@@ -4037,1 +4029,1 @@\n-        long c = getCtlAcquire();\n+        long c = ctl;\n@@ -4331,1 +4323,1 @@\n-            long c = getCtlAcquire();\n+            long c = ctl;\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":43,"deletions":51,"binary":false,"changes":94,"status":"modified"}]}