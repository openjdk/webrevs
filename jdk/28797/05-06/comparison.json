{"files":[{"patch":"@@ -1257,12 +1257,6 @@\n-            int s = top, b = base, m, cap, room; ForkJoinTask<?>[] a;\n-            if ((a = array) != null && (cap = a.length) > 0) { \/\/ else disabled\n-                if ((room = (m = cap - 1) - (s - b)) >= 0) {\n-                    top = s + 1;\n-                    long pos = slotOffset(m & s);\n-                    if (!internal)\n-                        U.putReference(a, pos, task);       \/\/ inside lock\n-                    else\n-                        U.getAndSetReference(a, pos, task); \/\/ fully fenced\n-                    if (room == 0)\n-                        growArray(a, cap, s);\n-                }\n+            int s = top++;                      \/\/ back out on failure\n+            ForkJoinTask<?>[] a = array;\n+            int size = s - base + 1, m;\n+            if (((a != null && a.length > size) || (a = growArray(a, s)) != null) &&\n+                (m = a.length - 1) >= 0) {\n+                a[m & s] = task;\n@@ -1271,6 +1265,3 @@\n-                if (room < 0)\n-                    throw new RejectedExecutionException(\"Queue capacity exceeded\");\n-                if (pool != null &&\n-                    (room == 0 ||\n-                     U.getReferenceAcquire(a, slotOffset(m & (s - 1))) == null))\n-                    pool.signalWork(this, s);    \/\/ may have appeared empty\n+                if (U.getReferenceAcquire(a, slotOffset(m & (s - 1))) == null &&\n+                    pool != null)\n+                    pool.signalWork(this, s);   \/\/ may have appeared empty\n@@ -1283,1 +1274,0 @@\n-         * @param cap old array capacity\n@@ -1285,0 +1275,1 @@\n+         * @return new array (or throws on OOME)\n@@ -1286,4 +1277,5 @@\n-        private void growArray(ForkJoinTask<?>[] a, int cap, int s) {\n-            int newCap = (cap >= 1 << 16) ? cap << 1 : cap << 2;\n-            ForkJoinTask<?>[] newArray = null;\n-            if (a != null && a.length == cap && cap > 0 && newCap > 0) {\n+        private ForkJoinTask<?>[] growArray(ForkJoinTask<?>[] a, int s) {\n+            int cap, newCap;\n+            if (a != null && (cap = a.length) > 0 &&\n+                (newCap = (cap >= 1 << 16) ? cap << 1 : cap << 2) > 0) {\n+                ForkJoinTask<?>[] newArray = null;\n@@ -1294,1 +1286,1 @@\n-                if (newArray != null) {               \/\/ else throw on next push\n+                if (newArray != null) {\n@@ -1296,1 +1288,1 @@\n-                    for (int k = s, j = cap; j > 0; --j, --k) {\n+                    for (int k = s - 1, j = cap; j > 0; --j, --k) {\n@@ -1303,1 +1295,2 @@\n-                    updateArray(newArray);           \/\/ fully fenced\n+                    updateArray(newArray);            \/\/ fully fenced\n+                    return newArray;\n@@ -1306,0 +1299,4 @@\n+            top = s;                                  \/\/ back out\n+            if ((phase & 1) == 0)                     \/\/ unlock if external\n+                unlockPhase();\n+            throw new RejectedExecutionException(\"Queue capacity exceeded\");\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":23,"deletions":26,"binary":false,"changes":49,"status":"modified"}]}