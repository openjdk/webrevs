{"files":[{"patch":"@@ -1252,1 +1252,1 @@\n-            int b = base, s = top, m;\n+            int b = base, s = top, room, m;\n@@ -1254,1 +1254,1 @@\n-                (a.length > s + 1 - b || (a = growArray()) != null) &&\n+                ((room = a.length - (s + 1 - b)) > 0 || (a = growArray()) != null) &&\n@@ -1259,3 +1259,3 @@\n-                    U.putInt(this, PHASE, unlock);\n-                if (U.getReferenceAcquire(a, slotOffset(m & (s - 1))) == null &&\n-                    pool != null)\n+                    phase = unlock;\n+                if ((U.getReferenceAcquire(a, slotOffset(m & (s - 1))) == null ||\n+                     room <= 0) && pool != null)\n@@ -1310,1 +1310,1 @@\n-                             a, slotOffset((cap - 1) & s), null)) != null)\n+                             a, slotOffset((cap - 1) & s), null)) != null) {\n@@ -1312,0 +1312,2 @@\n+                        U.storeFence();\n+                    }\n@@ -1317,0 +1319,1 @@\n+                            U.storeFence();\n@@ -1333,4 +1336,1 @@\n-            U.loadFence();  \/\/ ensure ordering for external callers\n-            ForkJoinTask<?> t= nextLocalTask(config & FIFO);\n-            U.storeFence();\n-            return t;\n+            return nextLocalTask(config & FIFO);\n@@ -1353,1 +1353,2 @@\n-                    U.putIntOpaque(this, TOP, s);\n+                    top = s;\n+                    U.storeFence();\n@@ -1356,1 +1357,1 @@\n-                    U.putIntRelease(this, PHASE, lock + NEXTIDLE);\n+                    phase = lock + NEXTIDLE;\n@@ -1416,0 +1417,1 @@\n+        \/\/        @jdk.internal.vm.annotation.DontInline\n@@ -1455,0 +1457,1 @@\n+                            U.storeFence();\n@@ -1457,1 +1460,1 @@\n-                            U.putIntRelease(this, PHASE, lock + NEXTIDLE);\n+                            phase = lock + NEXTIDLE;\n@@ -1501,1 +1504,1 @@\n-                         U.compareAndSetReference(a, k, t, null)))\n+                         U.compareAndSetReference(a, k, t, null))) {\n@@ -1503,0 +1506,2 @@\n+                        U.storeFence();\n+                    }\n@@ -1504,1 +1509,1 @@\n-                        U.putIntRelease(this, PHASE, lock + NEXTIDLE);\n+                        phase = lock + NEXTIDLE;\n@@ -1540,0 +1545,1 @@\n+                    U.storeFence();\n@@ -2018,1 +2024,2 @@\n-            for (long c;;) {                 \/\/ try to enqueue\n+            for (;;)       {                 \/\/ try to enqueue\n+                long c, e;\n@@ -2023,2 +2030,8 @@\n-                    if ((c & RC_MASK) == 0L)\n-                        quiescent();         \/\/ check quiescent termination\n+                    if (((e = runState) & STOP) == 0L &&\n+                        ((e & SHUTDOWN) == 0L || (c & RC_MASK) > 0L ||\n+                         quiescent() <= 0)) {  \/\/ spin for approx 1 scan cost\n+                        int tc = (short)(c >>> TC_SHIFT);\n+                        int spins = Math.max((tc << 1) + tc, SPIN_WAITS);\n+                        while ((idle = w.phase & IDLE) != 0 && --spins != 0)\n+                            Thread.onSpinWait();\n+                    }\n@@ -2027,1 +2040,1 @@\n-                else if ((c & RC_MASK) <= (pc & RC_MASK)) {\n+                else if ((c & RC_MASK) < (pc & RC_MASK)) {\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":32,"deletions":19,"binary":false,"changes":51,"status":"modified"}]}