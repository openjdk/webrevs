{"files":[{"patch":"@@ -1179,1 +1179,1 @@\n-        int base;                  \/\/ index of next slot for poll\n+        volatile int base;         \/\/ index of next slot for poll\n@@ -1253,2 +1253,2 @@\n-            int b = base, s = top, cap, m;\n-            if (a == null || (cap = a.length) <= s + 1 - b || (m = cap - 1) < 0)\n+            int s = top, m, cap = (a == null) ? 0 : a.length;\n+            if (cap <= s + 1 - base || (m = cap - 1) < 0)\n@@ -1259,1 +1259,1 @@\n-                if (U.getReference(a, slotOffset(m & (s - 1))) == null &&\n+                if (U.getReferenceAcquire(a, slotOffset(m & (s - 1))) == null &&\n@@ -1313,2 +1313,2 @@\n-            int b = base, s = top - 1, cap;\n-            if (a != null && s - b >= 0 && (cap = a.length) > 0) {\n+            int s = top - 1, b, cap = (a == null) ? 0 : a.length;\n+            if (s - (b = base) >= 0 && cap > 0) {\n@@ -1323,1 +1323,1 @@\n-                            U.putIntVolatile(this, BASE, b + 1);\n+                            base = b + 1;\n@@ -1328,1 +1328,1 @@\n-                        while (b == (b = U.getIntAcquire(this, BASE)))\n+                        while (b == (b = base))\n@@ -1408,1 +1408,1 @@\n-                    U.putIntVolatile(this, BASE, nb);\n+                    base = nb;\n@@ -1433,2 +1433,2 @@\n-            int b = base, p = top, s = p - 1, d = p - b, cap;\n-            if (a != null && (cap = a.length) > 0) {\n+            int p = top, s = p - 1, cap = (a == null) ? 0 : a.length, d = p - base;\n+            if (cap > 0) {\n@@ -1544,1 +1544,1 @@\n-                    U.putIntVolatile(this, BASE, b + 1);\n+                    base = b + 1;\n@@ -1830,3 +1830,2 @@\n-        int pc = U.getIntAcquire(this, PARALLELISM);\n-        long c = U.getLong(this, CTL);\n-        for (;;) {\n+        int pc = parallelism;\n+        for (long c = ctl;;) {\n@@ -1965,3 +1964,2 @@\n-                                            (rescans >= 0 ||\n-                                             (U.getReferenceAcquire(a, bp) == null &&\n-                                              q.top == q.base)))\n+                                            U.getReference(a, bp) == null &&\n+                                            (rescans >= 0 || q.top == b))\n@@ -1980,1 +1978,1 @@\n-                                    U.putIntVolatile(q, WorkQueue.BASE, nb);\n+                                    q.base = nb;\n@@ -2355,1 +2353,0 @@\n-                                        U.storeFence();\n@@ -2568,0 +2565,1 @@\n+                ForkJoinTask<?>[] a;\n@@ -2570,3 +2568,2 @@\n-                int s = q.top, b = q.base, cap = 0;\n-                ForkJoinTask<?>[] a = q.array;\n-                int m = (a == null || (cap = a.length) <= s + 1 - b) ? -1 : cap - 1;\n+                int s = q.top, cap = ((a = q.array) == null) ? 0 : a.length;\n+                int m = (cap <= s + 1 - q.base) ? -1 : cap - 1;\n@@ -2583,1 +2580,2 @@\n-                    if (a[m & (s - 1)] == null && signalIfEmpty)\n+                    if (U.getReferenceAcquire(a, slotOffset(m & (s - 1))) == null &&\n+                        signalIfEmpty)\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":22,"deletions":24,"binary":false,"changes":46,"status":"modified"}]}