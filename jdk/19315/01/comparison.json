{"files":[{"patch":"@@ -0,0 +1,132 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.io.Console;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+\n+import jdk.internal.io.JdkConsoleImpl;\n+\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+import jtreg.SkippedException;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.condition.EnabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n+\n+\n+\/**\n+ * @test\n+ * @bug 8332161\n+ * @summary Tests JdkConsoleImpl restores the echo state after readPassword() call\n+ *     This test relies on the static JdkConsoleImpl.echo() methods, which\n+ *     queries\/sets the platform's echo state.\n+ * @library \/test\/lib\n+ * @modules java.base\/jdk.internal.io:+open\n+ * @run junit RestoreEchoTest\n+ *\/\n+public class RestoreEchoTest {\n+\n+    @Test\n+    @EnabledOnOs({OS.LINUX, OS.MAC})\n+    public void testRestoreEcho() throws Throwable {\n+        \/\/ check \"expect\" command availability\n+        var expect = Paths.get(\"\/usr\/bin\/expect\");\n+        if (!Files.exists(expect) || !Files.isExecutable(expect)) {\n+            throw new SkippedException(\"'\" + expect + \"' not found\");\n+        }\n+\n+        expectRunner(\"false\");\n+        expectRunner(\"true\");\n+    }\n+\n+    private static void expectRunner(String initialEcho) throws Throwable {\n+        \/\/ invoking \"expect\" command\n+        var testSrc = System.getProperty(\"test.src\", \".\");\n+        var testClasses = System.getProperty(\"test.classes\", \".\");\n+        var jdkDir = System.getProperty(\"test.jdk\");\n+        OutputAnalyzer output = ProcessTools.executeProcess(\n+                \"expect\",\n+                \"-n\",\n+                testSrc + \"\/restoreEcho.exp\",\n+                initialEcho,\n+                jdkDir + \"\/bin\/java\",\n+                \"--add-opens=java.base\/jdk.internal.io=ALL-UNNAMED\",\n+                \"-Djdk.console=java.base\",\n+                \"-classpath\", testClasses,\n+                \"RestoreEchoTest\",\n+                initialEcho);\n+        output.reportDiagnosticSummary();\n+        var eval = output.getExitValue();\n+        if (eval != 0) {\n+            throw new RuntimeException(\"Test failed. Exit value from 'expect' command: \" + eval);\n+        }\n+    }\n+\n+    public static void main(String... args) throws Throwable {\n+        if (!\"java.base\".equals(System.getProperty(\"jdk.console\"))) {\n+            throw new RuntimeException(\"Test failed. jdk.console is not java.base\");\n+        }\n+\n+        MethodHandle MH_echo = MethodHandles.privateLookupIn(JdkConsoleImpl.class, MethodHandles.lookup())\n+                .findStatic(JdkConsoleImpl.class, \"echo\", MethodType.methodType(boolean.class, boolean.class));\n+\n+        var initialEcho = Boolean.parseBoolean(args[0]);\n+        var originalEcho = (boolean)MH_echo.invokeExact(initialEcho);\n+\n+        Console con = System.console();\n+        if (con == null) {\n+            throw new RuntimeException(\"Test failed. System.console() returned null\");\n+        }\n+\n+        \/\/ testing readLine()\n+        String input = con.readLine(\"prompt: \");\n+        con.printf(\"input is %s\\n\", input);\n+\n+        \/\/ testing readPassword()\n+        input = String.valueOf(con.readPassword(\"password prompt: \"));\n+        con.printf(\"password is %s\\n\", input);\n+\n+        var echoAfter = (boolean)MH_echo.invokeExact(originalEcho);\n+\n+        var echoStates =\n+                \"\"\"\n+                    Platform's original echo state: %s\n+                    Echo state before readPassword(): %s\n+                    Echo state after readPassword(): %s\n+                \"\"\".formatted(originalEcho, initialEcho, echoAfter);\n+        if (initialEcho != echoAfter) {\n+            throw new RuntimeException(\n+                \"\"\"\n+                Initial echo state was not correctly restored.\n+                %s\n+                \"\"\".formatted(echoStates));\n+        } else {\n+            System.out.println(echoStates);\n+        }\n+    }\n+}\n","filename":"test\/jdk\/java\/io\/Console\/RestoreEchoTest.java","additions":132,"deletions":0,"binary":false,"changes":132,"status":"added"},{"patch":"@@ -0,0 +1,60 @@\n+#\n+# Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+#\n+# This code is free software; you can redistribute it and\/or modify it\n+# under the terms of the GNU General Public License version 2 only, as\n+# published by the Free Software Foundation.\n+#\n+# This code is distributed in the hope that it will be useful, but WITHOUT\n+# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+# version 2 for more details (a copy is included in the LICENSE file that\n+# accompanied this code).\n+#\n+# You should have received a copy of the GNU General Public License version\n+# 2 along with this work; if not, write to the Free Software Foundation,\n+# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+#\n+# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+# or visit www.oracle.com if you need additional information or have any\n+# questions.\n+#\n+\n+set initialEcho [lrange $argv 0 0]\n+set java [lrange $argv 1 end]\n+set prompt \"prompt: \"\n+set pwprompt \"password prompt: \"\n+set input \"InPuT\"\n+set password \"PaSsWoRd\"\n+set expected \"input is $input\"\n+set pwexpected \"password is $password\"\n+set timeout 2\n+\n+eval spawn $java\n+\n+# readLine() - input is displayed depending on initialEcho value\n+expect \"$prompt\"\n+send -- \"$input\\n\"\n+if {$initialEcho == \"true\"} {\n+    expect \"$input\"\n+}\n+expect \"$expected\"\n+\n+if {$expect_out(0,string) != $expected} {\n+    send_error \"Expected: $expected\\n\"\n+    send_error \"Received: $expect_out(0,string)\"\n+    exit 1\n+}\n+\n+# readPassword() - password is not displayed regardless of initialEcho value\n+expect \"$pwprompt\"\n+send -- \"$password\\n\"\n+expect \"$pwexpected\"\n+\n+if {$expect_out(0,string) != $pwexpected} {\n+    send_error \"Expected: $pwexpected\\n\"\n+    send_error \"Received: $expect_out(0,string)\"\n+    exit 1\n+}\n+expect eof\n","filename":"test\/jdk\/java\/io\/Console\/restoreEcho.exp","additions":60,"deletions":0,"binary":false,"changes":60,"status":"added"}]}