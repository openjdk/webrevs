{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -1997,1 +1997,1 @@\n-  \/\/ _main_thread points to the thread that created\/loaded the JVM.\n+  \/\/ _main_thread points to the thread that created\/loaded the JVM\n@@ -2005,1 +2005,1 @@\n-\/\/ To install functions for atexit system call\n+\/\/ to install functions for atexit system call\n@@ -2025,1 +2025,1 @@\n-  \/\/ Check and sets minimum stack sizes against command line options\n+  \/\/ check and sets minimum stack sizes against command line options\n@@ -2030,1 +2030,1 @@\n-  \/\/ Not supported.\n+  \/\/ not supported\n@@ -2035,1 +2035,1 @@\n-    \/\/ set the number of file descriptors to max. print out error\n+    \/\/ Set the number of file descriptors to max. Print out error\n@@ -2042,8 +2042,11 @@\n-      nbr_files.rlim_cur = nbr_files.rlim_max;\n-\n-#ifdef __APPLE__\n-      \/\/ Darwin returns RLIM_INFINITY for rlim_max, but fails with EINVAL if\n-      \/\/ you attempt to use RLIM_INFINITY. As per setrlimit(2), OPEN_MAX must\n-      \/\/ be used instead\n-      nbr_files.rlim_cur = MIN(OPEN_MAX, nbr_files.rlim_cur);\n-#endif\n+      rlim_t rlim_original = nbr_files.rlim_cur;\n+\n+      \/\/ On macOS according to setrlimit(2), OPEN_MAX must be used instead\n+      \/\/ of RLIM_INFINITY, but testing on macOS >= 10.6, reveals that\n+      \/\/ we can, in fact, use even RLIM_INFINITY, so try the max value\n+      \/\/ that the system claims can be used first, same as other BSD OSes.\n+      \/\/ However, some terminals (ksh) will internally use \"int\" type\n+      \/\/ to store this value and since RLIM_INFINITY overflows an \"int\"\n+      \/\/ we might end up with a negative value, so cap the system limit max\n+      \/\/ at INT_MAX instead, just in case, for everyone.\n+      nbr_files.rlim_cur = MIN(INT_MAX, nbr_files.rlim_max);\n@@ -2052,0 +2055,6 @@\n+      if (status != 0) {\n+        \/\/ If that fails then try lowering the limit to either OPEN_MAX\n+        \/\/ (which is safe) or the original limit, whichever was greater.\n+        nbr_files.rlim_cur = MAX(OPEN_MAX, rlim_original);\n+        status = setrlimit(RLIMIT_NOFILE, &nbr_files);\n+      }\n@@ -2058,1 +2067,1 @@\n-  \/\/ at-exit methods are called in the reverse order of their registration.\n+  \/\/ At-exit methods are called in the reverse order of their registration.\n@@ -2064,1 +2073,1 @@\n-    \/\/ only register atexit functions if PerfAllowAtExitRegistration is set.\n+    \/\/ Only register atexit functions if PerfAllowAtExitRegistration is set.\n@@ -2069,1 +2078,1 @@\n-    \/\/ note: perfMemory_exit_helper atexit function may be removed in\n+    \/\/ Note: perfMemory_exit_helper atexit function may be removed in\n@@ -2092,1 +2101,1 @@\n-  \/\/ User has overridden the number of active processors\n+  \/\/ user has overridden the number of active processors\n@@ -2145,1 +2154,1 @@\n-  \/\/ This is only supported in Snow Leopard and beyond\n+  \/\/ this is only supported in Snow Leopard and beyond\n@@ -2147,1 +2156,1 @@\n-    \/\/ Add a \"Java: \" prefix to the name\n+    \/\/ add a \"Java: \" prefix to the name\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":29,"deletions":20,"binary":false,"changes":49,"status":"modified"}]}