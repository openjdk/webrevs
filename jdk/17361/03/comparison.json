{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -2012,1 +2012,1 @@\n-\/\/ this is called _after_ the global arguments have been parsed\n+\/\/ This is called _after_ the global arguments have been parsed\n@@ -2035,1 +2035,1 @@\n-    \/\/ set the number of file descriptors to max. print out error\n+    \/\/ Set the number of file descriptors to max. Print out error\n@@ -2042,8 +2042,11 @@\n-      nbr_files.rlim_cur = nbr_files.rlim_max;\n-\n-#ifdef __APPLE__\n-      \/\/ Darwin returns RLIM_INFINITY for rlim_max, but fails with EINVAL if\n-      \/\/ you attempt to use RLIM_INFINITY. As per setrlimit(2), OPEN_MAX must\n-      \/\/ be used instead\n-      nbr_files.rlim_cur = MIN(OPEN_MAX, nbr_files.rlim_cur);\n-#endif\n+      rlim_t rlim_original = nbr_files.rlim_cur;\n+\n+      \/\/ On macOS according to setrlimit(2), OPEN_MAX must be used instead\n+      \/\/ of RLIM_INFINITY, but testing on macOS >= 10.6, reveals that\n+      \/\/ we can, in fact, use even RLIM_INFINITY, so try the max value\n+      \/\/ that the system claims can be used first, same as other BSD OSes.\n+      \/\/ However, some terminals (ksh) will internally use \"int\" type\n+      \/\/ to store this value and since RLIM_INFINITY overflows an \"int\"\n+      \/\/ we might end up with a negative value, so cap the system limit max\n+      \/\/ at INT_MAX instead, just in case, for everyone.\n+      nbr_files.rlim_cur = MIN(INT_MAX, nbr_files.rlim_max);\n@@ -2052,0 +2055,6 @@\n+      if (status != 0) {\n+        \/\/ If that fails then try lowering the limit to either OPEN_MAX\n+        \/\/ (which is safe) or the original limit, whichever was greater.\n+        nbr_files.rlim_cur = MAX(OPEN_MAX, rlim_original);\n+        status = setrlimit(RLIMIT_NOFILE, &nbr_files);\n+      }\n@@ -2058,1 +2067,1 @@\n-  \/\/ at-exit methods are called in the reverse order of their registration.\n+  \/\/ At-exit methods are called in the reverse order of their registration.\n@@ -2064,1 +2073,1 @@\n-    \/\/ only register atexit functions if PerfAllowAtExitRegistration is set.\n+    \/\/ Only register atexit functions if PerfAllowAtExitRegistration is set.\n@@ -2069,1 +2078,1 @@\n-    \/\/ note: perfMemory_exit_helper atexit function may be removed in\n+    \/\/ Note: perfMemory_exit_helper atexit function may be removed in\n@@ -2077,1 +2086,1 @@\n-  \/\/ initialize thread priority policy\n+  \/\/ Initialize thread priority policy\n@@ -2081,1 +2090,1 @@\n-  \/\/ dynamically link to objective c gc registration\n+  \/\/ Dynamically link to objective c gc registration\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":25,"deletions":16,"binary":false,"changes":41,"status":"modified"}]}