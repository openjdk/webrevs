{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -54,1 +54,0 @@\n-import com.sun.tools.javac.file.JRTIndex;\n@@ -56,0 +55,2 @@\n+import com.sun.tools.javac.file.LegacyCtPropertiesAccess;\n+import com.sun.tools.javac.file.LegacyCtPropertiesAccess.LegacyCtPropertiesInfo;\n@@ -59,1 +60,0 @@\n-import com.sun.tools.javac.platform.PlatformDescription;\n@@ -62,0 +62,1 @@\n+import com.sun.tools.javac.util.Dependencies.CompletionCause;\n@@ -67,5 +68,0 @@\n-import com.sun.tools.javac.code.Symbol;\n-import com.sun.tools.javac.code.Symbol.CompletionFailure;\n-import com.sun.tools.javac.main.DelegatingJavaFileManager;\n-\n-import com.sun.tools.javac.util.Dependencies.CompletionCause;\n@@ -163,1 +159,1 @@\n-    private final JRTIndex jrtIndex;\n+    private final LegacyCtPropertiesAccess legacyCtPropertiesInfoAccess;\n@@ -210,12 +206,2 @@\n-        \/\/ Temporary, until more info is available from the module system.\n-        boolean useCtProps;\n-        JavaFileManager fm = context.get(JavaFileManager.class);\n-        if (fm instanceof DelegatingJavaFileManager delegatingJavaFileManager) {\n-            fm = delegatingJavaFileManager.getBaseFileManager();\n-        }\n-        if (fm instanceof JavacFileManager javacFileManager) {\n-            useCtProps = javacFileManager.isDefaultBootClassPath() && javacFileManager.isSymbolFileEnabled();\n-        } else {\n-            useCtProps = false;\n-        }\n-        jrtIndex = useCtProps && JRTIndex.isAvailable() ? JRTIndex.getSharedInstance() : null;\n+        legacyCtPropertiesInfoAccess =\n+                JavacFileManager.getLegacyCtPropertiesInfo(fileManager);\n@@ -244,1 +230,1 @@\n-        if (jrtIndex == null || !jrtIndex.isInJRT(c.classfile) || c.name == names.module_info) {\n+        if (!legacyCtPropertiesInfoAccess.supportsLegacyFlags(c.classfile) || c.name == names.module_info) {\n@@ -260,1 +246,2 @@\n-                    JRTIndex.CtSym ctSym = jrtIndex.getCtSym(packge.flatName());\n+                    LegacyCtPropertiesInfo legacyInfo =\n+                            legacyCtPropertiesInfoAccess.getInfo(packge.flatName());\n@@ -262,1 +249,1 @@\n-                    if (ctSym.proprietary)\n+                    if (legacyInfo.proprietary)\n@@ -264,2 +251,2 @@\n-                    if (ctSym.minProfile != null)\n-                        minProfile = Profile.lookup(ctSym.minProfile);\n+                    if (legacyInfo.minProfile != null)\n+                        minProfile = Profile.lookup(legacyInfo.minProfile);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/ClassFinder.java","additions":13,"deletions":26,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -44,2 +44,0 @@\n-import java.util.MissingResourceException;\n-import java.util.ResourceBundle;\n@@ -50,0 +48,1 @@\n+import com.sun.tools.javac.file.LegacyCtPropertiesAccess.LegacyCtPropertiesInfo;\n@@ -56,1 +55,1 @@\n-public class JRTIndex {\n+class JRTIndex implements LegacyCtPropertiesAccess {\n@@ -120,1 +119,1 @@\n-        final CtSym ctSym;\n+        final LegacyCtPropertiesInfo ctProperties;\n@@ -122,1 +121,1 @@\n-        private Entry(Map<String, Path> files, Set<RelativeDirectory> subdirs, CtSym ctSym) {\n+        private Entry(Map<String, Path> files, Set<RelativeDirectory> subdirs, LegacyCtPropertiesInfo ctProperties) {\n@@ -125,1 +124,1 @@\n-            this.ctSym = ctSym;\n+            this.ctProperties = ctProperties;\n@@ -129,47 +128,0 @@\n-    \/**\n-     * The info that used to be in ct.sym for classes in a package.\n-     *\/\n-    public static class CtSym {\n-        \/**\n-         * The classes in this package are internal and not visible.\n-         *\/\n-        public final boolean hidden;\n-        \/**\n-         * The classes in this package are proprietary and will generate a warning.\n-         *\/\n-        public final boolean proprietary;\n-        \/**\n-         * The minimum profile in which classes in this package are available.\n-         *\/\n-        public final String minProfile;\n-\n-        CtSym(boolean hidden, boolean proprietary, String minProfile) {\n-            this.hidden = hidden;\n-            this.proprietary = proprietary;\n-            this.minProfile = minProfile;\n-        }\n-\n-        @Override\n-        public String toString() {\n-            StringBuilder sb = new StringBuilder(\"CtSym[\");\n-            boolean needSep = false;\n-            if (hidden) {\n-                sb.append(\"hidden\");\n-                needSep = true;\n-            }\n-            if (proprietary) {\n-                if (needSep) sb.append(\",\");\n-                sb.append(\"proprietary\");\n-                needSep = true;\n-            }\n-            if (minProfile != null) {\n-                if (needSep) sb.append(\",\");\n-                sb.append(minProfile);\n-            }\n-            sb.append(\"]\");\n-            return sb.toString();\n-        }\n-\n-        static final CtSym EMPTY = new CtSym(false, false, null);\n-    }\n-\n@@ -184,2 +136,3 @@\n-    public CtSym getCtSym(CharSequence packageName) throws IOException {\n-        return getEntry(RelativeDirectory.forPackage(packageName)).ctSym;\n+    @Override\n+    public LegacyCtPropertiesInfo getInfo(CharSequence packageName) throws IOException {\n+        return getEntry(RelativeDirectory.forPackage(packageName)).ctProperties;\n@@ -225,1 +178,1 @@\n-                    getCtInfo(rd));\n+                    LegacyCtPropertiesInfo.createLegacyCtPropertiesInfo(rd));\n@@ -231,1 +184,2 @@\n-    public boolean isInJRT(FileObject fo) {\n+    @Override\n+    public boolean supportsLegacyFlags(FileObject fo) {\n@@ -240,34 +194,0 @@\n-    private CtSym getCtInfo(RelativeDirectory dir) {\n-        if (dir.path.isEmpty())\n-            return CtSym.EMPTY;\n-        \/\/ It's a side-effect of the default build rules that ct.properties\n-        \/\/ ends up as a resource bundle.\n-        if (ctBundle == null) {\n-            final String bundleName = \"com.sun.tools.javac.resources.ct\";\n-            ctBundle = ResourceBundle.getBundle(bundleName);\n-        }\n-        try {\n-            String attrs = ctBundle.getString(dir.path.replace('\/', '.') + '*');\n-            boolean hidden = false;\n-            boolean proprietary = false;\n-            String minProfile = null;\n-            for (String attr: attrs.split(\" +\", 0)) {\n-                switch (attr) {\n-                    case \"hidden\":\n-                        hidden = true;\n-                        break;\n-                    case \"proprietary\":\n-                        proprietary = true;\n-                        break;\n-                    default:\n-                        minProfile = attr;\n-                }\n-            }\n-            return new CtSym(hidden, proprietary, minProfile);\n-        } catch (MissingResourceException e) {\n-            return CtSym.EMPTY;\n-        }\n-\n-    }\n-\n-    private ResourceBundle ctBundle;\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/JRTIndex.java","additions":12,"deletions":92,"binary":false,"changes":104,"status":"modified"},{"patch":"@@ -404,1 +404,1 @@\n-                if (symbolFileEnabled && e.ctSym.hidden)\n+                if (symbolFileEnabled && e.ctProperties.hidden)\n@@ -428,1 +428,1 @@\n-            if (symbolFileEnabled && e.ctSym.hidden)\n+            if (symbolFileEnabled && e.ctProperties.hidden)\n@@ -461,0 +461,12 @@\n+    \/**\n+     * {@return Accessor for additional class properties.}\n+     *\/\n+    public static LegacyCtPropertiesAccess getLegacyCtPropertiesInfo(JavaFileManager fm) {\n+        if (fm instanceof JavacFileManager jfm && jfm.isDefaultBootClassPath() &&\n+            jfm.isSymbolFileEnabled() && JRTIndex.isAvailable()) {\n+            return jfm.getJRTIndex();\n+        } else {\n+            return LegacyCtPropertiesAccess.NOOP;\n+        }\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/JavacFileManager.java","additions":14,"deletions":2,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -0,0 +1,155 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package com.sun.tools.javac.file;\n+\n+import java.io.IOException;\n+import java.util.MissingResourceException;\n+import java.util.ResourceBundle;\n+import javax.tools.FileObject;\n+\n+import com.sun.tools.javac.file.RelativePath.RelativeDirectory;\n+\n+\/**\n+ * Support for legacy ct.properties.\n+ *\n+ * This interface is used:\n+ *\n+ * - when compiling with --source 8 to fill in (JDK 8) profile information,\n+ * mark classes in certain non-API packages as proprietary (which then leads to\n+ * the \"sun.proprietary\" warning when used), and hide other non-API packages.\n+ * For the source data see:\n+ * src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/resources\/ct.properties\n+ *\n+ * - when compiling with --source >8, this interface is only used to determine\n+ * if a file supports the proprietary flag (i.e. is on the default system path\n+ * of the default filemanager, and the proprietary flag is not disabled). The\n+ * proprietary flag is automatically filled for all classes in the jdk.unsupported\n+ * module.\n+ *\n+ * The --source above may be explicit or implicit.\n+ *\n+ * When compiling with --release N, this legacy support is not directly used,\n+ * as the relevant information is accessible from the lib\/ct.sym file that\n+ * contains the historical API record.\n+ *\/\n+public interface LegacyCtPropertiesAccess {\n+\n+    public static LegacyCtPropertiesAccess NOOP = new LegacyCtPropertiesAccess() {\n+        @Override\n+        public boolean supportsLegacyFlags(FileObject fo) {\n+            return false;\n+        }\n+\n+        @Override\n+        public LegacyCtPropertiesInfo getInfo(CharSequence packge) {\n+            throw new UnsupportedOperationException(\"Should not be called.\");\n+        }\n+    };\n+\n+    public boolean supportsLegacyFlags(FileObject fo);\n+\n+    public LegacyCtPropertiesInfo getInfo(CharSequence packge) throws IOException;\n+\n+    \/**\n+     * The info that used to be in ct.sym for classes in a package.\n+     *\/\n+    public static class LegacyCtPropertiesInfo {\n+        \/**\n+         * The classes in this package are internal and not visible.\n+         *\/\n+        public final boolean hidden;\n+        \/**\n+         * The classes in this package are proprietary and will generate a warning.\n+         *\/\n+        public final boolean proprietary;\n+        \/**\n+         * The minimum profile in which classes in this package are available.\n+         *\/\n+        public final String minProfile;\n+\n+        LegacyCtPropertiesInfo(boolean hidden, boolean proprietary, String minProfile) {\n+            this.hidden = hidden;\n+            this.proprietary = proprietary;\n+            this.minProfile = minProfile;\n+        }\n+\n+        @Override\n+        public String toString() {\n+            StringBuilder sb = new StringBuilder(\"CtSym[\");\n+            boolean needSep = false;\n+            if (hidden) {\n+                sb.append(\"hidden\");\n+                needSep = true;\n+            }\n+            if (proprietary) {\n+                if (needSep) sb.append(\",\");\n+                sb.append(\"proprietary\");\n+                needSep = true;\n+            }\n+            if (minProfile != null) {\n+                if (needSep) sb.append(\",\");\n+                sb.append(minProfile);\n+            }\n+            sb.append(\"]\");\n+            return sb.toString();\n+        }\n+\n+        static LegacyCtPropertiesInfo createLegacyCtPropertiesInfo(RelativeDirectory dir) {\n+            if (dir.path.isEmpty())\n+                return LegacyCtPropertiesInfo.EMPTY;\n+            \/\/ It's a side-effect of the default build rules that ct.properties\n+            \/\/ ends up as a resource bundle.\n+            if (ctBundle == null) {\n+                final String bundleName = \"com.sun.tools.javac.resources.ct\";\n+                ctBundle = ResourceBundle.getBundle(bundleName);\n+            }\n+            try {\n+                String attrs = ctBundle.getString(dir.path.replace('\/', '.') + '*');\n+                boolean hidden = false;\n+                boolean proprietary = false;\n+                String minProfile = null;\n+                for (String attr: attrs.split(\" +\", 0)) {\n+                    switch (attr) {\n+                        case \"hidden\":\n+                            hidden = true;\n+                            break;\n+                        case \"proprietary\":\n+                            proprietary = true;\n+                            break;\n+                        default:\n+                            minProfile = attr;\n+                    }\n+                }\n+                return new LegacyCtPropertiesInfo(hidden, proprietary, minProfile);\n+            } catch (MissingResourceException e) {\n+                return LegacyCtPropertiesInfo.EMPTY;\n+            }\n+        }\n+\n+        private static ResourceBundle ctBundle;\n+\n+        static final LegacyCtPropertiesInfo EMPTY = new LegacyCtPropertiesInfo(false, false, null);\n+    }\n+}\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/LegacyCtPropertiesAccess.java","additions":155,"deletions":0,"binary":false,"changes":155,"status":"added"},{"patch":"@@ -95,0 +95,1 @@\n+        ignore(\"com\/sun\/tools\/javac\/file\/LegacyCtPropertiesAccess$LegacyCtPropertiesInfo\", \"ctBundle\");\n","filename":"test\/langtools\/tools\/javac\/T8003967\/DetectMutableStaticFields.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8259039\n+ * @bug 8259039 8373436\n@@ -28,0 +28,1 @@\n+ *          and JDK 8 profiles\n@@ -57,0 +58,1 @@\n+        t.runCompactProfile();\n@@ -74,6 +76,1 @@\n-        Path javaHome = FileSystems.getDefault().getPath(System.getProperty(\"java.home\"));\n-        Path thisSystemModules = javaHome.resolve(\"lib\").resolve(\"modules\");\n-\n-        if (Files.isRegularFile(thisSystemModules)) {\n-            \/\/only use -source 8 when running on full JDK images (not on the exploded JDK), as the\n-            \/\/classfiles are not considered to be part of JRT image when running with -source 8:\n+        if (fullJDKImage()) {\n@@ -139,0 +136,59 @@\n+    void runCompactProfile() throws IOException {\n+        Path root = Paths.get(\".\");\n+        Path classes = root.resolve(\"classes\");\n+        Files.createDirectories(classes);\n+        ToolBox tb = new ToolBox();\n+        List<String> log;\n+        List<String> expected;\n+\n+        expected = List.of(\n+                \"Test.java:2:16: compiler.err.not.in.profile: javax.swing.JButton, compact1\",\n+                \"1 error\"\n+        );\n+\n+        List<List<String>> variants = new ArrayList<>();\n+\n+        if (fullJDKImage()) {\n+            variants.add(List.of(\"--source\", \"8\", \"--target\", \"8\"));\n+        }\n+\n+        variants.add(List.of(\"--release\", \"8\"));\n+\n+        for (List<String> variant : variants) {\n+            List<String> options = new ArrayList<>();\n+\n+            options.addAll(variant);\n+            options.add(\"-XDrawDiagnostics\");\n+            options.add(\"-Xlint:-options\");\n+            options.add(\"-profile\"); options.add(\"compact1\");\n+\n+            log = new JavacTask(tb)\n+                    .outdir(classes)\n+                    .options(options)\n+                    .sources(\"\"\"\n+                             public class Test {\n+                                 javax.swing.JButton b;\n+                             }\n+                             \"\"\")\n+                    .run(Task.Expect.FAIL)\n+                    .writeAll()\n+                    .getOutputLines(Task.OutputKind.DIRECT);\n+\n+            if (!expected.equals(log)) {\n+                throw new AssertionError(\"Unexpected output: \" + log +\n+                                         \", variantOptions: \" + variant);\n+            }\n+        }\n+    }\n+\n+    \/**\n+     * Checks if the runtime JDK is a \"package\" JDK image, as source-based options\n+     * don't work for exploded JDK. The system classfiles are not determined\n+     * to be part of the JRT image for exploded JDK.\n+     *\/\n+    static boolean fullJDKImage() {\n+        Path javaHome = FileSystems.getDefault().getPath(System.getProperty(\"java.home\"));\n+        Path thisSystemModules = javaHome.resolve(\"lib\").resolve(\"modules\");\n+\n+        return Files.isRegularFile(thisSystemModules);\n+    }\n","filename":"test\/langtools\/tools\/javac\/platform\/CtPropertiesTest.java","additions":63,"deletions":7,"binary":false,"changes":70,"status":"modified"}]}