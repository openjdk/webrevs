{"files":[{"patch":"@@ -687,4 +687,0 @@\n-    if (_generation->is_young()) {\n-      ShenandoahGCPhase phase(ShenandoahPhaseTimings::init_swap_rset);\n-      _generation->swap_card_tables();\n-    }\n@@ -701,0 +697,12 @@\n+\n+    \/\/ Verify before mark is done before swapping card tables.\n+    \/\/ Therefore, the write card table will be verified before being taken snapshot.\n+    if (ShenandoahVerify) {\n+      ShenandoahTimingsTracker v(ShenandoahPhaseTimings::init_mark_verify);\n+      heap->verifier()->verify_before_concmark();\n+    }\n+\n+    {\n+      ShenandoahGCPhase phase(ShenandoahPhaseTimings::init_swap_rset);\n+      _generation->swap_card_tables();\n+    }\n@@ -703,1 +711,1 @@\n-  if (ShenandoahVerify) {\n+  if (ShenandoahVerify && !heap->mode()->is_generational()) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahConcurrentGC.cpp","additions":13,"deletions":5,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -1160,0 +1160,3 @@\n+    \/\/ Set mark incomplete because the marking bitmaps have been reset except pinned regions.\n+    heap->global_generation()->set_mark_incomplete();\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahFullGC.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1058,1 +1058,8 @@\n-    verify_at_safepoint(\n+  VerifyRememberedSet verify_remembered_set = _verify_remembered_before_marking;\n+  if (_heap->mode()->is_generational() &&\n+      !_heap->old_generation()->is_mark_complete() &&\n+      !_heap->old_generation()->is_parsable()) {\n+    \/\/ Before marking, remembered set can't be verified w\/o complete old marking or parsable old generation.\n+    verify_remembered_set = _verify_remembered_disable;\n+  }\n+  verify_at_safepoint(\n@@ -1060,1 +1067,1 @@\n-          _verify_remembered_before_marking,\n+          verify_remembered_set,\n@@ -1279,8 +1286,0 @@\n-ShenandoahMarkingContext* ShenandoahVerifier::get_marking_context_for_old() {\n-  shenandoah_assert_generations_reconciled();\n-  if (_heap->old_generation()->is_mark_complete() || _heap->gc_generation()->is_global()) {\n-    return _heap->complete_marking_context();\n-  }\n-  return nullptr;\n-}\n-\n@@ -1288,1 +1287,1 @@\n-void ShenandoahVerifier::help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r, ShenandoahMarkingContext* ctx,\n+void ShenandoahVerifier::help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r,\n@@ -1290,0 +1289,4 @@\n+  shenandoah_assert_generations_reconciled();\n+  ShenandoahMarkingContext* ctx = _heap->old_generation()->is_mark_complete() ?\n+    _heap->old_generation()->complete_marking_context() : nullptr;\n+\n@@ -1360,1 +1363,0 @@\n-  ShenandoahMarkingContext* ctx = get_marking_context_for_old();\n@@ -1365,1 +1367,1 @@\n-  ShenandoahScanRemembered* scanner = old_generation->card_scan();\n+  ShenandoahWriteTableScanner scanner(ShenandoahGenerationalHeap::heap()->old_generation()->card_scan());\n@@ -1369,1 +1371,1 @@\n-      help_verify_region_rem_set(scanner, r, ctx, r->end(), \"Verify init-mark remembered set violation\");\n+      help_verify_region_rem_set(&scanner, r, r->end(), \"Verify init-mark remembered set violation\");\n@@ -1382,1 +1384,1 @@\n-      help_verify_region_rem_set(&scanner, r, nullptr, r->top(), \"Remembered set violation at end of Full GC\");\n+      help_verify_region_rem_set(&scanner, r, r->top(), \"Remembered set violation at end of Full GC\");\n@@ -1395,1 +1397,0 @@\n-  ShenandoahMarkingContext* ctx = get_marking_context_for_old();\n@@ -1400,1 +1401,1 @@\n-      help_verify_region_rem_set(&scanner, r, ctx, r->get_update_watermark(), \"Remembered set violation at init-update-references\");\n+      help_verify_region_rem_set(&scanner, r, r->get_update_watermark(), \"Remembered set violation at init-update-references\");\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVerifier.cpp","additions":18,"deletions":17,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -232,1 +232,1 @@\n-  void help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r, ShenandoahMarkingContext* ctx,\n+  void help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r,\n@@ -238,2 +238,0 @@\n-\n-  ShenandoahMarkingContext* get_marking_context_for_old();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVerifier.hpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"}]}