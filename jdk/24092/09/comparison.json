{"files":[{"patch":"@@ -687,4 +687,0 @@\n-    if (_generation->is_young()) {\n-      ShenandoahGCPhase phase(ShenandoahPhaseTimings::init_swap_rset);\n-      _generation->swap_card_tables();\n-    }\n@@ -701,0 +697,12 @@\n+\n+    \/\/ Verify before mark is done before swapping card tables.\n+    \/\/ Therefore, the write card table will be verified before being taken snapshot.\n+    if (ShenandoahVerify) {\n+      ShenandoahTimingsTracker v(ShenandoahPhaseTimings::init_mark_verify);\n+      heap->verifier()->verify_before_concmark();\n+    }\n+\n+    {\n+      ShenandoahGCPhase phase(ShenandoahPhaseTimings::init_swap_rset);\n+      _generation->swap_card_tables();\n+    }\n@@ -703,1 +711,1 @@\n-  if (ShenandoahVerify) {\n+  if (ShenandoahVerify && heap->mode()->is_generational()) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahConcurrentGC.cpp","additions":13,"deletions":5,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -1160,0 +1160,3 @@\n+    \/\/ Set mark incomplete because the marking bitmaps have been reset except pinned regions.\n+    heap->global_generation()->set_mark_incomplete();\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahFullGC.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1058,1 +1058,9 @@\n-    verify_at_safepoint(\n+  VerifyRememberedSet verify_remembered_set = _verify_remembered_before_marking;\n+  if (_heap->mode()->is_generational() &&\n+      !_heap->old_generation()->is_mark_complete() &&\n+      !_heap->old_generation()->is_parsable()) {\n+    \/\/ Before marking, remembered set can't be verified in global GC, because,\n+    \/\/ we don't know whether old gen is parseable or not.\n+    verify_remembered_set = _verify_remembered_disable;\n+  }\n+  verify_at_safepoint(\n@@ -1060,1 +1068,1 @@\n-          _verify_remembered_before_marking,\n+          verify_remembered_set,\n@@ -1117,0 +1125,8 @@\n+  VerifyRememberedSet verify_remembered_set = _verify_remembered_before_updating_references;\n+  if (_heap->mode()->is_generational() &&\n+      !_heap->old_generation()->is_mark_complete() &&\n+      !_heap->old_generation()->is_parsable()) {\n+    \/\/ Before marking, remembered set can't be verified in global GC, because,\n+    \/\/ we don't know whether old gen is parseable or not.\n+    verify_remembered_set = _verify_remembered_disable;\n+  }\n@@ -1119,1 +1135,1 @@\n-          _verify_remembered_before_updating_references,  \/\/ verify read-write remembered set\n+          verify_remembered_set,        \/\/ verify read-write remembered set\n@@ -1267,2 +1283,4 @@\n-      oop obj = CompressedOops::decode_not_null(o);\n-      if (_heap->is_in_young(obj) && !_scanner->is_card_dirty((HeapWord*) p)) {\n+      oop obj = CompressedOops::decode_raw(o);\n+      assert(is_object_aligned(obj), \"address not aligned: \" PTR_FORMAT, p2i(obj));\n+      ShenandoahHeapRegion* region = _heap->heap_region_containing(obj);\n+      if (region->is_active() && region->is_young() && !_scanner->is_card_dirty((HeapWord*) p)) {\n@@ -1279,8 +1297,0 @@\n-ShenandoahMarkingContext* ShenandoahVerifier::get_marking_context_for_old() {\n-  shenandoah_assert_generations_reconciled();\n-  if (_heap->old_generation()->is_mark_complete() || _heap->gc_generation()->is_global()) {\n-    return _heap->complete_marking_context();\n-  }\n-  return nullptr;\n-}\n-\n@@ -1288,1 +1298,1 @@\n-void ShenandoahVerifier::help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r, ShenandoahMarkingContext* ctx,\n+void ShenandoahVerifier::help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r,\n@@ -1290,0 +1300,4 @@\n+  shenandoah_assert_generations_reconciled();\n+  ShenandoahMarkingContext* ctx = _heap->old_generation()->is_mark_complete() ?\n+    _heap->old_generation()->complete_marking_context() : nullptr;\n+\n@@ -1360,1 +1374,0 @@\n-  ShenandoahMarkingContext* ctx = get_marking_context_for_old();\n@@ -1365,1 +1378,1 @@\n-  ShenandoahScanRemembered* scanner = old_generation->card_scan();\n+  ShenandoahWriteTableScanner scanner(ShenandoahGenerationalHeap::heap()->old_generation()->card_scan());\n@@ -1369,1 +1382,1 @@\n-      help_verify_region_rem_set(scanner, r, ctx, r->end(), \"Verify init-mark remembered set violation\");\n+      help_verify_region_rem_set(&scanner, r, r->end(), \"Verify init-mark remembered set violation\");\n@@ -1382,1 +1395,1 @@\n-      help_verify_region_rem_set(&scanner, r, nullptr, r->top(), \"Remembered set violation at end of Full GC\");\n+      help_verify_region_rem_set(&scanner, r, r->top(), \"Remembered set violation at end of Full GC\");\n@@ -1395,1 +1408,0 @@\n-  ShenandoahMarkingContext* ctx = get_marking_context_for_old();\n@@ -1400,1 +1412,1 @@\n-      help_verify_region_rem_set(&scanner, r, ctx, r->get_update_watermark(), \"Remembered set violation at init-update-references\");\n+      help_verify_region_rem_set(&scanner, r, r->get_update_watermark(), \"Remembered set violation at init-update-references\");\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVerifier.cpp","additions":32,"deletions":20,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -232,1 +232,1 @@\n-  void help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r, ShenandoahMarkingContext* ctx,\n+  void help_verify_region_rem_set(Scanner* scanner, ShenandoahHeapRegion* r,\n@@ -238,2 +238,0 @@\n-\n-  ShenandoahMarkingContext* get_marking_context_for_old();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVerifier.hpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"}]}