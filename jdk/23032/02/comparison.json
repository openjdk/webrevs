{"files":[{"patch":"@@ -125,1 +125,25 @@\n-  const CardValue* _table_base;\n+  uintptr_t _table_base;\n+\n+  \/\/ Avoid UB pointer operations by using integers internally.\n+\n+  static_assert(sizeof(uintptr_t) == sizeof(CardValue*), \"simplifying assumption\");\n+  static_assert(sizeof(CardValue) == 1, \"simplifying assumption\");\n+\n+  static uintptr_t iaddr(const void* p) {\n+    return reinterpret_cast<uintptr_t>(p);\n+  }\n+\n+  uintptr_t compute_table_base(HeapWord* start) const {\n+    uintptr_t offset = iaddr(start) >> _card_shift;\n+    return iaddr(_table) - offset;\n+  }\n+\n+  void verify_card_inclusive(const CardValue* card) const {\n+    assert(iaddr(card) >= iaddr(_table), \"out of bounds\");\n+    assert(iaddr(card) <= (iaddr(_table) + sizeof(_table)), \"out of bounds\");\n+  }\n+\n+  void verify_card_exclusive(const CardValue* card) const {\n+    assert(iaddr(card) >= iaddr(_table), \"out of bounds\");\n+    assert(iaddr(card) < (iaddr(_table) + sizeof(_table)), \"out of bounds\");\n+  }\n@@ -131,1 +155,2 @@\n-    _table_base(_table - (uintptr_t(start) >> _card_shift)) {\n+    _table_base(compute_table_base(start))\n+  {\n@@ -146,2 +171,3 @@\n-    assert(card >= _table && card <=  &_table[PSCardTable::num_cards_in_stripe], \"out of bounds\");\n-    return (HeapWord*) ((card - _table_base) << _card_shift);\n+    verify_card_inclusive(card);\n+    uintptr_t addr = (iaddr(card) - _table_base) << _card_shift;\n+    return reinterpret_cast<HeapWord*>(addr);\n@@ -151,1 +177,4 @@\n-    return &_table_base[uintptr_t(addr) >> _card_shift];\n+    uintptr_t icard = _table_base + (iaddr(addr) >> _card_shift);\n+    const CardValue* card = reinterpret_cast<const CardValue*>(icard);\n+    verify_card_inclusive(card);\n+    return card;\n@@ -159,1 +188,1 @@\n-    assert(card >= _table && card <  &_table[PSCardTable::num_cards_in_stripe], \"out of bounds\");\n+    verify_card_exclusive(card);\n","filename":"src\/hotspot\/share\/gc\/parallel\/psCardTable.cpp","additions":35,"deletions":6,"binary":false,"changes":41,"status":"modified"}]}