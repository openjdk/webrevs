{"files":[{"patch":"@@ -426,0 +426,8 @@\n+    Optional<Path> nullableOutputBundle() {\n+        try {\n+            return Optional.ofNullable(outputBundle());\n+        } catch (Exception ex) {\n+            return Optional.empty();\n+        }\n+    }\n+\n@@ -752,5 +760,9 @@\n-            } else if (ThrowingSupplier.toSupplier(() -> TKit.deleteIfExists(\n-                    outputBundle())).get()) {\n-                TKit.trace(\n-                        String.format(\"Deleted [%s] file before running jpackage\",\n-                                outputBundle()));\n+            } else {\n+                nullableOutputBundle().ifPresent(path -> {\n+                    if (ThrowingSupplier.toSupplier(() -> TKit.deleteIfExists(\n+                            path)).get()) {\n+                        TKit.trace(String.format(\n+                                \"Deleted [%s] file before running jpackage\",\n+                                path));\n+                    }\n+                });\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/JPackageCommand.java","additions":17,"deletions":5,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -585,1 +585,3 @@\n-                        TKit.assertPathExists(cmd.outputBundle(), false);\n+                        cmd.nullableOutputBundle().ifPresent(outputBundle -> {\n+                            TKit.assertPathExists(outputBundle, false);\n+                        });\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/PackageTest.java","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import jdk.jpackage.internal.AppImageFile;\n@@ -105,0 +106,49 @@\n+    @Test\n+    public static void testBadAppImage() throws IOException {\n+        Path appImageDir = TKit.createTempDirectory(\"appimage\");\n+        Files.createFile(appImageDir.resolve(\"foo\"));\n+        configureAppImageWithoutJPackageXMLFile(appImageDir).addInitializer(\n+                cmd -> {\n+                    cmd.removeArgumentWithValue(\"--name\");\n+                }).run(Action.CREATE);\n+    }\n+\n+    @Test\n+    public static void testBadAppImage2() throws IOException {\n+        Path appImageDir = TKit.createTempDirectory(\"appimage\");\n+        Files.createFile(appImageDir.resolve(\"foo\"));\n+        configureAppImageWithoutJPackageXMLFile(appImageDir).run(Action.CREATE);\n+    }\n+\n+    @Test\n+    public static void testBadAppImage3() throws IOException {\n+        Path appImageDir = TKit.createTempDirectory(\"appimage\");\n+\n+        JPackageCommand appImageCmd = JPackageCommand.helloAppImage().\n+                setFakeRuntime().setArgumentValue(\"--dest\", appImageDir);\n+\n+        configureAppImageWithoutJPackageXMLFile(appImageCmd.outputBundle()).\n+                addRunOnceInitializer(() -> {\n+                    appImageCmd.execute();\n+                    Files.delete(AppImageFile.getPathInAppImage(appImageCmd.\n+                            outputBundle()));\n+                }).run(Action.CREATE);\n+    }\n+\n+    private static PackageTest configureAppImageWithoutJPackageXMLFile(\n+            Path appImageDir) {\n+        return new PackageTest()\n+                .addInitializer(cmd -> {\n+                    cmd.saveConsoleOutput(true);\n+                    cmd.addArguments(\"--app-image\", appImageDir);\n+                    cmd.removeArgumentWithValue(\"--input\");\n+                    cmd.ignoreDefaultVerbose(true); \/\/ no \"--verbose\" option\n+                })\n+                .addBundleVerifier((cmd, result) -> {\n+                    TKit.assertTextStream(\n+                    \"Error: Missing .jpackage.xml file in app-image dir\").apply(\n+                            result.getOutput().stream());\n+                })\n+                .setExpectedExitCode(1);\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/share\/AppImagePackageTest.java","additions":50,"deletions":0,"binary":false,"changes":50,"status":"modified"}]}