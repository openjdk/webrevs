{"files":[{"patch":"@@ -560,2 +560,2 @@\n-        private final ConcurrentLinkedQueue<ReadSubscription> pendingSubscriptions\n-                = new ConcurrentLinkedQueue<>();\n+        private final AtomicReference<ReadSubscription> pendingSubscriptions\n+                = new AtomicReference<>();\n@@ -660,1 +660,0 @@\n-                impl.demand.reset();\n@@ -717,8 +716,1 @@\n-                readScheduler.runOrSchedule();\n-                if (readScheduler.isStopped() || completed) {\n-                    \/\/ if already completed or stopped we can handle any\n-                    \/\/ pending connection directly from here.\n-                    if (debug.on())\n-                        debug.log(\"handling pending subscription when completed\");\n-                    handlePending();\n-                }\n+                handlePending();\n@@ -938,2 +930,3 @@\n-                ReadSubscription previous;\n-                while ((previous = pendingSubscriptions.poll()) != null) {\n+                ReadSubscription target = new ReadSubscription(this, sub);\n+                ReadSubscription previous = pendingSubscriptions.getAndSet(target);\n+                if (previous != null) {\n@@ -953,3 +946,0 @@\n-                ReadSubscription target = new ReadSubscription(this, sub);\n-                pendingSubscriptions.offer(target);\n-\n@@ -963,1 +953,0 @@\n-                ReadSubscription pending;\n@@ -966,1 +955,2 @@\n-                while ((pending = pendingSubscriptions.poll()) != null) {\n+                ReadSubscription pending = pendingSubscriptions.getAndSet(null);\n+                if (pending  != null) {\n@@ -977,3 +967,0 @@\n-                    if (!pendingSubscriptions.isEmpty()) {\n-                        pending.stopReading();\n-                    }\n@@ -981,1 +968,1 @@\n-                    subscriptionImpl.demand.reset(); \/\/ subscriber will increase demand if it needs to.\n+                    demand.reset(); \/\/ subscriber will increase demand if it needs to.\n@@ -984,1 +971,1 @@\n-                        current = subscription = pending;\n+                        subscription = pending;\n@@ -1344,1 +1331,0 @@\n-        ensureReadingStopped();\n@@ -1349,15 +1335,0 @@\n-    \/**\n-     * This method ensure that we stop reading before\n-     * switching subscribers\n-     *\/\n-    private void ensureReadingStopped() {\n-        var readPublisher = this.readPublisher;\n-        if (readPublisher == null) return;\n-        var readSubscription = readPublisher.subscription;\n-        if (readSubscription == null) return;\n-        readSubscription.stopReading();\n-        var subscriptionImpl = readPublisher.subscriptionImpl;\n-        if (subscriptionImpl == null) return;\n-        subscriptionImpl.pauseReadEvent();\n-    }\n-\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/SocketTube.java","additions":10,"deletions":39,"binary":false,"changes":49,"status":"modified"}]}