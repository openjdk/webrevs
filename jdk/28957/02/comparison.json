{"files":[{"patch":"@@ -59,1 +59,1 @@\n-                LinuxFromOptions::createLinuxDebPackage,\n+                LinuxFromOptions.createLinuxDebPackage(options),\n@@ -70,1 +70,1 @@\n-                LinuxFromOptions::createLinuxRpmPackage,\n+                LinuxFromOptions.createLinuxRpmPackage(options),\n","filename":"src\/jdk.jpackage\/linux\/classes\/jdk\/jpackage\/internal\/LinuxBundlingEnvironment.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -54,1 +54,1 @@\n-                MacFromOptions::createMacDmgPackage,\n+                MacFromOptions.createMacDmgPackage(options),\n@@ -65,1 +65,1 @@\n-                MacFromOptions::createMacPkgPackage,\n+                MacFromOptions.createMacPkgPackage(options),\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/MacBundlingEnvironment.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -147,1 +147,1 @@\n-            Function<Options, T> createPackage,\n+            T pkg,\n@@ -153,1 +153,1 @@\n-        createNativePackage(options, createPackage, createBuildEnv, _ -> pipelineBuilder, pipelineBuilderMutatorFactory);\n+        createNativePackage(options, pkg, createBuildEnv, _ -> pipelineBuilder, pipelineBuilderMutatorFactory);\n@@ -157,1 +157,1 @@\n-            Function<Options, T> createPackage,\n+            T pkg,\n@@ -163,1 +163,1 @@\n-        Objects.requireNonNull(createPackage);\n+        Objects.requireNonNull(pkg);\n@@ -168,2 +168,0 @@\n-        var pkg = Objects.requireNonNull(createPackage.apply(options));\n-\n@@ -210,1 +208,3 @@\n-        return Optional.ofNullable(bundlers.get(op)).orElseThrow(NoSuchElementException::new);\n+        return Optional.ofNullable(bundlers.get(op)).orElseThrow(() -> {\n+            throw new NoSuchElementException(String.format(\"Unsupported bundling operation: %s\", op));\n+        });\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/DefaultBundlingEnvironment.java","additions":7,"deletions":7,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -53,2 +53,0 @@\n-        Objects.requireNonNull(defaultIconResourceName);\n-\n@@ -57,3 +55,8 @@\n-        return new Stub(nonNullName, Optional.ofNullable(startupInfo), fa,\n-                isService, Optional.ofNullable(description).orElse(nonNullName),\n-                Optional.ofNullable(icon), defaultIconResourceName,\n+        return new Stub(\n+                nonNullName,\n+                Optional.ofNullable(startupInfo),\n+                fa,\n+                isService,\n+                Optional.ofNullable(description).orElse(nonNullName),\n+                Optional.ofNullable(icon),\n+                Optional.ofNullable(defaultIconResourceName).orElseGet(LauncherBuilder::defaultIconResourceName),\n@@ -173,0 +176,17 @@\n+    private static String defaultIconResourceName() {\n+        switch (OperatingSystem.current()) {\n+            case WINDOWS -> {\n+                return \"JavaApp.ico\";\n+            }\n+            case LINUX -> {\n+                return \"JavaApp.png\";\n+            }\n+            case MACOS -> {\n+                return \"JavaApp.icns\";\n+            }\n+            default -> {\n+                throw new UnsupportedOperationException();\n+            }\n+        }\n+    }\n+\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/LauncherBuilder.java","additions":25,"deletions":5,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -48,1 +48,0 @@\n-import jdk.internal.util.OperatingSystem;\n@@ -85,1 +84,1 @@\n-        final var builder = new LauncherBuilder().defaultIconResourceName(defaultIconResourceName());\n+        final var builder = new LauncherBuilder();\n@@ -170,17 +169,0 @@\n-    private static String defaultIconResourceName() {\n-        switch (OperatingSystem.current()) {\n-            case WINDOWS -> {\n-                return \"JavaApp.ico\";\n-            }\n-            case LINUX -> {\n-                return \"JavaApp.png\";\n-            }\n-            case MACOS -> {\n-                return \"JavaApp.icns\";\n-            }\n-            default -> {\n-                throw new UnsupportedOperationException();\n-            }\n-        }\n-    }\n-\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/LauncherFromOptions.java","additions":1,"deletions":19,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -635,1 +635,1 @@\n-                var sb = new StringBuffer();\n+                var sb = new StringBuilder();\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/PackagingPipeline.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -114,1 +114,1 @@\n-                scope = SetBuilder.build(OptionScope.class).add(scope).add(mutators).create();\n+                scope = SetBuilder.<OptionScope>build().add(scope).add(mutators).create();\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/OptionSpecMapperOptionScope.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -56,1 +56,1 @@\n-    SIGN_MAC_APP_IMAGE(APP_IMAGE, OperatingSystem.MACOS, \"sign\");\n+    SIGN_MAC_APP_IMAGE(APP_IMAGE, OperatingSystem.MACOS, Verb.SIGN);\n@@ -58,1 +58,21 @@\n-    StandardBundlingOperation(PackageType packageType, String optionNameRegexp, OperatingSystem os, String descriptorVerb) {\n+    public enum Verb {\n+        CREATE(BundlingOperationDescriptor.VERB_CREATE_BUNDLE),\n+        SIGN(\"sign\"),\n+        ;\n+\n+        Verb(String value) {\n+            this.value = Objects.requireNonNull(value);\n+        }\n+\n+        public String value() {\n+            return value;\n+        }\n+\n+        public boolean createBundle() {\n+            return this == CREATE;\n+        }\n+\n+        private final String value;\n+    }\n+\n+    StandardBundlingOperation(PackageType packageType, String optionNameRegexp, OperatingSystem os, Verb descriptorVerb) {\n@@ -66,1 +86,1 @@\n-        this(packageType, optionNameRegexp, os, \"create\");\n+        this(packageType, optionNameRegexp, os, Verb.CREATE);\n@@ -69,1 +89,1 @@\n-    StandardBundlingOperation(PackageType packageType, OperatingSystem os, String descriptorVerb) {\n+    StandardBundlingOperation(PackageType packageType, OperatingSystem os, Verb descriptorVerb) {\n@@ -76,1 +96,1 @@\n-    OperatingSystem os() {\n+    public OperatingSystem os() {\n@@ -92,0 +112,4 @@\n+    public boolean createBundle() {\n+        return descriptorVerb.createBundle();\n+    }\n+\n@@ -94,1 +118,1 @@\n-        return new BundlingOperationDescriptor(os(), packageTypeValue(), descriptorVerb);\n+        return new BundlingOperationDescriptor(os(), packageTypeValue(), descriptorVerb.value());\n@@ -104,1 +128,1 @@\n-    static Stream<StandardBundlingOperation> ofPlatform(OperatingSystem os) {\n+    public static Stream<StandardBundlingOperation> ofPlatform(OperatingSystem os) {\n@@ -108,0 +132,7 @@\n+    public static Predicate<StandardBundlingOperation> platform(OperatingSystem os) {\n+        Objects.requireNonNull(os);\n+        return op -> {\n+            return  op.os() == os;\n+        };\n+    }\n+\n@@ -115,7 +146,0 @@\n-    static Predicate<StandardBundlingOperation> platform(OperatingSystem os) {\n-        Objects.requireNonNull(os);\n-        return op -> {\n-            return  op.os() == os;\n-        };\n-    }\n-\n@@ -148,2 +172,2 @@\n-    static final Set<BundlingOperationOptionScope> MACOS = SetBuilder.build(\n-            BundlingOperationOptionScope.class).add(MACOS_CREATE_BUNDLE).add(SIGN_MAC_APP_IMAGE).create();\n+    static final Set<BundlingOperationOptionScope> MACOS = SetBuilder.<BundlingOperationOptionScope>build(\n+            ).add(MACOS_CREATE_BUNDLE).add(SIGN_MAC_APP_IMAGE).create();\n@@ -172,1 +196,1 @@\n-    private final String descriptorVerb;\n+    private final Verb descriptorVerb;\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/StandardBundlingOperation.java","additions":41,"deletions":17,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -546,1 +546,1 @@\n-                    return SetBuilder.build(OptionScope.class)\n+                    return SetBuilder.<OptionScope>build()\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/StandardOption.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -43,1 +43,1 @@\n-public interface Application extends BundleSpec {\n+public non-sealed interface Application extends BundleSpec {\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/Application.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -30,1 +30,1 @@\n-public interface BundleSpec {\n+public sealed interface BundleSpec permits Application, Package {\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/BundleSpec.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -44,0 +44,4 @@\n+    public BundlingOperationDescriptor(OperatingSystem os, String bundleType) {\n+        this(os, bundleType, VERB_CREATE_BUNDLE);\n+    }\n+\n@@ -53,0 +57,2 @@\n+\n+    public static final String VERB_CREATE_BUNDLE = \"create\";\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/BundlingOperationDescriptor.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -69,1 +69,1 @@\n-public interface Package extends BundleSpec {\n+public non-sealed interface Package extends BundleSpec {\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/Package.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -72,0 +72,4 @@\n+    public static <T> IdentityWrapper<T> wrapIdentity(T v) {\n+        return new IdentityWrapper<>(v);\n+    }\n+\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/util\/IdentityWrapper.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -34,1 +34,1 @@\n-    public static <T> SetBuilder<T> build(Class<? extends T> type) {\n+    public static <T> SetBuilder<T> build() {\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/util\/SetBuilder.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -49,1 +49,1 @@\n-                WinFromOpions::createWinMsiPackage,\n+                WinFromOpions.createWinMsiPackage(options),\n@@ -63,1 +63,1 @@\n-                WinFromOpions::createWinExePackage,\n+                WinFromOpions.createWinExePackage(options),\n","filename":"src\/jdk.jpackage\/windows\/classes\/jdk\/jpackage\/internal\/WinBundlingEnvironment.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+        JUnitUtils.assertArrayEquals(null, null);\n","filename":"test\/jdk\/tools\/jpackage\/helpers-test\/jdk\/jpackage\/test\/JUnitUtilsTest.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -782,0 +782,24 @@\n+    \/**\n+     * Starts a new thread. In this thread calls\n+     * {@link #useToolProviderByDefault(ToolProvider)} with the specified\n+     * {@code jpackageToolProvider} and then calls {@code workload.run()}. Joins the\n+     * thread.\n+     * <p>\n+     * The idea is to run the {@code workload} in the context of the specified\n+     * jpackage {@code ToolProvider} without altering the global variable holding\n+     * the default jpackage {@code ToolProvider}. The global variable is\n+     * thread-local; setting its value in a new thread doesn't alter its copy in the\n+     * calling thread.\n+     *\n+     * @param jpackageToolProvider jpackage {@code ToolProvider}\n+     * @param workload             the workload to run\n+     *\/\n+    public static void withToolProvider(ToolProvider jpackageToolProvider, Runnable workload) {\n+        Objects.requireNonNull(jpackageToolProvider);\n+        Objects.requireNonNull(workload);\n+        ThrowingRunnable.toRunnable(Thread.ofVirtual().start(() -> {\n+            useToolProviderByDefault(jpackageToolProvider);\n+            workload.run();\n+        })::join).run();\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/JPackageCommand.java","additions":24,"deletions":0,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -46,0 +46,1 @@\n+import java.nio.file.LinkOption;\n@@ -69,0 +70,1 @@\n+import jdk.jpackage.internal.util.FileUtils;\n@@ -76,0 +78,1 @@\n+import jdk.jpackage.test.RunnablePackageTest.Action;\n@@ -440,21 +443,19 @@\n-        var cmd = new JPackageCommand()\n-                .useToolProvider(true)\n-                .ignoreDefaultRuntime(true)\n-                .dumpOutput(true)\n-                .setPackageType(PackageType.MAC_DMG)\n-                .setArgumentValue(\"--name\", \"foo\")\n-                .addArguments(\"--runtime-image\", runtimeImage)\n-                .addArguments(\"--dest\", runtimeBundleWorkDir);\n-\n-        mutator.ifPresent(cmd::mutate);\n-\n-        cmd.execute();\n-\n-        MacHelper.withExplodedDmg(cmd, dmgImage -> {\n-            if (dmgImage.endsWith(cmd.appInstallationDirectory().getFileName())) {\n-                Executor.of(\"cp\", \"-R\")\n-                        .addArgument(dmgImage)\n-                        .addArgument(unpackadeRuntimeBundleDir)\n-                        .execute(0);\n-            }\n-        });\n+        \/\/ Preferably create a DMG bundle, fallback to PKG if DMG packaging is disabled.\n+        new PackageTest().forTypes(Stream.of(\n+                PackageType.MAC_DMG,\n+                PackageType.MAC_PKG\n+        ).filter(PackageType::isEnabled).findFirst().orElseThrow(PackageType::throwSkippedExceptionIfNativePackagingUnavailable))\n+        .addInitializer(cmd -> {\n+            cmd.useToolProvider(true)\n+            .ignoreDefaultRuntime(true)\n+            .dumpOutput(true)\n+            .removeArgumentWithValue(\"--input\")\n+            .setArgumentValue(\"--name\", \"foo\")\n+            .setArgumentValue(\"--runtime-image\", runtimeImage)\n+            .setArgumentValue(\"--dest\", runtimeBundleWorkDir);\n+\n+            mutator.ifPresent(cmd::mutate);\n+        }).addInstallVerifier(cmd -> {\n+            final Path bundleRoot = cmd.pathToUnpackedPackageFile(cmd.appInstallationDirectory());\n+            FileUtils.copyRecursive(bundleRoot, unpackadeRuntimeBundleDir, LinkOption.NOFOLLOW_LINKS);\n+        }).run(Action.CREATE, Action.UNPACK, Action.VERIFY_INSTALL, Action.PURGE);\n@@ -505,1 +506,1 @@\n-            var sb = new StringBuffer();\n+            var sb = new StringBuilder();\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/MacHelper.java","additions":23,"deletions":22,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -216,1 +216,1 @@\n-        var sb = new StringBuffer();\n+        var sb = new StringBuilder();\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/MsiDatabase.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -63,1 +63,1 @@\n-        supported = isSupported(new BundlingOperationDescriptor(os, type, \"create\"));\n+        supported = isSupported(new BundlingOperationDescriptor(os, type));\n@@ -105,5 +105,7 @@\n-        try {\n-            return Inner.BUNDLING_ENV.configurationErrors(op).isEmpty();\n-        } catch (NoSuchElementException ex) {\n-            return false;\n-        }\n+        return Inner.BUNDLING_ENV.filter(bundlingEnv -> {\n+            try {\n+                return bundlingEnv.configurationErrors(op).isEmpty();\n+            } catch (NoSuchElementException ex) {\n+                return false;\n+            }\n+        }).isPresent();\n@@ -132,1 +134,1 @@\n-        private static final BundlingEnvironment BUNDLING_ENV = ServiceLoader.load(\n+        private static final Optional<BundlingEnvironment> BUNDLING_ENV = ServiceLoader.load(\n@@ -139,1 +141,1 @@\n-        ).findFirst().orElseThrow();\n+        ).findFirst();\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/PackageType.java","additions":10,"deletions":8,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -1075,3 +1075,4 @@\n-     * Creates a directory by creating all nonexistent parent directories first\n-     * just like java.nio.file.Files#createDirectories() and returns\n-     * java.io.Closeable that will delete all created nonexistent parent\n+     * Creates a directory by creating all nonexistent parent directories first just\n+     * like\n+     * {@link Files#createDirectories(Path, java.nio.file.attribute.FileAttribute...)}\n+     * and returns java.io.Closeable that will delete all created nonexistent parent\n@@ -1080,1 +1081,1 @@\n-    public static Closeable createDirectories(Path dir) throws IOException {\n+    public static Closeable createDirectories(Path dir) {\n@@ -1090,1 +1091,6 @@\n-        Files.createDirectories(dir);\n+\n+        try {\n+            Files.createDirectories(dir);\n+        } catch (IOException ex) {\n+            throw new UncheckedIOException(ex);\n+        }\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/TKit.java","additions":11,"deletions":5,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -43,0 +43,1 @@\n+import jdk.jpackage.internal.util.function.ExceptionBox;\n@@ -45,1 +46,0 @@\n-import jdk.jpackage.test.JavaTool;\n@@ -47,2 +47,0 @@\n-import org.junit.jupiter.api.AfterAll;\n-import org.junit.jupiter.api.BeforeAll;\n@@ -91,3 +89,2 @@\n-    @BeforeAll\n-    public static void setCustomJPackageToolProvider() {\n-        JPackageCommand.useToolProviderByDefault(new ToolProvider() {\n+    private static ToolProvider createToolProvider() {\n+        return new ToolProvider() {\n@@ -153,7 +150,1 @@\n-        });\n-    }\n-\n-    @AfterAll\n-    public static void resetJPackageToolProvider() {\n-        Optional.ofNullable(JavaTool.JPACKAGE.asToolProvider()).ifPresentOrElse(\n-                JPackageCommand::useToolProviderByDefault, JPackageCommand::useExecutableByDefault);\n+        };\n@@ -204,0 +195,2 @@\n+        final var jpackageToolProviderMock = createToolProvider();\n+\n@@ -208,1 +201,11 @@\n-        ).flatMap(x -> x).toArray(String[]::new));\n+        ).flatMap(x -> x).toArray(String[]::new)).map(dynamicTest -> {\n+            return DynamicTest.dynamicTest(dynamicTest.getDisplayName(), () -> {\n+                JPackageCommand.withToolProvider(jpackageToolProviderMock, () -> {\n+                    try {\n+                        dynamicTest.getExecutable().execute();\n+                    } catch (Throwable t) {\n+                        throw ExceptionBox.toUnchecked(ExceptionBox.unbox(t));\n+                    }\n+                });\n+            });\n+        });\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/cli\/OptionsValidationFailTest.java","additions":17,"deletions":14,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -25,0 +25,2 @@\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n@@ -41,1 +43,5 @@\n-        ARRAY_ASSERTERS.getOrDefault(expected.getClass().componentType(), OBJECT_ARRAY_ASSERTER).acceptUnchecked(expected, actual);\n+        if (expected == null || actual == null) {\n+            assertEquals(expected, actual);\n+        } else {\n+            ARRAY_ASSERTERS.getOrDefault(expected.getClass().componentType(), OBJECT_ARRAY_ASSERTER).acceptUnchecked(expected, actual);\n+        }\n","filename":"test\/jdk\/tools\/jpackage\/junit\/tools\/jdk\/jpackage\/test\/JUnitUtils.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -216,1 +216,1 @@\n-        TKit.createDirectories(outputDir);\n+        Files.createDirectories(outputDir);\n@@ -236,1 +236,1 @@\n-        TKit.createDirectories(appContentFile.getParent());\n+        Files.createDirectories(appContentFile.getParent());\n","filename":"test\/jdk\/tools\/jpackage\/share\/InOutPathTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}