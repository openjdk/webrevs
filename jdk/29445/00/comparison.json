{"files":[{"patch":"@@ -1475,0 +1475,3 @@\n+    if (res != JVMTI_ERROR_NONE) {\n+      return res;\n+    }\n@@ -2048,1 +2051,1 @@\n-        if (!rewrite_cp_refs_in_annotations_typeArray(type_annotations, byte_i)) {\n+        if (!rewrite_cp_refs_in_type_annotations_typeArray(type_annotations, byte_i, \"record_info\")) {\n","filename":"src\/hotspot\/share\/prims\/jvmtiRedefineClasses.cpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -0,0 +1,24 @@\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+@MyTypeAnnotation\n+public record MyRecord(@MyTypeUseAnnotation String filter) {\n+    public static MyRecord parse(String param) {\n+        if (param == null) {\n+            throw new IllegalArgumentException(\"Filter cannot be null\");\n+        }\n+        return new MyRecord(param);\n+    }\n+}\n+\n+@Target({ElementType.TYPE})\n+@Retention(RetentionPolicy.RUNTIME)\n+@interface MyTypeAnnotation {\n+}\n+\n+@Target({ ElementType.TYPE_USE })\n+@Retention(RetentionPolicy.RUNTIME)\n+@interface MyTypeUseAnnotation {\n+}\n","filename":"test\/jdk\/java\/lang\/instrument\/RetransformRecordTypeAnn\/MyRecord.java","additions":24,"deletions":0,"binary":false,"changes":24,"status":"added"},{"patch":"@@ -0,0 +1,64 @@\n+\/*\n+ * @test\n+ * @bug 8376185\n+ * @summary Class retransformation on a record type annotation\n+ * @comment This is will rewrite the constant pool and process\n+ * @comment the type annotation\n+ * @library \/test\/lib\n+ * @modules java.base\/jdk.internal.misc\n+ * @modules java.compiler\n+ *          java.instrument\n+ * @compile ..\/NamedBuffer.java\n+ * @compile altered\/MyRecord.jcod\n+ * @run shell rename.sh\n+ * @compile MyRecord.java\n+ * @run main RedefineClassHelper\n+ * @run main\/othervm -javaagent:redefineagent.jar -Xlog:redefine*=debug TestRetransformRecord\n+ *\/\n+\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.lang.instrument.ClassFileTransformer;\n+import java.lang.instrument.Instrumentation;\n+import java.security.ProtectionDomain;\n+\n+public class TestRetransformRecord {\n+    static final String SRC = System.getProperty(\"test.src\");\n+    static final String DEST = System.getProperty(\"test.classes\");\n+\n+    public static void main(String[] args) throws Exception {\n+        MyRecord.parse(\"foo\");\n+        File clsfile = new File(DEST + \"\/altered\/MyRecord.class\");\n+        byte[] buf = null;\n+        try (FileInputStream str = new FileInputStream(clsfile)) {\n+            buf = NamedBuffer.loadBufferFromStream(str);\n+        }\n+        Instrumentation inst = RedefineClassHelper.instrumentation;\n+        inst.addTransformer(new IdentityTransformer(\"MyRecord\", buf), true);\n+        inst.retransformClasses(MyRecord.class);\n+        System.out.println(MyRecord.parse(\"foo\"));\n+    }\n+}\n+\n+class IdentityTransformer implements ClassFileTransformer {\n+    private final String className;\n+    private final byte[] buffer;\n+\n+    public IdentityTransformer(String className, byte[] buffer) {\n+        this.className = className;\n+        this.buffer = buffer;\n+    }\n+\n+    @Override\n+    public byte[] transform(ClassLoader loader,\n+                            String classPath,\n+                            Class<?> classBeingRedefined,\n+                            ProtectionDomain protectionDomain,\n+                            byte[] classfileBuffer) {\n+        if (classPath != null && classPath.equals(className.replace('.', '\/'))) {\n+            System.out.println(\"Transforming \" + className);\n+            return buffer;\n+        }\n+        return null;\n+    }\n+}\n","filename":"test\/jdk\/java\/lang\/instrument\/RetransformRecordTypeAnn\/TestRetransformRecord.java","additions":64,"deletions":0,"binary":false,"changes":64,"status":"added"},{"patch":"@@ -0,0 +1,390 @@\n+class MyRecord {\n+  0xCAFEBABE;\n+  0;                                       \/\/ minor version\n+  69;                                      \/\/ version\n+  [] {                                     \/\/ Constant Pool\n+    ;                                      \/\/ first element is empty\n+    Method #2 #3;                          \/\/ #1\n+    Class #4;                              \/\/ #2\n+    NameAndType #5 #6;                     \/\/ #3\n+    Utf8 \"java\/lang\/Record\";               \/\/ #4\n+    Utf8 \"<init>\";                         \/\/ #5\n+    Utf8 \"()V\";                            \/\/ #6\n+    Field #8 #9;                           \/\/ #7\n+    Class #11;                             \/\/ #8\n+    NameAndType #10 #12;                   \/\/ #9\n+    Utf8 \"filter\";                         \/\/ #10\n+    Utf8 \"MyRecord\";                       \/\/ #11\n+    Utf8 \"Ljava\/lang\/String;\";             \/\/ #12\n+    Class #34;                             \/\/ #13\n+    Utf8 \"LMyTypeUseAnnotation;\";          \/\/ #14\n+    String #16;                            \/\/ #15\n+    Utf8 \"Filter cannot be null\";          \/\/ #16\n+    Method #13 #18;                        \/\/ #17\n+    NameAndType #5 #19;                    \/\/ #18\n+    Utf8 \"(Ljava\/lang\/String;)V\";          \/\/ #19\n+    Method #8 #18;                         \/\/ #20\n+    InvokeDynamic 0s #22;                  \/\/ #21\n+    NameAndType #23 #24;                   \/\/ #22\n+    Utf8 \"toString\";                       \/\/ #23\n+    Utf8 \"(LMyRecord;)Ljava\/lang\/String;\";  \/\/ #24\n+    InvokeDynamic 0s #26;                  \/\/ #25\n+    NameAndType #27 #28;                   \/\/ #26\n+    Utf8 \"hashCode\";                       \/\/ #27\n+    Utf8 \"(LMyRecord;)I\";                  \/\/ #28\n+    InvokeDynamic 0s #30;                  \/\/ #29\n+    NameAndType #31 #32;                   \/\/ #30\n+    Utf8 \"equals\";                         \/\/ #31\n+    Utf8 \"(LMyRecord;Ljava\/lang\/Object;)Z\";  \/\/ #32\n+    Utf8 \"RuntimeVisibleTypeAnnotations\";  \/\/ #33\n+    Utf8 \"java\/lang\/IllegalArgumentException\";  \/\/ #34\n+    Utf8 \"Code\";                           \/\/ #35\n+    Utf8 \"LineNumberTable\";                \/\/ #36\n+    Utf8 \"LocalVariableTable\";             \/\/ #37\n+    Utf8 \"this\";                           \/\/ #38\n+    Utf8 \"LMyRecord;\";                     \/\/ #39\n+    Utf8 \"MethodParameters\";               \/\/ #40\n+    Utf8 \"parse\";                          \/\/ #41\n+    Utf8 \"(Ljava\/lang\/String;)LMyRecord;\";  \/\/ #42\n+    Utf8 \"param\";                          \/\/ #43\n+    Utf8 \"StackMapTable\";                  \/\/ #44\n+    Utf8 \"()Ljava\/lang\/String;\";           \/\/ #45\n+    Utf8 \"()I\";                            \/\/ #46\n+    Utf8 \"(Ljava\/lang\/Object;)Z\";          \/\/ #47\n+    Utf8 \"o\";                              \/\/ #48\n+    Utf8 \"Ljava\/lang\/Object;\";             \/\/ #49\n+    Utf8 \"SourceFile\";                     \/\/ #50\n+    Utf8 \"MyRecord.java\";                  \/\/ #51\n+    Utf8 \"RuntimeVisibleAnnotations\";      \/\/ #52\n+    Utf8 \"LMyTypeAnnotation;\";             \/\/ #53\n+    Utf8 \"Record\";                         \/\/ #54\n+    Utf8 \"BootstrapMethods\";               \/\/ #55\n+    String #10;                            \/\/ #56\n+    MethodHandle 1b #7;                    \/\/ #57\n+    MethodHandle 6b #59;                   \/\/ #58\n+    Method #60 #61;                        \/\/ #59\n+    Class #62;                             \/\/ #60\n+    NameAndType #63 #64;                   \/\/ #61\n+    Utf8 \"java\/lang\/runtime\/ObjectMethods\";  \/\/ #62\n+    Utf8 \"bootstrap\";                      \/\/ #63\n+    Utf8 \"(Ljava\/lang\/invoke\/MethodHandles$Lookup;Ljava\/lang\/String;Ljava\/lang\/invoke\/TypeDescriptor;Ljava\/lang\/Class;Ljava\/lang\/String;[Ljava\/lang\/invoke\/MethodHandle;)Ljava\/lang\/Object;\";  \/\/ #64\n+    Utf8 \"InnerClasses\";                   \/\/ #65\n+    Class #67;                             \/\/ #66\n+    Utf8 \"java\/lang\/invoke\/MethodHandles$Lookup\";  \/\/ #67\n+    Class #69;                             \/\/ #68\n+    Utf8 \"java\/lang\/invoke\/MethodHandles\";  \/\/ #69\n+    Utf8 \"Lookup\";                         \/\/ #70\n+  }\n+\n+  0x0031;                                  \/\/ access\n+  #8;                                      \/\/ this_cpx\n+  #2;                                      \/\/ super_cpx\n+\n+  [] {                                     \/\/ Interfaces\n+  }                                        \/\/ end of Interfaces\n+\n+  [] {                                     \/\/ Fields\n+    {                                      \/\/ field\n+      0x0012;                              \/\/ access\n+      #10;                                 \/\/ name_index\n+      #12;                                 \/\/ descriptor_index\n+      [] {                                 \/\/ Attributes\n+        Attr(#33) {                        \/\/ RuntimeVisibleTypeAnnotations\n+          [] {                             \/\/ annotations\n+            {                              \/\/ type_annotation\n+              0x13;                        \/\/ target_type: FIELD\n+              []b {                        \/\/ type_paths\n+              }\n+              #14;\n+              [] {                         \/\/ element_value_pairs\n+              }                            \/\/ element_value_pairs\n+            }                              \/\/ type_annotation\n+          }\n+        }                                  \/\/ end of RuntimeVisibleTypeAnnotations\n+      }                                    \/\/ end of Attributes\n+    }\n+  }                                        \/\/ end of Fields\n+\n+  [] {                                     \/\/ Methods\n+    {                                      \/\/ method\n+      0x0001;                              \/\/ access\n+      #5;                                  \/\/ name_index\n+      #19;                                 \/\/ descriptor_index\n+      [] {                                 \/\/ Attributes\n+        Attr(#35) {                        \/\/ Code\n+          2;                               \/\/ max_stack\n+          2;                               \/\/ max_locals\n+          Bytes[]{\n+            0x2A 0xB7 0x00 0x01 0x2A 0x2B 0xB5 0x00 0x07 0xB1;\n+          }\n+          [] {                             \/\/ Traps\n+          }                                \/\/ end of Traps\n+          [] {                             \/\/ Attributes\n+            Attr(#36) {                    \/\/ LineNumberTable\n+              [] {                         \/\/ line_number_table\n+                   0    7;\n+              }\n+            }                              \/\/ end of LineNumberTable\n+            ;\n+            Attr(#37) {                    \/\/ LocalVariableTable\n+              [] {                         \/\/ LocalVariableTable\n+                   0   10   38   39   0;\n+                   0   10   11   12   1;\n+              }\n+            }                              \/\/ end of LocalVariableTable\n+          }                                \/\/ end of Attributes\n+        }                                  \/\/ end of Code\n+        ;\n+        Attr(#40) {                        \/\/ MethodParameters\n+          []b {                            \/\/ MethodParameters\n+            #10  0x0000;\n+          }\n+        }                                  \/\/ end of MethodParameters\n+        ;\n+        Attr(#33) {                        \/\/ RuntimeVisibleTypeAnnotations\n+          [] {                             \/\/ annotations\n+            {                              \/\/ type_annotation\n+              0x16;                        \/\/ target_type: METHOD_FORMAL_PARAMETER\n+              0x00;                        \/\/ parameter_index\n+              []b {                        \/\/ type_paths\n+              }\n+              #14;\n+              [] {                         \/\/ element_value_pairs\n+              }                            \/\/ element_value_pairs\n+            }                              \/\/ type_annotation\n+          }\n+        }                                  \/\/ end of RuntimeVisibleTypeAnnotations\n+      }                                    \/\/ end of Attributes\n+    }\n+    ;\n+    {                                      \/\/ method\n+      0x0009;                              \/\/ access\n+      #41;                                 \/\/ name_index\n+      #42;                                 \/\/ descriptor_index\n+      [] {                                 \/\/ Attributes\n+        Attr(#35) {                        \/\/ Code\n+          3;                               \/\/ max_stack\n+          1;                               \/\/ max_locals\n+          Bytes[]{\n+            0x2A 0xC7 0x00 0x0D 0xBB 0x00 0x0D 0x59 0x12 0x0F 0xB7 0x00;\n+            0x11 0xBF 0xBB 0x00 0x08 0x59 0x2A 0xB7 0x00 0x14 0xB0;\n+          }\n+          [] {                             \/\/ Traps\n+          }                                \/\/ end of Traps\n+          [] {                             \/\/ Attributes\n+            Attr(#36) {                    \/\/ LineNumberTable\n+              [] {                         \/\/ line_number_table\n+                   0    9;\n+                   4   10;\n+                  14   12;\n+              }\n+            }                              \/\/ end of LineNumberTable\n+            ;\n+            Attr(#37) {                    \/\/ LocalVariableTable\n+              [] {                         \/\/ LocalVariableTable\n+                   0   23   43   12   0;\n+              }\n+            }                              \/\/ end of LocalVariableTable\n+            ;\n+            Attr(#44) {                    \/\/ StackMapTable\n+              [] {                         \/\/ \n+                14b;                       \/\/ same_frame\n+              }\n+            }                              \/\/ end of StackMapTable\n+          }                                \/\/ end of Attributes\n+        }                                  \/\/ end of Code\n+      }                                    \/\/ end of Attributes\n+    }\n+    ;\n+    {                                      \/\/ method\n+      0x0011;                              \/\/ access\n+      #23;                                 \/\/ name_index\n+      #45;                                 \/\/ descriptor_index\n+      [] {                                 \/\/ Attributes\n+        Attr(#35) {                        \/\/ Code\n+          1;                               \/\/ max_stack\n+          1;                               \/\/ max_locals\n+          Bytes[]{\n+            0x2A 0xBA 0x00 0x15 0x00 0x00 0xB0;\n+          }\n+          [] {                             \/\/ Traps\n+          }                                \/\/ end of Traps\n+          [] {                             \/\/ Attributes\n+            Attr(#36) {                    \/\/ LineNumberTable\n+              [] {                         \/\/ line_number_table\n+                   0    6;\n+              }\n+            }                              \/\/ end of LineNumberTable\n+            ;\n+            Attr(#37) {                    \/\/ LocalVariableTable\n+              [] {                         \/\/ LocalVariableTable\n+                   0    7   38   39   0;\n+              }\n+            }                              \/\/ end of LocalVariableTable\n+          }                                \/\/ end of Attributes\n+        }                                  \/\/ end of Code\n+      }                                    \/\/ end of Attributes\n+    }\n+    ;\n+    {                                      \/\/ method\n+      0x0011;                              \/\/ access\n+      #27;                                 \/\/ name_index\n+      #46;                                 \/\/ descriptor_index\n+      [] {                                 \/\/ Attributes\n+        Attr(#35) {                        \/\/ Code\n+          1;                               \/\/ max_stack\n+          1;                               \/\/ max_locals\n+          Bytes[]{\n+            0x2A 0xBA 0x00 0x19 0x00 0x00 0xAC;\n+          }\n+          [] {                             \/\/ Traps\n+          }                                \/\/ end of Traps\n+          [] {                             \/\/ Attributes\n+            Attr(#36) {                    \/\/ LineNumberTable\n+              [] {                         \/\/ line_number_table\n+                   0    6;\n+              }\n+            }                              \/\/ end of LineNumberTable\n+            ;\n+            Attr(#37) {                    \/\/ LocalVariableTable\n+              [] {                         \/\/ LocalVariableTable\n+                   0    7   38   39   0;\n+              }\n+            }                              \/\/ end of LocalVariableTable\n+          }                                \/\/ end of Attributes\n+        }                                  \/\/ end of Code\n+      }                                    \/\/ end of Attributes\n+    }\n+    ;\n+    {                                      \/\/ method\n+      0x0011;                              \/\/ access\n+      #31;                                 \/\/ name_index\n+      #47;                                 \/\/ descriptor_index\n+      [] {                                 \/\/ Attributes\n+        Attr(#35) {                        \/\/ Code\n+          2;                               \/\/ max_stack\n+          2;                               \/\/ max_locals\n+          Bytes[]{\n+            0x2A 0x2B 0xBA 0x00 0x1D 0x00 0x00 0xAC          }\n+          [] {                             \/\/ Traps\n+          }                                \/\/ end of Traps\n+          [] {                             \/\/ Attributes\n+            Attr(#36) {                    \/\/ LineNumberTable\n+              [] {                         \/\/ line_number_table\n+                   0    6;\n+              }\n+            }                              \/\/ end of LineNumberTable\n+            ;\n+            Attr(#37) {                    \/\/ LocalVariableTable\n+              [] {                         \/\/ LocalVariableTable\n+                   0    8   38   39   0;\n+                   0    8   48   49   1;\n+              }\n+            }                              \/\/ end of LocalVariableTable\n+          }                                \/\/ end of Attributes\n+        }                                  \/\/ end of Code\n+      }                                    \/\/ end of Attributes\n+    }\n+    ;\n+    {                                      \/\/ method\n+      0x0001;                              \/\/ access\n+      #10;                                 \/\/ name_index\n+      #45;                                 \/\/ descriptor_index\n+      [] {                                 \/\/ Attributes\n+        Attr(#35) {                        \/\/ Code\n+          1;                               \/\/ max_stack\n+          1;                               \/\/ max_locals\n+          Bytes[]{\n+            0x2A 0xB4 0x00 0x07 0xB0;\n+          }\n+          [] {                             \/\/ Traps\n+          }                                \/\/ end of Traps\n+          [] {                             \/\/ Attributes\n+            Attr(#36) {                    \/\/ LineNumberTable\n+              [] {                         \/\/ line_number_table\n+                   0    6;\n+              }\n+            }                              \/\/ end of LineNumberTable\n+            ;\n+            Attr(#37) {                    \/\/ LocalVariableTable\n+              [] {                         \/\/ LocalVariableTable\n+                   0    5   38   39   0;\n+              }\n+            }                              \/\/ end of LocalVariableTable\n+          }                                \/\/ end of Attributes\n+        }                                  \/\/ end of Code\n+        ;\n+        Attr(#33) {                        \/\/ RuntimeVisibleTypeAnnotations\n+          [] {                             \/\/ annotations\n+            {                              \/\/ type_annotation\n+              0x14;                        \/\/ target_type: METHOD_RETURN\n+              []b {                        \/\/ type_paths\n+              }\n+              #14;\n+              [] {                         \/\/ element_value_pairs\n+              }                            \/\/ element_value_pairs\n+            }                              \/\/ type_annotation\n+          }\n+        }                                  \/\/ end of RuntimeVisibleTypeAnnotations\n+      }                                    \/\/ end of Attributes\n+    }\n+  }                                        \/\/ end of Methods\n+\n+  [] {                                     \/\/ Attributes\n+    Attr(#50) {                            \/\/ SourceFile\n+      #51;\n+    }                                      \/\/ end of SourceFile\n+    ;\n+    Attr(#52) {                            \/\/ RuntimeVisibleAnnotations\n+      [] {                                 \/\/ annotations\n+        {                                  \/\/ annotation\n+          #53;\n+          [] {                             \/\/ element_value_pairs\n+          }                                \/\/ element_value_pairs\n+        }                                  \/\/ annotation\n+      }\n+    }                                      \/\/ end of RuntimeVisibleAnnotations\n+    ;\n+    Attr(#54) {                            \/\/ Record\n+      [] {                                 \/\/ components\n+        {                                  \/\/ component\n+          #10;                             \/\/ name_index\n+          #12;                             \/\/ descriptor_index\n+          [] {                             \/\/ Attributes\n+            Attr(#33) {                    \/\/ RuntimeVisibleTypeAnnotations\n+              [] {                         \/\/ annotations\n+                {                          \/\/ type_annotation\n+                  0x13;                    \/\/ target_type: FIELD\n+                  []b {                    \/\/ type_paths\n+                  }\n+                  #14;\n+                  [] {                     \/\/ element_value_pairs\n+                  }                        \/\/ element_value_pairs\n+                }                          \/\/ type_annotation\n+              }\n+            }                              \/\/ end of RuntimeVisibleTypeAnnotations\n+          }                                \/\/ end of Attributes\n+        }\n+      }\n+    }                                      \/\/ end of Record\n+    ;\n+    Attr(#55) {                            \/\/ BootstrapMethods\n+      [] {                                 \/\/ bootstrap_methods\n+        {                                  \/\/ bootstrap_method\n+          #58;                             \/\/ bootstrap_method_ref\n+          [] {                             \/\/ bootstrap_arguments\n+            #8;\n+            #56;\n+            #57;\n+          }                                \/\/ bootstrap_arguments\n+        }                                  \/\/ bootstrap_method\n+      }\n+    }                                      \/\/ end of BootstrapMethods\n+    ;\n+    Attr(#65) {                            \/\/ InnerClasses\n+      [] {                                 \/\/ classes\n+          #66   #68   #70  25;\n+      }\n+    }                                      \/\/ end of InnerClasses\n+  }                                        \/\/ end of Attributes\n+}\n","filename":"test\/jdk\/java\/lang\/instrument\/RetransformRecordTypeAnn\/altered\/MyRecord.jcod","additions":390,"deletions":0,"binary":false,"changes":390,"status":"added"},{"patch":"@@ -0,0 +1,4 @@\n+#!\/bin\/sh\n+# move MyRecord class file created from jcod file to the altered directory\n+mkdir $TESTCLASSES\/altered\n+mv $TESTCLASSES\/MyRecord.class $TESTCLASSES\/altered\/MyRecord.class\n","filename":"test\/jdk\/java\/lang\/instrument\/RetransformRecordTypeAnn\/rename.sh","additions":4,"deletions":0,"binary":false,"changes":4,"status":"added"},{"patch":"@@ -110,1 +110,1 @@\n-        String manifest = \"Premain-Class: RedefineClassHelper\\nCan-Redefine-Classes: true\\n\";\n+        String manifest = \"Premain-Class: RedefineClassHelper\\nCan-Redefine-Classes: true\\nCan-Retransform-Classes: true\\n\";\n","filename":"test\/lib\/RedefineClassHelper.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}