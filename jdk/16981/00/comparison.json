{"files":[{"patch":"@@ -38,0 +38,1 @@\n+import java.lang.ref.ReferenceQueue;\n@@ -502,1 +503,14 @@\n-    @NativeImageReinitialize private HashMap<Long, WeakReference<ResolvedJavaType>> resolvedJavaTypes;\n+\n+    static class KlassWeakReference extends WeakReference<ResolvedJavaType> {\n+\n+        private final Long klassPointer;\n+\n+        public KlassWeakReference(Long klassPointer, ResolvedJavaType referent, ReferenceQueue<ResolvedJavaType>q) {\n+            super(referent, q);\n+            this.klassPointer = klassPointer;\n+        }\n+    }\n+\n+    @NativeImageReinitialize private HashMap<Long, KlassWeakReference> resolvedJavaTypes;\n+\n+    @NativeImageReinitialize private ReferenceQueue<ResolvedJavaType> resolvedJavaTypesQueue;\n@@ -665,1 +679,1 @@\n-    synchronized HotSpotResolvedObjectTypeImpl fromMetaspace(long klassPointer) {\n+    synchronized HotSpotResolvedObjectTypeImpl fromMetaspace(Long klassPointer) {\n@@ -668,0 +682,1 @@\n+            resolvedJavaTypesQueue = new ReferenceQueue<>();\n@@ -678,1 +693,1 @@\n-            resolvedJavaTypes.put(klassPointer, new WeakReference<>(javaType));\n+            resolvedJavaTypes.put(klassPointer, new KlassWeakReference(klassPointer, javaType, resolvedJavaTypesQueue));\n@@ -680,0 +695,1 @@\n+        expungeStaleEntries();\n@@ -683,0 +699,15 @@\n+\n+    \/**\n+     * Clean up WeakReferences whose referents have been cleared.\n+     *\/\n+    private void expungeStaleEntries() {\n+        KlassWeakReference current = (KlassWeakReference) resolvedJavaTypesQueue.poll();\n+        while (current != null) {\n+            \/\/ Make sure the entry is still mapped to the weak reference\n+            if (resolvedJavaTypes.get(current.klassPointer) == current) {\n+                resolvedJavaTypes.remove(current.klassPointer);\n+            }\n+            current = (KlassWeakReference) resolvedJavaTypesQueue.poll();\n+        }\n+    }\n+\n","filename":"src\/jdk.internal.vm.ci\/share\/classes\/jdk\/vm\/ci\/hotspot\/HotSpotJVMCIRuntime.java","additions":34,"deletions":3,"binary":false,"changes":37,"status":"modified"}]}