{"files":[{"patch":"@@ -28,1 +28,0 @@\n-import jdk.internal.javac.PreviewFeature;\n@@ -101,1 +100,1 @@\n- * @since 24\n+ * @since 25\n@@ -103,1 +102,0 @@\n-@PreviewFeature(feature = PreviewFeature.Feature.KEY_DERIVATION)\n@@ -482,0 +480,18 @@\n+    \/\/ Rethrows the IAPE thrown by an implementation, adding an explanation\n+    \/\/ on in which situation it fails.\n+    private void rethrow(InvalidAlgorithmParameterException e)\n+            throws InvalidAlgorithmParameterException {\n+        var source = serviceIterator == null\n+                ? \"specified\" : \"previously selected\";\n+        if (!skipDebug && pdebug != null) {\n+            pdebug.println(\"A \" + this.getAlgorithm()\n+                    + \" derivation cannot be performed \"\n+                    + \"using the supplied derivation \"\n+                    + \"inputs, using the \" + source + \" \"\n+                    + theOne.provider().getName()\n+                    + \".\");\n+        }\n+        throw new InvalidAlgorithmParameterException(\"The \" + source + \" provider \"\n+                + theOne.provider.getName() + \" does not support this input\", e);\n+    }\n+\n@@ -526,1 +542,6 @@\n-            return theOne.spi().engineDeriveKey(alg, derivationSpec);\n+            try {\n+                return theOne.spi().engineDeriveKey(alg, derivationSpec);\n+            } catch (InvalidAlgorithmParameterException e) {\n+                rethrow(e);\n+                return null; \/\/ will not be called\n+            }\n@@ -557,1 +578,6 @@\n-            return theOne.spi().engineDeriveData(derivationSpec);\n+            try {\n+                return theOne.spi().engineDeriveData(derivationSpec);\n+            } catch (InvalidAlgorithmParameterException e) {\n+                rethrow(e);\n+                return null; \/\/ will not be called\n+            }\n@@ -616,0 +642,5 @@\n+                        if (!skipDebug && pdebug != null) {\n+                            pdebug.println(\"The provider \"\n+                                    + currOne.provider().getName()\n+                                    + \" is selected\");\n+                        }\n@@ -652,1 +683,2 @@\n-                throw new InvalidAlgorithmParameterException(lastException);\n+                throw new InvalidAlgorithmParameterException(\n+                        \"No provider supports this input\", lastException);\n","filename":"src\/java.base\/share\/classes\/javax\/crypto\/KDF.java","additions":38,"deletions":6,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -27,2 +27,0 @@\n-import jdk.internal.javac.PreviewFeature;\n-\n@@ -47,1 +45,1 @@\n- * @since 24\n+ * @since 25\n@@ -49,1 +47,0 @@\n-@PreviewFeature(feature = PreviewFeature.Feature.KEY_DERIVATION)\n","filename":"src\/java.base\/share\/classes\/javax\/crypto\/KDFParameters.java","additions":2,"deletions":5,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -28,2 +28,0 @@\n-import jdk.internal.javac.PreviewFeature;\n-\n@@ -72,1 +70,1 @@\n- * @since 24\n+ * @since 25\n@@ -74,1 +72,0 @@\n-@PreviewFeature(feature = PreviewFeature.Feature.KEY_DERIVATION)\n","filename":"src\/java.base\/share\/classes\/javax\/crypto\/KDFSpi.java","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,2 +28,0 @@\n-import jdk.internal.javac.PreviewFeature;\n-\n@@ -78,1 +76,1 @@\n- * @since 24\n+ * @since 25\n@@ -80,1 +78,0 @@\n-@PreviewFeature(feature = PreviewFeature.Feature.KEY_DERIVATION)\n@@ -95,1 +92,0 @@\n-    @PreviewFeature(feature = PreviewFeature.Feature.KEY_DERIVATION)\n@@ -299,1 +295,0 @@\n-    @PreviewFeature(feature = PreviewFeature.Feature.KEY_DERIVATION)\n@@ -353,1 +348,0 @@\n-    @PreviewFeature(feature = PreviewFeature.Feature.KEY_DERIVATION)\n@@ -422,1 +416,0 @@\n-    @PreviewFeature(feature = PreviewFeature.Feature.KEY_DERIVATION)\n","filename":"src\/java.base\/share\/classes\/javax\/crypto\/spec\/HKDFParameterSpec.java","additions":2,"deletions":9,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -80,2 +80,1 @@\n-        @JEP(number=478, title=\"Key Derivation Function API\", status=\"Preview\")\n-        KEY_DERIVATION,\n+        KEY_DERIVATION, \/\/remove when the boot JDK is JDK 25\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/javac\/PreviewFeature.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -159,1 +159,0 @@\n-        jdk.crypto.cryptoki, \/\/ participates in preview features\n","filename":"src\/java.base\/share\/classes\/module-info.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -26,2 +26,0 @@\n-import jdk.internal.javac.ParticipatesInPreview;\n-\n@@ -36,1 +34,0 @@\n-@ParticipatesInPreview\n","filename":"src\/jdk.crypto.cryptoki\/share\/classes\/module-info.java","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,1 +29,0 @@\n- * @enablePreview\n","filename":"test\/jdk\/com\/sun\/crypto\/provider\/KDF\/HKDFBasicFunctionsTest.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -30,1 +30,0 @@\n- * @enablePreview\n","filename":"test\/jdk\/com\/sun\/crypto\/provider\/KDF\/HKDFDelayedPRK.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,1 +30,0 @@\n- * @enablePreview\n","filename":"test\/jdk\/com\/sun\/crypto\/provider\/KDF\/HKDFExhaustiveTest.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,1 +29,0 @@\n- * @enablePreview\n","filename":"test\/jdk\/com\/sun\/crypto\/provider\/KDF\/HKDFKnownAnswerTests.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,1 +29,0 @@\n- * @enablePreview\n@@ -92,1 +91,1 @@\n-}\n\\ No newline at end of file\n+}\n","filename":"test\/jdk\/com\/sun\/crypto\/provider\/KDF\/HKDFSaltIKMTest.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -0,0 +1,124 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8353888\n+ * @library \/test\/lib \/test\/jdk\/security\/unsignedjce\n+ * @build java.base\/javax.crypto.ProviderVerifier\n+ * @run main\/othervm KDFDelayedProviderException\n+ * @summary check delayed provider selection exception messages\n+ *\/\n+\n+import jdk.test.lib.Asserts;\n+\n+import javax.crypto.KDF;\n+import javax.crypto.KDFParameters;\n+import javax.crypto.KDFSpi;\n+import javax.crypto.SecretKey;\n+import java.security.InvalidAlgorithmParameterException;\n+import java.security.Provider;\n+import java.security.Security;\n+import java.security.spec.AlgorithmParameterSpec;\n+import java.security.spec.NamedParameterSpec;\n+\n+public class KDFDelayedProviderException {\n+    public static void main(String[] args) throws Exception {\n+\n+        Security.addProvider(new P1()); \/\/ only accepts NamedParameterSpec.ED25519\n+        Security.addProvider(new P2()); \/\/ only accepts NamedParameterSpec.ED448\n+\n+        checkMessage(\"No provider supports this input\",\n+                () -> KDF.getInstance(\"K\").deriveData(NamedParameterSpec.X25519));\n+\n+        checkMessage(\"The specified provider P1 does not support this input\",\n+                () -> KDF.getInstance(\"K\", \"P1\").deriveData(NamedParameterSpec.ED448));\n+\n+        \/\/ ED448 is supported by one provider\n+        KDF.getInstance(\"K\").deriveData(NamedParameterSpec.ED448);\n+\n+        \/\/ After P1 has been selected, ED448 is no longer supported\n+        var k = KDF.getInstance(\"K\");\n+        k.deriveData(NamedParameterSpec.ED25519);\n+        checkMessage(\"The previously selected provider P1 does not support this input\",\n+                () -> k.deriveData(NamedParameterSpec.ED448));\n+\n+    }\n+\n+    public static void checkMessage(String msg, Asserts.TestMethod testMethod) {\n+        var exc = Asserts.assertThrows(InvalidAlgorithmParameterException.class, testMethod);\n+        Asserts.assertEquals(msg, exc.getMessage());\n+    }\n+\n+    public static class P1 extends Provider {\n+        public P1() {\n+            super(\"P1\", \"1\", \"\");\n+            put(\"KDF.K\", K1.class.getName());\n+        }\n+    }\n+\n+    public static class P2 extends Provider {\n+        public P2() {\n+            super(\"P2\", \"1\", \"\");\n+            put(\"KDF.K\", K2.class.getName());\n+        }\n+    }\n+\n+    public static class K1 extends KDFSpi {\n+        public K1(KDFParameters p) throws InvalidAlgorithmParameterException {\n+            super(p);\n+        }\n+        protected byte[] engineDeriveData(AlgorithmParameterSpec derivationSpec)\n+                throws InvalidAlgorithmParameterException {\n+            if (derivationSpec != NamedParameterSpec.ED25519) {\n+                throw new InvalidAlgorithmParameterException(\"Not Ed25519\");\n+            }\n+            return new byte[0];\n+        }\n+        protected KDFParameters engineGetParameters() {\n+            return null;\n+        }\n+        protected SecretKey engineDeriveKey(String alg, AlgorithmParameterSpec derivationSpec) {\n+            return null;\n+        }\n+    }\n+\n+    public static class K2 extends KDFSpi {\n+        public K2(KDFParameters p) throws InvalidAlgorithmParameterException {\n+            super(p);\n+        }\n+        protected byte[] engineDeriveData(AlgorithmParameterSpec derivationSpec)\n+                throws InvalidAlgorithmParameterException {\n+            if (derivationSpec != NamedParameterSpec.ED448) {\n+                throw new InvalidAlgorithmParameterException(\"Not Ed448\");\n+            }\n+            return new byte[0];\n+        }\n+        protected KDFParameters engineGetParameters() {\n+            return null;\n+        }\n+        protected SecretKey engineDeriveKey(String alg, AlgorithmParameterSpec derivationSpec) {\n+            return null;\n+        }\n+    }\n+}\n","filename":"test\/jdk\/javax\/crypto\/KDF\/KDFDelayedProviderException.java","additions":124,"deletions":0,"binary":false,"changes":124,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,1 +30,0 @@\n- * @enablePreview\n","filename":"test\/jdk\/javax\/crypto\/KDF\/KDFDelayedProviderSyncTest.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -31,1 +31,0 @@\n- * @enablePreview\n","filename":"test\/jdk\/javax\/crypto\/KDF\/KDFDelayedProviderTest.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -31,1 +31,0 @@\n- * @enablePreview\n@@ -130,1 +129,1 @@\n-}\n\\ No newline at end of file\n+}\n","filename":"test\/jdk\/javax\/crypto\/KDF\/KDFDelayedProviderThreadingTest.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -46,1 +46,0 @@\n- * @enablePreview\n","filename":"test\/jdk\/sun\/security\/pkcs11\/KDF\/TestHKDF.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"}]}