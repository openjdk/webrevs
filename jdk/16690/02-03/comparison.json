{"files":[{"patch":"@@ -3713,14 +3713,0 @@\n-static void warn_thp_not_configured() {\n-  if (FLAG_IS_DEFAULT(UseTransparentHugePages)) {\n-    \/\/ Don't warn if user didn't set the flag\n-    return;\n-  }\n-\n-  if (UseZGC && os::Linux::thp_requested() && HugePages::supports_shmem_thp()) {\n-    \/\/ ZGC uses shared memory THPs; don't warn if those are configured\n-    return;\n-  }\n-\n-  log_warning(pagesize)(\"UseTransparentHugePages disabled, transparent huge pages are not supported by the operating system.\");\n-}\n-\n@@ -3752,0 +3738,25 @@\n+static bool validate_thps_configured() {\n+  assert(UseTransparentHugePages, \"Sanity\");\n+  assert(os::Linux::thp_requested(), \"Sanity\");\n+\n+  if (UseZGC) {\n+    if (!HugePages::supports_shmem_thp()) {\n+      log_warning(pagesize)(\"Shared memory transparent huge pages are not enabled in the OS. \"\n+          \"Set \/sys\/kernel\/mm\/transparent_hugepage\/shmem_enabled to 'advise' to enable them.\");\n+      \/\/ UseTransparentHugePages has historically been tightly coupled with\n+      \/\/ anonymous THPs. Fall through here and let the validity be determined\n+      \/\/ by the OS configuration for anonymous THPs. ZGC doesn't use the flag\n+      \/\/ but instead checks os::Linux::thp_requested().\n+    }\n+  }\n+\n+  if (!HugePages::supports_thp()) {\n+    log_warning(pagesize)(\"Anonymous transparent huge pages are not enabled in the OS. \"\n+        \"Set \/sys\/kernel\/mm\/transparent_hugepage\/enabled to 'madvise' to enable them.\");\n+    log_warning(pagesize)(\"UseTransparentHugePages disabled, transparent huge pages are not supported by the operating system.\");\n+    return false;\n+  }\n+\n+  return true;\n+}\n+\n@@ -3781,1 +3792,1 @@\n-  \/\/ 1) Handle the case where we do not want to use huge pages\n+  \/\/ Handle the case where we do not want to use huge pages\n@@ -3794,3 +3805,2 @@\n-  \/\/ 2) check if the OS supports THPs resp. static hugepages.\n-  if (UseTransparentHugePages && !HugePages::supports_thp()) {\n-    warn_thp_not_configured();\n+  \/\/ Check if the OS supports THPs\n+  if (UseTransparentHugePages && !validate_thps_configured()) {\n@@ -3801,0 +3811,1 @@\n+  \/\/ Check if the OS supports static hugepages.\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":29,"deletions":18,"binary":false,"changes":47,"status":"modified"}]}