{"files":[{"patch":"@@ -39,1 +39,0 @@\n-#include \"runtime\/atomicAccess.hpp\"\n@@ -49,1 +48,1 @@\n-StringDedup::StorageUse* volatile StringDedup::Processor::_storage_for_requests = nullptr;\n+DeferredStatic<Atomic<StringDedup::StorageUse*>> StringDedup::Processor::_storage_for_requests{};\n@@ -55,1 +54,0 @@\n-  assert(_storage_for_requests == nullptr, \"storage already created\");\n@@ -59,1 +57,2 @@\n-  _storage_for_requests = new StorageUse(_storages[0]);\n+  auto sfr = new StorageUse(_storages[0]); \/\/ Work around lack of std::forward.\n+  _storage_for_requests.initialize(sfr);\n@@ -78,1 +77,1 @@\n-    OopStorage* storage = AtomicAccess::load(&_storage_for_requests)->storage();\n+    OopStorage* storage = _storage_for_requests->load_relaxed()->storage();\n@@ -86,1 +85,1 @@\n-  _storage_for_processing = AtomicAccess::xchg(&_storage_for_requests, _storage_for_processing);\n+  _storage_for_processing = _storage_for_requests->exchange(_storage_for_processing);\n@@ -102,1 +101,1 @@\n-  return StorageUse::obtain(&_storage_for_requests);\n+  return StorageUse::obtain(_storage_for_requests.get());\n","filename":"src\/hotspot\/share\/gc\/shared\/stringdedup\/stringDedupProcessor.cpp","additions":6,"deletions":7,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,0 +30,1 @@\n+#include \"runtime\/atomic.hpp\"\n@@ -31,0 +32,1 @@\n+#include \"utilities\/deferredStatic.hpp\"\n@@ -54,1 +56,1 @@\n-  static StorageUse* volatile _storage_for_requests;\n+  static DeferredStatic<Atomic<StorageUse*>> _storage_for_requests;\n","filename":"src\/hotspot\/share\/gc\/shared\/stringdedup\/stringDedupProcessor.hpp","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -26,1 +26,0 @@\n-#include \"runtime\/atomicAccess.hpp\"\n@@ -37,1 +36,1 @@\n-  return AtomicAccess::load_acquire(&_use_count) > 0;\n+  return _use_count.load_acquire() > 0;\n@@ -41,1 +40,1 @@\n-StringDedup::StorageUse::obtain(StorageUse* volatile* ptr) {\n+StringDedup::StorageUse::obtain(Atomic<StorageUse*>* ptr) {\n@@ -43,2 +42,2 @@\n-  StorageUse* storage = AtomicAccess::load(ptr);\n-  AtomicAccess::inc(&storage->_use_count);\n+  StorageUse* storage = ptr->load_relaxed();\n+  storage->_use_count.add_then_fetch(1u);\n@@ -49,2 +48,2 @@\n-  size_t result = AtomicAccess::sub(&_use_count, size_t(1));\n-  assert(result != SIZE_MAX, \"use count underflow\");\n+  size_t result = _use_count.fetch_then_sub(1u);\n+  assert(result != 0, \"use count underflow\");\n","filename":"src\/hotspot\/share\/gc\/shared\/stringdedup\/stringDedupStorageUse.cpp","additions":6,"deletions":7,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,0 +30,1 @@\n+#include \"runtime\/atomic.hpp\"\n@@ -38,1 +39,1 @@\n-  volatile size_t _use_count;\n+  Atomic<size_t> _use_count;\n@@ -51,1 +52,1 @@\n-  static StorageUse* obtain(StorageUse* volatile* ptr);\n+  static StorageUse* obtain(Atomic<StorageUse*>* ptr);\n","filename":"src\/hotspot\/share\/gc\/shared\/stringdedup\/stringDedupStorageUse.hpp","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"}]}