{"files":[{"patch":"@@ -2531,2 +2531,2 @@\n-    PhaseIdealLoop::optimize(igvn, PostLoopOptsEliminateReachabilityFences);\n-    print_method(PHASE_ELIMINATE_REACHABILITY_FENCES, 2);\n+    PhaseIdealLoop::optimize(igvn, PostLoopOptsExpandReachabilityFences);\n+    print_method(PHASE_EXPAND_REACHABILITY_FENCES, 2);\n","filename":"src\/hotspot\/share\/opto\/compile.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -112,1 +112,1 @@\n-  PostLoopOptsEliminateReachabilityFences\n+  PostLoopOptsExpandReachabilityFences\n","filename":"src\/hotspot\/share\/opto\/compile.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -4966,1 +4966,1 @@\n-  bool do_eliminate_reachability_fences = (_mode == PostLoopOptsEliminateReachabilityFences);\n+  bool do_expand_reachability_fences = (_mode == PostLoopOptsExpandReachabilityFences);\n@@ -5034,1 +5034,1 @@\n-                    !do_eliminate_reachability_fences && !_verify_me && !_verify_only &&\n+                    !do_expand_reachability_fences && !_verify_me && !_verify_only &&\n@@ -5115,1 +5115,1 @@\n-  if (!_verify_me && !_verify_only && !strip_mined_loops_expanded && !do_eliminate_reachability_fences) {\n+  if (!_verify_me && !_verify_only && !strip_mined_loops_expanded && !do_expand_reachability_fences) {\n@@ -5146,1 +5146,1 @@\n-    \/\/ Use a change to optimize reachability fence nodes irrespective of\n+    \/\/ Use the opportunity to optimize reachability fence nodes irrespective of\n@@ -5185,1 +5185,1 @@\n-  if (do_eliminate_reachability_fences) {\n+  if (do_expand_reachability_fences) {\n@@ -5187,1 +5187,1 @@\n-    if (eliminate_reachability_fences()) {\n+    if (expand_reachability_fences()) {\n","filename":"src\/hotspot\/share\/opto\/loopnode.cpp","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -1552,1 +1552,1 @@\n-  bool eliminate_reachability_fences();\n+  bool expand_reachability_fences();\n","filename":"src\/hotspot\/share\/opto\/loopnode.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -95,1 +95,1 @@\n-    tty->print_cr (\"             Eliminate:       %7.3f s\", timers[_t_reachability_eliminate].seconds());\n+    tty->print_cr (\"             Expand:          %7.3f s\", timers[_t_reachability_expand].seconds());\n","filename":"src\/hotspot\/share\/opto\/phase.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -90,1 +90,1 @@\n-    f(         _t_reachability_eliminate, \"reachabilityFence_eliminate\") \\\n+    f(         _t_reachability_expand, \"reachabilityFence_expand\") \\\n","filename":"src\/hotspot\/share\/opto\/phase.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -91,1 +91,1 @@\n-  flags(ELIMINATE_REACHABILITY_FENCES,  \"Eliminate Reachability Fences\") \\\n+  flags(EXPAND_REACHABILITY_FENCES,     \"Expand Reachability Fences\") \\\n","filename":"src\/hotspot\/share\/opto\/phasetype.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -33,0 +33,1 @@\n+#include \"utilities\/pair.hpp\"\n@@ -186,1 +187,1 @@\n-  return true;\n+  return true; \/\/ a full-blown safepoint can interfere with a reachability fence and it's referent\n@@ -382,3 +383,5 @@\n-\/\/ All encountered safepoints are recorded in safepoints list.\n-static void linear_traversal(Node* n, Node_Stack& worklist, VectorSet& visited, Node_List& safepoints) {\n-  for (Node* ctrl = n; ctrl != nullptr; ctrl = ctrl->in(0)) {\n+\/\/ All encountered safepoints are recorded in safepoints list, except\n+\/\/ the ones filtered out by is_interfering_sfpt_candidate().\n+static void enumerate_interfering_sfpts_linear_traversal(Node* ctrl_start, Node_Stack& stack, VectorSet& visited,\n+                                                         Node_List& interfering_sfpts) {\n+  for (Node* ctrl = ctrl_start; ctrl != nullptr; ctrl = ctrl->in(0)) {\n@@ -390,1 +393,1 @@\n-        worklist.push(ctrl, 1);\n+        stack.push(ctrl, 1);\n@@ -393,1 +396,1 @@\n-        safepoints.push(ctrl);\n+        interfering_sfpts.push(ctrl);\n@@ -401,1 +404,6 @@\n-static void enumerate_interfering_sfpts(ReachabilityFenceNode* rf, PhaseIdealLoop* phase, Node_List& safepoints) {\n+static void enumerate_interfering_sfpts(ReachabilityFenceNode* rf, PhaseIdealLoop* phase,\n+                                        Node_Stack& stack, VectorSet& visited,\n+                                        Node_List& interfering_sfpts) {\n+  assert(stack.is_empty(), \"required\");\n+  assert(visited.is_empty(), \"required\");\n+\n@@ -406,1 +414,0 @@\n-  VectorSet visited;\n@@ -408,3 +415,1 @@\n-\n-  Node_Stack stack(0);\n-  linear_traversal(rf, stack, visited, safepoints); \/\/ start point\n+  enumerate_interfering_sfpts_linear_traversal(rf, stack, visited, interfering_sfpts); \/\/ starting point in CFG\n@@ -422,1 +427,1 @@\n-      linear_traversal(cur->in(idx), stack, visited, safepoints);\n+      enumerate_interfering_sfpts_linear_traversal(cur->in(idx), stack, visited, interfering_sfpts);\n@@ -427,0 +432,3 @@\n+  \/\/ reset temporary structures to initial state\n+  assert(stack.is_empty(), \"required\");\n+  visited.clear();\n@@ -437,2 +445,2 @@\n-bool PhaseIdealLoop::eliminate_reachability_fences() {\n-  Compile::TracePhase tp(_t_reachability_eliminate);\n+bool PhaseIdealLoop::expand_reachability_fences() {\n+  Compile::TracePhase tp(_t_reachability_expand);\n@@ -445,12 +453,20 @@\n-  Unique_Node_List redundant_rfs;\n-  Node_List worklist;\n-  for (int i = 0; i < C->reachability_fences_count(); i++) {\n-    ReachabilityFenceNode* rf = C->reachability_fence(i);\n-    assert(!is_redundant_rf(rf, true \/*rf_only*\/), \"missed\");\n-    if (PreserveReachabilityFencesOnConstants) {\n-      const Type* referent_t = igvn().type(rf->referent());\n-      assert(referent_t != TypePtr::NULL_PTR, \"redundant rf\");\n-      bool is_constant_rf = referent_t->singleton();\n-      if (is_constant_rf) {\n-        DEBUG_ONLY( no_of_constant_rfs += 1; )\n-        continue; \/\/ don't eliminate constant rfs\n+  Unique_Node_List for_removal;\n+  typedef Pair<SafePointNode*,Node*> ReachabilityEdge;\n+  GrowableArray<ReachabilityEdge> reachability_edges;\n+  {\n+    \/\/ Reuse temporary structures to avoid allocating them for every single RF node.\n+    Node_List sfpt_worklist;\n+    Node_Stack stack(0);\n+    VectorSet visited;\n+\n+    for (int i = 0; i < C->reachability_fences_count(); i++) {\n+      ReachabilityFenceNode* rf = C->reachability_fence(i);\n+      assert(!is_redundant_rf(rf, true \/*rf_only*\/), \"missed\");\n+      if (PreserveReachabilityFencesOnConstants) {\n+        const Type* referent_t = igvn().type(rf->referent());\n+        assert(referent_t != TypePtr::NULL_PTR, \"redundant rf\");\n+        bool is_constant_rf = referent_t->singleton();\n+        if (is_constant_rf) {\n+          DEBUG_ONLY( no_of_constant_rfs += 1; )\n+          continue; \/\/ leave RFs on constants intact\n+        }\n@@ -458,13 +474,13 @@\n-    }\n-    if (!is_redundant_rf(rf, false \/*rf_only*\/)) {\n-      Node_List safepoints;\n-      enumerate_interfering_sfpts(rf, this, safepoints);\n-\n-      Node* referent = rf->referent();\n-      while (safepoints.size() > 0) {\n-        SafePointNode* sfpt = safepoints.pop()->as_SafePoint();\n-        assert(is_dominator(get_ctrl(referent), sfpt), \"\");\n-        assert(sfpt->req() == rf_base_offset(sfpt), \"no extra edges allowed\");\n-        if (sfpt->find_edge(referent) == -1) {\n-          worklist.push(sfpt);\n-          worklist.push(referent);\n+      if (!is_redundant_rf(rf, false \/*rf_only*\/)) {\n+        assert(sfpt_worklist.size() == 0, \"not empty\");\n+        enumerate_interfering_sfpts(rf, this, stack, visited, sfpt_worklist);\n+\n+        Node* referent = rf->referent();\n+        while (sfpt_worklist.size() > 0) {\n+          SafePointNode* sfpt = sfpt_worklist.pop()->as_SafePoint();\n+          assert(is_dominator(get_ctrl(referent), sfpt), \"\");\n+          assert(sfpt->req() == rf_base_offset(sfpt), \"no extra edges allowed\");\n+          if (sfpt->find_edge(referent) == -1) {\n+            ReachabilityEdge p(sfpt, referent);\n+            reachability_edges.push(p);\n+          }\n@@ -473,0 +489,1 @@\n+      for_removal.push(rf);\n@@ -474,1 +491,0 @@\n-    redundant_rfs.push(rf);\n@@ -476,6 +492,9 @@\n-\n-  while (worklist.size() > 0) {\n-    Node* referent = worklist.pop();\n-    Node* sfpt     = worklist.pop();\n-    sfpt->add_req(referent);\n-    igvn()._worklist.push(sfpt);\n+  \/\/ Materialize reachability edges.\n+  while (reachability_edges.length() > 0) {\n+    ReachabilityEdge p = reachability_edges.pop();\n+    SafePointNode* sfpt = p.first;\n+    Node* referent = p.second;\n+    if (sfpt->find_edge(referent) == -1) {\n+      sfpt->add_req(referent);\n+      igvn()._worklist.push(sfpt);\n+    }\n@@ -483,5 +502,4 @@\n-\n-  \/\/ Eliminate redundant RFs.\n-  bool progress = (redundant_rfs.size() > 0);\n-  while (redundant_rfs.size() > 0) {\n-    remove_rf(redundant_rfs.pop()->as_ReachabilityFence());\n+  \/\/ Eliminate processed RFs. They become redundant once reachability edges are added.\n+  bool progress = (for_removal.size() > 0);\n+  while (for_removal.size() > 0) {\n+    remove_rf(for_removal.pop()->as_ReachabilityFence());\n","filename":"src\/hotspot\/share\/opto\/reachability.cpp","additions":69,"deletions":51,"binary":false,"changes":120,"status":"modified"}]}