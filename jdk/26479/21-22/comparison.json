{"files":[{"patch":"@@ -1432,1 +1432,1 @@\n-         * Runs the given task, as well as remaining local tasks.\n+         * Runs the given task, as well as remaining local tasks\n@@ -1434,2 +1434,1 @@\n-        final void topLevelExec(ForkJoinTask<?> task, int cfg) {\n-            int fifo = cfg & FIFO, clr = cfg & CLEAR_TLS;\n+        final void topLevelExec(ForkJoinTask<?> task, int fifo) {\n@@ -1438,26 +1437,1 @@\n-                task = null;\n-                int p = top, cap; ForkJoinTask<?>[] a;\n-                if ((a = array) == null || (cap = a.length) <= 0)\n-                    break;\n-                if (fifo == 0) {  \/\/ specialized localPop\n-                    int s = p - 1; long k;\n-                    if (U.getReference(\n-                            a, k = slotOffset((cap - 1) & s)) != null &&\n-                        (task = (ForkJoinTask<?>)\n-                         U.getAndSetReference(a, k, null)) != null) {\n-                        top = s;\n-                    }\n-                } else {         \/\/ specialized localPoll\n-                    for (int b = base; p - b > 0; ) {\n-                        int nb = b + 1;\n-                        if ((task = (ForkJoinTask<?>)U.getAndSetReference(\n-                                 a, slotOffset((cap - 1) & b), null)) != null) {\n-                            base = nb;\n-                            break;\n-                        }\n-                        if (nb == p)\n-                            break;\n-                        while (b == (b = U.getIntAcquire(this, BASE)))\n-                            Thread.onSpinWait();\n-                    }\n-                }\n+                task = (fifo != 0) ? localPoll() : localPop();\n@@ -1994,2 +1968,2 @@\n-            int cfg = w.config, r = w.stackPred;          \/\/ seed from registerWorker\n-            int rescans = 0, inactive = 0, taken = 0, n;\n+            int r = w.stackPred;                          \/\/ seed from registerWorker\n+            int fifo = (int)config & FIFO, rescans = 0, inactive = 0, taken = 0, n;\n@@ -2008,2 +1982,0 @@\n-                            if (q.base != b)\n-                                continue;                 \/\/ inconsistent\n@@ -2011,11 +1983,12 @@\n-                            if (t == null) {\n-                                if (q.array != a)         \/\/ resized\n-                                    continue;\n-                                if (rescans > 0)          \/\/ ran or stalled\n-                                    break scan;\n-                                if (U.getReference(a, np) != null ||\n-                                    (rescans < 0 &&\n-                                     (U.getReferenceAcquire(a, bp) != null ||\n-                                      q.top != q.base))) {\n-                                    rescans = 1;          \/\/ may be stalled\n-                                    continue;\n+                            if (q.base == b) {            \/\/ else inconsistent\n+                                if (t == null) {\n+                                    if (q.array == a) {   \/\/ else resized\n+                                        if (rescans > 0)  \/\/ ran or stalled\n+                                            break scan;\n+                                        if (U.getReference(a, np) == null &&\n+                                            (rescans >= 0 ||\n+                                             (U.getReferenceAcquire(a, bp) == null &&\n+                                              q.top == q.base)))\n+                                            break;\n+                                        rescans = 1;      \/\/ may be stalled\n+                                    }\n@@ -2023,6 +1996,16 @@\n-                                break;                    \/\/ probably empty\n-                            }\n-                            else if (inactive != 0) {\n-                                if ((inactive = tryReactivate(w)) != 0) {\n-                                    rescans = 1;          \/\/ can't take yet\n-                                    break scan;\n+                                else if (inactive != 0) {\n+                                    if ((inactive = tryReactivate(w)) != 0) {\n+                                        rescans = 1;      \/\/ can't take yet\n+                                        break scan;\n+                                    }\n+                                }\n+                                else if (U.compareAndSetReference(a, bp, t, null)) {\n+                                    q.base = nb;\n+                                    Object nt = U.getReferenceAcquire(a, np);\n+                                    w.source = qid;\n+                                    rescans = 1;\n+                                    ++taken;\n+                                    if (nt != null &&     \/\/ confirm a[nk]\n+                                        U.getReferenceAcquire(a, np) == nt)\n+                                        signalWork(a, nk); \/\/ propagate\n+                                    w.topLevelExec(t, fifo);\n@@ -2030,11 +2013,0 @@\n-                            }\n-                            else if (U.compareAndSetReference(a, bp, t, null)) {\n-                                q.base = nb;\n-                                Object nt = U.getReferenceAcquire(a, np);\n-                                w.source = qid;\n-                                rescans = 1;\n-                                ++taken;\n-                                if (nt != null &&         \/\/ confirm a[nk]\n-                                    U.getReferenceAcquire(a, np) == nt)\n-                                    signalWork(a, nk);    \/\/ propagate\n-                                w.topLevelExec(t, cfg);\n@@ -2063,1 +2035,1 @@\n-     * @param taken nonzero if stole tasks since last deactivation\n+     * @param taken number of stolen tasks since last deactivation\n@@ -2076,1 +2048,1 @@\n-                if (taken != 0)\n+                if (taken != 0) {\n@@ -2078,0 +2050,4 @@\n+                    if ((w.config & CLEAR_TLS) != 0 &&\n+                        (Thread.currentThread() instanceof ForkJoinWorkerThread f))\n+                        f.resetThreadLocals(); \/\/ (instanceof check always true)\n+                }\n@@ -2079,2 +2055,2 @@\n-                    inactive = w.phase & IDLE;    \/\/ check quiescent termination\n-                else {                            \/\/ spin for approx 1 scan cost\n+                    inactive = w.phase & IDLE; \/\/ check quiescent termination\n+                else {                         \/\/ spin for approx 1 scan cost\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":41,"deletions":65,"binary":false,"changes":106,"status":"modified"}]}