{"files":[{"patch":"@@ -1432,2 +1432,1 @@\n-         * Runs the given task, as well as remaining local tasks, and\n-         * those from the given queue that can be polled without interference.\n+         * Runs the given task, as well as remaining local tasks.\n@@ -1435,30 +1434,23 @@\n-        final void topLevelExec(ForkJoinTask<?> task, WorkQueue q, int fifo) {\n-            if (task != null && q != null) {\n-                int stolen = 1;\n-                outer: for (;;) {\n-                    task.doExec();\n-                    task = null;\n-                    int p = top, cap; ForkJoinTask<?>[] a;\n-                    if ((a = array) == null || (cap = a.length) <= 0)\n-                        break;\n-                    if (fifo == 0) {  \/\/ specialized localPop\n-                        int s = p - 1; long k;\n-                        if (U.getReference(\n-                                a, k = slotOffset((cap - 1) & s)) != null &&\n-                            (task = (ForkJoinTask<?>)\n-                             U.getAndSetReference(a, k, null)) != null) {\n-                            top = s;\n-                            continue;\n-                        }\n-                    } else {         \/\/ specialized localPoll\n-                        for (int b = base; p - b > 0; ) {\n-                            int nb = b + 1;\n-                            if ((task = (ForkJoinTask<?>)U.getAndSetReference(\n-                                     a, slotOffset((cap - 1) & b), null)) != null) {\n-                                base = nb;\n-                                continue outer;\n-                            }\n-                            if (nb == p)\n-                                break;\n-                            while (b == (b = U.getIntAcquire(this, BASE)))\n-                                Thread.onSpinWait();\n+        final void topLevelExec(ForkJoinTask<?> task, int cfg) {\n+            int fifo = cfg & FIFO, clr = cfg & CLEAR_TLS;\n+            while (task != null) {\n+                task.doExec();\n+                task = null;\n+                int p = top, cap; ForkJoinTask<?>[] a;\n+                if ((a = array) == null || (cap = a.length) <= 0)\n+                    break;\n+                if (fifo == 0) {  \/\/ specialized localPop\n+                    int s = p - 1; long k;\n+                    if (U.getReference(\n+                            a, k = slotOffset((cap - 1) & s)) != null &&\n+                        (task = (ForkJoinTask<?>)\n+                         U.getAndSetReference(a, k, null)) != null) {\n+                        top = s;\n+                    }\n+                } else {         \/\/ specialized localPoll\n+                    for (int b = base; p - b > 0; ) {\n+                        int nb = b + 1;\n+                        if ((task = (ForkJoinTask<?>)U.getAndSetReference(\n+                                 a, slotOffset((cap - 1) & b), null)) != null) {\n+                            base = nb;\n+                            break;\n@@ -1466,0 +1458,4 @@\n+                        if (nb == p)\n+                            break;\n+                        while (b == (b = U.getIntAcquire(this, BASE)))\n+                            Thread.onSpinWait();\n@@ -1467,14 +1463,0 @@\n-\n-                    ForkJoinTask<?> t; ForkJoinTask<?>[] qa; int qcap;\n-                    if ((qa = q.array) == null || (qcap = qa.length) <= 0)\n-                        break;       \/\/ one-shot steal attempt\n-                    int qb = q.base; long qk;\n-                    do {\n-                        t = (ForkJoinTask<?>)U.getReferenceAcquire(\n-                            qa, qk = slotOffset((qcap - 1) & qb));\n-                    } while (qb != (qb = q.base));\n-                    if (t == null || !U.compareAndSetReference(qa, qk, t, null))\n-                        break;\n-                    q.base = qb + 1;\n-                    ++stolen;\n-                    task = t;\n@@ -1482,1 +1464,0 @@\n-                nsteals += stolen;\n@@ -2013,2 +1994,2 @@\n-            int r = w.stackPred;                          \/\/ seed from registerWorker\n-            int fifo = (int)config & FIFO, rescans = 0, inactive = 0, taken = 0, n;\n+            int cfg = w.config, r = w.stackPred;          \/\/ seed from registerWorker\n+            int rescans = 0, inactive = 0, taken = 0, n;\n@@ -2054,1 +2035,2 @@\n-                                rescans = taken = 1;\n+                                rescans = 1;\n+                                ++taken;\n@@ -2058,1 +2040,1 @@\n-                                w.topLevelExec(t, q, fifo);\n+                                w.topLevelExec(t, cfg);\n@@ -2093,7 +2075,11 @@\n-            else if (((c & RC_MASK) == 0L && quiescent() > 0) || taken == 0)\n-                inactive = w.phase & IDLE;    \/\/ check quiescent termination\n-            else {                            \/\/ spin for approx 1 scan cost\n-                int tc = (short)(c >>> TC_SHIFT);\n-                int spins = Math.max(tc << 2, SPIN_WAITS) | 0x3;\n-                while ((inactive = w.phase & IDLE) != 0 && --spins != 0)\n-                    Thread.onSpinWait();\n+            else {\n+                if (taken != 0)\n+                    w.nsteals += taken;\n+                if (((c & RC_MASK) == 0L && quiescent() > 0) || taken == 0)\n+                    inactive = w.phase & IDLE;    \/\/ check quiescent termination\n+                else {                            \/\/ spin for approx 1 scan cost\n+                    int tc = (short)(c >>> TC_SHIFT);\n+                    int spins = Math.max((tc << 1) + tc, SPIN_WAITS);\n+                    while ((inactive = w.phase & IDLE) != 0 && --spins != 0)\n+                        Thread.onSpinWait();\n+                }\n@@ -2134,4 +2120,0 @@\n-            if ((w.config & CLEAR_TLS) != 0 &&\n-                (Thread.currentThread() instanceof ForkJoinWorkerThread f))\n-                f.resetThreadLocals();            \/\/ clear before release\n-            LockSupport.setCurrentBlocker(this);\n@@ -2140,0 +2122,1 @@\n+                LockSupport.setCurrentBlocker(this);\n@@ -2166,0 +2149,1 @@\n+                LockSupport.setCurrentBlocker(null);\n@@ -2167,1 +2151,0 @@\n-            LockSupport.setCurrentBlocker(null);\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":46,"deletions":63,"binary":false,"changes":109,"status":"modified"}]}