{"files":[{"patch":"@@ -41,0 +41,3 @@\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n@@ -44,0 +47,1 @@\n+import java.util.Collections;\n@@ -46,0 +50,1 @@\n+import java.util.Optional;\n@@ -48,0 +53,1 @@\n+import java.util.regex.Pattern;\n@@ -64,0 +70,25 @@\n+    private static final String UID = \"uid\";\n+    private static final String GID = \"gid\";\n+\n+    private static final Pattern ID_PATTERN = Pattern.compile(\"uid=(?<\" + UID + \">\\\\d+)\\\\([^\\\\)]+\\\\)\\\\s+gid=(?<\" + GID + \">\\\\d+).*\");\n+\n+    private static final Optional<String> USER = ProcessHandle.current().info().user().map(\n+            user -> {\n+                try (var br = new BufferedReader(new InputStreamReader(new ProcessBuilder(\"id\", user).start().getInputStream()))) {\n+                    for (final var line : br.lines().toList()) {\n+                        final var m = ID_PATTERN.matcher(line);\n+\n+                        if (m.matches()) {\n+                            return \"--user=\" + m.group(UID) + \":\" + m.group(GID);\n+                        }\n+                    }\n+                } catch (IOException e) {\n+                    \/\/ do nothing...\n+                }\n+\n+                return null;\n+            }\n+    );\n+\n+    private static final String NET_BIND_SERVICE = \"--cap-add=NET_BIND_SERVICE\";\n+\n@@ -72,18 +103,6 @@\n-            \/\/ Start the loop process in the \"main\" container, then run test cases\n-            \/\/ using a sidecar container.\n-            MainContainer mainContainer = new MainContainer();\n-            mainContainer.start();\n-            mainContainer.waitForMainMethodStart(TIME_TO_WAIT_FOR_MAIN_METHOD_START);\n-\n-            for (AttachStrategy attachStrategy : EnumSet.allOf(AttachStrategy.class)) {\n-                long mainProcPid = testCase01(attachStrategy);\n-\n-                \/\/ Excluding the test case below until JDK-8228850 is fixed\n-                \/\/ JDK-8228850: jhsdb jinfo fails with ClassCastException:\n-                \/\/ s.j.h.oops.TypeArray cannot be cast to s.j.h.oops.Instance\n-                \/\/ mainContainer.assertIsAlive();\n-                \/\/ testCase02(mainProcPid, attachStrategy);\n-\n-                mainContainer.assertIsAlive();\n-                testCase03(mainProcPid, attachStrategy);\n-            }\n+            for (final boolean elevated : USER.isPresent() ? new Boolean[] { false, true } : new Boolean[] { false }) {\n+                \/\/ Start the loop process in the \"main\" container, then run test cases\n+                \/\/ using a sidecar container.\n+                MainContainer mainContainer = new MainContainer();\n+                mainContainer.start(elevated);\n+                mainContainer.waitForMainMethodStart(TIME_TO_WAIT_FOR_MAIN_METHOD_START);\n@@ -91,1 +110,15 @@\n-            mainContainer.waitForAndCheck(TIME_TO_RUN_MAIN_PROCESS * 1000);\n+                for (AttachStrategy attachStrategy : EnumSet.allOf(AttachStrategy.class)) {\n+                    long mainProcPid = testCase01(attachStrategy, elevated);\n+\n+                    \/\/ Excluding the test case below until JDK-8228850 is fixed\n+                    \/\/ JDK-8228850: jhsdb jinfo fails with ClassCastException:\n+                    \/\/ s.j.h.oops.TypeArray cannot be cast to s.j.h.oops.Instance\n+                    \/\/ mainContainer.assertIsAlive();\n+                    \/\/ testCase02(mainProcPid, attachStrategy, elevated);\n+\n+                    mainContainer.assertIsAlive();\n+                    testCase03(mainProcPid, attachStrategy, elevated);\n+                }\n+\n+                mainContainer.waitForAndCheck(TIME_TO_RUN_MAIN_PROCESS * 1000);\n+            }\n@@ -99,2 +132,2 @@\n-    private static long testCase01(AttachStrategy attachStrategy) throws Exception {\n-        OutputAnalyzer out = runSideCar(MAIN_CONTAINER_NAME, attachStrategy, \"\/jdk\/bin\/jcmd\", \"-l\")\n+    private static long testCase01(AttachStrategy attachStrategy, boolean elevated) throws Exception {\n+        OutputAnalyzer out = runSideCar(MAIN_CONTAINER_NAME, attachStrategy, elevated, \"\/jdk\/bin\/jcmd\", \"-l\")\n@@ -112,2 +145,2 @@\n-    private static void testCase02(long pid, AttachStrategy attachStrategy) throws Exception {\n-        runSideCar(MAIN_CONTAINER_NAME, attachStrategy, \"\/jdk\/bin\/jhsdb\", \"jinfo\", \"--pid\", \"\" + pid)\n+    private static void testCase02(long pid, AttachStrategy attachStrategy, boolean elevated) throws Exception {\n+        runSideCar(MAIN_CONTAINER_NAME, attachStrategy, elevated, \"\/jdk\/bin\/jhsdb\", \"jinfo\", \"--pid\", \"\" + pid)\n@@ -121,2 +154,2 @@\n-    private static void testCase03(long pid, AttachStrategy attachStrategy) throws Exception {\n-        runSideCar(MAIN_CONTAINER_NAME, attachStrategy, \"\/jdk\/bin\/jcmd\", \"\" + pid, \"help\")\n+    private static void testCase03(long pid, AttachStrategy attachStrategy, boolean elevated) throws Exception {\n+        runSideCar(MAIN_CONTAINER_NAME, attachStrategy, elevated, \"\/jdk\/bin\/jcmd\", \"\" + pid, \"help\")\n@@ -125,1 +158,1 @@\n-        runSideCar(MAIN_CONTAINER_NAME, attachStrategy, \"\/jdk\/bin\/jcmd\", \"\" + pid, \"JFR.start\")\n+        runSideCar(MAIN_CONTAINER_NAME, attachStrategy, elevated, \"\/jdk\/bin\/jcmd\", \"\" + pid, \"JFR.start\")\n@@ -137,2 +170,1 @@\n-    private static OutputAnalyzer runSideCar(String mainContainerName, AttachStrategy attachStrategy, String whatToRun,\n-                                             String... args) throws Exception {\n+    private static OutputAnalyzer runSideCar(String mainContainerName, AttachStrategy attachStrategy, boolean elevated,  String whatToRun, String... args) throws Exception {\n@@ -153,0 +185,2 @@\n+        List<String> elevatedOpts = elevated && USER.isPresent() ? List.of(NET_BIND_SERVICE, USER.get()) : Collections.emptyList();\n+\n@@ -159,0 +193,1 @@\n+        cmd.addAll(elevatedOpts);\n@@ -207,1 +242,1 @@\n-        public Process start() throws Exception {\n+        public Process start(final boolean elevated) throws Exception {\n@@ -210,0 +245,6 @@\n+\n+            if (elevated && USER.isPresent()) {\n+                opts.addDockerOpts(USER.get());\n+                opts.addDockerOpts(NET_BIND_SERVICE);\n+            }\n+\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestJcmdWithSideCar.java","additions":70,"deletions":29,"binary":false,"changes":99,"status":"modified"}]}