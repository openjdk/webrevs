{"files":[{"patch":"@@ -27,1 +27,2 @@\n- * @summary Test that the HttpsURLConnection does not set IPv6 address literals for SNI hostname during TLS handshake\n+ * @summary Test that the HttpsURLConnection does not set IPv6 address literals for\n+ *          SNI hostname during TLS handshake\n@@ -29,0 +30,1 @@\n+ * @comment Add -Djavax.net.debug=all to the following line to enable SSL debugging\n@@ -50,0 +52,2 @@\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n@@ -60,1 +64,1 @@\n-    volatile static boolean serverReady = false;\n+    private final CountDownLatch serverReady = new CountDownLatch(1);\n@@ -62,4 +66,5 @@\n-    \/*\n-     * Turn on SSL debugging?\n-     *\/\n-    static boolean debug = Boolean.getBoolean(\"test.debug\");\n+    \/\/ use any free port by default\n+    volatile int serverPort = 0;\n+\n+    \/\/ stores an exception thrown by server in a separate thread\n+    volatile Exception serverException = null;\n@@ -77,1 +82,3 @@\n-            (SSLServerSocket) sslssf.createServerSocket(serverPort, 0, InetAddress.getByName(\"[::1]\"));\n+            (SSLServerSocket) sslssf.createServerSocket(\n+                    serverPort, 0,\n+                    InetAddress.getByName(\"[::1]\"));\n@@ -82,1 +89,1 @@\n-         * Signal Client, we're ready for his connect.\n+         * Signal the client, the server is ready to accept connection.\n@@ -84,1 +91,1 @@\n-        serverReady = true;\n+        serverReady.countDown();\n@@ -105,2 +112,6 @@\n-        while (!serverReady) {\n-            Thread.sleep(50);\n+        boolean ready = serverReady.await(10, TimeUnit.SECONDS);\n+        if (!ready) {\n+            throw new RuntimeException(\"Server timed out.\");\n+        }\n+        if (serverException != null) {\n+            throw new RuntimeException(\"Server failed to start.\", serverException);\n@@ -124,6 +135,0 @@\n-    \/\/ use any free port by default\n-    volatile int serverPort = 0;\n-\n-    \/\/ stores an exception thrown by server in a separate thread\n-    volatile Exception serverException = null;\n-\n@@ -135,3 +140,0 @@\n-        if (debug) {\n-            System.setProperty(\"javax.net.debug\", \"all\");\n-        }\n@@ -153,1 +155,1 @@\n-        startClient();\n+        doClientSide();\n@@ -164,15 +166,12 @@\n-    void startServer() throws Exception {\n-        serverThread = new Thread() {\n-            public void run() {\n-                try {\n-                    doServerSide();\n-                } catch (Exception e) {\n-                    \/*\n-                     * Our server thread just died.\n-                     *\n-                     * Release the client, if not active already...\n-                     *\/\n-                    System.err.println(\"Server died:\");\n-                    serverReady = true;\n-                    serverException = e;\n-                }\n+    void startServer() {\n+        serverThread = new Thread(() -> {\n+            try {\n+                doServerSide();\n+            } catch (Exception e) {\n+                \/*\n+                 * Our server thread just died.\n+                 *\n+                 * Store the exception and release the client.\n+                 *\/\n+                serverException = e;\n+                serverReady.countDown();\n@@ -180,1 +179,1 @@\n-        };\n+        });\n@@ -184,4 +183,0 @@\n-    void startClient() throws Exception {\n-        doClientSide();\n-    }\n-\n@@ -202,2 +197,4 @@\n-            public Socket createSocket(Socket s, String host, int port, boolean autoClose) throws IOException {\n-                final SSLSocket so = (SSLSocket) wrap.createSocket(s, host, port, autoClose);\n+            public Socket createSocket(Socket s, String host, int port, boolean autoClose)\n+                    throws IOException {\n+                final SSLSocket so =\n+                        (SSLSocket) wrap.createSocket(s, host, port, autoClose);\n@@ -327,1 +324,1 @@\n-            public Socket createSocket(String h, int p) throws IOException, UnknownHostException {\n+            public Socket createSocket(String h, int p) {\n@@ -331,1 +328,1 @@\n-            public Socket createSocket(String h, int p, InetAddress ipa, int lp) throws IOException, UnknownHostException {\n+            public Socket createSocket(String h, int p, InetAddress ipa, int lp) {\n@@ -335,1 +332,1 @@\n-            public Socket createSocket(InetAddress h, int p) throws IOException {\n+            public Socket createSocket(InetAddress h, int p) {\n@@ -339,1 +336,1 @@\n-            public Socket createSocket(InetAddress a, int p, InetAddress l, int lp) throws IOException {\n+            public Socket createSocket(InetAddress a, int p, InetAddress l, int lp) {\n","filename":"test\/jdk\/javax\/net\/ssl\/HttpsURLConnection\/SubjectAltNameIPv6.java","additions":44,"deletions":47,"binary":false,"changes":91,"status":"modified"}]}