{"files":[{"patch":"@@ -15,2 +15,8 @@\n-  struct I {\n-    int32_t idx;\n+  class I {\n+    friend IndexedFreeListAllocator<E, flag>;\n+    int32_t _idx;\n+#ifdef ASSERT\n+    IndexedFreeListAllocator<E, flag>* _owner;\n+#endif\n+\n+  public:\n@@ -18,1 +24,1 @@\n-      return idx != other.idx;\n+      return _idx != other._idx;\n@@ -21,1 +27,1 @@\n-      return idx == other.idx;\n+      return _idx == other._idx;\n@@ -25,0 +31,2 @@\n+\n+private:\n@@ -39,2 +47,2 @@\n-  GrowableArrayCHeap<BackingElement, flag> backing_storage;\n-  I free_start;\n+  GrowableArrayCHeap<BackingElement, flag> _backing_storage;\n+  I _free_start;\n@@ -42,0 +50,1 @@\n+public:\n@@ -43,2 +52,2 @@\n-  : backing_storage(8),\n-  free_start(I{0}) {}\n+  : _backing_storage(8),\n+  _free_start(I{0}) {}\n@@ -48,3 +57,3 @@\n-    int32_t i = free_start.idx;\n-    backing_storage.at_grow(i);\n-    BackingElement& be = backing_storage.at(i);\n+    int32_t i = _free_start._idx;\n+    _backing_storage.at_grow(i);\n+    BackingElement& be = _backing_storage.at(i);\n@@ -53,1 +62,1 @@\n-      free_start.idx += 1;\n+      _free_start._idx += 1;\n@@ -56,1 +65,1 @@\n-      free_start = be.link;\n+      _free_start = be.link;\n@@ -59,1 +68,1 @@\n-    return I{i};\n+    return I{i DEBUG_ONLY(COMMA this)};\n@@ -63,3 +72,5 @@\n-    BackingElement& be_freed = backing_storage.at(i.idx);\n-    be_freed.link = free_start;\n-    free_start = i;\n+    assert(i == nil || i._owner == this, \"attempt to free to wrong allocator\");\n+\n+    BackingElement& be_freed = _backing_storage.at(i._idx);\n+    be_freed.link = _free_start;\n+    _free_start = i;\n@@ -70,1 +81,1 @@\n-    return reinterpret_cast<E&>(backing_storage.at(i.idx).e);\n+    return reinterpret_cast<E&>(_backing_storage.at(i._idx).e);\n@@ -75,1 +86,1 @@\n-    return reinterpret_cast<const E&>(backing_storage.at(i.idx).e);\n+    return reinterpret_cast<const E&>(_backing_storage.at(i._idx).e);\n","filename":"src\/hotspot\/share\/nmt\/indexedFreeListAllocator.hpp","additions":30,"deletions":19,"binary":false,"changes":49,"status":"modified"}]}