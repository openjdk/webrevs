{"files":[{"patch":"@@ -4488,7 +4488,21 @@\n-          if (adr_type != new_adr_type && !init->already_has_narrow_mem_proj_with_adr_type(new_adr_type)) {\n-            DEBUG_ONLY( uint alias_idx = _compile->get_alias_index(new_adr_type); )\n-            assert(_compile->get_general_index(alias_idx) == _compile->get_alias_index(adr_type), \"new adr type should be narrowed down from existing adr type\");\n-            NarrowMemProjNode* new_proj = new NarrowMemProjNode(init, new_adr_type);\n-            igvn->set_type(new_proj, new_proj->bottom_type());\n-            record_for_optimizer(new_proj);\n-            set_map(proj, new_proj); \/\/ record it so ConnectionGraph::find_inst_mem() can find it\n+          if (adr_type != new_adr_type) {\n+            if (!init->already_has_narrow_mem_proj_with_adr_type(new_adr_type)) {\n+              DEBUG_ONLY( uint alias_idx = _compile->get_alias_index(new_adr_type); )\n+              assert(_compile->get_general_index(alias_idx) == _compile->get_alias_index(adr_type), \"new adr type should be narrowed down from existing adr type\");\n+              NarrowMemProjNode* new_proj = new NarrowMemProjNode(init, new_adr_type);\n+              igvn->set_type(new_proj, new_proj->bottom_type());\n+              record_for_optimizer(new_proj);\n+              set_map(proj, new_proj); \/\/ record it so ConnectionGraph::find_inst_mem() can find it\n+            } else {\n+              \/\/ A projection with the precise adr_type already exists; still record the mapping.\n+              NarrowMemProjNode* existing_proj = nullptr;\n+              auto find_existing = [&](NarrowMemProjNode* other) {\n+                if (existing_proj == nullptr && other->adr_type() == new_adr_type) {\n+                  existing_proj = other;\n+                }\n+              };\n+              init->for_each_narrow_mem_proj_with_new_uses(find_existing);\n+              if (existing_proj != nullptr) {\n+                set_map(proj, existing_proj);\n+              }\n+            }\n","filename":"src\/hotspot\/share\/opto\/escape.cpp","additions":21,"deletions":7,"binary":false,"changes":28,"status":"modified"}]}