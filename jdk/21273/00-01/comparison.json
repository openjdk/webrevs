{"files":[{"patch":"@@ -380,1 +380,9 @@\n-  assert(HAS_FWD == _heap->has_forwarded_objects(), \"Forwarded object status is sane\");\n+  \/\/ Young cycles are allowed to run when old marking is in progress. When old marking is in progress,\n+  \/\/ this barrier will be called with ENQUEUE=true and HAS_FWD=false, even though the young generation\n+  \/\/ may have forwarded objects. In this case, the `arraycopy_work` is first called with HAS_FWD=true and\n+  \/\/ ENQUEUE=false.\n+  assert(HAS_FWD == _heap->has_forwarded_objects() || (_heap->gc_state() & ShenandoahHeap::OLD_MARKING) != 0,\n+         \"Forwarded object status is sane\");\n+  \/\/ This function cannot be called to handle marking and evacuation at the same time (they operate on\n+  \/\/ different sides of the copy).\n+  assert((HAS_FWD || EVAC) != ENQUEUE, \"Cannot evacuate and mark both sides of copy.\");\n@@ -398,1 +406,0 @@\n-        obj = fwd;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahBarrierSet.inline.hpp","additions":9,"deletions":2,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -30,1 +30,0 @@\n-#include \"gc\/shenandoah\/shenandoahRootProcessor.hpp\"\n@@ -34,1 +33,1 @@\n-ShenandoahEvacuationStats::ShenandoahEvacuationStats(bool generational)\n+ShenandoahEvacuationStats::ShenandoahEvacuationStats()\n@@ -37,1 +36,1 @@\n-    _use_age_table(generational && (ShenandoahGenerationalCensusAtEvac || !ShenandoahGenerationalAdaptiveTenuring)) {\n+    _use_age_table(ShenandoahGenerationalCensusAtEvac || !ShenandoahGenerationalAdaptiveTenuring) {\n@@ -84,0 +83,1 @@\n+#ifndef PRODUCT\n@@ -92,0 +92,1 @@\n+#endif\n@@ -112,7 +113,6 @@\n-  if (_generational) {\n-    AgeTable young_region_ages(false);\n-    for (uint i = 0; i < heap->num_regions(); ++i) {\n-      ShenandoahHeapRegion* r = heap->get_region(i);\n-      if (r->is_young()) {\n-        young_region_ages.add(r->age(), r->get_live_data_words());\n-      }\n+\n+  AgeTable young_region_ages(false);\n+  for (uint i = 0; i < heap->num_regions(); ++i) {\n+    ShenandoahHeapRegion* r = heap->get_region(i);\n+    if (r->is_young()) {\n+      young_region_ages.add(r->age(), r->get_live_data_words());\n@@ -120,3 +120,0 @@\n-    st->print(\"Young regions: \");\n-    young_region_ages.print_on(st);\n-    st->cr();\n@@ -124,0 +121,3 @@\n+  st->print(\"Young regions: \");\n+  young_region_ages.print_on(st);\n+  st->cr();\n@@ -130,1 +130,1 @@\n-  virtual void do_thread(Thread* thread) override {\n+  void do_thread(Thread* thread) override {\n@@ -138,1 +138,1 @@\n-  ShenandoahEvacuationStats mutators(_generational), workers(_generational);\n+  ShenandoahEvacuationStats mutators, workers;\n@@ -150,1 +150,1 @@\n-  if (_generational && (ShenandoahGenerationalCensusAtEvac || !ShenandoahGenerationalAdaptiveTenuring)) {\n+  if (ShenandoahGenerationalCensusAtEvac || !ShenandoahGenerationalAdaptiveTenuring) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahEvacTracker.cpp","additions":16,"deletions":16,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -42,1 +42,1 @@\n-  ShenandoahEvacuationStats(bool generational);\n+  ShenandoahEvacuationStats();\n@@ -62,1 +62,0 @@\n-  bool _generational;\n@@ -68,4 +67,1 @@\n-  ShenandoahEvacuationTracker(bool generational) :\n-   _generational(generational),\n-   _workers_global(generational),\n-   _mutators_global(generational) {}\n+  ShenandoahEvacuationTracker() = default;\n@@ -79,2 +75,2 @@\n-                                   ShenandoahEvacuationStats* workers,\n-                                   ShenandoahEvacuationStats* mutators);\n+                            ShenandoahEvacuationStats* workers,\n+                            ShenandoahEvacuationStats* mutators);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahEvacTracker.hpp","additions":4,"deletions":8,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+#include \"gc\/shenandoah\/shenandoahGenerationalHeap.hpp\"\n@@ -340,1 +341,1 @@\n-void ShenandoahGenerationalControlThread::process_phase_timings(const ShenandoahHeap* heap) {\n+void ShenandoahGenerationalControlThread::process_phase_timings(const ShenandoahGenerationalHeap* heap) {\n@@ -394,3 +395,3 @@\n-void ShenandoahGenerationalControlThread::service_concurrent_normal_cycle(ShenandoahHeap* heap,\n-                                                              const ShenandoahGenerationType generation,\n-                                                              GCCause::Cause cause) {\n+void ShenandoahGenerationalControlThread::service_concurrent_normal_cycle(ShenandoahGenerationalHeap* heap,\n+                                                                          const ShenandoahGenerationType generation,\n+                                                                          GCCause::Cause cause) {\n@@ -424,1 +425,1 @@\n-void ShenandoahGenerationalControlThread::service_concurrent_old_cycle(ShenandoahHeap* heap, GCCause::Cause &cause) {\n+void ShenandoahGenerationalControlThread::service_concurrent_old_cycle(ShenandoahGenerationalHeap* heap, GCCause::Cause &cause) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalControlThread.cpp","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+#include \"gc\/shenandoah\/shenandoahGenerationType.hpp\"\n@@ -32,1 +33,0 @@\n-#include \"gc\/shenandoah\/shenandoahHeap.hpp\"\n@@ -37,0 +37,3 @@\n+class ShenandoahGeneration;\n+class ShenandoahGenerationalHeap;\n+class ShenandoahHeap;\n@@ -104,1 +107,1 @@\n-  void process_phase_timings(const ShenandoahHeap* heap);\n+  void process_phase_timings(const ShenandoahGenerationalHeap* heap);\n@@ -106,1 +109,1 @@\n-  void service_concurrent_normal_cycle(ShenandoahHeap* heap,\n+  void service_concurrent_normal_cycle(ShenandoahGenerationalHeap* heap,\n@@ -110,1 +113,1 @@\n-  void service_concurrent_old_cycle(ShenandoahHeap* heap,\n+  void service_concurrent_old_cycle(ShenandoahGenerationalHeap* heap,\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalControlThread.hpp","additions":7,"deletions":4,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -98,0 +98,1 @@\n+  _evac_tracker(new ShenandoahEvacuationTracker()),\n@@ -117,0 +118,12 @@\n+void ShenandoahGenerationalHeap::print_tracing_info() const {\n+  ShenandoahHeap::print_tracing_info();\n+\n+  LogTarget(Info, gc, stats) lt;\n+  if (lt.is_enabled()) {\n+    LogStream ls(lt);\n+    ls.cr();\n+    ls.cr();\n+    evac_tracker()->print_global_on(&ls);\n+  }\n+}\n+\n@@ -320,1 +333,1 @@\n-  evac_tracker()->begin_evacuation(thread, size * HeapWordSize);\n+  NOT_PRODUCT(evac_tracker()->begin_evacuation(thread, size * HeapWordSize));\n@@ -342,1 +355,1 @@\n-    evac_tracker()->end_evacuation(thread, size * HeapWordSize);\n+    NOT_PRODUCT(evac_tracker()->end_evacuation(thread, size * HeapWordSize));\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalHeap.cpp","additions":15,"deletions":2,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -56,0 +56,2 @@\n+  void print_tracing_info() const override;\n+\n@@ -65,0 +67,2 @@\n+  \/\/ Used primarily to look for failed evacuation attempts.\n+  ShenandoahEvacuationTracker*  _evac_tracker;\n@@ -80,0 +84,4 @@\n+  ShenandoahEvacuationTracker* evac_tracker() const {\n+    return _evac_tracker;\n+  }\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalHeap.hpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -504,1 +504,0 @@\n-  _evac_tracker = new ShenandoahEvacuationTracker(mode()->is_generational());\n@@ -539,1 +538,0 @@\n-  _evac_tracker(nullptr),\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.cpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -512,1 +512,0 @@\n-  ShenandoahEvacuationTracker*  _evac_tracker;\n@@ -537,1 +536,0 @@\n-  ShenandoahEvacuationTracker* evac_tracker()    const { return _evac_tracker;      }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.hpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -49,2 +49,3 @@\n-  bool gen_mode = ShenandoahHeap::heap()->mode()->is_generational();\n-  _evacuation_stats = new ShenandoahEvacuationStats(gen_mode);\n+  if (ShenandoahHeap::heap()->mode()->is_generational()) {\n+    _evacuation_stats = new ShenandoahEvacuationStats();\n+  }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahThreadLocalData.cpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -155,0 +155,1 @@\n+    shenandoah_assert_generational();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahThreadLocalData.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}