{"files":[{"patch":"@@ -62,1 +62,1 @@\n-extern int wcanonicalize(const WCHAR *path, WCHAR *out, int len);\n+extern WCHAR* wcanonicalize(const WCHAR *path, WCHAR *out, int len);\n@@ -277,0 +277,1 @@\n+        WCHAR* fp;\n@@ -280,2 +281,4 @@\n-                if (wcanonicalize(path, cp, len) >= 0) {\n-                    rv = (*env)->NewString(env, cp, (jsize)wcslen(cp));\n+                if ((fp = wcanonicalize(path, cp, len)) != NULL) {\n+                    rv = (*env)->NewString(env, fp, (jsize)wcslen(fp));\n+                    if (fp != cp)\n+                        free(fp);\n@@ -287,2 +290,4 @@\n-        } else if (wcanonicalize(path, canonicalPath, MAX_PATH_LENGTH) >= 0) {\n-            rv = (*env)->NewString(env, canonicalPath, (jsize)wcslen(canonicalPath));\n+        } else if ((fp = wcanonicalize(path, canonicalPath, MAX_PATH_LENGTH)) != NULL) {\n+            rv = (*env)->NewString(env, fp, (jsize)wcslen(canonicalPath));\n+            if (fp != canonicalPath)\n+                free(fp);\n","filename":"src\/java.base\/windows\/native\/libjava\/WinNTFileSystem_md.c","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -151,2 +151,5 @@\n-\/\/ Get the final path of 'path' placing the result in 'finalPath'.\n-\/\/ Zero is returned on success, non-zero on error.\n+\/\/ Return the final path of 'path'. If 'finalPath' is long enough, the final\n+\/\/ path is placed in it. If not, a new character array is allocated for the\n+\/\/ return value. If the return value does not equal the original 'finalPath'\n+\/\/ value, then the calling code might need to free the memory of the\n+\/\/ parameter. Non-NULL is returned on success, NULL on error.\n@@ -154,1 +157,1 @@\n-int getFinalPath(WCHAR* path, WCHAR* finalPath, DWORD size)\n+WCHAR* getFinalPath(WCHAR* path, WCHAR* finalPath, DWORD size)\n@@ -167,0 +170,5 @@\n+        if (len >= size) {\n+            if ((finalPath = (WCHAR*)malloc(len * sizeof(WCHAR))) == NULL)\n+                return NULL;\n+            len = GetFinalPathNameByHandleW(h, finalPath, len, 0);\n+        }\n@@ -168,1 +176,1 @@\n-        if (len > 0 && len <= size) {\n+        if (len != 0) {\n@@ -182,1 +190,1 @@\n-            return 0;\n+            return finalPath;\n@@ -186,1 +194,1 @@\n-    return -1;\n+    return NULL;\n@@ -193,1 +201,1 @@\n-int\n+WCHAR*\n@@ -204,1 +212,1 @@\n-        return -1;\n+        return NULL;\n@@ -208,1 +216,1 @@\n-        return -1;\n+        return NULL;\n@@ -283,1 +291,2 @@\n-                if (getFinalPath(path, result, size) != 0)\n+                WCHAR* fp = NULL;\n+                if ((fp = getFinalPath(path, result, size)) == NULL)\n@@ -286,1 +295,1 @@\n-                return 0;\n+                return fp;\n@@ -313,1 +322,1 @@\n-    return 0;\n+    return result;\n@@ -317,1 +326,1 @@\n-    return -1;\n+    return NULL;\n","filename":"src\/java.base\/windows\/native\/libjava\/canonicalize_md.c","additions":22,"deletions":13,"binary":false,"changes":35,"status":"modified"}]}