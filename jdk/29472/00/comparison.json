{"files":[{"patch":"@@ -363,4 +363,2 @@\n-  if (CDSConfig::is_dumping_heap()) {\n-    assert(Thread::current() == (Thread*)VMThread::vm_thread(), \"should be in vm thread\");\n-  } else {\n-    assert(CDSConfig::is_using_archive(), \"must be\");\n+  if (!CDSConfig::is_using_archive()) {\n+    assert(CDSConfig::is_dumping_heap() && Thread::current() == (Thread*)VMThread::vm_thread(), \"sanity\");\n@@ -468,0 +466,4 @@\n+\n+    if (CDSConfig::is_dumping_final_static_archive()) {\n+      StringTable::move_shared_strings_into_runtime_table();\n+    }\n","filename":"src\/hotspot\/share\/cds\/aotMappedHeapLoader.cpp","additions":6,"deletions":4,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -1107,1 +1107,6 @@\n-    assert(CDSConfig::allow_only_single_java_thread(), \"Required\");\n+    if (!CDSConfig::is_dumping_preimage_static_archive()) {\n+      \/\/ A single thread is required for Reference handling and deterministic CDS archive.\n+      \/\/ Its's not required for dumping preimage, where References won't be archived and\n+      \/\/ determinism is not needed.\n+      assert(CDSConfig::allow_only_single_java_thread(), \"Required\");\n+    }\n","filename":"src\/hotspot\/share\/cds\/aotMetaspace.cpp","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -180,3 +180,0 @@\n-  \/\/ We have a single Java thread. This means java.lang.ref.Reference$ReferenceHandler thread\n-  \/\/ is not running. Otherwise the checks for next\/discovered may not work.\n-  precond(CDSConfig::allow_only_single_java_thread());\n@@ -186,0 +183,8 @@\n+    \/\/ The following check works only if the java.lang.ref.Reference$ReferenceHandler thread\n+    \/\/ is not running.\n+    \/\/\n+    \/\/ This code is called on every object found by AOTArtifactFinder. When dumping the\n+    \/\/ preimage archive, AOTArtifactFinder should not find any Reference objects.\n+    precond(!CDSConfig::is_dumping_preimage_static_archive());\n+    precond(CDSConfig::allow_only_single_java_thread());\n+\n","filename":"src\/hotspot\/share\/cds\/aotReferenceObjSupport.cpp","additions":9,"deletions":4,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -559,1 +559,3 @@\n-  disable_heap_dumping();\n+  _is_using_optimized_module_handling = false;\n+  _is_using_full_module_graph = false;\n+  _is_dumping_full_module_graph = false;\n@@ -585,0 +587,1 @@\n+  _is_using_full_module_graph = false;\n@@ -957,1 +960,3 @@\n-  if (!(is_dumping_classic_static_archive() || is_dumping_final_static_archive())\n+  \/\/ Note: when dumping preimage static archive, only a very limited set of oops\n+  \/\/ are dumped.\n+  if (!is_dumping_static_archive()\n@@ -969,0 +974,20 @@\n+bool CDSConfig::is_dumping_klass_subgraphs() {\n+  if (is_dumping_classic_static_archive() || is_dumping_final_static_archive()) {\n+    \/\/ KlassSubGraphs (see heapShared.cpp) is a legacy mechanism for archiving oops. It\n+    \/\/ has been superceded by AOT class linking. This feature is used only when\n+    \/\/ AOT class linking is disabled.\n+    \/\/\n+    \/\/ KlassSubGraphs are disabled in the preimage static archive, which contains a very\n+    \/\/ limited set of oops.\n+    return is_dumping_heap() && !is_dumping_aot_linked_classes();\n+  } else {\n+    return false;\n+  }\n+}\n+\n+bool CDSConfig::is_using_klass_subgraphs() {\n+  return (is_loading_heap() &&\n+          !CDSConfig::is_using_aot_linked_classes() &&\n+          !CDSConfig::is_dumping_final_static_archive());\n+}\n+\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.cpp","additions":28,"deletions":3,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -191,0 +191,3 @@\n+  static bool is_dumping_klass_subgraphs()                   NOT_CDS_JAVA_HEAP_RETURN_(false);\n+  static bool is_using_klass_subgraphs()                     NOT_CDS_JAVA_HEAP_RETURN_(false);\n+\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.hpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -213,1 +213,1 @@\n-  if (!CDSConfig::is_dumping_aot_linked_classes()) {\n+  if (CDSConfig::is_dumping_klass_subgraphs()) {\n@@ -458,1 +458,0 @@\n-  assert(!CDSConfig::is_dumping_heap() && CDSConfig::is_using_archive(), \"runtime only\");\n@@ -937,1 +936,1 @@\n-  if (!CDSConfig::is_dumping_aot_linked_classes()) {\n+  if (CDSConfig::is_dumping_klass_subgraphs()) {\n@@ -1295,4 +1294,1 @@\n-  if (!is_archived_heap_in_use()) {\n-    return; \/\/ nothing to do\n-  }\n-  if (!CDSConfig::is_using_aot_linked_classes()) {\n+  if (CDSConfig::is_using_klass_subgraphs()) {\n@@ -1388,1 +1384,1 @@\n-  if (!is_archived_heap_in_use()) {\n+  if (!CDSConfig::is_using_klass_subgraphs()) {\n@@ -1864,1 +1860,1 @@\n-  assert(CDSConfig::is_dumping_heap(), \"dump time only\");\n+  precond(CDSConfig::is_dumping_klass_subgraphs());\n@@ -1915,1 +1911,1 @@\n-  assert(CDSConfig::is_dumping_heap(), \"dump time only\");\n+  precond(CDSConfig::is_dumping_klass_subgraphs());\n@@ -2141,1 +2137,1 @@\n-  if (!CDSConfig::is_dumping_aot_linked_classes()) {\n+  if (CDSConfig::is_dumping_klass_subgraphs()) {\n","filename":"src\/hotspot\/share\/cds\/heapShared.cpp","additions":7,"deletions":11,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -1266,0 +1266,4 @@\n+  if (CDSConfig::is_dumping_heap()) {\n+    create_scratch_mirror(k, CHECK_(false));\n+  }\n+\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -990,0 +990,22 @@\n+\n+void StringTable::move_shared_strings_into_runtime_table() {\n+  precond(CDSConfig::is_dumping_final_static_archive());\n+  JavaThread* THREAD = JavaThread::current();\n+  HandleMark hm(THREAD);\n+\n+  int n = 0;\n+  _shared_table.iterate_all([&](oop string) {\n+    int length = java_lang_String::length(string);\n+    Handle h_string (THREAD, string);\n+    StringWrapper name(h_string, length);\n+    unsigned int hash = hash_wrapped_string(name);\n+\n+    assert(!_alt_hash, \"too early\");\n+    oop interned = do_intern(name, hash, THREAD);\n+    assert(string == interned, \"must be\");\n+    n++;\n+  });\n+\n+  _shared_table.reset();\n+  log_info(aot)(\"Moved %d interned strings to runtime table\", n);\n+}\n","filename":"src\/hotspot\/share\/classfile\/stringTable.cpp","additions":22,"deletions":0,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -122,0 +122,1 @@\n+  static void move_shared_strings_into_runtime_table();\n","filename":"src\/hotspot\/share\/classfile\/stringTable.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -139,0 +139,1 @@\n+    static URLClassLoader loader; \/\/ keep Hello class alive\n@@ -147,1 +148,1 @@\n-        URLClassLoader loader = new URLClassLoader(urls, AOTMapTestApp.class.getClassLoader());\n+        loader = new URLClassLoader(urls, AOTMapTestApp.class.getClassLoader());\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/aotCache\/AOTMapTest.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"}]}