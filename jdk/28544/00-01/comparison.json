{"files":[{"patch":"@@ -0,0 +1,38 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * @test\n+ * @summary  Test verify that object allocation sampling is disabled during AOT.\n+ *\n+ * Don't remove 'modules' line, it triggers the crash.\n+ * @modules java.management\n+ *\n+ * @run main\/othervm\/native -agentlib:SamplingDuringInit -XX:-UseCompressedOops SamplingDuringInit\n+ *\/\n+\n+public class SamplingDuringInit {\n+\n+    public static void main(String[] args) throws Exception {\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/events\/SampledObjectAlloc\/SamplingDuringInit\/SamplingDuringInit.java","additions":38,"deletions":0,"binary":false,"changes":38,"status":"added"},{"patch":"@@ -0,0 +1,82 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#include \"jvmti.h\"\n+#include \"jvmti_common.hpp\"\n+\n+\n+extern \"C\" {\n+\n+JNIEXPORT void JNICALL\n+SampledObjectAlloc(jvmtiEnv *jvmti, JNIEnv* jni, jthread thread, jobject object, jclass object_klass, jlong size) {\n+  LOG(\"Sampled object\\n\");\n+}\n+\n+\n+jint Agent_Initialize(JavaVM *jvm, char *options, void *reserved) {\n+  jvmtiEnv* jvmti = nullptr;\n+  jvmtiCapabilities caps;\n+  jvmtiEventCallbacks callbacks;\n+  jvmtiError err;\n+  jint res;\n+\n+  LOG(\"AGENT INIT\");\n+  res = jvm->GetEnv((void **) &jvmti, JVMTI_VERSION_9);\n+  if (res != JNI_OK || jvmti == nullptr) {\n+    LOG(\"Wrong result of a valid call to GetEnv!\\n\");\n+    return JNI_ERR;\n+  }\n+\n+\n+  memset(&caps, 0, sizeof(caps));\n+  caps.can_generate_sampled_object_alloc_events = 1;\n+  if (jvmti->AddCapabilities(&caps) != JVMTI_ERROR_NONE) {\n+    return JNI_ERR;\n+  }\n+\n+  memset(&callbacks, 0, sizeof(callbacks));\n+  callbacks.SampledObjectAlloc = &SampledObjectAlloc;\n+\n+  err = jvmti->SetEventCallbacks(&callbacks, sizeof(callbacks));\n+  check_jvmti_error(err, \"SetEventCallbacks\");\n+  \/*\n+   * Interval should be small enough to triggger sampling event while objects are init by VM.\n+   *\/\n+  err = jvmti->SetHeapSamplingInterval(10);\n+  check_jvmti_error(err, \"SetHeapSamplingInterval\");\n+\n+\n+  err = jvmti->SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_SAMPLED_OBJECT_ALLOC, nullptr);\n+  check_jvmti_error(err, \"SetEventNotificationMode\");\n+\n+  return JNI_OK;\n+}\n+\n+JNIEXPORT jint JNICALL Agent_OnLoad(JavaVM *jvm, char *options, void *reserved) {\n+  return Agent_Initialize(jvm, options, reserved);\n+}\n+\n+JNIEXPORT jint JNICALL Agent_OnAttach(JavaVM *jvm, char *options, void *reserved) {\n+  return Agent_Initialize(jvm, options, reserved);\n+}\n+}\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/events\/SampledObjectAlloc\/SamplingDuringInit\/libSamplingDuringInit.cpp","additions":82,"deletions":0,"binary":false,"changes":82,"status":"added"}]}