{"files":[{"patch":"@@ -187,0 +187,1 @@\n+  NoJvmtiEventsMark njem;\n","filename":"src\/hotspot\/share\/cds\/aotStreamedHeapLoader.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -3162,6 +3162,1 @@\n-\/\/ Disable collection of VMObjectAlloc events\n-NoJvmtiVMObjectAllocMark::NoJvmtiVMObjectAllocMark() : _collector(nullptr) {\n-  \/\/ a no-op if VMObjectAlloc event is not enabled\n-  if (!JvmtiExport::should_post_vm_object_alloc()) {\n-    return;\n-  }\n+NoJvmtiEventsMark::NoJvmtiEventsMark() {\n@@ -3171,9 +3166,1 @@\n-    JvmtiThreadState *state = current_thread->jvmti_thread_state();\n-    if (state != nullptr) {\n-      JvmtiVMObjectAllocEventCollector *collector;\n-      collector = state->get_vm_object_alloc_event_collector();\n-      if (collector != nullptr && collector->is_enabled()) {\n-        _collector = collector;\n-        _collector->set_enabled(false);\n-      }\n-    }\n+    current_thread->disable_jvmti_events();\n@@ -3183,4 +3170,5 @@\n-\/\/ Re-Enable collection of VMObjectAlloc events (if previously enabled)\n-NoJvmtiVMObjectAllocMark::~NoJvmtiVMObjectAllocMark() {\n-  if (was_enabled()) {\n-    _collector->set_enabled(true);\n+NoJvmtiEventsMark::~NoJvmtiEventsMark() {\n+  Thread* thread = Thread::current_or_null();\n+  if (thread != nullptr && thread->is_Java_thread())  {\n+    JavaThread* current_thread = JavaThread::cast(thread);\n+    current_thread->enable_jvmti_events();\n","filename":"src\/hotspot\/share\/prims\/jvmtiExport.cpp","additions":7,"deletions":19,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -588,19 +588,2 @@\n-\/\/ Marker class to disable the posting of VMObjectAlloc events\n-\/\/ within its scope.\n-\/\/\n-\/\/ Usage :-\n-\/\/\n-\/\/ {\n-\/\/   NoJvmtiVMObjectAllocMark njm;\n-\/\/   :\n-\/\/   \/\/ VMObjAlloc event will not be posted\n-\/\/   JvmtiExport::vm_object_alloc_event_collector(obj);\n-\/\/   :\n-\/\/ }\n-\n-class NoJvmtiVMObjectAllocMark : public StackObj {\n- private:\n-  \/\/ enclosing collector if enabled, null otherwise\n-  JvmtiVMObjectAllocEventCollector *_collector;\n-\n-  bool was_enabled()    { return _collector != nullptr; }\n+\/\/ Marker class to temporary disable posting of jvmti events.\n+class NoJvmtiEventsMark : public StackObj {\n@@ -609,2 +592,2 @@\n-  NoJvmtiVMObjectAllocMark() NOT_JVMTI_RETURN;\n-  ~NoJvmtiVMObjectAllocMark() NOT_JVMTI_RETURN;\n+  NoJvmtiEventsMark() NOT_JVMTI_RETURN;\n+  ~NoJvmtiEventsMark() NOT_JVMTI_RETURN;\n","filename":"src\/hotspot\/share\/prims\/jvmtiExport.hpp","additions":4,"deletions":21,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -454,0 +454,1 @@\n+  _jvmti_events_disabled(false),\n","filename":"src\/hotspot\/share\/runtime\/javaThread.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -328,0 +328,1 @@\n+  bool                  _jvmti_events_disabled;          \/\/ JVMTI events disabled manually\n@@ -756,0 +757,3 @@\n+  void disable_jvmti_events()           { _jvmti_events_disabled = true; };\n+  void enable_jvmti_events()            { _jvmti_events_disabled = false; };\n+\n@@ -763,1 +767,2 @@\n-  bool should_hide_jvmti_events() const          { return _is_in_VTMS_transition || _is_disable_suspend || _is_in_java_upcall; }\n+  bool should_hide_jvmti_events() const          { return _is_in_VTMS_transition || _is_disable_suspend\n+    || _is_in_java_upcall || _jvmti_events_disabled; }\n","filename":"src\/hotspot\/share\/runtime\/javaThread.hpp","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"}]}