{"files":[{"patch":"@@ -52,0 +52,1 @@\n+import java.util.concurrent.atomic.AtomicReference;\n@@ -430,1 +431,2 @@\n-     * set test class. Scenarios are run in parallel.\n+     * set test class. Scenarios are run in parallel. Note: scenarios could still be run sequentially if flag\n+     *  {@code -DForceSequentialScenarios=true} is given.\n@@ -433,1 +435,1 @@\n-        start(true);\n+        start(!FORCE_SEQUENTIAL_SCENARIOS);\n@@ -456,1 +458,1 @@\n-            startWithScenarios(!FORCE_SEQUENTIAL_SCENARIOS && parallel);\n+            startWithScenarios(parallel);\n@@ -750,1 +752,1 @@\n-        record Outcome(Scenario scenario, TestFormatException tfe, Exception other) {}\n+        record Outcome(Scenario scenario, Exception other) {}\n@@ -752,1 +754,1 @@\n-\n+        AtomicReference<TestFormatException> testFormatException = new AtomicReference<>();\n@@ -755,1 +757,3 @@\n-            Outcome outcome;\n+            if (testFormatException.get() != null) {\n+                return null;\n+            }\n@@ -760,1 +764,0 @@\n-                outcome = new Outcome(scenario, null, null);\n@@ -762,1 +765,1 @@\n-                outcome = new Outcome(scenario, e, null);\n+                testFormatException.compareAndSet(null, e);\n@@ -764,1 +767,1 @@\n-                outcome = new Outcome(scenario, null, e);\n+                return new Outcome(scenario, e);\n@@ -774,1 +777,1 @@\n-            return outcome;\n+            return null;\n@@ -776,7 +779,4 @@\n-        \/\/ Rethrow first TestFormatException\n-        Optional<TestFormatException> tfe = outcomes.stream()\n-                .map(Outcome::tfe)\n-                .filter(Objects::nonNull)\n-                .findFirst();\n-        if (tfe.isPresent()) {\n-            throw tfe.get();\n+        \/\/ Rethrow TestFormatException if it occurred\n+        TestFormatException tfe = testFormatException.get();\n+        if (tfe != null) {\n+            throw tfe;\n@@ -784,0 +784,1 @@\n+\n@@ -786,1 +787,1 @@\n-                .filter(o -> o.other() != null)\n+                .filter(o -> o != null && o.other() != null)\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/TestFramework.java","additions":19,"deletions":18,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,1 +33,1 @@\n-    private static final List<String> FAILURES = new ArrayList<>();\n+    private static final ThreadLocal<List<String>> threadLocalFailures = ThreadLocal.withInitial(ArrayList<String>::new);\n@@ -37,1 +37,1 @@\n-            FAILURES.add(failureMessage);\n+            threadLocalFailures.get().add(failureMessage);\n@@ -61,1 +61,1 @@\n-        FAILURES.add(failureMessage);\n+        threadLocalFailures.get().add(failureMessage);\n@@ -66,1 +66,1 @@\n-        FAILURES.add(failureMessage);\n+        threadLocalFailures.get().add(failureMessage);\n@@ -70,1 +70,1 @@\n-        if (FAILURES.isEmpty()) {\n+        if (threadLocalFailures.get().isEmpty()) {\n@@ -77,2 +77,2 @@\n-        builder.append(\"Violations (\").append(FAILURES.size()).append(\")\").append(System.lineSeparator());\n-        builder.append(\"-------------\").append(\"-\".repeat(String.valueOf(FAILURES.size()).length()))\n+        builder.append(\"Violations (\").append(threadLocalFailures.get().size()).append(\")\").append(System.lineSeparator());\n+        builder.append(\"-------------\").append(\"-\".repeat(String.valueOf(threadLocalFailures.get().size()).length()))\n@@ -80,1 +80,1 @@\n-        for (String failure : FAILURES) {\n+        for (String failure : threadLocalFailures.get()) {\n@@ -84,1 +84,1 @@\n-        FAILURES.clear();\n+        threadLocalFailures.get().clear();\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/shared\/TestFormat.java","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -127,0 +127,2 @@\n+        \/\/ Single test\n+        boolean exceptionCatched = false;\n@@ -135,1 +137,1 @@\n-            return;\n+            exceptionCatched = true;\n@@ -137,1 +139,17 @@\n-        throw new RuntimeException(\"Should catch an exception\");\n+        Asserts.assertTrue(exceptionCatched, \"Should catch an exception\");\\\n+\n+        \/\/ Parallel scenarios\n+        exceptionCatched = false;\n+        try {\n+            if (helpers == null) {\n+                new TestFramework(clazz).addScenarios(new Scenario(1), new Scenario(2), new Scenario(3))\n+                                        .startParallel();\n+            } else {\n+                new TestFramework(clazz).addScenarios(new Scenario(1), new Scenario(2), new Scenario(3))\n+                                        .addHelperClasses(helpers).startParallel();\n+            }\n+        } catch (Exception e) {\n+            checkException(clazz, e, helpers);\n+            exceptionCatched = true;\n+        }\n+        Asserts.assertTrue(exceptionCatched, \"Should catch an exception\");\n","filename":"test\/hotspot\/jtreg\/testlibrary_tests\/ir_framework\/tests\/TestBadFormat.java","additions":21,"deletions":3,"binary":false,"changes":24,"status":"modified"}]}