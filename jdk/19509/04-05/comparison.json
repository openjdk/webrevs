{"files":[{"patch":"@@ -1610,0 +1610,3 @@\n+  \/\/ NOTE: PLEASE DON'T USE IT NAKED UNTIL WE DROP SUPPORT FOR MACHINES OLDER THAN Z15!!!!\n+  inline void z_popcnt(Register r1, Register r2, int64_t m3);   \/\/ population count\n+\n@@ -3095,1 +3098,0 @@\n-  inline void z_popcnt(Register r1, Register r2, int64_t m3);   \/\/ population count\n","filename":"src\/hotspot\/cpu\/s390\/assembler_s390.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -5810,0 +5810,3 @@\n+  assert(r_tmp != noreg, \"temp register required for pop_count_int, as code may run on machine older than z15\");\n+  assert_different_registers(r_dst, r_tmp); \/\/ if r_src is same as r_tmp, it should be fine\n+\n@@ -5811,2 +5814,1 @@\n-    z_llgfr(r_dst, r_src);\n-    z_popcnt(r_dst, r_dst, 8);\n+    pop_count_int_post_z15(r_dst, r_src);\n@@ -5814,11 +5816,1 @@\n-\n-    assert(r_tmp != noreg, \"temp register required for popcnt, for machines < z15\");\n-    assert_different_registers(r_dst, r_tmp); \/\/ if r_src is same as r_tmp, it should be fine\n-\n-    z_popcnt(r_dst, r_src, 0);\n-    z_srlg(r_tmp, r_dst, 16);\n-    z_alr(r_dst, r_tmp);\n-    z_srlg(r_tmp, r_dst, 8);\n-    z_alr(r_dst, r_tmp);\n-    \/\/ TODO: use risbgn instruction instead of srl below\n-    z_llgcr(r_dst, r_dst);\n+    pop_count_int_pre_z15(r_dst, r_src, r_tmp);\n@@ -5833,0 +5825,3 @@\n+  assert(r_tmp != noreg, \"temp register required for pop_count_long, as code may run on machine older than z15\");\n+  assert_different_registers(r_dst, r_tmp); \/\/ if r_src is same as r_tmp, it should be fine\n+\n@@ -5834,1 +5829,1 @@\n-    z_popcnt(r_dst, r_src, 8);\n+    pop_count_long_post_z15(r_dst, r_src);\n@@ -5836,0 +5831,28 @@\n+    pop_count_long_pre_z15(r_dst, r_src, r_tmp);\n+  }\n+\n+  BLOCK_COMMENT(\"} pop_count_long\");\n+}\n+\n+void MacroAssembler::pop_count_int_pre_z15(Register r_dst, Register r_src, Register r_tmp) {\n+  BLOCK_COMMENT(\"pop_count_int_pre_z15 {\");\n+\n+  assert(r_tmp != noreg, \"temp register required for popcnt, for machines < z15\");\n+  assert_different_registers(r_dst, r_tmp); \/\/ if r_src is same as r_tmp, it should be fine\n+\n+  z_popcnt(r_dst, r_src, 0);\n+  z_srlg(r_tmp, r_dst, 16);\n+  z_alr(r_dst, r_tmp);\n+  z_srlg(r_tmp, r_dst, 8);\n+  z_alr(r_dst, r_tmp);\n+  \/\/ TODO: use risbgn instruction instead of srl below\n+  z_llgcr(r_dst, r_dst);\n+\n+  BLOCK_COMMENT(\"} pop_count_int_pre_z15\");\n+}\n+\n+void MacroAssembler::pop_count_long_pre_z15(Register r_dst, Register r_src, Register r_tmp) {\n+  BLOCK_COMMENT(\"pop_count_long_pre_z15 {\");\n+\n+  assert(r_tmp != noreg, \"temp register required for popcnt, for machines < z15\");\n+  assert_different_registers(r_dst, r_tmp); \/\/ if r_src is same as r_tmp, it should be fine\n@@ -5837,2 +5860,7 @@\n-    assert(r_tmp != noreg, \"temp register required for popcnt, for machines < z15\");\n-    assert_different_registers(r_dst, r_tmp); \/\/ if r_src is same as r_tmp, it should be fine\n+  z_popcnt(r_dst, r_src, 0);\n+  z_ahhlr(r_dst, r_dst, r_dst);\n+  z_sllg(r_tmp, r_dst, 16);\n+  z_algr(r_dst, r_tmp);\n+  z_sllg(r_tmp, r_dst, 8);\n+  z_algr(r_dst, r_tmp);\n+  z_srlg(r_dst, r_dst, 56);\n@@ -5840,7 +5868,10 @@\n-    z_popcnt(r_dst, r_src, 0);\n-    z_ahhlr(r_dst, r_dst, r_dst);\n-    z_sllg(r_tmp, r_dst, 16);\n-    z_algr(r_dst, r_tmp);\n-    z_sllg(r_tmp, r_dst, 8);\n-    z_algr(r_dst, r_tmp);\n-    z_srlg(r_dst, r_dst, 56);\n+  BLOCK_COMMENT(\"} pop_count_long_pre_z15\");\n+}\n+\n+void MacroAssembler::pop_count_long_post_z15(Register r_dst, Register r_src) {\n+  BLOCK_COMMENT(\"pop_count_long_post_z15 {\");\n+\n+  if (VM_Version::has_MiscInstrExt3()) {\n+    z_popcnt(r_dst, r_dst, 8);\n+  } else {\n+    stop(\"this hardware doesn't support miscellaneous-instruction-extensions facility 3, still pop_count_long_post_z15 is used\");\n@@ -5849,1 +5880,14 @@\n-  BLOCK_COMMENT(\"} pop_count_long\");\n+  BLOCK_COMMENT(\"} pop_count_long_post_z15\");\n+}\n+\n+void MacroAssembler::pop_count_int_post_z15(Register r_dst, Register r_src) {\n+  BLOCK_COMMENT(\"pop_count_int_post_z15 {\");\n+\n+  if (VM_Version::has_MiscInstrExt3()) {\n+    z_llgfr(r_dst, r_src);\n+    z_popcnt(r_dst, r_dst, 8);\n+  } else {\n+    stop(\"this hardware doesn't support miscellaneous-instruction-extensions facility 3, still pop_count_int_post_z15 is used\");\n+  }\n+\n+  BLOCK_COMMENT(\"} pop_count_int_post_z15\");\n","filename":"src\/hotspot\/cpu\/s390\/macroAssembler_s390.cpp","additions":68,"deletions":24,"binary":false,"changes":92,"status":"modified"},{"patch":"@@ -1026,2 +1026,14 @@\n-  void pop_count_int(Register dst, Register src, Register tmp = noreg);\n-  void pop_count_long(Register dst, Register src, Register tmp = noreg);\n+  \/\/ if you're unsure whether your instruction will run on older hardware or newer hardware than Z15\n+  \/\/ then please use these instruction to avoid the compatibility issues\n+  void pop_count_int(Register dst, Register src, Register tmp);\n+  void pop_count_long(Register dst, Register src, Register tmp);\n+\n+  \/\/ Up for an adventure ? use these instructions :)\n+  \/\/ Should be only used when you're sure that instruction will \"only\" run on hardware older than z15\n+  void pop_count_int_pre_z15(Register dst, Register src, Register tmp);\n+  void pop_count_long_pre_z15(Register dst, Register src, Register tmp);\n+\n+  \/\/ Should be used in a case, where you're sure that instruction will never touch a hardware older than z15\n+  \/\/ it will only run on either a z15 machine or successor of it\n+  void pop_count_int_post_z15(Register dst, Register src);\n+  void pop_count_long_post_z15(Register dst, Register src);\n","filename":"src\/hotspot\/cpu\/s390\/macroAssembler_s390.hpp","additions":14,"deletions":2,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -10691,1 +10691,1 @@\n-    __ pop_count_int(Rdst, Rsrc);\n+    __ pop_count_int_post_z15(Rdst, Rsrc);\n@@ -10710,1 +10710,1 @@\n-    __ pop_count_long(Rdst, Rsrc);\n+    __ pop_count_long_post_z15(Rdst, Rsrc);\n@@ -10729,1 +10729,1 @@\n-    __ pop_count_int(Rdst, Rsrc, Rtmp);\n+    __ pop_count_int_pre_z15(Rdst, Rsrc, Rtmp);\n@@ -10749,1 +10749,1 @@\n-    __ pop_count_long(Rdst, Rsrc, Rtmp);\n+    __ pop_count_long_pre_z15(Rdst, Rsrc, Rtmp);\n","filename":"src\/hotspot\/cpu\/s390\/s390.ad","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"}]}