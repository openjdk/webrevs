{"files":[{"patch":"@@ -80,12 +80,0 @@\n-class ShenandoahUpdateRefsClosure: public ShenandoahOopClosureBase {\n-private:\n-  ShenandoahHeap* _heap;\n-public:\n-  inline ShenandoahUpdateRefsClosure();\n-  inline void do_oop(oop* p);\n-  inline void do_oop(narrowOop* p);\n-private:\n-  template <class T>\n-  inline void do_oop_work(T* p);\n-};\n-\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahClosures.hpp","additions":0,"deletions":12,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -100,12 +100,0 @@\n-ShenandoahUpdateRefsClosure::ShenandoahUpdateRefsClosure() :\n-  _heap(ShenandoahHeap::heap()) {\n-}\n-\n-template <class T>\n-void ShenandoahUpdateRefsClosure::do_oop_work(T* p) {\n-  _heap->update_with_forwarded(p);\n-}\n-\n-void ShenandoahUpdateRefsClosure::do_oop(oop* p)       { do_oop_work(p); }\n-void ShenandoahUpdateRefsClosure::do_oop(narrowOop* p) { do_oop_work(p); }\n-\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahClosures.inline.hpp","additions":0,"deletions":12,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -934,1 +934,6 @@\n-  ShenandoahUpdateRefsClosure _cl;\n+  \/\/ This closure runs when thread is stopped for handshake, which means\n+  \/\/ we can technically use STW closure here, as long as it only updates\n+  \/\/ locations modified by the thread itself, i.e. stack locations.\n+  \/\/ For extra safety, and to avoid future accidents when\/if that condition\n+  \/\/ would not hold true, we use concurrent closure instead.\n+  ShenandoahConcUpdateRefsClosure _cl;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahConcurrentGC.cpp","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+#include \"gc\/shenandoah\/shenandoahOopClosures.inline.hpp\"\n@@ -69,1 +70,1 @@\n-    ShenandoahUpdateRefsClosure cl;\n+    ShenandoahSTWUpdateRefsClosure cl;\n@@ -72,1 +73,1 @@\n-      _root_updater->roots_do<ShenandoahForwardedIsAliveClosure, ShenandoahUpdateRefsClosure>(worker_id, &is_alive, &cl);\n+      _root_updater->roots_do<ShenandoahForwardedIsAliveClosure, ShenandoahSTWUpdateRefsClosure>(worker_id, &is_alive, &cl);\n@@ -74,2 +75,2 @@\n-      AlwaysTrueClosure always_true;;\n-      _root_updater->roots_do<AlwaysTrueClosure, ShenandoahUpdateRefsClosure>(worker_id, &always_true, &cl);\n+      AlwaysTrueClosure always_true;\n+      _root_updater->roots_do<AlwaysTrueClosure, ShenandoahSTWUpdateRefsClosure>(worker_id, &always_true, &cl);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGC.cpp","additions":5,"deletions":4,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2015,2 +2015,2 @@\n-    ShenandoahUpdateRefsClosure keep_alive;\n-    ShenandoahParallelWeakRootsCleaningTask<ShenandoahForwardedIsAliveClosure, ShenandoahUpdateRefsClosure>\n+    ShenandoahSTWUpdateRefsClosure keep_alive;\n+    ShenandoahParallelWeakRootsCleaningTask<ShenandoahForwardedIsAliveClosure, ShenandoahSTWUpdateRefsClosure>\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}