{"files":[{"patch":"@@ -53,1 +53,1 @@\n-            Thread zero = TestScaffold.newThread (() -> {\n+            Thread zero = DebuggeeWrapper.newThread (() -> {\n@@ -58,1 +58,1 @@\n-            Thread one = TestScaffold.newThread (() -> {\n+            Thread one = DebuggeeWrapper.newThread (() -> {\n@@ -67,1 +67,1 @@\n-            Thread two = TestScaffold.newThread (() -> {\n+            Thread two = DebuggeeWrapper.newThread (() -> {\n","filename":"test\/jdk\/com\/sun\/jdi\/ClassesByName2Test.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -0,0 +1,124 @@\n+\/*\n+ * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.util.concurrent.ThreadFactory;\n+\n+public class DebuggeeWrapper {\n+\n+    public static String PROPERTY_NAME = \"main.wrapper\";\n+\n+    private static final String OLD_MAIN_THREAD_NAME = \"old-m-a-i-n\";\n+\n+    private static ThreadFactory threadFactory = r -> new Thread(r);\n+\n+    private static final String wrapperName = System.getProperty(PROPERTY_NAME);\n+\n+    public static String getWrapperName() {\n+        return wrapperName;\n+    }\n+\n+    public static boolean isVirtual() {\n+        return \"Virtual\".equals(wrapperName);\n+    }\n+\n+    public static Thread newThread(Runnable task) {\n+        return threadFactory.newThread(task);\n+    }\n+\n+    public static Thread newThread(Runnable task, String name) {\n+        Thread t = newThread(task);\n+        t.setName(name);\n+        return t;\n+    }\n+\n+    public static void main(String[] args) throws Throwable {\n+        String wrapper = args[0];\n+        String className = args[1];\n+        String[] classArgs = new String[args.length - 2];\n+        System.arraycopy(args, 2, classArgs, 0, args.length - 2);\n+        Class c = Class.forName(className);\n+        java.lang.reflect.Method mainMethod = c.getMethod(\"main\", new Class[] { String[].class });\n+        mainMethod.setAccessible(true);\n+\n+        if (wrapper.equals(\"Virtual\")) {\n+            threadFactory = Thread.ofVirtual().factory();\n+            MainThreadGroup tg = new MainThreadGroup();\n+            Thread vthread = Thread.ofVirtual().unstarted(() -> {\n+                try {\n+                    mainMethod.invoke(null, new Object[] { classArgs });\n+                } catch (InvocationTargetException e) {\n+                    tg.uncaughtThrowable = e.getCause();\n+                } catch (Throwable error) {\n+                    tg.uncaughtThrowable = error;\n+                }\n+            });\n+            Thread.currentThread().setName(OLD_MAIN_THREAD_NAME);\n+            vthread.setName(\"main\");\n+            vthread.start();\n+            vthread.join();\n+            if (tg.uncaughtThrowable != null) {\n+                \/\/ Note we cant just rethrow tg.uncaughtThrowable because there are tests\n+                \/\/ that track ExceptionEvents, and they will complain about the extra\n+                \/\/ exception. So instead mimic what happens when the main thread exits\n+                \/\/ with an exception.\n+                System.out.println(\"Uncaught Exception: \" + tg.uncaughtThrowable);\n+                tg.uncaughtThrowable.printStackTrace(System.out);\n+                System.exit(1);\n+            }\n+        } else if (wrapper.equals(\"Kernel\")) {\n+            MainThreadGroup tg = new MainThreadGroup();\n+            Thread t = new Thread(tg, () -> {\n+                try {\n+                    mainMethod.invoke(null, new Object[] { classArgs });\n+                } catch (InvocationTargetException e) {\n+                    tg.uncaughtThrowable = e.getCause();\n+                } catch (Throwable error) {\n+                    tg.uncaughtThrowable = error;\n+                }\n+            });\n+            t.start();\n+            t.join();\n+            if (tg.uncaughtThrowable != null) {\n+                throw new RuntimeException(tg.uncaughtThrowable);\n+            }\n+        } else {\n+            mainMethod.invoke(null, new Object[] { classArgs });\n+        }\n+    }\n+\n+    static class MainThreadGroup extends ThreadGroup {\n+        MainThreadGroup() {\n+            super(\"MainThreadGroup\");\n+        }\n+\n+        public void uncaughtException(Thread t, Throwable e) {\n+            if (e instanceof ThreadDeath) {\n+                return;\n+            }\n+            e.printStackTrace(System.err);\n+            uncaughtThrowable = e;\n+        }\n+        Throwable uncaughtThrowable = null;\n+    }\n+}\n\\ No newline at end of file\n","filename":"test\/jdk\/com\/sun\/jdi\/DebuggeeWrapper.java","additions":124,"deletions":0,"binary":false,"changes":124,"status":"added"},{"patch":"@@ -77,2 +77,2 @@\n-        Thread thread1 = TestScaffold.newThread(obj1, \"jj1\");\n-        Thread thread2 = TestScaffold.newThread(obj2, \"jj2\");\n+        Thread thread1 = DebuggeeWrapper.newThread(obj1, \"jj1\");\n+        Thread thread2 = DebuggeeWrapper.newThread(obj2, \"jj2\");\n","filename":"test\/jdk\/com\/sun\/jdi\/DeferredStepTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -846,1 +846,1 @@\n-            inflatorThread = TestScaffold.newThread(() -> {\n+            inflatorThread = DebuggeeWrapper.newThread(() -> {\n","filename":"test\/jdk\/com\/sun\/jdi\/EATests.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -172,1 +172,1 @@\n-        boolean is_vthread_mode = \"Virtual\".equals(System.getProperty(\"main.wrapper\"));\n+        boolean is_vthread_mode = DebuggeeWrapper.isVirtual();\n","filename":"test\/jdk\/com\/sun\/jdi\/ForceEarlyReturnTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -50,1 +50,1 @@\n-        Thread interruptorThread = TestScaffold.newThread(new Interruptor(Thread.currentThread()));\n+        Thread interruptorThread = DebuggeeWrapper.newThread(new Interruptor(Thread.currentThread()));\n","filename":"test\/jdk\/com\/sun\/jdi\/InterruptHangTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -57,2 +57,2 @@\n-        Thread t1 = TestScaffold.newThread(new InvokeHangTarg(), name1);\n-        Thread t2 = TestScaffold.newThread(new InvokeHangTarg(), name2);\n+        Thread t1 = DebuggeeWrapper.newThread(new InvokeHangTarg(), name1);\n+        Thread t2 = DebuggeeWrapper.newThread(new InvokeHangTarg(), name2);\n","filename":"test\/jdk\/com\/sun\/jdi\/InvokeHangTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -42,1 +42,1 @@\n-            Thread xx = TestScaffold.newThread(new Sleeper());\n+            Thread xx = DebuggeeWrapper.newThread(new Sleeper());\n","filename":"test\/jdk\/com\/sun\/jdi\/JdbLockTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -54,3 +54,3 @@\n-        Thread myThread1 = TestScaffold.newThread(myTask1, \"MYTHREAD-1\");\n-        Thread myThread2 = TestScaffold.newThread(myTask2, \"MYTHREAD-2\");\n-        Thread myThread3 = TestScaffold.newThread(myTask3, \"MYTHREAD-3\");\n+        Thread myThread1 = DebuggeeWrapper.newThread(myTask1, \"MYTHREAD-1\");\n+        Thread myThread2 = DebuggeeWrapper.newThread(myTask2, \"MYTHREAD-2\");\n+        Thread myThread3 = DebuggeeWrapper.newThread(myTask3, \"MYTHREAD-3\");\n","filename":"test\/jdk\/com\/sun\/jdi\/JdbStopThreadidTest.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -64,1 +64,1 @@\n-        Thread t1 = TestScaffold.newThread(new MyTask());\n+        Thread t1 = DebuggeeWrapper.newThread(new MyTask());\n","filename":"test\/jdk\/com\/sun\/jdi\/MonitorEventTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -146,1 +146,1 @@\n-        Thread thrd = TestScaffold.newThread(() -> {\n+        Thread thrd = DebuggeeWrapper.newThread(() -> {\n","filename":"test\/jdk\/com\/sun\/jdi\/MultiBreakpointsTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -189,1 +189,1 @@\n-        TestScaffold.newThread(new HarassThread()).start();\n+        DebuggeeWrapper.newThread(new HarassThread()).start();\n","filename":"test\/jdk\/com\/sun\/jdi\/PopAsynchronousTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -321,2 +321,1 @@\n-            String mainWrapper = System.getProperty(\"main.wrapper\");\n-            if (\"Virtual\".equals(mainWrapper)) {\n+            if (DebuggeeWrapper.isVirtual()) {\n","filename":"test\/jdk\/com\/sun\/jdi\/PopFramesTest.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -46,2 +46,2 @@\n-        Thread t1 = TestScaffold.newThread(new ResumeOneThreadTarg(), name1);\n-        Thread t2 = TestScaffold.newThread(new ResumeOneThreadTarg(), name2);\n+        Thread t1 = DebuggeeWrapper.newThread(new ResumeOneThreadTarg(), name1);\n+        Thread t2 = DebuggeeWrapper.newThread(new ResumeOneThreadTarg(), name2);\n","filename":"test\/jdk\/com\/sun\/jdi\/ResumeOneThreadTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -177,1 +177,1 @@\n-        boolean isVirtualThread = \"Virtual\".equals(System.getProperty(\"main.wrapper\"));\n+        boolean isVirtualThread = DebuggeeWrapper.isVirtual();\n","filename":"test\/jdk\/com\/sun\/jdi\/SetLocalWhileThreadInNative.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -53,2 +53,2 @@\n-        Thread t1 = TestScaffold.newThread(new SimulResumerTarg(), name1);\n-        Thread t2 = TestScaffold.newThread(new SimulResumerTarg(), name2);\n+        Thread t1 = DebuggeeWrapper.newThread(new SimulResumerTarg(), name1);\n+        Thread t2 = DebuggeeWrapper.newThread(new SimulResumerTarg(), name2);\n","filename":"test\/jdk\/com\/sun\/jdi\/SimulResumerTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -27,1 +27,0 @@\n-import java.lang.reflect.InvocationTargetException;\n@@ -30,1 +29,1 @@\n-import java.util.concurrent.ThreadFactory;\n+\n@@ -70,1 +69,0 @@\n-    public static final String OLD_MAIN_THREAD_NAME = \"old-m-a-i-n\";\n@@ -552,2 +550,3 @@\n-        \/\/ Need to change args to run wrapper using command like 'TestScaffold Virtual <app-name>'\n-        String mainWrapper = System.getProperty(\"main.wrapper\");\n+        \/\/ Need to change args to run wrapper using command like 'DebuggeeWrapper Virtual <app-name>'\n+        \/\/ Additionally property 'main.wrapper' should be set for tests which start additional threads\n+        String mainWrapper = DebuggeeWrapper.getWrapperName();\n@@ -555,2 +554,2 @@\n-            argInfo.targetVMArgs += \"-Dmain.wrapper=\" + mainWrapper;\n-            argInfo.targetAppCommandLine = TestScaffold.class.getName() + ' '\n+            argInfo.targetVMArgs += \"-D\" + DebuggeeWrapper.PROPERTY_NAME + \"=\" + mainWrapper;\n+            argInfo.targetAppCommandLine = DebuggeeWrapper.class.getName() + ' '\n@@ -1047,82 +1046,0 @@\n-    private static ThreadFactory threadFactory = r -> new Thread(r);\n-\n-    public static void main(String[] args) throws Throwable {\n-        String wrapper = args[0];\n-        String className = args[1];\n-        String[] classArgs = new String[args.length - 2];\n-        System.arraycopy(args, 2, classArgs, 0, args.length - 2);\n-        Class c = Class.forName(className);\n-        java.lang.reflect.Method mainMethod = c.getMethod(\"main\", new Class[] { String[].class });\n-        mainMethod.setAccessible(true);\n-\n-        if (wrapper.equals(\"Virtual\")) {\n-            threadFactory = Thread.ofVirtual().factory();\n-            MainThreadGroup tg = new MainThreadGroup();\n-            \/\/ TODO fix to set virtual scheduler group when become available\n-            Thread vthread = Thread.ofVirtual().unstarted(() -> {\n-                try {\n-                    mainMethod.invoke(null, new Object[] { classArgs });\n-                } catch (InvocationTargetException e) {\n-                    tg.uncaughtThrowable = e.getCause();\n-                } catch (Throwable error) {\n-                    tg.uncaughtThrowable = error;\n-                }\n-            });\n-            Thread.currentThread().setName(OLD_MAIN_THREAD_NAME);\n-            vthread.setName(\"main\");\n-            vthread.start();\n-            vthread.join();\n-            if (tg.uncaughtThrowable != null) {\n-                \/\/ Note we cant just rethrow tg.uncaughtThrowable because there are tests\n-                \/\/ that track ExceptionEvents, and they will complain about the extra\n-                \/\/ exception. So instead mimic what happens when the main thread exits\n-                \/\/ with an exception.\n-                System.out.println(\"Uncaught Exception: \" + tg.uncaughtThrowable);\n-                tg.uncaughtThrowable.printStackTrace(System.out);\n-                System.exit(1);\n-            }\n-        } else if (wrapper.equals(\"Kernel\")) {\n-            MainThreadGroup tg = new MainThreadGroup();\n-            Thread t = new Thread(tg, () -> {\n-                try {\n-                    mainMethod.invoke(null, new Object[] { classArgs });\n-                } catch (InvocationTargetException e) {\n-                    tg.uncaughtThrowable = e.getCause();\n-                } catch (Throwable error) {\n-                    tg.uncaughtThrowable = error;\n-                }\n-            });\n-            t.start();\n-            t.join();\n-            if (tg.uncaughtThrowable != null) {\n-                throw new RuntimeException(tg.uncaughtThrowable);\n-            }\n-        } else {\n-            mainMethod.invoke(null, new Object[] { classArgs });\n-        }\n-    }\n-\n-    static class MainThreadGroup extends ThreadGroup {\n-        MainThreadGroup() {\n-            super(\"MainThreadGroup\");\n-        }\n-\n-        public void uncaughtException(Thread t, Throwable e) {\n-            if (e instanceof ThreadDeath) {\n-                return;\n-            }\n-            e.printStackTrace(System.err);\n-            uncaughtThrowable = e;\n-        }\n-        Throwable uncaughtThrowable = null;\n-    }\n-\n-    public static Thread newThread(Runnable task) {\n-        return threadFactory.newThread(task);\n-    }\n-\n-    public static Thread newThread(Runnable task, String name) {\n-        Thread t = newThread(task);\n-        t.setName(name);\n-        return t;\n-    }\n","filename":"test\/jdk\/com\/sun\/jdi\/TestScaffold.java","additions":6,"deletions":89,"binary":false,"changes":95,"status":"modified"},{"patch":"@@ -61,1 +61,1 @@\n-            TestScaffold.newThread(() -> {\n+            DebuggeeWrapper.newThread(() -> {\n@@ -68,1 +68,0 @@\n-                        String mainWrapper = System.getProperty(\"main.wrapper\");\n@@ -73,1 +72,1 @@\n-                        long timeToSleep = \"Virtual\".equals(mainWrapper) ? 100 : 50;\n+                        long timeToSleep = DebuggeeWrapper.isVirtual() ? 100 : 50;\n","filename":"test\/jdk\/com\/sun\/jdi\/ThreadMemoryLeakTest.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -53,2 +53,2 @@\n-        Thread t1 = TestScaffold.newThread(new TwoThreadsTarg(), name1);\n-        Thread t2 = TestScaffold.newThread(new TwoThreadsTarg(), name2);\n+        Thread t1 = DebuggeeWrapper.newThread(new TwoThreadsTarg(), name1);\n+        Thread t2 = DebuggeeWrapper.newThread(new TwoThreadsTarg(), name2);\n","filename":"test\/jdk\/com\/sun\/jdi\/TwoThreadsTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}