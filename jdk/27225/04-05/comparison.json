{"files":[{"patch":"@@ -1795,10 +1795,12 @@\n-    Node* store = if_false->out(j)->isa_Store();\n-    \/\/ We only make changes if the memory input of the store is outside the outer loop body,\n-    \/\/ as this is when we would normally expect a Phi as input. If the memory input\n-    \/\/ is in the loop body as well, then we can safely assume it is still correct as the entire\n-    \/\/ body was cloned as a unit\n-    IdealLoopTree* input_loop = get_loop(get_ctrl(store->in(MemNode::Memory)));\n-    if (store != nullptr && !outer_loop->is_member(input_loop)) {\n-      Node* mem_out = find_last_store_in_outer_loop(store, outer_loop);\n-      Node* store_new = old_new[store->_idx];\n-      store_new->set_req(MemNode::Memory, mem_out);\n+    Node* store = if_false->out(j);\n+    if (store->is_Store()) {\n+      \/\/ We only make changes if the memory input of the store is outside the outer loop body,\n+      \/\/ as this is when we would normally expect a Phi as input. If the memory input\n+      \/\/ is in the loop body as well, then we can safely assume it is still correct as the entire\n+      \/\/ body was cloned as a unit\n+      IdealLoopTree* input_loop = get_loop(get_ctrl(store->in(MemNode::Memory)));\n+      if (!outer_loop->is_member(input_loop)) {\n+        Node* mem_out = find_last_store_in_outer_loop(store, outer_loop);\n+        Node* store_new = old_new[store->_idx];\n+        store_new->set_req(MemNode::Memory, mem_out);\n+      }\n","filename":"src\/hotspot\/share\/opto\/loopTransform.cpp","additions":12,"deletions":10,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -49,0 +49,12 @@\n+    \/\/ The store node in the loop body is moved to the OuterStripLoop.\n+    \/\/ When making the post loop the new store node\n+    \/\/ should have the moved store node as memory input, and not the\n+    \/\/ initial x = 0 store\n+    \/\/\n+    \/\/ store (x = 0)\n+    \/\/  |\n+    \/\/ store (x += 1, exit of CountedLoop main)\n+    \/\/  | <-- additional rewiring due to absence of phi node\n+    \/\/ store (x += 1, exit of CountedLoop post)\n+    \/\/  |\n+    \/\/ store (x = 0)\n@@ -57,0 +69,2 @@\n+    \/\/ Two independent stores\n+    \/\/ They should be wired independently in the post loop, no aliasing\n@@ -68,1 +82,20 @@\n-    static public void test3(A a1, A a2) {\n+    \/\/ Chain of stores with potential aliasing\n+    \/\/ The chain should be preserved when cloning the main loop body\n+    \/\/ to create the post loop. Only the first stored of the post loop\n+    \/\/ should be rewired to receive the last store of the main loop\n+    \/\/ as memory input\n+    \/\/\n+    \/\/ ...\n+    \/\/  |\n+    \/\/ store (a1.field = v, exit of CountedLoop main)\n+    \/\/  |\n+    \/\/ store (a2.field = v, exit of CountedLoop main)\n+    \/\/  |\n+    \/\/ store (a3.field = v, exit of CountedLoop main)\n+    \/\/  | <-- only additional rewiring needed\n+    \/\/ store (a1.field = v, exit of CountedLoop post)\n+    \/\/  |\n+    \/\/ store (a2.field = v, exit of CountedLoop post)\n+    \/\/  |\n+    \/\/ store (a3.field = v, exit of CountedLoop post)\n+    static public void test3(A a1, A a2, A a3) {\n@@ -71,0 +104,2 @@\n+        a3.field = 0;\n+        int v = 0;\n@@ -72,2 +107,4 @@\n-            a1.field += i;\n-            a2.field += i;\n+            v++;\n+            a1.field = v;\n+            a2.field = v;\n+            a3.field = v;\n@@ -75,2 +112,0 @@\n-        a1.field = 0;\n-        a2.field = 0;\n@@ -82,0 +117,1 @@\n+        A a3 = new A();\n@@ -93,3 +129,3 @@\n-        test3(a1, a1);\n-        if (a1.field != 0 || a2.field != 0) {\n-            throw new RuntimeException(\"unexpected value: \" + a1.field + \" \" + a2.field);\n+        test3(a1, a2, a3);\n+        if (a1.field != 20000 || a2.field != 20000 || a3.field != 20000) {\n+            throw new RuntimeException(\"unexpected value: \" + a1.field + \" \" + a2.field + \" \" + a3.field);\n","filename":"test\/hotspot\/jtreg\/compiler\/loopstripmining\/MissingStoreAfterOuterStripMinedLoop.java","additions":44,"deletions":8,"binary":false,"changes":52,"status":"modified"}]}