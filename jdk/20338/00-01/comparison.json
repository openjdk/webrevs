{"files":[{"patch":"@@ -31,1 +31,0 @@\n-import java.lang.classfile.attribute.CodeAttribute;\n@@ -61,4 +60,1 @@\n-        this.maxLocals = Util.maxLocals(methodInfo.methodFlags(), methodInfo.methodTypeSymbol());\n-        if (original instanceof CodeAttribute ca)\n-            this.maxLocals = Math.max(this.maxLocals, ca.maxLocals());\n-\n+        this.maxLocals = TerminalCodeBuilder.setupTopLocal(methodInfo, original);\n@@ -169,0 +165,4 @@\n+        int curTopLocal() {\n+            return BufferedCodeBuilder.this.curTopLocal();\n+        }\n+\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/BufferedCodeBuilder.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -129,0 +129,2 @@\n+        bytecodesBufWriter = (original instanceof CodeImpl cai) ? new BufWriterImpl(constantPool, context, cai.codeLength())\n+                : new BufWriterImpl(constantPool, context);\n@@ -131,8 +133,1 @@\n-        var topLocal = Util.maxLocals(methodInfo.methodFlags(), methodInfo.methodTypeSymbol());\n-        if (original instanceof CodeAttribute cai) {\n-            this.topLocal = Math.max(topLocal, cai.maxLocals());\n-            this.bytecodesBufWriter = new BufWriterImpl(constantPool, context, cai.codeLength());\n-        } else {\n-            this.topLocal = topLocal;\n-            this.bytecodesBufWriter = new BufWriterImpl(constantPool, context);\n-        }\n+        this.topLocal = TerminalCodeBuilder.setupTopLocal(methodInfo, original);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/DirectCodeBuilder.java","additions":3,"deletions":8,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -28,0 +28,2 @@\n+import java.lang.classfile.CodeModel;\n+import java.lang.classfile.attribute.CodeAttribute;\n@@ -32,0 +34,14 @@\n+\n+    static int setupTopLocal(MethodInfo methodInfo, CodeModel original) {\n+        int paramSlots = Util.maxLocals(methodInfo.methodFlags(), methodInfo.methodTypeSymbol());\n+        if (original == null) {\n+            return paramSlots;\n+        }\n+        if (original instanceof CodeAttribute attr) {\n+            return Math.max(paramSlots, attr.codeLength());\n+        }\n+        if (original instanceof BufferedCodeBuilder.Model buffered) {\n+            return Math.max(paramSlots, buffered.curTopLocal());\n+        }\n+        throw new InternalError(\"Unknown code model \" + original);\n+    }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/TerminalCodeBuilder.java","additions":16,"deletions":0,"binary":false,"changes":16,"status":"modified"}]}