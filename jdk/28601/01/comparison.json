{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1995, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1995, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,1 @@\n+import java.io.IOException;\n@@ -431,1 +432,1 @@\n-     * @return true if all goes well, false if no headers were set.\n+     * @throws IOException if no headers were set\n@@ -433,1 +434,2 @@\n-    public abstract boolean setHeaders(HttpURLConnection conn, HeaderParser p, String raw);\n+    public abstract void setHeaders(HttpURLConnection conn, HeaderParser p, String raw)\n+            throws IOException;\n","filename":"src\/java.base\/share\/classes\/sun\/net\/www\/protocol\/http\/AuthenticationInfo.java","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -128,1 +128,0 @@\n-     * @return true if all goes well, false if no headers were set.\n@@ -131,1 +130,1 @@\n-    public boolean setHeaders(HttpURLConnection conn, HeaderParser p, String raw) {\n+    public void setHeaders(HttpURLConnection conn, HeaderParser p, String raw) {\n@@ -136,1 +135,0 @@\n-        return true;\n","filename":"src\/java.base\/share\/classes\/sun\/net\/www\/protocol\/http\/BasicAuthentication.java","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -324,1 +324,5 @@\n-        return getHeaderValueImpl(url.getFile(), method);\n+        try {\n+            return getHeaderValueImpl(url.getFile(), method);\n+        } catch (IOException _) {\n+            return null;\n+        }\n@@ -342,1 +346,5 @@\n-        return getHeaderValueImpl(requestURI, method);\n+        try {\n+            return getHeaderValueImpl(requestURI, method);\n+        } catch (IOException _) {\n+            return null;\n+        }\n@@ -372,1 +380,1 @@\n-     * @return true if all goes well, false if no headers were set.\n+     * @throws IOException if no headers were set\n@@ -375,1 +383,2 @@\n-    public boolean setHeaders(HttpURLConnection conn, HeaderParser p, String raw) {\n+    public void setHeaders(HttpURLConnection conn, HeaderParser p, String raw)\n+            throws IOException {\n@@ -383,1 +392,1 @@\n-        params.setUserhash (Boolean.valueOf(p.findValue(\"userhash\")));\n+        params.setUserhash (Boolean.parseBoolean(p.findValue(\"userhash\")));\n@@ -390,1 +399,1 @@\n-            return false;\n+            throw new IOException(\"Illegal charset in header\");\n@@ -408,1 +417,1 @@\n-            return false;\n+            throw new IOException(\"Server challenge incomplete\");\n@@ -418,2 +427,1 @@\n-        if (!setAlgorithmNames(p, params))\n-            return false;\n+        setAlgorithmNames(p, params);\n@@ -429,7 +437,3 @@\n-        String value = getHeaderValueImpl (uri, method);\n-        if (value != null) {\n-            conn.setAuthenticationProperty(getHeaderName(), value);\n-            return true;\n-        } else {\n-            return false;\n-        }\n+        String value = getHeaderValueImpl(uri, method);\n+        assert value != null;\n+        conn.setAuthenticationProperty(getHeaderName(), value);\n@@ -441,2 +445,3 @@\n-    \/\/ returns false if algorithm not supported\n-    private static boolean setAlgorithmNames(HeaderParser p, Parameters params) {\n+    \/\/ throws IOException if algorithm not supported\n+    private static void setAlgorithmNames(HeaderParser p, Parameters params)\n+            throws IOException {\n@@ -462,1 +467,1 @@\n-            return false;\n+            throw new IOException(\"Unknown algorithm: \" + algorithm);\n@@ -467,1 +472,0 @@\n-        return true;\n@@ -473,1 +477,1 @@\n-    private String getHeaderValueImpl (String uri, String method) {\n+    private String getHeaderValueImpl (String uri, String method) throws IOException {\n@@ -482,5 +486,1 @@\n-        try {\n-            validateDigest(digest);\n-        } catch (IOException e) {\n-            return null;\n-        }\n+        validateDigest(digest);\n@@ -508,1 +508,1 @@\n-            return null;\n+            throw new IOException(\"Failed to compute digest\", ex);\n@@ -537,1 +537,1 @@\n-            return null;\n+            throw new IOException(\"Failed to compute user hash\", ex);\n","filename":"src\/java.base\/share\/classes\/sun\/net\/www\/protocol\/http\/DigestAuthentication.java","additions":29,"deletions":29,"binary":false,"changes":58,"status":"modified"},{"patch":"@@ -64,0 +64,1 @@\n+import jdk.internal.util.Exceptions;\n@@ -1472,2 +1473,4 @@\n-                        if (!proxyAuthentication.setHeaders(this,\n-                                                        authhdr.headerParser(), raw)) {\n+                        try {\n+                            proxyAuthentication.setHeaders(this,\n+                                    authhdr.headerParser(), raw);\n+                        } catch (IOException ex) {\n@@ -1475,1 +1478,5 @@\n-                            throw new IOException (\"Authentication failure\");\n+                            if (Exceptions.enhancedNonSocketExceptions()) {\n+                                throw new IOException (\"Authentication failure\", ex);\n+                            } else {\n+                                throw new IOException (\"Authentication failure\");\n+                            }\n@@ -1477,5 +1484,12 @@\n-                        if (serverAuthentication != null && srvHdr != null &&\n-                                !serverAuthentication.setHeaders(this,\n-                                                        srvHdr.headerParser(), raw)) {\n-                            disconnectInternal ();\n-                            throw new IOException (\"Authentication failure\");\n+                        if (serverAuthentication != null && srvHdr != null) {\n+                            try {\n+                                serverAuthentication.setHeaders(this,\n+                                        srvHdr.headerParser(), raw);\n+                            } catch (IOException ex) {\n+                                disconnectInternal();\n+                                if (Exceptions.enhancedNonSocketExceptions()) {\n+                                    throw new IOException (\"Authentication failure\", ex);\n+                                } else {\n+                                    throw new IOException (\"Authentication failure\");\n+                                }\n+                            }\n@@ -1560,1 +1574,3 @@\n-                        if (!serverAuthentication.setHeaders(this, null, raw)) {\n+                        try {\n+                            serverAuthentication.setHeaders(this, null, raw);\n+                        } catch (IOException ex) {\n@@ -1562,1 +1578,5 @@\n-                            throw new IOException (\"Authentication failure\");\n+                            if (Exceptions.enhancedNonSocketExceptions()) {\n+                                throw new IOException (\"Authentication failure\", ex);\n+                            } else {\n+                                throw new IOException (\"Authentication failure\");\n+                            }\n@@ -1938,2 +1958,4 @@\n-                        if (!proxyAuthentication.setHeaders(this,\n-                                                authhdr.headerParser(), raw)) {\n+                        try {\n+                            proxyAuthentication.setHeaders(this,\n+                                    authhdr.headerParser(), raw);\n+                        } catch (IOException ex) {\n@@ -1941,1 +1963,5 @@\n-                            throw new IOException (\"Authentication failure\");\n+                            if (Exceptions.enhancedNonSocketExceptions()) {\n+                                throw new IOException (\"Authentication failure\", ex);\n+                            } else {\n+                                throw new IOException (\"Authentication failure\");\n+                            }\n@@ -2204,1 +2230,3 @@\n-                if (!ret.setHeaders(this, p, raw)) {\n+                try {\n+                    ret.setHeaders(this, p, raw);\n+                } catch (IOException e) {\n@@ -2361,1 +2389,3 @@\n-                if (!ret.setHeaders(this, p, raw)) {\n+                try {\n+                    ret.setHeaders(this, p, raw);\n+                } catch (IOException e) {\n","filename":"src\/java.base\/share\/classes\/sun\/net\/www\/protocol\/http\/HttpURLConnection.java","additions":45,"deletions":15,"binary":false,"changes":60,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -171,1 +171,1 @@\n-     * @return true if all goes well, false if no headers were set.\n+     * @throws IOException if no headers were set\n@@ -174,1 +174,1 @@\n-    public boolean setHeaders(HttpURLConnection conn, HeaderParser p, String raw) {\n+    public void setHeaders(HttpURLConnection conn, HeaderParser p, String raw) throws IOException {\n@@ -179,14 +179,5 @@\n-        try {\n-            String response;\n-            byte[] incoming = null;\n-            String[] parts = raw.split(\"\\\\s+\");\n-            if (parts.length > 1) {\n-                incoming = Base64.getDecoder().decode(parts[1]);\n-            }\n-            response = hci.scheme + \" \" + Base64.getEncoder().encodeToString(\n-                        incoming==null?firstToken():nextToken(incoming));\n-\n-            conn.setAuthenticationProperty(getHeaderName(), response);\n-            return true;\n-        } catch (IOException e) {\n-            return false;\n+        String response;\n+        byte[] incoming = null;\n+        String[] parts = raw.split(\"\\\\s+\");\n+        if (parts.length > 1) {\n+            incoming = Base64.getDecoder().decode(parts[1]);\n@@ -194,0 +185,4 @@\n+        response = hci.scheme + \" \" + Base64.getEncoder().encodeToString(\n+                    incoming==null?firstToken():nextToken(incoming));\n+\n+        conn.setAuthenticationProperty(getHeaderName(), response);\n","filename":"src\/java.base\/share\/classes\/sun\/net\/www\/protocol\/http\/NegotiateAuthentication.java","additions":12,"deletions":17,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,1 +38,0 @@\n-import java.util.Properties;\n@@ -206,1 +205,1 @@\n-     * @return true if all goes well, false if no headers were set.\n+     * @throws IOException if no headers were set\n@@ -209,1 +208,1 @@\n-    public boolean setHeaders(HttpURLConnection conn, HeaderParser p, String raw) {\n+    public void setHeaders(HttpURLConnection conn, HeaderParser p, String raw) throws IOException {\n@@ -223,3 +222,2 @@\n-            return true;\n-        } catch (IOException | GeneralSecurityException e) {\n-            return false;\n+        } catch (GeneralSecurityException e) {\n+            throw new IOException(e);\n@@ -235,2 +233,1 @@\n-    private String buildType3Msg (String challenge) throws GeneralSecurityException,\n-                                                           IOException  {\n+    private String buildType3Msg (String challenge) throws GeneralSecurityException {\n","filename":"src\/java.base\/unix\/classes\/sun\/net\/www\/protocol\/http\/ntlm\/NTLMAuthentication.java","additions":6,"deletions":9,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -94,1 +94,2 @@\n-    private native byte[] getNextToken (long crdHandle, byte[] lastToken, Status returned);\n+    private native byte[] getNextToken (long crdHandle, byte[] lastToken, Status returned)\n+            throws IOException;\n","filename":"src\/java.base\/windows\/classes\/sun\/net\/www\/protocol\/http\/ntlm\/NTLMAuthSequence.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,1 +29,0 @@\n-import java.net.InetAddress;\n@@ -31,1 +30,0 @@\n-import java.net.UnknownHostException;\n@@ -207,1 +205,1 @@\n-     * @return true if all goes well, false if no headers were set.\n+     * @throws IOException if no headers were set\n@@ -210,1 +208,1 @@\n-    public boolean setHeaders(HttpURLConnection conn, HeaderParser p, String raw) {\n+    public void setHeaders(HttpURLConnection conn, HeaderParser p, String raw) throws IOException {\n@@ -227,1 +225,0 @@\n-            return true;\n@@ -230,1 +227,1 @@\n-            return false;\n+            throw e;\n","filename":"src\/java.base\/windows\/classes\/sun\/net\/www\/protocol\/http\/ntlm\/NTLMAuthentication.java","additions":4,"deletions":7,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -233,0 +233,2 @@\n+        SetLastError(ss);\n+        JNU_ThrowIOExceptionWithLastError(env, \"InitializeSecurityContext\");\n@@ -241,0 +243,2 @@\n+            SetLastError(ss);\n+            JNU_ThrowIOExceptionWithLastError(env, \"CompleteAuthToken\");\n","filename":"src\/java.base\/windows\/native\/libnet\/NTLMAuthSequence.c","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -0,0 +1,167 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8372731\n+ * @library \/test\/lib\n+ * @run main\/othervm NTLMFailTest\n+ * @run main\/othervm -Djdk.includeInExceptions= NTLMFailTest\n+ * @summary check that the Authentication failure exception\n+ *     honors the jdk.includeInExceptions setting\n+ *\/\n+\n+import jdk.test.lib.net.HttpHeaderParser;\n+import jdk.test.lib.net.URIBuilder;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.net.Authenticator;\n+import java.net.HttpURLConnection;\n+import java.net.InetAddress;\n+import java.net.PasswordAuthentication;\n+import java.net.ServerSocket;\n+import java.net.Socket;\n+import java.net.URL;\n+\n+public class NTLMFailTest {\n+\n+    static final int BODY_LEN = 8192;\n+\n+    static final String RESP_SERVER_AUTH =\n+            \"HTTP\/1.1 401 Unauthorized\\r\\n\" +\n+            \"WWW-Authenticate: NTLM\\r\\n\" +\n+            \"Connection: close\\r\\n\" +\n+            \"Content-Length: \" + BODY_LEN + \"\\r\\n\" +\n+            \"\\r\\n\";\n+\n+    static final String RESP_SERVER_NTLM =\n+            \"HTTP\/1.1 401 Unauthorized\\r\\n\" +\n+            \"WWW-Authenticate: NTLM InvalidChallenge\\r\\n\" +\n+            \"Connection: Keep-Alive\\r\\n\" +\n+            \"Content-Length: \" + BODY_LEN + \"\\r\\n\" +\n+            \"\\r\\n\";\n+\n+    public static void main(String[] args) throws Exception {\n+        Authenticator.setDefault(new TestAuthenticator());\n+        try (NTLMServer server = startServer(new ServerSocket(0, 0, InetAddress.getLoopbackAddress()))) {\n+            URL url = URIBuilder.newBuilder()\n+                    .scheme(\"http\")\n+                    .loopback()\n+                    .port(server.getLocalPort())\n+                    .path(\"\/\")\n+                    .toURLUnchecked();\n+            HttpURLConnection uc = (HttpURLConnection) url.openConnection();\n+            uc.setRequestMethod(\"HEAD\");\n+            uc.getInputStream().readAllBytes();\n+            throw new RuntimeException(\"Expected exception was not thrown\");\n+        } catch (IOException e) {\n+            if (e.getMessage().contains(\"Authentication failure\")) {\n+                System.err.println(\"Got expected exception:\");\n+                e.printStackTrace();\n+                if (System.getProperty(\"jdk.includeInExceptions\") == null) {\n+                    \/\/ detailed message enabled by default\n+                    if (e.getCause() == null) {\n+                        throw new RuntimeException(\"Expected a detailed exception\", e);\n+                    }\n+                    \/\/ no checks on the detailed message; it's platform-specific and may be translated\n+                } else {\n+                    \/\/ detailed message disabled\n+                    if (e.getCause() != null) {\n+                        throw new RuntimeException(\"Unexpected detailed exception\", e);\n+                    }\n+                }\n+            } else {\n+                throw e;\n+            }\n+        }\n+    }\n+\n+    static class NTLMServer extends Thread implements AutoCloseable {\n+        final ServerSocket ss;\n+        volatile boolean closed;\n+\n+        NTLMServer(ServerSocket serverSS) {\n+            super();\n+            setDaemon(true);\n+            this.ss = serverSS;\n+        }\n+\n+        int getLocalPort() { return ss.getLocalPort(); }\n+\n+        @Override\n+        public void run() {\n+            boolean doing2ndStageNTLM = false;\n+            while (!closed) {\n+                try {\n+                    Socket s = ss.accept();\n+                    InputStream is = s.getInputStream();\n+                    OutputStream os = s.getOutputStream();\n+                    doServer(is, os, doing2ndStageNTLM);\n+                    if (!doing2ndStageNTLM) {\n+                        doing2ndStageNTLM = true;\n+                    } else {\n+                        os.close();\n+                    }\n+                } catch (IOException ioe) {\n+                    if (!closed) {\n+                        ioe.printStackTrace();\n+                    }\n+                }\n+            }\n+        }\n+\n+        @Override\n+        public void close() {\n+           if (closed) return;\n+           synchronized(this) {\n+               if (closed) return;\n+               closed = true;\n+           }\n+           try { ss.close(); } catch (IOException x) { };\n+        }\n+    }\n+\n+    static NTLMServer startServer(ServerSocket serverSS) {\n+        NTLMServer server = new NTLMServer(serverSS);\n+        server.start();\n+        return server;\n+    }\n+\n+    static void doServer(InputStream is, OutputStream os, boolean doing2ndStageNTLM) throws IOException {\n+        if (!doing2ndStageNTLM) {\n+            new HttpHeaderParser(is);\n+            os.write(RESP_SERVER_AUTH.getBytes(\"ASCII\"));\n+        } else {\n+            new HttpHeaderParser(is);\n+            os.write(RESP_SERVER_NTLM.getBytes(\"ASCII\"));\n+        }\n+    }\n+\n+    static class TestAuthenticator extends Authenticator {\n+        protected PasswordAuthentication getPasswordAuthentication() {\n+            return new PasswordAuthentication(\"test\", \"secret\".toCharArray());\n+        }\n+    }\n+}\n","filename":"test\/jdk\/sun\/net\/www\/protocol\/http\/NTLMFailTest.java","additions":167,"deletions":0,"binary":false,"changes":167,"status":"added"}]}