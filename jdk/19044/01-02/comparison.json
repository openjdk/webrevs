{"files":[{"patch":"@@ -1295,0 +1295,2 @@\n+    \/\/ We must hold the dbgRawMonitor when calling verifyMonitorRank()\n+\n@@ -1366,0 +1368,1 @@\n+        \/\/ We must hold the dbgRawMonitor when calling verifyMonitorRank()\n@@ -1428,0 +1431,1 @@\n+    JNIEnv *env = getEnv();\n@@ -1439,1 +1443,0 @@\n-    JNIEnv *env = getEnv();\n@@ -1441,1 +1444,0 @@\n-    JNI_FUNC_PTR(env,DeleteLocalRef)(env, current_thread);\n@@ -1443,5 +1445,14 @@\n-    \/\/ Release ownership of the DebugRawMonitor before RawMonitorWait actually exits it.\n-    dbgRawMonitor_lock();\n-    dbg_monitor->ownerThread = NULL;\n-    dbg_monitor->entryCount = 0;\n-    dbgRawMonitor_unlock();\n+    {\n+      dbgRawMonitor_lock();\n+\n+      \/\/ Release ownership of the DebugRawMonitor before RawMonitorWait actually exits it.\n+      dbg_monitor->ownerThread = NULL;\n+      dbg_monitor->entryCount = 0;\n+\n+      \/\/ Doing a wait ends up doing an exit and then an enter after the wait completes.\n+      \/\/ We must do the same rank verificaton as is done during a monitor enter.\n+      \/\/ We must hold the dbgRawMonitor when calling verifyMonitorRank()\n+      verifyMonitorRank(env, dbg_monitor->rank, current_thread);\n+    \n+      dbgRawMonitor_unlock();\n+    }\n@@ -1457,0 +1468,2 @@\n+\n+    JNI_FUNC_PTR(env,DeleteLocalRef)(env, current_thread);\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/util.c","additions":20,"deletions":7,"binary":false,"changes":27,"status":"modified"}]}