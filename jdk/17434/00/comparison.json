{"files":[{"patch":"@@ -138,26 +138,0 @@\n-static inline bool should_do_cld_klass(const Klass* klass, bool leakp) {\n-  return klass != nullptr && _artifacts->should_do_cld_klass(klass, leakp);\n-}\n-\n-static inline KlassPtr get_cld_klass(CldPtr cld, bool leakp) {\n-  if (cld == nullptr) {\n-    return nullptr;\n-  }\n-  assert(leakp ? IS_LEAKP(cld) : used(cld), \"invariant\");\n-  KlassPtr cld_klass = cld->class_loader_klass();\n-  if (cld_klass == nullptr) {\n-    return nullptr;\n-  }\n-  if (should_do_cld_klass(cld_klass, leakp)) {\n-    if (current_epoch()) {\n-      \/\/ This will enqueue the klass, which is important for\n-      \/\/ reachability when doing clear and reset at rotation.\n-      JfrTraceId::load(cld_klass);\n-    } else {\n-      artifact_tag(cld_klass, leakp);\n-    }\n-    return cld_klass;\n-  }\n-  return nullptr;\n-}\n-\n@@ -176,0 +150,32 @@\n+static inline bool should_do_cld_klass(const Klass* cld_klass, bool leakp) {\n+  return cld_klass != nullptr && _artifacts->should_do_cld_klass(cld_klass, leakp);\n+}\n+\n+static inline bool should_enqueue(const Klass* cld_klass) {\n+  assert(cld_klass != nullptr, \"invariant\");\n+  if (previous_epoch()) {\n+    return false;\n+  }\n+  CldPtr cld = get_cld(cld_klass);\n+  return cld != nullptr && !cld->is_unloading();\n+}\n+\n+static inline KlassPtr get_cld_klass(CldPtr cld, bool leakp) {\n+  if (cld == nullptr) {\n+    return nullptr;\n+  }\n+  assert(leakp ? IS_LEAKP(cld) : used(cld), \"invariant\");\n+  KlassPtr cld_klass = cld->class_loader_klass();\n+  if (!should_do_cld_klass(cld_klass, leakp)) {\n+    return nullptr;\n+  }\n+  if (should_enqueue(cld_klass)) {\n+    \/\/ This will enqueue the klass, which is important for\n+    \/\/ reachability when doing clear and reset at rotation.\n+    JfrTraceId::load(cld_klass);\n+   } else {\n+     artifact_tag(cld_klass, leakp);\n+   }\n+   return cld_klass;\n+}\n+\n","filename":"src\/hotspot\/share\/jfr\/recorder\/checkpoint\/types\/jfrTypeSet.cpp","additions":32,"deletions":26,"binary":false,"changes":58,"status":"modified"}]}