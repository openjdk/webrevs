{"files":[{"patch":"@@ -638,1 +638,0 @@\n-        ensureCapacityInternal(count + 4);\n@@ -640,0 +639,1 @@\n+        ensureCapacityInternal(count + 4);\n@@ -642,4 +642,1 @@\n-            val[count++] = 'n';\n-            val[count++] = 'u';\n-            val[count++] = 'l';\n-            val[count++] = 'l';\n+            StringLatin1.putCharsAt(val, count, 'n', 'u', 'l', 'l');\n@@ -647,1 +644,1 @@\n-            count = StringUTF16.putCharsAt(val, count, 'n', 'u', 'l', 'l');\n+            StringUTF16.putCharsAt(val, count, 'n', 'u', 'l', 'l');\n@@ -649,1 +646,1 @@\n-        this.count = count;\n+        this.count = count + 4;\n@@ -769,1 +766,0 @@\n-        ensureCapacityInternal(count + (b ? 4 : 5));\n@@ -771,0 +767,2 @@\n+        int spaceNeeded = count + (b ? 4 : 5);\n+        ensureCapacityInternal(spaceNeeded);\n@@ -774,4 +772,1 @@\n-                val[count++] = 't';\n-                val[count++] = 'r';\n-                val[count++] = 'u';\n-                val[count++] = 'e';\n+                StringLatin1.putCharsAt(val, count, 't', 'r', 'u', 'e');\n@@ -779,5 +774,1 @@\n-                val[count++] = 'f';\n-                val[count++] = 'a';\n-                val[count++] = 'l';\n-                val[count++] = 's';\n-                val[count++] = 'e';\n+                StringLatin1.putCharsAt(val, count, 'f', 'a', 'l', 's', 'e');\n@@ -787,1 +778,1 @@\n-                count = StringUTF16.putCharsAt(val, count, 't', 'r', 'u', 'e');\n+                StringUTF16.putCharsAt(val, count, 't', 'r', 'u', 'e');\n@@ -789,1 +780,1 @@\n-                count = StringUTF16.putCharsAt(val, count, 'f', 'a', 'l', 's', 'e');\n+                StringUTF16.putCharsAt(val, count, 'f', 'a', 'l', 's', 'e');\n@@ -792,1 +783,1 @@\n-        this.count = count;\n+        this.count = spaceNeeded;\n","filename":"src\/java.base\/share\/classes\/java\/lang\/AbstractStringBuilder.java","additions":11,"deletions":20,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+import jdk.internal.misc.Unsafe;\n@@ -827,0 +828,21 @@\n+    static void putCharsAt(byte[] val, int index, int c1, int c2, int c3, int c4) {\n+        assert index >= 0 && index + 3 < length(val) : \"Trusted caller missed bounds check\";\n+        \/\/ Don't use the putChar method, Its instrinsic will cause C2 unable to combining values into larger stores.\n+        Unsafe UNSAFE = Unsafe.getUnsafe();\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index    , (byte)(c1));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 1, (byte)(c2));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 2, (byte)(c3));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 3, (byte)(c4));\n+    }\n+\n+    static void putCharsAt(byte[] val, int index, int c1, int c2, int c3, int c4, int c5) {\n+        assert index >= 0 && index + 4 < length(val) : \"Trusted caller missed bounds check\";\n+        \/\/ Don't use the putChar method, Its instrinsic will cause C2 unable to combining values into larger stores.\n+        Unsafe UNSAFE = Unsafe.getUnsafe();\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index    , (byte)(c1));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 1, (byte)(c2));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 2, (byte)(c3));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 3, (byte)(c4));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 4, (byte)(c5));\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/java\/lang\/StringLatin1.java","additions":22,"deletions":0,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -46,1 +46,0 @@\n-\n@@ -1551,21 +1550,30 @@\n-    public static int putCharsAt(byte[] value, int i, char c1, char c2, char c3, char c4) {\n-        int end = i + 4;\n-        checkBoundsBeginEnd(i, end, value);\n-        putChar(value, i++, c1);\n-        putChar(value, i++, c2);\n-        putChar(value, i++, c3);\n-        putChar(value, i++, c4);\n-        assert(i == end);\n-        return end;\n-    }\n-\n-    public static int putCharsAt(byte[] value, int i, char c1, char c2, char c3, char c4, char c5) {\n-        int end = i + 5;\n-        checkBoundsBeginEnd(i, end, value);\n-        putChar(value, i++, c1);\n-        putChar(value, i++, c2);\n-        putChar(value, i++, c3);\n-        putChar(value, i++, c4);\n-        putChar(value, i++, c5);\n-        assert(i == end);\n-        return end;\n+    static void putCharsAt(byte[] val, int index, int c1, int c2, int c3, int c4) {\n+        \/\/ Don't use the putChar method, Its instrinsic will cause C2 unable to combining values into larger stores.\n+        assert index >= 0 && index + 3 < length(val) : \"Trusted caller missed bounds check\";\n+        index <<= 1;\n+        Unsafe UNSAFE = Unsafe.getUnsafe();\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index    , (byte)(c1 >> HI_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 1, (byte)(c1 >> LO_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 2, (byte)(c2 >> HI_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 3, (byte)(c2 >> LO_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 4, (byte)(c3 >> HI_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 5, (byte)(c3 >> LO_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 6, (byte)(c4 >> HI_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 7, (byte)(c4 >> LO_BYTE_SHIFT));\n+    }\n+\n+    static void putCharsAt(byte[] val, int index, int c1, int c2, int c3, int c4, int c5) {\n+        \/\/ Don't use the putChar method, Its instrinsic will cause C2 unable to combining values into larger stores.\n+        assert index >= 0 && index + 4 < length(val) : \"Trusted caller missed bounds check\";\n+        index <<= 1;\n+        Unsafe UNSAFE = Unsafe.getUnsafe();\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index    , (byte)(c1 >> HI_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 1, (byte)(c1 >> LO_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 2, (byte)(c2 >> HI_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 3, (byte)(c2 >> LO_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 4, (byte)(c3 >> HI_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 5, (byte)(c3 >> LO_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 6, (byte)(c4 >> HI_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 7, (byte)(c4 >> LO_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 8, (byte)(c5 >> HI_BYTE_SHIFT));\n+        UNSAFE.putByte(val, Unsafe.ARRAY_BYTE_BASE_OFFSET + index + 9, (byte)(c5 >> LO_BYTE_SHIFT));\n","filename":"src\/java.base\/share\/classes\/java\/lang\/StringUTF16.java","additions":30,"deletions":22,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -111,7 +111,0 @@\n-            putCharsAt(val2, -1, '1', '2', '3', '4');\n-            putCharsAt(val2,  0, '1', '2', '3', '4');\n-            putCharsAt(val2,  2, '1', '2', '3', '4');\n-            putCharsAt(val2, -1, '1', '2', '3', '4', '5');\n-            putCharsAt(val2,  0, '1', '2', '3', '4', '5');\n-            putCharsAt(val2,  2, '1', '2', '3', '4', '5');\n-\n@@ -251,16 +244,0 @@\n-    static void putCharsAt(byte[] v, int i, char c1, char c2, char c3, char c4) {\n-        try {\n-            Helper.putCharsAt(v, i, c1, c2, c3, c4);\n-            throw new AssertionError(\"putCharsAt\");\n-        } catch (IndexOutOfBoundsException io) {\n-        }\n-    }\n-\n-    static void putCharsAt(byte[] v, int i, char c1, char c2, char c3, char c4, char c5) {\n-        try {\n-            Helper.putCharsAt(v, i, c1, c2, c3, c4, c5);\n-            throw new AssertionError(\"putCharsAt\");\n-        } catch (IndexOutOfBoundsException io) {\n-        }\n-    }\n-\n","filename":"test\/hotspot\/jtreg\/compiler\/intrinsics\/string\/TestStringUTF16IntrinsicRangeChecks.java","additions":0,"deletions":23,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -135,8 +135,0 @@\n-    public static int putCharsAt(byte[] value, int i, char c1, char c2, char c3, char c4) {\n-        return StringUTF16.putCharsAt(value, i, c1, c2, c3, c4);\n-    }\n-\n-    public static int putCharsAt(byte[] value, int i, char c1, char c2, char c3, char c4, char c5) {\n-        return StringUTF16.putCharsAt(value, i, c1, c2, c3, c4, c5);\n-    }\n-\n","filename":"test\/hotspot\/jtreg\/compiler\/patches\/java.base\/java\/lang\/Helper.java","additions":0,"deletions":8,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -229,11 +229,62 @@\n-    public String toStringCharWithBool8() {\n-        StringBuilder result = new StringBuilder();\n-        result.append(true);\n-        result.append(false);\n-        result.append(true);\n-        result.append(true);\n-        result.append(false);\n-        result.append(true);\n-        result.append(false);\n-        result.append(false);\n-        return result.toString();\n+    public int toStringCharWithBool8Latin1() {\n+        StringBuilder buf = sbLatin1;\n+        buf.delete(0, buf.length());\n+        buf.append(true);\n+        buf.append(false);\n+        buf.append(true);\n+        buf.append(true);\n+        buf.append(false);\n+        buf.append(true);\n+        buf.append(false);\n+        buf.append(false);\n+        return buf.length();\n+    }\n+\n+\n+    @Benchmark\n+    public int toStringCharWithBool8Utf16() {\n+        StringBuilder buf = sbUtf16;\n+        buf.delete(0, buf.length());\n+        buf.append('\\uFF16');\n+        buf.append(true);\n+        buf.append(false);\n+        buf.append(true);\n+        buf.append(true);\n+        buf.append(false);\n+        buf.append(true);\n+        buf.append(false);\n+        buf.append(false);\n+        return buf.length();\n+    }\n+\n+\n+    @Benchmark\n+    public int toStringCharWithNull8Latin1() {\n+        StringBuilder buf = sbLatin1;\n+        buf.delete(0, buf.length());\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        return buf.length();\n+    }\n+\n+\n+    @Benchmark\n+    public int toStringCharWithNull8Utf16() {\n+        StringBuilder buf = sbUtf16;\n+        buf.delete(0, buf.length());\n+        buf.append('\\uFF16');\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        buf.append((String) null);\n+        return buf.length();\n","filename":"test\/micro\/org\/openjdk\/bench\/java\/lang\/StringBuilders.java","additions":62,"deletions":11,"binary":false,"changes":73,"status":"modified"}]}