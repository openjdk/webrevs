{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,1 +32,1 @@\n-#include \"runtime\/atomicAccess.hpp\"\n+#include \"runtime\/atomic.hpp\"\n@@ -58,9 +58,0 @@\n-void PreservedMarks::restore_and_increment(volatile size_t* const total_size_addr) {\n-  const size_t stack_size = size();\n-  restore();\n-  \/\/ Only do the atomic add if the size is > 0.\n-  if (stack_size > 0) {\n-    AtomicAccess::add(total_size_addr, stack_size);\n-  }\n-}\n-\n@@ -96,1 +87,1 @@\n-  volatile size_t _total_size;\n+  Atomic<size_t> _total_size;\n@@ -105,1 +96,6 @@\n-      _preserved_marks_set->get(task_id)->restore_and_increment(&_total_size);\n+      PreservedMarks* next = _preserved_marks_set->get(task_id);\n+      size_t num_restored = next->size();\n+      next->restore();\n+      if (num_restored > 0) {\n+        _total_size.add_then_fetch(num_restored);\n+      }\n@@ -124,3 +120,5 @@\n-    assert(_total_size == _total_size_before, \"total_size = %zu before = %zu\", _total_size, _total_size_before);\n-    size_t mem_size = _total_size * (sizeof(oop) + sizeof(markWord));\n-    log_trace(gc)(\"Restored %zu marks, occupying %zu %s\", _total_size,\n+    size_t local_total_size = _total_size.load_relaxed();\n+\n+    assert(local_total_size == _total_size_before, \"total_size = %zu before = %zu\", local_total_size, _total_size_before);\n+    size_t mem_size = local_total_size * (sizeof(oop) + sizeof(markWord));\n+    log_trace(gc)(\"Restored %zu marks, occupying %zu %s\", local_total_size,\n","filename":"src\/hotspot\/share\/gc\/shared\/preservedMarks.cpp","additions":14,"deletions":16,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -62,2 +62,1 @@\n-  \/\/ Iterate over the stack, restore all preserved marks, and\n-  \/\/ reclaim the memory taken up by the stack segments.\n+  \/\/ Restore all preserved marks, and reclaim the memory taken up by the stack segments.\n@@ -74,2 +73,0 @@\n-  void restore_and_increment(volatile size_t* const _total_size_addr);\n-\n","filename":"src\/hotspot\/share\/gc\/shared\/preservedMarks.hpp","additions":2,"deletions":5,"binary":false,"changes":7,"status":"modified"}]}