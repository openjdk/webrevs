{"files":[{"patch":"@@ -416,1 +416,12 @@\n-                tsym = env.enclClass.sym;\n+                \/\/ Resolve target for unqualified reference based on declaring element\n+                tsym = switch (path.getLeaf().getKind()) {\n+                    case PACKAGE -> env.toplevel.packge;\n+                    case MODULE -> env.toplevel.modle;\n+                    case COMPILATION_UNIT ->\n+                        \/\/ Treat unqualified reference in legacy package.html as package reference.\n+                        \/\/ Unqualified references in doc-fiiles only need to work locally, so null is fine.\n+                        path.getCompilationUnit().getSourceFile().isNameCompatible(\"package\", JavaFileObject.Kind.HTML)\n+                                ? env.toplevel.packge\n+                                : null;\n+                    default -> env.enclClass.sym;  \/\/ Class or class member reference\n+                };\n@@ -473,1 +484,1 @@\n-            if (memberName == null)\n+            if (memberName == null) {\n@@ -475,0 +486,3 @@\n+            } else if (tsym == null || tsym.getKind() == ElementKind.PACKAGE || tsym.getKind() == ElementKind.MODULE) {\n+                return null;  \/\/ Non-null member name in non-class context\n+            }\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/api\/JavacTrees.java","additions":16,"deletions":2,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -53,0 +53,1 @@\n+import jdk.javadoc.internal.html.HtmlId;\n@@ -162,0 +163,4 @@\n+            if (ref == null && refSignature.startsWith(\"##\")) {\n+                \/\/ Unqualified local anchor link\n+                return htmlWriter.links.createLink(HtmlId.of(refFragment), labelContent);\n+            }\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/taglets\/LinkTaglet.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -1007,6 +1007,9 @@\n-        Element e = env.trees.getElement(getCurrentPath());\n-        if (e == null) {\n-            reportBadReference(tree);\n-        } else if ((inLink || inSee)\n-                && e.getKind() == ElementKind.CLASS && e.asType().getKind() != TypeKind.DECLARED) {\n-            reportBadReference(tree);\n+        \/\/ Exclude same-file anchor links from reference checks\n+        if (!tree.getSignature().startsWith(\"##\")) {\n+            Element e = env.trees.getElement(getCurrentPath());\n+            if (e == null) {\n+                reportBadReference(tree);\n+            } else if ((inLink || inSee)\n+                    && e.getKind() == ElementKind.CLASS && e.asType().getKind() != TypeKind.DECLARED) {\n+                reportBadReference(tree);\n+            }\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclint\/Checker.java","additions":9,"deletions":6,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -80,1 +80,5 @@\n-                    Plain link to <a href=\"..\/p2\/Class2.html#class2-sub-heading\">sub heading above<\/a><\/div>\"\"\",\n+                    Plain link to <a href=\"..\/p2\/Class2.html#class2-sub-heading\">heading in Class2<\/a><\/div>\"\"\",\n+            \"\"\"\n+                    <li><a href=\"#main\">unqualified link to heading above<\/a><\/li>\n+                    <li><a href=\"#main\">qualified link to heading above<\/a><\/li>\n+                    \"\"\",\n@@ -92,1 +96,4 @@\n-                    <a href=\"Class2.html#class2-sub-heading\">See sub heading in p2.Class2<\/a>\"\"\");\n+                    <li><a href=\"Class2.html#class2-sub-heading\">See sub heading in p2.Class2<\/a><\/li>\n+                    <li><a href=\"#package-p2-heading\">local qualified link<\/a><\/li>\n+                    <li><a href=\"#package-p2-heading\">local unqualified link<\/a><\/li>\n+                    \"\"\");\n@@ -98,1 +105,4 @@\n-                    <a href=\"..\/Class2.html#class2main\">See main heading in p2.ClassB<\/a>\"\"\");\n+                    <li><a href=\"..\/Class2.html#class2main\">See main heading in p2.ClassB<\/a><\/li>\n+                    <li><a href=\"..\/package-summary.html#package-p2-heading\">package link<\/a><\/li>\n+                    <li><a href=\"#package-p2-html-file-heading\">local anchor<\/a><\/li>\n+                    \"\"\");\n@@ -115,0 +125,14 @@\n+        checkOrder(\"m1\/com\/m1\/package-summary.html\",\n+            \"\"\"\n+                    <div class=\"block\"><a href=\"#package-anchor\">Link to local anchor<\/a>.\n+                    \"\"\",\n+            \"\"\"\n+                    <span id=\"package-anchor\" class=\"search-tag-result\">package-anchor<\/span><\/div>\n+                    \"\"\",\n+            \"\"\"\n+                    <ul class=\"tag-list\">\n+                    <li><a href=\"#package-anchor\">unqualified local anchor<\/a><\/li>\n+                    <li><a href=\"#package-anchor\">qualified local anchor<\/a><\/li>\n+                    <li><a href=\"#package-anchor\">fully qualified local anchor<\/a><\/li>\n+                    <\/ul>\n+                    \"\"\");\n@@ -119,2 +143,33 @@\n-                    <li><a href=\"..\/..\/..\/m2\/com\/m2\/Class2.html#main-heading\">See main heading in Class2<\/a><\/li>\n-                    <li><a href=\"..\/..\/module-summary.html#module-m1-heading\">See heading in module m1<\/a><\/li>\n+                    <p>More links:\n+                    <ul>\n+                    <li><a href=\"..\/..\/..\/m2\/com\/m2\/Class2.html#sub\">qualified remote link<\/a><\/li>\n+                    <li><a href=\"..\/..\/..\/m2\/com\/m2\/Class2.html#sub\">unqualified remote link<\/a><\/li>\n+                    <li><a href=\"..\/..\/module-summary.html#module-m1-heading\">module anchor link<\/a><\/li>\n+                    <li><a href=\"package-summary.html#package-anchor\">package anchor link<\/a><\/li>\n+                    <li><a href=\"#class1-anchor\">qualified local anchor link<\/a><\/li>\n+                    <li><a href=\"#class1-anchor\">unqualified local anchor link<\/a><\/li>\n+                    <\/ul>\n+                    \"\"\",\n+            \"\"\"\n+                    <dt>See Also:<\/dt>\n+                    <dd>\n+                    <ul class=\"tag-list\">\n+                    <li><a href=\"..\/..\/..\/m2\/com\/m2\/Class2.html#main-heading\">qualified remote link<\/a><\/li>\n+                    <li><a href=\"..\/..\/..\/m2\/com\/m2\/Class2.html#main-heading\">unqualified remote link<\/a><\/li>\n+                    <li><a href=\"..\/..\/module-summary.html#module-m1-heading\">module anchor link<\/a><\/li>\n+                    <li><a href=\"package-summary.html#package-anchor\">package anchor link<\/a><\/li>\n+                    <li><a href=\"#class1-anchor\">qualified local anchor link<\/a><\/li>\n+                    <li><a href=\"#class1-anchor\">unqualified local anchor link<\/a><\/li>\n+                    <\/ul>\n+                    \"\"\");\n+        checkOrder(\"m2\/module-summary.html\",\n+            \"\"\"\n+                    <a href=\"com\/m2\/package-summary.html#pkg-heading\">Plain link to local anchor<\/a>.\"\"\");\n+        checkOrder(\"m2\/com\/m2\/package-summary.html\",\n+            \"\"\"\n+                    <a href=\"#pkg-heading\">Plain link to local anchor<\/a>.\n+                    \"\"\",\n+            \"\"\"\n+                    <ul class=\"tag-list\">\n+                    <li><a href=\"#pkg-heading\">See local anchor<\/a><\/li>\n+                    <\/ul>\n@@ -129,1 +184,3 @@\n-                    Link to <a href=\"..\/com\/m2\/Class2.html#main-heading\"><code>heading in Class2<\/code><\/a>.\"\"\",\n+                    Link to <a href=\"..\/com\/m2\/Class2.html#main-heading\"><code>heading in Class2<\/code><\/a>.\n+                    <a href=\"#docfile-heading\">Plain link to local anchor<\/a>.\n+                    \"\"\",\n@@ -131,1 +188,4 @@\n-                    <li><a href=\"..\/..\/m1\/module-summary.html#module-m1-heading\">Heading in module m1<\/a><\/li>\"\"\");\n+                    <ul class=\"tag-list\">\n+                    <li><a href=\"..\/..\/m1\/module-summary.html#module-m1-heading\">Heading in module m1<\/a><\/li>\n+                    <li><a href=\"#docfile-heading\">See local anchor<\/a><\/li>\n+                    \"\"\");\n@@ -200,1 +260,3 @@\n-                    Plain link to {@linkplain p2.Class2##class2-sub-heading sub heading above}\n+                    Plain link to {@linkplain p2.Class2##class2-sub-heading heading in Class2}\n+                    @see ##main unqualified link to heading above\n+                    @see p1.Class1##main qualified link to heading above\n@@ -219,0 +281,2 @@\n+                     * @see p2##package-p2-heading local qualified link\n+                     * @see ##package-p2-heading local unqualified link\n@@ -230,0 +294,2 @@\n+                    @see p2##package-p2-heading package link\n+                    @see ##package-p2-html-file-heading local anchor\n@@ -238,0 +304,1 @@\n+                .requires(\"m2\")\n@@ -240,0 +307,3 @@\n+\n+                    import com.m2.Class2;\n+\n@@ -243,2 +313,18 @@\n-                     * @see m2\/com.m2.Class2##main-heading See main heading in Class2\n-                     * @see m1\/##module-m1-heading See heading in module m1\n+                     * <p>More links:\n+                     * <ul>\n+                     * <li>{@linkplain com.m2.Class2##sub qualified remote link}<\/li>\n+                     * <li>{@linkplain Class2##sub unqualified remote link}<\/li>\n+                     * <li>{@linkplain m1\/##module-m1-heading module anchor link}<\/li>\n+                     * <li>{@linkplain com.m1##package-anchor package anchor link}<\/li>\n+                     * <li>{@linkplain Class1##class1-anchor qualified local anchor link}<\/li>\n+                     * <li>{@linkplain ##class1-anchor unqualified local anchor link}<\/li>\n+                     * <\/ul>\n+                     *\n+                     * <p>{@index class1-anchor}\n+                     *\n+                     * @see com.m2.Class2##main-heading  qualified remote link\n+                     * @see Class2##main-heading unqualified remote link\n+                     * @see m1\/##module-m1-heading module anchor link\n+                     * @see com.m1##package-anchor package anchor link\n+                     * @see Class1##class1-anchor qualified local anchor link\n+                     * @see ##class1-anchor unqualified local anchor link\n@@ -253,0 +339,11 @@\n+        tb.writeFile(src.resolve(\"m1\/com\/m1\/package-info.java\"), \"\"\"\n+                    \/**\n+                     * {@linkplain ##package-anchor Link to local anchor}.\n+                     * {@index package-anchor}\n+                     *\n+                     * @see ##package-anchor unqualified local anchor\n+                     * @see com.m1##package-anchor qualified local anchor\n+                     * @see m1\/com.m1##package-anchor fully qualified local anchor\n+                     *\/\n+                    package com.m1;\n+                    \"\"\");\n@@ -267,0 +364,12 @@\n+        tb.writeFile(src.resolve(\"m2\/com\/m2\/package.html\"), \"\"\"\n+                    <html>\n+                    <head><title>Package com.m2<\/title><\/head>\n+                    <body>\n+                    {@linkplain ##pkg-heading Plain link to local anchor}.\n+\n+                    <h2 id=\"pkg-heading\">Package com.m2<\/h2>\n+\n+                    @see ##pkg-heading See local anchor\n+                    <\/body>\n+                    <\/html>\n+                    \"\"\");\n@@ -272,1 +381,2 @@\n-                    <body><h1>Module m2 HTML File<\/h1>\n+                    <body>\n+                    <h1 id=docfile-heading>Module m2 HTML File<\/h1>\n@@ -274,0 +384,2 @@\n+                    {@linkplain ##docfile-heading Plain link to local anchor}.\n+\n@@ -275,0 +387,1 @@\n+                    @see ##docfile-heading See local anchor\n@@ -300,1 +413,1 @@\n-}\n\\ No newline at end of file\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testSeeLinkAnchor\/TestSeeLinkAnchor.java","additions":126,"deletions":13,"binary":false,"changes":139,"status":"modified"}]}