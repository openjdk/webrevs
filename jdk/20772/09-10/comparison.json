{"files":[{"patch":"@@ -2597,2 +2597,2 @@\n-            public byte stringCoder(String s) {\n-                return s.coder();\n+            public boolean isLatin1(String s) {\n+                return s.coder() == String.LATIN1;\n","filename":"src\/java.base\/share\/classes\/java\/lang\/System.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -394,1 +394,1 @@\n-    byte stringCoder(String s);\n+    boolean isLatin1(String s);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/access\/JavaLangAccess.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -163,12 +163,4 @@\n-\n-        int countGreaterThanZero = 0;\n-        byte coder = JLA.stringCoder(str);\n-        int freeBytes = strlen + 2;\n-        if (coder == 0) {\n-            \/\/ If it is too long, it may be slow due to cache misses.\n-            if (strlen < 256) {\n-                countGreaterThanZero = JLA.countGreaterThanZero(str);\n-            }\n-            freeBytes += strlen - countGreaterThanZero; \/\/ 2 bytes\n-        } else {\n-            freeBytes += (strlen << 1); \/\/ 3 bytes\n+        int countGreaterThanZero = JLA.isLatin1(str) && strlen < 256 ? JLA.countGreaterThanZero(str) : 0;\n+        int utflen = countGreaterThanZero == strlen ? strlen : utflen(str, countGreaterThanZero);\n+        if (utflen > 65535) {\n+            throw new IllegalArgumentException(\"string too long\");\n@@ -176,1 +168,1 @@\n-        reserveSpace(freeBytes);\n+        reserveSpace(utflen + 2);\n@@ -178,2 +170,1 @@\n-        int start = this.offset;\n-        int offset = start + 2;\n+        int offset = this.offset;\n@@ -182,0 +173,4 @@\n+        elems[offset    ] = (byte) (utflen >> 8);\n+        elems[offset + 1] = (byte)  utflen;\n+        offset += 2;\n+\n@@ -200,6 +195,1 @@\n-        int utflen = offset - start - 2;\n-        if (utflen > 65535) {\n-            throw new IllegalArgumentException(\"string too long\");\n-        }\n-        elems[start    ] = (byte) (utflen >> 8);\n-        elems[start + 1] = (byte)  utflen;\n+\n@@ -209,0 +199,12 @@\n+    private static int utflen(String str, int countGreaterThanZero) {\n+        int strlen = str.length();\n+        int utflen = strlen;\n+        for (int i = countGreaterThanZero; i < strlen; i++) {\n+            int c = str.charAt(i);\n+            if (c >= 0x80 || c == 0)\n+                utflen += (c >= 0x800) ? 2 : 1;\n+        }\n+\n+        return utflen;\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/BufWriterImpl.java","additions":23,"deletions":21,"binary":false,"changes":44,"status":"modified"}]}