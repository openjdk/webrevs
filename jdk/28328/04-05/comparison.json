{"files":[{"patch":"@@ -27,1 +27,0 @@\n-#include \"utilities\/globalDefinitions.hpp\"\n@@ -36,2 +35,0 @@\n-\n-THREAD_LOCAL bool deferred_icache_invalidation = false;\n","filename":"src\/hotspot\/cpu\/aarch64\/icache_aarch64.cpp","additions":0,"deletions":3,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -31,62 +31,0 @@\n-#include \"code\/nmethod.hpp\"\n-#include \"utilities\/globalDefinitions.hpp\"\n-\n-#define PD_ICACHE_INVALIDATION_CONTEXT\n-\n-extern THREAD_LOCAL bool deferred_icache_invalidation;\n-\n-inline void ICacheInvalidationContext::pd_init() {\n-   if (NeoverseN1Errata1542419) {\n-    deferred_icache_invalidation = true;\n-  }\n-}\n-\n-inline bool ICacheInvalidationContext::deferred_invalidation() {\n-  return deferred_icache_invalidation;\n-}\n-\n-inline void ICacheInvalidationContext::pd_invalidate_icache() {\n-  if (NeoverseN1Errata1542419) {\n-    assert(deferred_icache_invalidation, \"Deferred icache invalidation must be enabled\");\n-    \/\/ Errata 1542419: Neoverse N1 cores with the 'COHERENT_ICACHE' feature may fetch stale\n-    \/\/ instructions when software depends on prefetch-speculation-protection\n-    \/\/ instead of explicit synchronization.\n-    \/\/\n-    \/\/ Neoverse-N1 implementation mitigates the errata 1542419 with a workaround:\n-    \/\/ - Disable coherent icache.\n-    \/\/ - Trap IC IVAU instructions.\n-    \/\/ - Execute:\n-    \/\/   - tlbi vae3is, xzr\n-    \/\/   - dsb sy\n-    \/\/ - Ignore trapped IC IVAU instructions.\n-    \/\/\n-    \/\/ `tlbi vae3is, xzr` invalidates all translation entries (all VAs, all possible levels).\n-    \/\/ It waits for all memory accesses using in-scope old translation information to complete\n-    \/\/ before it is considered complete.\n-    \/\/\n-    \/\/ As this workaround has significant overhead, Arm Neoverse N1 (MP050) Software Developer\n-    \/\/ Errata Notice version 29.0 suggests:\n-    \/\/\n-    \/\/ \"Since one TLB inner-shareable invalidation is enough to avoid this erratum, the number\n-    \/\/ of injected TLB invalidations should be minimized in the trap handler to mitigate\n-    \/\/ the performance impact due to this workaround.\"\n-#ifndef PRODUCT\n-    unsigned int cache_info = 0;\n-    asm volatile (\"mrs\\t%0, ctr_el0\":\"=r\" (cache_info));\n-    constexpr unsigned int CTR_IDC_SHIFT = 28;\n-    constexpr unsigned int CTR_DIC_SHIFT = 29;\n-    assert(((cache_info >> CTR_IDC_SHIFT) & 0x1) != 0x0, \"Expect CTR_EL0.IDC to be enabled\");\n-    assert(((cache_info >> CTR_DIC_SHIFT) & 0x1) == 0x0, \"Expect CTR_EL0.DIC to be disabled\");\n-#endif\n-\n-    \/\/ As the address for icache invalidation is not relevant\n-    \/\/ and IC IVAU instruction is ignored, we use XZR in it.\n-    asm volatile(\"dsb ish       \\n\"\n-                 \"ic  ivau, xzr \\n\"\n-                 \"isb           \\n\"\n-                 : : : \"memory\");\n-\n-    deferred_icache_invalidation = false;\n-  }\n-}\n-\n","filename":"src\/hotspot\/cpu\/aarch64\/icache_aarch64.hpp","additions":0,"deletions":62,"binary":false,"changes":62,"status":"modified"},{"patch":"@@ -0,0 +1,27 @@\n+\/*\n+ * Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+#include \"utilities\/globalDefinitions.hpp\"\n+\n+THREAD_LOCAL bool deferred_icache_invalidation = false;\n","filename":"src\/hotspot\/os_cpu\/linux_aarch64\/icache_linux_aarch64.cpp","additions":27,"deletions":0,"binary":false,"changes":27,"status":"added"},{"patch":"@@ -29,0 +29,61 @@\n+#include \"utilities\/globalDefinitions.hpp\"\n+\n+#define PD_ICACHE_INVALIDATION_CONTEXT\n+\n+extern THREAD_LOCAL bool deferred_icache_invalidation;\n+\n+inline void ICacheInvalidationContext::pd_init() {\n+   if (NeoverseN1Errata1542419) {\n+    deferred_icache_invalidation = true;\n+  }\n+}\n+\n+inline bool ICacheInvalidationContext::deferred_invalidation() {\n+  return deferred_icache_invalidation;\n+}\n+\n+inline void ICacheInvalidationContext::pd_invalidate_icache() {\n+  if (NeoverseN1Errata1542419) {\n+    assert(deferred_icache_invalidation, \"Deferred icache invalidation must be enabled\");\n+    \/\/ Errata 1542419: Neoverse N1 cores with the 'COHERENT_ICACHE' feature may fetch stale\n+    \/\/ instructions when software depends on prefetch-speculation-protection\n+    \/\/ instead of explicit synchronization.\n+    \/\/\n+    \/\/ Neoverse-N1 implementation mitigates the errata 1542419 with a workaround:\n+    \/\/ - Disable coherent icache.\n+    \/\/ - Trap IC IVAU instructions.\n+    \/\/ - Execute:\n+    \/\/   - tlbi vae3is, xzr\n+    \/\/   - dsb sy\n+    \/\/ - Ignore trapped IC IVAU instructions.\n+    \/\/\n+    \/\/ `tlbi vae3is, xzr` invalidates all translation entries (all VAs, all possible levels).\n+    \/\/ It waits for all memory accesses using in-scope old translation information to complete\n+    \/\/ before it is considered complete.\n+    \/\/\n+    \/\/ As this workaround has significant overhead, Arm Neoverse N1 (MP050) Software Developer\n+    \/\/ Errata Notice version 29.0 suggests:\n+    \/\/\n+    \/\/ \"Since one TLB inner-shareable invalidation is enough to avoid this erratum, the number\n+    \/\/ of injected TLB invalidations should be minimized in the trap handler to mitigate\n+    \/\/ the performance impact due to this workaround.\"\n+#ifndef PRODUCT\n+    unsigned int cache_info = 0;\n+    asm volatile (\"mrs\\t%0, ctr_el0\":\"=r\" (cache_info));\n+    constexpr unsigned int CTR_IDC_SHIFT = 28;\n+    constexpr unsigned int CTR_DIC_SHIFT = 29;\n+    assert(((cache_info >> CTR_IDC_SHIFT) & 0x1) != 0x0, \"Expect CTR_EL0.IDC to be enabled\");\n+    assert(((cache_info >> CTR_DIC_SHIFT) & 0x1) == 0x0, \"Expect CTR_EL0.DIC to be disabled\");\n+#endif\n+\n+    \/\/ As the address for icache invalidation is not relevant\n+    \/\/ and IC IVAU instruction is ignored, we use XZR in it.\n+    asm volatile(\"dsb ish       \\n\"\n+                 \"ic  ivau, xzr \\n\"\n+                 \"isb           \\n\"\n+                 : : : \"memory\");\n+\n+    deferred_icache_invalidation = false;\n+  }\n+}\n+\n","filename":"src\/hotspot\/os_cpu\/linux_aarch64\/icache_linux_aarch64.hpp","additions":61,"deletions":0,"binary":false,"changes":61,"status":"modified"},{"patch":"@@ -74,2 +74,0 @@\n-class nmethod;\n-\n","filename":"src\/hotspot\/share\/runtime\/icache.hpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}