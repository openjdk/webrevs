{"files":[{"patch":"@@ -27,0 +27,1 @@\n+#include \"utilities\/globalDefinitions.hpp\"\n@@ -35,0 +36,2 @@\n+\n+THREAD_LOCAL bool deferred_icache_invalidation = false;\n","filename":"src\/hotspot\/cpu\/aarch64\/icache_aarch64.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -36,4 +36,5 @@\n-inline void ICacheInvalidationContext::pd_init(nmethod* nm) {\n-  if (NeoverseN1Errata1542419) {\n-    _nm = nm;\n-    _deferred_icache_invalidation = (_nm != nullptr);\n+extern THREAD_LOCAL bool deferred_icache_invalidation;\n+\n+inline void ICacheInvalidationContext::pd_init() {\n+   if (NeoverseN1Errata1542419) {\n+    deferred_icache_invalidation = true;\n@@ -43,0 +44,4 @@\n+inline bool ICacheInvalidationContext::deferred_invalidation() {\n+  return deferred_icache_invalidation;\n+}\n+\n@@ -44,3 +49,7 @@\n-  if (_nm != nullptr) {\n-    assert(NeoverseN1Errata1542419, \"Should only be set for Neoverse N1 erratum\");\n-    \/\/ Neoverse-N1 implementation mitigates erratum 1542419 with a workaround:\n+  if (NeoverseN1Errata1542419) {\n+    assert(deferred_icache_invalidation, \"Deferred icache invalidation must be enabled\");\n+    \/\/ Errata 1542419: Neoverse N1 cores with the 'COHERENT_ICACHE' feature may fetch stale\n+    \/\/ instructions when software depends on prefetch-speculation-protection\n+    \/\/ instead of explicit synchronization.\n+    \/\/\n+    \/\/ Neoverse-N1 implementation mitigates the errata 1542419 with a workaround:\n@@ -52,0 +61,1 @@\n+    \/\/ - Ignore trapped IC IVAU instructions.\n@@ -53,3 +63,3 @@\n-    \/\/ `tlbi vae3is, xzr` invalidates translations for all address spaces (global for address).\n-    \/\/  It waits for all memory accesses using in-scope old translation information to complete\n-    \/\/  before it is considered complete.\n+    \/\/ `tlbi vae3is, xzr` invalidates all translation entries (all VAs, all possible levels).\n+    \/\/ It waits for all memory accesses using in-scope old translation information to complete\n+    \/\/ before it is considered complete.\n@@ -63,6 +73,8 @@\n-    \/\/\n-    \/\/ As the address for icache invalidation is not relevant, we use the nmethod's code start address.\n-    ICache::invalidate_word(_nm->code_begin());\n-    _deferred_icache_invalidation = false;\n-  }\n-}\n+#ifndef PRODUCT\n+    unsigned int cache_info = 0;\n+    asm volatile (\"mrs\\t%0, ctr_el0\":\"=r\" (cache_info));\n+    constexpr unsigned int CTR_IDC_SHIFT = 28;\n+    constexpr unsigned int CTR_DIC_SHIFT = 29;\n+    assert(((cache_info >> CTR_IDC_SHIFT) & 0x1) != 0x0, \"Expect CTR_EL0.IDC to be enabled\");\n+    assert(((cache_info >> CTR_DIC_SHIFT) & 0x1) == 0x0, \"Expect CTR_EL0.DIC to be disabled\");\n+#endif\n@@ -70,2 +82,9 @@\n-inline bool ICacheInvalidationContext::deferred_invalidation() {\n-  return _deferred_icache_invalidation;\n+    \/\/ As the address for icache invalidation is not relevant\n+    \/\/ and IC IVAU instruction is ignored, we use XZR in it.\n+    asm volatile(\"dsb ish       \\n\"\n+                 \"ic  ivau, xzr \\n\"\n+                 \"isb           \\n\"\n+                 : : : \"memory\");\n+\n+    deferred_icache_invalidation = false;\n+  }\n","filename":"src\/hotspot\/cpu\/aarch64\/icache_aarch64.hpp","additions":37,"deletions":18,"binary":false,"changes":55,"status":"modified"},{"patch":"@@ -75,1 +75,1 @@\n-    ICacheInvalidationContext icic(nm);\n+    ICacheInvalidationContext icic;\n","filename":"src\/hotspot\/share\/gc\/z\/zBarrierSetNMethod.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1439,1 +1439,1 @@\n-        ICacheInvalidationContext icic(nm);\n+        ICacheInvalidationContext icic;\n","filename":"src\/hotspot\/share\/gc\/z\/zGeneration.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -723,1 +723,1 @@\n-         ICacheInvalidationContext icic(nm);\n+         ICacheInvalidationContext icic;\n@@ -771,1 +771,1 @@\n-        ICacheInvalidationContext icic(nm);\n+        ICacheInvalidationContext icic;\n","filename":"src\/hotspot\/share\/gc\/z\/zMark.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -206,1 +206,1 @@\n-    ICacheInvalidationContext icic(nm);\n+    ICacheInvalidationContext icic;\n@@ -375,1 +375,1 @@\n-          ICacheInvalidationContext icic(nm);\n+          ICacheInvalidationContext icic;\n","filename":"src\/hotspot\/share\/gc\/z\/zNMethod.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -85,1 +85,1 @@\n-    ICacheInvalidationContext icic(nm);\n+    ICacheInvalidationContext icic;\n","filename":"src\/hotspot\/share\/gc\/z\/zUnload.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -128,2 +128,0 @@\n-\n-THREAD_LOCAL bool ICacheInvalidationContext::_deferred_icache_invalidation = false;\n","filename":"src\/hotspot\/share\/runtime\/icache.cpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -80,5 +80,1 @@\n-  static THREAD_LOCAL bool _deferred_icache_invalidation;\n-\n-  nmethod* _nm;\n-\n-  void pd_init(nmethod* nm);\n+  void pd_init();\n@@ -88,2 +84,2 @@\n-  ICacheInvalidationContext(nmethod* nm) : _nm(nullptr) {\n-    pd_init(nm);\n+  ICacheInvalidationContext() {\n+    pd_init();\n","filename":"src\/hotspot\/share\/runtime\/icache.hpp","additions":3,"deletions":7,"binary":false,"changes":10,"status":"modified"}]}