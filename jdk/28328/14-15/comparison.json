{"files":[{"patch":"@@ -882,13 +882,1 @@\n-  if (UseDeferredICacheInvalidation) {\n-    \/\/ Defer the ICache invalidation to a later point where multiple patches can be handled together.\n-    \/\/\n-    \/\/ Note: We rely on the fact that this function is only called from places where deferred invalidation\n-    \/\/ is safe. This assumption helps to avoid overhead of accessing thread-local data here.\n-    assert(ICacheInvalidationContext::current() != nullptr, \"ICache invalidation context should be set\");\n-    assert(ICacheInvalidationContext::current()->mode() == ICacheInvalidation::DEFERRED ||\n-           ICacheInvalidationContext::current()->mode() == ICacheInvalidation::NOT_NEEDED,\n-           \"ICache invalidation should be deferred or unneeded\");\n-    return;\n-  }\n-\n-  ICache::invalidate_word((address)patch_addr);\n+  ICacheInvalidationContext::invalidate_word((address)patch_addr);\n","filename":"src\/hotspot\/cpu\/aarch64\/gc\/z\/zBarrierSetAssembler_aarch64.cpp","additions":1,"deletions":13,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -59,13 +59,1 @@\n-  if (UseDeferredICacheInvalidation) {\n-    \/\/ Defer the ICache invalidation to a later point where multiple patches can be handled together.\n-    \/\/\n-    \/\/ Note: We rely on the fact that this function is only called from places where deferred invalidation\n-    \/\/ is safe. This assumption helps to avoid overhead of accessing thread-local data here.\n-    assert(ICacheInvalidationContext::current() != nullptr, \"ICache invalidation context should be set\");\n-    assert(ICacheInvalidationContext::current()->mode() == ICacheInvalidation::DEFERRED ||\n-           ICacheInvalidationContext::current()->mode() == ICacheInvalidation::NOT_NEEDED,\n-           \"ICache invalidation should be deferred or unneeded.\");\n-    return;\n-  }\n-\n-  ICache::invalidate_range(addr(), bytes);\n+  ICacheInvalidationContext::invalidate_range(addr(), bytes);\n","filename":"src\/hotspot\/cpu\/aarch64\/relocInfo_aarch64.cpp","additions":1,"deletions":13,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -55,0 +55,3 @@\n+bool VM_Version::_cache_dic_enabled;\n+bool VM_Version::_cache_idc_enabled;\n+\n@@ -90,0 +93,3 @@\n+  _cache_dic_enabled = false;\n+  _cache_idc_enabled = false;\n+\n@@ -657,0 +663,4 @@\n+  if (FLAG_IS_DEFAULT(UseDeferredICacheInvalidation) && is_cache_idc_enabled() && is_cache_dic_enabled()) {\n+    FLAG_SET_DEFAULT(UseDeferredICacheInvalidation, true);\n+  }\n+\n","filename":"src\/hotspot\/cpu\/aarch64\/vm_version_aarch64.cpp","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -56,0 +56,2 @@\n+  static bool _cache_dic_enabled;\n+  static bool _cache_idc_enabled;\n@@ -224,0 +226,3 @@\n+\n+  static bool is_cache_dic_enabled() { return _cache_dic_enabled; }\n+  static bool is_cache_idc_enabled() { return _cache_idc_enabled; }\n","filename":"src\/hotspot\/cpu\/aarch64\/vm_version_aarch64.hpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+#include \"runtime\/vm_version.hpp\"\n@@ -32,25 +33,0 @@\n-inline void assert_hardware_cache_coherency() {\n-  \/\/ For deferred icache invalidation, we expect hardware dcache\n-  \/\/ and icache to be coherent: CTR_EL0.IDC == 1 and CTR_EL0.DIC == 1\n-  \/\/ An exception is Neoverse N1 with erratum 1542419, which requires\n-  \/\/ a use of 'IC IVAU' instruction. In such a case, we expect\n-  \/\/ CTR_EL0.DIC == 0.\n-#ifdef ASSERT\n-  static unsigned int cache_info = 0;\n-  if (cache_info == 0) {\n-    asm volatile(\"mrs\\t%0, ctr_el0\" : \"=r\"(cache_info));\n-  }\n-  constexpr unsigned int CTR_IDC_SHIFT = 28;\n-  constexpr unsigned int CTR_DIC_SHIFT = 29;\n-  assert(((cache_info >> CTR_IDC_SHIFT) & 0x1) != 0x0,\n-         \"Expect CTR_EL0.IDC to be enabled\");\n-  if (NeoverseN1Errata1542419) {\n-    assert(((cache_info >> CTR_DIC_SHIFT) & 0x1) == 0x0,\n-           \"Expect CTR_EL0.DIC to be disabled for Neoverse N1 with erratum \"\n-           \"1542419\");\n-  } else {\n-    assert(((cache_info >> CTR_DIC_SHIFT) & 0x1) != 0x0,\n-           \"Expect CTR_EL0.DIC to be enabled\");\n-  }\n-#endif\n-}\n@@ -70,1 +46,6 @@\n-      assert_hardware_cache_coherency();\n+      assert(VM_Version::is_cache_idc_enabled(),\n+             \"Expect CTR_EL0.IDC to be enabled for Neoverse N1 with erratum \"\n+             \"1542419\");\n+      assert(!VM_Version::is_cache_dic_enabled(),\n+             \"Expect CTR_EL0.DIC to be disabled for Neoverse N1 with erratum \"\n+             \"1542419\");\n@@ -155,1 +136,1 @@\n-    assert_hardware_cache_coherency();\n+    assert(VM_Version::is_cache_idc_enabled(), \"Expect CTR_EL0.IDC to be enabled\");\n@@ -160,0 +141,4 @@\n+      assert(!VM_Version::is_cache_dic_enabled(),\n+             \"Expect CTR_EL0.DIC to be disabled for Neoverse N1 with erratum \"\n+             \"1542419\");\n+\n@@ -192,0 +177,2 @@\n+    } else {\n+      assert(VM_Version::is_cache_dic_enabled(), \"Expect CTR_EL0.DIC to be enabled\");\n@@ -205,0 +192,16 @@\n+\n+  static void invalidate_range(address start, int nbytes) {\n+    if (UseDeferredICacheInvalidation) {\n+      assert(_current_context != nullptr &&\n+             (_current_context->mode() == ICacheInvalidation::DEFERRED ||\n+              _current_context->mode() == ICacheInvalidation::NOT_NEEDED),\n+            \"UseDeferredICacheInvalidation requires ICache invalidation mode to be deferred or unneeded.\");\n+      return;\n+    }\n+\n+    ICache::invalidate_range(start, nbytes);\n+  }\n+\n+  static void invalidate_word(address addr) {\n+    invalidate_range(addr, 4);\n+  }\n","filename":"src\/hotspot\/os_cpu\/linux_aarch64\/icache_linux_aarch64.hpp","additions":30,"deletions":27,"binary":false,"changes":57,"status":"modified"},{"patch":"@@ -172,0 +172,2 @@\n+  _cache_idc_enabled = ((ctr_el0 >> 28) & 0x1) != 0;\n+  _cache_dic_enabled = ((ctr_el0 >> 29) & 0x1) != 0;\n","filename":"src\/hotspot\/os_cpu\/linux_aarch64\/vm_version_linux_aarch64.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1529,5 +1529,7 @@\n-  \/\/ Fix relocation\n-  RelocIterator iter(nm_copy);\n-  CodeBuffer src(this);\n-  CodeBuffer dst(nm_copy);\n-  while (iter.next()) {\n+  {\n+    ICacheInvalidationContext icic(ICacheInvalidation::NOT_NEEDED);\n+    \/\/ Fix relocation\n+    RelocIterator iter(nm_copy);\n+    CodeBuffer src(this);\n+    CodeBuffer dst(nm_copy);\n+    while (iter.next()) {\n@@ -1535,6 +1537,7 @@\n-    \/\/ Direct calls may no longer be in range and the use of a trampoline may now be required.\n-    \/\/ Instead, allow trampoline relocations to update their owners and perform the necessary checks.\n-    if (iter.reloc()->is_call()) {\n-      address trampoline = trampoline_stub_Relocation::get_trampoline_for(iter.reloc()->addr(), nm_copy);\n-      if (trampoline != nullptr) {\n-        continue;\n+      \/\/ Direct calls may no longer be in range and the use of a trampoline may now be required.\n+      \/\/ Instead, allow trampoline relocations to update their owners and perform the necessary checks.\n+      if (iter.reloc()->is_call()) {\n+        address trampoline = trampoline_stub_Relocation::get_trampoline_for(iter.reloc()->addr(), nm_copy);\n+        if (trampoline != nullptr) {\n+          continue;\n+        }\n@@ -1542,1 +1545,0 @@\n-    }\n@@ -1545,1 +1547,2 @@\n-    iter.reloc()->fix_relocation_after_move(&src, &dst);\n+      iter.reloc()->fix_relocation_after_move(&src, &dst);\n+    }\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":16,"deletions":13,"binary":false,"changes":29,"status":"modified"}]}