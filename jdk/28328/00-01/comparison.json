{"files":[{"patch":"@@ -865,1 +865,1 @@\n-void ZBarrierSetAssembler::patch_barrier_relocation(address addr, int format, bool defer_icache_invalidation) {\n+void ZBarrierSetAssembler::patch_barrier_relocation(address addr, int format) {\n@@ -882,2 +882,2 @@\n-  if (defer_icache_invalidation) {\n-    \/\/ Instruction cache invalidation per barrier can be expensive, e.g. on Neoverse N1 having erratum 1542419.\n+  if (NeoverseN1Errata1542419) {\n+    \/\/ Instruction cache invalidation per barrier is expensive on Neoverse N1 having erratum 1542419.\n@@ -885,0 +885,4 @@\n+    \/\/\n+    \/\/ Note: We rely on the fact that this function is only called from places where deferred invalidation\n+    \/\/ is safe. This assumption helps to avoid overhead of accessing thread-local data here.\n+    assert(ICacheInvalidationContext::deferred_invalidation(), \"ICache invalidation should be deferred\");\n","filename":"src\/hotspot\/cpu\/aarch64\/gc\/z\/zBarrierSetAssembler_aarch64.cpp","additions":7,"deletions":3,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -157,1 +157,1 @@\n-  void patch_barrier_relocation(address addr, int format, bool defer_icache_invalidation = false);\n+  void patch_barrier_relocation(address addr, int format);\n","filename":"src\/hotspot\/cpu\/aarch64\/gc\/z\/zBarrierSetAssembler_aarch64.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+    _deferred_icache_invalidation = (_nm != nullptr);\n@@ -65,0 +66,1 @@\n+    _deferred_icache_invalidation = false;\n@@ -68,0 +70,4 @@\n+inline bool ICacheInvalidationContext::deferred_invalidation() {\n+  return _deferred_icache_invalidation;\n+}\n+\n","filename":"src\/hotspot\/cpu\/aarch64\/icache_aarch64.hpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -58,1 +58,1 @@\n-  if (binding() != nullptr && binding()->deferred_icache_invalidation()) {\n+  if (ICacheInvalidationContext::deferred_invalidation()) {\n","filename":"src\/hotspot\/cpu\/aarch64\/relocInfo_aarch64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2035,1 +2035,1 @@\n-void nmethod::fix_oop_relocations(address begin, address end, bool initialize_immediates, bool defer_icache_invalidation) {\n+void nmethod::fix_oop_relocations(address begin, address end, bool initialize_immediates) {\n@@ -2038,1 +2038,0 @@\n-  AARCH64_ONLY(iter.set_deferred_icache_invalidation(defer_icache_invalidation);)\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -802,1 +802,1 @@\n-  void fix_oop_relocations(address begin, address end, bool initialize_immediates, bool defer_icache_invalidation = false);\n+  void fix_oop_relocations(address begin, address end, bool initialize_immediates);\n@@ -811,1 +811,0 @@\n-  void fix_oop_relocations(bool defer_icache_invalidation) { fix_oop_relocations(nullptr, nullptr, false, defer_icache_invalidation); }\n","filename":"src\/hotspot\/share\/code\/nmethod.hpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -571,2 +571,0 @@\n-  AARCH64_ONLY(bool _deferred_icache_invalidation;)\n-\n@@ -643,5 +641,0 @@\n-#ifdef AARCH64\n-  bool deferred_icache_invalidation() const { return _deferred_icache_invalidation;  }\n-  void set_deferred_icache_invalidation(bool b) { _deferred_icache_invalidation = b; }\n-#endif\n-\n","filename":"src\/hotspot\/share\/code\/relocInfo.hpp","additions":0,"deletions":7,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -78,1 +78,1 @@\n-    ZNMethod::nmethod_patch_barriers(nm, icic.deferred_invalidation());\n+    ZNMethod::nmethod_patch_barriers(nm);\n@@ -82,1 +82,1 @@\n-    ZNMethod::nmethod_oops_do_inner(nm, &cl, icic.deferred_invalidation());\n+    ZNMethod::nmethod_oops_do_inner(nm, &cl);\n","filename":"src\/hotspot\/share\/gc\/z\/zBarrierSetNMethod.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1441,1 +1441,1 @@\n-        ZNMethod::nmethod_patch_barriers(nm, icic.deferred_invalidation());\n+        ZNMethod::nmethod_patch_barriers(nm);\n@@ -1445,1 +1445,1 @@\n-        ZNMethod::nmethod_oops_do_inner(nm, &cl, icic.deferred_invalidation());\n+        ZNMethod::nmethod_oops_do_inner(nm, &cl);\n","filename":"src\/hotspot\/share\/gc\/z\/zGeneration.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -725,1 +725,1 @@\n-         ZNMethod::nmethod_patch_barriers(nm, icic.deferred_invalidation());\n+         ZNMethod::nmethod_patch_barriers(nm);\n@@ -729,1 +729,1 @@\n-         ZNMethod::nmethod_oops_do_inner(nm, &cl, icic.deferred_invalidation());\n+         ZNMethod::nmethod_oops_do_inner(nm, &cl);\n@@ -775,1 +775,1 @@\n-          ZNMethod::nmethod_patch_barriers(nm, icic.deferred_invalidation());\n+          ZNMethod::nmethod_patch_barriers(nm);\n@@ -780,1 +780,1 @@\n-        ZNMethod::nmethod_oops_do_inner(nm, &cl, icic.deferred_invalidation());\n+        ZNMethod::nmethod_oops_do_inner(nm, &cl);\n","filename":"src\/hotspot\/share\/gc\/z\/zMark.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -209,1 +209,1 @@\n-    nmethod_patch_barriers(nm, icic.deferred_invalidation());\n+    nmethod_patch_barriers(nm);\n@@ -252,1 +252,1 @@\n-void ZNMethod::nmethod_patch_barriers(nmethod* nm, bool defer_icache_invalidation) {\n+void ZNMethod::nmethod_patch_barriers(nmethod* nm) {\n@@ -256,1 +256,1 @@\n-    bs_asm->patch_barrier_relocation(barrier._reloc_addr, barrier._reloc_format AARCH64_ONLY(COMMA defer_icache_invalidation));\n+    bs_asm->patch_barrier_relocation(barrier._reloc_addr, barrier._reloc_format);\n@@ -265,1 +265,1 @@\n-void ZNMethod::nmethod_oops_do_inner(nmethod* nm, OopClosure* cl, bool defer_icache_invalidation) {\n+void ZNMethod::nmethod_oops_do_inner(nmethod* nm, OopClosure* cl) {\n@@ -291,1 +291,1 @@\n-    nm->fix_oop_relocations(defer_icache_invalidation);\n+    nm->fix_oop_relocations();\n@@ -378,1 +378,1 @@\n-          ZNMethod::nmethod_oops_do_inner(nm, &cl, icic.deferred_invalidation());\n+          ZNMethod::nmethod_oops_do_inner(nm, &cl);\n","filename":"src\/hotspot\/share\/gc\/z\/zNMethod.cpp","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -58,1 +58,1 @@\n-  static void nmethod_patch_barriers(nmethod* nm, bool defer_icache_invalidation = false);\n+  static void nmethod_patch_barriers(nmethod* nm);\n@@ -61,1 +61,1 @@\n-  static void nmethod_oops_do_inner(nmethod* nm, OopClosure* cl, bool defer_icache_invalidation = false);\n+  static void nmethod_oops_do_inner(nmethod* nm, OopClosure* cl);\n","filename":"src\/hotspot\/share\/gc\/z\/zNMethod.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -86,1 +86,1 @@\n-    ZNMethod::nmethod_oops_do_inner(nm, &cl, icic.deferred_invalidation());\n+    ZNMethod::nmethod_oops_do_inner(nm, &cl);\n","filename":"src\/hotspot\/share\/gc\/z\/zUnload.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -128,0 +128,2 @@\n+\n+THREAD_LOCAL bool ICacheInvalidationContext::_deferred_icache_invalidation = false;\n","filename":"src\/hotspot\/share\/runtime\/icache.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -80,0 +80,2 @@\n+  static THREAD_LOCAL bool _deferred_icache_invalidation;\n+\n@@ -91,3 +93,1 @@\n-    if (_nm != nullptr) {\n-      pd_invalidate_icache();\n-    }\n+    pd_invalidate_icache();\n@@ -96,3 +96,1 @@\n-  bool deferred_invalidation() const {\n-    return _nm != nullptr;\n-  }\n+  static bool deferred_invalidation();\n@@ -162,0 +160,3 @@\n+  inline bool ICacheInvalidationContext::deferred_invalidation() {\n+    return false;\n+  }\n","filename":"src\/hotspot\/share\/runtime\/icache.hpp","additions":7,"deletions":6,"binary":false,"changes":13,"status":"modified"}]}