{"files":[{"patch":"@@ -27,1 +27,1 @@\n-THREAD_LOCAL bool deferred_icache_invalidation = false;\n+THREAD_LOCAL ICacheInvalidationContext* current_icache_invalidation_context = nullptr;\n","filename":"src\/hotspot\/os_cpu\/linux_aarch64\/icache_linux_aarch64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -33,1 +33,1 @@\n-extern THREAD_LOCAL bool deferred_icache_invalidation;\n+extern THREAD_LOCAL ICacheInvalidationContext* current_icache_invalidation_context;\n@@ -36,2 +36,2 @@\n-   if (NeoverseN1Errata1542419) {\n-    deferred_icache_invalidation = true;\n+  if (NeoverseN1Errata1542419 && _needs_invalidation) {\n+    current_icache_invalidation_context = this;\n@@ -42,1 +42,5 @@\n-  return deferred_icache_invalidation;\n+  if (NeoverseN1Errata1542419 && current_icache_invalidation_context != nullptr) {\n+    assert(current_icache_invalidation_context->_needs_invalidation, \"ICacheInvalidationContext::deferred_invalidation must be invoked when icache invalidation is needed\");\n+    return true;\n+  }\n+  return false;\n@@ -46,2 +50,1 @@\n-  if (NeoverseN1Errata1542419) {\n-    assert(deferred_icache_invalidation, \"Deferred icache invalidation must be enabled\");\n+  if (NeoverseN1Errata1542419 && _needs_invalidation) {\n@@ -87,1 +90,1 @@\n-    deferred_icache_invalidation = false;\n+    current_icache_invalidation_context = nullptr;\n","filename":"src\/hotspot\/os_cpu\/linux_aarch64\/icache_linux_aarch64.hpp","additions":10,"deletions":7,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -75,1 +75,1 @@\n-    ICacheInvalidationContext icic;\n+    ICacheInvalidationContext icic(ZNMethod::needs_icache_invalidation(nm));\n","filename":"src\/hotspot\/share\/gc\/z\/zBarrierSetNMethod.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1439,1 +1439,1 @@\n-        ICacheInvalidationContext icic;\n+        ICacheInvalidationContext icic(ZNMethod::needs_icache_invalidation(nm));\n","filename":"src\/hotspot\/share\/gc\/z\/zGeneration.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -723,1 +723,1 @@\n-         ICacheInvalidationContext icic;\n+         ICacheInvalidationContext icic(ZNMethod::needs_icache_invalidation(nm));\n@@ -772,1 +772,6 @@\n-        ICacheInvalidationContext icic;\n+        bool needs_icache_invalidation = ZNMethod::needs_non_immediate_oops_patching(nm);\n+        if (complete_disarm && ZNMethod::needs_barrier_patching(nm)) {\n+          needs_icache_invalidation = true;\n+        }\n+\n+        ICacheInvalidationContext icic(needs_icache_invalidation);\n","filename":"src\/hotspot\/share\/gc\/z\/zMark.cpp","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -206,1 +206,1 @@\n-    ICacheInvalidationContext icic;\n+    ICacheInvalidationContext icic(needs_barrier_patching(nm));\n@@ -375,1 +375,1 @@\n-          ICacheInvalidationContext icic;\n+          ICacheInvalidationContext icic(ZNMethod::needs_non_immediate_oops_patching(nm));\n@@ -431,0 +431,12 @@\n+\n+bool ZNMethod::needs_icache_invalidation(nmethod* nm) {\n+  return needs_barrier_patching(nm) || needs_non_immediate_oops_patching(nm);\n+}\n+\n+bool ZNMethod::needs_barrier_patching(nmethod* nm) {\n+  return gc_data(nm)->barriers()->is_nonempty();\n+}\n+\n+bool ZNMethod::needs_non_immediate_oops_patching(nmethod* nm) {\n+  return gc_data(nm)->has_non_immediate_oops();\n+}\n","filename":"src\/hotspot\/share\/gc\/z\/zNMethod.cpp","additions":14,"deletions":2,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -77,0 +77,4 @@\n+\n+  static bool needs_icache_invalidation(nmethod* nm);\n+  static bool needs_barrier_patching(nmethod* nm);\n+  static bool needs_non_immediate_oops_patching(nmethod* nm);\n","filename":"src\/hotspot\/share\/gc\/z\/zNMethod.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -84,1 +84,1 @@\n-    ICacheInvalidationContext icic;\n+    ICacheInvalidationContext icic(ZNMethod::needs_non_immediate_oops_patching(nm));\n","filename":"src\/hotspot\/share\/gc\/z\/zUnload.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -78,0 +78,2 @@\n+  bool _needs_invalidation;\n+\n@@ -82,1 +84,1 @@\n-  ICacheInvalidationContext() {\n+  ICacheInvalidationContext(bool needs_invalidation) : _needs_invalidation(needs_invalidation) {\n","filename":"src\/hotspot\/share\/runtime\/icache.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"}]}