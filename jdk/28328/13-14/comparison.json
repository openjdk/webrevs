{"files":[{"patch":"@@ -68,14 +68,0 @@\n-#ifdef ASSERT\n-    if (_binding != nullptr && _binding->code() != nullptr) {\n-      nmethod *nm = _binding->code();\n-      if (!(BarrierSet::barrier_set()->barrier_set_nmethod()->is_armed(nm) ||\n-            SafepointSynchronize::is_at_safepoint() ||\n-            nm->is_unloading())) {\n-        ConditionalMutexLocker ml(NMethodState_lock, !NMethodState_lock->owned_by_self(), Mutex::_no_safepoint_check_flag);\n-        assert(nm->is_not_installed(),\n-             \"ICache invalidation context should only be used for armed \"\n-             \"or unloading or not installed nmethod or at safepoint\");\n-\n-      }\n-    }\n-#endif\n","filename":"src\/hotspot\/cpu\/aarch64\/relocInfo_aarch64.cpp","additions":0,"deletions":14,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -334,0 +334,5 @@\n+  if (code_size() == 0) {\n+    \/\/ Nothing to copy\n+    return;\n+  }\n+\n","filename":"src\/hotspot\/share\/code\/codeBlob.cpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2041,1 +2041,1 @@\n-  fix_oop_relocations(nullptr, nullptr, \/*initialize_immediates=*\/ true);\n+  fix_all_oop_relocations();\n@@ -2053,1 +2053,1 @@\n-void nmethod::fix_oop_relocations(address begin, address end, bool initialize_immediates) {\n+void nmethod::fix_all_oop_relocations() {\n@@ -2055,2 +2055,1 @@\n-  RelocIterator iter(this, begin, end);\n-  ICacheInvalidationContext icic;\n+  RelocIterator iter(this);\n@@ -2061,1 +2060,1 @@\n-      if (initialize_immediates && reloc->oop_is_immediate()) {\n+      if (reloc->oop_is_immediate()) {\n@@ -2065,1 +2064,23 @@\n-        icic.set_has_modified_code();\n+      } else {\n+        \/\/ get the oop from the pool, and re-insert it into the instruction\n+        reloc->set_value(reloc->value());\n+      }\n+    } else if (iter.type() == relocInfo::metadata_type) {\n+      metadata_Relocation* reloc = iter.metadata_reloc();\n+      reloc->fix_metadata_relocation();\n+    }\n+  }\n+}\n+\n+void nmethod::fix_non_immediate_oop_relocations() {\n+  \/\/ re-patch all oop-bearing instructions, just in case some oops moved\n+  RelocIterator iter(this);\n+  ICacheInvalidationContext icic;\n+  while (iter.next()) {\n+    bool modified_code = false;\n+    if (iter.type() == relocInfo::oop_type) {\n+      oop_Relocation* reloc = iter.oop_reloc();\n+      if (!reloc->oop_is_immediate()) {\n+        \/\/ get the oop from the pool, and re-insert it into the instruction\n+        reloc->set_value(reloc->value());\n+        modified_code = true;\n@@ -2067,2 +2088,0 @@\n-      \/\/ Refresh the oop-related bits of this instruction.\n-      modified_code = reloc->fix_oop_relocation();\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":27,"deletions":8,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -802,1 +802,0 @@\n-  void fix_oop_relocations(address begin, address end, bool initialize_immediates);\n@@ -809,2 +808,2 @@\n-  void fix_oop_relocations(address begin, address end) { fix_oop_relocations(begin, end, false); }\n-  void fix_oop_relocations()                           { fix_oop_relocations(nullptr, nullptr, false); }\n+  void fix_non_immediate_oop_relocations();\n+  void fix_all_oop_relocations();\n","filename":"src\/hotspot\/share\/code\/nmethod.hpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -593,11 +593,0 @@\n-\n-bool oop_Relocation::fix_oop_relocation() {\n-  if (!oop_is_immediate()) {\n-    \/\/ get the oop from the pool, and re-insert it into the instruction:\n-    set_value(value());\n-    return true;\n-  }\n-  return false;\n-}\n-\n-\n","filename":"src\/hotspot\/share\/code\/relocInfo.cpp","additions":0,"deletions":11,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -991,2 +991,0 @@\n-  bool fix_oop_relocation();        \/\/ reasserts oop value\n-\n","filename":"src\/hotspot\/share\/code\/relocInfo.hpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -90,1 +90,1 @@\n-  nm->fix_oop_relocations();\n+  nm->fix_non_immediate_oop_relocations();\n","filename":"src\/hotspot\/share\/gc\/g1\/g1NMethodClosure.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -64,1 +64,1 @@\n-    _nm->fix_oop_relocations();\n+    _nm->fix_non_immediate_oop_relocations();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahNMethod.inline.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -291,1 +291,1 @@\n-    nm->fix_oop_relocations();\n+    nm->fix_non_immediate_oop_relocations();\n","filename":"src\/hotspot\/share\/gc\/z\/zNMethod.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -46,1 +46,1 @@\n-    nm->fix_oop_relocations();\n+    nm->fix_non_immediate_oop_relocations();\n","filename":"src\/hotspot\/share\/memory\/iterator.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}