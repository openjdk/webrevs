{"files":[{"patch":"@@ -221,0 +221,1 @@\n+                p.onDelaySchedulerStart(this);\n@@ -232,4 +233,2 @@\n-     * 1. Process pending tasks in batches, to add or remove from heap\n-     * 2. Check for shutdown, either exiting or preparing for shutdown when empty\n-     * 3. Trigger all enabled tasks by externally submitting them to pool\n-     * 4. If active, set tentatively inactive,\n+     * 1. If apparently no work,\n+     *    if active, set tentatively inactive,\n@@ -237,0 +236,3 @@\n+     * 2. Process pending tasks in batches, to add or remove from heap\n+     * 3. Check for shutdown, either exiting or preparing for shutdown when empty\n+     * 4. Trigger all enabled tasks by submitting them to pool or run if immediate\n@@ -239,1 +241,0 @@\n-        p.onDelaySchedulerStart(this);\n@@ -243,0 +244,1 @@\n+        long parkTime = 0L;                    \/\/ zero for untimed park\n@@ -244,2 +246,13 @@\n-            ScheduledForkJoinTask<?> t; int runStatus;\n-            while (pending != null &&          \/\/ process pending tasks\n+            ScheduledForkJoinTask<?> q, t; int runStatus;\n+            if ((q = pending) == null) {\n+                restingSize = n;\n+                if (active != 0)               \/\/ deactivate and recheck\n+                    U.compareAndSetInt(this, ACTIVE, 1, 0);\n+                else {\n+                    Thread.interrupted();      \/\/ clear before park\n+                    U.park(false, parkTime);\n+                }\n+                q = pending;\n+            }\n+\n+            while (q != null &&                \/\/ process pending tasks\n@@ -250,4 +263,2 @@\n-                    next = t.nextPending;\n-                    long d = t.when;\n-                    int i = t.heapIndex, stat = t.status;\n-                    if (next != null)\n+                    int i;\n+                    if ((next = t.nextPending) != null)\n@@ -255,2 +266,2 @@\n-                    if (i >= 0) {\n-                        t.heapIndex = -1;\n+                    if ((i = t.heapIndex) >= 0) {\n+                        t.heapIndex = -1;      \/\/ remove cancelled task\n@@ -260,4 +271,5 @@\n-                    else if (stat >= 0) {\n-                        if (n >= cap || n < 0) \/\/ couldn't resize\n-                            t.trySetCancelled();\n-                        else {                 \/\/ add and sift up\n+                    else if (n >= cap || n < 0)\n+                        t.trySetCancelled();   \/\/ couldn't resize\n+                    else {\n+                        long d = t.when;       \/\/ add and sift up\n+                        if (t.status >= 0) {\n@@ -277,1 +289,1 @@\n-                                try {           \/\/ try to resize\n+                                try {          \/\/ try to resize\n@@ -282,2 +294,2 @@\n-                                    cap = newCap; \/\/ else keep using old array\n-                                    h = a;\n+                                    cap = newCap;\n+                                    h = a;     \/\/ else keep using old array\n@@ -289,0 +301,1 @@\n+                q = pending;\n@@ -291,1 +304,1 @@\n-            if ((runStatus = p.shutdownStatus(this)) != 0) {\n+            if (p != null && (runStatus = p.shutdownStatus(this)) != 0) {\n@@ -297,1 +310,1 @@\n-            long parkTime = 0L;             \/\/ zero for untimed park\n+            parkTime = 0L;\n@@ -312,1 +325,1 @@\n-                            else\n+                            else if (p != null)\n@@ -318,9 +331,0 @@\n-\n-            if (pending == null) {\n-                restingSize = n;\n-                Thread.interrupted();       \/\/ clear before park\n-                if (active == 0)\n-                    U.park(false, parkTime);\n-                else                        \/\/ deactivate and recheck\n-                    U.compareAndSetInt(this, ACTIVE, 1, 0);\n-            }\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/DelayScheduler.java","additions":36,"deletions":32,"binary":false,"changes":68,"status":"modified"}]}