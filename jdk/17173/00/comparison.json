{"files":[{"patch":"@@ -49,0 +49,1 @@\n+typedef HTHEME(__stdcall *PFNOPENTHEMEDATA)(HWND hwnd, LPCWSTR pszClassList);\n@@ -93,0 +94,1 @@\n+static PFNOPENTHEMEDATA OpenThemeDataFunc = NULL;\n@@ -112,0 +114,1 @@\n+constexpr unsigned int defaultDPI = 96;\n@@ -113,1 +116,2 @@\n-BOOL InitThemes() {\n+\n+static BOOL InitThemes() {\n@@ -119,0 +123,2 @@\n+        OpenThemeDataFunc = (PFNOPENTHEMEDATA)GetProcAddress(hModThemes,\n+                                                         \"OpenThemeData\");\n@@ -155,1 +161,1 @@\n-        if(OpenThemeDataForDpiFunc\n+        if((OpenThemeDataForDpiFunc || OpenThemeDataFunc)\n@@ -176,4 +182,6 @@\n-              constexpr unsigned int defaultDPI = 96;\n-              HTHEME hTheme = OpenThemeDataForDpiFunc (\n-                              AwtToolkit::GetInstance().GetHWnd(),\n-                              L\"Button\", defaultDPI);\n+              HTHEME hTheme = OpenThemeDataForDpiFunc\n+                              ? OpenThemeDataForDpiFunc(AwtToolkit::GetInstance().GetHWnd(),\n+                                                        L\"Button\", defaultDPI)\n+                              : OpenThemeDataFunc(AwtToolkit::GetInstance().GetHWnd(),\n+                                                  L\"Button\");\n+\n@@ -249,0 +257,1 @@\n+\n@@ -251,3 +260,4 @@\n-    HTHEME htheme = OpenThemeDataForDpiFunc(\n-                    AwtToolkit::GetInstance().GetHWnd(),\n-                    str, dpi);\n+    HTHEME htheme = OpenThemeDataForDpiFunc\n+                    ? OpenThemeDataForDpiFunc(AwtToolkit::GetInstance().GetHWnd(), str, dpi)\n+                    : OpenThemeDataFunc(AwtToolkit::GetInstance().GetHWnd(), str);\n+\n@@ -433,2 +443,0 @@\n-    rect.bottom = rectBottom;\n-    rect.right = rectRight;\n@@ -436,0 +444,7 @@\n+    if (OpenThemeDataForDpiFunc) {\n+        rect.bottom = rectBottom;\n+        rect.right = rectRight;\n+    } else {\n+        rect.bottom = h;\n+        rect.right = w;\n+    }\n@@ -458,0 +473,22 @@\n+static void rescale(SIZE *size) {\n+    static int dpiX = -1;\n+    static int dpiY = -1;\n+\n+    if (dpiX == -1 || dpiY == -1) {\n+        HWND hWnd = ::GetDesktopWindow();\n+        HDC hDC = ::GetDC(hWnd);\n+        dpiX = ::GetDeviceCaps(hDC, LOGPIXELSX);\n+        dpiY = ::GetDeviceCaps(hDC, LOGPIXELSY);\n+        ::ReleaseDC(hWnd, hDC);\n+    }\n+\n+    if (dpiX !=0 && dpiX != defaultDPI) {\n+        float invScaleX = (float) defaultDPI \/ dpiX;\n+        size->cx = (int) round(size->cx * invScaleX);\n+    }\n+    if (dpiY != 0 && dpiY != defaultDPI) {\n+        float invScaleY = (float) defaultDPI \/ dpiY;\n+        size->cy = (int) round(size->cy * invScaleY);\n+    }\n+}\n+\n@@ -749,0 +786,4 @@\n+            if (!OpenThemeDataForDpiFunc) {\n+                rescale(&size);\n+            }\n+\n","filename":"src\/java.desktop\/windows\/native\/libawt\/windows\/ThemeReader.cpp","additions":52,"deletions":11,"binary":false,"changes":63,"status":"modified"}]}