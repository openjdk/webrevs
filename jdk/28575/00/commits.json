[{"commit":{"message":"8371260: Improve scaling of downcalls using MemorySegments allocated with shared arenas\n\nMemorySegments allocated from shared Arena from\njava.lang.foreign.Arena.ofShared() have their lifecycle controlled by\njdk.internal.foreign.SharedSession. This class ensures that the\nMemorySegments can't be freed until after a thread has called\nArena.close(). This is implemented using a counter that is atomically\nincremented when used, and decremented when not used, on every invocation\nof a downcall. While shared Arenas allow any thread to use it and to\nclose it, this tracking has a cost when multiple threads are contended\non it. This patch changes the implementation to use multiple counters to\nreduce contention. sun.nio.ch.IOUtil, java.nio.Buffer and\nsun.nio.ch.SimpleAsynchronousFileChannelImpl are modified as they have\nthreads releasing the scope different from the ones that allocated them,\nso a ticket that tracks the counter has to be passed over.\n\nThe microbenchmark org.openjdk.bench.java.lang.foreign.\nCallOverheadConstant.panama_identity_memory_address_shared_3\nwas used to generate the following results. The scalability was checked\non a number of platforms with the JMH parameter \"-t\" specifying the\nnumber of threads. Measurements are in ns\/op .\n\nThe hardware are the Neoverse-N1, N2, V1 and V2, Intel Xeon 8375c and the\nAMD Epyc 9654.\n\nThreads    N1         N2            V1         V2       Xeon       Epyc\n    1      30.88      32.15      33.54      32.82      27.46       8.45\n    2     142.56     134.48     132.01     131.50     116.68      46.53\n    4     310.18     282.75     287.59     271.82     251.88      86.11\n    8     702.02     710.29     736.72     670.63     533.46     194.60\n   16   1,436.17   1,684.80   1,833.69   1,782.78   1,100.15     827.28\n   24   2,185.55   2,508.86   2,732.22   2,815.26   1,646.09   1,530.28\n   32   2,942.48   3,432.84   3,643.64   3,782.23   2,236.81   2,278.52\n   48   4,466.56   5,174.72   5,401.95   5,621.41   4,926.30   3,026.58\n\nAfter\nThreads    N1         N2            V1       V2       Xeon       Epyc\n    1      32.41      32.11      34.43    31.32      27.94       9.82\n    2      32.64      33.72      35.11    31.30      28.02       9.81\n    4      32.71      36.84      34.67    31.35      28.12      10.49\n    8      58.22      31.60      36.87    31.72      47.09      16.52\n   16      70.15      47.76      52.37    47.26      70.91      14.53\n   24      77.38      78.14      81.67    71.98      87.20      21.70\n   32      87.54      98.01      84.73    86.79     109.25      22.65\n   48     121.54     128.14     120.51   104.35     175.08      26.85"},"files":[{"filename":"src\/java.base\/share\/classes\/com\/sun\/crypto\/provider\/GaloisCounterMode.java"},{"filename":"src\/java.base\/share\/classes\/java\/lang\/ClassLoader.java"},{"filename":"src\/java.base\/share\/classes\/java\/nio\/Buffer.java"},{"filename":"src\/java.base\/share\/classes\/java\/util\/zip\/Adler32.java"},{"filename":"src\/java.base\/share\/classes\/java\/util\/zip\/CRC32.java"},{"filename":"src\/java.base\/share\/classes\/java\/util\/zip\/CRC32C.java"},{"filename":"src\/java.base\/share\/classes\/java\/util\/zip\/Deflater.java"},{"filename":"src\/java.base\/share\/classes\/java\/util\/zip\/Inflater.java"},{"filename":"src\/java.base\/share\/classes\/jdk\/internal\/access\/JavaNioAccess.java"},{"filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/ConfinedSession.java"},{"filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/GlobalSession.java"},{"filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/ImplicitSession.java"},{"filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/MemorySessionImpl.java"},{"filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/SharedResourceList.java"},{"filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/SharedSession.java"},{"filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/abi\/BindingSpecializer.java"},{"filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/abi\/DowncallLinker.java"},{"filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/abi\/fallback\/FallbackLinker.java"},{"filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/DatagramChannelImpl.java"},{"filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/IOUtil.java"},{"filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/SimpleAsynchronousFileChannelImpl.java"},{"filename":"src\/java.base\/unix\/classes\/sun\/nio\/fs\/UnixUserDefinedFileAttributeView.java"},{"filename":"src\/java.base\/windows\/classes\/sun\/nio\/ch\/WindowsAsynchronousFileChannelImpl.java"},{"filename":"src\/jdk.crypto.cryptoki\/share\/classes\/sun\/security\/pkcs11\/P11AEADCipher.java"},{"filename":"src\/jdk.crypto.cryptoki\/share\/classes\/sun\/security\/pkcs11\/P11Cipher.java"},{"filename":"src\/jdk.crypto.cryptoki\/share\/classes\/sun\/security\/pkcs11\/P11Digest.java"},{"filename":"src\/jdk.crypto.cryptoki\/share\/classes\/sun\/security\/pkcs11\/P11KeyWrapCipher.java"},{"filename":"src\/jdk.crypto.cryptoki\/share\/classes\/sun\/security\/pkcs11\/P11Mac.java"},{"filename":"src\/jdk.crypto.cryptoki\/share\/classes\/sun\/security\/pkcs11\/P11PSSSignature.java"},{"filename":"src\/jdk.crypto.cryptoki\/share\/classes\/sun\/security\/pkcs11\/P11Signature.java"},{"filename":"src\/jdk.sctp\/unix\/classes\/sun\/nio\/ch\/sctp\/SctpChannelImpl.java"},{"filename":"src\/jdk.sctp\/unix\/classes\/sun\/nio\/ch\/sctp\/SctpMultiChannelImpl.java"},{"filename":"test\/jdk\/java\/foreign\/TestMemorySession.java"}],"sha":"3f26a5b69292e106321fc729fd06deb09376eb92"}]