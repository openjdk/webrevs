{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -413,2 +413,4 @@\n-        void releaseBufferIfSubstituted() {\n-            if (buf != dst && RELEASED.compareAndSet(this, false, true)) {\n+        void releaseScopeOrCacheSubstitute() {\n+            if (buf == dst) {\n+                IOUtil.releaseScope(dst);\n+            } else if (RELEASED.compareAndSet(this, false, true)) {\n@@ -447,1 +449,1 @@\n-            if (dst instanceof DirectBuffer) {\n+            if (dst.isDirect()) {\n@@ -450,0 +452,1 @@\n+                IOUtil.acquireScope(dst, true);\n@@ -482,1 +485,1 @@\n-                    releaseBufferIfSubstituted();\n+                    releaseScopeOrCacheSubstitute();\n@@ -497,2 +500,2 @@\n-            \/\/ return direct buffer to cache if substituted\n-            releaseBufferIfSubstituted();\n+            \/\/ release direct buffer scope or return substitute to cache\n+            releaseScopeOrCacheSubstitute();\n@@ -515,2 +518,2 @@\n-                \/\/ return direct buffer to cache if substituted\n-                releaseBufferIfSubstituted();\n+                \/\/ release direct buffer scope or return substitute to cache\n+                releaseScopeOrCacheSubstitute();\n@@ -603,2 +606,4 @@\n-        void releaseBufferIfSubstituted() {\n-            if (buf != src && RELEASED.compareAndSet(this, false, true)) {\n+        void releaseScopeOrCacheSubstitute() {\n+            if (buf == src) {\n+                IOUtil.releaseScope(src);\n+            } else if (RELEASED.compareAndSet(this, false, true)) {\n@@ -627,1 +632,1 @@\n-            if (src instanceof DirectBuffer) {\n+            if (src.isDirect()) {\n@@ -630,0 +635,1 @@\n+                IOUtil.acquireScope(src, true);\n@@ -660,1 +666,1 @@\n-                releaseBufferIfSubstituted();\n+                releaseScopeOrCacheSubstitute();\n@@ -679,2 +685,2 @@\n-            \/\/ return direct buffer to cache if substituted\n-            releaseBufferIfSubstituted();\n+            \/\/ release direct buffer scope or return substitute to cache\n+            releaseScopeOrCacheSubstitute();\n@@ -693,2 +699,2 @@\n-            \/\/ return direct buffer to cache if substituted\n-            releaseBufferIfSubstituted();\n+            \/\/ release direct buffer scope or return substitute to cache\n+            releaseScopeOrCacheSubstitute();\n","filename":"src\/java.base\/windows\/classes\/sun\/nio\/ch\/WindowsAsynchronousFileChannelImpl.java","additions":23,"deletions":17,"binary":false,"changes":40,"status":"modified"}]}