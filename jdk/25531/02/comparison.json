{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -330,0 +330,5 @@\n+        if (dst.isDirect()) {\n+            IOUtil.acquireScope(dst, true);\n+            ((DirectBuffer)dst).address();\n+        }\n+\n@@ -352,0 +357,2 @@\n+                    if (dst.isDirect())\n+                        IOUtil.releaseScope(dst);\n@@ -384,0 +391,5 @@\n+        if (src.isDirect()) {\n+            IOUtil.acquireScope(src, true);\n+            ((DirectBuffer)src).address();\n+        }\n+\n@@ -406,0 +418,2 @@\n+                    if (src.isDirect())\n+                        IOUtil.releaseScope(src);\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/SimpleAsynchronousFileChannelImpl.java","additions":15,"deletions":1,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -413,2 +413,4 @@\n-        void releaseBufferIfSubstituted() {\n-            if (buf != dst && RELEASED.compareAndSet(this, false, true)) {\n+        void releaseScopeOrCacheSubstitute() {\n+            if (buf == dst) {\n+                IOUtil.releaseScope(dst);\n+            } else if (RELEASED.compareAndSet(this, false, true)) {\n@@ -447,1 +449,1 @@\n-            if (dst instanceof DirectBuffer) {\n+            if (dst.isDirect()) {\n@@ -449,0 +451,1 @@\n+                IOUtil.acquireScope(dst, true);\n@@ -452,1 +455,1 @@\n-                address = ((DirectBuffer)buf).address();\n+                address = IOUtil.bufferAddress(buf) + pos;\n@@ -482,1 +485,1 @@\n-                    releaseBufferIfSubstituted();\n+                    releaseScopeOrCacheSubstitute();\n@@ -497,2 +500,2 @@\n-            \/\/ return direct buffer to cache if substituted\n-            releaseBufferIfSubstituted();\n+            \/\/ release direct buffer scope or return substitute to cache\n+            releaseScopeOrCacheSubstitute();\n@@ -515,2 +518,2 @@\n-                \/\/ return direct buffer to cache if substituted\n-                releaseBufferIfSubstituted();\n+                \/\/ release direct buffer scope or return substitute to cache\n+                releaseScopeOrCacheSubstitute();\n@@ -603,2 +606,4 @@\n-        void releaseBufferIfSubstituted() {\n-            if (buf != src && RELEASED.compareAndSet(this, false, true)) {\n+        void releaseScopeOrCacheSubstitute() {\n+            if (buf == src) {\n+                IOUtil.releaseScope(src);\n+            } else if (RELEASED.compareAndSet(this, false, true)) {\n@@ -627,1 +632,1 @@\n-            if (src instanceof DirectBuffer) {\n+            if (src.isDirect()) {\n@@ -629,0 +634,1 @@\n+                IOUtil.acquireScope(src, true);\n@@ -637,1 +643,1 @@\n-                address = ((DirectBuffer)buf).address();\n+                address = IOUtil.bufferAddress(buf) + pos;\n@@ -660,1 +666,1 @@\n-                releaseBufferIfSubstituted();\n+                releaseScopeOrCacheSubstitute();\n@@ -679,2 +685,2 @@\n-            \/\/ return direct buffer to cache if substituted\n-            releaseBufferIfSubstituted();\n+            \/\/ release direct buffer scope or return substitute to cache\n+            releaseScopeOrCacheSubstitute();\n@@ -693,2 +699,2 @@\n-            \/\/ return direct buffer to cache if substituted\n-            releaseBufferIfSubstituted();\n+            \/\/ release direct buffer scope or return substitute to cache\n+            releaseScopeOrCacheSubstitute();\n","filename":"src\/java.base\/windows\/classes\/sun\/nio\/ch\/WindowsAsynchronousFileChannelImpl.java","additions":25,"deletions":19,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -90,0 +90,1 @@\n+        testViewsOfUnsupportedArenas(blah.toPath());\n@@ -564,0 +565,24 @@\n+    \/\/ tests unsupported MemorySegment view buffers\n+    static void testViewsOfUnsupportedArenas(Path file) throws IOException {\n+        System.out.println(\"testViewsOfUnsupportedArenas\");\n+\n+        AsynchronousFileChannel ch = AsynchronousFileChannel\n+            .open(file, CREATE, WRITE, TRUNCATE_EXISTING);\n+\n+        try {\n+            writeFully(ch, genUnsupportedBuffer(true), 0L);\n+            throw new RuntimeException(\"IllegalStateException expected\");\n+        } catch (IllegalStateException expected) {\n+            \/\/ ignore\n+        }\n+\n+        try {\n+            writeFully(ch, genUnsupportedBuffer(false), 0L);\n+            throw new RuntimeException(\"UnsupportedOperationException expected\");\n+        } catch (UnsupportedOperationException expected) {\n+            \/\/ ignore\n+        } finally {\n+            ch.close();\n+        }\n+    }\n+\n@@ -568,1 +593,2 @@\n-        return switch (rand.nextInt(3)) {\n+        rand.nextBytes(buf);\n+        return switch (rand.nextInt(4)) {\n@@ -573,1 +599,4 @@\n-            case 2 -> Arena.ofAuto().allocate(buf.length).asByteBuffer()\n+            case 2 -> Arena.global().allocate(buf.length).asByteBuffer()\n+                    .put(buf)\n+                    .flip();\n+            case 3 -> Arena.ofAuto().allocate(buf.length).asByteBuffer()\n@@ -580,0 +609,10 @@\n+    \/\/ returns ByteBuffer view of confined or shared arena\n+    static ByteBuffer genUnsupportedBuffer(boolean isConfined) {\n+        int size = 1024 + rand.nextInt(16000);\n+        byte[] buf = new byte[size];\n+        rand.nextBytes(buf);\n+        Arena arena = isConfined ? Arena.ofConfined() : Arena.ofShared();\n+        return arena.allocate(buf.length).asByteBuffer().put(buf).flip();\n+    }\n+\n+    \/\/ writes all remaining bytes in the buffer to the given channel at the\n","filename":"test\/jdk\/java\/nio\/channels\/AsynchronousFileChannel\/Basic.java","additions":42,"deletions":3,"binary":false,"changes":45,"status":"modified"}]}