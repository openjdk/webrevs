{"files":[{"patch":"@@ -26,0 +26,2 @@\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n@@ -29,2 +31,0 @@\n-import java.security.cert.*;\n-import java.util.function.Supplier;\n@@ -34,3 +34,1 @@\n- * Creates a simple usable SSLContext for SSLSocketFactory\n- * or a HttpsServer using either a given keystore or a default\n- * one in the test tree.\n+ * Utility for creating a simple usable {@link SSLContext} for testing purposes.\n@@ -38,1 +36,1 @@\n-public class SimpleSSLContext {\n+public final class SimpleSSLContext {\n@@ -40,1 +38,15 @@\n-    SSLContext ssl;\n+    private static final String DEFAULT_PROTOCOL = \"TLS\";\n+\n+    private static final String DEFAULT_KEY_STORE_FILE_REL_PATH = \"jdk\/test\/lib\/net\/testkeys\";\n+\n+    private final SSLContext ssl;\n+\n+    \/\/ Made `public` for backward compatibility\n+    public SimpleSSLContext() throws IOException {\n+        this.ssl = findSSLContext(DEFAULT_KEY_STORE_FILE_REL_PATH, DEFAULT_PROTOCOL);\n+    }\n+\n+    \/\/ Kept for backward compatibility\n+    public SimpleSSLContext(String keyStoreFileRelPath) throws IOException {\n+        this.ssl = findSSLContext(Objects.requireNonNull(keyStoreFileRelPath), DEFAULT_PROTOCOL);\n+    }\n@@ -43,2 +55,5 @@\n-     * loads default keystore from SimpleSSLContext\n-     * source directory\n+     * {@return a new {@link SSLContext} instance by searching for a key store\n+     * file path, and loading the first found one}\n+     *\n+     * @throws RuntimeException if no key store file can be found or the found\n+     * one cannot be loaded\n@@ -46,2 +61,2 @@\n-    public SimpleSSLContext() throws IOException {\n-        this(() -> \"TLS\");\n+    public static SSLContext findSSLContext() {\n+        return findSSLContext(DEFAULT_PROTOCOL);\n@@ -50,14 +65,13 @@\n-    private SimpleSSLContext(Supplier<String> protocols) throws IOException {\n-        String proto = protocols.get();\n-        String paths = System.getProperty(\"test.src.path\");\n-        StringTokenizer st = new StringTokenizer(paths, File.pathSeparator);\n-        while (st.hasMoreTokens()) {\n-            String path = st.nextToken();\n-            File f = new File(path, \"jdk\/test\/lib\/net\/testkeys\");\n-            if (f.exists()) {\n-                try (FileInputStream fis = new FileInputStream(f)) {\n-                    init(fis, proto);\n-                    break;\n-                }\n-            }\n-        }\n+    \/**\n+     * {@return a new {@link SSLContext} instance by searching for a key store\n+     * file path, and loading the first found one}\n+     *\n+     * @param protocol an {@link SSLContext} protocol\n+     *\n+     * @throws NullPointerException if {@code protocol} is null\n+     * @throws RuntimeException if no key store file can be found or the found\n+     * one cannot be loaded\n+     *\/\n+    public static SSLContext findSSLContext(String protocol) {\n+        Objects.requireNonNull(protocol);\n+        return findSSLContext(DEFAULT_KEY_STORE_FILE_REL_PATH, protocol);\n@@ -67,1 +81,11 @@\n-     * loads default keystore from given directory\n+     * {@return a new {@link SSLContext} instance by searching for a key store\n+     * file path, and loading the first found one}\n+     *\n+     * @param keyStoreFileRelPath a key store file path to be concatenated with\n+     *                            the search path(s) obtained from the\n+     *                            {@code test.src.path} system property\n+     * @param protocol an {@link SSLContext} protocol\n+     *\n+     * @throws NullPointerException if {@code keyStoreFileRelPath} or {@code protocol} is null\n+     * @throws RuntimeException if no key store file can be found or the found\n+     * one cannot be loaded\n@@ -69,4 +93,9 @@\n-    public SimpleSSLContext(String dir) throws IOException {\n-        String file = dir + \"\/testkeys\";\n-        try (FileInputStream fis = new FileInputStream(file)) {\n-            init(fis, \"TLS\");\n+    public static SSLContext findSSLContext(String keyStoreFileRelPath, String protocol) {\n+        Objects.requireNonNull(keyStoreFileRelPath);\n+        Objects.requireNonNull(protocol);\n+        var sourcePaths = System.getProperty(\"test.src.path\");\n+        for (var sourcePath : Collections.list(new StringTokenizer(sourcePaths, File.pathSeparator))) {\n+            var keyStoreFileAbsPath = Path.of((String) sourcePath, keyStoreFileRelPath);\n+            if (Files.exists(keyStoreFileAbsPath)) {\n+                return loadSSLContext(keyStoreFileAbsPath, protocol);\n+            }\n@@ -74,0 +103,3 @@\n+        throw new RuntimeException(\n+                \"Could not find any key store at source path(s) '%s' using key store file relative path '%s'\".formatted(\n+                        sourcePaths, keyStoreFileRelPath));\n@@ -76,2 +108,11 @@\n-    private void init(InputStream i, String protocol) throws IOException {\n-        try {\n+    \/**\n+     * {@return a new {@link SSLContext} loaded from the provided key store file\n+     * path using the given protocol}\n+     *\n+     * @param keyStoreFilePath a {@link KeyStore} file path\n+     * @param protocol an {@link SSLContext} protocol\n+     *\n+     * @throws RuntimeException if loading fails\n+     *\/\n+    private static SSLContext loadSSLContext(Path keyStoreFilePath, String protocol) {\n+        try (var storeStream = Files.newInputStream(keyStoreFilePath)) {\n@@ -80,1 +121,1 @@\n-            ks.load(i, passphrase);\n+            ks.load(storeStream, passphrase);\n@@ -88,6 +129,7 @@\n-            ssl = SSLContext.getInstance(protocol);\n-            ssl.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);\n-        } catch (KeyManagementException | KeyStoreException |\n-                UnrecoverableKeyException | CertificateException |\n-                NoSuchAlgorithmException e) {\n-            throw new RuntimeException(e.getMessage());\n+            var sslContext = SSLContext.getInstance(protocol);\n+            sslContext.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);\n+            return sslContext;\n+        } catch (Exception e) {\n+            var message = \"Failed loading 'SSLContext' from key store at location '%s' for protocol '%s'\".formatted(\n+                    keyStoreFilePath, protocol);\n+            throw new RuntimeException(message, e);\n@@ -97,0 +139,1 @@\n+    \/\/ Kept for backward compatibility\n@@ -98,5 +141,6 @@\n-        if(protocol == null || protocol.isEmpty()) {\n-            return new SimpleSSLContext().get();\n-        }\n-        else {\n-            return new SimpleSSLContext(() -> protocol).get();\n+        try {\n+            return protocol == null || protocol.isEmpty()\n+                    ? findSSLContext()\n+                    : findSSLContext(protocol);\n+        } catch (RuntimeException re) {\n+            throw new IOException(re);\n@@ -106,0 +150,1 @@\n+    \/\/ Kept for backward compatibility\n@@ -109,0 +154,1 @@\n+\n","filename":"test\/lib\/jdk\/test\/lib\/net\/SimpleSSLContext.java","additions":90,"deletions":44,"binary":false,"changes":134,"status":"modified"}]}