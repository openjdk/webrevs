{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -998,0 +998,2 @@\n+    gdata->jvmti_data_dump = JNI_FALSE;\n+\n@@ -1162,0 +1164,9 @@\n+        } else if (strcmp(buf, \"datadump\") == 0) {\n+          \/\/ Allow enabling of JVMTI DATA_DUMP_REQUEST support.\n+          \/\/ This is not a documented flag. This feature is only intended to be used\n+          \/\/ by debug agent developers. It is advised that you launch the debuggee\n+          \/\/ with -XX:+StartAttachListener. Otherwise the attach listener may fail to\n+          \/\/ startup due to the Signal Dispatcher thread being suspended due to an event.\n+          if ( !get_boolean(&str, &(gdata->jvmti_data_dump)) ) {\n+                goto syntax_error;\n+            }\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/debugInit.c","additions":12,"deletions":1,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2001, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -1390,3 +1390,1 @@\n-\/***** debugging *****\/\n-\n-#ifdef DEBUG\n+\/***** APIs for debugging the debug agent *****\/\n@@ -1479,2 +1477,0 @@\n-\n-#endif \/* DEBUG *\/\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/eventFilter.c","additions":2,"deletions":6,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2001, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -79,1 +79,1 @@\n-\/***** debugging *****\/\n+\/***** APIs for debugging the debug agent *****\/\n@@ -81,1 +81,0 @@\n-#ifdef DEBUG\n@@ -83,1 +82,0 @@\n-#endif\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/eventFilter.h","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -1333,0 +1333,11 @@\n+\/* Event callback for JVMTI_EVENT_DATA_DUMP_REQUEST *\/\n+static void JNICALL\n+cbDataDump(jvmtiEnv *jvmti_env)\n+{\n+    tty_message(\"Debug Agent Data Dump\");\n+    tty_message(\"=== START DUMP ===\");\n+    threadControl_dumpAllThreads();\n+    eventHandler_dumpAllHandlers(JNI_TRUE);\n+    tty_message(\"=== END DUMP ===\");\n+}\n+\n@@ -1521,0 +1532,13 @@\n+\n+    \/*\n+     * DATA_DUMP_REQUEST is special since it is not tied to any handlers or an EI,\n+     * so it cannot be setup using threadControl_setEventMode(). Use JVMTI API directly.\n+     *\/\n+    if (gdata->jvmti_data_dump) {\n+        error = JVMTI_FUNC_PTR(gdata->jvmti,SetEventNotificationMode)\n+                (gdata->jvmti, JVMTI_ENABLE, JVMTI_EVENT_DATA_DUMP_REQUEST, NULL);\n+        if (error != JVMTI_ERROR_NONE) {\n+            EXIT_ERROR(error,\"Can't enable data dump request events\");\n+        }\n+    }\n+\n@@ -1583,0 +1607,2 @@\n+    \/* Event callback for JVMTI_EVENT_DATA_DUMP_REQUEST *\/\n+    gdata->callbacks.DataDumpRequest = &cbDataDump;\n@@ -1842,3 +1868,1 @@\n-\/***** debugging *****\/\n-\n-#ifdef DEBUG\n+\/***** APIs for debugging the debug agent *****\/\n@@ -1883,2 +1907,0 @@\n-\n-#endif \/* DEBUG *\/\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/eventHandler.c","additions":28,"deletions":6,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -85,1 +85,1 @@\n-\/***** debugging *****\/\n+\/***** APIs for debugging the debug agent *****\/\n@@ -87,1 +87,0 @@\n-#ifdef DEBUG\n@@ -91,1 +90,0 @@\n-#endif\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/eventHandler.h","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -140,5 +140,0 @@\n-#ifdef DEBUG\n-static void dumpThreadList(ThreadList *list);\n-static void dumpThread(ThreadNode *node);\n-#endif\n-\n@@ -2559,1 +2554,1 @@\n-\/***** debugging *****\/\n+\/***** APIs for debugging the debug agent *****\/\n@@ -2561,1 +2556,2 @@\n-#ifdef DEBUG\n+static void dumpThreadList(ThreadList *list);\n+static void dumpThread(ThreadNode *node);\n@@ -2566,0 +2562,1 @@\n+    tty_message(\"suspendAllCount: %d\", suspendAllCount);\n@@ -2650,2 +2647,0 @@\n-\n-#endif \/* DEBUG *\/\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/threadControl.c","additions":4,"deletions":9,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -79,1 +79,1 @@\n-\/***** debugging *****\/\n+\/***** APIs for debugging the debug agent *****\/\n@@ -81,1 +81,0 @@\n-#ifdef DEBUG\n@@ -84,1 +83,0 @@\n-#endif\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/threadControl.h","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1987,2 +1987,0 @@\n-#ifdef DEBUG\n-\n@@ -2043,2 +2041,0 @@\n-#endif\n-\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/util.c","additions":0,"deletions":4,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -93,0 +93,1 @@\n+    jboolean jvmti_data_dump; \/* If true, then support JVMTI DATA_DUMP_REQUEST events. *\/\n@@ -392,1 +393,0 @@\n-#ifdef DEBUG\n@@ -394,1 +394,0 @@\n-#endif\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/util.h","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,176 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.Map;\n+\n+import jdk.test.lib.dcmd.PidJcmdExecutor;\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+\n+import com.sun.jdi.Bootstrap;\n+import com.sun.jdi.ClassType;\n+import com.sun.jdi.VirtualMachine;\n+import com.sun.jdi.VMDisconnectedException;\n+import com.sun.jdi.connect.AttachingConnector;\n+import com.sun.jdi.connect.Connector;\n+import com.sun.jdi.connect.IllegalConnectorArgumentsException;\n+import com.sun.jdi.event.ClassPrepareEvent;\n+import com.sun.jdi.event.Event;\n+import com.sun.jdi.event.EventSet;\n+import com.sun.jdi.request.EventRequest;\n+import com.sun.jdi.request.ClassPrepareRequest;\n+\/**\n+ * @test\n+ * @bug  8332488\n+ * @summary Unit test for testing debug agent support for JVMTI.data_dump jcmd.\n+ *\n+ * @library \/test\/lib\n+ * @modules jdk.jdi\n+ * @build DataDumpTest\n+ * @run main\/othervm\/timeout=15 DataDumpTest\n+ *\/\n+\n+class DataDumpTestTarg {\n+    public static void main(String args[]) throws Exception {\n+        \/\/ Write something that can be read by the driver\n+        System.out.println(\"Debuggee started\");\n+    }\n+}\n+\n+public class DataDumpTest {\n+\n+    public static void main(String[] args) throws Exception {\n+        System.out.println(\"Test 1: Debuggee start with datadump=y\");\n+        runTest(\"-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,datadump=y\");\n+    }\n+\n+    private static void sleep(long ms) {\n+        try {\n+            Thread.sleep(ms);\n+        } catch (InterruptedException e) {\n+        }\n+    }\n+\n+    private static void runTest(String jdwpArg) throws Exception {\n+        ProcessBuilder pb = ProcessTools.createTestJavaProcessBuilder(\n+                jdwpArg,\n+                \/\/ Probably not required by this test, but best to include when using datadump\n+                \"-XX:+StartAttachListener\",\n+                \"DataDumpTestTarg\");\n+        Process p = null;\n+        OutputAnalyzer out = null;\n+        try {\n+            p = pb.start();\n+            InputStream is = p.getInputStream();\n+            out = new OutputAnalyzer(p);\n+\n+            \/\/ Attach a debugger and do the data dump. The data dump output will appear\n+            \/\/ in the debuggee output.\n+            attachAndDump(p.pid());\n+\n+            out.waitFor(); \/\/ Wait for the debuggee to exit\n+\n+            System.out.println(\"Deuggee output:\");\n+            System.out.println(out.getOutput());\n+\n+            \/\/ All these strings are part of the debug agent data dump output.\n+            out.shouldHaveExitValue(0);\n+            out.shouldContain(\"Debuggee started\");\n+            out.shouldContain(\"Debug Agent Data Dump\");\n+            out.shouldContain(\"suspendAllCount: 0\");\n+            out.shouldContain(\"ClassMatch: classPattern(DataDumpTestTarg)\");\n+            out.shouldContain(\"Handlers for EI_VM_DEATH\");\n+        } finally {\n+            if (p != null) {\n+                p.destroyForcibly();\n+            }\n+        }\n+    }\n+\n+    private static void attachAndDump(long pid) throws IOException,\n+            IllegalConnectorArgumentsException {\n+        \/\/ Get the ProcessAttachingConnector, which can attach using the pid of the debuggee.\n+        AttachingConnector ac = Bootstrap.virtualMachineManager().attachingConnectors()\n+                .stream()\n+                .filter(c -> c.name().equals(\"com.sun.jdi.ProcessAttach\"))\n+                .findFirst()\n+                .orElseThrow(() -> new RuntimeException(\"Unable to locate ProcessAttachingConnector\"));\n+\n+        \/\/ Set the connector's \"pid\" argument to the pid of the debuggee.\n+        Map<String, Connector.Argument> args = ac.defaultArguments();\n+        Connector.StringArgument arg = (Connector.StringArgument)args.get(\"pid\");\n+        arg.setValue(\"\" + pid);\n+\n+        \/\/ Attach to the debuggee.\n+        System.out.println(\"Debugger is attaching to: \" + pid + \" ...\");\n+        VirtualMachine vm = ac.attach(args);\n+\n+        \/\/ List all threads as a sanity check.\n+        System.out.println(\"Attached! Now listing threads ...\");\n+        vm.allThreads().stream().forEach(System.out::println);\n+\n+        \/\/ Request VM to trigger ClassPrepareRequest when DataDumpTestTarg class is prepared.\n+        ClassPrepareRequest classPrepareRequest = vm.eventRequestManager().createClassPrepareRequest();\n+        classPrepareRequest.addClassFilter(\"DataDumpTestTarg\");\n+        \/\/ Don't use SUSPEND_ALL here. That might prevent the data dump because the\n+        \/\/ Signal Dispatcher and Attach Listener threads will be suspended, and they\n+        \/\/ may be needed by the jcmd support.\n+        classPrepareRequest.setSuspendPolicy(EventRequest.SUSPEND_EVENT_THREAD);\n+        classPrepareRequest.enable();\n+\n+        try {\n+            while (true) { \/\/ Exit when we get VMDisconnectedException\n+                EventSet eventSet = vm.eventQueue().remove();\n+                if (eventSet == null) {\n+                    continue;\n+                }\n+                for (Event event : eventSet) {\n+                    System.out.println(\"Received event: \" + event);\n+                    if (event instanceof ClassPrepareEvent) {\n+                        ClassPrepareEvent evt = (ClassPrepareEvent) event;\n+                        ClassType classType = (ClassType) evt.referenceType();\n+\n+                        \/\/ Run JVMTI.data_dump jcmd.\n+                        OutputAnalyzer out = new PidJcmdExecutor(\"\" + pid).execute(\"JVMTI.data_dump\");\n+                        out.waitFor();\n+\n+                        \/\/ Verify the output of the jcmd. Note the actual dump is in the debuggee\n+                        \/\/ output, not in the jcmd output, so we don't check it here.\n+                        System.out.println(\"JVMTI.data_dump output:\");\n+                        System.out.println(out.getOutput());\n+                        out.shouldContain(\"Command executed successfully\");\n+                        out.shouldHaveExitValue(0);\n+                    }\n+                }\n+                eventSet.resume();\n+            }\n+        } catch (VMDisconnectedException e) {\n+            System.out.println(\"VM is now disconnected.\");\n+        } catch (Exception e) {\n+            e.printStackTrace();\n+            throw new RuntimeException(e);\n+        }\n+    }\n+}\n","filename":"test\/jdk\/com\/sun\/jdi\/DataDumpTest.java","additions":176,"deletions":0,"binary":false,"changes":176,"status":"added"}]}