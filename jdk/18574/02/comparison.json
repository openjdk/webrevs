{"files":[{"patch":"@@ -1681,1 +1681,0 @@\n-  JvmtiVTMSTransitionDisabler disabler;\n@@ -1684,1 +1683,0 @@\n-\n@@ -1687,1 +1685,0 @@\n-    ThreadsListHandle tlh(current_thread);\n@@ -1690,16 +1687,0 @@\n-    JavaThread *java_thread;\n-    oop thread_obj = nullptr;\n-    err = get_threadOop_and_JavaThread(tlh.list(), thread, &java_thread, &thread_obj);\n-    if (err != JVMTI_ERROR_NONE) {\n-      return err;\n-    }\n-\n-    if (java_lang_VirtualThread::is_instance(thread_obj) && java_thread == nullptr) {\n-      \/\/ Target virtual thread is unmounted.\n-      ResourceMark rm(current_thread);\n-      MultipleStackTracesCollector collector(this, max_frame_count);\n-      collector.fill_frames(thread, java_thread, thread_obj);\n-      collector.allocate_and_fill_stacks(\/* thread_count *\/ 1);\n-      *stack_info_ptr = collector.stack_info();\n-      return collector.result();\n-    }\n@@ -1708,1 +1689,1 @@\n-    Handshake::execute(&op, &tlh, java_thread);\n+    JvmtiHandshake::execute(&op, thread);\n@@ -1714,0 +1695,2 @@\n+    JvmtiVTMSTransitionDisabler disabler;\n+\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnv.cpp","additions":3,"deletions":20,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -2056,2 +2056,2 @@\n-GetSingleStackTraceClosure::do_thread(Thread *target) {\n-  JavaThread *jt = JavaThread::cast(target);\n+GetSingleStackTraceClosure::doit() {\n+  JavaThread *jt = _target_jt;\n@@ -2060,1 +2060,1 @@\n-  if (!jt->is_exiting() && thread_oop != nullptr) {\n+  if ((jt == nullptr || !jt->is_exiting()) && thread_oop != nullptr) {\n@@ -2064,0 +2064,1 @@\n+    set_result(_collector.result());\n@@ -2067,0 +2068,12 @@\n+void\n+GetSingleStackTraceClosure::do_thread(Thread *target) {\n+  assert(_target_jt == JavaThread::cast(target), \"sanity check\");\n+  doit();\n+}\n+\n+void\n+GetSingleStackTraceClosure::do_vthread(Handle target_h) {\n+  assert(_target_jt == nullptr || _target_jt->vthread() == target_h(), \"sanity check\");\n+  doit();\n+}\n+\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":16,"deletions":3,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -727,1 +727,1 @@\n-class GetSingleStackTraceClosure : public HandshakeClosure {\n+class GetSingleStackTraceClosure : public JvmtiUnitedHandshakeClosure {\n@@ -736,1 +736,1 @@\n-    : HandshakeClosure(\"GetSingleStackTrace\"),\n+    : JvmtiUnitedHandshakeClosure(\"GetSingleStackTrace\"),\n@@ -742,0 +742,2 @@\n+  void do_vthread(Handle target_h);\n+  void doit();\n@@ -743,1 +745,1 @@\n-  jvmtiError result()             { return _collector.result(); }\n+  jvmtiError result()             { return _result; }\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.hpp","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"}]}