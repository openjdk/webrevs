{"files":[{"patch":"@@ -1539,1 +1539,1 @@\n-                      __ z_afi(lreg, java_negate(c));\n+                      __ add2reg_32(lreg, java_negate(c));\n","filename":"src\/hotspot\/cpu\/s390\/c1_LIRAssembler_s390.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -660,1 +660,1 @@\n-      z_lgr(r1, r2);\n+      lgr_if_needed(r1, r2);\n@@ -684,1 +684,1 @@\n-void MacroAssembler::add2reg_32(Register r1, int64_t imm) {\n+void MacroAssembler::add2reg_32(Register r1, int64_t imm, Register r2) {\n@@ -687,2 +687,6 @@\n-  if (Immediate::is_simm16(imm)) {\n-    z_ahi(r1, imm);\n+  if (r2 == noreg) { r2 = r1; }\n+\n+  \/\/ Handle special case imm == 0.\n+  if (imm == 0) {\n+    lr_if_needed(r1, r2);\n+    \/\/ Nothing else to do.\n@@ -691,0 +695,32 @@\n+\n+  if (!PreferLAoverADD || (r2 == Z_R0)) {\n+    bool distinctOpnds = VM_Version::has_DistinctOpnds();\n+\n+    if (Immediate::is_simm16(imm)) {\n+      if (r1 == r2){\n+        z_ahi(r1, imm);\n+        return;\n+      }\n+      if (distinctOpnds) {\n+        z_ahik(r1, r2, imm);\n+        return;\n+      }\n+      lr_if_needed(r1, r2);\n+      z_ahi(r1, imm);\n+      return;\n+    }\n+  } else {\n+    \/\/ Can we encode imm in 12 bits unsigned?\n+    if (Displacement::is_shortDisp(imm)) {\n+      z_la(r1, imm, r2);\n+      return;\n+    }\n+    \/\/ Can we encode imm in 20 bits signed?\n+    if (Displacement::is_validDisp(imm)) {\n+      \/\/ Always use LAY instruction, so we don't need the tmp register.\n+      z_lay(r1, imm, r2);\n+      return;\n+    }\n+\n+  }\n+\n@@ -692,0 +728,1 @@\n+  lr_if_needed(r1, r2);\n","filename":"src\/hotspot\/cpu\/s390\/macroAssembler_s390.cpp","additions":41,"deletions":4,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -160,1 +160,1 @@\n-  void add2reg_32(Register r1, int64_t imm);\n+  void add2reg_32(Register r1, int64_t imm, Register r2 = noreg);\n","filename":"src\/hotspot\/cpu\/s390\/macroAssembler_s390.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}