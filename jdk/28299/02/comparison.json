{"files":[{"patch":"@@ -7477,2 +7477,1 @@\n-Node * LibraryCallKit::get_key_start_from_aescrypt_object(Node *aescrypt_object) {\n-#if defined(PPC64) || defined(S390) || defined(RISCV64)\n+Node* LibraryCallKit::get_key_start_from_aescrypt_object(Node* aescrypt_object) {\n@@ -7482,7 +7481,3 @@\n-  \/\/ The ppc64 and riscv64 stubs of encryption and decryption use the same round keys (sessionK[0]).\n-  Node* objSessionK = load_field_from_object(aescrypt_object, \"sessionK\", \"[[I\");\n-  assert (objSessionK != nullptr, \"wrong version of com.sun.crypto.provider.AES_Crypt\");\n-  if (objSessionK == nullptr) {\n-    return (Node *) nullptr;\n-  }\n-  Node* objAESCryptKey = load_array_element(objSessionK, intcon(0), TypeAryPtr::OOPS, \/* set_ctrl *\/ true);\n+  \/\/ The following platform specific stubs of encryption and decryption use the same round keys.\n+#if defined(PPC64) || defined(S390) || defined(RISCV64)\n+  const char* key_name = \"sessionKe\";\n@@ -7490,3 +7485,4 @@\n-  Node* objAESCryptKey = load_field_from_object(aescrypt_object, \"K\", \"[I\");\n-#endif \/\/ PPC64\n-  assert (objAESCryptKey != nullptr, \"wrong version of com.sun.crypto.provider.AES_Crypt\");\n+  const char* key_name = \"K\";\n+#endif\n+  Node* objAESCryptKey = load_field_from_object(aescrypt_object, key_name, \"[I\");\n+  assert(objAESCryptKey != nullptr, \"wrong version of com.sun.crypto.provider.AES_Crypt\");\n","filename":"src\/hotspot\/share\/opto\/library_call.cpp","additions":8,"deletions":12,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -57,5 +57,6 @@\n-    \/\/ Following two attributes are specific to Intrinsics where sessionK is\n-    \/\/ used for PPC64, S390, and RISCV64 architectures, whereas K is used for\n-    \/\/ everything else.\n-    private int[][] sessionK = null;\n-    private int[] K = null;\n+    \/\/ Following attributes (sessionKe and K) are specific to Intrinsics, where\n+    \/\/ sessionKe is the unprocessed key that is used for PPC64, S390 and\n+    \/\/ RISCV64 architectures, whereas K is used for everything else.\n+    private int[] sessionKe = null; \/\/ key for encryption\n+    private int[] sessionKd = null; \/\/ preprocessed key for decryption\n+    private int[] K = null; \/\/ preprocessed key in case of decryption\n@@ -907,1 +908,0 @@\n-        int decrypt = decrypting ? 1 : 0;\n@@ -923,0 +923,1 @@\n+\n@@ -924,5 +925,7 @@\n-            if (sessionK == null) {\n-                sessionK = new int[2][];\n-            } else {\n-                Arrays.fill(sessionK[0], 0);\n-                Arrays.fill(sessionK[1], 0);\n+            if (sessionKe != null) {\n+                Arrays.fill(sessionKe, 0);\n+            }\n+            sessionKe = genRoundKeys(key, rounds);\n+            if (sessionKd != null) {\n+                Arrays.fill(sessionKd, 0);\n+                sessionKd = null;\n@@ -930,2 +933,0 @@\n-            sessionK[0] = genRoundKeys(key, rounds);\n-            sessionK[1] = genInvRoundKeys(sessionK[0], rounds);\n@@ -937,1 +938,9 @@\n-        K = sessionK[decrypt];\n+\n+        if (decrypting) {\n+            if (sessionKd == null) {\n+                sessionKd = genInvRoundKeys(sessionKe, rounds);\n+            }\n+            K = sessionKd;\n+        } else {\n+            K = sessionKe;\n+        }\n","filename":"src\/java.base\/share\/classes\/com\/sun\/crypto\/provider\/AES_Crypt.java","additions":23,"deletions":14,"binary":false,"changes":37,"status":"modified"}]}