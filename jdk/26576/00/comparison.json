{"files":[{"patch":"@@ -103,5 +103,5 @@\n-    private Reference<AccelSurface> validSrcDataRef = new WeakReference<>(null);\n-    private Reference<AccelSurface> validDstDataRef = new WeakReference<>(null);\n-    private Reference<Region> validClipRef = new WeakReference<>(null);\n-    private Reference<Composite> validCompRef = new WeakReference<>(null);\n-    private Reference<Paint> validPaintRef = new WeakReference<>(null);\n+    private Reference<AccelSurface> validSrcDataRef = null;\n+    private Reference<AccelSurface> validDstDataRef = null;\n+    private Reference<Region> validClipRef = null;\n+    private Reference<Composite> validCompRef = null;\n+    private Reference<Paint> validPaintRef = null;\n@@ -216,1 +216,1 @@\n-        } else if (validPaintRef.get() != paint) {\n+        } else if (stateChanged(validPaintRef, paint)) {\n@@ -223,5 +223,3 @@\n-        final AccelSurface validatedSrcData = validSrcDataRef.get();\n-        final AccelSurface validatedDstData = validDstDataRef.get();\n-        if ((currentContext != this) ||\n-            (srcData != validatedSrcData) ||\n-            (dstData != validatedDstData))\n+        final boolean srcChanged = stateChanged(validSrcDataRef, srcData);\n+        final boolean dstChanged = stateChanged(validDstDataRef, dstData);\n+        if ((currentContext != this) || srcChanged || dstChanged)\n@@ -229,1 +227,1 @@\n-            if (dstData != validatedDstData) {\n+            if (dstChanged) {\n@@ -246,2 +244,2 @@\n-            validSrcDataRef = new WeakReference<>(srcData);\n-            validDstDataRef = new WeakReference<>(dstData);\n+            validSrcDataRef = wrapState(srcData);\n+            validDstDataRef = wrapState(dstData);\n@@ -251,2 +249,2 @@\n-        final Region validatedClip = validClipRef.get();\n-        if ((clip != validatedClip) || updateClip) {\n+        final Region validatedClip = validClipRef == null ? null : validClipRef.get();\n+        if (stateChanged(validClipRef, clip) || updateClip) {\n@@ -267,1 +265,1 @@\n-            validClipRef = new WeakReference<>(clip);\n+            validClipRef = wrapState(clip);\n@@ -273,1 +271,1 @@\n-        if ((comp != validCompRef.get()) || (flags != validatedFlags)) {\n+        if (stateChanged(validCompRef, comp) || (flags != validatedFlags)) {\n@@ -282,1 +280,1 @@\n-            validCompRef = new WeakReference<>(comp);\n+            validCompRef = wrapState(comp);\n@@ -316,1 +314,1 @@\n-            validPaintRef = new WeakReference<>(paint);\n+            validPaintRef = wrapState(paint);\n@@ -324,0 +322,12 @@\n+    private static <T> boolean stateChanged(Reference<T> ref, T obj) {\n+        \/\/ null ref means \"true\" null object\n+        if (ref == null) return obj != null;\n+        T old = ref.get();\n+        \/\/ null ref value means the object was GC'ed, return true in that case\n+        return old == null || old != obj;\n+    }\n+\n+    private static <T> Reference<T> wrapState(T obj) {\n+        return obj == null ? null : new WeakReference<>(obj);\n+    }\n+\n@@ -437,5 +447,5 @@\n-        validSrcDataRef.clear();\n-        validDstDataRef.clear();\n-        validCompRef.clear();\n-        validClipRef.clear();\n-        validPaintRef.clear();\n+        validSrcDataRef = null;\n+        validDstDataRef = null;\n+        validCompRef = null;\n+        validClipRef = null;\n+        validPaintRef = null;\n","filename":"src\/java.desktop\/share\/classes\/sun\/java2d\/pipe\/BufferedContext.java","additions":35,"deletions":25,"binary":false,"changes":60,"status":"modified"}]}