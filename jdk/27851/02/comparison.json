{"files":[{"patch":"@@ -36,0 +36,1 @@\n+import java.security.NoSuchAlgorithmException;\n@@ -38,0 +39,1 @@\n+import java.security.UnrecoverableEntryException;\n@@ -224,1 +226,1 @@\n-        if ((firstDot == -1) || (secondDot == firstDot)) {\n+        if ((firstDot == -1) || (secondDot == -1)) {\n@@ -243,2 +245,9 @@\n-        } catch (Exception e) {\n-            \/\/ ignore\n+        } catch (UnrecoverableEntryException |\n+                 KeyStoreException |\n+                 NumberFormatException |\n+                 NoSuchAlgorithmException |\n+                 IndexOutOfBoundsException e) {\n+            \/\/ ignore and only log exception\n+            if (SSLLogger.isOn && SSLLogger.isOn(\"keymanager\")) {\n+                SSLLogger.warning(\"KeyMgr: exception triggered: \" + e);\n+            }\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/X509KeyManagerImpl.java","additions":12,"deletions":3,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug 6302126 6302321 6302271 6302304\n+ * @bug 6302126 6302321 6302271 6302304 8369995\n@@ -35,0 +35,7 @@\n+ *     Extra logging and\/or propagate errors in X509KeyManagerImpl\n+ *\n+ * @library \/test\/lib \/test\/jdk\/java\/net\/httpclient\/lib\n+ * @modules java.base\/sun.security.x509\n+ *\n+ * @run junit NullCases\n+ * @run junit\/othervm -Djavax.net.debug=ssl:keymanager -Darg=debug NullCases\n@@ -36,4 +43,16 @@\n-import java.io.*;\n-import java.net.*;\n-import java.security.*;\n-import javax.net.ssl.*;\n+\n+import jdk.test.lib.Asserts;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+\n+import javax.net.ssl.KeyManagerFactory;\n+import javax.net.ssl.X509KeyManager;\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.security.KeyPair;\n+import java.security.SecureRandom;\n+import java.security.KeyStore;\n+import java.security.PrivateKey;\n+import java.security.cert.Certificate;\n@@ -42,1 +61,3 @@\n-import java.util.*;\n+import static jdk.httpclient.test.lib.common.DynamicKeyStoreUtil.generateCert;\n+import static jdk.httpclient.test.lib.common.DynamicKeyStoreUtil.generateKeyStore;\n+import static jdk.httpclient.test.lib.common.DynamicKeyStoreUtil.generateRSAKeyPair;\n@@ -46,4 +67,9 @@\n-    public static void main(String[] args) throws Exception {\n-        KeyManagerFactory kmf;\n-        X509KeyManager km;\n-        char [] password = {' '};\n+    private static boolean isDebug;\n+    private static KeyManagerFactory kmf;\n+    private static X509KeyManager km;\n+    private final PrintStream initialErrStream = System.err;\n+\n+    @BeforeAll\n+    public static void beforeAll() throws Exception {\n+        final String arg = System.getProperty(\"arg\");\n+        isDebug = arg != null && arg.equals(\"debug\");\n@@ -51,1 +77,0 @@\n-        \/\/ check for bug 6302126\n@@ -53,1 +78,0 @@\n-        kmf.init((KeyStore)null, password);\n@@ -55,1 +79,9 @@\n-        \/\/ check for 6302321\n+        \/\/ creating a new keystore\n+        final SecureRandom secureRandom = new SecureRandom();\n+        final KeyPair keyPair = generateRSAKeyPair(secureRandom);\n+        final X509Certificate originServerCert = generateCert(keyPair, secureRandom,\n+                \"subject\");\n+        final KeyStore ks = generateKeyStore(keyPair.getPrivate(),\n+                new Certificate[]{originServerCert});\n+\n+        kmf.init(ks, null);\n@@ -57,5 +89,18 @@\n-        X509Certificate[] certs = km.getCertificateChain(\"doesnotexist\");\n-        PrivateKey priv = km.getPrivateKey(\"doesnotexist\");\n-        if (certs != null || priv != null) {\n-            throw new Exception(\"Should return null if the alias can't be found\");\n-        }\n+    }\n+\n+    private X509KeyManager generateNullKm() throws Exception {\n+        char[] password = {' '};\n+        kmf.init((KeyStore) null, password);\n+        return (X509KeyManager) kmf.getKeyManagers()[0];\n+    }\n+\n+    @Test\n+    public void JDK6302126Test() throws Exception {\n+        \/\/ check for bug 6302126\n+        generateNullKm();\n+    }\n+\n+    @Test\n+    public void JDK6302304Test() throws Exception {\n+        \/\/ check for bug 6302304\n+        final X509KeyManager km = generateNullKm();\n@@ -63,11 +108,0 @@\n-        \/\/ check for 6302271\n-        String[] clis = km.getClientAliases(\"doesnotexist\", null);\n-        if (clis != null && clis.length == 0) {\n-            throw new Exception(\"Should return null instead of empty array\");\n-        }\n-        String[] srvs = km.getServerAliases(\"doesnotexist\", null);\n-        if (srvs != null && srvs.length == 0) {\n-            throw new Exception(\"Should return null instead of empty array\");\n-        }\n-\n-        \/\/ check for 6302304\n@@ -81,0 +115,86 @@\n+\n+    @Test\n+    public void JDK6302321Test() {\n+        \/\/ check for bug 6302321\n+        final X509Certificate[] certs = km.getCertificateChain(\"doesnotexist\");\n+        final PrivateKey priv = km.getPrivateKey(\"doesnotexist\");\n+        Asserts.assertNull(certs, \"Should return null if the alias can't be found\");\n+        Asserts.assertNull(priv, \"Should return null if the alias can't be found\");\n+    }\n+\n+    @Test\n+    public void JDK6302271Test() {\n+        \/\/ check for 6302271\n+        final String[] clis = km.getClientAliases(\"doesnotexist\", null);\n+        Asserts.assertFalse((clis != null && clis.length == 0), \"Should return null instead of empty array\");\n+\n+        final String[] srvs = km.getServerAliases(\"doesnotexist\", null);\n+        Asserts.assertFalse((srvs != null && srvs.length == 0), \"Should return null instead of empty array\");\n+    }\n+\n+    \/**\n+     * The following tests are testing JDK-8369995\n+     *\/\n+\n+    private ByteArrayOutputStream replaceSystemError() {\n+        final ByteArrayOutputStream outputStream = new ByteArrayOutputStream();\n+        final PrintStream newErrStream = new PrintStream(outputStream);\n+        System.setErr(newErrStream);\n+\n+        return outputStream;\n+    }\n+\n+    @Test\n+    public void incompleteChainAndKeyTest() {\n+        final X509Certificate[] certs = km.getCertificateChain(\"1.1\");\n+        final PrivateKey priv = km.getPrivateKey(\"1.1\");\n+\n+        Asserts.assertNull(certs, \"Should return null if the alias can't be found\");\n+        Asserts.assertNull(priv, \"Should return null if the alias can't be found\");\n+    }\n+\n+    @Test\n+    public void nonexistentBuilderTest() {\n+        \/\/ recording logs to the output stream\n+        final ByteArrayOutputStream outputStream = replaceSystemError();\n+\n+        final X509Certificate[] certs = km.getCertificateChain(\"RSA.1.1\");\n+        final PrivateKey priv = km.getPrivateKey(\"RSA.1.1\");\n+\n+        Asserts.assertNull(certs, \"Should return null if the alias can't be found\");\n+        Asserts.assertNull(priv, \"Should return null if the alias can't be found\");\n+\n+        System.setErr(initialErrStream);\n+        System.err.println(\" => nonexistentBuilderTest: \\n\" + outputStream);\n+\n+        Asserts.assertFalse(isDebug && !outputStream.toString().contains(\"KeyMgr: exception triggered:\"),\n+                \"No log triggered\");\n+    }\n+\n+    @Test\n+    public void nonexistentKSTest() {\n+        final X509Certificate[] certs = km.getCertificateChain(\"RSA.0.1\");\n+        final PrivateKey priv = km.getPrivateKey(\"RSA.0.1\");\n+\n+        Asserts.assertNull(certs, \"Should return null if the alias can't be found\");\n+        Asserts.assertNull(priv, \"Should return null if the alias can't be found\");\n+    }\n+\n+    @ParameterizedTest\n+    @ValueSource(strings = {\"RSA.not.exist\", \"..1\"})\n+    public void wrongNumberFormatTest(final String alias) {\n+        \/\/ recording logs to the output stream\n+        final ByteArrayOutputStream outputStream = replaceSystemError();\n+        X509Certificate[] certs = km.getCertificateChain(alias);\n+        PrivateKey priv = km.getPrivateKey(alias);\n+\n+        Asserts.assertNull(certs, \"Should return null if the alias can't be found\");\n+        Asserts.assertNull(priv, \"Should return null if the alias can't be found\");\n+\n+        System.setErr(initialErrStream);\n+        System.err.println(\" => wrongNumberFormatTest alias<\" + alias + \">: \\n\" + outputStream);\n+\n+        Asserts.assertFalse(isDebug && !outputStream.toString().contains(\"KeyMgr: exception triggered:\"),\n+                \"No log triggered\");\n+\n+    }\n","filename":"test\/jdk\/sun\/security\/ssl\/X509KeyManager\/NullCases.java","additions":150,"deletions":30,"binary":false,"changes":180,"status":"modified"},{"patch":"@@ -0,0 +1,173 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import jdk.test.lib.Asserts;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.BeforeAll;\n+\n+import javax.net.ssl.KeyManagerFactory;\n+import javax.net.ssl.X509KeyManager;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.security.Key;\n+import java.security.KeyStore;\n+import java.security.KeyStoreSpi;\n+import java.security.Security;\n+import java.security.cert.Certificate;\n+import java.util.ConcurrentModificationException;\n+import java.util.Date;\n+import java.util.Enumeration;\n+\n+\/*\n+ * @test\n+ * @bug 8369995\n+ * @summary X509KeyManagerImpl negative tests causing exceptions\n+ * @library \/test\/lib\n+ * @run junit\/othervm X509KeyManagerNegativeTests\n+ *\/\n+public class X509KeyManagerNegativeTests {\n+    private static X509KeyManager exceptionThrowingKM;\n+\n+    @BeforeAll\n+    public static void beforeAll() throws Exception {\n+\n+        \/\/ initialising exception throwing ks\n+        \/\/ cleaned up after the tests are complete\n+        final KeyManagerFactory exceptionThrowingKMF = KeyManagerFactory.getInstance(\"NewSunX509\");\n+\n+        \/\/ adding dummy provider\n+        Security.addProvider(new MyCustomKSProvider());\n+        final KeyStore exceptionThrowingKS = KeyStore.getInstance(\"MyExceptionKS\");\n+        exceptionThrowingKS.load(null, null);\n+\n+        exceptionThrowingKMF.init((KeyStore) exceptionThrowingKS, null);\n+        exceptionThrowingKM = (X509KeyManager) exceptionThrowingKMF.getKeyManagers()[0];\n+    }\n+\n+    @AfterAll\n+    public static void cleanup() {\n+        \/\/ remove custom provider\n+        Security.removeProvider(\"MyCustomKSProvider\");\n+    }\n+\n+    @Test\n+    public void ksExceptionTest() {\n+        \/\/ recording logs to the output stream\n+        Asserts.assertThrows(ConcurrentModificationException.class,\n+                () -> exceptionThrowingKM.getCertificateChain(\"RSA.0.0\"));\n+        Asserts.assertThrows(ConcurrentModificationException.class,\n+                () -> exceptionThrowingKM.getPrivateKey(\"RSA.0.0\"));\n+    }\n+\n+    public static class MyCustomKSProvider extends java.security.Provider {\n+        public MyCustomKSProvider() {\n+            super(\"MyCustomKSProvider\", 1.0, \"My Custom KS Provider\");\n+            put(\"KeyStore.MyExceptionKS\", MyExceptionKS.class.getName());\n+        }\n+    }\n+\n+    public static class MyExceptionKS extends KeyStoreSpi {\n+\n+        @Override\n+        public KeyStore.Entry engineGetEntry(String alias, KeyStore.ProtectionParameter param) {\n+            throw new ConcurrentModificationException(\"getEntry exception\");\n+        }\n+\n+        @Override\n+        public Key engineGetKey(String alias, char[] password) {\n+            return null;\n+        }\n+\n+        @Override\n+        public Certificate[] engineGetCertificateChain(String alias) {\n+            return null;\n+        }\n+\n+        @Override\n+        public Certificate engineGetCertificate(String alias) {\n+            return null;\n+        }\n+\n+        @Override\n+        public Date engineGetCreationDate(String alias) {\n+            return null;\n+        }\n+\n+        @Override\n+        public Enumeration<String> engineAliases() {\n+            return null;\n+        }\n+\n+        @Override\n+        public boolean engineContainsAlias(String alias) {\n+            return false;\n+        }\n+\n+        @Override\n+        public int engineSize() {\n+            return 0;\n+        }\n+\n+        @Override\n+        public boolean engineIsKeyEntry(String alias) {\n+            return false;\n+        }\n+\n+        @Override\n+        public boolean engineIsCertificateEntry(String alias) {\n+            return false;\n+        }\n+\n+        @Override\n+        public String engineGetCertificateAlias(Certificate cert) {\n+            return null;\n+        }\n+\n+        @Override\n+        public void engineStore(OutputStream stream, char[] password) {\n+        }\n+\n+        @Override\n+        public void engineLoad(InputStream stream, char[] password) {\n+        }\n+\n+        @Override\n+        public void engineSetKeyEntry(String alias, Key key, char[] password, Certificate[] chain) {\n+        }\n+\n+        @Override\n+        public void engineSetKeyEntry(String alias, byte[] key, Certificate[] chain) {\n+        }\n+\n+        @Override\n+        public void engineSetCertificateEntry(String alias, Certificate cert) {\n+        }\n+\n+        @Override\n+        public void engineDeleteEntry(String alias) {\n+        }\n+    }\n+}\n","filename":"test\/jdk\/sun\/security\/ssl\/X509KeyManager\/X509KeyManagerNegativeTests.java","additions":173,"deletions":0,"binary":false,"changes":173,"status":"added"}]}