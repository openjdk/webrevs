{"files":[{"patch":"@@ -1213,2 +1213,2 @@\n-        if (maxValue <= 0.0) {\n-            return 0.0;\n+        if (maxValue <= DoubleZigguratTables.exponentialX0) {\n+            return DoubleZigguratTables.exponentialX0;\n@@ -1217,1 +1217,1 @@\n-        if (maxValue >= MAX_EXPONENTIAL) {\n+        if (maxValue >= Math.nextDown(MAX_EXPONENTIAL)) {\n@@ -1220,2 +1220,3 @@\n-            \/\/ Conversion to long rounds toward zero\n-            maxExtraMinus1 = (long) (maxValue \/ DoubleZigguratTables.exponentialX0);\n+            \/\/ Math.round rounds toward infinity in conversion to long; adding 1.0 corrects for any\n+            \/\/ downward rounding error in the division\n+            maxExtraMinus1 = Math.round(1.0 + maxValue \/ DoubleZigguratTables.exponentialX0);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/util\/random\/RandomSupport.java","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -0,0 +1,35 @@\n+\/*\n+ * @test\n+ * @bug 8326227\n+ * @modules java.base\/jdk.internal.util\n+ * @summary Verify that RandomSupport methods behave as specified\n+ * @run junit RandomSupportTest\n+ *\/\n+\n+import org.junit.jupiter.api.*;\n+import java.util.random.RandomGenerator;\n+import jdk.internal.util.random.RandomSupport;\n+import static org.junit.jupiter.api.Assertions.*;\n+public class RandomSupportTest {\n+    private static class WorstCaseRandomGenerator implements RandomGenerator {\n+        boolean havePreviousOutput = false;\n+        @Override\n+        public long nextLong() {\n+            if (havePreviousOutput) {\n+                \/\/ gets shifted to 0x4000_0000_0000_0000, which puts us in the center of the sampling rectangle and\n+                \/\/ ensures that we'll never choose a point under the curve\n+                return Long.MIN_VALUE;\n+            } else {\n+                havePreviousOutput = true;\n+                return Long.MIN_VALUE | 255; \/\/ need high value in last byte in order to skip the fast path\n+            }\n+        }\n+    }\n+    @Test\n+    public void testNextExponentialSoftCapped() {\n+        for (double max = 1.0; max < 10.0; max++) {\n+            WorstCaseRandomGenerator rng = new WorstCaseRandomGenerator();\n+            assertTrue(RandomSupport.computeNextExponentialSoftCapped(rng, max) >= max);\n+        }\n+    }\n+}\n\\ No newline at end of file\n","filename":"test\/jdk\/jdk\/internal\/util\/random\/RandomSupportTest.java","additions":35,"deletions":0,"binary":false,"changes":35,"status":"added"}]}