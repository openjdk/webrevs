{"files":[{"patch":"@@ -56,0 +56,2 @@\n+import static java.lang.invoke.MethodHandleNatives.Constants.NESTMATE_CLASS;\n+import static java.lang.invoke.MethodHandleNatives.Constants.STRONG_LOADER_LINK;\n@@ -351,1 +353,1 @@\n-            return caller.makeHiddenClassDefiner(lambdaClassName, classBytes, Set.of(NESTMATE, STRONG), lambdaProxyClassFileDumper)\n+            return caller.makeHiddenClassDefiner(lambdaClassName, classBytes, lambdaProxyClassFileDumper, NESTMATE_CLASS | STRONG_LOADER_LINK)\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/InnerClassLambdaMetafactory.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -50,1 +50,0 @@\n-import java.util.Set;\n@@ -227,1 +226,1 @@\n-        Class<?> invokerClass = LOOKUP.makeHiddenClassDefiner(className, classFile, Set.of(), dumper())\n+        Class<?> invokerClass = LOOKUP.makeHiddenClassDefiner(className, classFile, dumper())\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/InvokerBytecodeGenerator.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -67,0 +67,1 @@\n+import static java.lang.invoke.MethodHandleNatives.Constants.NESTMATE_CLASS;\n@@ -1114,1 +1115,1 @@\n-                        .makeHiddenClassDefiner(name, INJECTED_INVOKER_TEMPLATE, Set.of(NESTMATE), dumper())\n+                        .makeHiddenClassDefiner(name, INJECTED_INVOKER_TEMPLATE, dumper(), NESTMATE_CLASS)\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/MethodHandleImpl.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -288,1 +288,1 @@\n-        var definer = new Lookup(intfc).makeHiddenClassDefiner(className, template, Set.of(), DUMPER);\n+        var definer = new Lookup(intfc).makeHiddenClassDefiner(className, template, DUMPER);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/MethodHandleProxies.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1909,1 +1909,1 @@\n-            static int optionsToFlag(Set<ClassOption> options) {\n+            static int optionsToFlag(ClassOption[] options) {\n@@ -1912,0 +1912,3 @@\n+                    if ((flags & cp.flag) != 0) {\n+                        throw new IllegalArgumentException(\"Duplicate ClassOption \" + cp);\n+                    }\n@@ -2129,2 +2132,1 @@\n-            Objects.requireNonNull(options);\n-\n+            int flags = ClassOption.optionsToFlag(options);\n@@ -2136,1 +2138,1 @@\n-            return makeHiddenClassDefiner(bytes.clone(), Set.of(options), false).defineClassAsLookup(initialize);\n+            return makeHiddenClassDefiner(bytes.clone(), false, flags).defineClassAsLookup(initialize);\n@@ -2216,1 +2218,2 @@\n-            Objects.requireNonNull(options);\n+\n+            int flags = ClassOption.optionsToFlag(options);\n@@ -2223,1 +2226,1 @@\n-            return makeHiddenClassDefiner(bytes.clone(), Set.of(options), false)\n+            return makeHiddenClassDefiner(bytes.clone(), false, flags)\n@@ -2369,1 +2372,1 @@\n-            return makeHiddenClassDefiner(cf, Set.of(), false, dumper);\n+            return makeHiddenClassDefiner(cf, false, dumper, 0);\n@@ -2381,1 +2384,1 @@\n-         * @param options class options\n+         * @param flags   class option flag mask\n@@ -2389,2 +2392,2 @@\n-                                                    Set<ClassOption> options,\n-                                                    boolean accessVmAnnotations) {\n+                                                    boolean accessVmAnnotations,\n+                                                    int flags) {\n@@ -2392,1 +2395,16 @@\n-            return makeHiddenClassDefiner(cf, options, accessVmAnnotations, defaultDumper());\n+            return makeHiddenClassDefiner(cf, accessVmAnnotations, defaultDumper(), flags);\n+        }\n+\n+        \/**\n+         * Returns a ClassDefiner that creates a {@code Class} object of a hidden class\n+         * from the given bytes and the given options.  No package name check on the given bytes.\n+         *\n+         * @param name    internal name that specifies the prefix of the hidden class\n+         * @param bytes   class bytes\n+         * @param dumper  dumper to write the given bytes to the dumper's output directory\n+         * @return ClassDefiner that defines a hidden class of the given bytes and options.\n+         *\/\n+        ClassDefiner makeHiddenClassDefiner(String name, byte[] bytes, ClassFileDumper dumper) {\n+            Objects.requireNonNull(dumper);\n+            \/\/ skip name and access flags validation\n+            return makeHiddenClassDefiner(ClassFile.newInstanceNoCheck(name, bytes), false, dumper, 0);\n@@ -2401,1 +2419,1 @@\n-         * @param options class options\n+         * @param flags   class options flag mask\n@@ -2405,1 +2423,1 @@\n-        ClassDefiner makeHiddenClassDefiner(String name, byte[] bytes, Set<ClassOption> options, ClassFileDumper dumper) {\n+        ClassDefiner makeHiddenClassDefiner(String name, byte[] bytes, ClassFileDumper dumper, int flags) {\n@@ -2408,1 +2426,1 @@\n-            return makeHiddenClassDefiner(ClassFile.newInstanceNoCheck(name, bytes), options, false, dumper);\n+            return makeHiddenClassDefiner(ClassFile.newInstanceNoCheck(name, bytes), false, dumper, flags);\n@@ -2416,1 +2434,1 @@\n-         * @param options class options\n+         * @param flags class option flag mask\n@@ -2421,1 +2439,0 @@\n-                                                    Set<ClassOption> options,\n@@ -2423,2 +2440,3 @@\n-                                                    ClassFileDumper dumper) {\n-            int flags = HIDDEN_CLASS | ClassOption.optionsToFlag(options);\n+                                                    ClassFileDumper dumper,\n+                                                    int flags) {\n+            flags |= HIDDEN_CLASS;\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/MethodHandles.java","additions":36,"deletions":18,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -54,1 +54,0 @@\n-import java.util.Set;\n@@ -1356,1 +1355,1 @@\n-                var hiddenClass = lookup.makeHiddenClassDefiner(CLASS_NAME, classBytes, Set.of(), DUMPER)\n+                var hiddenClass = lookup.makeHiddenClassDefiner(CLASS_NAME, classBytes, DUMPER)\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/StringConcatFactory.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"}]}