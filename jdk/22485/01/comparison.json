{"files":[{"patch":"@@ -2466,1 +2466,1 @@\n-void PhaseIdealLoop::do_range_check(IdealLoopTree *loop, Node_List &old_new) {\n+void PhaseIdealLoop::do_range_check(IdealLoopTree* loop) {\n@@ -2529,2 +2529,3 @@\n-  \/\/ not loop invariant).\n-  Node* new_limit_ctrl = dominated_node(pre_ctrl, pre_limit_ctrl);\n+  \/\/ not loop invariant). new_limit_ctrl is used for both the pre and main loops. Early control for the main limit may be\n+  \/\/ below the pre loop entry and the pre limit and must be taken into account when initializing new_limit_ctrl.\n+  Node* new_limit_ctrl = dominated_node(pre_ctrl, pre_limit_ctrl, compute_early_ctrl(main_limit, main_limit_ctrl));\n@@ -2781,2 +2782,4 @@\n-  set_ctrl(pre_end->cmp_node(), new_limit_ctrl);\n-  set_ctrl(pre_end->in(1), new_limit_ctrl);\n+  \/\/ Can't use new_limit_ctrl for Bool\/Cmp because it can be out of loop while they are loop variant. Conservatively set\n+  \/\/ control to latest possible one.\n+  set_ctrl(pre_end->cmp_node(), pre_end->in(0));\n+  set_ctrl(pre_end->in(1), pre_end->in(0));\n@@ -2822,2 +2825,2 @@\n-  \/\/ new main_limit can push Bool\/Cmp nodes down (when one of the eliminated condition has parameters that are not loop\n-  \/\/ invariant in the pre loop.\n+  \/\/ new main_limit can push opaque node for zero trip guard down (when one of the eliminated condition has parameters\n+  \/\/ that are not loop invariant in the pre loop).\n@@ -2825,2 +2828,3 @@\n-  set_ctrl(iffm->in(1)->in(1), new_limit_ctrl);\n-  set_ctrl(iffm->in(1), new_limit_ctrl);\n+  \/\/ Bool\/Cmp nodes for zero trip guard should have been assigned control between the main and pre loop (because zero\n+  \/\/ trip guard depends on induction variable value out of pre loop) so shouldn't need to be adjusted\n+  assert(is_dominator(new_limit_ctrl, get_ctrl(iffm->in(1)->in(1))), \"control of cmp should be below control of updated input\");\n@@ -3405,1 +3409,1 @@\n-      phase->do_range_check(this, old_new);\n+      phase->do_range_check(this);\n","filename":"src\/hotspot\/share\/opto\/loopTransform.cpp","additions":14,"deletions":10,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -1419,1 +1419,1 @@\n-  void do_range_check(IdealLoopTree *loop, Node_List &old_new);\n+  void do_range_check(IdealLoopTree* loop);\n","filename":"src\/hotspot\/share\/opto\/loopnode.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}