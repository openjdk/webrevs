{"files":[{"patch":"@@ -4265,1 +4265,1 @@\n-                                                  bool obj_array, bool not_array) {\n+                                                  bool obj_array, bool not_array, Node** obj) {\n@@ -4307,1 +4307,8 @@\n-  return generate_fair_guard(bol, region);\n+  Node* ctrl = generate_fair_guard(bol, region);\n+  Node* is_array_ctrl = not_array ? control() : ctrl;\n+  if (obj != nullptr && is_array_ctrl != nullptr && is_array_ctrl != top()) {\n+    \/\/ Keep track of the fact that 'obj' is an array to prevent\n+    \/\/ array specific accesses from floating above the guard.\n+    *obj = _gvn.transform(new CastPPNode(is_array_ctrl, *obj, TypeAryPtr::BOTTOM));\n+  }\n+  return ctrl;\n@@ -4402,1 +4409,1 @@\n-  Node* non_array = generate_non_array_guard(load_object_klass(array), nullptr);\n+  Node* non_array = generate_non_array_guard(load_object_klass(array), nullptr, &array);\n@@ -5262,1 +5269,2 @@\n-    Node* array_ctl = generate_array_guard(obj_klass, (RegionNode*)nullptr);\n+    Node* array_obj = obj;\n+    Node* array_ctl = generate_array_guard(obj_klass, (RegionNode*)nullptr, &array_obj);\n@@ -5267,1 +5275,1 @@\n-      Node* obj_length = load_array_length(obj);\n+      Node* obj_length = load_array_length(array_obj);\n@@ -5281,1 +5289,1 @@\n-          ArrayCopyNode* ac = ArrayCopyNode::make(this, true, obj, intcon(0), alloc_obj, intcon(0), obj_length, true, false);\n+          ArrayCopyNode* ac = ArrayCopyNode::make(this, true, array_obj, intcon(0), alloc_obj, intcon(0), obj_length, true, false);\n@@ -5302,1 +5310,1 @@\n-        copy_to_clone(obj, alloc_obj, array_size, true);\n+        copy_to_clone(array_obj, alloc_obj, array_size, true);\n@@ -5923,2 +5931,2 @@\n-    generate_non_array_guard(load_object_klass(src), slow_region);\n-    generate_non_array_guard(load_object_klass(dest), slow_region);\n+    generate_non_array_guard(load_object_klass(src), slow_region, &src);\n+    generate_non_array_guard(load_object_klass(dest), slow_region, &dest);\n@@ -8540,1 +8548,1 @@\n-    Node* array_ctl = generate_array_guard(klass_node, nullptr);\n+    Node* array_ctl = generate_array_guard(klass_node, nullptr, &obj);\n","filename":"src\/hotspot\/share\/opto\/library_call.cpp","additions":18,"deletions":10,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -166,2 +166,2 @@\n-  Node* generate_array_guard(Node* kls, RegionNode* region) {\n-    return generate_array_guard_common(kls, region, false, false);\n+  Node* generate_array_guard(Node* kls, RegionNode* region, Node** obj = nullptr) {\n+    return generate_array_guard_common(kls, region, false, false, obj);\n@@ -169,2 +169,2 @@\n-  Node* generate_non_array_guard(Node* kls, RegionNode* region) {\n-    return generate_array_guard_common(kls, region, false, true);\n+  Node* generate_non_array_guard(Node* kls, RegionNode* region, Node** obj = nullptr) {\n+    return generate_array_guard_common(kls, region, false, true, obj);\n@@ -172,2 +172,2 @@\n-  Node* generate_objArray_guard(Node* kls, RegionNode* region) {\n-    return generate_array_guard_common(kls, region, true, false);\n+  Node* generate_objArray_guard(Node* kls, RegionNode* region, Node** obj = nullptr) {\n+    return generate_array_guard_common(kls, region, true, false, obj);\n@@ -175,2 +175,2 @@\n-  Node* generate_non_objArray_guard(Node* kls, RegionNode* region) {\n-    return generate_array_guard_common(kls, region, true, true);\n+  Node* generate_non_objArray_guard(Node* kls, RegionNode* region, Node** obj = nullptr) {\n+    return generate_array_guard_common(kls, region, true, true, obj);\n@@ -179,1 +179,1 @@\n-                                    bool obj_array, bool not_array);\n+                                    bool obj_array, bool not_array, Node** obj = nullptr);\n","filename":"src\/hotspot\/share\/opto\/library_call.hpp","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -585,0 +585,1 @@\n+  TypeAryPtr::BOTTOM = TypeAryPtr::make(TypePtr::BotPTR, TypeAry::make(Type::BOTTOM, TypeInt::POS), nullptr, false, Type::OffsetBot);\n@@ -4685,10 +4686,11 @@\n-const TypeAryPtr *TypeAryPtr::RANGE;\n-const TypeAryPtr *TypeAryPtr::OOPS;\n-const TypeAryPtr *TypeAryPtr::NARROWOOPS;\n-const TypeAryPtr *TypeAryPtr::BYTES;\n-const TypeAryPtr *TypeAryPtr::SHORTS;\n-const TypeAryPtr *TypeAryPtr::CHARS;\n-const TypeAryPtr *TypeAryPtr::INTS;\n-const TypeAryPtr *TypeAryPtr::LONGS;\n-const TypeAryPtr *TypeAryPtr::FLOATS;\n-const TypeAryPtr *TypeAryPtr::DOUBLES;\n+const TypeAryPtr* TypeAryPtr::BOTTOM;\n+const TypeAryPtr* TypeAryPtr::RANGE;\n+const TypeAryPtr* TypeAryPtr::OOPS;\n+const TypeAryPtr* TypeAryPtr::NARROWOOPS;\n+const TypeAryPtr* TypeAryPtr::BYTES;\n+const TypeAryPtr* TypeAryPtr::SHORTS;\n+const TypeAryPtr* TypeAryPtr::CHARS;\n+const TypeAryPtr* TypeAryPtr::INTS;\n+const TypeAryPtr* TypeAryPtr::LONGS;\n+const TypeAryPtr* TypeAryPtr::FLOATS;\n+const TypeAryPtr* TypeAryPtr::DOUBLES;\n","filename":"src\/hotspot\/share\/opto\/type.cpp","additions":13,"deletions":11,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -1473,10 +1473,11 @@\n-  static const TypeAryPtr *RANGE;\n-  static const TypeAryPtr *OOPS;\n-  static const TypeAryPtr *NARROWOOPS;\n-  static const TypeAryPtr *BYTES;\n-  static const TypeAryPtr *SHORTS;\n-  static const TypeAryPtr *CHARS;\n-  static const TypeAryPtr *INTS;\n-  static const TypeAryPtr *LONGS;\n-  static const TypeAryPtr *FLOATS;\n-  static const TypeAryPtr *DOUBLES;\n+  static const TypeAryPtr* BOTTOM;\n+  static const TypeAryPtr* RANGE;\n+  static const TypeAryPtr* OOPS;\n+  static const TypeAryPtr* NARROWOOPS;\n+  static const TypeAryPtr* BYTES;\n+  static const TypeAryPtr* SHORTS;\n+  static const TypeAryPtr* CHARS;\n+  static const TypeAryPtr* INTS;\n+  static const TypeAryPtr* LONGS;\n+  static const TypeAryPtr* FLOATS;\n+  static const TypeAryPtr* DOUBLES;\n","filename":"src\/hotspot\/share\/opto\/type.hpp","additions":12,"deletions":11,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug 8064703\n+ * @bug 8064703 8347006\n@@ -31,0 +31,3 @@\n+ * @run main\/othervm -XX:-BackgroundCompilation -XX:-UseOnStackReplacement -XX:TypeProfileLevel=020\n+ *                   -XX:+UnlockExperimentalVMOptions -XX:+UseCompactObjectHeaders -XX:-UseTLAB\n+ *                   compiler.arraycopy.TestArrayCopyNoInit\n","filename":"test\/hotspot\/jtreg\/compiler\/arraycopy\/TestArrayCopyNoInit.java","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"}]}