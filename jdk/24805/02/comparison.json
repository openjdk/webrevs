{"files":[{"patch":"@@ -1046,9 +1046,4 @@\n-                        if (command == IMPORTKEYSTORE) {\n-                            System.err.print\n-                                    (rb.getString(\"Enter.destination.keystore.password.\"));\n-                        } else {\n-                            System.err.print\n-                                    (rb.getString(\"Enter.keystore.password.\"));\n-                        }\n-                        System.err.flush();\n-                        storePass = Password.readPassword(System.in);\n+                        String prompt = command == IMPORTKEYSTORE\n+                                ? rb.getString(\"Enter.destination.keystore.password.\")\n+                                : rb.getString(\"Enter.keystore.password.\");\n+                        storePass = Password.toolReadPassword(prompt);\n@@ -1068,2 +1063,2 @@\n-                            System.err.print(rb.getString(\"Re.enter.new.password.\"));\n-                            char[] storePassAgain = Password.readPassword(System.in);\n+                            char[] storePassAgain = Password.toolReadPassword(\n+                                    rb.getString(\"Re.enter.new.password.\"));\n@@ -1090,3 +1085,2 @@\n-                        System.err.print(rb.getString(\"Enter.keystore.password.\"));\n-                        System.err.flush();\n-                        storePass = Password.readPassword(System.in);\n+                        storePass = Password.toolReadPassword(\n+                                rb.getString(\"Enter.keystore.password.\"));\n@@ -1731,1 +1725,1 @@\n-                System.err.print(form.format(source));\n+                String prompt = form.format(source);\n@@ -1733,1 +1727,1 @@\n-                    System.err.println();\n+                    prompt += \"\\n\";\n@@ -1735,2 +1729,2 @@\n-                        System.err.print(rb.getString\n-                                (\".RETURN.if.same.as.keystore.password.\"));\n+                        prompt += rb.getString\n+                                (\".RETURN.if.same.as.keystore.password.\");\n@@ -1741,1 +1735,1 @@\n-                        System.err.print(form.format(src));\n+                        prompt += form.format(src);\n@@ -1744,2 +1738,1 @@\n-                System.err.flush();\n-                char[] entered = Password.readPassword(System.in);\n+                char[] entered = Password.toolReadPassword(prompt);\n@@ -1750,2 +1743,2 @@\n-                    System.err.print(rb.getString(\"Re.enter.new.password.\"));\n-                    char[] passAgain = Password.readPassword(System.in);\n+                    char[] passAgain = Password.toolReadPassword(\n+                            rb.getString(\"Re.enter.new.password.\"));\n@@ -1791,4 +1784,2 @@\n-            System.err.print(\n-                rb.getString(\"Enter.the.password.to.be.stored.\"));\n-            System.err.flush();\n-            char[] entered = Password.readPassword(System.in);\n+            char[] entered = Password.toolReadPassword(\n+                    rb.getString(\"Enter.the.password.to.be.stored.\"));\n@@ -1796,2 +1787,2 @@\n-            System.err.print(rb.getString(\"Re.enter.password.\"));\n-            char[] passAgain = Password.readPassword(System.in);\n+            char[] passAgain = Password.toolReadPassword(\n+                    rb.getString(\"Re.enter.password.\"));\n@@ -2405,3 +2396,2 @@\n-                System.err.print(rb.getString(\"Enter.source.keystore.password.\"));\n-                System.err.flush();\n-                srcstorePass = Password.readPassword(System.in);\n+                srcstorePass = Password.toolReadPassword(\n+                        rb.getString(\"Enter.source.keystore.password.\"));\n@@ -3487,2 +3477,1 @@\n-            System.err.print(form.format(source));\n-            entered = Password.readPassword(System.in);\n+            entered = Password.toolReadPassword(form.format(source));\n@@ -3499,2 +3488,1 @@\n-                System.err.print(form.format(src));\n-                reentered = Password.readPassword(System.in);\n+                reentered = Password.toolReadPassword(form.format(src));\n@@ -3566,0 +3554,1 @@\n+            String prompt = form.format(source);\n@@ -3567,2 +3556,0 @@\n-                System.err.println(form.format(source));\n-\n@@ -3572,3 +3559,1 @@\n-                System.err.print(form.format(src));\n-            } else {\n-                System.err.print(form.format(source));\n+                prompt += form.format(src);\n@@ -3577,1 +3562,1 @@\n-            keyPass = Password.readPassword(System.in);\n+            keyPass = Password.toolReadPassword(prompt);\n@@ -5276,0 +5261,4 @@\n+            System.err.println();\n+            System.err.println(rb.getString(\"for.more.information.see.the.online.documentation.at.\"));\n+            System.err.println(\"https:\/\/docs.oracle.com\/en\/java\/javase\/\"\n+                    + Runtime.version().feature() + \"\/docs\/specs\/man\/keytool.html\");\n","filename":"src\/java.base\/share\/classes\/sun\/security\/tools\/keytool\/Main.java","additions":31,"deletions":42,"binary":false,"changes":73,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+for.more.information.see.the.online.documentation.at.=For more information, see the online documentation at:\n","filename":"src\/java.base\/share\/classes\/sun\/security\/tools\/keytool\/resources\/keytool.properties","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+for.more.information.see.the.online.documentation.at.=如需了解更多信息，请访问在线手册页面：\n","filename":"src\/java.base\/share\/classes\/sun\/security\/tools\/keytool\/resources\/keytool_zh_CN.properties","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -39,0 +39,20 @@\n+\n+    private static final String PASS_ECHO_WARNING\n+            = ResourcesMgr.getString(\"pass.echo.warning\");\n+\n+    \/**\n+     * Reads user password from stdin. Shows a warning if cannot suppress echo.\n+     * Used by keytool and jarsigner.\n+     *\/\n+    public static char[] toolReadPassword(String prompt) throws IOException {\n+        \/\/ If the password is piped into the command, typically\n+        \/\/ System.in.available() will not be zero. We don't show\n+        \/\/ the warning in this case.\n+        if (System.in.available() == 0 && System.console() == null) {\n+            System.err.println(PASS_ECHO_WARNING);\n+        }\n+        System.err.print(prompt);\n+        System.err.flush();\n+        return readPassword(System.in, false);\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/sun\/security\/util\/Password.java","additions":21,"deletions":1,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -26,0 +26,3 @@\n+# sun.security.util.Password\n+pass.echo.warning=Warning: password will be echoed because output is redirected.\n+\n","filename":"src\/java.base\/share\/classes\/sun\/security\/util\/resources\/security.properties","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -26,0 +26,3 @@\n+# sun.security.util.Password\n+pass.echo.warning=警告：由于输出被重定向，密码将会被回显。\n+\n","filename":"src\/java.base\/share\/classes\/sun\/security\/util\/resources\/security_zh_CN.properties","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1225,1 +1225,2 @@\n-    -   `file`: Retrieve the password from the file named *argument*.\n+    -   `file`: Retrieve the password from the file named *argument*. Only\n+        the first line of the file is used, with the trailing newline removed.\n@@ -2349,1 +2350,1 @@\n-the command line in the `-storepass` and `-keypass` options. However, a\n+the command line via options such as `-storepass` and `-keypass`. However, a\n@@ -2351,2 +2352,7 @@\n-for testing, or you are on a secure system. When you don't specify a required\n-password option on a command line, you are prompted for it.\n+for testing, or you are on a secure system. As a safer alternative, use\n+`-storepass:file` or `-storepass:env` to supply the password from a file or an\n+environment variable.\n+\n+When you don't specify a required password option on a command line, you are\n+prompted for it. Password input is typically hidden, unless the `keytool`\n+output is redirected to a file or pipe, in which case the input may be echoed.\n","filename":"src\/java.base\/share\/man\/keytool.md","additions":10,"deletions":4,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -2729,2 +2729,0 @@\n-        System.err.print(prompt);\n-        System.err.flush();\n@@ -2732,1 +2730,1 @@\n-            char[] pass = Password.readPassword(System.in);\n+            char[] pass = Password.toolReadPassword(prompt);\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/security\/tools\/jarsigner\/Main.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -75,0 +75,1 @@\n+import javax.swing.event.HyperlinkListener;\n@@ -101,1 +102,2 @@\n- * provides richer formatting options.\n+ * provides richer formatting options. {@link Builder#addHyperlinkListener}\n+ * can be called to add a listener to hyperlinks inside the HTML.\n@@ -584,0 +586,1 @@\n+                                           null,\n@@ -602,0 +605,1 @@\n+                                         builder.hyperlinkListener,\n@@ -623,0 +627,1 @@\n+                                                       HyperlinkListener hyperlinkListener,\n@@ -635,0 +640,3 @@\n+        if (hyperlinkListener != null && text instanceof JEditorPane ep) {\n+            ep.addHyperlinkListener(hyperlinkListener);\n+        }\n@@ -638,0 +646,1 @@\n+        text.getCaret().setVisible(false);\n@@ -1368,0 +1377,1 @@\n+        HyperlinkListener hyperlinkListener;\n@@ -1448,0 +1458,11 @@\n+        \/**\n+         * Set the HyperlinkListener of links inside the instructions pane.\n+         *\n+         * @param hyperlinkListener the listener\n+         * @return this builder\n+         *\/\n+        public Builder addHyperlinkListener(HyperlinkListener hyperlinkListener) {\n+            this.hyperlinkListener = hyperlinkListener;\n+            return this;\n+        }\n+\n","filename":"test\/jdk\/java\/awt\/regtesthelpers\/PassFailJFrame.java","additions":22,"deletions":1,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -0,0 +1,109 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8354469\n+ * @summary keytool password prompt shows warning when cannot suppress echo\n+ * @library \/java\/awt\/regtesthelpers\n+ * @build PassFailJFrame\n+ * @run main\/manual\/othervm EchoPassword\n+ *\/\n+\n+import javax.swing.*;\n+import javax.swing.event.HyperlinkEvent;\n+\n+import java.awt.*;\n+import java.awt.datatransfer.StringSelection;\n+import java.io.File;\n+\n+public class EchoPassword {\n+\n+    static JLabel label;\n+\n+    public static void main(String[] args) throws Exception {\n+\n+        final String keytool = String.format(\"\\\"%s\/bin\/keytool\\\" -keystore 8354469.ks\",\n+                System.getProperty(\"java.home\").replace(\"\\\\\", File.separator));\n+\n+        final String firstCommand = keytool + \" -genkeypair\";\n+        final String secondCommand = keytool + \" -genkeypair | type\";\n+        final String thirdCommand = \"(echo changeit & echo changeit ) | \" + keytool + \" -genkeypair\";\n+\n+        final String message = String.format(\"\"\"\n+                <html>Perform the following steps and record the final result:\n+                <ol>\n+                <li>Open a terminal or Windows Command Prompt window.\n+\n+                <li>Click <a href='First'>Copy First Command<\/a> to copy the following command into\n+                the system clipboard. Paste it into the terminal window and execute the command.\n+                <pre>\n+                %s\n+                <\/pre>\n+                When prompted, enter some characters and press Enter. Verify that the input is\n+                hidden, and no warning about password echoing appears. Press Ctrl-C to exit.\n+\n+                <li>Click <a href='Second'>Copy Second Command<\/a> to copy the following command into\n+                the system clipboard. Paste it into the terminal window and execute the command.\n+                <pre>\n+                %s\n+                <\/pre>\n+                When prompted, enter some characters and press Enter. Verify that the input is\n+                echoed, and a warning about password echoing is shown. Press Ctrl-C to exit.\n+\n+                <li>Click <a href='Third'>Copy Third Command<\/a> to copy the following command into\n+                the system clipboard. Paste it into the terminal window and execute the command.\n+                <pre>\n+                %s\n+                <\/pre>\n+                Verify that the password \"changeit\" is not shown in the command output, and\n+                no warning about password echoing appears. It's OK to see an exception.\n+                <\/ol>\n+                Press \"pass\" if the behavior matches expectations; otherwise, press \"fail\".\n+                \"\"\", firstCommand, secondCommand, thirdCommand);\n+\n+        PassFailJFrame.builder()\n+                .instructions(message)\n+                .addHyperlinkListener(e -> {\n+                    if (e.getEventType() == HyperlinkEvent.EventType.ACTIVATED) {\n+                        Toolkit.getDefaultToolkit().getSystemClipboard().setContents(\n+                                new StringSelection(switch (e.getDescription()) {\n+                                    case \"First\" -> firstCommand;\n+                                    case \"Second\" -> secondCommand;\n+                                    default -> thirdCommand;\n+                                }), null);\n+                        label.setText(e.getDescription() + \" command copied\");\n+                        if (e.getSource() instanceof JEditorPane ep) {\n+                            ep.getCaret().setVisible(false);\n+                        }\n+                    }\n+                })\n+                .columns(100)\n+                .splitUIBottom(() -> {\n+                    label = new JLabel(\"Status\");\n+                    return label;\n+                })\n+                .build()\n+                .awaitAndCheck();\n+    }\n+}\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/EchoPassword.java","additions":109,"deletions":0,"binary":false,"changes":109,"status":"added"},{"patch":"@@ -640,1 +640,1 @@\n-        assertTrue(err.indexOf(\"Warning\") == -1,\n+        assertTrue(err.indexOf(\"Warning:  Different store and key passwords\") == -1,\n@@ -645,1 +645,1 @@\n-        assertTrue(err.indexOf(\"Warning\") != -1,\n+        assertTrue(err.indexOf(\"Warning:  Different store and key passwords\") != -1,\n@@ -1886,1 +1886,1 @@\n-}\n\\ No newline at end of file\n+}\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/KeyToolTest.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -140,0 +140,2 @@\n+                    new Pair(\"java.base\/share\/classes\/sun\/security\/util\/Password.java\",\n+                            List.of(MGR_GETSTRING)),\n","filename":"test\/jdk\/sun\/security\/util\/Resources\/Usages.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}