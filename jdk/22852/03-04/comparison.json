{"files":[{"patch":"@@ -755,3 +755,6 @@\n-  \/\/ In some cases, there are other relevant initial memory states besides\n-  \/\/ initial_mem. In such cases, we are rather dealing with multiple trees and\n-  \/\/ their fringes.\n+  \/\/ In some cases, there are relevant memory state modifying nodes that we\n+  \/\/ cannot discover by searching from initial_mem. In such cases, we need to\n+  \/\/ expand our search with additional search roots. For details, see comments\n+  \/\/ and code below related to the initialization of\n+  \/\/ worklist_def_use_mem_states, which, prior to the main worklist loop below,\n+  \/\/ contains the search roots.\n@@ -775,0 +778,2 @@\n+\n+  \/\/ initial_mem is always a search root\n@@ -776,0 +781,1 @@\n+\n@@ -778,0 +784,45 @@\n+  assert(initial_mem_block->dominates(early), \"invariant\");\n+  \/\/ We sometimes need to add additional search roots to discover all relevant\n+  \/\/ anti-dependent stores. The additional required search roots are alias\n+  \/\/ memory nodes of initial_mem on the dominator tree path from the initial\n+  \/\/ memory block (inclusive) to the early block (inclusive). Specifically, we\n+  \/\/ must consider Phi memory nodes as search roots as they terminate\n+  \/\/ anti-dependence searches reaching them from above.\n+  \/\/\n+  \/\/ A situation where we need to add Phi search roots is the below.\n+  \/\/\n+  \/\/                    |\n+  \/\/ initial_mem_block  |\n+  \/\/             +-------------+\n+  \/\/             |...          |\n+  \/\/             |initial_mem  |\n+  \/\/             |...          |\n+  \/\/             +-------------+\n+  \/\/                \/        \\\n+  \/\/               \/          \\\n+  \/\/              ...        ...\n+  \/\/               \\          \/\n+  \/\/                \\        \/\n+  \/\/               +----------+\n+  \/\/               |...       |\n+  \/\/               |Phi       |\n+  \/\/               |...       |\n+  \/\/               +----------+\n+  \/\/                    |\n+  \/\/                    |\n+  \/\/          early     |\n+  \/\/         +---------------------+\n+  \/\/         |...                  |\n+  \/\/         |anti-dependent store |\n+  \/\/         |...                  |\n+  \/\/         +---------------------+\n+  \/\/\n+  \/\/ Here, there are multiple CFG paths from initial_mem_block to the early\n+  \/\/ block. Importantly, there is a Phi memory node with initial_mem alive (not\n+  \/\/ overwritten) on all of its inputs. If we only add initial_mem as our\n+  \/\/ search root, our anti-dependence search will terminate at the Phi, and we\n+  \/\/ will never discover the anti-dependent store in the early block.\n+  \/\/\n+  \/\/ Observations indicate that extra search roots are only required if the\n+  \/\/ load has an explicit control input (hence the load->in(0) != nullptr check\n+  \/\/ below).\n@@ -779,8 +830,0 @@\n-    assert(initial_mem_block->dominates(early), \"invariant\");\n-    \/\/ If the load has an explicit control input, walk up the dominator tree\n-    \/\/ from the early block (inclusive) to the initial memory block\n-    \/\/ (inclusive). When traversing the blocks, we look for Phi(s) that can alias\n-    \/\/ initial_mem; these are also potential initial memory states and there\n-    \/\/ may be further required anti-dependences due to them. Stop searching\n-    \/\/ when we step past the initial memory block. The loop below always\n-    \/\/ terminates because the root block strictly dominates initial_mem_block.\n@@ -790,1 +833,1 @@\n-        \/\/ If we are in the initial memory block, and initial_mem is not itself\n+        \/\/ If we are in initial_mem_block, and initial_mem is not itself\n@@ -792,2 +835,2 @@\n-        \/\/ Phis in the block. Therefore, no Phis in the block can be initial\n-        \/\/ memory states.\n+        \/\/ Phis in the block. Therefore, no Phis in the block are relevant\n+        \/\/ search roots.\n@@ -802,2 +845,3 @@\n-        if (n->is_memory_phi() && C->can_alias(n->adr_type(), load_alias_idx) && n != initial_mem) {\n-          \/\/ We have found a relevant Phi initial memory state\n+        if (n->is_memory_phi() && C->can_alias(n->adr_type(), load_alias_idx)\n+            && n != initial_mem) {\n+          \/\/ We have found a relevant Phi search root\n","filename":"src\/hotspot\/share\/opto\/gcm.cpp","additions":60,"deletions":16,"binary":false,"changes":76,"status":"modified"}]}