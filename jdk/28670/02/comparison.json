{"files":[{"patch":"@@ -562,1 +562,12 @@\n-    return (TrainingData::need_data() || TrainingData::assembling_data()) ? make_a_copy : set_to_null;\n+    if (TrainingData::need_data() || TrainingData::assembling_data()) {\n+      \/\/ Only add MethodCounters that are reachable via MethodTrainingData,\n+      \/\/ i.e. MethodCounters associated with a valid MethodTrainingData.\n+      if (ref->msotype() == MetaspaceObj::MethodCountersType) {\n+        MethodCounters* mcs = (MethodCounters*)obj;\n+        return mcs->has_valid_method_training_data() ? make_a_copy : set_to_null;\n+      } else {\n+        return make_a_copy;\n+      }\n+    } else {\n+      return set_to_null;\n+    }\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.cpp","additions":12,"deletions":1,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -98,0 +98,6 @@\n+bool MethodCounters::has_valid_method_training_data() {\n+  Metadata* mtd = method_training_data();\n+  Metadata* mts = method_training_data_sentinel();\n+  return mtd != mts;\n+}\n+\n","filename":"src\/hotspot\/share\/oops\/methodCounters.cpp","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -168,0 +168,2 @@\n+  bool has_valid_method_training_data();\n+\n","filename":"src\/hotspot\/share\/oops\/methodCounters.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -122,1 +122,1 @@\n-  if (!have_data() && !need_data()) {\n+  if ((!have_data() && !need_data()) || (assembling_data() && !CDSConfig::is_at_aot_safepoint())) {\n","filename":"src\/hotspot\/share\/oops\/trainingData.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}