{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2013, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2013, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,1 +53,1 @@\n-     * Returns a new InnocuousThread with an auto-generated thread name\n+     * Returns a new InnocuousThread with an auto-generated thread name,\n@@ -65,0 +65,11 @@\n+        return newThread(name, target, -1);\n+    }\n+    \/**\n+     * Returns a new InnocuousThread with its context class loader\n+     * set to the system class loader. The thread priority will be\n+     * set to the given priority.\n+     *\/\n+    public static Thread newThread(String name, Runnable target, int priority) {\n+        if (System.getSecurityManager() == null) {\n+            return createThread(name, target, ClassLoader.getSystemClassLoader(), priority);\n+        }\n@@ -69,4 +80,1 @@\n-                        return new InnocuousThread(INNOCUOUSTHREADGROUP,\n-                                                   target,\n-                                                   name,\n-                                                   ClassLoader.getSystemClassLoader());\n+                        return createThread(name, target, ClassLoader.getSystemClassLoader(), priority);\n@@ -89,0 +97,11 @@\n+        return newSystemThread(name, target, -1);\n+    }\n+\n+    \/**\n+     * Returns a new InnocuousThread with null context class loader.\n+     * Thread priority is set to the given priority.\n+     *\/\n+    public static Thread newSystemThread(String name, Runnable target, int priority) {\n+        if (System.getSecurityManager() == null) {\n+            return createThread(name, target, null, priority);\n+        }\n@@ -93,2 +112,1 @@\n-                        return new InnocuousThread(INNOCUOUSTHREADGROUP,\n-                                                   target, name, null);\n+                        return createThread(name, target, null, priority);\n@@ -99,0 +117,9 @@\n+    private static Thread createThread(String name, Runnable target, ClassLoader loader, int priority) {\n+        Thread t = new InnocuousThread(INNOCUOUSTHREADGROUP,\n+                target, name, loader);\n+        if (priority >= 0) {\n+            t.setPriority(priority);\n+        }\n+        return t;\n+    }\n+\n@@ -170,7 +197,11 @@\n-            INNOCUOUSTHREADGROUP = AccessController.doPrivileged(\n-                new PrivilegedAction<ThreadGroup>() {\n-                    @Override\n-                    public ThreadGroup run() {\n-                        return new ThreadGroup(root, \"InnocuousThreadGroup\");\n-                    }\n-                });\n+            if (System.getSecurityManager() == null) {\n+                INNOCUOUSTHREADGROUP = new ThreadGroup(root, \"InnocuousThreadGroup\");\n+            } else {\n+                INNOCUOUSTHREADGROUP = AccessController.doPrivileged(\n+                    new PrivilegedAction<ThreadGroup>() {\n+                        @Override\n+                        public ThreadGroup run() {\n+                            return new ThreadGroup(root, \"InnocuousThreadGroup\");\n+                        }\n+                    });\n+            }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/misc\/InnocuousThread.java","additions":46,"deletions":15,"binary":false,"changes":61,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -31,2 +31,0 @@\n-import java.security.AccessController;\n-import java.security.PrivilegedAction;\n@@ -45,8 +43,2 @@\n-            return AccessController.doPrivileged(new PrivilegedAction<>() {\n-                @Override\n-                public Thread run() {\n-                    Thread t = InnocuousThread.newSystemThread(\"Common-Cleaner\", r);\n-                    t.setPriority(Thread.MAX_PRIORITY - 2);\n-                    return t;\n-                }\n-            });\n+            return InnocuousThread.newSystemThread(\"Common-Cleaner\",\n+                    r, Thread.MAX_PRIORITY - 2);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/ref\/CleanerFactory.java","additions":3,"deletions":11,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -216,9 +216,2 @@\n-            return AccessController.doPrivileged(new PrivilegedAction<>() {\n-                @Override\n-                public Thread run() {\n-                    Thread t = InnocuousThread.newThread(r);\n-                    t.setPriority(Thread.MAX_PRIORITY - 2);\n-                    t.setName(\"Cleaner-\" + cleanerThreadNumber.getAndIncrement());\n-                    return t;\n-                }\n-            });\n+            return InnocuousThread.newThread(\"Cleaner-\" + cleanerThreadNumber.getAndIncrement(),\n+                r, Thread.MIN_PRIORITY - 2);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/ref\/CleanerImpl.java","additions":2,"deletions":9,"binary":false,"changes":11,"status":"modified"}]}