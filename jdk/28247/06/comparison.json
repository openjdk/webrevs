{"files":[{"patch":"@@ -34,9 +34,24 @@\n-  enum Type {\n-    _alloc_shared,      \/\/ Allocate common, outside of TLAB\n-    _alloc_shared_gc,   \/\/ Allocate common, outside of GCLAB\/PLAB\n-    _alloc_cds,         \/\/ Allocate for CDS\n-    _alloc_tlab,        \/\/ Allocate TLAB\n-    _alloc_gclab,       \/\/ Allocate GCLAB\n-    _alloc_plab,        \/\/ Allocate PLAB\n-    _ALLOC_LIMIT\n-  };\n+  \/\/ bit 0: mutator (0) or GC (1) alloc\n+  \/\/ bit 1: shared (0) or LAB (1) alloc\n+  \/\/ bit 2: if LAB, then GCLAB (0) or PLAB (1)\n+  \/\/ bit 3: if mutator, then normal (0) or CDS (1)\n+  \/\/ bit 4: if GC and shared, then YOUNG_GENERATION (0) or OLD_GENERATION (1); PLAB is always OLD_GENERATION (1)\n+  \/\/ bit 5: if GC shared OLD_GENERATION alloc, then non-promotion (0) or promotion (1).\n+  typedef int Type;\n+\n+  static constexpr int bit_gc_alloc         = 1 << 0;\n+  static constexpr int bit_lab_alloc        = 1 << 1;\n+  static constexpr int bit_plab_alloc       = 1 << 2;\n+  static constexpr int bit_cds_alloc        = 1 << 3;\n+  static constexpr int bit_old_alloc        = 1 << 4;\n+  static constexpr int bit_promotion_alloc  = 1 << 5;\n+\n+\n+  static constexpr Type _alloc_shared              = 0;\n+  static constexpr Type _alloc_tlab                = bit_lab_alloc;\n+  static constexpr Type _alloc_cds                 = bit_cds_alloc;\n+  static constexpr Type _alloc_shared_gc           = bit_gc_alloc;\n+  static constexpr Type _alloc_shared_gc_old       = _alloc_shared_gc | bit_old_alloc;\n+  static constexpr Type _alloc_shared_gc_promotion = _alloc_shared_gc_old | bit_promotion_alloc;\n+  static constexpr Type _alloc_gclab               = bit_gc_alloc | bit_lab_alloc;\n+  static constexpr Type _alloc_plab                = bit_gc_alloc | bit_lab_alloc | bit_plab_alloc | bit_old_alloc;\n@@ -46,4 +61,0 @@\n-      case _alloc_shared:\n-        return \"Shared\";\n-      case _alloc_shared_gc:\n-        return \"Shared GC\";\n@@ -54,0 +65,8 @@\n+      case _alloc_shared:\n+        return \"Shared\";\n+      case _alloc_shared_gc:\n+        return \"Shared GC\";\n+      case _alloc_shared_gc_old:\n+        return \"Shared GC Old\";\n+      case _alloc_shared_gc_promotion:\n+        return \"Shared GC Promotion\";\n@@ -83,6 +102,0 @@\n-  \/\/ This is the generation which the request is targeting.\n-  ShenandoahAffiliation const _affiliation;\n-\n-  \/\/ True if this request is trying to copy any object from young to old (promote).\n-  bool _is_promotion;\n-\n@@ -94,1 +107,1 @@\n-  ShenandoahAllocRequest(size_t _min_size, size_t _requested_size, Type _alloc_type, ShenandoahAffiliation affiliation, bool is_promotion = false) :\n+  ShenandoahAllocRequest(size_t _min_size, size_t _requested_size, Type _alloc_type) :\n@@ -96,1 +109,1 @@\n-          _actual_size(0), _waste(0), _alloc_type(_alloc_type), _affiliation(affiliation), _is_promotion(is_promotion)\n+          _actual_size(0), _waste(0), _alloc_type(_alloc_type)\n@@ -104,1 +117,1 @@\n-    return ShenandoahAllocRequest(min_size, requested_size, _alloc_tlab, ShenandoahAffiliation::YOUNG_GENERATION);\n+    return ShenandoahAllocRequest(min_size, requested_size, _alloc_tlab);\n@@ -108,1 +121,1 @@\n-    return ShenandoahAllocRequest(min_size, requested_size, _alloc_gclab, ShenandoahAffiliation::YOUNG_GENERATION);\n+    return ShenandoahAllocRequest(min_size, requested_size, _alloc_gclab);\n@@ -112,1 +125,1 @@\n-    return ShenandoahAllocRequest(min_size, requested_size, _alloc_plab, ShenandoahAffiliation::OLD_GENERATION);\n+    return ShenandoahAllocRequest(min_size, requested_size, _alloc_plab);\n@@ -118,1 +131,1 @@\n-      return ShenandoahAllocRequest(0, requested_size, _alloc_shared_gc, affiliation, true);\n+      return ShenandoahAllocRequest(0, requested_size, _alloc_shared_gc_promotion);\n@@ -120,1 +133,4 @@\n-    return ShenandoahAllocRequest(0, requested_size, _alloc_shared_gc, affiliation);\n+    if (affiliation ==OLD_GENERATION) {\n+      return ShenandoahAllocRequest(0, requested_size, _alloc_shared_gc_old);\n+    }\n+    return ShenandoahAllocRequest(0, requested_size, _alloc_shared_gc);\n@@ -124,1 +140,1 @@\n-    return ShenandoahAllocRequest(0, requested_size, _alloc_shared, ShenandoahAffiliation::YOUNG_GENERATION);\n+    return ShenandoahAllocRequest(0, requested_size, _alloc_shared);\n@@ -128,1 +144,1 @@\n-    return ShenandoahAllocRequest(0, requested_size, _alloc_cds, ShenandoahAffiliation::YOUNG_GENERATION);\n+    return ShenandoahAllocRequest(0, requested_size, _alloc_cds);\n@@ -170,13 +186,1 @@\n-    switch (_alloc_type) {\n-      case _alloc_tlab:\n-      case _alloc_shared:\n-      case _alloc_cds:\n-        return true;\n-      case _alloc_gclab:\n-      case _alloc_plab:\n-      case _alloc_shared_gc:\n-        return false;\n-      default:\n-        ShouldNotReachHere();\n-        return false;\n-    }\n+    return (_alloc_type & bit_gc_alloc) == 0;\n@@ -186,13 +190,1 @@\n-    switch (_alloc_type) {\n-      case _alloc_tlab:\n-      case _alloc_shared:\n-      case _alloc_cds:\n-        return false;\n-      case _alloc_gclab:\n-      case _alloc_plab:\n-      case _alloc_shared_gc:\n-        return true;\n-      default:\n-        ShouldNotReachHere();\n-        return false;\n-    }\n+    return (_alloc_type & bit_gc_alloc) != 0;\n@@ -202,13 +194,1 @@\n-    switch (_alloc_type) {\n-      case _alloc_tlab:\n-      case _alloc_gclab:\n-      case _alloc_plab:\n-        return true;\n-      case _alloc_shared:\n-      case _alloc_shared_gc:\n-      case _alloc_cds:\n-        return false;\n-      default:\n-        ShouldNotReachHere();\n-        return false;\n-    }\n+    return (_alloc_type & bit_lab_alloc) != 0;\n@@ -218,1 +198,1 @@\n-    return _affiliation == OLD_GENERATION;\n+    return (_alloc_type & bit_old_alloc) != 0;\n@@ -222,1 +202,1 @@\n-    return _affiliation == YOUNG_GENERATION;\n+    return (_alloc_type & bit_old_alloc) == 0;\n@@ -226,1 +206,1 @@\n-    return _affiliation;\n+    return (_alloc_type & bit_old_alloc) == 0 ? YOUNG_GENERATION : OLD_GENERATION ;\n@@ -230,1 +210,1 @@\n-    return shenandoah_affiliation_name(_affiliation);\n+    return shenandoah_affiliation_name(affiliation());\n@@ -234,1 +214,1 @@\n-    return _is_promotion;\n+    return (_alloc_type & bit_promotion_alloc) != 0;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocRequest.hpp","additions":52,"deletions":72,"binary":false,"changes":124,"status":"modified"},{"patch":"@@ -1314,11 +1314,4 @@\n-  switch (req.type()) {\n-    case ShenandoahAllocRequest::_alloc_tlab:\n-    case ShenandoahAllocRequest::_alloc_shared:\n-    case ShenandoahAllocRequest::_alloc_cds:\n-      return allocate_for_mutator(req, in_new_region);\n-    case ShenandoahAllocRequest::_alloc_gclab:\n-    case ShenandoahAllocRequest::_alloc_plab:\n-    case ShenandoahAllocRequest::_alloc_shared_gc:\n-      return allocate_for_collector(req, in_new_region);\n-    default:\n-      ShouldNotReachHere();\n+  if (req.is_mutator_alloc()) {\n+    return allocate_for_mutator(req, in_new_region);\n+  } else {\n+    return allocate_for_collector(req, in_new_region);\n@@ -1326,1 +1319,0 @@\n-  return nullptr;\n@@ -1616,1 +1608,0 @@\n-  size_t ac = alloc_capacity(r);\n@@ -1618,1 +1609,0 @@\n-  ShenandoahGeneration* request_generation = nullptr;\n@@ -1620,1 +1610,3 @@\n-    request_generation = _heap->mode()->is_generational()? _heap->young_generation(): _heap->global_generation();\n+    assert(req.type() == ShenandoahAllocRequest::_alloc_tlab ||\n+           req.type() == ShenandoahAllocRequest::_alloc_shared ||\n+           req.type() == ShenandoahAllocRequest::_alloc_cds, \"Must be one of the mutator alloc types.\");\n@@ -1622,5 +1614,4 @@\n-  } else if (req.type() == ShenandoahAllocRequest::_alloc_gclab) {\n-    request_generation = _heap->mode()->is_generational()? _heap->young_generation(): _heap->global_generation();\n-    orig_partition = ShenandoahFreeSetPartitionId::Collector;\n-  } else if (req.type() == ShenandoahAllocRequest::_alloc_plab) {\n-    request_generation = _heap->old_generation();\n+  } else if (req.is_old()) {\n+    assert(req.type() == ShenandoahAllocRequest::_alloc_shared_gc_old ||\n+           req.type() == ShenandoahAllocRequest::_alloc_shared_gc_promotion ||\n+           req.type() == ShenandoahAllocRequest::_alloc_plab, \"Must be one of the old alloc types.\");\n@@ -1629,8 +1620,3 @@\n-    assert(req.type() == ShenandoahAllocRequest::_alloc_shared_gc, \"Unexpected allocation type\");\n-    if (req.is_old()) {\n-      request_generation = _heap->old_generation();\n-      orig_partition = ShenandoahFreeSetPartitionId::OldCollector;\n-    } else {\n-      request_generation = _heap->mode()->is_generational()? _heap->young_generation(): _heap->global_generation();\n-      orig_partition = ShenandoahFreeSetPartitionId::Collector;\n-    }\n+    assert(req.type() == ShenandoahAllocRequest::_alloc_shared_gc ||\n+           req.type() == ShenandoahAllocRequest::_alloc_gclab, \"Must be.\");\n+    orig_partition = ShenandoahFreeSetPartitionId::Collector;\n@@ -3272,1 +3258,0 @@\n-      case ShenandoahAllocRequest::_alloc_shared_gc:\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahFreeSet.cpp","additions":14,"deletions":29,"binary":false,"changes":43,"status":"modified"},{"patch":"@@ -132,0 +132,2 @@\n+    case ShenandoahAllocRequest::_alloc_shared_gc_old:\n+    case ShenandoahAllocRequest::_alloc_shared_gc_promotion:\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.inline.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}