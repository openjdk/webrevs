{"files":[{"patch":"@@ -34,0 +34,2 @@\n+import jdk.internal.classfile.impl.BytecodeHelpers;\n+import jdk.internal.classfile.impl.Util;\n@@ -85,1 +87,32 @@\n-        return new AbstractInstruction.UnboundIncrementInstruction(slot, constant);\n+        var opcode = BytecodeHelpers.validateAndIsWideIinc(slot, constant) ? Opcode.IINC_W: Opcode.IINC;\n+        return new AbstractInstruction.UnboundIncrementInstruction(opcode, slot, constant);\n+    }\n+\n+    \/**\n+     * {@return an increment instruction}\n+     * <p>\n+     * {@code slot} must be {@link java.lang.classfile##u1 u1} and\n+     * {@code constant} must be within {@code [-128, 127]} for\n+     * {@link Opcode#IINC iinc}, or {@code slot} must be\n+     * {@link java.lang.classfile##u2 u2} and {@code constant} must be\n+     * within {@code [-32768, 32767]} for {@link Opcode#IINC_W wide iinc}.\n+     *\n+     * @apiNote\n+     * The explicit {@code op} argument allows creating {@code wide} or\n+     * regular increment instructions when {@code slot} and\n+     * {@code constant} can be encoded with more optimized\n+     * increment instructions.\n+     *\n+     * @param op the opcode for the specific type of increment instruction,\n+     *           which must be of kind {@link Opcode.Kind#INCREMENT}\n+     * @param slot the local variable slot to increment\n+     * @param constant the increment constant\n+     * @throws IllegalArgumentException if the opcode kind is not\n+     *         {@link Opcode.Kind#INCREMENT} or {@code slot} or\n+     *         {@code constant} is out of range\n+     * @since 27\n+     *\/\n+    static IncrementInstruction of(Opcode op, int slot, int constant) {\n+        Util.checkKind(op, Opcode.Kind.INCREMENT);\n+        BytecodeHelpers.validateIncrement(op, slot, constant);\n+        return new AbstractInstruction.UnboundIncrementInstruction(op, slot, constant);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/classfile\/instruction\/IncrementInstruction.java","additions":34,"deletions":1,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -835,4 +835,2 @@\n-        public UnboundIncrementInstruction(int slot, int constant) {\n-            super(BytecodeHelpers.validateAndIsWideIinc(slot, constant)\n-                  ? Opcode.IINC_W\n-                  : Opcode.IINC);\n+        public UnboundIncrementInstruction(Opcode op, int slot, int constant) {\n+            super(op);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/AbstractInstruction.java","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -453,0 +453,7 @@\n+    public static void validateIncrement(Opcode opcode, int slot, int constant) {\n+        if (validateAndIsWideIinc(slot, constant) && opcode != Opcode.IINC_W) {\n+            throw new IllegalArgumentException(\n+                    \"IINC: operands require wide encoding for %s\".formatted(opcode));\n+        }\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/BytecodeHelpers.java","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -198,0 +198,1 @@\n+            check(fails, () -> IncrementInstruction.of(IINC_W, i, 1));\n@@ -211,0 +212,1 @@\n+            check(fails, () -> IncrementInstruction.of(IINC, i, 1));\n@@ -253,0 +255,7 @@\n+        IncrementInstruction.of(IINC, 0, 2);\n+        IncrementInstruction.of(IINC, 0, Byte.MIN_VALUE);\n+        IncrementInstruction.of(IINC, 0, Byte.MAX_VALUE);\n+        IncrementInstruction.of(IINC_W, 0, 2);\n+        IncrementInstruction.of(IINC_W, 0, Short.MIN_VALUE);\n+        IncrementInstruction.of(IINC_W, 0, Short.MAX_VALUE);\n+\n@@ -260,0 +269,6 @@\n+        for (int i : new int[] {Byte.MIN_VALUE - 1, Byte.MAX_VALUE + 1}) {\n+            assertThrows(IllegalArgumentException.class, () -> IncrementInstruction.of(IINC, 0, i));\n+        }\n+        for (int i : new int[] {Short.MIN_VALUE - 1, Short.MAX_VALUE + 1}) {\n+            assertThrows(IllegalArgumentException.class, () -> IncrementInstruction.of(IINC_W, 0, i));\n+        }\n","filename":"test\/jdk\/jdk\/classfile\/InstructionValidationTest.java","additions":15,"deletions":0,"binary":false,"changes":15,"status":"modified"}]}