[{"commit":{"message":"Merge branch 'master' into JDK-8354242"},"files":[{"filename":"src\/hotspot\/share\/opto\/node.cpp"}],"sha":"1b9c3b363fcc296956663249ef95d60a26a704d2"},{"commit":{"message":"8354242: VectorAPI: combine vector not operation with compare\n\nThis patch optimizes the following patterns:\nFor integer types:\n```\n(XorV (VectorMaskCmp src1 src2 cond) (Replicate -1))\n    => (VectorMaskCmp src1 src2 ncond)\n(XorVMask (VectorMaskCmp src1 src2 cond) (MaskAll m1))\n    => (VectorMaskCmp src1 src2 ncond)\n```\ncond can be eq, ne, le, ge, lt, gt, ule, uge, ult and ugt, ncond is the\nnegative comparison of cond.\n\nFor float and double types:\n```\n(XorV (VectorMaskCast (VectorMaskCmp src1 src2 cond)) (Replicate -1))\n    => (VectorMaskCast (VectorMaskCmp src1 src2 ncond))\n(XorVMask (VectorMaskCast (VectorMaskCmp src1 src2 cond)) (MaskAll m1))\n    => (VectorMaskCast (VectorMaskCmp src1 src2 ncond))\n```\ncond can be eq or ne.\n\nBenchmarks on Nvidia Grace machine with 128-bit SVE2:\nWith option `-XX:UseSVE=2`:\n```\nBenchmark\t\t\tUnit\tBefore\t\tScore Error\tAfter\t\tScore Error\tUplift\ntestCompareEQMaskNotByte\tops\/s\t7912127.225\t2677.289518\t10266136.26\t8955.008548\t1.29\ntestCompareEQMaskNotDouble\tops\/s\t884737.6799\t446.963779\t1179760.772\t448.031844\t1.33\ntestCompareEQMaskNotFloat\tops\/s\t1765045.787\t682.332214\t2359520.803\t896.305743\t1.33\ntestCompareEQMaskNotInt\t\tops\/s\t1787221.411\t977.743935\t2353952.519\t960.069976\t1.31\ntestCompareEQMaskNotLong\tops\/s\t895297.1974\t673.44808\t1178449.02\t323.804205\t1.31\ntestCompareEQMaskNotShort\tops\/s\t3339987.002\t3415.2226\t4712761.965\t2110.862053\t1.41\ntestCompareGEMaskNotByte\tops\/s\t7907615.16\t4094.243652\t10251646.9\t9486.699831\t1.29\ntestCompareGEMaskNotInt\t\tops\/s\t1683738.958\t4233.813092\t2352855.205\t1251.952546\t1.39\ntestCompareGEMaskNotLong\tops\/s\t854496.1561\t8594.598885\t1177811.493\t521.1229\t1.37\ntestCompareGEMaskNotShort\tops\/s\t3341860.309\t1578.975338\t4714008.434\t1681.10365\t1.41\ntestCompareGTMaskNotByte\tops\/s\t7910823.674\t2993.367032\t10245063.58\t9774.75138\t1.29\ntestCompareGTMaskNotInt\t\tops\/s\t1673393.928\t3153.099431\t2353654.521\t1190.848583\t1.4\ntestCompareGTMaskNotLong\tops\/s\t849405.9159\t2432.858159\t1177952.041\t359.96413\t1.38\ntestCompareGTMaskNotShort\tops\/s\t3339509.141\t3339.976585\t4711442.496\t2673.364893\t1.41\ntestCompareLEMaskNotByte\tops\/s\t7911340.004\t3114.69191\t10231626.5\t27134.20035\t1.29\ntestCompareLEMaskNotInt\t\tops\/s\t1675812.113\t1340.969885\t2353255.341\t1452.4522\t1.4\ntestCompareLEMaskNotLong\tops\/s\t848862.8036\t6564.841731\t1177763.623\t539.290106\t1.38\ntestCompareLEMaskNotShort\tops\/s\t3324951.54\t2380.29473\t4712116.251\t1544.559684\t1.41\ntestCompareLTMaskNotByte\tops\/s\t7910390.844\t2630.861436\t10239567.69\t6487.441672\t1.29\ntestCompareLTMaskNotInt\t\tops\/s\t1672180.09\t995.238142\t2353757.863\t853.774734\t1.4\ntestCompareLTMaskNotLong\tops\/s\t856502.2695\t12276.82851\t1177671.815\t496.723302\t1.37\ntestCompareLTMaskNotShort\tops\/s\t3325798.025\t2412.702501\t4711554.181\t1779.302112\t1.41\ntestCompareNEMaskNotByte\tops\/s\t7910002.518\t2771.82477\t10245315.33\t16321.93935\t1.29\ntestCompareNEMaskNotDouble\tops\/s\t863754.6022\t523.140788\t1179133.982\t476.572178\t1.36\ntestCompareNEMaskNotFloat\tops\/s\t1723321.883\t2598.484803\t2358492.186\t877.1401\t1.36\ntestCompareNEMaskNotInt\t\tops\/s\t1670288.841\t751.774826\t2354158.125\t835.720163\t1.4\ntestCompareNEMaskNotLong\tops\/s\t836327.6835\t410.525466\t1178178.825\t308.757932\t1.4\ntestCompareNEMaskNotShort\tops\/s\t3327815.841\t1511.978763\t4711379.136\t2336.505531\t1.41\ntestCompareUGEMaskNotByte\tops\/s\t7906699.024\t3200.936474\t10253843.74\t15067.59401\t1.29\ntestCompareUGEMaskNotInt\tops\/s\t1674003.923\t3287.191727\t2353340.666\t951.381021\t1.4\ntestCompareUGEMaskNotLong\tops\/s\t852424.5562\t8920.408939\t1177943.609\t389.6621\t1.38\ntestCompareUGEMaskNotShort\tops\/s\t3327255.858\t1584.885143\t4711622.355\t1247.215277\t1.41\ntestCompareUGTMaskNotByte\tops\/s\t7909249.189\t4435.283667\t10245541.34\t10993.34739\t1.29\ntestCompareUGTMaskNotInt\tops\/s\t1693713.433\t20650.00213\t2353153.787\t1055.343846\t1.38\ntestCompareUGTMaskNotLong\tops\/s\t851022.3395\t7079.065268\t1177910.677\t538.604598\t1.38\ntestCompareUGTMaskNotShort\tops\/s\t3327236.988\t1616.886789\t4711209.865\t3098.494145\t1.41\ntestCompareULEMaskNotByte\tops\/s\t7909350.825\t3251.262342\t10261449.03\t7273.831341\t1.29\ntestCompareULEMaskNotInt\tops\/s\t1672350.925\t1545.304304\t2353231.755\t914.231193\t1.4\ntestCompareULEMaskNotLong\tops\/s\t853349.4765\t9804.906913\t1177967.254\t435.044367\t1.38\ntestCompareULEMaskNotShort\tops\/s\t3325757.891\t1555.062257\t4712873.187\t1650.986905\t1.41\ntestCompareULTMaskNotByte\tops\/s\t7912218.621\t2633.477744\t10242095.98\t21921.39902\t1.29\ntestCompareULTMaskNotInt\tops\/s\t1673994.849\t2672.507666\t2353449.22\t946.105757\t1.4\ntestCompareULTMaskNotLong\tops\/s\t849032.5868\t10406.06689\t1177586.047\t506.541456\t1.38\ntestCompareULTMaskNotShort\tops\/s\t3328062.026\t1892.991844\t4713247.216\t1855.983724\t1.41\n\n```\nWith option `-XX:UseSVE=0`:\n```\nBenchmark\t\t\tUnit\tBefore\t\tScore Error\tAfter\t\tScore Error\tUplift\ntestCompareEQMaskNotByte\tops\/s\t7895961.919\t72712.90804\t7746493.731\t71481.92938\t0.98\ntestCompareEQMaskNotDouble\tops\/s\t789811.0455\t384.493088\t766473.7994\t2216.581793\t0.97\ntestCompareEQMaskNotFloat\tops\/s\t1806305.818\t638.010451\t1819616.613\t3295.38958\t1\ntestCompareEQMaskNotInt\t\tops\/s\t1815820.144\t1225.336135\t1849538.401\t766.29902\t1.01\ntestCompareEQMaskNotLong\tops\/s\t807336.492\t335.451807\t792732.9483\t277.954432\t0.98\ntestCompareEQMaskNotShort\tops\/s\t4818266.38\t1927.862665\t4668903.001\t1922.782715\t0.96\ntestCompareGEMaskNotByte\tops\/s\t7818439.678\t75374.97739\t16498003.98\t41440.49653\t2.11\ntestCompareGEMaskNotInt\t\tops\/s\t1815159.05\t1090.912209\t2372095.779\t1664.397112\t1.3\ntestCompareGEMaskNotLong\tops\/s\t804324.5575\t2301.686878\t927919.8507\t371.766719\t1.15\ntestCompareGEMaskNotShort\tops\/s\t4818966.563\t2443.643652\t5385561.038\t29558.37423\t1.11\ntestCompareGTMaskNotByte\tops\/s\t7893406.157\t82687.74264\t16470663.2\t22165.55812\t2.08\ntestCompareGTMaskNotInt\t\tops\/s\t1815316.812\t915.894106\t2370447.198\t655.016338\t1.3\ntestCompareGTMaskNotLong\tops\/s\t807019.456\t526.525482\t928079.0541\t330.582693\t1.15\ntestCompareGTMaskNotShort\tops\/s\t4820552.881\t1684.247747\t5355902.93\t5893.2915\t1.11\ntestCompareLEMaskNotByte\tops\/s\t7816263.323\t79560.0015\t16473621.19\t56688.99585\t2.1\ntestCompareLEMaskNotInt\t\tops\/s\t1814915.724\t926.998625\t2368790.306\t932.594778\t1.3\ntestCompareLEMaskNotLong\tops\/s\t806483.9\t935.718082\t928110.9074\t407.096695\t1.15\ntestCompareLEMaskNotShort\tops\/s\t4813660.241\t6817.870509\t5357107.852\t10061.47975\t1.11\ntestCompareLTMaskNotByte\tops\/s\t7838948.962\t69136.4504\t16424405.96\t24464.75469\t2.09\ntestCompareLTMaskNotInt\t\tops\/s\t1815056.833\t1187.6453\t2369892.187\t1103.819634\t1.3\ntestCompareLTMaskNotLong\tops\/s\t806602.1804\t287.923365\t928346.4118\t617.682824\t1.15\ntestCompareLTMaskNotShort\tops\/s\t4817940.643\t2767.1509\t5372537.84\t15397.47169\t1.11\ntestCompareNEMaskNotByte\tops\/s\t9078493.798\t4630.339307\t16484348.42\t18925.88346\t1.81\ntestCompareNEMaskNotDouble\tops\/s\t661769.6272\t398.712981\t926763.5839\t1808.843788\t1.4\ntestCompareNEMaskNotFloat\tops\/s\t1570527.252\t563.642144\t2312425.678\t1815.844846\t1.47\ntestCompareNEMaskNotInt\t\tops\/s\t1619146.58\t626.793854\t2369711.543\t942.330478\t1.46\ntestCompareNEMaskNotLong\tops\/s\t680201.5381\t2252.836482\t927808.6147\t414.917863\t1.36\ntestCompareNEMaskNotShort\tops\/s\t3763508.054\t3622.560798\t5367808.015\t8591.466599\t1.42\ntestCompareUGEMaskNotByte\tops\/s\t7886373.129\t75917.74675\t16480928.93\t27524.31005\t2.08\ntestCompareUGEMaskNotInt\tops\/s\t1815636.832\t750.036241\t2369683.015\t901.609404\t1.3\ntestCompareUGEMaskNotLong\tops\/s\t806862.5826\t287.819616\t928001.4394\t361.063837\t1.15\ntestCompareUGEMaskNotShort\tops\/s\t4820581.361\t2098.537435\t5375854.248\t25619.40165\t1.11\ntestCompareUGTMaskNotByte\tops\/s\t7891591.465\t96614.93542\t16410405.93\t15012.37096\t2.07\ntestCompareUGTMaskNotInt\tops\/s\t1814871.179\t662.825588\t2371325.903\t1170.491164\t1.3\ntestCompareUGTMaskNotLong\tops\/s\t804013.7658\t2240.534209\t928062.2169\t531.306897\t1.15\ntestCompareUGTMaskNotShort\tops\/s\t4818150.337\t3051.717685\t5381449.337\t21212.34187\t1.11\ntestCompareULEMaskNotByte\tops\/s\t7831540.628\t81306.67253\t16495250.78\t38682.19675\t2.1\ntestCompareULEMaskNotInt\tops\/s\t1814484.14\t687.860656\t2369265.075\t940.609586\t1.3\ntestCompareULEMaskNotLong\tops\/s\t807780.5749\t769.876816\t927538.0732\t1278.267724\t1.14\ntestCompareULEMaskNotShort\tops\/s\t4817437.42\t5141.336541\t5356183.359\t7015.608124\t1.11\ntestCompareULTMaskNotByte\tops\/s\t7849078.225\t56753.59764\t16395975.27\t34043.67295\t2.08\ntestCompareULTMaskNotInt\tops\/s\t1814328.226\t2697.219111\t2370700.47\t1991.841988\t1.3\ntestCompareULTMaskNotLong\tops\/s\t807166.8197\t253.061506\t927926.2803\t252.933462\t1.14\ntestCompareULTMaskNotShort\tops\/s\t4821098.216\t1625.959044\t5348980.243\t4100.768121\t1.1\n```\n\nBenchmarks on AMD EPYC 9124 16-Core Processor:\nWith option `-XX:UseAVX=3`:\n```\nBenchmark\t\t\tUnit\tBefore\t\tScore Error\tAfter\t\tScore Error\tUplift\ntestCompareEQMaskNotByte\tops\/s\t16607323.35\t1233692.631\t18381557.66\t1163201.522\t1.1\ntestCompareEQMaskNotDouble\tops\/s\t2114285.245\t58782.2534\t2959946.353\t43016.0445\t1.39\ntestCompareEQMaskNotFloat\tops\/s\t4480874.437\t89975.29074\t6960151.436\t64799.143\t1.55\ntestCompareEQMaskNotInt\t\tops\/s\t4370906.91\t51784.80889\t6856955.043\t313858.5504\t1.56\ntestCompareEQMaskNotLong\tops\/s\t2080065.895\t26762.06732\t2939142.143\t67179.05314\t1.41\ntestCompareEQMaskNotShort\tops\/s\t7968282.563\t210437.2781\t12701214.56\t473152.6407\t1.59\ntestCompareGEMaskNotByte\tops\/s\t18419141.89\t473408.9451\t19880059.68\t321638.0397\t1.07\ntestCompareGEMaskNotInt\t\tops\/s\t4419015.62\t77352.98633\t7037639.227\t151066.0383\t1.59\ntestCompareGEMaskNotLong\tops\/s\t2147982.48\t49227.42782\t3000275.928\t39298.75344\t1.39\ntestCompareGEMaskNotShort\tops\/s\t8469039.613\t17833.19707\t12288229.49\t244317.8812\t1.45\ntestCompareGTMaskNotByte\tops\/s\t18728997.5\t468328.8358\t20544730.05\t392264.6466\t1.09\ntestCompareGTMaskNotInt\t\tops\/s\t4510009.705\t78812.57357\t7364629.942\t70970.78473\t1.63\ntestCompareGTMaskNotLong\tops\/s\t2124104.969\t40917.89257\t2953536.279\t35199.19687\t1.39\ntestCompareGTMaskNotShort\tops\/s\t8690557.621\t311534.1159\t12344017.51\t457931.8741\t1.42\ntestCompareLEMaskNotByte\tops\/s\t17758400.53\t478383.4945\t19209183.26\t1143297.241\t1.08\ntestCompareLEMaskNotInt\t\tops\/s\t4363664.862\t43443.18063\t7054093.064\t78141.11476\t1.61\ntestCompareLEMaskNotLong\tops\/s\t2068632.213\t29844.78023\t2954766.412\t50667.22502\t1.42\ntestCompareLEMaskNotShort\tops\/s\t8637608.548\t183538.5511\t12719010.27\t473568.8825\t1.47\ntestCompareLTMaskNotByte\tops\/s\t14406138.95\t423105.0163\t17292417.96\t371386.9689\t1.2\ntestCompareLTMaskNotInt\t\tops\/s\t4546707.266\t131977.3144\t7040483.394\t213590.4657\t1.54\ntestCompareLTMaskNotLong\tops\/s\t2123277.356\t47243.21499\t2848720.442\t58896.97045\t1.34\ntestCompareLTMaskNotShort\tops\/s\t7570169.363\t649873.6295\t11945383.75\t988276.5955\t1.57\ntestCompareNEMaskNotByte\tops\/s\t18274529.55\t683396.7384\t19081938.8\t1118739.778\t1.04\ntestCompareNEMaskNotDouble\tops\/s\t2112533.61\t43295.50012\t2912115.441\t78189.51083\t1.37\ntestCompareNEMaskNotFloat\tops\/s\t4628683.814\t93817.07362\t6967208.729\t145135.8544\t1.5\ntestCompareNEMaskNotInt\t\tops\/s\t4470900.214\t75974.50842\t7286913.662\t116328.5277\t1.62\ntestCompareNEMaskNotLong\tops\/s\t2134091.061\t46377.94061\t2934667.477\t81675.46021\t1.37\ntestCompareNEMaskNotShort\tops\/s\t8790384.287\t396161.8599\t13076858.35\t286272.1155\t1.48\ntestCompareUGEMaskNotByte\tops\/s\t18009150.9\t660803.8886\t17551258.33\t1667014.843\t0.97\ntestCompareUGEMaskNotInt\tops\/s\t4442928.74\t83190.81019\t6854088.277\t329008.8901\t1.54\ntestCompareUGEMaskNotLong\tops\/s\t2088357.736\t71696.24791\t2973202.26\t63278.78974\t1.42\ntestCompareUGEMaskNotShort\tops\/s\t8348624.02\t116562.7876\t12832250.78\t546869.3006\t1.53\ntestCompareUGTMaskNotByte\tops\/s\t17871101.25\t800199.6321\t19902619.81\t214003.3262\t1.11\ntestCompareUGTMaskNotInt\tops\/s\t4088304.421\t137797.9723\t7135454.33\t124553.651\t1.74\ntestCompareUGTMaskNotLong\tops\/s\t2070610.42\t19881.82182\t2991536.365\t36260.60767\t1.44\ntestCompareUGTMaskNotShort\tops\/s\t8637099.341\t155822.1608\t12756579.77\t186068.199\t1.47\ntestCompareULEMaskNotByte\tops\/s\t17940901.36\t1258029.364\t18932484.94\t694554.6305\t1.05\ntestCompareULEMaskNotInt\tops\/s\t4369177.511\t74982.31936\t6392773.082\t550171.2266\t1.46\ntestCompareULEMaskNotLong\tops\/s\t2135905.761\t43693.63178\t2877579.631\t41651.56289\t1.34\ntestCompareULEMaskNotShort\tops\/s\t8607710.544\t132655.1676\t12446370.04\t441718.3035\t1.44\ntestCompareULTMaskNotByte\tops\/s\t17409912.23\t1033204.537\t20607479.99\t362000.5056\t1.18\ntestCompareULTMaskNotInt\tops\/s\t4386455.9\t119192.1635\t6920123.264\t186158.2845\t1.57\ntestCompareULTMaskNotLong\tops\/s\t2064995.149\t38622.2734\t2988343.589\t39037.90006\t1.44\ntestCompareULTMaskNotShort\tops\/s\t8642182.752\t230919.2442\t13029582.09\t437101.4923\t1.5\n```\n\nThe small amount of performance degradation is due to test fluctuations."},"files":[{"filename":"src\/hotspot\/share\/opto\/node.cpp"},{"filename":"src\/hotspot\/share\/opto\/vectornode.cpp"},{"filename":"src\/hotspot\/share\/opto\/vectornode.hpp"},{"filename":"test\/hotspot\/jtreg\/compiler\/vectorapi\/VectorMaskCompareNotTest.java"},{"filename":"test\/micro\/org\/openjdk\/bench\/jdk\/incubator\/vector\/MaskCompareNotBenchmark.java"}],"sha":"1f3c5899acaf6ac6bb09d2497b6b1b78ba3a92b3"}]