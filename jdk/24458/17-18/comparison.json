{"files":[{"patch":"@@ -1698,2 +1698,3 @@\n-  if (_phase->is_member(_loop, _phase->get_ctrl(_limit))) { \/\/ Limit must be loop-invariant\n-    return;\n+\n+  if (!_loop->is_invariant(_limit)) { \/\/ Limit must be loop-invariant\n+     return;\n@@ -1709,1 +1710,1 @@\n-bool PhaseIdealLoop::LoopExitTest::canonicalize_mask(jlong stride_con) {\n+void PhaseIdealLoop::LoopExitTest::canonicalize_mask(jlong stride_con) {\n@@ -1711,1 +1712,1 @@\n-    return false;\n+    return;\n@@ -1720,4 +1721,1 @@\n-    return true;\n-  }\n-\n-  if (stride_con == -1) {\n+  } else {\n@@ -1727,1 +1725,0 @@\n-    return true;\n@@ -1729,3 +1726,0 @@\n-\n-  \/\/ Should not reach\n-  return false;\n@@ -1764,2 +1758,2 @@\n-  _node = incr->in(2);\n-  if (!_node->is_Con()) {     \/\/ Oops, swap these\n+  _stride_node = incr->in(2);\n+  if (!_stride_node->is_Con()) {     \/\/ Oops, swap these\n@@ -1770,1 +1764,1 @@\n-    swap(_xphi, _node);        \/\/ 'incr' is commutative, so ok to swap\n+    swap(_xphi, _stride_node);        \/\/ 'incr' is commutative, so ok to swap\n@@ -1777,1 +1771,1 @@\n-  jlong stride_con = node()->get_integer_as_long(iv_bt);\n+  jlong stride_con = stride_node()->get_integer_as_long(iv_bt);\n@@ -1819,3 +1813,0 @@\n-  \/\/ if (!_iv_incr.is_valid_with_bt(_iv_bt)) {\n-  \/\/   return;\n-  \/\/ }\n@@ -1853,1 +1844,1 @@\n-    _sfpt = sfpt->as_SafePoint();\n+    _safepoint = sfpt->as_SafePoint();\n@@ -1855,1 +1846,1 @@\n-    _sfpt = _phase->find_safepoint(_back_control, _head, _loop);\n+    _safepoint = _phase->find_safepoint(_back_control, _head, _loop);\n@@ -2045,1 +2036,1 @@\n-  const TypeInteger* limit_t = igvn->type(_structure.exit_test().limit())->is_integer(_iv_bt);\n+  const TypeInteger* limit_t = igvn->type(_structure.limit())->is_integer(_iv_bt);\n@@ -2051,1 +2042,1 @@\n-  const jlong stride_con = _structure.stride().compute_non_zero_stride_con(_structure.exit_test().mask(), _iv_bt);\n+  const jlong stride_con = _structure.stride_con();\n@@ -2141,0 +2132,1 @@\n+  \/\/\n@@ -2292,1 +2284,1 @@\n-    if (!_phase->is_dominator(_phase->get_ctrl(_structure.exit_test().limit()), loop_limit_check_parse_predicate->in(0))) {\n+    if (!_phase->is_dominator(_phase->get_ctrl(_structure.limit()), loop_limit_check_parse_predicate->in(0))) {\n@@ -2313,1 +2305,1 @@\n-                                           _structure.exit_test().limit(),\n+                                           _structure.limit(),\n@@ -2340,1 +2332,1 @@\n-    if (!_phase->is_dominator(_phase->get_ctrl(_structure.exit_test().limit()), parse_predicate_entry) ||\n+    if (!_phase->is_dominator(_phase->get_ctrl(_structure.limit()), parse_predicate_entry) ||\n@@ -2405,1 +2397,1 @@\n-    \/\/ If the array is shorter than 0x8000 this exits through a AIOOB\n+    \/\/ If the array is shorter than 0x8000 this exits through an AIOOB\n@@ -2412,1 +2404,1 @@\n-      \/\/ if the limit can have a higher value than the increment (before the0 phi)\n+      \/\/ if the limit can have a higher value than the increment (before the phi)\n@@ -2477,1 +2469,1 @@\n-bool CountedLoopConverter::is_safepoint_invalid(SafePointNode* sfpt) {\n+bool CountedLoopConverter::is_safepoint_invalid(SafePointNode* sfpt) const {\n@@ -2500,1 +2492,1 @@\n-  const jlong stride_con = _structure.stride().compute_non_zero_stride_con(_structure.exit_test().mask(), _iv_bt);\n+  const jlong stride_con = _structure.stride_con();\n@@ -2503,4 +2495,5 @@\n-    Node* cmp_limit = CmpNode::make(_structure.exit_test().limit(), igvn->integercon((stride_con > 0\n-                                                              ? max_signed_integer(_iv_bt)\n-                                                              : min_signed_integer(_iv_bt))\n-                                                                 - _structure.final_limit_correction(), _iv_bt), _iv_bt);\n+    jlong adjusted_stride_con = (stride_con > 0\n+                               ? max_signed_integer(_iv_bt)\n+                               : min_signed_integer(_iv_bt)) - _structure.final_limit_correction();\n+\n+    Node* cmp_limit = CmpNode::make(_structure.limit(), igvn->integercon(adjusted_stride_con, _iv_bt), _iv_bt);\n@@ -2513,1 +2506,1 @@\n-    Node* cmp_limit = CmpNode::make(init_trip, _structure.exit_test().limit(), _iv_bt);\n+    Node* cmp_limit = CmpNode::make(init_trip, _structure.limit(), _iv_bt);\n@@ -2530,1 +2523,1 @@\n-  Node* adjusted_limit = _structure.exit_test().limit();\n+  Node* adjusted_limit = _structure.limit();\n@@ -2541,1 +2534,1 @@\n-    adjusted_limit = igvn->transform(AddNode::make(_structure.exit_test().limit(), _structure.stride().node(), _iv_bt));\n+    adjusted_limit = igvn->transform(AddNode::make(_structure.limit(), _structure.stride().stride_node(), _iv_bt));\n@@ -2559,1 +2552,0 @@\n-  _phase->set_subtree_ctrl(adjusted_limit, false);\n@@ -2565,1 +2557,1 @@\n-  incr->set_req(2, _structure.stride().node());\n+  incr->set_req(2, _structure.stride().stride_node());\n@@ -2615,1 +2607,1 @@\n-\/\/ Need to swap loop-exit and loop-back control?\n+  \/\/ Need to swap loop-exit and loop-back control?\n@@ -2747,1 +2739,1 @@\n-                                                     const BasicType iv_bt, Node* loop_entry) {\n+                                                     const BasicType iv_bt, Node* loop_entry) const {\n","filename":"src\/hotspot\/share\/opto\/loopnode.cpp","additions":33,"deletions":41,"binary":false,"changes":74,"status":"modified"},{"patch":"@@ -1341,1 +1341,1 @@\n-    bool canonicalize_mask(jlong stride_con);\n+    void canonicalize_mask(jlong stride_con);\n@@ -1384,1 +1384,1 @@\n-    Node* _node = nullptr;\n+    Node* _stride_node = nullptr;\n@@ -1392,2 +1392,2 @@\n-    bool is_valid() const { return _is_valid && _node != nullptr; }\n-    Node* node() const { return _node; }\n+    bool is_valid() const { return _is_valid && _stride_node != nullptr; }\n+    Node* stride_node() const { return _stride_node; }\n@@ -2021,1 +2021,1 @@\n-    SafePointNode* _sfpt = nullptr;\n+    SafePointNode* _safepoint = nullptr;\n@@ -2029,3 +2029,4 @@\n-      _exit_test(PhaseIdealLoop::LoopExitTest(_phase->loop_exit_control(_head, _loop), _loop, _phase)),\n-      _iv_incr(PhaseIdealLoop::LoopIVIncr(_head, _loop)),\n-      _truncated_increment(CountedLoopNode::TruncatedIncrement(_iv_bt)),\n+      _back_control(_phase->loop_exit_control(_head, _loop)),\n+      _exit_test(_back_control, _loop, _phase),\n+      _iv_incr(_head, _loop),\n+      _truncated_increment(_iv_bt),\n@@ -2039,1 +2040,0 @@\n-\n@@ -2048,1 +2048,3 @@\n-    SafePointNode* sfpt() const { return _sfpt; }\n+    SafePointNode* sfpt() const { return _safepoint; }\n+    jlong stride_con() const { return _stride.compute_non_zero_stride_con(_exit_test.mask(), _iv_bt); }\n+    Node* limit() const { return _exit_test.limit(); }\n@@ -2060,3 +2062,1 @@\n-#ifdef ASSERT\n-  bool _checked_for_counted_loop = false;\n-#endif\n+  DEBUG_ONLY(bool _checked_for_counted_loop = false;)\n@@ -2076,1 +2076,1 @@\n-                                       Node* loop_entry);\n+                                       Node* loop_entry) const;\n@@ -2081,1 +2081,1 @@\n-  bool is_safepoint_invalid(SafePointNode* sfpt);\n+  bool is_safepoint_invalid(SafePointNode* sfpt) const;\n@@ -2099,4 +2099,2 @@\n-#ifdef ASSERT\n-  bool should_stress_long_counted_loop();\n-  bool stress_long_counted_loop();\n-#endif\n+  DEBUG_ONLY(bool should_stress_long_counted_loop();)\n+  DEBUG_ONLY(bool stress_long_counted_loop();)\n","filename":"src\/hotspot\/share\/opto\/loopnode.hpp","additions":17,"deletions":19,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -4271,0 +4271,2 @@\n+    Node* loop_incr = loop_exit.incr();\n+\n@@ -4273,1 +4275,1 @@\n-    if (!loop_exit.incr()->is_Phi() || loop_exit.incr()->in(0) == head) {\n+    if (!loop_incr->is_Phi() || loop_incr->in(0) == head) {\n@@ -4278,1 +4280,1 @@\n-    region = loop_exit.incr()->in(0);\n+    region = loop_incr->in(0);\n@@ -4284,1 +4286,1 @@\n-    for (uint i = 1; i < loop_exit.incr()->req(); ++i) {\n+    for (uint i = 1; i < loop_incr->req(); ++i) {\n@@ -4286,1 +4288,1 @@\n-      increment.build(loop_exit.incr()->in(i));\n+      increment.build(loop_incr->in(i));\n","filename":"src\/hotspot\/share\/opto\/loopopts.cpp","additions":6,"deletions":4,"binary":false,"changes":10,"status":"modified"}]}