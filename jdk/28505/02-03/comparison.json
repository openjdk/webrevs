{"files":[{"patch":"@@ -85,2 +85,3 @@\n-  Bucket& bucket(unsigned i) { return _buckets[i]; }\n-  Bucket* bucket_addr(unsigned i) { return &_buckets[i]; }\n+  Bucket& bucket(unsigned idx) { return _buckets[idx]; }\n+  Bucket* bucket_addr(unsigned idx) { return &_buckets[idx]; }\n+  Entry* head(unsigned idx) { return bucket(idx).head(); }\n@@ -88,1 +89,1 @@\n-  bool try_add(unsigned idx, Entry* entry);\n+  bool try_add(unsigned idx, Entry* entry, Entry* next);\n@@ -96,0 +97,3 @@\n+  template <typename Callback>\n+  static void iterate(Entry* entry, Callback& cb);\n+\n","filename":"src\/hotspot\/share\/jfr\/utilities\/jfrConcurrentHashtable.hpp","additions":7,"deletions":3,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -86,1 +86,7 @@\n-inline bool JfrConcurrentHashtable<T, IdType, TableEntry>::try_add(unsigned idx, TableEntry<T, IdType>* entry) {\n+template <typename Callback>\n+inline void JfrConcurrentHashtable<T, IdType, TableEntry>::iterate(TableEntry<T, IdType>* entry, Callback& cb) {\n+  Bucket::iterate(entry, cb);\n+}\n+\n+template <typename T, typename IdType, template <typename, typename> class TableEntry>\n+inline bool JfrConcurrentHashtable<T, IdType, TableEntry>::try_add(unsigned idx, TableEntry<T, IdType>* entry, TableEntry<T, IdType>* next) {\n@@ -88,2 +94,2 @@\n-  assert(idx < _capacity, \"invariant\");\n-  const bool added = bucket(idx).try_add(entry);\n+  entry->set_next(next);\n+  const bool added = bucket(idx).try_add(entry, next);\n@@ -159,5 +165,10 @@\n-    this->iterate(idx, lookup);\n-    if (lookup.found()) {\n-      if (entry != nullptr) {\n-        _callback->on_unlink(entry);\n-        delete entry;\n+    Entry* next = this->head(idx);\n+    if (next != nullptr) {\n+      JfrConcurrentHashtable<T, IdType, TableEntry>::iterate(next, lookup);\n+      if (lookup.found()) {\n+        if (entry != nullptr) {\n+          _callback->on_unlink(entry);\n+          delete entry;\n+        }\n+        entry = lookup.result();\n+        break;\n@@ -165,2 +176,0 @@\n-      entry = lookup.result();\n-      break;\n@@ -172,1 +181,1 @@\n-    if (this->try_add(idx, entry)) {\n+    if (this->try_add(idx, entry, next)) {\n","filename":"src\/hotspot\/share\/jfr\/utilities\/jfrConcurrentHashtable.inline.hpp","additions":20,"deletions":11,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -46,1 +46,1 @@\n-  bool try_add(NodePtr node);\n+  bool try_add(NodePtr node, NodePtr next);\n@@ -51,0 +51,2 @@\n+  template <typename Callback>\n+  static void iterate(NodePtr node, Callback& cb);\n","filename":"src\/hotspot\/share\/jfr\/utilities\/jfrLinkedList.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -66,1 +66,1 @@\n-inline bool JfrLinkedList<NodeType, AllocPolicy>::try_add(NodeType* node) {\n+inline bool JfrLinkedList<NodeType, AllocPolicy>::try_add(NodeType* node, NodeType* next) {\n@@ -68,3 +68,2 @@\n-  NodePtr next = head();\n-  node->_next = next;\n-  return AtomicAccess::cmpxchg(&_head, next, node) == next;\n+  assert(node->_next == next, \"invariant\");\n+  return head() == next && AtomicAccess::cmpxchg(&_head, next, node) == next;\n@@ -87,5 +86,10 @@\n-void JfrLinkedList<NodeType, AllocPolicy>::iterate(Callback& cb) {\n-  NodePtr current = head();\n-  while (current != nullptr) {\n-    NodePtr next = (NodePtr)current->_next;\n-    if (!cb.process(current)) {\n+inline void JfrLinkedList<NodeType, AllocPolicy>::iterate(Callback& cb) {\n+  JfrLinkedList<NodeType, AllocPolicy>::iterate(head(), cb);\n+}\n+\n+template <typename NodeType, typename AllocPolicy>\n+template <typename Callback>\n+inline void JfrLinkedList<NodeType, AllocPolicy>::iterate(NodeType* node, Callback& cb) {\n+  while (node != nullptr) {\n+    NodePtr next = (NodePtr)node->_next;\n+    if (!cb.process(node)) {\n@@ -94,1 +98,1 @@\n-    current = next;\n+    node = next;\n@@ -99,1 +103,1 @@\n-NodeType* JfrLinkedList<NodeType, AllocPolicy>::excise(NodeType* prev, NodeType* node) {\n+inline NodeType* JfrLinkedList<NodeType, AllocPolicy>::excise(NodeType* prev, NodeType* node) {\n@@ -117,1 +121,1 @@\n-bool JfrLinkedList<NodeType, AllocPolicy>::in_list(const NodeType* node) const {\n+inline bool JfrLinkedList<NodeType, AllocPolicy>::in_list(const NodeType* node) const {\n@@ -130,1 +134,1 @@\n-NodeType* JfrLinkedList<NodeType, AllocPolicy>::cut() {\n+inline NodeType* JfrLinkedList<NodeType, AllocPolicy>::cut() {\n","filename":"src\/hotspot\/share\/jfr\/utilities\/jfrLinkedList.inline.hpp","additions":17,"deletions":13,"binary":false,"changes":30,"status":"modified"}]}