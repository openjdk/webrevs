{"files":[{"patch":"@@ -869,0 +869,1 @@\n+            String keyEntryAlias = null;\n@@ -882,0 +883,5 @@\n+                    } else if (co instanceof KeyEntry ke) {\n+                        if (keyEntryAlias == null && ke.chain.length > 0 && ke.chain[0].equals(tce.cert)) {\n+                            \/\/ Remember keyEntry corresponding to the trusted cert entry\n+                            keyEntryAlias = alias.toLowerCase(Locale.ROOT);\n+                        }\n@@ -921,0 +927,4 @@\n+                    \/\/ Remove keyEntry related to certificate with empty trust settings\n+                    if (keyEntryAlias != null) {\n+                        entries.remove(keyEntryAlias);\n+                    }\n@@ -937,0 +947,4 @@\n+                        \/\/ Remove keyEntry related to implicitly distrusted certificate\n+                        if (keyEntryAlias != null) {\n+                            entries.remove(keyEntryAlias);\n+                        }\n@@ -952,0 +966,4 @@\n+                    \/\/ Remove keyEntry related to certificate with empty trusted settings\n+                    if (keyEntryAlias != null) {\n+                        entries.remove(keyEntryAlias);\n+                    }\n","filename":"src\/java.base\/macosx\/classes\/apple\/security\/KeychainStore.java","additions":18,"deletions":0,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 7133495 8062264 8046777 8153005\n+ * @bug 7133495 8062264 8046777 8153005 8331163\n@@ -50,0 +50,1 @@\n+    private static final String CERT_FILE = USER_DIR + FS + \"7133495.cert\";\n@@ -162,0 +163,26 @@\n+\n+            \/\/ Export CN2 certificate from PKCS12\n+            LOG_MSG(\"Export CN2 certificate from the keystore: \" + PKCS12_KEYSTORE);\n+            SecurityTools.keytool(String.format(\"-J-Dkeystore.pkcs12.legacy -export\" +\n+                                \" -storetype PKCS12 -keystore %s -storepass %s\" +\n+                                \" -alias 7133495-2 -file %s\",\n+                        PKCS12_KEYSTORE, PWD, CERT_FILE)).shouldHaveExitValue(0);\n+\n+            \/\/ Update CN2 certificate trust setting to \"Never Trust\"\n+            LOG_MSG(\"Importing the certificate from \" + CERT_FILE\n+                    + \" to \" + KEYCHAIN_FILE + \" with Trust Settings restriction\");\n+\n+            ProcessTools.executeCommand(\"sh\", \"-c\", String.format(\"security add-trusted-cert\" +\n+                    \" -r deny -k %s %s\", KEYCHAIN_FILE, CERT_FILE)).shouldHaveExitValue(0);\n+\n+            \/\/ Export a private key from the keychain (without supplying a password)\n+            \/\/ Access controls have already been lowered (see 'security import ... -A' above)\n+            LOG_MSG(\"Exporting a private key with restricted Trust Settings from the keychain\");\n+            try (FileInputStream fis = new FileInputStream(KEYCHAIN_FILE)) {\n+                KeyStore ks2 = KeyStore.getInstance(\"KeychainStore\");\n+                ks2.load(fis, null);\n+                key = ks2.getKey(\"CN2\", null);\n+                if (key instanceof PrivateKey) {\n+                    throw new RuntimeException(\"Key should not be accessible\");\n+                }\n+            }\n@@ -174,0 +201,1 @@\n+        Files.deleteIfExists(Paths.get(CERT_FILE));\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/ListKeyChainStore.java","additions":29,"deletions":1,"binary":false,"changes":30,"status":"modified"}]}