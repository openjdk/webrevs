{"files":[{"patch":"@@ -29,0 +29,1 @@\n+import java.util.List;\n@@ -49,1 +50,1 @@\n-import static org.junit.jupiter.api.Assertions.assertFalse;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n@@ -105,1 +106,1 @@\n-                .GET()\n+                .POST(HttpRequest.BodyPublishers.ofString(\"test data\"))\n@@ -111,4 +112,0 @@\n-        if (!goAwaySentLatch.await(5, TimeUnit.SECONDS)) {\n-            throw new AssertionError(\"GOAWAY not sent in time\");\n-        }\n-\n@@ -121,0 +118,4 @@\n+        if (!goAwaySentLatch.await(5, TimeUnit.SECONDS)) {\n+            throw new AssertionError(\"GOAWAY not sent in time\");\n+        }\n+\n@@ -126,3 +127,23 @@\n-        Throwable firstError = first.handle((r, ex) -> ex).join();\n-        if (firstError instanceof CompletionException ce && ce.getCause() != null) {\n-            firstError = ce.getCause();\n+        List<CompletableFuture<HttpResponse<String>>> requests = List.of(first, second, third);\n+\n+        int failureCount = 0;\n+        int successCount = 0;\n+        Throwable goawayError = null;\n+\n+        for (CompletableFuture<HttpResponse<String>> req : requests) {\n+            try {\n+                HttpResponse<String> response = req.join();\n+                if (response.statusCode() == 200) {\n+                    successCount++;\n+                }\n+            } catch (CompletionException e) {\n+                failureCount++;\n+                if (goawayError == null) {\n+                    Throwable cause = e.getCause();\n+                    if (cause != null) {\n+                        goawayError = cause;\n+                    } else {\n+                        goawayError = e;\n+                    }\n+                }\n+            }\n@@ -131,10 +152,2 @@\n-        assertTrue(firstError != null && firstError.getMessage() != null,\n-                \"First request should fail with GOAWAY error\");\n-        assertTrue(firstError.getMessage().contains(\"GOAWAY\")\n-                        && firstError.getMessage().contains(\"Protocol error\")\n-                        && firstError.getMessage().contains(\"0x1\")\n-                        && firstError.getMessage().contains(DEBUG_MESSAGE),\n-                \"First request should contain GOAWAY error details: \" + firstError.getMessage());\n-\n-        HttpResponse<String> secondResponse = second.handle((r, ex) -> r).join();\n-        HttpResponse<String> thirdResponse = third.handle((r, ex) -> r).join();\n+        assertEquals(1, failureCount, \"Exactly one request should fail\");\n+        assertEquals(2, successCount, \"Exactly two requests should succeed\");\n@@ -142,4 +155,7 @@\n-        assertTrue(secondResponse != null && secondResponse.statusCode() == 200,\n-                \"Second request (unprocessed stream) should be retried and succeed\");\n-        assertTrue(thirdResponse != null && thirdResponse.statusCode() == 200,\n-                \"Third request (unprocessed stream) should be retried and succeed\");\n+        assertTrue(goawayError != null && goawayError.getMessage() != null,\n+                \"Failed request should have GOAWAY error\");\n+        assertTrue(goawayError.getMessage().contains(\"GOAWAY\")\n+                        && goawayError.getMessage().contains(\"Protocol error\")\n+                        && goawayError.getMessage().contains(\"0x1\")\n+                        && goawayError.getMessage().contains(DEBUG_MESSAGE),\n+                \"Failed request should contain GOAWAY error details: \" + goawayError.getMessage());\n@@ -148,1 +164,1 @@\n-                \"Second and third requests should reach server after being retried\");\n+                \"Retried requests should reach server after being retried\");\n@@ -162,1 +178,2 @@\n-                System.out.println(\"Handler: sending GOAWAY(PROTOCOL_ERROR, lastStreamId=1) and closing connection\");\n+                int lastStreamId = impl.getStreamId();\n+                System.out.println(\"Handler: sending GOAWAY(PROTOCOL_ERROR, lastStreamId=\" + lastStreamId + \") and closing connection\");\n@@ -164,1 +181,1 @@\n-                impl.getServerConnection().sendGoAway(1, PROTOCOL_ERROR, DEBUG_DATA);\n+                impl.getServerConnection().sendGoAway(lastStreamId, PROTOCOL_ERROR, DEBUG_DATA);\n","filename":"test\/jdk\/java\/net\/httpclient\/http2\/GoAwayWithErrorTest.java","additions":43,"deletions":26,"binary":false,"changes":69,"status":"modified"},{"patch":"@@ -251,0 +251,4 @@\n+    public int getStreamId() {\n+        return streamid;\n+    }\n+\n","filename":"test\/jdk\/java\/net\/httpclient\/lib\/jdk\/httpclient\/test\/lib\/http2\/Http2TestExchangeImpl.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"}]}