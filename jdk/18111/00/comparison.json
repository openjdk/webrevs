{"files":[{"patch":"@@ -100,1 +100,1 @@\n-    public void invalidateFileCache() {\n+    public synchronized void invalidateFileCache() {\n@@ -103,1 +103,0 @@\n-            filesLoader.cancelRunnables();\n@@ -159,4 +158,4 @@\n-        if (filesLoader != null) {\n-            filesLoader.loadThread.interrupt();\n-            filesLoader.cancelRunnables();\n-        }\n+        synchronized (this) {\n+            if (filesLoader != null) {\n+                filesLoader.loadThread.interrupt();\n+            }\n@@ -164,3 +163,4 @@\n-        int fid = fetchID.incrementAndGet();\n-        setBusy(true, fid);\n-        filesLoader = new FilesLoader(currentDirectory, fid);\n+            int fid = fetchID.incrementAndGet();\n+            setBusy(true, fid);\n+            filesLoader = new FilesLoader(currentDirectory, fid);\n+        }\n@@ -279,1 +279,0 @@\n-        private volatile DoChangeContents runnable;\n@@ -282,0 +281,2 @@\n+        private DoChangeContents runnable;\n+\n@@ -300,2 +301,0 @@\n-            FileSystemView fileSystem = fileSystemView;\n-\n@@ -306,1 +305,1 @@\n-            File[] list = fileSystem.getFiles(currentDirectory, useFileHiding);\n+            File[] list = fileSystemView.getFiles(currentDirectory, useFileHiding);\n@@ -313,1 +312,1 @@\n-            Vector<File> newFiles = new Vector<File>();\n+            final Vector<File> newFiles = new Vector<File>();\n@@ -315,1 +314,1 @@\n-            \/\/ run through the file list, add directories and selectable files to fileCache\n+            \/\/ Run through the file list, add directories and selectable files to fileCache\n@@ -398,1 +397,1 @@\n-                                cancelRunnables();\n+                                return null;\n@@ -411,6 +410,0 @@\n-\n-        private void cancelRunnables() {\n-            if (runnable != null) {\n-                runnable.cancel();\n-            }\n-        }\n@@ -525,1 +518,0 @@\n-        private boolean doFire = true;\n@@ -527,2 +519,2 @@\n-        private int addStart = 0;\n-        private int remStart = 0;\n+        private final int addStart;\n+        private final int remStart;\n@@ -539,3 +531,5 @@\n-        synchronized void cancel() {\n-            doFire = false;\n-        }\n+        @Override\n+        public void run() {\n+            if (fetchID.get() != fid) {\n+                return;\n+            }\n@@ -543,13 +537,5 @@\n-        public synchronized void run() {\n-            if (fetchID.get() == fid && doFire) {\n-                int remSize = (remFiles == null) ? 0 : remFiles.size();\n-                int addSize = (addFiles == null) ? 0 : addFiles.size();\n-                synchronized(fileCache) {\n-                    if (remSize > 0) {\n-                        fileCache.removeAll(remFiles);\n-                    }\n-                    if (addSize > 0) {\n-                        fileCache.addAll(addStart, addFiles);\n-                    }\n-                    files = null;\n-                    directories = null;\n+            int remSize = (remFiles == null) ? 0 : remFiles.size();\n+            int addSize = (addFiles == null) ? 0 : addFiles.size();\n+            synchronized(fileCache) {\n+                if (remSize > 0) {\n+                    fileCache.removeAll(remFiles);\n@@ -557,6 +543,2 @@\n-                if (remSize > 0 && addSize == 0) {\n-                    fireIntervalRemoved(BasicDirectoryModel.this, remStart, remStart + remSize - 1);\n-                } else if (addSize > 0 && remSize == 0 && addStart + addSize <= fileCache.size()) {\n-                    fireIntervalAdded(BasicDirectoryModel.this, addStart, addStart + addSize - 1);\n-                } else {\n-                    fireContentsChanged();\n+                if (addSize > 0) {\n+                    fileCache.addAll(addStart, addFiles);\n@@ -564,0 +546,9 @@\n+                files = null;\n+                directories = null;\n+            }\n+            if (remSize > 0 && addSize == 0) {\n+                fireIntervalRemoved(BasicDirectoryModel.this, remStart, remStart + remSize - 1);\n+            } else if (addSize > 0 && remSize == 0 && addStart + addSize <= fileCache.size()) {\n+                fireIntervalAdded(BasicDirectoryModel.this, addStart, addStart + addSize - 1);\n+            } else {\n+                fireContentsChanged();\n","filename":"src\/java.desktop\/share\/classes\/javax\/swing\/plaf\/basic\/BasicDirectoryModel.java","additions":38,"deletions":47,"binary":false,"changes":85,"status":"modified"}]}