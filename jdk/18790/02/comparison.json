{"files":[{"patch":"@@ -34,0 +34,1 @@\n+#include \"classfile\/classLoader.hpp\"\n@@ -121,0 +122,3 @@\n+    log_info(cds,dynamic)(\"CDS dynamic dump: clinit = \" INT64_FORMAT \"ms)\",\n+                          (int64_t)ClassLoader::class_init_time_ms());\n+\n","filename":"src\/hotspot\/share\/cds\/dynamicArchive.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -121,0 +121,4 @@\n+PerfCounter*    ClassLoader::_perf_ik_link_methods_time = nullptr;\n+PerfCounter*    ClassLoader::_perf_method_adapters_time = nullptr;\n+PerfCounter*    ClassLoader::_perf_ik_link_methods_count = nullptr;\n+PerfCounter*    ClassLoader::_perf_method_adapters_count = nullptr;\n@@ -124,0 +128,28 @@\n+PerfCounter*    ClassLoader::_perf_resolve_indy_time = nullptr;\n+PerfCounter*    ClassLoader::_perf_resolve_invokehandle_time = nullptr;\n+PerfCounter*    ClassLoader::_perf_resolve_mh_time = nullptr;\n+PerfCounter*    ClassLoader::_perf_resolve_mt_time = nullptr;\n+\n+PerfCounter*    ClassLoader::_perf_resolve_indy_count = nullptr;\n+PerfCounter*    ClassLoader::_perf_resolve_invokehandle_count = nullptr;\n+PerfCounter*    ClassLoader::_perf_resolve_mh_count = nullptr;\n+PerfCounter*    ClassLoader::_perf_resolve_mt_count = nullptr;\n+\n+void ClassLoader::print_counters() {\n+  if (ProfileClassLinkage) {\n+    LogStreamHandle(Info, init) log;\n+    if (log.is_enabled()) {\n+      log.print_cr(\"ClassLoader:\");\n+      log.print_cr(\"  clinit:               \" INT64_FORMAT \"ms \/ \" INT64_FORMAT \" events\", (int64_t)ClassLoader::class_init_time_ms(), (int64_t)ClassLoader::class_init_count());\n+      log.print_cr(\"  link methods:         \" INT64_FORMAT \"ms \/ \" INT64_FORMAT \" events\", (int64_t)Management::ticks_to_ms(_perf_ik_link_methods_time->get_value())   , (int64_t)_perf_ik_link_methods_count->get_value());\n+      log.print_cr(\"  method adapters:      \" INT64_FORMAT \"ms \/ \" INT64_FORMAT \" events\", (int64_t)Management::ticks_to_ms(_perf_method_adapters_time->get_value())   , (int64_t)_perf_method_adapters_count->get_value());\n+      log.print_cr(\"  resolve...\");\n+      log.print_cr(\"    invokedynamic:   \" INT64_FORMAT \"ms \/ \" INT64_FORMAT \" events\", (int64_t)Management::ticks_to_ms(_perf_resolve_indy_time->get_value())         , (int64_t)_perf_resolve_indy_count->get_value());\n+      log.print_cr(\"    invokehandle:    \" INT64_FORMAT \"ms \/ \" INT64_FORMAT \" events\", (int64_t)Management::ticks_to_ms(_perf_resolve_invokehandle_time->get_value()) , (int64_t)_perf_resolve_invokehandle_count->get_value());\n+      log.print_cr(\"    CP_MethodHandle: \" INT64_FORMAT \"ms \/ \" INT64_FORMAT \" events\", (int64_t)Management::ticks_to_ms(_perf_resolve_mh_time->get_value())           , (int64_t)_perf_resolve_mh_count->get_value());\n+      log.print_cr(\"    CP_MethodType:   \" INT64_FORMAT \"ms \/ \" INT64_FORMAT \" events\", (int64_t)Management::ticks_to_ms(_perf_resolve_mt_time->get_value())           , (int64_t)_perf_resolve_mt_count->get_value());\n+      log.cr();\n+    }\n+  }\n+}\n+\n@@ -1339,1 +1371,0 @@\n-\n@@ -1344,0 +1375,17 @@\n+  if (ProfileClassLinkage) {\n+    NEWPERFTICKCOUNTER(_perf_ik_link_methods_time, SUN_CLS, \"linkMethodsTime\");\n+    NEWPERFTICKCOUNTER(_perf_method_adapters_time, SUN_CLS, \"makeAdaptersTime\");\n+    NEWPERFEVENTCOUNTER(_perf_ik_link_methods_count, SUN_CLS, \"linkMethodsCount\");\n+    NEWPERFEVENTCOUNTER(_perf_method_adapters_count, SUN_CLS, \"makeAdaptersCount\");\n+\n+    NEWPERFTICKCOUNTER(_perf_resolve_indy_time, SUN_CLS, \"resolve_invokedynamic_time\");\n+    NEWPERFTICKCOUNTER(_perf_resolve_invokehandle_time, SUN_CLS, \"resolve_invokehandle_time\");\n+    NEWPERFTICKCOUNTER(_perf_resolve_mh_time, SUN_CLS, \"resolve_MethodHandle_time\");\n+    NEWPERFTICKCOUNTER(_perf_resolve_mt_time, SUN_CLS, \"resolve_MethodType_time\");\n+\n+    NEWPERFEVENTCOUNTER(_perf_resolve_indy_count, SUN_CLS, \"resolve_invokedynamic_count\");\n+    NEWPERFEVENTCOUNTER(_perf_resolve_invokehandle_count, SUN_CLS, \"resolve_invokehandle_count\");\n+    NEWPERFEVENTCOUNTER(_perf_resolve_mh_count, SUN_CLS, \"resolve_MethodHandle_count\");\n+    NEWPERFEVENTCOUNTER(_perf_resolve_mt_count, SUN_CLS, \"resolve_MethodType_count\");\n+  }\n+\n@@ -1429,1 +1477,1 @@\n-  return UsePerfData ? _perf_classes_inited->get_value() : -1;\n+  return (UsePerfData) ? _perf_classes_inited->get_value() : -1;\n@@ -1433,1 +1481,1 @@\n-  return UsePerfData ?\n+  return (UsePerfData) ?\n","filename":"src\/hotspot\/share\/classfile\/classLoader.cpp","additions":51,"deletions":3,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -169,0 +169,14 @@\n+  static PerfCounter* _perf_ik_link_methods_time;\n+  static PerfCounter* _perf_method_adapters_time;\n+  static PerfCounter* _perf_ik_link_methods_count;\n+  static PerfCounter* _perf_method_adapters_count;\n+\n+  static PerfCounter* _perf_resolve_indy_time;\n+  static PerfCounter* _perf_resolve_invokehandle_time;\n+  static PerfCounter* _perf_resolve_mh_time;\n+  static PerfCounter* _perf_resolve_mt_time;\n+\n+  static PerfCounter* _perf_resolve_indy_count;\n+  static PerfCounter* _perf_resolve_invokehandle_count;\n+  static PerfCounter* _perf_resolve_mh_count;\n+  static PerfCounter* _perf_resolve_mt_count;\n@@ -288,0 +302,17 @@\n+  static PerfCounter* perf_ik_link_methods_time() { return _perf_ik_link_methods_time; }\n+  static PerfCounter* perf_method_adapters_time() { return _perf_method_adapters_time; }\n+  static PerfCounter* perf_ik_link_methods_count() { return _perf_ik_link_methods_count; }\n+  static PerfCounter* perf_method_adapters_count() { return _perf_method_adapters_count; }\n+\n+  static PerfCounter* perf_resolve_invokedynamic_time() { return _perf_resolve_indy_time; }\n+  static PerfCounter* perf_resolve_invokehandle_time() { return _perf_resolve_invokehandle_time; }\n+  static PerfCounter* perf_resolve_method_handle_time() { return _perf_resolve_mh_time; }\n+  static PerfCounter* perf_resolve_method_type_time() { return _perf_resolve_mt_time; }\n+\n+  static PerfCounter* perf_resolve_invokedynamic_count() { return _perf_resolve_indy_count; }\n+  static PerfCounter* perf_resolve_invokehandle_count() { return _perf_resolve_invokehandle_count; }\n+  static PerfCounter* perf_resolve_method_handle_count() { return _perf_resolve_mh_count; }\n+  static PerfCounter* perf_resolve_method_type_count() { return _perf_resolve_mt_count; }\n+\n+  static void print_counters();\n+\n","filename":"src\/hotspot\/share\/classfile\/classLoader.hpp","additions":31,"deletions":0,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+#include \"classfile\/classLoader.hpp\"\n@@ -58,1 +59,2 @@\n-#include \"runtime\/javaThread.hpp\"\n+#include \"runtime\/javaThread.inline.hpp\"\n+#include \"runtime\/perfData.hpp\"\n@@ -1731,0 +1733,4 @@\n+\n+  PerfTraceTimedEvent timer(ClassLoader::perf_resolve_invokehandle_time(),\n+                            ClassLoader::perf_resolve_invokehandle_count());\n+\n@@ -1782,0 +1788,3 @@\n+  PerfTraceTimedEvent timer(ClassLoader::perf_resolve_invokedynamic_time(),\n+                            ClassLoader::perf_resolve_invokedynamic_count());\n+\n","filename":"src\/hotspot\/share\/interpreter\/linkResolver.cpp","additions":10,"deletions":1,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+#include \"classfile\/classLoader.hpp\"\n@@ -65,1 +66,2 @@\n-#include \"runtime\/javaThread.hpp\"\n+#include \"runtime\/javaThread.inline.hpp\"\n+#include \"runtime\/perfData.hpp\"\n@@ -1017,1 +1019,3 @@\n-    {\n+    { PerfTraceTimedEvent timer(ClassLoader::perf_resolve_invokedynamic_time(),\n+                                ClassLoader::perf_resolve_invokedynamic_count());\n+\n@@ -1075,1 +1079,3 @@\n-    {\n+    { PerfTraceTimedEvent timer(ClassLoader::perf_resolve_method_handle_time(),\n+                                ClassLoader::perf_resolve_method_handle_count());\n+\n@@ -1123,1 +1129,3 @@\n-    {\n+    { PerfTraceTimedEvent timer(ClassLoader::perf_resolve_method_type_time(),\n+                                ClassLoader::perf_resolve_method_type_count());\n+\n","filename":"src\/hotspot\/share\/oops\/constantPool.cpp","additions":12,"deletions":4,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -981,0 +981,2 @@\n+  PerfTraceTime timer(ClassLoader::perf_ik_link_methods_time());\n+\n@@ -1217,1 +1219,1 @@\n-      if (UsePerfData) {\n+      if (UsePerfData || ProfileClassLinkage) {\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.cpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"classfile\/classLoader.hpp\"\n@@ -71,0 +72,1 @@\n+#include \"runtime\/perfData.hpp\"\n@@ -1217,0 +1219,4 @@\n+  if (ProfileClassLinkage) {\n+    ClassLoader::perf_ik_link_methods_count()->inc();\n+  }\n+\n@@ -1268,0 +1274,2 @@\n+  PerfTraceTime timer(ClassLoader::perf_method_adapters_time());\n+\n","filename":"src\/hotspot\/share\/oops\/method.cpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -3757,0 +3757,11 @@\n+  if (log_is_enabled(Info, init)) {\n+     FLAG_SET_ERGO_IF_DEFAULT(ProfileClassLinkage, true);\n+  }\n+\n+  if (ProfileClassLinkage && !UsePerfData) {\n+    if (!FLAG_IS_DEFAULT(ProfileClassLinkage)) {\n+       warning(\"Disabling ProfileClassLinkage since UsePerfData is turned off.\");\n+       FLAG_SET_DEFAULT(ProfileClassLinkage, false);\n+     }\n+  }\n+\n","filename":"src\/hotspot\/share\/runtime\/arguments.cpp","additions":11,"deletions":0,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -1977,0 +1977,3 @@\n+  product(bool, ProfileClassLinkage, false, DIAGNOSTIC,                     \\\n+          \"Profile class loading, linking, and CP resolution\")              \\\n+                                                                            \\\n","filename":"src\/hotspot\/share\/runtime\/globals.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+#include \"classfile\/classLoader.hpp\"\n@@ -159,0 +160,6 @@\n+void log_vm_init_stats() {\n+  LogStreamHandle(Info, init) log;\n+  if (log.is_enabled()) {\n+    ClassLoader::print_counters();\n+  }\n+}\n@@ -359,0 +366,2 @@\n+\n+  log_vm_init_stats();\n","filename":"src\/hotspot\/share\/runtime\/java.cpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -62,0 +62,2 @@\n+extern void log_vm_init_stats();\n+\n","filename":"src\/hotspot\/share\/runtime\/java.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -299,1 +299,1 @@\n-  assert(!_all->contains(p->name()), \"duplicate name added\");\n+  assert(!_all->contains(p->name()), \"duplicate name added: %s\", p->name());\n@@ -530,5 +530,0 @@\n-PerfTraceTime::~PerfTraceTime() {\n-  if (!UsePerfData) return;\n-  _t.stop();\n-  _timerp->inc(_t.ticks());\n-}\n","filename":"src\/hotspot\/share\/runtime\/perfData.cpp","additions":1,"deletions":6,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -834,1 +834,1 @@\n-      if (!UsePerfData) return;\n+      if (!UsePerfData || timerp == nullptr) return;\n@@ -838,1 +838,7 @@\n-    ~PerfTraceTime();\n+    const char* name() const { return _timerp->name(); }\n+\n+    ~PerfTraceTime() {\n+      if (!UsePerfData || !_t.is_active()) return;\n+      _t.stop();\n+      _timerp->inc(_t.ticks());\n+    }\n@@ -867,1 +873,1 @@\n-      if (!UsePerfData) return;\n+      if (!UsePerfData || timerp == nullptr) return;\n","filename":"src\/hotspot\/share\/runtime\/perfData.hpp","additions":9,"deletions":3,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+#include \"classfile\/classLoader.hpp\"\n@@ -66,0 +67,1 @@\n+#include \"runtime\/perfData.hpp\"\n@@ -2573,0 +2575,3 @@\n+  if (ProfileClassLinkage) {\n+    ClassLoader::perf_method_adapters_count()->inc();\n+  }\n","filename":"src\/hotspot\/share\/runtime\/sharedRuntime.cpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -831,0 +831,5 @@\n+  if (ProfileClassLinkage) {\n+    log_info(init)(\"Before main:\");\n+    log_vm_init_stats();\n+  }\n+\n","filename":"src\/hotspot\/share\/runtime\/threads.cpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"}]}