{"files":[{"patch":"@@ -56,2 +56,0 @@\n-    native static int waitsToEnter();\n-    native static int waitsToBeNotified();\n@@ -59,0 +57,2 @@\n+    native static void ensureBlockedOnEnter(Thread thread);\n+    native static void ensureWaitsToBeNotified(Thread thread);\n@@ -90,4 +90,3 @@\n-            threads[i] = startTask(i, new WaitingTask(), isVirtual, \"Waiting\");\n-        }\n-        while (waitsToBeNotified() < NUMBER_OF_WAITING_THREADS) {\n-            sleep(1);\n+            Thread thread = startTask(i, new WaitingTask(), isVirtual, \"Waiting\");\n+            ensureWaitsToBeNotified(thread);\n+            threads[i] = thread;\n@@ -102,4 +101,3 @@\n-            threads[i] = startTask(i, new EnteringTask(), isVirtual, \"Entering\");\n-        }\n-        while (waitsToEnter() < NUMBER_OF_ENTERING_THREADS) {\n-            sleep(1);\n+            Thread thread = startTask(i, new EnteringTask(), isVirtual, \"Entering\");\n+            ensureBlockedOnEnter(thread);\n+            threads[i] = thread;\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/ObjectMonitorUsage\/ObjectMonitorUsage.java","additions":8,"deletions":10,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -38,2 +38,0 @@\n-static int waits_to_enter = 0;\n-static int waits_to_be_notified = 0;\n@@ -56,36 +54,0 @@\n-JNIEXPORT void JNICALL\n-MonitorContendedEnter(jvmtiEnv *jvmti, JNIEnv *jni, jthread thread, jobject monitor) {\n-  RawMonitorLocker rml(jvmti, jni, event_lock);\n-  if (is_tested_monitor(jni, monitor)) {\n-    waits_to_enter++;\n-    log_event(jvmti, jni, thread, \"MonitorContendedEnter\", waits_to_enter);\n-  }\n-}\n-\n-JNIEXPORT void JNICALL\n-MonitorContendedEntered(jvmtiEnv *jvmti, JNIEnv *jni, jthread thread, jobject monitor) {\n-  RawMonitorLocker rml(jvmti, jni, event_lock);\n-  if (is_tested_monitor(jni, monitor)) {\n-    waits_to_enter--;\n-    log_event(jvmti, jni, thread, \"MonitorContendedEntered\", waits_to_enter);\n-  }\n-}\n-\n-JNIEXPORT void JNICALL\n-MonitorWait(jvmtiEnv *jvmti, JNIEnv *jni, jthread thread, jobject monitor, jlong timeout) {\n-  RawMonitorLocker rml(jvmti, jni, event_lock);\n-  if (is_tested_monitor(jni, monitor)) {\n-    waits_to_be_notified++;\n-    log_event(jvmti, jni, thread, \"MonitorWait\", waits_to_be_notified);\n-  }\n-}\n-\n-JNIEXPORT void JNICALL\n-MonitorWaited(jvmtiEnv *jvmti, JNIEnv *jni, jthread thread, jobject monitor, jboolean timed_out) {\n-  RawMonitorLocker rml(jvmti, jni, event_lock);\n-  if (is_tested_monitor(jni, monitor)) {\n-    waits_to_be_notified--;\n-    log_event(jvmti, jni, thread, \"MonitorWaited\", waits_to_be_notified);\n-  }\n-}\n-\n@@ -96,1 +58,0 @@\n-  jvmtiEventCallbacks callbacks;\n@@ -119,9 +80,0 @@\n-  memset(&callbacks, 0, sizeof(callbacks));\n-  callbacks.MonitorContendedEnter   = &MonitorContendedEnter;\n-  callbacks.MonitorContendedEntered = &MonitorContendedEntered;\n-  callbacks.MonitorWait = &MonitorWait;\n-  callbacks.MonitorWaited = &MonitorWaited;\n-\n-  err = jvmti->SetEventCallbacks(&callbacks, sizeof(jvmtiEventCallbacks));\n-  check_jvmti_error(err, \"Agent_Initialize: error in JVMTI SetEventCallbacks\");\n-\n@@ -228,14 +180,0 @@\n-  waits_to_enter = 0;\n-  waits_to_be_notified = 0;\n-\n-  err = jvmti->SetEventNotificationMode(event_mode, JVMTI_EVENT_MONITOR_CONTENDED_ENTER, nullptr);\n-  check_jvmti_status(jni, err, \"setTestedMonitor: error in JVMTI SetEventNotificationMode #1\");\n-\n-  err = jvmti->SetEventNotificationMode(event_mode, JVMTI_EVENT_MONITOR_CONTENDED_ENTERED, nullptr);\n-  check_jvmti_status(jni, err, \"setTestedMonitor: error in JVMTI SetEventNotificationMode #2\");\n-\n-  err = jvmti->SetEventNotificationMode(event_mode, JVMTI_EVENT_MONITOR_WAIT, nullptr);\n-  check_jvmti_status(jni, err, \"setTestedMonitor: error in JVMTI SetEventNotificationMode #3\");\n-\n-  err = jvmti->SetEventNotificationMode(event_mode, JVMTI_EVENT_MONITOR_WAITED, nullptr);\n-  check_jvmti_status(jni, err, \"setTestedMonitor: error in JVMTI SetEventNotificationMode #4\");\n@@ -244,2 +182,1 @@\n-JNIEXPORT jint JNICALL\n-Java_ObjectMonitorUsage_waitsToEnter(JNIEnv *jni, jclass cls) {\n+static void wait_for_state(JNIEnv *jni, jthread thread, jint exp_state) {\n@@ -247,1 +184,6 @@\n-  return waits_to_enter;\n+  while (true) {\n+    if (get_thread_state(jvmti, jni, thread) & exp_state) {\n+      break;\n+    }\n+    rml.wait(100);\n+  }\n@@ -250,4 +192,8 @@\n-JNIEXPORT jint JNICALL\n-Java_ObjectMonitorUsage_waitsToBeNotified(JNIEnv *jni, jclass cls) {\n-  RawMonitorLocker rml(jvmti, jni, event_lock);\n-  return waits_to_be_notified;\n+JNIEXPORT void JNICALL\n+Java_ObjectMonitorUsage_ensureBlockedOnEnter(JNIEnv *jni, jclass cls, jthread thread) {\n+  wait_for_state(jni, thread, JVMTI_THREAD_STATE_BLOCKED_ON_MONITOR_ENTER);\n+}\n+\n+JNIEXPORT void JNICALL\n+Java_ObjectMonitorUsage_ensureWaitsToBeNotified(JNIEnv *jni, jclass cls, jthread thread) {\n+  wait_for_state(jni, thread, JVMTI_THREAD_STATE_WAITING_INDEFINITELY);\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/ObjectMonitorUsage\/libObjectMonitorUsage.cpp","additions":15,"deletions":69,"binary":false,"changes":84,"status":"modified"}]}