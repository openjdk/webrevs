{"files":[{"patch":"@@ -251,1 +251,1 @@\n-  Klass* k = obj->klass_raw();\n+  Klass* k = obj->klass_without_asserts();\n","filename":"src\/hotspot\/share\/gc\/g1\/g1CollectedHeap.inline.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -436,2 +436,6 @@\n-  if (!oopDesc::is_oop(obj)) {\n-    log_error(gc, verify)(PTR_FORMAT \" not an oop\", p2i(obj));\n+  \/\/ Make a few sanity checks of the class before calling the full-fledged\n+  \/\/ is_oop check (which also performs its own klass verification).\n+  Klass* klass = obj->klass_without_asserts();\n+\n+  if (klass == nullptr) {\n+    log_error(gc, verify)(\"Object \" PTR_FORMAT \" has a null klass\", p2i(obj));\n@@ -441,5 +445,1 @@\n-  \/\/ Now examine the Klass a little more closely.\n-  Klass* klass = obj->klass_raw();\n-\n-  bool is_metaspace_object = Metaspace::contains(klass);\n-  if (!is_metaspace_object) {\n+  if (!Metaspace::contains(klass)) {\n@@ -447,1 +447,1 @@\n-                          \"not metadata\", p2i(klass), p2i(obj));\n+                          \"is not in metaspace\", p2i(klass), p2i(obj));\n@@ -449,1 +449,3 @@\n-  } else if (!klass->is_klass()) {\n+  }\n+\n+  if (!klass->is_klass()) {\n@@ -455,0 +457,6 @@\n+  \/\/ Now, perform the more in-depth verification of the object.\n+  if (!oopDesc::is_oop(obj)) {\n+    log_error(gc, verify)(PTR_FORMAT \" not an oop\", p2i(obj));\n+    return false;\n+  }\n+\n","filename":"src\/hotspot\/share\/gc\/g1\/g1HeapRegion.cpp","additions":17,"deletions":9,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -232,1 +232,1 @@\n-  if (!Metaspace::contains(object->klass_raw())) {\n+  if (!Metaspace::contains(object->klass_without_asserts())) {\n","filename":"src\/hotspot\/share\/gc\/shared\/collectedHeap.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+#include \"oops\/oop.inline.hpp\"\n@@ -48,1 +49,1 @@\n-  Klass* k = (Klass*)oopDesc::load_klass_raw((oopDesc*)obj);\n+  Klass* k = ((oopDesc*)obj)->klass_without_asserts();\n","filename":"src\/hotspot\/share\/gc\/shared\/locationPrinter.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -48,0 +48,1 @@\n+  friend class ArchiveBuilder;\n@@ -67,0 +68,5 @@\n+  static inline Klass* decode_not_null_without_asserts(narrowKlass v, address base, int shift);\n+  static inline Klass* decode_not_null(narrowKlass v, address base, int shift);\n+\n+  static inline narrowKlass encode_not_null(Klass* v, address base, int shift);\n+\n@@ -95,2 +101,4 @@\n-  static inline Klass* decode_raw(narrowKlass v, address base, int shift);\n-  static inline Klass* decode_raw(narrowKlass v);\n+  \/\/ Versions without asserts\n+  static inline Klass* decode_not_null_without_asserts(narrowKlass v);\n+  static inline Klass* decode_without_asserts(narrowKlass v);\n+\n@@ -98,1 +106,0 @@\n-  static inline Klass* decode_not_null(narrowKlass v, address base, int shift);\n@@ -100,0 +107,1 @@\n+\n@@ -101,1 +109,0 @@\n-  static inline narrowKlass encode_not_null(Klass* v, address base, int shift);\n@@ -103,1 +110,0 @@\n-\n","filename":"src\/hotspot\/share\/oops\/compressedKlass.hpp","additions":11,"deletions":5,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -39,5 +39,1 @@\n-inline Klass* CompressedKlassPointers::decode_raw(narrowKlass v) {\n-  return decode_raw(v, base(), shift());\n-}\n-\n-inline Klass* CompressedKlassPointers::decode_raw(narrowKlass v, address narrow_base, int shift) {\n+inline Klass* CompressedKlassPointers::decode_not_null_without_asserts(narrowKlass v, address narrow_base, int shift) {\n@@ -47,4 +43,0 @@\n-inline Klass* CompressedKlassPointers::decode_not_null(narrowKlass v) {\n-  return decode_not_null(v, base(), shift());\n-}\n-\n@@ -53,1 +45,1 @@\n-  Klass* result = decode_raw(v, narrow_base, shift);\n+  Klass* result = decode_not_null_without_asserts(v, narrow_base, shift);\n@@ -58,8 +50,0 @@\n-inline Klass* CompressedKlassPointers::decode(narrowKlass v) {\n-  return is_null(v) ? nullptr : decode_not_null(v);\n-}\n-\n-inline narrowKlass CompressedKlassPointers::encode_not_null(Klass* v) {\n-  return encode_not_null(v, base(), shift());\n-}\n-\n@@ -77,0 +61,20 @@\n+inline Klass* CompressedKlassPointers::decode_not_null_without_asserts(narrowKlass v) {\n+  return decode_not_null_without_asserts(v, base(), shift());\n+}\n+\n+inline Klass* CompressedKlassPointers::decode_without_asserts(narrowKlass v) {\n+  return is_null(v) ? nullptr : decode_not_null_without_asserts(v);\n+}\n+\n+inline Klass* CompressedKlassPointers::decode_not_null(narrowKlass v) {\n+  return decode_not_null(v, base(), shift());\n+}\n+\n+inline Klass* CompressedKlassPointers::decode(narrowKlass v) {\n+  return is_null(v) ? nullptr : decode_not_null(v);\n+}\n+\n+inline narrowKlass CompressedKlassPointers::encode_not_null(Klass* v) {\n+  return encode_not_null(v, base(), shift());\n+}\n+\n","filename":"src\/hotspot\/share\/oops\/compressedKlass.inline.hpp","additions":22,"deletions":18,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -168,10 +168,0 @@\n-void* oopDesc::load_klass_raw(oop obj) {\n-  if (UseCompressedClassPointers) {\n-    narrowKlass narrow_klass = obj->_metadata._compressed_klass;\n-    if (narrow_klass == 0) return nullptr;\n-    return (void*)CompressedKlassPointers::decode_raw(narrow_klass);\n-  } else {\n-    return obj->_metadata._klass;\n-  }\n-}\n-\n","filename":"src\/hotspot\/share\/oops\/oop.cpp","additions":0,"deletions":10,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -88,2 +88,2 @@\n-  \/\/ Get the raw value without any checks.\n-  inline Klass* klass_raw() const;\n+  \/\/ Get the klass without running any asserts.\n+  inline Klass* klass_without_asserts() const;\n@@ -319,1 +319,0 @@\n-  static void* load_klass_raw(oop obj);\n","filename":"src\/hotspot\/share\/oops\/oop.hpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -114,1 +114,1 @@\n-Klass* oopDesc::klass_raw() const {\n+Klass* oopDesc::klass_without_asserts() const {\n@@ -116,1 +116,1 @@\n-    return CompressedKlassPointers::decode_raw(_metadata._compressed_klass);\n+    return CompressedKlassPointers::decode_without_asserts(_metadata._compressed_klass);\n","filename":"src\/hotspot\/share\/oops\/oop.inline.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1259,1 +1259,1 @@\n-    Klass* k = CompressedKlassPointers::decode_raw(narrow_klass);\n+    Klass* k = CompressedKlassPointers::decode_without_asserts(narrow_klass);\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}