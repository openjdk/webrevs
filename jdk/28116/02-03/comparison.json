{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug     4715206 8371164\n+ * @bug     4715206\n@@ -28,1 +28,0 @@\n- *          Test ArrayList-to-ArrayList fast path optimization.\n@@ -33,3 +32,0 @@\n-import java.util.Collections;\n-import java.util.ConcurrentModificationException;\n-import java.util.Iterator;\n@@ -44,8 +40,0 @@\n-        testWeakHashMapAddAll();\n-        testArrayListFastPath();\n-        testArrayListSubclassUsesSlowPath();\n-        testSingletonSetToArray();\n-        testModCountIncrement();\n-    }\n-\n-    private static void testWeakHashMapAddAll() {\n@@ -100,129 +88,0 @@\n-\n-    private static void testArrayListFastPath() {\n-        \/\/ Test ArrayList-to-ArrayList fast path\n-        ArrayList<String> source = new ArrayList<>();\n-        source.add(\"a\");\n-        source.add(\"b\");\n-        source.add(\"c\");\n-\n-        ArrayList<String> dest = new ArrayList<>();\n-        dest.add(\"x\");\n-        boolean result = dest.addAll(source);\n-\n-        if (!result) {\n-            throw new RuntimeException(\"addAll should return true when adding non-empty collection\");\n-        }\n-        if (dest.size() != 4) {\n-            throw new RuntimeException(\"Expected size 4, got \" + dest.size());\n-        }\n-        if (!dest.get(0).equals(\"x\") || !dest.get(1).equals(\"a\") ||\n-            !dest.get(2).equals(\"b\") || !dest.get(3).equals(\"c\")) {\n-            throw new RuntimeException(\"Elements not added correctly, got: \" + dest);\n-        }\n-\n-        \/\/ Test empty ArrayList-to-ArrayList\n-        ArrayList<String> emptySource = new ArrayList<>();\n-        ArrayList<String> dest2 = new ArrayList<>();\n-        dest2.add(\"y\");\n-        boolean result2 = dest2.addAll(emptySource);\n-\n-        if (result2) {\n-            throw new RuntimeException(\"addAll should return false when adding empty collection\");\n-        }\n-        if (dest2.size() != 1 || !dest2.get(0).equals(\"y\")) {\n-            throw new RuntimeException(\"Destination should be unchanged when adding empty collection, got: \" + dest2);\n-        }\n-\n-        \/\/ Test ArrayList fast path with null elements\n-        ArrayList<String> sourceWithNull = new ArrayList<>();\n-        sourceWithNull.add(null);\n-        sourceWithNull.add(\"test\");\n-\n-        ArrayList<String> dest3 = new ArrayList<>();\n-        dest3.addAll(sourceWithNull);\n-\n-        if (dest3.size() != 2 || dest3.get(0) != null || !dest3.get(1).equals(\"test\")) {\n-            throw new RuntimeException(\"Fast path should preserve null elements, got: \" + dest3);\n-        }\n-    }\n-\n-    private static void testSingletonSetToArray() {\n-        \/\/ Test SingletonSet toArray() optimization\n-        var set = Collections.singleton(\"test\");\n-        Object[] array = set.toArray();\n-\n-        if (array.length != 1 || !array[0].equals(\"test\")) {\n-            throw new RuntimeException(\"SingletonSet toArray() failed, expected [test], got: \" + java.util.Arrays.toString(array));\n-        }\n-\n-        \/\/ Test SingletonSet toArray(T[]) with exact size\n-        String[] stringArray = new String[1];\n-        String[] result = set.toArray(stringArray);\n-\n-        if (result != stringArray || result.length != 1 || !result[0].equals(\"test\")) {\n-            throw new RuntimeException(\"SingletonSet toArray(T[]) with exact size failed, expected same array with [test], got: \" + java.util.Arrays.toString(result));\n-        }\n-\n-        \/\/ Test SingletonSet toArray(T[]) with larger array\n-        String[] largerArray = new String[3];\n-        String[] result2 = set.toArray(largerArray);\n-\n-        if (result2 != largerArray || !result2[0].equals(\"test\") || result2[1] != null) {\n-            throw new RuntimeException(\"SingletonSet toArray(T[]) with larger array failed, expected [test, null, ...], got: \" + java.util.Arrays.toString(result2));\n-        }\n-\n-        \/\/ Test SingletonSet toArray(T[]) with smaller array\n-        String[] smallerArray = new String[0];\n-        String[] result3 = set.toArray(smallerArray);\n-\n-        if (result3 == smallerArray || result3.length != 1 || !result3[0].equals(\"test\")) {\n-            throw new RuntimeException(\"SingletonSet toArray(T[]) with smaller array failed, expected new array [test], got: \" + java.util.Arrays.toString(result3));\n-        }\n-    }\n-\n-    private static void testArrayListSubclassUsesSlowPath() {\n-        \/\/ ArrayList subclasses should NOT use the fast path\n-        class ArrayListSubclass<E> extends ArrayList<E> {}\n-\n-        ArrayListSubclass<String> source = new ArrayListSubclass<>();\n-        source.add(\"test\");\n-\n-        ArrayList<String> dest = new ArrayList<>();\n-        boolean result = dest.addAll(source);\n-\n-        if (!result || dest.size() != 1 || !dest.get(0).equals(\"test\")) {\n-            throw new RuntimeException(\"ArrayList subclass addAll failed\");\n-        }\n-    }\n-\n-    private static void testModCountIncrement() {\n-        \/\/ Test that modCount is incremented by checking iterator behavior\n-        ArrayList<String> source = new ArrayList<>();\n-        source.add(\"test\");\n-\n-        ArrayList<String> dest = new ArrayList<>();\n-        Iterator<String> it = dest.iterator();\n-\n-        dest.addAll(source); \/\/ Should increment modCount\n-\n-        try {\n-            it.next(); \/\/ Should throw ConcurrentModificationException\n-            throw new RuntimeException(\"Expected ConcurrentModificationException\");\n-        } catch (ConcurrentModificationException e) {\n-            \/\/ Expected - modCount was incremented\n-        }\n-\n-        \/\/ Test that modCount is incremented even when adding empty ArrayList\n-        ArrayList<String> emptySource = new ArrayList<>();\n-        ArrayList<String> dest2 = new ArrayList<>();\n-        Iterator<String> it2 = dest2.iterator();\n-\n-        dest2.addAll(emptySource); \/\/ Should increment modCount (even though returns false)\n-\n-        try {\n-            it2.next(); \/\/ Should throw ConcurrentModificationException\n-            throw new RuntimeException(\"Expected ConcurrentModificationException for empty addAll\");\n-        } catch (ConcurrentModificationException e) {\n-            \/\/ Expected - modCount was incremented even for empty collection\n-        }\n-    }\n","filename":"test\/jdk\/java\/util\/ArrayList\/AddAll.java","additions":2,"deletions":143,"binary":false,"changes":145,"status":"modified"},{"patch":"@@ -890,0 +890,34 @@\n+    private static void testAddAll(Collection<Integer> c) {\n+        if (! supportsAdd(c)) return;\n+        \n+        clear(c);\n+        \n+        \/\/ Test empty ArrayList source\n+        ArrayList<Integer> emptySource = new ArrayList<>();\n+        check(! c.addAll(emptySource));\n+        \n+        \/\/ Test non-empty ArrayList source\n+        ArrayList<Integer> arraySource = new ArrayList<>();\n+        arraySource.add(42);\n+        arraySource.add(99);\n+        check(c.addAll(arraySource));\n+        equal(new ArrayList<Integer>(c), arraySource);\n+        \n+        clear(c);\n+        \n+        \/\/ Test non-ArrayList source\n+        List<Integer> linkedSource = new LinkedList<>();\n+        linkedSource.add(77);\n+        check(c.addAll(linkedSource));\n+        equal(new ArrayList<Integer>(c), linkedSource);\n+        \n+        \/\/ Test non-empty destination\n+        clear(c);\n+        c.add(10);\n+        c.add(20);\n+        int sizeBefore = c.size();\n+        check(c.addAll(arraySource));\n+        equal(c.size(), sizeBefore + arraySource.size());\n+        check(c.containsAll(arraySource));\n+    }\n+\n@@ -1297,0 +1331,2 @@\n+        testAddAll(c);\n+\n","filename":"test\/jdk\/java\/util\/Collection\/MOAT.java","additions":36,"deletions":0,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -1,109 +0,0 @@\n-\/*\n- * Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-\/*\n- * @test\n- * @bug     8371164\n- * @summary Test Collections.SingletonSet toArray() optimizations\n- * @author  John Engebretson\n- *\/\n-\n-import java.util.Collections;\n-import java.util.Set;\n-\n-public class SingletonSetToArray {\n-    public static void main(String[] args) {\n-        testToArray();\n-        testToArrayWithExactSize();\n-        testToArrayWithLargerArray();\n-        testToArrayWithSmallerArray();\n-        testToArrayWithNullElement();\n-    }\n-\n-    private static void testToArray() {\n-        Set<String> set = Collections.singleton(\"test\");\n-        Object[] array = set.toArray();\n-\n-        if (array.length != 1 || !array[0].equals(\"test\")) {\n-            throw new RuntimeException(\"toArray() failed, expected [test], got: \" + java.util.Arrays.toString(array));\n-        }\n-    }\n-\n-    private static void testToArrayWithExactSize() {\n-        Set<String> set = Collections.singleton(\"test\");\n-        String[] stringArray = new String[1];\n-        String[] result = set.toArray(stringArray);\n-\n-        if (result != stringArray || result.length != 1 || !result[0].equals(\"test\")) {\n-            throw new RuntimeException(\"toArray(T[]) with exact size failed, expected same array with [test], got: \" + java.util.Arrays.toString(result));\n-        }\n-    }\n-\n-    private static void testToArrayWithLargerArray() {\n-        Set<String> set = Collections.singleton(\"test\");\n-        String[] largerArray = new String[5];\n-        String[] result = set.toArray(largerArray);\n-\n-        if (result != largerArray || !result[0].equals(\"test\") || result[1] != null) {\n-            throw new RuntimeException(\"toArray(T[]) with larger array failed, expected [test, null, ...], got: \" + java.util.Arrays.toString(result));\n-        }\n-\n-        \/\/ Verify remaining elements are unchanged (should remain null)\n-        for (int i = 2; i < largerArray.length; i++) {\n-            if (largerArray[i] != null) {\n-                throw new RuntimeException(\"Array element \" + i + \" should remain null, got: \" + largerArray[i]);\n-            }\n-        }\n-    }\n-\n-    private static void testToArrayWithSmallerArray() {\n-        Set<String> set = Collections.singleton(\"test\");\n-        String[] smallerArray = new String[0];\n-        String[] result = set.toArray(smallerArray);\n-\n-        if (result == smallerArray || result.length != 1 || !result[0].equals(\"test\")) {\n-            throw new RuntimeException(\"toArray(T[]) with smaller array failed, expected new array [test], got: \" + java.util.Arrays.toString(result));\n-        }\n-\n-        \/\/ Verify correct array type was created\n-        if (!result.getClass().getComponentType().equals(String.class)) {\n-            throw new RuntimeException(\"Wrong array type created, expected String[], got: \" + result.getClass().getComponentType());\n-        }\n-    }\n-\n-    private static void testToArrayWithNullElement() {\n-        Set<String> set = Collections.singleton(null);\n-        Object[] array = set.toArray();\n-\n-        if (array.length != 1 || array[0] != null) {\n-            throw new RuntimeException(\"toArray() with null element failed, expected [null], got: \" + java.util.Arrays.toString(array));\n-        }\n-\n-        String[] stringArray = new String[1];\n-        String[] result = set.toArray(stringArray);\n-\n-        if (result != stringArray || result.length != 1 || result[0] != null) {\n-            throw new RuntimeException(\"toArray(T[]) with null element failed, expected [null], got: \" + java.util.Arrays.toString(result));\n-        }\n-    }\n-}\n","filename":"test\/jdk\/java\/util\/Collections\/SingletonSetToArray.java","additions":0,"deletions":109,"binary":false,"changes":109,"status":"deleted"}]}