{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -753,0 +753,16 @@\n+        if (c.getClass() == ArrayList.class) {\n+            ArrayList<?> src = (ArrayList<?>) c;\n+            Object[] a = src.elementData;\n+            int numNew = src.size;\n+            modCount++;\n+            if (numNew == 0)\n+                return false;\n+            Object[] elementData;\n+            final int s;\n+            if (numNew > (elementData = this.elementData).length - (s = size))\n+                elementData = grow(s + numNew);\n+            System.arraycopy(a, 0, elementData, s, numNew);\n+            size = s + numNew;\n+            return true;\n+        }\n+\n","filename":"src\/java.base\/share\/classes\/java\/util\/ArrayList.java","additions":17,"deletions":1,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -5256,0 +5256,14 @@\n+        @Override\n+        public Object[] toArray() {\n+            return new Object[] {element};\n+        }\n+        @Override\n+        @SuppressWarnings(\"unchecked\")\n+        public <T> T[] toArray(T[] a) {\n+            if (a.length < 1)\n+                a = (T[])java.lang.reflect.Array.newInstance(a.getClass().getComponentType(), 1);\n+            a[0] = (T)element;\n+            if (a.length > 1)\n+                a[1] = null;\n+            return a;\n+        }\n","filename":"src\/java.base\/share\/classes\/java\/util\/Collections.java","additions":14,"deletions":0,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug     4715206\n+ * @bug     4715206 8371164\n@@ -28,0 +28,1 @@\n+ *          Test ArrayList-to-ArrayList fast path optimization.\n@@ -32,0 +33,3 @@\n+import java.util.Collections;\n+import java.util.ConcurrentModificationException;\n+import java.util.Iterator;\n@@ -40,0 +44,8 @@\n+        testWeakHashMapAddAll();\n+        testArrayListFastPath();\n+        testArrayListSubclassUsesSlowPath();\n+        testSingletonSetToArray();\n+        testModCountIncrement();\n+    }\n+\n+    private static void testWeakHashMapAddAll() {\n@@ -88,0 +100,129 @@\n+\n+    private static void testArrayListFastPath() {\n+        \/\/ Test ArrayList-to-ArrayList fast path\n+        ArrayList<String> source = new ArrayList<>();\n+        source.add(\"a\");\n+        source.add(\"b\");\n+        source.add(\"c\");\n+\n+        ArrayList<String> dest = new ArrayList<>();\n+        dest.add(\"x\");\n+        boolean result = dest.addAll(source);\n+\n+        if (!result) {\n+            throw new RuntimeException(\"addAll should return true when adding non-empty collection\");\n+        }\n+        if (dest.size() != 4) {\n+            throw new RuntimeException(\"Expected size 4, got \" + dest.size());\n+        }\n+        if (!dest.get(0).equals(\"x\") || !dest.get(1).equals(\"a\") ||\n+            !dest.get(2).equals(\"b\") || !dest.get(3).equals(\"c\")) {\n+            throw new RuntimeException(\"Elements not added correctly, got: \" + dest);\n+        }\n+\n+        \/\/ Test empty ArrayList-to-ArrayList\n+        ArrayList<String> emptySource = new ArrayList<>();\n+        ArrayList<String> dest2 = new ArrayList<>();\n+        dest2.add(\"y\");\n+        boolean result2 = dest2.addAll(emptySource);\n+\n+        if (result2) {\n+            throw new RuntimeException(\"addAll should return false when adding empty collection\");\n+        }\n+        if (dest2.size() != 1 || !dest2.get(0).equals(\"y\")) {\n+            throw new RuntimeException(\"Destination should be unchanged when adding empty collection, got: \" + dest2);\n+        }\n+\n+        \/\/ Test ArrayList fast path with null elements\n+        ArrayList<String> sourceWithNull = new ArrayList<>();\n+        sourceWithNull.add(null);\n+        sourceWithNull.add(\"test\");\n+\n+        ArrayList<String> dest3 = new ArrayList<>();\n+        dest3.addAll(sourceWithNull);\n+\n+        if (dest3.size() != 2 || dest3.get(0) != null || !dest3.get(1).equals(\"test\")) {\n+            throw new RuntimeException(\"Fast path should preserve null elements, got: \" + dest3);\n+        }\n+    }\n+\n+    private static void testSingletonSetToArray() {\n+        \/\/ Test SingletonSet toArray() optimization\n+        var set = Collections.singleton(\"test\");\n+        Object[] array = set.toArray();\n+\n+        if (array.length != 1 || !array[0].equals(\"test\")) {\n+            throw new RuntimeException(\"SingletonSet toArray() failed, expected [test], got: \" + java.util.Arrays.toString(array));\n+        }\n+\n+        \/\/ Test SingletonSet toArray(T[]) with exact size\n+        String[] stringArray = new String[1];\n+        String[] result = set.toArray(stringArray);\n+\n+        if (result != stringArray || result.length != 1 || !result[0].equals(\"test\")) {\n+            throw new RuntimeException(\"SingletonSet toArray(T[]) with exact size failed, expected same array with [test], got: \" + java.util.Arrays.toString(result));\n+        }\n+\n+        \/\/ Test SingletonSet toArray(T[]) with larger array\n+        String[] largerArray = new String[3];\n+        String[] result2 = set.toArray(largerArray);\n+\n+        if (result2 != largerArray || !result2[0].equals(\"test\") || result2[1] != null) {\n+            throw new RuntimeException(\"SingletonSet toArray(T[]) with larger array failed, expected [test, null, ...], got: \" + java.util.Arrays.toString(result2));\n+        }\n+\n+        \/\/ Test SingletonSet toArray(T[]) with smaller array\n+        String[] smallerArray = new String[0];\n+        String[] result3 = set.toArray(smallerArray);\n+\n+        if (result3 == smallerArray || result3.length != 1 || !result3[0].equals(\"test\")) {\n+            throw new RuntimeException(\"SingletonSet toArray(T[]) with smaller array failed, expected new array [test], got: \" + java.util.Arrays.toString(result3));\n+        }\n+    }\n+\n+    private static void testArrayListSubclassUsesSlowPath() {\n+        \/\/ ArrayList subclasses should NOT use the fast path\n+        class ArrayListSubclass<E> extends ArrayList<E> {}\n+\n+        ArrayListSubclass<String> source = new ArrayListSubclass<>();\n+        source.add(\"test\");\n+\n+        ArrayList<String> dest = new ArrayList<>();\n+        boolean result = dest.addAll(source);\n+\n+        if (!result || dest.size() != 1 || !dest.get(0).equals(\"test\")) {\n+            throw new RuntimeException(\"ArrayList subclass addAll failed\");\n+        }\n+    }\n+\n+    private static void testModCountIncrement() {\n+        \/\/ Test that modCount is incremented by checking iterator behavior\n+        ArrayList<String> source = new ArrayList<>();\n+        source.add(\"test\");\n+\n+        ArrayList<String> dest = new ArrayList<>();\n+        Iterator<String> it = dest.iterator();\n+\n+        dest.addAll(source); \/\/ Should increment modCount\n+\n+        try {\n+            it.next(); \/\/ Should throw ConcurrentModificationException\n+            throw new RuntimeException(\"Expected ConcurrentModificationException\");\n+        } catch (ConcurrentModificationException e) {\n+            \/\/ Expected - modCount was incremented\n+        }\n+\n+        \/\/ Test that modCount is incremented even when adding empty ArrayList\n+        ArrayList<String> emptySource = new ArrayList<>();\n+        ArrayList<String> dest2 = new ArrayList<>();\n+        Iterator<String> it2 = dest2.iterator();\n+\n+        dest2.addAll(emptySource); \/\/ Should increment modCount (even though returns false)\n+\n+        try {\n+            it2.next(); \/\/ Should throw ConcurrentModificationException\n+            throw new RuntimeException(\"Expected ConcurrentModificationException for empty addAll\");\n+        } catch (ConcurrentModificationException e) {\n+            \/\/ Expected - modCount was incremented even for empty collection\n+        }\n+    }\n","filename":"test\/jdk\/java\/util\/ArrayList\/AddAll.java","additions":143,"deletions":2,"binary":false,"changes":145,"status":"modified"},{"patch":"@@ -0,0 +1,109 @@\n+\/*\n+ * Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug     8371164\n+ * @summary Test Collections.SingletonSet toArray() optimizations\n+ * @author  John Engebretson\n+ *\/\n+\n+import java.util.Collections;\n+import java.util.Set;\n+\n+public class SingletonSetToArray {\n+    public static void main(String[] args) {\n+        testToArray();\n+        testToArrayWithExactSize();\n+        testToArrayWithLargerArray();\n+        testToArrayWithSmallerArray();\n+        testToArrayWithNullElement();\n+    }\n+\n+    private static void testToArray() {\n+        Set<String> set = Collections.singleton(\"test\");\n+        Object[] array = set.toArray();\n+\n+        if (array.length != 1 || !array[0].equals(\"test\")) {\n+            throw new RuntimeException(\"toArray() failed, expected [test], got: \" + java.util.Arrays.toString(array));\n+        }\n+    }\n+\n+    private static void testToArrayWithExactSize() {\n+        Set<String> set = Collections.singleton(\"test\");\n+        String[] stringArray = new String[1];\n+        String[] result = set.toArray(stringArray);\n+\n+        if (result != stringArray || result.length != 1 || !result[0].equals(\"test\")) {\n+            throw new RuntimeException(\"toArray(T[]) with exact size failed, expected same array with [test], got: \" + java.util.Arrays.toString(result));\n+        }\n+    }\n+\n+    private static void testToArrayWithLargerArray() {\n+        Set<String> set = Collections.singleton(\"test\");\n+        String[] largerArray = new String[5];\n+        String[] result = set.toArray(largerArray);\n+\n+        if (result != largerArray || !result[0].equals(\"test\") || result[1] != null) {\n+            throw new RuntimeException(\"toArray(T[]) with larger array failed, expected [test, null, ...], got: \" + java.util.Arrays.toString(result));\n+        }\n+\n+        \/\/ Verify remaining elements are unchanged (should remain null)\n+        for (int i = 2; i < largerArray.length; i++) {\n+            if (largerArray[i] != null) {\n+                throw new RuntimeException(\"Array element \" + i + \" should remain null, got: \" + largerArray[i]);\n+            }\n+        }\n+    }\n+\n+    private static void testToArrayWithSmallerArray() {\n+        Set<String> set = Collections.singleton(\"test\");\n+        String[] smallerArray = new String[0];\n+        String[] result = set.toArray(smallerArray);\n+\n+        if (result == smallerArray || result.length != 1 || !result[0].equals(\"test\")) {\n+            throw new RuntimeException(\"toArray(T[]) with smaller array failed, expected new array [test], got: \" + java.util.Arrays.toString(result));\n+        }\n+\n+        \/\/ Verify correct array type was created\n+        if (!result.getClass().getComponentType().equals(String.class)) {\n+            throw new RuntimeException(\"Wrong array type created, expected String[], got: \" + result.getClass().getComponentType());\n+        }\n+    }\n+\n+    private static void testToArrayWithNullElement() {\n+        Set<String> set = Collections.singleton(null);\n+        Object[] array = set.toArray();\n+\n+        if (array.length != 1 || array[0] != null) {\n+            throw new RuntimeException(\"toArray() with null element failed, expected [null], got: \" + java.util.Arrays.toString(array));\n+        }\n+\n+        String[] stringArray = new String[1];\n+        String[] result = set.toArray(stringArray);\n+\n+        if (result != stringArray || result.length != 1 || result[0] != null) {\n+            throw new RuntimeException(\"toArray(T[]) with null element failed, expected [null], got: \" + java.util.Arrays.toString(result));\n+        }\n+    }\n+}\n","filename":"test\/jdk\/java\/util\/Collections\/SingletonSetToArray.java","additions":109,"deletions":0,"binary":false,"changes":109,"status":"added"},{"patch":"@@ -0,0 +1,128 @@\n+\/*\n+ * Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package org.openjdk.bench.java.util;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.LinkedList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.WeakHashMap;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.openjdk.jmh.annotations.Benchmark;\n+import org.openjdk.jmh.annotations.BenchmarkMode;\n+import org.openjdk.jmh.annotations.Fork;\n+import org.openjdk.jmh.annotations.Level;\n+import org.openjdk.jmh.annotations.Measurement;\n+import org.openjdk.jmh.annotations.Mode;\n+import org.openjdk.jmh.annotations.OutputTimeUnit;\n+import org.openjdk.jmh.annotations.Param;\n+import org.openjdk.jmh.annotations.Scope;\n+import org.openjdk.jmh.annotations.Setup;\n+import org.openjdk.jmh.annotations.State;\n+import org.openjdk.jmh.annotations.Warmup;\n+\n+\n+\/**\n+ * Benchmark measuring ArrayList addAll() performance.\n+ *\n+ * Tests the performance of ArrayList.addAll() when copying from another ArrayList.\n+ *\/\n+@BenchmarkMode(Mode.AverageTime)\n+@OutputTimeUnit(TimeUnit.NANOSECONDS)\n+@State(Scope.Benchmark)\n+@Warmup(iterations = 3, time = 1, timeUnit = TimeUnit.SECONDS)\n+@Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)\n+@Fork(value = 1, jvmArgs = { \"-XX:+UseParallelGC\", \"-Xmx3g\" })\n+public class ArrayListBulkOpsBenchmark {\n+    @Param({\"0\", \"1\", \"5\", \"75\"})\n+    int size;\n+\n+    @Param({\"ArrayList\", \"LinkedList\"})\n+    String type;\n+\n+    List<String> source;\n+\n+    @Setup(Level.Trial)\n+    public void setup() {\n+        switch (type) {\n+            case \"ArrayList\" -> source = new ArrayList<>(size);\n+            case \"LinkedList\" -> source = new LinkedList<>();\n+        }\n+        for (int i = 0; i < size; i++) source.add(\"key\" + i);\n+    }\n+\n+    @Benchmark\n+    public ArrayList<String> addAll() {\n+        ArrayList<String> result = new ArrayList<>(size);\n+        result.addAll(source);\n+        return result;\n+    }\n+\n+    static void poisonCallSites() {\n+        HashMap<String, String> hashMapSource = new HashMap<>();\n+        TreeSet<String> treeSetSource = new TreeSet<>();\n+        WeakHashMap<String, String> weakHashMapSource = new WeakHashMap<>();\n+        for (int i = 0; i < 75; i++) {\n+            hashMapSource.put(\"key\" + i, \"value\" + i);\n+            treeSetSource.add(\"key\" + i);\n+            weakHashMapSource.put(\"key\" + i, \"value\" + i);\n+        }\n+        \/\/ Poison ArrayList.addAll() with different Collection types\n+        for (int i = 0; i < 40_000; i++) {\n+            ArrayList<Object> temp = new ArrayList<>();\n+            temp.addAll(hashMapSource.entrySet());\n+            temp.addAll(treeSetSource);\n+            temp.addAll(weakHashMapSource.keySet());\n+        }\n+    }\n+\n+    @BenchmarkMode(Mode.AverageTime)\n+    @OutputTimeUnit(TimeUnit.NANOSECONDS)\n+    @State(Scope.Benchmark)\n+    @Warmup(iterations = 3, time = 1, timeUnit = TimeUnit.SECONDS)\n+    @Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)\n+    @Fork(value = 1, jvmArgs = { \"-XX:+UseParallelGC\", \"-Xmx3g\" })\n+    public static class SingletonSet {\n+        Set<String> singletonSetSource = Collections.singleton(\"key\");\n+\n+        @Param({ \"false\", \"true\" })\n+        private boolean poison;\n+\n+        @Setup(Level.Trial)\n+        public void setup() {\n+            if (poison) poisonCallSites();\n+        }\n+\n+        @Benchmark\n+        public ArrayList<String> addAllSingletonSet() {\n+            ArrayList<String> result = new ArrayList<>(1);\n+            result.addAll(singletonSetSource);\n+            return result;\n+        }\n+    }\n+}\n\\ No newline at end of file\n","filename":"test\/micro\/org\/openjdk\/bench\/java\/util\/ArrayListBulkOpsBenchmark.java","additions":128,"deletions":0,"binary":false,"changes":128,"status":"added"}]}