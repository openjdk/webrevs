{"files":[{"patch":"@@ -0,0 +1,187 @@\n+#\n+# Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+#\n+# This code is free software; you can redistribute it and\/or modify it\n+# under the terms of the GNU General Public License version 2 only, as\n+# published by the Free Software Foundation.  Oracle designates this\n+# particular file as subject to the \"Classpath\" exception as provided\n+# by Oracle in the LICENSE file that accompanied this code.\n+#\n+# This code is distributed in the hope that it will be useful, but WITHOUT\n+# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+# version 2 for more details (a copy is included in the LICENSE file that\n+# accompanied this code).\n+#\n+# You should have received a copy of the GNU General Public License version\n+# 2 along with this work; if not, write to the Free Software Foundation,\n+# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+#\n+# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+# or visit www.oracle.com if you need additional information or have any\n+# questions.\n+#\n+\n+################################################################################\n+# Setup krb5 (Kerberos 5)\n+################################################################################\n+AC_DEFUN_ONCE([LIB_SETUP_KRB5],\n+[\n+  AC_ARG_WITH(krb5, [AS_HELP_STRING([--with-krb5],\n+      [specify prefix directory for the krb5 package on Linux, or use \"yes\/no\/auto\" (default=auto)])])\n+  AC_ARG_WITH(krb5-include, [AS_HELP_STRING([--with-krb5-include],\n+      [specify directory for the krb5 include files on Linux])])\n+  AC_ARG_WITH(krb5-lib, [AS_HELP_STRING([--with-krb5-lib],\n+      [specify directory for the krb5 library on Linux])])\n+\n+  KRB5_CFLAGS=\n+  KRB5_LIBS=\n+  ENABLE_LIBKRB5_LINUX=false\n+\n+  if test \"x$OPENJDK_TARGET_OS\" != \"xlinux\" && test \"x${with_krb5}\" = \"xyes\"; then\n+    AC_MSG_ERROR([krb5 support is only available on Linux])\n+  elif test \"x${with_krb5}\" = \"xno\"; then\n+    AC_MSG_CHECKING([for krb5])\n+    AC_MSG_RESULT([disabled])\n+  else\n+    KRB5_FOUND=no\n+\n+    if test \"x${with_krb5}\" != \"x\" && test \"x${with_krb5}\" != \"xyes\" && test \"x${with_krb5}\" != \"xauto\"; then\n+      # if a path was provided, use it\n+      if test \"x${with_krb5}\" != \"x\"; then\n+        AC_MSG_CHECKING([for krb5])\n+        KRB5_LIBS=\"-L${with_krb5}\/lib -lkrb5 -lcom_err\"\n+        KRB5_CFLAGS=\"-I${with_krb5}\/include\"\n+        KRB5_FOUND=yes\n+        AC_MSG_RESULT([${with_krb5}])\n+      fi\n+    fi\n+\n+    if test \"x${with_krb5_include}\" != \"x\"; then\n+      AC_MSG_CHECKING([for krb5 includes])\n+      KRB5_CFLAGS=\"-I${with_krb5_include}\"\n+      KRB5_FOUND=yes\n+      AC_MSG_RESULT([${with_krb5_include}])\n+    fi\n+\n+    if test \"x${with_krb5_lib}\" != \"x\"; then\n+      AC_MSG_CHECKING([for krb5 libs])\n+      KRB5_LIBS=\"-L${with_krb5_lib} -lkrb5 -lcom_err\"\n+      KRB5_FOUND=yes\n+      AC_MSG_RESULT([${with_krb5_lib}])\n+    fi\n+\n+    if test \"x$KRB5_FOUND\" = \"xno\"; then\n+      if test \"x$SYSROOT\" != \"x\"; then\n+        AC_MSG_CHECKING([for krb5 ($SYSROOT)])\n+        # Cross-compilation with SYSROOT - look at known locations in SYSROOT.\n+        KRB5_LIB_PATH=\"\"\n+        COM_ERR_LIB_PATH=\"\"\n+\n+        # Look for libkrb5\/libcom_err\n+        if test -f \"$SYSROOT\/usr\/lib64\/libkrb5.so\" && test \"x$OPENJDK_TARGET_CPU_BITS\" = x64; then\n+          KRB5_LIB_PATH=\"$SYSROOT\/usr\/lib64\"\n+        elif test -f \"$SYSROOT\/usr\/lib\/libkrb5.so\"; then\n+          KRB5_LIB_PATH=\"$SYSROOT\/usr\/lib\"\n+        elif test -f \"$SYSROOT\/usr\/lib\/$OPENJDK_TARGET_CPU-$OPENJDK_TARGET_OS-$OPENJDK_TARGET_ABI\/libkrb5.so\"; then\n+          KRB5_LIB_PATH=\"$SYSROOT\/usr\/lib\/$OPENJDK_TARGET_CPU-$OPENJDK_TARGET_OS-$OPENJDK_TARGET_ABI\"\n+        elif test -f \"$SYSROOT\/usr\/lib\/$OPENJDK_TARGET_CPU_AUTOCONF-$OPENJDK_TARGET_OS-$OPENJDK_TARGET_ABI\/libkrb5.so\"; then\n+          KRB5_LIB_PATH=\"$SYSROOT\/usr\/lib\/$OPENJDK_TARGET_CPU_AUTOCONF-$OPENJDK_TARGET_OS-$OPENJDK_TARGET_ABI\"\n+        fi\n+\n+        if test -f \"$KRB5_LIB_PATH\/libcom_err.so\"; then\n+          COM_ERR_LIB_PATH=\"$KRB5_LIB_PATH\"\n+        elif test -f \"$SYSROOT\/usr\/lib64\/libcom_err.so\" && test \"x$OPENJDK_TARGET_CPU_BITS\" = x64; then\n+          COM_ERR_LIB_PATH=\"$SYSROOT\/usr\/lib64\"\n+        elif test -f \"$SYSROOT\/usr\/lib\/libcom_err.so\"; then\n+          COM_ERR_LIB_PATH=\"$SYSROOT\/usr\/lib\"\n+        elif test -f \"$SYSROOT\/usr\/lib\/$OPENJDK_TARGET_CPU-$OPENJDK_TARGET_OS-$OPENJDK_TARGET_ABI\/libcom_err.so\"; then\n+          COM_ERR_LIB_PATH=\"$SYSROOT\/usr\/lib\/$OPENJDK_TARGET_CPU-$OPENJDK_TARGET_OS-$OPENJDK_TARGET_ABI\"\n+        elif test -f \"$SYSROOT\/usr\/lib\/$OPENJDK_TARGET_CPU_AUTOCONF-$OPENJDK_TARGET_OS-$OPENJDK_TARGET_ABI\/libcom_err.so\"; then\n+          COM_ERR_LIB_PATH=\"$SYSROOT\/usr\/lib\/$OPENJDK_TARGET_CPU_AUTOCONF-$OPENJDK_TARGET_OS-$OPENJDK_TARGET_ABI\"\n+        fi\n+\n+        # Check for matching include files\n+        KRB5_INCLUDE_PATH=\"\"\n+        COM_ERR_INCLUDE_PATH=\"\"\n+\n+        if test -f \"$SYSROOT\/usr\/include\/krb5\/krb5.h\"; then\n+          KRB5_INCLUDE_PATH=\"$SYSROOT\/usr\/include\"\n+        fi\n+\n+        if test -f \"$SYSROOT\/usr\/include\/com_err.h\"; then\n+          COM_ERR_INCLUDE_PATH=\"$SYSROOT\/usr\/include\"\n+        fi\n+\n+        # Check everything was found and merge paths\n+        if test \"x$KRB5_LIB_PATH\" != \"x\" && test \"x$COM_ERR_LIB_PATH\" != \"x\" && \\\n+             test \"x$KRB5_INCLUDE_PATH\" != \"x\" && test \"x$COM_ERR_INCLUDE_PATH\" != \"x\"; then\n+          KRB5_LIBS=\"-L$KRB5_LIB_PATH -lkrb5\"\n+          if test \"x$COM_ERR_LIB_PATH\" != \"x\" && test \"x$COM_ERR_LIB_PATH\" != \"x$KRB5_LIB_PATH\"; then\n+            KRB5_LIBS=\"$KRB5_LIBS -L$COM_ERR_LIB_PATH\"\n+          fi\n+          KRB5_LIBS=\"$KRB5_LIBS -lcom_err\"\n+\n+          KRB5_CFLAGS=\"-I$KRB5_INCLUDE_PATH\"\n+          if test \"x$COM_ERR_INCLUDE_PATH\" != \"x\" && test \"x$COM_ERR_INCLUDE_PATH\" != \"x$KRB5_INCLUDE_PATH\"; then\n+            KRB5_CFLAGS=\"$KRB5_CFLAGS -I$COM_ERR_INCLUDE_PATH\"\n+          fi\n+\n+          KRB5_FOUND=yes\n+        fi\n+        AC_MSG_RESULT([$KRB5_FOUND])\n+      else\n+        if test \"x$PKG_CONFIG\" != \"x\" ; then\n+          PKG_CHECK_MODULES(KRB5, krb5, [KRB5_FOUND=yes], [KRB5_FOUND=no])\n+          if test \"x$KRB5_FOUND\" = \"xyes\" ; then\n+            AC_MSG_CHECKING([for krb5])\n+            AC_MSG_RESULT([yes (using pkg-config)])\n+          fi\n+        fi\n+\n+        if test \"x$KRB5_FOUND\" = \"xno\"; then\n+          UTIL_LOOKUP_PROGS(KRB5CONF, krb5-config)\n+          if test \"x$KRB5CONF\" != \"x\"; then\n+            AC_MSG_CHECKING([for krb5 using krb5-config])\n+            KRB5_CFLAGS=\"`$KRB5CONF --cflags`\"\n+            KRB5_LIBS=\"`$KRB5CONF --libs`\"\n+            KRB5_FOUND=yes\n+            AC_MSG_RESULT([$KRB5_FOUND])\n+          fi\n+        fi\n+      fi\n+    fi\n+\n+    # No sysconfig\/pkg-config\/krb5-config, so auto-detect\n+    if test \"x$KRB5_FOUND\" = \"xno\"; then\n+      AC_CHECK_HEADERS([krb5.h], [\n+        AC_CHECK_HEADERS([com_err.h], [\n+          AC_CHECK_LIB([krb5], [krb5_init_context], [\n+            KRB5_CFLAGS=\"\"\n+            KRB5_LIBS=\"-lkrb5\"\n+            AC_CHECK_LIB([com_err], [com_err], [\n+              KRB5_LIBS=\"$KRB5_LIBS -lcom_err\"\n+            ])\n+            KRB5_FOUND=yes\n+          ])\n+        ])\n+      ])\n+    fi\n+\n+    if test \"x$KRB5_FOUND\" = \"xno\"; then\n+      if test \"x${with_krb5}\" = \"xyes\"; then\n+        AC_MSG_ERROR([krb5 was required but could not be found])\n+      fi\n+      KRB5_CFLAGS=\n+      KRB5_LIBS=\n+      ENABLE_LIBKRB5_LINUX=false\n+    else\n+      ENABLE_LIBKRB5_LINUX=true\n+    fi\n+  fi\n+\n+  AC_SUBST(KRB5_CFLAGS)\n+  AC_SUBST(KRB5_LIBS)\n+  AC_SUBST(ENABLE_LIBKRB5_LINUX)\n+])\n","filename":"make\/autoconf\/lib-krb5.m4","additions":187,"deletions":0,"binary":false,"changes":187,"status":"added"},{"patch":"@@ -34,0 +34,1 @@\n+m4_include([lib-krb5.m4])\n@@ -120,0 +121,1 @@\n+  LIB_SETUP_KRB5\n","filename":"make\/autoconf\/libraries.m4","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -438,0 +438,3 @@\n+KRB5_LIBS := @KRB5_LIBS@\n+KRB5_CFLAGS := @KRB5_CFLAGS@\n+ENABLE_LIBKRB5_LINUX := @ENABLE_LIBKRB5_LINUX@\n","filename":"make\/autoconf\/spec.gmk.template","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -89,0 +89,1 @@\n+        EXTRA_SRC := $(TOPDIR)\/src\/java.security.jgss\/share\/native\/libkrb5shared, \\\n@@ -98,0 +99,17 @@\n+\n+  ifeq ($(call isTargetOs, linux), true)\n+    ifeq ($(ENABLE_LIBKRB5_LINUX), true)\n+      $(eval $(call SetupJdkLibrary, BUILD_LIBKRB5_LINUX, \\\n+          NAME := linuxkrb5, \\\n+          OPTIMIZATION := LOW, \\\n+          DISABLED_WARNINGS_clang_nativeccache.c := deprecated-declarations, \\\n+          EXTRA_HEADER_DIRS := java.base:libjava, \\\n+          EXTRA_SRC := $(TOPDIR)\/src\/java.security.jgss\/share\/native\/libkrb5shared, \\\n+          CFLAGS_linux := $(KRB5_CFLAGS) $(COM_ERR_CFLAGS), \\\n+          LIBS_linux := $(KRB5_LIBS) $(COM_ERR_LIBS), \\\n+      ))\n+\n+      TARGETS += $(BUILD_LIBKRB5_LINUX)\n+    endif\n+  endif\n+\n","filename":"make\/modules\/java.security.jgss\/Lib.gmk","additions":18,"deletions":0,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -113,0 +113,19 @@\n+# Kerberos native test library configuration\n+ifeq ($(call isTargetOs, linux), true)\n+  # Linux: only build if krb5 is enabled and working\n+  ifeq ($(ENABLE_LIBKRB5_LINUX), true)\n+    BUILD_JDK_JTREG_LIBRARIES_LDFLAGS_libNativeCredentialCacheHelper := $(KRB5_LIBS)\n+    BUILD_JDK_JTREG_LIBRARIES_CFLAGS_libNativeCredentialCacheHelper := $(KRB5_CFLAGS)\n+  else\n+    # Exclude the Kerberos test library if krb5 is not available on Linux\n+    BUILD_JDK_JTREG_EXCLUDE += libNativeCredentialCacheHelper.c\n+  endif\n+else ifeq ($(call isTargetOs, macosx), true)\n+  # macOS: build with system krb5 and disable deprecation warnings\n+  BUILD_JDK_JTREG_LIBRARIES_LDFLAGS_libNativeCredentialCacheHelper := $(KRB5_LIBS)\n+  BUILD_JDK_JTREG_LIBRARIES_CFLAGS_libNativeCredentialCacheHelper := $(KRB5_CFLAGS) -Wno-deprecated-declarations\n+else\n+  # Other platforms: exclude the library\n+  BUILD_JDK_JTREG_EXCLUDE += libNativeCredentialCacheHelper.c\n+endif\n+\n","filename":"make\/test\/JtregNativeJdk.gmk","additions":19,"deletions":0,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -329,3 +329,6 @@\n-            \/\/ The default ticket cache on Windows and Mac is not a file.\n-            if (OperatingSystem.isWindows() ||\n-                    OperatingSystem.isMacOS()) {\n+            \/\/ On Windows\/MacOSX\/Linux, use native system library calls to acquire\n+            \/\/ credentials from any supported credential cache types on those\n+            \/\/ platforms (in particular, the default ticket cache on Windows and\n+            \/\/ MacOSX is not a file, so cannot use the pure Java code)\n+            if (OperatingSystem.isWindows() || OperatingSystem.isMacOS()\n+                    || OperatingSystem.isLinux()) {\n@@ -414,1 +417,1 @@\n-    \/\/ This method is only called on Windows and Mac OS X, the native\n+    \/\/ This method is only called on Windows, MacOSX and Linux, the native\n@@ -531,0 +534,2 @@\n+        } else if (OperatingSystem.isLinux()) {\n+            System.loadLibrary(\"linuxkrb5\");\n","filename":"src\/java.security.jgss\/share\/classes\/sun\/security\/krb5\/Credentials.java","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,4 +26,18 @@\n-#import \"sun_security_krb5_Credentials.h\"\n-#import <Kerberos\/Kerberos.h>\n-#import <string.h>\n-#import <time.h>\n+\/*\n+ * Unified Kerberos native credential cache implementation for MacOSX\/Linux.\n+ *\/\n+\n+#include \"sun_security_krb5_Credentials.h\"\n+#include <string.h>\n+#include <time.h>\n+#include <stdarg.h>\n+\n+#ifdef MACOSX\n+    \/\/ Mac OS X specific includes\n+    #import <Kerberos\/Kerberos.h>\n+#elif defined(LINUX)\n+    \/\/ Linux specific includes\n+    #include <krb5\/krb5.h>\n+    #include <arpa\/inet.h>\n+    #include <com_err.h>\n+#endif\n@@ -75,1 +89,1 @@\n-static jobject BuildAddressList(JNIEnv *env, krb5_address **kerbtime);\n+static jobject BuildAddressList(JNIEnv *env, krb5_address **addresses);\n@@ -449,3 +463,0 @@\n-\n-#pragma mark -\n-\n@@ -570,0 +581,4 @@\n+    if (addressCount == 0) {\n+        return NULL;\n+    }\n+\n@@ -610,2 +625,0 @@\n-#pragma mark - Utility methods -\n-\n","filename":"src\/java.security.jgss\/share\/native\/libkrb5shared\/nativeccache.c","additions":24,"deletions":11,"binary":false,"changes":35,"previous_filename":"src\/java.security.jgss\/macosx\/native\/libosxkrb5\/nativeccache.c","status":"renamed"},{"patch":"@@ -0,0 +1,170 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @summary Test JAAS access to in-memory credential caches\n+ * @library \/test\/lib\n+ * @requires os.family != \"windows\"\n+ * @modules java.security.jgss\/sun.security.krb5:+open\n+ *          java.security.jgss\/sun.security.krb5.internal:+open\n+ *          java.security.jgss\/sun.security.krb5.internal.ccache\n+ *          java.security.jgss\/sun.security.krb5.internal.crypto\n+ *          java.security.jgss\/sun.security.krb5.internal.ktab\n+ *          java.security.jgss\/sun.security.jgss.krb5\n+ *          java.base\/sun.security.util:+open\n+ *          java.base\/jdk.internal.misc\n+ * @compile NativeCacheTest.java\n+ * @run main jdk.test.lib.FileInstaller TestHosts TestHosts\n+ * @run main\/othervm\/native --enable-native-access=ALL-UNNAMED -Djdk.net.hosts.file=TestHosts NativeCacheTest\n+ *\/\n+\n+import sun.security.krb5.Credentials;\n+import javax.security.auth.login.LoginContext;\n+import javax.security.auth.Subject;\n+import javax.security.auth.kerberos.KerberosTicket;\n+import java.io.File;\n+\n+\/**\n+ * Test JAAS access to in-memory credential caches.\n+ *\n+ * This test validates that JAAS can access in-memory credential caches\n+ * on Linux through the native enhancement, using TGTs from OneKDC.\n+ *\/\n+public class NativeCacheTest {\n+\n+    public static void main(String[] args) throws Exception {\n+        try {\n+            \/\/ Create TGT using OneKDC (in file cache)\n+            createTGTWithOneKDC();\n+\n+            \/\/ Copy TGT to in-memory cache using JNI\n+            String inMemoryCacheName = copyTGTToInMemoryCache();\n+\n+            \/\/ Test JAAS access to in-memory cache\n+            testJAASAccessToInMemoryCache(inMemoryCacheName);\n+\n+        } catch (UnsatisfiedLinkError e) {\n+            System.out.println(\"Kerberos native library not available - test skipped\");\n+            return;\n+        } catch (Exception e) {\n+            System.err.println(\"Test failed: \" + e.getMessage());\n+            throw e;\n+        }\n+    }\n+\n+    \/**\n+     * Use OneKDC to create a TGT via the JAAS LoginModule\n+     *\/\n+    private static void createTGTWithOneKDC() throws Exception {\n+        System.out.println(\"Creating TGT via OneKDC\");\n+\n+        OneKDC kdc = new OneKDC(null);\n+        kdc.writeJAASConf();\n+\n+        \/\/ Force JAAS to save credentials to file cache for copying\n+        System.setProperty(\"test.kdc.save.ccache\", \"onekdc_cache.ccache\");\n+\n+        try {\n+            \/\/ Authenticate using the JAAS LoginModule\n+            LoginContext lc = new LoginContext(\"com.sun.security.jgss.krb5.initiate\",\n+                                               new OneKDC.CallbackForClient());\n+            lc.login();\n+\n+            \/\/ Verify authentication\n+            Subject subject = lc.getSubject();\n+            KerberosTicket ticket = subject.getPrivateCredentials(KerberosTicket.class).iterator().next();\n+\n+            System.out.println(\"JAAS authentication successful\");\n+            System.out.println(\"TGT: \" + ticket.getClient() + \" -> \" + ticket.getServer());\n+\n+        } catch (Exception e) {\n+            System.out.println(\"JAAS authentication failed: \" + e.getMessage());\n+        }\n+    }\n+\n+    \/**\n+     * Copy the TGT to an in-memory cache using JNI\n+     *\/\n+    private static String copyTGTToInMemoryCache() throws Exception {\n+        System.out.println(\"Creating in-memory cache and copying TGT from file cache\");\n+\n+        \/\/ Check that the FILE: ccache exists\n+        File fileCache = new File(\"onekdc_cache.ccache\");\n+        if (!fileCache.exists()) {\n+            throw new RuntimeException(\"File cache does not exist: \" + fileCache.getAbsolutePath());\n+        }\n+\n+        \/\/ Create MEMORY: ccache from the FILE: ccache\n+        String memoryCacheName = \"MEMORY:test_\" + System.currentTimeMillis();\n+        if (!NativeCredentialCacheHelper.createInMemoryCacheFromFileCache(\n+                memoryCacheName, \"FILE:\" + fileCache.getAbsolutePath())) {\n+            throw new RuntimeException(\"Failed to create in-memory cache from file cache\");\n+        }\n+\n+        System.setProperty(\"KRB5CCNAME\", memoryCacheName);\n+\n+        System.out.println(\"Successfully created in-memory cache with credentials: \" + memoryCacheName);\n+\n+        return memoryCacheName;\n+    }\n+\n+    \/**\n+     * Test JAAS access to an in-memory cache\n+     *\/\n+    private static void testJAASAccessToInMemoryCache(String inMemoryCacheName) throws Exception {\n+        System.out.println(\"Testing JAAS access to an in-memory cache\");\n+\n+        \/\/ Verify KRB5CCNAME points to our in-memory cache\n+        String krb5ccname = System.getProperty(\"KRB5CCNAME\");\n+        System.out.println(\"KRB5CCNAME is set to: \" + krb5ccname);\n+        System.out.println(\"Expected in-memory cache: \" + inMemoryCacheName);\n+\n+        if (!inMemoryCacheName.equals(krb5ccname)) {\n+            System.out.println(\"ERROR: KRB5CCNAME does not point to our in-memory cache\");\n+            throw new RuntimeException(\"test setup error - KRB5CCNAME not pointing to in-memory cache\");\n+        }\n+\n+        Credentials creds = Credentials.acquireDefaultCreds();\n+\n+        if (creds != null) {\n+            String client = creds.getClient().toString();\n+            String server = creds.getServer().toString();\n+\n+            \/\/ Verify these are the OneKDC test credentials\n+            if (client.contains(\"dummy\") && server.contains(\"RABBIT.HOLE\") && server.contains(\"krbtgt\")) {\n+                System.out.println(\"SUCCESS: Retrieved correct OneKDC test credentials from in-memory cache\");\n+                System.out.println(\"Client: \" + client);\n+                System.out.println(\"Server: \" + server);\n+            } else {\n+                System.out.println(\"ERROR: JAAS retrieved wrong credentials from in-memory cache\");\n+                System.out.println(\"Expected: dummy@RABBIT.HOLE -> krbtgt\/RABBIT.HOLE@RABBIT.HOLE\");\n+                System.out.println(\"Found: \" + client + \" -> \" + server);\n+                throw new RuntimeException(\"in-memory cache test failed - wrong credentials retrieved\");\n+            }\n+        } else {\n+            System.out.println(\"ERROR: JAAS accessed in-memory cache but found no credentials\");\n+            throw new RuntimeException(\"in-memory cache test failed - no credentials retrieved\");\n+        }\n+    }\n+}\n","filename":"test\/jdk\/sun\/security\/krb5\/native\/NativeCacheTest.java","additions":170,"deletions":0,"binary":false,"changes":170,"status":"added"},{"patch":"@@ -0,0 +1,46 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+ \/* DO NOT EDIT THIS FILE - it is machine generated *\/\n+#include <jni.h>\n+\/* Header for class NativeCredentialCacheHelper *\/\n+\n+#ifndef _Included_NativeCredentialCacheHelper\n+#define _Included_NativeCredentialCacheHelper\n+#ifdef __cplusplus\n+extern \"C\" {\n+#endif\n+\/*\n+ * Class:     NativeCredentialCacheHelper\n+ * Method:    createInMemoryCacheFromFileCache\n+ * Signature: (Ljava\/lang\/String;Ljava\/lang\/String;)Z\n+ *\/\n+JNIEXPORT jboolean JNICALL Java_NativeCredentialCacheHelper_createInMemoryCacheFromFileCache\n+  (JNIEnv *, jclass, jstring, jstring);\n+\n+#ifdef __cplusplus\n+}\n+#endif\n+#endif\n","filename":"test\/jdk\/sun\/security\/krb5\/native\/NativeCredentialCacheHelper.h","additions":46,"deletions":0,"binary":false,"changes":46,"status":"added"},{"patch":"@@ -0,0 +1,49 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * JNI wrapper for native Kerberos credential cache operations.\n+ * Provides native methods to create in-memory credential caches and copy\n+ * Kerberos credentials from file credential caches for testing JAAS access.\n+ *\/\n+public class NativeCredentialCacheHelper {\n+\n+    static {\n+        try {\n+            System.loadLibrary(\"NativeCredentialCacheHelper\");\n+        } catch (UnsatisfiedLinkError e) {\n+            System.err.println(\"Failed to load NativeCredentialCacheHelper library: \" + e.getMessage());\n+            throw e;\n+        }\n+    }\n+\n+    \/**\n+     * Creates an in-memory credential ccache, copies credentials from a file ccache,\n+     * and sets KRB5CCNAME to the in-memory ccache.\n+     *\n+     * @param inMemoryCacheName The name for the MEMORY: ccache (e.g., \"MEMORY:test123\")\n+     * @param fileCacheName The FILE: ccache name to copy from (e.g., \"FILE:\/path\/to\/cache\")\n+     * @return true if all operations succeeded, false if any operation failed\n+     *\/\n+    public static native boolean createInMemoryCacheFromFileCache(String inMemoryCacheName, String fileCacheName);\n+}\n","filename":"test\/jdk\/sun\/security\/krb5\/native\/NativeCredentialCacheHelper.java","additions":49,"deletions":0,"binary":false,"changes":49,"status":"added"},{"patch":"@@ -0,0 +1,3 @@\n+127.0.0.1 localhost\n+127.0.0.1 host.rabbit.hole\n+127.0.0.1 kdc.rabbit.hole\n","filename":"test\/jdk\/sun\/security\/krb5\/native\/TestHosts","additions":3,"deletions":0,"binary":false,"changes":3,"status":"added"},{"patch":"@@ -0,0 +1,223 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#include <jni.h>\n+#include <krb5\/krb5.h>\n+#include <string.h>\n+#include <stdio.h>\n+#include <stdlib.h>\n+#include <unistd.h>\n+#include <limits.h>\n+\n+#include \"NativeCredentialCacheHelper.h\"\n+\n+\/\/ Global krb5 context\n+static krb5_context g_context = NULL;\n+\n+\/**\n+ * Initialize krb5 context with OneKDC config\n+ *\/\n+static krb5_error_code ensure_context() {\n+    \/\/ Check if OneKDC config file exists or needs to be created\n+    if (access(\"localkdc-krb5.conf\", F_OK) != -1) {\n+        char *current_path = realpath(\"localkdc-krb5.conf\", NULL);\n+        if (current_path != NULL) {\n+            setenv(\"KRB5_CONFIG\", current_path, 1);\n+            free(current_path);\n+\n+            \/\/ If context already exists, reinitialize it\n+            if (g_context != NULL) {\n+                krb5_free_context(g_context);\n+                g_context = NULL;\n+            }\n+        }\n+    }\n+\n+    if (g_context == NULL) {\n+        return krb5_init_context(&g_context);\n+    }\n+    return 0;\n+}\n+\n+\/**\n+ * Convert Java string to C string\n+ *\/\n+static char* jstring_to_cstring(JNIEnv *env, jstring jstr) {\n+    if (jstr == NULL) return NULL;\n+\n+    const char *utf_chars = (*env)->GetStringUTFChars(env, jstr, NULL);\n+    if (utf_chars == NULL) return NULL;\n+\n+    char *result = strdup(utf_chars);\n+    if (result == NULL) return NULL;\n+\n+    (*env)->ReleaseStringUTFChars(env, jstr, utf_chars);\n+    return result;\n+}\n+\n+\/**\n+ * Print error messages for krb5 errors\n+ *\/\n+static void print_krb5_error(const char *operation, krb5_error_code code) {\n+    if (code != 0) {\n+        printf(\"krb5 error in %s: %s\\n\", operation, error_message(code));\n+    }\n+}\n+\n+\/**\n+ * Creates an in-memory credential ccache, copies credentials from a file ccache,\n+ * and sets KRB5CCNAME to the in-memory ccache.\n+ *\/\n+JNIEXPORT jboolean JNICALL Java_NativeCredentialCacheHelper_createInMemoryCacheFromFileCache\n+  (JNIEnv *env, jclass cls, jstring inMemoryCacheName, jstring fileCacheName)\n+{\n+    krb5_error_code ret;\n+    krb5_ccache file_ccache = NULL;\n+    krb5_ccache in_memory_ccache = NULL;\n+    krb5_cc_cursor cursor;\n+    krb5_creds creds;\n+    char *in_memory_cache_name = NULL;\n+    char *file_cache_name = NULL;\n+    int copied_count = 0;\n+\n+    ret = ensure_context();\n+    if (ret) {\n+        print_krb5_error(\"ensure_context\", ret);\n+        return JNI_FALSE;\n+    }\n+\n+    in_memory_cache_name = jstring_to_cstring(env, inMemoryCacheName);\n+    file_cache_name = jstring_to_cstring(env, fileCacheName);\n+    if (!in_memory_cache_name || !file_cache_name) {\n+        printf(\"Failed to get file or in-memory cache names\\n\");\n+        goto cleanup;\n+    }\n+\n+    printf(\"Creating in-memory cache: %s from file cache: %s\\n\",\n+        in_memory_cache_name, file_cache_name);\n+\n+    \/\/ Resolve FILE: ccache\n+    ret = krb5_cc_resolve(g_context, file_cache_name, &file_ccache);\n+    if (ret) {\n+        print_krb5_error(\"krb5_cc_resolve (file cache)\", ret);\n+        printf(\"ERROR: File cache does not exist or cannot be accessed: %s\\n\", file_cache_name);\n+        goto cleanup;\n+    }\n+\n+    \/\/ Resolve in-memory cache\n+    ret = krb5_cc_resolve(g_context, in_memory_cache_name, &in_memory_ccache);\n+    if (ret) {\n+        print_krb5_error(\"krb5_cc_resolve (in-memory)\", ret);\n+        goto cleanup;\n+    }\n+\n+    printf(\"Created in-memory cache: %s\\n\", in_memory_cache_name);\n+\n+    \/\/ Get principal from file cache for initialization\n+    krb5_principal principal = NULL;\n+    ret = krb5_cc_get_principal(g_context, file_ccache, &principal);\n+    if (ret) {\n+        print_krb5_error(\"krb5_cc_get_principal\", ret);\n+        printf(\"ERROR: Cannot get principal from file cache: %s\\n\", file_cache_name);\n+        goto cleanup;\n+    }\n+\n+    \/\/ Initialize in-memory cache with the principal\n+    ret = krb5_cc_initialize(g_context, in_memory_ccache, principal);\n+    if (ret) {\n+        print_krb5_error(\"krb5_cc_initialize\", ret);\n+        krb5_free_principal(g_context, principal);\n+        goto cleanup;\n+    }\n+\n+    \/\/ Copy credentials from file cache to in-memory cache\n+    ret = krb5_cc_start_seq_get(g_context, file_ccache, &cursor);\n+    if (ret) {\n+        print_krb5_error(\"krb5_cc_start_seq_get\", ret);\n+        krb5_free_principal(g_context, principal);\n+        goto cleanup;\n+    }\n+\n+    while ((ret = krb5_cc_next_cred(g_context, file_ccache, &cursor, &creds)) == 0) {\n+        ret = krb5_cc_store_cred(g_context, in_memory_ccache, &creds);\n+        if (ret) {\n+            print_krb5_error(\"krb5_cc_store_cred\", ret);\n+            krb5_free_cred_contents(g_context, &creds);\n+            break;\n+        }\n+\n+        \/\/ Print the actual credential names\n+        char *client_name = NULL;\n+        char *server_name = NULL;\n+        if (creds.client) {\n+            krb5_unparse_name(g_context, creds.client, &client_name);\n+        }\n+        if (creds.server) {\n+            krb5_unparse_name(g_context, creds.server, &server_name);\n+        }\n+\n+        printf(\"Copied credential: %s -> %s\\n\",\n+               client_name ? client_name : \"unknown\",\n+               server_name ? server_name : \"unknown\");\n+\n+        if (client_name) krb5_free_unparsed_name(g_context, client_name);\n+        if (server_name) krb5_free_unparsed_name(g_context, server_name);\n+\n+        copied_count++;\n+        krb5_free_cred_contents(g_context, &creds);\n+    }\n+\n+    \/\/ End the cursor (expected to return KRB5_CC_END)\n+    krb5_cc_end_seq_get(g_context, file_ccache, &cursor);\n+\n+    if (copied_count == 0) {\n+        printf(\"ERROR: No credentials found in file cache to copy: %s\\n\", file_cache_name);\n+        ret = KRB5_CC_NOTFOUND;\n+        krb5_free_principal(g_context, principal);\n+        goto cleanup;\n+    }\n+\n+    printf(\"Successfully copied %d credentials to in-memory cache: %s\\n\",\n+           copied_count, in_memory_cache_name);\n+\n+    \/\/ Set KRB5CCNAME environment variable to point to in-memory cache\n+    if (setenv(\"KRB5CCNAME\", in_memory_cache_name, 1) != 0) {\n+        printf(\"ERROR: Failed to set KRB5CCNAME environment variable\\n\");\n+        ret = -1;\n+        krb5_free_principal(g_context, principal);\n+        goto cleanup;\n+    }\n+\n+    printf(\"Set KRB5CCNAME to: %s\\n\", in_memory_cache_name);\n+    ret = 0;\n+    krb5_free_principal(g_context, principal);\n+\n+cleanup:\n+    if (file_ccache) krb5_cc_close(g_context, file_ccache);\n+    if (file_cache_name) free(file_cache_name);\n+\n+    if (in_memory_ccache) krb5_cc_close(g_context, in_memory_ccache);\n+    if (in_memory_cache_name) free(in_memory_cache_name);\n+\n+    return (ret == 0) ? JNI_TRUE : JNI_FALSE;\n+}\n","filename":"test\/jdk\/sun\/security\/krb5\/native\/libNativeCredentialCacheHelper.c","additions":223,"deletions":0,"binary":false,"changes":223,"status":"added"}]}