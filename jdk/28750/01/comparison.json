{"files":[{"patch":"@@ -111,1 +111,2 @@\n-    error = getaddrinfo(hostname, NULL, &hints, &res);\n+    NET_RESTARTABLE(error, getaddrinfo(hostname, NULL, &hints, &res),\n+                    error != EAI_SYSTEM)\n@@ -232,4 +233,7 @@\n-    if (getnameinfo((struct sockaddr *)&sa, sizeof(struct sockaddr_in),\n-                    host, sizeof(host), NULL, 0, NI_NAMEREQD)) {\n-        JNU_ThrowByName(env, \"java\/net\/UnknownHostException\", NULL);\n-    } else {\n+    int r;\n+\n+    NET_RESTARTABLE(r, getnameinfo((struct sockaddr *)&sa, sizeof(struct sockaddr_in),\n+                                   host, sizeof(host), NULL, 0, NI_NAMEREQD),\n+                    r != EAI_SYSTEM)\n+\n+    if (r == 0) {\n@@ -237,2 +241,2 @@\n-        if (ret == NULL) {\n-            JNU_ThrowByName(env, \"java\/net\/UnknownHostException\", NULL);\n+        if (ret != NULL) {\n+            return ret;\n@@ -242,1 +246,2 @@\n-    return ret;\n+    JNU_ThrowByName(env, \"java\/net\/UnknownHostException\", NULL);\n+    return NULL;\n@@ -286,1 +291,2 @@\n-    connect_rv = connect(fd, &sa->sa, sizeof(struct sockaddr_in));\n+    NET_RESTARTABLE(connect_rv, connect(fd, &sa->sa, sizeof(struct sockaddr_in)),\n+                    connect_rv != -1);\n@@ -400,0 +406,1 @@\n+\n@@ -401,1 +408,3 @@\n-        n = sendto(fd, sendbuf, plen, 0, &sa->sa, sizeof(struct sockaddr_in));\n+        NET_RESTARTABLE(n, sendto(fd, sendbuf, plen, 0, &sa->sa, sizeof(struct sockaddr_in)),\n+                        n != -1)\n+\n@@ -425,2 +434,2 @@\n-                n = recvfrom(fd, recvbuf, sizeof(recvbuf), 0,\n-                             (struct sockaddr *)&sa_recv, &len);\n+                NET_RESTARTABLE(n, recvfrom(fd, recvbuf, sizeof(recvbuf), 0,\n+                                      (struct sockaddr *)&sa_recv, &len), n != -1);\n","filename":"src\/java.base\/unix\/native\/libnet\/Inet4AddressImpl.c","additions":21,"deletions":12,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -230,1 +230,1 @@\n-    error = getaddrinfo(hostname, NULL, &hints, &res);\n+    NET_RESTARTABLE(error, getaddrinfo(hostname, NULL, &hints, &res), error != EAI_SYSTEM)\n@@ -433,3 +433,6 @@\n-    if (getnameinfo(&sa.sa, len, host, sizeof(host), NULL, 0, NI_NAMEREQD)) {\n-        JNU_ThrowByName(env, \"java\/net\/UnknownHostException\", NULL);\n-    } else {\n+    int r;\n+\n+    NET_RESTARTABLE(r, getnameinfo(&sa.sa, len, host, sizeof(host), NULL, 0, NI_NAMEREQD),\n+                    r != EAI_SYSTEM)\n+\n+    if (r == 0) {\n@@ -437,2 +440,2 @@\n-        if (ret == NULL) {\n-            JNU_ThrowByName(env, \"java\/net\/UnknownHostException\", NULL);\n+        if (ret != NULL) {\n+            return ret;\n@@ -442,1 +445,2 @@\n-    return ret;\n+    JNU_ThrowByName(env, \"java\/net\/UnknownHostException\", NULL);\n+    return NULL;\n@@ -486,1 +490,2 @@\n-    connect_rv = connect(fd, &sa->sa, sizeof(struct sockaddr_in6));\n+    NET_RESTARTABLE(connect_rv, connect(fd, &sa->sa, sizeof(struct sockaddr_in6)),\n+                    connect_rv != -1);\n@@ -607,1 +612,4 @@\n-        n = sendto(fd, sendbuf, plen, 0, &sa->sa, sizeof(struct sockaddr_in6));\n+\n+        NET_RESTARTABLE(n, sendto(fd, sendbuf, plen, 0, &sa->sa, sizeof(struct sockaddr_in6)),\n+                        n != -1)\n+\n@@ -631,2 +639,2 @@\n-                n = recvfrom(fd, recvbuf, sizeof(recvbuf), 0,\n-                             (struct sockaddr *)&sa_recv, &len);\n+                NET_RESTARTABLE(n, recvfrom(fd, recvbuf, sizeof(recvbuf), 0,\n+                                   (struct sockaddr *)&sa_recv, &len), n == -1);\n","filename":"src\/java.base\/unix\/native\/libnet\/Inet6AddressImpl.c","additions":19,"deletions":11,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -79,3 +79,0 @@\n-    case EINTR:\n-        JNU_ThrowByName(env, JNU_JAVAIOPKG \"InterruptedIOException\", msg);\n-        break;\n@@ -630,1 +627,1 @@\n-          pfd.events |= POLLIN;\n+            pfd.events |= POLLIN;\n@@ -632,1 +629,1 @@\n-          pfd.events |= POLLOUT;\n+            pfd.events |= POLLOUT;\n@@ -634,1 +631,1 @@\n-          pfd.events |= POLLOUT;\n+            pfd.events |= POLLOUT;\n@@ -642,1 +639,1 @@\n-          return read_rv > 0 ? 0 : -1;\n+            return read_rv > 0 ? 0 : -1;\n@@ -647,1 +644,1 @@\n-          break;\n+            break;\n@@ -649,1 +646,1 @@\n-      } \/* while *\/\n+    } \/* while *\/\n","filename":"src\/java.base\/unix\/native\/libnet\/net_util_md.c","additions":6,"deletions":9,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -83,0 +83,16 @@\n+\/**\n+ * Invokes call in a loop, setting RET to return value.\n+ * Invokes PREDICATE for condition to break from loop\n+ * If PREDICATE fails, and errno is not EINTR, loop breaks also\n+ * Continue loop otherwise.\n+ *\n+ * NB. It is assumed that if PREDICATE fails then errno is set\n+ *\/\n+#define NET_RESTARTABLE(RET,CALL,PREDICATE)     \\\n+    while (1) {                                 \\\n+        RET = CALL;                     \\\n+        if (PREDICATE || errno != EINTR) {      \\\n+            break;                              \\\n+        }                                       \\\n+    }\n+\n","filename":"src\/java.base\/unix\/native\/libnet\/net_util_md.h","additions":16,"deletions":0,"binary":false,"changes":16,"status":"modified"}]}