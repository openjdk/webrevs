{"files":[{"patch":"@@ -31,1 +31,1 @@\n-import java.util.List;\n+import java.util.*;\n@@ -42,0 +42,15 @@\n+\/**\n+ * @test id=path-to-gc-roots-true-cutoff-inf\n+ * @requires vm.hasJFR & vm.flagless\n+ * @modules jdk.jfr\/jdk.jfr.internal.test\n+ * @library \/test\/lib \/test\/jdk\n+ * @run main\/othervm -XX:TLABSize=2k -Xmx256M -XX:ErrorLogTimeout=1 jdk.jfr.jcmd.TestJcmdDumpPathToGCRoots true infinity true\n+ *\/\n+\/**\n+ * @test id=path-to-gc-roots-true-cutoff-0\n+ * @requires vm.hasJFR & vm.flagless\n+ * @modules jdk.jfr\/jdk.jfr.internal.test\n+ * @library \/test\/lib \/test\/jdk\n+ * @run main\/othervm -XX:TLABSize=2k -Xmx256M -XX:ErrorLogTimeout=1 jdk.jfr.jcmd.TestJcmdDumpPathToGCRoots true 0 true\n+ *\/\n+\n@@ -44,2 +59,2 @@\n- * @summary Start a recording with or without path-to-gc-roots\n- * @requires vm.hasJFR\n+ * @test id=path-to-gc-roots-true-cutoff-default\n+ * @requires vm.hasJFR & vm.flagless\n@@ -48,3 +63,49 @@\n- * @requires vm.flagless\n- *\n- * @run main\/othervm -XX:TLABSize=2k jdk.jfr.jcmd.TestJcmdDumpPathToGCRoots\n+ * @run main\/othervm -XX:TLABSize=2k -Xmx256M -XX:ErrorLogTimeout=1 jdk.jfr.jcmd.TestJcmdDumpPathToGCRoots true - true\n+ *\/\n+\n+\/**\n+ * @test id=path-to-gc-roots-false-cutoff-inf\n+ * @requires vm.hasJFR & vm.flagless\n+ * @modules jdk.jfr\/jdk.jfr.internal.test\n+ * @library \/test\/lib \/test\/jdk\n+ * @run main\/othervm -XX:TLABSize=2k -Xmx256M -XX:ErrorLogTimeout=1 jdk.jfr.jcmd.TestJcmdDumpPathToGCRoots false infinity false\n+ *\/\n+\n+\/**\n+ * @test id=path-to-gc-roots-false-cutoff-0\n+ * @requires vm.hasJFR & vm.flagless\n+ * @modules jdk.jfr\/jdk.jfr.internal.test\n+ * @library \/test\/lib \/test\/jdk\n+ * @run main\/othervm -XX:TLABSize=2k -Xmx256M -XX:ErrorLogTimeout=1 jdk.jfr.jcmd.TestJcmdDumpPathToGCRoots false 0 false\n+ *\/\n+\n+\/**\n+ * @test id=path-to-gc-roots-false-cutoff-default\n+ * @requires vm.hasJFR & vm.flagless\n+ * @modules jdk.jfr\/jdk.jfr.internal.test\n+ * @library \/test\/lib \/test\/jdk\n+ * @run main\/othervm -XX:TLABSize=2k -Xmx256M -XX:ErrorLogTimeout=1 jdk.jfr.jcmd.TestJcmdDumpPathToGCRoots false - false\n+ *\/\n+\n+\/**\n+ * @test id=path-to-gc-roots-default-cutoff-inf\n+ * @requires vm.hasJFR & vm.flagless\n+ * @modules jdk.jfr\/jdk.jfr.internal.test\n+ * @library \/test\/lib \/test\/jdk\n+ * @run main\/othervm -XX:TLABSize=2k -Xmx512M -XX:ErrorLogTimeout=1 jdk.jfr.jcmd.TestJcmdDumpPathToGCRoots - infinity true\n+ *\/\n+\n+\/**\n+ * @test id=path-to-gc-roots-default-cutoff-0\n+ * @requires vm.hasJFR & vm.flagless\n+ * @modules jdk.jfr\/jdk.jfr.internal.test\n+ * @library \/test\/lib \/test\/jdk\n+ * @run main\/othervm -XX:TLABSize=2k -Xmx512M -XX:ErrorLogTimeout=1 jdk.jfr.jcmd.TestJcmdDumpPathToGCRoots - 0 false\n+ *\/\n+\n+\/**\n+ * @test id=path-to-gc-roots-default-cutoff-default\n+ * @requires vm.hasJFR & vm.flagless\n+ * @modules jdk.jfr\/jdk.jfr.internal.test\n+ * @library \/test\/lib \/test\/jdk\n+ * @run main\/othervm -XX:TLABSize=2k -Xmx512M -XX:ErrorLogTimeout=1 jdk.jfr.jcmd.TestJcmdDumpPathToGCRoots - - false\n@@ -54,2 +115,4 @@\n-    private static final int OBJECT_COUNT = 100_000;\n-    public static List<Object[]> leak = new ArrayList<>(OBJECT_COUNT);\n+    \/\/ Comfortably large enough to saturate the 32M EdgeQueue in PathToGcRootsOperation\n+    \/\/ and thus exercise both BFS and DFS paths\n+    private static final int OBJECT_COUNT = 2_500_000;\n+    public static List<Object> leak = new ArrayList<>();\n@@ -60,0 +123,4 @@\n+        if (args.length != 3) {\n+            throw new RuntimeException(\"Expected 2 arguments\");\n+        }\n+\n@@ -62,4 +129,12 @@\n-        \/\/ dump parameter trumps previous setting\n-        testDump(\"path-to-gc-roots=true\", Collections.singletonMap(settingName, \"infinity\"), true);\n-        testDump(\"path-to-gc-roots=true\", Collections.singletonMap(settingName, \"0 ns\"), true);\n-        testDump(\"path-to-gc-roots=true\", Collections.emptyMap(), true);\n+        final String ptgcr =\n+            switch (args[0]) {\n+                case \"-\" -> \"\";\n+                default -> \"path-to-gc-roots=\" + args[0];\n+            };\n+\n+        final Map settings = switch (args[1]) {\n+            case \"infinity\" -> Collections.singletonMap(settingName, \"infinity\");\n+            case \"0\" -> Collections.singletonMap(settingName, \"0 ns\");\n+            case \"-\" -> Collections.emptyMap();\n+            default -> throw new RuntimeException(\"Invalid \" + args[1]);\n+        };\n@@ -67,3 +142,4 @@\n-        testDump(\"path-to-gc-roots=false\", Collections.singletonMap(settingName, \"infinity\"), false);\n-        testDump(\"path-to-gc-roots=false\", Collections.singletonMap(settingName, \"0 ns\"), false);\n-        testDump(\"path-to-gc-roots=false\", Collections.emptyMap(), false);\n+        final boolean expectChains = Boolean.valueOf(args[2]);\n+\n+        \/\/ dump parameter trumps previous setting\n+        testDump(ptgcr, settings, expectChains);\n@@ -71,3 +147,0 @@\n-        testDump(\"\", Collections.singletonMap(settingName, \"infinity\"), true);\n-        testDump(\"\", Collections.singletonMap(settingName, \"0 ns\"), false);\n-        testDump(\"\", Collections.emptyMap(), false);\n@@ -134,2 +207,7 @@\n-        for (int i = 0; i < OBJECT_COUNT;i ++) {\n-            leak.add(new Object[0]);\n+        int chainlen = 10000;\n+        for (int i = 0; i < OBJECT_COUNT\/chainlen; i ++) {\n+            LinkedList<Object> l = new LinkedList();\n+            for (int j = 0; j < chainlen; j ++) {\n+                l.add(new Object());\n+            }\n+            leak.add(l);\n","filename":"test\/jdk\/jdk\/jfr\/jcmd\/TestJcmdDumpPathToGCRoots.java","additions":98,"deletions":20,"binary":false,"changes":118,"status":"modified"}]}