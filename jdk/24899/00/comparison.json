{"files":[{"patch":"@@ -434,8 +434,0 @@\n-\n-            new ScriptRunner()\n-            .setDirectory(imageDir)\n-            .setResourceCategoryId(\"resource.post-app-image-script\")\n-            .setScriptNameSuffix(\"post-image\")\n-            .setEnvironmentVariable(\"JpAppImageDir\", imageDir.toAbsolutePath().toString())\n-            .run(params);\n-\n@@ -603,0 +595,9 @@\n+        final var imageDir = MSI_IMAGE_DIR.fetchFrom(params);\n+\n+        new ScriptRunner()\n+        .setDirectory(imageDir)\n+        .setResourceCategoryId(\"resource.post-app-image-script\")\n+        .setScriptNameSuffix(\"post-image\")\n+        .setEnvironmentVariable(\"JpAppImageDir\", imageDir.toAbsolutePath().toString())\n+        .run(params);\n+\n","filename":"src\/jdk.jpackage\/windows\/classes\/jdk\/jpackage\/internal\/WinMsiBundler.java","additions":9,"deletions":8,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+import java.util.ArrayList;\n@@ -27,0 +28,1 @@\n+import java.util.stream.Stream;\n@@ -28,5 +30,1 @@\n-import jdk.jpackage.test.TKit;\n-import jdk.jpackage.test.PackageTest;\n-import jdk.jpackage.test.PackageType;\n-import jdk.jpackage.test.Annotations.Test;\n-import jdk.jpackage.test.Annotations.Parameter;\n+import jdk.jpackage.test.Annotations.ParameterSupplier;\n@@ -34,0 +32,1 @@\n+import jdk.jpackage.test.Annotations.Test;\n@@ -35,0 +34,4 @@\n+import jdk.jpackage.test.PackageTest;\n+import jdk.jpackage.test.PackageType;\n+import jdk.jpackage.test.RunnablePackageTest.Action;\n+import jdk.jpackage.test.TKit;\n@@ -49,9 +52,34 @@\n-    public WinScriptTest(PackageType type) {\n-        this.packageType = type;\n-\n-        test = new PackageTest()\n-        .forTypes(type)\n-        .configureHelloApp()\n-        .addInitializer(cmd -> {\n-            cmd.setFakeRuntime().saveConsoleOutput(true);\n-        });\n+    @Test\n+    public static void test8355651() {\n+        new PackageTest()\n+                .configureHelloApp()\n+                .addInitializer(JPackageCommand::setFakeRuntime)\n+                .addInitializer(cmd -> {\n+                    final var expectedConfigFiles = Stream.concat(\n+                            Stream.of(\"bundle.wxf\", \"ui.wxf\", \"overrides.wxi\", \"main.wxs\"),\n+                            Stream.of(\"de\", \"en\", \"ja\", \"zh_CN\").map(loc -> {\n+                                return \"MsiInstallerStrings_\" + loc + \".wxl\";\n+                            })\n+                    );\n+\n+                    final var expectedCurrentDirFiles = Stream.of(\n+                            new JPackageCommand(cmd).setPackageType(PackageType.IMAGE).setArgumentValue(\"--dest\", \"\").appLauncherPath());\n+\n+                    final var resourceDir = TKit.createTempDirectory(\"resources\");\n+                    cmd.addArguments(\"--resource-dir\", resourceDir);\n+\n+                    createScript(cmd, \"post-image\", Stream.of(\n+                            Stream.of(\n+                                    \"var fs = new ActiveXObject('Scripting.FileSystemObject')\",\n+                                    \"var configDir = fs.GetParentFolderName(WScript.ScriptFullName)\"\n+                            ),\n+                            expectedConfigFiles.map(str -> {\n+                                return String.format(\"WScript.Echo('Probe: ' + configDir + '\\\\\\\\%s'); fs.GetFile(configDir + '\\\\\\\\%s')\", str, str);\n+                            }),\n+                            expectedCurrentDirFiles.map(Path::toString).map(str -> {\n+                                return str.replace('\\\\', '\/');\n+                            }).map(str -> {\n+                                return String.format(\"WScript.Echo('Probe: %s'); fs.GetFile('%s')\", str, str);\n+                            })\n+                    ).flatMap(x -> x).toList());\n+                }).run(Action.CREATE);\n@@ -61,5 +89,8 @@\n-    public static List<Object[]> data() {\n-        return List.of(new Object[][]{\n-            {PackageType.WIN_MSI},\n-            {PackageType.WIN_EXE}\n-        });\n+    public static List<Object[]> test() {\n+        final List<Object[]> data = new ArrayList<>();\n+        for (final var type : PackageType.WINDOWS) {\n+            for (final var exitCode : List.of(0, 10)) {\n+                data.add(new Object[] {type, exitCode});\n+            }\n+        }\n+        return data;\n@@ -69,3 +100,10 @@\n-    @Parameter(\"0\")\n-    @Parameter(\"10\")\n-    public void test(int wsfExitCode) throws IOException {\n+    @ParameterSupplier\n+    public static void test(PackageType packageType, int wsfExitCode) throws IOException {\n+\n+        final var test = new PackageTest()\n+                .forTypes(packageType)\n+                .configureHelloApp()\n+                .addInitializer(cmd -> {\n+                    cmd.setFakeRuntime().saveConsoleOutput(true);\n+                });\n+\n@@ -110,1 +148,1 @@\n-        test.run();\n+        test.run(Action.CREATE);\n@@ -152,7 +190,1 @@\n-           XmlUtils.createXml(Path.of(cmd.getArgumentValue(\"--resource-dir\"),\n-                    String.format(\"%s-%s.wsf\", cmd.name(), scriptSuffixName)), xml -> {\n-                xml.writeStartElement(\"job\");\n-                xml.writeAttribute(\"id\", \"main\");\n-                xml.writeStartElement(\"script\");\n-                xml.writeAttribute(\"language\", \"JScript\");\n-                xml.writeCData(String.join(\"\\n\", List.of(\n+            WinScriptTest.createScript(cmd, scriptSuffixName, List.of(\n@@ -164,4 +196,1 @@\n-                )));\n-                xml.writeEndElement();\n-                xml.writeEndElement();\n-            });\n+            ));\n@@ -176,2 +205,12 @@\n-    private final PackageType packageType;\n-    private PackageTest test;\n+    private static void createScript(JPackageCommand cmd, String scriptSuffixName, List<String> js) throws IOException {\n+        XmlUtils.createXml(Path.of(cmd.getArgumentValue(\"--resource-dir\"),\n+                String.format(\"%s-%s.wsf\", cmd.name(), scriptSuffixName)), xml -> {\n+            xml.writeStartElement(\"job\");\n+            xml.writeAttribute(\"id\", \"main\");\n+            xml.writeStartElement(\"script\");\n+            xml.writeAttribute(\"language\", \"JScript\");\n+            xml.writeCData(String.join(\"\\n\", js));\n+            xml.writeEndElement();\n+            xml.writeEndElement();\n+        });\n+    }\n","filename":"test\/jdk\/tools\/jpackage\/windows\/WinScriptTest.java","additions":75,"deletions":36,"binary":false,"changes":111,"status":"modified"}]}