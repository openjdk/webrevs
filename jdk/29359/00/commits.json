[{"commit":{"message":"8374349: [VectorAPI]: AArch64: Prefer merging mode SVE CPY instruction\n\nWhen optimizing some VectorMask related APIs , we found an optimization\nopportunity related to the `cpy (immediate, zeroing)` instruction [1].\nImplementing the functionality of this instruction using `cpy (immediate,\nmerging)` instruction [2] leads to better performance.\n\nCurrently the `cpy (imm, zeroing)` instruction is used in code generated\nby `VectorStoreMaskNode` and `VectorReinterpretNode`. Doing this\noptimization benefits all vector APIs that generate these two IRs\npotentially, such as `VectorMask.intoArray()` and `VectorMask.toLong()`.\n\nMicrobenchmarks show this change brings performance uplift ranging from\n**11%** to **33%**, depending on the specific operation and data types.\n\nThe specific changes in this PR:\n1. Achieve the functionality of the `cpy (imm, zeroing)` instruction\nwith the `movi + cpy (imm, merging)` instructions in assembler:\n```\ncpy  z17.d, p1\/z, #1 =>\n\nmovi v17.2d, #0       \/\/ this instruction is zero cost\ncpy  z17.d, p1\/m, #1\n```\n\n2. Add a new option `PreferSVEMergingModeCPY` to indicate whether to\napply this optimization or not.\n- This option belongs to the Arch product category.\n- The default value is true on Neoverse-V1\/V2 where the improvement\n  has been confirmed, false on others.\n- When its value is true, the change is applied.\n\n3. Add a jtreg test to verify the behavior of this option.\n\nThis PR was tested on aarch64 and x86 machines with different\nconfigurations, and all tests passed.\n\nJMH benchmarks:\n\nOn a Nvidia Grace (Neoverse-V2) machine with 128-bit SVE2:\n```\nBenchmark\t        \tUnit\tsize\tBefore\t\tError\tAfter\t\tError\tUplift\nbyteIndexInRange\t\tops\/ms\t7.00\t471816.15\t1125.96\t473237.77\t1593.92\t1.00\nbyteIndexInRange\t\tops\/ms\t256.00\t149654.21\t416.57\t149259.95\t116.59\t1.00\nbyteIndexInRange\t\tops\/ms\t259.00\t177850.31\t991.13\t179785.19\t1110.07\t1.01\nbyteIndexInRange\t\tops\/ms\t512.00\t133393.26\t167.26\t133484.61\t281.83\t1.00\ndoubleIndexInRange\t\tops\/ms\t7.00\t302176.39\t12848.8\t299813.02\t37.76\t0.99\ndoubleIndexInRange\t\tops\/ms\t256.00\t47831.93\t56.70\t46708.70\t56.11\t0.98\ndoubleIndexInRange\t\tops\/ms\t259.00\t11550.02\t27.95\t15333.50\t10.40\t1.33\ndoubleIndexInRange\t\tops\/ms\t512.00\t23687.76\t61.65\t23996.08\t69.52\t1.01\nfloatIndexInRange\t\tops\/ms\t7.00\t412195.79\t124.71\t411770.23\t78.73\t1.00\nfloatIndexInRange\t\tops\/ms\t256.00\t84479.98\t70.69\t84237.31\t70.15\t1.00\nfloatIndexInRange\t\tops\/ms\t259.00\t22585.65\t80.07\t28296.21\t7.98\t1.25\nfloatIndexInRange\t\tops\/ms\t512.00\t46902.99\t51.60\t46686.68\t66.01\t1.00\nintIndexInRange\t\t\tops\/ms\t7.00\t413411.70\t50.59\t420684.66\t253.55\t1.02\nintIndexInRange\t\t\tops\/ms\t256.00\t84652.41\t191.45\t86758.74\t193.66\t1.02\nintIndexInRange\t\t\tops\/ms\t259.00\t61825.20\t291.71\t62037.58\t2355.43\t1.00\nintIndexInRange\t\t\tops\/ms\t512.00\t46754.89\t149.72\t46972.06\t40.13\t1.00\nlongIndexInRange\t\tops\/ms\t7.00\t329385.10\t3292.7\t318538.75\t11103.9\t0.97\nlongIndexInRange\t\tops\/ms\t256.00\t46910.36\t53.41\t46927.82\t138.29\t1.00\nlongIndexInRange\t\tops\/ms\t259.00\t33126.45\t3210.07\t32245.59\t1347.58\t0.97\nlongIndexInRange\t\tops\/ms\t512.00\t23931.64\t215.55\t23805.65\t312.39\t0.99\nshortIndexInRange\t\tops\/ms\t7.00\t479265.67\t1055.89\t468452.89\t433.15\t0.98\nshortIndexInRange\t\tops\/ms\t256.00\t138657.38\t317.72\t138695.29\t505.69\t1.00\nshortIndexInRange\t\tops\/ms\t259.00\t113353.87\t913.13\t108912.75\t1125.60\t0.96\nshortIndexInRange\t\tops\/ms\t512.00\t84652.74\t171.37\t84447.01\t91.99\t1.00\n```\n\nOn an AWS Graviton3 (Neoverse-V1) machine with 128-bit SVE1:\n```\nBenchmark\t        \tUnit\tsize\tBefore\t\tError\tAfter\t\tError\tUplift\nbyteIndexInRange\t\tops\/ms\t7.00\t320073.86\t669.91\t318557.87\t1285.42\t1.00\nbyteIndexInRange\t\tops\/ms\t256.00\t119246.71\t43.13\t120658.01\t28.27\t1.01\nbyteIndexInRange\t\tops\/ms\t259.00\t137664.23\t12001.6\t150378.59\t70.41\t1.09\nbyteIndexInRange\t\tops\/ms\t512.00\t97187.13\t18.60\t95356.43\t78.60\t0.98\ndoubleIndexInRange\t\tops\/ms\t7.00\t291076.68\t603.08\t287383.75\t518.59\t0.99\ndoubleIndexInRange\t\tops\/ms\t256.00\t57473.11\t123.34\t61559.58\t687.21\t1.07\ndoubleIndexInRange\t\tops\/ms\t259.00\t19396.73\t40.03\t22046.65\t8.66\t1.14\ndoubleIndexInRange\t\tops\/ms\t512.00\t33619.28\t33.58\t34715.40\t157.72\t1.03\nfloatIndexInRange\t\tops\/ms\t7.00\t317295.18\t627.76\t303857.78\t465.78\t0.96\nfloatIndexInRange\t\tops\/ms\t256.00\t91734.27\t183.61\t91851.31\t394.35\t1.00\nfloatIndexInRange\t\tops\/ms\t259.00\t38103.12\t129.44\t42237.38\t92.17\t1.11\nfloatIndexInRange\t\tops\/ms\t512.00\t57219.58\t366.00\t57769.07\t264.71\t1.01\nintIndexInRange\t\t\tops\/ms\t7.00\t317063.25\t830.81\t304289.56\t541.12\t0.96\nintIndexInRange\t\t\tops\/ms\t256.00\t91535.60\t315.36\t98143.40\t142.44\t1.07\nintIndexInRange\t\t\tops\/ms\t259.00\t73827.89\t472.28\t73781.80\t21.53\t1.00\nintIndexInRange\t\t\tops\/ms\t512.00\t57552.09\t20.19\t62348.87\t37.45\t1.08\nlongIndexInRange\t\tops\/ms\t7.00\t301886.14\t381.89\t301636.82\t184.80\t1.00\nlongIndexInRange\t\tops\/ms\t256.00\t62246.77\t69.29\t62093.75\t88.72\t1.00\nlongIndexInRange\t\tops\/ms\t259.00\t40642.36\t861.47\t41566.43\t256.04\t1.02\nlongIndexInRange\t\tops\/ms\t512.00\t34850.70\t154.39\t34884.42\t149.17\t1.00\nshortIndexInRange\t\tops\/ms\t7.00\t318133.03\t593.20\t313469.12\t528.73\t0.99\nshortIndexInRange\t\tops\/ms\t256.00\t105019.58\t21.38\t105014.90\t21.81\t1.00\nshortIndexInRange\t\tops\/ms\t259.00\t116235.93\t1985.27\t118697.74\t48.41\t1.02\nshortIndexInRange\t\tops\/ms\t512.00\t91981.84\t166.84\t91874.82\t78.28\t1.00\n```\n\n[1] https:\/\/developer.arm.com\/documentation\/ddi0602\/2025-06\/SVE-Instructions\/CPY--immediate--zeroing---Copy-signed-integer-immediate-to-vector-elements--zeroing--?lang=en\n[2] https:\/\/developer.arm.com\/documentation\/ddi0602\/2025-12\/SVE-Instructions\/CPY--immediate--merging---Copy-signed-integer-immediate-to-vector-elements--merging--?lang=en"},"files":[{"filename":"src\/hotspot\/cpu\/aarch64\/assembler_aarch64.hpp"},{"filename":"src\/hotspot\/cpu\/aarch64\/globals_aarch64.hpp"},{"filename":"src\/hotspot\/cpu\/aarch64\/vm_version_aarch64.cpp"},{"filename":"src\/hotspot\/cpu\/aarch64\/vm_version_aarch64.hpp"},{"filename":"test\/hotspot\/gtest\/aarch64\/test_assembler_aarch64.cpp"},{"filename":"test\/hotspot\/jtreg\/compiler\/arguments\/TestPreferSVEMergingModeCPY.java"}],"sha":"4f5a7bd7b03b117ebeb9979e448b85943de956a7"}]