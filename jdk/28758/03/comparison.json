{"files":[{"patch":"@@ -69,1 +69,0 @@\n-    const bool alloc_failure_pending = ShenandoahCollectorPolicy::is_allocation_failure(cancelled_cause);\n@@ -71,2 +70,6 @@\n-    const GCCause::Cause requested_gc_cause = _requested_gc_cause;\n-\n+    const GCCause::Cause requested_gc_cause = current_requested_gc_cause();\n+    const bool alloc_failure_pending = ShenandoahCollectorPolicy::is_allocation_failure(cancelled_cause) ||\n+                                       ShenandoahCollectorPolicy::is_allocation_failure(requested_gc_cause);\n+    if (is_gc_requested) {\n+      reset_requested_gc();\n+    }\n@@ -172,2 +175,3 @@\n-      \/\/ If this cycle completed without being cancelled, notify waiters about it\n-      if (!heap->cancelled_gc()) {\n+      \/\/ If this cycle completed without being cancelled, or alloc_failure_pending is true(degen),\n+      \/\/ notify waiters about it\n+      if (!heap->cancelled_gc() || alloc_failure_pending) {\n@@ -233,2 +237,6 @@\n-    MonitorLocker ml(&_control_lock, Mutex::_no_safepoint_check_flag);\n-    ml.wait(sleep);\n+    {\n+      MonitorLocker ml(&_control_lock, Mutex::_no_safepoint_check_flag);\n+      if (current_requested_gc_cause() == GCCause::_no_gc) {\n+        ml.wait(sleep);\n+      }\n+    }\n@@ -236,0 +244,4 @@\n+\n+  \/\/ In case any threads are waiting for a cycle to happen, notify them so they observe the shutdown.\n+  notify_gc_waiters();\n+  notify_alloc_failure_waiters();\n@@ -349,1 +361,2 @@\n-void ShenandoahControlThread::notify_control_thread(GCCause::Cause cause) {\n+void ShenandoahControlThread::notify_control_thread(GCCause::Cause cause, ShenandoahGeneration* generation) {\n+  assert(generation->is_global(), \"Must be\");\n@@ -359,0 +372,4 @@\n+void ShenandoahControlThread::notify_control_thread(GCCause::Cause cause) {\n+  notify_control_thread(cause, ShenandoahHeap::heap()->global_generation());\n+}\n+\n@@ -394,1 +411,0 @@\n-  _gc_requested.unset();\n@@ -398,0 +414,17 @@\n+\n+\n+GCCause::Cause ShenandoahControlThread::current_requested_gc_cause() {\n+  if (_control_lock.owned_by_self()) return _requested_gc_cause;\n+  {\n+    MonitorLocker ml(&_control_lock, Mutex::_no_safepoint_check_flag);\n+    return _requested_gc_cause;\n+  }\n+}\n+\n+void ShenandoahControlThread::reset_requested_gc() {\n+  {\n+    MonitorLocker ml(&_control_lock, Mutex::_no_safepoint_check_flag);\n+    _requested_gc_cause = GCCause::_no_gc;\n+    _gc_requested.unset();\n+  }\n+}\n\\ No newline at end of file\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahControlThread.cpp","additions":42,"deletions":9,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -44,2 +44,2 @@\n-  ShenandoahSharedFlag _gc_requested;\n-  GCCause::Cause       _requested_gc_cause;\n+  ShenandoahSharedFlag               _gc_requested;\n+  GCCause::Cause                     _requested_gc_cause;\n@@ -58,0 +58,2 @@\n+  \/\/ Sets the requested cause and flag and notifies the control thread\n+  void notify_control_thread(GCCause::Cause cause, ShenandoahGeneration* generation) override;\n@@ -73,0 +75,4 @@\n+\n+  GCCause::Cause current_requested_gc_cause();\n+\n+  void reset_requested_gc();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahControlThread.hpp","additions":8,"deletions":2,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -50,1 +50,1 @@\n-    request_gc(cause);\n+    notify_control_thread(cause, heap->mode()->is_generational() ? reinterpret_cast<ShenandoahGeneration *>(heap->young_generation()) : heap->global_generation());\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahController.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -33,0 +33,2 @@\n+class ShenandoahGeneration;\n+\n@@ -65,0 +67,3 @@\n+ \/\/ Sets the requested cause and flag and notifies the control thread\n+  virtual void notify_control_thread(GCCause::Cause cause, ShenandoahGeneration* generation) { }\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahController.hpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -673,2 +673,3 @@\n-      if (_requested_gc_cause != GCCause::_no_gc) {\n-        log_debug(gc, thread)(\"Reject request for concurrent gc because another gc is pending: %s\", GCCause::to_string(_requested_gc_cause));\n+      GCCause::Cause requested_gc_cause = _requested_gc_cause;\n+      if (requested_gc_cause != GCCause::_no_gc) {\n+        log_debug(gc, thread)(\"Reject request for concurrent gc because another gc is pending: %s\", GCCause::to_string(requested_gc_cause));\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalControlThread.cpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -66,1 +66,1 @@\n-  GCCause::Cause  _requested_gc_cause;\n+  GCCause::Cause _requested_gc_cause;\n@@ -140,1 +140,1 @@\n-  void notify_control_thread(GCCause::Cause cause, ShenandoahGeneration* generation);\n+  void notify_control_thread(GCCause::Cause cause, ShenandoahGeneration* generation) override;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalControlThread.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}