{"files":[{"patch":"@@ -27,0 +27,1 @@\n+#include \"runtime\/interfaceSupport.inline.hpp\"\n@@ -113,0 +114,2 @@\n+\n+#ifdef ASSERT\n@@ -114,3 +117,0 @@\n-  auto not_enough_memory = [&]() {\n-    return unused < (required_memory + sizeof(Message)*(output == nullptr ? 1 : 2));\n-  };\n@@ -119,0 +119,6 @@\n+#endif\n+\n+  auto not_enough_memory = [&]() {\n+    return this->available_bytes() < (required_memory + sizeof(Message)*(output == nullptr ? 1 : 2));\n+  };\n+\n@@ -121,3 +127,11 @@\n-      while (not_enough_memory()) {\n-        _producer_lock.wait(0);\n-        unused = this->available_bytes();\n+      auto stall_for_memory = [&]() {\n+        while (not_enough_memory()) {\n+          _producer_lock.wait(0);\n+        }\n+      };\n+      Thread* thread = Thread::current_or_null();\n+      if (thread != nullptr && thread->is_Java_thread()) {\n+        ThreadBlockInVM tbivm(JavaThread::cast(thread));\n+        stall_for_memory();\n+      } else {\n+        stall_for_memory();\n","filename":"src\/hotspot\/share\/logging\/circularStringBuffer.cpp","additions":20,"deletions":6,"binary":false,"changes":26,"status":"modified"}]}