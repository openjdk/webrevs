{"files":[{"patch":"@@ -78,0 +78,4 @@\n+}\n+\n+void EpsilonHeap::post_initialize() {\n+  CollectedHeap::post_initialize();\n","filename":"src\/hotspot\/share\/gc\/epsilon\/epsilonHeap.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -72,0 +72,1 @@\n+  void post_initialize() override;\n","filename":"src\/hotspot\/share\/gc\/epsilon\/epsilonHeap.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -601,1 +601,0 @@\n-  initialize_serviceability();\n","filename":"src\/hotspot\/share\/gc\/shared\/collectedHeap.cpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -244,0 +244,4 @@\n+  \/\/ Initialize serviceability support. This should prepare the implementation\n+  \/\/ for accepting serviceability-related calls, like memory_managers(), memory_pools().\n+  virtual void initialize_serviceability() = 0;\n+\n@@ -420,2 +424,0 @@\n-  virtual void initialize_serviceability() = 0;\n-\n","filename":"src\/hotspot\/share\/gc\/shared\/collectedHeap.hpp","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -1185,3 +1185,2 @@\n-  \/\/ (\"weak\") refs processing infrastructure initialization\n-  Universe::heap()->post_initialize();\n-\n+  \/\/ Initialize serviceability\n+  Universe::heap()->initialize_serviceability();\n@@ -1189,1 +1188,0 @@\n-\n@@ -1192,0 +1190,3 @@\n+  \/\/ Complete initialization\n+  Universe::heap()->post_initialize();\n+\n","filename":"src\/hotspot\/share\/memory\/universe.cpp","additions":5,"deletions":4,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -26,2 +26,8 @@\n-\/**\n- * @test TestInitAllocs\n+import java.util.Arrays;\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+\n+\/* @test id=default\n@@ -29,41 +35,45 @@\n- * @summary Test that allocation path taken in early JVM phases works\n- *\n- * @run main\/othervm -Xmx256m\n- *                   -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC\n- *                   gc.epsilon.TestInitAllocs\n- *\n- * @run main\/othervm -Xmx256m\n- *                   -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC\n- *                   -XX:+UseTLAB\n- *                   -XX:+UseCompressedOops\n- *                   -XX:EpsilonMinHeapExpand=1024\n- *                   -XX:EpsilonUpdateCountersStep=1\n- *                   -XX:EpsilonPrintHeapSteps=1000000\n- *                   gc.epsilon.TestInitAllocs\n- *\n- * @run main\/othervm -Xmx256m\n- *                   -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC\n- *                   -XX:+UseTLAB\n- *                   -XX:-UseCompressedOops\n- *                   -XX:EpsilonMinHeapExpand=1024\n- *                   -XX:EpsilonUpdateCountersStep=1\n- *                   -XX:EpsilonPrintHeapSteps=1000000\n- *                   gc.epsilon.TestInitAllocs\n- *\n- * @run main\/othervm -Xmx256m\n- *                   -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC\n- *                   -XX:-UseTLAB\n- *                   -XX:+UseCompressedOops\n- *                   -XX:EpsilonMinHeapExpand=1024\n- *                   -XX:EpsilonUpdateCountersStep=1\n- *                   -XX:EpsilonPrintHeapSteps=1000000\n- *                   gc.epsilon.TestInitAllocs\n- *\n- * @run main\/othervm -Xmx256m\n- *                   -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC\n- *                   -XX:-UseTLAB\n- *                   -XX:-UseCompressedOops\n- *                   -XX:EpsilonMinHeapExpand=1024\n- *                   -XX:EpsilonUpdateCountersStep=1\n- *                   -XX:EpsilonPrintHeapSteps=1000000\n- *                   gc.epsilon.TestInitAllocs\n+ * @summary Stress test that allocation path taken in early JVM phases works\n+ * @library \/test\/lib\n+ * @run driver gc.epsilon.TestInitAllocs\n+ *\/\n+\n+\/* @test id=nocoops\n+ * @requires vm.gc.Epsilon\n+ * @library \/test\/lib\n+ * @run driver gc.epsilon.TestInitAllocs -XX:-UseCompressedOops\n+ *\/\n+\n+\/* @test id=notlabs\n+ * @requires vm.gc.Epsilon\n+ * @library \/test\/lib\n+ * @run driver gc.epsilon.TestInitAllocs -XX:-UseTLAB\n+ *\/\n+\n+\/* @test id=notlabs-nocoops\n+ * @requires vm.gc.Epsilon\n+ * @library \/test\/lib\n+ * @run driver gc.epsilon.TestInitAllocs -XX:-UseCompressedOops -XX:-UseTLAB\n+ *\/\n+\n+\/* @test id=coh\n+ * @requires vm.gc.Epsilon\n+ * @library \/test\/lib\n+ * @run driver gc.epsilon.TestInitAllocs -XX:+UseCompactObjectHeaders\n+ *\/\n+\n+\/* @test id=coh-nocoops\n+ * @requires vm.gc.Epsilon\n+ * @library \/test\/lib\n+ * @run driver gc.epsilon.TestInitAllocs -XX:+UseCompactObjectHeaders -XX:-UseCompressedOops\n+ *\/\n+\n+\/* @test id=coh-notlabs\n+ * @requires vm.gc.Epsilon\n+ * @library \/test\/lib\n+ * @run driver gc.epsilon.TestInitAllocs -XX:+UseCompactObjectHeaders -XX:-UseTLAB\n+ *\/\n+\n+\/* @test id=coh-notlabs-nocoops\n+ * @requires vm.gc.Epsilon\n+ * @library \/test\/lib\n+ * @run driver gc.epsilon.TestInitAllocs -XX:+UseCompactObjectHeaders -XX:-UseCompressedOops -XX:-UseTLAB\n@@ -73,2 +83,22 @@\n-  public static void main(String[] args) throws Exception {\n-    System.out.println(\"Hello World\");\n+  static final Integer TRIES = Integer.getInteger(\"tries\", 500);\n+\n+  public static void main(String... args) throws Exception {\n+    List<String> testArgs = new ArrayList<>();\n+    testArgs.add(\"-Xmx256m\");\n+    testArgs.add(\"-XX:+UnlockExperimentalVMOptions\");\n+    testArgs.add(\"-XX:+UseEpsilonGC\");\n+    testArgs.add(\"-XX:EpsilonMinHeapExpand=1024\");\n+    testArgs.add(\"-XX:EpsilonUpdateCountersStep=1\");\n+    testArgs.add(\"-XX:EpsilonPrintHeapSteps=1000000\");\n+    testArgs.addAll(Arrays.asList(args));\n+    testArgs.add(TestInitAllocs.Main.class.getName());\n+    for (int t = 0; t < TRIES; t++) {\n+      OutputAnalyzer oa = ProcessTools.executeLimitedTestJava(testArgs);\n+      oa.shouldHaveExitValue(0);\n+    }\n+  }\n+\n+  static class Main {\n+    public static void main(String... args) {\n+      \/\/ Do nothing\n+    }\n","filename":"test\/hotspot\/jtreg\/gc\/epsilon\/TestInitAllocs.java","additions":75,"deletions":45,"binary":false,"changes":120,"status":"modified"}]}