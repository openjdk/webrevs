{"files":[{"patch":"@@ -28,1 +28,1 @@\n- * @run testng java.net.http\/jdk.internal.net.http.RawChannelTest\n+ * @run testng\/othervm java.net.http\/jdk.internal.net.http.RawChannelTest\n@@ -30,0 +30,5 @@\n+\/\/ use\n+\/\/     @run testng\/othervm -Dseed=6434511950803022575\n+\/\/          java.net.http\/jdk.internal.net.http.RawChannelTest\n+\/\/ to reproduce a failure with a particular seed (e.g. 6434511950803022575)\n+\/\/ if this test is observed failing with that seed\n","filename":"test\/jdk\/java\/net\/httpclient\/whitebox\/RawChannelTestDriver.java","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,0 +26,1 @@\n+import java.io.Closeable;\n@@ -46,0 +47,2 @@\n+import java.util.concurrent.atomic.AtomicReference;\n+\n@@ -47,1 +50,0 @@\n-import jdk.internal.net.http.websocket.WebSocketRequest;\n@@ -60,0 +62,14 @@\n+    \/\/ can't use jdk.test.lib when injected in java.net.httpclient\n+    \/\/ Seed can be specified on the @run line with -Dseed=<seed>\n+    private static class RandomFactory {\n+        private static long getSeed() {\n+            long seed = Long.getLong(\"seed\", new Random().nextLong());\n+            System.out.println(\"Seed from RandomFactory = \"+seed+\"L\");\n+            return seed;\n+        }\n+        public static Random getRandom() {\n+            return new Random(getSeed());\n+        }\n+    }\n+\n+    private static final Random RANDOM = RandomFactory.getRandom();\n@@ -93,1 +109,2 @@\n-            new TestServer(server).start();\n+            TestServer testServer = new TestServer(server);\n+            testServer.start();\n@@ -132,0 +149,1 @@\n+                            closeChannel(chan);\n@@ -148,0 +166,3 @@\n+                        print(\"OP_RIGHT failed: \" + e);\n+                        outputCompleted.completeExceptionally(e);\n+                        closeChannel(chan);\n@@ -171,0 +192,1 @@\n+                            closeChannel(chan);\n@@ -182,1 +204,4 @@\n-                                e.printStackTrace();\n+                                print(\"OP_READ failed to register event: \" + e);\n+                                inputCompleted.completeExceptionally(e);\n+                                closeChannel(chan);\n+                                throw new UncheckedIOException(e);\n@@ -194,0 +219,1 @@\n+\n@@ -196,6 +222,1 @@\n-                        try {\n-                            print(\"closing channel\");\n-                            chan.close();\n-                        } catch (IOException x) {\n-                            x.printStackTrace();\n-                        }\n+                        closeChannel(chan);\n@@ -206,0 +227,5 @@\n+            Throwable serverError = testServer.failed.get();\n+            if (serverError != null) {\n+                throw new AssertionError(\"TestServer failed: \"\n+                        + serverError, serverError);\n+            }\n@@ -209,0 +235,11 @@\n+    private static void closeChannel(RawChannel chan) {\n+        print(\"closing channel\");\n+        try {\n+            chan.close();\n+        } catch (IOException x) {\n+            print(\"Failed to close channel: \" + x);\n+            x.printStackTrace();\n+        }\n+    }\n+\n+\n@@ -240,0 +277,1 @@\n+        private final AtomicReference<Throwable> failed = new AtomicReference<>();\n@@ -245,0 +283,12 @@\n+        private void fail(Closeable s, String actor, Throwable t) {\n+            failed.compareAndSet(null, t);\n+            print(\"Server %s got exception: %s\", actor, t);\n+            t.printStackTrace();\n+            try {\n+                s.close();\n+            } catch (Exception x) {\n+                print(\"Server %s failed to close socket: %s\", actor, t);\n+            }\n+\n+        }\n+\n@@ -255,0 +305,1 @@\n+                        print(\"Server reader started\");\n@@ -259,1 +310,1 @@\n-                        e.printStackTrace();\n+                        fail(s, \"reader\", e);\n@@ -265,0 +316,1 @@\n+                        print(\"Server writer started\");\n@@ -269,1 +321,1 @@\n-                        e.printStackTrace();\n+                        fail(s, \"writer\", e);\n@@ -279,1 +331,1 @@\n-                e.printStackTrace();\n+                fail(server,\"acceptor\", e);\n@@ -368,1 +420,3 @@\n-        return new byte[new Random().nextInt(1 + bound)];\n+        \/\/ bound must be > 1; No need to check it,\n+        \/\/ nextInt will throw IllegalArgumentException if needed\n+        return new byte[RANDOM.nextInt(1, bound + 1)];\n","filename":"test\/jdk\/java\/net\/httpclient\/whitebox\/java.net.http\/jdk\/internal\/net\/http\/RawChannelTest.java","additions":68,"deletions":14,"binary":false,"changes":82,"status":"modified"}]}