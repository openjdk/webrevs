{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2016, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2016, 2025, Oracle and\/or its affiliates. All rights reserved.\n","filename":"test\/jdk\/java\/net\/httpclient\/whitebox\/RawChannelTestDriver.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+import java.io.Closeable;\n@@ -46,0 +47,2 @@\n+import java.util.concurrent.atomic.AtomicReference;\n+\n@@ -47,1 +50,0 @@\n-import jdk.internal.net.http.websocket.WebSocketRequest;\n@@ -93,1 +95,2 @@\n-            new TestServer(server).start();\n+            TestServer testServer = new TestServer(server);\n+            testServer.start();\n@@ -112,0 +115,46 @@\n+            chan.registerEvent(new RawChannel.RawEvent() {\n+\n+                @Override\n+                public int interestOps() {\n+                    return SelectionKey.OP_READ;\n+                }\n+\n+                @Override\n+                public void handle() {\n+                    int i = readHandles.incrementAndGet();\n+                    print(\"OP_READ #%s\", i);\n+                    ByteBuffer read = null;\n+                    long total = 0;\n+                    while (true) {\n+                        try {\n+                            read = chan.read();\n+                        } catch (IOException e) {\n+                            inputCompleted.completeExceptionally(e);\n+                            closeChannel(chan);\n+                            e.printStackTrace();\n+                        }\n+                        if (read == null) {\n+                            print(\"OP_READ EOF\");\n+                            inputCompleted.complete(null);\n+                            break;\n+                        } else if (!read.hasRemaining()) {\n+                            print(\"OP_READ stall\");\n+                            try {\n+                                chan.registerEvent(this);\n+                            } catch (IOException e) {\n+                                print(\"OP_READ failed to register event: \" + e);\n+                                inputCompleted.completeExceptionally(e);\n+                                closeChannel(chan);\n+                                throw new UncheckedIOException(e);\n+                            }\n+                            readStall.countDown();\n+                            break;\n+                        }\n+                        int r = read.remaining();\n+                        total += r;\n+                        clientRead.addAndGet(r);\n+                    }\n+                    print(\"OP_READ read %s bytes (%s total)\", total, clientRead.get());\n+                }\n+            });\n+\n@@ -132,0 +181,1 @@\n+                            closeChannel(chan);\n@@ -148,0 +198,3 @@\n+                        print(\"OP_RIGHT failed: \" + e);\n+                        outputCompleted.completeExceptionally(e);\n+                        closeChannel(chan);\n@@ -153,41 +206,0 @@\n-            chan.registerEvent(new RawChannel.RawEvent() {\n-\n-                @Override\n-                public int interestOps() {\n-                    return SelectionKey.OP_READ;\n-                }\n-\n-                @Override\n-                public void handle() {\n-                    int i = readHandles.incrementAndGet();\n-                    print(\"OP_READ #%s\", i);\n-                    ByteBuffer read = null;\n-                    long total = 0;\n-                    while (true) {\n-                        try {\n-                            read = chan.read();\n-                        } catch (IOException e) {\n-                            inputCompleted.completeExceptionally(e);\n-                            e.printStackTrace();\n-                        }\n-                        if (read == null) {\n-                            print(\"OP_READ EOF\");\n-                            inputCompleted.complete(null);\n-                            break;\n-                        } else if (!read.hasRemaining()) {\n-                            print(\"OP_READ stall\");\n-                            try {\n-                                chan.registerEvent(this);\n-                            } catch (IOException e) {\n-                                e.printStackTrace();\n-                            }\n-                            readStall.countDown();\n-                            break;\n-                        }\n-                        int r = read.remaining();\n-                        total += r;\n-                        clientRead.addAndGet(r);\n-                    }\n-                    print(\"OP_READ read %s bytes (%s total)\", total, clientRead.get());\n-                }\n-            });\n@@ -196,6 +208,1 @@\n-                        try {\n-                            print(\"closing channel\");\n-                            chan.close();\n-                        } catch (IOException x) {\n-                            x.printStackTrace();\n-                        }\n+                        closeChannel(chan);\n@@ -206,0 +213,15 @@\n+            Throwable serverError = testServer.failed.get();\n+            if (serverError != null) {\n+                throw new AssertionError(\"TestServer failed: \"\n+                        + serverError, serverError);\n+            }\n+        }\n+    }\n+\n+    private static void closeChannel(RawChannel chan) {\n+        print(\"closing channel\");\n+        try {\n+            chan.close();\n+        } catch (IOException x) {\n+            print(\"Failed to close channel: \" + x);\n+            x.printStackTrace();\n@@ -209,0 +231,1 @@\n+\n@@ -240,0 +263,1 @@\n+        private final AtomicReference<Throwable> failed = new AtomicReference<>();\n@@ -245,0 +269,12 @@\n+        private void fail(Closeable s, String actor, Throwable t) {\n+            failed.compareAndSet(null, t);\n+            print(\"Server %s got exception: %s\", actor, t);\n+            t.printStackTrace();\n+            try {\n+                s.close();\n+            } catch (Exception x) {\n+                print(\"Server %s failed to close socket: %s\", actor, t);\n+            }\n+\n+        }\n+\n@@ -255,0 +291,1 @@\n+                        print(\"Server reader started\");\n@@ -259,1 +296,1 @@\n-                        e.printStackTrace();\n+                        fail(s, \"reader\", e);\n@@ -265,0 +302,1 @@\n+                        print(\"Server writer started\");\n@@ -269,1 +307,1 @@\n-                        e.printStackTrace();\n+                        fail(s, \"writer\", e);\n@@ -279,1 +317,1 @@\n-                e.printStackTrace();\n+                fail(server,\"acceptor\", e);\n","filename":"test\/jdk\/java\/net\/httpclient\/whitebox\/java.net.http\/jdk\/internal\/net\/http\/RawChannelTest.java","additions":90,"deletions":52,"binary":false,"changes":142,"status":"modified"}]}