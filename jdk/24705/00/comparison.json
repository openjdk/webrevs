{"files":[{"patch":"@@ -30,0 +30,2 @@\n+import java.lang.classfile.attribute.StackMapFrameInfo;\n+import java.lang.classfile.attribute.StackMapTableAttribute;\n@@ -51,0 +53,1 @@\n+import jdk.internal.classfile.impl.DirectCodeBuilder;\n@@ -106,0 +109,7 @@\n+    private static final List<StackMapFrameInfo.VerificationTypeInfo> TYPE_SWITCH_LOCALS = List.of(\n+            StackMapFrameInfo.ObjectVerificationTypeInfo.of(CD_Object), StackMapFrameInfo.SimpleVerificationTypeInfo.INTEGER\n+    );\n+    private static final List<StackMapFrameInfo.VerificationTypeInfo> TYPE_SWITCH_EXTRA_LOCALS = List.of(\n+            StackMapFrameInfo.ObjectVerificationTypeInfo.of(CD_Object), StackMapFrameInfo.SimpleVerificationTypeInfo.INTEGER,\n+            StackMapFrameInfo.ObjectVerificationTypeInfo.of(CD_BiPredicate), StackMapFrameInfo.ObjectVerificationTypeInfo.of(CD_List)\n+    );\n@@ -485,0 +495,2 @@\n+        var locals = enumDescs == null && extraClassLabels == null ? TYPE_SWITCH_LOCALS : TYPE_SWITCH_EXTRA_LOCALS;\n+\n@@ -487,0 +499,1 @@\n+            var stackMapFrames = new ArrayList<StackMapFrameInfo>(labelConstants.length * 2);\n@@ -497,0 +510,1 @@\n+            stackMapFrames.add(StackMapFrameInfo.of(nonNullLabel, locals, List.of()));\n@@ -499,1 +513,3 @@\n-                  .ireturn();\n+                  .ireturn()\n+                  .with(StackMapTableAttribute.of(stackMapFrames));\n+                DirectCodeBuilder.withMaxs(cb, 2, locals.size()); \/\/ checkIndex uses 2\n@@ -512,0 +528,1 @@\n+                stackMapFrames.add(StackMapFrameInfo.of(target, locals, List.of()));\n@@ -544,1 +561,1 @@\n-                            Label notNumber = cb.newLabel();\n+                            Label notNumber = cb.newLabel(); \/\/ this label may end up unbound\n@@ -573,2 +590,3 @@\n-                                  .labelBinding(notNumber)\n-                                  .aload(SELECTOR_OBJ)\n+                                  .labelBinding(notNumber);\n+                                stackMapFrames.add(StackMapFrameInfo.of(notNumber, locals, List.of()));\n+                                cb.aload(SELECTOR_OBJ)\n@@ -583,0 +601,1 @@\n+                                stackMapFrames.add(StackMapFrameInfo.of(compare, locals, List.of(StackMapFrameInfo.SimpleVerificationTypeInfo.INTEGER)));\n@@ -651,2 +670,3 @@\n-                      .labelBinding(notNumber)\n-                      .aload(SELECTOR_OBJ)\n+                      .labelBinding(notNumber);\n+                    stackMapFrames.add(StackMapFrameInfo.of(notNumber, locals, List.of()));\n+                    cb.aload(SELECTOR_OBJ)\n@@ -660,3 +680,3 @@\n-                      .labelBinding(compare)\n-\n-                      .loadConstant(integerLabel)\n+                      .labelBinding(compare);\n+                    stackMapFrames.add(StackMapFrameInfo.of(compare, locals, List.of(StackMapFrameInfo.SimpleVerificationTypeInfo.INTEGER)));\n+                    cb.loadConstant(integerLabel)\n@@ -691,0 +711,1 @@\n+            stackMapFrames.add(StackMapFrameInfo.of(dflt, locals, List.of()));\n@@ -693,1 +714,3 @@\n-              .ireturn();\n+              .ireturn()\n+              .with(StackMapTableAttribute.of(stackMapFrames));\n+            DirectCodeBuilder.withMaxs(cb, 3, locals.size()); \/\/ enum labels use 3 stack, others use 2\n@@ -705,1 +728,1 @@\n-        byte[] classBytes = ClassFile.of().build(ConstantUtils.binaryNameToDesc(typeSwitchClassName(caller.lookupClass())),\n+        byte[] classBytes = ClassFile.of(ClassFile.StackMapsOption.DROP_STACK_MAPS).build(ConstantUtils.binaryNameToDesc(typeSwitchClassName(caller.lookupClass())),\n","filename":"src\/java.base\/share\/classes\/java\/lang\/runtime\/SwitchBootstraps.java","additions":34,"deletions":11,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -75,5 +75,4 @@\n-        return switch (parent) {\n-            case BlockCodeBuilderImpl b -> b.topLocal;\n-            case ChainedCodeBuilder b -> b.terminal.curTopLocal();\n-            case TerminalCodeBuilder b -> b.curTopLocal();\n-        };\n+        if (parent instanceof BlockCodeBuilderImpl bcb) {\n+            return bcb.topLocal;\n+        }\n+        return findTerminal(parent).curTopLocal();\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/BlockCodeBuilderImpl.java","additions":5,"deletions":6,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -42,4 +42,2 @@\n-        this.terminal = switch (downstream) {\n-            case ChainedClassBuilder cb -> cb.terminal;\n-            case DirectClassBuilder db -> db;\n-        };\n+        this.terminal = downstream instanceof ChainedClassBuilder ccb ?\n+                ccb.terminal : (DirectClassBuilder) downstream;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/ChainedClassBuilder.java","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -41,4 +41,2 @@\n-        this.terminal = switch (downstream) {\n-            case ChainedFieldBuilder cb -> cb.terminal;\n-            case TerminalFieldBuilder tb -> tb;\n-        };\n+        this.terminal = downstream instanceof ChainedFieldBuilder cfb ?\n+                cfb.terminal : (TerminalFieldBuilder) downstream;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/ChainedFieldBuilder.java","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -44,4 +44,2 @@\n-        this.terminal = switch (downstream) {\n-            case ChainedMethodBuilder cb -> cb.terminal;\n-            case TerminalMethodBuilder tb -> tb;\n-        };\n+        this.terminal = downstream instanceof ChainedMethodBuilder cmb ?\n+                cmb.terminal : (TerminalMethodBuilder) downstream;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/ChainedMethodBuilder.java","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -267,4 +267,5 @@\n-                    switch (i) {\n-                        case BranchInstruction br -> br.target();\n-                        case DiscontinuedInstruction.JsrInstruction jsr -> jsr.target();\n-                        case LookupSwitchInstruction ls -> {\n+                    switch (i.opcode().kind()) {\n+                        case BRANCH -> ((BranchInstruction) i).target();\n+                        case DISCONTINUED_JSR -> ((DiscontinuedInstruction.JsrInstruction) i).target();\n+                        case LOOKUP_SWITCH -> {\n+                            var ls = (LookupSwitchInstruction) i;\n@@ -274,1 +275,2 @@\n-                        case TableSwitchInstruction ts -> {\n+                        case TABLE_SWITCH -> {\n+                            var ts = (TableSwitchInstruction) i;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/CodeImpl.java","additions":7,"deletions":5,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -51,1 +51,0 @@\n-    private static final DeferredLabel[] EMPTY_LABEL_ARRAY = {};\n@@ -54,1 +53,0 @@\n-    private static final AbstractPseudoInstruction.ExceptionCatchImpl[] EMPTY_HANDLER_ARRAY = {};\n@@ -77,0 +75,3 @@\n+    private int maxStackHint = -1;\n+    private int maxLocalsHint = -1;\n+\n@@ -176,0 +177,6 @@\n+    public static void withMaxs(CodeBuilder cob, int stacks, int locals) {\n+        var dcb = (DirectCodeBuilder) cob;\n+        dcb.maxStackHint = stacks;\n+        dcb.maxLocalsHint = locals;\n+    }\n+\n@@ -322,0 +329,2 @@\n+                } else if (maxLocalsHint >= 0 && maxStackHint >= 0) {\n+                    buf.writeU2U2(maxStackHint, maxLocalsHint);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/DirectCodeBuilder.java","additions":11,"deletions":2,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,4 +38,6 @@\n-        this.terminal = switch (parent) {\n-            case NonterminalCodeBuilder cb -> cb.terminal;\n-            case TerminalCodeBuilder cb -> cb;\n-        };\n+        this.terminal = findTerminal(parent);\n+    }\n+\n+    static TerminalCodeBuilder findTerminal(CodeBuilder cob) {\n+        return cob instanceof NonterminalCodeBuilder ncb ?\n+                ncb.terminal : (TerminalCodeBuilder) cob;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/NonterminalCodeBuilder.java","additions":7,"deletions":5,"binary":false,"changes":12,"status":"modified"}]}