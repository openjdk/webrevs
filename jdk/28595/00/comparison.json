{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2012, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -25,1 +25,1 @@\n- * @bug 4111507\n+ * @bug 4111507 8372857\n@@ -27,1 +27,0 @@\n- * @author Ann Wollrath\n@@ -36,1 +35,1 @@\n-public class AddrInUse implements Runnable {\n+public class AddrInUse {\n@@ -38,25 +37,1 @@\n-    private static int port = -1;\n-    private static final long TIMEOUT = 10000;\n-\n-    private boolean exportSucceeded = false;\n-    private Throwable exportException = null;\n-\n-    public void run() {\n-\n-        \/*\n-         * Attempt to create (i.e. export) a registry on the port that\n-         * has already been bound, and record the result.\n-         *\/\n-        try {\n-            LocateRegistry.createRegistry(port);\n-            synchronized (this) {\n-                exportSucceeded = true;\n-                notifyAll();\n-            }\n-        } catch (Throwable t) {\n-            synchronized (this) {\n-                exportException = t;\n-                notifyAll();\n-            }\n-        }\n-    }\n+    private static volatile Throwable failure = null;\n@@ -65,2 +40,0 @@\n-        System.err.println(\"\\nRegression test for bug 4111507\\n\");\n-\n@@ -70,13 +43,3 @@\n-        ServerSocket server = new ServerSocket(0);\n-        port = server.getLocalPort();\n-        System.err.println(\"Created a ServerSocket on port \" + port + \"...\");\n-\n-        \/*\n-         * Start a thread that creates a registry on the same port,\n-         * and analyze the result.\n-         *\/\n-        System.err.println(\"create a registry on the same port...\");\n-        System.err.println(\"(should cause an ExportException)\");\n-        AddrInUse obj = new AddrInUse();\n-        synchronized (obj) {\n-            (new Thread(obj, \"AddrInUse\")).start();\n+        try (ServerSocket server = new ServerSocket(0)) {\n+            int port = server.getLocalPort();\n+            System.err.println(\"Created a ServerSocket on port \" + port + \"...\");\n@@ -85,2 +48,2 @@\n-             * Don't wait forever (original bug is that the export\n-             * hangs).\n+             * Start a thread that creates a registry on the same port,\n+             * and analyze the result.\n@@ -88,1 +51,2 @@\n-            obj.wait(TIMEOUT);\n+            System.err.println(\"create a registry on the same port...\");\n+            System.err.println(\"(should cause an ExportException)\");\n@@ -90,11 +54,9 @@\n-            if (obj.exportSucceeded) {\n-                throw new RuntimeException(\n-                    \"TEST FAILED: export on already-bound port succeeded\");\n-            } else if (obj.exportException != null) {\n-                obj.exportException.printStackTrace();\n-                if (obj.exportException instanceof ExportException) {\n-                    System.err.println(\"TEST PASSED\");\n-                } else {\n-                    throw new RuntimeException(\n-                        \"TEST FAILED: unexpected exception occurred\",\n-                        obj.exportException);\n+            Thread exportRegistryThread = new Thread(() -> {\n+                \/*\n+                 * Attempt to create (i.e. export) a registry on the port that\n+                 * has already been bound, and record the result.\n+                 *\/\n+                try {\n+                    LocateRegistry.createRegistry(port);\n+                } catch (Throwable t) {\n+                    failure = t;\n@@ -102,2 +64,18 @@\n-            } else {\n-                throw new RuntimeException(\"TEST FAILED: export timed out\");\n+            }, \"ExportRegistry-Thread\");\n+\n+            exportRegistryThread.start();\n+\n+            \/*\n+             * Wait for the LocateRegistry.createRegistry() call to complete or\n+             * if it blocks forever (due to the original bug), then let jtreg fail\n+             * the test with a timeout\n+             *\/\n+            exportRegistryThread.join();\n+            Throwable ex = failure;\n+            if (ex == null) {\n+                throw new RuntimeException(\n+                        \"TEST FAILED: export on already-bound port succeeded\");\n+            }\n+            if (!(ex instanceof ExportException)) {\n+                throw new RuntimeException(\n+                        \"TEST FAILED: unexpected exception occurred\", ex);\n@@ -105,0 +83,1 @@\n+            System.err.println(\"TEST PASSED, received expected exception: \" + ex);\n","filename":"test\/jdk\/java\/rmi\/server\/RemoteServer\/AddrInUse.java","additions":39,"deletions":60,"binary":false,"changes":99,"status":"modified"}]}