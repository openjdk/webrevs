{"files":[{"patch":"@@ -46,3 +46,0 @@\n-    private static final String BYTE_ARRAY_CLASS_NAME = new byte[0].getClass().getName();\n-\n-    private static AtomicBoolean onError = null;\n@@ -60,12 +57,5 @@\n-        CountDownLatch delivered = new CountDownLatch(1);\n-        onError = new AtomicBoolean();\n-        Thread current = Thread.currentThread();\n-        allocateBeforeRecording();\n-        try (RecordingStream rs = new RecordingStream()) {\n-            rs.enable(EVENT_NAME);\n-            rs.onEvent(EVENT_NAME, e -> {\n-                if (verify(e, current)) {\n-                    delivered.countDown();\n-                }\n-            });\n-            rs.startAsync();\n+        long currentThreadId = Thread.currentThread().threadId();\n+        allocate(OBJECTS_TO_ALLOCATE_BEFORE_RECORDING);\n+        try (Recording r = new Recording()) {\n+            r.enable(EVENT_NAME);\n+            r.start();\n@@ -73,3 +63,9 @@\n-            delivered.await();\n-            if (onError.get()) {\n-                throw new RuntimeException(\"Sample weight is not below \" + BEFORE_RECORDING_SAMPLE_WEIGHT);\n+            r.stop();\n+            List<RecordedEvent> events = Events.fromRecording(r);\n+            Events.hasEvents(events);\n+            for (RecordedEvent event : events) {\n+                if (currentThreadId == event.getThread().getJavaThreadId()) {\n+                    if (event.getLong(\"weight\") >= BEFORE_RECORDING_SAMPLE_WEIGHT) {\n+                        throw new RuntimeException(\"Sample weight is not below \" + BEFORE_RECORDING_SAMPLE_WEIGHT);\n+                    }\n+                }\n@@ -80,4 +76,0 @@\n-    private static void allocateBeforeRecording() throws Exception {\n-        allocate(OBJECTS_TO_ALLOCATE_BEFORE_RECORDING);\n-    }\n-\n@@ -89,11 +81,0 @@\n-\n-    private static boolean verify(RecordedEvent event, Thread thread) {\n-        if (thread.getId() != event.getThread().getJavaThreadId()) {\n-            return false;\n-        }\n-        System.out.println(event);\n-        if (event.getLong(\"weight\") >= BEFORE_RECORDING_SAMPLE_WEIGHT) {\n-            onError.set(true);\n-        }\n-        return true;\n-    }\n","filename":"test\/jdk\/jdk\/jfr\/event\/allocation\/TestObjectAllocationSampleEventInitialWeight.java","additions":14,"deletions":33,"binary":false,"changes":47,"status":"modified"}]}