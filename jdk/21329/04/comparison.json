{"files":[{"patch":"@@ -202,1 +202,0 @@\n-    JavaValue result(T_OBJECT);\n@@ -204,9 +203,2 @@\n-    Handle path_string = java_lang_String::create_from_str(path, CHECK_(url_h));\n-    Klass* classLoaders_klass =\n-        vmClasses::jdk_internal_loader_ClassLoaders_klass();\n-    JavaCalls::call_static(&result, classLoaders_klass,\n-                           vmSymbols::toFileURL_name(),\n-                           vmSymbols::toFileURL_signature(),\n-                           path_string, CHECK_(url_h));\n-\n-    atomic_set_shared_jar_url(shared_path_index, result.get_oop());\n+    oop result_oop = get_shared_jar_url_helper(path, url_h, CHECK_(url_h));\n+    atomic_set_shared_jar_url(shared_path_index, result_oop);\n@@ -220,0 +212,11 @@\n+oop CDSProtectionDomain::get_shared_jar_url_helper(const char* path, Handle url_h, TRAPS) {\n+  JavaValue result(T_OBJECT);\n+  Handle path_string = java_lang_String::create_from_str(path, CHECK_NULL);\n+  JavaCalls::call_static(&result,\n+                         vmClasses::jdk_internal_loader_ClassLoaders_klass(),\n+                         vmSymbols::toFileURL_name(),\n+                         vmSymbols::toFileURL_signature(),\n+                         path_string, CHECK_NULL);\n+  return result.get_oop();\n+}\n+\n","filename":"src\/hotspot\/share\/cds\/cdsProtectionDomain.cpp","additions":13,"deletions":10,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -83,0 +83,1 @@\n+  static oop get_shared_jar_url_helper(const char* path, Handle url_h, TRAPS);\n","filename":"src\/hotspot\/share\/cds\/cdsProtectionDomain.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -754,2 +754,10 @@\n-  \/\/ Exercise the manifest processing code to ensure classes used by CDS at runtime\n-  \/\/ are always archived\n+  \/\/ Some classes are used at CDS runtime but are not loaded, and therefore archived, at\n+  \/\/ dumptime. We can perform dummmy calls to these classes at dumptime to ensure they\n+  \/\/ are archived.\n+  exercise_runtime_cds_code(CHECK);\n+\n+  log_info(cds)(\"Loading classes to share: done.\");\n+}\n+\n+void MetaspaceShared::exercise_runtime_cds_code(TRAPS) {\n+  \/\/ Exercise the manifest processing code\n@@ -759,1 +767,2 @@\n-  log_info(cds)(\"Loading classes to share: done.\");\n+  \/\/ Exercise FileSystem and URL code\n+  CDSProtectionDomain::get_shared_jar_url_helper(\"dummy.jar\", Handle(), CHECK);\n@@ -802,10 +811,0 @@\n-  \/\/ Dummy call to load classes used at CDS runtime\n-  JavaValue result(T_OBJECT);\n-  Handle path_string = java_lang_String::create_from_str(\"dummy.jar\", CHECK);\n-  JavaCalls::call_static(&result,\n-                         vmClasses::jdk_internal_loader_ClassLoaders_klass(),\n-                         vmSymbols::toFileURL_name(),\n-                         vmSymbols::toFileURL_signature(),\n-                         path_string,\n-                         CHECK);\n-\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":12,"deletions":13,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -78,0 +78,1 @@\n+  static void exercise_runtime_cds_code(TRAPS) NOT_CDS_RETURN;\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2024, Oracle and\/or its affiliates. All rights reserved.\n","filename":"src\/hotspot\/share\/classfile\/vmClassMacros.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -57,2 +57,0 @@\n-runtime\/cds\/appcds\/DumpRuntimeClassesTest.java 8341452 generic-all\n-\n","filename":"test\/hotspot\/jtreg\/ProblemList-Xcomp.txt","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -30,0 +30,3 @@\n+ * @requires vm.compMode != \"Xcomp\"\n+ * @comment Running this test with -Xcomp may load other classes which\n+ *          are not used in other modes\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/DumpRuntimeClassesTest.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"}]}