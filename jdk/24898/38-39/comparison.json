{"files":[{"patch":"@@ -1946,2 +1946,1 @@\n-            \/\/ Use fp arithmetic to get an upper bound of the root\n-            long sLong = (long) nthRootUpper(Math.nextUp(x >= 0 ? x : x + 0x1p64), n);\n+            long sLong = (long) nthRootApprox(Math.nextUp(x >= 0 ? x : x + 0x1p64), n);\n@@ -1950,0 +1949,12 @@\n+                \/* The integer-valued recurrence formula in the algorithm of Brent&Zimmermann\n+                 * simply discards the fraction part of the real-valued Newton recurrence\n+                 * on the function f discussed in the referenced work.\n+                 * Indeed, for real x and integer n > 0, the equality ⌊x\/n⌋ == ⌊⌊x⌋\/n⌋ holds,\n+                 * from which the claim follows.\n+                 * As a consequence, an initial underestimate (not discussed in BZ)\n+                 * will immediately lead to a (weak) overestimate during the 1st iteration,\n+                 * thus meeting BZ requirements for termination and correctness.\n+                 *\/\n+                long sToN1 = BigInteger.unsignedLongPow(sLong, n - 1);\n+                sLong = ((n - 1) * sLong + Long.divideUnsigned(x, sToN1)) \/ n;\n+\n@@ -1951,1 +1962,1 @@\n-                long u = sLong, sToN1;\n+                long u = sLong;\n@@ -2006,1 +2017,1 @@\n-            double approx = nthRootUpper(rad, n);\n+            double approx = nthRootApprox(rad, n);\n@@ -2051,0 +2062,2 @@\n+        \/\/ Do the 1st iteration outside the loop to ensure an overestimate\n+        newtonRecurrenceNthRoot(this, s, n, s.toBigInteger().pow(n - 1));\n@@ -2063,4 +2076,2 @@\n-    private static double nthRootUpper(double x, int n) {\n-        return Math.nextUp(n == 3\n-                ? Math.cbrt(x)\n-                : Math.exp(Math.nextUp(Math.nextUp(Math.log(x)) \/ n)));\n+    private static double nthRootApprox(double x, int n) {\n+        return Math.nextUp(n == 3 ? Math.cbrt(x) : Math.pow(x, Math.nextUp(1.0 \/ n)));\n","filename":"src\/java.base\/share\/classes\/java\/math\/MutableBigInteger.java","additions":19,"deletions":8,"binary":false,"changes":27,"status":"modified"}]}