{"files":[{"patch":"@@ -32,10 +32,0 @@\n-OS=`uname -s`\n-case \"$OS\" in\n-  Windows* | CYGWIN* )\n-    ;;\n-  * )\n-    echo \"Cannot run a Windows-specific test on $OS\"\n-    exit 1\n-    ;;\n-esac\n-\n@@ -63,1 +53,1 @@\n-JAVAC=\"${TESTJAVA}\/bin\/javac\"\n+javac=\"${TESTJAVA}\/bin\/javac\"\n@@ -65,4 +55,4 @@\n-SRCFILEBASE=GetAvailableProcessors\n-SRCFILE=\"${TESTSRC}\/$SRCFILEBASE.java\"\n-LOGFILE=\"${TESTCLASSES}\/$SRCFILEBASE.output.log\"\n-$JAVAC ${TESTJAVACOPTS} ${TESTTOOLVMOPTS} -d ${TESTCLASSES} $SRCFILE\n+src_file_base=GetAvailableProcessors\n+src_file=\"${TESTSRC}\/$src_file_base.java\"\n+log_file=\"${TESTCLASSES}\/$src_file_base.output.log\"\n+$javac ${TESTJAVACOPTS} ${TESTTOOLVMOPTS} -d ${TESTCLASSES} $src_file\n@@ -72,1 +62,1 @@\n-  echo \"Compilation failed: $SRCFILE\";\n+  echo \"Compilation failed: $src_file\";\n@@ -76,4 +66,4 @@\n-# Write SYSTEM_INFO.dwNumberOfProcessors to a log file\n-GETPROCINFONAME=GetProcessorInfo\n-GETPROCINFOLOG=\"${TESTCLASSES}\/$GETPROCINFONAME.output.log\"\n-${TESTNATIVEPATH}\/$GETPROCINFONAME > $GETPROCINFOLOG 2>&1\n+# Write processor information from Windows APIs to a log file\n+get_proc_info_name=GetProcessorInfo\n+get_proc_info_log=\"${TESTCLASSES}\/$get_proc_info_name.output.log\"\n+${TESTNATIVEPATH}\/$get_proc_info_name > $get_proc_info_log 2>&1\n@@ -83,1 +73,1 @@\n-grep -Po \"$unsupported_os_regex\" $GETPROCINFOLOG\n+grep -Po \"$unsupported_os_regex\" $get_proc_info_log\n@@ -91,1 +81,1 @@\n-grep -Po \"$processor_info_regex\" $GETPROCINFOLOG\n+grep -Po \"$processor_info_regex\" $get_proc_info_log\n@@ -94,1 +84,1 @@\n-  echo \"TESTBUG: $GETPROCINFONAME did not output a processor count.\";\n+  echo \"TESTBUG: $get_proc_info_name did not output a processor count.\";\n@@ -99,3 +89,3 @@\n-NATIVEPROCS=\"${TESTCLASSES}\/processor_count_native.log\"\n-grep -Po \"$processor_info_regex\" $GETPROCINFOLOG   | sed -e 's\/[a-zA-Z: \\.]\/\/g' > $NATIVEPROCS 2>&1\n-group_processor_counts_str=$(<$NATIVEPROCS)\n+native_procs=\"${TESTCLASSES}\/processor_count_native.log\"\n+grep -Po \"$processor_info_regex\" $get_proc_info_log   | sed -e 's\/[a-zA-Z: \\.]\/\/g' > $native_procs 2>&1\n+group_processor_counts_str=$(<$native_procs)\n@@ -107,1 +97,1 @@\n-let dwNumberOfProcessors=64\n+let num_processors=64\n@@ -111,2 +101,2 @@\n-  if [ $group_processor_count -lt $dwNumberOfProcessors ]; then\n-    dwNumberOfProcessors=$group_processor_count\n+  if [ $group_processor_count -lt $num_processors ]; then\n+    num_processors=$group_processor_count\n@@ -116,2 +106,2 @@\n-if [ $dwNumberOfProcessors -le 0 ]; then\n-  echo \"Test failed: $GETPROCINFONAME did not output a valid processor count.\";\n+if [ $num_processors -le 0 ]; then\n+  echo \"Test failed: $get_proc_info_name did not output a valid processor count.\";\n@@ -121,2 +111,2 @@\n-if [ $dwNumberOfProcessors -gt 64 ]; then\n-  echo \"Test failed: $GETPROCINFONAME returned an invalid processor count.\";\n+if [ $num_processors -gt 64 ]; then\n+  echo \"Test failed: $get_proc_info_name returned an invalid processor count.\";\n@@ -126,2 +116,2 @@\n-if [ $dwNumberOfProcessors -lt 64 ]; then\n-  let affinity=$((1 << dwNumberOfProcessors))-1\n+if [ $num_processors -lt 64 ]; then\n+  let affinity=$((1 << num_processors))-1\n@@ -134,2 +124,2 @@\n-javaCmdLine=\"${TESTJAVA}\/bin\/java -XX:+UseAllWindowsProcessorGroups ${TESTVMOPTS} -cp ${TESTCLASSES} $SRCFILEBASE\"\n-commandLine=\"start \/wait \/b \/affinity $affinity $javaCmdLine > $LOGFILE\"\n+java_cmd_line=\"${TESTJAVA}\/bin\/java -XX:+UseAllWindowsProcessorGroups ${TESTVMOPTS} -cp ${TESTCLASSES} $src_file_base\"\n+cmd_line=\"start \/wait \/b \/affinity $affinity $java_cmd_line > $log_file\"\n@@ -137,2 +127,2 @@\n-echo \"Executing: $commandLine\"\n-cmd \/c $commandLine\n+echo \"Executing: $cmd_line\"\n+cmd \/c $cmd_line\n@@ -141,1 +131,1 @@\n-  echo \"Test FAILED: $SRCFILE\";\n+  echo \"Test FAILED: $src_file\";\n@@ -147,1 +137,1 @@\n-grep -Po \"$available_processors_regex\" $LOGFILE\n+grep -Po \"$available_processors_regex\" $log_file\n@@ -150,1 +140,1 @@\n-  echo \"TESTBUG: $SRCFILE did not output a processor count.\";\n+  echo \"TESTBUG: $src_file did not output a processor count.\";\n@@ -155,3 +145,3 @@\n-JAVAPROCS=\"${TESTCLASSES}\/processor_count_java.log\"\n-grep -Po \"$available_processors_regex\" $LOGFILE | sed -e 's\/[a-zA-Z: \\.]\/\/g' > $JAVAPROCS 2>&1\n-runtimeAvailableProcessors=$(<$JAVAPROCS)\n+java_procs_log=\"${TESTCLASSES}\/processor_count_java.log\"\n+grep -Po \"$available_processors_regex\" $log_file | sed -e 's\/[a-zA-Z: \\.]\/\/g' > $java_procs_log 2>&1\n+java_runtime_processors=$(<$java_procs_log)\n@@ -161,5 +151,2 @@\n-echo \"java.lang.Runtime.availableProcessors: $runtimeAvailableProcessors\"\n-echo \"SYSTEM_INFO.dwNumberOfProcessors:      $dwNumberOfProcessors\"\n-\n-if [ \"$runtimeAvailableProcessors\" != \"$dwNumberOfProcessors\" ]; then\n-  echo \"Test failed: Runtime.availableProcessors ($runtimeAvailableProcessors) != dwNumberOfProcessors ($dwNumberOfProcessors)\"\n+if [ \"$java_runtime_processors\" != \"$num_processors\" ]; then\n+  echo \"Test failed: Runtime.availableProcessors ($java_runtime_processors) != Processor count in smallest group ($num_processors)\"\n","filename":"test\/hotspot\/jtreg\/runtime\/6942632\/GetAvailableProcessors.sh","additions":37,"deletions":50,"binary":false,"changes":87,"status":"modified"}]}