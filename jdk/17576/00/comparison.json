{"files":[{"patch":"@@ -79,0 +79,1 @@\n+#include \"utilities\/population_count.hpp\"\n@@ -870,0 +871,21 @@\n+  \/\/ Starting with Windows 11 and Windows Server 2022, the OS has changed to\n+  \/\/ make processes and their threads span all processors in the system,\n+  \/\/ across all processor groups, by default. Therefore, we will allow all\n+  \/\/ processors to be active processors on these operating systems. However,\n+  \/\/ job objects can be used to restrict processor affinity across the\n+  \/\/ processor groups. In this case, the number of active processors must be\n+  \/\/ obtained from the processor affinity in the job object.\n+  bool schedules_all_processor_groups = win32::is_windows_11_or_greater() || win32::is_windows_server_2022_or_greater();\n+  if (schedules_all_processor_groups) {\n+    DWORD processors_in_job_object = win32::active_processors_in_job_object();\n+\n+    if (processors_in_job_object > 0) {\n+      return processors_in_job_object;\n+    }\n+  }\n+\n+  DWORD logical_processors = 0;\n+  SYSTEM_INFO si;\n+  GetSystemInfo(&si);\n+\n+  \/\/ There is no associated job object so get the number of available logical processors from the process affinity mask\n@@ -872,10 +894,7 @@\n-  int proc_count = processor_count();\n-  if (proc_count <= sizeof(UINT_PTR) * BitsPerByte &&\n-      GetProcessAffinityMask(GetCurrentProcess(), &lpProcessAffinityMask, &lpSystemAffinityMask)) {\n-    \/\/ Nof active processors is number of bits in process affinity mask\n-    int bitcount = 0;\n-    while (lpProcessAffinityMask != 0) {\n-      lpProcessAffinityMask = lpProcessAffinityMask & (lpProcessAffinityMask-1);\n-      bitcount++;\n-    }\n-    return bitcount;\n+  if (GetProcessAffinityMask(GetCurrentProcess(), &lpProcessAffinityMask, &lpSystemAffinityMask)) {\n+    logical_processors = population_count(lpProcessAffinityMask);\n+\n+    if (logical_processors < si.dwNumberOfProcessors) {\n+      \/\/ Respect the custom processor affinity since it is not equal to all processors in the current processor group\n+      return logical_processors;\n+    }\n@@ -883,1 +902,1 @@\n-    return proc_count;\n+    warning(\"GetProcessAffinityMask() failed: GetLastError->%ld.\", GetLastError());\n@@ -885,0 +904,15 @@\n+\n+  \/\/ There are no processor affinity restrictions at this point so we can return\n+  \/\/ the overall processor count if the OS automatically schedules threads across\n+  \/\/ all processors on the system. Note that older operating systems can\n+  \/\/ correctly report processor count but will not schedule threads across\n+  \/\/ processor groups unless the application explicitly uses group affinity APIs\n+  \/\/ to assign threads to processor groups. On these older operating systems, we\n+  \/\/ will continue to use the dwNumberOfProcessors field. For details on the\n+  \/\/ latest Windows scheduling behavior, see\n+  \/\/ https:\/\/learn.microsoft.com\/en-us\/windows\/win32\/procthread\/processor-groups#behavior-starting-with-windows-11-and-windows-server-2022\n+  if (schedules_all_processor_groups) {\n+    logical_processors = processor_count();\n+  }\n+\n+  return logical_processors == 0 ? si.dwNumberOfProcessors : logical_processors;\n@@ -1773,4 +1807,0 @@\n-  VS_FIXEDFILEINFO *file_info;\n-  TCHAR kernel32_path[MAX_PATH];\n-  UINT len, ret;\n-\n@@ -1779,38 +1809,4 @@\n-  \/\/ Get the full path to \\Windows\\System32\\kernel32.dll and use that for\n-  \/\/ determining what version of Windows we're running on.\n-  len = MAX_PATH - (UINT)strlen(\"\\\\kernel32.dll\") - 1;\n-  ret = GetSystemDirectory(kernel32_path, len);\n-  if (ret == 0 || ret > len) {\n-    st->print_cr(\"Call to GetSystemDirectory failed\");\n-    return;\n-  }\n-  strncat(kernel32_path, \"\\\\kernel32.dll\", MAX_PATH - ret);\n-\n-  DWORD version_size = GetFileVersionInfoSize(kernel32_path, nullptr);\n-  if (version_size == 0) {\n-    st->print_cr(\"Call to GetFileVersionInfoSize failed\");\n-    return;\n-  }\n-\n-  LPTSTR version_info = (LPTSTR)os::malloc(version_size, mtInternal);\n-  if (version_info == nullptr) {\n-    st->print_cr(\"Failed to allocate version_info\");\n-    return;\n-  }\n-\n-  if (!GetFileVersionInfo(kernel32_path, 0, version_size, version_info)) {\n-    os::free(version_info);\n-    st->print_cr(\"Call to GetFileVersionInfo failed\");\n-    return;\n-  }\n-\n-  if (!VerQueryValue(version_info, TEXT(\"\\\\\"), (LPVOID*)&file_info, &len)) {\n-    os::free(version_info);\n-    st->print_cr(\"Call to VerQueryValue failed\");\n-    return;\n-  }\n-\n-  int major_version = HIWORD(file_info->dwProductVersionMS);\n-  int minor_version = LOWORD(file_info->dwProductVersionMS);\n-  int build_number = HIWORD(file_info->dwProductVersionLS);\n-  int build_minor = LOWORD(file_info->dwProductVersionLS);\n+  int major_version = windows_major_version();\n+  int minor_version = windows_minor_version();\n+  int build_number = windows_build_number();\n+  int build_minor = windows_build_minor();\n@@ -1818,1 +1814,0 @@\n-  os::free(version_info);\n@@ -1914,0 +1909,6 @@\n+\n+    \/\/ This is the number of logical processors in the current processor group only and is therefore\n+    \/\/ at most 64. The GetLogicalProcessorInformation function is used to compute the total number\n+    \/\/ of processors. However, it requires memory to be allocated for the processor information buffer.\n+    \/\/ Since this method is used in paths where memory allocation should not be done (i.e. after a crash),\n+    \/\/ only the number of processors in the current group will be returned.\n@@ -3981,0 +3982,163 @@\n+int    os::win32::_major_version             = 0;\n+int    os::win32::_minor_version             = 0;\n+int    os::win32::_build_number              = 0;\n+int    os::win32::_build_minor               = 0;\n+\n+void os::win32::initialize_windows_version() {\n+  if (_major_version > 0) {\n+    return; \/\/ nothing to do if the version has already been set\n+  }\n+\n+  VS_FIXEDFILEINFO *file_info;\n+  TCHAR kernel32_path[MAX_PATH];\n+  UINT len, ret;\n+\n+  bool is_workstation = !IsWindowsServer();\n+\n+  \/\/ Get the full path to \\Windows\\System32\\kernel32.dll and use that for\n+  \/\/ determining what version of Windows we're running on.\n+  len = MAX_PATH - (UINT)strlen(\"\\\\kernel32.dll\") - 1;\n+  ret = GetSystemDirectory(kernel32_path, len);\n+  if (ret == 0 || ret > len) {\n+    warning(\"GetSystemDirectory() failed: GetLastError->%ld.\", GetLastError());\n+    return;\n+  }\n+  strncat(kernel32_path, \"\\\\kernel32.dll\", MAX_PATH - ret);\n+\n+  DWORD version_size = GetFileVersionInfoSize(kernel32_path, nullptr);\n+  if (version_size == 0) {\n+    warning(\"GetFileVersionInfoSize() failed: GetLastError->%ld.\", GetLastError());\n+    return;\n+  }\n+\n+  LPTSTR version_info = (LPTSTR)os::malloc(version_size, mtInternal);\n+  if (version_info == nullptr) {\n+    warning(\"os::malloc() failed to allocate %ld bytes for GetFileVersionInfo buffer\", version_size);\n+    return;\n+  }\n+\n+  if (!GetFileVersionInfo(kernel32_path, 0, version_size, version_info)) {\n+    os::free(version_info);\n+    warning(\"GetFileVersionInfo() failed: GetLastError->%ld.\", GetLastError());\n+    return;\n+  }\n+\n+  if (!VerQueryValue(version_info, TEXT(\"\\\\\"), (LPVOID*)&file_info, &len)) {\n+    os::free(version_info);\n+    warning(\"VerQueryValue() failed. Cannot determine Windows version.\");\n+    return;\n+  }\n+\n+  _major_version = HIWORD(file_info->dwProductVersionMS);\n+  _minor_version = LOWORD(file_info->dwProductVersionMS);\n+  _build_number  = HIWORD(file_info->dwProductVersionLS);\n+  _build_minor   = LOWORD(file_info->dwProductVersionLS);\n+}\n+\n+bool os::win32::is_windows_11_or_greater() {\n+  \/\/ Windows 11 starts at build 22000 (Version 21H2) as per\n+  \/\/ https:\/\/learn.microsoft.com\/en-us\/windows\/release-health\/windows11-release-information\n+  return (windows_major_version() >= 10 && windows_build_number() >= 22000 && !IsWindowsServer());\n+}\n+\n+bool os::win32::is_windows_server_2022_or_greater() {\n+  \/\/ Windows Server 2022 starts at build 20348.169 as per\n+  \/\/ https:\/\/learn.microsoft.com\/en-us\/windows\/release-health\/release-information\n+  return (windows_major_version() >= 10 && windows_build_number() >= 20348 && IsWindowsServer());\n+}\n+\n+DWORD os::win32::active_processors_in_job_object() {\n+  BOOL is_in_job_object = false;\n+  if (!IsProcessInJob(GetCurrentProcess(), nullptr, &is_in_job_object)) {\n+    warning(\"IsProcessInJob() failed: GetLastError->%ld.\", GetLastError());\n+    return 0;\n+  }\n+\n+  if (!is_in_job_object) {\n+    return 0;\n+  }\n+\n+  DWORD processors = 0;\n+\n+  LPVOID job_object_information = nullptr;\n+  DWORD job_object_information_length = 0;\n+\n+  if (!QueryInformationJobObject(nullptr, JobObjectGroupInformationEx, nullptr, 0, &job_object_information_length)) {\n+    DWORD last_error = GetLastError();\n+    if (last_error == ERROR_INSUFFICIENT_BUFFER) {\n+      DWORD group_count = job_object_information_length \/ sizeof(GROUP_AFFINITY);\n+\n+      job_object_information = os::malloc(job_object_information_length, mtInternal);\n+      if (job_object_information != nullptr) {\n+          if (QueryInformationJobObject(nullptr, JobObjectGroupInformationEx, job_object_information, job_object_information_length, &job_object_information_length)) {\n+            assert(group_count == job_object_information_length \/ sizeof(GROUP_AFFINITY), \"Unexpected group count\");\n+\n+            for (DWORD i = 0; i < group_count; i++) {\n+              KAFFINITY group_affinity = ((GROUP_AFFINITY*)job_object_information)[i].Mask;\n+              processors += population_count(group_affinity);\n+            }\n+\n+            assert(processors > 0, \"Must find at least 1 logical processor\");\n+          } else {\n+            warning(\"QueryInformationJobObject() failed: GetLastError->%ld.\", GetLastError());\n+          }\n+\n+          os::free(job_object_information);\n+      } else {\n+          warning(\"os::malloc() failed to allocate %ld bytes for QueryInformationJobObject\", job_object_information_length);\n+      }\n+    }\n+  }\n+\n+  return processors;\n+}\n+\n+DWORD os::win32::system_logical_processor_count() {\n+  DWORD logical_processors = 0;\n+  typedef BOOL(WINAPI* LPFN_GET_LOGICAL_PROCESSOR_INFORMATION_EX)(\n+      LOGICAL_PROCESSOR_RELATIONSHIP, PSYSTEM_LOGICAL_PROCESSOR_INFORMATION_EX, PDWORD);\n+\n+  LPFN_GET_LOGICAL_PROCESSOR_INFORMATION_EX glpiex;\n+\n+  glpiex = (LPFN_GET_LOGICAL_PROCESSOR_INFORMATION_EX)GetProcAddress(\n+      GetModuleHandle(TEXT(\"kernel32\")),\n+      \"GetLogicalProcessorInformationEx\");\n+\n+  if (glpiex != nullptr) {\n+    LOGICAL_PROCESSOR_RELATIONSHIP relationship_type = RelationGroup;\n+    PSYSTEM_LOGICAL_PROCESSOR_INFORMATION_EX system_logical_processor_info = nullptr;\n+    DWORD returned_length = 0;\n+\n+    \/\/ https:\/\/learn.microsoft.com\/en-us\/windows\/win32\/api\/sysinfoapi\/nf-sysinfoapi-getlogicalprocessorinformationex\n+    if (!glpiex(relationship_type, nullptr, &returned_length)) {\n+      DWORD last_error = GetLastError();\n+\n+      if (last_error == ERROR_INSUFFICIENT_BUFFER) {\n+        system_logical_processor_info = (PSYSTEM_LOGICAL_PROCESSOR_INFORMATION_EX)os::malloc(returned_length, mtInternal);\n+\n+        if (nullptr == system_logical_processor_info) {\n+          warning(\"os::malloc() failed to allocate %ld bytes for GetLogicalProcessorInformationEx buffer\", returned_length);\n+        } else if (!glpiex(relationship_type, system_logical_processor_info, &returned_length)) {\n+          warning(\"GetLogicalProcessorInformationEx() failed: GetLastError->%ld.\", GetLastError());\n+        } else {\n+          DWORD processor_groups = system_logical_processor_info->Group.ActiveGroupCount;\n+\n+          for (DWORD i = 0; i < processor_groups; i++) {\n+            PROCESSOR_GROUP_INFO group_info = system_logical_processor_info->Group.GroupInfo[i];\n+            logical_processors += group_info.ActiveProcessorCount;\n+          }\n+\n+          assert(logical_processors > 0, \"Must find at least 1 logical processor\");\n+        }\n+\n+        os::free(system_logical_processor_info);\n+      }\n+      else {\n+        warning(\"GetLogicalProcessorInformationEx() failed: GetLastError->%ld.\", last_error);\n+      }\n+    }\n+  }\n+\n+  return logical_processors;\n+}\n+\n@@ -3982,0 +4146,2 @@\n+  initialize_windows_version();\n+\n@@ -3988,1 +4154,8 @@\n-  set_processor_count(si.dwNumberOfProcessors);\n+\n+  DWORD processors = 0;\n+  bool schedules_all_processor_groups = win32::is_windows_11_or_greater() || win32::is_windows_server_2022_or_greater();\n+  if (schedules_all_processor_groups) {\n+    processors = system_logical_processor_count();\n+  }\n+\n+  set_processor_count(processors > 0 ? processors : si.dwNumberOfProcessors);\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":228,"deletions":55,"binary":false,"changes":283,"status":"modified"},{"patch":"@@ -47,0 +47,5 @@\n+  static int    _major_version;\n+  static int    _minor_version;\n+  static int    _build_number;\n+  static int    _build_minor;\n+\n@@ -59,0 +64,19 @@\n+  static bool   is_windows_11_or_greater();\n+  static bool   is_windows_server_2022_or_greater();\n+  static DWORD  system_logical_processor_count();\n+  static int windows_major_version() {\n+    initialize_windows_version();\n+    return _major_version;\n+  }\n+  static int windows_minor_version() {\n+    initialize_windows_version();\n+    return _minor_version;\n+  }\n+  static int windows_build_number() {\n+    initialize_windows_version();\n+    return _build_number;\n+  }\n+  static int windows_build_minor() {\n+    initialize_windows_version();\n+    return _build_minor;\n+  }\n@@ -75,0 +99,2 @@\n+  static void initialize_windows_version();\n+  static DWORD active_processors_in_job_object();\n","filename":"src\/hotspot\/os\/windows\/os_windows.hpp","additions":26,"deletions":0,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -706,0 +706,16 @@\n+TEST_VM(os_windows, processor_count) {\n+  int processors = os::processor_count();\n+  EXPECT_GT(processors, 0) << \"Expected at least 1 processor\";\n+\n+  int active_processors = os::active_processor_count();\n+  EXPECT_GT(active_processors, 0) << \"Expected at least 1 active processor\";\n+\n+  bool schedules_all_processor_groups = os::win32::is_windows_11_or_greater() || os::win32::is_windows_server_2022_or_greater();\n+  if (schedules_all_processor_groups) {\n+    EXPECT_EQ(active_processors, processors) << \"Expected all processors to be active\";\n+  } else {\n+    \/\/ active_processors should be at most the number of processors in 1 Windows processor group.\n+    EXPECT_LE(active_processors, processors) << \"Expected active processors to not exceed available processors\";\n+  }\n+}\n+\n","filename":"test\/hotspot\/gtest\/runtime\/test_os_windows.cpp","additions":16,"deletions":0,"binary":false,"changes":16,"status":"modified"}]}