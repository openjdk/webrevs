{"files":[{"patch":"@@ -177,0 +177,1 @@\n+  _cur_distribute_log_buffers_time_ms = 0.0;\n@@ -462,0 +463,1 @@\n+  debug_time(\"Distribute Log Buffers\", _cur_distribute_log_buffers_time_ms);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1GCPhaseTimes.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -184,0 +184,2 @@\n+  double _cur_distribute_log_buffers_time_ms;\n+\n@@ -307,0 +309,4 @@\n+  void record_distribute_log_buffers_time_ms(double ms) {\n+    _cur_distribute_log_buffers_time_ms += ms;\n+  }\n+\n@@ -379,0 +385,4 @@\n+  double cur_distribute_log_buffers_time_ms() {\n+    return _cur_distribute_log_buffers_time_ms;\n+  }\n+\n","filename":"src\/hotspot\/share\/gc\/g1\/g1GCPhaseTimes.hpp","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -786,1 +786,3 @@\n-    return all_cards_processing_time + average_time_ms(G1GCPhaseTimes::MergeLB);\n+    return all_cards_processing_time +\n+           average_time_ms(G1GCPhaseTimes::MergeLB) +\n+           phase_times()->cur_distribute_log_buffers_time_ms();\n@@ -788,1 +790,3 @@\n-  return (all_cards_processing_time * logged_dirty_cards \/ scan_heap_roots_cards) + average_time_ms(G1GCPhaseTimes::MergeLB);\n+  return (all_cards_processing_time * logged_dirty_cards \/ scan_heap_roots_cards) +\n+         average_time_ms(G1GCPhaseTimes::MergeLB) +\n+         phase_times()->cur_distribute_log_buffers_time_ms();\n@@ -877,0 +881,1 @@\n+                                    p->cur_distribute_log_buffers_time_ms() +\n","filename":"src\/hotspot\/share\/gc\/g1\/g1Policy.cpp","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -1261,1 +1261,1 @@\n-  HeapRegionClaimer _hr_claimer;\n+  uint _num_workers;\n@@ -1263,1 +1263,1 @@\n-  BufferNode::Stack _dirty_card_buffers;\n+  BufferNode::Stack* _dirty_card_buffers;\n@@ -1270,3 +1270,6 @@\n-    while (BufferNode* node = _dirty_card_buffers.pop()) {\n-      cl->apply_to_buffer(node, worker_id);\n-      dcqs.deallocate_buffer(node);\n+    for (uint i = 0; i < _num_workers; i++) {\n+      uint index = (worker_id + i) % _num_workers;\n+      while (BufferNode* node = _dirty_card_buffers[index].pop()) {\n+        cl->apply_to_buffer(node, worker_id);\n+        dcqs.deallocate_buffer(node);\n+      }\n@@ -1279,1 +1282,1 @@\n-    _hr_claimer(num_workers),\n+    _num_workers(num_workers),\n@@ -1281,1 +1284,1 @@\n-    _dirty_card_buffers(),\n+    _dirty_card_buffers(nullptr),\n@@ -1286,0 +1289,8 @@\n+      Ticks start = Ticks::now();\n+\n+      _dirty_card_buffers = NEW_C_HEAP_ARRAY(BufferNode::Stack, num_workers, mtGC);\n+      for (uint i = 0; i < num_workers; i++)\n+      {\n+        new (&_dirty_card_buffers[i]) BufferNode::Stack();\n+      }\n+\n@@ -1288,2 +1299,8 @@\n-      if (buffers._entry_count != 0) {\n-        _dirty_card_buffers.prepend(*buffers._head, *buffers._tail);\n+      BufferNode* cur = buffers._head;\n+\n+      uint worker = 0;\n+      while (cur != nullptr) {\n+        BufferNode* next = cur->next();\n+        cur->set_next(nullptr);\n+        _dirty_card_buffers[worker++ % num_workers].push(*cur);\n+        cur = next;\n@@ -1291,0 +1308,3 @@\n+\n+      Tickspan total = Ticks::now() - start;\n+      G1CollectedHeap::heap()->phase_times()->record_distribute_log_buffers_time_ms(total.seconds() * 1000.0);\n@@ -1294,0 +1314,5 @@\n+  ~G1MergeHeapRootsTask() {\n+    if (_dirty_card_buffers != nullptr) {\n+      FREE_C_HEAP_ARRAY(BufferNode::Stack, _dirty_card_buffers);\n+    }\n+  }\n","filename":"src\/hotspot\/share\/gc\/g1\/g1RemSet.cpp","additions":34,"deletions":9,"binary":false,"changes":43,"status":"modified"}]}