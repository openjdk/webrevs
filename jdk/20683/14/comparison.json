{"files":[{"patch":"@@ -1296,1 +1296,1 @@\n-  char* rp = os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen);\n+  char* rp = os::realpath((char *)dlinfo.dli_fname, buf, buflen);\n@@ -1327,1 +1327,1 @@\n-        rp = os::Posix::realpath(java_home_var, buf, buflen);\n+        rp = os::realpath(java_home_var, buf, buflen);\n@@ -1348,1 +1348,1 @@\n-          rp = os::Posix::realpath((char *)dlinfo.dli_fname, buf, buflen);\n+          rp = os::realpath((char *)dlinfo.dli_fname, buf, buflen);\n","filename":"src\/hotspot\/os\/aix\/os_aix.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -1512,1 +1512,1 @@\n-    rp = os::Posix::realpath(dli_fname, buf, buflen);\n+    rp = os::realpath(dli_fname, buf, buflen);\n@@ -1544,1 +1544,1 @@\n-        rp = os::Posix::realpath(java_home_var, buf, buflen);\n+        rp = os::realpath(java_home_var, buf, buflen);\n@@ -1578,1 +1578,1 @@\n-          rp = os::Posix::realpath(dli_fname, buf, buflen);\n+          rp = os::realpath(dli_fname, buf, buflen);\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2766,1 +2766,1 @@\n-    rp = os::Posix::realpath(dli_fname, buf, buflen);\n+    rp = os::realpath(dli_fname, buf, buflen);\n@@ -2800,1 +2800,1 @@\n-        rp = os::Posix::realpath(java_home_var, buf, buflen);\n+        rp = os::realpath(java_home_var, buf, buflen);\n@@ -2821,1 +2821,1 @@\n-          rp = os::Posix::realpath(dli_fname, buf, buflen);\n+          rp = os::realpath(dli_fname, buf, buflen);\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -792,1 +792,1 @@\n-  return os::Posix::realpath(buffer, _exePath, PATH_MAX);\n+  return os::realpath(buffer, _exePath, PATH_MAX);\n","filename":"src\/hotspot\/os\/linux\/os_perf_linux.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1027,1 +1027,1 @@\n-char* os::Posix::realpath(const char* filename, char* outbuf, size_t outbuflen) {\n+char* os::realpath(const char* filename, char* outbuf, size_t outbuflen) {\n@@ -1030,1 +1030,1 @@\n-    assert(false, \"os::Posix::realpath: invalid arguments.\");\n+    assert(false, \"os::realpath: invalid arguments.\");\n@@ -1065,1 +1065,0 @@\n-\n","filename":"src\/hotspot\/os\/posix\/os_posix.cpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -76,7 +76,0 @@\n-  \/\/ A safe implementation of realpath which will not cause a buffer overflow if the resolved path\n-  \/\/   is longer than PATH_MAX.\n-  \/\/ On success, returns 'outbuf', which now contains the path.\n-  \/\/ On error, it will return null and set errno. The content of 'outbuf' is undefined.\n-  \/\/ On truncation error ('outbuf' too small), it will return null and set errno to ENAMETOOLONG.\n-  static char* realpath(const char* filename, char* outbuf, size_t outbuflen);\n-\n","filename":"src\/hotspot\/os\/posix\/os_posix.hpp","additions":0,"deletions":7,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -5318,0 +5318,22 @@\n+char* os::realpath(const char* filename, char* outbuf, size_t outbuflen) {\n+\n+  if (filename == nullptr || outbuf == nullptr || outbuflen < 1) {\n+    assert(false, \"os::realpath: invalid arguments.\");\n+    errno = EINVAL;\n+    return nullptr;\n+  }\n+\n+  char* result = nullptr;\n+  ALLOW_C_FUNCTION(::_fullpath, char* p = ::_fullpath(nullptr, filename, 0);)\n+  if (p != nullptr) {\n+    if (strlen(p) < outbuflen) {\n+      strcpy(outbuf, p);\n+      result = outbuf;\n+    } else {\n+      errno = ENAMETOOLONG;\n+    }\n+    ALLOW_C_FUNCTION(::free, ::free(p);) \/\/ *not* os::free\n+  }\n+  return result;\n+}\n+\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":22,"deletions":0,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -671,0 +671,7 @@\n+  \/\/ A safe implementation of realpath which will not cause a buffer overflow if the resolved path\n+  \/\/ is longer than PATH_MAX.\n+  \/\/ On success, returns 'outbuf', which now contains the path.\n+  \/\/ On error, it will return null and set errno. The content of 'outbuf' is undefined.\n+  \/\/ On truncation error ('outbuf' too small), it will return null and set errno to ENAMETOOLONG.\n+  static char* realpath(const char* filename, char* outbuf, size_t outbuflen);\n+\n","filename":"src\/hotspot\/share\/runtime\/os.hpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -1205,1 +1205,0 @@\n-#ifndef _WIN64\n@@ -1208,1 +1207,1 @@\n-    const char* absname = os::Posix::realpath(name, tmp, sizeof(tmp));\n+    const char* absname = os::realpath(name, tmp, sizeof(tmp));\n@@ -1210,1 +1209,0 @@\n-#endif\n","filename":"src\/hotspot\/share\/services\/diagnosticCommand.cpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -213,1 +213,1 @@\n-FORBID_C_FUNCTION(char* realpath(const char* path, char* resolved_path), \"use os::Posix::realpath\");\n+FORBID_C_FUNCTION(char* realpath(const char* path, char* resolved_path), \"use os::realpath\");\n","filename":"src\/hotspot\/share\/utilities\/globalDefinitions.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -408,0 +408,78 @@\n+#ifndef MAX_PATH\n+#define MAX_PATH    (2 * K)\n+#endif\n+\n+TEST_VM(os, realpath) {\n+  \/* POSIX requires that the file exists, Windows doesn't *\/\n+  static const char* nosuchpath = \"\/1234567890123456789\";\n+  static const char* tmppath = \"\/tmp\";\n+\n+  char buffer[MAX_PATH];\n+\n+  \/* test a non-existant path, but provide a short buffer *\/\n+  errno = 0;\n+  const char* returnedBuffer = os::realpath(nosuchpath, buffer, sizeof(nosuchpath) - 2);\n+  \/* Returns ENOENT on Linux, ENAMETOOLONG on Windows *\/\n+  EXPECT_TRUE(returnedBuffer == nullptr);\n+#if defined(_WINDOWS)\n+  EXPECT_TRUE(errno == ENAMETOOLONG);\n+#else\n+  EXPECT_TRUE(errno == ENOENT);\n+#endif\n+\n+  \/* test a non-existant path, but provide an adequate buffer *\/\n+  errno = 0;\n+  returnedBuffer = os::realpath(nosuchpath, buffer, sizeof(nosuchpath) + 3);\n+  \/* Returns ENOENT on Linux, 0 on SOME versions of Windows *\/\n+#if defined(_WINDOWS)\n+  if (returnedBuffer != nullptr) {\n+    EXPECT_TRUE(returnedBuffer == buffer);\n+  } else {\n+    EXPECT_TRUE(errno != 0);\n+  }\n+#else\n+  EXPECT_TRUE(returnedBuffer == nullptr);\n+  EXPECT_TRUE(errno == ENOENT);\n+#endif\n+\n+  \/* test an existing path using a large buffer *\/\n+  errno = 0;\n+  returnedBuffer = os::realpath(tmppath, buffer, MAX_PATH);\n+  EXPECT_TRUE(returnedBuffer == buffer);\n+\n+  \/* test an existing path using a buffer that is too small on a normal macOS install *\/\n+  errno = 0;\n+  returnedBuffer = os::realpath(tmppath, buffer, strlen(tmppath) + 3);\n+  \/* on MacOS, \/tmp is a symlink to \/private\/tmp, so doesn't fit in a small buffer. *\/\n+#if !defined(__APPLE__)\n+  EXPECT_TRUE(returnedBuffer == buffer);\n+#else\n+  EXPECT_TRUE(returnedBuffer == nullptr);\n+  EXPECT_TRUE(errno == ENAMETOOLONG);\n+#endif\n+\n+  \/* test an existing path using a buffer that is too small *\/\n+  errno = 0;\n+  returnedBuffer = os::realpath(tmppath, buffer, strlen(tmppath) - 1);\n+  EXPECT_TRUE(returnedBuffer == nullptr);\n+  EXPECT_TRUE(errno == ENAMETOOLONG);\n+\n+  \/* the following tests cause an assert inside os::realpath() in fastdebug mode *\/\n+#ifndef ASSERT\n+  errno = 0;\n+  returnedBuffer = os::realpath(nullptr, buffer, sizeof(buffer));\n+  EXPECT_TRUE(returnedBuffer == nullptr);\n+  EXPECT_TRUE(errno == EINVAL);\n+\n+  errno = 0;\n+  returnedBuffer = os::realpath(tmppath, nullptr, sizeof(buffer));\n+  EXPECT_TRUE(returnedBuffer == nullptr);\n+  EXPECT_TRUE(errno == EINVAL);\n+\n+  errno = 0;\n+  returnedBuffer = os::realpath(tmppath, buffer, 0);\n+  EXPECT_TRUE(returnedBuffer == nullptr);\n+  EXPECT_TRUE(errno == EINVAL);\n+#endif\n+}\n+\n","filename":"test\/hotspot\/gtest\/runtime\/test_os.cpp","additions":78,"deletions":0,"binary":false,"changes":78,"status":"modified"},{"patch":"@@ -39,1 +39,1 @@\n- * @run testng\/othervm -XX:+UsePerfData SystemMapTest\n+ * @run testng\/othervm -XX:+UseZGC -XX:+UsePerfData SystemMapTest\n@@ -41,1 +41,1 @@\n-public class SystemMapTest extends SystemMapTestBase {\n+public class SystemMapZGCTest extends SystemMapTestBase {\n","filename":"test\/hotspot\/jtreg\/serviceability\/dcmd\/vm\/SystemMapZGCTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"previous_filename":"test\/hotspot\/jtreg\/serviceability\/dcmd\/vm\/SystemMapTest.java","status":"copied"}]}