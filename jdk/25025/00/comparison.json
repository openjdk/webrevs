{"files":[{"patch":"@@ -862,6 +862,5 @@\n-            int set = Stream.of(Objects.requireNonNull(capturedState))\n-                    .map(Objects::requireNonNull)\n-                    .map(CapturableState::forName)\n-                    .mapToInt(state -> 1 << state.ordinal())\n-                    .sum();\n-            return new LinkerOptions.CaptureCallState(set);\n+            int mask = 0;\n+            for (var state : capturedState) {\n+                mask |= CapturableState.forName(state).mask;\n+            }\n+            return new LinkerOptions.CaptureCallState(mask);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/foreign\/Linker.java","additions":5,"deletions":6,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -188,3 +188,1 @@\n-        return linkerOptions.capturedCallState()\n-                .mapToInt(CapturableState::mask)\n-                .reduce(0, (a, b) -> a | b);\n+        return linkerOptions.capturedCallStateMask();\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/abi\/CallingSequence.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,2 +33,2 @@\n-import java.util.List;\n-import java.util.stream.Collectors;\n+import java.util.ArrayList;\n+import java.util.Map;\n@@ -40,3 +40,3 @@\n-    GET_LAST_ERROR    (\"GetLastError\",    JAVA_INT, 1 << 0, OperatingSystem.isWindows()),\n-    WSA_GET_LAST_ERROR(\"WSAGetLastError\", JAVA_INT, 1 << 1, OperatingSystem.isWindows()),\n-    ERRNO             (\"errno\",           JAVA_INT, 1 << 2, true);\n+    GET_LAST_ERROR    (\"GetLastError\",    JAVA_INT, 1 << 0),\n+    WSA_GET_LAST_ERROR(\"WSAGetLastError\", JAVA_INT, 1 << 1),\n+    ERRNO             (\"errno\",           JAVA_INT, 1 << 2);\n@@ -44,3 +44,2 @@\n-    public static final StructLayout LAYOUT = MemoryLayout.structLayout(\n-        supportedStates().map(CapturableState::layout).toArray(MemoryLayout[]::new));\n-    public static final List<CapturableState> BY_ORDINAL = List.of(values());\n+    public static final StructLayout LAYOUT;\n+    public static final Map<String, CapturableState> SUPPORTED;\n@@ -49,1 +48,16 @@\n-        assert (BY_ORDINAL.size() < Integer.SIZE); \/\/ Update LinkerOptions.CaptureCallState\n+        var values = values();\n+\n+        if (OperatingSystem.isWindows()) {\n+            SUPPORTED = Map.of(GET_LAST_ERROR.stateName, GET_LAST_ERROR,\n+                               WSA_GET_LAST_ERROR.stateName, WSA_GET_LAST_ERROR,\n+                               ERRNO.stateName, ERRNO);\n+        } else {\n+            SUPPORTED = Map.of(ERRNO.stateName, ERRNO);\n+        }\n+\n+        MemoryLayout[] stateLayouts = new MemoryLayout[SUPPORTED.size()];\n+        int i = 0;\n+        for (var supported : SUPPORTED.values()) {\n+            stateLayouts[i++] = supported.layout;\n+        }\n+        LAYOUT = MemoryLayout.structLayout(stateLayouts);\n@@ -52,4 +66,3 @@\n-    private final String stateName;\n-    private final ValueLayout layout;\n-    private final int mask;\n-    private final boolean isSupported;\n+    public final String stateName;\n+    public final ValueLayout layout;\n+    public final int mask;\n@@ -57,1 +70,1 @@\n-    CapturableState(String stateName, ValueLayout layout, int mask, boolean isSupported) {\n+    CapturableState(String stateName, ValueLayout layout, int mask) {\n@@ -61,5 +74,0 @@\n-        this.isSupported = isSupported;\n-    }\n-\n-    private static Stream<CapturableState> supportedStates() {\n-        return Stream.of(values()).filter(CapturableState::isSupported);\n@@ -69,21 +77,7 @@\n-        return Stream.of(values())\n-                .filter(stl -> stl.stateName().equals(name))\n-                .filter(CapturableState::isSupported)\n-                .findAny()\n-                .orElseThrow(() -> new IllegalArgumentException(\n-                        \"Unknown name: \" + name +\", must be one of: \"\n-                            + supportedStates()\n-                                    .map(CapturableState::stateName)\n-                                    .collect(Collectors.joining(\", \"))));\n-    }\n-\n-    public String stateName() {\n-        return stateName;\n-    }\n-\n-    public ValueLayout layout() {\n-        return layout;\n-    }\n-\n-    public int mask() {\n-        return mask;\n+        var ret = SUPPORTED.get(name);\n+        if (ret == null) {\n+            throw new IllegalArgumentException(\n+                    \"Unknown name: \" + name +\", must be one of: \"\n+                            + SUPPORTED.keySet());\n+        }\n+        return ret;\n@@ -92,2 +86,12 @@\n-    public boolean isSupported() {\n-        return isSupported;\n+    \/**\n+     * Returns a list-like display string for a captured state mask.\n+     * Enclosed with brackets.\n+     *\/\n+    public static String displayString(int mask) {\n+        var displayList = new ArrayList<>();\n+        for (var e : SUPPORTED.values()) {\n+            if ((mask & e.mask) != 0) {\n+                displayList.add(e.stateName);\n+            }\n+        }\n+        return displayList.toString();\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/abi\/CapturableState.java","additions":47,"deletions":43,"binary":false,"changes":90,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2022, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2022, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -87,1 +87,1 @@\n-    public Stream<CapturableState> capturedCallState() {\n+    public int capturedCallStateMask() {\n@@ -89,1 +89,1 @@\n-        return stl == null ? Stream.empty() : stl.saved().stream();\n+        return stl == null ? 0 : stl.mask();\n@@ -153,1 +153,1 @@\n-    public record CaptureCallState(int compact) implements LinkerOptionImpl {\n+    public record CaptureCallState(int mask) implements LinkerOptionImpl {\n@@ -159,15 +159,0 @@\n-        public Set<CapturableState> saved() {\n-            var set = EnumSet.noneOf(CapturableState.class);\n-            int mask = compact;\n-            int i = 0;\n-            while (mask != 0) {\n-                if ((mask & 1) == 1) {\n-                    set.add(CapturableState.BY_ORDINAL.get(i));\n-                }\n-                mask >>= 1;\n-                i++;\n-            }\n-            return set;\n-        }\n-\n-\n@@ -176,1 +161,1 @@\n-            return obj instanceof CaptureCallState that && compact == that.compact;\n+            return obj instanceof CaptureCallState that && mask == that.mask;\n@@ -181,1 +166,6 @@\n-            return compact;\n+            return mask;\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return \"CaptureCallState\" + CapturableState.displayString(mask);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/abi\/LinkerOptions.java","additions":11,"deletions":21,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -87,3 +87,1 @@\n-        int capturedStateMask = options.capturedCallState()\n-                .mapToInt(CapturableState::mask)\n-                .reduce(0, (a, b) -> a | b);\n+        int capturedStateMask = options.capturedCallStateMask();\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/abi\/fallback\/FallbackLinker.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,0 +30,1 @@\n+import jdk.internal.vm.annotation.Stable;\n@@ -87,1 +88,1 @@\n-    private static final OperatingSystem CURRENT_OS = initOS();\n+    private static @Stable OperatingSystem CURRENT_OS;\n@@ -125,1 +126,5 @@\n-        return CURRENT_OS;\n+        var current = CURRENT_OS;\n+        if (current == null) {\n+            return CURRENT_OS = initOS();\n+        }\n+        return current;\n@@ -134,0 +139,1 @@\n+        \/\/ Called lazily, valueOf has overhead\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/util\/OperatingSystem.java","additions":9,"deletions":3,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+ * @bug 8356126\n@@ -50,2 +51,1 @@\n-import static org.testng.Assert.assertEquals;\n-import static org.testng.Assert.assertTrue;\n+import static org.testng.Assert.*;\n@@ -64,0 +64,11 @@\n+    \/\/ Basic sanity tests around Java API contracts\n+    @Test\n+    public void testApiContracts() {\n+        assertThrows(IllegalArgumentException.class, () -> Linker.Option.captureCallState(\"Does not exist\"));\n+        var duplicateOpt = Linker.Option.captureCallState(\"errno\", \"errno\"); \/\/ duplicates\n+        var noDuplicateOpt = Linker.Option.captureCallState(\"errno\");\n+        assertEquals(duplicateOpt, noDuplicateOpt, \"auto deduplication\");\n+        var display = duplicateOpt.toString();\n+        assertTrue(display.contains(\"errno\"), \"toString should contain state name 'errno': \" + display);\n+    }\n+\n","filename":"test\/jdk\/java\/foreign\/capturecallstate\/TestCaptureCallState.java","additions":13,"deletions":2,"binary":false,"changes":15,"status":"modified"}]}