{"files":[{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/atomic.hpp\"\n@@ -249,1 +250,1 @@\n-  volatile bool _size_limit_reached;\n+  Atomic<bool> _size_limit_reached;\n@@ -258,1 +259,1 @@\n-  volatile Thread* _resize_lock_owner;\n+  Atomic<Thread*> _resize_lock_owner;\n@@ -276,1 +277,1 @@\n-  volatile Thread* _invisible_epoch;\n+  Atomic<Thread*> _invisible_epoch;\n@@ -438,1 +439,1 @@\n-  bool is_max_size_reached() { return _size_limit_reached; }\n+  bool is_max_size_reached() { return _size_limit_reached.load_relaxed(); }\n@@ -442,1 +443,1 @@\n-  bool is_safepoint_safe() { return _resize_lock_owner == nullptr; }\n+  bool is_safepoint_safe() { return _resize_lock_owner.load_relaxed() == nullptr; }\n","filename":"src\/hotspot\/share\/utilities\/concurrentHashTable.hpp","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+#include \"runtime\/atomic.hpp\"\n@@ -224,2 +225,2 @@\n-  if (AtomicAccess::load_acquire(&_cht->_invisible_epoch) != nullptr) {\n-    AtomicAccess::release_store_fence(&_cht->_invisible_epoch, (Thread*)nullptr);\n+  if (_cht->_invisible_epoch.load_acquire() != nullptr) {\n+    _cht->_invisible_epoch.release_store_fence(nullptr);\n@@ -285,1 +286,1 @@\n-  assert(_resize_lock_owner == thread, \"Re-size lock not held\");\n+  assert(_resize_lock_owner.load_relaxed() == thread, \"Re-size lock not held\");\n@@ -288,1 +289,1 @@\n-  if (AtomicAccess::load_acquire(&_invisible_epoch) == thread) {\n+  if (_invisible_epoch.load_acquire() == thread) {\n@@ -291,1 +292,1 @@\n-  assert(_invisible_epoch == nullptr, \"Two thread doing bulk operations\");\n+  assert(_invisible_epoch.load_relaxed() == nullptr, \"Two thread doing bulk operations\");\n@@ -294,1 +295,1 @@\n-  AtomicAccess::release_store(&_invisible_epoch, thread);\n+  _invisible_epoch.release_store(thread);\n@@ -303,2 +304,2 @@\n-    if (_resize_lock_owner != nullptr) {\n-      assert(locker != _resize_lock_owner, \"Already own lock\");\n+    if (_resize_lock_owner.load_relaxed() != nullptr) {\n+      assert(locker != _resize_lock_owner.load_relaxed(), \"Already own lock\");\n@@ -312,2 +313,2 @@\n-  _invisible_epoch = nullptr;\n-  _resize_lock_owner = locker;\n+  _invisible_epoch.store_relaxed(nullptr);\n+  _resize_lock_owner.store_relaxed(locker);\n@@ -329,2 +330,2 @@\n-    if (_resize_lock_owner != nullptr) {\n-      assert(locker != _resize_lock_owner, \"Already own lock\");\n+    if (_resize_lock_owner.load_relaxed() != nullptr) {\n+      assert(locker != _resize_lock_owner.load_relaxed(), \"Already own lock\");\n@@ -338,2 +339,2 @@\n-  _resize_lock_owner = locker;\n-  _invisible_epoch = nullptr;\n+  _resize_lock_owner.store_relaxed(locker);\n+  _invisible_epoch.store_relaxed(nullptr);\n@@ -346,3 +347,3 @@\n-  _invisible_epoch = nullptr;\n-  assert(locker == _resize_lock_owner, \"Not unlocked by locker.\");\n-  _resize_lock_owner = nullptr;\n+  _invisible_epoch.store_relaxed(nullptr);\n+  assert(locker == _resize_lock_owner.load_relaxed(), \"Not unlocked by locker.\");\n+  _resize_lock_owner.store_relaxed(nullptr);\n@@ -480,2 +481,2 @@\n-  assert((is_mt && _resize_lock_owner != nullptr) ||\n-         (!is_mt && _resize_lock_owner == thread), \"Re-size lock not held\");\n+  assert((is_mt && _resize_lock_owner.load_relaxed() != nullptr) ||\n+         (!is_mt && _resize_lock_owner.load_relaxed() == thread), \"Re-size lock not held\");\n@@ -699,1 +700,1 @@\n-  assert(_resize_lock_owner == thread, \"Re-size lock not held\");\n+  assert(_resize_lock_owner.load_relaxed() == thread, \"Re-size lock not held\");\n@@ -713,1 +714,1 @@\n-  assert(_resize_lock_owner == thread, \"Re-size lock not held\");\n+  assert(_resize_lock_owner.load_relaxed() == thread, \"Re-size lock not held\");\n@@ -716,1 +717,1 @@\n-  _size_limit_reached = false;\n+  _size_limit_reached.store_relaxed(false);\n@@ -770,1 +771,1 @@\n-    assert(_resize_lock_owner != thread, \"Re-size lock held\");\n+    assert(_resize_lock_owner.load_relaxed() != thread, \"Re-size lock held\");\n@@ -773,1 +774,1 @@\n-  assert(_resize_lock_owner == thread, \"Should be locked by me\");\n+  assert(_resize_lock_owner.load_relaxed() == thread, \"Should be locked by me\");\n@@ -776,1 +777,1 @@\n-  assert(_resize_lock_owner != thread, \"Re-size lock held\");\n+  assert(_resize_lock_owner.load_relaxed() != thread, \"Re-size lock held\");\n@@ -790,1 +791,1 @@\n-  _size_limit_reached = (log2_size == _log2_size_limit);\n+  _size_limit_reached.store_relaxed(log2_size == _log2_size_limit);\n@@ -815,1 +816,1 @@\n-  _size_limit_reached = _new_table->_log2_size == _log2_size_limit;\n+  _size_limit_reached.store_relaxed(_new_table->_log2_size == _log2_size_limit);\n@@ -824,1 +825,1 @@\n-  assert(_resize_lock_owner == thread, \"Should be locked\");\n+  assert(_resize_lock_owner.load_relaxed() == thread, \"Should be locked\");\n@@ -843,1 +844,1 @@\n-    assert(_resize_lock_owner != thread, \"Re-size lock held\");\n+    assert(_resize_lock_owner.load_relaxed() != thread, \"Re-size lock held\");\n@@ -846,1 +847,1 @@\n-  assert(_resize_lock_owner == thread, \"Should be locked by me\");\n+  assert(_resize_lock_owner.load_relaxed() == thread, \"Should be locked by me\");\n@@ -849,1 +850,1 @@\n-  assert(_resize_lock_owner != thread, \"Re-size lock held\");\n+  assert(_resize_lock_owner.load_relaxed() != thread, \"Re-size lock held\");\n@@ -964,1 +965,1 @@\n-  assert(_resize_lock_owner == thread, \"Re-size lock not held\");\n+  assert(_resize_lock_owner.load_relaxed() == thread, \"Re-size lock not held\");\n@@ -1023,1 +1024,1 @@\n-  _size_limit_reached = _table->_log2_size == _log2_size_limit;\n+  _size_limit_reached.store_relaxed(_table->_log2_size == _log2_size_limit);\n@@ -1142,1 +1143,1 @@\n-  assert(_resize_lock_owner != thread, \"Re-size lock held\");\n+  assert(_resize_lock_owner.load_relaxed() != thread, \"Re-size lock held\");\n@@ -1146,1 +1147,1 @@\n-  assert(_resize_lock_owner != thread, \"Re-size lock held\");\n+  assert(_resize_lock_owner.load_relaxed() != thread, \"Re-size lock held\");\n@@ -1208,1 +1209,1 @@\n-  assert(_resize_lock_owner != thread, \"Re-size lock held\");\n+  assert(_resize_lock_owner.load_relaxed() != thread, \"Re-size lock held\");\n","filename":"src\/hotspot\/share\/utilities\/concurrentHashTable.inline.hpp","additions":37,"deletions":36,"binary":false,"changes":73,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+#include \"runtime\/atomic.hpp\"\n@@ -44,1 +45,1 @@\n-    volatile size_t _next;\n+    Atomic<size_t> _next;\n@@ -59,1 +60,1 @@\n-      _next = 0;\n+      _next.store_relaxed(0);\n@@ -65,2 +66,2 @@\n-      if (AtomicAccess::load(&_next) < _limit) {\n-        size_t claimed = AtomicAccess::fetch_then_add(&_next, _size);\n+      if (_next.load_relaxed() < _limit) {\n+        size_t claimed = _next.fetch_then_add(_size);\n@@ -81,1 +82,1 @@\n-      return AtomicAccess::load_acquire(&_next) >= _limit;\n+      return _next.load_acquire() >= _limit;\n@@ -111,1 +112,1 @@\n-    assert(BucketsOperation::_cht->_resize_lock_owner == thread,\n+    assert(BucketsOperation::_cht->_resize_lock_owner.load_relaxed() == thread,\n@@ -117,1 +118,1 @@\n-    assert(BucketsOperation::_cht->_resize_lock_owner == thread,\n+    assert(BucketsOperation::_cht->_resize_lock_owner.load_relaxed() == thread,\n@@ -125,1 +126,1 @@\n-    assert(BucketsOperation::_cht->_resize_lock_owner != thread,\n+    assert(BucketsOperation::_cht->_resize_lock_owner.load_relaxed() != thread,\n@@ -172,1 +173,1 @@\n-    assert(BucketsOperation::_cht->_resize_lock_owner != nullptr,\n+    assert(BucketsOperation::_cht->_resize_lock_owner.load_relaxed() != nullptr,\n@@ -180,1 +181,1 @@\n-    assert(BucketsOperation::_cht->_resize_lock_owner != nullptr,\n+    assert(BucketsOperation::_cht->_resize_lock_owner.load_relaxed() != nullptr,\n@@ -213,1 +214,1 @@\n-    assert(BucketsOperation::_cht->_resize_lock_owner != nullptr,\n+    assert(BucketsOperation::_cht->_resize_lock_owner.load_relaxed() != nullptr,\n@@ -219,1 +220,1 @@\n-    assert(BucketsOperation::_cht->_resize_lock_owner != nullptr,\n+    assert(BucketsOperation::_cht->_resize_lock_owner.load_relaxed() != nullptr,\n@@ -256,1 +257,1 @@\n-    assert(BucketsOperation::_cht->_resize_lock_owner != nullptr,\n+    assert(BucketsOperation::_cht->_resize_lock_owner.load_relaxed() != nullptr,\n@@ -262,1 +263,1 @@\n-    assert(BucketsOperation::_cht->_resize_lock_owner != nullptr,\n+    assert(BucketsOperation::_cht->_resize_lock_owner.load_relaxed() != nullptr,\n","filename":"src\/hotspot\/share\/utilities\/concurrentHashTableTasks.inline.hpp","additions":15,"deletions":14,"binary":false,"changes":29,"status":"modified"}]}