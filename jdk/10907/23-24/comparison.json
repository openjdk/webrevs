{"files":[{"patch":"@@ -47,1 +47,1 @@\n-  private static long          lockStackCurrentOffset;\n+  private static long          lockStackOffsetOffset;\n@@ -105,2 +105,2 @@\n-    lockStackCurrentOffset = type.getField(\"_lock_stack\").getOffset() + typeLockStack.getField(\"_current\").getOffset();\n-    lockStackBaseOffset = type.getField(\"_lock_stack\").getOffset() + typeLockStack.getField(\"_base\").getOffset();\n+    lockStackOffsetOffset = type.getField(\"_lock_stack\").getOffset() + typeLockStack.getField(\"_offset\").getOffset();\n+    lockStackBaseOffset = type.getField(\"_lock_stack\").getOffset() + typeLockStack.getField(\"_base[0]\").getOffset();\n@@ -406,8 +406,12 @@\n-    Address current = addr.getAddressAt(lockStackCurrentOffset);\n-    Address base = addr.getAddressAt(lockStackBaseOffset);\n-    while (base.lessThan(current)) {\n-        Address oop = base.getAddressAt(0);\n-        if (oop.equals(obj)) {\n-            return true;\n-        }\n-        base = base.addOffsetTo(oopPtrSize);\n+    long current = lockStackBaseOffset;\n+    long end = addr.getJIntAt(lockStackOffsetOffset);\n+    if (Assert.ASSERTS_ENABLED) {\n+      Assert.that(current <= end, \"current stack offset must be above base offset\");\n+    }\n+\n+    while (current < end) {\n+      Address oop = addr.getAddressAt(current);\n+      if (oop.equals(obj)) {\n+        return true;\n+      }\n+      current += oopPtrSize;\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/runtime\/JavaThread.java","additions":15,"deletions":11,"binary":false,"changes":26,"status":"modified"}]}