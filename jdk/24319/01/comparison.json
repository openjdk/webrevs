{"files":[{"patch":"@@ -132,0 +132,7 @@\n+    inline void update_livedata(size_t live) {\n+      _region_union._live_data = live;\n+#ifdef ASSERT\n+      _union_tag = is_live_data;\n+#endif\n+    }\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahHeuristics.hpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -91,0 +91,11 @@\n+  \/\/ Between consecutive mixed-evacuation cycles, the live data within each candidate region may change due to\n+  \/\/ promotions and old-gen evacuations.  Re-sort the candidate regions in order to first evacuate regions that have\n+  \/\/ the smallest amount of live data.  These are easiest to evacuate with least effort.  Doing these first allows\n+  \/\/ us to more quickly replenish free memory with empty regions.\n+  for (uint i = _next_old_collection_candidate; i < _last_old_collection_candidate; i++) {\n+    ShenandoahHeapRegion* r = _region_data[i].get_region();\n+    _region_data[i].update_livedata(r->get_live_data_bytes());\n+  }\n+  QuickSort::sort<RegionData>(_region_data + _next_old_collection_candidate, unprocessed_old_collection_candidates(),\n+                              compare_by_live);\n+\n@@ -406,0 +417,4 @@\n+\n+#ifdef KELVIN_DEPRECATE\n+    r->capture_mixed_candidate_garbage();\n+#endif\n@@ -448,0 +463,4 @@\n+\n+#ifdef KELVIN_DEPRECATE\n+      r->capture_mixed_candidate_garbage();\n+#endif\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahOldHeuristics.cpp","additions":19,"deletions":0,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -78,0 +78,1 @@\n+  _mixed_candidate_garbage_words(0),\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -262,0 +262,2 @@\n+  size_t _mixed_candidate_garbage_words;\n+\n@@ -371,1 +373,1 @@\n-\n+#ifdef KELVIN_DEPRECATE\n@@ -374,0 +376,1 @@\n+#endif\n@@ -379,0 +382,2 @@\n+\n+  \/\/ Returns bytes identified as live at time of most recent mark. Does not include allocations subsequent to last mark.\n@@ -380,0 +385,2 @@\n+\n+  \/\/ Returns words identified as live at time of most recent mark.  Can only be called during final mark safepoints.\n@@ -381,0 +388,6 @@\n+#ifdef KELVIN_DEPRECATE\n+  inline size_t get_mixed_candidate_live_data_bytes() const;\n+  inline size_t get_mixed_candidate_live_data_words() const;\n+\n+  inline void capture_mixed_candidate_garbage();\n+#endif\n@@ -382,0 +395,2 @@\n+  \/\/ Returns garbage by calculating difference between used and get_live_data_words.  Can only be called during final\n+  \/\/ meark safepoints. Allocations above TAMS are considered live.\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.hpp","additions":16,"deletions":1,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -131,0 +131,1 @@\n+#ifdef KELVIN_DEPRECATE\n@@ -134,0 +135,1 @@\n+#endif\n@@ -151,1 +153,4 @@\n-  return Atomic::load(&_live_data);\n+  ShenandoahMarkingContext *ctx = ShenandoahHeap::heap()->complete_marking_context();\n+  HeapWord* tams = ctx->top_at_mark_start(this);\n+  size_t words_above_tams = pointer_delta(top(), tams);\n+  return Atomic::load(&_live_data) + words_above_tams;\n@@ -158,0 +163,19 @@\n+#ifdef KELVIN_DEPRECATE\n+inline size_t ShenandoahHeapRegion::get_mixed_candidate_live_data_bytes() const {\n+  shenandoah_assert_safepoint();\n+  assert(used() >= _mixed_candidate_garbage_words * HeapWordSize, \"used must exceed garbage\");\n+  return used() - _mixed_candidate_garbage_words * HeapWordSize;\n+}\n+\n+inline size_t ShenandoahHeapRegion::get_mixed_candidate_live_data_words() const {\n+  shenandoah_assert_safepoint();\n+  assert(used() >= _mixed_candidate_garbage_words * HeapWordSize, \"used must exceed garbage\");\n+  return used() \/ HeapWordSize - _mixed_candidate_garbage_words;\n+}\n+\n+inline void ShenandoahHeapRegion::capture_mixed_candidate_garbage() {\n+  shenandoah_assert_safepoint();\n+  _mixed_candidate_garbage_words = garbage() \/ HeapWordSize;\n+}\n+#endif\n+\n@@ -166,1 +190,0 @@\n-\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.inline.hpp","additions":25,"deletions":2,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -60,0 +60,1 @@\n+#ifdef KELVIN_DEPRECATE\n@@ -74,0 +75,1 @@\n+#endif\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegionClosures.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -107,1 +107,1 @@\n-    region->increase_live_data_alloc_words(live_bytes \/ HeapWordSize);\n+    region->increase_live_data_gc_words(live_bytes \/ HeapWordSize);\n","filename":"test\/hotspot\/gtest\/gc\/shenandoah\/test_shenandoahOldHeuristic.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}