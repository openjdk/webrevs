{"files":[{"patch":"@@ -276,1 +276,1 @@\n-        if (length_in_bytes > 16 || !is_feat_fp16_supported()) {\n+        if (length_in_bytes < 8 || length_in_bytes > 16 || !is_feat_fp16_supported()) {\n@@ -3450,1 +3450,0 @@\n-\n@@ -3452,1 +3451,1 @@\n-\/\/ reach here for T_FLOAT type:\n+\/\/ reach here:\n@@ -3459,9 +3458,3 @@\n-\/\/ For half float input (inferred as a T_SHORT type) - the only case that can reach here is\n-\/\/ through autovectorization which is strictly ordered. At the time of writing this, support for\n-\/\/ Float16 in VectorAPI is not available and thus only support for autovectorization has been added.\n-instruct reduce_addFHF_sve(vRegF dst_src1, vReg src2) %{\n-  predicate((Matcher::vector_element_basic_type(n->in(2)) == T_FLOAT &&\n-             (!VM_Version::use_neon_for_vector(Matcher::vector_length_in_bytes(n->in(2))) ||\n-              n->as_Reduction()->requires_strict_order())) ||\n-            (Matcher::vector_element_basic_type(n->in(2)) == T_SHORT && UseSVE > 0));\n-  match(Set dst_src1 (AddReductionVHF dst_src1 src2));\n+instruct reduce_addF_sve(vRegF dst_src1, vReg src2) %{\n+  predicate(!VM_Version::use_neon_for_vector(Matcher::vector_length_in_bytes(n->in(2))) ||\n+            n->as_Reduction()->requires_strict_order());\n@@ -3469,1 +3462,1 @@\n-  format %{ \"reduce_addFHF_sve $dst_src1, $dst_src1, $src2\" %}\n+  format %{ \"reduce_addF_sve $dst_src1, $dst_src1, $src2\" %}\n@@ -3474,2 +3467,21 @@\n-    BasicType bt = Matcher::vector_element_basic_type(this, $src2);\n-    __ sve_fadda($dst_src1$$FloatRegister, __ elemType_to_regVariant(bt), ptrue, $src2$$FloatRegister);\n+    __ sve_fadda($dst_src1$$FloatRegister, __ S, ptrue, $src2$$FloatRegister);\n+  %}\n+  ins_pipe(pipe_slow);\n+%}\n+\n+\/\/ This rule calculates the reduction result in strict order. Two cases will\n+\/\/ reach here:\n+\/\/ 1. Non strictly-ordered AddReductionVHF when vector size > 128-bits. For example -\n+\/\/    AddReductionVHF generated by Vector API. For vector size > 128-bits, it is more\n+\/\/    beneficial performance-wise to generate direct SVE instruction even if it is\n+\/\/    strictly ordered.\n+\/\/ 2. Strictly-ordered AddReductionVHF. For example - AddReductionVHF generated by\n+\/\/    auto-vectorization on SVE machine.\n+instruct reduce_addHF_sve(vRegF dst_src1, vReg src2) %{\n+  predicate(UseSVE > 0);\n+  match(Set dst_src1 (AddReductionVHF dst_src1 src2));\n+  format %{ \"reduce_addHF_sve $dst_src1, $dst_src1, $src2\" %}\n+  ins_encode %{\n+    uint length_in_bytes = Matcher::vector_length_in_bytes(this, $src2);\n+    assert(length_in_bytes == MaxVectorSize, \"invalid vector length\");\n+    __ sve_fadda($dst_src1$$FloatRegister, __ H, ptrue, $src2$$FloatRegister);\n@@ -3497,1 +3509,1 @@\n-\/\/ reach here for T_DOUBLE type:\n+\/\/ reach here:\n@@ -3510,1 +3522,0 @@\n-    assert(UseSVE > 0, \"must be sve\");\n","filename":"src\/hotspot\/cpu\/aarch64\/aarch64_vector.ad","additions":28,"deletions":17,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -266,1 +266,1 @@\n-        if (length_in_bytes > 16 || !is_feat_fp16_supported()) {\n+        if (length_in_bytes < 8 || length_in_bytes > 16 || !is_feat_fp16_supported()) {\n@@ -2107,3 +2107,3 @@\n-\n-dnl REDUCE_ADD_FP_SVE($1,        $2     )\n-dnl REDUCE_ADD_FP_SVE(insn_name, op_name)\n+dnl\n+dnl REDUCE_ADD_FP_SVE($1,   $2  )\n+dnl REDUCE_ADD_FP_SVE(type, size)\n@@ -2112,3 +2112,3 @@\n-\/\/ reach here for ifelse($2, F, T_FLOAT, T_DOUBLE) type:\n-\/\/ 1. Non strictly-ordered AddReductionV$2 when vector size > 128-bits. For example -\n-\/\/    AddReductionV$2 generated by Vector API. For vector size > 128-bits, it is more\n+\/\/ reach here:\n+\/\/ 1. Non strictly-ordered AddReductionV$1 when vector size > 128-bits. For example -\n+\/\/    AddReductionV$1 generated by Vector API. For vector size > 128-bits, it is more\n@@ -2117,1 +2117,1 @@\n-\/\/ 2. Strictly-ordered AddReductionV$2. For example - AddReductionV$2 generated by\n+\/\/ 2. Strictly-ordered AddReductionV$1. For example - AddReductionV$1 generated by\n@@ -2119,11 +2119,3 @@\n-ifelse($2, F,\n-`\/\/ For half float input (inferred as a T_SHORT type) - the only case that can reach here is\n-\/\/ through autovectorization which is strictly ordered. At the time of writing this, support for\n-\/\/ Float16 in VectorAPI is not available and thus only support for autovectorization has been added.\n-',)dnl\n-instruct reduce_add$1_sve(vReg$2 dst_src1, vReg src2) %{\n-  ifelse($2, F,\n-       `predicate((Matcher::vector_element_basic_type(n->in(2)) == T_FLOAT &&\n-             (!VM_Version::use_neon_for_vector(Matcher::vector_length_in_bytes(n->in(2))) ||\n-              n->as_Reduction()->requires_strict_order())) ||\n-            (Matcher::vector_element_basic_type(n->in(2)) == T_SHORT && UseSVE > 0));',\n+instruct reduce_add$1_sve(vReg`'ifelse($1, HF, F, $1) dst_src1, vReg src2) %{\n+  ifelse($1, HF,\n+       `predicate(UseSVE > 0);',\n@@ -2132,4 +2124,1 @@\n-  ifelse($2, F,\n-       `match(Set dst_src1 (AddReductionVHF dst_src1 src2));\n-  match(Set dst_src1 (AddReductionV$2 dst_src1 src2));',\n-       `match(Set dst_src1 (AddReductionV$2 dst_src1 src2));')\n+  match(Set dst_src1 (AddReductionV$1 dst_src1 src2));\n@@ -2138,5 +2127,2 @@\n-    assert(UseSVE > 0, \"must be sve\");\n-    uint length_in_bytes = Matcher::vector_length_in_bytes(this, $src2);\n-    assert(length_in_bytes == MaxVectorSize, \"invalid vector length\");\n-    ifelse($2, F,\n-       `BasicType bt = Matcher::vector_element_basic_type(this, $src2);\n+    ifelse($1, F,\n+       `assert(UseSVE > 0, \"must be sve\");\n@@ -2144,3 +2130,3 @@\n-ifelse($2, F,\n-       `__ sve_fadda($dst_src1$$FloatRegister, __ elemType_to_regVariant(bt), ptrue, $src2$$FloatRegister);',\n-       `__ sve_fadda($dst_src1$$FloatRegister, __ $2, ptrue, $src2$$FloatRegister);')\n+uint length_in_bytes = Matcher::vector_length_in_bytes(this, $src2);\n+    assert(length_in_bytes == MaxVectorSize, \"invalid vector length\");\n+    __ sve_fadda($dst_src1$$FloatRegister, __ $2, ptrue, $src2$$FloatRegister);\n@@ -2151,1 +2137,2 @@\n-REDUCE_ADD_FP_SVE(FHF, F)\n+REDUCE_ADD_FP_SVE(F,  S)\n+REDUCE_ADD_FP_SVE(HF, H)\n","filename":"src\/hotspot\/cpu\/aarch64\/aarch64_vector_ad.m4","additions":19,"deletions":32,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -1874,1 +1874,1 @@\n-        ins(vtmp, H, vsrc, 0, 1);\n+        ext(vtmp, T8B, vsrc, vsrc, 2);\n@@ -1876,1 +1876,1 @@\n-        ins(vtmp, H, vsrc, 0, 2);\n+        ext(vtmp, T8B, vsrc, vsrc, 4);\n@@ -1878,1 +1878,1 @@\n-        ins(vtmp, H, vsrc, 0, 3);\n+        ext(vtmp, T8B, vsrc, vsrc, 6);\n@@ -1881,1 +1881,1 @@\n-          ins(vtmp, H, vsrc, 0, 4);\n+          ext(vtmp, T16B, vsrc, vsrc, 8);\n@@ -1883,1 +1883,1 @@\n-          ins(vtmp, H, vsrc, 0, 5);\n+          ext(vtmp, T16B, vsrc, vsrc, 10);\n@@ -1885,1 +1885,1 @@\n-          ins(vtmp, H, vsrc, 0, 6);\n+          ext(vtmp, T16B, vsrc, vsrc, 12);\n@@ -1887,1 +1887,1 @@\n-          ins(vtmp, H, vsrc, 0, 7);\n+          ext(vtmp, T16B, vsrc, vsrc, 14);\n@@ -1923,1 +1923,1 @@\n-    ins(vtmp, H, vsrc, 0, 1);\n+    ext(vtmp, T8B, vsrc, vsrc, 2);\n@@ -1925,1 +1925,1 @@\n-    ins(vtmp, H, vsrc, 0, 2);\n+    ext(vtmp, T8B, vsrc, vsrc, 4);\n@@ -1927,1 +1927,1 @@\n-    ins(vtmp, H, vsrc, 0, 3);\n+    ext(vtmp, T8B, vsrc, vsrc, 6);\n@@ -1930,1 +1930,1 @@\n-        ins(vtmp, H, vsrc, 0, 4);\n+        ext(vtmp, T16B, vsrc, vsrc, 8);\n@@ -1932,1 +1932,1 @@\n-        ins(vtmp, H, vsrc, 0, 5);\n+        ext(vtmp, T16B, vsrc, vsrc, 10);\n@@ -1934,1 +1934,1 @@\n-        ins(vtmp, H, vsrc, 0, 6);\n+        ext(vtmp, T16B, vsrc, vsrc, 12);\n@@ -1936,1 +1936,1 @@\n-        ins(vtmp, H, vsrc, 0, 7);\n+        ext(vtmp, T16B, vsrc, vsrc, 14);\n","filename":"src\/hotspot\/cpu\/aarch64\/c2_MacroAssembler_aarch64.cpp","additions":14,"deletions":14,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -1401,2 +1401,2 @@\n-  case Op_AddReductionVI:  return new AddReductionVINode(ctrl, n1, n2);\n-  case Op_AddReductionVL:  return new AddReductionVLNode(ctrl, n1, n2);\n+  case Op_AddReductionVI: return new AddReductionVINode(ctrl, n1, n2);\n+  case Op_AddReductionVL: return new AddReductionVLNode(ctrl, n1, n2);\n@@ -1404,4 +1404,4 @@\n-  case Op_AddReductionVF:  return new AddReductionVFNode(ctrl, n1, n2, requires_strict_order);\n-  case Op_AddReductionVD:  return new AddReductionVDNode(ctrl, n1, n2, requires_strict_order);\n-  case Op_MulReductionVI:  return new MulReductionVINode(ctrl, n1, n2);\n-  case Op_MulReductionVL:  return new MulReductionVLNode(ctrl, n1, n2);\n+  case Op_AddReductionVF: return new AddReductionVFNode(ctrl, n1, n2, requires_strict_order);\n+  case Op_AddReductionVD: return new AddReductionVDNode(ctrl, n1, n2, requires_strict_order);\n+  case Op_MulReductionVI: return new MulReductionVINode(ctrl, n1, n2);\n+  case Op_MulReductionVL: return new MulReductionVLNode(ctrl, n1, n2);\n@@ -1409,7 +1409,7 @@\n-  case Op_MulReductionVF:  return new MulReductionVFNode(ctrl, n1, n2, requires_strict_order);\n-  case Op_MulReductionVD:  return new MulReductionVDNode(ctrl, n1, n2, requires_strict_order);\n-  case Op_MinReductionV:   return new MinReductionVNode (ctrl, n1, n2);\n-  case Op_MaxReductionV:   return new MaxReductionVNode (ctrl, n1, n2);\n-  case Op_AndReductionV:   return new AndReductionVNode (ctrl, n1, n2);\n-  case Op_OrReductionV:    return new OrReductionVNode  (ctrl, n1, n2);\n-  case Op_XorReductionV:   return new XorReductionVNode (ctrl, n1, n2);\n+  case Op_MulReductionVF: return new MulReductionVFNode(ctrl, n1, n2, requires_strict_order);\n+  case Op_MulReductionVD: return new MulReductionVDNode(ctrl, n1, n2, requires_strict_order);\n+  case Op_MinReductionV:  return new MinReductionVNode (ctrl, n1, n2);\n+  case Op_MaxReductionV:  return new MaxReductionVNode (ctrl, n1, n2);\n+  case Op_AndReductionV:  return new AndReductionVNode (ctrl, n1, n2);\n+  case Op_OrReductionV:   return new OrReductionVNode  (ctrl, n1, n2);\n+  case Op_XorReductionV:  return new XorReductionVNode (ctrl, n1, n2);\n@@ -1657,0 +1657,2 @@\n+    case Op_AddReductionVHF:\n+    case Op_MulReductionVHF:\n","filename":"src\/hotspot\/share\/opto\/vectornode.cpp","additions":15,"deletions":13,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -339,2 +339,2 @@\n-  virtual const Type* bottom_type() const { return Type::HALF_FLOAT; }\n-  virtual uint ideal_reg() const { return Op_RegF; }\n+  const Type* bottom_type() const override { return Type::HALF_FLOAT; }\n+  uint ideal_reg() const override { return Op_RegF; }\n@@ -613,2 +613,2 @@\n-  virtual const Type* bottom_type() const { return Type::HALF_FLOAT; }\n-  virtual uint ideal_reg() const { return Op_RegF; }\n+  const Type* bottom_type() const override { return Type::HALF_FLOAT; }\n+  uint ideal_reg() const override { return Op_RegF; }\n","filename":"src\/hotspot\/share\/opto\/vectornode.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -464,5 +464,5 @@\n-    short result = (short) 0;\n-       for (int i = 0; i < LEN; i++) {\n-           result = float16ToRawShortBits(Float16.add(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i])));\n-       }\n-       return result;\n+        short result = (short) 0;\n+        for (int i = 0; i < LEN; i++) {\n+            result = float16ToRawShortBits(Float16.add(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i])));\n+        }\n+        return result;\n@@ -486,5 +486,5 @@\n-       short result = floatToFloat16(1.0f);\n-       for (int i = 0; i < LEN; i++) {\n-           result = float16ToRawShortBits(Float16.multiply(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i])));\n-       }\n-       return result;\n+        short result = floatToFloat16(1.0f);\n+        for (int i = 0; i < LEN; i++) {\n+            result = float16ToRawShortBits(Float16.multiply(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i])));\n+        }\n+        return result;\n@@ -510,8 +510,8 @@\n-       short result = (short) 0;\n-       for (int i = 0; i < LEN; i+=8) {\n-           result = float16ToRawShortBits(Float16.add(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i])));\n-           result = float16ToRawShortBits(Float16.add(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+1])));\n-           result = float16ToRawShortBits(Float16.add(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+2])));\n-           result = float16ToRawShortBits(Float16.add(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+3])));\n-       }\n-       return result;\n+        short result = (short) 0;\n+        for (int i = 0; i < LEN; i+=8) {\n+            result = float16ToRawShortBits(Float16.add(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i])));\n+            result = float16ToRawShortBits(Float16.add(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+1])));\n+            result = float16ToRawShortBits(Float16.add(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+2])));\n+            result = float16ToRawShortBits(Float16.add(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+3])));\n+        }\n+        return result;\n@@ -537,8 +537,8 @@\n-       short result = floatToFloat16(1.0f);\n-       for (int i = 0; i < LEN; i+=8) {\n-           result = float16ToRawShortBits(Float16.multiply(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i])));\n-           result = float16ToRawShortBits(Float16.multiply(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+1])));\n-           result = float16ToRawShortBits(Float16.multiply(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+2])));\n-           result = float16ToRawShortBits(Float16.multiply(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+3])));\n-       }\n-       return result;\n+        short result = floatToFloat16(1.0f);\n+        for (int i = 0; i < LEN; i+=8) {\n+            result = float16ToRawShortBits(Float16.multiply(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i])));\n+            result = float16ToRawShortBits(Float16.multiply(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+1])));\n+            result = float16ToRawShortBits(Float16.multiply(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+2])));\n+            result = float16ToRawShortBits(Float16.multiply(Float16.shortBitsToFloat16(result), Float16.shortBitsToFloat16(input1[i+3])));\n+        }\n+        return result;\n","filename":"test\/hotspot\/jtreg\/compiler\/vectorization\/TestFloat16VectorOperations.java","additions":26,"deletions":26,"binary":false,"changes":52,"status":"modified"}]}