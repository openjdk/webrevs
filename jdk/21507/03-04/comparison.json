{"files":[{"patch":"@@ -1271,1 +1271,2 @@\n-            if ((a = array) != null && (cap = a.length) > 0) { \/\/ else disabled\n+            if ((a = array) != null && (cap = a.length) > 0 &&\n+                task != null) {                             \/\/ else disabled\n@@ -1282,1 +1283,2 @@\n-                if (!internal)\n+                int d = 1;\n+                if (!internal) {\n@@ -1284,0 +1286,3 @@\n+                    if (task.getClass().getSuperclass() == interruptibleTaskClass)\n+                        d = 2;\n+                }\n@@ -1286,1 +1291,1 @@\n-                else if ((room == 0 || a[m & (s - 1)] == null) && pool != null)\n+                else if ((room == 0 || a[m & (s - d)] == null) && pool != null)\n@@ -2048,1 +2053,1 @@\n-        long e; WorkQueue[] qs; int n;\n+        int ac =  (short)(qc >>> RC_SHIFT), n; long e; WorkQueue[] qs;\n@@ -2050,1 +2055,1 @@\n-            ((e & SHUTDOWN) != 0L && (qc & RC_MASK) == 0L && quiescent() > 0) ||\n+            ((e & SHUTDOWN) != 0L && ac == 0 && quiescent() > 0) ||\n@@ -2053,1 +2058,2 @@\n-        for (int k = Math.max(n << 1, SPIN_WAITS), checks = 2;;) {\n+        int checks = (ac == 0) ? 1 : (ac == 1) ? 2 : 3;\n+        for (int k = Math.max(n + (n << 1), SPIN_WAITS);;) {\n@@ -2059,5 +2065,6 @@\n-            Thread.onSpinWait();              \/\/ interleave spins and rechecks\n-            if (checks != 0 && (k & 1) == 0 && (q = qs[k & (n - 1)]) != null &&\n-                (a = q.array) != null && (cap = a.length) > 0 &&\n-                a[q.base & (cap - 1)] != null && --checks == 0)\n-                reactivate(false);            \/\/ help signal\n+            if ((q = qs[k & (n - 1)]) == null)\n+                Thread.onSpinWait();          \/\/ interleave spins and rechecks\n+            else if ((a = q.array) != null && (cap = a.length) > 0 &&\n+                     a[q.base & (cap - 1)] != null && --checks <= 0 &&\n+                     ctl == qc && compareAndSetCtl(qc, pc))\n+                return w.phase = activePhase; \/\/ reactivate\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":18,"deletions":11,"binary":false,"changes":29,"status":"modified"}]}