{"files":[{"patch":"@@ -1858,2 +1858,1 @@\n-        if ((tryTerminate(false, false) & STOP) == 0L && phase != 0 &&\n-            w != null) {\n+        if (phase != 0 && w != null && (runState & STOP) == 0L) {\n@@ -1861,1 +1860,0 @@\n-            w.cancelTasks();               \/\/ clean queue\n@@ -1866,2 +1864,2 @@\n-                qs[i] = null;\n-                stealCount += ns;          \/\/ accumulate steals\n+                    qs[i] = null;\n+                    stealCount += ns;      \/\/ accumulate steals\n@@ -1870,2 +1868,5 @@\n-            if (w.source != DROPPED && (runState & STOP) == 0L)\n-                signalWork();              \/\/ possibly replace\n+        }\n+        if ((tryTerminate(false, false) & STOP) == 0L &&\n+            phase != 0 && w != null && w.source != DROPPED) {\n+            signalWork();                  \/\/ possibly replace\n+            w.cancelTasks();               \/\/ clean queue\n@@ -2743,13 +2744,12 @@\n-        long e;\n-        if (((e = runState) & STOP) == 0L) {\n-            long isShutdown, ps;\n-            if (now) {\n-                runState = ((ps = lockRunState()) + RS_LOCK) | STOP | SHUTDOWN;\n-                if ((ps & STOP) == 0L)\n-                    interruptAll();\n-            }\n-            else if ((isShutdown = (e & SHUTDOWN)) != 0L || enable) {\n-                if (isShutdown == 0L)\n-                    getAndBitwiseOrRunState(SHUTDOWN);\n-                if (quiescent() > 0)\n-                    now = true;\n+        long e, isShutdown, ps;\n+        if (((e = runState) & TERMINATED) != 0L)\n+            now = false;\n+        else if ((e & STOP) != 0L)\n+            now = true;\n+        else if (now) {\n+            if (((ps = getAndBitwiseOrRunState(SHUTDOWN|STOP) & STOP)) == 0L) {\n+                if ((ps & RS_LOCK) != 0L) {\n+                    lockRunState(); \/\/ ensure queues array stable after stop\n+                    unlockRunState();\n+                }\n+                interruptAll();\n@@ -2757,2 +2757,0 @@\n-            if (now)\n-                e = runState;\n@@ -2760,1 +2758,7 @@\n-        if ((e & (STOP | TERMINATED)) == STOP) {\n+        else if ((isShutdown = (e & SHUTDOWN)) != 0L || enable) {\n+            if (isShutdown == 0L)\n+                getAndBitwiseOrRunState(SHUTDOWN);\n+            if (quiescent() > 0)\n+                now = true;\n+        }\n+        if (now) {\n@@ -2845,1 +2849,0 @@\n-        \/\/        releaseAll();\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/ForkJoinPool.java","additions":27,"deletions":24,"binary":false,"changes":51,"status":"modified"}]}