{"files":[{"patch":"@@ -298,1 +298,0 @@\n-  static Klass* as_Klass(jobject java_class);\n@@ -300,1 +299,0 @@\n-  static InstanceKlass* as_InstanceKlass(jobject java_class);\n@@ -1902,1 +1900,1 @@\n-  const bool           may_be_java;\n+  const bool may_be_java;\n@@ -1906,1 +1904,1 @@\n-  Symbol* name() const      { return lookup_symbol(name_index); }\n+  Symbol* name() const { return lookup_symbol(name_index); }\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.hpp","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -37,1 +37,0 @@\n-#include \"runtime\/jniHandles.inline.hpp\"\n@@ -295,4 +294,0 @@\n-inline Klass* java_lang_Class::as_Klass(jobject java_class) {\n-  return as_Klass(JNIHandles::resolve_non_null(java_class));\n-}\n-\n@@ -305,4 +300,0 @@\n-inline InstanceKlass* java_lang_Class::as_InstanceKlass(jobject java_class) {\n-  return as_InstanceKlass(JNIHandles::resolve_non_null(java_class));\n-}\n-\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.inline.hpp","additions":0,"deletions":9,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -870,1 +870,1 @@\n-  const Klass* const k = java_lang_Class::as_Klass(clazz);\n+  const Klass* const k = java_lang_Class::as_Klass(resolve_non_null(clazz));\n","filename":"src\/hotspot\/share\/jfr\/jni\/jfrJavaSupport.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -690,1 +690,1 @@\n-  klass = java_lang_Class::as_Klass(mirror);\n+  klass = java_lang_Class::as_Klass(JNIHandles::resolve(mirror));\n@@ -2610,1 +2610,1 @@\n-  Klass* klass = java_lang_Class::as_Klass(mirror);\n+  Klass* klass = java_lang_Class::as_Klass(JNIHandles::resolve(mirror));\n","filename":"src\/hotspot\/share\/jvmci\/jvmciCompilerToVM.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -350,1 +350,1 @@\n-    trace_class_resolution(java_lang_Class::as_Klass(result));\n+    trace_class_resolution(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(result)));\n@@ -529,1 +529,1 @@\n-  InstanceKlass* k = java_lang_Class::as_InstanceKlass(clazz);\n+  InstanceKlass* k = java_lang_Class::as_InstanceKlass(JNIHandles::resolve_non_null(clazz));\n@@ -1044,1 +1044,2 @@\n-    Klass* k = java_lang_Class::as_Klass(clazz);\n+    Klass* k = java_lang_Class::as_Klass(\n+      JNIHandles::resolve_non_null(clazz));\n@@ -1603,1 +1604,1 @@\n-  Klass* k = java_lang_Class::as_Klass(cls); \\\n+  Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(cls)); \\\n@@ -1748,1 +1749,1 @@\n-  Klass* k = java_lang_Class::as_Klass(clazz);\n+  Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));\n@@ -1942,1 +1943,1 @@\n-  Klass* k = java_lang_Class::as_Klass(cls);\n+  Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(cls));\n@@ -1983,1 +1984,1 @@\n-  Klass* k = java_lang_Class::as_Klass(clazz);\n+  Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));\n@@ -2284,1 +2285,1 @@\n-  Klass* ek = java_lang_Class::as_Klass(elementClass);\n+  Klass* ek = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(elementClass));\n@@ -2629,1 +2630,1 @@\n-  Klass* k = java_lang_Class::as_Klass(clazz);\n+  Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));\n@@ -2692,1 +2693,1 @@\n-  Klass* k   = java_lang_Class::as_Klass(clazz);\n+  Klass* k   = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));\n@@ -2928,1 +2929,1 @@\n-    trace_class_resolution(java_lang_Class::as_Klass(result));\n+    trace_class_resolution(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(result)));\n","filename":"src\/hotspot\/share\/prims\/jni.cpp","additions":12,"deletions":11,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -818,1 +818,1 @@\n-    trace_class_resolution(java_lang_Class::as_Klass(result));\n+    trace_class_resolution(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(result)));\n@@ -843,2 +843,2 @@\n-    const char * from_name = java_lang_Class::as_Klass(from)->external_name();\n-    const char * to_name = java_lang_Class::as_Klass(result)->external_name();\n+    const char* from_name = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(from))->external_name();\n+    const char* to_name = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(result))->external_name();\n@@ -909,2 +909,2 @@\n-  InstanceKlass* lookup_k = java_lang_Class::as_InstanceKlass(lookup);\n-  \/\/ Lookup class must not be a primitive class (whose mirror null Klass*)\n+  InstanceKlass* lookup_k = java_lang_Class::as_InstanceKlass(JNIHandles::resolve_non_null(lookup));\n+  \/\/ Lookup class must not be a primitive class (whose mirror has a null Klass*)\n@@ -912,1 +912,2 @@\n-    THROW_MSG_NULL(vmSymbols::java_lang_IllegalArgumentException(), \"Lookup class is primitive\");\n+    \/\/ The error message is wrong. We come here only if lookup is a primitive class\n+    THROW_MSG_NULL(vmSymbols::java_lang_IllegalArgumentException(), \"Lookup class is null\");\n@@ -1447,1 +1448,1 @@\n-    Klass* k = java_lang_Class::as_Klass(cls);\n+    Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve(cls));\n@@ -1599,1 +1600,1 @@\n-  Klass* k = java_lang_Class::as_Klass(cls);\n+  Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(cls));\n@@ -1616,1 +1617,1 @@\n-  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(ofClass);\n+  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve_non_null(ofClass));\n@@ -1737,2 +1738,2 @@\n-  InstanceKlass* c = java_lang_Class::as_InstanceKlass(current);\n-  InstanceKlass* m = java_lang_Class::as_InstanceKlass(member);\n+  InstanceKlass* c = java_lang_Class::as_InstanceKlass(JNIHandles::resolve_non_null(current));\n+  InstanceKlass* m = java_lang_Class::as_InstanceKlass(JNIHandles::resolve_non_null(member));\n@@ -1746,1 +1747,1 @@\n-  InstanceKlass* c = java_lang_Class::as_InstanceKlass(current);\n+  InstanceKlass* c = java_lang_Class::as_InstanceKlass(JNIHandles::resolve_non_null(current));\n@@ -1757,1 +1758,1 @@\n-  InstanceKlass* c = java_lang_Class::as_InstanceKlass(current);\n+  InstanceKlass* c = java_lang_Class::as_InstanceKlass(JNIHandles::resolve_non_null(current));\n@@ -3340,1 +3341,1 @@\n-  Klass* k = java_lang_Class::as_Klass(cls);\n+  Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve(cls));\n@@ -3357,1 +3358,0 @@\n-  Klass* caller_k = java_lang_Class::as_Klass(caller);\n@@ -3365,1 +3365,1 @@\n-  InstanceKlass* lambda_ik = java_lang_Class::as_InstanceKlass(lambdaProxyClass);\n+  InstanceKlass* lambda_ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(lambdaProxyClass));\n@@ -3405,1 +3405,1 @@\n-  InstanceKlass* caller_ik = java_lang_Class::as_InstanceKlass(caller);\n+  InstanceKlass* caller_ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(caller));\n@@ -3502,1 +3502,1 @@\n-  Klass* k = java_lang_Class::as_Klass(cls);\n+  Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve(cls));\n","filename":"src\/hotspot\/share\/prims\/jvm.cpp","additions":18,"deletions":18,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -1097,1 +1097,1 @@\n-      Klass* caller = java_lang_Class::as_Klass(caller_jh);\n+      Klass* caller = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(caller_jh));\n@@ -1114,1 +1114,1 @@\n-                     java_lang_Class::as_Klass(caller_jh);\n+                     java_lang_Class::as_Klass(JNIHandles::resolve_non_null(caller_jh));\n@@ -1242,1 +1242,1 @@\n-  Klass* caller_k = java_lang_Class::as_Klass(caller_jh);\n+  Klass* caller_k = java_lang_Class::as_Klass(JNIHandles::resolve(caller_jh));\n","filename":"src\/hotspot\/share\/prims\/methodHandles.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -492,1 +492,1 @@\n-  InstanceKlass* k = java_lang_Class::as_InstanceKlass(clazz);\n+  InstanceKlass* k = java_lang_Class::as_InstanceKlass(JNIHandles::resolve_non_null(clazz));\n","filename":"src\/hotspot\/share\/prims\/unsafe.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1159,1 +1159,1 @@\n-  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(klass);\n+  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(klass));\n@@ -1939,1 +1939,1 @@\n-  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(klass);\n+  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(klass));\n@@ -1944,1 +1944,1 @@\n-  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(klass);\n+  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(klass));\n@@ -1950,1 +1950,1 @@\n-  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(klass);\n+  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(klass));\n@@ -1959,1 +1959,1 @@\n-  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(klass);\n+  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(klass));\n@@ -1968,1 +1968,1 @@\n-  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(klass);\n+  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(klass));\n@@ -1977,1 +1977,1 @@\n-  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(klass);\n+  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(klass));\n@@ -1986,1 +1986,1 @@\n-  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(klass);\n+  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(klass));\n@@ -1995,1 +1995,1 @@\n-  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(klass);\n+  InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(klass));\n@@ -2158,1 +2158,1 @@\n-  return (jboolean)AOTMetaspace::in_aot_cache(java_lang_Class::as_Klass(clazz));\n+  return (jboolean)AOTMetaspace::in_aot_cache(java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz)));\n@@ -2166,4 +2166,3 @@\n-  Klass *k = java_lang_Class::as_Klass(clazz);\n-  if (k->is_instance_klass()) {\n-    InstanceKlass *ik = InstanceKlass::cast(k);\n-    ik->link_class(THREAD); \/\/ may throw verification error\n+  Klass *k = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(clazz));\n+  if (!k->is_instance_klass()) {\n+    return;\n@@ -2171,0 +2170,2 @@\n+  InstanceKlass *ik = InstanceKlass::cast(k);\n+  ik->link_class(THREAD); \/\/ may throw verification error\n@@ -2431,1 +2432,1 @@\n-  Klass* klass = java_lang_Class::as_Klass(wbclass);\n+  Klass* klass = java_lang_Class::as_Klass(JNIHandles::resolve_non_null(wbclass));\n@@ -2573,1 +2574,1 @@\n-  Klass* k = java_lang_Class::as_Klass(mirror);\n+  Klass* k = java_lang_Class::as_Klass(JNIHandles::resolve(mirror));\n@@ -3065,1 +3066,1 @@\n-      InstanceKlass* ik = java_lang_Class::as_InstanceKlass(wbclass);\n+      InstanceKlass* ik = java_lang_Class::as_InstanceKlass(JNIHandles::resolve(wbclass));\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":18,"deletions":17,"binary":false,"changes":35,"status":"modified"}]}