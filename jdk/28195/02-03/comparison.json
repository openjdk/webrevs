{"files":[{"patch":"@@ -59,7 +59,7 @@\n-    protected final TimeLine timeSource;\n-    protected final String dbgTag;\n-    protected final Lock lock = new ReentrantLock();\n-    protected long congestionWindow = INITIAL_WINDOW;\n-    protected int maxDatagramSize = QuicConnectionImpl.DEFAULT_DATAGRAM_SIZE;\n-    protected int minimumWindow = 2 * maxDatagramSize;\n-    protected long bytesInFlight;\n+    final TimeLine timeSource;\n+    final String dbgTag;\n+    final Lock lock = new ReentrantLock();\n+    long congestionWindow = INITIAL_WINDOW;\n+    int maxDatagramSize = QuicConnectionImpl.DEFAULT_DATAGRAM_SIZE;\n+    int minimumWindow = 2 * maxDatagramSize;\n+    long bytesInFlight;\n@@ -67,3 +67,3 @@\n-    protected long maxBytesInFlight;\n-    protected Deadline congestionRecoveryStartTime;\n-    protected long ssThresh = Long.MAX_VALUE;\n+    long maxBytesInFlight;\n+    Deadline congestionRecoveryStartTime;\n+    long ssThresh = Long.MAX_VALUE;\n@@ -73,4 +73,2 @@\n-    protected QuicBaseCongestionController(String dbgTag, QuicRttEstimator rttEstimator) {\n-        this.dbgTag = dbgTag;\n-        this.timeSource = TimeSource.source();\n-        this.pacer = new QuicPacer(rttEstimator, this);\n+    QuicBaseCongestionController(String dbgTag, QuicRttEstimator rttEstimator) {\n+        this(dbgTag, TimeSource.source(), rttEstimator);\n@@ -79,3 +77,3 @@\n-    \/\/ for testing\n-    protected QuicBaseCongestionController(TimeLine source, QuicRttEstimator rttEstimator) {\n-        this.dbgTag = \"TEST\";\n+    \/\/ Allows to pass a custom timeline for testing\n+    QuicBaseCongestionController(String dbgTag, TimeLine source, QuicRttEstimator rttEstimator) {\n+        this.dbgTag = dbgTag;\n@@ -86,1 +84,1 @@\n-    protected boolean inCongestionRecovery(Deadline sentTime) {\n+    boolean inCongestionRecovery(Deadline sentTime) {\n@@ -91,1 +89,1 @@\n-    protected abstract void onCongestionEvent(Deadline sentTime);\n+    abstract void onCongestionEvent(Deadline sentTime);\n@@ -184,1 +182,1 @@\n-    protected abstract boolean congestionAvoidanceAcked(int packetBytes, Deadline sentTime);\n+    abstract boolean congestionAvoidanceAcked(int packetBytes, Deadline sentTime);\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/quic\/QuicBaseCongestionController.java","additions":18,"deletions":20,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -67,1 +67,1 @@\n-        super(source, rttEstimator);\n+        super(\"TEST\", source, rttEstimator);\n@@ -110,1 +110,1 @@\n-    protected boolean congestionAvoidanceAcked(int packetBytes, Deadline sentTime) {\n+    boolean congestionAvoidanceAcked(int packetBytes, Deadline sentTime) {\n@@ -121,7 +121,2 @@\n-            long targetBytes;\n-            \/\/ not sure if dblTarget can overflow a long, but 1.5 congestionWindow can not.\n-            if (dblTargetBytes > 1.5 * congestionWindow) {\n-                targetBytes = (long) (1.5 * congestionWindow);\n-            } else {\n-                targetBytes = (long)dblTargetBytes;\n-            }\n+            assert dblTargetBytes > 0 : \"Unexpected negative target bytes\";\n+            long targetBytes = (long) Math.min(dblTargetBytes, 1.5 * congestionWindow);\n@@ -129,0 +124,1 @@\n+                long oldWindow = congestionWindow;\n@@ -130,0 +126,2 @@\n+                assert congestionWindow > oldWindow :\n+                        \"Window size decreased: %s to %s\".formatted(oldWindow, congestionWindow);\n@@ -143,1 +141,1 @@\n-    protected void onCongestionEvent(Deadline sentTime) {\n+    void onCongestionEvent(Deadline sentTime) {\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/quic\/QuicCubicCongestionController.java","additions":8,"deletions":10,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -45,1 +45,1 @@\n-    protected boolean congestionAvoidanceAcked(int packetBytes, Deadline sentTime) {\n+    boolean congestionAvoidanceAcked(int packetBytes, Deadline sentTime) {\n@@ -53,1 +53,1 @@\n-    protected void onCongestionEvent(Deadline sentTime) {\n+    void onCongestionEvent(Deadline sentTime) {\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/quic\/QuicRenoCongestionController.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -97,0 +97,25 @@\n+\/*\n+ * @test id=reno-cc\n+ * @bug 8087112\n+ * @library \/test\/lib \/test\/jdk\/java\/net\/httpclient\/lib\n+ * @build jdk.test.lib.net.SimpleSSLContext\n+ *        jdk.httpclient.test.lib.http2.Http2TestServer\n+ * @run testng\/othervm\/timeout=360 -XX:+CrashOnOutOfMemoryError\n+ *                     -Djdk.httpclient.quic.idleTimeout=120\n+ *                     -Djdk.httpclient.keepalive.timeout.h3=120\n+ *                     -Djdk.test.server.quic.idleTimeout=90\n+ *                     -Djdk.httpclient.quic.minPtoBackoffTime=60\n+ *                     -Djdk.httpclient.quic.maxPtoBackoffTime=120\n+ *                     -Djdk.httpclient.quic.maxPtoBackoff=9\n+ *                     -Djdk.httpclient.http3.maxStreamLimitTimeout=0\n+ *                     -Djdk.httpclient.quic.maxEndpoints=1\n+ *                     -Djdk.httpclient.quic.maxBidiStreams=2\n+ *                     -Djdk.httpclient.retryOnStreamlimit=50\n+ *                     -Djdk.httpclient.HttpClient.log=errors,http3,quic:hs:retransmit\n+ *                     -Dsimpleget.requests=100\n+ *                     -Djdk.internal.httpclient.quic.congestionController=reno\n+ *                     H3MultipleConnectionsToSameHost\n+ * @summary Send 100 large concurrent requests, with connections whose max stream\n+ *          limit is artificially low, in order to cause concurrent connections\n+ *          to the same host to be created, with Reno congestion controller\n+ *\/\n","filename":"test\/jdk\/java\/net\/httpclient\/http3\/H3MultipleConnectionsToSameHost.java","additions":25,"deletions":0,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -151,0 +151,12 @@\n+\/*\n+ * @test id=reno-cc\n+ * @bug 8087112\n+ * @library \/test\/lib \/test\/jdk\/java\/net\/httpclient\/lib\n+ * @build jdk.test.lib.net.SimpleSSLContext jdk.httpclient.test.lib.common.TestUtil\n+ *        jdk.httpclient.test.lib.http2.Http2TestServer\n+ * @run testng\/othervm\/timeout=480 -Djdk.internal.httpclient.quic.congestionController=reno\n+ *                     H3SimpleGet\n+ * @summary send multiple GET requests using Reno congestion controller\n+ *\/\n+\n+\n","filename":"test\/jdk\/java\/net\/httpclient\/http3\/H3SimpleGet.java","additions":12,"deletions":0,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -49,1 +49,1 @@\n- *          or IPv6\n+ *          or IPv6, using CUBIC or Reno\n@@ -67,0 +67,5 @@\n+ * @run testng\/othervm\n+ *              -Djdk.internal.httpclient.debug=true\n+ *              -Djdk.httpclient.HttpClient.log=requests,responses,errors\n+ *              -Djdk.internal.httpclient.quic.congestionController=reno\n+ *              H3SimpleTest\n","filename":"test\/jdk\/java\/net\/httpclient\/http3\/H3SimpleTest.java","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"}]}