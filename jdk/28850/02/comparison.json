{"files":[{"patch":"@@ -284,3 +284,3 @@\n-    static bool oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                      size_t length);\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                               size_t length);\n","filename":"src\/hotspot\/share\/gc\/shared\/barrierSet.hpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -37,3 +37,3 @@\n-inline bool BarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                                                                      arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                                                                      size_t length) {\n+inline OopCopyResult BarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                                                                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                                                                               size_t length) {\n@@ -45,1 +45,2 @@\n-    return Raw::oop_arraycopy(nullptr, 0, src, nullptr, 0, dst, length);\n+    Raw::oop_arraycopy(nullptr, 0, src, nullptr, 0, dst, length);\n+    return OopCopyResult::ok;\n@@ -53,1 +54,1 @@\n-      return false;\n+      return OopCopyResult::failed_check_class_cast;\n@@ -58,1 +59,1 @@\n-  return true;\n+  return OopCopyResult::ok;\n","filename":"src\/hotspot\/share\/gc\/shared\/barrierSet.inline.hpp","additions":7,"deletions":6,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -107,3 +107,3 @@\n-    static bool oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                      size_t length);\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                               size_t length);\n","filename":"src\/hotspot\/share\/gc\/shared\/cardTableBarrierSet.hpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -102,1 +102,1 @@\n-inline bool CardTableBarrierSet::AccessBarrier<decorators, BarrierSetT>::\n+inline OopCopyResult CardTableBarrierSet::AccessBarrier<decorators, BarrierSetT>::\n@@ -134,1 +134,1 @@\n-        return false;\n+        return OopCopyResult::failed_check_class_cast;\n@@ -139,1 +139,2 @@\n-  return true;\n+\n+  return OopCopyResult::ok;\n","filename":"src\/hotspot\/share\/gc\/shared\/cardTableBarrierSet.inline.hpp","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -176,3 +176,3 @@\n-    static bool oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                      size_t length);\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                               size_t length);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahBarrierSet.hpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -371,3 +371,3 @@\n-bool ShenandoahBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                                                                         arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                                                                         size_t length) {\n+OopCopyResult ShenandoahBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                                                                                  arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                                                                                  size_t length) {\n@@ -379,1 +379,1 @@\n-  bool result = Raw::oop_arraycopy_in_heap(src_obj, src_offset_in_bytes, src_raw, dst_obj, dst_offset_in_bytes, dst_raw, length);\n+  OopCopyResult result = Raw::oop_arraycopy_in_heap(src_obj, src_offset_in_bytes, src_raw, dst_obj, dst_offset_in_bytes, dst_raw, length);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahBarrierSet.inline.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -91,0 +91,1 @@\n+    [[noreturn]]\n@@ -101,2 +102,2 @@\n-    static bool oop_copy_one_check_cast(zpointer* dst, zpointer* src, Klass* dst_klass);\n-    static void oop_copy_one(zpointer* dst, zpointer* src);\n+    static OopCopyResult oop_copy_one_check_cast(zpointer* dst, zpointer* src, Klass* dst_klass);\n+    static OopCopyResult oop_copy_one(zpointer* dst, zpointer* src);\n@@ -104,2 +105,2 @@\n-    static bool oop_arraycopy_in_heap_check_cast(zpointer* dst, zpointer* src, size_t length, Klass* dst_klass);\n-    static bool oop_arraycopy_in_heap_no_check_cast(zpointer* dst, zpointer* src, size_t length);\n+    static OopCopyResult oop_arraycopy_in_heap_check_cast(zpointer* dst, zpointer* src, size_t length, Klass* dst_klass);\n+    static OopCopyResult oop_arraycopy_in_heap_no_check_cast(zpointer* dst, zpointer* src, size_t length);\n@@ -137,6 +138,6 @@\n-    static bool oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, zpointer* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, zpointer* dst_raw,\n-                                      size_t length);\n-    static bool oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, oop* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, oop* dst_raw,\n-                                      size_t length) {\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, zpointer* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, zpointer* dst_raw,\n+                                               size_t length);\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, oop* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, oop* dst_raw,\n+                                               size_t length) {\n@@ -147,3 +148,3 @@\n-    static bool oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, narrowOop* src_raw,\n-                                      arrayOop dst_obj, size_t dst_offset_in_bytes, narrowOop* dst_raw,\n-                                      size_t length) { unsupported(); return false; }\n+    static OopCopyResult oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, narrowOop* src_raw,\n+                                               arrayOop dst_obj, size_t dst_offset_in_bytes, narrowOop* dst_raw,\n+                                               size_t length) { unsupported(); }\n","filename":"src\/hotspot\/share\/gc\/z\/zBarrierSet.hpp","additions":14,"deletions":13,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -331,1 +331,1 @@\n-inline void ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_copy_one(zpointer* dst, zpointer* src) {\n+inline OopCopyResult ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_copy_one(zpointer* dst, zpointer* src) {\n@@ -334,0 +334,2 @@\n+  \/\/ Future location for null-restriction check and failure reporting\n+\n@@ -335,0 +337,2 @@\n+\n+  return OopCopyResult::ok;\n@@ -338,1 +342,1 @@\n-inline bool ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_copy_one_check_cast(zpointer* dst, zpointer* src, Klass* dst_klass) {\n+inline OopCopyResult ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_copy_one_check_cast(zpointer* dst, zpointer* src, Klass* dst_klass) {\n@@ -343,1 +347,1 @@\n-    return false;\n+    return OopCopyResult::failed_check_class_cast;\n@@ -348,1 +352,1 @@\n-  return true;\n+  return OopCopyResult::ok;\n@@ -352,1 +356,1 @@\n-inline bool ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap_check_cast(zpointer* dst, zpointer* src, size_t length, Klass* dst_klass) {\n+inline OopCopyResult ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap_check_cast(zpointer* dst, zpointer* src, size_t length, Klass* dst_klass) {\n@@ -355,3 +359,3 @@\n-    if (!oop_copy_one_check_cast(dst, src, dst_klass)) {\n-      \/\/ Check cast failed\n-      return false;\n+    const OopCopyResult result = oop_copy_one_check_cast(dst, src, dst_klass);\n+    if (result != OopCopyResult::ok) {\n+      return result;\n@@ -361,1 +365,1 @@\n-  return true;\n+  return OopCopyResult::ok;\n@@ -365,1 +369,1 @@\n-inline bool ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap_no_check_cast(zpointer* dst, zpointer* src, size_t length) {\n+inline OopCopyResult ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap_no_check_cast(zpointer* dst, zpointer* src, size_t length) {\n@@ -370,1 +374,4 @@\n-      oop_copy_one(dst, src);\n+      const OopCopyResult result = oop_copy_one(dst, src);\n+      if (result != OopCopyResult::ok) {\n+        return result;\n+      }\n@@ -372,1 +379,2 @@\n-    return true;\n+\n+    return OopCopyResult::ok;\n@@ -380,1 +388,4 @@\n-      oop_copy_one(dst, src);\n+      const OopCopyResult result = oop_copy_one(dst, src);\n+      if (result != OopCopyResult::ok) {\n+        return result;\n+      }\n@@ -382,1 +393,2 @@\n-    return true;\n+\n+    return OopCopyResult::ok;\n@@ -386,1 +398,1 @@\n-  return true;\n+  return OopCopyResult::ok;\n@@ -390,3 +402,3 @@\n-inline bool ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, zpointer* src_raw,\n-                                                                                       arrayOop dst_obj, size_t dst_offset_in_bytes, zpointer* dst_raw,\n-                                                                                       size_t length) {\n+inline OopCopyResult ZBarrierSet::AccessBarrier<decorators, BarrierSetT>::oop_arraycopy_in_heap(arrayOop src_obj, size_t src_offset_in_bytes, zpointer* src_raw,\n+                                                                                                arrayOop dst_obj, size_t dst_offset_in_bytes, zpointer* dst_raw,\n+                                                                                                size_t length) {\n@@ -399,0 +411,2 @@\n+  } else {\n+    return oop_arraycopy_in_heap_no_check_cast(dst, src, length);\n@@ -400,2 +414,0 @@\n-\n-  return oop_arraycopy_in_heap_no_check_cast(dst, src, length);\n","filename":"src\/hotspot\/share\/gc\/z\/zBarrierSet.inline.hpp","additions":32,"deletions":20,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -131,3 +131,3 @@\n-  static inline bool oop_arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, const T* src_raw,\n-                                   arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                   size_t length) {\n+  static inline OopCopyResult oop_arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, const T* src_raw,\n+                                            arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                            size_t length) {\n@@ -319,3 +319,4 @@\n-  static inline bool oop_arraycopy(arrayOop src_obj, size_t src_offset_in_bytes,\n-                                   arrayOop dst_obj, size_t dst_offset_in_bytes,\n-                                   size_t length) {\n+  [[nodiscard]] \/\/ The caller is responsible to throw an exception on failure\n+  static inline OopCopyResult oop_arraycopy(arrayOop src_obj, size_t src_offset_in_bytes,\n+                                            arrayOop dst_obj, size_t dst_offset_in_bytes,\n+                                            size_t length) {\n@@ -328,4 +329,8 @@\n-  static inline bool oop_arraycopy_raw(T* src, T* dst, size_t length) {\n-    return AccessT::oop_arraycopy(nullptr, 0, src,\n-                                  nullptr, 0, dst,\n-                                  length);\n+  static inline void oop_arraycopy_raw(T* src, T* dst, size_t length) {\n+    static_assert((decorators & ARRAYCOPY_CHECKCAST) == 0);\n+\n+    OopCopyResult result = AccessT::oop_arraycopy(nullptr, 0, src,\n+                                                  nullptr, 0, dst,\n+                                                  length);\n+\n+    assert(result == OopCopyResult::ok, \"Should never fail\");\n","filename":"src\/hotspot\/share\/oops\/access.hpp","additions":15,"deletions":10,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -128,3 +128,3 @@\n-    static bool access_barrier(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                               size_t length) {\n+    static OopCopyResult access_barrier(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                        arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                        size_t length) {\n@@ -134,1 +134,1 @@\n-      return true;\n+      return OopCopyResult::ok;\n@@ -138,3 +138,3 @@\n-    static bool oop_access_barrier(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                   arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                   size_t length) {\n+    static OopCopyResult oop_access_barrier(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                            arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                            size_t length) {\n@@ -334,3 +334,3 @@\n-  bool RuntimeDispatch<decorators, T, BARRIER_ARRAYCOPY>::arraycopy_init(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                                                         arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                                                         size_t length) {\n+  OopCopyResult RuntimeDispatch<decorators, T, BARRIER_ARRAYCOPY>::arraycopy_init(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                                                                  arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                                                                  size_t length) {\n","filename":"src\/hotspot\/share\/oops\/access.inline.hpp","additions":10,"deletions":10,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -38,0 +38,7 @@\n+\/\/ Result from oop_arraycopy\n+enum class OopCopyResult {\n+  ok,                      \/\/ oop array copy sucessful\n+  failed_check_class_cast, \/\/ oop array copy failed subtype check (ARRAYCOPY_CHECKCAST)\n+  failed_check_null        \/\/ oop array copy failed null check (ARRAYCOPY_NOTNULL)\n+};\n+\n@@ -95,3 +102,3 @@\n-    typedef bool (*arraycopy_func_t)(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                     arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                     size_t length);\n+    typedef OopCopyResult (*arraycopy_func_t)(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                              arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                              size_t length);\n@@ -103,3 +110,3 @@\n-    typedef bool (*arraycopy_func_t)(arrayOop src_obj, size_t src_offset_in_bytes, void* src,\n-                                     arrayOop dst_obj, size_t dst_offset_in_bytes, void* dst,\n-                                     size_t length);\n+    typedef OopCopyResult (*arraycopy_func_t)(arrayOop src_obj, size_t src_offset_in_bytes, void* src,\n+                                              arrayOop dst_obj, size_t dst_offset_in_bytes, void* dst,\n+                                              size_t length);\n@@ -508,3 +515,3 @@\n-    static bool arraycopy_init(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                               arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                               size_t length);\n+    static OopCopyResult arraycopy_init(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                        arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                        size_t length);\n@@ -512,3 +519,3 @@\n-    static inline bool arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                 arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                 size_t length) {\n+    static inline OopCopyResult arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                          arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                          size_t length) {\n@@ -823,1 +830,1 @@\n-      HasDecorator<decorators, AS_RAW>::value && CanHardwireRaw<decorators>::value, bool>::type\n+      HasDecorator<decorators, AS_RAW>::value && CanHardwireRaw<decorators>::value, OopCopyResult>::type\n@@ -829,3 +836,3 @@\n-        return Raw::oop_arraycopy(src_obj, src_offset_in_bytes, src_raw,\n-                                  dst_obj, dst_offset_in_bytes, dst_raw,\n-                                  length);\n+        Raw::oop_arraycopy(src_obj, src_offset_in_bytes, src_raw,\n+                           dst_obj, dst_offset_in_bytes, dst_raw,\n+                           length);\n@@ -833,3 +840,3 @@\n-        return Raw::arraycopy(src_obj, src_offset_in_bytes, src_raw,\n-                              dst_obj, dst_offset_in_bytes, dst_raw,\n-                              length);\n+        Raw::arraycopy(src_obj, src_offset_in_bytes, src_raw,\n+                       dst_obj, dst_offset_in_bytes, dst_raw,\n+                       length);\n@@ -837,0 +844,2 @@\n+\n+      return OopCopyResult::ok;\n@@ -841,1 +850,1 @@\n-      HasDecorator<decorators, AS_RAW>::value && !CanHardwireRaw<decorators>::value, bool>::type\n+      HasDecorator<decorators, AS_RAW>::value && !CanHardwireRaw<decorators>::value, OopCopyResult>::type\n@@ -860,1 +869,1 @@\n-      !HasDecorator<decorators, AS_RAW>::value, bool>::type\n+      !HasDecorator<decorators, AS_RAW>::value, OopCopyResult>::type\n@@ -1004,3 +1013,3 @@\n-  inline bool arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n-                                     arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                                     size_t length) {\n+  inline OopCopyResult arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, T* src_raw,\n+                                              arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                              size_t length) {\n@@ -1013,3 +1022,3 @@\n-  inline bool arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, HeapWord* src_raw,\n-                                     arrayOop dst_obj, size_t dst_offset_in_bytes, HeapWord* dst_raw,\n-                                     size_t length) {\n+  inline OopCopyResult arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, HeapWord* src_raw,\n+                                              arrayOop dst_obj, size_t dst_offset_in_bytes, HeapWord* dst_raw,\n+                                              size_t length) {\n@@ -1023,3 +1032,3 @@\n-  inline bool arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, narrowOop* src_raw,\n-                                     arrayOop dst_obj, size_t dst_offset_in_bytes, narrowOop* dst_raw,\n-                                     size_t length) {\n+  inline OopCopyResult arraycopy_reduce_types(arrayOop src_obj, size_t src_offset_in_bytes, narrowOop* src_raw,\n+                                              arrayOop dst_obj, size_t dst_offset_in_bytes, narrowOop* dst_raw,\n+                                              size_t length) {\n@@ -1163,3 +1172,3 @@\n-  inline bool arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, const T* src_raw,\n-                        arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n-                        size_t length) {\n+  inline OopCopyResult arraycopy(arrayOop src_obj, size_t src_offset_in_bytes, const T* src_raw,\n+                                 arrayOop dst_obj, size_t dst_offset_in_bytes, T* dst_raw,\n+                                 size_t length) {\n","filename":"src\/hotspot\/share\/oops\/accessBackend.hpp","additions":42,"deletions":33,"binary":false,"changes":75,"status":"modified"},{"patch":"@@ -188,0 +188,18 @@\n+static void throw_array_store_exception(arrayOop src, arrayOop dst, TRAPS) {\n+  ResourceMark rm(THREAD);\n+  Klass* bound = ObjArrayKlass::cast(dst->klass())->element_klass();\n+  Klass* stype = ObjArrayKlass::cast(src->klass())->element_klass();\n+  stringStream ss;\n+  if (!bound->is_subtype_of(stype)) {\n+    ss.print(\"arraycopy: type mismatch: can not copy %s[] into %s[]\",\n+             stype->external_name(), bound->external_name());\n+  } else {\n+    \/\/ oop_arraycopy should return the index in the source array that\n+    \/\/ contains the problematic oop.\n+    ss.print(\"arraycopy: element type mismatch: can not cast one of the elements\"\n+             \" of %s[] to the type of the destination array, %s\",\n+             stype->external_name(), bound->external_name());\n+  }\n+  THROW_MSG(vmSymbols::java_lang_ArrayStoreException(), ss.as_string());\n+}\n+\n@@ -194,1 +212,2 @@\n-    ArrayAccess<>::oop_arraycopy(s, src_offset, d, dst_offset, length);\n+    OopCopyResult result = ArrayAccess<>::oop_arraycopy(s, src_offset, d, dst_offset, length);\n+    assert(result == OopCopyResult::ok, \"Should never fail\");\n@@ -199,20 +218,9 @@\n-    if (stype == bound || stype->is_subtype_of(bound)) {\n-      \/\/ elements are guaranteed to be subtypes, so no check necessary\n-      ArrayAccess<ARRAYCOPY_DISJOINT>::oop_arraycopy(s, src_offset, d, dst_offset, length);\n-    } else {\n-      \/\/ slow case: need individual subtype checks\n-      \/\/ note: don't use obj_at_put below because it includes a redundant store check\n-      if (!ArrayAccess<ARRAYCOPY_DISJOINT | ARRAYCOPY_CHECKCAST>::oop_arraycopy(s, src_offset, d, dst_offset, length)) {\n-        ResourceMark rm(THREAD);\n-        stringStream ss;\n-        if (!bound->is_subtype_of(stype)) {\n-          ss.print(\"arraycopy: type mismatch: can not copy %s[] into %s[]\",\n-                   stype->external_name(), bound->external_name());\n-        } else {\n-          \/\/ oop_arraycopy should return the index in the source array that\n-          \/\/ contains the problematic oop.\n-          ss.print(\"arraycopy: element type mismatch: can not cast one of the elements\"\n-                   \" of %s[] to the type of the destination array, %s\",\n-                   stype->external_name(), bound->external_name());\n-        }\n-        THROW_MSG(vmSymbols::java_lang_ArrayStoreException(), ss.as_string());\n+    bool type_check = stype != bound && !stype->is_subtype_of(bound);\n+\n+    auto arraycopy = [&] {\n+      if (type_check) {\n+        return ArrayAccess<ARRAYCOPY_DISJOINT | ARRAYCOPY_CHECKCAST>::\n+            oop_arraycopy(s, src_offset, d, dst_offset, length);\n+      } else {\n+        return ArrayAccess<ARRAYCOPY_DISJOINT>::\n+            oop_arraycopy(s, src_offset, d, dst_offset, length);\n@@ -220,0 +228,13 @@\n+    };\n+\n+    OopCopyResult result = arraycopy();\n+\n+    switch (result) {\n+    case OopCopyResult::ok:\n+      \/\/ Done\n+      break;\n+    case OopCopyResult::failed_check_class_cast:\n+      throw_array_store_exception(s, d, JavaThread::current());\n+      break;\n+    default:\n+      ShouldNotReachHere();\n","filename":"src\/hotspot\/share\/oops\/objArrayKlass.cpp","additions":42,"deletions":21,"binary":false,"changes":63,"status":"modified"}]}