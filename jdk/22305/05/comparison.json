{"files":[{"patch":"@@ -253,3 +253,1 @@\n-  if (Arguments::is_internal_module_property(key) &&\n-      !Arguments::is_module_path_property(key) &&\n-      !Arguments::is_add_modules_property(key)) {\n+  if (Arguments::is_non_cds_compatible_internal_module_property(key)) {\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.cpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -426,2 +426,1 @@\n-  CDS_JAVA_HEAP_ONLY(Modules::serialize(soc);)\n-  CDS_JAVA_HEAP_ONLY(Modules::serialize_addmods_names(soc);)\n+  CDS_JAVA_HEAP_ONLY(Modules::serialize_archived_module_info(soc);)\n@@ -570,4 +569,1 @@\n-  \/\/ Write module name into archive\n-  CDS_JAVA_HEAP_ONLY(Modules::dump_main_module_name();)\n-  \/\/ Write module names from --add-modules into archive\n-  CDS_JAVA_HEAP_ONLY(Modules::dump_addmods_names();)\n+  CDS_JAVA_HEAP_ONLY(Modules::dump_archived_module_info());\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":2,"deletions":6,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -565,0 +565,1 @@\n+char* Modules::_archived_native_access_flags = nullptr;\n@@ -571,1 +572,42 @@\n-  ArchivePtrMarker::mark_pointer(&_archived_main_module_name);\n+}\n+\n+void Modules::check_archived_flag_consistency(char* archived_flag, const char* runtime_flag, const char* property) {\n+  log_info(cds)(\"%s %s\", property,\n+    archived_flag != nullptr ? archived_flag : \"(null)\");\n+  bool disable = false;\n+  if (runtime_flag == nullptr) {\n+    if (archived_flag != nullptr) {\n+      log_info(cds)(\"Value for property %s: %s specified during dump time but not during runtime\", property, archived_flag);\n+      disable = true;\n+    }\n+  } else {\n+    if (archived_flag == nullptr) {\n+      log_info(cds)(\"Value for property %s: %s specified during runtime but not during dump time\", property, runtime_flag);\n+      disable = true;\n+    } else if (strcmp(runtime_flag, archived_flag) != 0) {\n+      log_info(cds)(\"Mismatched values for property %s: runtime %s dump time %s\", property, runtime_flag, archived_flag);\n+      disable = true;\n+    }\n+  }\n+\n+  if (disable) {\n+    log_info(cds)(\"Disabling optimized module handling\");\n+    CDSConfig::stop_using_optimized_module_handling();\n+  }\n+  log_info(cds)(\"optimized module handling: %s\", CDSConfig::is_using_optimized_module_handling() ? \"enabled\" : \"disabled\");\n+  log_info(cds)(\"full module graph: %s\", CDSConfig::is_using_full_module_graph() ? \"enabled\" : \"disabled\");\n+}\n+\n+void Modules::dump_archived_module_info() {\n+  \/\/ Write module name into archive\n+  CDS_JAVA_HEAP_ONLY(Modules::dump_main_module_name();)\n+  \/\/ Write module names from --add-modules into archive\n+  CDS_JAVA_HEAP_ONLY(Modules::dump_addmods_names();)\n+  \/\/ Write native enable-native-access flag into archive\n+  CDS_JAVA_HEAP_ONLY(Modules::dump_native_access_flag());\n+}\n+\n+void Modules::serialize_archived_module_info(SerializeClosure* soc) {\n+  CDS_JAVA_HEAP_ONLY(Modules::serialize(soc);)\n+  CDS_JAVA_HEAP_ONLY(Modules::serialize_addmods_names(soc);)\n+  CDS_JAVA_HEAP_ONLY(Modules::serialize_native_access_flags(soc);)\n@@ -580,15 +622,0 @@\n-    bool disable = false;\n-    if (runtime_main_module == nullptr) {\n-      if (_archived_main_module_name != nullptr) {\n-        log_info(cds)(\"Module %s specified during dump time but not during runtime\", _archived_main_module_name);\n-        disable = true;\n-      }\n-    } else {\n-      if (_archived_main_module_name == nullptr) {\n-        log_info(cds)(\"Module %s specified during runtime but not during dump time\", runtime_main_module);\n-        disable = true;\n-      } else if (strcmp(runtime_main_module, _archived_main_module_name) != 0) {\n-        log_info(cds)(\"Mismatched modules: runtime %s dump time %s\", runtime_main_module, _archived_main_module_name);\n-        disable = true;\n-      }\n-    }\n@@ -596,6 +623,1 @@\n-    if (disable) {\n-      log_info(cds)(\"Disabling optimized module handling\");\n-      CDSConfig::stop_using_optimized_module_handling();\n-    }\n-    log_info(cds)(\"optimized module handling: %s\", CDSConfig::is_using_optimized_module_handling() ? \"enabled\" : \"disabled\");\n-    log_info(cds)(\"full module graph: %s\", CDSConfig::is_using_full_module_graph() ? \"enabled\" : \"disabled\");\n+    check_archived_flag_consistency(_archived_main_module_name, runtime_main_module, \"jdk.module.main\");\n@@ -608,0 +630,21 @@\n+void Modules::dump_native_access_flag() {\n+  const char* native_access_names = get_native_access_flags_as_sorted_string();\n+  if (native_access_names != nullptr) {\n+    _archived_native_access_flags = ArchiveBuilder::current()->ro_strdup(native_access_names);\n+  }\n+}\n+\n+const char* Modules::get_native_access_flags_as_sorted_string() {\n+  return get_numbered_property_as_sorted_string(\"jdk.module.enable.native.access\");\n+}\n+\n+void Modules::serialize_native_access_flags(SerializeClosure* soc) {\n+  soc->do_ptr(&_archived_native_access_flags);\n+  if (soc->reading()) {\n+    check_archived_flag_consistency(_archived_native_access_flags, get_native_access_flags_as_sorted_string(), \"jdk.module.enable.native.access\");\n+\n+    \/\/ Don't hold onto the pointer, in case we might decide to unmap the archive.\n+    _archived_native_access_flags = nullptr;\n+  }\n+}\n+\n@@ -609,1 +652,0 @@\n-  unsigned int count = Arguments::addmods_count();\n@@ -614,1 +656,4 @@\n-  ArchivePtrMarker::mark_pointer(&_archived_addmods_names);\n+}\n+\n+const char* Modules::get_addmods_names_as_sorted_string() {\n+  return get_numbered_property_as_sorted_string(\"jdk.module.addmods\");\n@@ -620,27 +665,1 @@\n-    bool disable = false;\n-    if (_archived_addmods_names[0] != '\\0') {\n-      if (Arguments::addmods_count() == 0) {\n-        log_info(cds)(\"--add-modules module name(s) found in archive but not specified during runtime: %s\",\n-            _archived_addmods_names);\n-        disable = true;\n-      } else {\n-        const char* addmods_names = get_addmods_names_as_sorted_string();\n-        if (strcmp((const char*)_archived_addmods_names, addmods_names) != 0) {\n-          log_info(cds)(\"Mismatched --add-modules module name(s).\");\n-          log_info(cds)(\"  dump time: %s runtime: %s\", _archived_addmods_names, addmods_names);\n-          disable = true;\n-        }\n-      }\n-    } else {\n-      if (Arguments::addmods_count() > 0) {\n-        log_info(cds)(\"--add-modules module name(s) specified during runtime but not found in archive: %s\",\n-                      get_addmods_names_as_sorted_string());\n-        disable = true;\n-      }\n-    }\n-    if (disable) {\n-      log_info(cds)(\"Disabling optimized module handling\");\n-      CDSConfig::stop_using_optimized_module_handling();\n-    }\n-    log_info(cds)(\"optimized module handling: %s\", CDSConfig::is_using_optimized_module_handling() ? \"enabled\" : \"disabled\");\n-    log_info(cds)(\"full module graph: %s\", CDSConfig::is_using_full_module_graph() ? \"enabled\" : \"disabled\");\n+    check_archived_flag_consistency(_archived_addmods_names, get_addmods_names_as_sorted_string(), \"jdk.module.addmods\");\n@@ -653,1 +672,1 @@\n-const char* Modules::get_addmods_names_as_sorted_string() {\n+const char* Modules::get_numbered_property_as_sorted_string(const char* property) {\n@@ -655,1 +674,3 @@\n-  const int max_digits = 3;\n+  \/\/ theoretical string size limit for decimal int, but the following loop will end much sooner due to\n+  \/\/ OS command-line size limit.\n+  const int max_digits = 10;\n@@ -657,1 +678,1 @@\n-  size_t prop_len = strlen(\"jdk.module.addmods\") + max_digits + extra_symbols_count;\n+  size_t prop_len = strlen(property) + max_digits + extra_symbols_count;\n@@ -660,2 +681,2 @@\n-  for (unsigned int i = 0; i < Arguments::addmods_count(); i++) {\n-    jio_snprintf(prop_name, prop_len, \"jdk.module.addmods.%d\", i);\n+  for (unsigned int i = 0;; i++) {\n+    jio_snprintf(prop_name, prop_len, \"%s.%d\", property, i);\n@@ -663,0 +684,3 @@\n+    if (prop_value == nullptr) {\n+      break;\n+    }\n@@ -698,1 +722,1 @@\n-      prefix = \"\\n\";\n+      prefix = \",\";\n@@ -702,1 +726,2 @@\n-  return (const char*)os::strdup(st.as_string()); \/\/ Example: \"java.base,java.compiler\"\n+  const char* result = (const char*)os::strdup(st.as_string()); \/\/ Example: \"java.base,java.compiler\"\n+  return strcmp(result, \"\") != 0 ? result : nullptr;\n","filename":"src\/hotspot\/share\/classfile\/modules.cpp","additions":83,"deletions":58,"binary":false,"changes":141,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-* Copyright (c) 2016, 2023, Oracle and\/or its affiliates. All rights reserved.\n+* Copyright (c) 2016, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -62,0 +62,2 @@\n+  static void dump_archived_module_info() NOT_CDS_JAVA_HEAP_RETURN;\n+  static void serialize_archived_module_info(SerializeClosure* soc) NOT_CDS_JAVA_HEAP_RETURN;\n@@ -64,0 +66,6 @@\n+  static void check_archived_flag_consistency(char* archived_flag, const char* runtime_flag, const char* property) NOT_CDS_JAVA_HEAP_RETURN;\n+\n+  static void dump_native_access_flag() NOT_CDS_JAVA_HEAP_RETURN;\n+  static const char* get_native_access_flags_as_sorted_string() NOT_CDS_JAVA_HEAP_RETURN_(nullptr);\n+  static void serialize_native_access_flags(SerializeClosure* soc) NOT_CDS_JAVA_HEAP_RETURN;\n+\n@@ -65,1 +73,0 @@\n-  static void serialize_addmods_names(SerializeClosure* soc) NOT_CDS_JAVA_HEAP_RETURN;\n@@ -67,0 +74,1 @@\n+  static void serialize_addmods_names(SerializeClosure* soc) NOT_CDS_JAVA_HEAP_RETURN;\n@@ -68,0 +76,1 @@\n+  static const char* get_numbered_property_as_sorted_string(const char* property) NOT_CDS_JAVA_HEAP_RETURN_(nullptr);\n@@ -71,0 +80,1 @@\n+  static char* _archived_native_access_flags;\n","filename":"src\/hotspot\/share\/classfile\/modules.hpp","additions":12,"deletions":2,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -323,1 +323,11 @@\n-  if  (strncmp(property, MODULE_PROPERTY_PREFIX, MODULE_PROPERTY_PREFIX_LEN) == 0) {\n+  return internal_module_property_helper(property, false);\n+}\n+\n+\/\/ Returns true if property is one of those recognized by is_internal_module_property() but\n+\/\/ is not supported by CDS archived full module graph.\n+bool Arguments::is_non_cds_compatible_internal_module_property(const char* property) {\n+  return internal_module_property_helper(property, true);\n+}\n+\n+bool Arguments::internal_module_property_helper(const char* property, bool check_for_cds) {\n+  if (strncmp(property, MODULE_PROPERTY_PREFIX, MODULE_PROPERTY_PREFIX_LEN) == 0) {\n@@ -329,1 +339,0 @@\n-        matches_property_suffix(property_suffix, ADDMODS, ADDMODS_LEN) ||\n@@ -331,1 +340,0 @@\n-        matches_property_suffix(property_suffix, PATH, PATH_LEN) ||\n@@ -333,2 +341,1 @@\n-        matches_property_suffix(property_suffix, ILLEGAL_NATIVE_ACCESS, ILLEGAL_NATIVE_ACCESS_LEN) ||\n-        matches_property_suffix(property_suffix, ENABLE_NATIVE_ACCESS, ENABLE_NATIVE_ACCESS_LEN)) {\n+        matches_property_suffix(property_suffix, ILLEGAL_NATIVE_ACCESS, ILLEGAL_NATIVE_ACCESS_LEN)) {\n@@ -337,0 +344,9 @@\n+\n+    if (!check_for_cds) {\n+      \/\/ CDS notes: these properties are supported by CDS archived full module graph.\n+      if (matches_property_suffix(property_suffix, PATH, PATH_LEN) ||\n+          matches_property_suffix(property_suffix, ADDMODS, ADDMODS_LEN) ||\n+          matches_property_suffix(property_suffix, ENABLE_NATIVE_ACCESS, ENABLE_NATIVE_ACCESS_LEN)) {\n+        return true;\n+      }\n+    }\n@@ -341,9 +357,0 @@\n-bool Arguments::is_add_modules_property(const char* key) {\n-  return (strcmp(key, MODULE_PROPERTY_PREFIX ADDMODS) == 0);\n-}\n-\n-\/\/ Return true if the key matches the --module-path property name (\"jdk.module.path\").\n-bool Arguments::is_module_path_property(const char* key) {\n-  return (strcmp(key, MODULE_PROPERTY_PREFIX PATH) == 0);\n-}\n-\n","filename":"src\/hotspot\/share\/runtime\/arguments.cpp","additions":21,"deletions":14,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -465,3 +465,2 @@\n-  static bool is_add_modules_property(const char* key);\n-  static unsigned int addmods_count() { return  _addmods_count; }\n-  static bool is_module_path_property(const char* key);\n+  static bool is_non_cds_compatible_internal_module_property(const char* property);\n+  static bool internal_module_property_helper(const char* property, bool check_for_cds);\n","filename":"src\/hotspot\/share\/runtime\/arguments.hpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -128,1 +128,1 @@\n-            .assertAbnormalExit(\"Mismatched --add-modules module name(s)\",\n+            .assertAbnormalExit(\"Mismatched values for property jdk.module.addmods\",\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/aotClassLinking\/AOTClassLinkingVMOptions.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -86,2 +86,2 @@\n-          .shouldContain(\"Mismatched --add-modules module name(s).\")\n-          .shouldContain(\"dump time: jdk.jconsole runtime: jdk.incubator.vector\")\n+          .shouldContain(\"Mismatched values for property jdk.module.addmods\")\n+          .shouldContain(\"runtime jdk.incubator.vector dump time jdk.jconsole\")\n@@ -95,1 +95,1 @@\n-          .shouldContain(\"Module jdk.httpserver specified during dump time but not during runtime\")\n+          .shouldContain(\"jdk.httpserver specified during dump time but not during runtime\")\n@@ -115,1 +115,1 @@\n-          .shouldContain(\"--add-modules module name(s) specified during runtime but not found in archive: jdk.jconsole\")\n+          .shouldContain(\"jdk.jconsole specified during runtime but not during dump time\")\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/jigsaw\/addmods\/AddmodsOption.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -0,0 +1,133 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * @test\n+ * @bug 8342089\n+ * @summary Test consistency of --enable-native-access option for CDS dump time and runtime\n+ * @requires vm.cds.write.archived.java.heap\n+ * @requires vm.flagless\n+ * @library \/test\/lib \/test\/hotspot\/jtreg\/runtime\/cds\/appcds\n+ * @run driver EnableNativeAccessCDS\n+ *\/\n+\n+import jdk.test.lib.process.OutputAnalyzer;\n+\n+public class EnableNativeAccessCDS {\n+    public static void main(String[] args) throws Exception {\n+        final String module0 = \"java.base\";\n+        final String module1 = \"jdk.httpserver\";\n+        final String disabledOptimizedModule = \"Disabling optimized module handling\";\n+        final String loggingOption = \"-Xlog:cds=debug\";\n+\n+        String archiveName = TestCommon.getNewArchiveName(\"native-access\");\n+        TestCommon.setCurrentArchiveName(archiveName);\n+\n+        \/\/ dump a base archive with --enable-native-access=java.base\n+        OutputAnalyzer oa = TestCommon.dumpBaseArchive(\n+            archiveName,\n+            loggingOption,\n+            \"--enable-native-access\", module0,\n+            \"-version\");\n+        oa.shouldHaveExitValue(0);\n+\n+        \/\/ same module specified during runtime\n+        oa = TestCommon.execCommon(\n+            loggingOption,\n+            \"--enable-native-access\", module0,\n+            \"-version\");\n+        oa.shouldHaveExitValue(0)\n+        .shouldContain(\"use_full_module_graph = true\");\n+\n+        \/\/ different module specified during runtime\n+        oa = TestCommon.execCommon(\n+            loggingOption,\n+            \"--enable-native-access\", module1,\n+            \"-version\");\n+        oa.shouldHaveExitValue(0)\n+        .shouldContain(\"Mismatched values for property jdk.module.enable.native.access: runtime jdk.httpserver dump time java.base\")\n+        .shouldContain(disabledOptimizedModule);\n+\n+        \/\/ no module specified during runtime\n+        oa = TestCommon.execCommon(\n+            loggingOption,\n+            \"-version\");\n+        oa.shouldHaveExitValue(0)\n+        .shouldContain(\"Value for property jdk.module.enable.native.access: java.base specified during dump time but not during runtime\")\n+        .shouldContain(disabledOptimizedModule);\n+\n+        \/\/ dump an archive without --enable-native-access option\n+        archiveName = TestCommon.getNewArchiveName(\"no-native-access-modules\");\n+        TestCommon.setCurrentArchiveName(archiveName);\n+        oa = TestCommon.dumpBaseArchive(\n+            archiveName,\n+            loggingOption,\n+            \"-version\");\n+        oa.shouldHaveExitValue(0);\n+\n+        \/\/ run with --enable-native-access\n+        oa = TestCommon.execCommon(\n+            loggingOption,\n+            \"--enable-native-access\", module0,\n+            \"-version\");\n+        oa.shouldHaveExitValue(0)\n+          .shouldContain(\"Value for property jdk.module.enable.native.access: java.base specified during runtime but not during dump time\")\n+          .shouldContain(disabledOptimizedModule);\n+\n+        \/\/ dump an archive with multiple modules with native access\n+        archiveName = TestCommon.getNewArchiveName(\"multiple-native-access-modules\");\n+        TestCommon.setCurrentArchiveName(archiveName);\n+        oa = TestCommon.dumpBaseArchive(\n+            archiveName,\n+            loggingOption,\n+            \"--enable-native-access\", module0 + \",\" + module1,\n+            \"-version\");\n+        oa.shouldHaveExitValue(0);\n+\n+        \/\/ same module specified during runtime but in a different order\n+        oa = TestCommon.execCommon(\n+            loggingOption,\n+            \"--enable-native-access\", module1 + \",\" + module0,\n+            \"-version\");\n+        oa.shouldHaveExitValue(0)\n+          .shouldContain(\"use_full_module_graph = true\");\n+\n+        \/\/ same module specified during runtime but specifying --enable-native-access twice\n+        oa = TestCommon.execCommon(\n+            loggingOption,\n+            \"--enable-native-access\", module0,\n+            \"--enable-native-access\", module1,\n+            \"-version\");\n+        oa.shouldHaveExitValue(0)\n+          .shouldContain(\"use_full_module_graph = true\");\n+\n+        \/\/ run with only one same module\n+        oa = TestCommon.execCommon(\n+            loggingOption,\n+            \"--enable-native-access\", module0,\n+            \"-version\");\n+        oa.shouldHaveExitValue(0)\n+            .shouldContain(\"Mismatched values for property jdk.module.enable.native.access: runtime java.base dump time java.base,jdk.httpserver\")\n+            .shouldContain(disabledOptimizedModule);\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/jigsaw\/module\/EnableNativeAccessCDS.java","additions":133,"deletions":0,"binary":false,"changes":133,"status":"added"},{"patch":"@@ -73,1 +73,1 @@\n-          .shouldContain(\"Mismatched modules: runtime jdk.compiler dump time jdk.httpserver\")\n+          .shouldContain(\"Mismatched values for property jdk.module.main: runtime jdk.compiler dump time jdk.httpserver\")\n@@ -81,1 +81,1 @@\n-          .shouldContain(\"Module jdk.httpserver specified during dump time but not during runtime\")\n+          .shouldContain(\"Value for property jdk.module.main: jdk.httpserver specified during dump time but not during runtime\")\n@@ -99,1 +99,1 @@\n-          .shouldContain(\"Module jdk.httpserver specified during runtime but not during dump time\")\n+          .shouldContain(\"Value for property jdk.module.main: jdk.httpserver specified during runtime but not during dump time\")\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/jigsaw\/module\/ModuleOption.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"}]}