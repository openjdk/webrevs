{"files":[{"patch":"@@ -1331,0 +1331,9 @@\n+        const oop thread_oop = p->threadObj();\n+        if (thread_oop != nullptr) {\n+          if (p->is_vthread_mounted()) {\n+            const oop vt = p->vthread();\n+            assert(vt != nullptr, \"vthread should not be null when vthread is mounted\");\n+            st->print_cr(\"   Mounted virtual thread \\\"%s\\\" #\" INT64_FORMAT, JavaThread::name_for(vt), (int64_t)java_lang_Thread::thread_id(vt));\n+            p->print_vthread_stack_on(st);\n+          }\n+        }\n","filename":"src\/hotspot\/share\/runtime\/threads.cpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -0,0 +1,85 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import jdk.test.lib.dcmd.CommandExecutor;\n+import jdk.test.lib.dcmd.JMXExecutor;\n+import jdk.test.lib.process.OutputAnalyzer;\n+import org.testng.annotations.Test;\n+\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.regex.Pattern;\n+\n+\/*\n+ * @test\n+ * @summary Test of diagnostic command Thread.print with virtual threads\n+ * @requires vm.continuations\n+ * @library \/test\/lib\n+ * @modules java.base\n+ * @run testng PrintMountedVirtualThread\n+ *\/\n+public class PrintMountedVirtualThread {\n+\n+    public void run(CommandExecutor executor) throws InterruptedException {\n+        var shouldFinish = new AtomicBoolean(false);\n+        var started = new CountDownLatch(1);\n+        final Runnable runnable = new DummyRunnable(shouldFinish, started);\n+        Thread vthread = Thread.ofVirtual().name(\"Dummy Vthread\").start(runnable);\n+        started.await();\n+        \/* Execute *\/\n+        OutputAnalyzer output = executor.execute(\"Thread.print\");\n+        output.shouldMatch(\".*at \" + Pattern.quote(DummyRunnable.class.getName()) + \"\\\\.run.*\");\n+        output.shouldMatch(\".*at \" + Pattern.quote(DummyRunnable.class.getName()) + \"\\\\.compute.*\");\n+        output.shouldMatch(\"Mounted virtual thread \" + \"\\\"Dummy Vthread\\\"\" + \" #\" + vthread.threadId());\n+        shouldFinish.set(true);\n+    }\n+\n+    @Test\n+    public void jmx() throws InterruptedException {\n+        run(new JMXExecutor());\n+    }\n+\n+    static class DummyRunnable implements Runnable {\n+\n+        private final AtomicBoolean shouldFinish;\n+        private final CountDownLatch started;\n+\n+        public DummyRunnable(AtomicBoolean shouldFinish, CountDownLatch started) {\n+           this.shouldFinish = shouldFinish;\n+           this.started = started;\n+        }\n+\n+        public void run() {\n+            compute();\n+        }\n+\n+        void compute() {\n+            started.countDown();\n+            while (!shouldFinish.get()) {\n+                Thread.onSpinWait();\n+            }\n+        }\n+    }\n+\n+\n+}\n","filename":"test\/hotspot\/jtreg\/serviceability\/dcmd\/thread\/PrintMountedVirtualThread.java","additions":85,"deletions":0,"binary":false,"changes":85,"status":"added"}]}