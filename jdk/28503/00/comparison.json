{"files":[{"patch":"@@ -30,0 +30,1 @@\n+#include \"sanitizers\/address.hpp\"\n@@ -34,0 +35,5 @@\n+#if INCLUDE_ASAN\n+#undef NMT_BLOCK_INTEGRITY_CHECKS\n+#else\n+#define NMT_BLOCK_INTEGRITY_CHECKS\n+#endif\n@@ -131,0 +137,11 @@\n+  static void asan_poison_header_footer(void* addr) {\n+    MallocHeader* header = (MallocHeader*)addr - 1;\n+    ASAN_POISON_MEMORY_REGION(header->footer_address(), sizeof(uint16_t));\n+    ASAN_POISON_MEMORY_REGION(header, sizeof(MallocHeader));\n+  }\n+  static void asan_unpoison_header_footer(void* addr) {\n+    MallocHeader* header = (MallocHeader*)addr - 1;\n+    ASAN_UNPOISON_MEMORY_REGION(header, sizeof(MallocHeader));\n+    ASAN_UNPOISON_MEMORY_REGION(header->footer_address(), sizeof(uint16_t));\n+  }\n+\n","filename":"src\/hotspot\/share\/nmt\/mallocHeader.hpp","additions":17,"deletions":0,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -99,5 +99,0 @@\n-  char msg[256];\n-  address corruption = nullptr;\n-  if (!is_valid_malloced_pointer(memblock, msg, sizeof(msg))) {\n-    fatal(\"Not a valid malloc pointer: \" PTR_FORMAT \": %s\", p2i(memblock), msg);\n-  }\n@@ -105,4 +100,11 @@\n-  if (!header_pointer->check_block_integrity(msg, sizeof(msg), &corruption)) {\n-    header_pointer->print_block_on_error(tty, corruption != nullptr ? corruption : (address)header_pointer, (address)header_pointer);\n-    fatal(\"NMT has detected a memory corruption bug. Block at \" PTR_FORMAT \": %s\", p2i(memblock), msg);\n-  }\n+  #ifdef NMT_BLOCK_INTEGRITY_CHECKS\n+    char msg[256];\n+    address corruption = nullptr;\n+    if (!is_valid_malloced_pointer(memblock, msg, sizeof(msg))) {\n+      fatal(\"Not a valid malloc pointer: \" PTR_FORMAT \": %s\", p2i(memblock), msg);\n+    }\n+    if (!header_pointer->check_block_integrity(msg, sizeof(msg), &corruption)) {\n+      header_pointer->print_block_on_error(tty, corruption != nullptr ? corruption : (address)header_pointer, (address)header_pointer);\n+      fatal(\"NMT has detected a memory corruption bug. Block at \" PTR_FORMAT \": %s\", p2i(memblock), msg);\n+    }\n+  #endif\n","filename":"src\/hotspot\/share\/nmt\/mallocHeader.inline.hpp","additions":11,"deletions":9,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -202,1 +202,1 @@\n-\n+  MallocHeader::asan_poison_header_footer(memblock);\n@@ -210,0 +210,1 @@\n+  MallocHeader::asan_unpoison_header_footer(memblock);\n@@ -221,1 +222,0 @@\n-\n","filename":"src\/hotspot\/share\/nmt\/mallocTracker.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -709,1 +709,1 @@\n-\n+    MallocHeader::asan_unpoison_header_footer(memblock);\n@@ -733,0 +733,1 @@\n+      MallocHeader::asan_poison_header_footer(memblock);\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -35,2 +35,0 @@\n-#if !INCLUDE_ASAN\n-\n@@ -55,0 +53,2 @@\n+#if !INCLUDE_ASAN\n+\n@@ -193,0 +193,80 @@\n+#else \/\/ ASAN is enabled\n+\n+#define DEFINE_ASAN_TEST(test_function)  \\\n+  DEFINE_TEST(test_function, \".*AddressSanitizer.*\")\n+\n+static void test_write_header() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  uint16_t* canary_ptr = (uint16_t*)((char*)p - sizeof(uint16_t));\n+  *canary_ptr = 1;\n+}\n+\n+static void test_read_header() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  uint16_t* canary_ptr = (uint16_t*)((char*)p - sizeof(uint16_t));\n+  uint16_t read_canary = 0;\n+  read_canary = *canary_ptr;\n+}\n+\n+static void test_write_footer() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n+  uint16_t* footer_ptr = (uint16_t*)(p + SIZE);\n+  *footer_ptr = 1;\n+}\n+\n+static void test_read_footer() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n+  uint16_t* footer_ptr = (uint16_t*)(p + SIZE);\n+  uint16_t read_footer = *footer_ptr;\n+}\n+\n+static void test_write_header_after_realloc() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  p = (char*)os::realloc(p, 2 * SIZE, mtTest);\n+  uint16_t* canary_ptr = (uint16_t*)((char*)p - sizeof(uint16_t));\n+  *canary_ptr = 1;\n+}\n+\n+static void test_read_header_after_realloc() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  p = (char*)os::realloc(p, 2 * SIZE, mtTest);\n+  uint16_t* canary_ptr = (uint16_t*)((char*)p - sizeof(uint16_t));\n+  uint16_t read_canary = 0;\n+  read_canary = *canary_ptr;\n+}\n+\n+static void test_write_footer_after_realloc() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  p = (char*)os::realloc(p, 2 * SIZE, mtTest);\n+  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n+  uint16_t* footer_ptr = (uint16_t*)(p + 2 * SIZE);\n+  *footer_ptr = 1;\n+}\n+\n+static void test_read_footer_after_realloc() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  p = (char*)os::realloc(p, 2 * SIZE, mtTest);\n+  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n+  uint16_t* footer_ptr = (uint16_t*)(p + 2 * SIZE);\n+  uint16_t read_footer = *footer_ptr;\n+}\n+\n+DEFINE_ASAN_TEST(test_write_header);\n+DEFINE_ASAN_TEST(test_read_header);\n+DEFINE_ASAN_TEST(test_write_footer);\n+DEFINE_ASAN_TEST(test_read_footer);\n+DEFINE_ASAN_TEST(test_write_header_after_realloc);\n+DEFINE_ASAN_TEST(test_read_header_after_realloc);\n+DEFINE_ASAN_TEST(test_write_footer_after_realloc);\n+DEFINE_ASAN_TEST(test_read_footer_after_realloc);\n+\n","filename":"test\/hotspot\/gtest\/nmt\/test_nmt_buffer_overflow_detection.cpp","additions":82,"deletions":2,"binary":false,"changes":84,"status":"modified"}]}