{"files":[{"patch":"@@ -202,0 +202,4 @@\n+WB_ENTRY(jlong, WB_GetMinimumJavaStackSize(JNIEnv* env, jobject o))\n+  return os::get_minimum_java_stack_size();\n+WB_END\n+\n@@ -3136,1 +3140,2 @@\n-  {CC\"lockAndStuckInSafepoint\", CC\"()V\", (void*)&WB_TakeLockAndHangInSafepoint},\n+  {CC\"lockAndStuckInSafepoint\", CC\"()V\",              (void*)&WB_TakeLockAndHangInSafepoint},\n+  {CC\"getMinimumJavaStackSize\", CC\"()J\",              (void*)&WB_GetMinimumJavaStackSize},\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2580,0 +2580,4 @@\n+jlong os::get_minimum_java_stack_size() {\n+  return static_cast<jlong>(_java_thread_min_stack_allowed);\n+}\n+\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -393,0 +393,2 @@\n+  \/\/ get allowed minimum java stack size\n+  static jlong get_minimum_java_stack_size();\n","filename":"src\/hotspot\/share\/runtime\/os.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,0 +32,1 @@\n+ * @library \/test\/lib\n@@ -34,1 +35,3 @@\n- * @run main\/othervm -Xss384K -Xint TestStackOverflowDuringInit\n+ * @build jdk.test.whitebox.WhiteBox\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller jdk.test.whitebox.WhiteBox\n+ * @run main\/othervm -Xbootclasspath\/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI TestStackOverflowDuringInit\n@@ -39,0 +42,3 @@\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+import jdk.test.whitebox.WhiteBox;\n@@ -42,0 +48,3 @@\n+    static String expected = \"java.lang.NoClassDefFoundError: Could not initialize class TestStackOverflowDuringInit$LongCache\";\n+    static String cause = \"Caused by: java.lang.StackOverflowError\";\n+\n@@ -91,3 +100,2 @@\n-    public static void main(String[] args) throws Exception {\n-        String expected = \"java.lang.NoClassDefFoundError: Could not initialize class TestStackOverflowDuringInit$LongCache\";\n-        String cause = \"Caused by: java.lang.StackOverflowError\";\n+    static class Launcher {\n+        public static void main(String[] args) throws Exception {\n@@ -95,11 +103,12 @@\n-        \/\/ Pre-load, but not initialize, LongCache, else we will\n-        \/\/ hit SOE during class loading.\n-        System.out.println(\"Pre-loading ...\");\n-        Class<?> c = Class.forName(\"TestStackOverflowDuringInit$LongCache\",\n-                                   false,\n-                                   TestStackOverflowDuringInit.class.getClassLoader());\n-        try {\n-            recurse();\n-        } catch (Throwable ex) {\n-            \/\/            ex.printStackTrace();\n-            verify_stack(ex, expected, cause);\n+            \/\/ Pre-load, but not initialize, LongCache, else we will\n+            \/\/ hit SOE during class loading.\n+            System.out.println(\"Pre-loading ...\");\n+            Class<?> c = Class.forName(\"TestStackOverflowDuringInit$LongCache\",\n+                                       false,\n+                                       TestStackOverflowDuringInit.class.getClassLoader());\n+            try {\n+                recurse();\n+            } catch (Throwable ex) {\n+                \/\/            ex.printStackTrace();\n+                verify_stack(ex, expected, cause);\n+            }\n@@ -107,1 +116,0 @@\n-    }\n@@ -109,10 +117,11 @@\n-    private static void verify_stack(Throwable e, String expected, String cause) throws Exception {\n-        ByteArrayOutputStream byteOS = new ByteArrayOutputStream();\n-        try (PrintStream printStream = new PrintStream(byteOS)) {\n-            e.printStackTrace(printStream);\n-        }\n-        String stackTrace = byteOS.toString(\"ASCII\");\n-        System.out.println(stackTrace);\n-        if (!stackTrace.contains(expected) ||\n-            (cause != null && !stackTrace.contains(cause))) {\n-            throw new RuntimeException(expected + \" and\/or \" + cause + \" missing from stacktrace\");\n+        private static void verify_stack(Throwable e, String expected, String cause) throws Exception {\n+            ByteArrayOutputStream byteOS = new ByteArrayOutputStream();\n+            try (PrintStream printStream = new PrintStream(byteOS)) {\n+                e.printStackTrace(printStream);\n+            }\n+            String stackTrace = byteOS.toString(\"ASCII\");\n+            System.out.println(stackTrace);\n+            if (!stackTrace.contains(expected) ||\n+                (cause != null && !stackTrace.contains(cause))) {\n+                throw new RuntimeException(expected + \" and\/or \" + cause + \" missing from stacktrace\");\n+            }\n@@ -121,0 +130,13 @@\n+\n+    public static void main(String[] args) throws Exception {\n+        WhiteBox wb = WhiteBox.getWhiteBox();\n+        long minimumJavaStackSize = wb.getMinimumJavaStackSize();\n+        ProcessBuilder pb = ProcessTools.createLimitedTestJavaProcessBuilder(\n+                \"-Xss\" + Long.toString(minimumJavaStackSize), \"-Xint\",\n+                Launcher.class.getName());\n+\n+        OutputAnalyzer analyzer = new OutputAnalyzer(pb.start());\n+        analyzer.shouldHaveExitValue(0);\n+        analyzer.shouldContain(expected);\n+        analyzer.shouldContain(cause);\n+    }\n","filename":"test\/hotspot\/jtreg\/runtime\/ClassInitErrors\/TestStackOverflowDuringInit.java","additions":49,"deletions":27,"binary":false,"changes":76,"status":"modified"},{"patch":"@@ -80,0 +80,1 @@\n+  public native long getMinimumJavaStackSize();\n","filename":"test\/lib\/jdk\/test\/whitebox\/WhiteBox.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}