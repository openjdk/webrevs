{"files":[{"patch":"@@ -37,0 +37,1 @@\n+    private static final long NANOS_PER_SECOND = 1000_000_000L;\n@@ -167,1 +168,2 @@\n-        private int count;\n+        private long count;\n+        private boolean hasOverflowed;\n@@ -171,4 +173,19 @@\n-            if (value instanceof Duration duration) {\n-                seconds += duration.getSeconds();\n-                nanos += duration.getNano();\n-                count++;\n+            if (hasOverflowed) {\n+                return;\n+            }\n+            if (value instanceof Duration d) {\n+                try {\n+                    \/\/ Code copied from Duration::plus\n+                    long secondsToAdd = d.getSeconds();\n+                    long nanosToAdd = d.getNano();\n+                    if ((secondsToAdd | nanosToAdd) == 0) {\n+                        return;\n+                    }\n+                    long s = Math.addExact(seconds, secondsToAdd);\n+                    seconds = Math.addExact(s, nanosToAdd \/ NANOS_PER_SECOND);\n+                    nanos = nanos + nanosToAdd % NANOS_PER_SECOND;\n+                    count++;\n+                } catch (ArithmeticException ae) {\n+                    hasOverflowed = true;\n+                    count = 0;\n+                }\n@@ -348,0 +365,1 @@\n+        private boolean hasOverflowed;\n@@ -351,0 +369,3 @@\n+            if (hasOverflowed) {\n+                return;\n+            }\n@@ -352,3 +373,15 @@\n-                seconds += n.getSeconds();\n-                nanos += n.getNano();\n-                hasValue = true;\n+                try {\n+                    \/\/ Code copied from Duration::plus\n+                    long secondsToAdd = n.getSeconds();\n+                    long nanosToAdd = n.getNano();\n+                    if ((secondsToAdd | nanosToAdd) == 0) {\n+                        return;\n+                    }\n+                    long s = Math.addExact(seconds, secondsToAdd);\n+                    seconds = Math.addExact(s, nanosToAdd \/ NANOS_PER_SECOND);\n+                    nanos = nanos + nanosToAdd % NANOS_PER_SECOND;\n+                    hasValue = true;;\n+                } catch (ArithmeticException ae) {\n+                    hasOverflowed = true;\n+                    hasValue = false;\n+                }\n@@ -366,0 +399,1 @@\n+        private boolean hasOverflowed;\n@@ -370,0 +404,3 @@\n+            if (hasOverflowed) {\n+                return;\n+            }\n@@ -371,2 +408,7 @@\n-                sum += n.longValue();\n-                hasValue = true;\n+                try {\n+                    sum = Math.addExact(sum, n.longValue());\n+                    hasValue = true;\n+                } catch (ArithmeticException ae) {\n+                    hasOverflowed = true;\n+                    hasValue = false;\n+                }\n@@ -439,1 +481,5 @@\n-                return last.longValue() - first.longValue();\n+                try {\n+                    return Math.subtractExact(last.longValue(), first.longValue());\n+                } catch (ArithmeticException ae) {\n+                    return null;\n+                }\n@@ -531,1 +577,1 @@\n-                long nanos = 1_000_000_000L * duration.getSeconds() + duration.getNano();\n+                double nanos = 1_000_000_000.0 * duration.getSeconds() + duration.getNano();\n","filename":"src\/jdk.jfr\/share\/classes\/jdk\/jfr\/internal\/query\/Function.java","additions":58,"deletions":12,"binary":false,"changes":70,"status":"modified"}]}