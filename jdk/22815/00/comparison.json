{"files":[{"patch":"@@ -1267,7 +1267,0 @@\n-  \/\/ Start with ceiling based on a per-thread estimate:\n-  size_t ceiling = ObjectSynchronizer::in_use_list_ceiling();\n-  size_t old_ceiling = ceiling;\n-  if (ceiling < list->max()) {\n-    \/\/ The max used by the system has exceeded the ceiling so use that:\n-    ceiling = list->max();\n-  }\n@@ -1278,11 +1271,4 @@\n-  if (NoAsyncDeflationProgressMax != 0 &&\n-      _no_progress_cnt >= NoAsyncDeflationProgressMax) {\n-    double remainder = (100.0 - MonitorUsedDeflationThreshold) \/ 100.0;\n-    size_t new_ceiling = ceiling + (size_t)((double)ceiling * remainder) + 1;\n-    ObjectSynchronizer::set_in_use_list_ceiling(new_ceiling);\n-    log_info(monitorinflation)(\"Too many deflations without progress; \"\n-                               \"bumping in_use_list_ceiling from \" SIZE_FORMAT\n-                               \" to \" SIZE_FORMAT, old_ceiling, new_ceiling);\n-    _no_progress_cnt = 0;\n-    ceiling = new_ceiling;\n-  }\n+  size_t old_ceiling = ObjectSynchronizer::in_use_list_ceiling();\n+  \/\/ Make sure the we use a ceiling value that is not lower than the\n+  \/\/ max used by the system, and not zero.\n+  size_t ceiling = MAX3(old_ceiling, list->max(), monitors_used);\n@@ -1293,0 +1279,23 @@\n+    bool status = true;\n+\n+    \/\/ Check if we it's time to adjust the in_use_list_ceiling up, due\n+    \/\/ to too many async deflation attempts without any progress.\n+    if (NoAsyncDeflationProgressMax != 0 &&\n+        _no_progress_cnt >= NoAsyncDeflationProgressMax) {\n+      double remainder = (100.0 - MonitorUsedDeflationThreshold) \/ 100.0;\n+      size_t new_ceiling = ceiling + (size_t)((double)ceiling * remainder) + 1;\n+\n+      if (new_ceiling < old_ceiling) {\n+        new_ceiling = SIZE_MAX; \/\/ Wrap around, let's clamp new_ceiling.\n+      }\n+      ObjectSynchronizer::set_in_use_list_ceiling(new_ceiling);\n+      log_info(monitorinflation)(\"Too many deflations without progress; \"\n+                                 \"bumping in_use_list_ceiling from \" SIZE_FORMAT\n+                                 \" to \" SIZE_FORMAT, old_ceiling, new_ceiling);\n+      _no_progress_cnt = 0;\n+      ceiling = new_ceiling;\n+\n+      \/\/ Check if our monitor usage is still above the threshold:\n+      monitor_usage = (monitors_used * 100LL) \/ ceiling;\n+      status = int(monitor_usage) > MonitorUsedDeflationThreshold;\n+    }\n@@ -1296,1 +1305,1 @@\n-    return true;\n+    return status;\n","filename":"src\/hotspot\/share\/runtime\/synchronizer.cpp","additions":28,"deletions":19,"binary":false,"changes":47,"status":"modified"}]}