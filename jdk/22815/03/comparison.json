{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -1267,7 +1267,0 @@\n-  \/\/ Start with ceiling based on a per-thread estimate:\n-  size_t ceiling = ObjectSynchronizer::in_use_list_ceiling();\n-  size_t old_ceiling = ceiling;\n-  if (ceiling < list->max()) {\n-    \/\/ The max used by the system has exceeded the ceiling so use that:\n-    ceiling = list->max();\n-  }\n@@ -1278,11 +1271,6 @@\n-  if (NoAsyncDeflationProgressMax != 0 &&\n-      _no_progress_cnt >= NoAsyncDeflationProgressMax) {\n-    double remainder = (100.0 - MonitorUsedDeflationThreshold) \/ 100.0;\n-    size_t new_ceiling = ceiling + (size_t)((double)ceiling * remainder) + 1;\n-    ObjectSynchronizer::set_in_use_list_ceiling(new_ceiling);\n-    log_info(monitorinflation)(\"Too many deflations without progress; \"\n-                               \"bumping in_use_list_ceiling from \" SIZE_FORMAT\n-                               \" to \" SIZE_FORMAT, old_ceiling, new_ceiling);\n-    _no_progress_cnt = 0;\n-    ceiling = new_ceiling;\n-  }\n+  size_t old_ceiling = ObjectSynchronizer::in_use_list_ceiling();\n+  \/\/ Make sure that we use a ceiling value that is not lower than\n+  \/\/ previous, not lower than the recorded max used by the system, and\n+  \/\/ not lower than the current number of monitors in use (which can\n+  \/\/ race ahead of max). The result is guaranteed > 0.\n+  size_t ceiling = MAX3(old_ceiling, list->max(), monitors_used);\n@@ -1293,0 +1281,25 @@\n+    \/\/ Deflate monitors if over the threshold percentage, unless no\n+    \/\/ progress on previous deflations.\n+    bool is_above_threshold = true;\n+\n+    \/\/ Check if it's time to adjust the in_use_list_ceiling up, due\n+    \/\/ to too many async deflation attempts without any progress.\n+    if (NoAsyncDeflationProgressMax != 0 &&\n+        _no_progress_cnt >= NoAsyncDeflationProgressMax) {\n+      double remainder = (100.0 - MonitorUsedDeflationThreshold) \/ 100.0;\n+      size_t delta = (size_t)(ceiling * remainder) + 1;\n+      size_t new_ceiling = (ceiling > SIZE_MAX - delta)\n+        ? SIZE_MAX         \/\/ Overflow, let's clamp new_ceiling.\n+        : ceiling + delta;\n+\n+      ObjectSynchronizer::set_in_use_list_ceiling(new_ceiling);\n+      log_info(monitorinflation)(\"Too many deflations without progress; \"\n+                                 \"bumping in_use_list_ceiling from \" SIZE_FORMAT\n+                                 \" to \" SIZE_FORMAT, old_ceiling, new_ceiling);\n+      _no_progress_cnt = 0;\n+      ceiling = new_ceiling;\n+\n+      \/\/ Check if our monitor usage is still above the threshold:\n+      monitor_usage = (monitors_used * 100LL) \/ ceiling;\n+      is_above_threshold = int(monitor_usage) > MonitorUsedDeflationThreshold;\n+    }\n@@ -1296,1 +1309,1 @@\n-    return true;\n+    return is_above_threshold;\n","filename":"src\/hotspot\/share\/runtime\/synchronizer.cpp","additions":33,"deletions":20,"binary":false,"changes":53,"status":"modified"}]}