{"files":[{"patch":"@@ -169,2 +169,4 @@\n-        for (Field f : receiverType.getDeclaredFields()) {\n-            if (Modifier.isStatic(f.getModifiers())) continue;\n+        \/\/ The receiver may be a referenced class different from the declaring class\n+        for (var declaringClass = receiverType; declaringClass != null; declaringClass = declaringClass.getSuperclass()) {\n+            for (Field f : declaringClass.getDeclaredFields()) {\n+                if (Modifier.isStatic(f.getModifiers())) continue;\n@@ -172,3 +174,4 @@\n-            if (offset == UNSAFE.objectFieldOffset(f)) {\n-                assert f.getType() == fieldType;\n-                return f;\n+                if (offset == UNSAFE.objectFieldOffset(f)) {\n+                    assert f.getType() == fieldType;\n+                    return f;\n+                }\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/VarHandles.java","additions":8,"deletions":5,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -24,1 +24,1 @@\n-\/**\n+\/*\n@@ -26,1 +26,1 @@\n- * @bug 8302260\n+ * @bug 8302260 8372002\n@@ -32,1 +32,0 @@\n-import java.lang.constant.ClassDesc;\n@@ -35,1 +34,0 @@\n-import java.lang.invoke.VarHandle;\n@@ -46,1 +44,1 @@\n-    private static Stream<Arguments> testCases() {\n+    private static Stream<Arguments> staticTestCases() {\n@@ -71,2 +69,2 @@\n-    @MethodSource(\"testCases\")\n-    void test(Class<?> refc, String name, Class<?> type, Class<?> declaringClass, Object value) throws Throwable {\n+    @MethodSource(\"staticTestCases\")\n+    void testStatic(Class<?> refc, String name, Class<?> type, Class<?> declaringClass, Object value) throws Throwable {\n@@ -87,0 +85,31 @@\n+    private static Arguments[] instanceTestCases() {\n+        return new Arguments[] {\n+                \/\/ Basic instance field in p.q.Q\n+                Arguments.of(p.q.Q.class, \"instanceIntField\", int.class, new p.q.Q(), 42),\n+                \/\/ p.C.instanceIntField hides the superclass instanceIntField, but it still exists\n+                Arguments.of(p.C.class, \"instanceIntField\", int.class, new p.C(), 76),\n+                Arguments.of(p.q.Q.class, \"instanceIntField\", int.class, new p.C(), 42),\n+                \/\/ p.D.instanceIntField points to that of p.q.Q\n+                Arguments.of(p.D.class, \"instanceIntField\", int.class, new p.D(), 42),\n+        };\n+    }\n+\n+    @ParameterizedTest\n+    @MethodSource(\"instanceTestCases\")\n+    void testInstance(Class<?> refc, String name, Class<?> type, Object instance, Object value) throws Throwable {\n+        var vh = LOOKUP.findVarHandle(refc, name, type).withInvokeBehavior();\n+        assertEquals(value, vh.get(instance));\n+\n+        var refcDesc = refc.describeConstable().orElseThrow();\n+        var typeDesc = type.describeConstable().orElseThrow();\n+        var vhd = vh.describeConstable().orElseThrow();\n+        var vhd2 = VarHandleDesc.ofField(refcDesc, name, typeDesc);\n+\n+        assertEquals(value, vhd.resolveConstantDesc(LOOKUP).get(instance));\n+        assertEquals(value, vhd2.resolveConstantDesc(LOOKUP).get(instance));\n+\n+        \/\/ The string does not use the declaring class because\n+        \/\/ receiver is restricted on the handle\n+        assertEquals(vhd.toString(), varHandleDescString(refc, name, type, false));\n+    }\n+\n","filename":"test\/jdk\/java\/lang\/invoke\/VarHandles\/describeConstable\/DescribeConstableTest.java","additions":37,"deletions":8,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,2 @@\n+\n+    public int instanceIntField = 76; \/\/ Hides the field from Q\n","filename":"test\/jdk\/java\/lang\/invoke\/VarHandles\/describeConstable\/p\/C.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,0 +32,2 @@\n+\n+    public int instanceIntField = 42;\n","filename":"test\/jdk\/java\/lang\/invoke\/VarHandles\/describeConstable\/p\/q\/Q.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"}]}