{"files":[{"patch":"@@ -367,0 +367,9 @@\n+        \/\/ If the embedded runtime contains executable(s) in the \"bin\"\n+        \/\/ subdirectory, we should use the standalone runtime info plist\n+        \/\/ template. Otherwise, the user may be unable to run the \"java\"\n+        \/\/ or other executables in the \"bin\" subdirectory of the embedded\n+        \/\/ runtime.\n+        final var useRuntimeInfoPlist = app.isRuntime() ||\n+                app.runtimeBuilder().orElseThrow().withNativeCommands() ||\n+                Files.isDirectory(env.resolvedLayout().runtimeDirectory().resolve(\"bin\"));\n+\n@@ -372,1 +381,1 @@\n-        if (app.isRuntime()) {\n+        if (useRuntimeInfoPlist) {\n@@ -380,1 +389,1 @@\n-        if (app.isRuntime()) {\n+        if (useRuntimeInfoPlist) {\n@@ -382,0 +391,7 @@\n+        } else {\n+            template = \"ApplicationRuntime-Info.plist.template\";\n+        }\n+\n+        \/\/ Public name and category should be based on standalone runtime vs\n+        \/\/ embedded runtime.\n+        if (app.isRuntime()) {\n@@ -385,1 +401,0 @@\n-            template = \"ApplicationRuntime-Info.plist.template\";\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/MacPackagingPipeline.java","additions":18,"deletions":3,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -86,0 +86,5 @@\n+    @Override\n+    public boolean withNativeCommands() {\n+        return !jlinkCmdLine.contains(\"--strip-native-commands\");\n+    }\n+\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/JLinkRuntimeBuilder.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -49,0 +49,10 @@\n+    \/**\n+     * Returns {@code true} if \"--strip-native-commands\" was not used with jlink.\n+     * Default implementation returns {@code false}.\n+     *\n+     * @return {@code true} if \"--strip-native-commands\" was not used with jlink\n+     *\/\n+    default boolean withNativeCommands() {\n+        return false;\n+    }\n+\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/RuntimeBuilder.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -309,8 +309,0 @@\n-            Files.createDirectories(fakeRuntimeDir);\n-\n-            if (TKit.isLinux()) {\n-                \/\/ Need to make the code in rpm spec happy as it assumes there is\n-                \/\/ always something in application image.\n-                fakeRuntimeDir.resolve(\"bin\").toFile().mkdir();\n-            }\n-\n@@ -323,1 +315,1 @@\n-            \/\/ Mak sure fake runtime takes some disk space.\n+            \/\/ Make sure fake runtime takes some disk space.\n@@ -326,1 +318,1 @@\n-            createBulkFile.accept(fakeRuntimeDir.resolve(Path.of(\"bin\", \"bulk\")));\n+            createBulkFile.accept(fakeRuntimeDir.resolve(Path.of(\"lib\", \"bulk\")));\n@@ -1230,0 +1222,18 @@\n+        MAC_RUNTIME_PLIST_JDK_KEY(cmd -> {\n+            if (TKit.isOSX()) {\n+                var appLayout = cmd.appLayout();\n+                var plistPath = appLayout.runtimeDirectory().resolve(\"Contents\/Info.plist\");\n+                var keyName = \"JavaVM\";\n+                var keyValue = MacHelper.readPList(plistPath).findDictValue(keyName);\n+                if (cmd.isRuntime() || Files.isDirectory(appLayout.runtimeHomeDirectory().resolve(\"bin\"))) {\n+                    \/\/ There are native launchers in the runtime\n+                    TKit.assertTrue(keyValue.isPresent(), String.format(\n+                            \"Check the runtime plist file [%s] contains '%s' key\",\n+                            plistPath, keyName));\n+                } else {\n+                    TKit.assertTrue(keyValue.isEmpty(), String.format(\n+                            \"Check the runtime plist file [%s] contains NO '%s' key\",\n+                            plistPath, keyName));\n+                }\n+            }\n+        }),\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/JPackageCommand.java","additions":20,"deletions":10,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import static jdk.jpackage.internal.util.PListWriter.writeKey;\n@@ -434,0 +435,4 @@\n+                    writeKey(xml, \"JavaVM\");\n+                    writeDict(xml, toXmlConsumer(() -> {\n+                        writeString(xml, \"JVMVersion\", value(\"CF_BUNDLE_VERSION\", cmd.version()));\n+                    }));\n","filename":"test\/jdk\/tools\/jpackage\/macosx\/CustomInfoPListTest.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -123,1 +123,2 @@\n-                    StandardAssert.RUNTIME_DIRECTORY);\n+                    StandardAssert.RUNTIME_DIRECTORY,\n+                    StandardAssert.MAC_RUNTIME_PLIST_JDK_KEY);\n","filename":"test\/jdk\/tools\/jpackage\/share\/AppImagePackageTest.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -54,1 +54,1 @@\n-            String runtimeSubdir) {\n+            String runtimeSubdir, boolean withNativeCommands) {\n@@ -58,0 +58,1 @@\n+        this.withNativeCommands = withNativeCommands;\n@@ -93,0 +94,4 @@\n+        if (!withNativeCommands) {\n+            jlink.addArgument(\"--strip-native-commands\");\n+        }\n+\n@@ -130,1 +135,8 @@\n-                data.add(new Object[] { javaAppDesc, pathCfg[0], pathCfg[1] });\n+                if (TKit.isOSX()) {\n+                    \/\/ On OSX platform we need to test both runtime root and runtime home\n+                    \/\/ directories with and without \"bin\" folder.\n+                    data.add(new Object[] { javaAppDesc, pathCfg[0], pathCfg[1], true });\n+                    data.add(new Object[] { javaAppDesc, pathCfg[0], pathCfg[1], false });\n+                } else {\n+                    data.add(new Object[] { javaAppDesc, pathCfg[0], pathCfg[1], true });\n+                }\n@@ -140,0 +152,1 @@\n+    private final boolean withNativeCommands;\n","filename":"test\/jdk\/tools\/jpackage\/share\/CookedRuntimeTest.java","additions":15,"deletions":2,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -143,1 +143,1 @@\n-                    final Path runtimeBinDir = runtimeDir.resolve(\"bin\");\n+                    final Path runtimeLibDir = runtimeDir.resolve(\"lib\");\n@@ -151,2 +151,2 @@\n-                                String.format(\"WScript.Echo('Probe directory: %s')\", runtimeBinDir),\n-                                String.format(\"fs.GetFolder('%s')\", runtimeBinDir.toString().replace('\\\\', '\/'))\n+                                String.format(\"WScript.Echo('Probe directory: %s')\", runtimeLibDir),\n+                                String.format(\"fs.GetFolder('%s')\", runtimeLibDir.toString().replace('\\\\', '\/'))\n@@ -159,2 +159,2 @@\n-                                String.format(\"printf 'Probe directory: %%s\\\\n' '%s'\", runtimeBinDir),\n-                                String.format(\"[ -d '%s' ]\", runtimeBinDir)\n+                                String.format(\"printf 'Probe directory: %%s\\\\n' '%s'\", runtimeLibDir),\n+                                String.format(\"[ -d '%s' ]\", runtimeLibDir)\n","filename":"test\/jdk\/tools\/jpackage\/share\/PostImageScriptTest.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"}]}