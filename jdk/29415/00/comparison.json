{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -52,1 +52,0 @@\n-import javax.net.ssl.SSLHandshakeException;\n@@ -68,0 +67,1 @@\n+import java.util.Objects;\n@@ -77,0 +77,1 @@\n+import java.util.concurrent.Semaphore;\n@@ -90,0 +91,1 @@\n+import static org.testng.Assert.assertNotEquals;\n@@ -95,0 +97,5 @@\n+    private static final ConcurrentHashMap<String, Semaphore> semaphores\n+            = new ConcurrentHashMap<>();\n+    \/\/ A number big enough to make sure nothing else could\n+    \/\/ be blocked trying to acquire a released semaphore.\n+    private static final int RELEASE_ALL = 1000;\n@@ -120,0 +127,1 @@\n+    static final AtomicLong requestCount = new AtomicLong();\n@@ -281,1 +289,2 @@\n-        var builder = HttpRequest.newBuilder(URI.create(uri));\n+        var u = URI.create(uri+\"?req=\"+requestCount.incrementAndGet());\n+        var builder = HttpRequest.newBuilder(u);\n@@ -327,0 +336,18 @@\n+    private static void releaseSemaphores() {\n+        \/\/ release left over semaphores\n+        for (var sem : semaphores.values()) {\n+            sem.release(RELEASE_ALL);\n+        }\n+        semaphores.clear();\n+    }\n+\n+    private static Semaphore addSemaphoreFor(HttpRequest req) {\n+        \/\/ release left over semaphores\n+        releaseSemaphores();\n+        String key = Objects.requireNonNull(req.uri().getRawQuery(), \"query\");\n+        var sem = new Semaphore(0);\n+        semaphores.put(key, sem);\n+        out.println(now() + \"Semaphore \" + sem + \" added for \" + req.uri());\n+        return sem;\n+    }\n+\n@@ -346,0 +373,2 @@\n+            var sem = addSemaphoreFor(req);\n+\n@@ -348,0 +377,1 @@\n+            out.println(now() + \"Sending (async): \" + req.uri());\n@@ -351,1 +381,1 @@\n-            out.println(\"iteration: \" + i + \", req: \" + req.uri());\n+            out.println(now() + \"iteration: \" + i + \", req sent: \" + req.uri());\n@@ -357,1 +387,1 @@\n-            out.println(\"response after cancel: \" + response);\n+            out.println(now() + \"response after cancel: \" + response);\n@@ -362,0 +392,1 @@\n+                sem.release(RELEASE_ALL);\n@@ -365,1 +396,2 @@\n-                out.println(\"Got expected exception: \" + x);\n+                sem.release(RELEASE_ALL);\n+                out.println(now() + \"Got expected exception: \" + x);\n@@ -374,1 +406,1 @@\n-                out.println(\"Got expected exception: \" + x);\n+                out.println(now() + \"Got expected exception: \" + x);\n@@ -396,1 +428,1 @@\n-                        out.println(\"CancellationException cause: \" + x);\n+                        out.println(now() + \"CancellationException cause: \" + x);\n@@ -406,1 +438,1 @@\n-                    out.println(\"Unexpected cause: \" + cause.getClass());\n+                    out.println(now() + \"Unexpected cause: \" + cause.getClass());\n@@ -411,1 +443,1 @@\n-                    out.println(\"Got expected exception: \" + wrapped);\n+                    out.println(now() + \"Got expected exception: \" + wrapped);\n@@ -414,1 +446,1 @@\n-                    out.println(\"Unexpected exception: \" + wrapped);\n+                    out.println(now() + \"Unexpected exception: \" + wrapped);\n@@ -455,2 +487,3 @@\n-                    \/\/ this is dangerous\n-                    out.println(\"waiting for completion on: \" + cancelFuture);\n+                    \/\/ this is dangerous - so we use a virtual thread\n+                    \/\/ to avoid starving the executor\n+                    out.println(now() + \"waiting for completion on: \" + cancelFuture);\n@@ -459,1 +492,1 @@\n-                        out.println(\"Cancelling from \" + Thread.currentThread());\n+                        out.println(now() + \"Cancelling from \" + Thread.currentThread());\n@@ -462,1 +495,1 @@\n-                        out.println(\"cancelled \" + cf1);\n+                        out.println(now() + \"cancelled \" + cf1);\n@@ -464,1 +497,1 @@\n-                    if (async) executor.execute(cancel);\n+                    if (async) Thread.ofVirtual().start(cancel);\n@@ -477,0 +510,2 @@\n+            var sem = addSemaphoreFor(req);\n+\n@@ -479,0 +514,1 @@\n+            out.println(now() + \"Sending (async): \" + req.uri());\n@@ -480,1 +516,1 @@\n-            var cf1 = response.whenComplete((r,t) -> System.out.println(t));\n+            var cf1 = response.whenComplete((r,t) -> System.out.println(now() + t));\n@@ -482,0 +518,1 @@\n+            out.println(now() + \"iteration: \" + i + \", req sent: \" + req.uri());\n@@ -486,1 +523,1 @@\n-            out.println(\"response after cancel: \" + response);\n+            out.println(now() + \"response after cancel: \" + response);\n@@ -491,0 +528,1 @@\n+                sem.release(RELEASE_ALL);\n@@ -494,1 +532,2 @@\n-                out.println(\"Got expected exception: \" + x);\n+                sem.release(RELEASE_ALL);\n+                out.println(now() + \"Got expected exception: \" + x);\n@@ -503,1 +542,1 @@\n-                out.println(\"Got expected exception: \" + x);\n+                out.println(now() + \"Got expected exception: \" + x);\n@@ -524,1 +563,1 @@\n-                    out.println(\"CancellationException cause: \" + x);\n+                    out.println(now() + \"CancellationException cause: \" + x);\n@@ -534,1 +573,1 @@\n-                    out.println(\"Got expected exception: \" + wrapped);\n+                    out.println(now() + \"Got expected exception: \" + wrapped);\n@@ -537,1 +576,1 @@\n-                    out.println(\"Unexpected exception: \" + wrapped);\n+                    out.println(now() + \"Unexpected exception: \" + wrapped);\n@@ -574,1 +613,1 @@\n-            var uriStr = uri + \"\/post\/req=\" + i;\n+            var uriStr = uri + \"\/post\/i=\" + i;\n@@ -584,1 +623,1 @@\n-                if (async) executor.execute(interrupt);\n+                if (async) Thread.ofVirtual().start(interrupt);\n@@ -596,0 +635,2 @@\n+            var sem = addSemaphoreFor(req);\n+\n@@ -599,1 +640,1 @@\n-                out.println(\"Sending: \" + uriStr);\n+                out.println(now() + \"Sending: \" + req.uri());\n@@ -604,1 +645,2 @@\n-            out.println(uriStr + \": got result or exception\");\n+            sem.release(RELEASE_ALL);\n+            out.println(now() + req.uri() + \": got result or exception\");\n@@ -606,1 +648,1 @@\n-                out.println(uriStr + \": Got expected exception: \" + failed);\n+                out.println(now() + req.uri() + \": Got expected exception: \" + failed);\n@@ -608,1 +650,1 @@\n-                out.println(uriStr + \": got IOException: \" + failed);\n+                out.println(now() + req.uri() + \": got IOException: \" + failed);\n@@ -614,1 +656,1 @@\n-                    out.println(uriStr + \": Accepting IOException: \" + failed);\n+                    out.println(now() + req.uri() + \": Accepting IOException: \" + failed);\n@@ -617,1 +659,1 @@\n-                    out.println(uriStr + \": unexpected exception: \" + failed);\n+                    out.println(now() + req.uri() + \": unexpected exception: \" + failed);\n@@ -621,1 +663,1 @@\n-                out.println(uriStr + \": unexpected exception: \" + failed);\n+                out.println(now() + req.uri() + \": unexpected exception: \" + failed);\n@@ -625,1 +667,1 @@\n-                out.println(uriStr + \": got body: \" + body);\n+                out.println(now() + req.uri() + \": got body: \" + body);\n@@ -628,1 +670,1 @@\n-            out.println(\"next iteration\");\n+            out.println(now() + \"next iteration\");\n@@ -703,1 +745,1 @@\n-                    System.err.println(\"Shared client name is: \" + sharedClientName);\n+                    System.err.println(now() + \"Shared client name is: \" + sharedClientName);\n@@ -722,3 +764,3 @@\n-                out.println(\"HTTPSlowHandler received request to \" + t.getRequestURI());\n-                System.err.println(\"HTTPSlowHandler received request to \" + t.getRequestURI());\n-\n+                out.println(now() + \"HTTPSlowHandler received request to \" + t.getRequestURI());\n+                System.err.println(now() + \"HTTPSlowHandler received request to \" + t.getRequestURI());\n+                var sem = semaphores.get(t.getRequestURI().getRawQuery());\n@@ -732,1 +774,1 @@\n-                    \/\/ lets split the response in several chunks...\n+                    \/\/ let's split the response in several chunks...\n@@ -746,1 +788,11 @@\n-                        out.printf(\"Server wrote %d bytes%n\", req.length);\n+                        out.printf(now() + \"Server wrote %d bytes%n\", req.length);\n+                    }\n+                    if (sem != null) {\n+                        out.printf(now() + \"Server waiting to acquire %s for %s%n\",\n+                                sem, t.getRequestURI());\n+                        try {\n+                            sem.acquire();\n+                        } catch (InterruptedException e) {\n+                            Thread.currentThread().interrupt();\n+                        }\n+                        out.printf(now() + \" ...sem acquired%n\");\n@@ -750,1 +802,1 @@\n-                out.println(\"HTTPSlowHandler: unexpected exception: \" + e);\n+                out.println(now() + \"HTTPSlowHandler: unexpected exception: \" + e);\n@@ -754,2 +806,2 @@\n-                out.printf(\"HTTPSlowHandler reply sent: %s%n\", t.getRequestURI());\n-                System.err.printf(\"HTTPSlowHandler reply sent: %s%n\", t.getRequestURI());\n+                out.printf(now() + \"HTTPSlowHandler reply sent: %s%n\", t.getRequestURI());\n+                System.err.printf(now() + \"HTTPSlowHandler reply sent: %s%n\", t.getRequestURI());\n","filename":"test\/jdk\/java\/net\/httpclient\/CancelRequestTest.java","additions":95,"deletions":43,"binary":false,"changes":138,"status":"modified"}]}