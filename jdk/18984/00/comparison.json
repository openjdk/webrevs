{"files":[{"patch":"@@ -1039,0 +1039,1 @@\n+  nmethod::ResultStatus result_status = nmethod::passed;\n@@ -1127,1 +1128,2 @@\n-                               compiler, CompLevel(task()->comp_level()));\n+                               compiler, CompLevel(task()->comp_level()),\n+                               result_status);\n@@ -1133,0 +1135,1 @@\n+      assert(result_status == nmethod::passed, \"sanity\");\n@@ -1187,2 +1190,7 @@\n-    \/\/ The CodeCache is full.\n-    record_failure(\"code cache is full\");\n+    \/\/ The CodeCache is full or out of memeory.\n+    if (result_status == nmethod::code_cache_full) {\n+      record_failure(\"code cache is full\");\n+    } else {\n+      assert(result_status == nmethod::out_of_memory, \"sanity\");\n+      record_failure(\"out of memory to allocate immutable data\");\n+    }\n","filename":"src\/hotspot\/share\/ci\/ciEnv.cpp","additions":11,"deletions":3,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -113,0 +113,5 @@\n+\/\/ Cast from int value to narrow type\n+#define CHECKED_CAST(result, T, thing)      \\\n+  result = static_cast<T>(thing); \\\n+  assert(static_cast<int>(result) == thing, \"failed: %d != %d\", static_cast<int>(result), thing);\n+\n@@ -124,1 +129,2 @@\n-  uint total_size;\n+  uint total_nm_size;\n+  uint total_immut_size;\n@@ -129,2 +135,2 @@\n-  uint scopes_data_size;\n-  uint scopes_pcs_size;\n+  uint oops_size;\n+  uint metadata_size;\n@@ -132,1 +138,0 @@\n-  uint handler_table_size;\n@@ -134,0 +139,3 @@\n+  uint handler_table_size;\n+  uint scopes_pcs_size;\n+  uint scopes_data_size;\n@@ -138,2 +146,0 @@\n-  uint oops_size;\n-  uint metadata_size;\n@@ -143,1 +149,2 @@\n-    total_size          += nm->size();\n+    total_nm_size       += nm->size();\n+    total_immut_size    += nm->immutable_data_size();\n@@ -163,1 +170,5 @@\n-    if (total_size != 0)          tty->print_cr(\" total in heap  = %u (100%%)\", total_size);\n+    uint total_size = total_nm_size + total_immut_size;\n+    if (total_nm_size != 0) {\n+      tty->print_cr(\" total size      = %u (100%%)\", total_size);\n+      tty->print_cr(\" in CodeCache    = %u (%f%%)\", total_nm_size, (total_nm_size * 100.0f)\/total_size);\n+    }\n@@ -165,12 +176,39 @@\n-    if (nmethod_count != 0)       tty->print_cr(\" header         = %u (%f%%)\", header_size, (header_size * 100.0f)\/total_size);\n-    if (relocation_size != 0)     tty->print_cr(\" relocation     = %u (%f%%)\", relocation_size, (relocation_size * 100.0f)\/total_size);\n-    if (consts_size != 0)         tty->print_cr(\" constants      = %u (%f%%)\", consts_size, (consts_size * 100.0f)\/total_size);\n-    if (insts_size != 0)          tty->print_cr(\" main code      = %u (%f%%)\", insts_size, (insts_size * 100.0f)\/total_size);\n-    if (stub_size != 0)           tty->print_cr(\" stub code      = %u (%f%%)\", stub_size, (stub_size * 100.0f)\/total_size);\n-    if (oops_size != 0)           tty->print_cr(\" oops           = %u (%f%%)\", oops_size, (oops_size * 100.0f)\/total_size);\n-    if (metadata_size != 0)       tty->print_cr(\" metadata       = %u (%f%%)\", metadata_size, (metadata_size * 100.0f)\/total_size);\n-    if (scopes_data_size != 0)    tty->print_cr(\" scopes data    = %u (%f%%)\", scopes_data_size, (scopes_data_size * 100.0f)\/total_size);\n-    if (scopes_pcs_size != 0)     tty->print_cr(\" scopes pcs     = %u (%f%%)\", scopes_pcs_size, (scopes_pcs_size * 100.0f)\/total_size);\n-    if (dependencies_size != 0)   tty->print_cr(\" dependencies   = %u (%f%%)\", dependencies_size, (dependencies_size * 100.0f)\/total_size);\n-    if (handler_table_size != 0)  tty->print_cr(\" handler table  = %u (%f%%)\", handler_table_size, (handler_table_size * 100.0f)\/total_size);\n-    if (nul_chk_table_size != 0)  tty->print_cr(\" nul chk table  = %u (%f%%)\", nul_chk_table_size, (nul_chk_table_size * 100.0f)\/total_size);\n+    if (nmethod_count != 0) {\n+      tty->print_cr(\"   header        = %u (%f%%)\", header_size, (header_size * 100.0f)\/total_nm_size);\n+    }\n+    if (relocation_size != 0) {\n+      tty->print_cr(\"   relocation    = %u (%f%%)\", relocation_size, (relocation_size * 100.0f)\/total_nm_size);\n+    }\n+    if (consts_size != 0) {\n+      tty->print_cr(\"   constants     = %u (%f%%)\", consts_size, (consts_size * 100.0f)\/total_nm_size);\n+    }\n+    if (insts_size != 0) {\n+      tty->print_cr(\"   main code     = %u (%f%%)\", insts_size, (insts_size * 100.0f)\/total_nm_size);\n+    }\n+    if (stub_size != 0) {\n+      tty->print_cr(\"   stub code     = %u (%f%%)\", stub_size, (stub_size * 100.0f)\/total_nm_size);\n+    }\n+    if (oops_size != 0) {\n+      tty->print_cr(\"   oops          = %u (%f%%)\", oops_size, (oops_size * 100.0f)\/total_nm_size);\n+    }\n+    if (metadata_size != 0) {\n+      tty->print_cr(\"   metadata      = %u (%f%%)\", metadata_size, (metadata_size * 100.0f)\/total_nm_size);\n+    }\n+    if (total_immut_size != 0) {\n+      tty->print_cr(\" immutable data  = %u (%f%%)\", total_immut_size, (total_immut_size * 100.0f)\/total_size);\n+    }\n+    if (dependencies_size != 0) {\n+      tty->print_cr(\"   dependencies  = %u (%f%%)\", dependencies_size, (dependencies_size * 100.0f)\/total_immut_size);\n+    }\n+    if (nul_chk_table_size != 0) {\n+      tty->print_cr(\"   nul chk table = %u (%f%%)\", nul_chk_table_size, (nul_chk_table_size * 100.0f)\/total_immut_size);\n+    }\n+    if (handler_table_size != 0) {\n+      tty->print_cr(\"   handler table = %u (%f%%)\", handler_table_size, (handler_table_size * 100.0f)\/total_immut_size);\n+    }\n+    if (scopes_pcs_size != 0) {\n+      tty->print_cr(\"   scopes pcs    = %u (%f%%)\", scopes_pcs_size, (scopes_pcs_size * 100.0f)\/total_immut_size);\n+    }\n+    if (scopes_data_size != 0) {\n+      tty->print_cr(\"   scopes data   = %u (%f%%)\", scopes_data_size, (scopes_data_size * 100.0f)\/total_immut_size);\n+    }\n@@ -178,2 +216,6 @@\n-    if (speculations_size != 0)   tty->print_cr(\" speculations   = %u (%f%%)\", speculations_size, (speculations_size * 100.0f)\/total_size);\n-    if (jvmci_data_size != 0)     tty->print_cr(\" JVMCI data     = %u (%f%%)\", jvmci_data_size, (jvmci_data_size * 100.0f)\/total_size);\n+    if (speculations_size != 0) {\n+      tty->print_cr(\"   speculations  = %u (%f%%)\", speculations_size, (speculations_size * 100.0f)\/total_immut_size);\n+    }\n+    if (jvmci_data_size != 0) {\n+      tty->print_cr(\"   JVMCI data    = %u (%f%%)\", jvmci_data_size, (jvmci_data_size * 100.0f)\/total_immut_size);\n+    }\n@@ -1092,1 +1134,2 @@\n-  CompLevel comp_level\n+  CompLevel comp_level,\n+  ResultStatus& result_status\n@@ -1107,3 +1150,4 @@\n-  int nmethod_size =\n-    CodeBlob::allocation_size(code_buffer, sizeof(nmethod))\n-    + adjust_pcs_size(debug_info->pcs_size())\n+  int nmethod_size = CodeBlob::allocation_size(code_buffer, sizeof(nmethod));\n+\n+  int immutable_data_size =\n+      adjust_pcs_size(debug_info->pcs_size())\n@@ -1118,0 +1162,10 @@\n+\n+  \/\/ First, allocate space for immutable data in C heap.\n+  address immutable_data = nullptr;\n+  if (immutable_data_size > 0) {\n+    immutable_data = (address)os::malloc(immutable_data_size, mtCode);\n+    if (immutable_data == nullptr) {\n+      result_status = out_of_memory;\n+      return nullptr; \/\/ OutOfMemory, bailout\n+    }\n+  }\n@@ -1122,7 +1176,4 @@\n-    nmethod(method(), compiler->type(), nmethod_size, compile_id, entry_bci, offsets,\n-            orig_pc_offset, debug_info, dependencies, code_buffer, frame_size,\n-            oop_maps,\n-            handler_table,\n-            nul_chk_table,\n-            compiler,\n-            comp_level\n+    nmethod(method(), compiler->type(), nmethod_size, immutable_data_size,\n+            compile_id, entry_bci, immutable_data, offsets, orig_pc_offset,\n+            debug_info, dependencies, code_buffer, frame_size, oop_maps,\n+            handler_table, nul_chk_table, compiler, comp_level\n@@ -1167,0 +1218,3 @@\n+    result_status = passed;\n+  } else {\n+    result_status = code_cache_full;\n@@ -1199,3 +1253,1 @@\n-  _entry_offset          = checked_cast<uint16_t>(offsets->value(CodeOffsets::Entry));\n-  _verified_entry_offset = checked_cast<uint16_t>(offsets->value(CodeOffsets::Verified_Entry));\n-  _stub_offset           = content_offset() + code_buffer->total_offset_of(code_buffer->stubs());\n+  _stub_offset = content_offset() + code_buffer->total_offset_of(code_buffer->stubs());\n@@ -1203,1 +1255,3 @@\n-  _skipped_instructions_size = checked_cast<uint16_t>(code_buffer->total_skipped_instructions_size());\n+  CHECKED_CAST(_entry_offset,              uint16_t, (offsets->value(CodeOffsets::Entry)));\n+  CHECKED_CAST(_verified_entry_offset,     uint16_t, (offsets->value(CodeOffsets::Verified_Entry)));\n+  CHECKED_CAST(_skipped_instructions_size, uint16_t, (code_buffer->total_skipped_instructions_size()));\n@@ -1265,3 +1319,10 @@\n-    _metadata_offset         = checked_cast<uint16_t>(align_up(code_buffer->total_oop_size(), oopSize));\n-    _dependencies_offset     = checked_cast<uint16_t>(_metadata_offset + align_up(code_buffer->total_metadata_size(), wordSize));\n-    _scopes_pcs_offset       = _dependencies_offset;\n+    CHECKED_CAST(_metadata_offset, uint16_t, (align_up(code_buffer->total_oop_size(), oopSize)));\n+    DEBUG_ONLY( int data_end_offset = _metadata_offset + align_up(code_buffer->total_metadata_size(), wordSize); )\n+    assert((data_offset() + data_end_offset) <= nmethod_size, \"wrong nmethod's size: %d < %d\", nmethod_size, (data_offset() + data_end_offset));\n+\n+    \/\/ native wrapper does not have read-only data but we need unique not null address\n+    _immutable_data          = data_end();\n+    _immutable_data_size     = 0;\n+    _nul_chk_table_offset    = 0;\n+    _handler_table_offset    = _nul_chk_table_offset;\n+    _scopes_pcs_offset       = _handler_table_offset;\n@@ -1269,2 +1330,0 @@\n-    _handler_table_offset    = _scopes_data_offset;\n-    _nul_chk_table_offset    = _handler_table_offset;\n@@ -1272,1 +1331,1 @@\n-    _speculations_offset     = _nul_chk_table_offset;\n+    _speculations_offset     = _scopes_data_offset;\n@@ -1274,3 +1333,0 @@\n-    DEBUG_ONLY( int data_end_offset = _jvmci_data_offset; )\n-#else\n-    DEBUG_ONLY( int data_end_offset = _nul_chk_table_offset; )\n@@ -1278,1 +1334,0 @@\n-    assert((data_offset() + data_end_offset) <= nmethod_size, \"wrong nmethod's size: %d < %d\", nmethod_size, (data_offset() + data_end_offset));\n@@ -1346,0 +1401,1 @@\n+  int immutable_data_size,\n@@ -1348,0 +1404,1 @@\n+  address immutable_data,\n@@ -1424,1 +1481,4 @@\n-      _unwind_handler_offset = code_offset() + offsets->value(CodeOffsets::UnwindHandler);\n+      \/\/ C1 generates UnwindHandler at the end of instructions section.\n+      \/\/ Calculate positive offset as distance between the start of stubs section\n+      \/\/ (which is also the end of instructions section) and the start of the handler.\n+      CHECKED_CAST(_unwind_handler_offset, int16_t, (_stub_offset - code_offset() - offsets->value(CodeOffsets::UnwindHandler)));\n@@ -1428,3 +1488,15 @@\n-    _metadata_offset      = checked_cast<uint16_t>(align_up(code_buffer->total_oop_size(), oopSize));\n-    _dependencies_offset  = checked_cast<uint16_t>(_metadata_offset     + align_up(code_buffer->total_metadata_size(), wordSize));\n-    _scopes_pcs_offset    = checked_cast<uint16_t>(_dependencies_offset + align_up((int)dependencies->size_in_bytes(), oopSize));\n+    CHECKED_CAST(_metadata_offset, uint16_t, (align_up(code_buffer->total_oop_size(), oopSize)));\n+    DEBUG_ONLY( int data_end_offset = _metadata_offset + align_up(code_buffer->total_metadata_size(), wordSize); )\n+    assert((data_offset() + data_end_offset) <= nmethod_size, \"wrong nmethod's size: %d < %d\", nmethod_size, (data_offset() + data_end_offset));\n+\n+    _immutable_data_size  = immutable_data_size;\n+    if (immutable_data_size > 0) {\n+      assert(immutable_data != nullptr, \"required\");\n+      _immutable_data     = immutable_data;\n+    } else {\n+      \/\/ We need unique not null address\n+      _immutable_data     = data_end();\n+    }\n+    CHECKED_CAST(_nul_chk_table_offset, uint16_t, (align_up((int)dependencies->size_in_bytes(), oopSize)));\n+    CHECKED_CAST(_handler_table_offset, uint16_t, (_nul_chk_table_offset + align_up(nul_chk_table->size_in_bytes(), oopSize)));\n+    _scopes_pcs_offset    = _handler_table_offset + align_up(handler_table->size_in_bytes(), oopSize);\n@@ -1432,2 +1504,1 @@\n-    _handler_table_offset = _scopes_data_offset   + align_up(debug_info->data_size       (), oopSize);\n-    _nul_chk_table_offset = _handler_table_offset + align_up(handler_table->size_in_bytes(), oopSize);\n+\n@@ -1435,1 +1506,1 @@\n-    _speculations_offset  = _nul_chk_table_offset + align_up(nul_chk_table->size_in_bytes(), oopSize);\n+    _speculations_offset  = _scopes_data_offset   + align_up(debug_info->data_size(), oopSize);\n@@ -1438,1 +1509,1 @@\n-    DEBUG_ONLY( int data_end_offset = _jvmci_data_offset    + align_up(jvmci_data_size, oopSize); )\n+    DEBUG_ONLY( int immutable_data_end_offset = _jvmci_data_offset  + align_up(jvmci_data_size, oopSize); )\n@@ -1440,1 +1511,1 @@\n-    DEBUG_ONLY( int data_end_offset = _nul_chk_table_offset + align_up(nul_chk_table->size_in_bytes(), oopSize); )\n+    DEBUG_ONLY( int immutable_data_end_offset = _scopes_data_offset + align_up(debug_info->data_size(), oopSize); )\n@@ -1442,1 +1513,2 @@\n-    assert((data_offset() + data_end_offset) <= nmethod_size, \"wrong nmethod's size: %d < %d\", nmethod_size, (data_offset() + data_end_offset));\n+    assert(immutable_data_end_offset <= immutable_data_size, \"wrong read-only data size: %d > %d\",\n+           immutable_data_end_offset, immutable_data_size);\n@@ -2050,0 +2122,4 @@\n+  if (_immutable_data != data_end()) {\n+    os::free(_immutable_data);\n+    _immutable_data = data_end(); \/\/ Valid not null address\n+  }\n@@ -2682,1 +2758,1 @@\n-  PcDesc* lower = lower_incl;     \/\/ this is initial sentiel\n+  PcDesc* lower = lower_incl;     \/\/ this is initial sentinel\n@@ -3005,8 +3081,4 @@\n-  if (scopes_data_size  () > 0) st->print_cr(\" scopes data    [\" INTPTR_FORMAT \",\" INTPTR_FORMAT \"] = %d\",\n-                                             p2i(scopes_data_begin()),\n-                                             p2i(scopes_data_end()),\n-                                             scopes_data_size());\n-  if (scopes_pcs_size   () > 0) st->print_cr(\" scopes pcs     [\" INTPTR_FORMAT \",\" INTPTR_FORMAT \"] = %d\",\n-                                             p2i(scopes_pcs_begin()),\n-                                             p2i(scopes_pcs_end()),\n-                                             scopes_pcs_size());\n+  if (immutable_data_size() > 0) st->print_cr(\" immutable data [\" INTPTR_FORMAT \",\" INTPTR_FORMAT \"] = %d\",\n+                                             p2i(immutable_data_begin()),\n+                                             p2i(immutable_data_end()),\n+                                             immutable_data_size());\n@@ -3017,4 +3089,0 @@\n-  if (handler_table_size() > 0) st->print_cr(\" handler table  [\" INTPTR_FORMAT \",\" INTPTR_FORMAT \"] = %d\",\n-                                             p2i(handler_table_begin()),\n-                                             p2i(handler_table_end()),\n-                                             handler_table_size());\n@@ -3025,0 +3093,12 @@\n+  if (handler_table_size() > 0) st->print_cr(\" handler table  [\" INTPTR_FORMAT \",\" INTPTR_FORMAT \"] = %d\",\n+                                             p2i(handler_table_begin()),\n+                                             p2i(handler_table_end()),\n+                                             handler_table_size());\n+  if (scopes_pcs_size   () > 0) st->print_cr(\" scopes pcs     [\" INTPTR_FORMAT \",\" INTPTR_FORMAT \"] = %d\",\n+                                             p2i(scopes_pcs_begin()),\n+                                             p2i(scopes_pcs_end()),\n+                                             scopes_pcs_size());\n+  if (scopes_data_size  () > 0) st->print_cr(\" scopes data    [\" INTPTR_FORMAT \",\" INTPTR_FORMAT \"] = %d\",\n+                                             p2i(scopes_data_begin()),\n+                                             p2i(scopes_data_end()),\n+                                             scopes_data_size());\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":150,"deletions":70,"binary":false,"changes":220,"status":"modified"},{"patch":"@@ -198,0 +198,3 @@\n+  \/\/ nmethod's read-only data\n+  address _immutable_data;\n+\n@@ -214,0 +217,1 @@\n+  int      _immutable_data_size;\n@@ -227,3 +231,4 @@\n-  \/\/ Offset of the unwind handler if it exists\n-  int _unwind_handler_offset;\n-\n+  \/\/ Offset (from insts_end) of the unwind handler if it exists\n+  int16_t  _unwind_handler_offset;\n+  \/\/ Number of arguments passed on the stack\n+  uint16_t _num_stack_arg_slots;\n@@ -234,2 +239,6 @@\n-  uint16_t _dependencies_offset;\n-  uint16_t _scopes_pcs_offset;\n+\n+  \/\/ Offset in immutable data section\n+  \/\/ _dependencies_offset == 0\n+  uint16_t _nul_chk_table_offset;\n+  uint16_t _handler_table_offset; \/\/ This table could be big in C1 code\n+  int      _scopes_pcs_offset;\n@@ -237,2 +246,0 @@\n-  int      _handler_table_offset;\n-  int      _nul_chk_table_offset;\n@@ -252,2 +259,0 @@\n-  uint16_t     _num_stack_arg_slots;   \/\/ Number of arguments passed on the stack\n-\n@@ -310,0 +315,1 @@\n+          int immutable_data_size,\n@@ -312,0 +318,1 @@\n+          address immutable_data,\n@@ -466,0 +473,6 @@\n+  enum ResultStatus {\n+    passed,\n+    code_cache_full,\n+    out_of_memory\n+  };\n+\n@@ -480,1 +493,2 @@\n-                              CompLevel comp_level\n+                              CompLevel comp_level,\n+                              ResultStatus& result_status\n@@ -527,1 +541,1 @@\n-  address unwind_handler_begin  () const { return _unwind_handler_offset != -1 ? (header_begin() + _unwind_handler_offset) : nullptr; }\n+  address unwind_handler_begin  () const { return _unwind_handler_offset != -1 ? (insts_end() - _unwind_handler_offset) : nullptr; }\n@@ -533,11 +547,14 @@\n-  Metadata** metadata_end       () const { return (Metadata**) (data_begin() + _dependencies_offset)  ; }\n-\n-  address dependencies_begin    () const { return           data_begin() + _dependencies_offset       ; }\n-  address dependencies_end      () const { return           data_begin() + _scopes_pcs_offset         ; }\n-  PcDesc* scopes_pcs_begin      () const { return (PcDesc*)(data_begin() + _scopes_pcs_offset)        ; }\n-  PcDesc* scopes_pcs_end        () const { return (PcDesc*)(data_begin() + _scopes_data_offset)       ; }\n-  address scopes_data_begin     () const { return           data_begin() + _scopes_data_offset        ; }\n-  address scopes_data_end       () const { return           data_begin() + _handler_table_offset      ; }\n-  address handler_table_begin   () const { return           data_begin() + _handler_table_offset      ; }\n-  address handler_table_end     () const { return           data_begin() + _nul_chk_table_offset      ; }\n-  address nul_chk_table_begin   () const { return           data_begin() + _nul_chk_table_offset      ; }\n+  Metadata** metadata_end       () const { return (Metadata**)  data_end(); }\n+\n+  \/\/ read-only data\n+  address immutable_data_begin  () const { return           _immutable_data; }\n+  address immutable_data_end    () const { return           _immutable_data + _immutable_data_size ; }\n+  address dependencies_begin    () const { return           _immutable_data; }\n+  address dependencies_end      () const { return           _immutable_data + _nul_chk_table_offset; }\n+  address nul_chk_table_begin   () const { return           _immutable_data + _nul_chk_table_offset; }\n+  address nul_chk_table_end     () const { return           _immutable_data + _handler_table_offset; }\n+  address handler_table_begin   () const { return           _immutable_data + _handler_table_offset; }\n+  address handler_table_end     () const { return           _immutable_data + _scopes_pcs_offset   ; }\n+  PcDesc* scopes_pcs_begin      () const { return (PcDesc*)(_immutable_data + _scopes_pcs_offset)  ; }\n+  PcDesc* scopes_pcs_end        () const { return (PcDesc*)(_immutable_data + _scopes_data_offset) ; }\n+  address scopes_data_begin     () const { return           _immutable_data + _scopes_data_offset  ; }\n@@ -546,5 +563,5 @@\n-  address nul_chk_table_end     () const { return           data_begin() + _speculations_offset       ; }\n-  address speculations_begin    () const { return           data_begin() + _speculations_offset       ; }\n-  address speculations_end      () const { return           data_begin() + _jvmci_data_offset         ; }\n-  address jvmci_data_begin      () const { return           data_begin() + _jvmci_data_offset         ; }\n-  address jvmci_data_end        () const { return           data_end(); }\n+  address scopes_data_end       () const { return           _immutable_data + _speculations_offset ; }\n+  address speculations_begin    () const { return           _immutable_data + _speculations_offset ; }\n+  address speculations_end      () const { return           _immutable_data + _jvmci_data_offset   ; }\n+  address jvmci_data_begin      () const { return           _immutable_data + _jvmci_data_offset   ; }\n+  address jvmci_data_end        () const { return            immutable_data_end(); }\n@@ -552,1 +569,1 @@\n-  address nul_chk_table_end     () const { return           data_end(); }\n+  address scopes_data_end       () const { return            immutable_data_end(); }\n@@ -556,10 +573,11 @@\n-  int consts_size       () const { return int(          consts_end       () -           consts_begin       ()); }\n-  int insts_size        () const { return int(          insts_end        () -           insts_begin        ()); }\n-  int stub_size         () const { return int(          stub_end         () -           stub_begin         ()); }\n-  int oops_size         () const { return int((address) oops_end         () - (address) oops_begin         ()); }\n-  int metadata_size     () const { return int((address) metadata_end     () - (address) metadata_begin     ()); }\n-  int scopes_data_size  () const { return int(          scopes_data_end  () -           scopes_data_begin  ()); }\n-  int scopes_pcs_size   () const { return int((intptr_t)scopes_pcs_end   () - (intptr_t)scopes_pcs_begin   ()); }\n-  int dependencies_size () const { return int(          dependencies_end () -           dependencies_begin ()); }\n-  int handler_table_size() const { return int(          handler_table_end() -           handler_table_begin()); }\n-  int nul_chk_table_size() const { return int(          nul_chk_table_end() -           nul_chk_table_begin()); }\n+  int immutable_data_size() const { return _immutable_data_size; }\n+  int consts_size        () const { return int(          consts_end       () -           consts_begin       ()); }\n+  int insts_size         () const { return int(          insts_end        () -           insts_begin        ()); }\n+  int stub_size          () const { return int(          stub_end         () -           stub_begin         ()); }\n+  int oops_size          () const { return int((address) oops_end         () - (address) oops_begin         ()); }\n+  int metadata_size      () const { return int((address) metadata_end     () - (address) metadata_begin     ()); }\n+  int scopes_data_size   () const { return int(          scopes_data_end  () -           scopes_data_begin  ()); }\n+  int scopes_pcs_size    () const { return int((intptr_t)scopes_pcs_end   () - (intptr_t)scopes_pcs_begin   ()); }\n+  int dependencies_size  () const { return int(          dependencies_end () -           dependencies_begin ()); }\n+  int handler_table_size () const { return int(          handler_table_end() -           handler_table_begin()); }\n+  int nul_chk_table_size () const { return int(          nul_chk_table_end() -           nul_chk_table_begin()); }\n@@ -567,2 +585,2 @@\n-  int speculations_size () const { return int(          speculations_end () -           speculations_begin ()); }\n-  int jvmci_data_size   () const { return int(          jvmci_data_end   () -           jvmci_data_begin   ()); }\n+  int speculations_size  () const { return int(          speculations_end () -           speculations_begin ()); }\n+  int jvmci_data_size    () const { return int(          jvmci_data_end   () -           jvmci_data_begin   ()); }\n","filename":"src\/hotspot\/share\/code\/nmethod.hpp","additions":58,"deletions":40,"binary":false,"changes":98,"status":"modified"},{"patch":"@@ -2178,0 +2178,1 @@\n+      nmethod::ResultStatus result_status;\n@@ -2186,1 +2187,1 @@\n-                                 compiler, comp_level,\n+                                 compiler, comp_level, result_status,\n","filename":"src\/hotspot\/share\/jvmci\/jvmciRuntime.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -579,1 +579,1 @@\n-  nonstatic_field(nmethod,                     _scopes_pcs_offset,                            u2)                                    \\\n+  nonstatic_field(nmethod,                     _scopes_pcs_offset,                            int)                                    \\\n@@ -581,3 +581,2 @@\n-  nonstatic_field(nmethod,                     _dependencies_offset,                          u2)                                    \\\n-  nonstatic_field(nmethod,                     _handler_table_offset,                         int)                                   \\\n-  nonstatic_field(nmethod,                     _nul_chk_table_offset,                         int)                                   \\\n+  nonstatic_field(nmethod,                     _handler_table_offset,                         u2)                                    \\\n+  nonstatic_field(nmethod,                     _nul_chk_table_offset,                         u2)                                    \\\n@@ -587,0 +586,2 @@\n+  nonstatic_field(nmethod,                     _immutable_data,                               address)                               \\\n+  nonstatic_field(nmethod,                     _immutable_data_size,                          int)                                   \\\n","filename":"src\/hotspot\/share\/runtime\/vmStructs.cpp","additions":5,"deletions":4,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -45,0 +45,2 @@\n+  private static AddressField  immutableDataField;\n+  private static CIntegerField immutableDataSizeField;\n@@ -53,2 +55,3 @@\n-  private static CIntField     dependenciesOffsetField;\n-  private static CIntField     scopesPCsOffsetField;\n+  private static CIntField     handlerTableOffsetField;\n+  private static CIntField     nulChkTableOffsetField;\n+  private static CIntegerField scopesPCsOffsetField;\n@@ -56,2 +59,0 @@\n-  private static CIntegerField handlerTableOffsetField;\n-  private static CIntegerField nulChkTableOffsetField;\n@@ -85,0 +86,2 @@\n+    immutableDataField          = type.getAddressField(\"_immutable_data\");\n+    immutableDataSizeField      = type.getCIntegerField(\"_immutable_data_size\");\n@@ -92,2 +95,1 @@\n-    dependenciesOffsetField     = new CIntField(type.getCIntegerField(\"_dependencies_offset\"), 0);\n-    scopesPCsOffsetField        = new CIntField(type.getCIntegerField(\"_scopes_pcs_offset\"), 0);\n+    scopesPCsOffsetField        = type.getCIntegerField(\"_scopes_pcs_offset\");\n@@ -95,2 +97,2 @@\n-    handlerTableOffsetField     = type.getCIntegerField(\"_handler_table_offset\");\n-    nulChkTableOffsetField      = type.getCIntegerField(\"_nul_chk_table_offset\");\n+    handlerTableOffsetField     = new CIntField(type.getCIntegerField(\"_handler_table_offset\"), 0);\n+    nulChkTableOffsetField      = new CIntField(type.getCIntegerField(\"_nul_chk_table_offset\"), 0);\n@@ -136,12 +138,16 @@\n-  public Address metadataEnd()          { return dataBegin().addOffsetTo(getDependenciesOffset());   }\n-  public Address dependenciesBegin()    { return dataBegin().addOffsetTo(getDependenciesOffset());   }\n-  public Address dependenciesEnd()      { return dataBegin().addOffsetTo(getScopesDataOffset());     }\n-  public Address scopesDataBegin()      { return dataBegin().addOffsetTo(getScopesDataOffset());     }\n-  public Address scopesDataEnd()        { return dataBegin().addOffsetTo(getScopesPCsOffset());      }\n-  public Address scopesPCsBegin()       { return dataBegin().addOffsetTo(getScopesPCsOffset());      }\n-  public Address scopesPCsEnd()         { return dataBegin().addOffsetTo(getHandlerTableOffset());   }\n-  public Address handlerTableBegin()    { return dataBegin().addOffsetTo(getHandlerTableOffset());   }\n-  public Address handlerTableEnd()      { return dataBegin().addOffsetTo(getNulChkTableOffset());    }\n-  public Address nulChkTableBegin()     { return dataBegin().addOffsetTo(getNulChkTableOffset());    }\n-  public Address nulChkTableEnd()       { return dataEnd();                                          }\n-\n+  public Address metadataEnd()          { return dataEnd();                                          }\n+\n+  public Address immutableDataBegin()   { return immutableDataField.getValue(addr);                         }\n+  public Address immutableDataEnd()     { return immutableDataBegin().addOffsetTo(getImmutableDataSize());  }\n+  public Address dependenciesBegin()    { return immutableDataBegin();                                      }\n+  public Address dependenciesEnd()      { return immutableDataBegin().addOffsetTo(getHandlerTableOffset()); }\n+  public Address handlerTableBegin()    { return immutableDataBegin().addOffsetTo(getHandlerTableOffset()); }\n+  public Address handlerTableEnd()      { return immutableDataBegin().addOffsetTo(getNulChkTableOffset());  }\n+  public Address nulChkTableBegin()     { return immutableDataBegin().addOffsetTo(getNulChkTableOffset());  }\n+  public Address nulChkTableEnd()       { return immutableDataBegin().addOffsetTo(getScopesDataOffset());   }\n+  public Address scopesDataBegin()      { return immutableDataBegin().addOffsetTo(getScopesDataOffset());   }\n+  public Address scopesDataEnd()        { return immutableDataBegin().addOffsetTo(getScopesPCsOffset());    }\n+  public Address scopesPCsBegin()       { return immutableDataBegin().addOffsetTo(getScopesPCsOffset());    }\n+  public Address scopesPCsEnd()         { return immutableDataEnd();                                        }\n+\n+  public int getImmutableDataSize()     { return (int) immutableDataSizeField.getValue(addr);        }\n@@ -164,1 +170,4 @@\n-      stubSize()         +\n+      stubSize();\n+  }\n+  public int immutableDataSize() {\n+    return\n@@ -519,1 +528,1 @@\n-  private int getDependenciesOffset() { return (int) dependenciesOffsetField.getValue(addr); }\n+  private int getDependenciesOffset() { return (int) 0; }\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/NMethod.java","additions":31,"deletions":22,"binary":false,"changes":53,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,0 +29,1 @@\n+ *                   -XX:+IgnoreUnrecognizedVMOptions -XX:NMethodSizeLimit=655360\n","filename":"test\/hotspot\/jtreg\/compiler\/c1\/TestLinearScanOrderMain.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}