{"files":[{"patch":"@@ -168,0 +168,1 @@\n+        java.management.rmi,\n","filename":"src\/java.base\/share\/classes\/module-info.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -49,0 +49,1 @@\n+import jdk.internal.access.SharedSecrets;\n@@ -111,1 +112,0 @@\n-\n@@ -113,0 +113,1 @@\n+\n@@ -118,1 +119,6 @@\n-            this.acc = JMXSubjectDomainCombiner.getContext(subject);\n+            if (SharedSecrets.getJavaLangAccess().allowSecurityManager()) {\n+                \/\/ SM is allowed.  Will use ACC with Subject:\n+                this.acc = JMXSubjectDomainCombiner.getContext(subject);\n+            } else {\n+                this.acc = null;\n+            }\n@@ -1295,3 +1301,9 @@\n-            if (acc == null)\n-                return action.run();\n-            else\n+            if (acc == null) {\n+                \/\/ No ACC, therefore no SM. May have a Subject:\n+                if (subject != null) {\n+                    return Subject.doAs(subject, action);\n+                } else {\n+                    return action.run();\n+                }\n+            } else {\n+                \/\/ ACC is present, we have a Subject and SM is permitted:\n@@ -1299,0 +1311,1 @@\n+            }\n@@ -1415,1 +1428,4 @@\n-                try {\n+                \/\/ No ACC, therefore no SM. May have a Subject:\n+                if (subject != null) {\n+                    return Subject.doAs(subject, op);\n+                } else {\n@@ -1417,4 +1433,0 @@\n-                } catch (Exception e) {\n-                    if (e instanceof RuntimeException)\n-                        throw (RuntimeException) e;\n-                    throw new PrivilegedActionException(e);\n@@ -1423,1 +1435,25 @@\n-                return AccessController.doPrivileged(op, acc);\n+                \/\/ ACC is present, we have a Subject and SM is permitted:\n+                return AccessController.doPrivileged((PrivilegedExceptionAction<Object>) () -> Subject.doAs(subject, op), acc);\n+            }\n+        } catch (PrivilegedActionException pe) {\n+            \/\/ Dealing with cause of PrivilegedActionException is the same as handling other Exceptions.\n+            Throwable cause = pe.getCause();\n+\n+            if (cause instanceof Error) {\n+                throw new JMXServerErrorException(cause.toString(), (Error) cause);\n+            } else if (cause instanceof SecurityException) {\n+                throw (SecurityException) cause;\n+            } else if (cause instanceof RuntimeException) {\n+                throw (RuntimeException) cause;\n+            } else if (cause instanceof Exception) {\n+                throw new PrivilegedActionException((Exception) cause);\n+            } else {\n+                throw new RuntimeException(cause);\n+            }\n+        } catch (Exception e) {\n+            if (e instanceof SecurityException) {\n+                throw (SecurityException) e;\n+            } else if (e instanceof RuntimeException) {\n+                throw (RuntimeException) e;\n+            } else {\n+                throw new PrivilegedActionException(e);\n@@ -1588,7 +1624,16 @@\n-            try{\n-                if (acc != null) {\n-                    return AccessController.doPrivileged(\n-                            (PrivilegedExceptionAction<T>) () ->\n-                                    wrappedClass.cast(mo.get()), acc);\n-                }else{\n-                    return wrappedClass.cast(mo.get());\n+            try {\n+                if (acc == null) {\n+                    \/\/ No ACC, therefore no SM. May have a Subject:\n+                    if (subject != null) {\n+                        return Subject.doAs(subject, (PrivilegedExceptionAction<T>) () -> wrappedClass.cast(mo.get()));\n+                    } else {\n+                        return wrappedClass.cast(mo.get());\n+                    }\n+                } else {\n+                    \/\/ ACC is present, we have a Subject and SM is permitted:\n+                    PrivilegedExceptionAction<T> action = new PrivilegedExceptionAction<T>() {\n+                        public T run() throws Exception {\n+                            return wrappedClass.cast(mo.get());\n+                        }\n+                    };\n+                    return AccessController.doPrivileged(action, acc);\n@@ -1596,1 +1641,1 @@\n-            }finally{\n+            } finally {\n","filename":"src\/java.management.rmi\/share\/classes\/javax\/management\/remote\/rmi\/RMIConnectionImpl.java","additions":64,"deletions":19,"binary":false,"changes":83,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -58,0 +58,1 @@\n+import jdk.internal.access.SharedSecrets;\n@@ -349,1 +350,7 @@\n-        return Subject.getSubject(AccessController.getContext());\n+        Subject subject = null;\n+        if (!SharedSecrets.getJavaLangAccess().allowSecurityManager()) {\n+            subject = Subject.current();\n+        } else {\n+            subject = Subject.getSubject(AccessController.getContext());\n+        }\n+        return subject;\n","filename":"src\/java.management\/share\/classes\/com\/sun\/jmx\/remote\/internal\/ServerNotifForwarder.java","additions":9,"deletions":2,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -45,0 +45,1 @@\n+import jdk.internal.access.SharedSecrets;\n@@ -303,0 +304,1 @@\n+    @SuppressWarnings(\"removal\")\n@@ -304,8 +306,11 @@\n-        @SuppressWarnings(\"removal\")\n-        final AccessControlContext acc = AccessController.getContext();\n-        @SuppressWarnings(\"removal\")\n-        final Subject s =\n-            AccessController.doPrivileged(new PrivilegedAction<>() {\n-                    public Subject run() {\n-                        return Subject.getSubject(acc);\n-                    }\n+        Subject s = null;\n+        if (!SharedSecrets.getJavaLangAccess().allowSecurityManager()) {\n+            s = Subject.current();\n+        } else {\n+            @SuppressWarnings(\"removal\")\n+            final AccessControlContext acc = AccessController.getContext();\n+            \/\/@SuppressWarnings(\"removal\")\n+            s = AccessController.doPrivileged(new PrivilegedAction<>() {\n+                        public Subject run() {\n+                            return Subject.getSubject(acc);\n+                        }\n@@ -313,0 +318,1 @@\n+        }\n","filename":"src\/java.management\/share\/classes\/com\/sun\/jmx\/remote\/security\/MBeanServerFileAccessController.java","additions":15,"deletions":9,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -63,0 +63,2 @@\n+import javax.security.auth.Subject;\n+import jdk.internal.access.SharedSecrets;\n@@ -172,1 +174,1 @@\n-     * AccessControlContext of the Monitor.start() caller.\n+     * Subject and possibly AccessControlContext of the Monitor.start() caller.\n@@ -174,0 +176,1 @@\n+    private volatile Subject subject;\n@@ -175,5 +178,1 @@\n-    private static final AccessControlContext noPermissionsACC =\n-            new AccessControlContext(\n-            new ProtectionDomain[] {new ProtectionDomain(null, null)});\n-    @SuppressWarnings(\"removal\")\n-    private volatile AccessControlContext acc = noPermissionsACC;\n+    private volatile AccessControlContext acc;\n@@ -716,1 +715,1 @@\n-            \/\/ Cache the AccessControlContext of the Monitor.start() caller.\n+            \/\/ Cache the Subject and possibly AccessControlContext of the Monitor.start() caller.\n@@ -719,1 +718,4 @@\n-            acc = AccessController.getContext();\n+            subject = Subject.current();\n+            if (SharedSecrets.getJavaLangAccess().allowSecurityManager()) {\n+                acc = AccessController.getContext();\n+            }\n@@ -750,1 +752,1 @@\n-            \/\/ Reset the AccessControlContext.\n+            \/\/ Reset the Subject and AccessControlContext.\n@@ -752,1 +754,2 @@\n-            acc = noPermissionsACC;\n+            subject = null;\n+            acc = null;\n@@ -1515,0 +1518,1 @@\n+            final Subject s;\n@@ -1518,0 +1522,1 @@\n+                s  = Monitor.this.subject;\n@@ -1535,1 +1540,5 @@\n-                throw new SecurityException(\"AccessControlContext cannot be null\");\n+                \/\/ No SecurityManager:\n+                Subject.doAs(s, action);\n+            } else {\n+                \/\/ ACC means SM is permitted.\n+                AccessController.doPrivileged(action, ac);\n@@ -1537,1 +1546,0 @@\n-            AccessController.doPrivileged(action, ac);\n","filename":"src\/java.management\/share\/classes\/javax\/management\/monitor\/Monitor.java","additions":21,"deletions":13,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,0 +38,3 @@\n+ * @run main\/othervm\/timeout=300 -Djava.security.manager=allow StartStopTest 1\n+ * @run main\/othervm\/timeout=300 -Djava.security.manager=allow StartStopTest 2\n+ * @run main\/othervm\/timeout=300 -Djava.security.manager=allow StartStopTest 3\n","filename":"test\/jdk\/javax\/management\/monitor\/StartStopTest.java","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -33,0 +33,2 @@\n+ *\n+ * @run main\/othervm ThreadPoolAccTest\n@@ -34,0 +36,1 @@\n+ * @run main\/othervm -Djava.security.manager=allow -DThreadPoolAccTest.useGetSubjectACC=true ThreadPoolAccTest\n@@ -40,0 +43,1 @@\n+import java.util.concurrent.Callable;\n@@ -70,1 +74,3 @@\n-            Subject subject = Subject.getSubject(AccessController.getContext());\n+            \/\/ Use Subject.current() unless test Property is set.\n+            Subject subject = Boolean.getBoolean(\"ThreadPoolAccTest.useGetSubjectACC\") ?\n+                              Subject.getSubject(AccessController.getContext()) : Subject.current();\n@@ -139,1 +145,3 @@\n-                Subject.doAs(subject, action);\n+                \/\/ Subject.doAs(subject, action);\n+                Callable<Void> c = (Callable<Void>) () -> action.run();\n+                Subject.callAs(subject, c);\n","filename":"test\/jdk\/javax\/management\/monitor\/ThreadPoolAccTest.java","additions":10,"deletions":2,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -33,0 +33,2 @@\n+ *\n+ * @run main\/othervm NotificationAccessControllerTest\n","filename":"test\/jdk\/javax\/management\/remote\/mandatory\/notif\/NotificationAccessControllerTest.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2015, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -34,0 +34,1 @@\n+ *\n@@ -35,0 +36,1 @@\n+ * @run main\/othervm -Djava.security.manager=allow NotificationEmissionTest 1\n","filename":"test\/jdk\/javax\/management\/remote\/mandatory\/notif\/NotificationEmissionTest.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -7,0 +7,1 @@\n+    permission javax.security.auth.AuthPermission \"doAs\";\n","filename":"test\/jdk\/javax\/management\/remote\/mandatory\/notif\/policy.negative","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -7,0 +7,1 @@\n+    permission javax.security.auth.AuthPermission \"doAs\";\n","filename":"test\/jdk\/javax\/management\/remote\/mandatory\/notif\/policy.positive","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -33,0 +33,1 @@\n+ * @run main\/othervm NonJMXPrincipalsTest\n","filename":"test\/jdk\/javax\/management\/remote\/mandatory\/passwordAccessFile\/NonJMXPrincipalsTest.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -33,0 +33,2 @@\n+ *\n+ * @run main\/othervm PasswordAccessFileTest\n","filename":"test\/jdk\/javax\/management\/remote\/mandatory\/passwordAccessFile\/PasswordAccessFileTest.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -33,0 +33,2 @@\n+ *\n+ * @run main\/othervm RMIAltAuthTest\n@@ -34,0 +36,1 @@\n+ * @run main\/othervm -Djava.security.manager=allow -DSimpleStandard.useGetSubjectACC=true RMIAltAuthTest\n","filename":"test\/jdk\/javax\/management\/remote\/mandatory\/passwordAuthenticator\/RMIAltAuthTest.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -33,0 +33,2 @@\n+ *\n+ * @run main\/othervm RMIPasswdAuthTest\n@@ -34,0 +36,1 @@\n+ * @run main\/othervm -Djava.security.manager=allow -DSimpleStandard.useGetSubjectACC=true RMIPasswdAuthTest\n","filename":"test\/jdk\/javax\/management\/remote\/mandatory\/passwordAuthenticator\/RMIPasswdAuthTest.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2004, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -155,2 +155,2 @@\n-        AccessControlContext acc = AccessController.getContext();\n-        Subject subject = Subject.getSubject(acc);\n+        Subject subject = Boolean.getBoolean(\"SimpleStandard.useGetSubjectACC\") ?\n+                          Subject.getSubject(AccessController.getContext()) : Subject.current();\n","filename":"test\/jdk\/javax\/management\/remote\/mandatory\/passwordAuthenticator\/SimpleStandard.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -32,0 +32,5 @@\n+ *\n+ * @run main\/othervm\/timeout=300 -DDEBUG_STANDARD -Dusername=username1 -Dpassword=password1 AuthorizationTest -server -mapType x.access.file;x.password.file -populate -client -mapType credentials\n+ * @run main\/othervm\/timeout=300 -DDEBUG_STANDARD -Dusername=username2 -Dpassword=password2 AuthorizationTest -server -mapType x.access.file;x.password.file -populate -client -mapType credentials -expectedCreateException -expectedSetException -expectedInvokeException\n+ * @run main\/othervm\/timeout=300 -DDEBUG_STANDARD -Dusername=username6 -Dpassword=password6 AuthorizationTest -server -mapType x.access.file;x.password.file -populate -client -mapType credentials -expectedCreateException -expectedGetException -expectedSetException -expectedInvokeException\n+ *\n@@ -35,0 +40,1 @@\n+ *\n","filename":"test\/jdk\/javax\/management\/security\/AuthorizationTest.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -36,1 +36,3 @@\n-       permission java.io.FilePermission \"*\",\"read,write\";\n+    permission java.io.FilePermission \"*\",\"read,write\";\n+\n+    permission javax.security.auth.AuthPermission \"doAs\";\n","filename":"test\/jdk\/javax\/management\/security\/java.policy.authorization","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -64,0 +64,1 @@\n+ * @run main\/othervm\/timeout=300 RmiBootstrapTest .*_test.*.in\n@@ -75,0 +76,1 @@\n+ * @run main\/othervm\/timeout=300 RmiBootstrapTest .*_ssltest.*.in\n","filename":"test\/jdk\/sun\/management\/jmxremote\/bootstrap\/RmiBootstrapTest.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}