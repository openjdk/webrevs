{"files":[{"patch":"@@ -1301,3 +1301,5 @@\n-            if (acc == null) {\n-                \/\/ No ACC, therefore no SM. May have a Subject:\n-                if (subject != null) {\n+            if (!SharedSecrets.getJavaLangAccess().allowSecurityManager()) {\n+                \/\/ Modern case\n+                if (subject == null)\n+                    return action.run();\n+                else\n@@ -1305,0 +1307,4 @@\n+            } else {\n+                \/\/ SM permitted\n+                if (acc == null) {\n+                    return action.run(); \/\/ No Subject or ACC\n@@ -1306,1 +1312,1 @@\n-                    return action.run();\n+                    return AccessController.doPrivileged(action, acc);\n@@ -1308,3 +1314,0 @@\n-            } else {\n-                \/\/ ACC is present, meaning SM is permitted:\n-                return AccessController.doPrivileged(action, acc);\n@@ -1427,4 +1430,10 @@\n-            if (acc == null) {\n-                \/\/ No ACC, therefore no SM. May have a Subject:\n-                if (subject != null) {\n-                    return Subject.doAs(subject, op);\n+            if (!SharedSecrets.getJavaLangAccess().allowSecurityManager()) {\n+                \/\/ Modern case\n+                if (subject == null) {\n+                    try {\n+                        return op.run();\n+                    } catch (Exception e) {\n+                        if (e instanceof RuntimeException)\n+                           throw (RuntimeException) e;\n+                        throw new PrivilegedActionException(e);\n+                    }\n@@ -1432,1 +1441,1 @@\n-                    return op.run();\n+                    return Subject.doAs(subject, op);\n@@ -1435,2 +1444,12 @@\n-                \/\/ ACC is present, meaning SM is permitted:\n-                return AccessController.doPrivileged(op, acc);\n+                \/\/ SM permitted\n+                if (acc == null) {\n+                    try {\n+                        return op.run();\n+                    } catch (Exception e) {\n+                        if (e instanceof RuntimeException)\n+                           throw (RuntimeException) e;\n+                        throw new PrivilegedActionException(e);\n+                    }\n+                } else {\n+                    return AccessController.doPrivileged(op, acc);\n+                }\n@@ -1608,7 +1627,2 @@\n-                if (acc != null) {\n-                    \/\/ ACC is present, meaning SM is permitted:\n-                    return AccessController.doPrivileged(\n-                            (PrivilegedExceptionAction<T>) () ->\n-                                    wrappedClass.cast(mo.get()), acc);\n-                } else {\n-                    \/\/ No ACC, therefore no SM. May have a Subject:\n+                if (!SharedSecrets.getJavaLangAccess().allowSecurityManager()) {\n+                    \/\/ Modern case\n@@ -1620,0 +1634,9 @@\n+                } else {\n+                    \/\/ SM permitted\n+                    if (acc != null) {\n+                        return AccessController.doPrivileged(\n+                                (PrivilegedExceptionAction<T>) () ->\n+                                        wrappedClass.cast(mo.get()), acc);\n+                    } else {\n+                        return wrappedClass.cast(mo.get());\n+                    }\n","filename":"src\/java.management.rmi\/share\/classes\/javax\/management\/remote\/rmi\/RMIConnectionImpl.java","additions":44,"deletions":21,"binary":false,"changes":65,"status":"modified"}]}