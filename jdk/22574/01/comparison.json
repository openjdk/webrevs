{"files":[{"patch":"@@ -33,0 +33,1 @@\n+#include \"threadHelper.inline.hpp\"\n@@ -57,1 +58,1 @@\n-void run_cmov_tests() {\n+static void run_cmov_tests() {\n@@ -110,1 +111,0 @@\n- public:\n@@ -113,3 +113,11 @@\n-  static TESTSIZE base_cmpxchg(int variant, intptr_t addr, TESTSIZE expected, TESTSIZE new_value, TESTSIZE result, bool boolean_result = false) {\n-    BufferBlob* bb = BufferBlob::create(\"riscvTest\", 128);\n-    CodeBuffer code(bb);\n+  typedef TESTSIZE (*cmpxchg_narrow_func)(intptr_t addr, TESTSIZE expected, TESTSIZE new_value, TESTSIZE result,\n+                                          int64_t scratch0, int64_t scratch1, int64_t scratch2);\n+\n+  BufferBlob*  _bb;\n+  cmpxchg_func _func;\n+  cmpxchg_narrow_func _narrow;\n+\n+ public:\n+  CmpxchgTester(int variant, bool boolean_result) {\n+    _bb = BufferBlob::create(\"riscvTest\", 128);\n+    CodeBuffer code(_bb);\n@@ -118,1 +126,9 @@\n-    {\n+    if (ASMSIZE == Assembler::int8 || ASMSIZE == Assembler::int16) {\n+        address entry = _masm.pc();\n+       _masm.cmpxchg_narrow_value(\/*addr*\/ c_rarg0, \/*expected*\/ c_rarg1, \/*new_value*\/c_rarg2,\n+                        ASMSIZE, Assembler::relaxed, Assembler::relaxed,\n+                        \/*result*\/ c_rarg3, boolean_result, c_rarg4, c_rarg5, c_rarg6); \/* Uses also t0-t1, caller saved *\/\n+      _masm.mv(c_rarg0, c_rarg3);\n+      _masm.ret();\n+      _narrow = ((cmpxchg_narrow_func)entry);\n+    } else {\n@@ -122,1 +138,1 @@\n-                        ASMSIZE, Assembler::relaxed, Assembler::relaxed,\n+                        ASMSIZE, Assembler::aq, Assembler::rl,\n@@ -129,1 +145,1 @@\n-                        ASMSIZE, Assembler::relaxed, Assembler::relaxed,\n+                        ASMSIZE, Assembler::aq, Assembler::rl,\n@@ -136,1 +152,1 @@\n-                        ASMSIZE, Assembler::relaxed, Assembler::relaxed,\n+                        ASMSIZE, Assembler::aq, Assembler::rl,\n@@ -143,1 +159,1 @@\n-                        ASMSIZE, Assembler::relaxed, Assembler::relaxed,\n+                        ASMSIZE, Assembler::aq, Assembler::rl,\n@@ -150,0 +166,1 @@\n+      _func = ((cmpxchg_func)entry);\n@@ -152,3 +169,12 @@\n-    TESTSIZE ret = ((cmpxchg_func)entry)(addr, expected, new_value, result);\n-    BufferBlob::free(bb);\n-    return ret;\n+  }\n+\n+  ~CmpxchgTester() {\n+    BufferBlob::free(_bb);\n+  }\n+\n+  TESTSIZE cmpxchg(intptr_t addr, TESTSIZE expected, TESTSIZE new_value) {\n+    if (ASMSIZE == Assembler::int8 || ASMSIZE == Assembler::int16) {\n+      return _narrow(addr, expected, new_value, \/* dummy result *\/ 67, -1, -1, -1);\n+    } else {\n+      return _func(addr, expected, new_value, \/* dummy result *\/ 67);\n+    }\n@@ -159,1 +185,2 @@\n-void plain_cmpxchg_test(int variant, TESTSIZE dv, TESTSIZE ex, TESTSIZE nv, TESTSIZE eret, TESTSIZE edata, bool bv) {\n+static void plain_cmpxchg_test(int variant, TESTSIZE dv, TESTSIZE ex, TESTSIZE nv, TESTSIZE eret, TESTSIZE edata, bool bv) {\n+  CmpxchgTester<TESTSIZE, ASMSIZE> cmpxchg(variant, bv);\n@@ -161,1 +188,1 @@\n-  TESTSIZE ret = CmpxchgTester<TESTSIZE, ASMSIZE>::base_cmpxchg(variant, (intptr_t)&data, ex, nv, \/* dummy *\/ 67, bv);\n+  TESTSIZE ret = cmpxchg.cmpxchg((intptr_t)&data, ex, nv);\n@@ -167,1 +194,1 @@\n-void run_plain_cmpxchg_tests() {\n+static void run_plain_cmpxchg_tests() {\n@@ -237,1 +264,1 @@\n-TEST_VM(RiscV, cmpxchg_int64_plain_lr_sc) {\n+TEST_VM(RiscV, cmpxchg_int64_lr_sc) {\n@@ -244,1 +271,1 @@\n-TEST_VM(RiscV, cmpxchg_int64_plain_maybe_zacas) {\n+TEST_VM(RiscV, cmpxchg_int64_maybe_zacas) {\n@@ -250,1 +277,1 @@\n-TEST_VM(RiscV, cmpxchg_int32_plain_lr_sc) {\n+TEST_VM(RiscV, cmpxchg_int32_lr_sc) {\n@@ -257,1 +284,1 @@\n-TEST_VM(RiscV, cmpxchg_int32_plain_maybe_zacas) {\n+TEST_VM(RiscV, cmpxchg_int32_maybe_zacas) {\n@@ -264,26 +291,3 @@\n-class NarrowCmpxchgTester {\n- public:\n-  typedef TESTSIZE (*cmpxchg_func)(intptr_t addr, TESTSIZE expected, TESTSIZE new_value, TESTSIZE result,\n-                                   int64_t scratch0, int64_t scratch1, int64_t scratch2);\n-\n-  static TESTSIZE narrow_cmpxchg(intptr_t addr, TESTSIZE expected, TESTSIZE new_value, TESTSIZE result, bool boolean_result = false) {\n-    BufferBlob* bb = BufferBlob::create(\"riscvTest\", 128);\n-    CodeBuffer code(bb);\n-    MacroAssembler _masm(&code);\n-    address entry = _masm.pc();\n-    {\n-       _masm.cmpxchg_narrow_value(\/*addr*\/ c_rarg0, \/*expected*\/ c_rarg1, \/*new_value*\/c_rarg2,\n-                        ASMSIZE, Assembler::relaxed, Assembler::relaxed,\n-                        \/*result*\/ c_rarg3, boolean_result, c_rarg4, c_rarg5, c_rarg6); \/* Uses also t0-t1, caller saved *\/\n-      _masm.mv(c_rarg0, c_rarg3);\n-      _masm.ret();\n-    }\n-    _masm.flush(); \/\/ icache invalidate\n-    TESTSIZE ret = ((cmpxchg_func)entry)(addr, expected, new_value, result, -1, -1, -1);\n-    BufferBlob::free(bb);\n-    return ret;\n-  }\n-};\n-\n-template <typename TESTSIZE, Assembler::operand_size ASMSIZE>\n-void run_narrow_cmpxchg_tests() {\n+static void run_narrow_cmpxchg_tests() {\n+  CmpxchgTester<TESTSIZE, ASMSIZE> cmpxchg(0, false);\n+  CmpxchgTester<TESTSIZE, ASMSIZE> cmpxchg_bool(0, true);\n@@ -297,1 +301,1 @@\n-    ret = NarrowCmpxchgTester<TESTSIZE, ASMSIZE>::narrow_cmpxchg((intptr_t)&data[i], 121, 42, \/* result *\/ 67, false);\n+    ret = cmpxchg.cmpxchg((intptr_t)&data[i], 121, 42);\n@@ -302,1 +306,1 @@\n-    ret = NarrowCmpxchgTester<TESTSIZE, ASMSIZE>::narrow_cmpxchg((intptr_t)&data[i], 120, 42, \/* result *\/ 67, false);\n+    ret = cmpxchg.cmpxchg((intptr_t)&data[i], 120, 42);\n@@ -307,1 +311,1 @@\n-    ret = NarrowCmpxchgTester<TESTSIZE, ASMSIZE>::narrow_cmpxchg((intptr_t)&data[i], 121, 42, \/* result *\/ 67, true);\n+    ret = cmpxchg_bool.cmpxchg((intptr_t)&data[i], 121, 42);\n@@ -312,1 +316,1 @@\n-    ret = NarrowCmpxchgTester<TESTSIZE, ASMSIZE>::narrow_cmpxchg((intptr_t)&data[i], 120, 42, \/* result *\/ 67, true);\n+    ret = cmpxchg_bool.cmpxchg((intptr_t)&data[i], 120, 42);\n@@ -325,0 +329,6 @@\n+TEST_VM(RiscV, cmpxchg_int16_maybe_zacas) {\n+  if (UseZacas) {\n+    run_narrow_cmpxchg_tests<int16_t, Assembler::int16>();\n+  }\n+}\n+\n@@ -332,1 +342,1 @@\n-TEST_VM(RiscV, cmpxchg_int16_maybe_zacas) {\n+TEST_VM(RiscV, cmpxchg_int8_maybe_zacas) {\n@@ -334,1 +344,1 @@\n-    run_narrow_cmpxchg_tests<int16_t, Assembler::int16>();\n+    run_narrow_cmpxchg_tests<int8_t, Assembler::int8>();\n@@ -338,1 +348,83 @@\n-TEST_VM(RiscV, cmpxchg_int8_maybe_zacas) {\n+template <typename TESTSIZE>\n+TESTSIZE next_count(TESTSIZE now, TESTSIZE add) {\n+  if ((std::numeric_limits<TESTSIZE>::max() - add) >= now) {\n+    return now + add;\n+  }\n+  TESTSIZE diff = std::numeric_limits<TESTSIZE>::max() - now;\n+  add -= diff;\n+  return std::numeric_limits<TESTSIZE>::min() + add;\n+}\n+\n+constexpr int64_t PAR_IT_END       = 10000;\n+constexpr int64_t NUMBER_THREADS   = 4;\n+constexpr int64_t TOTAL_ITERATIONS = NUMBER_THREADS * PAR_IT_END;\n+\n+template <typename TESTSIZE>\n+constexpr TESTSIZE result_count() {\n+  if (std::numeric_limits<TESTSIZE>::max() > (std::numeric_limits<TESTSIZE>::min() + TOTAL_ITERATIONS)) {\n+    return std::numeric_limits<TESTSIZE>::min() + TOTAL_ITERATIONS;\n+  }\n+  int64_t range = std::numeric_limits<TESTSIZE>::max();\n+  range -= std::numeric_limits<TESTSIZE>::min();\n+  int64_t rest = TOTAL_ITERATIONS % range;\n+  return std::numeric_limits<TESTSIZE>::min() + rest;\n+}\n+\n+template<>\n+constexpr int64_t result_count<int64_t>() {\n+    return std::numeric_limits<int64_t>::min() + TOTAL_ITERATIONS;\n+}\n+\n+template <typename TESTSIZE, Assembler::operand_size ASMSIZE>\n+static void run_concurrent_cmpxchg_tests() {\n+  volatile TESTSIZE data = std::numeric_limits<TESTSIZE>::min();\n+  int num_threads = NUMBER_THREADS;\n+  CmpxchgTester<TESTSIZE, ASMSIZE> cmpxchg(0, false); \/\/ variant 0, not bool ret\n+  auto incThread = [&](Thread* _current, int _id) {   \/\/ _id starts from 0..(CTHREAD-1)\n+    TESTSIZE my_oldvalue = std::numeric_limits<TESTSIZE>::min() + _id;\n+    for (int64_t i = 0; i < PAR_IT_END ; i++) {\n+      TESTSIZE newvalue = next_count<TESTSIZE>(my_oldvalue,  1);\n+      TESTSIZE ret;\n+      do {\n+        ret = cmpxchg.cmpxchg((intptr_t)&data, my_oldvalue, newvalue);\n+      } while (ret != my_oldvalue);\n+      my_oldvalue = next_count<TESTSIZE>(my_oldvalue, num_threads);\n+    }\n+  };\n+  TestThreadGroup<decltype(incThread)> ttg(incThread, num_threads);\n+  ttg.doit();\n+  ttg.join();\n+  ASSERT_EQ(data, result_count<TESTSIZE>());\n+}\n+\n+template <typename TESTSIZE, Assembler::operand_size ASMSIZE>\n+static void run_concurrent_alt_cmpxchg_tests() {\n+  volatile TESTSIZE data = std::numeric_limits<TESTSIZE>::min();\n+  int num_threads = NUMBER_THREADS;\n+  CmpxchgTester<TESTSIZE, ASMSIZE> cmpxchg(0, false); \/\/ variant 0, not bool ret\n+  auto incThread = [&](Thread* _current, int _id) {   \/\/ _id starts from 0..(CTHREAD-1)\n+    for (int i = 0; i < PAR_IT_END; i++) {\n+      TESTSIZE oldvalue;\n+      TESTSIZE ret = 0;\n+      do {\n+        oldvalue = ret;\n+        TESTSIZE newvalue = next_count<TESTSIZE>(oldvalue, 1);\n+        ret = cmpxchg.cmpxchg((intptr_t)&data, oldvalue, newvalue);\n+      } while (ret != oldvalue);\n+    }\n+  };\n+  TestThreadGroup<decltype(incThread)> ttg(incThread, num_threads);\n+  ttg.doit();\n+  ttg.join();\n+  ASSERT_EQ(data, result_count<TESTSIZE>());\n+}\n+\n+TEST_VM(RiscV, cmpxchg_int64_concurrent_lr_sc) {\n+  bool zacas = UseZacas;\n+  UseZacas = false;\n+  run_concurrent_cmpxchg_tests<int64_t, Assembler::int64>();\n+  run_concurrent_alt_cmpxchg_tests<int64_t, Assembler::int64>();\n+  UseZacas = zacas;\n+}\n+\n+TEST_VM(RiscV, cmpxchg_int64_concurrent_maybe_zacas) {\n@@ -340,1 +432,47 @@\n-    run_narrow_cmpxchg_tests<int8_t, Assembler::int8>();\n+    run_concurrent_cmpxchg_tests<int64_t, Assembler::int64>();\n+    run_concurrent_alt_cmpxchg_tests<int64_t, Assembler::int64>();\n+  }\n+}\n+\n+TEST_VM(RiscV, cmpxchg_int32_concurrent_lr_sc) {\n+  bool zacas = UseZacas;\n+  UseZacas = false;\n+  run_concurrent_cmpxchg_tests<int32_t, Assembler::int32>();\n+  run_concurrent_alt_cmpxchg_tests<int32_t, Assembler::int32>();\n+  UseZacas = zacas;\n+}\n+\n+TEST_VM(RiscV, cmpxchg_int32_concurrent_maybe_zacas) {\n+  if (UseZacas) {\n+    run_concurrent_cmpxchg_tests<int32_t, Assembler::int32>();\n+    run_concurrent_alt_cmpxchg_tests<int32_t, Assembler::int32>();\n+  }\n+}\n+\n+TEST_VM(RiscV, cmpxchg_int16_concurrent_lr_sc) {\n+  bool zacas = UseZacas;\n+  UseZacas = false;\n+  run_concurrent_cmpxchg_tests<int16_t, Assembler::int16>();\n+  run_concurrent_alt_cmpxchg_tests<int16_t, Assembler::int16>();\n+  UseZacas = zacas;\n+}\n+\n+TEST_VM(RiscV, cmpxchg_int16_concurrent_maybe_zacas) {\n+  if (UseZacas) {\n+    run_concurrent_cmpxchg_tests<int16_t, Assembler::int16>();\n+    run_concurrent_alt_cmpxchg_tests<int16_t, Assembler::int16>();\n+  }\n+}\n+\n+TEST_VM(RiscV, cmpxchg_int8_concurrent_lr_sc) {\n+  bool zacas = UseZacas;\n+  UseZacas = false;\n+  run_concurrent_cmpxchg_tests<int8_t, Assembler::int8>();\n+  run_concurrent_alt_cmpxchg_tests<int8_t, Assembler::int8>();\n+  UseZacas = zacas;\n+}\n+\n+TEST_VM(RiscV, cmpxchg_int8_concurrent_maybe_zacas) {\n+  if (UseZacas) {\n+    run_concurrent_cmpxchg_tests<int8_t, Assembler::int8>();\n+    run_concurrent_alt_cmpxchg_tests<int8_t, Assembler::int8>();\n@@ -346,2 +484,1 @@\n- public:\n-  typedef TESTSIZE (*cmpxchg_narrow)(intptr_t addr, TESTSIZE expected, TESTSIZE new_value, TESTSIZE result,\n+  typedef TESTSIZE (*weak_cmpxchg_narrow_func)(intptr_t addr, TESTSIZE expected, TESTSIZE new_value, TESTSIZE result,\n@@ -350,1 +487,1 @@\n-  typedef TESTSIZE (*cmpxchg_func)(intptr_t addr, TESTSIZE expected, TESTSIZE new_value, TESTSIZE result);\n+  typedef TESTSIZE (*weak_cmpxchg_func)(intptr_t addr, TESTSIZE expected, TESTSIZE new_value, TESTSIZE result);\n@@ -352,3 +489,8 @@\n-  static TESTSIZE weak_narrow_cmpxchg(intptr_t addr, TESTSIZE expected, TESTSIZE new_value) {\n-    BufferBlob* bb = BufferBlob::create(\"riscvTest\", 128);\n-    CodeBuffer code(bb);\n+  BufferBlob*  _bb;\n+  weak_cmpxchg_narrow_func _narrow_weak;\n+  weak_cmpxchg_func _weak;\n+\n+ public:\n+  WeakCmpxchgTester() : _bb(nullptr), _narrow_weak(nullptr), _weak(nullptr) {\n+    _bb = BufferBlob::create(\"riscvTest\", 128);\n+    CodeBuffer code(_bb);\n@@ -356,2 +498,2 @@\n-    address entry = _masm.pc();\n-    {\n+    if (ASMSIZE == Assembler::int8 || ASMSIZE == Assembler::int16) {\n+        address entry = _masm.pc();\n@@ -363,13 +505,3 @@\n-    }\n-    _masm.flush(); \/\/ icache invalidate\n-    TESTSIZE ret = ((cmpxchg_narrow)entry)(addr, expected, new_value, \/*result*\/ 67, -1, -1, -1);\n-    BufferBlob::free(bb);\n-    return ret;\n-  }\n-\n-  static TESTSIZE weak_cmpxchg(intptr_t addr, TESTSIZE expected, TESTSIZE new_value) {\n-    BufferBlob* bb = BufferBlob::create(\"riscvTest\", 128);\n-    CodeBuffer code(bb);\n-    MacroAssembler _masm(&code);\n-    address entry = _masm.pc();\n-    {\n+      _narrow_weak = ((weak_cmpxchg_narrow_func)entry);\n+    } else {\n+        address entry = _masm.pc();\n@@ -380,0 +512,1 @@\n+      _weak = ((weak_cmpxchg_func)entry);\n@@ -382,3 +515,12 @@\n-    TESTSIZE ret = ((cmpxchg_func)entry)(addr, expected, new_value, \/*result*\/ 67);\n-    BufferBlob::free(bb);\n-    return ret;\n+  }\n+\n+  TESTSIZE weak_cmpxchg(intptr_t addr, TESTSIZE expected, TESTSIZE new_value) {\n+    if (ASMSIZE == Assembler::int8 || ASMSIZE == Assembler::int16) {\n+      return _narrow_weak(addr, expected, new_value, \/* dummy result *\/ 67, -1, -1, -1);\n+    } else {\n+      return _weak(addr, expected, new_value, \/* dummy result *\/ 67);\n+    }\n+  }\n+\n+  ~WeakCmpxchgTester() {\n+    BufferBlob::free(_bb);\n@@ -389,6 +531,6 @@\n-void run_weak_cmpxchg_narrow_value_tests() {\n-  \/\/ Assume natural aligned\n-  TESTSIZE data[8];\n-  TESTSIZE ret;\n-  for (int i = 0; i < 7; i++) {\n-    memset(data, -1, sizeof(data));\n+void run_weak_cmpxchg_tests() {\n+  WeakCmpxchgTester<TESTSIZE, ASMSIZE> cmpxchg;\n+  TESTSIZE data = 121;\n+  TESTSIZE ret = cmpxchg.weak_cmpxchg((intptr_t)&data, 121, 42);\n+  ASSERT_EQ(ret, 1);\n+  ASSERT_EQ(data, 42);\n@@ -396,4 +538,5 @@\n-    data[i] = 121;\n-    ret = WeakCmpxchgTester<TESTSIZE, ASMSIZE>::weak_narrow_cmpxchg((intptr_t)&data[i], 121, 42);\n-    ASSERT_EQ(ret, 1);\n-    ASSERT_EQ(data[i], 42);\n+  data = 121;\n+  ret = cmpxchg.weak_cmpxchg((intptr_t)&data, 120, 42);\n+  ASSERT_EQ(ret, 0);\n+  ASSERT_EQ(data, 121);\n+}\n@@ -401,4 +544,23 @@\n-    data[i] = 121;\n-    ret = WeakCmpxchgTester<TESTSIZE, ASMSIZE>::weak_narrow_cmpxchg((intptr_t)&data[i], 120, 42);\n-    ASSERT_EQ(ret, 0);\n-    ASSERT_EQ(data[i], 121);\n+TEST_VM(RiscV, weak_cmpxchg_int64_lr_sc) {\n+  bool zacas = UseZacas;\n+  UseZacas = false;\n+  run_weak_cmpxchg_tests<int64_t, Assembler::int64>();\n+  UseZacas = zacas;\n+}\n+\n+TEST_VM(RiscV, weak_cmpxchg_int64_maybe_zacas) {\n+  if (UseZacas) {\n+    run_weak_cmpxchg_tests<int64_t, Assembler::int64>();\n+  }\n+}\n+\n+TEST_VM(RiscV, weak_cmpxchg_int32_lr_sc) {\n+  bool zacas = UseZacas;\n+  UseZacas = false;\n+  run_weak_cmpxchg_tests<int32_t, Assembler::int32>();\n+  UseZacas = zacas;\n+}\n+\n+TEST_VM(RiscV, weak_cmpxchg_int32_maybe_zacas) {\n+  if (UseZacas) {\n+    run_weak_cmpxchg_tests<int32_t, Assembler::int32>();\n@@ -411,1 +573,1 @@\n-  run_weak_cmpxchg_narrow_value_tests<int16_t, Assembler::int16>();\n+  run_weak_cmpxchg_tests<int16_t, Assembler::int16>();\n@@ -418,1 +580,1 @@\n-  run_weak_cmpxchg_narrow_value_tests<int8_t, Assembler::int8>();\n+  run_weak_cmpxchg_tests<int8_t, Assembler::int8>();\n@@ -424,1 +586,1 @@\n-    run_weak_cmpxchg_narrow_value_tests<int16_t, Assembler::int16>();\n+    run_weak_cmpxchg_tests<int16_t, Assembler::int16>();\n@@ -430,1 +592,1 @@\n-    run_weak_cmpxchg_narrow_value_tests<int8_t, Assembler::int8>();\n+    run_weak_cmpxchg_tests<int8_t, Assembler::int8>();\n@@ -435,5 +597,20 @@\n-void run_weak_cmpxchg_tests() {\n-  TESTSIZE data = 121;\n-  TESTSIZE ret = WeakCmpxchgTester<TESTSIZE, ASMSIZE>::weak_cmpxchg((intptr_t)&data, 121, 42);\n-  ASSERT_EQ(ret, 1);\n-  ASSERT_EQ(data, 42);\n+static void run_concurrent_weak_cmpxchg_tests() {\n+  volatile TESTSIZE data = std::numeric_limits<TESTSIZE>::min();\n+  int num_threads = NUMBER_THREADS;\n+  WeakCmpxchgTester<TESTSIZE, ASMSIZE> cmpxchg; \/\/ not bool ret\n+  auto incThread = [&](Thread* _current, int _id) { \/\/ _id starts from 0..(CTHREAD-1)\n+    TESTSIZE my_oldvalue = std::numeric_limits<TESTSIZE>::min() + _id;\n+    for (int64_t i = 0; i < PAR_IT_END; i++) {\n+      TESTSIZE newvalue = next_count<TESTSIZE>(my_oldvalue, 1);\n+      TESTSIZE ret;\n+      do {\n+        ret = cmpxchg.weak_cmpxchg((intptr_t)&data, my_oldvalue, newvalue);\n+      } while (ret != 1);\n+      my_oldvalue = next_count<TESTSIZE>(my_oldvalue, num_threads);\n+    }\n+  };\n+  TestThreadGroup<decltype(incThread)> ttg(incThread, num_threads);\n+  ttg.doit();\n+  ttg.join();\n+  ASSERT_EQ(data, result_count<TESTSIZE>());\n+}\n@@ -441,4 +618,20 @@\n-  data = 121;\n-  ret = WeakCmpxchgTester<TESTSIZE, ASMSIZE>::weak_cmpxchg((intptr_t)&data, 120, 42);\n-  ASSERT_EQ(ret, 0);\n-  ASSERT_EQ(data, 121);\n+template <typename TESTSIZE, Assembler::operand_size ASMSIZE>\n+static void run_concurrent_alt_weak_cmpxchg_tests() {\n+  volatile TESTSIZE data = std::numeric_limits<TESTSIZE>::min();\n+  int num_threads = NUMBER_THREADS;\n+  WeakCmpxchgTester<TESTSIZE, ASMSIZE> cmpxchg; \/\/ not bool ret\n+  auto incThread = [&](Thread* _current, int _id) { \/\/ _id starts from 0..(CTHREAD-1)\n+    for (int i = 0; i < PAR_IT_END; i++) {\n+      TESTSIZE oldvalue;\n+      TESTSIZE ret = 0;\n+      do {\n+        oldvalue = data;\n+        TESTSIZE newvalue = next_count<TESTSIZE>(oldvalue, 1);\n+        ret = cmpxchg.weak_cmpxchg((intptr_t)&data, oldvalue, newvalue);\n+      } while (ret != 1);\n+    }\n+  };\n+  TestThreadGroup<decltype(incThread)> ttg(incThread, num_threads);\n+  ttg.doit();\n+  ttg.join();\n+  ASSERT_EQ(data, result_count<TESTSIZE>());\n@@ -447,1 +640,1 @@\n-TEST_VM(RiscV, weak_cmpxchg_int64_lr_sc) {\n+TEST_VM(RiscV, weak_cmpxchg_int64_concurrent_lr_sc) {\n@@ -450,1 +643,2 @@\n-  run_weak_cmpxchg_tests<int64_t, Assembler::int64>();\n+  run_concurrent_weak_cmpxchg_tests<int64_t, Assembler::int64>();\n+  run_concurrent_alt_weak_cmpxchg_tests<int64_t, Assembler::int64>();\n@@ -454,1 +648,1 @@\n-TEST_VM(RiscV, weak_cmpxchg_int64_maybe_zacas) {\n+TEST_VM(RiscV, weak_cmpxchg_int64_concurrent_maybe_zacas) {\n@@ -456,1 +650,2 @@\n-    run_weak_cmpxchg_tests<int64_t, Assembler::int64>();\n+    run_concurrent_weak_cmpxchg_tests<int64_t, Assembler::int64>();\n+    run_concurrent_alt_weak_cmpxchg_tests<int64_t, Assembler::int64>();\n@@ -460,1 +655,1 @@\n-TEST_VM(RiscV, weak_cmpxchg_int32_lr_sc) {\n+TEST_VM(RiscV, weak_cmpxchg_int32_concurrent_lr_sc) {\n@@ -463,1 +658,2 @@\n-  run_weak_cmpxchg_tests<int32_t, Assembler::int32>();\n+  run_concurrent_weak_cmpxchg_tests<int32_t, Assembler::int32>();\n+  run_concurrent_alt_weak_cmpxchg_tests<int32_t, Assembler::int32>();\n@@ -467,1 +663,1 @@\n-TEST_VM(RiscV, weak_cmpxchg_int32_maybe_zacas) {\n+TEST_VM(RiscV, weak_cmpxchg_int32_concurrent_maybe_zacas) {\n@@ -469,1 +665,32 @@\n-    run_weak_cmpxchg_tests<int32_t, Assembler::int32>();\n+    run_concurrent_weak_cmpxchg_tests<int32_t, Assembler::int32>();\n+    run_concurrent_alt_weak_cmpxchg_tests<int32_t, Assembler::int32>();\n+  }\n+}\n+\n+TEST_VM(RiscV, weak_cmpxchg_int16_concurrent_lr_sc) {\n+  bool zacas = UseZacas;\n+  UseZacas = false;\n+  run_concurrent_weak_cmpxchg_tests<int16_t, Assembler::int16>();\n+  run_concurrent_alt_weak_cmpxchg_tests<int16_t, Assembler::int16>();\n+  UseZacas = zacas;\n+}\n+\n+TEST_VM(RiscV, weak_cmpxchg_int16_concurrent_maybe_zacas) {\n+  if (UseZacas) {\n+    run_concurrent_weak_cmpxchg_tests<int16_t, Assembler::int16>();\n+    run_concurrent_alt_weak_cmpxchg_tests<int16_t, Assembler::int16>();\n+  }\n+}\n+\n+TEST_VM(RiscV, weak_cmpxchg_int8_concurrent_lr_sc) {\n+  bool zacas = UseZacas;\n+  UseZacas = false;\n+  run_concurrent_weak_cmpxchg_tests<int8_t, Assembler::int8>();\n+  run_concurrent_alt_weak_cmpxchg_tests<int8_t, Assembler::int8>();\n+  UseZacas = zacas;\n+}\n+\n+TEST_VM(RiscV, weak_cmpxchg_int8_concurrent_maybe_zacas) {\n+  if (UseZacas) {\n+    run_concurrent_weak_cmpxchg_tests<int8_t, Assembler::int8>();\n+    run_concurrent_alt_weak_cmpxchg_tests<int8_t, Assembler::int8>();\n","filename":"test\/hotspot\/gtest\/riscv\/test_assembler_riscv.cpp","additions":340,"deletions":113,"binary":false,"changes":453,"status":"modified"}]}