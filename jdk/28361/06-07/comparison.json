{"files":[{"patch":"@@ -1687,2 +1687,2 @@\n-int java_lang_Thread::_VTMS_transition_disable_count_offset;\n-int java_lang_Thread::_is_in_VTMS_transition_offset;\n+int java_lang_Thread::_vthread_transition_disable_count_offset;\n+int java_lang_Thread::_is_in_vthread_transition_offset;\n@@ -1748,2 +1748,2 @@\n-int java_lang_Thread::VTMS_transition_disable_count(oop java_thread) {\n-  jint* addr = java_thread->field_addr<jint>(_VTMS_transition_disable_count_offset);\n+int java_lang_Thread::vthread_transition_disable_count(oop java_thread) {\n+  jint* addr = java_thread->field_addr<jint>(_vthread_transition_disable_count_offset);\n@@ -1753,3 +1753,3 @@\n-void java_lang_Thread::inc_VTMS_transition_disable_count(oop java_thread) {\n-  assert(VTMSTransition_lock->owned_by_self(), \"Must be locked\");\n-  jint* addr = java_thread->field_addr<jint>(_VTMS_transition_disable_count_offset);\n+void java_lang_Thread::inc_vthread_transition_disable_count(oop java_thread) {\n+  assert(VThreadTransition_lock->owned_by_self(), \"Must be locked\");\n+  jint* addr = java_thread->field_addr<jint>(_vthread_transition_disable_count_offset);\n@@ -1760,3 +1760,3 @@\n-void java_lang_Thread::dec_VTMS_transition_disable_count(oop java_thread) {\n-  assert(VTMSTransition_lock->owned_by_self(), \"Must be locked\");\n-  jint* addr = java_thread->field_addr<jint>(_VTMS_transition_disable_count_offset);\n+void java_lang_Thread::dec_vthread_transition_disable_count(oop java_thread) {\n+  assert(VThreadTransition_lock->owned_by_self(), \"Must be locked\");\n+  jint* addr = java_thread->field_addr<jint>(_vthread_transition_disable_count_offset);\n@@ -1767,2 +1767,2 @@\n-bool java_lang_Thread::is_in_VTMS_transition(oop java_thread) {\n-  jboolean* addr = java_thread->field_addr<jboolean>(_is_in_VTMS_transition_offset);\n+bool java_lang_Thread::is_in_vthread_transition(oop java_thread) {\n+  jboolean* addr = java_thread->field_addr<jboolean>(_is_in_vthread_transition_offset);\n@@ -1772,3 +1772,3 @@\n-void java_lang_Thread::set_is_in_VTMS_transition(oop java_thread, bool val) {\n-  assert(is_in_VTMS_transition(java_thread) != val, \"already %s transition\", val ? \"inside\" : \"outside\");\n-  jboolean* addr = java_thread->field_addr<jboolean>(_is_in_VTMS_transition_offset);\n+void java_lang_Thread::set_is_in_vthread_transition(oop java_thread, bool val) {\n+  assert(is_in_vthread_transition(java_thread) != val, \"already %s transition\", val ? \"inside\" : \"outside\");\n+  jboolean* addr = java_thread->field_addr<jboolean>(_is_in_vthread_transition_offset);\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.cpp","additions":15,"deletions":15,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -378,2 +378,2 @@\n-  macro(java_lang_Thread, VTMS_transition_disable_count, int_signature, false) \\\n-  macro(java_lang_Thread, is_in_VTMS_transition, bool_signature, false) \\\n+  macro(java_lang_Thread, vthread_transition_disable_count, int_signature, false) \\\n+  macro(java_lang_Thread, is_in_vthread_transition, bool_signature, false) \\\n@@ -393,2 +393,2 @@\n-  static int _VTMS_transition_disable_count_offset;\n-  static int _is_in_VTMS_transition_offset;\n+  static int _vthread_transition_disable_count_offset;\n+  static int _is_in_vthread_transition_offset;\n@@ -448,4 +448,4 @@\n-  static int  VTMS_transition_disable_count(oop java_thread);\n-  static void inc_VTMS_transition_disable_count(oop java_thread);\n-  static void dec_VTMS_transition_disable_count(oop java_thread);\n-  static int  VTMS_transition_disable_count_offset() { return _VTMS_transition_disable_count_offset; }\n+  static int  vthread_transition_disable_count(oop java_thread);\n+  static void inc_vthread_transition_disable_count(oop java_thread);\n+  static void dec_vthread_transition_disable_count(oop java_thread);\n+  static int  vthread_transition_disable_count_offset() { return _vthread_transition_disable_count_offset; }\n@@ -453,3 +453,3 @@\n-  static bool is_in_VTMS_transition(oop java_thread);\n-  static void set_is_in_VTMS_transition(oop java_thread, bool val);\n-  static int  is_in_VTMS_transition_offset() { return _is_in_VTMS_transition_offset; }\n+  static bool is_in_vthread_transition(oop java_thread);\n+  static void set_is_in_vthread_transition(oop java_thread, bool val);\n+  static int  is_in_vthread_transition_offset() { return _is_in_vthread_transition_offset; }\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.hpp","additions":11,"deletions":11,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -500,2 +500,2 @@\n-  template(VTMS_transition_disable_count_name,        \"VTMS_transition_disable_count\")            \\\n-  template(is_in_VTMS_transition_name,                \"is_in_VTMS_transition\")                    \\\n+  template(vthread_transition_disable_count_name,     \"vthread_transition_disable_count\")         \\\n+  template(is_in_vthread_transition_name,             \"is_in_vthread_transition\")                 \\\n","filename":"src\/hotspot\/share\/classfile\/vmSymbols.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -263,1 +263,1 @@\n-  nonstatic_field(JavaThread,                  _is_in_VTMS_transition,                        bool)                                  \\\n+  nonstatic_field(JavaThread,                  _is_in_vthread_transition,                     bool)                                  \\\n@@ -439,1 +439,1 @@\n-  static_field(java_lang_Thread,            _is_in_VTMS_transition_offset,                    int)                                   \\\n+  static_field(java_lang_Thread,            _is_in_vthread_transition_offset,                 int)                                   \\\n","filename":"src\/hotspot\/share\/jvmci\/vmStructs_jvmci.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -3046,0 +3046,13 @@\n+\/\/--------------------inline_native_vthread_start_transition--------------------\n+\/\/ inline void startTransition(boolean is_mount);\n+\/\/ inline void endFirstTransition();\n+\/\/ Pseudocode of implementation:\n+\/\/\n+\/\/ java_lang_Thread::set_is_in_VTMS_transition(vthread, true);\n+\/\/ carrier->set_is_in_VTMS_transition(true);\n+\/\/ OrderAccess::storeload();\n+\/\/ int disable_requests = java_lang_Thread::vthread_transition_disable_count(vthread)\n+\/\/                        + global_vthread_transition_disable_count();\n+\/\/ if (disable_requests > 0) {\n+\/\/   slow path: runtime call\n+\/\/ }\n@@ -3051,2 +3064,2 @@\n-  Node* jt_addr = basic_plus_adr(thread, in_bytes(JavaThread::is_in_VTMS_transition_offset()));\n-  Node* vt_addr = basic_plus_adr(vt_oop, java_lang_Thread::is_in_VTMS_transition_offset());\n+  Node* jt_addr = basic_plus_adr(thread, in_bytes(JavaThread::is_in_vthread_transition_offset()));\n+  Node* vt_addr = basic_plus_adr(vt_oop, java_lang_Thread::is_in_vthread_transition_offset());\n@@ -3058,1 +3071,1 @@\n-  Node* global_disable_addr = makecon(TypeRawPtr::make((address)MountUnmountDisabler::global_start_transition_disable_count_address()));\n+  Node* global_disable_addr = makecon(TypeRawPtr::make((address)MountUnmountDisabler::global_vthread_transition_disable_count_address()));\n@@ -3060,1 +3073,1 @@\n-  Node* vt_disable_addr = basic_plus_adr(vt_oop, java_lang_Thread::VTMS_transition_disable_count_offset());\n+  Node* vt_disable_addr = basic_plus_adr(vt_oop, java_lang_Thread::vthread_transition_disable_count_offset());\n@@ -3092,2 +3105,2 @@\n-    Node* jt_addr = basic_plus_adr(thread, in_bytes(JavaThread::is_in_VTMS_transition_offset()));\n-    Node* vt_addr = basic_plus_adr(vt_oop, java_lang_Thread::is_in_VTMS_transition_offset());\n+    Node* jt_addr = basic_plus_adr(thread, in_bytes(JavaThread::is_in_vthread_transition_offset()));\n+    Node* vt_addr = basic_plus_adr(vt_oop, java_lang_Thread::is_in_vthread_transition_offset());\n","filename":"src\/hotspot\/share\/opto\/library_call.cpp","additions":19,"deletions":6,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -560,2 +560,2 @@\n-  java_lang_Thread::set_is_in_VTMS_transition(vt, false);\n-  current->set_is_in_VTMS_transition(false);\n+  java_lang_Thread::set_is_in_vthread_transition(vt, false);\n+  current->set_is_in_vthread_transition(false);\n@@ -566,2 +566,2 @@\n-  java_lang_Thread::set_is_in_VTMS_transition(vt, false);\n-  current->set_is_in_VTMS_transition(false);\n+  java_lang_Thread::set_is_in_vthread_transition(vt, false);\n+  current->set_is_in_vthread_transition(false);\n","filename":"src\/hotspot\/share\/opto\/runtime.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -701,1 +701,1 @@\n-  jvf = check_and_skip_hidden_frames(jt->is_in_VTMS_transition(), jvf);\n+  jvf = check_and_skip_hidden_frames(jt->is_in_vthread_transition(), jvf);\n@@ -723,0 +723,1 @@\n+    assert(!java_thread->is_in_vthread_transition(), \"invariant\");\n@@ -1696,1 +1697,1 @@\n-      if (jt->is_in_VTMS_transition()) {\n+      if (jt->is_in_vthread_transition()) {\n@@ -2038,1 +2039,1 @@\n-  assert(!Continuations::enabled() || self || !is_virtual || current->is_VTMS_transition_disabler(), \"sanity check\");\n+  assert(!Continuations::enabled() || self || !is_virtual || current->is_vthread_transition_disabler(), \"sanity check\");\n@@ -2612,1 +2613,1 @@\n-                   java_thread->is_VTMS_transition_disabler(), java_thread->is_in_VTMS_transition());\n+                   java_thread->is_vthread_transition_disabler(), java_thread->is_in_vthread_transition());\n","filename":"src\/hotspot\/share\/prims\/jvmtiEnvBase.cpp","additions":5,"deletions":4,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -69,1 +69,1 @@\n-    assert(!_current->is_in_VTMS_transition(), \"must be\");\n+    assert(!_current->is_in_vthread_transition(), \"must be\");\n@@ -90,1 +90,1 @@\n-    assert(_current->is_in_VTMS_transition(), \"must be\");\n+    assert(_current->is_in_vthread_transition(), \"must be\");\n@@ -103,1 +103,1 @@\n-  if (current->is_in_VTMS_transition()) {\n+  if (current->is_in_vthread_transition()) {\n","filename":"src\/hotspot\/share\/runtime\/continuation.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2634,1 +2634,1 @@\n-  assert(_thread->is_in_VTMS_transition(), \"must be\");\n+  assert(_thread->is_in_vthread_transition(), \"must be\");\n@@ -2644,2 +2644,2 @@\n-      java_lang_Thread::set_is_in_VTMS_transition(_thread->vthread(), false);\n-      _thread->set_is_in_VTMS_transition(false);\n+      java_lang_Thread::set_is_in_vthread_transition(_thread->vthread(), false);\n+      _thread->set_is_in_vthread_transition(false);\n","filename":"src\/hotspot\/share\/runtime\/continuationFreezeThaw.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -500,2 +500,2 @@\n-  _is_in_VTMS_transition(false),\n-  DEBUG_ONLY(_is_VTMS_transition_disabler(false) COMMA)\n+  _is_in_vthread_transition(false),\n+  DEBUG_ONLY(_is_vthread_transition_disabler(false) COMMA)\n@@ -1150,2 +1150,5 @@\n-bool JavaThread::is_in_VTMS_transition() const {\n-  return AtomicAccess::load(&_is_in_VTMS_transition);\n+bool JavaThread::is_in_vthread_transition() const {\n+  DEBUG_ONLY(Thread* current = Thread::current();)\n+  assert(is_handshake_safe_for(current) || SafepointSynchronize::is_at_safepoint()\n+         || JavaThread::cast(current)->is_disabler_at_start(), \"not safe\");\n+  return AtomicAccess::load(&_is_in_vthread_transition);\n@@ -1154,3 +1157,3 @@\n-void JavaThread::set_is_in_VTMS_transition(bool val) {\n-  assert(is_in_VTMS_transition() != val, \"already %s transition\", val ? \"inside\" : \"outside\");\n-  AtomicAccess::store(&_is_in_VTMS_transition, val);\n+void JavaThread::set_is_in_vthread_transition(bool val) {\n+  assert(is_in_vthread_transition() != val, \"already %s transition\", val ? \"inside\" : \"outside\");\n+  AtomicAccess::store(&_is_in_vthread_transition, val);\n@@ -1160,2 +1163,6 @@\n-void JavaThread::set_is_VTMS_transition_disabler(bool val) {\n-  _is_VTMS_transition_disabler = val;\n+void JavaThread::set_is_vthread_transition_disabler(bool val) {\n+  _is_vthread_transition_disabler = val;\n+}\n+\n+void JavaThread::set_is_disabler_at_start(bool val) {\n+  _is_disabler_at_start = val;\n@@ -1172,2 +1179,2 @@\n-  \/\/ Suspending a JavaThread in VTMS transition or disabling VTMS transitions can cause deadlocks.\n-  assert(!is_VTMS_transition_disabler(), \"no suspend allowed for VTMS transition disablers\");\n+  \/\/ Suspending a vthread transition disabler can cause deadlocks.\n+  assert(!is_vthread_transition_disabler(), \"no suspend allowed for vthread transition disablers\");\n","filename":"src\/hotspot\/share\/runtime\/javaThread.cpp","additions":18,"deletions":11,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -735,2 +735,3 @@\n-  bool _is_in_VTMS_transition;                    \/\/ thread is in virtual thread mount state transition\n-  DEBUG_ONLY(bool _is_VTMS_transition_disabler;)  \/\/ thread currently disabled VTMS transitions\n+  bool _is_in_vthread_transition;                    \/\/ thread is in virtual thread mount state transition\n+  DEBUG_ONLY(bool _is_vthread_transition_disabler;)  \/\/ thread currently disabled vthread transitions\n+  DEBUG_ONLY(bool _is_disabler_at_start;)            \/\/ thread at process of disabling vthread transitions\n@@ -738,2 +739,2 @@\n-  bool is_in_VTMS_transition() const;\n-  void set_is_in_VTMS_transition(bool val);\n+  bool is_in_vthread_transition() const;\n+  void set_is_in_vthread_transition(bool val);\n@@ -741,2 +742,4 @@\n-  bool is_VTMS_transition_disabler() const       { return _is_VTMS_transition_disabler; }\n-  void set_is_VTMS_transition_disabler(bool val);\n+  bool is_vthread_transition_disabler() const       { return _is_vthread_transition_disabler; }\n+  void set_is_vthread_transition_disabler(bool val);\n+  bool is_disabler_at_start() const                 { return _is_disabler_at_start; }\n+  void set_is_disabler_at_start(bool val);\n@@ -760,1 +763,1 @@\n-  \/\/ - is in a VTMS transition (_is_in_VTMS_transition)\n+  \/\/ - is in a vthread transition (_is_in_vthread_transition)\n@@ -763,1 +766,1 @@\n-  bool should_hide_jvmti_events() const          { return _is_in_VTMS_transition || _is_disable_suspend || _is_in_java_upcall; }\n+  bool should_hide_jvmti_events() const          { return _is_in_vthread_transition || _is_disable_suspend || _is_in_java_upcall; }\n@@ -924,1 +927,1 @@\n-  static ByteSize is_in_VTMS_transition_offset()     { return byte_offset_of(JavaThread, _is_in_VTMS_transition); }\n+  static ByteSize is_in_vthread_transition_offset()     { return byte_offset_of(JavaThread, _is_in_vthread_transition); }\n","filename":"src\/hotspot\/share\/runtime\/javaThread.hpp","additions":12,"deletions":9,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -34,1 +34,1 @@\n-volatile int MountUnmountDisabler::_global_start_transition_disable_count = 0;\n+volatile int MountUnmountDisabler::_global_vthread_transition_disable_count = 0;\n@@ -96,1 +96,1 @@\n-        MonitorLocker ml(VTMSTransition_lock);\n+        MonitorLocker ml(VThreadTransition_lock);\n@@ -126,0 +126,5 @@\n+  \/\/ We need to read the per-vthread and global counters to check if transitions are disabled.\n+  \/\/ In case of JVMTI present, the global counter will always be at least 1. This is to force\n+  \/\/ the slow path and check for possible event posting. Here we need to check if transitions\n+  \/\/ are actually disabled, so we compare the global counter against 1 or 0 accordingly.\n+  \/\/ In case of JVMTI we also need to check for suspension.\n@@ -127,2 +132,2 @@\n-  return java_lang_Thread::VTMS_transition_disable_count(vthread) > 0\n-         || global_start_transition_disable_count() > base_disable_count\n+  return java_lang_Thread::vthread_transition_disable_count(vthread) > 0\n+         || global_vthread_transition_disable_count() > base_disable_count\n@@ -133,2 +138,2 @@\n-  assert(!java_lang_Thread::is_in_VTMS_transition(vthread), \"\");\n-  assert(!current->is_in_VTMS_transition(), \"\");\n+  assert(!java_lang_Thread::is_in_vthread_transition(vthread), \"\");\n+  assert(!current->is_in_vthread_transition(), \"\");\n@@ -138,2 +143,2 @@\n-  java_lang_Thread::set_is_in_VTMS_transition(vth(), true);\n-  current->set_is_in_VTMS_transition(true);\n+  java_lang_Thread::set_is_in_vthread_transition(vth(), true);\n+  current->set_is_in_vthread_transition(true);\n@@ -145,2 +150,2 @@\n-    java_lang_Thread::set_is_in_VTMS_transition(vth(), false);\n-    current->set_is_in_VTMS_transition(false);\n+    java_lang_Thread::set_is_in_vthread_transition(vth(), false);\n+    current->set_is_in_vthread_transition(false);\n@@ -149,1 +154,1 @@\n-      MonitorLocker ml(VTMSTransition_lock);\n+      MonitorLocker ml(VThreadTransition_lock);\n@@ -156,2 +161,2 @@\n-    java_lang_Thread::set_is_in_VTMS_transition(vth(), true);\n-    current->set_is_in_VTMS_transition(true);\n+    java_lang_Thread::set_is_in_vthread_transition(vth(), true);\n+    current->set_is_in_vthread_transition(true);\n@@ -170,2 +175,2 @@\n-  assert(java_lang_Thread::is_in_VTMS_transition(vthread), \"\");\n-  assert(current->is_in_VTMS_transition(), \"\");\n+  assert(java_lang_Thread::is_in_vthread_transition(vthread), \"\");\n+  assert(current->is_in_vthread_transition(), \"\");\n@@ -184,2 +189,2 @@\n-  java_lang_Thread::set_is_in_VTMS_transition(vth(), false);\n-  current->set_is_in_VTMS_transition(false);\n+  java_lang_Thread::set_is_in_vthread_transition(vth(), false);\n+  current->set_is_in_vthread_transition(false);\n@@ -189,1 +194,1 @@\n-    MonitorLocker ml(VTMSTransition_lock);\n+    MonitorLocker ml(VThreadTransition_lock);\n@@ -194,2 +199,2 @@\n-\/\/ disable VTMS transitions for one virtual thread\n-\/\/ disable VTMS transitions for all threads if thread is nullptr or a platform thread\n+\/\/ disable transitions for one virtual thread\n+\/\/ disable transitions for all threads if thread is nullptr or a platform thread\n@@ -207,1 +212,1 @@\n-  assert(!current->is_in_VTMS_transition(), \"\");\n+  assert(!current->is_in_vthread_transition(), \"\");\n@@ -218,1 +223,1 @@\n-  \/\/ If target is a platform thread then we have to disable VTMS transitions for all threads.\n+  \/\/ If target is a platform thread then we have to disable transitions for all threads.\n@@ -224,1 +229,1 @@\n-    VTMS_transition_disable_for_one(); \/\/ disable VTMS transitions for one virtual thread\n+    disable_transition_for_one(); \/\/ disable transitions for one virtual thread\n@@ -226,1 +231,1 @@\n-    VTMS_transition_disable_for_all(); \/\/ disable VTMS transitions for all virtual threads\n+    disable_transition_for_all(); \/\/ disable transitions for all virtual threads\n@@ -230,1 +235,1 @@\n-\/\/ disable VTMS transitions for all virtual threads\n+\/\/ disable transitions for all virtual threads\n@@ -241,2 +246,2 @@\n-  assert(!JavaThread::current()->is_in_VTMS_transition(), \"\");\n-  VTMS_transition_disable_for_all();\n+  assert(!JavaThread::current()->is_in_vthread_transition(), \"\");\n+  disable_transition_for_all();\n@@ -256,1 +261,1 @@\n-    VTMS_transition_enable_for_one(); \/\/ enable VTMS transitions for one virtual thread\n+    enable_transition_for_one(); \/\/ enable transitions for one virtual thread\n@@ -258,1 +263,1 @@\n-    VTMS_transition_enable_for_all(); \/\/ enable VTMS transitions for all virtual threads\n+    enable_transition_for_all(); \/\/ enable transitions for all virtual threads\n@@ -262,1 +267,1 @@\n-\/\/ disable VTMS transitions for one virtual thread\n+\/\/ disable transitions for one virtual thread\n@@ -264,2 +269,2 @@\n-MountUnmountDisabler::VTMS_transition_disable_for_one() {\n-  MonitorLocker ml(VTMSTransition_lock);\n+MountUnmountDisabler::disable_transition_for_one() {\n+  MonitorLocker ml(VThreadTransition_lock);\n@@ -271,1 +276,1 @@\n-  java_lang_Thread::inc_VTMS_transition_disable_count(_vthread());\n+  java_lang_Thread::inc_vthread_transition_disable_count(_vthread());\n@@ -276,1 +281,1 @@\n-  while (java_lang_Thread::is_in_VTMS_transition(_vthread())) {\n+  while (java_lang_Thread::is_in_vthread_transition(_vthread())) {\n@@ -287,1 +292,1 @@\n-  DEBUG_ONLY(JavaThread::current()->set_is_VTMS_transition_disabler(true);)\n+  DEBUG_ONLY(JavaThread::current()->set_is_vthread_transition_disabler(true);)\n@@ -290,1 +295,1 @@\n-\/\/ disable VTMS transitions for all virtual threads\n+\/\/ disable transitions for all virtual threads\n@@ -292,2 +297,3 @@\n-MountUnmountDisabler::VTMS_transition_disable_for_all() {\n-  JavaThread* thread = JavaThread::current();\n+MountUnmountDisabler::disable_transition_for_all() {\n+  DEBUG_ONLY(JavaThread* thread = JavaThread::current();)\n+  DEBUG_ONLY(thread->set_is_disabler_at_start(true);)\n@@ -295,1 +301,1 @@\n-  MonitorLocker ml(VTMSTransition_lock);\n+  MonitorLocker ml(VThreadTransition_lock);\n@@ -306,1 +312,1 @@\n-  inc_global_start_transition_disable_count();\n+  inc_global_vthread_transition_disable_count();\n@@ -315,1 +321,1 @@\n-    while (jt->is_in_VTMS_transition()) {\n+    while (jt->is_in_vthread_transition()) {\n@@ -327,1 +333,2 @@\n-  DEBUG_ONLY(thread->set_is_VTMS_transition_disabler(true);)\n+  DEBUG_ONLY(thread->set_is_vthread_transition_disabler(true);)\n+  DEBUG_ONLY(thread->set_is_disabler_at_start(false);)\n@@ -330,1 +337,1 @@\n-\/\/ enable VTMS transitions for one virtual thread\n+\/\/ enable transitions for one virtual thread\n@@ -332,1 +339,1 @@\n-MountUnmountDisabler::VTMS_transition_enable_for_one() {\n+MountUnmountDisabler::enable_transition_for_one() {\n@@ -336,1 +343,1 @@\n-  \/\/ release barrier before decrementing _VTMS_transition_disable_count to\n+  \/\/ release barrier before decrementing _vthread_transition_disable_count to\n@@ -343,1 +350,1 @@\n-  MonitorLocker ml(VTMSTransition_lock);\n+  MonitorLocker ml(VThreadTransition_lock);\n@@ -345,2 +352,2 @@\n-  java_lang_Thread::dec_VTMS_transition_disable_count(_vthread());\n-  if (java_lang_Thread::VTMS_transition_disable_count(_vthread()) == 0) {\n+  java_lang_Thread::dec_vthread_transition_disable_count(_vthread());\n+  if (java_lang_Thread::vthread_transition_disable_count(_vthread()) == 0) {\n@@ -349,1 +356,1 @@\n-  DEBUG_ONLY(JavaThread::current()->set_is_VTMS_transition_disabler(false);)\n+  DEBUG_ONLY(JavaThread::current()->set_is_vthread_transition_disabler(false);)\n@@ -352,1 +359,1 @@\n-\/\/ enable VTMS transitions for all virtual threads\n+\/\/ enable transitions for all virtual threads\n@@ -354,1 +361,1 @@\n-MountUnmountDisabler::VTMS_transition_enable_for_all() {\n+MountUnmountDisabler::enable_transition_for_all() {\n@@ -358,1 +365,1 @@\n-  \/\/ release barrier before decrementing _global_start_transition_disable_count\n+  \/\/ release barrier before decrementing _global_vthread_transition_disable_count\n@@ -365,1 +372,1 @@\n-  MonitorLocker ml(VTMSTransition_lock);\n+  MonitorLocker ml(VThreadTransition_lock);\n@@ -370,1 +377,1 @@\n-  dec_global_start_transition_disable_count();\n+  dec_global_vthread_transition_disable_count();\n@@ -372,1 +379,1 @@\n-  if (global_start_transition_disable_count() == base_disable_count || _is_exclusive) {\n+  if (global_vthread_transition_disable_count() == base_disable_count || _is_exclusive) {\n@@ -375,1 +382,1 @@\n-  DEBUG_ONLY(thread->set_is_VTMS_transition_disabler(false);)\n+  DEBUG_ONLY(thread->set_is_vthread_transition_disabler(false);)\n@@ -378,3 +385,3 @@\n-int MountUnmountDisabler::global_start_transition_disable_count() {\n-  assert(_global_start_transition_disable_count >= 0, \"\");\n-  return AtomicAccess::load(&_global_start_transition_disable_count);\n+int MountUnmountDisabler::global_vthread_transition_disable_count() {\n+  assert(_global_vthread_transition_disable_count >= 0, \"\");\n+  return AtomicAccess::load(&_global_vthread_transition_disable_count);\n@@ -383,4 +390,4 @@\n-void MountUnmountDisabler::inc_global_start_transition_disable_count() {\n-  assert(VTMSTransition_lock->owned_by_self() || SafepointSynchronize::is_at_safepoint(), \"Must be locked\");\n-  assert(_global_start_transition_disable_count >= 0, \"\");\n-  AtomicAccess::store(&_global_start_transition_disable_count, _global_start_transition_disable_count + 1);\n+void MountUnmountDisabler::inc_global_vthread_transition_disable_count() {\n+  assert(VThreadTransition_lock->owned_by_self() || SafepointSynchronize::is_at_safepoint(), \"Must be locked\");\n+  assert(_global_vthread_transition_disable_count >= 0, \"\");\n+  AtomicAccess::store(&_global_vthread_transition_disable_count, _global_vthread_transition_disable_count + 1);\n@@ -389,4 +396,4 @@\n-void MountUnmountDisabler::dec_global_start_transition_disable_count() {\n-  assert(VTMSTransition_lock->owned_by_self() || SafepointSynchronize::is_at_safepoint(), \"Must be locked\");\n-  assert(_global_start_transition_disable_count > 0, \"\");\n-  AtomicAccess::store(&_global_start_transition_disable_count, _global_start_transition_disable_count - 1);\n+void MountUnmountDisabler::dec_global_vthread_transition_disable_count() {\n+  assert(VThreadTransition_lock->owned_by_self() || SafepointSynchronize::is_at_safepoint(), \"Must be locked\");\n+  assert(_global_vthread_transition_disable_count > 0, \"\");\n+  AtomicAccess::store(&_global_vthread_transition_disable_count, _global_vthread_transition_disable_count - 1);\n@@ -396,1 +403,1 @@\n-  assert(VTMSTransition_lock->owned_by_self(), \"Must be locked\");\n+  assert(VThreadTransition_lock->owned_by_self(), \"Must be locked\");\n@@ -401,1 +408,1 @@\n-  assert(VTMSTransition_lock->owned_by_self(), \"Must be locked\");\n+  assert(VThreadTransition_lock->owned_by_self(), \"Must be locked\");\n@@ -412,1 +419,1 @@\n-  assert(VTMSTransition_lock->owned_by_self(), \"Must be locked\");\n+  assert(VThreadTransition_lock->owned_by_self(), \"Must be locked\");\n@@ -418,1 +425,1 @@\n-  assert(VTMSTransition_lock->owned_by_self(), \"Must be locked\");\n+  assert(VThreadTransition_lock->owned_by_self(), \"Must be locked\");\n@@ -434,2 +441,2 @@\n-    assert(val && _global_start_transition_disable_count == 0, \"\");\n-    AtomicAccess::inc(&_global_start_transition_disable_count);\n+    assert(val && _global_vthread_transition_disable_count == 0, \"\");\n+    AtomicAccess::inc(&_global_vthread_transition_disable_count);\n@@ -439,1 +446,1 @@\n-      inc_global_start_transition_disable_count();\n+      inc_global_vthread_transition_disable_count();\n@@ -441,1 +448,1 @@\n-      dec_global_start_transition_disable_count();\n+      dec_global_vthread_transition_disable_count();\n@@ -444,1 +451,1 @@\n-  log_trace(continuations,tracking)(\"%s _notify_jvmti_events, _global_start_transition_disable_count=%d\", val ? \"enabling\" : \"disabling\", _global_start_transition_disable_count);\n+  log_trace(continuations,tracking)(\"%s _notify_jvmti_events, _global_vthread_transition_disable_count=%d\", val ? \"enabling\" : \"disabling\", _global_vthread_transition_disable_count);\n","filename":"src\/hotspot\/share\/runtime\/mountUnmountDisabler.cpp","additions":83,"deletions":76,"binary":false,"changes":159,"status":"modified"},{"patch":"@@ -33,0 +33,3 @@\n+\/\/ This class adds support to disable virtual thread transitions (mount\/unmount).\n+\/\/ This is needed to safely execute operations that access virtual thread state.\n+\/\/ Users should use the Handshake class when possible instead of using this directly.\n@@ -34,1 +37,7 @@\n-  static volatile int _global_start_transition_disable_count;\n+  \/\/ The global counter is used for operations that require disabling\n+  \/\/ transitions for all virtual threads. Currently this is only used\n+  \/\/ by some JVMTI operations. We also increment this counter when the\n+  \/\/ first JVMTI agent attaches to always force the slowpath when starting\n+  \/\/ a transition. This is needed because if JVMTI is present we need to\n+  \/\/ check for possible event posting.\n+  static volatile int _global_vthread_transition_disable_count;\n@@ -44,4 +53,4 @@\n-  void VTMS_transition_disable_for_one();\n-  void VTMS_transition_disable_for_all();\n-  void VTMS_transition_enable_for_one();\n-  void VTMS_transition_enable_for_all();\n+  void disable_transition_for_one();\n+  void disable_transition_for_all();\n+  void enable_transition_for_one();\n+  void enable_transition_for_all();\n@@ -54,3 +63,3 @@\n-  static int global_start_transition_disable_count();\n-  static void inc_global_start_transition_disable_count();\n-  static void dec_global_start_transition_disable_count();\n+  static int global_vthread_transition_disable_count();\n+  static void inc_global_vthread_transition_disable_count();\n+  static void dec_global_vthread_transition_disable_count();\n@@ -58,2 +67,2 @@\n-  static volatile int* global_start_transition_disable_count_address() {\n-    return &_global_start_transition_disable_count;\n+  static volatile int* global_vthread_transition_disable_count_address() {\n+    return &_global_vthread_transition_disable_count;\n","filename":"src\/hotspot\/share\/runtime\/mountUnmountDisabler.hpp","additions":19,"deletions":10,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -52,1 +52,1 @@\n-Monitor* VTMSTransition_lock          = nullptr;\n+Monitor* VThreadTransition_lock       = nullptr;\n@@ -268,1 +268,1 @@\n-  MUTEX_DEFN(VTMSTransition_lock             , PaddedMonitor, safepoint);   \/\/ used for Virtual Thread Mount State transition management\n+  MUTEX_DEFN(VThreadTransition_lock          , PaddedMonitor, safepoint);\n@@ -364,2 +364,2 @@\n-  MUTEX_DEFL(JvmtiThreadState_lock          , PaddedMutex  , VTMSTransition_lock);   \/\/ Used by JvmtiThreadState\/JvmtiEventController\n-  MUTEX_DEFL(SharedDecoder_lock             , PaddedMutex  , NmtVirtualMemory_lock); \/\/ Must be lower than NmtVirtualMemory_lock due to MemTracker::print_containing_region\n+  MUTEX_DEFL(JvmtiThreadState_lock          , PaddedMutex  , VThreadTransition_lock); \/\/ Used by JvmtiThreadState\/JvmtiEventController\n+  MUTEX_DEFL(SharedDecoder_lock             , PaddedMutex  , NmtVirtualMemory_lock);  \/\/ Must be lower than NmtVirtualMemory_lock due to MemTracker::print_containing_region\n","filename":"src\/hotspot\/share\/runtime\/mutexLocker.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -50,1 +50,1 @@\n-extern Monitor* VTMSTransition_lock;             \/\/ a lock for Virtual Thread Mount State transition (VTMS transition) management\n+extern Monitor* VThreadTransition_lock;          \/\/ a lock used when disabling virtual thread transitions\n","filename":"src\/hotspot\/share\/runtime\/mutexLocker.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -100,1 +100,2 @@\n-    assert(!self->is_in_VTMS_transition(), \"no suspend allowed in VTMS transition\");\n+    \/\/ Self-suspending while in transition can cause deadlocks.\n+    assert(!self->is_in_vthread_transition(), \"no self-suspend allowed in transition\");\n","filename":"src\/hotspot\/share\/runtime\/suspendResumeManager.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}