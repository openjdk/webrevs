{"files":[{"patch":"@@ -0,0 +1,113 @@\n+\/*\n+ * Copyright 2025 Arm Limited and\/or its affiliates.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+\/**\n+* @test\n+* @bug 8373574\n+* @summary Verify correct execution of CastII -> ConvHF2F IR sequence on AArch64\n+* @modules jdk.incubator.vector\n+* @library \/test\/lib \/\n+* @compile TestCastIIToConvHF2FNoSp.java\n+* @run driver\/timeout=480 compiler.vectorapi.TestCastIIToConvHF2FNoSp\n+*\/\n+\n+package compiler.vectorapi;\n+import compiler.lib.ir_framework.*;\n+import jdk.incubator.vector.*;\n+import static jdk.incubator.vector.Float16.*;\n+import static java.lang.Float.*;\n+import java.util.Arrays;\n+import jdk.test.lib.*;\n+import compiler.lib.generators.Generator;\n+import static compiler.lib.generators.Generators.G;\n+\n+public class TestCastIIToConvHF2FNoSp {\n+    short[] input1;\n+    short[] output;\n+    static final int LEN = 527;\n+\n+    static final Float16 FP16_CONST = Float16.valueOf(1023.0f);\n+    static final VectorSpecies<Float16> SPECIES = Float16Vector.SPECIES_PREFERRED;\n+\n+    public static void main(String args[]) {\n+        \/\/ Test with default MaxVectorSize\n+        TestFramework.runWithFlags(\"--add-modules=jdk.incubator.vector\");\n+\n+        \/\/ Test with different values of MaxVectorSize\n+        TestFramework.runWithFlags(\"--add-modules=jdk.incubator.vector\", \"-XX:MaxVectorSize=8\");\n+        TestFramework.runWithFlags(\"--add-modules=jdk.incubator.vector\", \"-XX:MaxVectorSize=16\");\n+        TestFramework.runWithFlags(\"--add-modules=jdk.incubator.vector\", \"-XX:MaxVectorSize=32\");\n+        TestFramework.runWithFlags(\"--add-modules=jdk.incubator.vector\", \"-XX:MaxVectorSize=64\");\n+    }\n+\n+    static void assertResults(int arity, short ... values) {\n+        assert values.length == (arity + 2);\n+        Float16 expected_fp16 = shortBitsToFloat16(values[arity]);\n+        Float16 actual_fp16 = shortBitsToFloat16(values[arity + 1]);\n+        if(!expected_fp16.equals(actual_fp16)) {\n+            String inputs = Arrays.toString(Arrays.copyOfRange(values, 0, arity - 1));\n+            throw new AssertionError(\"Result Mismatch!, input = \" + inputs + \" actual = \" + actual_fp16 +  \" expected = \" + expected_fp16);\n+        }\n+    }\n+\n+    public TestCastIIToConvHF2FNoSp() {\n+        input1 = new short[LEN];\n+        output = new short[LEN];\n+\n+        Generator<Short> gen = G.float16s();\n+        for (int i = 0; i < LEN; ++i) {\n+            input1[i] = gen.next();\n+        }\n+    }\n+\n+    @Test\n+    @IR(counts = {IRNode.MIN_VHF, \" >0 \"},\n+        applyIfCPUFeature = {\"sve\", \"true\"})\n+    @IR(counts = {IRNode.MIN_VHF, \" >0 \"},\n+        applyIfCPUFeatureAnd = {\"fphp\", \"true\", \"asimdhp\", \"true\", \"sve\", \"false\"})\n+    void vectorMinConstantInputFloat16() {\n+        int i = 0;\n+        for (; i < SPECIES.loopBound(LEN); i += SPECIES.length()) {\n+            Float16Vector.fromArray(SPECIES, input1, i)\n+                         .lanewise(VectorOperators.MIN,\n+                                   float16ToRawShortBits(FP16_CONST))\n+                         .intoArray(output, i);\n+        }\n+        if (i < LEN) {\n+            VectorMask<Float16> mask = SPECIES.indexInRange(i, LEN);\n+            Float16Vector.fromArray(SPECIES, input1, i, mask)\n+                         .lanewise(VectorOperators.MIN,\n+                                   float16ToRawShortBits(FP16_CONST))\n+                         .intoArray(output, i, mask);\n+        }\n+    }\n+\n+    @Check(test=\"vectorMinConstantInputFloat16\")\n+    void checkResultMinConstantInputFloat16() {\n+        for (int i = 0; i < LEN; ++i) {\n+            short expected = floatToFloat16(Math.min(FP16_CONST.floatValue(), float16ToFloat(input1[i])));\n+            assertResults(2, float16ToRawShortBits(FP16_CONST), input1[i], expected, output[i]);\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/compiler\/vectorapi\/TestCastIIToConvHF2FNoSp.java","additions":113,"deletions":0,"binary":false,"changes":113,"status":"added"}]}