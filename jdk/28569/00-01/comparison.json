{"files":[{"patch":"@@ -228,0 +228,1 @@\n+        private volatile boolean closed;\n@@ -313,1 +314,1 @@\n-\n+            ensureOpen();\n@@ -357,0 +358,1 @@\n+            ensureOpen();\n@@ -368,0 +370,1 @@\n+            ensureOpen();\n@@ -378,0 +381,1 @@\n+            ensureOpen();\n@@ -401,0 +405,1 @@\n+            ensureOpen();\n@@ -410,0 +415,1 @@\n+            closed = true;\n@@ -413,0 +419,6 @@\n+\n+        private void ensureOpen() throws IOException {\n+            if (closed) {\n+                throw new IOException(\"ModuleReader is closed\");\n+            }\n+        }\n@@ -444,6 +456,1 @@\n-            final JarEntry entry;\n-            try {\n-                entry = jf.getJarEntry(name);\n-            } catch (IllegalStateException ise) {\n-                throw new IOException(ise);\n-            }\n+            JarEntry entry = jf.getJarEntry(name);\n@@ -482,5 +489,1 @@\n-                    try {\n-                        return jf.getInputStream(entry);\n-                    } catch (IllegalStateException ise) {\n-                        throw new IOException(ise);\n-                    }\n+                    return jf.getInputStream(entry);\n@@ -498,5 +501,1 @@\n-            try {\n-                return jf.stream().map(JarEntry::getName);\n-            } catch (IllegalStateException ise) {\n-                throw new IOException(ise);\n-            }\n+            return jf.stream().map(JarEntry::getName);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/module\/ModulePatcher.java","additions":16,"deletions":17,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -1,111 +0,0 @@\n-\/*\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-import java.io.IOException;\n-import java.lang.module.ModuleDescriptor;\n-import java.lang.module.ModuleReader;\n-import java.lang.module.ModuleReference;\n-import java.net.URI;\n-import java.nio.file.Files;\n-import java.nio.file.Path;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.Optional;\n-import java.util.jar.JarEntry;\n-import java.util.jar.JarOutputStream;\n-import java.util.stream.Stream;\n-\n-import jdk.internal.module.ModulePatcher;\n-import org.junit.jupiter.api.Test;\n-import static org.junit.jupiter.api.Assertions.assertThrows;\n-import static org.junit.jupiter.api.Assertions.assertTrue;\n-\n-\/*\n- * @test\n- * @summary verify the implementation of jdk.internal.module.ModulePatcher$PatchedModuleReader\n- * @modules java.base\/jdk.internal.module\n- * @run junit ${test.main.class}\n- *\/\n-class PatchedModuleReaderTest {\n-\n-    \/*\n-     * The test creates a jdk.internal.module.ModulePatcher$PatchedModuleReader and verifies\n-     * that after closing that PatchedModuleReader, subsequent operations throw the specified\n-     * IOException.\n-     *\/\n-    @Test\n-    void testIOExceptionUponClose() throws IOException {\n-        \/\/ create a JAR file with an arbitrary resource\n-        final String resourceName = \"testresource\";\n-        final Path tmpJarFile = Files.createTempFile(Path.of(\".\"), \"test-\", \".jar\");\n-        try (JarOutputStream jarout = new JarOutputStream(Files.newOutputStream(tmpJarFile))) {\n-            jarout.putNextEntry(new JarEntry(resourceName));\n-            jarout.write(new byte[]{0x01});\n-            jarout.closeEntry();\n-        }\n-\n-        \/\/ create a test module\/module reference\n-        final String moduleName = \"foo.bar\";\n-        final ModuleDescriptor md = ModuleDescriptor.newModule(moduleName).build();\n-        final ModuleReference dummyModuleRef = new ModuleReference(md, tmpJarFile.toUri()) {\n-            @Override\n-            public ModuleReader open() {\n-                return new NoOpModuleReader();\n-            }\n-        };\n-        \/\/ create a ModulePatcher pointing to the test module and the test JAR file\n-        final ModulePatcher patcher = new ModulePatcher(Map.of(moduleName, List.of(tmpJarFile.toString())));\n-        final ModuleReference maybePatched = patcher.patchIfNeeded(dummyModuleRef);\n-        final ModuleReader reader;\n-        \/\/ open a ModuleReader and verify that the test resource exists\n-        try (var _ = reader = maybePatched.open()) {\n-            System.err.println(\"using ModuleReader: \" + reader);\n-            final Optional<URI> res = reader.find(resourceName);\n-            assertTrue(res.isPresent(), \"missing resource\");\n-        }\n-        \/\/ now that the ModuleReader is closed, verify that an IOException gets thrown\n-        \/\/ when using that closed ModuleReader\n-        assertThrows(IOException.class, () -> reader.find(resourceName));\n-        assertThrows(IOException.class, () -> reader.read(resourceName));\n-        assertThrows(IOException.class, () -> reader.open(resourceName));\n-        assertThrows(IOException.class, () -> reader.list());\n-    }\n-\n-    private static final class NoOpModuleReader implements ModuleReader {\n-\n-        @Override\n-        public Optional<URI> find(String name) {\n-            return Optional.empty();\n-        }\n-\n-        @Override\n-        public Stream<String> list() {\n-            return Stream.empty();\n-        }\n-\n-        @Override\n-        public void close() {\n-            \/\/ no-op\n-        }\n-    }\n-}\n","filename":"test\/jdk\/java\/lang\/module\/ModuleReader\/PatchedModuleReaderTest.java","additions":0,"deletions":111,"binary":false,"changes":111,"status":"deleted"},{"patch":"@@ -0,0 +1,95 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.io.IOException;\n+import java.lang.module.ModuleFinder;\n+import java.lang.module.ModuleReader;\n+import java.lang.module.ModuleReference;\n+import java.net.URI;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+\n+import org.junit.jupiter.api.Test;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+\/*\n+ * @test\n+ * @bug 8372787\n+ * @summary verify the behaviour of ModuleReader when using --patch-module\n+ * @comment patch the java.base module with a test specific resource\n+ * @compile\/module=java.base java\/lang\/PatchedFoo.java\n+ * @run junit\/othervm ${test.main.class}\n+ *\/\n+class PatchedModuleReaderTest {\n+\n+    \/*\n+     * This test opens a ModuleReader for a patched module, accumulates\n+     * the Stream of resources from that ModuleReader and then closes that\n+     * ModuleReader. It then verifies that the closed ModuleReader\n+     * throws the specified IOException whenever it is used for subsequent\n+     * operations on the Stream of resources.\n+     *\/\n+    @Test\n+    void testIOExceptionUponClose() throws Exception {\n+        final ModuleReference mref = ModuleFinder.ofSystem()\n+                .find(\"java.base\")\n+                .orElseThrow();\n+        final ModuleReader reader;\n+        final Stream<String> resources;\n+        final String nonExistentResource = \"foo\/bar\/NonExistent.class\";\n+        \/\/ open the ModuleReader\n+        try (var _ = reader = mref.open()) {\n+            \/\/ verify we are using the patched module\n+            final String resourceName = \"java\/lang\/PatchedFoo.class\";\n+            final Optional<URI> res = reader.find(resourceName);\n+            assertTrue(res.isPresent(), resourceName + \" is missing in \"\n+                    + mref.descriptor().name() + \" module\");\n+            \/\/ test a non-existent resource\n+            assertTrue(reader.find(nonExistentResource).isEmpty(),\n+                    \"unexpected resource \" + nonExistentResource + \" in \"\n+                            + mref.descriptor().name() + \" module\");\n+            \/\/ hold on to the available resources, to test them after the\n+            \/\/ ModuleReader is closed\n+            resources = reader.list();\n+        } \/\/ close the ModuleReader\n+\n+        \/\/ verify IOException is thrown by the closed ModuleReader\n+        resources.forEach(rn -> {\n+            assertThrows(IOException.class, () -> reader.read(rn),\n+                    \"ModuleReader.read(String)\");\n+            assertThrows(IOException.class, () -> reader.open(rn),\n+                    \"ModuleReader.open(String)\");\n+            assertThrows(IOException.class, () -> reader.find(rn),\n+                    \"ModuleReader.find(String)\");\n+        });\n+\n+        \/\/ repeat the test for a non-existent resource\n+        assertThrows(IOException.class, () -> reader.read(nonExistentResource),\n+                \"ModuleReader.read(String)\");\n+        assertThrows(IOException.class, () -> reader.open(nonExistentResource),\n+                \"ModuleReader.open(String)\");\n+        assertThrows(IOException.class, () -> reader.find(nonExistentResource),\n+                \"ModuleReader.find(String)\");\n+    }\n+}\n","filename":"test\/jdk\/java\/lang\/module\/ModuleReader\/patched\/PatchedModuleReaderTest.java","additions":95,"deletions":0,"binary":false,"changes":95,"status":"added"},{"patch":"@@ -22,1 +22,0 @@\n- *\n@@ -24,0 +23,1 @@\n+package java.lang;\n@@ -25,2 +25,1 @@\n-module com.test {\n-  exports com.test;\n+public class PatchedFoo {\n","filename":"test\/jdk\/java\/lang\/module\/ModuleReader\/patched\/java.base\/java\/lang\/PatchedFoo.java","additions":2,"deletions":3,"binary":false,"changes":5,"previous_filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/aotCache\/modules\/com.test\/module-info.java","status":"copied"}]}