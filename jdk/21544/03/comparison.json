{"files":[{"patch":"@@ -94,1 +94,4 @@\n-\n+    \/\/ CEN header size + name length + comment length + extra length\n+    \/\/ should not exceed 65,535 bytes per the PKWare APP.NOTE\n+    \/\/ 4.4.10, 4.4.11, & 4.4.12.\n+    private static final int MAX_COMBINED_CEN_HEADER_SIZE = 0xFFFF;\n@@ -102,2 +105,2 @@\n-     * @throws IllegalArgumentException if the entry name is longer than\n-     *         0xFFFF bytes\n+     * @throws IllegalArgumentException if the combined length of the entry name\n+     * and {@linkplain #CENHDR CEN Header size} exceeds 65,535 bytes.\n@@ -107,1 +110,1 @@\n-        if (name.length() > 0xFFFF) {\n+        if (!isCENHeaderValid(name, null, null)) {\n@@ -522,2 +525,4 @@\n-     * @throws IllegalArgumentException if the length of the specified\n-     *         extra field data is greater than 0xFFFF bytes\n+     * @throws IllegalArgumentException if the combined length of the specified\n+     * extra field data, the {@linkplain #getName() entry name},\n+     * the {@linkplain #getComment() entry comment}, and\n+     * {@linkplain #CENHDR CEN Header size}, exceeds 65,535 bytes.\n@@ -544,1 +549,1 @@\n-            if (extra.length > 0xFFFF) {\n+            if (!isCENHeaderValid(name, extra, comment)) {\n@@ -645,5 +650,0 @@\n-     *\n-     * <p>ZIP entry comments have maximum length of 0xffff. If the length of the\n-     * specified comment string is greater than 0xFFFF bytes after encoding, only\n-     * the first 0xFFFF bytes are output to the ZIP file entry.\n-     *\n@@ -651,1 +651,4 @@\n-     *\n+     * @throws IllegalArgumentException if the combined length\n+     * of the specified entry comment, {@linkplain #getName() entry name},\n+     * the {@linkplain #getExtra() extra field data}, and\n+     * {@linkplain #CENHDR CEN Header size}, exceeds 65,535 bytes.\n@@ -655,0 +658,5 @@\n+        if (comment != null) {\n+            if (!isCENHeaderValid(name, extra, comment)) {\n+                throw new IllegalArgumentException(\"entry comment too long\");\n+            }\n+        }\n@@ -705,0 +713,16 @@\n+\n+    \/**\n+     * Validate that the CEN header size + name length + comment length + extra length\n+     *  do not exceed 65,535 bytes per the PKWare APP.NOTE\n+     *  4.4.10, 4.4.11, & 4.4.12.\n+     * @param name Zip entry name\n+     * @param extra Zip extra data\n+     * @param comment Zip entry comment\n+     * @return true if valid CEN Header size; false otherwise\n+     *\/\n+    private static  boolean isCENHeaderValid(String name, byte[] extra, String comment) {\n+        int clen = comment == null ? 0 : comment.length();\n+        int elen = extra == null ? 0 : extra.length;\n+        int headerSize = CENHDR + name.length() + clen + elen;\n+        return headerSize <= MAX_COMBINED_CEN_HEADER_SIZE ? true : false;\n+    }\n","filename":"src\/java.base\/share\/classes\/java\/util\/zip\/ZipEntry.java","additions":37,"deletions":13,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -265,0 +265,9 @@\n+        \/\/ CEN header size + name length + comment length + extra length\n+        \/\/ should not exceed 65,535 bytes per the PKWare APP.NOTE\n+        \/\/ 4.4.10, 4.4.11, & 4.4.12.\n+        int clen = e.comment == null ? 0 : e.comment.length();\n+        int elen = e.extra == null ? 0 : e.extra.length;\n+        int headerSize = CENHDR + e.name.length() + clen + elen;\n+        if (headerSize > 0xFFFF ) {\n+            throw new ZipException(\"invalid CEN header (bad header size)\");\n+        }\n@@ -605,0 +614,16 @@\n+\n+        int clen = 0;\n+        byte[] commentBytes = null;\n+        if (e.comment != null) {\n+            commentBytes = zc.getBytes(e.comment);\n+            clen = commentBytes.length;\n+        }\n+\n+        \/\/ CEN header size + name length + comment length + extra length\n+        \/\/ should not exceed 65,535 bytes per the PKWare APP.NOTE\n+        \/\/ 4.4.10, 4.4.11, & 4.4.12.\n+        int headerSize = CENHDR + nlen + clen + elen;\n+        if (headerSize > 0xFFFF ) {\n+            throw new ZipException(\"invalid CEN header (bad header size)\");\n+        }\n+\n@@ -636,6 +661,0 @@\n-        byte[] commentBytes = null;\n-        int clen = 0;\n-        if (e.comment != null) {\n-            commentBytes = zc.getBytes(e.comment);\n-            clen = Math.min(commentBytes.length, 0xffff);\n-        }\n@@ -689,7 +708,0 @@\n-        \/\/ CEN header size + name length + comment length + extra length\n-        \/\/ should not exceed 65,535 bytes per the PKWare APP.NOTE\n-        \/\/ 4.4.10, 4.4.11, & 4.4.12.\n-        long headerSize = (long)CENHDR + nlen + clen + elen;\n-        if (headerSize > 0xFFFF ) {\n-            throw new ZipException(\"invalid CEN header (bad header size)\");\n-        }\n","filename":"src\/java.base\/share\/classes\/java\/util\/zip\/ZipOutputStream.java","additions":25,"deletions":13,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -0,0 +1,150 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/* @test\n+ * @bug 8340553\n+ * @summary Verify that ZipEntry(String), ZipEntry::setComment, and\n+ * ZipEntry::setExtra throws a IllegalArgumentException when the\n+ * length of the field exceeds 65,489 bytes\n+ * @run junit MaxZipEntryFieldSizeTest\n+ *\/\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+\n+import java.io.IOException;\n+import java.nio.ByteBuffer;\n+import java.nio.ByteOrder;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipFile;\n+\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+\n+public class MaxZipEntryFieldSizeTest {\n+\n+    \/\/ CEN header size + name length + comment length + extra length\n+    \/\/ should not exceed 65,535 bytes per the PKWare APP.NOTE\n+    \/\/ 4.4.10, 4.4.11, & 4.4.12.\n+    static final int MAX_COMBINED_CEN_HEADER_SIZE = 0xFFFF;\n+    \/\/ Maximum possible size of name length + comment length + extra length\n+    \/\/ for entries in order to not exceed 65,489 bytes\n+    static final int MAX_NAME_COMMENT_EXTRA_SIZE =\n+            MAX_COMBINED_CEN_HEADER_SIZE - ZipFile.CENHDR;\n+    \/\/ Tag for the 'unknown' field type, specified in APPNOTE.txt 'Third party mappings'\n+    static final short UNKNOWN_ZIP_TAG = (short) 0x9902;\n+    \/\/ ZIP file to be used by the tests\n+    static final Path ZIP_FILE = Path.of(\"ZipEntryFieldSize.zip\");\n+    \/\/ Zip Entry name used by tests\n+    static final String ENTRY_NAME = \"EntryName\";\n+    \/\/ Max length minus the size of the ENTRY_NAME or ENTRY_COMMENT\n+    static final int MAX_FIELD_LEN_MINUS_ENTRY_NAME =\n+            MAX_NAME_COMMENT_EXTRA_SIZE - 9;\n+\n+    \/**\n+     * Clean up prior to test run\n+     *\n+     * @throws IOException if an error occurs\n+     *\/\n+    @BeforeEach\n+    public void startUp() throws IOException {\n+        Files.deleteIfExists(ZIP_FILE);\n+    }\n+\n+    \/**\n+     * Validate an IllegalArgumentException is thrown when the comment\n+     * length exceeds 65,489 bytes.\n+     *\/\n+    @ParameterizedTest\n+    @ValueSource(ints = {MAX_COMBINED_CEN_HEADER_SIZE,\n+            MAX_NAME_COMMENT_EXTRA_SIZE,\n+            MAX_NAME_COMMENT_EXTRA_SIZE + 1,\n+            MAX_FIELD_LEN_MINUS_ENTRY_NAME,\n+            MAX_FIELD_LEN_MINUS_ENTRY_NAME - 1})\n+    void setCommentLengthTest(int length) {\n+        final byte[] bytes = new byte[length];\n+        Arrays.fill(bytes, (byte) 'a');\n+        boolean expectException = length > MAX_NAME_COMMENT_EXTRA_SIZE;\n+        ZipEntry zipEntry = new ZipEntry(ENTRY_NAME);\n+        String comment = new String(bytes, StandardCharsets.UTF_8);\n+        System.out.printf(\"Comment Len= %s, exception: %s%n\", comment.length(), expectException);\n+        \/\/ The comment length will trigger the IllegalArgumentException\n+        if (expectException) {\n+            assertThrows(IllegalArgumentException.class, () ->\n+                    zipEntry.setComment(comment));\n+        }\n+    }\n+\n+    \/**\n+     * Validate an IllegalArgumentException is thrown when the name\n+     * length exceeds 65,489 bytes.\n+     *\/\n+    @ParameterizedTest\n+    @ValueSource(ints = {MAX_COMBINED_CEN_HEADER_SIZE,\n+            MAX_NAME_COMMENT_EXTRA_SIZE,\n+            MAX_NAME_COMMENT_EXTRA_SIZE + 1,\n+            MAX_FIELD_LEN_MINUS_ENTRY_NAME,\n+            MAX_FIELD_LEN_MINUS_ENTRY_NAME - 1})\n+    void setNameLengthTest(int length) {\n+        boolean expectException = length > MAX_NAME_COMMENT_EXTRA_SIZE;\n+        final byte[] bytes = new byte[length];\n+        Arrays.fill(bytes, (byte) 'a');\n+        String name = new String(bytes, StandardCharsets.UTF_8);\n+        System.out.printf(\"name Len= %s, exception: %s%n\", name.length(), expectException);\n+        \/\/ The name length will trigger the IllegalArgumentException\n+        if (expectException) {\n+            assertThrows(IllegalArgumentException.class, () -> new ZipEntry(name));\n+        }\n+    }\n+\n+    \/**\n+     * Validate an IllegalArgumentException is thrown when the extra data\n+     * length exceeds 65,489 bytes.\n+     *\/\n+    @ParameterizedTest\n+    @ValueSource(ints = {MAX_COMBINED_CEN_HEADER_SIZE,\n+            MAX_NAME_COMMENT_EXTRA_SIZE,\n+            MAX_NAME_COMMENT_EXTRA_SIZE + 1,\n+            MAX_FIELD_LEN_MINUS_ENTRY_NAME,\n+            MAX_FIELD_LEN_MINUS_ENTRY_NAME - 1})\n+    void setExtraLengthTest(int length) {\n+        final byte[] bytes = new byte[length];\n+        boolean expectException = length > MAX_NAME_COMMENT_EXTRA_SIZE;\n+        \/\/ Little-endian ByteBuffer for updating the header fields\n+        ByteBuffer buffer = ByteBuffer.wrap(bytes).order(ByteOrder.LITTLE_ENDIAN);\n+        \/\/ We use the 'unknown' tag, specified in APPNOTE.TXT, 4.6.1 Third party mappings'\n+        buffer.putShort(UNKNOWN_ZIP_TAG);\n+        \/\/ Size of the actual (empty) data\n+        buffer.putShort((short) (length - 2 * Short.BYTES));\n+        ZipEntry zipEntry = new ZipEntry(ENTRY_NAME);\n+        System.out.printf(\"extra Len= %s, exception: %s%n\", bytes.length, expectException);\n+        \/\/ The extra data length will trigger the IllegalArgumentException\n+        if (expectException) {\n+            assertThrows(IllegalArgumentException.class, () -> zipEntry.setExtra(bytes));\n+        }\n+    }\n+}\n","filename":"test\/jdk\/java\/util\/zip\/ZipEntry\/MaxZipEntryFieldSizeTest.java","additions":150,"deletions":0,"binary":false,"changes":150,"status":"added"},{"patch":"@@ -1,169 +0,0 @@\n-\/*\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-\/* @test\n- * @bug 8336025\n- * @summary Verify that ZipOutputStream throws a ZipException when the\n- * CEN header size + name length + comment length + extra length exceeds\n- * 65,535 bytes\n- * @run junit ZipOutputStreamMaxCenHdrTest\n- *\/\n-import org.junit.jupiter.api.BeforeEach;\n-import org.junit.jupiter.params.ParameterizedTest;\n-import org.junit.jupiter.params.provider.ValueSource;\n-\n-import java.io.*;\n-import java.nio.ByteBuffer;\n-import java.nio.ByteOrder;\n-import java.nio.charset.StandardCharsets;\n-import java.nio.file.Files;\n-import java.nio.file.Path;\n-import java.util.Arrays;\n-import java.util.zip.ZipEntry;\n-import java.util.zip.ZipException;\n-import java.util.zip.ZipFile;\n-import java.util.zip.ZipOutputStream;\n-\n-import static org.junit.jupiter.api.Assertions.*;\n-\n-public class ZipOutputStreamMaxCenHdrTest {\n-\n-    \/\/ CEN header size + name length + comment length + extra length\n-    \/\/ should not exceed 65,535 bytes per the PKWare APP.NOTE\n-    \/\/ 4.4.10, 4.4.11, & 4.4.12.\n-    static final int MAX_COMBINED_CEN_HEADER_SIZE = 0xFFFF;\n-\n-    \/\/ Maximum possible size of name length + comment length + extra length\n-    \/\/ for entries in order to not exceed 65,489 bytes minus 46 bytes for the CEN\n-    \/\/ header length\n-    static final int MAX_NAME_COMMENT_EXTRA_SIZE =\n-            MAX_COMBINED_CEN_HEADER_SIZE - ZipFile.CENHDR;\n-\n-    \/\/ Tag for the 'unknown' field type, specified in APPNOTE.txt 'Third party mappings'\n-    static final short UNKNOWN_ZIP_TAG = (short) 0x9902;\n-\n-    \/\/ ZIP file to be used by the tests\n-    static final Path ZIP_FILE = Path.of(\"maxCENHdrTest.zip\");\n-\n-    \/**\n-     * Clean up prior to test run\n-     *\n-     * @throws IOException if an error occurs\n-     *\/\n-    @BeforeEach\n-    public void startUp() throws IOException {\n-        Files.deleteIfExists(ZIP_FILE);\n-    }\n-\n-    \/**\n-     * Validate a ZipException is thrown when the combined CEN Header, name\n-     * length, comment length, and extra data length exceeds 65,535 bytes when\n-     * the ZipOutputStream is closed.\n-     *\/\n-    @ParameterizedTest\n-    @ValueSource(ints = {MAX_COMBINED_CEN_HEADER_SIZE,\n-            MAX_COMBINED_CEN_HEADER_SIZE - 1,\n-            MAX_NAME_COMMENT_EXTRA_SIZE,\n-            MAX_NAME_COMMENT_EXTRA_SIZE - 1})\n-    void setCommentTest(int length) throws IOException {\n-        boolean expectZipException = length > MAX_NAME_COMMENT_EXTRA_SIZE;\n-        final byte[] bytes = new byte[length];\n-        Arrays.fill(bytes, (byte) 'a');\n-        ZipEntry zipEntry = new ZipEntry(\"\");\n-        \/\/ The comment length will trigger the ZipException\n-        zipEntry.setComment(new String(bytes, StandardCharsets.UTF_8));\n-        boolean receivedException = writeZipEntry(zipEntry, expectZipException);\n-        assertEquals(receivedException, expectZipException);\n-    }\n-\n-    \/**\n-     * Validate an ZipException is thrown when the combined CEN Header, name\n-     * length, comment length, and extra data length exceeds 65,535 bytes when\n-     * the ZipOutputStream is closed.\n-     *\/\n-    @ParameterizedTest\n-    @ValueSource(ints = {MAX_COMBINED_CEN_HEADER_SIZE,\n-            MAX_COMBINED_CEN_HEADER_SIZE - 1,\n-            MAX_NAME_COMMENT_EXTRA_SIZE,\n-            MAX_NAME_COMMENT_EXTRA_SIZE - 1})\n-    void setNameTest(int length) throws IOException {\n-        boolean expectZipException = length > MAX_NAME_COMMENT_EXTRA_SIZE;\n-        final byte[] bytes = new byte[length];\n-        Arrays.fill(bytes, (byte) 'a');\n-        \/\/ The name length will trigger the ZipException\n-        ZipEntry zipEntry = new ZipEntry(new String(bytes, StandardCharsets.UTF_8));\n-        boolean receivedException = writeZipEntry(zipEntry, expectZipException);\n-        assertEquals(receivedException, expectZipException);\n-    }\n-\n-    \/**\n-     * Validate an ZipException is thrown when the combined CEN Header, name\n-     * length, comment length, and extra data length exceeds 65,535 bytes when\n-     * the ZipOutputStream is closed.\n-     *\/\n-    @ParameterizedTest\n-    @ValueSource(ints = {MAX_COMBINED_CEN_HEADER_SIZE,\n-            MAX_COMBINED_CEN_HEADER_SIZE - 1,\n-            MAX_NAME_COMMENT_EXTRA_SIZE,\n-            MAX_NAME_COMMENT_EXTRA_SIZE - 1})\n-    void setExtraTest(int length) throws IOException {\n-        boolean expectZipException = length > MAX_NAME_COMMENT_EXTRA_SIZE;\n-        final byte[] bytes = new byte[length];\n-        \/\/ Little-endian ByteBuffer for updating the header fields\n-        ByteBuffer buffer = ByteBuffer.wrap(bytes).order(ByteOrder.LITTLE_ENDIAN);\n-        \/\/ We use the 'unknown' tag, specified in APPNOTE.TXT, 4.6.1 Third party mappings'\n-        buffer.putShort(UNKNOWN_ZIP_TAG);\n-        \/\/ Size of the actual (empty) data\n-        buffer.putShort((short) (length - 2 * Short.BYTES));\n-        ZipEntry zipEntry = new ZipEntry(\"\");\n-        \/\/ The extra data length will trigger the ZipException\n-        zipEntry.setExtra(bytes);\n-        boolean receivedException = writeZipEntry(zipEntry, expectZipException);\n-        assertEquals(receivedException, expectZipException);\n-    }\n-\n-    \/**\n-     * Write a single Zip entry using ZipOutputStream\n-     * @param zipEntry the ZipEntry to write\n-     * @param expectZipException true if a ZipException is expected, false otherwse\n-     * @return true if a ZipException was thrown\n-     * @throws IOException if an error occurs\n-     *\/\n-    private static boolean writeZipEntry(ZipEntry zipEntry, boolean expectZipException)\n-            throws IOException {\n-        boolean receivedException = false;\n-        try (ZipOutputStream zos = new ZipOutputStream(\n-                new BufferedOutputStream(Files.newOutputStream(ZIP_FILE)))) {\n-            zos.putNextEntry(zipEntry);\n-            if (expectZipException) {\n-                ZipException ex = assertThrows(ZipException.class, zos::close);\n-                assertTrue(ex.getMessage().matches(\".*bad header size.*\"),\n-                        \"Unexpected ZipException message: \" + ex.getMessage());\n-                receivedException = true;\n-            }\n-        } catch (Exception e) {\n-            throw new RuntimeException(\"Received Unexpected Exception\", e);\n-        }\n-        return receivedException;\n-    }\n-}\n","filename":"test\/jdk\/java\/util\/zip\/ZipOutputStream\/ZipOutputStreamMaxCenHdrTest.java","additions":0,"deletions":169,"binary":false,"changes":169,"status":"deleted"}]}