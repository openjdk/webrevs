{"files":[{"patch":"@@ -1736,1 +1736,1 @@\n-bool os::remove_stack_guard_pages(char* addr, size_t size) {\n+bool os::remove_stack_guard_pages(char* addr, size_t size, const char* err_msg) {\n","filename":"src\/hotspot\/os\/aix\/os_aix.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1766,2 +1766,2 @@\n-bool os::remove_stack_guard_pages(char* addr, size_t size) {\n-  return os::uncommit_memory(addr, size);\n+bool os::remove_stack_guard_pages(char* addr, size_t size, const char* err_msg) {\n+  return os::uncommit_memory(addr, size, false, err_msg);\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -3566,1 +3566,1 @@\n-bool os::remove_stack_guard_pages(char* addr, size_t size) {\n+bool os::remove_stack_guard_pages(char* addr, size_t size, const char* err_msg) {\n@@ -3572,2 +3572,1 @@\n-\n-  return os::uncommit_memory(addr, size);\n+  return os::uncommit_memory(addr, size, false, err_msg);\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -3660,2 +3660,2 @@\n-bool os::remove_stack_guard_pages(char* addr, size_t size) {\n-  return os::uncommit_memory(addr, size);\n+bool os::remove_stack_guard_pages(char* addr, size_t size, const char* err_msg) {\n+  return os::uncommit_memory(addr, size, false, err_msg);\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1328,3 +1328,3 @@\n-    if (!os::unmap_memory(mapped_base, r->used_aligned())) {\n-      fatal(\"os::unmap_memory of region %d failed\", region_index);\n-    }\n+    char err_msg[] = \"os::unmap_memory of region 2147483647 failed\";\n+    os::snprintf_checked(err_msg, sizeof(err_msg), \"os::unmap_memory of region %d failed\", region_index);\n+    os::unmap_memory(mapped_base, r->used_aligned(), err_msg);\n@@ -1657,3 +1657,1 @@\n-        if (!os::unmap_memory(mapped_base, size)) {\n-          fatal(\"os::unmap_memory failed\");\n-        }\n+        os::unmap_memory(mapped_base, size);\n","filename":"src\/hotspot\/share\/cds\/filemap.cpp","additions":4,"deletions":6,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -172,3 +172,1 @@\n-    bool res = os::uncommit_memory((char*)delta.start(),\n-                                   delta.byte_size());\n-    assert(res, \"uncommit should succeed\");\n+    os::uncommit_memory((char*)delta.start(), delta.byte_size());\n","filename":"src\/hotspot\/share\/gc\/shared\/cardTable.cpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1771,6 +1771,1 @@\n-    bool success = os::uncommit_memory((char*)_aux_bitmap_region.start(), _aux_bitmap_region.byte_size());\n-    if (!success) {\n-      log_warning(gc)(\"Auxiliary marking bitmap uncommit failed: \" PTR_FORMAT \" (%zu bytes)\",\n-                      p2i(_aux_bitmap_region.start()), _aux_bitmap_region.byte_size());\n-      assert(false, \"Auxiliary marking bitmap uncommit should always succeed\");\n-    }\n+    os::uncommit_memory((char*)_aux_bitmap_region.start(), _aux_bitmap_region.byte_size(), false, \"Auxiliary marking bitmap uncommit failed\");\n@@ -2626,5 +2621,1 @@\n-  bool success = os::uncommit_memory(addr, len);\n-  if (!success) {\n-    log_warning(gc)(\"Bitmap slice uncommit failed: \" PTR_FORMAT \" (%zu bytes)\", p2i(addr), len);\n-    assert(false, \"Bitmap slice uncommit should always succeed\");\n-  }\n+  os::uncommit_memory(addr, len, false, \"Bitmap slice uncommit failed\");\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.cpp","additions":2,"deletions":11,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -814,5 +814,1 @@\n-    bool success = os::uncommit_memory((char *) bottom(), RegionSizeBytes);\n-    if (!success) {\n-      log_warning(gc)(\"Region uncommit failed: \" PTR_FORMAT \" (%zu bytes)\", p2i(bottom()), RegionSizeBytes);\n-      assert(false, \"Region uncommit should always succeed\");\n-    }\n+    os::uncommit_memory((char *) bottom(), RegionSizeBytes, false, \"Region uncommit failed\");\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.cpp","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -90,2 +90,1 @@\n-  bool result = os::release_memory((char*)addr, size_for(length));\n-  assert(result, \"Failed to release memory\");\n+  os::release_memory((char*)addr, size_for(length));\n","filename":"src\/hotspot\/share\/memory\/allocation.inline.hpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -102,3 +102,1 @@\n-  if (!os::release_memory(base, size)) {\n-    fatal(\"os::release_memory failed\");\n-  }\n+  os::release_memory(base, size);\n@@ -269,3 +267,1 @@\n-  if (!os::unmap_memory(base, size)) {\n-    fatal(\"os::unmap_memory failed\");\n-  }\n+  os::unmap_memory(base, size);\n","filename":"src\/hotspot\/share\/memory\/memoryReserver.cpp","additions":2,"deletions":6,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -193,4 +193,2 @@\n-  if (os::uncommit_memory((char*)p, word_size * BytesPerWord) == false) {\n-    \/\/ Note: this can actually happen, since uncommit may increase the number of mappings.\n-    fatal(\"Failed to uncommit metaspace.\");\n-  }\n+  os::uncommit_memory((char*)p, word_size * BytesPerWord, false, \"Failed to uncommit metaspace.\");\n+\n","filename":"src\/hotspot\/share\/memory\/metaspace\/virtualSpaceNode.cpp","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -373,6 +373,2 @@\n-    if (!os::uncommit_memory(aligned_upper_new_high, upper_needs, _executable)) {\n-      DEBUG_ONLY(warning(\"os::uncommit_memory failed\"));\n-      return;\n-    } else {\n-      _upper_high -= upper_needs;\n-    }\n+    os::uncommit_memory(aligned_upper_new_high, upper_needs, _executable);\n+    _upper_high -= upper_needs;\n@@ -384,6 +380,2 @@\n-    if (!os::uncommit_memory(aligned_middle_new_high, middle_needs, _executable)) {\n-      DEBUG_ONLY(warning(\"os::uncommit_memory failed\"));\n-      return;\n-    } else {\n-      _middle_high -= middle_needs;\n-    }\n+    os::uncommit_memory(aligned_middle_new_high, middle_needs, _executable);\n+    _middle_high -= middle_needs;\n@@ -395,6 +387,2 @@\n-    if (!os::uncommit_memory(aligned_lower_new_high, lower_needs, _executable)) {\n-      DEBUG_ONLY(warning(\"os::uncommit_memory failed\"));\n-      return;\n-    } else {\n-      _lower_high -= lower_needs;\n-    }\n+    os::uncommit_memory(aligned_lower_new_high, lower_needs, _executable);\n+    _lower_high -= lower_needs;\n","filename":"src\/hotspot\/share\/memory\/virtualspace.cpp","additions":6,"deletions":18,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -2260,0 +2260,9 @@\n+\/\/ Helper for os::uncommit_memory and os::unmap_memory\n+static void print_err_fatal(char* addr, size_t bytes, const char* err_msg1, const char* err_msg2) {\n+  const char* s = \": \";\n+  if (err_msg1 == nullptr) {\n+    err_msg1 = \"\";\n+    s =  \"\";\n+  }\n+  fatal(\"%s%s%s\" RANGEFMT, err_msg1, s, err_msg2, RANGEFMTARGS(addr, bytes));\n+}\n@@ -2266,1 +2275,1 @@\n-bool os::uncommit_memory(char* addr, size_t bytes, bool executable) {\n+bool os::uncommit_memory(char* addr, size_t bytes, bool executable, const char* err_msg) {\n@@ -2279,4 +2288,2 @@\n-  if (res) {\n-    log_debug(os, map)(\"Uncommitted \" RANGEFMT, RANGEFMTARGS(addr, bytes));\n-  } else {\n-    log_info(os, map)(\"Failed to uncommit \" RANGEFMT, RANGEFMTARGS(addr, bytes));\n+  if (!res) {\n+    print_err_fatal(addr, bytes, err_msg, \"Failed to uncommit \");\n@@ -2284,0 +2291,1 @@\n+  log_debug(os, map)(\"Uncommitted \" RANGEFMT, RANGEFMTARGS(addr, bytes));\n@@ -2285,1 +2293,1 @@\n-  return res;\n+  return true;\n@@ -2306,3 +2314,1 @@\n-    log_info(os, map)(\"Failed to release \" RANGEFMT, RANGEFMTARGS(addr, bytes));\n-  } else {\n-    log_debug(os, map)(\"Released \" RANGEFMT, RANGEFMTARGS(addr, bytes));\n+    fatal(\"Failed to release \" RANGEFMT, RANGEFMTARGS(addr, bytes));\n@@ -2310,1 +2316,3 @@\n-  return res;\n+  log_debug(os, map)(\"Released \" RANGEFMT, RANGEFMTARGS(addr, bytes));\n+\n+  return true;\n@@ -2379,1 +2387,1 @@\n-bool os::unmap_memory(char *addr, size_t bytes) {\n+bool os::unmap_memory(char *addr, size_t bytes, const char* err_msg) {\n@@ -2390,1 +2398,4 @@\n-  return result;\n+  if (!result) {\n+    print_err_fatal(addr, bytes, err_msg, \"Failed to unmap memory \");\n+  }\n+  return true;\n@@ -2429,1 +2440,4 @@\n-  return res;\n+  if (!res) {\n+    fatal(\"Failed to release memory special \" RANGEFMT, RANGEFMTARGS(addr, bytes));\n+  }\n+  return true;\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":27,"deletions":13,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -488,1 +488,1 @@\n-  static bool   uncommit_memory(char* addr, size_t bytes, bool executable = false);\n+  static bool   uncommit_memory(char* addr, size_t bytes, bool executable = false, const char* err_msg = nullptr);\n@@ -518,1 +518,1 @@\n-  static bool   remove_stack_guard_pages(char* addr, size_t bytes);\n+  static bool   remove_stack_guard_pages(char* addr, size_t bytes, const char* err_msg = nullptr);\n@@ -534,1 +534,1 @@\n-  static bool   unmap_memory(char *addr, size_t bytes);\n+  static bool   unmap_memory(char *addr, size_t bytes, const char* err_msg = nullptr);\n","filename":"src\/hotspot\/share\/runtime\/os.hpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -119,1 +119,1 @@\n-    if (os::remove_stack_guard_pages((char *) low_addr, len)) {\n+    if (os::remove_stack_guard_pages((char *) low_addr, len, \"Attempt to deallocate stack guard pages failed\")) {\n","filename":"src\/hotspot\/share\/runtime\/stackOverflow.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -160,1 +160,1 @@\n-                        \"Failed to uncommit \\\\[0x.* - 0x.*\\\\), \\\\(.* bytes\\\\)\",\n+                        \"fatal error: Failed to uncommit \\\\[0x.* - 0x.*\\\\), \\\\(.* bytes\\\\).*\",\n","filename":"test\/hotspot\/jtreg\/runtime\/os\/TestMemoryAllocationLogging.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}