{"files":[{"patch":"@@ -310,3 +310,7 @@\n-    HeapWord* result = mem_allocate_cas_noexpand(size, is_tlab);\n-    if (result != nullptr) {\n-      return result;\n+    HeapWord* result;\n+    {\n+      ConditionalMutexLocker locker(Heap_lock, !is_init_completed());\n+      result = mem_allocate_cas_noexpand(size, is_tlab);\n+      if (result != nullptr) {\n+        return result;\n+      }\n@@ -329,4 +333,9 @@\n-        \/\/ Can't do GC; try heap expansion to satisfy the request.\n-        result = expand_heap_and_allocate(size, is_tlab);\n-        if (result != nullptr) {\n-          return result;\n+        \/\/ Double checked locking, this ensure that is_init_completed() does not\n+        \/\/ transition while expanding the heap.\n+        MonitorLocker ml(InitCompleted_lock, Monitor::_no_safepoint_check_flag);\n+        if (!is_init_completed()) {\n+          \/\/ Can't do GC; try heap expansion to satisfy the request.\n+          result = expand_heap_and_allocate(size, is_tlab);\n+          if (result != nullptr) {\n+            return result;\n+          }\n","filename":"src\/hotspot\/share\/gc\/parallel\/parallelScavengeHeap.cpp","additions":16,"deletions":7,"binary":false,"changes":23,"status":"modified"}]}