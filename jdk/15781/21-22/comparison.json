{"files":[{"patch":"@@ -95,1 +95,3 @@\n-\n+  product(bool, UseMadvPopulateWrite, true, DIAGNOSTIC,                 \\\n+          \"Use MADV_POPULATE_WRITE in os::pd_pretouch_memory.\")         \\\n+                                                                        \\\n","filename":"src\/hotspot\/os\/linux\/globals_linux.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2959,12 +2959,14 @@\n-    if (::madvise(first, len, MADV_POPULATE_WRITE) == -1) {\n-      int err = errno;\n-      if (err == EINVAL) { \/\/ Not supported\n-        \/\/ When using THP we need to always pre-touch using small pages as the\n-        \/\/ OS will initially always use small pages.\n-        pretouch_memory_common(first, last, os::vm_page_size());\n-      } else {\n-        log_warning(gc, os)(\"::madvise(\" PTR_FORMAT \", \" SIZE_FORMAT\n-                            \", %d) failed; error='%s' (errno=%d)\",\n-                            p2i(first), len, MADV_POPULATE_WRITE,\n-                            os::strerror(err), err);\n-      }\n+    int err = 0;\n+    if (UseMadvPopulateWrite &&\n+\t::madvise(first, len, MADV_POPULATE_WRITE) == -1) {\n+      err = errno;\n+    }\n+    if (err == 0 || err == EINVAL) { \/\/ Not to use or not supported\n+      \/\/ When using THP we need to always pre-touch using small pages as the\n+      \/\/ OS will initially always use small pages.\n+      pretouch_memory_common(first, last, os::vm_page_size());\n+    } else {\n+      log_warning(gc, os)(\"::madvise(\" PTR_FORMAT \", \" SIZE_FORMAT\n+\t\t\t  \", %d) failed; error='%s' (errno=%d)\",\n+\t\t\t  p2i(first), len, MADV_POPULATE_WRITE,\n+\t\t\t  os::strerror(err), err);\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":14,"deletions":12,"binary":false,"changes":26,"status":"modified"}]}