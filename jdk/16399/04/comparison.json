{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2012, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -304,1 +304,1 @@\n-        MIDIHDR* hdr = &(sysex->header[i]);\n+        MIDIHDR* hdr = &(sysex->headerInfo[i].header);\n@@ -323,1 +323,1 @@\n-        err = midiInUnprepareHeader((HMIDIIN) handle->deviceHandle, &(sysex->header[i]), sizeof(MIDIHDR));\n+        err = midiInUnprepareHeader((HMIDIIN) handle->deviceHandle, &(sysex->headerInfo[i].header), sizeof(MIDIHDR));\n@@ -505,1 +505,1 @@\n-        MIDIHDR* hdr = &(sysex->header[msg->data.l.index]);\n+        MIDIHDR* hdr = &(sysex->headerInfo[msg->data.l.index].header);\n","filename":"src\/java.desktop\/windows\/native\/libjsound\/PLATFORM_API_WinOS_MidiIn.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2012, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -164,1 +164,1 @@\n-        MIDIHDR* hdr = &(sysex->header[i]);\n+        MIDIHDR* hdr = &(sysex->headerInfo[i].header);\n@@ -173,1 +173,1 @@\n-INT32 freeLongBuffer(MIDIHDR* hdr, HMIDIOUT deviceHandle, INT32 minToLeaveData) {\n+INT32 freeLongBuffer(MidiHeaderInfo* info, HMIDIOUT deviceHandle, INT32 minToLeaveData) {\n@@ -175,0 +175,1 @@\n+    MIDIHDR* hdr = &(info->header);\n@@ -183,1 +184,1 @@\n-    if (hdr->lpData && (((INT32) hdr->dwBufferLength) < minToLeaveData || minToLeaveData < 0)) {\n+    if (hdr->lpData && (info->bufferLength < minToLeaveData || minToLeaveData < 0)) {\n@@ -187,0 +188,1 @@\n+        info->bufferLength=0;\n@@ -204,1 +206,1 @@\n-        err = freeLongBuffer(&(sysex->header[i]), (HMIDIOUT) handle->deviceHandle, -1);\n+        err = freeLongBuffer(&(sysex->headerInfo[i]), (HMIDIOUT) handle->deviceHandle, -1);\n@@ -355,0 +357,1 @@\n+    MidiHeaderInfo* info = NULL;\n@@ -381,1 +384,2 @@\n-                hdr = &(sysex->header[i]);\n+                info = &(sysex->headerInfo[i]);\n+                hdr = &(info->header);\n@@ -385,0 +389,1 @@\n+                info = NULL;\n@@ -407,1 +412,1 @@\n-        freeLongBuffer(hdr, handle->deviceHandle, (INT32) size);\n+        freeLongBuffer(info, handle->deviceHandle, (INT32) size);\n@@ -410,1 +415,1 @@\n-            hdr->dwBufferLength = size;\n+            info->bufferLength = size;\n@@ -412,0 +417,4 @@\n+        \/\/ Because midiOutLongMsg() ignores dwBytesRecorded, set both\n+        \/\/ dwBufferLength to the size of the data. The actual buffer\n+        \/\/ size is recorded in info->bufferLength.\n+        hdr->dwBufferLength = size;\n@@ -416,1 +425,1 @@\n-            freeLongBuffer(hdr, handle->deviceHandle, -1);\n+            freeLongBuffer(info, handle->deviceHandle, -1);\n@@ -422,1 +431,1 @@\n-            freeLongBuffer(hdr, handle->deviceHandle, -1);\n+            freeLongBuffer(info, handle->deviceHandle, -1);\n","filename":"src\/java.desktop\/windows\/native\/libjsound\/PLATFORM_API_WinOS_MidiOut.c","additions":19,"deletions":10,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, 2007, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -92,1 +92,1 @@\n-    int structSize = sizeof(SysExQueue) + ((count - 1) * sizeof(MIDIHDR));\n+    int structSize = sizeof(SysExQueue) + ((count - 1) * sizeof(MidiHeaderInfo));\n@@ -115,2 +115,3 @@\n-        sysex->header[i].lpData = dataPtr;\n-        sysex->header[i].dwBufferLength = size;\n+        sysex->headerInfo[i].header.lpData = dataPtr;\n+        sysex->headerInfo[i].header.dwBufferLength = size;\n+        sysex->headerInfo[i].bufferLength = size;\n@@ -118,1 +119,1 @@\n-        sysex->header[i].dwUser = (DWORD) i;\n+        sysex->headerInfo[i].header.dwUser = (DWORD) i;\n","filename":"src\/java.desktop\/windows\/native\/libjsound\/PLATFORM_API_WinOS_Util.c","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, 2007, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2023, Oracle and\/or its affiliates. All rights reserved.\n@@ -49,0 +49,5 @@\n+typedef struct tag_MidiHeaderInfo {\n+    MIDIHDR header;     \/\/ Windows specific structure to hold meta info\n+    INT32 bufferLength; \/\/ the actual length of the buffer in MIDIHDR\n+} MidiHeaderInfo;\n+\n@@ -50,5 +55,5 @@\n-    int count;         \/\/ number of sys ex headers\n-    int size;          \/\/ data size per sys ex header\n-    int ownsLinearMem; \/\/ true when linearMem is to be disposed\n-    UBYTE* linearMem;  \/\/ where the actual sys ex data is, count*size bytes\n-    MIDIHDR header[1]; \/\/ Windows specific structure to hold meta info\n+    int count;                    \/\/ number of sys ex headers\n+    int size;                     \/\/ data size per sys ex header\n+    int ownsLinearMem;            \/\/ true when linearMem is to be disposed\n+    UBYTE* linearMem;             \/\/ where the actual sys ex data is, count*size bytes\n+    MidiHeaderInfo headerInfo[1]; \/\/ a structure to hold MIDIHDR and the actual buffer length\n","filename":"src\/java.desktop\/windows\/native\/libjsound\/PLATFORM_API_WinOS_Util.h","additions":11,"deletions":6,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -37,1 +37,1 @@\n- * @bug 8237495 8301310\n+ * @bug 8074211 8237495 8301310\n@@ -117,0 +117,5 @@\n+                \/\/ The three parts of the sysex below are added for\n+                \/\/ JDK-8301310, but it can also used to test JDK-8074211.\n+                \/\/ However, The testcase does not fail when JDK-8074211 occurs.\n+                \/\/ It's recommended to setup a loopback MIDI device then check\n+                \/\/ whether the sysex received is the same as the testcase.\n","filename":"test\/jdk\/javax\/sound\/midi\/SysexMessage\/SendRawSysexMessage.java","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"}]}