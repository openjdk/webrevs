{"files":[{"patch":"@@ -80,0 +80,1 @@\n+  _monitoring_support->mark_ready();\n@@ -104,1 +105,1 @@\n-HeapWord* EpsilonHeap::allocate_work(size_t size, bool verbose) {\n+HeapWord* EpsilonHeap::allocate_work(size_t size) {\n@@ -154,4 +155,8 @@\n-  \/\/ Allocation successful, update counters\n-  if (verbose) {\n-    size_t last = _last_counter_update;\n-    if ((used - last >= _step_counter_update) && AtomicAccess::cmpxchg(&_last_counter_update, last, used) == last) {\n+  \/\/ Allocation successful, update counters and print status.\n+  \/\/ At this point, some diagnostic subsystems might not yet be initialized.\n+  \/\/ We pretend the printout happened either way. This keeps allocation path\n+  \/\/ from obsessively checking the subsystems' status on every allocation.\n+  size_t last_counter = AtomicAccess::load(&_last_counter_update);\n+  if ((used - last_counter >= _step_counter_update) &&\n+      AtomicAccess::cmpxchg(&_last_counter_update, last_counter, used) == last_counter) {\n+    if (_monitoring_support->is_ready()) {\n@@ -162,5 +167,5 @@\n-  \/\/ ...and print the occupancy line, if needed\n-  if (verbose) {\n-    size_t last = _last_heap_print;\n-    if ((used - last >= _step_heap_print) && AtomicAccess::cmpxchg(&_last_heap_print, last, used) == last) {\n-      print_heap_info(used);\n+  size_t last_heap = AtomicAccess::load(&_last_heap_print);\n+  if ((used - last_heap >= _step_heap_print) &&\n+      AtomicAccess::cmpxchg(&_last_heap_print, last_heap, used) == last_heap) {\n+    print_heap_info(used);\n+    if (Metaspace::initialized()) {\n@@ -268,2 +273,1 @@\n-  \/\/ Cannot use verbose=true because Metaspace is not initialized\n-  return allocate_work(size, \/* verbose = *\/false);\n+  return allocate_work(size);\n","filename":"src\/hotspot\/share\/gc\/epsilon\/epsilonHeap.cpp","additions":16,"deletions":12,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -86,1 +86,1 @@\n-  HeapWord* allocate_work(size_t size, bool verbose = true);\n+  HeapWord* allocate_work(size_t size);\n","filename":"src\/hotspot\/share\/gc\/epsilon\/epsilonHeap.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -99,0 +99,1 @@\n+  _ready = false;\n@@ -102,0 +103,1 @@\n+  assert(is_ready(), \"Must be ready\");\n@@ -113,0 +115,8 @@\n+\n+bool EpsilonMonitoringSupport::is_ready() {\n+  return AtomicAccess::load_acquire(&_ready);\n+}\n+\n+void EpsilonMonitoringSupport::mark_ready() {\n+  return AtomicAccess::release_store(&_ready, true);\n+}\n","filename":"src\/hotspot\/share\/gc\/epsilon\/epsilonMonitoringSupport.cpp","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+  volatile bool _ready;\n@@ -41,0 +42,2 @@\n+  bool is_ready();\n+  void mark_ready();\n","filename":"src\/hotspot\/share\/gc\/epsilon\/epsilonMonitoringSupport.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,76 @@\n+\/*\n+ * Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package gc.epsilon;\n+\n+\/**\n+ * @test TestInitAllocs\n+ * @requires vm.gc.Epsilon\n+ * @summary Test that allocation path taken in early JVM phases works\n+ *\n+ * @run main\/othervm -Xmx256m\n+ *                   -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC\n+ *                   gc.epsilon.TestInitAllocs\n+ *\n+ * @run main\/othervm -Xmx256m\n+ *                   -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC\n+ *                   -XX:+UseTLAB\n+ *                   -XX:+UseCompressedOops\n+ *                   -XX:EpsilonMinHeapExpand=1024\n+ *                   -XX:EpsilonUpdateCountersStep=1\n+ *                   -XX:EpsilonPrintHeapSteps=1000000\n+ *                   gc.epsilon.TestInitAllocs\n+ *\n+ * @run main\/othervm -Xmx256m\n+ *                   -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC\n+ *                   -XX:+UseTLAB\n+ *                   -XX:-UseCompressedOops\n+ *                   -XX:EpsilonMinHeapExpand=1024\n+ *                   -XX:EpsilonUpdateCountersStep=1\n+ *                   -XX:EpsilonPrintHeapSteps=1000000\n+ *                   gc.epsilon.TestInitAllocs\n+ *\n+ * @run main\/othervm -Xmx256m\n+ *                   -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC\n+ *                   -XX:-UseTLAB\n+ *                   -XX:+UseCompressedOops\n+ *                   -XX:EpsilonMinHeapExpand=1024\n+ *                   -XX:EpsilonUpdateCountersStep=1\n+ *                   -XX:EpsilonPrintHeapSteps=1000000\n+ *                   gc.epsilon.TestInitAllocs\n+ *\n+ * @run main\/othervm -Xmx256m\n+ *                   -XX:+UnlockExperimentalVMOptions -XX:+UseEpsilonGC\n+ *                   -XX:-UseTLAB\n+ *                   -XX:-UseCompressedOops\n+ *                   -XX:EpsilonMinHeapExpand=1024\n+ *                   -XX:EpsilonUpdateCountersStep=1\n+ *                   -XX:EpsilonPrintHeapSteps=1000000\n+ *                   gc.epsilon.TestInitAllocs\n+ *\/\n+\n+public class TestInitAllocs {\n+  public static void main(String[] args) throws Exception {\n+    System.out.println(\"Hello World\");\n+  }\n+}\n","filename":"test\/hotspot\/jtreg\/gc\/epsilon\/TestInitAllocs.java","additions":76,"deletions":0,"binary":false,"changes":76,"status":"added"}]}