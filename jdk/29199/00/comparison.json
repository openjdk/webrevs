{"files":[{"patch":"@@ -150,2 +150,0 @@\n-        Log.verbose(I18N.format(\"message.outputting-to-location\", debFile.toAbsolutePath()));\n-\n@@ -162,2 +160,0 @@\n-\n-        Log.verbose(I18N.format(\"message.output-to-location\", debFile.toAbsolutePath()));\n","filename":"src\/jdk.jpackage\/linux\/classes\/jdk\/jpackage\/internal\/LinuxDebPackager.java","additions":0,"deletions":4,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -136,2 +136,0 @@\n-        Log.verbose(I18N.format(\"message.outputting-bundle-location\", rpmFile.getParent()));\n-\n@@ -150,2 +148,0 @@\n-\n-        Log.verbose(I18N.format(\"message.output-bundle-location\", rpmFile.getParent()));\n","filename":"src\/jdk.jpackage\/linux\/classes\/jdk\/jpackage\/internal\/LinuxRpmPackager.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-# Copyright (c) 2017, 2025, Oracle and\/or its affiliates. All rights reserved.\n+# Copyright (c) 2017, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -52,2 +52,0 @@\n-message.outputting-to-location=Generating DEB for installer to: {0}.\n-message.output-to-location=Package (.deb) saved to: {0}.\n@@ -55,2 +53,0 @@\n-message.outputting-bundle-location=Generating RPM for installer to: {0}.\n-message.output-bundle-location=Package (.rpm) saved to: {0}.\n","filename":"src\/jdk.jpackage\/linux\/classes\/jdk\/jpackage\/internal\/resources\/LinuxResources.properties","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -57,1 +57,0 @@\n-                    Log.verbose(I18N.format(\"message.building-dmg\", pkg.app().name()));\n@@ -67,4 +66,1 @@\n-                (env, pkg, outputDir) -> {\n-                    Log.verbose(I18N.format(\"message.building-pkg\", pkg.app().name()));\n-                    return new MacPkgPackager(env, pkg, outputDir);\n-                });\n+                MacPkgPackager::new);\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/MacBundlingEnvironment.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -238,11 +238,0 @@\n-        Log.verbose(MessageFormat.format(I18N.getString(\n-                \"message.creating-dmg-file\"), finalDMG.toAbsolutePath()));\n-\n-        try {\n-            Files.deleteIfExists(finalDMG);\n-        } catch (IOException ex) {\n-            throw new IOException(MessageFormat.format(I18N.getString(\n-                    \"message.dmg-cannot-be-overwritten\"),\n-                    finalDMG.toAbsolutePath()));\n-        }\n-\n@@ -386,5 +375,0 @@\n-\n-        Log.verbose(MessageFormat.format(I18N.getString(\n-                \"message.output-to-location\"),\n-                pkg.app().name(), normalizedAbsolutePathString(finalDMG)));\n-\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/MacDmgPackager.java","additions":0,"deletions":16,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -220,0 +220,5 @@\n+\n+        @Override\n+        public String label() {\n+            throw new UnsupportedOperationException();\n+        }\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/MacPackagingPipeline.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -60,1 +60,0 @@\n-message.building-dmg=Building DMG package for {0}.\n@@ -62,4 +61,0 @@\n-message.creating-dmg-file=Creating DMG file: {0}.\n-message.dmg-cannot-be-overwritten=Dmg file exists [{0}] and can not be removed.\n-message.output-to-location=Result DMG installer for {0}: {1}.\n-message.building-pkg=Building PKG package for {0}.\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/resources\/MacResources.properties","additions":0,"deletions":5,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -45,1 +45,1 @@\n-import jdk.internal.util.OperatingSystem;\n+import jdk.jpackage.internal.PackagingPipeline.PackageTaskID;\n@@ -49,1 +49,0 @@\n-import jdk.jpackage.internal.model.AppImagePackageType;\n@@ -54,2 +53,1 @@\n-import jdk.jpackage.internal.model.PackageType;\n-import jdk.jpackage.internal.model.StandardPackageType;\n+import jdk.jpackage.internal.util.PathUtils;\n@@ -137,1 +135,3 @@\n-        final var outputDir = OptionUtils.outputDir(options).resolve(app.appImageDirName());\n+        final var outputDir = PathUtils.normalizedAbsolutePath(OptionUtils.outputDir(options).resolve(app.appImageDirName()));\n+\n+        Log.verbose(I18N.getString(\"message.create-app-image\"));\n@@ -145,2 +145,0 @@\n-        Log.verbose(I18N.format(\"message.creating-app-bundle\", outputDir.getFileName(), outputDir.toAbsolutePath().getParent()));\n-\n@@ -148,1 +146,1 @@\n-            throw new JPackageException(I18N.format(\"error.root-exists\", outputDir.toAbsolutePath()));\n+            throw new JPackageException(I18N.format(\"error.root-exists\", outputDir));\n@@ -153,0 +151,2 @@\n+\n+        Log.verbose(I18N.getString(\"message.app-image-created\"));\n@@ -177,0 +177,9 @@\n+        var pipelineBuilder = Objects.requireNonNull(createPipelineBuilder.apply(pkg));\n+\n+        \/\/ Delete an old output package file (if any) before creating a new one.\n+        pipelineBuilder.task(PackageTaskID.DELETE_OLD_PACKAGE_FILE)\n+                .addDependencies(pipelineBuilder.taskGraphSnapshot().getTailsOf(PackageTaskID.CREATE_PACKAGE_FILE))\n+                .addDependent(PackageTaskID.CREATE_PACKAGE_FILE)\n+                .packageAction(PackagingPipeline::deleteOutputBundle)\n+                .add();\n+\n@@ -178,4 +187,4 @@\n-            .outputDir(OptionUtils.outputDir(options))\n-            .env(Objects.requireNonNull(createBuildEnv.apply(options, pkg)))\n-            .pipelineBuilderMutatorFactory(pipelineBuilderMutatorFactory)\n-            .execute(Objects.requireNonNull(createPipelineBuilder.apply(pkg)));\n+                .outputDir(OptionUtils.outputDir(options))\n+                .env(Objects.requireNonNull(createBuildEnv.apply(options, pkg)))\n+                .pipelineBuilderMutatorFactory(pipelineBuilderMutatorFactory)\n+                .execute(pipelineBuilder);\n@@ -198,4 +207,0 @@\n-\n-            var packageType = OptionUtils.bundlingOperation(cmdline).packageType();\n-\n-            Log.verbose(I18N.format(\"message.bundle-created\", I18N.getString(bundleTypeDescription(packageType, op.os()))));\n@@ -222,49 +227,0 @@\n-    private String bundleTypeDescription(PackageType type, OperatingSystem os) {\n-        switch (type) {\n-            case StandardPackageType stdType -> {\n-                switch (stdType) {\n-                    case WIN_MSI -> {\n-                        return \"bundle-type.win-msi\";\n-                    }\n-                    case WIN_EXE -> {\n-                        return \"bundle-type.win-exe\";\n-                    }\n-                    case LINUX_DEB -> {\n-                        return \"bundle-type.linux-deb\";\n-                    }\n-                    case LINUX_RPM -> {\n-                        return \"bundle-type.linux-rpm\";\n-                    }\n-                    case MAC_DMG -> {\n-                        return \"bundle-type.mac-dmg\";\n-                    }\n-                    case MAC_PKG -> {\n-                        return \"bundle-type.mac-pkg\";\n-                    }\n-                    default -> {\n-                        throw new AssertionError();\n-                    }\n-                }\n-            }\n-            case AppImagePackageType appImageType -> {\n-                switch (os) {\n-                    case WINDOWS -> {\n-                        return \"bundle-type.win-app\";\n-                    }\n-                    case LINUX -> {\n-                        return \"bundle-type.linux-app\";\n-                    }\n-                    case MACOS -> {\n-                        return \"bundle-type.mac-app\";\n-                    }\n-                    default -> {\n-                        throw new AssertionError();\n-                    }\n-                }\n-            }\n-            default -> {\n-                throw new AssertionError();\n-            }\n-        }\n-    }\n-\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/DefaultBundlingEnvironment.java","additions":21,"deletions":65,"binary":false,"changes":86,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,0 +32,1 @@\n+import java.nio.file.Files;\n@@ -42,0 +43,2 @@\n+import java.util.function.BiConsumer;\n+import java.util.function.Function;\n@@ -43,0 +46,1 @@\n+import java.util.function.Supplier;\n@@ -48,0 +52,1 @@\n+import jdk.jpackage.internal.model.JPackageException;\n@@ -100,1 +105,1 @@\n-    interface StartupParameters {\n+    sealed interface StartupParameters {\n@@ -130,0 +135,1 @@\n+        DELETE_OLD_PACKAGE_FILE,\n@@ -186,1 +192,1 @@\n-    record TaskConfig(Optional<TaskAction> action) {\n+    record TaskConfig(Optional<TaskAction> action, Optional<TaskAction> beforeAction, Optional<TaskAction> afterAction) {\n@@ -189,0 +195,2 @@\n+            Objects.requireNonNull(beforeAction);\n+            Objects.requireNonNull(afterAction);\n@@ -199,14 +207,0 @@\n-            private TaskBuilder(TaskID id) {\n-                super(id);\n-            }\n-\n-            private TaskBuilder(TaskID id, TaskConfig config) {\n-                this(id);\n-                config.action().ifPresent(this::setAction);\n-            }\n-\n-            private TaskBuilder setAction(TaskAction v) {\n-                action = v;\n-                return this;\n-            }\n-\n@@ -214,2 +208,1 @@\n-                action = null;\n-                return this;\n+                return setAction(ActionRole.WORKLOAD, null);\n@@ -219,1 +212,1 @@\n-                return setAction(action);\n+                return applicationAction(ActionRole.WORKLOAD, action);\n@@ -223,1 +216,1 @@\n-                return setAction(action);\n+                return appImageAction(ActionRole.WORKLOAD, action);\n@@ -227,1 +220,1 @@\n-                return setAction(action);\n+                return copyAction(ActionRole.WORKLOAD, action);\n@@ -231,1 +224,1 @@\n-                return setAction(action);\n+                return packageAction(ActionRole.WORKLOAD, action);\n@@ -235,1 +228,33 @@\n-                return setAction(action);\n+                return action(ActionRole.WORKLOAD, action);\n+            }\n+\n+            <T extends Application, U extends AppImageLayout> TaskBuilder logAppImageActionBegin(String keyId, Function<AppImageBuildEnv<T, U>, Object[]> formatArgsSupplier) {\n+                return logAppImageAction(ActionRole.BEFORE, keyId, formatArgsSupplier);\n+            }\n+\n+            <T extends Application, U extends AppImageLayout> TaskBuilder logAppImageActionEnd(String keyId, Function<AppImageBuildEnv<T, U>, Object[]> formatArgsSupplier) {\n+                return logAppImageAction(ActionRole.AFTER, keyId, formatArgsSupplier);\n+            }\n+\n+            <T extends Package, U extends AppImageLayout> TaskBuilder logPackageActionBegin(String keyId, Function<PackageBuildEnv<T, U>, Object[]> argsSupplier) {\n+                return logPackageAction(ActionRole.BEFORE, keyId, argsSupplier);\n+            }\n+\n+            <T extends Package, U extends AppImageLayout> TaskBuilder logPackageActionEnd(String keyId, Function<PackageBuildEnv<T, U>, Object[]> argsSupplier) {\n+                return logPackageAction(ActionRole.AFTER, keyId, argsSupplier);\n+            }\n+\n+            TaskBuilder logActionBegin(String keyId, Supplier<Object[]> formatArgsSupplier) {\n+                return logAction(ActionRole.BEFORE, keyId, formatArgsSupplier);\n+            }\n+\n+            TaskBuilder logActionBegin(String keyId, Object... formatArgsSupplier) {\n+                return logAction(ActionRole.BEFORE, keyId, () -> formatArgsSupplier);\n+            }\n+\n+            TaskBuilder logActionEnd(String keyId, Supplier<Object[]> formatArgsSupplier) {\n+                return logAction(ActionRole.AFTER, keyId, formatArgsSupplier);\n+            }\n+\n+            TaskBuilder logActionEnd(String keyId, Object... formatArgsSupplier) {\n+                return logAction(ActionRole.AFTER, keyId, () -> formatArgsSupplier);\n@@ -239,1 +264,1 @@\n-                return action != null;\n+                return workloadAction != null;\n@@ -275,1 +300,4 @@\n-                final var config = new TaskConfig(Optional.ofNullable(action));\n+                final var config = new TaskConfig(\n+                        Optional.ofNullable(workloadAction),\n+                        Optional.ofNullable(beforeAction),\n+                        Optional.ofNullable(afterAction));\n@@ -281,1 +309,94 @@\n-            private TaskAction action;\n+\n+            private enum ActionRole {\n+                WORKLOAD(TaskBuilder::setWorkloadAction),\n+                BEFORE(TaskBuilder::setBeforeAction),\n+                AFTER(TaskBuilder::setAfterAction),\n+                ;\n+\n+                ActionRole(BiConsumer<TaskBuilder, TaskAction> actionSetter) {\n+                    this.actionSetter = Objects.requireNonNull(actionSetter);\n+                }\n+\n+                TaskBuilder setAction(TaskBuilder taskBuilder, TaskAction action) {\n+                    actionSetter.accept(taskBuilder, action);\n+                    return taskBuilder;\n+                }\n+\n+                private final BiConsumer<TaskBuilder, TaskAction> actionSetter;\n+            }\n+\n+\n+            private TaskBuilder(TaskID id) {\n+                super(id);\n+            }\n+\n+            private TaskBuilder(TaskID id, TaskConfig config) {\n+                this(id);\n+                config.action().ifPresent(this::setWorkloadAction);\n+                config.beforeAction().ifPresent(this::setBeforeAction);\n+                config.afterAction().ifPresent(this::setAfterAction);\n+            }\n+\n+            private TaskBuilder setAction(ActionRole role, TaskAction v) {\n+                return role.setAction(this, v);\n+            }\n+\n+            private TaskBuilder setWorkloadAction(TaskAction v) {\n+                workloadAction = v;\n+                return this;\n+            }\n+\n+            private TaskBuilder setBeforeAction(TaskAction v) {\n+                beforeAction = v;\n+                return this;\n+            }\n+\n+            private TaskBuilder setAfterAction(TaskAction v) {\n+                afterAction = v;\n+                return this;\n+            }\n+\n+            private <T extends Application, U extends ApplicationLayout> TaskBuilder applicationAction(ActionRole role, ApplicationImageTaskAction<T, U> action) {\n+                return setAction(role, action);\n+            }\n+\n+            private <T extends Application, U extends AppImageLayout> TaskBuilder appImageAction(ActionRole role, AppImageTaskAction<T, U> action) {\n+                return setAction(role, action);\n+            }\n+\n+            private <T extends Package> TaskBuilder copyAction(ActionRole role, CopyAppImageTaskAction<T> action) {\n+                return setAction(role, action);\n+            }\n+\n+            private <T extends Package, U extends AppImageLayout> TaskBuilder packageAction(ActionRole role, PackageTaskAction<T, U> action) {\n+                return setAction(role, action);\n+            }\n+\n+            private TaskBuilder action(ActionRole role, NoArgTaskAction action) {\n+                return setAction(role, action);\n+            }\n+\n+            private <T extends Application, U extends AppImageLayout> TaskBuilder logAppImageAction(ActionRole role, String keyId, Function<AppImageBuildEnv<T, U>, Object[]> formatArgsSupplier) {\n+                Objects.requireNonNull(keyId);\n+                return appImageAction(role, (AppImageBuildEnv<T, U> env) -> {\n+                    Log.verbose(I18N.format(keyId, formatArgsSupplier.apply(env)));\n+                });\n+            }\n+\n+            private <T extends Package, U extends AppImageLayout> TaskBuilder logPackageAction(ActionRole role, String keyId, Function<PackageBuildEnv<T, U>, Object[]> formatArgsSupplier) {\n+                Objects.requireNonNull(keyId);\n+                return packageAction(role, (PackageBuildEnv<T, U> env) -> {\n+                    Log.verbose(I18N.format(keyId, formatArgsSupplier.apply(env)));\n+                });\n+            }\n+\n+            private TaskBuilder logAction(ActionRole role, String keyId, Supplier<Object[]> formatArgsSupplier) {\n+                Objects.requireNonNull(keyId);\n+                return action(role, () -> {\n+                    Log.verbose(I18N.format(keyId, formatArgsSupplier.get()));\n+                });\n+            }\n+\n+            private TaskAction workloadAction;\n+            private TaskAction beforeAction;\n+            private TaskAction afterAction;\n@@ -297,1 +418,5 @@\n-            return new TaskBuilder(id);\n+            return Optional.ofNullable(taskConfig.get(id)).map(taskConfig -> {\n+                return new TaskBuilder(id, taskConfig);\n+            }).orElseGet(() -> {\n+                return new TaskBuilder(id);\n+            });\n@@ -395,0 +520,2 @@\n+                .logActionBegin(\"message.create-package\")\n+                .logActionEnd(\"message.package-created\")\n@@ -428,0 +555,11 @@\n+    static void deleteOutputBundle(PackageBuildEnv<Package, AppImageLayout> env) throws IOException {\n+\n+        var outputBundle = env.outputDir().resolve(env.pkg().packageFileNameWithSuffix());\n+\n+        try {\n+            Files.deleteIfExists(outputBundle);\n+        } catch (IOException ex) {\n+            throw new JPackageException(I18N.format(\"error.output-bundle-cannot-be-overwritten\", outputBundle.toAbsolutePath()), ex);\n+        }\n+    }\n+\n@@ -648,0 +786,3 @@\n+                if (config.beforeAction.isPresent()) {\n+                    context.execute(config.beforeAction.orElseThrow());\n+                }\n@@ -649,0 +790,3 @@\n+                if (config.afterAction.isPresent()) {\n+                    context.execute(config.afterAction.orElseThrow());\n+                }\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/PackagingPipeline.java","additions":172,"deletions":28,"binary":false,"changes":200,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -59,1 +59,1 @@\n-import jdk.jpackage.internal.model.PackageType;\n+import jdk.jpackage.internal.model.BundleType;\n@@ -253,1 +253,1 @@\n-                    optionSpec, bundlingOperation.packageTypeValue()));\n+                    optionSpec, bundlingOperation.bundleTypeValue()));\n@@ -270,2 +270,2 @@\n-            if (obj instanceof PackageType packageType) {\n-                return packageType;\n+            if (obj instanceof BundleType bundleType) {\n+                return bundleType;\n@@ -273,1 +273,2 @@\n-                return typeOption.spec()\n+                var spec = new StandardOptionContext(os).mapOptionSpec(typeOption.spec());\n+                return spec\n@@ -275,1 +276,1 @@\n-                        .convert(typeOption.spec().name(), StringToken.of(((String[])obj)[0]))\n+                        .convert(spec.name(), StringToken.of(((String[])obj)[0]))\n@@ -278,2 +279,2 @@\n-        }).map(packageType -> {\n-            \/\/ Find standard bundling operations producing the given package type.\n+        }).map(bundleType -> {\n+            \/\/ Find standard bundling operations producing the given bundle type.\n@@ -281,1 +282,1 @@\n-                return op.packageType().equals(packageType);\n+                return op.bundleType().equals(bundleType);\n@@ -286,1 +287,1 @@\n-                \/\/ bundles of the `packageType`.\n+                \/\/ bundles of the `bundleType`.\n@@ -289,1 +290,1 @@\n-                        packageType));\n+                        bundleType));\n@@ -293,1 +294,1 @@\n-                \/\/ Multiple standard bundling operations produce the `packageType` package type.\n+                \/\/ Multiple standard bundling operations produce the `bundleType` bundle type.\n@@ -301,1 +302,1 @@\n-                    \/\/ bundles of the `packageType` on the current OS.\n+                    \/\/ bundles of the `bundleType` on the current OS.\n@@ -304,1 +305,1 @@\n-                            packageType, OperatingSystem.current()));\n+                            bundleType, OperatingSystem.current()));\n@@ -319,1 +320,1 @@\n-            \/\/ No package type specified, use the default bundling operation in the given environment.\n+            \/\/ No bundle type specified, use the default bundling operation in the given environment.\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/OptionsAnalyzer.java","additions":17,"deletions":16,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -27,2 +27,0 @@\n-import static jdk.jpackage.internal.model.AppImagePackageType.APP_IMAGE;\n-\n@@ -37,0 +35,2 @@\n+import jdk.jpackage.internal.model.AppImageBundleType;\n+import jdk.jpackage.internal.model.BundleType;\n@@ -47,3 +47,3 @@\n-    CREATE_WIN_APP_IMAGE(APP_IMAGE, \"^(?!(linux-|mac-|win-exe-|win-msi-))\", OperatingSystem.WINDOWS),\n-    CREATE_LINUX_APP_IMAGE(APP_IMAGE, \"^(?!(win-|mac-|linux-rpm-|linux-deb-))\", OperatingSystem.LINUX),\n-    CREATE_MAC_APP_IMAGE(APP_IMAGE, \"^(?!(linux-|win-|mac-dmg-|mac-pkg-))\", OperatingSystem.MACOS),\n+    CREATE_WIN_APP_IMAGE(AppImageBundleType.WIN_APP_IMAGE, \"^(?!(linux-|mac-|win-exe-|win-msi-))\", OperatingSystem.WINDOWS),\n+    CREATE_LINUX_APP_IMAGE(AppImageBundleType.LINUX_APP_IMAGE, \"^(?!(win-|mac-|linux-rpm-|linux-deb-))\", OperatingSystem.LINUX),\n+    CREATE_MAC_APP_IMAGE(AppImageBundleType.MAC_APP_IMAGE, \"^(?!(linux-|win-|mac-dmg-|mac-pkg-))\", OperatingSystem.MACOS),\n@@ -56,1 +56,1 @@\n-    SIGN_MAC_APP_IMAGE(APP_IMAGE, OperatingSystem.MACOS, Verb.SIGN);\n+    SIGN_MAC_APP_IMAGE(AppImageBundleType.MAC_APP_IMAGE, OperatingSystem.MACOS, Verb.SIGN);\n@@ -81,2 +81,2 @@\n-    StandardBundlingOperation(PackageType packageType, String optionNameRegexp, OperatingSystem os, Verb descriptorVerb) {\n-        this.packageType = Objects.requireNonNull(packageType);\n+    StandardBundlingOperation(BundleType bundleType, String optionNameRegexp, OperatingSystem os, Verb descriptorVerb) {\n+        this.bundleType = Objects.requireNonNull(bundleType);\n@@ -88,2 +88,2 @@\n-    StandardBundlingOperation(PackageType packageType, String optionNameRegexp, OperatingSystem os) {\n-        this(packageType, optionNameRegexp, os, Verb.CREATE);\n+    StandardBundlingOperation(BundleType bundleType, String optionNameRegexp, OperatingSystem os) {\n+        this(bundleType, optionNameRegexp, os, Verb.CREATE);\n@@ -92,2 +92,2 @@\n-    StandardBundlingOperation(PackageType packageType, OperatingSystem os, Verb descriptorVerb) {\n-        this.packageType = Objects.requireNonNull(packageType);\n+    StandardBundlingOperation(BundleType bundleType, OperatingSystem os, Verb descriptorVerb) {\n+        this.bundleType = Objects.requireNonNull(bundleType);\n@@ -103,2 +103,2 @@\n-    public String packageTypeValue() {\n-        if (packageType.equals(APP_IMAGE)) {\n+    public String bundleTypeValue() {\n+        if (bundleType instanceof AppImageBundleType) {\n@@ -107,1 +107,1 @@\n-            return ((StandardPackageType)packageType).suffix().substring(1);\n+            return ((StandardPackageType)bundleType).suffix().substring(1);\n@@ -111,0 +111,4 @@\n+    public BundleType bundleType() {\n+        return bundleType;\n+    }\n+\n@@ -112,1 +116,1 @@\n-        return packageType;\n+        return (PackageType)bundleType();\n@@ -125,1 +129,1 @@\n-        return new BundlingOperationDescriptor(os(), packageTypeValue(), descriptorVerb.value());\n+        return new BundlingOperationDescriptor(os(), bundleTypeValue(), descriptorVerb.value());\n@@ -202,1 +206,1 @@\n-    private final PackageType packageType;\n+    private final BundleType bundleType;\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/StandardBundlingOperation.java","additions":23,"deletions":19,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -58,0 +58,2 @@\n+import jdk.jpackage.internal.model.AppImageBundleType;\n+import jdk.jpackage.internal.model.BundleType;\n@@ -62,1 +64,0 @@\n-import jdk.jpackage.internal.model.PackageType;\n@@ -106,1 +107,1 @@\n-    public static final OptionValue<PackageType> TYPE = option(\"type\", PackageType.class).addAliases(\"t\")\n+    public static final OptionValue<BundleType> TYPE = option(\"type\", BundleType.class).addAliases(\"t\")\n@@ -110,4 +111,1 @@\n-                Objects.requireNonNull(str);\n-                return Stream.of(StandardBundlingOperation.values()).filter(bundlingOperation -> {\n-                    return bundlingOperation.packageTypeValue().equals(str);\n-                }).map(StandardBundlingOperation::packageType).findFirst().orElseThrow(IllegalArgumentException::new);\n+                return parseBundleType(str, OperatingSystem.current());\n@@ -118,0 +116,3 @@\n+                b.converter(str -> {\n+                    return parseBundleType(str, context.os());\n+                });\n@@ -668,0 +669,17 @@\n+    private static BundleType parseBundleType(String str, OperatingSystem appImageOS) {\n+        Objects.requireNonNull(str);\n+        Objects.requireNonNull(appImageOS);\n+\n+        return Stream.of(StandardBundlingOperation.values()).filter(bundlingOperation -> {\n+            return bundlingOperation.bundleTypeValue().equals(str);\n+        })\n+        .filter(bundlingOperation -> {\n+            \/\/ Skip app image bundle type if it is from another platform.\n+            return !(bundlingOperation.bundleType() instanceof AppImageBundleType)\n+                    || (bundlingOperation.os() == appImageOS);\n+        })\n+        .map(StandardBundlingOperation::bundleType)\n+        .findFirst()\n+        .orElseThrow(IllegalArgumentException::new);\n+    }\n+\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/StandardOption.java","additions":24,"deletions":6,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -0,0 +1,51 @@\n+\/*\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package jdk.jpackage.internal.model;\n+\n+import java.util.Objects;\n+\n+\/**\n+ * App image bundle type.\n+ *\n+ * @see StandardPackageType\n+ *\/\n+public enum AppImageBundleType implements BundleType {\n+\n+    WIN_APP_IMAGE(\"bundle-type.win-app\"),\n+    LINUX_APP_IMAGE(\"bundle-type.linux-app\"),\n+    MAC_APP_IMAGE(\"bundle-type.mac-app\"),\n+    ;\n+\n+    private AppImageBundleType(String key) {\n+        this.key = Objects.requireNonNull(key);\n+    }\n+\n+    @Override\n+    public String label() {\n+        return I18N.getString(key);\n+    }\n+\n+    private final String key;\n+}\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/AppImageBundleType.java","additions":51,"deletions":0,"binary":false,"changes":51,"status":"added"},{"patch":"@@ -1,41 +0,0 @@\n-\/*\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.  Oracle designates this\n- * particular file as subject to the \"Classpath\" exception as provided\n- * by Oracle in the LICENSE file that accompanied this code.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-package jdk.jpackage.internal.model;\n-\n-\/**\n- * App image packaging type.\n- *\n- * @see StandardPackageType\n- *\/\n-public final class AppImagePackageType implements PackageType {\n-\n-    private AppImagePackageType() {\n-    }\n-\n-    \/**\n-     * Singleton\n-     *\/\n-    public static final AppImagePackageType APP_IMAGE = new AppImagePackageType();\n-}\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/AppImagePackageType.java","additions":0,"deletions":41,"binary":false,"changes":41,"status":"deleted"},{"patch":"@@ -0,0 +1,39 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package jdk.jpackage.internal.model;\n+\n+\n+\/**\n+ * Generic bundle type. E.g.: application image, rpm, msi are all bundle types.\n+ *\/\n+public sealed interface BundleType permits PackageType, AppImageBundleType {\n+\n+    \/**\n+     * Returns a user-facing label of this bundle type.\n+     * @return a user-facing label of this bundle type.\n+     *\/\n+    String label();\n+}\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/BundleType.java","additions":39,"deletions":0,"binary":false,"changes":39,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,1 +30,1 @@\n- * Generic package type. E.g.: application image, rpm, msi are all package types.\n+ * Native package type. E.g.: dmg, rpm, msi are all package types.\n@@ -34,1 +34,1 @@\n-public interface PackageType {}\n+public non-sealed interface PackageType extends BundleType {}\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/PackageType.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -27,0 +27,2 @@\n+import java.util.Objects;\n+\n@@ -31,6 +33,6 @@\n-    WIN_MSI(\".msi\"),\n-    WIN_EXE(\".exe\"),\n-    LINUX_DEB(\".deb\"),\n-    LINUX_RPM(\".rpm\"),\n-    MAC_PKG(\".pkg\"),\n-    MAC_DMG(\".dmg\");\n+    WIN_MSI(\"bundle-type.win-msi\", \".msi\"),\n+    WIN_EXE(\"bundle-type.win-exe\", \".exe\"),\n+    LINUX_DEB(\"bundle-type.linux-deb\", \".deb\"),\n+    LINUX_RPM(\"bundle-type.linux-rpm\", \".rpm\"),\n+    MAC_PKG(\"bundle-type.mac-pkg\", \".pkg\"),\n+    MAC_DMG(\"bundle-type.mac-dmg\", \".dmg\");\n@@ -38,2 +40,3 @@\n-    StandardPackageType(String suffix) {\n-        this.suffix = suffix;\n+    StandardPackageType(String key, String suffix) {\n+        this.key = Objects.requireNonNull(key);\n+        this.suffix = Objects.requireNonNull(suffix);\n@@ -51,0 +54,6 @@\n+    @Override\n+    public String label() {\n+        return I18N.getString(key);\n+    }\n+\n+    private final String key;\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/StandardPackageType.java","additions":18,"deletions":9,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -31,2 +31,2 @@\n-bundle-type.win-exe=EXE Installer Package\n-bundle-type.win-msi=MSI Installer Package\n+bundle-type.win-exe=Windows EXE Installer\n+bundle-type.win-msi=Windows MSI Installer\n@@ -37,2 +37,2 @@\n-bundle-type.linux-deb=DEB Bundle\n-bundle-type.linux-rpm=RPM Bundle\n+bundle-type.linux-deb=Linux DEB Package\n+bundle-type.linux-rpm=Linux RPM Package\n@@ -46,1 +46,6 @@\n-message.creating-app-bundle=Creating app package: {0} in {1}\n+\n+message.create-package=Building output package file...\n+message.create-app-image=Building output application image directory...\n+message.package-created=Succeeded in building output package file\n+message.app-image-created=Succeeded in building output application image directory\n+\n@@ -48,1 +53,1 @@\n-message.bundle-created=Succeeded in building {0} package\n+\n@@ -100,0 +105,2 @@\n+error.output-bundle-cannot-be-overwritten=Output package file \"{0}\" exists and can not be removed.\n+\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/resources\/MainResources.properties","additions":13,"deletions":6,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -82,2 +82,0 @@\n-        Log.verbose(I18N.format(\"message.outputting-to-location\", outputDir.toAbsolutePath()));\n-\n@@ -105,2 +103,0 @@\n-\n-        Log.verbose(I18N.format(\"message.output-location\", outputDir.toAbsolutePath()));\n","filename":"src\/jdk.jpackage\/windows\/classes\/jdk\/jpackage\/internal\/WinExePackager.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -318,1 +318,0 @@\n-        Log.verbose(I18N.format(\"message.generating-msi\", msiOut.toAbsolutePath()));\n","filename":"src\/jdk.jpackage\/windows\/classes\/jdk\/jpackage\/internal\/WinMsiPackager.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-# Copyright (c) 2017, 2025, Oracle and\/or its affiliates. All rights reserved.\n+# Copyright (c) 2017, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -59,2 +59,0 @@\n-message.outputting-to-location=Generating EXE for installer to: {0}.\n-message.output-location=Installer (.exe) saved to: {0}\n@@ -67,2 +65,0 @@\n-message.generating-msi=Generating MSI: {0}.\n-\n","filename":"src\/jdk.jpackage\/windows\/classes\/jdk\/jpackage\/internal\/resources\/WinResources.properties","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -83,0 +83,1 @@\n+        removeOldOutputBundle = true;\n@@ -94,0 +95,1 @@\n+        removeOldOutputBundle = cmd.removeOldOutputBundle;\n@@ -847,0 +849,22 @@\n+    \/**\n+     * Configures this instance to optionally remove the existing output bundle\n+     * before running the jpackage command.\n+     *\n+     * @param v {@code true} to remove existing output bundle before running the\n+     *          jpackage command, and {@code false} otherwise\n+     * @return this\n+     *\/\n+    public JPackageCommand removeOldOutputBundle(boolean v) {\n+        verifyMutable();\n+        removeOldOutputBundle = v;\n+        return this;\n+    }\n+\n+    \/**\n+     * Returns {@code true} if this instance will remove existing output bundle\n+     * before running the jpackage command, and {@code false} otherwise.\n+     *\/\n+    public boolean isRemoveOldOutputBundle() {\n+        return removeOldOutputBundle;\n+    }\n+\n@@ -949,15 +973,12 @@\n-        if (hasArgument(\"--dest\")) {\n-            nullableOutputBundle().ifPresent(path -> {\n-                ThrowingRunnable.toRunnable(() -> {\n-                    if (Files.isDirectory(path)) {\n-                        TKit.deleteDirectoryRecursive(path, String.format(\n-                                \"Delete [%s] folder before running jpackage\",\n-                                path));\n-                    } else if (TKit.deleteIfExists(path)) {\n-                        TKit.trace(String.format(\n-                                \"Deleted [%s] file before running jpackage\",\n-                                path));\n-                    }\n-                }).run();\n-            });\n-        }\n+        nullableOutputBundle().filter(_ -> {\n+            return removeOldOutputBundle;\n+        }).ifPresent(path -> {\n+            ThrowingRunnable.toRunnable(() -> {\n+                if (Files.isDirectory(path)) {\n+                    TKit.deleteDirectoryRecursive(path,\n+                            String.format(\"Delete [%s] folder before running jpackage\", path));\n+                } else if (TKit.deleteIfExists(path)) {\n+                    TKit.trace(String.format(\"Deleted [%s] file before running jpackage\", path));\n+                }\n+            }).run();\n+        });\n@@ -1093,1 +1114,1 @@\n-    public static enum ReadOnlyPathAssert{\n+    public static enum ReadOnlyPathAssert {\n@@ -1777,0 +1798,1 @@\n+    private boolean removeOldOutputBundle;\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/JPackageCommand.java","additions":38,"deletions":16,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -729,1 +729,11 @@\n-                    Executor.Result result = cmd.execute(expectedJPackageExitCode);\n+                    var nullableOutputBundle = cmd.nullableOutputBundle();\n+\n+                    var oldOutputBundleSnapshot = nullableOutputBundle\n+                            .filter(Files::exists)\n+                            .filter(_ -> {\n+                                return !cmd.isRemoveOldOutputBundle();\n+                            })\n+                            .map(TKit.PathSnapshot::new);\n+\n+                    var result = cmd.execute(expectedJPackageExitCode);\n+\n@@ -733,2 +743,10 @@\n-                        cmd.nullableOutputBundle().ifPresent(outputBundle -> {\n-                            TKit.assertPathExists(outputBundle, false);\n+                        nullableOutputBundle.ifPresent(outputBundle -> {\n+                            oldOutputBundleSnapshot.ifPresentOrElse(snapshot -> {\n+                                \/\/ jpackage failed, but the output bundle exists.\n+                                \/\/ This output bundle existed before the jpackage was invoked.\n+                                \/\/ Verify jpackage didn't modify it.\n+                                new TKit.PathSnapshot(outputBundle).assertEquals(snapshot, String.format(\n+                                        \"Check jpackage didn't modify the old output bundle [%s]\", outputBundle));\n+                            }, () -> {\n+                                TKit.assertPathExists(outputBundle, false);\n+                            });\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/PackageTest.java","additions":22,"deletions":4,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -44,1 +44,1 @@\n-import jdk.jpackage.internal.model.AppImagePackageType;\n+import jdk.jpackage.internal.model.AppImageBundleType;\n@@ -122,1 +122,1 @@\n-        final var type = op.packageTypeValue();\n+        final var type = op.bundleTypeValue();\n@@ -124,1 +124,1 @@\n-        if (op.packageType() instanceof AppImagePackageType) {\n+        if (op.bundleType() instanceof AppImageBundleType) {\n@@ -168,1 +168,1 @@\n-        if (op.packageType() instanceof AppImagePackageType) {\n+        if (op.bundleType() instanceof AppImageBundleType) {\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/DefaultBundlingEnvironmentTest.java","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -636,1 +636,6 @@\n-                    new PackageType() {},\n+                    new PackageType() {\n+                        @Override\n+                        public String label() {\n+                            throw new UnsupportedOperationException();\n+                        }\n+                    },\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/PackagingPipelineTest.java","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -56,0 +56,2 @@\n+import jdk.jpackage.internal.model.AppImageBundleType;\n+import jdk.jpackage.internal.model.BundleType;\n@@ -178,0 +180,9 @@\n+    @ParameterizedTest\n+    @EnumSource(names = {\"WINDOWS\", \"LINUX\", \"MACOS\"})\n+    public void test_TYPE_valid(OperatingSystem appImageOS) {\n+\n+        var spec = new StandardOptionContext(appImageOS).mapOptionSpec(StandardOption.TYPE.getSpec());\n+\n+        test_TYPE_valid(spec, appImageOS);\n+    }\n+\n@@ -183,5 +194,1 @@\n-        Stream.of(StandardBundlingOperation.values()).forEach(bundlingOperation -> {\n-            var pkgTypeStr = bundlingOperation.packageTypeValue();\n-            var pkgType = spec.converter().orElseThrow().convert(spec.name(), StringToken.of(pkgTypeStr)).orElseThrow();\n-            assertSame(bundlingOperation.packageType(), pkgType);\n-        });\n+        test_TYPE_valid(spec, OperatingSystem.current());\n@@ -339,0 +346,12 @@\n+    private void test_TYPE_valid(OptionSpec<BundleType> spec, OperatingSystem appImageOS) {\n+        Stream.of(StandardBundlingOperation.values()).filter(bundlingOperation -> {\n+            \/\/ Skip app image bundle type if it is from another platform.\n+            return !(bundlingOperation.bundleType() instanceof AppImageBundleType)\n+                    || (bundlingOperation.os() == appImageOS);\n+        }).forEach(bundlingOperation -> {\n+            var bundleTypeStr = bundlingOperation.bundleTypeValue();\n+            var bundleType = spec.converter().orElseThrow().convert(spec.name(), StringToken.of(bundleTypeStr)).orElseThrow();\n+            assertSame(bundlingOperation.bundleType(), bundleType);\n+        });\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/cli\/StandardOptionTest.java","additions":24,"deletions":5,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -25,0 +25,1 @@\n+import static jdk.jpackage.test.RunnablePackageTest.Action.CREATE;\n@@ -35,0 +36,1 @@\n+import java.util.function.Consumer;\n@@ -44,0 +46,1 @@\n+import jdk.jpackage.test.ConfigurationTarget;\n@@ -179,8 +182,3 @@\n-    @SuppressWarnings(\"unchecked\")\n-    public void testVerbose() {\n-        JPackageCommand cmd = JPackageCommand.helloAppImage()\n-                \/\/ Disable default logic adding `--verbose` option\n-                \/\/ to jpackage command line.\n-                .ignoreDefaultVerbose(true)\n-                .saveConsoleOutput(true)\n-                .setFakeRuntime().executePrerequisiteActions();\n+    @Parameter(\"false\")\n+    @Parameter(\"true\")\n+    public void testQuiet(boolean appImage) {\n@@ -188,12 +186,3 @@\n-        List<String> expectedVerboseOutputStrings = new ArrayList<>();\n-        expectedVerboseOutputStrings.add(\"Creating app package:\");\n-        if (TKit.isWindows()) {\n-            expectedVerboseOutputStrings.add(\n-                    \"Succeeded in building Windows Application Image package\");\n-        } else if (TKit.isLinux()) {\n-            expectedVerboseOutputStrings.add(\n-                    \"Succeeded in building Linux Application Image package\");\n-        } else if (TKit.isOSX()) {\n-            expectedVerboseOutputStrings.add(\"Preparing Info.plist:\");\n-            expectedVerboseOutputStrings.add(\n-                    \"Succeeded in building Mac Application Image package\");\n+        ConfigurationTarget target;\n+        if (appImage) {\n+            target = new ConfigurationTarget(JPackageCommand.helloAppImage());\n@@ -201,1 +190,1 @@\n-            TKit.throwUnknownPlatformError();\n+            target = new ConfigurationTarget(new PackageTest().configureHelloApp());\n@@ -204,3 +193,7 @@\n-        TKit.deleteDirectoryContentsRecursive(cmd.outputDir());\n-        List<String> nonVerboseOutput = cmd.execute().getOutput();\n-        List<String>[] verboseOutput = (List<String>[])new List<?>[1];\n+        target.addInitializer(cmd -> {\n+            \/\/ Disable the default logic adding `--verbose` option to jpackage command line.\n+            cmd.ignoreDefaultVerbose(true)\n+            .useToolProvider(true)\n+            .saveConsoleOutput(true)\n+            .setFakeRuntime();\n+        });\n@@ -208,8 +201,9 @@\n-        \/\/ Directory clean up is not 100% reliable on Windows because of\n-        \/\/ antivirus software that can lock .exe files. Setup\n-        \/\/ different output directory instead of cleaning the default one for\n-        \/\/ verbose jpackage run.\n-        TKit.withTempDirectory(\"verbose-output\", tempDir -> {\n-            cmd.setArgumentValue(\"--dest\", tempDir);\n-            cmd.addArgument(\"--verbose\");\n-            verboseOutput[0] = cmd.execute().getOutput();\n+        Consumer<Executor.Result> asserter = result -> {\n+            TKit.assertStringListEquals(List.of(), result.getOutput(), \"Check output is empty\");\n+        };\n+\n+        target.cmd().map(JPackageCommand::execute).ifPresent(asserter);\n+        target.test().ifPresent(test -> {\n+            test.addBundleVerifier((_, result) -> {\n+                asserter.accept(result);\n+            }).run(CREATE);\n@@ -217,0 +211,21 @@\n+    }\n+\n+    @Test\n+    @Parameter(\"false\")\n+    @Parameter(\"true\")\n+    public void testVerbose(boolean appImage) {\n+\n+        ConfigurationTarget target;\n+        if (appImage) {\n+            target = new ConfigurationTarget(JPackageCommand.helloAppImage());\n+        } else {\n+            target = new ConfigurationTarget(new PackageTest().configureHelloApp());\n+        }\n+\n+        target.addInitializer(cmd -> {\n+            \/\/ Disable the default logic adding `--verbose` option to jpackage command line.\n+            cmd.ignoreDefaultVerbose(true)\n+                    .useToolProvider(true)\n+                    .addArgument(\"--verbose\")\n+                    .saveConsoleOutput(true)\n+                    .setFakeRuntime();\n@@ -218,2 +233,10 @@\n-        TKit.assertTrue(nonVerboseOutput.size() < verboseOutput[0].size(),\n-                \"Check verbose output is longer than regular\");\n+            List<CannedFormattedString> verboseContent;\n+            if (appImage) {\n+                verboseContent = List.of(\n+                        JPackageStringBundle.MAIN.cannedFormattedString(\"message.create-app-image\"),\n+                        JPackageStringBundle.MAIN.cannedFormattedString(\"message.app-image-created\"));\n+            } else {\n+                verboseContent = List.of(\n+                        JPackageStringBundle.MAIN.cannedFormattedString(\"message.create-package\"),\n+                        JPackageStringBundle.MAIN.cannedFormattedString(\"message.package-created\"));\n+            }\n@@ -221,4 +244,1 @@\n-        expectedVerboseOutputStrings.forEach(str -> {\n-            TKit.assertTextStream(str).label(\"regular output\")\n-                    .predicate(String::contains).negate()\n-                    .apply(nonVerboseOutput);\n+            cmd.validateOutput(verboseContent.toArray(CannedFormattedString[]::new));\n@@ -227,3 +247,3 @@\n-        expectedVerboseOutputStrings.forEach(str -> {\n-            TKit.assertTextStream(str).label(\"verbose output\")\n-                    .apply(verboseOutput[0]);\n+        target.cmd().ifPresent(JPackageCommand::execute);\n+        target.test().ifPresent(test -> {\n+            test.run(CREATE);\n","filename":"test\/jdk\/tools\/jpackage\/share\/BasicTest.java","additions":62,"deletions":42,"binary":false,"changes":104,"status":"modified"},{"patch":"@@ -0,0 +1,119 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\n+import java.io.FileOutputStream;\n+import java.io.IOException;\n+import java.io.PrintWriter;\n+import java.io.UncheckedIOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Objects;\n+import java.util.spi.ToolProvider;\n+import jdk.internal.util.OperatingSystem;\n+import jdk.jpackage.test.Annotations.Parameter;\n+import jdk.jpackage.test.Annotations.Test;\n+import jdk.jpackage.test.JPackageCommand;\n+import jdk.jpackage.test.JPackageStringBundle;\n+import jdk.jpackage.test.JavaTool;\n+import jdk.jpackage.test.PackageTest;\n+import jdk.jpackage.test.TKit;\n+\n+\/*\n+ * @test\n+ * @summary Test how jpackage handles errors writing output bundle\n+ * @library \/test\/jdk\/tools\/jpackage\/helpers\n+ * @build jdk.jpackage.test.*\n+ * @compile -Xlint:all -Werror OutputErrorTest.java\n+ * @run main\/othervm\/timeout=1440 -Xmx512m jdk.jpackage.test.Main\n+ *  --jpt-run=OutputErrorTest\n+ *\/\n+\n+public final class OutputErrorTest {\n+\n+    @Test\n+    @Parameter(\"DIR\")\n+    \/\/ \"Locked file error\" reliably works only on Windows\n+    @Parameter(value = \"LOCKED_FILE\", ifOS = OperatingSystem.WINDOWS)\n+    public void testPackage(ExistingOutputBundleType existingOutputBundleType) {\n+\n+        new PackageTest().configureHelloApp().addInitializer(cmd -> {\n+\n+            cmd.setFakeRuntime();\n+            cmd.setArgumentValue(\"--dest\", TKit.createTempDirectory(\"output\"));\n+            cmd.removeOldOutputBundle(false);\n+            cmd.validateOutput(JPackageCommand.makeError(JPackageStringBundle.MAIN.cannedFormattedString(\n+                    \"error.output-bundle-cannot-be-overwritten\", cmd.outputBundle().toAbsolutePath())));\n+\n+            var outputBundle = cmd.outputBundle();\n+\n+            switch (existingOutputBundleType) {\n+                case DIR -> {\n+                    Files.createDirectories(outputBundle);\n+                    Files.writeString(outputBundle.resolve(\"foo.txt\"), \"Hello\");\n+                }\n+                case LOCKED_FILE -> {\n+                    Files.writeString(outputBundle, \"Hello\");\n+                    cmd.useToolProvider(createToolProviderWithLockedFile(\n+                            JavaTool.JPACKAGE.asToolProvider(), outputBundle));\n+                }\n+            }\n+\n+        }).setExpectedExitCode(1).run();\n+    }\n+\n+    enum ExistingOutputBundleType {\n+        DIR,\n+        LOCKED_FILE,\n+        ;\n+    }\n+\n+    private static ToolProvider createToolProviderWithLockedFile(ToolProvider tp, Path lockedFile) {\n+        Objects.requireNonNull(tp);\n+        if (!Files.isRegularFile(lockedFile)) {\n+            throw new IllegalArgumentException();\n+        }\n+\n+        return new ToolProvider() {\n+\n+            @Override\n+            public String name() {\n+                return \"jpackage-mock\";\n+            }\n+\n+            @SuppressWarnings(\"try\")\n+            @Override\n+            public int run(PrintWriter out, PrintWriter err, String... args) {\n+                try {\n+                    var lastModifiedTime = Files.getLastModifiedTime(lockedFile);\n+                    try (var fos = new FileOutputStream(lockedFile.toFile()); var lock = fos.getChannel().lock()) {\n+                        Files.setLastModifiedTime(lockedFile, lastModifiedTime);\n+                        return tp.run(out, err, args);\n+                    }\n+                } catch (IOException ex) {\n+                    throw new UncheckedIOException(ex);\n+                }\n+            }\n+        };\n+    }\n+}\n","filename":"test\/jdk\/tools\/jpackage\/share\/OutputErrorTest.java","additions":119,"deletions":0,"binary":false,"changes":119,"status":"added"}]}