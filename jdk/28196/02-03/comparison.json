{"files":[{"patch":"@@ -25,0 +25,3 @@\n+import java.net.BindException;\n+import java.net.ServerSocket;\n+import java.net.Socket;\n@@ -27,0 +30,1 @@\n+import java.net.http.HttpOption;\n@@ -50,0 +54,1 @@\n+import static java.net.http.HttpOption.H3_DISCOVERY;\n@@ -70,0 +75,2 @@\n+    private ServerSocket tcpServerSocket = null;\n+    private Thread tcpServerThread = null;\n@@ -85,0 +92,26 @@\n+\n+        \/\/ Attempts to bind a TCP server socket on the same port\n+        \/\/ That server will just accept and immediately close\n+        \/\/ any connection. This is to make sure that we won't target\n+        \/\/ another server when falling back to TCP.\n+        tcpServerSocket = new ServerSocket();\n+        try {\n+            tcpServerSocket.bind(h3Server.getAddress());\n+            tcpServerThread = Thread.ofPlatform().daemon().start(() -> {\n+                System.out.println(\"tcpServerThread started\");\n+                while (true) {\n+                    try (var accepted = tcpServerSocket.accept()) {\n+                        \/\/ close immediately\n+                    } catch (IOException x) {\n+                        System.out.println(\"tcpServerSocket: \" + x);\n+                        break;\n+                    }\n+                }\n+                System.out.println(\"tcpServerThread stopped\");\n+            });\n+        } catch (BindException x) {\n+            tcpServerSocket.close();\n+            \/\/ if tcpServerSocket is null we will use\n+            \/\/ HTTP3_URI_ONLY for the request\n+            tcpServerSocket = null;\n+        }\n@@ -93,0 +126,4 @@\n+        if (tcpServerSocket != null) {\n+            tcpServerSocket.close();\n+            tcpServerThread.join();\n+        }\n@@ -128,0 +165,4 @@\n+        if (tcpServerSocket == null) {\n+            \/\/ could not open ServerSocket on same port, only use HTTP\/3\n+            reqBuilder.setOption(H3_DISCOVERY, HTTP_3_URI_ONLY);\n+        }\n@@ -146,1 +187,0 @@\n-\n@@ -151,1 +191,1 @@\n-            Assert.assertEquals(resp1.statusCode(), 200, \"unexpected response code for GET request\");\n+            fail(\"Unexpected response from server: \" + resp1);\n","filename":"test\/jdk\/java\/net\/httpclient\/http3\/H3LogHandshakeErrors.java","additions":42,"deletions":2,"binary":false,"changes":44,"status":"modified"}]}