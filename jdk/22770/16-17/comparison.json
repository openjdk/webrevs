{"files":[{"patch":"@@ -33,2 +33,4 @@\n-class AsyncLogWriter::ProducerLocker : public StackObj {\n-  static Thread* _holder;\n+class AsyncLogWriter::Locker {\n+  Thread*& _holder;\n+  PlatformMonitor& _lock;\n+\n@@ -36,4 +38,4 @@\n-  static Thread* current_holder() { return _holder; }\n-  ProducerLocker() {\n-    assert(_instance != nullptr, \"AsyncLogWriter::_lock is unavailable\");\n-    _instance->_producer_lock.lock();\n+  Locker(Thread*& holder, PlatformMonitor& lock)\n+  : _holder(holder),\n+    _lock(lock) {\n+    _lock.lock();\n@@ -43,1 +45,1 @@\n-  ~ProducerLocker() {\n+  ~Locker() {\n@@ -46,1 +48,1 @@\n-    _instance->_producer_lock.unlock();\n+    _lock.unlock();\n@@ -49,1 +51,3 @@\n-  void notify() { _instance->_consumer_lock.notify(); }\n+  void notify() {\n+    _lock.notify();\n+  }\n@@ -53,1 +57,1 @@\n-    _instance->_producer_lock.wait(0\/* no timeout *\/);\n+    _lock.wait(0 \/* no timeout *\/);\n@@ -58,1 +62,1 @@\n-class AsyncLogWriter::ConsumerLocker : public StackObj {\n+class AsyncLogWriter::ProducerLocker : public Locker {\n@@ -60,1 +64,0 @@\n-\n@@ -63,11 +66,2 @@\n-  ConsumerLocker() {\n-    assert(_instance != nullptr, \"AsyncLogWriter::_lock is unavailable\");\n-    _instance->_consumer_lock.lock();\n-    _holder = Thread::current_or_null();\n-  }\n-\n-  ~ConsumerLocker() {\n-    assert(_holder == Thread::current_or_null(), \"must be\");\n-    _holder = nullptr;\n-    _instance->_consumer_lock.unlock();\n-  }\n+  ProducerLocker() : Locker(_holder, _instance->_producer_lock) {}\n+};\n@@ -75,7 +69,5 @@\n-  void notify() { _instance->_consumer_lock.notify(); }\n-  void wait() {\n-    Thread* saved_holder = _holder;\n-    _holder = nullptr;\n-    _instance->_consumer_lock.wait(0\/* no timeout *\/);\n-    _holder = saved_holder;\n-  }\n+class AsyncLogWriter::ConsumerLocker : public Locker {\n+  static Thread* _holder;\n+public:\n+  static Thread* current_holder() { return _holder; }\n+  ConsumerLocker() : Locker(_holder, _instance->_consumer_lock) {}\n","filename":"src\/hotspot\/share\/logging\/logAsyncWriter.cpp","additions":22,"deletions":30,"binary":false,"changes":52,"status":"modified"},{"patch":"@@ -63,0 +63,1 @@\n+  class Locker;\n","filename":"src\/hotspot\/share\/logging\/logAsyncWriter.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}