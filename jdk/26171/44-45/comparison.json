{"files":[{"patch":"@@ -72,1 +72,1 @@\n-  _volatile_top(start + RegionSizeWords),\n+  _volatile_top(nullptr),\n@@ -577,1 +577,1 @@\n-  assert(volatile_top() == end(), \"Must be\");\n+  assert(volatile_top() == nullptr, \"Must be\");\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -392,1 +392,3 @@\n-  inline bool try_allocate(HeapWord* const obj, size_t const size);\n+  \/\/ Use AtomicAccess::cmpxchg to allocate the object,\n+  \/\/ prior value of _volatile_top will be always written to reference prior_volatile_top.\n+  inline bool try_allocate(HeapWord* const obj, size_t const size, HeapWord* &prior_volatile_top);\n@@ -464,1 +466,2 @@\n-    return is_active_alloc_region() ? volatile_top() : _top;\n+    HeapWord* v_top = volatile_top();\n+    return v_top == nullptr ? _top : v_top;\n@@ -482,2 +485,2 @@\n-    assert(is_active_alloc_region(), \"Must be\");\n-    return byte_size(volatile_top(),    end());\n+    HeapWord* v_top = volatile_top();\n+    return v_top == nullptr ? 0 : byte_size(volatile_top(),    end());\n@@ -557,0 +560,1 @@\n+    assert(_volatile_top == nullptr, \"Must be\");\n@@ -566,0 +570,1 @@\n+    assert(is_active_alloc_region(), \"Must be\");\n@@ -569,5 +574,9 @@\n-    HeapWord* current_volatile_top = volatile_top();\n-    while (current_volatile_top != end() &&\n-           AtomicAccess::cmpxchg(&_volatile_top, current_volatile_top, end()) != current_volatile_top) {\n-      \/\/ Failed to exchange _volatile_top with end, get new _volatile_top and retry\n-      current_volatile_top = volatile_top();\n+    HeapWord* previous_volatile_top = nullptr;\n+    while (true \/*Always break out in the loop*\/) {\n+      previous_volatile_top = volatile_top();\n+      assert(previous_volatile_top != nullptr, \"Must not\");\n+      set_top(previous_volatile_top); \/\/ Sync current _volatile_top back to _top\n+      if (AtomicAccess::cmpxchg(&_volatile_top, previous_volatile_top, (HeapWord*) nullptr) == previous_volatile_top) {\n+        \/\/ break when successfully exchange _volatile_top to nullptr\n+        break;\n+      }\n@@ -575,3 +584,1 @@\n-    set_top(current_volatile_top); \/\/ Sync current _volatile_top back to _top\n-\n-    assert(is_active_alloc_region(), \"Must be\");\n+    assert(_top == previous_volatile_top, \"Must be\");\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.hpp","additions":19,"deletions":12,"binary":false,"changes":31,"status":"modified"},{"patch":"@@ -173,0 +173,6 @@\n+  HeapWord* obj = volatile_top();\n+  if (obj == nullptr) {\n+    \/\/ _volatile_top has been updated to nullptr, it is not allowed to do atomic alloc\n+    return nullptr;\n+  }\n+\n@@ -174,1 +180,0 @@\n-    HeapWord* obj = volatile_top();\n@@ -177,1 +182,1 @@\n-      if (try_allocate(obj, size)) {\n+      if (try_allocate(obj \/*value*\/, size, obj \/*reference*\/)) {\n@@ -183,0 +188,4 @@\n+      if (obj == nullptr) {\n+        \/\/ _volatile_top has been updated to nullptr, it is not allowed to retry atomic alloc\n+        return nullptr;\n+      }\n@@ -196,0 +205,5 @@\n+  HeapWord* obj = volatile_top();\n+  if (obj == nullptr) {\n+    \/\/ _volatile_top has been updated to nullptr, it is not allowed to do atomic alloc\n+    return nullptr;\n+  }\n@@ -198,1 +212,0 @@\n-    HeapWord* obj = volatile_top();\n@@ -205,1 +218,1 @@\n-      if (try_allocate(obj, adjusted_size)) {\n+      if (try_allocate(obj \/*value*\/, adjusted_size, obj \/*reference*\/)) {\n@@ -212,0 +225,5 @@\n+\n+      if (obj == nullptr) {\n+        \/\/ _volatile_top has been updated to nullptr, it is not allowed to retry atomic alloc\n+        return nullptr;\n+      }\n@@ -221,1 +239,1 @@\n-bool ShenandoahHeapRegion::try_allocate(HeapWord* const obj, size_t const size) {\n+bool ShenandoahHeapRegion::try_allocate(HeapWord* const obj, size_t const size, HeapWord* &prior_top) {\n@@ -223,1 +241,1 @@\n-  if (AtomicAccess::cmpxchg(&_volatile_top, obj, new_top) == obj) {\n+  if ((prior_top = AtomicAccess::cmpxchg(&_volatile_top, obj, new_top)) == obj) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.inline.hpp","additions":24,"deletions":6,"binary":false,"changes":30,"status":"modified"}]}