{"files":[{"patch":"@@ -36,2 +36,2 @@\n-ShenandoahAllocator<ALLOC_PARTITION>::ShenandoahAllocator(uint const alloc_region_count, ShenandoahFreeSet* free_set):\n-  _alloc_region_count(alloc_region_count), _free_set(free_set), _alloc_partition_name(ShenandoahRegionPartitions::partition_name(ALLOC_PARTITION)) {\n+ShenandoahAllocator<ALLOC_PARTITION>::ShenandoahAllocator(uint const alloc_region_count, ShenandoahFreeSet* free_set, bool yield_to_safepoint):\n+  _free_set(free_set), _alloc_partition_name(ShenandoahRegionPartitions::partition_name(ALLOC_PARTITION)), _alloc_region_count(alloc_region_count), _yield_to_safepoint(yield_to_safepoint) {\n@@ -39,1 +39,0 @@\n-    _alloc_regions = PaddedArray<ShenandoahAllocRegion, mtGC>::create_unfreeable(alloc_region_count);\n@@ -255,1 +254,1 @@\n-template <bool ATOMIC>\n+template <bool IS_SHARED_ALLOC_REGION>\n@@ -258,1 +257,1 @@\n-  if (!ATOMIC) {\n+  if (!IS_SHARED_ALLOC_REGION) {\n@@ -264,1 +263,1 @@\n-    obj = ATOMIC ? region->allocate_lab_atomic(req, actual_size, ready_for_retire) : region->allocate_lab(req, actual_size);\n+    obj = IS_SHARED_ALLOC_REGION ? region->allocate_lab_atomic(req, actual_size, ready_for_retire) : region->allocate_lab(req, actual_size);\n@@ -266,1 +265,1 @@\n-    obj = ATOMIC ? region->allocate_atomic(actual_size, req, ready_for_retire) : region->allocate(req.size(), req);\n+    obj = IS_SHARED_ALLOC_REGION ? region->allocate_atomic(actual_size, req, ready_for_retire) : region->allocate(req.size(), req);\n@@ -281,1 +280,1 @@\n-    if (!ATOMIC && region->free_words() < PLAB::min_size()) {\n+    if (!IS_SHARED_ALLOC_REGION && region->free_words() < PLAB::min_size()) {\n@@ -379,4 +378,0 @@\n-  if (_alloc_region_count == 0u) {\n-    \/\/ no-op if _alloc_region_count is 0\n-    return;\n-  }\n@@ -402,7 +397,0 @@\n-        if (!r->has_allocs()) {\n-          log_debug(gc, alloc)(\"%sAllocator: Reverting heap region %li to FREE due to no alloc in the region\",\n-            _alloc_partition_name, r->index());\n-          r->make_empty();\n-          r->set_affiliation(FREE);\n-          _free_set->partitions()->increase_empty_region_counts(ALLOC_PARTITION, 1);\n-        }\n@@ -421,4 +409,0 @@\n-  if (_alloc_region_count == 0u) {\n-    \/\/ no-op if _alloc_region_count is 0\n-    return;\n-  }\n@@ -432,3 +416,1 @@\n-  ShenandoahAllocator(static_cast<uint>(ShenandoahMutatorAllocRegions), free_set) {\n-  _yield_to_safepoint = true;\n-}\n+  ShenandoahAllocator(static_cast<uint>(ShenandoahMutatorAllocRegions), free_set, true) { }\n@@ -437,3 +419,1 @@\n-  ShenandoahAllocator(static_cast<uint>(ShenandoahCollectorAllocRegions), free_set) {\n-  _yield_to_safepoint = false;\n-}\n+  ShenandoahAllocator(static_cast<uint>(ShenandoahCollectorAllocRegions), free_set, false) { }\n@@ -442,3 +422,1 @@\n-  ShenandoahAllocator(0u, free_set) {\n-  _yield_to_safepoint = false;\n-}\n+  ShenandoahAllocator(0u, free_set, false) { }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocator.cpp","additions":10,"deletions":32,"binary":false,"changes":42,"status":"modified"},{"patch":"@@ -34,1 +34,0 @@\n-#include \"memory\/padded.hpp\"\n@@ -44,0 +43,2 @@\n+public:\n+  static constexpr uint             MAX_ALLOC_REGION_COUNT = 128;\n@@ -49,3 +50,1 @@\n-\n-  PaddedEnd<ShenandoahAllocRegion>*  _alloc_regions;\n-  uint  const                        _alloc_region_count;\n+  \/\/ Fields won't change during VM life cycle\n@@ -53,2 +52,5 @@\n-  const char*                        _alloc_partition_name;\n-  bool                               _yield_to_safepoint = false;\n+  char const * const                 _alloc_partition_name;\n+  uint const                         _alloc_region_count;\n+  bool const                         _yield_to_safepoint;\n+\n+  \/\/Fields often get updated\n@@ -58,0 +60,1 @@\n+  ShenandoahAllocRegion              _alloc_regions[MAX_ALLOC_REGION_COUNT];\n@@ -95,0 +98,2 @@\n+  \/\/ Caller should pass true for template parameter HOLDING_HEAP_LOCK if it is holding heap lock, in this case\n+  \/\/ the function will not use AtomicAccess to load the shared alloc regions.\n@@ -98,3 +103,3 @@\n-  \/\/ Allocate in a region, use atomic operations if template parameter ATOMIC is true.\n-  \/\/ When template parameter ATOMIC is false, heap lock is required.\n-  template <bool ATOMIC>\n+  \/\/ Allocate in a region, use atomic operations if template parameter IS_SHARED_ALLOC_REGION is true.\n+  \/\/ When template parameter IS_SHARED_ALLOC_REGION is false, heap lock is required.\n+  template <bool IS_SHARED_ALLOC_REGION>\n@@ -126,1 +131,0 @@\n-  static constexpr uint             MAX_ALLOC_REGION_COUNT = 128;\n@@ -128,1 +132,1 @@\n-  ShenandoahAllocator(uint alloc_region_count, ShenandoahFreeSet* free_set);\n+  ShenandoahAllocator(uint alloc_region_count, ShenandoahFreeSet* free_set, bool yield_to_safepoint);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocator.hpp","additions":15,"deletions":11,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -646,0 +646,8 @@\n+  if (!r->has_allocs()) {\n+    log_debug(gc, alloc)(\"%sAllocator: Reverting heap region %li to FREE due to no alloc in the region\",\n+      partition_name(which_partition), r->index());\n+    r->make_empty();\n+    r->set_affiliation(FREE);\n+    increase_empty_region_counts(which_partition, 1);\n+  }\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahFreeSet.cpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"}]}