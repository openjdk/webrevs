{"files":[{"patch":"@@ -72,1 +72,1 @@\n-  _volatile_top(nullptr),\n+  _atomic_top(nullptr),\n@@ -577,1 +577,1 @@\n-  assert(volatile_top() == nullptr, \"Must be\");\n+  assert(atomic_top() == nullptr, \"Must be\");\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -253,2 +253,2 @@\n-  HeapWord* volatile _volatile_top;\n-  HeapWord*          _top;\n+  HeapWord* volatile _atomic_top; \/\/ for atomic alloc functions, always set to nullprt if a region is not an active alloc region.\n+  HeapWord* volatile _top;\n@@ -393,2 +393,2 @@\n-  \/\/ prior value of _volatile_top will be always written to reference prior_volatile_top.\n-  inline bool try_allocate(HeapWord* const obj, size_t const size, HeapWord* &prior_volatile_top);\n+  \/\/ prior value of _atomic_top will be always written to reference prior_atomic_top.\n+  inline bool try_allocate(HeapWord* const obj, size_t const size, HeapWord* &prior_atomic_top);\n@@ -461,2 +461,2 @@\n-  HeapWord* volatile_top() const {\n-    return AtomicAccess::load(&_volatile_top);\n+  HeapWord* atomic_top() const {\n+    return AtomicAccess::load(&_atomic_top);\n@@ -466,2 +466,2 @@\n-    HeapWord* v_top = volatile_top();\n-    return v_top == nullptr ? _top : v_top;\n+    HeapWord* v_top = atomic_top();\n+    return v_top == nullptr ? AtomicAccess::load(&_top) : v_top;\n@@ -470,1 +470,1 @@\n-    _top = v;\n+    AtomicAccess::store(&_top, v);\n@@ -485,1 +485,1 @@\n-    HeapWord* v_top = volatile_top();\n+    HeapWord* v_top = atomic_top();\n@@ -559,3 +559,3 @@\n-    \/\/ Sync _top to _volatile_top before setting _active_alloc_region flag to prepare for CAS allocation\n-    assert(_volatile_top == nullptr, \"Must be\");\n-    AtomicAccess::store(&_volatile_top, _top);\n+    \/\/ Sync _top to _atomic_top before setting _active_alloc_region flag to prepare for CAS allocation\n+    assert(atomic_top() == nullptr, \"Must be\");\n+    AtomicAccess::store(&_atomic_top, _top);\n@@ -572,1 +572,1 @@\n-    \/\/ Before unset _active_alloc_region flag, _volatile_top needs to be set to the end of region,\n+    \/\/ Before unset _active_alloc_region flag, _atomic_top needs to be set to the end of region,\n@@ -574,7 +574,7 @@\n-    HeapWord* previous_volatile_top = nullptr;\n-    while (true \/*Always break out in the loop*\/) {\n-      previous_volatile_top = volatile_top();\n-      assert(previous_volatile_top != nullptr, \"Must not\");\n-      set_top(previous_volatile_top); \/\/ Sync current _volatile_top back to _top\n-      if (AtomicAccess::cmpxchg(&_volatile_top, previous_volatile_top, (HeapWord*) nullptr) == previous_volatile_top) {\n-        \/\/ break when successfully exchange _volatile_top to nullptr\n+    HeapWord* previous_atomic_top = nullptr;\n+    while (true \/*always break out in the loop*\/) {\n+      previous_atomic_top = atomic_top();\n+      assert(previous_atomic_top != nullptr, \"Must not\");\n+      set_top(previous_atomic_top); \/\/ Sync current _atomic_top back to _top\n+      if (AtomicAccess::cmpxchg(&_atomic_top, previous_atomic_top, (HeapWord*) nullptr) == previous_atomic_top) {\n+        \/\/ break when successfully exchange _atomic_top to nullptr\n@@ -584,1 +584,1 @@\n-    assert(_top == previous_volatile_top, \"Must be\");\n+    assert(_top == previous_atomic_top, \"Must be\");\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.hpp","additions":22,"deletions":22,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -173,1 +173,1 @@\n-  HeapWord* obj = volatile_top();\n+  HeapWord* obj = atomic_top();\n@@ -175,1 +175,1 @@\n-    \/\/ _volatile_top has been updated to nullptr, it is not allowed to do atomic alloc\n+    \/\/ _atomic_top has been updated to nullptr, it is not allowed to do atomic alloc\n@@ -189,1 +189,1 @@\n-        \/\/ _volatile_top has been updated to nullptr, it is not allowed to retry atomic alloc\n+        \/\/ _atomic_top has been updated to nullptr, it is not allowed to retry atomic alloc\n@@ -205,1 +205,1 @@\n-  HeapWord* obj = volatile_top();\n+  HeapWord* obj = atomic_top();\n@@ -207,1 +207,1 @@\n-    \/\/ _volatile_top has been updated to nullptr, it is not allowed to do atomic alloc\n+    \/\/ _atomic_top has been updated to nullptr, it is not allowed to do atomic alloc\n@@ -227,1 +227,1 @@\n-        \/\/ _volatile_top has been updated to nullptr, it is not allowed to retry atomic alloc\n+        \/\/ _atomic_top has been updated to nullptr, it is not allowed to retry atomic alloc\n@@ -239,1 +239,1 @@\n-bool ShenandoahHeapRegion::try_allocate(HeapWord* const obj, size_t const size, HeapWord* &prior_top) {\n+bool ShenandoahHeapRegion::try_allocate(HeapWord* const obj, size_t const size, HeapWord* &prior_atomic_top) {\n@@ -241,1 +241,1 @@\n-  if ((prior_top = AtomicAccess::cmpxchg(&_volatile_top, obj, new_top)) == obj) {\n+  if ((prior_atomic_top = AtomicAccess::cmpxchg(&_atomic_top, obj, new_top)) == obj) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeapRegion.inline.hpp","additions":8,"deletions":8,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -44,1 +44,2 @@\n-  volatile_nonstatic_field(ShenandoahHeapRegion, _volatile_top,        HeapWord*)                         \\\n+  volatile_nonstatic_field(ShenandoahHeapRegion, _atomic_top,          HeapWord*)                         \\\n+  volatile_nonstatic_field(ShenandoahHeapRegion, _top,                 HeapWord*)                         \\\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/vmStructs_shenandoah.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -105,0 +105,1 @@\n+ *      -XX:ErrorFile=\/tmp\/hs_err_pid%p.log\n@@ -109,0 +110,1 @@\n+ *      -XX:ErrorFile=\/tmp\/hs_err_pid%p.log\n","filename":"test\/hotspot\/jtreg\/gc\/shenandoah\/TestAllocObjects.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}