{"files":[{"patch":"@@ -25,1 +25,0 @@\n-#include \"gc\/shared\/workerThread.hpp\"\n@@ -34,1 +33,0 @@\n-#include \"runtime\/os.hpp\"\n@@ -94,1 +92,0 @@\n-\n@@ -97,0 +94,37 @@\n+template <ShenandoahFreeSetPartitionId ALLOC_PARTITION>\n+uint ShenandoahAllocator<ALLOC_PARTITION>::alloc_start_index() {\n+  uint alloc_start_index = 0u;\n+  switch (ALLOC_PARTITION) {\n+    case ShenandoahFreeSetPartitionId::Mutator:\n+      alloc_start_index = ShenandoahThreadLocalData::mutator_allocator_start_index();\n+      break;\n+    case ShenandoahFreeSetPartitionId::Collector:\n+      alloc_start_index = ShenandoahThreadLocalData::collector_allocator_start_index();\n+      break;\n+    default:\n+      break;\n+  }\n+  if (alloc_start_index == UINT_MAX) {\n+    if (_alloc_region_count <= 1u) {\n+      alloc_start_index = 0u;\n+    } else {\n+      if (ALLOC_PARTITION == ShenandoahFreeSetPartitionId::Mutator) {\n+        alloc_start_index = abs(os::random()) % _alloc_region_count;\n+      } else {\n+        alloc_start_index = (Thread::current()->is_Worker_thread() ? WorkerThread::worker_id() : abs(os::random())) % _alloc_region_count;\n+      }\n+    }\n+    switch (ALLOC_PARTITION) {\n+      case ShenandoahFreeSetPartitionId::Mutator:\n+        ShenandoahThreadLocalData::set_mutator_allocator_start_index(alloc_start_index);\n+        break;\n+      case ShenandoahFreeSetPartitionId::Collector:\n+        ShenandoahThreadLocalData::set_collector_allocator_start_index(alloc_start_index);\n+        break;\n+      default:\n+        break;\n+    }\n+  }\n+  return alloc_start_index;\n+}\n+\n@@ -387,2 +421,0 @@\n-THREAD_LOCAL uint ShenandoahMutatorAllocator::_alloc_start_index = UINT_MAX;\n-\n@@ -394,12 +426,0 @@\n-uint ShenandoahMutatorAllocator::alloc_start_index() {\n-  if (_alloc_start_index == UINT_MAX) {\n-    if (_alloc_region_count <= 1u) {\n-      _alloc_start_index = 0u;\n-    } else {\n-      _alloc_start_index = abs(os::random()) % _alloc_region_count;\n-      assert(_alloc_start_index < _alloc_region_count, \"alloc_start_index out of range\");\n-    }\n-  }\n-  return _alloc_start_index;\n-}\n-\n@@ -411,4 +431,0 @@\n-uint ShenandoahCollectorAllocator::alloc_start_index() {\n-  return Thread::current()->is_Worker_thread() ? WorkerThread::worker_id() % _alloc_region_count : 0u;\n-}\n-\n@@ -420,4 +436,0 @@\n-uint ShenandoahOldCollectorAllocator::alloc_start_index() {\n-  return Thread::current()->is_Worker_thread() ? WorkerThread::worker_id() % _alloc_region_count : 0u;\n-}\n-\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocator.cpp","additions":37,"deletions":25,"binary":false,"changes":62,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+#include \"gc\/shenandoah\/shenandoahThreadLocalData.hpp\"\n@@ -60,1 +61,1 @@\n-  virtual uint alloc_start_index() { return 0u; }\n+  uint alloc_start_index();\n@@ -136,2 +137,0 @@\n-  static THREAD_LOCAL uint _alloc_start_index;\n-  uint alloc_start_index() override;\n@@ -143,1 +142,0 @@\n-  uint alloc_start_index() override;\n@@ -152,1 +150,0 @@\n-  uint alloc_start_index() override;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocator.hpp","additions":2,"deletions":5,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -46,1 +46,3 @@\n-  _evacuation_stats(new ShenandoahEvacuationStats()) {\n+  _evacuation_stats(new ShenandoahEvacuationStats()),\n+  _mutator_allocator_start_index(UINT_MAX),\n+  _collector_allocator_start_index(UINT_MAX) {\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahThreadLocalData.cpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -86,0 +86,4 @@\n+  uint   _mutator_allocator_start_index;\n+\n+  uint   _collector_allocator_start_index;\n+\n@@ -283,0 +287,16 @@\n+\n+  static uint mutator_allocator_start_index() {\n+    return data(Thread::current())->_mutator_allocator_start_index;\n+  }\n+\n+  static void set_mutator_allocator_start_index(uint start_index) {\n+    data(Thread::current())->_mutator_allocator_start_index = start_index;\n+  }\n+\n+  static uint collector_allocator_start_index() {\n+    return data(Thread::current())->_collector_allocator_start_index;\n+  }\n+\n+  static void set_collector_allocator_start_index(uint start_index) {\n+    data(Thread::current())->_collector_allocator_start_index = start_index;\n+  }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahThreadLocalData.hpp","additions":20,"deletions":0,"binary":false,"changes":20,"status":"modified"}]}