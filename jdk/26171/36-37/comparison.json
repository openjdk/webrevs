{"files":[{"patch":"@@ -144,2 +144,4 @@\n-    \/\/ Eagerly refresh alloc regions if there are 50% or more of alloc regions ready for retire\n-    ShenandoahHeapLocker locker(ShenandoahHeap::heap()->lock(), _yield_to_safepoint);\n+    \/\/ Eagerly refresh alloc regions if there are 50% or more of alloc regions ready for retire.\n+    \/\/ While holding uninitialized new object, the thread MUST NOT yield to safepoint.\n+    ShenandoahHeapLocker locker(ShenandoahHeap::heap()->lock(), false);\n+    ShenandoahHeapAccountingUpdater accounting_updater(_free_set, ALLOC_PARTITION);\n@@ -147,1 +149,1 @@\n-      reserve_alloc_regions();\n+      accounting_updater._need_update = refresh_alloc_regions() > 0;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocator.cpp","additions":5,"deletions":3,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -67,5 +67,6 @@\n-  \/\/ Attempt to allocate memory to satisfy alloc request.\n-  \/\/ If _alloc_region_count is not 0, it will try to allocate in shared alloc regions first with atomic operations w\/o\n-  \/\/ the need of global heap lock(fast path); when fast path fails, it will call attempt_allocation_slow which takes\n-  \/\/ global heap lock and try to refresh shared alloc regions if they are not refreshed by other mutator thread.\n-  \/\/ If _alloc_region_count is 0, no shared alloc region will be reserved, allocation is always done with global heap lock held.\n+  \/\/ Attempt to allocate memory to satisfy non-humongous allocation.\n+  \/\/ The function is the main entry point of non-humongous allocation work, it tries fast-path allocation calling function\n+  \/\/ attempt_allocation_in_alloc_regions to directly allocate from shared alloc regions.\n+  \/\/ When fast-path allocation fails, it will call attempt_allocation_slow which acquires heap lock.\n+  \/\/ When fast-path allocation succeeds while it also determines >=50% of alloc regions are ready to retire, it calls\n+  \/\/ refresh_alloc_regions to eagerly retire and refill those alloc regions.\n@@ -74,1 +75,1 @@\n-  \/\/ Slow path of allocation attempt. When fast path trying to allocate in shared alloc regions fails attempt_allocation_slow will\n+  \/\/ Slow path of allocation work. When fast path trying to allocate in shared alloc regions fails attempt_allocation_slow will\n@@ -140,3 +141,3 @@\n-\/*\n- * Allocator impl for mutator\n- *\/\n+\/\/ Allocator impl for mutator:\n+\/\/ 1. _yield_to_safepoint is set to true,\n+\/\/ 1. _alloc_region_count is configured by flag ShenandoahMutatorAllocRegions\n@@ -148,0 +149,3 @@\n+\/\/ Allocator impl for collector:\n+\/\/ 1. _yield_to_safepoint is set to false,\n+\/\/ 1. _alloc_region_count is configured by flag ShenandoahCollectorAllocRegions\n@@ -159,0 +163,3 @@\n+  \/\/ Overrides ShenandoahAllocator::allocate function for OldCollector partition.\n+  \/\/ It delegates allocation work to ShenandoahFreeSet::allocate_for_collector,\n+  \/\/ in addition, after allocation it handles plab and remembered set related works which are needed only for old gen.\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocator.hpp","additions":16,"deletions":9,"binary":false,"changes":25,"status":"modified"}]}