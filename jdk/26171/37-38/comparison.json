{"files":[{"patch":"@@ -164,1 +164,1 @@\n-    if (obj != nullptr) {\n+    if (obj != nullptr && regions_ready_for_refresh == 0) {\n@@ -170,1 +170,1 @@\n-\n+  \/\/ Eagerly refresh alloc regions if any is ready for refresh since it is already holding the heap lock.\n@@ -172,3 +172,6 @@\n-    int refreshed = refresh_alloc_regions(&req, &in_new_region, &obj);\n-    if (refreshed > 0 || obj != nullptr) {\n-      accounting_updater._need_update = true;\n+    if (obj == nullptr) {\n+      if (const int refreshed = refresh_alloc_regions(&req, &in_new_region, &obj); refreshed > 0 || obj != nullptr) {\n+        accounting_updater._need_update = true;\n+      }\n+    } else {\n+      accounting_updater._need_update = refresh_alloc_regions() > 0;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocator.cpp","additions":8,"deletions":5,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -75,2 +75,9 @@\n-  \/\/ Slow path of allocation work. When fast path trying to allocate in shared alloc regions fails attempt_allocation_slow will\n-  \/\/ be called to refresh shared alloc regions and allocate memory for the alloc request.\n+  \/\/ Slow path of non-humongous allocation work.\n+  \/\/ When the allocator fails to allocate memory with fast-path w\/o holding heap lock, it calls this function\n+  \/\/ to try the slow-path allocation. The function always acquires heap lock and then handle the slow-path allocation as:\n+  \/\/ 1. if _epoch_id has changed by any other thread, try the fast-path again immediately since alloc regions have already been refreshed;\n+  \/\/ 2. if any region of alloc regions is ready for refresh(retire), call refresh_alloc_regions to refresh;\n+  \/\/ 3. if allocation is still not satisfied in above steps, call attempt_allocation_from_free_set to find a region\n+  \/\/    in free set w\/ sufficient free space and allocate in the region;\n+  \/\/ 4. update accounting if needed;\n+  \/\/ Call must not hold heap lock.\n@@ -80,2 +87,2 @@\n-  \/\/   1. _alloc_region_count is explicitly set to 0 to disable CAS allocator;\n-  \/\/   2. all the shared alloc regions are not ready to retire, nor have enough space for allocation.\n+  \/\/ 1. All the shared alloc regions are not ready to retire, nor have enough space for allocation;\n+  \/\/ 2. There are regions can be retired, but the new regions reserved from free set don't have enough free space to satisfy the allocation.\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocator.hpp","additions":11,"deletions":4,"binary":false,"changes":15,"status":"modified"}]}