{"files":[{"patch":"@@ -148,1 +148,1 @@\n-  if (obj != nullptr) {\n+  if (obj != nullptr && regions_ready_for_refresh < _alloc_region_count \/ 2) {\n@@ -151,2 +151,11 @@\n-  \/\/ Slow path under heap lock\n-  return attempt_allocation_slow(req, in_new_region, regions_ready_for_refresh, old_epoch_id);\n+  if (obj == nullptr) {\n+    \/\/ Slow path under heap lock\n+    obj = attempt_allocation_slow(req, in_new_region, regions_ready_for_refresh, old_epoch_id);\n+  } else {\n+    \/\/ Eagerly refresh alloc region if there are 1\/2 or more of alloc regions ready for retire\n+    ShenandoahHeapLocker locker(ShenandoahHeap::heap()->lock(), _yield_to_safepoint);\n+    if (_epoch_id == old_epoch_id) {\n+      refresh_alloc_regions(nullptr, nullptr, nullptr);\n+    }\n+  }\n+  return obj;\n@@ -377,1 +386,4 @@\n-  log_debug(gc, alloc)(\"%sAllocator: Releasing all alloc regions\", _alloc_partition_name);\n+  if (_alloc_region_count == 0u) {\n+    \/\/ no-op if _alloc_region_count is 0\n+    return;\n+  }\n@@ -379,0 +391,1 @@\n+  log_debug(gc, alloc)(\"%sAllocator: Releasing all alloc regions\", _alloc_partition_name);\n@@ -415,0 +428,4 @@\n+  if (_alloc_region_count == 0u) {\n+    \/\/ no-op if _alloc_region_count is 0\n+    return;\n+  }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocator.cpp","additions":21,"deletions":4,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -60,1 +60,5 @@\n-  \/\/ start index of the shared alloc regions where the allocation will start from.\n+  \/\/ Start index of the shared alloc regions where the allocation will start from.\n+  \/\/ The alloc start index is stored in thread local data, each thread has it own start index to reduce contention.\n+  \/\/ The value is determined when this function is called at the first time from a thread.\n+  \/\/ For GC workers, the started index is calculated using worker id as: WorkerThread::worker_id() % _alloc_region_count;\n+  \/\/ for non GC worker, the value is calculated with random like: abs(os::random()) % _alloc_region_count.\n@@ -119,1 +123,4 @@\n-  \/\/ Handle the allocation request - entry point of memory allocation, including humongous allocation.\n+  \/\/ Handle the allocation request - it is the entry point of memory allocation, including humongous allocation:\n+  \/\/ 1. for humongous allocation, it delegates to function ShenandoahFreeSet::allocate_contiguous;\n+  \/\/ 2. for others allocations, it calls function attempt_allocation.\n+  \/\/ Caller does not hold the heap lock.\n@@ -153,2 +160,0 @@\n-  void release_alloc_regions() override { \/* nothing to release*\/ }\n-  void reserve_alloc_regions() override { \/* no need to reserve any alloc region*\/}\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahAllocator.hpp","additions":9,"deletions":4,"binary":false,"changes":13,"status":"modified"}]}