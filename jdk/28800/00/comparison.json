{"files":[{"patch":"@@ -87,0 +87,1 @@\n+    private static final SSLContext serverSSLCtx = SimpleSSLContext.findSSLContext();\n@@ -171,2 +172,0 @@\n-        final SSLContext serverSSLCtx = new SimpleSSLContext().get();\n-        assertNotNull(serverSSLCtx, \"could not create SSLContext\");\n@@ -279,2 +278,0 @@\n-        final SSLContext serverSSLCtx = new SimpleSSLContext().get();\n-        assertNotNull(serverSSLCtx, \"could not create SSLContext\");\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/HttpsParametersClientAuthTest.java","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -76,1 +76,1 @@\n-    static SSLContext ctx;\n+    private static final SSLContext ctx = SimpleSSLContext.findSSLContext();\n@@ -125,1 +125,0 @@\n-            ctx = new SimpleSSLContext().get();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/SANTest.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -62,1 +62,1 @@\n-    static SSLContext ctx;\n+    private static final SSLContext ctx = SimpleSSLContext.findSSLContext();\n@@ -87,1 +87,0 @@\n-            ctx = new SimpleSSLContext().get();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/SelCacheTest.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -72,1 +72,1 @@\n-    static SSLContext ctx;\n+    private static final SSLContext ctx = SimpleSSLContext.findSSLContext();\n@@ -97,1 +97,0 @@\n-            ctx = new SimpleSSLContext().get();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/Test1.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-    static SSLContext ctx;\n+    private static final SSLContext ctx = SimpleSSLContext.findSSLContext();\n@@ -80,1 +80,0 @@\n-            ctx = new SimpleSSLContext().get();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/Test12.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -62,1 +62,1 @@\n-    static SSLContext ctx;\n+    private static final SSLContext ctx = SimpleSSLContext.findSSLContext();\n@@ -90,1 +90,0 @@\n-            ctx = new SimpleSSLContext().get();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/Test13.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -24,1 +24,1 @@\n-\/**\n+\/*\n@@ -58,1 +58,1 @@\n-        SSLContext ssl = new SimpleSSLContext().get();\n+        SSLContext ssl = SimpleSSLContext.findSSLContext();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/Test6a.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -62,1 +62,1 @@\n-        SSLContext ssl = new SimpleSSLContext().get();\n+        SSLContext ssl = SimpleSSLContext.findSSLContext();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/Test7a.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -64,1 +64,1 @@\n-            SSLContext ssl = new SimpleSSLContext().get();\n+            SSLContext ssl = SimpleSSLContext.findSSLContext();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/Test8a.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -61,1 +61,1 @@\n-    static SSLContext ctx;\n+    private static final SSLContext ctx = SimpleSSLContext.findSSLContext();\n@@ -86,1 +86,0 @@\n-            ctx = new SimpleSSLContext().get();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/Test9.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -59,2 +59,2 @@\n-    static SSLContext serverCtx;\n-    static volatile SSLContext clientCtx = null;\n+    private static final SSLContext serverCtx = SimpleSSLContext.findSSLContext();\n+    private static final SSLContext clientCtx = SimpleSSLContext.findSSLContext();\n@@ -79,2 +79,0 @@\n-            serverCtx = new SimpleSSLContext().get();\n-            clientCtx = new SimpleSSLContext().get();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/Test9a.java","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -66,1 +66,1 @@\n-    SSLContext sslContext;\n+    private static final SSLContext sslContext = SimpleSSLContext.findSSLContext();\n@@ -80,1 +80,0 @@\n-        sslContext = new SimpleSSLContext().get();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/bugs\/HandlerConnectionClose.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2023, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -62,1 +62,1 @@\n-    SSLContext sslContext;\n+    private static final SSLContext sslContext = SimpleSSLContext.findSSLContext();\n@@ -72,1 +72,0 @@\n-        sslContext = new SimpleSSLContext().get();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/simpleserver\/HttpsServerAlertTest.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2021, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -70,1 +70,1 @@\n-    SSLContext sslContext;\n+    private static final SSLContext sslContext = SimpleSSLContext.findSSLContext();\n@@ -80,1 +80,0 @@\n-        sslContext = new SimpleSSLContext().get();\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/simpleserver\/HttpsServerTest.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -81,1 +81,1 @@\n-    static SSLContext sslContext;\n+    private static final SSLContext sslContext = SimpleSSLContext.findSSLContext();\n@@ -89,4 +89,0 @@\n-\n-        sslContext = new SimpleSSLContext().get();\n-        if (sslContext == null)\n-            throw new AssertionError(\"Unexpected null sslContext\");\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/simpleserver\/jwebserver\/MaxRequestTimeTest.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -26,0 +26,2 @@\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n@@ -29,2 +31,0 @@\n-import java.security.cert.*;\n-import java.util.function.Supplier;\n@@ -34,3 +34,1 @@\n- * Creates a simple usable SSLContext for SSLSocketFactory\n- * or a HttpsServer using either a given keystore or a default\n- * one in the test tree.\n+ * Utility for creating a simple usable {@link SSLContext} for testing purposes.\n@@ -38,1 +36,1 @@\n-public class SimpleSSLContext {\n+public final class SimpleSSLContext {\n@@ -40,1 +38,15 @@\n-    SSLContext ssl;\n+    private static final String DEFAULT_PROTOCOL = \"TLS\";\n+\n+    private static final String DEFAULT_KEY_STORE_FILE_REL_PATH = \"jdk\/test\/lib\/net\/testkeys\";\n+\n+    private final SSLContext ssl;\n+\n+    \/\/ Made `public` for backward compatibility\n+    public SimpleSSLContext() throws IOException {\n+        this.ssl = findSSLContext(DEFAULT_KEY_STORE_FILE_REL_PATH, DEFAULT_PROTOCOL);\n+    }\n+\n+    \/\/ Kept for backward compatibility\n+    public SimpleSSLContext(String keyStoreFileRelPath) throws IOException {\n+        this.ssl = findSSLContext(Objects.requireNonNull(keyStoreFileRelPath), DEFAULT_PROTOCOL);\n+    }\n@@ -43,2 +55,5 @@\n-     * loads default keystore from SimpleSSLContext\n-     * source directory\n+     * {@return a new {@link SSLContext} instance by searching for a key store\n+     * file path, and loading the first found one}\n+     *\n+     * @throws RuntimeException if no key store file can be found or the found\n+     * one cannot be loaded\n@@ -46,2 +61,2 @@\n-    public SimpleSSLContext() throws IOException {\n-        this(() -> \"TLS\");\n+    public static SSLContext findSSLContext() {\n+        return findSSLContext(DEFAULT_PROTOCOL);\n@@ -50,14 +65,13 @@\n-    private SimpleSSLContext(Supplier<String> protocols) throws IOException {\n-        String proto = protocols.get();\n-        String paths = System.getProperty(\"test.src.path\");\n-        StringTokenizer st = new StringTokenizer(paths, File.pathSeparator);\n-        while (st.hasMoreTokens()) {\n-            String path = st.nextToken();\n-            File f = new File(path, \"jdk\/test\/lib\/net\/testkeys\");\n-            if (f.exists()) {\n-                try (FileInputStream fis = new FileInputStream(f)) {\n-                    init(fis, proto);\n-                    break;\n-                }\n-            }\n-        }\n+    \/**\n+     * {@return a new {@link SSLContext} instance by searching for a key store\n+     * file path, and loading the first found one}\n+     *\n+     * @param protocol an {@link SSLContext} protocol\n+     *\n+     * @throws NullPointerException if {@code protocol} is null\n+     * @throws RuntimeException if no key store file can be found or the found\n+     * one cannot be loaded\n+     *\/\n+    public static SSLContext findSSLContext(String protocol) {\n+        Objects.requireNonNull(protocol);\n+        return findSSLContext(DEFAULT_KEY_STORE_FILE_REL_PATH, protocol);\n@@ -67,1 +81,11 @@\n-     * loads default keystore from given directory\n+     * {@return a new {@link SSLContext} instance by searching for a key store\n+     * file path, and loading the first found one}\n+     *\n+     * @param keyStoreFileRelPath a key store file path to be concatenated with\n+     *                            the search path(s) obtained from the\n+     *                            {@code test.src.path} system property\n+     * @param protocol an {@link SSLContext} protocol\n+     *\n+     * @throws NullPointerException if {@code keyStoreFileRelPath} or {@code protocol} is null\n+     * @throws RuntimeException if no key store file can be found or the found\n+     * one cannot be loaded\n@@ -69,4 +93,9 @@\n-    public SimpleSSLContext(String dir) throws IOException {\n-        String file = dir + \"\/testkeys\";\n-        try (FileInputStream fis = new FileInputStream(file)) {\n-            init(fis, \"TLS\");\n+    public static SSLContext findSSLContext(String keyStoreFileRelPath, String protocol) {\n+        Objects.requireNonNull(keyStoreFileRelPath);\n+        Objects.requireNonNull(protocol);\n+        var sourcePaths = System.getProperty(\"test.src.path\");\n+        for (var sourcePath : Collections.list(new StringTokenizer(sourcePaths, File.pathSeparator))) {\n+            var keyStoreFileAbsPath = Path.of((String) sourcePath, keyStoreFileRelPath);\n+            if (Files.exists(keyStoreFileAbsPath)) {\n+                return loadSSLContext(keyStoreFileAbsPath, protocol);\n+            }\n@@ -74,0 +103,3 @@\n+        throw new RuntimeException(\n+                \"Could not find any key store at source path(s) '%s' using key store file relative path '%s'\".formatted(\n+                        sourcePaths, keyStoreFileRelPath));\n@@ -76,2 +108,11 @@\n-    private void init(InputStream i, String protocol) throws IOException {\n-        try {\n+    \/**\n+     * {@return a new {@link SSLContext} loaded from the provided key store file\n+     * path using the given protocol}\n+     *\n+     * @param keyStoreFilePath a {@link KeyStore} file path\n+     * @param protocol an {@link SSLContext} protocol\n+     *\n+     * @throws RuntimeException if loading fails\n+     *\/\n+    private static SSLContext loadSSLContext(Path keyStoreFilePath, String protocol) {\n+        try (var storeStream = Files.newInputStream(keyStoreFilePath)) {\n@@ -80,1 +121,1 @@\n-            ks.load(i, passphrase);\n+            ks.load(storeStream, passphrase);\n@@ -88,6 +129,7 @@\n-            ssl = SSLContext.getInstance(protocol);\n-            ssl.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);\n-        } catch (KeyManagementException | KeyStoreException |\n-                UnrecoverableKeyException | CertificateException |\n-                NoSuchAlgorithmException e) {\n-            throw new RuntimeException(e.getMessage());\n+            var sslContext = SSLContext.getInstance(protocol);\n+            sslContext.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);\n+            return sslContext;\n+        } catch (Exception e) {\n+            var message = \"Failed loading 'SSLContext' from key store at location '%s' for protocol '%s'\".formatted(\n+                    keyStoreFilePath, protocol);\n+            throw new RuntimeException(message, e);\n@@ -97,0 +139,1 @@\n+    \/\/ Kept for backward compatibility\n@@ -98,5 +141,6 @@\n-        if(protocol == null || protocol.isEmpty()) {\n-            return new SimpleSSLContext().get();\n-        }\n-        else {\n-            return new SimpleSSLContext(() -> protocol).get();\n+        try {\n+            return protocol == null || protocol.isEmpty()\n+                    ? findSSLContext()\n+                    : findSSLContext(protocol);\n+        } catch (RuntimeException re) {\n+            throw new IOException(re);\n@@ -106,0 +150,1 @@\n+    \/\/ Kept for backward compatibility\n@@ -109,0 +154,1 @@\n+\n","filename":"test\/lib\/jdk\/test\/lib\/net\/SimpleSSLContext.java","additions":90,"deletions":44,"binary":false,"changes":134,"status":"modified"}]}