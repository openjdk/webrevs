{"files":[{"patch":"@@ -280,8 +280,0 @@\n-            if (options.modulePath.isEmpty()) {\n-                \/\/ no --module-path specified - try to set $JAVA_HOME\/jmods if that exists\n-                Path jmods = getDefaultModulePath();\n-                if (jmods != null) {\n-                    options.modulePath.add(jmods);\n-                }\n-            }\n-\n@@ -380,0 +372,4 @@\n+        \/\/ Empty module path not allowed with ALL-MODULE-PATH in --add-modules\n+        if (options.addMods.contains(ALL_MODULE_PATH) && options.modulePath.isEmpty()) {\n+            throw taskHelper.newBadArgs(\"err.no.module.path\");\n+        }\n@@ -382,0 +378,1 @@\n+\n@@ -396,2 +393,3 @@\n-                options.modulePath.add(defModPath);\n-                finder = newModuleFinder(options.modulePath);\n+                List<Path> combinedPaths = new ArrayList<>(options.modulePath);\n+                combinedPaths.add(defModPath);\n+                finder = newModuleFinder(combinedPaths);\n@@ -422,2 +420,24 @@\n-                ModuleFinder mf = newLimitedFinder(finder, options.limitMods,\n-                                              Set.of());\n+                \/\/ all observable modules in the app module path are roots\n+                Set<String> initialRoots = appModuleFinder.findAll()\n+                        .stream()\n+                        .map(ModuleReference::descriptor)\n+                        .map(ModuleDescriptor::name)\n+                        .collect(Collectors.toSet());\n+\n+                \/\/ Error if no module is found on the app module path\n+                if (initialRoots.isEmpty()) {\n+                    String modPath = options.modulePath.stream()\n+                            .map(a -> a.toString())\n+                            .collect(Collectors.joining(\", \"));\n+                    throw taskHelper.newBadArgs(\"err.empty.module.path\", modPath);\n+                }\n+\n+                \/\/ Use a module finder with limited observability, as determined\n+                \/\/ by initialRoots, to find the observable modules from the\n+                \/\/ application module path (--module-path option) only. We must\n+                \/\/ not include JDK modules from the default module path or the\n+                \/\/ run-time image. Only do this if no --limit-modules has been\n+                \/\/ specified to begin with.\n+                ModuleFinder mf = newLimitedFinder(finder,\n+                                                   options.limitMods.isEmpty() ? initialRoots : options.limitMods,\n+                                                   Set.of());\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/JlinkTask.java","additions":32,"deletions":12,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -130,1 +130,2 @@\n-err.empty.module.path=empty module path\n+err.no.module.path=--module-path option must be specified with --add-modules ALL-MODULE-PATH\n+err.empty.module.path=No module found in module path ''{0}'' with --add-modules ALL-MODULE-PATH\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/resources\/jlink.properties","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -30,1 +30,0 @@\n-import java.nio.file.Paths;\n@@ -32,1 +31,0 @@\n-import java.util.Collections;\n@@ -39,1 +37,0 @@\n-import jdk.tools.jlink.plugin.Plugin;\n@@ -41,0 +38,1 @@\n+import jdk.tools.jlink.plugin.Plugin;\n@@ -138,1 +136,1 @@\n-            String imageDir = \"bug8189777-all-module-path\";\n+            String imageDir = \"bug8345259-all-module-path\";\n@@ -142,1 +140,1 @@\n-                    .call().assertSuccess();\n+                    .call().assertFailure();\n","filename":"test\/jdk\/tools\/jlink\/JLinkTest.java","additions":3,"deletions":5,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -24,10 +24,2 @@\n-\/*\n- * @test\n- * @summary jlink test of --add-module ALL-MODULE-PATH\n- * @library \/test\/lib\n- * @modules jdk.compiler\n- * @build jdk.test.lib.process.ProcessTools\n- *        jdk.test.lib.process.OutputAnalyzer\n- *        jdk.test.lib.compiler.CompilerUtils\n- * @run testng AllModulePath\n- *\/\n+import static org.testng.Assert.assertEquals;\n+import static org.testng.Assert.assertTrue;\n@@ -35,1 +27,1 @@\n-import java.io.File;\n+import java.io.ByteArrayOutputStream;\n@@ -41,1 +33,0 @@\n-import java.nio.file.attribute.BasicFileAttributes;\n@@ -43,1 +34,0 @@\n-import java.util.Arrays;\n@@ -47,2 +37,0 @@\n-import java.util.stream.Collectors;\n-import java.util.stream.Stream;\n@@ -50,3 +38,1 @@\n-\n-import jdk.test.lib.compiler.CompilerUtils;\n-import jdk.test.lib.process.ProcessTools;\n+import java.util.stream.Collectors;\n@@ -56,1 +42,0 @@\n-import static org.testng.Assert.*;\n@@ -58,0 +43,21 @@\n+import jdk.test.lib.compiler.CompilerUtils;\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+import jdk.tools.jlink.internal.LinkableRuntimeImage;\n+import tests.Helper;\n+import tests.Result;\n+\n+\/*\n+ * @test\n+ * @bug 8345259\n+ * @summary jlink test of --add-module ALL-MODULE-PATH\n+ * @library ..\/..\/lib \/test\/lib\n+ * @modules jdk.compiler\n+ *          java.base\/jdk.internal.jimage\n+ *          jdk.jlink\/jdk.tools.jlink.internal\n+ *          jdk.jlink\/jdk.tools.jimage\n+ * @build jdk.test.lib.process.ProcessTools\n+ *        jdk.test.lib.process.OutputAnalyzer\n+ *        jdk.test.lib.compiler.CompilerUtils\n+ * @run testng\/othervm -Duser.language=en -Duser.country=US AllModulePath\n+ *\/\n@@ -60,3 +66,5 @@\n-    private final Path JMODS = Paths.get(System.getProperty(\"test.jdk\")).resolve(\"jmods\");\n-    private final Path SRC = Paths.get(System.getProperty(\"test.src\")).resolve(\"src\");\n-    private final Path MODS = Paths.get(\"mods\");\n+    private static final Path JMODS = Paths.get(System.getProperty(\"test.jdk\")).resolve(\"jmods\");\n+    private static final Path SRC = Paths.get(System.getProperty(\"test.src\")).resolve(\"src\");\n+    private static final Path MODS = Paths.get(\"mods\");\n+    private static final boolean LINKABLE_RUNTIME = LinkableRuntimeImage.isLinkableRuntime();\n+    private static final boolean JMODS_EXIST = Files.exists(JMODS);\n@@ -70,0 +78,9 @@\n+    private static Helper HELPER;\n+\n+    private static boolean isExplodedJDKImage() {\n+        if (!JMODS_EXIST && !LINKABLE_RUNTIME) {\n+            System.err.println(\"Test skipped. Not a linkable runtime and no JMODs\");\n+            return true;\n+        }\n+        return false;\n+    }\n@@ -73,1 +90,1 @@\n-        if (Files.notExists(JMODS)) {\n+        if (isExplodedJDKImage()) {\n@@ -76,0 +93,1 @@\n+        HELPER = Helper.newHelper(LINKABLE_RUNTIME);\n@@ -87,0 +105,3 @@\n+    \/*\n+     * --add-modules ALL-MODULE-PATH with an existing module-path.\n+     *\/\n@@ -89,1 +110,1 @@\n-        if (Files.notExists(JMODS)) {\n+        if (isExplodedJDKImage()) {\n@@ -93,3 +114,5 @@\n-        \/\/ create custom image\n-        Path image = Paths.get(\"image\");\n-        createImage(image, \"--add-modules\", \"ALL-MODULE-PATH\");\n+        Path image = HELPER.createNewImageDir(\"image\");\n+        List<String> opts = List.of(\"--module-path\", MODS.toString(),\n+                                    \"--output\", image.toString(),\n+                                    \"--add-modules\", \"ALL-MODULE-PATH\");\n+        createImage(image, opts, true \/* success *\/);\n@@ -98,5 +121,2 @@\n-        Files.find(JMODS, 1, (Path p, BasicFileAttributes attr) ->\n-                                p.toString().endsWith(\".jmod\"))\n-             .map(p -> JMODS.relativize(p).toString())\n-             .map(n -> n.substring(0, n.length()-5))\n-             .forEach(modules::add);\n+        \/\/ java.base is a dependency of any external module\n+        modules.add(\"java.base\");\n@@ -108,0 +128,4 @@\n+    \/*\n+     * --add-modules ALL-MODULE-PATH with an existing module path and module\n+     * limits applied. Module limit on module from module path.\n+     *\/\n@@ -110,1 +134,1 @@\n-        if (Files.notExists(JMODS)) {\n+        if (isExplodedJDKImage()) {\n@@ -115,4 +139,6 @@\n-        Path image = Paths.get(\"image1\");\n-        createImage(image,\n-                    \"--add-modules\", \"ALL-MODULE-PATH\",\n-                    \"--limit-modules\", \"m1\");\n+        Path image = HELPER.createNewImageDir(\"image1\");\n+        List<String> opts = List.of(\"--module-path\", MODS.toString(),\n+                                    \"--output\", image.toString(),\n+                                    \"--add-modules\", \"ALL-MODULE-PATH\",\n+                                    \"--limit-modules\", \"m1\");\n+        createImage(image, opts, true \/* success *\/);\n@@ -123,0 +149,5 @@\n+    \/*\n+     * --add-modules *includes* ALL-MODULE-PATH with an existing module path\n+     * and module limits applied. Module limit on a dependency, but custom\n+     * modules explicitly listed (therefore, expect inclusion of them).\n+     *\/\n@@ -125,1 +156,1 @@\n-        if (Files.notExists(JMODS)) {\n+        if (isExplodedJDKImage()) {\n@@ -130,5 +161,7 @@\n-        Path image = Paths.get(\"image2\");\n-        createImage(image,\n-                    \"--add-modules\", \"m1,test\",\n-                    \"--add-modules\", \"ALL-MODULE-PATH\",\n-                    \"--limit-modules\", \"java.base\");\n+        Path image = HELPER.createNewImageDir(\"image2\");\n+        List<String> opts = List.of(\"--module-path\", MODS.toString(),\n+                                    \"--output\", image.toString(),\n+                                    \"--add-modules\", \"m1,test\",\n+                                    \"--add-modules\", \"ALL-MODULE-PATH\",\n+                                    \"--limit-modules\", \"java.base\");\n+        createImage(image, opts, true \/* success *\/);\n@@ -140,1 +173,67 @@\n-     * check the modules linked in the image\n+     * No --module-path with --add-modules ALL-MODULE-PATH is an error.\n+     *\/\n+    @Test\n+    public void noModulePath() throws IOException {\n+        if (isExplodedJDKImage()) {\n+            return;\n+        }\n+        Path targetPath = HELPER.createNewImageDir(\"all-mod-path-no-mod-path\");\n+        List<String> allArgs = List.of(\"--add-modules\", \"ALL-MODULE-PATH\",\n+                                       \"--output\", targetPath.toString());\n+        JlinkOutput allOut = createImage(targetPath, allArgs, false \/* expect failure *\/);\n+        String expected = \"Error: --module-path option must be specified with --add-modules ALL-MODULE-PATH\";\n+        assertEquals(allOut.stdout.trim(), expected);\n+    }\n+\n+    \/*\n+     * --module-path not-exist and --add-modules ALL-MODULE-PATH is an error.\n+     *\/\n+    @Test\n+    public void modulePathEmpty() throws IOException {\n+        if (isExplodedJDKImage()) {\n+            return;\n+        }\n+        Path targetPath = HELPER.createNewImageDir(\"all-mod-path-not-existing\");\n+        String strNotExists = \"not-exist\";\n+        Path notExists = Path.of(strNotExists);\n+        if (Files.exists(notExists)) {\n+            throw new RuntimeException(\"Test setup error, path must not exist!\");\n+        }\n+        List<String> allArgs = List.of(\"--add-modules\", \"ALL-MODULE-PATH\",\n+                                       \"--module-path\", notExists.toString(),\n+                                       \"--output\", targetPath.toString());\n+\n+        JlinkOutput allOut = createImage(targetPath, allArgs, false \/* expect failure *\/);\n+        String actual = allOut.stdout.trim();\n+        assertTrue(actual.startsWith(\"Error: No module found in module path\"));\n+        assertTrue(actual.contains(strNotExists));\n+    }\n+\n+    \/*\n+     * --add-modules ALL-MODULE-PATH with an existing module path and module\n+     * limits applied. This case test a module limit on a dependency, jdk.jfr,\n+     * and *doesn't* list the module explicitly in --add-modules. Therefore,\n+     * expects for the module - on the module path - to be not be present.\n+     *\/\n+    @Test\n+    public void modulePathWithLimitMods() throws Exception {\n+        if (isExplodedJDKImage()) {\n+            return;\n+        }\n+        Path targetPath = HELPER.createNewImageDir(\"all-mods-limit-mods\");\n+        String moduleName = \"com.baz.runtime\";\n+        Result result = HELPER.generateDefaultJModule(moduleName, \"jdk.jfr\");\n+        Path customModulePath = result.getFile().getParent();\n+        List<String> allArgs = List.of(\"--add-modules\", \"ALL-MODULE-PATH\",\n+                                       \"--limit-modules\", \"jdk.jfr\", \/\/ A dependency of com.baz.runtime\n+                                       \"--module-path\", customModulePath.toString(),\n+                                       \"--output\", targetPath.toString());\n+        JlinkOutput allOut = createImage(targetPath, allArgs, true \/* success *\/);\n+        assertTrue(allOut.stdout.isEmpty());\n+        assertTrue(allOut.stderr.isEmpty());\n+        List<String> expected = List.of(\"java.base\", \"jdk.jfr\");\n+        verifyListModules(targetPath, expected);\n+    }\n+\n+    \/*\n+     * check the modules linked in the image using m1\/p.ListModules\n@@ -156,0 +255,15 @@\n+    \/*\n+     * Verify linked modules using java --list-modules\n+     *\/\n+    private void verifyListModules(Path targetPath, List<String> expected) throws Exception {\n+        Path java = findTool(targetPath, \"java\");\n+        List<String> listMods = List.of(java.toString(), \"--list-modules\");\n+        OutputAnalyzer out = ProcessTools.executeCommand(listMods.toArray(new String[] {}))\n+                                         .shouldHaveExitValue(0);\n+        List<String> actual = out.asLines().stream()\n+                                 .map(s -> { return s.split(\"@\")[0]; })\n+                                 .sorted()\n+                                 .toList();\n+        assertEquals(actual, expected);\n+    }\n+\n@@ -167,11 +281,12 @@\n-    private void createImage(Path image, String... options) throws IOException {\n-        String modulepath = JMODS.toString() + File.pathSeparator + MODS.toString();\n-        List<String> opts = List.of(\"--module-path\", modulepath,\n-                                    \"--output\", image.toString());\n-        String[] args = Stream.concat(opts.stream(), Arrays.stream(options))\n-                              .toArray(String[]::new);\n-\n-        System.out.println(\"jlink \" + Arrays.stream(args).collect(Collectors.joining(\" \")));\n-        PrintWriter pw = new PrintWriter(System.out);\n-        int rc = JLINK_TOOL.run(pw, pw, args);\n-        assertTrue(rc == 0);\n+    private JlinkOutput createImage(Path image, List<String> args, boolean success) throws IOException {\n+        System.out.println(\"jlink \" + args.stream().collect(Collectors.joining(\" \")));\n+\n+        ByteArrayOutputStream baos = new ByteArrayOutputStream();\n+        PrintWriter out = new PrintWriter(baos);\n+        ByteArrayOutputStream berrOs = new ByteArrayOutputStream();\n+        PrintWriter err = new PrintWriter(berrOs);\n+        int rc = JLINK_TOOL.run(out, err, args.toArray(String[]::new));\n+        assertEquals(rc == 0, success);\n+        String stdOut = new String(baos.toByteArray());\n+        String stdErr = new String(berrOs.toByteArray());\n+        return new JlinkOutput(stdErr, stdOut);\n@@ -179,0 +294,2 @@\n+\n+    private static record JlinkOutput(String stderr, String stdout) {};\n","filename":"test\/jdk\/tools\/jlink\/basic\/AllModulePath.java","additions":172,"deletions":55,"binary":false,"changes":227,"status":"modified"},{"patch":"@@ -24,15 +24,0 @@\n-\/*\n- * @test\n- * @summary Basic test of jlink to create jmods and images\n- * @author Andrei Eremeev\n- * @library \/test\/lib\n- * @modules java.base\/jdk.internal.module\n- *          jdk.jlink\n- *          jdk.compiler\n- * @build jdk.test.lib.process.ProcessTools\n- *        jdk.test.lib.process.OutputAnalyzer\n- *        jdk.test.lib.compiler.CompilerUtils\n- *        jdk.test.lib.util.JarUtils\n- * @run main BasicTest\n- *\/\n-\n@@ -53,0 +38,1 @@\n+import jdk.tools.jlink.internal.LinkableRuntimeImage;\n@@ -54,0 +40,14 @@\n+\/*\n+ * @test\n+ * @summary Basic test of jlink to create jmods and images\n+ * @author Andrei Eremeev\n+ * @library \/test\/lib\n+ * @modules java.base\/jdk.internal.module\n+ *          jdk.jlink\/jdk.tools.jlink.internal\n+ *          jdk.compiler\n+ * @build jdk.test.lib.process.ProcessTools\n+ *        jdk.test.lib.process.OutputAnalyzer\n+ *        jdk.test.lib.compiler.CompilerUtils\n+ *        jdk.test.lib.util.JarUtils\n+ * @run main\/othervm BasicTest\n+ *\/\n@@ -65,8 +65,10 @@\n-    private final String TEST_MODULE = \"test\";\n-    private final Path jdkHome = Paths.get(System.getProperty(\"test.jdk\"));\n-    private final Path jdkMods = jdkHome.resolve(\"jmods\");\n-    private final Path testSrc = Paths.get(System.getProperty(\"test.src\"));\n-    private final Path src = testSrc.resolve(\"src\").resolve(TEST_MODULE);\n-    private final Path classes = Paths.get(\"classes\");\n-    private final Path jmods = Paths.get(\"jmods\");\n-    private final Path jars = Paths.get(\"jars\");\n+    private static final String TEST_MODULE = \"test\";\n+    private static final Path jdkHome = Paths.get(System.getProperty(\"test.jdk\"));\n+    private static final Path jdkMods = jdkHome.resolve(\"jmods\");\n+    private static final boolean JMODS_EXIST = Files.exists(jdkMods);\n+    private static final boolean LINKABLE_RUNTIME = LinkableRuntimeImage.isLinkableRuntime();\n+    private static final Path testSrc = Paths.get(System.getProperty(\"test.src\"));\n+    private static final Path src = testSrc.resolve(\"src\").resolve(TEST_MODULE);\n+    private static final Path classes = Paths.get(\"classes\");\n+    private static final Path jmods = Paths.get(\"jmods\");\n+    private static final Path jars = Paths.get(\"jars\");\n@@ -78,0 +80,8 @@\n+    private static boolean isExplodedJDKImage() {\n+        if (!JMODS_EXIST && !LINKABLE_RUNTIME) {\n+            System.err.println(\"Test skipped. Not a linkable runtime and no JMODs\");\n+            return true;\n+        }\n+        return false;\n+    }\n+\n@@ -79,1 +89,1 @@\n-        if (Files.notExists(jdkMods)) {\n+        if (isExplodedJDKImage()) {\n@@ -149,0 +159,2 @@\n+        String modPathArg = (JMODS_EXIST ? jdkMods + File.pathSeparator : \"\") +\n+                                jmods;\n@@ -150,1 +162,1 @@\n-                \"--module-path\", jdkMods + File.pathSeparator + jmods,\n+                \"--module-path\", modPathArg,\n","filename":"test\/jdk\/tools\/jlink\/basic\/BasicTest.java","additions":37,"deletions":25,"binary":false,"changes":62,"status":"modified"}]}