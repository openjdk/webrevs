{"files":[{"patch":"@@ -36,1 +36,1 @@\n-G1HeapRegion* G1AllocRegion::_dummy_region = nullptr;\n+Atomic<G1HeapRegion*> G1AllocRegion::_dummy_region;\n@@ -39,1 +39,1 @@\n-  assert(_dummy_region == nullptr, \"should be set once\");\n+  assert(_dummy_region.load_relaxed() == nullptr, \"should be set once\");\n@@ -49,1 +49,1 @@\n-  _dummy_region = dummy_region;\n+  _dummy_region.release_store(dummy_region);\n@@ -53,1 +53,1 @@\n-  assert(alloc_region != nullptr && alloc_region != _dummy_region,\n+  assert(alloc_region != nullptr && alloc_region != _dummy_region.load_relaxed(),\n@@ -114,1 +114,1 @@\n-  assert_alloc_region(_alloc_region != nullptr, \"not initialized properly\");\n+  assert_alloc_region(_alloc_region.load_relaxed() != nullptr, \"not initialized properly\");\n@@ -119,2 +119,2 @@\n-  G1HeapRegion* alloc_region = _alloc_region;\n-  if (alloc_region != _dummy_region) {\n+  G1HeapRegion* alloc_region = _alloc_region.load_acquire();\n+  if (alloc_region != _dummy_region.load_relaxed()) {\n@@ -130,1 +130,1 @@\n-  assert_alloc_region(_alloc_region == _dummy_region, \"pre-condition\");\n+  assert_alloc_region(_alloc_region.load_relaxed() == _dummy_region.load_relaxed(), \"pre-condition\");\n@@ -141,1 +141,0 @@\n-    OrderAccess::storestore();\n@@ -157,3 +156,3 @@\n-  assert_alloc_region(_alloc_region == nullptr, \"pre-condition\");\n-  assert_alloc_region(_dummy_region != nullptr, \"should have been set\");\n-  _alloc_region = _dummy_region;\n+  assert_alloc_region(_alloc_region.load_relaxed() == nullptr, \"pre-condition\");\n+  assert_alloc_region(_dummy_region.load_relaxed() != nullptr, \"should have been set\");\n+  _alloc_region.release_store(_dummy_region.load_relaxed());\n@@ -166,1 +165,1 @@\n-  assert_alloc_region(_alloc_region == _dummy_region && _count == 0, \"pre-condition\");\n+  assert_alloc_region(_alloc_region.load_relaxed() == _dummy_region.load_relaxed() && _count == 0, \"pre-condition\");\n@@ -178,1 +177,1 @@\n-  _alloc_region = alloc_region;\n+  _alloc_region.release_store(alloc_region);\n@@ -185,1 +184,1 @@\n-  G1HeapRegion* alloc_region = _alloc_region;\n+  G1HeapRegion* alloc_region = _alloc_region.load_acquire();\n@@ -187,2 +186,2 @@\n-  assert_alloc_region(_alloc_region == _dummy_region, \"post-condition of retire()\");\n-  _alloc_region = nullptr;\n+  assert_alloc_region(_alloc_region.load_relaxed() == _dummy_region.load_relaxed(), \"post-condition of retire()\");\n+  _alloc_region.store_relaxed(nullptr);\n@@ -190,1 +189,1 @@\n-  return (alloc_region == _dummy_region) ? nullptr : alloc_region;\n+  return (alloc_region == _dummy_region.load_relaxed()) ? nullptr : alloc_region;\n@@ -214,1 +213,2 @@\n-    if (_alloc_region == nullptr) {\n+    G1HeapRegion* alloc_region = _alloc_region.load_acquire();\n+    if (alloc_region == nullptr) {\n@@ -216,1 +216,1 @@\n-    } else if (_alloc_region == _dummy_region) {\n+    } else if (alloc_region == _dummy_region.load_relaxed()) {\n@@ -219,1 +219,1 @@\n-      out->print(HR_FORMAT, HR_FORMAT_PARAMS(_alloc_region));\n+      out->print(HR_FORMAT, HR_FORMAT_PARAMS(alloc_region));\n@@ -238,1 +238,1 @@\n-  : _alloc_region(nullptr),\n+  : _alloc_region(),\n@@ -253,1 +253,1 @@\n-  assert(_retained_alloc_region == nullptr, \"Pre-condition\");\n+  assert(_retained_alloc_region.load_relaxed() == nullptr, \"Pre-condition\");\n@@ -264,2 +264,3 @@\n-  if (_retained_alloc_region != nullptr &&\n-      free_bytes < _retained_alloc_region->free()) {\n+  G1HeapRegion* retained_alloc_region = _retained_alloc_region.load_acquire();\n+  if (retained_alloc_region != nullptr &&\n+      free_bytes < retained_alloc_region->free()) {\n@@ -281,2 +282,3 @@\n-      if (_retained_alloc_region != nullptr) {\n-        waste = retire_internal(_retained_alloc_region, true);\n+      G1HeapRegion* retained_alloc_region = _retained_alloc_region.load_acquire();\n+      if (retained_alloc_region != nullptr) {\n+        waste = retire_internal(retained_alloc_region, true);\n@@ -284,1 +286,1 @@\n-      _retained_alloc_region = current_region;\n+      _retained_alloc_region.release_store(current_region);\n@@ -303,1 +305,1 @@\n-  hr = _retained_alloc_region;\n+  hr = _retained_alloc_region.load_acquire();\n@@ -316,3 +318,4 @@\n-  if (_retained_alloc_region != nullptr) {\n-    _wasted_bytes += retire_internal(_retained_alloc_region, false);\n-    _retained_alloc_region = nullptr;\n+  G1HeapRegion* retained_alloc_region = _retained_alloc_region.load_acquire();\n+  if (retained_alloc_region != nullptr) {\n+    _wasted_bytes += retire_internal(retained_alloc_region, false);\n+    _retained_alloc_region.store_relaxed(nullptr);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1AllocRegion.cpp","additions":35,"deletions":32,"binary":false,"changes":67,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+#include \"runtime\/atomic.hpp\"\n@@ -43,2 +44,0 @@\n-\n-private:\n@@ -55,1 +54,1 @@\n-  G1HeapRegion* volatile _alloc_region;\n+  Atomic<G1HeapRegion*> _alloc_region;\n@@ -74,1 +73,1 @@\n-  static G1HeapRegion* _dummy_region;\n+  static Atomic<G1HeapRegion*> _dummy_region;\n@@ -127,1 +126,1 @@\n-    G1HeapRegion * hr = _alloc_region;\n+    G1HeapRegion * hr = _alloc_region.load_acquire();\n@@ -129,1 +128,1 @@\n-    return (hr == _dummy_region) ? nullptr : hr;\n+    return (hr == _dummy_region.load_relaxed()) ? nullptr : hr;\n@@ -180,1 +179,1 @@\n-  G1HeapRegion* volatile _retained_alloc_region;\n+  Atomic<G1HeapRegion*> _retained_alloc_region;\n","filename":"src\/hotspot\/share\/gc\/g1\/g1AllocRegion.hpp","additions":6,"deletions":7,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -35,1 +35,1 @@\n-           _name, (message), _count, p2i(_alloc_region)                  \\\n+           _name, (message), _count, p2i(_alloc_region.load_relaxed())   \\\n@@ -41,1 +41,1 @@\n-  _alloc_region = _dummy_region;\n+  _alloc_region.store_relaxed(_dummy_region.load_relaxed());\n@@ -54,1 +54,1 @@\n-  G1HeapRegion* alloc_region = _alloc_region;\n+  G1HeapRegion* alloc_region = _alloc_region.load_acquire();\n@@ -100,2 +100,3 @@\n-  if (_retained_alloc_region != nullptr) {\n-    HeapWord* result = _retained_alloc_region->par_allocate(min_word_size, desired_word_size, actual_word_size);\n+  G1HeapRegion* retained_alloc_region = _retained_alloc_region.load_acquire();\n+  if (retained_alloc_region != nullptr) {\n+    HeapWord* result = retained_alloc_region->par_allocate(min_word_size, desired_word_size, actual_word_size);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1AllocRegion.inline.hpp","additions":6,"deletions":5,"binary":false,"changes":11,"status":"modified"}]}