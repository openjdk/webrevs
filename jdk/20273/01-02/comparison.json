{"files":[{"patch":"@@ -694,0 +694,1 @@\n+        static final MethodTypeDesc STR_GET_BYTES = MethodTypeDesc.of(CD_void, CD_byteArray, CD_int, CD_byte);\n@@ -709,0 +710,1 @@\n+            lookup = JLA.stringConcatLookup();\n@@ -735,0 +737,5 @@\n+                    if (args.parameterCount() <= HIGH_ARITY_THRESHOLD) {\n+                        acceptInlineCopy(cb);\n+                        return;\n+                    }\n+\n@@ -815,3 +822,3 @@\n-                    int INIT_CODER = argSlots + strings;\n-                    int INIT_INDEX = argSlots + strings + 1;\n-                    int BUF = argSlots + strings + 2;\n+                    int coderSlot = argSlots + strings;\n+                    int indexSlot = argSlots + strings + 1;\n+                    int bufSlot = argSlots + strings + 2;\n@@ -832,1 +839,1 @@\n-                    cb.istore(INIT_CODER);\n+                    cb.istore(coderSlot);\n@@ -857,2 +864,2 @@\n-                      .istore(INIT_INDEX)\n-                      .iload(INIT_CODER).i2b()\n+                      .istore(indexSlot)\n+                      .iload(coderSlot)\n@@ -860,11 +867,4 @@\n-                      .astore(BUF);\n-\n-                    if (constants[constants.length - 1] != null) {\n-                        cb.iload(INIT_INDEX)\n-                          .iload(INIT_CODER)\n-                          .aload(BUF)\n-                          .ldc(constants[constants.length - 1])\n-                          .invokestatic(STRING_CONCAT_HELPER, \"prepend\", PREPEND_STRING)\n-                          .istore(INIT_INDEX);\n-                    }\n-                    \/\/ paramSlots\n+                      .astore(bufSlot);\n+\n+                    prependConstant(cb, constants[constants.length - 1], bufSlot, indexSlot, coderSlot);\n+\n@@ -876,4 +876,3 @@\n-                        cb.iload(INIT_INDEX)\n-                          .iload(INIT_CODER)\n-                          .aload(BUF);\n-\n+                        cb.iload(indexSlot)\n+                          .iload(coderSlot)\n+                          .aload(bufSlot);\n@@ -893,1 +892,2 @@\n-                            cb.aload(argSlots + paramStrings[i])\n+                            int strVarSlot = argSlots + paramStrings[i];\n+                            cb.aload(strVarSlot)\n@@ -896,10 +896,3 @@\n-                        cb.istore(INIT_INDEX);\n-\n-                        if (constants[i] != null) {\n-                            cb.iload(INIT_INDEX)\n-                              .iload(INIT_CODER)\n-                              .aload(BUF)\n-                              .ldc(constants[i])\n-                              .invokestatic(STRING_CONCAT_HELPER, \"prepend\", PREPEND_STRING)\n-                              .istore(INIT_INDEX);\n-                        }\n+                        cb.istore(indexSlot);\n+\n+                        prependConstant(cb, constants[i], bufSlot, indexSlot, coderSlot);\n@@ -910,2 +903,2 @@\n-                      .aload(BUF)\n-                      .iload(INIT_CODER)\n+                      .aload(bufSlot)\n+                      .iload(coderSlot)\n@@ -916,0 +909,26 @@\n+                static void prependConstant(CodeBuilder cb, String constant, int bufSlot, int indexSlot, int coderSlot) {\n+                    if (constant == null) {\n+                        return;\n+                    }\n+                    if (constant.length() == 1) {\n+                        cb.iload(indexSlot)\n+                          .iload(coderSlot)\n+                          .aload(bufSlot)\n+                          .loadConstant((int) constant.charAt(0))\n+                          .invokestatic(STRING_CONCAT_HELPER, \"prepend\", PREPEND_CHAR)\n+                          .istore(indexSlot);\n+                        return;\n+                    }\n+\n+                    cb.iload(indexSlot)\n+                      .loadConstant(constant.length())\n+                      .isub()\n+                      .istore(indexSlot);\n+\n+                    cb.ldc(constant)\n+                       .aload(bufSlot)\n+                       .iload(indexSlot)\n+                       .iload(coderSlot)\n+                       .invokevirtual(CD_String, \"getBytes\", STR_GET_BYTES);\n+                }\n+\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/StringConcatFactory.java","additions":53,"deletions":34,"binary":false,"changes":87,"status":"modified"}]}