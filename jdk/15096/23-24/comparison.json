{"files":[{"patch":"@@ -27,0 +27,2 @@\n+#include <functional>\n+#include <memory>\n@@ -6359,2 +6361,1 @@\n-void AwtComponent::_SetParent(void * param)\n-{\n+void AwtComponent::_SetParent(void * param) {\n@@ -6362,7 +6363,4 @@\n-        JNIEnv *env = (JNIEnv *)JNU_GetEnv(jvm, JNI_VERSION_1_2);\n-        SetParentStruct *data = (SetParentStruct*) param;\n-        jobject self = data->component;\n-        jobject parent = data->parentComp;\n-\n-        AwtComponent *awtComponent = NULL;\n-        AwtComponent *awtParent = NULL;\n+        JNIEnv *env = (JNIEnv *) JNU_GetEnv(jvm, JNI_VERSION_1_2);\n+        std::unique_ptr<SetParentStruct> data(static_cast<SetParentStruct*>(param));\n+        std::unique_ptr<std::remove_pointer<jobject>::type, std::function<void (jobject)>> self(data->component, [&env] (jobject self) -> void { env->DeleteGlobalRef(self); });\n+        std::unique_ptr<std::remove_pointer<jobject>::type, std::function<void (jobject)>> parent(data->parentComp, [&env] (jobject parent) -> void { env->DeleteGlobalRef(parent); });\n@@ -6370,0 +6368,2 @@\n+        AwtComponent *awtComponent = nullptr;\n+        AwtComponent *awtParent = nullptr;\n@@ -6371,9 +6371,7 @@\n-        JNI_CHECK_PEER_GOTO(self, ret);\n-        awtComponent = (AwtComponent *)pData;\n-        JNI_CHECK_PEER_GOTO(parent, ret);\n-        awtParent = (AwtComponent *)pData;\n-\n-        HWND selfWnd;\n-        HWND parentWnd;\n-        selfWnd = awtComponent->GetHWnd();\n-        parentWnd = awtParent->GetHWnd();\n+        JNI_CHECK_PEER_RETURN(self.get());\n+        awtComponent = (AwtComponent *) pData;\n+        JNI_CHECK_PEER_RETURN(parent.get());\n+        awtParent = (AwtComponent *) pData;\n+\n+        HWND selfWnd = awtComponent->GetHWnd();\n+        HWND parentWnd = awtParent->GetHWnd();\n@@ -6385,4 +6383,0 @@\n-ret:\n-        env->DeleteGlobalRef(self);\n-        env->DeleteGlobalRef(parent);\n-        delete data;\n@@ -6540,2 +6534,1 @@\n-static void _GetInsets(void* param)\n-{\n+static void _GetInsets(void* param) {\n@@ -6544,2 +6537,2 @@\n-    GetInsetsStruct *gis = (GetInsetsStruct *)param;\n-    jobject self = gis->window;\n+    std::unique_ptr<GetInsetsStruct> gis(static_cast<GetInsetsStruct *>(param));\n+    std::unique_ptr<std::remove_pointer<jobject>::type, std::function<void (jobject)>> self(gis->window, [&env] (jobject self) -> void { env->DeleteGlobalRef(self); });\n@@ -6551,3 +6544,2 @@\n-    JNI_CHECK_PEER_GOTO(self, ret);\n-    AwtComponent *component;\n-    component = (AwtComponent *) pData;\n+    JNI_CHECK_PEER_RETURN(self.get());\n+    AwtComponent *component = (AwtComponent *) pData;\n@@ -6556,4 +6548,0 @@\n-\n-  ret:\n-    env->DeleteGlobalRef(self);\n-    delete gis;\n","filename":"src\/java.desktop\/windows\/native\/libawt\/windows\/awt_Component.cpp","additions":21,"deletions":33,"binary":false,"changes":54,"status":"modified"}]}