{"files":[{"patch":"@@ -33,0 +33,1 @@\n+import java.util.concurrent.ConcurrentHashMap;\n@@ -34,0 +35,1 @@\n+import java.util.zip.Adler32;\n@@ -41,3 +43,4 @@\n-    ZLIB(1, \"zlib\"),\n-    BROTLI(2, \"brotli\"),\n-    ZSTD(3, \"zstd\");\n+    ZLIB(1, \"zlib\", new ConcurrentHashMap<>(2)),\n+    \/\/ Placeholders, we currently support only ZLIB internally.\n+    BROTLI(2, \"brotli\", null),\n+    ZSTD(3, \"zstd\", null);\n@@ -47,0 +50,4 @@\n+    \/\/ We compress only local certificates, so it's ok to store the\n+    \/\/ deflated cert data in a memory cache permanently, i.e. such\n+    \/\/ cache is going to be of a manageable size.\n+    final Map<Integer, byte[]> cache;     \/\/ Checksum -> deflated data map.\n@@ -48,1 +55,1 @@\n-    CompressionAlgorithm(int id, String name) {\n+    CompressionAlgorithm(int id, String name, Map<Integer, byte[]> cache) {\n@@ -51,0 +58,1 @@\n+        this.cache = cache;\n@@ -54,2 +62,1 @@\n-        for (CompressionAlgorithm cca :\n-                CompressionAlgorithm.values()) {\n+        for (CompressionAlgorithm cca : CompressionAlgorithm.values()) {\n@@ -65,2 +72,1 @@\n-        for (CompressionAlgorithm cca :\n-                CompressionAlgorithm.values()) {\n+        for (CompressionAlgorithm cca : CompressionAlgorithm.values()) {\n@@ -136,1 +142,0 @@\n-    \/\/ We currently support only ZLIB internally.\n@@ -139,13 +144,6 @@\n-        return Map.of(ZLIB.name, (input) -> {\n-            try (Deflater deflater = new Deflater();\n-                    ByteArrayOutputStream outputStream =\n-                            new ByteArrayOutputStream(input.length)) {\n-\n-                deflater.setInput(input);\n-                deflater.finish();\n-                byte[] buffer = new byte[1024];\n-\n-                while (!deflater.finished()) {\n-                    int compressedSize = deflater.deflate(buffer);\n-                    outputStream.write(buffer, 0, compressedSize);\n-                }\n+        return Map.of(ZLIB.name, (input) ->\n+                ZLIB.cache.computeIfAbsent(getChecksum(input), key -> {\n+                    if (SSLLogger.isOn() && SSLLogger.isOn(\"ssl,handshake\")) {\n+                        SSLLogger.info(\"Deflating new \" + ZLIB.name\n+                                + \" certificate data with checksum: \" + key);\n+                    }\n@@ -153,9 +151,23 @@\n-                return outputStream.toByteArray();\n-            } catch (Exception e) {\n-                if (SSLLogger.isOn() && SSLLogger.isOn(\"ssl,handshake\")) {\n-                    SSLLogger.warning(\n-                            \"Exception during certificate compression: \", e);\n-                }\n-                return null;\n-            }\n-        });\n+                    try (Deflater deflater = new Deflater();\n+                            ByteArrayOutputStream outputStream =\n+                                    new ByteArrayOutputStream(input.length)) {\n+\n+                        deflater.setInput(input);\n+                        deflater.finish();\n+                        byte[] buffer = new byte[1024];\n+\n+                        while (!deflater.finished()) {\n+                            int compressedSize = deflater.deflate(buffer);\n+                            outputStream.write(buffer, 0, compressedSize);\n+                        }\n+\n+                        return outputStream.toByteArray();\n+                    } catch (Exception e) {\n+                        if (SSLLogger.isOn()\n+                                && SSLLogger.isOn(\"ssl,handshake\")) {\n+                            SSLLogger.warning(\"Exception during certificate \"\n+                                    + \"compression: \", e);\n+                        }\n+                        return null;\n+                    }\n+                }));\n@@ -188,0 +200,7 @@\n+\n+    \/\/ Fast checksum.\n+    private static int getChecksum(byte[] input) {\n+        Adler32 adler32 = new Adler32();\n+        adler32.update(input);\n+        return (int) adler32.getValue();\n+    }\n","filename":"src\/java.base\/share\/classes\/sun\/security\/ssl\/CompressionAlgorithm.java","additions":50,"deletions":31,"binary":false,"changes":81,"status":"modified"}]}