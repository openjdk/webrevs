{"files":[{"patch":"@@ -24,8 +24,0 @@\n-package compiler.c2;\n-\n-import compiler.lib.ir_framework.*;\n-import compiler.lib.verify.*;\n-import compiler.lib.ir_framework.Test;\n-\n-import java.util.Random;\n-\n@@ -36,0 +28,1 @@\n+ * @modules java.base\/jdk.internal.misc\n@@ -37,0 +30,3 @@\n+ * @compile ..\/..\/compiler\/lib\/ir_framework\/TestFramework.java\n+ * @compile ..\/..\/compiler\/lib\/generators\/Generators.java\n+ * @compile ..\/..\/compiler\/lib\/verify\/Verify.java\n@@ -39,216 +35,0 @@\n-public class TestConstantMultiplier {\n-    private static final Random RANDOM = AbstractInfo.getRandom();\n-\n-    public static void main(String[] args) {\n-        TestFramework.run();\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy81I(int num) {\n-        return num * 81;\n-    }\n-\n-    @Run(test = \"testMultBy81I\")\n-    private static void runMultBy81II() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(81 * multiplicand, testMultBy81I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy73I(int num) {\n-        return num * 73;\n-    }\n-\n-    @Run(test = \"testMultBy73I\")\n-    private static void runMultBy73II() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(73 * multiplicand, testMultBy73I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy45I(int num) {\n-        return num * 45;\n-    }\n-\n-    @Run(test = \"testMultBy45I\")\n-    private static void runMultBy45II() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(45 * multiplicand, testMultBy45I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy41I(int num) {\n-        return num * 41;\n-    }\n-\n-    @Run(test = \"testMultBy41I\")\n-    private static void runMultBy41II() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(41 * multiplicand, testMultBy41I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy37I(int num) {\n-        return num * 37;\n-    }\n-\n-    @Run(test = \"testMultBy37I\")\n-    private static void runMultBy37II() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(37 * multiplicand, testMultBy37I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy27I(int num) {\n-        return num * 27;\n-    }\n-\n-    @Run(test = \"testMultBy27I\")\n-    private static void runMultBy27II() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(27 * multiplicand, testMultBy27I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy25I(int num) {\n-        return num * 25;\n-    }\n-\n-    @Run(test = \"testMultBy25I\")\n-    private static void runMultBy25II() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(25 * multiplicand, testMultBy25I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy21I(int num) {\n-        return num * 21;\n-    }\n-\n-    @Run(test = \"testMultBy21I\")\n-    private static void runMultBy21II() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(21 * multiplicand, testMultBy21I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy19I(int num) {\n-        return num * 19;\n-    }\n-\n-    @Run(test = \"testMultBy19I\")\n-    private static void runMultBy19II() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(19 * multiplicand, testMultBy19I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy13I(int num) {\n-        return num * 13;\n-    }\n-\n-    @Run(test = \"testMultBy13I\")\n-    private static void runMultBy13I() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(13 * multiplicand, testMultBy13I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n-    private static int testMultBy11I(int num) {\n-        return num * 11;\n-    }\n-\n-    @Run(test = \"testMultBy11I\")\n-    private static void runMultBy11I() {\n-        int multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(11 * multiplicand, testMultBy11I(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy81L(long num) {\n-        return num * 81;\n-    }\n-\n-    @Run(test = \"testMultBy81L\")\n-    private static void runMultBy81L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(81 * multiplicand, testMultBy81L(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy73L(long num) {\n-        return num * 73;\n-    }\n-\n-    @Run(test = \"testMultBy73L\")\n-    private static void runMultBy73L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(73 * multiplicand, testMultBy73L(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy45L(long num) {\n-        return num * 45;\n-    }\n-\n-    @Run(test = \"testMultBy45L\")\n-    private static void runMultBy45L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(45 * multiplicand, testMultBy45L(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy41L(long num) {\n-        return num * 41;\n-    }\n-\n-    @Run(test = \"testMultBy41L\")\n-    private static void runMultBy41L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(41 * multiplicand, testMultBy41L(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy37L(long num) {\n-        return num * 37;\n-    }\n-\n-    @Run(test = \"testMultBy37L\")\n-    private static void runMultBy37L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(37 * multiplicand, testMultBy37L(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy27L(long num) {\n-        return num * 27;\n-    }\n-\n-    @Run(test = \"testMultBy27L\")\n-    private static void runMultBy27L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(27 * multiplicand, testMultBy27L(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy25L(long num) {\n-        return num * 25;\n-    }\n@@ -256,11 +36,1 @@\n-    @Run(test = \"testMultBy25L\")\n-    private static void runMultBy25L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(25 * multiplicand, testMultBy25L(multiplicand));\n-    }\n-\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy21L(long num) {\n-        return num * 21;\n-    }\n+package compiler.c2;\n@@ -268,5 +38,3 @@\n-    @Run(test = \"testMultBy21L\")\n-    private static void runMultBy21L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(21 * multiplicand, testMultBy21L(multiplicand));\n-    }\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.IntStream;\n@@ -274,5 +42,3 @@\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy19L(long num) {\n-        return num * 19;\n-    }\n+import compiler.lib.ir_framework.*;\n+import compiler.lib.verify.*;\n+import compiler.lib.ir_framework.Test;\n@@ -280,5 +46,2 @@\n-    @Run(test = \"testMultBy19L\")\n-    private static void runMultBy19L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(19 * multiplicand, testMultBy19L(multiplicand));\n-    }\n+import compiler.lib.compile_framework.*;\n+import compiler.lib.generators.Generators;\n@@ -286,5 +49,4 @@\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy13L(long num) {\n-        return num * 13;\n-    }\n+import compiler.lib.template_framework.Template;\n+import compiler.lib.template_framework.TemplateToken;\n+import static compiler.lib.template_framework.Template.scope;\n+import static compiler.lib.template_framework.Template.let;\n@@ -292,5 +54,1 @@\n-    @Run(test = \"testMultBy13L\")\n-    private static void runMultBy13L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(13 * multiplicand, testMultBy13L(multiplicand));\n-    }\n+import compiler.lib.template_framework.library.TestFrameworkClass;\n@@ -298,5 +56,1 @@\n-    @Test\n-    @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n-    private static long testMultBy11L(long num) {\n-        return num * 11;\n-    }\n+public class TestConstantMultiplier {\n@@ -304,4 +58,75 @@\n-    @Run(test = \"testMultBy11L\")\n-    private static void runMultBy11L() {\n-        long multiplicand = RANDOM.nextInt();\n-        Verify.checkEQ(11 * multiplicand, testMultBy11L(multiplicand));\n+    public static void main(String[] args) {\n+        \/\/ Create a new CompileFramework instance.\n+        CompileFramework comp = new CompileFramework();\n+\n+        \/\/ Add a java source file.\n+        comp.addJavaSourceCode(\"c2.compilerr.ConstantMultiplierTest\", generate(comp));\n+\n+        \/\/ Compile the source file.\n+        comp.compile();\n+\n+        \/\/ p.xyz.InnterTest.main(new String[] {});\n+        comp.invoke(\"c2.compiler.ConstantMultiplierTest\", \"main\", new Object[] {new String[] {}});\n+\n+        \/\/ We can also pass VM flags for the Test VM.\n+        \/\/ p.xyz.InnterTest.main(new String[] {\"-Xbatch\"});\n+        comp.invoke(\"c2.compiler.ConstantMultiplierTest\", \"main\", new Object[] {new String[] {\"-Xbatch\"}});\n+    }\n+\n+\n+    \/\/ Generate a source Java file as String\n+    public static String generate(CompileFramework comp) {\n+        var testHeader = Template.make(() -> scope(\n+            \"\"\"\n+                public static Random RANDOM = new Random(1023);\n+\n+            \"\"\"\n+        ));\n+        var testTemplate = Template.make(() -> scope(\n+            IntStream.of(81, 73, 45, 41, 37, 27, 25, 21, 19, 13, 11).mapToObj(\n+                multiplier -> scope(\n+                    let(\"multiplier\", multiplier),\n+                    \"\"\"\n+                        @Test\n+                        @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_I, \"1\"})\n+                        private static int testMultBy#{multiplier}I(int num) {\n+                            return num * #{multiplier};\n+                        }\n+\n+                        @Run(test = \"testMultBy#{multiplier}I\")\n+                        private static void runMultBy#{multiplier}II() {\n+                            int multiplicand = RANDOM.nextInt();\n+                            Verify.checkEQ(#{multiplier} * multiplicand, testMultBy#{multiplier}I(multiplicand));\n+                        }\n+\n+                        @Test\n+                        @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_IMM_L, \"1\"})\n+                        private static long testMultBy#{multiplier}L(long num) {\n+                            return num * #{multiplier};\n+                        }\n+\n+                        @Run(test = \"testMultBy#{multiplier}L\")\n+                        private static void runMultBy#{multiplier}L() {\n+                            long multiplicand = RANDOM.nextInt();\n+                            Verify.checkEQ(#{multiplier} * multiplicand, testMultBy#{multiplier}L(multiplicand));\n+                        }\n+                    \"\"\"\n+            )).toList()\n+        ));\n+\n+        var testClass = Template.make(() -> scope(\n+            testHeader.asToken(),\n+            testTemplate.asToken()\n+        ));\n+\n+        List<TemplateToken> testTemplateTokens = List.of(testClass.asToken());\n+\n+        return TestFrameworkClass.render(\n+            \/\/ package and class name.\n+            \"c2.compiler\", \"ConstantMultiplierTest\",\n+            \/\/ Set of imports.\n+            Set.of(\"java.util.Random\",\"compiler.lib.verify.*\"),\n+            \/\/ classpath, so the Test VM has access to the compiled class files.\n+            comp.getEscapedClassPathOfCompiledClasses(),\n+            \/\/ The list of tests.\n+            testTemplateTokens);\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/TestConstantMultiplier.java","additions":94,"deletions":269,"binary":false,"changes":363,"status":"modified"}]}