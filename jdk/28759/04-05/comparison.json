{"files":[{"patch":"@@ -7103,0 +7103,1 @@\n+      assert_different_registers(dst, src);\n","filename":"src\/hotspot\/cpu\/x86\/c2_MacroAssembler_x86.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -11500,1 +11500,1 @@\n-instruct mulI_mem_imm(rRegI dst, memory src, immI imm, rFlagsReg cr)\n+instruct mulI_mem_imm(rRegI dst, memory src, immI imm, rRegI rtmp, rFlagsReg cr)\n@@ -11503,1 +11503,1 @@\n-  effect(KILL cr, TEMP dst);\n+  effect(KILL cr, TEMP dst, TEMP rtmp);\n@@ -11508,2 +11508,2 @@\n-    __ movl($dst$$Register, $src$$Address);\n-    __ imullq_imm(T_INT, $dst$$Register, $dst$$Register, $imm$$constant);\n+    __ movl($rtmp$$Register, $src$$Address);\n+    __ imullq_imm(T_INT, $dst$$Register, $rtmp$$Register, $imm$$constant);\n@@ -11595,1 +11595,1 @@\n-instruct mulL_mem_imm(rRegL dst, memory src, immL32 imm, rFlagsReg cr)\n+instruct mulL_mem_imm(rRegL dst, memory src, immL32 imm, rRegL rtmp, rFlagsReg cr)\n@@ -11598,1 +11598,1 @@\n-  effect(KILL cr, TEMP dst);\n+  effect(KILL cr, TEMP dst, TEMP rtmp);\n@@ -11603,2 +11603,2 @@\n-    __ movq($dst$$Register, $src$$Address);\n-    __ imullq_imm(T_LONG, $dst$$Register, $dst$$Register, $imm$$constant);\n+    __ movq($rtmp$$Register, $src$$Address);\n+    __ imullq_imm(T_LONG, $dst$$Register, $rtmp$$Register, $imm$$constant);\n","filename":"src\/hotspot\/cpu\/x86\/x86.ad","additions":8,"deletions":8,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -76,0 +76,9 @@\n+                public static int [] memI;\n+                public static long [] memL;\n+\n+                static {\n+                    memL = new long[512];\n+                    Generators.G.fill(Generators.G.longs(), memL);\n+                    memI = new int[512];\n+                    Generators.G.fill(Generators.G.ints(), memI);\n+                }\n@@ -79,1 +88,1 @@\n-        var testTemplate = Template.make(() -> scope(\n+        var testTemplate1 = Template.make(() -> scope(\n@@ -91,1 +100,1 @@\n-                        private static void runMultBy#{multiplier}II() {\n+                        private static void runMultBy#{multiplier}I() {\n@@ -111,0 +120,32 @@\n+        var testTemplate2 = Template.make(() -> scope(\n+            IntStream.of(81, 73, 45, 41, 37, 27, 25, 21, 19, 13, 11).mapToObj(\n+                multiplier -> scope(\n+                    let(\"multiplier\", multiplier),\n+                    \"\"\"\n+                        @Test\n+                        @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_MEM_IMM_I, \"1\"})\n+                        private static int testMultBy#{multiplier}I_mem(int index) {\n+                            return memI[index] * #{multiplier};\n+                        }\n+\n+                        @Run(test = \"testMultBy#{multiplier}I_mem\")\n+                        private static void runMultBy#{multiplier}I_mem() {\n+                            int index = RANDOM.nextInt(memI.length);\n+                            Verify.checkEQ(#{multiplier} * memI[index], testMultBy#{multiplier}I_mem(index));\n+                        }\n+\n+                        @Test\n+                        @IR(applyIfPlatform = {\"x64\", \"true\"}, counts = {IRNode.X86_MULT_MEM_IMM_L, \"1\"})\n+                        private static long testMultBy#{multiplier}L_mem(int index) {\n+                            return memL[index] * #{multiplier};\n+                        }\n+\n+                        @Run(test = \"testMultBy#{multiplier}L_mem\")\n+                        private static void runMultBy#{multiplier}L_mem() {\n+                            int index = RANDOM.nextInt(memL.length);\n+                            Verify.checkEQ(#{multiplier} * memL[index], testMultBy#{multiplier}L_mem(index));\n+                        }\n+                    \"\"\"\n+            )).toList()\n+        ));\n+\n@@ -113,1 +154,2 @@\n-            testTemplate.asToken()\n+            testTemplate1.asToken(),\n+            testTemplate2.asToken()\n@@ -122,1 +164,1 @@\n-            Set.of(\"java.util.Random\",\"compiler.lib.verify.*\"),\n+            Set.of(\"java.util.Random\",\"compiler.lib.verify.*\", \"compiler.lib.generators.*\"),\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/TestConstantMultiplier.java","additions":46,"deletions":4,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -2794,0 +2794,10 @@\n+    public static final String X86_MULT_MEM_IMM_I = PREFIX + \"X86_MULT_MEM_IMM_I\" + POSTFIX;\n+    static {\n+        machOnlyNameRegex(X86_MULT_MEM_IMM_I, \"mulI_mem_imm\");\n+    }\n+\n+    public static final String X86_MULT_MEM_IMM_L = PREFIX + \"X86_MULT_MEM_IMM_L\" + POSTFIX;\n+    static {\n+        machOnlyNameRegex(X86_MULT_MEM_IMM_L, \"mulL_mem_imm\");\n+    }\n+\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/IRNode.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -39,0 +39,2 @@\n+import java.util.stream.IntStream;\n+import java.util.stream.LongStream;\n@@ -47,0 +49,9 @@\n+    public static int  [] memI;\n+    public static long [] memL;\n+\n+    @Setup\n+    public void BMSetup() {\n+        memI = IntStream.range(0, 1024).toArray();\n+        memL = LongStream.range(0, 1024).toArray();\n+    }\n+\n@@ -97,0 +108,50 @@\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static int mul_by_25_I_mem(int index) {\n+       return memI[index] * 25;\n+    }\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static int mul_by_27_I_mem(int index) {\n+       return memI[index] * 27;\n+    }\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static int mul_by_37_I_mem(int index) {\n+       return memI[index] * 37;\n+    }\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static int mul_by_19_I_mem(int index) {\n+       return memI[index] * 19;\n+    }\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static int mul_by_13_I_mem(int index) {\n+       return memI[index] * 13;\n+    }\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static int mul_by_11_I_mem(int index) {\n+       return memI[index] * 11;\n+    }\n+\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static long mul_by_25_L_mem(int index) {\n+       return memL[index] * 25;\n+    }\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static long mul_by_27_L_mem(int index) {\n+       return memL[index] * 27;\n+    }\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static long mul_by_37_L_mem(int index) {\n+       return memL[index] * 37;\n+    }\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static long mul_by_19_L_mem(int index) {\n+       return memL[index] * 19;\n+    }\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static long mul_by_13_L_mem(int index) {\n+       return memL[index] * 13;\n+    }\n+    @CompilerControl(CompilerControl.Mode.INLINE)\n+    public static long mul_by_11_L_mem(int index) {\n+       return memL[index] * 11;\n+    }\n+\n@@ -124,0 +185,28 @@\n+\n+    @Benchmark\n+    public long testConstMultiplierL_mem() {\n+        long res = 0;\n+        for (int j = 0; j < memL.length; j += 2) {\n+            res += mul_by_37_L_mem(j);\n+            res += mul_by_25_L_mem(j);\n+            res += mul_by_27_L_mem(j);\n+            res += mul_by_19_L_mem(j);\n+            res += mul_by_13_L_mem(j);\n+            res += mul_by_11_L_mem(j);\n+        }\n+        return res;\n+    }\n+\n+    @Benchmark\n+    public int testConstMultiplierI_mem() {\n+        int res = 0;\n+        for (int j = 0 ; j < memI.length; j += 2) {\n+            res += mul_by_37_I_mem(j);\n+            res += mul_by_25_I_mem(j);\n+            res += mul_by_27_I_mem(j);\n+            res += mul_by_19_I_mem(j);\n+            res += mul_by_13_I_mem(j);\n+            res += mul_by_11_I_mem(j);\n+        }\n+        return res;\n+    }\n","filename":"test\/micro\/org\/openjdk\/bench\/vm\/compiler\/ConstantMultiplierOptimization.java","additions":89,"deletions":0,"binary":false,"changes":89,"status":"modified"}]}