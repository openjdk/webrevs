{"files":[{"patch":"@@ -105,0 +105,1 @@\n+        checkAutomaticModuleName();\n@@ -277,20 +278,0 @@\n-                \/\/ Check for a valid and consistent automatic module name\n-                try (InputStream jis = zf.getInputStream(zf.getEntry(entryName))) {\n-                    Manifest manifest = new Manifest(jis);\n-                    Attributes global = manifest.getMainAttributes();\n-                    String name = global.getValue(\"Automatic-Module-Name\");\n-                    if (name != null) {\n-                        try {\n-                            ModuleDescriptor.newAutomaticModule(name);\n-                        } catch (IllegalArgumentException e) {\n-                            errorAndInvalid(formatMsg(\"error.validator.manifest.invalid.automatic.module.name\", name));\n-                        }\n-                        if (md != null) {\n-                            if (!name.equals(md.name())) {\n-                                errorAndInvalid(formatMsg(\"error.validator.manifest.inconsistent.automatic.module.name\", name, md.name()));\n-                            }\n-                        }\n-                    }\n-                } catch (IOException e) {\n-                    errorAndInvalid(e.getMessage());\n-                }\n@@ -478,0 +459,30 @@\n+    \/**\n+     * Checks whether an Automatic-Module-Name entry is valid\n+     * and also verifies it to the name given by a compiled\n+     * module descriptor.\n+     *\/\n+    private void checkAutomaticModuleName() {\n+        var entry = zf.getEntry(\"META-INF\/MANIFEST.MF\");\n+        if (entry == null) {\n+            return;\n+        }\n+        try (InputStream jis = zf.getInputStream(entry)) {\n+            Attributes attributes = new Manifest(jis).getMainAttributes();\n+            String automaticModuleName = attributes.getValue(\"Automatic-Module-Name\");\n+            if (automaticModuleName == null) {\n+                return;\n+            }\n+            try {\n+                ModuleDescriptor.newAutomaticModule(automaticModuleName);\n+            } catch (IllegalArgumentException e) {\n+                errorAndInvalid(formatMsg(\"error.validator.manifest.invalid.automatic.module.name\", automaticModuleName));\n+            }\n+            if (md == null || automaticModuleName.equals(md.name())) {\n+                return;\n+            }\n+            errorAndInvalid(formatMsg(\"error.validator.manifest.inconsistent.automatic.module.name\", automaticModuleName, md.name()));\n+        } catch (IOException e) {\n+            errorAndInvalid(e.getMessage());\n+        }\n+    }\n+\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/tools\/jar\/Validator.java","additions":31,"deletions":20,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -144,1 +144,1 @@\n-        expected module name is: {1} - but found Automatic-Module-Name entry in manifest: {0}\n+        expected Automatic-Module-Name entry in manifest: {0} to match name of compiled module: {1}\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/tools\/jar\/resources\/jar.properties","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n@@ -321,8 +322,4 @@\n-        try {\n-            jar(\"--validate --file \" + file.toString());\n-            fail(\"Expecting non-zero exit code\");\n-        } catch (IOException e) {\n-            var err = e.getMessage();\n-            System.out.println(err);\n-            assertTrue(err.contains(\"invalid module name of Automatic-Module-Name entry in manifest: default\"), \"missing warning for: default\");\n-        }\n+        var e = assertThrows(IOException.class, () -> jar(\"--validate --file \" + file.toString()));\n+        var err = e.getMessage();\n+        System.out.println(err);\n+        assertTrue(err.contains(\"invalid module name of Automatic-Module-Name entry in manifest: default\"), \"missing warning for: default\");\n@@ -347,8 +344,4 @@\n-        try {\n-            jar(\"--validate --file \" + file.toString());\n-            fail(\"Expecting non-zero exit code\");\n-        } catch (IOException e) {\n-            var err = e.getMessage();\n-            System.out.println(err);\n-            assertTrue(err.contains(\"expected module name is: foo - but found Automatic-Module-Name entry in manifest: bar\"), \"missing warning for: foo\/bar\");\n-        }\n+        var e = assertThrows(IOException.class, () -> jar(\"--validate --file \" + file.toString()));\n+        var err = e.getMessage();\n+        System.out.println(err);\n+        assertTrue(err.contains(\"expected Automatic-Module-Name entry in manifest: bar to match name of compiled module: foo\"), \"missing warning for: foo\/bar\");\n","filename":"test\/jdk\/tools\/jar\/ValidatorTest.java","additions":9,"deletions":16,"binary":false,"changes":25,"status":"modified"}]}