{"files":[{"patch":"@@ -1728,1 +1728,1 @@\n-  SavedState old_state = clone_map_and_save_state();\n+  SavedState old_state(this);\n@@ -1734,1 +1734,0 @@\n-    restore_state(old_state);\n@@ -1737,1 +1736,1 @@\n-  destruct_map_clone(old_state);\n+  old_state.discard();\n@@ -2375,7 +2374,8 @@\n-LibraryCallKit::SavedState LibraryCallKit::clone_map_and_save_state() {\n-  SavedState state;\n-  state.sp = sp();\n-  state.jvms = jvms();\n-  state.map = clone_map();\n-  for (DUIterator_Fast imax, i = control()->fast_outs(imax); i < imax; i++) {\n-    Node* out = control()->fast_out(i);\n+LibraryCallKit::SavedState::SavedState(LibraryCallKit* kit) :\n+  _kit(kit),\n+  _sp(kit->sp()),\n+  _jvms(kit->jvms()),\n+  _map(kit->clone_map())\n+{\n+  for (DUIterator_Fast imax, i = kit->control()->fast_outs(imax); i < imax; i++) {\n+    Node* out = kit->control()->fast_out(i);\n@@ -2383,1 +2383,1 @@\n-      state.ctrl_succ.push(out);\n+      _ctrl_succ.push(out);\n@@ -2386,1 +2386,0 @@\n-  return state;\n@@ -2389,12 +2388,15 @@\n-void LibraryCallKit::restore_state(const SavedState& state) {\n-  jvms()->set_map(state.map);\n-  jvms()->set_sp(state.sp);\n-  state.map->set_jvms(jvms());\n-  set_map(state.map);\n-  set_sp(state.sp);\n-  for (DUIterator_Fast imax, i = control()->fast_outs(imax); i < imax; i++) {\n-    Node* out = control()->fast_out(i);\n-    if (out->is_CFG() && out->in(0) == control() && out != map() && !state.ctrl_succ.member(out)) {\n-      _gvn.hash_delete(out);\n-      out->set_req(0, C->top());\n-      C->record_for_igvn(out);\n+LibraryCallKit::SavedState::~SavedState() {\n+  if (discarded) {\n+    return;\n+  }\n+  _kit->jvms()->set_map(_map);\n+  _kit->jvms()->set_sp(_sp);\n+  _map->set_jvms(_kit->jvms());\n+  _kit->set_map(_map);\n+  _kit->set_sp(_sp);\n+  for (DUIterator_Fast imax, i = _kit->control()->fast_outs(imax); i < imax; i++) {\n+    Node* out = _kit->control()->fast_out(i);\n+    if (out->is_CFG() && out->in(0) == _kit->control() && out != _kit->map() && !_ctrl_succ.member(out)) {\n+      _kit->_gvn.hash_delete(out);\n+      out->set_req(0, _kit->C->top());\n+      _kit->C->record_for_igvn(out);\n@@ -2402,0 +2404,1 @@\n+      _kit->_gvn.hash_find_insert(out);\n@@ -2406,2 +2409,2 @@\n-void LibraryCallKit::destruct_map_clone(const SavedState& state) {\n-  GraphKit::destruct_map_clone(state.map);\n+void LibraryCallKit::SavedState::discard() {\n+  discarded = true;\n@@ -2471,1 +2474,1 @@\n-  SavedState old_state = clone_map_and_save_state();\n+  SavedState old_state(this);\n@@ -2480,1 +2483,0 @@\n-      restore_state(old_state);\n@@ -2498,1 +2500,0 @@\n-    restore_state(old_state);\n@@ -2507,2 +2508,1 @@\n-  alias_type->adr_type() == TypeAryPtr::RANGE) {\n-    restore_state(old_state);\n+      alias_type->adr_type() == TypeAryPtr::RANGE) {\n@@ -2527,1 +2527,0 @@\n-      restore_state(old_state);\n@@ -2535,1 +2534,1 @@\n-  destruct_map_clone(old_state);\n+  old_state.discard();\n@@ -2771,1 +2770,1 @@\n-  SavedState old_state = clone_map_and_save_state();\n+  SavedState old_state(this);\n@@ -2780,1 +2779,0 @@\n-    restore_state(old_state);\n@@ -2784,1 +2782,1 @@\n-  destruct_map_clone(old_state);\n+  old_state.discard();\n","filename":"src\/hotspot\/share\/opto\/library_call.cpp","additions":34,"deletions":36,"binary":false,"changes":70,"status":"modified"},{"patch":"@@ -138,2 +138,2 @@\n-   * SavedState using clone_map_and_save_state, and before returning in case of bailing out,\n-   * fix the graph using restore_state.\n+   * SavedState by constructing it, and the state will be restored on destruction. If the\n+   * intrinsic is not bailing out, one need to call discard to prevent restoring the old state.\n@@ -141,5 +141,12 @@\n-  struct SavedState {\n-    uint sp;\n-    JVMState* jvms;\n-    SafePointNode* map;\n-    Unique_Node_List ctrl_succ;\n+  class SavedState {\n+    LibraryCallKit* _kit;\n+    uint _sp;\n+    JVMState* _jvms;\n+    SafePointNode* _map;\n+    Unique_Node_List _ctrl_succ;\n+    bool discarded = false;\n+\n+  public:\n+    SavedState(LibraryCallKit*);\n+    ~SavedState();\n+    void discard();\n@@ -147,3 +154,0 @@\n-  SavedState clone_map_and_save_state();\n-  void restore_state(const SavedState&);\n-  void destruct_map_clone(const SavedState& sfp);\n","filename":"src\/hotspot\/share\/opto\/library_call.hpp","additions":14,"deletions":10,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -825,1 +825,1 @@\n-  SavedState old_state = clone_map_and_save_state();\n+  SavedState old_state(this);\n@@ -862,1 +862,0 @@\n-    restore_state(old_state);\n@@ -874,1 +873,0 @@\n-        restore_state(old_state);\n@@ -883,1 +881,0 @@\n-        restore_state(old_state);\n@@ -891,1 +888,0 @@\n-        restore_state(old_state);\n@@ -896,1 +892,0 @@\n-        restore_state(old_state);\n@@ -911,1 +906,0 @@\n-      restore_state(old_state);\n@@ -948,1 +942,1 @@\n-  destruct_map_clone(old_state);\n+  old_state.discard();\n@@ -1025,1 +1019,1 @@\n-  SavedState old_state = clone_map_and_save_state();\n+  SavedState old_state(this);\n@@ -1038,1 +1032,0 @@\n-    restore_state(old_state);\n@@ -1060,1 +1053,0 @@\n-        restore_state(old_state);\n@@ -1070,1 +1062,0 @@\n-      restore_state(old_state);\n@@ -1081,1 +1072,0 @@\n-    restore_state(old_state);\n@@ -1092,1 +1082,0 @@\n-      restore_state(old_state);\n@@ -1103,1 +1092,0 @@\n-    restore_state(old_state);\n@@ -1124,1 +1112,0 @@\n-    restore_state(old_state);\n@@ -1133,1 +1120,0 @@\n-      restore_state(old_state);\n@@ -1180,1 +1166,1 @@\n-  destruct_map_clone(old_state);\n+  old_state.discard();\n@@ -1303,1 +1289,1 @@\n-  SavedState old_state = clone_map_and_save_state();\n+  SavedState old_state(this);\n@@ -1325,1 +1311,0 @@\n-    restore_state(old_state);\n@@ -1333,1 +1318,0 @@\n-    restore_state(old_state);\n@@ -1348,1 +1332,0 @@\n-      restore_state(old_state);\n@@ -1361,1 +1344,0 @@\n-      restore_state(old_state);\n@@ -1370,1 +1352,0 @@\n-      restore_state(old_state);\n@@ -1393,1 +1374,1 @@\n-  destruct_map_clone(old_state);\n+  old_state.discard();\n","filename":"src\/hotspot\/share\/opto\/vectorIntrinsics.cpp","additions":6,"deletions":25,"binary":false,"changes":31,"status":"modified"}]}