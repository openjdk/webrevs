{"files":[{"patch":"@@ -132,1 +132,1 @@\n-  inline void arraycopy_marking(T* src, T* dst, size_t count, bool is_old_marking);\n+  inline void arraycopy_marking(T* dst, size_t count);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahBarrierSet.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -390,4 +390,2 @@\n-  \/\/ may have forwarded objects. In this case, the `arraycopy_work` is first called with HAS_FWD=true and\n-  \/\/ ENQUEUE=false.\n-  assert(HAS_FWD == _heap->has_forwarded_objects() || _heap->is_concurrent_old_mark_in_progress(),\n-         \"Forwarded object status is sane\");\n+  \/\/ may have forwarded objects.\n+  assert(HAS_FWD == _heap->has_forwarded_objects() || _heap->is_concurrent_old_mark_in_progress(), \"Forwarded object status is sane\");\n@@ -396,1 +394,1 @@\n-  assert((HAS_FWD || EVAC) != ENQUEUE, \"Cannot evacuate and mark both sides of copy.\");\n+  static_assert((HAS_FWD || EVAC) != ENQUEUE, \"Cannot evacuate and mark both sides of copy.\");\n@@ -415,1 +413,1 @@\n-      if (ENQUEUE && !ctx->is_marked_strong_or_old(obj)) {\n+      if (ENQUEUE && !ctx->is_marked_strong(obj)) {\n@@ -429,1 +427,8 @@\n-  char gc_state = ShenandoahThreadLocalData::gc_state(Thread::current());\n+  const char gc_state = ShenandoahThreadLocalData::gc_state(Thread::current());\n+  if ((gc_state & ShenandoahHeap::MARKING) != 0) {\n+    \/\/ If marking old or young, we must evaluate the SATB barrier. This will be the only\n+    \/\/ action if we are not marking old. If we are marking old, we must still evaluate the\n+    \/\/ load reference barrier for a young collection.\n+    arraycopy_marking(dst, count);\n+  }\n+\n@@ -431,0 +436,1 @@\n+    assert((gc_state & ShenandoahHeap::YOUNG_MARKING) == 0, \"Cannot be marking young during evacuation\");\n@@ -433,0 +439,1 @@\n+    assert((gc_state & ShenandoahHeap::YOUNG_MARKING) == 0, \"Cannot be marking young during update-refs\");\n@@ -435,12 +442,0 @@\n-\n-  if (_heap->mode()->is_generational()) {\n-    assert(ShenandoahSATBBarrier, \"Generational mode assumes SATB mode\");\n-    if ((gc_state & ShenandoahHeap::YOUNG_MARKING) != 0) {\n-      arraycopy_marking(src, dst, count, false);\n-    }\n-    if ((gc_state & ShenandoahHeap::OLD_MARKING) != 0) {\n-      arraycopy_marking(src, dst, count, true);\n-    }\n-  } else if ((gc_state & ShenandoahHeap::MARKING) != 0) {\n-    arraycopy_marking(src, dst, count, false);\n-  }\n@@ -450,1 +445,1 @@\n-void ShenandoahBarrierSet::arraycopy_marking(T* src, T* dst, size_t count, bool is_old_marking) {\n+void ShenandoahBarrierSet::arraycopy_marking(T* dst, size_t count) {\n@@ -452,21 +447,0 @@\n-  \/*\n-   * Note that an old-gen object is considered live if it is live at the start of OLD marking or if it is promoted\n-   * following the start of OLD marking.\n-   *\n-   * 1. Every object promoted following the start of OLD marking will be above TAMS within its old-gen region\n-   * 2. Every object live at the start of OLD marking will be referenced from a \"root\" or it will be referenced from\n-   *    another live OLD-gen object.  With regards to old-gen, roots include stack locations and all of live young-gen.\n-   *    All root references to old-gen are identified during a bootstrap young collection.  All references from other\n-   *    old-gen objects will be marked during the traversal of all old objects, or will be marked by the SATB barrier.\n-   *\n-   * During old-gen marking (which is interleaved with young-gen collections), call arraycopy_work() if:\n-   *\n-   * 1. The overwritten array resides in old-gen and it is below TAMS within its old-gen region\n-   * 2. Do not call arraycopy_work for any array residing in young-gen because young-gen collection is idle at this time\n-   *\n-   * During young-gen marking, call arraycopy_work() if:\n-   *\n-   * 1. The overwritten array resides in young-gen and is below TAMS within its young-gen region\n-   * 2. Additionally, if array resides in old-gen, regardless of its relationship to TAMS because this old-gen array\n-   *    may hold references to young-gen\n-   *\/\n@@ -474,17 +448,2 @@\n-    T* array = dst;\n-    HeapWord* array_addr = reinterpret_cast<HeapWord*>(array);\n-    ShenandoahHeapRegion* r = _heap->heap_region_containing(array_addr);\n-    if (is_old_marking) {\n-      \/\/ Generational, old marking\n-      assert(_heap->mode()->is_generational(), \"Invariant\");\n-      if (r->is_old() && (array_addr < _heap->marking_context()->top_at_mark_start(r))) {\n-        arraycopy_work<T, false, false, true>(array, count);\n-      }\n-    } else if (_heap->mode()->is_generational()) {\n-      \/\/ Generational, young marking\n-      if (r->is_old() || (array_addr < _heap->marking_context()->top_at_mark_start(r))) {\n-        arraycopy_work<T, false, false, true>(array, count);\n-      }\n-    } else if (array_addr < _heap->marking_context()->top_at_mark_start(r)) {\n-      \/\/ Non-generational, marking\n-      arraycopy_work<T, false, false, true>(array, count);\n+    if (!_heap->marking_context()->allocated_after_mark_start(reinterpret_cast<HeapWord*>(dst))) {\n+      arraycopy_work<T, false, false, true>(dst, count);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahBarrierSet.inline.hpp","additions":17,"deletions":58,"binary":false,"changes":75,"status":"modified"},{"patch":"@@ -2032,2 +2032,2 @@\n-    ShenandoahBarrierSet::satb_mark_queue_set().set_filter_out_young(\n-      is_concurrent_old_mark_in_progress() && !is_concurrent_young_mark_in_progress()\n+    ShenandoahBarrierSet::satb_mark_queue_set().set_filter_mode(\n+      is_concurrent_young_mark_in_progress(), is_concurrent_old_mark_in_progress()\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -31,1 +31,1 @@\n-  SATBMarkQueueSet(allocator), _filter_out_young(false)\n+  SATBMarkQueueSet(allocator), _filter_mode(FILTER_MARKED)\n@@ -38,1 +38,1 @@\n-class ShenandoahSATBMarkQueueFilterFn {\n+class ShenandoahSatbFilterOutMarked {\n@@ -42,1 +42,1 @@\n-  explicit ShenandoahSATBMarkQueueFilterFn(ShenandoahHeap* heap) : _heap(heap) {}\n+  explicit ShenandoahSatbFilterOutMarked(ShenandoahHeap* heap) : _heap(heap) {}\n@@ -50,1 +50,1 @@\n-class ShenandoahSATBOldMarkQueueFilterFn {\n+class ShenandoahSatbFilterOutYoung {\n@@ -54,1 +54,1 @@\n-  explicit ShenandoahSATBOldMarkQueueFilterFn(ShenandoahHeap* heap) : _heap(heap) {}\n+  explicit ShenandoahSatbFilterOutYoung(ShenandoahHeap* heap) : _heap(heap) {}\n@@ -64,0 +64,14 @@\n+class ShenandoahSatbFilterOutOld {\n+  ShenandoahHeap* const _heap;\n+\n+public:\n+  explicit ShenandoahSatbFilterOutOld(ShenandoahHeap* heap) : _heap(heap) {}\n+\n+  \/\/ Return true if entry should be filtered out (removed), false if it should be retained.\n+  bool operator()(const void* entry) const {\n+    assert(!_heap->is_concurrent_old_mark_in_progress(), \"Should only use this when old marking is not in progress\");\n+    assert(_heap->is_concurrent_young_mark_in_progress(), \"Should only use this when young marking is in progress\");\n+    return !_heap->requires_marking(entry) || !_heap->is_in_young(entry);\n+  }\n+};\n+\n@@ -66,4 +80,12 @@\n-  if (_filter_out_young) {\n-    apply_filter(ShenandoahSATBOldMarkQueueFilterFn(heap), queue);\n-  } else {\n-    apply_filter(ShenandoahSATBMarkQueueFilterFn(heap), queue);\n+  switch (_filter_mode) {\n+    case FILTER_MARKED:\n+      apply_filter(ShenandoahSatbFilterOutMarked(heap), queue);\n+      break;\n+    case FILTER_YOUNG:\n+      apply_filter(ShenandoahSatbFilterOutYoung(heap), queue);\n+      break;\n+    case FILTER_OLD:\n+      apply_filter(ShenandoahSatbFilterOutOld(heap), queue);\n+      break;\n+    default:\n+      ShouldNotReachHere();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahSATBMarkQueueSet.cpp","additions":31,"deletions":9,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -33,1 +33,7 @@\n-  bool _filter_out_young;\n+  enum FilterMode {\n+    FILTER_MARKED,\n+    FILTER_YOUNG,\n+    FILTER_OLD\n+  };\n+\n+  FilterMode _filter_mode;\n@@ -40,2 +46,8 @@\n-  void set_filter_out_young(bool filter_out_young) {\n-    _filter_out_young = filter_out_young;\n+  void set_filter_mode(bool marking_young, bool marking_old) {\n+    if (marking_young && !marking_old) {\n+      _filter_mode = FILTER_OLD;\n+    } else if (!marking_young && marking_old) {\n+      _filter_mode = FILTER_YOUNG;\n+    } else {\n+      _filter_mode = FILTER_MARKED;\n+    }\n@@ -45,1 +57,1 @@\n-    return _filter_out_young;\n+    return _filter_mode == FILTER_YOUNG;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahSATBMarkQueueSet.hpp","additions":16,"deletions":4,"binary":false,"changes":20,"status":"modified"}]}