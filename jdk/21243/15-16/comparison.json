{"files":[{"patch":"@@ -166,0 +166,13 @@\n+    public void writeU2U2U2(int x1, int x2, int x3) {\n+        reserveSpace(6);\n+        byte[] elems = this.elems;\n+        int offset = this.offset;\n+        elems[offset    ] = (byte) (x1 >> 8);\n+        elems[offset + 1] = (byte) x1;\n+        elems[offset + 2] = (byte) (x2 >> 8);\n+        elems[offset + 3] = (byte) x2;\n+        elems[offset + 4] = (byte) (x3 >> 8);\n+        elems[offset + 5] = (byte) x3;\n+        this.offset = offset + 6;\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/BufWriterImpl.java","additions":13,"deletions":0,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -3,0 +3,1 @@\n+ * Copyright (c) 2024, Alibaba Group Holding Limited. All Rights Reserved.\n@@ -33,0 +34,1 @@\n+import java.util.Arrays;\n@@ -57,0 +59,2 @@\n+    static final Util.Writable[] EMPTY_WRITABLE_ARRAY = {};\n+    static final ClassEntry[] EMPTY_CLASS_ENTRY_ARRAY = {};\n@@ -58,2 +62,4 @@\n-    private final List<Util.Writable> fields = new ArrayList<>();\n-    private final List<Util.Writable> methods = new ArrayList<>();\n+    private Util.Writable[] fields = EMPTY_WRITABLE_ARRAY;\n+    private Util.Writable[] methods = EMPTY_WRITABLE_ARRAY;\n+    private int fieldsCount = 0;\n+    private int methodsCount = 0;\n@@ -140,1 +146,5 @@\n-        fields.add(field);\n+        if (fieldsCount >= fields.length) {\n+            int newCapacity = fieldsCount + 8;\n+            this.fields = Arrays.copyOf(fields, newCapacity);\n+        }\n+        fields[fieldsCount++] = field;\n@@ -145,1 +155,5 @@\n-        methods.add(method);\n+        if (methodsCount >= methods.length) {\n+            int newCapacity = methodsCount + 8;\n+            this.methods = Arrays.copyOf(methods, newCapacity);\n+        }\n+        methods[methodsCount++] = method;\n@@ -187,3 +201,1 @@\n-        List<ClassEntry> ies = new ArrayList<>(interfaceEntriesSize);\n-        for (int i = 0; i < interfaceEntriesSize; i++)\n-            ies.add(AbstractPoolEntry.maybeClone(constantPool, interfaceEntries.get(i)));\n+        ClassEntry[] ies = interfaceEntriesSize == 0 ? EMPTY_CLASS_ENTRY_ARRAY : buildInterfaceEnties(interfaceEntriesSize);\n@@ -198,2 +210,2 @@\n-        Util.writeList(tail, fields);\n-        Util.writeList(tail, methods);\n+        Util.writeList(tail, fields, fieldsCount);\n+        Util.writeList(tail, methods, methodsCount);\n@@ -214,2 +226,1 @@\n-        head.writeU2(flags);\n-        head.writeIndex(thisClassEntry);\n+        head.writeU2U2(flags, head.cpIndex(thisClassEntry));\n@@ -217,1 +228,4 @@\n-        Util.writeListIndices(head, ies);\n+        head.writeU2(interfaceEntriesSize);\n+        for (int i = 0; i < interfaceEntriesSize; i++) {\n+            head.writeIndex(ies[i]);\n+        }\n@@ -222,0 +236,7 @@\n+\n+    private ClassEntry[] buildInterfaceEnties(int interfaceEntriesSize) {\n+        var ies = new ClassEntry[interfaceEntriesSize];\n+        for (int i = 0; i < interfaceEntriesSize; i++)\n+            ies[i] = AbstractPoolEntry.maybeClone(constantPool, interfaceEntries.get(i));\n+        return ies;\n+    }\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/DirectClassBuilder.java","additions":33,"deletions":12,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -223,2 +223,1 @@\n-                buf.writeU2U2(startPc, endPc);\n-                buf.writeU2(handlerPc);\n+                buf.writeU2U2U2(startPc, endPc, handlerPc);\n@@ -515,2 +514,1 @@\n-            bytecodesBufWriter.writeU1U1(WIDE, IINC);\n-            bytecodesBufWriter.writeU2U2(slot, val);\n+            bytecodesBufWriter.writeU2U2U2((WIDE << 8) | IINC, slot, val);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/DirectCodeBuilder.java","additions":2,"deletions":4,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -151,3 +151,1 @@\n-        buf.writeU2(flags);\n-        buf.writeIndex(name);\n-        buf.writeIndex(desc);\n+        buf.writeU2U2U2(flags, buf.cpIndex(name), buf.cpIndex(desc));\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/DirectMethodBuilder.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -263,2 +263,1 @@\n-    static void writeList(BufWriterImpl buf, List<Writable> list) {\n-        int size = list.size();\n+    static void writeList(BufWriterImpl buf, Writable[] array, int size) {\n@@ -267,1 +266,1 @@\n-            list.get(i).writeTo(buf);\n+            array[i].writeTo(buf);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/Util.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"}]}