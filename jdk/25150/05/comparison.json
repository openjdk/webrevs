{"files":[{"patch":"@@ -320,1 +320,1 @@\n-static void register_command(TypedMethodOptionMatcher* matcher,\n+static bool register_command(TypedMethodOptionMatcher* matcher,\n@@ -322,0 +322,2 @@\n+                             char* errorbuf,\n+                             const int buf_size,\n@@ -334,1 +336,11 @@\n-    return;\n+    return true;\n+  }\n+\n+  if (!UnlockDiagnosticVMOptions) {\n+    const char* name = option2name(option);\n+    JVMFlag* flag = JVMFlag::find_declared_flag(name);\n+    if (flag != nullptr && flag->is_diagnostic()) {\n+      jio_snprintf(errorbuf, buf_size, \"VM option '%s' is diagnostic and must be enabled via -XX:+UnlockDiagnosticVMOptions.\", name);\n+      delete matcher;\n+      return false;\n+    }\n@@ -349,1 +361,1 @@\n-  return;\n+  return true;\n@@ -717,1 +729,1 @@\n-static void scan_value(enum OptionType type, char* line, int& total_bytes_read,\n+static bool scan_value(enum OptionType type, char* line, int& total_bytes_read,\n@@ -736,3 +748,1 @@\n-      line += bytes_read;\n-      register_command(matcher, option, value);\n-      return;\n+      return register_command(matcher, option, errorbuf, buf_size, value);\n@@ -741,0 +751,1 @@\n+      return false;\n@@ -754,2 +765,1 @@\n-      line += bytes_read;\n-      register_command(matcher, option, value);\n+      return register_command(matcher, option, errorbuf, buf_size, value);\n@@ -758,0 +768,1 @@\n+      return false;\n@@ -764,3 +775,1 @@\n-      line += bytes_read;\n-      register_command(matcher, option, (ccstr) value);\n-      return;\n+      return register_command(matcher, option, errorbuf, buf_size, (ccstr) value);\n@@ -769,0 +778,1 @@\n+      return false;\n@@ -793,0 +803,1 @@\n+          return false;\n@@ -801,0 +812,1 @@\n+          return false;\n@@ -807,0 +819,1 @@\n+          return false;\n@@ -813,0 +826,1 @@\n+          return false;\n@@ -822,2 +836,1 @@\n-      register_command(matcher, option, (ccstr) value);\n-      return;\n+      return register_command(matcher, option, errorbuf, buf_size, (ccstr) value);\n@@ -826,0 +839,1 @@\n+      return false;\n@@ -832,2 +846,1 @@\n-      register_command(matcher, option, true);\n-      return;\n+      return register_command(matcher, option, errorbuf, buf_size,true);\n@@ -838,3 +851,1 @@\n-        line += bytes_read;\n-        register_command(matcher, option, true);\n-        return;\n+        return register_command(matcher, option, errorbuf, buf_size,true);\n@@ -843,3 +854,1 @@\n-        line += bytes_read;\n-        register_command(matcher, option, false);\n-        return;\n+        return register_command(matcher, option, errorbuf, buf_size,false);\n@@ -848,0 +857,1 @@\n+        return false;\n@@ -851,0 +861,1 @@\n+      return false;\n@@ -860,3 +871,1 @@\n-      line += bytes_read;\n-      register_command(matcher, option, atof(value));\n-      return;\n+      return register_command(matcher, option, errorbuf, buf_size, atof(value));\n@@ -865,0 +874,1 @@\n+      return false;\n@@ -868,0 +878,1 @@\n+    return false;\n@@ -874,1 +885,1 @@\n-static void scan_option_and_value(enum OptionType type, char* line, int& total_bytes_read,\n+static bool scan_option_and_value(enum OptionType type, char* line, int& total_bytes_read,\n@@ -890,1 +901,1 @@\n-      return;\n+      return false;\n@@ -897,1 +908,1 @@\n-      return;\n+      return false;\n@@ -899,1 +910,1 @@\n-    scan_value(type, line, total_bytes_read, matcher, option, errorbuf, buf_size);\n+    return scan_value(type, line, total_bytes_read, matcher, option, errorbuf, buf_size);\n@@ -903,0 +914,1 @@\n+    return false;\n@@ -904,1 +916,0 @@\n-  return;\n@@ -999,2 +1010,1 @@\n-        scan_option_and_value(type, line, bytes_read, typed_matcher, error_buf, sizeof(error_buf));\n-        if (*error_buf != '\\0') {\n+        if (!scan_option_and_value(type, line, bytes_read, typed_matcher, error_buf, sizeof(error_buf))) {\n@@ -1014,1 +1024,4 @@\n-          register_command(typed_matcher, option, true);\n+          if (!register_command(typed_matcher, option, error_buf, sizeof(error_buf), true)) {\n+            print_parse_error(error_buf, original.get());\n+            return false;\n+          }\n@@ -1044,1 +1057,4 @@\n-        register_command(matcher, option, true);\n+        if (!register_command(matcher, option, error_buf, sizeof(error_buf), true)) {\n+          print_parse_error(error_buf, original.get());\n+          return false;\n+        }\n@@ -1048,1 +1064,4 @@\n-        register_command(matcher, option, (uintx)MemStatAction::collect);\n+        if (!register_command(matcher, option, error_buf, sizeof(error_buf), (uintx)MemStatAction::collect)) {\n+          print_parse_error(error_buf, original.get());\n+          return false;\n+        }\n@@ -1056,2 +1075,1 @@\n-    scan_value(type, line, bytes_read, matcher, option, error_buf, sizeof(error_buf));\n-    if (*error_buf != '\\0') {\n+    if (!scan_value(type, line, bytes_read, matcher, option, error_buf, sizeof(error_buf))) {\n@@ -1164,2 +1182,3 @@\n-        register_command(matcher, CompileCommandEnum::CompileOnly, true);\n-        continue;\n+        if (register_command(matcher, CompileCommandEnum::CompileOnly, error_buf, sizeof(error_buf), true)) {\n+          continue;\n+        }\n","filename":"src\/hotspot\/share\/compiler\/compilerOracle.cpp","additions":58,"deletions":39,"binary":false,"changes":97,"status":"modified"},{"patch":"@@ -40,1 +40,1 @@\n-        ProcessTools.executeTestJava(\"-XX:CompileCommand=option,package\/class,ccstrlist,ControlIntrinsic,+_getClass\", \"-version\")\n+        ProcessTools.executeTestJava(\"-XX:+UnlockDiagnosticVMOptions\", \"-XX:CompileCommand=option,package\/class,ccstrlist,ControlIntrinsic,+_getClass\", \"-version\")\n@@ -46,1 +46,1 @@\n-        ProcessTools.executeTestJava(\"-XX:CompileCommand=option,*,ccstrlist,ControlIntrinsic,+_getClass\", \"-version\")\n+        ProcessTools.executeTestJava(\"-XX:+UnlockDiagnosticVMOptions\", \"-XX:CompileCommand=option,*,ccstrlist,ControlIntrinsic,+_getClass\", \"-version\")\n@@ -54,1 +54,1 @@\n-        ProcessTools.executeTestJava(\"-XX:CompileCommand=option,*.ccstrlist,ccstrlist,ControlIntrinsic,+_getClass\", \"-version\")\n+        ProcessTools.executeTestJava(\"-XX:+UnlockDiagnosticVMOptions\", \"-XX:CompileCommand=option,*.ccstrlist,ccstrlist,ControlIntrinsic,+_getClass\", \"-version\")\n@@ -60,1 +60,1 @@\n-        ProcessTools.executeTestJava(\"-XX:CompileCommand=option,*.*,ccstrlist,ControlIntrinsic,+_getClass\", \"-version\")\n+        ProcessTools.executeTestJava(\"-XX:+UnlockDiagnosticVMOptions\", \"-XX:CompileCommand=option,*.*,ccstrlist,ControlIntrinsic,+_getClass\", \"-version\")\n@@ -65,1 +65,1 @@\n-        ProcessTools.executeTestJava(\"-XX:CompileCommand=option,class,PrintIntrinsics\", \"-version\")\n+        ProcessTools.executeTestJava(\"-XX:+UnlockDiagnosticVMOptions\", \"-XX:CompileCommand=option,class,PrintIntrinsics\", \"-version\")\n@@ -71,1 +71,1 @@\n-        ProcessTools.executeTestJava(\"-XX:CompileCommand=option,class.PrintIntrinsics,PrintIntrinsics\", \"-version\")\n+        ProcessTools.executeTestJava(\"-XX:+UnlockDiagnosticVMOptions\", \"-XX:CompileCommand=option,class.PrintIntrinsics,PrintIntrinsics\", \"-version\")\n","filename":"test\/hotspot\/jtreg\/compiler\/compilercontrol\/commands\/OptionTest.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+ *      -XX:+UnlockDiagnosticVMOptions\n","filename":"test\/hotspot\/jtreg\/compiler\/intrinsics\/bigInteger\/TestMultiplyToLen.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -33,0 +33,1 @@\n+ *      -XX:+UnlockDiagnosticVMOptions\n@@ -41,0 +42,1 @@\n+ *      -XX:+UnlockDiagnosticVMOptions\n","filename":"test\/hotspot\/jtreg\/compiler\/intrinsics\/bigInteger\/TestShift.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+ *      -XX:+UnlockDiagnosticVMOptions\n","filename":"test\/hotspot\/jtreg\/compiler\/intrinsics\/bigInteger\/TestSquareToLen.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -29,1 +29,1 @@\n- * @requires ! vm.opt.final.UnlockExperimentalVMOptions\n+ * @requires !vm.opt.final.UnlockExperimentalVMOptions\n@@ -40,1 +40,1 @@\n- * @requires ! vm.debug\n+ * @requires !vm.debug\n@@ -47,0 +47,11 @@\n+\/* @test VMCompileCommandWarningDiagnostic\n+ * @bug 8351958\n+ * @summary Warn if compile command that is an alias for a diagnostic vm option is used and -XX:+UnlockDiagnosticVMOptions isn't specified.\n+ * @requires vm.flagless\n+ * @requires !vm.debug\n+ * @library \/test\/lib\n+ * @modules java.base\/jdk.internal.misc\n+ *          java.management\n+ * @run driver VMOptionWarning DiagnosticCompileCommand\n+ *\/\n+\n@@ -51,1 +62,1 @@\n- * @requires ! vm.debug\n+ * @requires !vm.debug\n@@ -85,0 +96,7 @@\n+            case \"DiagnosticCompileCommand\": {\n+                pb = ProcessTools.createLimitedTestJavaProcessBuilder(\"-XX:CompileCommand=PrintAssembly,MyClass::myMethod\", \"-version\");\n+                output = new OutputAnalyzer(pb.start());\n+                output.shouldNotHaveExitValue(0);\n+                output.shouldContain(\"Error: VM option 'PrintAssembly' is diagnostic and must be enabled via -XX:+UnlockDiagnosticVMOptions.\");\n+                break;\n+            }\n","filename":"test\/hotspot\/jtreg\/runtime\/CommandLine\/VMOptionWarning.java","additions":21,"deletions":3,"binary":false,"changes":24,"status":"modified"}]}