{"files":[{"patch":"@@ -62,0 +62,12 @@\n+    \/\/ Event: 2301.131 Thread 0x00007fc6cc2866a0 nmethod 1298 0x00007fc6b4f82610 code [0x00007fc6b4f82a40, 0x00007fc6b4f83aa0]\n+    static Pattern compilation_event =\n+        Pattern.compile(\"Event: .* Thread .* nmethod \\\\d+ 0x(\\\\p{XDigit}+) code \");\n+\n+    \/\/ Compressed class space mapped at: 0x00007fc62f000000-0x00007fc66f000000, reserved size: 1073741824\n+    static Pattern compressed_class_space =\n+        Pattern.compile(\"Compressed class space mapped at: 0x(\\\\p{XDigit}+)\\\\-0x(\\\\p{XDigit}+), \");\n+\n+    \/\/ Narrow klass base: 0x00007fc62e000000, Narrow klass shift: 0, Narrow klass range: 0x100000000\n+    static Pattern narrow_klass_base =\n+        Pattern.compile(\"Narrow klass base: 0x(\\\\p{XDigit}+), \");\n+\n@@ -100,0 +112,6 @@\n+        \/\/ Known bad pointers:\n+        output = executor.execute(\"VM.inspect 0x0\");\n+        output.shouldContain(\"address not safe\");\n+        output = executor.execute(\"VM.inspect -1\");\n+        output.shouldContain(\"address not safe\");\n+\n@@ -101,2 +119,2 @@\n-        OutputAnalyzer threadPrintOutput = executor.execute(\"Thread.print\");\n-        BigInteger ptr = findPointer(threadPrintOutput, thread_id_line, 1);\n+        OutputAnalyzer jcmdOutput = executor.execute(\"Thread.print\", true \/* silent *\/);\n+        BigInteger ptr = findPointer(jcmdOutput, thread_id_line, 1, true);\n@@ -106,1 +124,1 @@\n-        \/\/ verbose shows output like:\n+        \/\/ -verbose shows output like:\n@@ -116,3 +134,10 @@\n-        \/\/ Known bad pointers:\n-        output = executor.execute(\"VM.inspect 0x0\");\n-        output.shouldContain(\"address not safe\");\n+        \/\/ Find and test a compiled method:\n+        jcmdOutput = executor.execute(\"VM.info\", true \/* silent *\/);\n+        ptr = findPointer(jcmdOutput, compilation_event, 1, false);\n+        if (ptr != null) {\n+            output = executor.execute(\"VM.inspect \" + pointerText(ptr));\n+            System.out.println(output);\n+            output.shouldContain(\"Compiled method \");\n+        } else{\n+            System.out.println(\"No compilation event found.\");\n+        }\n@@ -120,2 +145,18 @@\n-        output = executor.execute(\"VM.inspect -1\");\n-        output.shouldContain(\"address not safe\");\n+        \/\/ Test pointer into metadata:\n+        ptr = findPointer(jcmdOutput, compressed_class_space, 1, false);\n+        if (ptr != null) {\n+            output = executor.execute(\"VM.inspect \" + pointerText(ptr));\n+            System.out.println(output);\n+            output.shouldContain(\"metadata\");\n+        } else{\n+            System.out.println(\"No Compressed class space found.\");\n+        }\n+\n+        ptr = findPointer(jcmdOutput, narrow_klass_base, 1, false);\n+        if (ptr != null) {\n+            output = executor.execute(\"VM.inspect \" + pointerText(ptr));\n+            System.out.println(output);\n+            output.shouldContain(\"metadata\");\n+        } else{\n+            System.out.println(\"No narrow klass base found.\");\n+        }\n@@ -124,2 +165,2 @@\n-        threadPrintOutput = executor.execute(\"Thread.print\");\n-        ptr = findPointer(threadPrintOutput, waiting_on_mylock, 1);\n+        jcmdOutput = executor.execute(\"Thread.print\");\n+        ptr = findPointer(jcmdOutput, waiting_on_mylock, 1, true);\n@@ -161,1 +202,1 @@\n-    public BigInteger findPointer(OutputAnalyzer output, Pattern pattern, int regexGroup) {\n+    public BigInteger findPointer(OutputAnalyzer output, Pattern pattern, int regexGroup, boolean mustFind) {\n@@ -178,1 +219,6 @@\n-            Assert.fail(\"Failed to find '\" + pattern + \"' in output:\" + output.getOutput());\n+            String msg = \"Failed to find '\" + pattern + \"' in output:\" + output.getOutput();\n+            if (mustFind) {\n+                Assert.fail(msg);\n+            } else {\n+                System.out.println(msg);\n+            }\n","filename":"test\/hotspot\/jtreg\/serviceability\/dcmd\/vm\/VMInspectTest.java","additions":58,"deletions":12,"binary":false,"changes":70,"status":"modified"}]}