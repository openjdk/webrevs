{"files":[{"patch":"@@ -191,4 +191,0 @@\n-bool ArchiveBuilder::is_dumping_full_module_graph() {\n-  return DumpSharedSpaces && MetaspaceShared::use_full_module_graph();\n-}\n-\n@@ -240,1 +236,1 @@\n-  if (is_dumping_full_module_graph()) {\n+  if (CDSConfig::is_dumping_full_module_graph()) {\n@@ -589,1 +585,1 @@\n-  if (is_dumping_full_module_graph()) {\n+  if (CDSConfig::is_dumping_full_module_graph()) {\n@@ -606,1 +602,1 @@\n-  if (is_dumping_full_module_graph()) {\n+  if (CDSConfig::is_dumping_full_module_graph()) {\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.cpp","additions":3,"deletions":7,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -240,1 +240,0 @@\n-  bool is_dumping_full_module_graph();\n","filename":"src\/hotspot\/share\/cds\/archiveBuilder.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+#include \"cds\/cdsConfig.hpp\"\n@@ -90,1 +91,1 @@\n-    if (!MetaspaceShared::use_full_module_graph()) {\n+    if (!CDSConfig::is_loading_full_module_graph()) {\n","filename":"src\/hotspot\/share\/cds\/archiveHeapLoader.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+#include \"cds\/archiveHeapLoader.hpp\"\n@@ -28,0 +29,2 @@\n+#include \"classfile\/classLoaderDataShared.hpp\"\n+#include \"logging\/log.hpp\"\n@@ -30,0 +33,2 @@\n+bool CDSConfig::_enable_dumping_full_module_graph = true;\n+bool CDSConfig::_enable_loading_full_module_graph = true;\n@@ -40,0 +45,46 @@\n+\n+bool CDSConfig::is_dumping_full_module_graph() {\n+  if (is_dumping_heap() &&\n+      MetaspaceShared::use_optimized_module_handling() &&\n+      _enable_dumping_full_module_graph) {\n+    return true;\n+  } else {\n+    return false;\n+  }\n+}\n+\n+bool CDSConfig::is_loading_full_module_graph() {\n+  if (ClassLoaderDataShared::is_full_module_graph_loaded()) {\n+    return true;\n+  }\n+\n+  if (UseSharedSpaces &&\n+      ArchiveHeapLoader::can_use() &&\n+      MetaspaceShared::use_optimized_module_handling() &&\n+      _enable_loading_full_module_graph) {\n+    \/\/ Classes used by the archived full module graph are loaded in JVMTI early phase.\n+    assert(!(JvmtiExport::should_post_class_file_load_hook() && JvmtiExport::has_early_class_hook_env()),\n+           \"CDS should be disabled if early class hooks are enabled\");\n+    return true;\n+  } else {\n+    return false;\n+  }\n+}\n+\n+void CDSConfig::disable_dumping_full_module_graph(const char* reason) {\n+  if (_enable_dumping_full_module_graph) {\n+    _enable_dumping_full_module_graph = false;\n+    if (reason != nullptr) {\n+      log_info(cds)(\"full module graph cannot be dumped: %s\", reason);\n+    }\n+  }\n+}\n+\n+void CDSConfig::disable_loading_full_module_graph(const char* reason) {\n+  if (_enable_loading_full_module_graph) {\n+    _enable_loading_full_module_graph = false;\n+    if (reason != nullptr) {\n+      log_info(cds)(\"full module graph cannot be loaded: %s\", reason);\n+    }\n+  }\n+}\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.cpp","additions":51,"deletions":0,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -33,1 +33,3 @@\n-  static bool _is_dumping_dynamic_archive;\n+  static bool     _is_dumping_dynamic_archive;\n+  static bool _enable_dumping_full_module_graph;\n+  static bool _enable_loading_full_module_graph;\n@@ -46,0 +48,5 @@\n+  static void disable_dumping_full_module_graph(const char* reason = nullptr) NOT_CDS_JAVA_HEAP_RETURN;\n+  static bool      is_dumping_full_module_graph()            NOT_CDS_JAVA_HEAP_RETURN_(false);\n+  static void disable_loading_full_module_graph(const char* reason = nullptr) NOT_CDS_JAVA_HEAP_RETURN;\n+  static bool      is_loading_full_module_graph()            NOT_CDS_JAVA_HEAP_RETURN_(false);\n+\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.hpp","additions":8,"deletions":1,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+#include \"cds\/cdsConfig.hpp\"\n@@ -121,1 +122,1 @@\n-  if (MetaspaceShared::use_full_module_graph() && ik->is_shared() && pkg_entry != nullptr) {\n+  if (CDSConfig::is_loading_full_module_graph() && ik->is_shared() && pkg_entry != nullptr) {\n","filename":"src\/hotspot\/share\/cds\/cdsProtectionDomain.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -216,1 +216,1 @@\n-  _use_full_module_graph = MetaspaceShared::use_full_module_graph();\n+  _use_full_module_graph = CDSConfig::is_dumping_full_module_graph();\n@@ -1971,1 +1971,1 @@\n-    MetaspaceShared::disable_full_module_graph();\n+    CDSConfig::disable_loading_full_module_graph();\n@@ -2391,2 +2391,1 @@\n-    MetaspaceShared::disable_full_module_graph();\n-    log_info(cds)(\"full module graph: disabled because archive was created without full module graph\");\n+    CDSConfig::disable_loading_full_module_graph(\"archive was created without full module graph\");\n","filename":"src\/hotspot\/share\/cds\/filemap.cpp","additions":3,"deletions":4,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -586,1 +586,1 @@\n-  if (MetaspaceShared::use_full_module_graph()) {\n+  if (CDSConfig::is_dumping_full_module_graph()) {\n@@ -975,1 +975,1 @@\n-    if (record->is_full_module_graph() && !MetaspaceShared::use_full_module_graph()) {\n+    if (record->is_full_module_graph() && !CDSConfig::is_loading_full_module_graph()) {\n@@ -1516,1 +1516,1 @@\n-  if (MetaspaceShared::use_full_module_graph()) {\n+  if (CDSConfig::is_dumping_full_module_graph()) {\n","filename":"src\/hotspot\/share\/cds\/heapShared.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -100,1 +100,0 @@\n-bool MetaspaceShared::_use_full_module_graph = true;\n@@ -785,1 +784,1 @@\n-      disable_full_module_graph();\n+      CDSConfig::disable_dumping_full_module_graph();\n@@ -789,1 +788,1 @@\n-    if (use_full_module_graph()) {\n+    if (CDSConfig::is_dumping_full_module_graph()) {\n@@ -1174,1 +1173,1 @@\n-    log_info(cds)(\"initial full module graph: %s\", MetaspaceShared::use_full_module_graph() ? \"enabled\" : \"disabled\");\n+    log_info(cds)(\"initial full module graph: %s\", CDSConfig::is_loading_full_module_graph() ? \"enabled\" : \"disabled\");\n@@ -1548,23 +1547,0 @@\n-bool MetaspaceShared::use_full_module_graph() {\n-#if INCLUDE_CDS_JAVA_HEAP\n-  if (ClassLoaderDataShared::is_full_module_graph_loaded()) {\n-    return true;\n-  }\n-#endif\n-  bool result = _use_optimized_module_handling && _use_full_module_graph;\n-  if (DumpSharedSpaces) {\n-    result &= HeapShared::can_write();\n-  } else if (UseSharedSpaces) {\n-    result &= ArchiveHeapLoader::can_use();\n-  } else {\n-    result = false;\n-  }\n-\n-  if (result && UseSharedSpaces) {\n-    \/\/ Classes used by the archived full module graph are loaded in JVMTI early phase.\n-    assert(!(JvmtiExport::should_post_class_file_load_hook() && JvmtiExport::has_early_class_hook_env()),\n-           \"CDS should be disabled if early class hooks are enabled\");\n-  }\n-  return result;\n-}\n-\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.cpp","additions":3,"deletions":27,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -56,1 +56,0 @@\n-  static bool _use_full_module_graph;\n@@ -167,4 +166,0 @@\n-  \/\/ Can we use the full archived module graph?\n-  static bool use_full_module_graph() NOT_CDS_RETURN_(false);\n-  static void disable_full_module_graph() { _use_full_module_graph = false; }\n-\n","filename":"src\/hotspot\/share\/cds\/metaspaceShared.hpp","additions":0,"deletions":5,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n-#include \"cds\/metaspaceShared.hpp\"\n+#include \"cds\/cdsConfig.hpp\"\n@@ -148,1 +148,1 @@\n-  assert(DumpSharedSpaces && MetaspaceShared::use_full_module_graph(), \"must be\");\n+  assert(CDSConfig::is_dumping_full_module_graph(), \"must be\");\n@@ -155,1 +155,1 @@\n-  assert(DumpSharedSpaces && MetaspaceShared::use_full_module_graph(), \"must be\");\n+  assert(CDSConfig::is_dumping_full_module_graph(), \"must be\");\n@@ -162,1 +162,1 @@\n-  assert(DumpSharedSpaces && MetaspaceShared::use_full_module_graph(), \"must be\");\n+  assert(CDSConfig::is_dumping_full_module_graph(), \"must be\");\n@@ -175,1 +175,1 @@\n-  if (f->reading() && MetaspaceShared::use_full_module_graph()) {\n+  if (f->reading() && CDSConfig::is_loading_full_module_graph()) {\n@@ -185,1 +185,1 @@\n-  assert(UseSharedSpaces && !MetaspaceShared::use_full_module_graph(), \"must be\");\n+  assert(UseSharedSpaces && !CDSConfig::is_loading_full_module_graph(), \"must be\");\n@@ -192,1 +192,1 @@\n-  assert(UseSharedSpaces && MetaspaceShared::use_full_module_graph(), \"must be\");\n+  assert(CDSConfig::is_loading_full_module_graph(), \"must be\");\n@@ -198,1 +198,1 @@\n-  assert(UseSharedSpaces && MetaspaceShared::use_full_module_graph(), \"must be\");\n+  assert(CDSConfig::is_loading_full_module_graph(), \"must be\");\n@@ -203,1 +203,1 @@\n-  assert(UseSharedSpaces && MetaspaceShared::use_full_module_graph(), \"must be\");\n+  assert(CDSConfig::is_loading_full_module_graph(), \"must be\");\n","filename":"src\/hotspot\/share\/classfile\/classLoaderDataShared.cpp","additions":9,"deletions":9,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+#include \"cds\/cdsConfig.hpp\"\n@@ -489,1 +490,1 @@\n-  assert(MetaspaceShared::use_full_module_graph(), \"must be\");\n+  assert(CDSConfig::is_dumping_full_module_graph(), \"must be\");\n@@ -602,1 +603,1 @@\n-    log_info(cds)(\"full module graph: %s\", MetaspaceShared::use_full_module_graph() ? \"enabled\" : \"disabled\");\n+    log_info(cds)(\"full module graph: %s\", CDSConfig::is_loading_full_module_graph() ? \"enabled\" : \"disabled\");\n@@ -607,1 +608,1 @@\n-  assert(UseSharedSpaces && MetaspaceShared::use_full_module_graph(), \"must be\");\n+  assert(UseSharedSpaces && CDSConfig::is_loading_full_module_graph(), \"must be\");\n@@ -643,1 +644,1 @@\n-  if (DumpSharedSpaces && Universe::is_module_initialized() && MetaspaceShared::use_full_module_graph()) {\n+  if (DumpSharedSpaces && Universe::is_module_initialized() && CDSConfig::is_dumping_full_module_graph()) {\n","filename":"src\/hotspot\/share\/classfile\/modules.cpp","additions":5,"deletions":4,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -143,1 +143,1 @@\n-    assert(MetaspaceShared::use_full_module_graph(), \"must be\");\n+    assert(CDSConfig::is_loading_full_module_graph(), \"must be\");\n@@ -156,1 +156,1 @@\n-    assert(MetaspaceShared::use_full_module_graph(), \"must be\");\n+    assert(CDSConfig::is_loading_full_module_graph(), \"must be\");\n","filename":"src\/hotspot\/share\/classfile\/systemDictionary.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2694,0 +2694,1 @@\n+  assert(CDSConfig::is_dumping_archive(), \"must be\");\n@@ -2697,7 +2698,1 @@\n-  if (!MetaspaceShared::use_full_module_graph()) {\n-    _package_entry = nullptr;\n-  } else if (CDSConfig::is_dumping_dynamic_archive()) {\n-    if (!MetaspaceShared::is_in_shared_metaspace(_package_entry)) {\n-      _package_entry = nullptr;\n-    }\n-  } else {\n+  if (CDSConfig::is_dumping_full_module_graph()) {\n@@ -2709,0 +2704,6 @@\n+  } else if (CDSConfig::is_dumping_dynamic_archive() &&\n+             CDSConfig::is_loading_full_module_graph() &&\n+             MetaspaceShared::is_in_shared_metaspace(_package_entry)) {\n+    \/\/ _package_entry is an archived package in the base archive. Leave it as is.\n+  } else {\n+    _package_entry = nullptr;\n@@ -3030,1 +3031,1 @@\n-    if (MetaspaceShared::use_full_module_graph() && _package_entry == pkg_entry) {\n+    if (CDSConfig::is_loading_full_module_graph() && _package_entry == pkg_entry) {\n","filename":"src\/hotspot\/share\/oops\/instanceKlass.cpp","additions":9,"deletions":8,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -1272,1 +1272,2 @@\n-    MetaspaceShared::disable_full_module_graph();\n+    CDSConfig::disable_loading_full_module_graph();\n+    CDSConfig::disable_dumping_full_module_graph();\n","filename":"src\/hotspot\/share\/runtime\/arguments.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"}]}