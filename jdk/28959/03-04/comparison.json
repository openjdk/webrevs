{"files":[{"patch":"@@ -0,0 +1,108 @@\n+\/*\n+ * Copyright (c) 2026, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package jdk.jpackage.internal;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.ResourceBundle;\n+\n+import jdk.jpackage.internal.model.MacDmgPackage;\n+\n+final class MacDmgLicense {\n+\n+    public static void prepareLicense(MacDmgPackage pkg, BuildEnv env,\n+                Path licenseFile) throws IOException {\n+        final var licFile = pkg.licenseFile();\n+        if (licFile.isEmpty()) {\n+            return;\n+        }\n+\n+        byte[] licenseContentOriginal =\n+                Files.readAllBytes(licFile.orElseThrow());\n+        String licenseInBase64 =\n+                Base64.getEncoder().encodeToString(licenseContentOriginal);\n+\n+        Map<String, String> data = new HashMap<>();\n+        data.put(\"APPLICATION_LICENSE_TEXT\", licenseInBase64);\n+        data.put(\"STR_DATA_ENGLISH\",\n+                getSTRData(\"English\", Locale.ENGLISH, \"MacRoman\"));\n+        data.put(\"STR_DATA_GERMAN\",\n+                getSTRData(\"German\", Locale.GERMAN, \"MacRoman\"));\n+        data.put(\"STR_DATA_JAPANESE\",\n+                getSTRData(\"Japanese\", Locale.JAPANESE, \"Shift_JIS\"));\n+        data.put(\"STR_DATA_SIMPLIFIED_CHINESE\",\n+                getSTRData(\"Simplified Chinese\", Locale.SIMPLIFIED_CHINESE, \"GB2312\"));\n+\n+        env.createResource(DEFAULT_LICENSE_PLIST)\n+                .setCategory(I18N.getString(\"resource.license-setup\"))\n+                .setSubstitutionData(data)\n+                .saveToFile(licenseFile);\n+    }\n+\n+    private static void writeSTRDataString(ByteArrayOutputStream bos,\n+                String str, String charset) {\n+        byte [] bytes = str.getBytes(Charset.forName(charset));\n+        byte [] bytesLength = {(byte)bytes.length};\n+        bos.writeBytes(bytesLength);\n+        bos.writeBytes(bytes);\n+    }\n+\n+    \/\/ Returns base64 decoded STR section data.\n+    \/\/ Strings should be in following order:\n+    \/\/ Language, message.dmg.license.button.agree,\n+    \/\/ message.dmg.license.button.disagree, message.dmg.license.button.print\n+    \/\/ message.dmg.license.button.save, message.dmg.license.message\n+    \/\/ STR section data encoded:\n+    \/\/ Number of strings in the list (unsigned 16-bit integer, big endian): 6\n+    \/\/ A sequence of strings prefixed with string length (unsigned 8-bit integer)\n+    \/\/ Note: Language should not be translated.\n+    private static String getSTRData(String language, Locale locale, String charset) {\n+        ResourceBundle bundle = ResourceBundle.getBundle(\n+                \"jdk.jpackage.internal.resources.MacResources\", locale);\n+        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n+\n+        byte [] numberOfStrings = {0x00, 0x06}; \/\/ Always 6\n+        bos.writeBytes(numberOfStrings);\n+\n+        writeSTRDataString(bos, language, charset);\n+        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.agree\"), charset);\n+        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.disagree\"), charset);\n+        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.print\"), charset);\n+        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.save\"), charset);\n+        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.message\"), charset);\n+\n+        return Base64.getEncoder().encodeToString(bos.toByteArray());\n+    }\n+\n+    private static final String DEFAULT_LICENSE_PLIST=\"lic_template.plist\";\n+}\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/MacDmgLicense.java","additions":108,"deletions":0,"binary":false,"changes":108,"status":"added"},{"patch":"@@ -30,1 +30,0 @@\n-import java.io.ByteArrayOutputStream;\n@@ -33,1 +32,0 @@\n-import java.nio.charset.Charset;\n@@ -39,1 +37,0 @@\n-import java.util.Base64;\n@@ -42,1 +39,0 @@\n-import java.util.Locale;\n@@ -45,1 +41,0 @@\n-import java.util.ResourceBundle;\n@@ -182,63 +177,0 @@\n-    private void writeSTRDataString(ByteArrayOutputStream bos,\n-                String str, String charset) {\n-        byte [] bytes = str.getBytes(Charset.forName(charset));\n-        byte [] bytesLength = {(byte)bytes.length};\n-        bos.writeBytes(bytesLength);\n-        bos.writeBytes(bytes);\n-    }\n-\n-    \/\/ Returns base64 decoded STR section data.\n-    \/\/ Strings should be in following order:\n-    \/\/ Language, message.dmg.license.button.agree,\n-    \/\/ message.dmg.license.button.disagree, message.dmg.license.button.print\n-    \/\/ message.dmg.license.button.save, message.dmg.license.message\n-    \/\/ STR section data encoded:\n-    \/\/ Number of strings in the list (unsigned 16-bit integer, big endian): 6\n-    \/\/ A sequence of strings prefixed with string length (unsigned 8-bit integer)\n-    \/\/ Note: Language should not be translated.\n-    private String getSTRData(String language, Locale locale, String charset) {\n-        ResourceBundle bundle = ResourceBundle.getBundle(\n-                \"jdk.jpackage.internal.resources.MacResources\", locale);\n-        ByteArrayOutputStream bos = new ByteArrayOutputStream();\n-\n-        byte [] numberOfStrings = {0x00, 0x06}; \/\/ Always 6\n-        bos.writeBytes(numberOfStrings);\n-\n-        writeSTRDataString(bos, language, charset);\n-        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.agree\"), charset);\n-        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.disagree\"), charset);\n-        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.print\"), charset);\n-        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.button.save\"), charset);\n-        writeSTRDataString(bos, bundle.getString(\"message.dmg.license.message\"), charset);\n-\n-        return Base64.getEncoder().encodeToString(bos.toByteArray());\n-    }\n-\n-    private void prepareLicense() throws IOException {\n-        final var licFile = pkg.licenseFile();\n-        if (licFile.isEmpty()) {\n-            return;\n-        }\n-\n-        byte[] licenseContentOriginal =\n-                Files.readAllBytes(licFile.orElseThrow());\n-        String licenseInBase64 =\n-                Base64.getEncoder().encodeToString(licenseContentOriginal);\n-\n-        Map<String, String> data = new HashMap<>();\n-        data.put(\"APPLICATION_LICENSE_TEXT\", licenseInBase64);\n-        data.put(\"STR_DATA_ENGLISH\",\n-                getSTRData(\"English\", Locale.ENGLISH, \"MacRoman\"));\n-        data.put(\"STR_DATA_GERMAN\",\n-                getSTRData(\"German\", Locale.GERMAN, \"MacRoman\"));\n-        data.put(\"STR_DATA_JAPANESE\",\n-                getSTRData(\"Japanese\", Locale.JAPANESE, \"Shift_JIS\"));\n-        data.put(\"STR_DATA_SIMPLIFIED_CHINESE\",\n-                getSTRData(\"Simplified Chinese\", Locale.SIMPLIFIED_CHINESE, \"GB2312\"));\n-\n-        env.createResource(DEFAULT_LICENSE_PLIST)\n-                .setCategory(I18N.getString(\"resource.license-setup\"))\n-                .setSubstitutionData(data)\n-                .saveToFile(licenseFile());\n-    }\n-\n@@ -256,1 +188,1 @@\n-        prepareLicense();\n+        MacDmgLicense.prepareLicense(pkg, env, licenseFile());\n@@ -491,2 +423,0 @@\n-\n-    private static final String DEFAULT_LICENSE_PLIST=\"lic_template.plist\";\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/MacDmgPackager.java","additions":1,"deletions":71,"binary":false,"changes":72,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+\t\t\t<!-- Note: Values if \"Name\" keys should not be localized for all languages. It is internal use only. -->\n","filename":"src\/jdk.jpackage\/macosx\/classes\/jdk\/jpackage\/internal\/resources\/lic_template.plist","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -186,1 +186,1 @@\n-    Executor storeOutputInFiles(boolean v) {\n+    public Executor storeOutputInFiles(boolean v) {\n@@ -191,1 +191,1 @@\n-    Executor storeOutputInFiles() {\n+    public Executor storeOutputInFiles() {\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/Executor.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -59,0 +59,3 @@\n+ * For DMG license should be displayed on command line when \"hdiutil attach\"\n+ * is called.\n+ *\n@@ -99,0 +102,1 @@\n+        initMacDmgLicenseVerifier(test.forTypes(PackageType.MAC_DMG));\n@@ -134,0 +138,27 @@\n+    private static PackageTest initMacDmgLicenseVerifier(PackageTest test) {\n+        return test\n+        .addBundleVerifier(cmd -> {\n+            verifyLicenseFileInDMGPackage(cmd);\n+        });\n+    }\n+\n+    private static void verifyLicenseFileInDMGPackage(JPackageCommand cmd)\n+            throws IOException {\n+        \/\/ DMG should have license, so attach with \"no\", since we only need license.\n+        \/\/ With \"no\" attach will be canceled.\n+        final var attachExec = Executor.of(\"sh\", \"-c\", String.join(\" \",\n+                \"no\",\n+                \"|\",\n+                \"\/usr\/bin\/hdiutil\",\n+                \"attach\",\n+                JPackageCommand.escapeAndJoin(cmd.outputBundle().toString())\n+        )).saveOutput().storeOutputInFiles();\n+\n+        \/\/ Expected exit code is 1, since we canceling license.\n+        final var attachResult = attachExec.executeAndRepeatUntilExitCode(1, 10, 6);\n+        TKit.assertStringListEquals(Files.readAllLines(LICENSE_FILE),\n+                attachResult.stdout(), String.format(\n+                \"Check output of \\\"hdiutil attach\\\" has the same license as contents of source license file [%s]\",\n+                LICENSE_FILE));\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/share\/LicenseTest.java","additions":32,"deletions":1,"binary":false,"changes":33,"status":"modified"}]}