{"files":[{"patch":"@@ -101,0 +101,1 @@\n+\n@@ -103,0 +104,5 @@\n+            this.Hmac = getHmac(ps);\n+\n+            if (!this.kdfHmac.equals(this.Hmac)) {\n+                throw new IOException(\"PRF and Hmac must be same\");\n+            }\n@@ -293,0 +299,14 @@\n+\n+    public static String getHmac(String text) {\n+        final String word2 = \"And\";\n+\n+        String regex = Pattern.quote(word2) + \"(.*?)$\";\n+        Pattern pattern = Pattern.compile(regex);\n+        Matcher matcher = pattern.matcher(text);\n+\n+        if (matcher.find()) {\n+            return matcher.group(1);\n+        } else {\n+            return null;\n+        }\n+    }\n","filename":"src\/java.base\/share\/classes\/sun\/security\/pkcs12\/MacData.java","additions":20,"deletions":0,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -178,0 +178,1 @@\n+    private boolean newKeystore;\n@@ -1248,0 +1249,1 @@\n+            newKeystore = true;\n@@ -1482,1 +1484,1 @@\n-        final String kdfHmac;\n+        String kdfHmac;\n@@ -1485,6 +1487,11 @@\n-        if (macAlgorithm.startsWith(\"PBEWith\") ||\n-                defaultMacAlgorithm().startsWith(\"PBEWith\")) {\n-            if (defaultMacAlgorithm().equals(\"PBEWithHmacSHA512\")) {\n-                kdfHmac = \"HmacSHA512\";\n-            } else if (defaultMacAlgorithm().equals(\"PBEWithHmacSHA256\")) {\n-                kdfHmac = \"HmacSHA256\";\n+        if (newKeystore) {\n+            if (macAlgorithm.startsWith(\"PBEWith\") ||\n+                    defaultMacAlgorithm().startsWith(\"PBEWith\")) {\n+                kdfHmac = defaultMacAlgorithm().replace(\"PBEWith\", \"\");\n+                if (!(kdfHmac.equals(\"HmacSHA512\") ||\n+                        kdfHmac.equals(\"HmacSHA256\"))) {\n+                    kdfHmac = pbmac1Hmac; \/\/ use value associated with keystore\n+                }\n+                algName = \"PBMAC1\";\n+                \/\/ Override with value of security property.\n+                writeIterationCount = defaultMacIterationCount();\n@@ -1492,2 +1499,2 @@\n-                \/\/ Use value currently associated with this keystore.\n-                kdfHmac = pbmac1Hmac;\n+                algName = macAlgorithm.substring(7);\n+                kdfHmac = macAlgorithm;\n@@ -1495,3 +1502,0 @@\n-            algName = \"PBMAC1\";\n-            \/\/ Override with value of security property.\n-            writeIterationCount = defaultMacIterationCount();\n@@ -1499,2 +1503,7 @@\n-            algName = macAlgorithm.substring(7);\n-            kdfHmac = macAlgorithm;\n+            if (pbmac1Hmac != null) { \/\/ have PBMAC1 keystore\n+                kdfHmac = pbmac1Hmac;\n+                algName = \"PBMAC1\";\n+            } else {\n+                algName = macAlgorithm.substring(7);\n+                kdfHmac = macAlgorithm;\n+            }\n@@ -1945,1 +1954,2 @@\n-        String kdfHmac;\n+        final String kdfHmac;\n+        String tmp;\n@@ -1947,5 +1957,2 @@\n-        if (macAlgorithm.equals(\"PBEWithHmacSHA256\")) {\n-            kdfHmac = \"HmacSHA256\";\n-        } else if (macAlgorithm.equals(\"PBEWithHmacSHA512\")) {\n-            kdfHmac = \"HmacSHA512\";\n-        } else {\n+        tmp = macAlgorithm.replace(\"PBEWith\", \"\");\n+        if (!(tmp.equals(\"HmacSHA512\") || tmp.equals(\"HmacSHA256\"))) {\n@@ -1953,0 +1960,2 @@\n+        } else {\n+            kdfHmac = tmp;\n@@ -2205,1 +2214,1 @@\n-                                \"PBEWith\" + pbmac1KdfHmac);\n+                                macAlgorithm);\n","filename":"src\/java.base\/share\/classes\/sun\/security\/pkcs12\/PKCS12KeyStore.java","additions":30,"deletions":21,"binary":false,"changes":51,"status":"modified"}]}