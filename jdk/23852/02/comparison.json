{"files":[{"patch":"@@ -465,1 +465,0 @@\n-java\/awt\/Headless\/HeadlessMalfunctionTest.java 8349099 generic-all\n","filename":"test\/jdk\/ProblemList.txt","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -23,5 +23,0 @@\n-import jdk.internal.org.objectweb.asm.ClassReader;\n-import jdk.internal.org.objectweb.asm.ClassVisitor;\n-import jdk.internal.org.objectweb.asm.ClassWriter;\n-import jdk.internal.org.objectweb.asm.MethodVisitor;\n-import jdk.internal.org.objectweb.asm.Opcodes;\n@@ -29,0 +24,2 @@\n+import java.lang.classfile.ClassFile;\n+import java.lang.classfile.MethodModel;\n@@ -40,1 +37,0 @@\n-\n@@ -42,18 +38,16 @@\n-            public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined,\n-                                    ProtectionDomain pd, byte[] cb) {\n-                if (\"java\/awt\/GraphicsEnvironment\".equals(className)) {\n-                    System.out.println(\"Transforming java.awt.GraphicsEnvironment.\");\n-                    try {\n-                        final ClassReader cr = new ClassReader(cb);\n-                        final ClassWriter cw = new ClassWriter(cr, 0);\n-                        cr.accept(new ClassVisitor(Opcodes.ASM9, cw) {\n-\n-                            @Override\n-                            public MethodVisitor visitMethod(int access, String name, String descriptor, String signature,\n-                                                             String[] exceptions) {\n-                                if (\"isHeadless\".equals(name) && \"()Z\".equals(descriptor)) {\n-                                    System.out.println(\"isHeadless removed from java.awt.GraphicsEnvironment.\");\n-                                    \/\/ WHACK! Remove the isHeadless method.\n-                                    return null;\n-                                }\n-                                return super.visitMethod(access, name, descriptor, signature, exceptions);\n+            public byte[] transform(ClassLoader loader,\n+                                    String className,\n+                                    Class<?> classBeingRedefined,\n+                                    ProtectionDomain pd,\n+                                    byte[] cb) {\n+                if (!\"java\/awt\/GraphicsEnvironment\".equals(className)) {\n+                    return null;\n+                }\n+                System.out.println(\"Transforming java.awt.GraphicsEnvironment.\");\n+                try {\n+                    return ClassFile.of().transformClass(ClassFile.of().parse(cb), (classBuilder, element) -> {\n+                        if (element instanceof MethodModel method) {\n+                            if (\"isHeadless\".equals(method.methodName().stringValue()) &&\n+                                    \"()Z\".equals(method.methodType().stringValue())) {\n+                                System.out.println(\"isHeadless removed from java.awt.GraphicsEnvironment.\");\n+                                return;\n@@ -61,5 +55,6 @@\n-                        }, 0);\n-                        return cw.toByteArray();\n-                    } catch (Exception e) {\n-                        e.printStackTrace();\n-                    }\n+                        }\n+                        classBuilder.with(element);\n+                    });\n+                } catch (Exception e) {\n+                    e.printStackTrace();\n+                    return null;\n@@ -67,1 +62,0 @@\n-                return null;\n","filename":"test\/jdk\/java\/awt\/Headless\/HeadlessMalfunctionAgent.java","additions":25,"deletions":31,"binary":false,"changes":56,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -35,2 +35,2 @@\n- * @library \/test\/lib\n- * @modules java.base\/jdk.internal.org.objectweb.asm\n+ * @library \/test\/\n+ * @requires os.family == \"linux\"\n@@ -41,1 +41,0 @@\n- *              HeadlessMalfunctionAgent$1$1\n@@ -52,2 +51,1 @@\n-                        \"HeadlessMalfunctionAgent$1.class\",\n-                        \"HeadlessMalfunctionAgent$1$1.class\");\n+                        \"HeadlessMalfunctionAgent$1.class\");\n@@ -58,2 +56,0 @@\n-                \"--add-opens\",\n-                \"java.base\/jdk.internal.org.objectweb.asm=ALL-UNNAMED\",\n@@ -65,0 +61,4 @@\n+        \/\/ Patched should mention that isHeadless is missing, log message differs between OSes;\n+        \/\/ e.g. LWCToolkit toolkit path on MacOS and Win32GraphicsEnvironment code path on Windows\n+        \/\/ logs \"java.lang.NoSuchMethodError: 'boolean java.awt.GraphicsEnvironment.isHeadless()'\",\n+        \/\/ whereas Linux logs \"FATAL ERROR in native method: GetStaticMethodID isHeadless failed\"\n","filename":"test\/jdk\/java\/awt\/Headless\/HeadlessMalfunctionTest.java","additions":8,"deletions":8,"binary":false,"changes":16,"status":"modified"}]}