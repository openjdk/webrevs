{"files":[{"patch":"@@ -107,1 +107,7 @@\n-  const void* const res = mmap((void*)addr, length, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE, -1, 0);\n+  constexpr int mmap_fd =\n+  #ifdef __APPLE__\n+    VM_MAKE_TAG(VM_MEMORY_JAVA);\n+  #else\n+    -1;\n+  #endif\n+  const void* const res = mmap((void*)addr, length, PROT_READ | PROT_WRITE, MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE, mmap_fd, 0);\n@@ -154,1 +160,7 @@\n-  const void* const res = mmap((void*)start, length, PROT_NONE, MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE | MAP_NORESERVE, -1, 0);\n+  constexpr int mmap_fd =\n+  #ifdef __APPLE__\n+    VM_MAKE_TAG(VM_MEMORY_JAVA);\n+  #else\n+    -1;\n+  #endif\n+  const void* const res = mmap((void*)start, length, PROT_NONE, MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE | MAP_NORESERVE, mmap_fd, 0);\n@@ -175,1 +187,7 @@\n-  const void* const res = mmap((void*)untype(addr), size, PROT_NONE, MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE | MAP_NORESERVE, -1, 0);\n+  constexpr int mmap_fd =\n+  #ifdef __APPLE__\n+    VM_MAKE_TAG(VM_MEMORY_JAVA);\n+  #else\n+    -1;\n+  #endif\n+  const void* const res = mmap((void*)untype(addr), size, PROT_NONE, MAP_FIXED | MAP_ANONYMOUS | MAP_PRIVATE | MAP_NORESERVE, mmap_fd, 0);\n","filename":"src\/hotspot\/os\/bsd\/gc\/z\/zPhysicalMemoryBacking_bsd.cpp","additions":21,"deletions":3,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -107,0 +107,1 @@\n+  #include <mach\/vm_statistics.h>\n@@ -1520,1 +1521,1 @@\n-                                       MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0);\n+                                       MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, VM_MAKE_TAG(VM_MEMORY_JAVA), 0);\n@@ -1647,1 +1648,1 @@\n-        MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE|MAP_ANONYMOUS, -1, 0);\n+        MAP_PRIVATE|MAP_FIXED|MAP_NORESERVE|MAP_ANONYMOUS, VM_MAKE_TAG(VM_MEMORY_JAVA), 0);\n@@ -1692,1 +1693,7 @@\n-  char* addr = (char*)::mmap(requested_addr, bytes, PROT_NONE, flags, -1, 0);\n+  constexpr int mmap_fd =\n+  #ifdef __APPLE__\n+    VM_MAKE_TAG(VM_MEMORY_JAVA);\n+  #else\n+    -1;\n+  #endif\n+  char* addr = (char*)::mmap(requested_addr, bytes, PROT_NONE, flags, mmap_fd, 0);\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":10,"deletions":3,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -34,0 +34,4 @@\n+#ifdef __APPLE__\n+#include <mach\/mach_vm.h>\n+#include <mach\/vm_statistics.h>\n+#endif\n@@ -37,0 +41,33 @@\n+#ifdef __APPLE__\n+\/\/ Check if a memory region is tagged with VM_MEMORY_JAVA\n+static bool is_memory_tagged_as_java(void* addr, size_t size) {\n+  \/\/ Use mach_vm_region with extended info to get the user_tag\n+  mach_vm_address_t address = (mach_vm_address_t)addr;\n+  mach_vm_size_t region_size = 0;\n+  vm_region_extended_info_data_t extended_info;\n+  mach_msg_type_number_t info_count = VM_REGION_EXTENDED_INFO_COUNT;\n+  mach_port_t object_name = MACH_PORT_NULL;\n+\n+  kern_return_t kr = mach_vm_region(mach_task_self(),\n+                                    &address,\n+                                    &region_size,\n+                                    VM_REGION_EXTENDED_INFO,\n+                                    (vm_region_info_t)&extended_info,\n+                                    &info_count,\n+                                    &object_name);\n+\n+  if (kr != KERN_SUCCESS) {\n+    return false;\n+  }\n+\n+  \/\/ Check if the memory region covers our allocation and has the correct tag\n+  if (address <= (mach_vm_address_t)addr &&\n+      (address + region_size) >= ((mach_vm_address_t)addr + size)) {\n+    \/\/ Check if the user_tag matches VM_MEMORY_JAVA\n+    return extended_info.user_tag == VM_MEMORY_JAVA;\n+  }\n+\n+  return false;\n+}\n+#endif\n+\n@@ -105,0 +142,6 @@\n+  #ifdef __APPLE__\n+    \/\/ Validate BSD memory tagging for os::commit_memory path (covers pd_* functions)\n+    EXPECT_TRUE(is_memory_tagged_as_java(_reserved, ZGranuleSize))\n+      << \"Memory allocated via os::commit_memory should be tagged with VM_MEMORY_JAVA on macOS\";\n+  #endif\n+\n@@ -230,0 +273,8 @@\n+#ifdef __APPLE__\n+    \/\/ Validate BSD memory tagging for ZGC allocation path (covers ZPhysicalMemoryBacking functions)\n+    if (!is_null(object)) {\n+      EXPECT_TRUE(is_memory_tagged_as_java((void*)untype(object), object_size))\n+        << \"ZGC object allocation should be tagged with VM_MEMORY_JAVA on macOS\";\n+    }\n+#endif\n+\n","filename":"test\/hotspot\/gtest\/gc\/z\/test_zForwarding.cpp","additions":51,"deletions":0,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -40,0 +40,4 @@\n+#ifdef __APPLE__\n+#include <mach\/mach_vm.h>\n+#include <mach\/vm_statistics.h>\n+#endif\n@@ -43,0 +47,33 @@\n+#ifdef __APPLE__\n+\/\/ Check if a memory region is tagged with VM_MEMORY_JAVA\n+static bool is_memory_tagged_as_java(void* addr, size_t size) {\n+  \/\/ Use mach_vm_region with extended info to get the user_tag\n+  mach_vm_address_t address = (mach_vm_address_t)addr;\n+  mach_vm_size_t region_size = 0;\n+  vm_region_extended_info_data_t extended_info;\n+  mach_msg_type_number_t info_count = VM_REGION_EXTENDED_INFO_COUNT;\n+  mach_port_t object_name = MACH_PORT_NULL;\n+\n+  kern_return_t kr = mach_vm_region(mach_task_self(),\n+                                    &address,\n+                                    &region_size,\n+                                    VM_REGION_EXTENDED_INFO,\n+                                    (vm_region_info_t)&extended_info,\n+                                    &info_count,\n+                                    &object_name);\n+\n+  if (kr != KERN_SUCCESS) {\n+    return false;\n+  }\n+\n+  \/\/ Check if the memory region covers our allocation and has the correct tag\n+  if (address <= (mach_vm_address_t)addr &&\n+      (address + region_size) >= ((mach_vm_address_t)addr + size)) {\n+    \/\/ Check if the user_tag matches VM_MEMORY_JAVA\n+    return extended_info.user_tag == VM_MEMORY_JAVA;\n+  }\n+\n+  return false;\n+}\n+#endif\n+\n@@ -739,0 +776,6 @@\n+\n+#ifdef __APPLE__\n+    \/\/ Validate BSD memory tagging for JVM-allocated memory\n+    EXPECT_TRUE(is_memory_tagged_as_java(p, 1 * M))\n+      << \"JVM memory allocated via os::reserve_memory should be tagged with VM_MEMORY_JAVA on macOS\";\n+#endif\n@@ -1111,0 +1154,6 @@\n+#ifdef __APPLE__\n+  \/\/ Validate BSD memory tagging for JVM-allocated memory\n+  EXPECT_TRUE(is_memory_tagged_as_java(base, size))\n+    << \"JVM memory allocated via os::reserve_memory should be tagged with VM_MEMORY_JAVA on macOS\";\n+#endif\n+\n@@ -1133,0 +1182,7 @@\n+\n+#ifdef __APPLE__\n+  \/\/ Validate BSD memory tagging for JVM-allocated memory\n+  EXPECT_TRUE(is_memory_tagged_as_java(base, size))\n+    << \"JVM memory allocated via os::reserve_memory should be tagged with VM_MEMORY_JAVA on macOS\";\n+#endif\n+\n","filename":"test\/hotspot\/gtest\/runtime\/test_os.cpp","additions":56,"deletions":0,"binary":false,"changes":56,"status":"modified"}]}