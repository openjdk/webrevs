{"files":[{"patch":"@@ -149,1 +149,7 @@\n-    artifact_tag(cld_klass, leakp);\n+    if (current_epoch()) {\n+      \/\/ This will enqueue the klass, which is important for\n+      \/\/ reachability when doing clear and reset at rotation.\n+      JfrTraceId::load(cld_klass);\n+    } else {\n+      artifact_tag(cld_klass, leakp);\n+    }\n@@ -599,1 +605,1 @@\n-\/\/ PackageWriter used during unloading.\n+\/\/ PackageWriter used during flush or unloading i.e. the current epoch.\n@@ -629,1 +635,1 @@\n-static void do_unloading_packages(PackageWriter& pw) {\n+static void do_packages(PackageWriter& pw) {\n@@ -650,7 +656,2 @@\n-  if (unloading()) {\n-    do_unloading_packages(pw);\n-    return;\n-  }\n-  if (flushpoint()) {\n-    PackageCallback callback(&_subsystem_callback, &pw);\n-    do_all_packages(pw);\n+  if (current_epoch()) {\n+    do_packages(pw);\n@@ -711,1 +712,1 @@\n-\/\/ ModuleWriter used during unloading.\n+\/\/ ModuleWriter used during flush or unloading i.e. the current epoch.\n@@ -741,2 +742,1 @@\n-static void do_unloading_modules(ModuleWriter& mw) {\n-  assert(unloading(), \"invariant\");\n+static void do_modules(ModuleWriter& mw) {\n@@ -763,7 +763,2 @@\n-  if (unloading()) {\n-    do_unloading_modules(mw);\n-    return;\n-  }\n-  if (flushpoint()) {\n-    ModuleCallback callback(&_subsystem_callback, &mw);\n-    do_all_modules(mw);\n+  if (current_epoch()) {\n+    do_modules(mw);\n@@ -831,1 +826,1 @@\n-\/\/ CldWriter used during unloading.\n+\/\/ CldWriter used during flush or unloading i.e. the current epoch.\n@@ -870,2 +865,1 @@\n-static void do_unloading_clds(CldWriter& cldw) {\n-  assert(unloading(), \"invariant\");\n+static void do_clds(CldWriter& cldw) {\n@@ -894,7 +888,2 @@\n-  if (unloading()) {\n-    do_unloading_clds(cldw);\n-    return;\n-  }\n-  if (flushpoint()) {\n-    CldCallback callback(&_subsystem_callback, &cldw);\n-    do_all_clds(cldw);\n+  if (current_epoch()) {\n+    do_clds(cldw);\n","filename":"src\/hotspot\/share\/jfr\/recorder\/checkpoint\/types\/jfrTypeSet.cpp","additions":19,"deletions":30,"binary":false,"changes":49,"status":"modified"}]}