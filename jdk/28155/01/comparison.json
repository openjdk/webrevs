{"files":[{"patch":"@@ -123,0 +123,22 @@\n+\n+RELEASE_FILE_TEMPLATE := $(TOPDIR)\/src\/java.base\/share\/classes\/jdk\/internal\/jmod\/resources\/release.txt.template\n+RELEASE_FILE_TARGET := $(SUPPORT_OUTPUTDIR)\/gensrc\/$(MODULE)\/jdk\/internal\/jmod\/resources\/release.txt\n+\n+RELEASE_FILE_VARDEPS := $(COMPANY_NAME) $(VERSION_STRING) $(VERSION_DATE)\n+RELEASE_FILE_VARDEPS_FILE := $(call DependOnVariable, RELEASE_FILE_VARDEPS, \\\n+    $(SUPPORT_OUTPUTDIR)\/gensrc\/$(MODULE)\/jlink_release_txt.vardeps)\n+\n+$(eval $(call SetupTextFileProcessing, BUILD_RELEASE_FILE, \\\n+    SOURCE_FILES := $(RELEASE_FILE_TEMPLATE), \\\n+    OUTPUT_FILE := $(RELEASE_FILE_TARGET), \\\n+    REPLACEMENTS := \\\n+        @@COMPANY_NAME@@ => $(COMPANY_NAME) ; \\\n+        @@VERSION_STRING@@ => $(VERSION_STRING) ; \\\n+        @@VERSION_DATE@@ => $(VERSION_DATE) , \\\n+))\n+\n+$(BUILD_RELEASE_FILE): $(RELEASE_FILE_VARDEPS_FILE)\n+\n+TARGETS += $(BUILD_RELEASE_FILE)\n+\n+################################################################################\n","filename":"make\/modules\/java.base\/Gensrc.gmk","additions":22,"deletions":0,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -37,1 +37,1 @@\n-COPY += .icu .dat .spp .nrm content-types.properties \\\n+COPY += .icu .dat .spp .nrm .txt content-types.properties \\\n","filename":"make\/modules\/java.base\/Java.gmk","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,1 @@\n+@@COMPANY_NAME@@-@@VERSION_STRING@@-@@VERSION_DATE@@\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/jmod\/resources\/release.txt.template","additions":1,"deletions":0,"binary":false,"changes":1,"status":"added"},{"patch":"@@ -30,0 +30,1 @@\n+import java.io.BufferedReader;\n@@ -33,0 +34,1 @@\n+import java.io.InputStreamReader;\n@@ -59,0 +61,1 @@\n+import java.util.NoSuchElementException;\n@@ -241,0 +244,16 @@\n+    \/\/ Release information as in the java.base module for target image\n+    public static final String JDK_RELEASE_RESOURCE = \"jdk\/internal\/jmod\/resources\/release.txt\";\n+\n+    \/**\n+     * Read the release.txt from the module.\n+     *\/\n+    private static Optional<String> getReleaseInfo(ModuleReference mref) throws IOException {\n+        var in = mref.open().open(JDK_RELEASE_RESOURCE);\n+        if (in.isEmpty()) {\n+            return Optional.empty();\n+        }\n+\n+        try (var r = new BufferedReader(new InputStreamReader(in.get()))) {\n+            return Optional.of(r.readLine());\n+        }\n+    }\n@@ -572,18 +591,22 @@\n-    private static void checkJavaBaseVersion(ModuleFinder finder) {\n-        assert finder.find(\"java.base\").isPresent();\n-\n-        \/\/ use the version of java.base module, if present, as\n-        \/\/ the release version for multi-release JAR files\n-        ModuleDescriptor.Version v = finder.find(\"java.base\").get()\n-                .descriptor().version().orElseThrow(() ->\n-                new IllegalArgumentException(\"No version in java.base descriptor\")\n-                        );\n-\n-        Runtime.Version version = Runtime.Version.parse(v.toString());\n-        if (Runtime.version().feature() != version.feature() ||\n-                Runtime.version().interim() != version.interim()) {\n-            \/\/ jlink version and java.base version do not match.\n-            \/\/ We do not (yet) support this mode.\n-            throw new IllegalArgumentException(taskHelper.getMessage(\"err.jlink.version.mismatch\",\n-                    Runtime.version().feature(), Runtime.version().interim(),\n-                    version.feature(), version.interim()));\n+    private void checkJavaBaseVersion(ModuleFinder finder) {\n+        try {\n+            ModuleReference current = ModuleLayer.boot()\n+                    .configuration()\n+                    .findModule(\"java.base\")\n+                    .get()\n+                    .reference();\n+            ModuleReference target = finder.find(\"java.base\").get();\n+            String currentRelease = getReleaseInfo(current).orElseThrow(() ->\n+                new IllegalArgumentException(\"Cannot find release.txt\"));\n+            String targetRelease = getReleaseInfo(target).orElse(\"N\/A\");\n+            if (! currentRelease.equals(targetRelease)) {\n+                \/\/ jlink version and java.base version do not match.\n+                \/\/ We do not (yet) support this mode.\n+                throw new IllegalArgumentException(taskHelper.getMessage(\"err.jlink.version.mismatch\",\n+                        currentRelease,\n+                        targetRelease));\n+            }\n+        } catch (NoSuchElementException e) {\n+            assert false : \"Should have found java.base module\";\n+        } catch (IOException ioe) {\n+            throw new UncheckedIOException(ioe);\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/JlinkTask.java","additions":41,"deletions":18,"binary":false,"changes":59,"status":"modified"},{"patch":"@@ -133,1 +133,1 @@\n-err.jlink.version.mismatch=jlink version {0}.{1} does not match target java.base version {2}.{3}\n+err.jlink.version.mismatch=jlink build {0} does not match target java.base build {1}\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/resources\/jlink.properties","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}