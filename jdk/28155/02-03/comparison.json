{"files":[{"patch":"@@ -61,0 +61,1 @@\n+import java.util.NoSuchElementException;\n@@ -249,2 +250,3 @@\n-    private static Optional<String> getReleaseInfo(ModuleReference mref) throws IOException {\n-        Optional<InputStream> release = mref.open().open(JDK_RELEASE_RESOURCE);\n+    private static Optional<String> getReleaseInfo(ModuleReference mref) {\n+        try {\n+            Optional<InputStream> release = mref.open().open(JDK_RELEASE_RESOURCE);\n@@ -252,3 +254,3 @@\n-        if (release.isEmpty()) {\n-            return Optional.empty();\n-        }\n+            if (release.isEmpty()) {\n+                return Optional.empty();\n+            }\n@@ -256,2 +258,5 @@\n-        try (var r = new BufferedReader(new InputStreamReader(release.get()))) {\n-            return Optional.of(r.readLine());\n+            try (var r = new BufferedReader(new InputStreamReader(release.get()))) {\n+                return Optional.of(r.readLine());\n+            }\n+        } catch (IOException ioe) {\n+            throw new UncheckedIOException(ioe);\n@@ -432,1 +437,2 @@\n-            checkJavaBaseVersion(finder);\n+            assert(finder.find(\"java.base\").isPresent());\n+            checkJavaBaseVersion(finder.find(\"java.base\").get());\n@@ -583,0 +589,10 @@\n+    private static String getJlinkRuntimeVersion() {\n+        ModuleReference current = ModuleLayer.boot()\n+                .configuration()\n+                .findModule(\"java.base\")\n+                .get()\n+                .reference();\n+        \/\/ This jlink runtime should always have the release.txt\n+        return getReleaseInfo(current).get();\n+    }\n+\n@@ -590,1 +606,4 @@\n-    private void checkJavaBaseVersion(ModuleFinder finder) {\n+    private static void checkJavaBaseVersion(ModuleReference target) {\n+        String currentRelease = getJlinkRuntimeVersion();\n+        String targetRelease;\n+\n@@ -592,16 +611,3 @@\n-            ModuleReference current = ModuleLayer.boot()\n-                    .configuration()\n-                    .findModule(\"java.base\")\n-                    .get()\n-                    .reference();\n-            ModuleReference target = finder.find(\"java.base\").get();\n-            \/\/ This jlink runtime should always have the release.txt\n-            String currentRelease = getReleaseInfo(current).orElseThrow(() ->\n-                    new IllegalArgumentException(\"Cannot find release.txt\"));\n-            \/\/ Old runtime may not have the release.txt, result in a mismatch\n-            String targetRelease = getReleaseInfo(target).orElse(\"N\/A\");\n-            if (! currentRelease.equals(targetRelease)) {\n-                \/\/ Current runtime image and the target runtime image is not compatible release\n-                throw new IllegalArgumentException(taskHelper.getMessage(\"err.jlink.version.mismatch\",\n-                        currentRelease,\n-                        targetRelease));\n+            targetRelease = getReleaseInfo(target).get();\n+            if (currentRelease.equals(targetRelease)) {\n+                return;\n@@ -609,2 +615,5 @@\n-        } catch (IOException ioe) {\n-            throw new UncheckedIOException(ioe);\n+        } catch (NoSuchElementException nsee) {\n+            \/\/ target release has no release.txt\n+            \/\/ the java.base module must be older than the jlink runtime\n+            \/\/ silently ignore and fall through to version mismatch\n+            targetRelease = \"missing\";\n@@ -612,0 +621,5 @@\n+\n+        \/\/ Current runtime image and the target runtime image are not compatible build\n+        throw new IllegalArgumentException(taskHelper.getMessage(\"err.jlink.version.mismatch\",\n+                currentRelease,\n+                targetRelease));\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/JlinkTask.java","additions":41,"deletions":27,"binary":false,"changes":68,"status":"modified"}]}