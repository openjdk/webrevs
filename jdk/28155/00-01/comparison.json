{"files":[{"patch":"@@ -129,1 +129,1 @@\n-  $(SUPPORT_OUTPUTDIR)\/gensrc\/$(MODULE)\/jlink_release_txt.vardeps)\n+    $(SUPPORT_OUTPUTDIR)\/gensrc\/$(MODULE)\/jlink_release_txt.vardeps)\n@@ -132,6 +132,6 @@\n-  SOURCE_FILES := $(RELEASE_FILE_TEMPLATE), \\\n-  OUTPUT_FILE := $(RELEASE_FILE_TARGET), \\\n-  REPLACEMENTS := \\\n-      @@COMPANY_NAME@@ => $(COMPANY_NAME) ; \\\n-      @@VERSION_STRING@@ => $(VERSION_STRING) ; \\\n-      @@VERSION_DATE@@ => $(VERSION_DATE) , \\\n+    SOURCE_FILES := $(RELEASE_FILE_TEMPLATE), \\\n+    OUTPUT_FILE := $(RELEASE_FILE_TARGET), \\\n+    REPLACEMENTS := \\\n+        @@COMPANY_NAME@@ => $(COMPANY_NAME) ; \\\n+        @@VERSION_STRING@@ => $(VERSION_STRING) ; \\\n+        @@VERSION_DATE@@ => $(VERSION_DATE) , \\\n@@ -140,1 +140,1 @@\n-$(OUTPUT_FILE): $(RELEASE_FILE_VARDEPS_FILE)\n+$(BUILD_RELEASE_FILE): $(RELEASE_FILE_VARDEPS_FILE)\n","filename":"make\/modules\/java.base\/Gensrc.gmk","additions":8,"deletions":8,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -51,10 +51,0 @@\n-TARGETS += $(JLINK_PROPERTIES) $(JMOD_PROPERTIES) $(JIMAGE_PROPERTIES)\n-\n-################################################################################\n-\n-RELEASE_FILE_TEMPLATE := $(TOPDIR)\/src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/resources\/release.txt.template\n-RELEASE_FILE_TARGET := $(SUPPORT_OUTPUTDIR)\/gensrc\/$(MODULE)\/jdk\/tools\/jlink\/resources\/release.txt\n-\n-RELEASE_FILE_VARDEPS := $(COMPANY_NAME) $(VERSION_STRING) $(VERSION_DATE)\n-RELEASE_FILE_VARDEPS_FILE := $(call DependOnVariable, RELEASE_FILE_VARDEPS, \\\n-  $(SUPPORT_OUTPUTDIR)\/gensrc\/$(MODULE)\/jlink_release_txt.vardeps)\n@@ -62,12 +52,1 @@\n-$(eval $(call SetupTextFileProcessing, BUILD_RELEASE_FILE, \\\n-  SOURCE_FILES := $(RELEASE_FILE_TEMPLATE), \\\n-  OUTPUT_FILE := $(RELEASE_FILE_TARGET), \\\n-  REPLACEMENTS := \\\n-      @@COMPANY_NAME@@ => $(COMPANY_NAME) ; \\\n-      @@VERSION_STRING@@ => $(VERSION_STRING) ; \\\n-      @@VERSION_DATE@@ => $(VERSION_DATE) , \\\n-))\n-\n-$(OUTPUT_FILE): $(RELEASE_FILE_VARDEPS_FILE)\n-\n-TARGETS += $(BUILD_RELEASE_FILE)\n+TARGETS += $(JLINK_PROPERTIES) $(JMOD_PROPERTIES) $(JIMAGE_PROPERTIES)\n","filename":"make\/modules\/jdk.jlink\/Gensrc.gmk","additions":1,"deletions":22,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -30,1 +30,1 @@\n-COPY += .conf .txt\n+COPY += .conf\n","filename":"make\/modules\/jdk.jlink\/Java.gmk","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -61,0 +61,1 @@\n+import java.util.NoSuchElementException;\n@@ -243,2 +244,0 @@\n-    \/\/ Release information stored in jdk.jlink module for this jlink\n-    public static final String JLINK_RELEASE_RESOURCE = \"jdk\/tools\/jlink\/resources\/release.txt\";\n@@ -248,5 +247,7 @@\n-    private String jlinkReleaseInfo;\n-\n-    private static String getReleaseInfo(InputStream in) throws IOException {\n-        if (in == null) {\n-            return \"N\/A\";\n+    \/**\n+     * Read the release.txt from the module.\n+     *\/\n+    private static Optional<String> getReleaseInfo(ModuleReference mref) throws IOException {\n+        var in = mref.open().open(JDK_RELEASE_RESOURCE);\n+        if (in.isEmpty()) {\n+            return Optional.empty();\n@@ -255,2 +256,2 @@\n-        try (var r = new BufferedReader(new InputStreamReader(in))) {\n-            return r.readLine();\n+        try (var r = new BufferedReader(new InputStreamReader(in.get()))) {\n+            return Optional.of(r.readLine());\n@@ -279,5 +280,0 @@\n-            \/\/ Get jlink release.txt\n-            try (InputStream jlinkRelease = m.getResourceAsStream(JLINK_RELEASE_RESOURCE)) {\n-                jlinkReleaseInfo = getReleaseInfo(jlinkRelease);\n-            }\n-\n@@ -596,7 +592,16 @@\n-        assert finder.find(\"java.base\").isPresent();\n-        String jdkReleaseInfo = \"N\/A\";\n-\n-        try (var in = finder.find(\"java.base\").get().open().open(JDK_RELEASE_RESOURCE).orElse(null)) {\n-            jdkReleaseInfo = getReleaseInfo(in);\n-            if (jdkReleaseInfo.equals(jlinkReleaseInfo)) {\n-                return;\n+        try {\n+            ModuleReference current = ModuleLayer.boot()\n+                    .configuration()\n+                    .findModule(\"java.base\")\n+                    .get()\n+                    .reference();\n+            ModuleReference target = finder.find(\"java.base\").get();\n+            String currentRelease = getReleaseInfo(current).orElseThrow(() ->\n+                new IllegalArgumentException(\"Cannot find release.txt\"));\n+            String targetRelease = getReleaseInfo(target).orElse(\"N\/A\");\n+            if (! currentRelease.equals(targetRelease)) {\n+                \/\/ jlink version and java.base version do not match.\n+                \/\/ We do not (yet) support this mode.\n+                throw new IllegalArgumentException(taskHelper.getMessage(\"err.jlink.version.mismatch\",\n+                        currentRelease,\n+                        targetRelease));\n@@ -604,0 +609,2 @@\n+        } catch (NoSuchElementException e) {\n+            assert false : \"Should have found java.base module\";\n@@ -605,1 +612,1 @@\n-            \/\/ ignore and resume as version not match\n+            throw new UncheckedIOException(ioe);\n@@ -607,6 +614,0 @@\n-\n-        \/\/ jlink version and java.base version do not match.\n-        \/\/ We do not (yet) support this mode.\n-        throw new IllegalArgumentException(taskHelper.getMessage(\"err.jlink.version.mismatch\",\n-                jlinkReleaseInfo,\n-                jdkReleaseInfo));\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/internal\/JlinkTask.java","additions":29,"deletions":28,"binary":false,"changes":57,"status":"modified"},{"patch":"@@ -1,1 +0,0 @@\n-@@COMPANY_NAME@@-@@VERSION_STRING@@-@@VERSION_DATE@@\n","filename":"src\/jdk.jlink\/share\/classes\/jdk\/tools\/jlink\/resources\/release.txt.template","additions":0,"deletions":1,"binary":false,"changes":1,"status":"deleted"}]}