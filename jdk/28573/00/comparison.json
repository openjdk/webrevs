{"files":[{"patch":"@@ -307,3 +307,6 @@\n-    result = mem_allocate_cas_noexpand(size, is_tlab);\n-    if (result != nullptr) {\n-      break;\n+    {\n+      ConditionalMutexLocker locker(Heap_lock, !is_init_completed());\n+      result = mem_allocate_cas_noexpand(size, is_tlab);\n+      if (result != nullptr) {\n+        break;\n+      }\n@@ -323,4 +326,9 @@\n-        \/\/ Can't do GC; try heap expansion to satisfy the request.\n-        result = expand_heap_and_allocate(size, is_tlab);\n-        if (result != nullptr) {\n-          return result;\n+        \/\/ Double checked locking, this ensure that is_init_completed() does not\n+        \/\/ transition while expanding the heap.\n+        MonitorLocker ml(InitCompleted_lock, Monitor::_no_safepoint_check_flag);\n+        if (!is_init_completed()) {\n+          \/\/ Can't do GC; try heap expansion to satisfy the request.\n+          result = expand_heap_and_allocate(size, is_tlab);\n+          if (result != nullptr) {\n+            return result;\n+          }\n","filename":"src\/hotspot\/share\/gc\/serial\/serialHeap.cpp","additions":15,"deletions":7,"binary":false,"changes":22,"status":"modified"}]}