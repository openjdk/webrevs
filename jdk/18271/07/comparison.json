{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2015, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,0 +26,1 @@\n+ * @enablePreview\n@@ -28,1 +29,0 @@\n- * @modules java.base\/jdk.internal.org.objectweb.asm\n@@ -32,0 +32,3 @@\n+import java.lang.classfile.ClassFile;\n+import java.lang.constant.ClassDesc;\n+import java.lang.constant.MethodTypeDesc;\n@@ -33,3 +36,3 @@\n-import jdk.internal.org.objectweb.asm.ClassWriter;\n-import jdk.internal.org.objectweb.asm.MethodVisitor;\n-import jdk.internal.org.objectweb.asm.Opcodes;\n+\n+import static java.lang.classfile.ClassFile.*;\n+import static java.lang.constant.ConstantDescs.*;\n@@ -54,1 +57,1 @@\n-    static class TestClassLoader extends ClassLoader implements Opcodes {\n+    static class TestClassLoader extends ClassLoader{\n@@ -69,2 +72,1 @@\n-            ClassWriter cw = new ClassWriter(0);\n-            MethodVisitor mv;\n+            byte[] bytes = null;\n@@ -72,18 +74,13 @@\n-               case CLASS_NAME_A:\n-                    cw.visit(52, ACC_SUPER | ACC_PUBLIC, CLASS_NAME_A, null, \"java\/lang\/Object\", null);\n-                    {\n-                        mv = cw.visitMethod(ACC_PUBLIC, \"<init>\", \"()V\", null, null);\n-                        mv.visitCode();\n-                        mv.visitVarInsn(ALOAD, 0);\n-                        mv.visitMethodInsn(INVOKESPECIAL, \"java\/lang\/Object\", \"<init>\", \"()V\");\n-                        mv.visitInsn(RETURN);\n-                        mv.visitMaxs(1, 1);\n-                        mv.visitEnd();\n-\n-                        mv = cw.visitMethod(ACC_FINAL | ACC_STATIC, \"m\", \"()I\", null, null);\n-                        mv.visitCode();\n-                        mv.visitLdcInsn(FAILED);\n-                        mv.visitInsn(IRETURN);\n-                        mv.visitMaxs(1, 1);\n-                        mv.visitEnd();\n-                    }\n+                case CLASS_NAME_A:\n+                    bytes = ClassFile.of().build(ClassDesc.of(CLASS_NAME_A),\n+                            clb -> clb.withVersion(JAVA_8_VERSION, 0)\n+                                    .withFlags(ACC_PUBLIC + ACC_SUPER)\n+                                    .withSuperclass(CD_Object)\n+                                    .withMethodBody(INIT_NAME, MTD_void, ACC_PUBLIC,\n+                                            cob -> cob\n+                                                    .aload(0)\n+                                                    .invokespecial(CD_Object, INIT_NAME, MTD_void)\n+                                                    .return_())\n+                                    .withMethodBody(\"m\", MethodTypeDesc.of(CD_int), ACC_FINAL + ACC_STATIC,\n+                                            cob -> cob.ldc(FAILED).ireturn())\n+                    );\n@@ -91,10 +88,0 @@\n-                case CLASS_NAME_B:\n-                    cw.visit(52, ACC_SUPER | ACC_PUBLIC, CLASS_NAME_B, null, CLASS_NAME_A, null);\n-                    {\n-                        mv = cw.visitMethod(ACC_PUBLIC, \"<init>\", \"()V\", null, null);\n-                        mv.visitCode();\n-                        mv.visitVarInsn(ALOAD, 0);\n-                        mv.visitMethodInsn(INVOKESPECIAL, CLASS_NAME_A, \"<init>\", \"()V\");\n-                        mv.visitInsn(RETURN);\n-                        mv.visitMaxs(1, 1);\n-                        mv.visitEnd();\n@@ -102,8 +89,13 @@\n-                        mv = cw.visitMethod(ACC_PUBLIC, \"m\", \"()I\", null, null);\n-                        mv.visitCode();\n-                        mv.visitLdcInsn(EXPECTED);\n-                        mv.visitInsn(IRETURN);\n-                        mv.visitMaxs(1, 1);\n-                        mv.visitEnd();\n-\n-                    }\n+                case CLASS_NAME_B:\n+                    bytes = ClassFile.of().build(ClassDesc.ofInternalName(CLASS_NAME_B),\n+                            clb -> clb.withVersion(JAVA_8_VERSION, 0)\n+                                    .withFlags(ACC_PUBLIC + ACC_SUPER)\n+                                    .withSuperclass(ClassDesc.ofInternalName(CLASS_NAME_A))\n+                                    .withMethodBody(INIT_NAME, MTD_void, ACC_PUBLIC,\n+                                            cob -> cob\n+                                                    .aload(0)\n+                                                    .invokespecial(ClassDesc.ofInternalName(CLASS_NAME_A), INIT_NAME, MTD_void)\n+                                                    .return_())\n+                                    .withMethodBody(\"m\", MethodTypeDesc.of(CD_int), ACC_PUBLIC,\n+                                            cob -> cob.ldc(EXPECTED).ireturn())\n+                    );\n@@ -114,1 +106,0 @@\n-            cw.visitEnd();\n@@ -116,1 +107,1 @@\n-            return cw.toByteArray();\n+            return bytes;\n","filename":"test\/hotspot\/jtreg\/runtime\/finalStatic\/FinalStatic.java","additions":37,"deletions":46,"binary":false,"changes":83,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2023, Oracle and\/or its affiliates. All rights reserved.\n+     * Copyright (c) 2014, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,3 +26,8 @@\n-import jdk.internal.org.objectweb.asm.ClassWriter;\n-import jdk.internal.org.objectweb.asm.MethodVisitor;\n-import static jdk.internal.org.objectweb.asm.Opcodes.*;\n+import java.lang.classfile.ClassFile;\n+import java.lang.classfile.CodeBuilder;\n+import java.lang.constant.ClassDesc;\n+import java.lang.constant.MethodTypeDesc;\n+\n+import static java.lang.classfile.ClassFile.*;\n+import static java.lang.constant.ConstantDescs.*;\n+\n@@ -35,0 +40,1 @@\n+ * @enablePreview\n@@ -36,2 +42,1 @@\n- * @modules java.base\/jdk.internal.org.objectweb.asm\n- *          java.base\/jdk.internal.misc\n+ * @modules java.base\/jdk.internal.misc\n@@ -40,1 +45,1 @@\n- * @run driver OverriderMsg\n+ * @run main\/othervm --enable-preview OverriderMsg\n@@ -45,1 +50,1 @@\n-\/\/ asm part of the test creates these two classes:\n+\/\/ ClassFile part of the test creates these two classes:\n@@ -60,2 +65,1 @@\n-        ClassWriter cw = new ClassWriter(0);\n-        MethodVisitor mv;\n+        byte[] bytes;\n@@ -63,1 +67,15 @@\n-        cw.visit(V1_7, ACC_PUBLIC + ACC_SUPER, \"HasFinal\", null, \"java\/lang\/Object\", null);\n+        bytes = ClassFile.of().build(ClassDesc.of(\"HasFinal\"),\n+                    clb -> clb\n+                            .withVersion(JAVA_7_VERSION, 0)\n+                            .withFlags(ACC_PUBLIC + ACC_SUPER)\n+                            .withSuperclass(CD_Object)\n+\n+                            .withMethodBody(INIT_NAME, MTD_void, ACC_PUBLIC,\n+                                    cob -> cob\n+                                            .aload(0)\n+                                            .invokespecial(CD_Object, INIT_NAME, MTD_void)\n+                                            .return_())\n+\n+                            .withMethodBody(\"m\", MethodTypeDesc.ofDescriptor(\"(Ljava\/lang\/String;)V\"), ACC_PUBLIC + ACC_FINAL, CodeBuilder::return_)\n+\n+        );\n@@ -65,17 +83,0 @@\n-        {\n-            mv = cw.visitMethod(ACC_PUBLIC, \"<init>\", \"()V\", null, null);\n-            mv.visitCode();\n-            mv.visitVarInsn(ALOAD, 0);\n-            mv.visitMethodInsn(INVOKESPECIAL, \"java\/lang\/Object\", \"<init>\", \"()V\");\n-            mv.visitInsn(RETURN);\n-            mv.visitMaxs(1, 1);\n-            mv.visitEnd();\n-        }\n-        {\n-            mv = cw.visitMethod(ACC_PUBLIC + ACC_FINAL, \"m\", \"(Ljava\/lang\/String;)V\", null, null);\n-            mv.visitCode();\n-            mv.visitInsn(RETURN);\n-            mv.visitMaxs(0, 2);\n-            mv.visitEnd();\n-        }\n-        cw.visitEnd();\n@@ -83,1 +84,1 @@\n-             fos.write(cw.toByteArray());\n+             fos.write(bytes);\n@@ -90,28 +91,19 @@\n-        ClassWriter cw = new ClassWriter(0);\n-        MethodVisitor mv;\n-        cw.visit(V1_7, ACC_PUBLIC + ACC_SUPER, \"Overrider\", null, \"HasFinal\", null);\n-\n-        {\n-            mv = cw.visitMethod(ACC_PUBLIC, \"<init>\", \"()V\", null, null);\n-            mv.visitCode();\n-            mv.visitVarInsn(ALOAD, 0);\n-            mv.visitMethodInsn(INVOKESPECIAL, \"HasFinal\", \"<init>\", \"()V\");\n-            mv.visitInsn(RETURN);\n-            mv.visitMaxs(1, 1);\n-            mv.visitEnd();\n-        }\n-        {\n-            mv = cw.visitMethod(ACC_PUBLIC, \"m\", \"(Ljava\/lang\/String;)V\", null, null);\n-            mv.visitCode();\n-            mv.visitInsn(RETURN);\n-            mv.visitMaxs(0, 2);\n-            mv.visitEnd();\n-        }\n-        {\n-            mv = cw.visitMethod(ACC_PUBLIC + ACC_STATIC, \"main\", \"([Ljava\/lang\/String;)V\", null, null);\n-            mv.visitCode();\n-            mv.visitInsn(RETURN);\n-            mv.visitMaxs(0, 1);\n-            mv.visitEnd();\n-        }\n-        cw.visitEnd();\n+        byte[] bytes;\n+\n+        bytes = ClassFile.of().build(ClassDesc.of(\"Overrider\"),\n+                clb -> clb\n+                        .withVersion(JAVA_7_VERSION, 0)\n+                        .withFlags(ACC_PUBLIC + ACC_SUPER)\n+                        .withSuperclass(ClassDesc.of(\"HasFinal\"))\n+\n+                        .withMethodBody(INIT_NAME, MTD_void, ACC_PUBLIC,\n+                                cob -> cob\n+                                        .aload(0)\n+                                        .invokespecial(ClassDesc.ofInternalName(\"HasFinal\"), INIT_NAME, MTD_void)\n+                                        .return_())\n+\n+                        .withMethodBody(\"m\", MethodTypeDesc.ofDescriptor(\"(Ljava\/lang\/String;)V\"), ACC_PUBLIC, CodeBuilder::return_)\n+\n+                        .withMethodBody(\"main\", MethodTypeDesc.ofDescriptor(\"([Ljava\/lang\/String;)V\"), ACC_PUBLIC + ACC_STATIC, CodeBuilder::return_)\n+\n+        );\n@@ -120,1 +112,1 @@\n-             fos.write(cw.toByteArray());\n+             fos.write(bytes);\n","filename":"test\/hotspot\/jtreg\/runtime\/verifier\/OverriderMsg.java","additions":50,"deletions":58,"binary":false,"changes":108,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,3 +26,7 @@\n-import jdk.internal.org.objectweb.asm.ClassWriter;\n-import jdk.internal.org.objectweb.asm.MethodVisitor;\n-import static jdk.internal.org.objectweb.asm.Opcodes.*;\n+import java.lang.classfile.ClassFile;\n+import java.lang.constant.ClassDesc;\n+import java.lang.constant.MethodTypeDesc;\n+\n+\n+import static java.lang.classfile.ClassFile.*;\n+import static java.lang.constant.ConstantDescs.*;\n@@ -34,0 +38,1 @@\n+ * @enablePreview\n@@ -36,2 +41,1 @@\n- * @modules java.base\/jdk.internal.org.objectweb.asm\n- *          java.base\/jdk.internal.misc\n+ * @modules java.base\/jdk.internal.misc\n@@ -40,4 +44,4 @@\n- * @run driver TestMultiANewArray 49\n- * @run driver TestMultiANewArray 50\n- * @run driver TestMultiANewArray 51\n- * @run driver TestMultiANewArray 52\n+ * @run main\/othervm --enable-preview TestMultiANewArray 49\n+ * @run main\/othervm --enable-preview TestMultiANewArray 50\n+ * @run main\/othervm --enable-preview TestMultiANewArray 51\n+ * @run main\/othervm --enable-preview TestMultiANewArray 52\n@@ -58,21 +62,1 @@\n-        ClassWriter cw = new ClassWriter(0);\n-        MethodVisitor mv;\n-\n-        cw.visit(cfv, ACC_PUBLIC + ACC_SUPER, \"ClassFile\", null, \"java\/lang\/Object\", null);\n-        mv = cw.visitMethod(ACC_PUBLIC, \"<init>\", \"()V\", null, null);\n-        mv.visitCode();\n-        mv.visitVarInsn(ALOAD, 0);\n-        mv.visitMethodInsn(INVOKESPECIAL, \"java\/lang\/Object\", \"<init>\", \"()V\", false);\n-        mv.visitInsn(RETURN);\n-        mv.visitMaxs(1, 1);\n-        mv.visitEnd();\n-\n-        mv = cw.visitMethod(ACC_PUBLIC + ACC_STATIC, \"main\", \"([Ljava\/lang\/String;)V\", null, null);\n-        mv.visitCode();\n-        mv.visitInsn(ICONST_1);\n-        mv.visitInsn(ICONST_2);\n-        mv.visitMultiANewArrayInsn(\"[I\", 2);\n-        mv.visitVarInsn(ASTORE, 1);\n-        mv.visitInsn(RETURN);\n-        mv.visitMaxs(2, 2);\n-        mv.visitEnd();\n+        byte[] bytes;\n@@ -80,1 +64,19 @@\n-        cw.visitEnd();\n+        bytes = ClassFile.of().build(ClassDesc.of(\"ClassFile\"),\n+                    clb -> clb\n+                            .withVersion(cfv, 0)\n+                            .withSuperclass(CD_Object)\n+                            .withFlags(ACC_PUBLIC + ACC_SUPER)\n+                            .withMethodBody(INIT_NAME, MTD_void, ACC_PUBLIC,\n+                                    cob -> cob\n+                                            .aload(0)\n+                                            .invokespecial(CD_Object, INIT_NAME, MTD_void)\n+                                            .return_())\n+                            .withMethodBody(\"main\", MethodTypeDesc.of(CD_void, CD_String.arrayType()),ACC_PUBLIC + ACC_STATIC,\n+                                    cob -> cob\n+                                            .iconst_1()\n+                                            .iconst_2()\n+                                            .multianewarray(CD_int.arrayType(), 2)\n+                                            .astore(1)\n+                                            .return_()\n+                            )\n+        );\n@@ -83,1 +85,1 @@\n-             fos.write(cw.toByteArray());\n+             fos.write(bytes);\n","filename":"test\/hotspot\/jtreg\/runtime\/verifier\/TestMultiANewArray.java","additions":35,"deletions":33,"binary":false,"changes":68,"status":"modified"}]}