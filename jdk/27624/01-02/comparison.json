{"files":[{"patch":"@@ -664,0 +664,4 @@\n+\n+            if (debug != null) {\n+                emitWeakKeyStoreWarning();\n+            }\n@@ -866,5 +870,1 @@\n-                    debug.println(\"WARNING: JCEKS uses outdated cryptographic \"\n-                            + \"algorithms and will be removed in a future \"\n-                            + \"release. Migrate to PKCS12 using:\\n\"\n-                            + \"keytool -importkeystore -srckeystore <keystore> \"\n-                            + \"-destkeystore <keystore> -deststoretype pkcs12\");\n+                    emitWeakKeyStoreWarning();\n@@ -989,0 +989,8 @@\n+\n+    private void emitWeakKeyStoreWarning() {\n+        debug.println(\"WARNING: JCEKS uses outdated cryptographic \"\n+                + \"algorithms and will be removed in a future \"\n+                + \"release. Migrate to PKCS12 using:\\n\"\n+                + \"keytool -importkeystore -srckeystore <keystore> \"\n+                + \"-destkeystore <keystore> -deststoretype pkcs12\");\n+    }\n","filename":"src\/java.base\/share\/classes\/com\/sun\/crypto\/provider\/JceKeyStore.java","additions":13,"deletions":5,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -630,0 +630,4 @@\n+\n+            if (debug != null) {\n+                emitWeakKeyStoreWarning();\n+            }\n@@ -794,9 +798,1 @@\n-                String type = this.getClass().getSimpleName().\n-                        toUpperCase(Locale.ROOT);\n-                if (type.equals(\"JKS\")){\n-                    debug.println(\"WARNING: JKS uses outdated cryptographic \"\n-                            + \"algorithms and will be removed in a future \"\n-                            + \"release. Migrate to PKCS12 using:\\n\"\n-                            + \"keytool -importkeystore -srckeystore <keystore> \"\n-                            + \"-destkeystore <keystore> -deststoretype pkcs12\");\n-                }\n+                emitWeakKeyStoreWarning();\n@@ -853,0 +849,12 @@\n+\n+    private void emitWeakKeyStoreWarning() {\n+        String type = this.getClass().getSimpleName().\n+                toUpperCase(Locale.ROOT);\n+        if (type.equals(\"JKS\")){\n+            debug.println(\"WARNING: JKS uses outdated cryptographic \"\n+                    + \"algorithms and will be removed in a future \"\n+                    + \"release. Migrate to PKCS12 using:\\n\"\n+                    + \"keytool -importkeystore -srckeystore <keystore> \"\n+                    + \"-destkeystore <keystore> -deststoretype pkcs12\");\n+        }\n+    }\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/JavaKeyStore.java","additions":17,"deletions":9,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -170,0 +170,1 @@\n+    String realStoreType;\n@@ -1489,1 +1490,1 @@\n-                    store.getType(), keystore));\n+                    realStoreType, keystore));\n@@ -2432,3 +2433,16 @@\n-                    if (store.getType().equalsIgnoreCase(\"JKS\")\n-                            || store.getType().equalsIgnoreCase(\"JCEKS\")) {\n-                        weakKeyStore = true;\n+\n+                    File storeFile = new File(keyStoreName);\n+                    if (storeFile.exists()) {\n+                        \/\/ Probe for real type. A JKS can be loaded as PKCS12 because\n+                        \/\/ DualFormat support, vice versa.\n+                        try {\n+                            KeyStore keyStore = KeyStore.getInstance(storeFile, storepass);\n+                            realStoreType = keyStore.getType();\n+                            if (realStoreType.equalsIgnoreCase(\"JKS\")\n+                                    || realStoreType.equalsIgnoreCase(\"JCEKS\")) {\n+                                weakKeyStore = true;\n+                            }\n+                        } catch (KeyStoreException e) {\n+                            \/\/ Probing not supported, therefore cannot be JKS or JCEKS.\n+                            \/\/ Skip the legacy type warning at all.\n+                        }\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/security\/tools\/jarsigner\/Main.java","additions":18,"deletions":4,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -30,0 +30,3 @@\n+ * @modules java.base\/sun.security.tools.keytool\n+ *          java.base\/sun.security.x509\n+ * @run main\/othervm -Djava.security.debug=keystore OutdatedKeyStoreWarning\n@@ -32,0 +35,1 @@\n+import java.io.FileOutputStream;\n@@ -34,1 +38,0 @@\n-import java.io.File;\n@@ -36,0 +39,3 @@\n+import java.security.KeyStore;\n+import java.security.cert.Certificate;\n+import java.security.cert.X509Certificate;\n@@ -41,0 +47,3 @@\n+import sun.security.tools.keytool.CertAndKeyGen;\n+import sun.security.x509.X500Name;\n+\n@@ -94,0 +103,4 @@\n+\n+        for (String type : ksTypes) {\n+            checkStoreAPIWarning(type);\n+        }\n@@ -120,0 +133,39 @@\n+    \/\/ Test case for: KeyStore.getInstance(\"JKS\" or \"JCEKS\"), load(null, null), and\n+    \/\/ store it where warning should be emitted.\n+    private static void checkStoreAPIWarning(String type) throws Exception {\n+        ByteArrayOutputStream bOut = new ByteArrayOutputStream();\n+        PrintStream origErr = System.err;\n+        PrintStream origOut = System.out;\n+\n+        try {\n+            PrintStream pStream = new PrintStream(bOut);\n+            System.setErr(pStream);\n+            System.setOut(pStream);\n+\n+            KeyStore ks = KeyStore.getInstance(type);\n+            ks.load(null, null);\n+\n+            CertAndKeyGen cag = new CertAndKeyGen(\"EC\", \"SHA256withECDSA\");\n+            cag.generate(\"secp256r1\");\n+            X509Certificate cert = cag.getSelfCertificate(new X500Name(\"CN=one\"), 3600);\n+            ks.setKeyEntry(\"dummy\", cag.getPrivateKey(), \"changeit\".toCharArray(),\n+                    new Certificate[] {cert});\n+\n+            try (FileOutputStream fos = new FileOutputStream(type.toLowerCase() +\n+                    \"_storeAPI.ks\")) {\n+                ks.store(fos, \"changeit\".toCharArray());\n+            }\n+        } finally {\n+            System.setErr(origErr);\n+            System.setOut(origOut);\n+        }\n+\n+        String msg = bOut.toString();\n+        if (!msg.contains(\"WARNING: \" + type.toUpperCase(Locale.ROOT)) ||\n+                !msg.contains(KS_WARNING1) ||\n+                !msg.contains(KS_WARNING2)) {\n+            throw new RuntimeException(\"Expected warning not found for KeyStore.store() API (\" +\n+                    type + \"):\\n\" + msg);\n+        }\n+    }\n+\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/OutdatedKeyStoreWarning.java","additions":53,"deletions":1,"binary":false,"changes":54,"status":"modified"}]}