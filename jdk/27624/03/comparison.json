{"files":[{"patch":"@@ -664,0 +664,4 @@\n+\n+            if (debug != null) {\n+                emitWeakKeyStoreWarning();\n+            }\n@@ -865,0 +869,4 @@\n+                if (debug != null) {\n+                    emitWeakKeyStoreWarning();\n+                }\n+\n@@ -981,0 +989,8 @@\n+\n+    private void emitWeakKeyStoreWarning() {\n+        debug.println(\"WARNING: JCEKS uses outdated cryptographic \"\n+                + \"algorithms and will be removed in a future \"\n+                + \"release. Migrate to PKCS12 using:\\n\"\n+                + \"keytool -importkeystore -srckeystore <keystore> \"\n+                + \"-destkeystore <keystore> -deststoretype pkcs12\");\n+    }\n","filename":"src\/java.base\/share\/classes\/com\/sun\/crypto\/provider\/JceKeyStore.java","additions":16,"deletions":0,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -630,0 +630,4 @@\n+\n+            if (debug != null) {\n+                emitWeakKeyStoreWarning();\n+            }\n@@ -793,0 +797,4 @@\n+            if (debug != null) {\n+                emitWeakKeyStoreWarning();\n+            }\n+\n@@ -841,0 +849,12 @@\n+\n+    private void emitWeakKeyStoreWarning() {\n+        String type = this.getClass().getSimpleName().\n+                toUpperCase(Locale.ROOT);\n+        if (type.equals(\"JKS\")){\n+            debug.println(\"WARNING: JKS uses outdated cryptographic \"\n+                    + \"algorithms and will be removed in a future \"\n+                    + \"release. Migrate to PKCS12 using:\\n\"\n+                    + \"keytool -importkeystore -srckeystore <keystore> \"\n+                    + \"-destkeystore <keystore> -deststoretype pkcs12\");\n+        }\n+    }\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/JavaKeyStore.java","additions":21,"deletions":1,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -324,1 +324,2 @@\n-jks.storetype.warning=The %1$s keystore uses a proprietary format. It is recommended to migrate to PKCS12 which is an industry standard format using \"keytool -importkeystore -srckeystore %2$s -destkeystore %2$s -deststoretype pkcs12\".\n+jks.storetype.warning=%1$s uses outdated cryptographic algorithms and will be removed in a future release. Migrate to PKCS12 using:\\n\\\n+keytool -importkeystore -srckeystore %2$s -destkeystore %2$s -deststoretype pkcs12\n","filename":"src\/java.base\/share\/classes\/sun\/security\/tools\/keytool\/resources\/keytool.properties","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -170,0 +170,1 @@\n+    String realStoreType;\n@@ -243,0 +244,1 @@\n+    private boolean weakKeyStore = false;\n@@ -1485,0 +1487,6 @@\n+        if (weakKeyStore) {\n+            warnings.add(String.format(rb.getString(\n+                    \"jks.storetype.warning\"),\n+                    realStoreType, keystore));\n+        }\n+\n@@ -2425,0 +2433,17 @@\n+\n+                    File storeFile = new File(keyStoreName);\n+                    if (storeFile.exists()) {\n+                        \/\/ Probe for real type. A JKS can be loaded as PKCS12 because\n+                        \/\/ DualFormat support, vice versa.\n+                        try {\n+                            KeyStore keyStore = KeyStore.getInstance(storeFile, storepass);\n+                            realStoreType = keyStore.getType();\n+                            if (realStoreType.equalsIgnoreCase(\"JKS\")\n+                                    || realStoreType.equalsIgnoreCase(\"JCEKS\")) {\n+                                weakKeyStore = true;\n+                            }\n+                        } catch (KeyStoreException e) {\n+                            \/\/ Probing not supported, therefore cannot be JKS or JCEKS.\n+                            \/\/ Skip the legacy type warning at all.\n+                        }\n+                    }\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/security\/tools\/jarsigner\/Main.java","additions":25,"deletions":0,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -225,0 +225,2 @@\n+jks.storetype.warning=%1$s uses outdated cryptographic algorithms and will be removed in a future release. Migrate to PKCS12 using:\\n\\\n+keytool -importkeystore -srckeystore %2$s -destkeystore %2$s -deststoretype pkcs12\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/security\/tools\/jarsigner\/resources\/jarsigner.properties","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -853,0 +853,3 @@\n+\n+            if (line.contains(Test.OUTDATED_KEYSTORE_WARNING1)) continue;\n+            if (line.contains(Test.OUTDATED_KEYSTORE_WARNING2)) continue;\n","filename":"test\/jdk\/sun\/security\/tools\/jarsigner\/compatibility\/Compatibility.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -154,0 +154,7 @@\n+    static final String OUTDATED_KEYSTORE_WARNING1\n+            = \"uses outdated cryptographic algorithms and will be \"\n+            + \"removed in a future release. Migrate to PKCS12 using:\";\n+\n+    static final String OUTDATED_KEYSTORE_WARNING2\n+            = \"keytool -importkeystore -srckeystore\";\n+\n","filename":"test\/jdk\/sun\/security\/tools\/jarsigner\/warnings\/Test.java","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -0,0 +1,176 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8353749\n+ * @summary Validate that keytool and jarsigner emit warnings for\n+ *         JKS and JCEKS keystore with java.security.debug=keystore\n+ * @library \/test\/lib\n+ * @modules java.base\/sun.security.tools.keytool\n+ *          java.base\/sun.security.x509\n+ * @run main\/othervm -Djava.security.debug=keystore OutdatedKeyStoreWarning\n+ *\/\n+\n+import java.io.FileOutputStream;\n+import java.nio.file.Path;\n+import java.io.ByteArrayOutputStream;\n+import java.io.PrintStream;\n+import java.security.KeyStore;\n+import java.security.cert.Certificate;\n+import java.security.cert.X509Certificate;\n+import java.util.Locale;\n+\n+import jdk.test.lib.SecurityTools;\n+import jdk.test.lib.util.JarUtils;\n+\n+import sun.security.tools.keytool.CertAndKeyGen;\n+import sun.security.x509.X500Name;\n+\n+public class OutdatedKeyStoreWarning {\n+\n+    private static final String KS_WARNING1 =\n+            \"uses outdated cryptographic algorithms and will be removed \" +\n+            \"in a future release. Migrate to PKCS12 using:\";\n+\n+    private static final String KS_WARNING2=\n+            \"keytool -importkeystore -srckeystore <keystore> \" +\n+            \"-destkeystore <keystore> -deststoretype pkcs12\";\n+\n+    public static void main(String[] args) throws Exception {\n+        String[] ksTypes = {\"JKS\", \"JCEKS\"};\n+\n+        for (String type : ksTypes) {\n+            String ksFile = type.toLowerCase() + \".ks\";\n+            String cmdWarning = type + \" \" + KS_WARNING1;\n+\n+            checkWarnings(type, () -> {\n+                SecurityTools.keytool(String.format(\n+                        \"-genkeypair -keystore %s -storetype %s -storepass changeit \" +\n+                        \"-keypass changeit -keyalg ec -alias a1 -dname CN=me \" +\n+                        \"-J-Djava.security.debug=keystore\",\n+                        ksFile, type.toLowerCase()))\n+                        .shouldContain(\"Warning:\")\n+                        .shouldContain(cmdWarning)\n+                        .shouldContain(KS_WARNING2)\n+                        .shouldHaveExitValue(0);\n+            });\n+\n+            JarUtils.createJarFile(Path.of(\"unsigned.jar\"), Path.of(\".\"), Path.of(ksFile));\n+            checkWarnings(type, () -> {\n+                SecurityTools.jarsigner(String.format(\n+                        \"-keystore %s -storetype %s -storepass changeit -signedjar signed.jar \" +\n+                        \"unsigned.jar a1 \" +\n+                        \"-J-Djava.security.debug=keystore\",\n+                        ksFile, type.toLowerCase()))\n+                        .shouldContain(\"Warning:\")\n+                        .shouldContain(cmdWarning)\n+                        .shouldContain(KS_WARNING2)\n+                        .shouldHaveExitValue(0);\n+            });\n+\n+            checkWarnings(type, () -> {\n+                SecurityTools.jarsigner(String.format(\n+                        \"-verify -keystore %s -storetype %s -storepass changeit signed.jar \" +\n+                        \"-J-Djava.security.debug=keystore\",\n+                        ksFile, type.toLowerCase()))\n+                        .shouldContain(\"Warning:\")\n+                        .shouldContain(cmdWarning)\n+                        .shouldContain(KS_WARNING2)\n+                        .shouldHaveExitValue(0);\n+            });\n+        }\n+\n+        for (String type : ksTypes) {\n+            checkStoreAPIWarning(type);\n+        }\n+    }\n+\n+    private static void checkWarnings(String type, RunnableWithException r) throws Exception {\n+        ByteArrayOutputStream bOut = new ByteArrayOutputStream();\n+        PrintStream origErr = System.err;\n+        PrintStream origOut = System.out;\n+\n+        try {\n+            PrintStream pStream = new PrintStream(bOut);\n+            System.setErr(pStream);\n+            System.setOut(pStream);\n+            r.run();\n+        } finally {\n+            System.setErr(origErr);\n+            System.setOut(origOut);\n+        }\n+\n+        String msg = bOut.toString();\n+        if (!msg.contains(\"WARNING: \" + type.toUpperCase(Locale.ROOT)) ||\n+                !msg.contains(KS_WARNING1) ||\n+                !msg.contains(KS_WARNING2) ||\n+                !msg.contains(\"Warning:\")) {\n+            throw new RuntimeException(\"Expected warning not found for \" + type + \":\\n\" + msg);\n+        }\n+    }\n+\n+    \/\/ Test case for: KeyStore.getInstance(\"JKS\" or \"JCEKS\"), load(null, null), and\n+    \/\/ store it where warning should be emitted.\n+    private static void checkStoreAPIWarning(String type) throws Exception {\n+        ByteArrayOutputStream bOut = new ByteArrayOutputStream();\n+        PrintStream origErr = System.err;\n+        PrintStream origOut = System.out;\n+\n+        try {\n+            PrintStream pStream = new PrintStream(bOut);\n+            System.setErr(pStream);\n+            System.setOut(pStream);\n+\n+            KeyStore ks = KeyStore.getInstance(type);\n+            ks.load(null, null);\n+\n+            CertAndKeyGen cag = new CertAndKeyGen(\"EC\", \"SHA256withECDSA\");\n+            cag.generate(\"secp256r1\");\n+            X509Certificate cert = cag.getSelfCertificate(new X500Name(\"CN=one\"), 3600);\n+            ks.setKeyEntry(\"dummy\", cag.getPrivateKey(), \"changeit\".toCharArray(),\n+                    new Certificate[] {cert});\n+\n+            try (FileOutputStream fos = new FileOutputStream(type.toLowerCase() +\n+                    \"_storeAPI.ks\")) {\n+                ks.store(fos, \"changeit\".toCharArray());\n+            }\n+        } finally {\n+            System.setErr(origErr);\n+            System.setOut(origOut);\n+        }\n+\n+        String msg = bOut.toString();\n+        if (!msg.contains(\"WARNING: \" + type.toUpperCase(Locale.ROOT)) ||\n+                !msg.contains(KS_WARNING1) ||\n+                !msg.contains(KS_WARNING2)) {\n+            throw new RuntimeException(\"Expected warning not found for KeyStore.store() API (\" +\n+                    type + \"):\\n\" + msg);\n+        }\n+    }\n+\n+    @FunctionalInterface\n+    interface RunnableWithException {\n+        void run() throws Exception;\n+    }\n+}\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/OutdatedKeyStoreWarning.java","additions":176,"deletions":0,"binary":false,"changes":176,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2017, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2017, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug 8171319 8177569 8182879 8172404\n+ * @bug 8171319 8177569 8182879 8172404 8353749\n@@ -229,1 +229,2 @@\n-                .shouldNotContain(\"proprietary format\");\n+                .shouldNotContain(\"outdated cryptographic algorithms\")\n+                .shouldNotContain(\"keytool -importkeystore -srckeystore\");\n@@ -245,1 +246,4 @@\n-                .shouldContain(\"JKS keystore uses a proprietary format\");\n+                .shouldContain(\"JKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -255,1 +259,4 @@\n-                .shouldContain(\"JKS keystore uses a proprietary format\");\n+                .shouldContain(\"JKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -257,1 +264,4 @@\n-                .shouldContain(\"JKS keystore uses a proprietary format\");\n+                .shouldContain(\"JKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -259,1 +269,4 @@\n-                .shouldContain(\"JKS keystore uses a proprietary format\");\n+                .shouldContain(\"JKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -261,1 +274,4 @@\n-                .shouldContain(\"JKS keystore uses a proprietary format\");\n+                .shouldContain(\"JKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -263,1 +279,4 @@\n-                .shouldContain(\"JKS keystore uses a proprietary format\");\n+                .shouldContain(\"JKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -265,1 +284,4 @@\n-                .shouldContain(\"JKS keystore uses a proprietary format\");\n+                .shouldContain(\"JKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -279,1 +301,4 @@\n-                .shouldContain(\"JCEKS keystore uses a proprietary format\");\n+                .shouldContain(\"JCEKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -281,1 +306,4 @@\n-                .shouldContain(\"JCEKS keystore uses a proprietary format\");\n+                .shouldContain(\"JCEKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -283,1 +311,4 @@\n-                .shouldContain(\"JCEKS keystore uses a proprietary format\");\n+                .shouldContain(\"JCEKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -285,1 +316,4 @@\n-                .shouldContain(\"JCEKS keystore uses a proprietary format\");\n+                .shouldContain(\"JCEKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -287,1 +321,4 @@\n-                .shouldContain(\"JCEKS keystore uses a proprietary format\");\n+                .shouldContain(\"JCEKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -289,1 +326,4 @@\n-                .shouldContain(\"JCEKS keystore uses a proprietary format\");\n+                .shouldContain(\"JCEKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -293,1 +333,4 @@\n-                .shouldContain(\"JCEKS keystore uses a proprietary format\");\n+                .shouldContain(\"JCEKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\");\n@@ -339,1 +382,4 @@\n-                .shouldContain(\"JKS keystore uses a proprietary format\")\n+                .shouldContain(\"JKS uses outdated cryptographic algorithms\" +\n+                        \" and will be removed\")\n+                .shouldMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\")\n@@ -349,1 +395,3 @@\n-                .shouldNotContain(\"proprietary format\")\n+                .shouldNotContain(\"outdated cryptographic algorithms\")\n+                .shouldNotMatch(\"keytool -importkeystore -srckeystore.\" +\n+                        \"*-destkeystore.*-deststoretype pkcs12\")\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/WeakAlg.java","additions":67,"deletions":19,"binary":false,"changes":86,"status":"modified"}]}