{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2008, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2008, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,1 +28,0 @@\n-import java.io.IOError;\n@@ -31,0 +30,1 @@\n+import java.net.URI;\n@@ -33,1 +33,0 @@\n-import java.nio.file.FileSystems;\n@@ -35,1 +34,0 @@\n-import java.nio.file.InvalidPathException;\n@@ -40,0 +38,1 @@\n+import java.util.HashMap;\n@@ -41,0 +40,1 @@\n+import java.util.Map;\n@@ -166,0 +166,26 @@\n+    \/\/ Must match the keys\/values expected by ZipFileSystem.java.\n+    private static final Map<String, String> READ_ONLY_JARFS_ENV = Map.of(\n+            \/\/ Jar files opened by Javac should always be read-only.\n+            \"accessMode\", \"readOnly\",\n+            \/\/ ignores timestamps not stored in ZIP central directory, reducing I\/O.\n+            \"zipinfo-time\", \"false\");\n+\n+    \/**\n+     * Returns a {@link java.nio.file.FileSystem FileSystem} environment map\n+     * suitable for creating read-only JAR file-systems with default timestamp\n+     * information via {@link FileSystemProvider#newFileSystem(Path, Map)}\n+     * or {@link java.nio.file.FileSystems#newFileSystem(Path, Map)}.\n+     *\n+     * @param releaseVersion the release version to use when creating a\n+     *                       file-system from a multi-release JAR (or\n+     *                       {@code null} to ignore release versioning).\n+     *\/\n+    public Map<String, ?> readOnlyJarFSEnv(String releaseVersion) {\n+        if (releaseVersion == null) {\n+            return READ_ONLY_JARFS_ENV;\n+        }\n+        \/\/ Multi-release JARs need an additional attribute.\n+        Map<String, String> env = new HashMap<>(READ_ONLY_JARFS_ENV);\n+        env.put(\"releaseVersion\", releaseVersion);\n+        return Collections.unmodifiableMap(env);\n+    }\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/FSInfo.java","additions":30,"deletions":4,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -564,5 +564,0 @@\n-            Map<String,String> env = new HashMap<>();\n-            \/\/ ignores timestamps not stored in ZIP central directory, reducing I\/O\n-            \/\/ This key is handled by ZipFileSystem only.\n-            env.put(\"zipinfo-time\", \"false\");\n-\n@@ -570,1 +565,0 @@\n-                env.put(\"multi-release\", multiReleaseValue);\n@@ -573,0 +567,1 @@\n+                Map<String, ?> env = fsInfo.readOnlyJarFSEnv(multiReleaseValue);\n@@ -580,2 +575,5 @@\n-                \/\/ or if non \"*.jar\" files are on the classpath.\n-                this.fileSystem = FileSystems.newFileSystem(archivePath, env, (ClassLoader)null);\n+                \/\/ or if non \"*.jar\" files are on the classpath. If this is not a ZIP\/JAR file then it\n+                \/\/ will ignore ZIP specific parameters in env, and may not end up being read-only.\n+                \/\/ However, Javac should never attempt to write back to archives either way.\n+                Map<String, ?> env = fsInfo.readOnlyJarFSEnv(null);\n+                this.fileSystem = FileSystems.newFileSystem(archivePath, env);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/JavacFileManager.java","additions":6,"deletions":8,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -84,2 +84,0 @@\n-import com.sun.tools.javac.code.Lint;\n-import com.sun.tools.javac.code.Lint.LintCategory;\n@@ -88,1 +86,0 @@\n-import com.sun.tools.javac.resources.CompilerProperties.Warnings;\n@@ -91,1 +88,0 @@\n-import com.sun.tools.javac.util.JCDiagnostic.Warning;\n@@ -144,1 +140,1 @@\n-    private Map<String,String> fsEnv = Collections.emptyMap();\n+    private String releaseVersion = null;\n@@ -236,1 +232,2 @@\n-        fsEnv = Collections.singletonMap(\"releaseVersion\", multiReleaseValue);\n+        \/\/ Null is implicitly allowed and unsets the value.\n+        this.releaseVersion = multiReleaseValue;\n@@ -483,1 +480,1 @@\n-         * @see JavaFileManager#getLocationForModule(Location, JavaFileObject, String)\n+         * @see JavaFileManager#getLocationForModule(Location, JavaFileObject)\n@@ -1390,1 +1387,1 @@\n-                    try (FileSystem fs = jarFSProvider.newFileSystem(p, fsEnv)) {\n+                    try (FileSystem fs = jarFSProvider.newFileSystem(p, fsInfo.readOnlyJarFSEnv(releaseVersion))) {\n@@ -1466,1 +1463,1 @@\n-                            fs = jarFSProvider.newFileSystem(p, Collections.emptyMap());\n+                            fs = jarFSProvider.newFileSystem(p, fsInfo.readOnlyJarFSEnv(null));\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/Locations.java","additions":6,"deletions":9,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -54,1 +54,0 @@\n-import javax.tools.JavaFileManager.Location;\n@@ -57,1 +56,0 @@\n-import javax.tools.StandardJavaFileManager;\n@@ -67,0 +65,1 @@\n+import com.sun.tools.javac.util.Assert;\n@@ -99,0 +98,8 @@\n+    \/\/ These must match attributes defined in ZipFileSystem.java.\n+    private static final Map<String, ?> CT_SYM_ZIP_ENV = Map.of(\n+            \/\/ Symbol file should always be opened read-only.\n+            \"accessMode\", \"readOnly\",\n+            \/\/ Uses less accurate, but faster, timestamp information\n+            \/\/ (nobody should care about timestamps in the CT symbol file).\n+            \"zipinfo-time\", \"false\");\n+\n@@ -120,1 +127,1 @@\n-            try (FileSystem fs = FileSystems.newFileSystem(ctSymFile, (ClassLoader)null);\n+            try (FileSystem fs = FileSystems.newFileSystem(ctSymFile, CT_SYM_ZIP_ENV);\n@@ -252,1 +259,5 @@\n-                        ctSym2FileSystem.put(file, fs = FileSystems.newFileSystem(file, (ClassLoader)null));\n+                        fs = FileSystems.newFileSystem(file, CT_SYM_ZIP_ENV);\n+                        \/\/ If for any reason this was not opened from a ZIP file,\n+                        \/\/ then the resulting file system would not be read-only.\n+                        Assert.check(fs.isReadOnly());\n+                        ctSym2FileSystem.put(file, fs);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/platform\/JDKPlatformProvider.java","additions":16,"deletions":5,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -40,0 +40,1 @@\n+import java.util.Map;\n@@ -163,1 +164,1 @@\n-            zipfs = FileSystems.newFileSystem(testZip);\n+            zipfs = FileSystems.newFileSystem(testZip, Map.of(\"accessMode\", \"readOnly\"));\n","filename":"test\/langtools\/tools\/javac\/api\/file\/SJFM_TestBase.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n","filename":"test\/langtools\/tools\/javac\/jvm\/ClassRefDupInConstantPoolTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug 8331027\n+ * @bug 8331027, 8356645\n@@ -30,0 +30,1 @@\n+ *          jdk.compiler\/com.sun.tools.javac.file\n@@ -47,0 +48,1 @@\n+import java.util.Map;\n@@ -63,1 +65,7 @@\n-        try (FileSystem fs = FileSystems.newFileSystem(ctSym)) {\n+        \/\/ Expected to always be a ZIP filesystem.\n+        Map<String, ?> env = Map.of(\"accessMode\", \"readOnly\");\n+        try (FileSystem fs = FileSystems.newFileSystem(ctSym, env)) {\n+            \/\/ Check that the file system is read only (not true if not a zip file system).\n+            if (!fs.isReadOnly()) {\n+                throw new AssertionError(\"Expected read-only file system\");\n+            }\n","filename":"test\/langtools\/tools\/javac\/platform\/VerifyCTSymClassFiles.java","additions":11,"deletions":3,"binary":false,"changes":14,"status":"modified"}]}