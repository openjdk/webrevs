{"files":[{"patch":"@@ -730,5 +730,7 @@\n-    \/\/ Try to find bind address of preferred address family first.\n-    for (ai = addrInfo; ai != NULL; ai = ai->ai_next) {\n-        if (ai->ai_family == preferredAddressFamily) {\n-            listenAddr = ai;\n-            break;\n+    \/\/ Try to find bind address of preferred address family first (if java.net.preferIPv6Addresses != \"system\").\n+    if (preferredAddressFamily != AF_UNSPEC) {\n+        for (ai = addrInfo; ai != NULL; ai = ai->ai_next) {\n+            if (ai->ai_family == preferredAddressFamily) {\n+                listenAddr = ai;\n+                break;\n+            }\n@@ -746,1 +748,1 @@\n-    \/\/ mapped INADDR_ANY if preferredAddressFamily is AF_INET6 or not set.\n+    \/\/ mapped INADDR_ANY if preferIPv4Stack is false.\n@@ -748,1 +750,1 @@\n-    if (preferredAddressFamily != AF_INET) {\n+    if (!allowOnlyIPv4) {\n@@ -970,2 +972,4 @@\n-    \/* 1st pass - preferredAddressFamily (by default IPv4), 2nd pass - the rest *\/\n-    for (pass = 0; pass < 2 && socketFD < 0; pass++) {\n+    \/\/ 1st pass - preferredAddressFamily (by default IPv4), 2nd pass - the rest;\n+    \/\/ if java.net.preferIPv6Addresses == \"system\", only 2nd pass is needed\n+    pass = preferredAddressFamily != AF_UNSPEC ? 0 : 1;\n+    for (; pass < 2 && socketFD < 0; pass++) {\n@@ -1308,0 +1312,37 @@\n+\/*\n+ * Reads java.net.preferIPv6Addresses system value, sets preferredAddressFamily to\n+ *  - AF_INET6 if the property is \"true\";\n+ *  - AF_INET if the property is \"false\".\n+ *  - AF_UNSPEC if the property is \"system\".\n+ * Doesn't change preferredAddressFamily if the property is not set or failed to read.\n+ *\/\n+static int readPreferIPv6Addresses(JNIEnv* jniEnv,\n+    jclass sysClass, jmethodID getPropMethod, const char *propName)\n+{\n+    jstring value;\n+    jstring name = (*jniEnv)->NewStringUTF(jniEnv, propName);\n+\n+    if (name == NULL) {\n+        return JNI_ERR;\n+    }\n+    value = (jstring)(*jniEnv)->CallStaticObjectMethod(jniEnv, sysClass, getPropMethod, name);\n+    if ((*jniEnv)->ExceptionCheck(jniEnv)) {\n+        return JNI_ERR;\n+    }\n+    if (value != NULL) {\n+        const char *theValue = (*jniEnv)->GetStringUTFChars(jniEnv, value, NULL);\n+        if (theValue == NULL) {\n+            return JNI_ERR;\n+        }\n+        if (strcmp(theValue, \"true\") == 0) {\n+            preferredAddressFamily = AF_INET6;\n+        } else if (strcmp(theValue, \"false\") == 0) {\n+            preferredAddressFamily = AF_INET;\n+        } else if (strcmp(theValue, \"system\") == 0) {\n+            preferredAddressFamily = AF_UNSPEC;\n+        }\n+        (*jniEnv)->ReleaseStringUTFChars(jniEnv, value, theValue);\n+    }\n+    return JNI_OK;\n+}\n+\n@@ -1365,1 +1406,1 @@\n-        readBooleanSysProp(&preferredAddressFamily, AF_INET6, AF_INET,\n+        readPreferIPv6Addresses(\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libdt_socket\/socketTransport.c","additions":51,"deletions":10,"binary":false,"changes":61,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+import java.util.Objects;\n@@ -42,1 +43,1 @@\n- * @bug 8184770\n+ * @bug 8184770 8313804\n@@ -47,1 +48,1 @@\n- * @run main\/othervm JdwpNetProps\n+ * @run main\/othervm -Djava.net.preferIPv6Addresses=system JdwpNetProps\n@@ -63,0 +64,7 @@\n+        String preferIPv6Address = System.getProperty(\"java.net.preferIPv6Addresses\");\n+        if (!Objects.equals(preferIPv6Address, \"system\")) {\n+          throw new AssertionError(\n+              \"Expected -Djava.net.preferIPv6Address=system, was \" + preferIPv6Address);\n+        }\n+        boolean systemPrefersIPv6 = addrs[0] instanceof Inet6Address;\n+\n@@ -67,0 +75,8 @@\n+            new ListenTest(\"localhost\", ipv4Address)\n+                    .preferIPv4Stack(true)\n+                    .preferIPv6Addresses(\"true\")\n+                    .run(TestResult.Success);\n+            new ListenTest(\"localhost\", ipv4Address)\n+                    .preferIPv4Stack(true)\n+                    .preferIPv6Addresses(\"system\")\n+                    .run(TestResult.Success);\n@@ -71,1 +87,1 @@\n-                \/\/ - only IPv4, so connection prom IPv6 should fail\n+                \/\/ - only IPv4, so connection from IPv6 should fail\n@@ -74,1 +90,5 @@\n-                        .preferIPv6Addresses(true)\n+                        .preferIPv6Addresses(\"true\")\n+                        .run(TestResult.AttachFailed);\n+                new ListenTest(\"localhost\", ipv6Address)\n+                        .preferIPv4Stack(true)\n+                        .preferIPv6Addresses(\"system\")\n@@ -78,1 +98,4 @@\n-                        .preferIPv6Addresses(false)\n+                        .preferIPv6Addresses(\"false\")\n+                        .run(TestResult.AttachFailed);\n+                \/\/ - listen on IPv4 (preferIPv6Addresses defaults to false)\n+                new ListenTest(\"localhost\", ipv6Address)\n@@ -82,1 +105,1 @@\n-                        .preferIPv6Addresses(true)\n+                        .preferIPv6Addresses(\"true\")\n@@ -84,0 +107,13 @@\n+                new ListenTest(\"localhost\", ipv6Address)\n+                        .preferIPv6Addresses(\"system\")\n+                        .run(systemPrefersIPv6 ? TestResult.Success : TestResult.AttachFailed);\n+                \/\/ - listen on IPv6, connect from IPv4\n+                new ListenTest(\"localhost\", ipv4Address)\n+                        .preferIPv4Stack(false)\n+                        .preferIPv6Addresses(\"true\")\n+                        .run(TestResult.AttachFailed);\n+                \/\/ - listen on system preference, connect from IPv4\n+                new ListenTest(\"localhost\", ipv4Address)\n+                        .preferIPv4Stack(false)\n+                        .preferIPv6Addresses(\"system\")\n+                        .run(systemPrefersIPv6 ? TestResult.AttachFailed : TestResult.Success);\n@@ -86,0 +122,4 @@\n+            if (!systemPrefersIPv6) {\n+                throw new AssertionError(\"The system is IPv6-only, but systemPrefersIPv6 was unexpectedly false\");\n+            }\n+\n@@ -90,0 +130,16 @@\n+            new ListenTest(\"localhost\", ipv6Address)\n+                    .preferIPv4Stack(true)\n+                    .preferIPv6Addresses(\"system\")\n+                    .run(TestResult.ListenFailed);\n+            new ListenTest(\"localhost\", ipv6Address)\n+                    .preferIPv4Stack(true)\n+                    .preferIPv6Addresses(\"true\")\n+                    .run(TestResult.ListenFailed);\n+            new ListenTest(\"localhost\", ipv6Address)\n+                    .run(TestResult.Success);\n+            new ListenTest(\"localhost\", ipv6Address)\n+                    .preferIPv6Addresses(\"system\")\n+                    .run(TestResult.Success);\n+            new ListenTest(\"localhost\", ipv6Address)\n+                    .preferIPv6Addresses(\"true\")\n+                    .run(TestResult.Success);\n@@ -103,1 +159,1 @@\n-        private Boolean preferIPv6Addresses;\n+        private String preferIPv6Addresses;\n@@ -112,1 +168,1 @@\n-        public ListenTest preferIPv6Addresses(Boolean value) {\n+        public ListenTest preferIPv6Addresses(String value) {\n@@ -123,1 +179,1 @@\n-                options.add(\"-Djava.net.preferIPv6Addresses=\" + preferIPv6Addresses.toString());\n+                options.add(\"-Djava.net.preferIPv6Addresses=\" + preferIPv6Addresses);\n@@ -204,0 +260,1 @@\n+\n","filename":"test\/jdk\/com\/sun\/jdi\/JdwpNetProps.java","additions":66,"deletions":9,"binary":false,"changes":75,"status":"modified"}]}