{"files":[{"patch":"@@ -32,0 +32,1 @@\n+import jdk.test.lib.security.DataFetcher;\n@@ -48,3 +49,11 @@\n-        test(readCMS(\"mldsa44-signed-attrs.pem\"), readCert(\"ML-DSA-44.crt\"));\n-        test(readCMS(\"mldsa65-signed-attrs.pem\"), readCert(\"ML-DSA-65.crt\"));\n-        test(readCMS(\"mldsa87-signed-attrs.pem\"), readCert(\"ML-DSA-87.crt\"));\n+        try (var cmsFetcher = DataFetcher.of(CMS_ML_DSA.class,\n+                    \"cms-ml-dsa-draft-ietf-lamps-cms-ml-dsa-07\/\");\n+            var dsaFetcher = DataFetcher.of(DILITHIUM_CERTIFICATES.class,\n+                    \"dilithium-certificates-draft-ietf-lamps-dilithium-certificates-13\/\")) {\n+            test(readCMS(cmsFetcher, \"mldsa44-signed-attrs.pem\"),\n+                    readCert(dsaFetcher, \"ML-DSA-44.crt\"));\n+            test(readCMS(cmsFetcher, \"mldsa65-signed-attrs.pem\"),\n+                    readCert(dsaFetcher, \"ML-DSA-65.crt\"));\n+            test(readCMS(cmsFetcher, \"mldsa87-signed-attrs.pem\"),\n+                    readCert(dsaFetcher, \"ML-DSA-87.crt\"));\n+        }\n@@ -64,4 +73,2 @@\n-    static byte[] readCMS(String entry) throws IOException  {\n-        var data = fetchData(CMS_ML_DSA.class,\n-                \"cms-ml-dsa-draft-ietf-lamps-cms-ml-dsa-07\/\",\n-                \"examples\/\" + entry);\n+    static byte[] readCMS(DataFetcher f, String entry) throws IOException  {\n+        var data = f.fetch(\"examples\/\" + entry);\n@@ -76,4 +83,2 @@\n-    static X509Certificate readCert(String entry) throws Exception {\n-        var data = fetchData(DILITHIUM_CERTIFICATES.class,\n-                \"dilithium-certificates-draft-ietf-lamps-dilithium-certificates-13\/\",\n-                \"examples\/\" + entry);\n+    static X509Certificate readCert(DataFetcher f, String entry) throws Exception {\n+        var data = f.fetch(\"examples\/\" + entry);\n","filename":"test\/jdk\/sun\/security\/provider\/pqc\/ML_DSA_CMS.java","additions":16,"deletions":11,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -37,19 +37,21 @@\n-public class DataFetcher {\n-    \/\/\/ Fetches data.\n-    \/\/\/\n-    \/\/\/ By default, this method fetches a ZIP from an artifact server,\n-    \/\/\/ extracts an entry inside, and returns its content.\n-    \/\/\/\n-    \/\/\/ Users can also specify the \"jdk.tests.repos.pattern\" system property\n-    \/\/\/ to fetch the extracted file in an alternative location. The value of\n-    \/\/\/ this system property is a [format][java.util.Formatter] string that\n-    \/\/\/ takes the last part of [organization name][Artifact#organization()],\n-    \/\/\/ the [name][Artifact#name()], the [version][Artifact#revision()],\n-    \/\/\/ and `entry` as arguments. For example:\n-    \/\/\/\n-    \/\/\/ With the [CMS_ML_DSA] class inside this test, the pattern\n-    \/\/\/ `file:\/\/\/Users\/tester\/repos\/external\/%s\/%s\/%4$s` will be resolved to\n-    \/\/\/ a local file like `\/Users\/tester\/repos\/external\/lamps-wg\/cms-ml-dsa\/entry`;\n-    \/\/\/ and a pattern `https:\/\/raw.repos.com\/%s\/%s\/%s\/%s` will be resolved to\n-    \/\/\/ a URL like `https:\/\/raw.repos.com\/lamps-wg\/cms-ml-dsa\/c8f0cf7\/entry`.\n-    \/\/\/\n+\/\/\/ Fetches data for a repo.\n+\/\/\/\n+\/\/\/ By default, data is extracted from ZIP file on an artifact server.\n+\/\/\/\n+\/\/\/ Users can specify the \"jdk.tests.repos.pattern\" system property\n+\/\/\/ to fetch the file in an alternative location. The value of this\n+\/\/\/ system property represents the URL for the entry with \"%o\" mapping to\n+\/\/\/ the last part of [organization name][Artifact#organization()], \"%n\"\n+\/\/\/ to [name][Artifact#name()], \"%r\" to[version][Artifact#revision()],\n+\/\/\/ and \"%e\" to the entry name. For example:\n+\/\/\/\n+\/\/\/ With the [CMS_ML_DSA] class inside this test, the pattern\n+\/\/\/ `file:\/\/\/Users\/tester\/repos\/external\/%o\/%n\/%e` will be resolved to\n+\/\/\/ a local file like `\/Users\/tester\/repos\/external\/lamps-wg\/cms-ml-dsa\/entry`;\n+\/\/\/ and a pattern `https:\/\/raw.repos.com\/%o\/%n\/%r\/%e` will be resolved to\n+\/\/\/ a URL like `https:\/\/raw.repos.com\/lamps-wg\/cms-ml-dsa\/c8f0cf7\/entry`.\n+\/\/\/\n+public interface DataFetcher extends AutoCloseable {\n+\n+    byte[] fetch(String entry) throws IOException;\n+\n@@ -58,2 +60,1 @@\n-    \/\/\/ @param entry the entry name without `zipPrefix`\n-    public static byte[] fetchData(Class<?> klass, String zipPrefix, String entry)\n+    static DataFetcher of(Class<?> klass, String zipPrefix)\n@@ -65,11 +66,5 @@\n-            var url = String.format(prop,\n-                    org.substring(org.lastIndexOf('.') + 1),\n-                    artifact.name(),\n-                    artifact.revision(),\n-                    entry);\n-            System.out.println(\"fetching \" + url + \"...\");\n-            try (var is = new URI(url).toURL().openStream()) {\n-                return is.readAllBytes();\n-            } catch (URISyntaxException e) {\n-                throw new IOException(\"Invalid URL: \" + url);\n-            }\n+            prop = prop.replace(\"%o\", org.substring(org.lastIndexOf('.') + 1));\n+            prop = prop.replace(\"%n\", artifact.name());\n+            prop = prop.replace(\"%r\", artifact.revision());\n+            System.out.println(\"Creating FileFetcher on \" + prop);\n+            return new FileFetcher(prop);\n@@ -80,9 +75,2 @@\n-                System.out.println(\"fetching \" + zipPrefix + entry + \" in \" + p + \"...\");\n-                try (ZipFile zf = new ZipFile(p.toFile())) {\n-                    ZipEntry ze = zf.getEntry(zipPrefix + entry);\n-                    if (ze != null) {\n-                        return zf.getInputStream(ze).readAllBytes();\n-                    } else {\n-                        throw new RuntimeException(\"Entry not found: \" + entry);\n-                    }\n-                }\n+                System.out.println(\"Creating ZipFetcher on \" + p);\n+                return new ZipFetcher(new ZipFile(p.toFile()), zipPrefix);\n@@ -90,1 +78,43 @@\n-                throw new SkippedException(\"Cannot find the artifact \" + artifact.name(), e);\n+                throw new SkippedException(\"Cannot find \" + artifact.name(), e);\n+            }\n+        }\n+    }\n+\n+    \/\/\/ Fetches data from a URL.\n+    \/\/\/ @param base the base URL string, contains \"%e\" mapping to entry name\n+    record FileFetcher(String base) implements DataFetcher {\n+        @Override\n+        public void close() throws Exception {\n+            \/\/ nothing to do\n+        }\n+\n+        @Override\n+        public byte[] fetch(String entry) throws IOException {\n+            System.out.println(\"Reading \" + entry + \"...\");\n+            try (var is = new URI(base.replace(\"%e\", entry)).toURL().openStream()) {\n+                return is.readAllBytes();\n+            } catch (URISyntaxException e) {\n+                throw new IOException(\"Cannot create URI\", e);\n+            }\n+        }\n+    }\n+\n+    \/\/\/ Fetches data from a ZIP file.\n+    \/\/\/ @param zf the `ZipFile`\n+    \/\/\/ @param zipPrefix optional prefix string inside the ZIP file. For\n+    \/\/\/     example, if an entry \"sample\/data\" is \"archive\/sample\/data\"\n+    \/\/\/     inside the ZIP, \"archive\/\" should be provided as `zipPrefix`.\n+    record ZipFetcher(ZipFile zf, String zipPrefix) implements DataFetcher {\n+        @Override\n+        public void close() throws Exception {\n+            zf.close();\n+        }\n+\n+        @Override\n+        public byte[] fetch(String entry) throws IOException {\n+            System.out.println(\"Reading \" + entry + \"...\");\n+            ZipEntry ze = zf.getEntry(zipPrefix + entry);\n+            if (ze != null) {\n+                return zf.getInputStream(ze).readAllBytes();\n+            } else {\n+                throw new RuntimeException(\"Entry not found: \" + entry);\n","filename":"test\/lib\/jdk\/test\/lib\/security\/DataFetcher.java","additions":72,"deletions":42,"binary":false,"changes":114,"status":"modified"}]}