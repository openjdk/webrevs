{"files":[{"patch":"@@ -510,1 +510,1 @@\n-                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm\");\n+                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm \" + digAlgId);\n@@ -515,1 +515,1 @@\n-                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm\");\n+                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm \" + digAlgId);\n@@ -521,1 +521,1 @@\n-                        throw new NoSuchAlgorithmException(\"Incompatible digest algorithm\");\n+                        throw new NoSuchAlgorithmException(\"Incompatible digest algorithm \" + digAlgId);\n@@ -525,1 +525,1 @@\n-                        throw new NoSuchAlgorithmException(\"Incompatible digest algorithm\");\n+                        throw new NoSuchAlgorithmException(\"Incompatible digest algorithm \" + digAlgId);\n@@ -532,1 +532,1 @@\n-                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm\");\n+                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm \" + digAlgId);\n@@ -546,1 +546,1 @@\n-                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm\" + digAlgId);\n+                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm \" + digAlgId);\n@@ -555,1 +555,1 @@\n-                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm\");\n+                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm \" + digAlgId);\n@@ -562,1 +562,1 @@\n-                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm\");\n+                    throw new NoSuchAlgorithmException(\"Incompatible digest algorithm \" + digAlgId);\n@@ -575,1 +575,1 @@\n-     * 1. Simply key algorithm like RSA, DSA, EC, this method returns\n+     * 1. Simple key algorithm like RSA, DSA, EC, this method returns\n","filename":"src\/java.base\/share\/classes\/sun\/security\/pkcs\/SignerInfo.java","additions":9,"deletions":9,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import jdk.security.jarsigner.JarSigner;\n@@ -38,0 +39,1 @@\n+import java.io.File;\n@@ -40,0 +42,2 @@\n+import java.security.KeyStore;\n+import java.util.List;\n@@ -41,0 +45,1 @@\n+import java.util.zip.ZipFile;\n@@ -43,0 +48,3 @@\n+\n+    static List<String> SIGNERS = List.of(\"44\", \"65\", \"87\");\n+\n@@ -44,0 +52,4 @@\n+        prepare();\n+        testAPI();\n+        testTool(); \/\/ call this last, it modified a.jar.\n+    }\n@@ -45,0 +57,6 @@\n+    private static void prepare() throws Exception {\n+        for (var signer : SIGNERS) {\n+            SecurityTools.keytool(\"-keystore ks -storepass changeit -genkeypair -alias \"\n+                            + signer + \" -keyalg ML-DSA-\" + signer + \" -dname CN=\" + signer)\n+                    .shouldHaveExitValue(0);\n+        }\n@@ -47,0 +65,1 @@\n+    }\n@@ -48,3 +67,18 @@\n-        genKeyAndSign(\"ML-DSA-44\", \"M4\");\n-        genKeyAndSign(\"ML-DSA-65\", \"M6\");\n-        genKeyAndSign(\"ML-DSA-87\", \"M8\");\n+    static void testAPI() throws Exception {\n+        var pass = \"changeit\".toCharArray();\n+        var ks = KeyStore.getInstance(new File(\"ks\"), pass);\n+        for (var signer : SIGNERS) {\n+            var jsb = new JarSigner.Builder((KeyStore.PrivateKeyEntry)\n+                    ks.getEntry(signer, new KeyStore.PasswordProtection(pass)));\n+            try (var zf = new ZipFile(\"a.jar\");\n+                 var of = Files.newOutputStream(Path.of(signer + \".jar\"))) {\n+                jsb.signerName(signer).build().sign(zf, of);\n+            }\n+            try (var jf = new JarFile(signer + \".jar\")) {\n+                var je = jf.getJarEntry(\"a\");\n+                jf.getInputStream(je).readAllBytes();\n+                Asserts.assertEquals(1, je.getCertificates().length);\n+                checkDigestAlgorithm(jf, signer, KnownOIDs.SHA_512);\n+            }\n+        }\n+    }\n@@ -52,0 +86,5 @@\n+    static void testTool() throws Exception {\n+        for (var signer : SIGNERS) {\n+            SecurityTools.jarsigner(\"-keystore ks -storepass changeit a.jar \" + signer)\n+                    .shouldHaveExitValue(0);\n+        }\n@@ -57,1 +96,0 @@\n-\n@@ -61,4 +99,3 @@\n-\n-            checkDigestAlgorithm(jf, \"M4\", KnownOIDs.SHA_512);\n-            checkDigestAlgorithm(jf, \"M6\", KnownOIDs.SHA_512);\n-            checkDigestAlgorithm(jf, \"M8\", KnownOIDs.SHA_512);\n+            for (var signer : SIGNERS) {\n+                checkDigestAlgorithm(jf, signer, KnownOIDs.SHA_512);\n+            }\n@@ -68,9 +105,1 @@\n-    static void genKeyAndSign(String alg, String alias) throws Exception {\n-        SecurityTools.keytool(\"-keystore ks -storepass changeit -genkeypair -alias \"\n-                        + alias + \" -keyalg \" + alg + \" -dname CN=\" + alias)\n-                .shouldHaveExitValue(0);\n-        SecurityTools.jarsigner(\"-keystore ks -storepass changeit a.jar \" + alias)\n-                .shouldHaveExitValue(0);\n-    }\n-\n-    static void checkDigestAlgorithm(JarFile jf, String alias, KnownOIDs expectAlg)\n+    static void checkDigestAlgorithm(JarFile jf, String alias, KnownOIDs digAlg)\n@@ -81,1 +110,1 @@\n-        DerUtils.checkAlg(p7, \"10100\", expectAlg);\n+        DerUtils.checkAlg(p7, \"10100\", digAlg);\n@@ -83,1 +112,3 @@\n-        DerUtils.checkAlg(p7, \"104020\", expectAlg);\n+        DerUtils.checkAlg(p7, \"104020\", digAlg);\n+        \/\/ SignedData - signerInfos - signatureAlgorithm\n+        DerUtils.checkAlg(p7, \"104040\", KnownOIDs.valueOf(\"ML_DSA_\" + alias));\n@@ -85,1 +116,3 @@\n-        DerUtils.checkAlg(p7, \"1040321000\", expectAlg);\n+        DerUtils.checkAlg(p7, \"1040321000\", digAlg);\n+        \/\/ SignedData - signerInfos - signedAttrs - CMSAlgorithmProtection - signatureAlgorithm\n+        DerUtils.checkAlg(p7, \"1040321010\", KnownOIDs.valueOf(\"ML_DSA_\" + alias));\n","filename":"test\/jdk\/sun\/security\/tools\/jarsigner\/ML_DSA.java","additions":53,"deletions":20,"binary":false,"changes":73,"status":"modified"}]}