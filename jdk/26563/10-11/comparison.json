{"files":[{"patch":"@@ -32,1 +32,1 @@\n-import jdk.test.lib.security.DataFetcher;\n+import jdk.test.lib.security.RepositoryFileReader;\n@@ -44,1 +44,1 @@\n-import static jdk.test.lib.security.DataFetcher.*;\n+import static jdk.test.lib.security.RepositoryFileReader.*;\n@@ -49,1 +49,1 @@\n-        try (var cmsFetcher = DataFetcher.of(CMS_ML_DSA.class,\n+        try (var cmsReader = RepositoryFileReader.of(CMS_ML_DSA.class,\n@@ -51,1 +51,1 @@\n-            var dsaFetcher = DataFetcher.of(DILITHIUM_CERTIFICATES.class,\n+            var dsaReader = RepositoryFileReader.of(DILITHIUM_CERTIFICATES.class,\n@@ -53,6 +53,6 @@\n-            test(readCMS(cmsFetcher, \"mldsa44-signed-attrs.pem\"),\n-                    readCert(dsaFetcher, \"ML-DSA-44.crt\"));\n-            test(readCMS(cmsFetcher, \"mldsa65-signed-attrs.pem\"),\n-                    readCert(dsaFetcher, \"ML-DSA-65.crt\"));\n-            test(readCMS(cmsFetcher, \"mldsa87-signed-attrs.pem\"),\n-                    readCert(dsaFetcher, \"ML-DSA-87.crt\"));\n+            test(readCMS(cmsReader, \"mldsa44-signed-attrs.pem\"),\n+                    readCert(dsaReader, \"ML-DSA-44.crt\"));\n+            test(readCMS(cmsReader, \"mldsa65-signed-attrs.pem\"),\n+                    readCert(dsaReader, \"ML-DSA-65.crt\"));\n+            test(readCMS(cmsReader, \"mldsa87-signed-attrs.pem\"),\n+                    readCert(dsaReader, \"ML-DSA-87.crt\"));\n@@ -73,2 +73,2 @@\n-    static byte[] readCMS(DataFetcher f, String entry) throws IOException  {\n-        var data = f.fetch(\"examples\/\" + entry);\n+    static byte[] readCMS(RepositoryFileReader f, String entry) throws IOException  {\n+        var data = f.read(\"examples\/\" + entry);\n@@ -83,2 +83,2 @@\n-    static X509Certificate readCert(DataFetcher f, String entry) throws Exception {\n-        var data = f.fetch(\"examples\/\" + entry);\n+    static X509Certificate readCert(RepositoryFileReader f, String entry) throws Exception {\n+        var data = f.read(\"examples\/\" + entry);\n","filename":"test\/jdk\/sun\/security\/provider\/pqc\/ML_DSA_CMS.java","additions":14,"deletions":14,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -1,144 +0,0 @@\n-\/*\n- * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-package jdk.test.lib.security;\n-\n-import jdk.test.lib.artifacts.Artifact;\n-import jdk.test.lib.artifacts.ArtifactResolver;\n-import jdk.test.lib.artifacts.ArtifactResolverException;\n-import jtreg.SkippedException;\n-\n-import java.io.IOException;\n-import java.net.URI;\n-import java.net.URISyntaxException;\n-import java.nio.file.Path;\n-import java.util.zip.ZipEntry;\n-import java.util.zip.ZipFile;\n-\n-\/\/\/ Fetches data for a repo.\n-\/\/\/\n-\/\/\/ By default, data is extracted from ZIP file on an artifact server.\n-\/\/\/\n-\/\/\/ Users can specify the \"jdk.tests.repos.pattern\" system property\n-\/\/\/ to fetch the file in an alternative location. The value of this\n-\/\/\/ system property represents the URL for the entry with \"%o\" mapping to\n-\/\/\/ the last part of [organization name][Artifact#organization()], \"%n\"\n-\/\/\/ to [name][Artifact#name()], \"%r\" to[version][Artifact#revision()],\n-\/\/\/ and \"%e\" to the entry name. For example:\n-\/\/\/\n-\/\/\/ With the [CMS_ML_DSA] class inside this test, the pattern\n-\/\/\/ `file:\/\/\/Users\/tester\/repos\/external\/%o\/%n\/%e` will be resolved to\n-\/\/\/ a local file like `\/Users\/tester\/repos\/external\/lamps-wg\/cms-ml-dsa\/entry`;\n-\/\/\/ and a pattern `https:\/\/raw.repos.com\/%o\/%n\/%r\/%e` will be resolved to\n-\/\/\/ a URL like `https:\/\/raw.repos.com\/lamps-wg\/cms-ml-dsa\/c8f0cf7\/entry`.\n-\/\/\/\n-public sealed interface DataFetcher extends AutoCloseable {\n-\n-    byte[] fetch(String entry) throws IOException;\n-\n-    @Override\n-    void close() throws IOException; \/\/ to avoid InterruptedException warning\n-\n-    \/\/\/ @param klass the `Artifact` class\n-    \/\/\/ @param zipPrefix the common prefix for each entry in the ZIP file\n-    static DataFetcher of(Class<?> klass, String zipPrefix) {\n-        Artifact artifact = klass.getAnnotation(Artifact.class);\n-        var org = artifact.organization();\n-        var prop = System.getProperty(\"jdk.tests.repos.pattern\");\n-        if (prop != null && org.startsWith(\"jpg.tests.jdk.repos.\")) {\n-            prop = prop.replace(\"%o\", org.substring(org.lastIndexOf('.') + 1));\n-            prop = prop.replace(\"%n\", artifact.name());\n-            prop = prop.replace(\"%r\", artifact.revision());\n-            System.out.println(\"Creating FileFetcher on \" + prop);\n-            return new FileFetcher(prop);\n-        } else {\n-            try {\n-                Path p = ArtifactResolver.resolve(klass).entrySet().stream()\n-                        .findAny().get().getValue();\n-                System.out.println(\"Creating ZipFetcher on \" + p);\n-                return new ZipFetcher(new ZipFile(p.toFile()), zipPrefix);\n-            } catch (ArtifactResolverException | IOException e) {\n-                throw new SkippedException(\"Cannot find \" + artifact.name(), e);\n-            }\n-        }\n-    }\n-\n-    \/\/\/ Fetches data from a URL.\n-    \/\/\/ @param base the base URL string, contains \"%e\" mapping to entry name\n-    record FileFetcher(String base) implements DataFetcher {\n-        @Override\n-        public void close() {\n-            \/\/ nothing to do\n-        }\n-\n-        @Override\n-        public byte[] fetch(String entry) throws IOException {\n-            System.out.println(\"Reading \" + entry + \"...\");\n-            try (var is = new URI(base.replace(\"%e\", entry)).toURL().openStream()) {\n-                return is.readAllBytes();\n-            } catch (URISyntaxException e) {\n-                throw new IOException(\"Cannot create URI\", e);\n-            }\n-        }\n-    }\n-\n-    \/\/\/ Fetches data from a ZIP file.\n-    \/\/\/ @param zf the `ZipFile`\n-    \/\/\/ @param zipPrefix optional prefix string inside the ZIP file. For\n-    \/\/\/     example, if an entry \"sample\/data\" is \"archive\/sample\/data\"\n-    \/\/\/     inside the ZIP, \"archive\/\" should be provided as `zipPrefix`.\n-    record ZipFetcher(ZipFile zf, String zipPrefix) implements DataFetcher {\n-        @Override\n-        public void close() throws IOException {\n-            zf.close();\n-        }\n-\n-        @Override\n-        public byte[] fetch(String entry) throws IOException {\n-            System.out.println(\"Reading \" + entry + \"...\");\n-            ZipEntry ze = zf.getEntry(zipPrefix + entry);\n-            if (ze != null) {\n-                return zf.getInputStream(ze).readAllBytes();\n-            } else {\n-                throw new RuntimeException(\"Entry not found: \" + entry);\n-            }\n-        }\n-    }\n-\n-    @Artifact(\n-            organization = \"jpg.tests.jdk.repos.lamps-wg\",\n-            name = \"dilithium-certificates\",\n-            revision = \"785a549\",\n-            extension = \"zip\",\n-            unpack = false)\n-    public static class DILITHIUM_CERTIFICATES {\n-    }\n-\n-    @Artifact(\n-            organization = \"jpg.tests.jdk.repos.lamps-wg\",\n-            name = \"cms-ml-dsa\",\n-            revision = \"c8f0cf7\",\n-            extension = \"zip\",\n-            unpack = false)\n-    public static class CMS_ML_DSA {\n-    }\n-}\n","filename":"test\/lib\/jdk\/test\/lib\/security\/DataFetcher.java","additions":0,"deletions":144,"binary":false,"changes":144,"status":"deleted"},{"patch":"@@ -0,0 +1,151 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package jdk.test.lib.security;\n+\n+import jdk.test.lib.artifacts.Artifact;\n+import jdk.test.lib.artifacts.ArtifactResolver;\n+import jdk.test.lib.artifacts.ArtifactResolverException;\n+import jtreg.SkippedException;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.nio.file.Path;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipFile;\n+\n+\/\/\/ A helper class to read files from a code repository.\n+\/\/\/\n+\/\/\/ By default, the code repository is stored on the artifact server\n+\/\/\/ as a ZIP file.\n+\/\/\/\n+\/\/\/ Users can specify the \"jdk.tests.repos.pattern\" system property to read\n+\/\/\/ the files from an alternative location. The value of this system property\n+\/\/\/ represents the URL for each file entry where:\n+\/\/\/ - \"%o\" maps to the last part of [organization name][Artifact#organization()],\n+\/\/\/ - \"%n\" maps to [name][Artifact#name()],\n+\/\/\/ - \"%r\" maps to [version][Artifact#revision()],\n+\/\/\/ - \"%e\" maps to the name of the file entry to read.\n+\/\/\/\n+\/\/\/ For example, with the [CMS_ML_DSA] class inside this test:\n+\/\/\/ - The pattern `file:\/\/\/Users\/tester\/repos\/external\/%o\/%n\/%e` resolves to\n+\/\/\/   a local file like `\/Users\/tester\/repos\/external\/lamps-wg\/cms-ml-dsa\/entry`.\n+\/\/\/ - The pattern `https:\/\/raw.repos.com\/%o\/%n\/%r\/%e` resolves to\n+\/\/\/   `https:\/\/raw.repos.com\/lamps-wg\/cms-ml-dsa\/c8f0cf7\/entry`.\n+\/\/\/\n+public sealed interface RepositoryFileReader extends AutoCloseable {\n+\n+    \/\/\/ Reads the content of `entry` as a byte array.\n+    byte[] read(String entry) throws IOException;\n+\n+    \/\/\/ Overrides the method with a different exception type\n+    \/\/\/ to avoid compiler warnings about `InterruptedException`.\n+    @Override\n+    void close() throws IOException;\n+\n+    \/\/\/ Returns a `RepositoryFileReader`.\n+    \/\/\/ @param klass the `Artifact` class\n+    \/\/\/ @param zipPrefix the prefix used in the ZIP file. See\n+    \/\/\/         [ZipReader#ZipReader(ZipFile, String)].\n+    static RepositoryFileReader of(Class<?> klass, String zipPrefix) {\n+        Artifact artifact = klass.getAnnotation(Artifact.class);\n+        var org = artifact.organization();\n+        var prop = System.getProperty(\"jdk.tests.repos.pattern\");\n+        if (prop != null && org.startsWith(\"jpg.tests.jdk.repos.\")) {\n+            prop = prop.replace(\"%o\", org.substring(org.lastIndexOf('.') + 1));\n+            prop = prop.replace(\"%n\", artifact.name());\n+            prop = prop.replace(\"%r\", artifact.revision());\n+            System.out.println(\"Creating URLReader on \" + prop);\n+            return new URLReader(prop);\n+        } else {\n+            try {\n+                Path p = ArtifactResolver.resolve(klass).entrySet().stream()\n+                        .findAny().get().getValue();\n+                System.out.println(\"Creating ZipReader on \" + p);\n+                return new ZipReader(new ZipFile(p.toFile()), zipPrefix);\n+            } catch (ArtifactResolverException | IOException e) {\n+                throw new SkippedException(\"Cannot find \" + artifact.name(), e);\n+            }\n+        }\n+    }\n+\n+    \/\/\/ A `RepositoryFileReader` to read file from a URL.\n+    \/\/\/ @param base the base URL string, contains \"%e\" mapping to entry name\n+    record URLReader(String base) implements RepositoryFileReader {\n+        @Override\n+        public void close() {\n+            \/\/ nothing to do\n+        }\n+\n+        @Override\n+        public byte[] read(String entry) throws IOException {\n+            System.out.println(\"Reading \" + entry + \"...\");\n+            try (var is = new URI(base.replace(\"%e\", entry)).toURL().openStream()) {\n+                return is.readAllBytes();\n+            } catch (URISyntaxException e) {\n+                throw new IOException(\"Cannot create URI\", e);\n+            }\n+        }\n+    }\n+\n+    \/\/\/ A `RepositoryFileReader` to read file from a ZIP file.\n+    \/\/\/ @param zf the `ZipFile`\n+    \/\/\/ @param zipPrefix optional prefix string inside the ZIP file. For example,\n+    \/\/\/     if an entry \"folder\/file\" is represented as \"archive\/folder\/file\"\n+    \/\/\/     inside the ZIP, \"archive\/\" should be provided as `zipPrefix`.\n+    record ZipReader(ZipFile zf, String zipPrefix) implements RepositoryFileReader {\n+        @Override\n+        public void close() throws IOException {\n+            zf.close();\n+        }\n+\n+        @Override\n+        public byte[] read(String entry) throws IOException {\n+            System.out.println(\"Reading \" + entry + \"...\");\n+            ZipEntry ze = zf.getEntry(zipPrefix + entry);\n+            if (ze != null) {\n+                return zf.getInputStream(ze).readAllBytes();\n+            } else {\n+                throw new RuntimeException(\"Entry not found: \" + entry);\n+            }\n+        }\n+    }\n+\n+    @Artifact(\n+            organization = \"jpg.tests.jdk.repos.lamps-wg\",\n+            name = \"dilithium-certificates\",\n+            revision = \"785a549\",\n+            extension = \"zip\",\n+            unpack = false)\n+    public static class DILITHIUM_CERTIFICATES {\n+    }\n+\n+    @Artifact(\n+            organization = \"jpg.tests.jdk.repos.lamps-wg\",\n+            name = \"cms-ml-dsa\",\n+            revision = \"c8f0cf7\",\n+            extension = \"zip\",\n+            unpack = false)\n+    public static class CMS_ML_DSA {\n+    }\n+}\n","filename":"test\/lib\/jdk\/test\/lib\/security\/RepositoryFileReader.java","additions":151,"deletions":0,"binary":false,"changes":151,"status":"added"}]}