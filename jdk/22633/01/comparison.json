{"files":[{"patch":"@@ -31,0 +31,2 @@\n+import sun.nio.ch.IOUtil;\n+import java.io.FileDescriptor;\n@@ -144,0 +146,2 @@\n+            \/\/ make the reading part of the socket nonblocking, so the drain (drain_all) method works\n+            IOUtil.configureBlocking(IOUtil.newFD(sv[0]), false);\n@@ -306,1 +310,1 @@\n-                    int n;\n+                    int n, m;\n@@ -309,1 +313,1 @@\n-                        n = Pollset.pollsetPoll(pollset, address,\n+                        m = n = Pollset.pollsetPoll(pollset, address,\n@@ -311,0 +315,12 @@\n+                        while (m-- > 0) {\n+                            long eventAddress = Pollset.getEvent(address, m);\n+                            int fd = Pollset.getDescriptor(eventAddress);\n+\n+                            \/\/ To emulate one shot semantic we need to remove\n+                            \/\/ the file descriptor here.\n+                            if (fd != sp[0] && fd != ctlSp[0]) {\n+                                synchronized (controlQueue) {\n+                                    Pollset.pollsetCtl(pollset, Pollset.PS_DELETE, fd, 0);\n+                                }\n+                            }\n+                        }\n@@ -326,8 +342,0 @@\n-                            \/\/ To emulate one shot semantic we need to remove\n-                            \/\/ the file descriptor here.\n-                            if (fd != sp[0] && fd != ctlSp[0]) {\n-                                synchronized (controlQueue) {\n-                                    Pollset.pollsetCtl(pollset, Pollset.PS_DELETE, fd, 0);\n-                                }\n-                            }\n-\n@@ -353,1 +361,1 @@\n-                                    Pollset.drain1(ctlSp[0]);\n+                                    Pollset.drain(ctlSp[0]);\n","filename":"src\/java.base\/aix\/classes\/sun\/nio\/ch\/AixPollPort.java","additions":19,"deletions":11,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -123,0 +123,1 @@\n+    public static native void drain(int fd) throws IOException;\n","filename":"src\/java.base\/aix\/classes\/sun\/nio\/ch\/Pollset.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -164,0 +164,17 @@\n+JNIEXPORT void JNICALL\n+Java_sun_nio_ch_Pollset_drain(JNIEnv *env, jclass cl, jint fd)\n+{\n+    char buf[16];\n+\n+    for (;;) {\n+        int n = read(fd, buf, sizeof(buf));\n+        if ((n < 0) && (errno != EAGAIN && errno != EWOULDBLOCK)) {\n+            JNU_ThrowIOExceptionWithLastError(env, \"Drain\");\n+        }\n+        if (n != (int)sizeof(buf)) {\n+            break;\n+        }\n+    }\n+    return;\n+}\n+\n","filename":"src\/java.base\/aix\/native\/libnio\/ch\/Pollset.c","additions":17,"deletions":0,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -588,2 +588,0 @@\n-java\/nio\/channels\/AsynchronousSocketChannel\/StressLoopback.java 8211851 aix-ppc64\n-\n","filename":"test\/jdk\/ProblemList.txt","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}