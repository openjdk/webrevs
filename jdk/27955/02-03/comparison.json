{"files":[{"patch":"@@ -1689,0 +1689,3 @@\n+\n+  void split_thru_phi_yank_old_nodes(Node* n, Node* region);\n+\n","filename":"src\/hotspot\/share\/opto\/loopnode.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -231,32 +231,1 @@\n-  \/\/ If the region is a Loop, we are removing the old n,\n-  \/\/ and need to yank it from the _body. If any phi we\n-  \/\/ just split through now has no use any more, it also\n-  \/\/ has to be removed.\n-  IdealLoopTree* region_loop = get_loop(region);\n-  if (region->is_Loop() && region_loop->is_innermost()) {\n-    region_loop->_body.yank(n);\n-    for (uint j = 1; j < n->req(); j++) {\n-      PhiNode* phi = n->in(j)->isa_Phi();\n-      \/\/ Check that phi belongs to the region and only has n as a use.\n-      if (phi != nullptr && phi->in(0) == region) {\n-        bool found_n = false;\n-        bool found_other = false;\n-        for (DUIterator_Fast kmax, k = phi->fast_outs(kmax); k < kmax; k++) {\n-          Node* u = phi->fast_out(k);\n-          if (u == n) {\n-            \/\/ Single and multiple use are allowed:\n-            \/\/   n = ConvF2I(phi)\n-            \/\/   n = AddI(phi, phi)\n-            found_n = true;\n-          } else {\n-            found_other = true;\n-          }\n-        }\n-        if (found_n && !found_other) {\n-          assert(get_ctrl(phi) == region, \"sanity\");\n-          assert(get_ctrl(n) == region, \"sanity\");\n-          region_loop->_body.yank(phi);\n-        }\n-      }\n-    }\n-  }\n+  split_thru_phi_yank_old_nodes(n, region);\n@@ -275,0 +244,22 @@\n+\/\/ If the region is a Loop, we are removing the old n,\n+\/\/ and need to yank it from the _body. If any phi we\n+\/\/ just split through now has no use any more, it also\n+\/\/ has to be removed.\n+void PhaseIdealLoop::split_thru_phi_yank_old_nodes(Node* n, Node* region) {\n+  IdealLoopTree* region_loop = get_loop(region);\n+  if (region->is_Loop() && region_loop->is_innermost()) {\n+    region_loop->_body.yank(n);\n+    for (uint j = 1; j < n->req(); j++) {\n+      PhiNode* phi = n->in(j)->isa_Phi();\n+      \/\/ Check that phi belongs to the region and only has n as a use.\n+      if (phi != nullptr &&\n+          phi->in(0) == region &&\n+          phi->unique_multiple_edges_out_or_null() == n) {\n+        assert(get_ctrl(phi) == region, \"sanity\");\n+        assert(get_ctrl(n) == region, \"sanity\");\n+        region_loop->_body.yank(phi);\n+      }\n+    }\n+  }\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/loopopts.cpp","additions":23,"deletions":32,"binary":false,"changes":55,"status":"modified"},{"patch":"@@ -2892,0 +2892,14 @@\n+Node* Node::unique_multiple_edges_out_or_null() const {\n+  Node* use = nullptr;\n+  for (DUIterator_Fast kmax, k = fast_outs(kmax); k < kmax; k++) {\n+    Node* u = fast_out(k);\n+    if (use == nullptr) {\n+      use = u; \/\/ first use\n+    } else if (u != use) {\n+      return nullptr; \/\/ not unique\n+    } else {\n+      \/\/ secondary use\n+    }\n+  }\n+  return use;\n+}\n","filename":"src\/hotspot\/share\/opto\/node.cpp","additions":14,"deletions":0,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -425,0 +425,7 @@\n+\n+  \/\/ In some cases, a node n is only used by a single use, but the use may use\n+  \/\/ n once or multiple times:\n+  \/\/   use = ConvF2I(this)\n+  \/\/   use = AddI(this, this)\n+  Node* unique_multiple_edges_out_or_null() const;\n+\n","filename":"src\/hotspot\/share\/opto\/node.hpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"}]}