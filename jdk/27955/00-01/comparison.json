{"files":[{"patch":"@@ -239,7 +239,21 @@\n-      Node* in = n->in(j);\n-      \/\/ Check that in is a phi, and n was its only use.\n-      if (in->is_Phi() && in->in(0) == region &&\n-          in->outcnt() == 1 && in->unique_out() == n) {\n-        assert(get_ctrl(in) == region, \"sanity\");\n-        assert(get_ctrl(n) == region, \"sanity\");\n-        region_loop->_body.yank(in);\n+      PhiNode* phi = n->in(j)->isa_Phi();\n+      \/\/ Check that phi belongs to the region and only has n as a use.\n+      if (phi != nullptr && phi->in(0) == region) {\n+        bool found_n = false;\n+        bool found_other = false;\n+        for (DUIterator_Fast kmax, k = phi->fast_outs(kmax); k < kmax; k++) {\n+          Node* u = phi->fast_out(k);\n+          if (u == n) {\n+            \/\/ Single and multiple use are allowed:\n+            \/\/   n = ConvF2I(phi)\n+            \/\/   n = AddI(phi, phi)\n+            found_n = true;\n+          } else {\n+            found_other = true;\n+          }\n+        }\n+        if (found_n && !found_other) {\n+          assert(get_ctrl(phi) == region, \"sanity\");\n+          assert(get_ctrl(n) == region, \"sanity\");\n+          region_loop->_body.yank(phi);\n+        }\n","filename":"src\/hotspot\/share\/opto\/loopopts.cpp","additions":21,"deletions":7,"binary":false,"changes":28,"status":"modified"}]}