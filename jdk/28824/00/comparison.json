{"files":[{"patch":"@@ -2467,1 +2467,1 @@\n-jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {\n+CPUTime_t os::detailed_thread_cpu_time(Thread* t) {\n@@ -2471,2 +2471,5 @@\n-  if (!thread_cpu_time_unchecked(thread, &sys_time, &user_time)) {\n-    return -1;\n+  if (!thread_cpu_time_unchecked(t, &sys_time, &user_time)) {\n+    return {\n+      -1,\n+      -1\n+    };\n@@ -2475,1 +2478,12 @@\n-  return user_sys_cpu_time ? sys_time + user_time : user_time;\n+  return {\n+    user_time,\n+    sys_time\n+  };\n+}\n+\n+jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {\n+  CPUTime_t cpu_time = detailed_thread_cpu_time(thread);\n+  if (cpu_time.user == -1) {\n+    return -1;\n+  }\n+  return user_sys_cpu_time ? cpu_time.user + cpu_time.system : cpu_time.user;\n","filename":"src\/hotspot\/os\/aix\/os_aix.cpp","additions":18,"deletions":4,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -2293,0 +2293,26 @@\n+CPUTime_t os::detailed_thread_cpu_time(Thread* t) {\n+#ifdef __APPLE__\n+  struct thread_basic_info tinfo;\n+  mach_msg_type_number_t tcount = THREAD_INFO_MAX;\n+  kern_return_t kr;\n+  thread_t mach_thread;\n+\n+  mach_thread = t->osthread()->thread_id();\n+  kr = thread_info(mach_thread, THREAD_BASIC_INFO, (thread_info_t)&tinfo, &tcount);\n+  if (kr != KERN_SUCCESS) {\n+    return {\n+      -1,\n+      -1\n+    };\n+  }\n+\n+  return {\n+    ((jlong) tinfo.user_time.seconds * (jlong)1000000000) + ((jlong) tinfo.user_time.microseconds * (jlong)1000),\n+    ((jlong) tinfo.system_time.seconds * (jlong)1000000000) + ((jlong)tinfo.system_time.microseconds * (jlong)1000)\n+  };\n+#else\n+  Unimplemented();\n+  return {0, 0};\n+#endif\n+}\n+\n@@ -2329,8 +2355,2 @@\n-  struct thread_basic_info tinfo;\n-  mach_msg_type_number_t tcount = THREAD_INFO_MAX;\n-  kern_return_t kr;\n-  thread_t mach_thread;\n-\n-  mach_thread = thread->osthread()->thread_id();\n-  kr = thread_info(mach_thread, THREAD_BASIC_INFO, (thread_info_t)&tinfo, &tcount);\n-  if (kr != KERN_SUCCESS) {\n+  CPUTime_t cpu_time = detailed_thread_cpu_time(thread);\n+  if (cpu_time.user == -1) {\n@@ -2339,9 +2359,1 @@\n-\n-  if (user_sys_cpu_time) {\n-    jlong nanos;\n-    nanos = ((jlong) tinfo.system_time.seconds + tinfo.user_time.seconds) * (jlong)1000000000;\n-    nanos += ((jlong) tinfo.system_time.microseconds + (jlong) tinfo.user_time.microseconds) * (jlong)1000;\n-    return nanos;\n-  } else {\n-    return ((jlong)tinfo.user_time.seconds * 1000000000) + ((jlong)tinfo.user_time.microseconds * (jlong)1000);\n-  }\n+  return user_sys_cpu_time ? cpu_time.user + cpu_time.system : cpu_time.user;\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":29,"deletions":17,"binary":false,"changes":46,"status":"modified"},{"patch":"@@ -5001,0 +5001,9 @@\n+CPUTime_t os::detailed_thread_cpu_time(Thread* t) {\n+  jlong user = user_thread_cpu_time(t);\n+  jlong total = total_thread_cpu_time(t);\n+  return {\n+    user,\n+    total - user\n+  };\n+}\n+\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2025, Oracle and\/or its affiliates. All rights reserved.\n","filename":"src\/hotspot\/os\/linux\/os_linux.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -55,0 +55,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -4892,0 +4893,19 @@\n+CPUTime_t os::detailed_thread_cpu_time(Thread* t) {\n+  FILETIME CreationTime;\n+  FILETIME ExitTime;\n+  FILETIME KernelTime;\n+  FILETIME UserTime;\n+\n+  if (GetThreadTimes(t->osthread()->thread_handle(), &CreationTime,\n+                      &ExitTime, &KernelTime, &UserTime) == 0) {\n+    return {\n+      -1,\n+      -1\n+    };\n+  }\n+\n+  return {\n+    FT2INT64(UserTime) * 100,\n+    FT2INT64(KernelTime) * 100\n+  };\n+}\n@@ -4916,9 +4936,2 @@\n-  \/\/ This code is copy from classic VM -> hpi::sysThreadCPUTime\n-  \/\/ If this function changes, os::is_thread_cpu_time_supported() should too\n-  FILETIME CreationTime;\n-  FILETIME ExitTime;\n-  FILETIME KernelTime;\n-  FILETIME UserTime;\n-\n-  if (GetThreadTimes(thread->osthread()->thread_handle(), &CreationTime,\n-                      &ExitTime, &KernelTime, &UserTime) == 0) {\n+  CPUTime_t cpu_time = detailed_thread_cpu_time(thread);\n+  if (cpu_time.user == -1) {\n@@ -4926,4 +4939,0 @@\n-  } else if (user_sys_cpu_time) {\n-    return (FT2INT64(UserTime) + FT2INT64(KernelTime)) * 100;\n-  } else {\n-    return FT2INT64(UserTime) * 100;\n@@ -4931,0 +4940,1 @@\n+  return user_sys_cpu_time ? cpu_time.user + cpu_time.system : cpu_time.user;\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":23,"deletions":13,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -32,0 +32,2 @@\n+#include \"services\/cpuTimeUsage.hpp\"\n+#include \"utilities\/globalDefinitions.hpp\"\n@@ -74,2 +76,2 @@\n-  _starting_user_time(0.0),\n-  _starting_system_time(0.0),\n+  _starting_user_time(0),\n+  _starting_system_time(0),\n@@ -80,5 +82,8 @@\n-    bool valid = os::getTimesSecs(&_starting_real_time,\n-                                  &_starting_user_time,\n-                                  &_starting_system_time);\n-    if (!valid) {\n-      log_warning(gc, cpu)(\"TraceCPUTime: os::getTimesSecs() returned invalid result\");\n+    CPUTime_t cpu_time_vm = CPUTimeUsage::GC::detailed_gc_operation_vm_thread();\n+    CPUTime_t cpu_time_gc = CPUTimeUsage::GC::detailed_gc_threads();\n+    CPUTime_t cpu_time_stringdedup = CPUTimeUsage::GC::detailed_stringdedup();\n+    _starting_user_time = cpu_time_vm.user + cpu_time_gc.user + cpu_time_stringdedup.user;\n+    _starting_system_time = cpu_time_vm.system + cpu_time_gc.system + cpu_time_stringdedup.system;\n+    _starting_real_time = os::elapsedTime();\n+    if (CPUTimeUsage::Error::has_error()) {\n+      log_warning(gc, cpu)(\"TraceCPUTime: CPUTimeUsage may contain invalid results\");\n@@ -92,3 +97,9 @@\n-    double real_time, user_time, system_time;\n-    bool valid = os::getTimesSecs(&real_time, &user_time, &system_time);\n-    if (valid) {\n+    CPUTime_t cpu_time_vm = CPUTimeUsage::GC::detailed_gc_operation_vm_thread();\n+    CPUTime_t cpu_time_gc = CPUTimeUsage::GC::detailed_gc_threads();\n+    CPUTime_t cpu_time_stringdedup = CPUTimeUsage::GC::detailed_stringdedup();\n+\n+    double real_time = os::elapsedTime() - _starting_real_time;\n+    jlong user_time = cpu_time_vm.user + cpu_time_gc.user + cpu_time_stringdedup.user;\n+    jlong system_time = cpu_time_vm.system + cpu_time_gc.system + cpu_time_stringdedup.system;\n+\n+    if (!CPUTimeUsage::Error::has_error()) {\n@@ -98,1 +109,3 @@\n-      log_info(gc, cpu)(\"User=%3.2fs Sys=%3.2fs Real=%3.2fs\", user_time, system_time, real_time);\n+      double user_time_seconds = 1.0 * user_time \/ NANOSECS_PER_SEC;\n+      double system_time_seconds = 1.0 * system_time \/ NANOSECS_PER_SEC;\n+      log_info(gc, cpu)(\"User=%3.2fs Sys=%3.2fs Real=%3.2fs\", user_time_seconds, system_time_seconds, real_time);\n@@ -103,1 +116,1 @@\n-      log_warning(gc, cpu)(\"TraceCPUTime: os::getTimesSecs() returned invalid result\");\n+      log_warning(gc, cpu)(\"TraceCPUTime: CPUTimeUsage may contain invalid results\");\n","filename":"src\/hotspot\/share\/gc\/shared\/gcTraceTime.cpp","additions":25,"deletions":12,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -39,2 +39,2 @@\n-  double _starting_user_time;   \/\/ user time at start of measurement\n-  double _starting_system_time; \/\/ system time at start of measurement\n+  jlong _starting_user_time;   \/\/ user time at start of measurement\n+  jlong _starting_system_time; \/\/ system time at start of measurement\n","filename":"src\/hotspot\/share\/gc\/shared\/gcTraceTime.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -170,0 +170,6 @@\n+struct CPUTime {\n+  jlong user;\n+  jlong system;\n+};\n+typedef struct CPUTime CPUTime_t;\n+\n@@ -997,0 +1003,2 @@\n+  static CPUTime_t detailed_thread_cpu_time(Thread* t);\n+\n","filename":"src\/hotspot\/share\/runtime\/os.hpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -38,0 +38,12 @@\n+static inline CPUTime_t detailed_thread_cpu_time_or_zero(Thread* thread) {\n+  CPUTime_t cpu_time = os::detailed_thread_cpu_time(thread);\n+  if (cpu_time.system == -1 || cpu_time.user == -1) {\n+    CPUTimeUsage::Error::mark_error();\n+    return {\n+      0,\n+      0\n+    };\n+  }\n+  return cpu_time;\n+}\n+\n@@ -58,2 +70,18 @@\n-jlong CPUTimeUsage::GC::vm_thread() {\n-  return Universe::heap()->_vmthread_cpu_time;\n+class DetailedCPUTimeThreadClosure : public ThreadClosure {\n+private:\n+  CPUTime_t _cpu_time = {\n+    0,\n+    0\n+  };\n+\n+public:\n+  virtual void do_thread(Thread* thread) {\n+    CPUTime_t new_value = detailed_thread_cpu_time_or_zero(thread);\n+    _cpu_time.user += new_value.user;\n+    _cpu_time.system += new_value.system;\n+  }\n+  CPUTime_t cpu_time() { return _cpu_time; };\n+};\n+\n+jlong CPUTimeUsage::GC::total() {\n+  return gc_threads() + vm_thread() + stringdedup();\n@@ -68,2 +96,2 @@\n-jlong CPUTimeUsage::GC::total() {\n-  return gc_threads() + vm_thread() + stringdedup();\n+jlong CPUTimeUsage::GC::vm_thread() {\n+  return Universe::heap()->_vmthread_cpu_time;\n@@ -79,0 +107,21 @@\n+CPUTime_t CPUTimeUsage::GC::detailed_gc_threads() {\n+  DetailedCPUTimeThreadClosure cl;\n+  Universe::heap()->gc_threads_do(&cl);\n+  return cl.cpu_time();\n+}\n+\n+CPUTime_t CPUTimeUsage::GC::detailed_gc_operation_vm_thread() {\n+  assert_at_safepoint();\n+  return detailed_thread_cpu_time_or_zero((Thread*)VMThread::vm_thread());\n+}\n+\n+CPUTime_t CPUTimeUsage::GC::detailed_stringdedup() {\n+  if (UseStringDeduplication) {\n+    return detailed_thread_cpu_time_or_zero((Thread*)StringDedup::_processor->_thread);\n+  }\n+  return {\n+    0,\n+    0\n+  };\n+}\n+\n","filename":"src\/hotspot\/share\/services\/cpuTimeUsage.cpp","additions":53,"deletions":4,"binary":false,"changes":57,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -34,0 +35,1 @@\n+    \/\/ user + system time\n@@ -38,0 +40,7 @@\n+\n+    \/\/ user and system reported separately\n+    static CPUTime_t detailed_gc_threads();\n+    \/\/ detailed_gc_operation_vm_thread assumes it is called\n+    \/\/ during the start and end of a GC safepoint.\n+    static CPUTime_t detailed_gc_operation_vm_thread();\n+    static CPUTime_t detailed_stringdedup();\n","filename":"src\/hotspot\/share\/services\/cpuTimeUsage.hpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -299,0 +299,1 @@\n+const int NANOUNITS_PER_MICROUNIT = NANOUNITS \/ MICROUNITS;\n","filename":"src\/hotspot\/share\/utilities\/globalDefinitions.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}