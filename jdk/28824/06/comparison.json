{"files":[{"patch":"@@ -2467,1 +2467,5 @@\n-jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {\n+CPUTime os::current_detailed_thread_cpu_time() {\n+  return os::detailed_thread_cpu_time(Thread::current());\n+}\n+\n+CPUTime os::detailed_thread_cpu_time(Thread* t) {\n@@ -2471,2 +2475,2 @@\n-  if (!thread_cpu_time_unchecked(thread, &sys_time, &user_time)) {\n-    return -1;\n+  if (!thread_cpu_time_unchecked(t, &sys_time, &user_time)) {\n+    return { -1, -1 };\n@@ -2475,1 +2479,4 @@\n-  return user_sys_cpu_time ? sys_time + user_time : user_time;\n+  return {\n+    user_time,\n+    sys_time\n+  };\n@@ -2477,1 +2484,0 @@\n-\n","filename":"src\/hotspot\/os\/aix\/os_aix.cpp","additions":11,"deletions":5,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2293,0 +2293,27 @@\n+CPUTime os::current_detailed_thread_cpu_time() {\n+  return os::detailed_thread_cpu_time(Thread::current());\n+}\n+\n+CPUTime os::detailed_thread_cpu_time(Thread* t) {\n+#ifdef __APPLE__\n+  struct thread_basic_info tinfo;\n+  mach_msg_type_number_t tcount = THREAD_INFO_MAX;\n+  kern_return_t kr;\n+  thread_t mach_thread;\n+\n+  mach_thread = t->osthread()->thread_id();\n+  kr = thread_info(mach_thread, THREAD_BASIC_INFO, (thread_info_t)&tinfo, &tcount);\n+  if (kr != KERN_SUCCESS) {\n+    return { -1, -1 };\n+  }\n+\n+  return {\n+    ((jlong) tinfo.user_time.seconds * NANOSECS_PER_SEC) + ((jlong) tinfo.user_time.microseconds * MICROS_PER_SEC),\n+    ((jlong) tinfo.system_time.seconds * NANOSECS_PER_SEC) + ((jlong)tinfo.system_time.microseconds * MICROS_PER_SEC)\n+  };\n+#else\n+  Unimplemented();\n+  return { 0, 0 };\n+#endif\n+}\n+\n@@ -2327,28 +2354,0 @@\n-jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {\n-#ifdef __APPLE__\n-  struct thread_basic_info tinfo;\n-  mach_msg_type_number_t tcount = THREAD_INFO_MAX;\n-  kern_return_t kr;\n-  thread_t mach_thread;\n-\n-  mach_thread = thread->osthread()->thread_id();\n-  kr = thread_info(mach_thread, THREAD_BASIC_INFO, (thread_info_t)&tinfo, &tcount);\n-  if (kr != KERN_SUCCESS) {\n-    return -1;\n-  }\n-\n-  if (user_sys_cpu_time) {\n-    jlong nanos;\n-    nanos = ((jlong) tinfo.system_time.seconds + tinfo.user_time.seconds) * (jlong)1000000000;\n-    nanos += ((jlong) tinfo.system_time.microseconds + (jlong) tinfo.user_time.microseconds) * (jlong)1000;\n-    return nanos;\n-  } else {\n-    return ((jlong)tinfo.user_time.seconds * 1000000000) + ((jlong)tinfo.user_time.microseconds * (jlong)1000);\n-  }\n-#else\n-  Unimplemented();\n-  return 0;\n-#endif\n-}\n-\n-\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":27,"deletions":28,"binary":false,"changes":55,"status":"modified"},{"patch":"@@ -5001,0 +5001,16 @@\n+CPUTime os::current_detailed_thread_cpu_time() {\n+  struct rusage usage;\n+  if (getrusage(RUSAGE_THREAD, &usage) == 0) {\n+    return {\n+      usage.ru_stime.tv_sec * NANOSECS_PER_SEC + usage.ru_stime.tv_usec * MICROS_PER_SEC +\n+      usage.ru_utime.tv_sec * NANOSECS_PER_SEC + usage.ru_utime.tv_usec * MICROS_PER_SEC,\n+      usage.ru_utime.tv_sec * NANOSECS_PER_SEC + usage.ru_utime.tv_usec * MICROS_PER_SEC\n+    };\n+  }\n+  return {-1, -1};\n+}\n+\n+CPUTime os::detailed_thread_cpu_time(Thread* t) {\n+  return CPUTime(total_thread_cpu_time(t), user_thread_cpu_time(t));\n+}\n+\n@@ -5024,8 +5040,0 @@\n-jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {\n-  if (user_sys_cpu_time) {\n-    return total_thread_cpu_time(thread);\n-  } else {\n-    return user_thread_cpu_time(thread);\n-  }\n-}\n-\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":16,"deletions":8,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2025, Oracle and\/or its affiliates. All rights reserved.\n","filename":"src\/hotspot\/os\/linux\/os_linux.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -55,0 +55,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -4892,0 +4893,22 @@\n+constexpr jlong filetime_interval = 100;\n+\n+CPUTime os::current_detailed_thread_cpu_time() {\n+  return os::detailed_thread_cpu_time(Thread::current());\n+}\n+\n+CPUTime os::detailed_thread_cpu_time(Thread* t) {\n+  FILETIME CreationTime;\n+  FILETIME ExitTime;\n+  FILETIME KernelTime;\n+  FILETIME UserTime;\n+\n+  if (GetThreadTimes(t->osthread()->thread_handle(), &CreationTime,\n+                      &ExitTime, &KernelTime, &UserTime) == 0) {\n+    return { -1, -1 };\n+  }\n+\n+  return {\n+    FT2INT64(UserTime) * filetime_interval,\n+    FT2INT64(KernelTime) * filetime_interval\n+  };\n+}\n@@ -4915,18 +4938,0 @@\n-jlong os::thread_cpu_time(Thread* thread, bool user_sys_cpu_time) {\n-  \/\/ This code is copy from classic VM -> hpi::sysThreadCPUTime\n-  \/\/ If this function changes, os::is_thread_cpu_time_supported() should too\n-  FILETIME CreationTime;\n-  FILETIME ExitTime;\n-  FILETIME KernelTime;\n-  FILETIME UserTime;\n-\n-  if (GetThreadTimes(thread->osthread()->thread_handle(), &CreationTime,\n-                      &ExitTime, &KernelTime, &UserTime) == 0) {\n-    return -1;\n-  } else if (user_sys_cpu_time) {\n-    return (FT2INT64(UserTime) + FT2INT64(KernelTime)) * 100;\n-  } else {\n-    return FT2INT64(UserTime) * 100;\n-  }\n-}\n-\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":23,"deletions":18,"binary":false,"changes":41,"status":"modified"},{"patch":"@@ -32,0 +32,3 @@\n+#include \"services\/cpuTimeUsage.hpp\"\n+#include \"utilities\/debug.hpp\"\n+#include \"utilities\/globalDefinitions.hpp\"\n@@ -71,0 +74,10 @@\n+static CPUTime sample_detailed_cpu_time() {\n+  CPUTime cpu_time_vm = os::current_detailed_thread_cpu_time();\n+  CPUTime cpu_time_gc = CPUTimeUsage::GC::detailed_gc_threads();\n+  CPUTime cpu_time_stringdedup = CPUTimeUsage::GC::detailed_stringdedup();\n+  return {\n+    cpu_time_vm.total() + cpu_time_gc.total() + cpu_time_gc.total(),\n+    cpu_time_vm.user() + cpu_time_gc.user() + cpu_time_stringdedup.user()\n+  };\n+}\n+\n@@ -74,2 +87,1 @@\n-  _starting_user_time(0.0),\n-  _starting_system_time(0.0),\n+  _starting_cpu_time(0,0),\n@@ -77,2 +89,1 @@\n-  _tracer(tracer)\n-{\n+  _tracer(tracer) {\n@@ -80,5 +91,4 @@\n-    bool valid = os::getTimesSecs(&_starting_real_time,\n-                                  &_starting_user_time,\n-                                  &_starting_system_time);\n-    if (!valid) {\n-      log_warning(gc, cpu)(\"TraceCPUTime: os::getTimesSecs() returned invalid result\");\n+    _starting_cpu_time = sample_detailed_cpu_time();\n+    _starting_real_time = os::elapsedTime();\n+    if (CPUTimeUsage::Error::has_error()) {\n+      log_warning(gc, cpu)(\"TraceCPUTime: CPUTimeUsage may contain invalid results\");\n@@ -92,5 +102,8 @@\n-    double real_time, user_time, system_time;\n-    bool valid = os::getTimesSecs(&real_time, &user_time, &system_time);\n-    if (valid) {\n-      user_time -= _starting_user_time;\n-      system_time -= _starting_system_time;\n+    double real_time = os::elapsedTime();\n+    CPUTime cpu_time = sample_detailed_cpu_time();\n+\n+    if (!CPUTimeUsage::Error::has_error()) {\n+      guarantee((cpu_time.user() - _starting_cpu_time.user()) >= 0, \"must be\");\n+      guarantee((cpu_time.system() - _starting_cpu_time.system()) >= 0, \"must be\");\n+\n+      cpu_time -= _starting_cpu_time;\n@@ -98,1 +111,4 @@\n-      log_info(gc, cpu)(\"User=%3.2fs Sys=%3.2fs Real=%3.2fs\", user_time, system_time, real_time);\n+\n+      double user_time_seconds = 1.0 * cpu_time.user() \/ NANOSECS_PER_SEC;\n+      double system_time_seconds = 1.0 * cpu_time.system() \/ NANOSECS_PER_SEC;\n+      log_info(gc, cpu)(\"User=%3.2fs Sys=%3.2fs Real=%3.2fs\", user_time_seconds, system_time_seconds, real_time);\n@@ -100,1 +116,1 @@\n-        _tracer->report_cpu_time_event(user_time, system_time, real_time);\n+        _tracer->report_cpu_time_event(user_time_seconds, system_time_seconds, real_time);\n@@ -103,1 +119,1 @@\n-      log_warning(gc, cpu)(\"TraceCPUTime: os::getTimesSecs() returned invalid result\");\n+      log_warning(gc, cpu)(\"TraceCPUTime: CPUTimeUsage may contain invalid results\");\n","filename":"src\/hotspot\/share\/gc\/shared\/gcTraceTime.cpp","additions":33,"deletions":17,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -38,4 +39,3 @@\n-  bool _active;                 \/\/ true if times will be measured and printed\n-  double _starting_user_time;   \/\/ user time at start of measurement\n-  double _starting_system_time; \/\/ system time at start of measurement\n-  double _starting_real_time;   \/\/ real time at start of measurement\n+  bool _active;                  \/\/ True if times will be measured and printed\n+  CPUTime _starting_cpu_time;    \/\/ User and system time at start of measurement\n+  double _starting_real_time;    \/\/ Real time at start of measurement\n","filename":"src\/hotspot\/share\/gc\/shared\/gcTraceTime.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -139,0 +139,4 @@\n+  static CPUTime get_detailed_cpu_time() {\n+    return os::current_detailed_thread_cpu_time();\n+  }\n+\n","filename":"src\/hotspot\/share\/gc\/shared\/stringdedup\/stringDedup.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -76,0 +76,1 @@\n+#include \"utilities\/debug.hpp\"\n@@ -103,0 +104,17 @@\n+CPUTime::CPUTime(jlong total, jlong user) :\n+  _total(static_cast<int64_t>(total)), _user(static_cast<int64_t>(user)) {};\n+\n+CPUTime& CPUTime::operator+=(const CPUTime &other) {\n+  _total += other._total;\n+  _user += other._user;\n+  return *this;\n+}\n+\n+CPUTime& CPUTime::operator-=(const CPUTime &other) {\n+  guarantee(_total - other._total >= 0, \"\");\n+  guarantee(_user - other._user >= 0, \"\");\n+  _total -= other._total;\n+  _user -= other._user;\n+  return *this;\n+}\n+\n@@ -509,0 +527,7 @@\n+jlong os::thread_cpu_time(Thread* thread, bool user_sys_cpu_time) {\n+  CPUTime cpu_time = detailed_thread_cpu_time(thread);\n+  if (cpu_time.user() == -1) {\n+    return -1;\n+  }\n+  return user_sys_cpu_time ? cpu_time.total() : cpu_time.user();\n+}\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":25,"deletions":0,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+#include <cstdint>\n@@ -170,0 +171,15 @@\n+class CPUTime {\n+private:\n+  int64_t _total;\n+  int64_t _user;\n+\n+public:\n+  CPUTime(jlong total, jlong user);\n+  CPUTime& operator+=(const CPUTime &other);\n+  CPUTime& operator-=(const CPUTime &other);\n+\n+  int64_t total() { return _total; };\n+  int64_t user() { return _user;};\n+  int64_t system() { return _total - _user; }\n+};\n+\n@@ -997,0 +1013,3 @@\n+  static CPUTime current_detailed_thread_cpu_time();\n+  static CPUTime detailed_thread_cpu_time(Thread* t);\n+\n","filename":"src\/hotspot\/share\/runtime\/os.hpp","additions":19,"deletions":0,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+#include \"utilities\/globalDefinitions.hpp\"\n@@ -38,0 +39,20 @@\n+static inline CPUTime detailed_current_thread_cpu_time_or_zero() {\n+  CPUTime cpu_time = os::current_detailed_thread_cpu_time();\n+  if (cpu_time.user() != -1) {\n+    return cpu_time;\n+  } else {\n+    CPUTimeUsage::Error::mark_error();\n+    return {0, 0};\n+  }\n+}\n+\n+static inline CPUTime detailed_thread_cpu_time_or_zero(Thread* thread) {\n+  CPUTime cpu_time = os::detailed_thread_cpu_time(thread);\n+  if (cpu_time.user() != -1) {\n+    return cpu_time;\n+  } else {\n+    CPUTimeUsage::Error::mark_error();\n+    return {0, 0};\n+  }\n+}\n+\n@@ -58,2 +79,13 @@\n-jlong CPUTimeUsage::GC::vm_thread() {\n-  return Universe::heap()->_vmthread_cpu_time;\n+class DetailedCPUTimeThreadClosure : public ThreadClosure {\n+private:\n+  CPUTime _cpu_time = { 0, 0 };\n+\n+public:\n+  virtual void do_thread(Thread* thread) {\n+    _cpu_time += detailed_current_thread_cpu_time_or_zero();\n+  }\n+  CPUTime cpu_time() { return _cpu_time; };\n+};\n+\n+jlong CPUTimeUsage::GC::total() {\n+  return gc_threads() + vm_thread() + stringdedup();\n@@ -68,2 +100,2 @@\n-jlong CPUTimeUsage::GC::total() {\n-  return gc_threads() + vm_thread() + stringdedup();\n+jlong CPUTimeUsage::GC::vm_thread() {\n+  return Universe::heap()->_vmthread_cpu_time;\n@@ -79,0 +111,13 @@\n+CPUTime CPUTimeUsage::GC::detailed_gc_threads() {\n+  DetailedCPUTimeThreadClosure cl;\n+  Universe::heap()->gc_threads_do(&cl);\n+  return cl.cpu_time();\n+}\n+\n+CPUTime CPUTimeUsage::GC::detailed_stringdedup() {\n+  if (UseStringDeduplication) {\n+    return StringDedup::get_detailed_cpu_time();\n+  }\n+  return { 0, 0 };\n+}\n+\n","filename":"src\/hotspot\/share\/services\/cpuTimeUsage.cpp","additions":49,"deletions":4,"binary":false,"changes":53,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -34,0 +35,1 @@\n+    \/\/ user + system time\n@@ -38,0 +40,6 @@\n+\n+    \/\/ user and system reported separately, and a using\n+    \/\/ sub-system that supports stable sampling during\n+    \/\/ high frequency sampling\n+    static CPUTime detailed_gc_threads();\n+    static CPUTime detailed_stringdedup();\n","filename":"src\/hotspot\/share\/services\/cpuTimeUsage.hpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -299,0 +299,1 @@\n+const int NANOUNITS_PER_MICROUNIT = NANOUNITS \/ MICROUNITS;\n@@ -300,0 +301,1 @@\n+const jlong MICROS_PER_SEC        = CONST64(1000);\n","filename":"src\/hotspot\/share\/utilities\/globalDefinitions.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}