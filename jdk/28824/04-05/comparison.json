{"files":[{"patch":"@@ -2467,0 +2467,4 @@\n+CPUTime os::current_detailed_thread_cpu_time() {\n+  return os::detailed_thread_cpu_time(Thread::current());\n+}\n+\n","filename":"src\/hotspot\/os\/aix\/os_aix.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2293,0 +2293,4 @@\n+CPUTime os::current_detailed_thread_cpu_time() {\n+  return os::detailed_thread_cpu_time(Thread::current());\n+}\n+\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -5001,0 +5001,12 @@\n+CPUTime os::current_detailed_thread_cpu_time() {\n+  struct rusage usage;\n+  if (getrusage(RUSAGE_THREAD, &usage) == 0) {\n+    return {\n+      usage.ru_stime.tv_sec * NANOSECS_PER_SEC + usage.ru_stime.tv_usec * MICROS_PER_SEC +\n+      usage.ru_utime.tv_sec * NANOSECS_PER_SEC + usage.ru_utime.tv_usec * MICROS_PER_SEC,\n+      usage.ru_utime.tv_sec * NANOSECS_PER_SEC + usage.ru_utime.tv_usec * MICROS_PER_SEC\n+    };\n+  }\n+  return {-1, -1};\n+}\n+\n@@ -5002,6 +5014,1 @@\n-  jlong user = user_thread_cpu_time(t);\n-  jlong total = total_thread_cpu_time(t);\n-  return {\n-    user,\n-    total - user\n-  };\n+  return CPUTime(total_thread_cpu_time(t), user_thread_cpu_time(t));\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":13,"deletions":6,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -4895,0 +4895,4 @@\n+CPUTime os::current_detailed_thread_cpu_time() {\n+  return os::detailed_thread_cpu_time(Thread::current());\n+}\n+\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -33,0 +33,1 @@\n+#include \"utilities\/debug.hpp\"\n@@ -74,1 +75,1 @@\n-  CPUTime cpu_time_vm = CPUTimeUsage::GC::detailed_gc_operation_vm_thread();\n+  CPUTime cpu_time_vm = os::current_detailed_thread_cpu_time();\n@@ -78,2 +79,2 @@\n-    cpu_time_vm.user + cpu_time_gc.user + cpu_time_stringdedup.user,\n-    cpu_time_vm.system + cpu_time_gc.system + cpu_time_stringdedup.system\n+    cpu_time_vm.total() + cpu_time_gc.total() + cpu_time_gc.total(),\n+    cpu_time_vm.user() + cpu_time_gc.user() + cpu_time_stringdedup.user()\n@@ -105,0 +106,3 @@\n+      guarantee((cpu_time.user() - _starting_cpu_time.user()) >= 0, \"must be\");\n+      guarantee((cpu_time.system() - _starting_cpu_time.system()) >= 0, \"must be\");\n+\n@@ -107,2 +111,3 @@\n-      double user_time_seconds = 1.0 * cpu_time.user \/ NANOSECS_PER_SEC;\n-      double system_time_seconds = 1.0 * cpu_time.system \/ NANOSECS_PER_SEC;\n+\n+      double user_time_seconds = 1.0 * cpu_time.user() \/ NANOSECS_PER_SEC;\n+      double system_time_seconds = 1.0 * cpu_time.system() \/ NANOSECS_PER_SEC;\n","filename":"src\/hotspot\/share\/gc\/shared\/gcTraceTime.cpp","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -139,0 +139,4 @@\n+  static CPUTime get_detailed_cpu_time() {\n+    return os::current_detailed_thread_cpu_time();\n+  }\n+\n","filename":"src\/hotspot\/share\/gc\/shared\/stringdedup\/stringDedup.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -76,0 +76,1 @@\n+#include \"utilities\/debug.hpp\"\n@@ -103,2 +104,2 @@\n-CPUTime::CPUTime(jlong user, jlong system) :\n-  user(static_cast<int64_t>(user)), system(static_cast<int64_t>(system)) {};\n+CPUTime::CPUTime(jlong total, jlong user) :\n+  _total(static_cast<int64_t>(total)), _user(static_cast<int64_t>(user)) {};\n@@ -107,2 +108,2 @@\n-  user += other.user;\n-  system += other.system;\n+  _total += other._total;\n+  _user += other._user;\n@@ -113,2 +114,4 @@\n-  user -= other.user;\n-  system -= other.system;\n+  guarantee(_total - other._total >= 0, \"\");\n+  guarantee(_user - other._user >= 0, \"\");\n+  _total -= other._total;\n+  _user -= other._user;\n@@ -526,1 +529,1 @@\n-  if (cpu_time.user == -1) {\n+  if (cpu_time.user() == -1) {\n@@ -529,1 +532,1 @@\n-  return user_sys_cpu_time ? cpu_time.user + cpu_time.system : cpu_time.user;\n+  return user_sys_cpu_time ? cpu_time.total() : cpu_time.user();\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":11,"deletions":8,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+#include <cstdint>\n@@ -171,0 +172,4 @@\n+private:\n+  int64_t _total;\n+  int64_t _user;\n+\n@@ -172,3 +177,1 @@\n-  int64_t user;\n-  int64_t system;\n-  CPUTime(jlong user, jlong system);\n+  CPUTime(jlong total, jlong user);\n@@ -177,0 +180,4 @@\n+\n+  int64_t total() { return _total; };\n+  int64_t user() { return _user;};\n+  int64_t system() { return _total - _user; }\n@@ -998,1 +1005,1 @@\n-\n+  \n@@ -1006,0 +1013,1 @@\n+  static CPUTime current_detailed_thread_cpu_time();\n","filename":"src\/hotspot\/share\/runtime\/os.hpp","additions":12,"deletions":4,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+#include \"utilities\/globalDefinitions.hpp\"\n@@ -38,0 +39,10 @@\n+static inline CPUTime detailed_current_thread_cpu_time_or_zero() {\n+  CPUTime cpu_time = os::current_detailed_thread_cpu_time();\n+  if (cpu_time.user() != -1) {\n+    return cpu_time;\n+  } else {\n+    CPUTimeUsage::Error::mark_error();\n+    return {0, 0};\n+  }\n+}\n+\n@@ -40,1 +51,3 @@\n-  if (cpu_time.system == -1 || cpu_time.user == -1) {\n+  if (cpu_time.user() != -1) {\n+    return cpu_time;\n+  } else {\n@@ -42,1 +55,1 @@\n-    return { 0, 0 };\n+    return {0, 0};\n@@ -44,1 +57,0 @@\n-  return cpu_time;\n@@ -73,1 +85,1 @@\n-    _cpu_time += detailed_thread_cpu_time_or_zero(thread);\n+    _cpu_time += detailed_current_thread_cpu_time_or_zero();\n@@ -105,5 +117,0 @@\n-CPUTime CPUTimeUsage::GC::detailed_gc_operation_vm_thread() {\n-  assert_at_safepoint();\n-  return detailed_thread_cpu_time_or_zero((Thread*)VMThread::vm_thread());\n-}\n-\n@@ -112,1 +119,1 @@\n-    return detailed_thread_cpu_time_or_zero((Thread*)StringDedup::_processor->_thread);\n+    return StringDedup::get_detailed_cpu_time();\n","filename":"src\/hotspot\/share\/services\/cpuTimeUsage.cpp","additions":17,"deletions":10,"binary":false,"changes":27,"status":"modified"},{"patch":"@@ -41,1 +41,3 @@\n-    \/\/ user and system reported separately\n+    \/\/ user and system reported separately, and a using\n+    \/\/ sub-system that supports stable sampling during\n+    \/\/ high frequency sampling\n@@ -43,3 +45,0 @@\n-    \/\/ detailed_gc_operation_vm_thread assumes it is called\n-    \/\/ during the start and end of a GC safepoint.\n-    static CPUTime detailed_gc_operation_vm_thread();\n","filename":"src\/hotspot\/share\/services\/cpuTimeUsage.hpp","additions":3,"deletions":4,"binary":false,"changes":7,"status":"modified"}]}