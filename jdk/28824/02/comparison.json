{"files":[{"patch":"@@ -2467,1 +2467,1 @@\n-jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {\n+CPUTime os::detailed_thread_cpu_time(Thread* t) {\n@@ -2471,2 +2471,2 @@\n-  if (!thread_cpu_time_unchecked(thread, &sys_time, &user_time)) {\n-    return -1;\n+  if (!thread_cpu_time_unchecked(t, &sys_time, &user_time)) {\n+    return { -1, -1 };\n@@ -2475,1 +2475,4 @@\n-  return user_sys_cpu_time ? sys_time + user_time : user_time;\n+  return {\n+    user_time,\n+    sys_time\n+  };\n@@ -2477,1 +2480,0 @@\n-\n","filename":"src\/hotspot\/os\/aix\/os_aix.cpp","additions":7,"deletions":5,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -2293,0 +2293,23 @@\n+CPUTime os::detailed_thread_cpu_time(Thread* t) {\n+#ifdef __APPLE__\n+  struct thread_basic_info tinfo;\n+  mach_msg_type_number_t tcount = THREAD_INFO_MAX;\n+  kern_return_t kr;\n+  thread_t mach_thread;\n+\n+  mach_thread = t->osthread()->thread_id();\n+  kr = thread_info(mach_thread, THREAD_BASIC_INFO, (thread_info_t)&tinfo, &tcount);\n+  if (kr != KERN_SUCCESS) {\n+    return { -1, -1 };\n+  }\n+\n+  return {\n+    ((jlong) tinfo.user_time.seconds * NANOSECS_PER_SEC) + ((jlong) tinfo.user_time.microseconds * MICROS_PER_SEC),\n+    ((jlong) tinfo.system_time.seconds * NANOSECS_PER_SEC) + ((jlong)tinfo.system_time.microseconds * MICROS_PER_SEC)\n+  };\n+#else\n+  Unimplemented();\n+  return { 0, 0 };\n+#endif\n+}\n+\n@@ -2327,28 +2350,0 @@\n-jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {\n-#ifdef __APPLE__\n-  struct thread_basic_info tinfo;\n-  mach_msg_type_number_t tcount = THREAD_INFO_MAX;\n-  kern_return_t kr;\n-  thread_t mach_thread;\n-\n-  mach_thread = thread->osthread()->thread_id();\n-  kr = thread_info(mach_thread, THREAD_BASIC_INFO, (thread_info_t)&tinfo, &tcount);\n-  if (kr != KERN_SUCCESS) {\n-    return -1;\n-  }\n-\n-  if (user_sys_cpu_time) {\n-    jlong nanos;\n-    nanos = ((jlong) tinfo.system_time.seconds + tinfo.user_time.seconds) * (jlong)1000000000;\n-    nanos += ((jlong) tinfo.system_time.microseconds + (jlong) tinfo.user_time.microseconds) * (jlong)1000;\n-    return nanos;\n-  } else {\n-    return ((jlong)tinfo.user_time.seconds * 1000000000) + ((jlong)tinfo.user_time.microseconds * (jlong)1000);\n-  }\n-#else\n-  Unimplemented();\n-  return 0;\n-#endif\n-}\n-\n-\n","filename":"src\/hotspot\/os\/bsd\/os_bsd.cpp","additions":23,"deletions":28,"binary":false,"changes":51,"status":"modified"},{"patch":"@@ -5001,0 +5001,9 @@\n+CPUTime os::detailed_thread_cpu_time(Thread* t) {\n+  jlong user = user_thread_cpu_time(t);\n+  jlong total = total_thread_cpu_time(t);\n+  return {\n+    user,\n+    total - user\n+  };\n+}\n+\n@@ -5024,8 +5033,0 @@\n-jlong os::thread_cpu_time(Thread *thread, bool user_sys_cpu_time) {\n-  if (user_sys_cpu_time) {\n-    return total_thread_cpu_time(thread);\n-  } else {\n-    return user_thread_cpu_time(thread);\n-  }\n-}\n-\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":9,"deletions":8,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2025, Oracle and\/or its affiliates. All rights reserved.\n","filename":"src\/hotspot\/os\/linux\/os_linux.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -55,0 +55,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -4892,0 +4893,18 @@\n+constexpr jlong filetime_interval = 100;\n+\n+CPUTime os::detailed_thread_cpu_time(Thread* t) {\n+  FILETIME CreationTime;\n+  FILETIME ExitTime;\n+  FILETIME KernelTime;\n+  FILETIME UserTime;\n+\n+  if (GetThreadTimes(t->osthread()->thread_handle(), &CreationTime,\n+                      &ExitTime, &KernelTime, &UserTime) == 0) {\n+    return { -1, -1 };\n+  }\n+\n+  return {\n+    FT2INT64(UserTime) * filetime_interval,\n+    FT2INT64(KernelTime) * filetime_interval\n+  };\n+}\n@@ -4915,18 +4934,0 @@\n-jlong os::thread_cpu_time(Thread* thread, bool user_sys_cpu_time) {\n-  \/\/ This code is copy from classic VM -> hpi::sysThreadCPUTime\n-  \/\/ If this function changes, os::is_thread_cpu_time_supported() should too\n-  FILETIME CreationTime;\n-  FILETIME ExitTime;\n-  FILETIME KernelTime;\n-  FILETIME UserTime;\n-\n-  if (GetThreadTimes(thread->osthread()->thread_handle(), &CreationTime,\n-                      &ExitTime, &KernelTime, &UserTime) == 0) {\n-    return -1;\n-  } else if (user_sys_cpu_time) {\n-    return (FT2INT64(UserTime) + FT2INT64(KernelTime)) * 100;\n-  } else {\n-    return FT2INT64(UserTime) * 100;\n-  }\n-}\n-\n","filename":"src\/hotspot\/os\/windows\/os_windows.cpp","additions":19,"deletions":18,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -32,0 +32,2 @@\n+#include \"services\/cpuTimeUsage.hpp\"\n+#include \"utilities\/globalDefinitions.hpp\"\n@@ -71,0 +73,10 @@\n+static CPUTime sample_detailed_cpu_time() {\n+  CPUTime cpu_time_vm = CPUTimeUsage::GC::detailed_gc_operation_vm_thread();\n+  CPUTime cpu_time_gc = CPUTimeUsage::GC::detailed_gc_threads();\n+  CPUTime cpu_time_stringdedup = CPUTimeUsage::GC::detailed_stringdedup();\n+  return {\n+    cpu_time_vm.user + cpu_time_gc.user + cpu_time_stringdedup.user,\n+    cpu_time_vm.system + cpu_time_gc.system + cpu_time_stringdedup.system\n+  };\n+}\n+\n@@ -74,2 +86,1 @@\n-  _starting_user_time(0.0),\n-  _starting_system_time(0.0),\n+  _starting_cpu_time(0,0),\n@@ -77,2 +88,1 @@\n-  _tracer(tracer)\n-{\n+  _tracer(tracer) {\n@@ -80,5 +90,4 @@\n-    bool valid = os::getTimesSecs(&_starting_real_time,\n-                                  &_starting_user_time,\n-                                  &_starting_system_time);\n-    if (!valid) {\n-      log_warning(gc, cpu)(\"TraceCPUTime: os::getTimesSecs() returned invalid result\");\n+    _starting_cpu_time = sample_detailed_cpu_time();\n+    _starting_real_time = os::elapsedTime();\n+    if (CPUTimeUsage::Error::has_error()) {\n+      log_warning(gc, cpu)(\"TraceCPUTime: CPUTimeUsage may contain invalid results\");\n@@ -92,5 +101,5 @@\n-    double real_time, user_time, system_time;\n-    bool valid = os::getTimesSecs(&real_time, &user_time, &system_time);\n-    if (valid) {\n-      user_time -= _starting_user_time;\n-      system_time -= _starting_system_time;\n+    double real_time = os::elapsedTime();\n+    CPUTime cpu_time = sample_detailed_cpu_time();\n+\n+    if (!CPUTimeUsage::Error::has_error()) {\n+      cpu_time -= _starting_cpu_time;\n@@ -98,1 +107,3 @@\n-      log_info(gc, cpu)(\"User=%3.2fs Sys=%3.2fs Real=%3.2fs\", user_time, system_time, real_time);\n+      double user_time_seconds = 1.0 * cpu_time.user \/ NANOSECS_PER_SEC;\n+      double system_time_seconds = 1.0 * cpu_time.system \/ NANOSECS_PER_SEC;\n+      log_info(gc, cpu)(\"User=%3.2fs Sys=%3.2fs Real=%3.2fs\", user_time_seconds, system_time_seconds, real_time);\n@@ -100,1 +111,1 @@\n-        _tracer->report_cpu_time_event(user_time, system_time, real_time);\n+        _tracer->report_cpu_time_event(user_time_seconds, system_time_seconds, real_time);\n@@ -103,1 +114,1 @@\n-      log_warning(gc, cpu)(\"TraceCPUTime: os::getTimesSecs() returned invalid result\");\n+      log_warning(gc, cpu)(\"TraceCPUTime: CPUTimeUsage may contain invalid results\");\n","filename":"src\/hotspot\/share\/gc\/shared\/gcTraceTime.cpp","additions":28,"deletions":17,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -38,4 +39,3 @@\n-  bool _active;                 \/\/ true if times will be measured and printed\n-  double _starting_user_time;   \/\/ user time at start of measurement\n-  double _starting_system_time; \/\/ system time at start of measurement\n-  double _starting_real_time;   \/\/ real time at start of measurement\n+  bool _active;                  \/\/ True if times will be measured and printed\n+  CPUTime _starting_cpu_time;    \/\/ User and system time at start of measurement\n+  double _starting_real_time;    \/\/ Real time at start of measurement\n","filename":"src\/hotspot\/share\/gc\/shared\/gcTraceTime.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -103,0 +103,9 @@\n+CPUTime::CPUTime(long user, long system) :\n+  user(user), system(system) {};\n+\n+CPUTime CPUTime::operator-=(const CPUTime &n) {\n+  user -= n.user;\n+  system -= n.system;\n+  return *this;\n+}\n+\n@@ -509,0 +518,7 @@\n+jlong os::thread_cpu_time(Thread* thread, bool user_sys_cpu_time) {\n+  CPUTime cpu_time = detailed_thread_cpu_time(thread);\n+  if (cpu_time.user == -1) {\n+    return -1;\n+  }\n+  return user_sys_cpu_time ? cpu_time.user + cpu_time.system : cpu_time.user;\n+}\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":16,"deletions":0,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -170,0 +170,8 @@\n+class CPUTime {\n+public:\n+  long user;\n+  long system;\n+  CPUTime(long user, long system);\n+  CPUTime operator-=(const CPUTime &n);\n+};\n+\n@@ -997,0 +1005,2 @@\n+  static CPUTime detailed_thread_cpu_time(Thread* t);\n+\n","filename":"src\/hotspot\/share\/runtime\/os.hpp","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -38,0 +38,9 @@\n+static inline CPUTime detailed_thread_cpu_time_or_zero(Thread* thread) {\n+  CPUTime cpu_time = os::detailed_thread_cpu_time(thread);\n+  if (cpu_time.system == -1 || cpu_time.user == -1) {\n+    CPUTimeUsage::Error::mark_error();\n+    return { 0, 0 };\n+  }\n+  return cpu_time;\n+}\n+\n@@ -58,2 +67,15 @@\n-jlong CPUTimeUsage::GC::vm_thread() {\n-  return Universe::heap()->_vmthread_cpu_time;\n+class DetailedCPUTimeThreadClosure : public ThreadClosure {\n+private:\n+  CPUTime _cpu_time = { 0, 0 };\n+\n+public:\n+  virtual void do_thread(Thread* thread) {\n+    CPUTime new_value = detailed_thread_cpu_time_or_zero(thread);\n+    _cpu_time.user += new_value.user;\n+    _cpu_time.system += new_value.system;\n+  }\n+  CPUTime cpu_time() { return _cpu_time; };\n+};\n+\n+jlong CPUTimeUsage::GC::total() {\n+  return gc_threads() + vm_thread() + stringdedup();\n@@ -68,2 +90,2 @@\n-jlong CPUTimeUsage::GC::total() {\n-  return gc_threads() + vm_thread() + stringdedup();\n+jlong CPUTimeUsage::GC::vm_thread() {\n+  return Universe::heap()->_vmthread_cpu_time;\n@@ -79,0 +101,18 @@\n+CPUTime CPUTimeUsage::GC::detailed_gc_threads() {\n+  DetailedCPUTimeThreadClosure cl;\n+  Universe::heap()->gc_threads_do(&cl);\n+  return cl.cpu_time();\n+}\n+\n+CPUTime CPUTimeUsage::GC::detailed_gc_operation_vm_thread() {\n+  assert_at_safepoint();\n+  return detailed_thread_cpu_time_or_zero((Thread*)VMThread::vm_thread());\n+}\n+\n+CPUTime CPUTimeUsage::GC::detailed_stringdedup() {\n+  if (UseStringDeduplication) {\n+    return detailed_thread_cpu_time_or_zero((Thread*)StringDedup::_processor->_thread);\n+  }\n+  return { 0, 0 };\n+}\n+\n","filename":"src\/hotspot\/share\/services\/cpuTimeUsage.cpp","additions":44,"deletions":4,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -34,0 +35,1 @@\n+    \/\/ user + system time\n@@ -38,0 +40,7 @@\n+\n+    \/\/ user and system reported separately\n+    static CPUTime detailed_gc_threads();\n+    \/\/ detailed_gc_operation_vm_thread assumes it is called\n+    \/\/ during the start and end of a GC safepoint.\n+    static CPUTime detailed_gc_operation_vm_thread();\n+    static CPUTime detailed_stringdedup();\n","filename":"src\/hotspot\/share\/services\/cpuTimeUsage.hpp","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -299,0 +299,1 @@\n+const int NANOUNITS_PER_MICROUNIT = NANOUNITS \/ MICROUNITS;\n@@ -300,0 +301,1 @@\n+const jlong MICROS_PER_SEC        = CONST64(1000);\n","filename":"src\/hotspot\/share\/utilities\/globalDefinitions.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}