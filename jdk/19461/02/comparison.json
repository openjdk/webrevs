{"files":[{"patch":"@@ -90,1 +90,1 @@\n-  enum class Tag {\n+  enum class Tag : uint8_t {\n@@ -104,0 +104,1 @@\n+  uint32_t _init_size;\n","filename":"src\/hotspot\/share\/memory\/arena.hpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+#include \"utilities\/debug.hpp\"\n@@ -35,0 +36,6 @@\n+#include \"utilities\/ostream.hpp\"\n+\n+#define INDENT_BY(num_chars, CODE) { \\\n+  streamIndentor si(out, num_chars); \\\n+  { CODE }                           \\\n+}\n@@ -46,0 +53,9 @@\n+MemReporterBase::MemReporterBase(outputStream* out, size_t scale) :\n+  _scale(scale), _output(out) {\n+  _output->set_autoindent(true);\n+}\n+\n+MemReporterBase::~MemReporterBase() {\n+  _output->set_autoindent(false);\n+}\n+\n@@ -108,13 +124,1 @@\n-void MemReporterBase::print_malloc_line(const MemoryCounter* c) const {\n-  output()->print(\"%28s\", \" \");\n-  print_malloc(c);\n-  output()->print_cr(\" \");\n-}\n-\n-void MemReporterBase::print_virtual_memory_line(size_t reserved, size_t committed, size_t peak) const {\n-  output()->print(\"%28s\", \" \");\n-  print_virtual_memory(reserved, committed, peak);\n-  output()->print_cr(\" \");\n-}\n-\n-void MemReporterBase::print_arena_line(const MemoryCounter* c) const {\n+void MemReporterBase::print_arena(const MemoryCounter* c) const {\n@@ -127,2 +131,2 @@\n-  out->print(\"%27s (arena=\" SIZE_FORMAT \"%s #\" SIZE_FORMAT \")\", \"\",\n-    amount_in_current_scale(amount), scale, count);\n+  out->print(\"(arena=\" SIZE_FORMAT \"%s #\" SIZE_FORMAT \")\",\n+             amount_in_current_scale(amount), scale, count);\n@@ -138,2 +142,0 @@\n-\n-  out->cr();\n@@ -159,1 +161,3 @@\n-  out->print_cr(\"\\nNative Memory Tracking:\\n\");\n+  out->cr();\n+  out->print_cr(\"Native Memory Tracking:\");\n+  out->cr();\n@@ -169,7 +173,9 @@\n-  out->print_cr(\"       malloc: \" SIZE_FORMAT \"%s #\" SIZE_FORMAT \", peak=\" SIZE_FORMAT \"%s #\" SIZE_FORMAT,\n-                amount_in_current_scale(total_malloced_bytes), current_scale(),\n-                _malloc_snapshot->total_count(),\n-                amount_in_current_scale(_malloc_snapshot->total_peak()),\n-                current_scale(), _malloc_snapshot->total_peak_count());\n-  out->print(\"       mmap:   \");\n-  print_total(total_mmap_reserved_bytes, total_mmap_committed_bytes);\n+  INDENT_BY(7,\n+    out->print_cr(\"malloc: \" SIZE_FORMAT \"%s #\" SIZE_FORMAT \", peak=\" SIZE_FORMAT \"%s #\" SIZE_FORMAT,\n+                  amount_in_current_scale(total_malloced_bytes), current_scale(),\n+                  _malloc_snapshot->total_count(),\n+                  amount_in_current_scale(_malloc_snapshot->total_peak()),\n+                  current_scale(), _malloc_snapshot->total_peak_count());\n+    out->print(\"mmap:   \");\n+    print_total(total_mmap_reserved_bytes, total_mmap_committed_bytes);\n+  )\n@@ -221,1 +227,2 @@\n-  out->print(\"-%26s (\", NMTUtil::flag_to_name(flag));\n+  constexpr int indent = 28;\n+  out->print(\"-%*s (\", indent - 2, NMTUtil::flag_to_name(flag));\n@@ -232,0 +239,2 @@\n+  streamIndentor si(out, indent);\n+\n@@ -234,4 +243,3 @@\n-    out->print_cr(\"%27s (classes #\" SIZE_FORMAT \")\",\n-      \" \", (_instance_class_count + _array_class_count));\n-    out->print_cr(\"%27s (  instance classes #\" SIZE_FORMAT \", array classes #\" SIZE_FORMAT \")\",\n-      \" \", _instance_class_count, _array_class_count);\n+    out->print_cr(\"(classes #\" SIZE_FORMAT \")\", (_instance_class_count + _array_class_count));\n+    out->print_cr(\"(  instance classes #\" SIZE_FORMAT \", array classes #\" SIZE_FORMAT \")\",\n+                  _instance_class_count, _array_class_count);\n@@ -242,2 +250,2 @@\n-    out->print_cr(\"%27s (threads #\" SIZE_FORMAT \")\", \" \", ThreadStackTracker::thread_count());\n-    out->print(\"%27s (stack: \", \" \");\n+    out->print_cr(\"(threads #\" SIZE_FORMAT \")\", ThreadStackTracker::thread_count());\n+    out->print(\"(stack: \");\n@@ -250,1 +258,2 @@\n-    print_malloc_line(malloc_memory->malloc_counter());\n+    print_malloc(malloc_memory->malloc_counter());\n+    out->cr();\n@@ -254,1 +263,2 @@\n-    print_virtual_memory_line(virtual_memory->reserved(), virtual_memory->committed(), virtual_memory->peak_size());\n+    print_virtual_memory(virtual_memory->reserved(), virtual_memory->committed(), virtual_memory->peak_size());\n+    out->cr();\n@@ -258,1 +268,2 @@\n-    print_arena_line(malloc_memory->arena_counter());\n+    print_arena(malloc_memory->arena_counter());\n+    out->cr();\n@@ -263,2 +274,2 @@\n-    out->print_cr(\"%27s (tracking overhead=\" SIZE_FORMAT \"%s)\", \" \",\n-      amount_in_current_scale(_malloc_snapshot->malloc_overhead()), scale);\n+    out->print_cr(\"(tracking overhead=\" SIZE_FORMAT \"%s)\",\n+                   amount_in_current_scale(_malloc_snapshot->malloc_overhead()), scale);\n@@ -272,1 +283,1 @@\n-  out->print_cr(\" \");\n+  out->cr();\n@@ -295,2 +306,2 @@\n-  out->print_cr(\"%27s (  %s)\", \" \", name);\n-  out->print(\"%27s (    \", \" \");\n+  out->print_cr(\"(  %s)\", name);\n+  out->print(\"(    \");\n@@ -299,3 +310,3 @@\n-  out->print_cr(\"%27s (    used=\" SIZE_FORMAT \"%s)\", \" \", amount_in_current_scale(stats.used()), scale);\n-  out->print_cr(\"%27s (    waste=\" SIZE_FORMAT \"%s =%2.2f%%)\", \" \", amount_in_current_scale(waste),\n-    scale, waste_percentage);\n+  out->print_cr(\"(    used=\" SIZE_FORMAT \"%s)\", amount_in_current_scale(stats.used()), scale);\n+  out->print_cr(\"(    waste=\" SIZE_FORMAT \"%s =%2.2f%%)\", amount_in_current_scale(waste),\n+                scale, waste_percentage);\n@@ -336,1 +347,0 @@\n-    out->print(\"%29s\", \" \");\n@@ -340,2 +350,6 @@\n-    print_malloc(malloc_site->counter(), flag);\n-    out->print_cr(\"\\n\");\n+    INDENT_BY(29,\n+      out->print(\"(\");\n+      print_malloc(malloc_site->counter(), flag);\n+      out->print_cr(\")\");\n+    )\n+    out->cr();\n@@ -353,0 +367,1 @@\n+\n@@ -369,7 +384,10 @@\n-    out->print(\"%28s (\", \" \");\n-    print_total(virtual_memory_site->reserved(), virtual_memory_site->committed());\n-    MEMFLAGS flag = virtual_memory_site->flag();\n-    if (flag != mtNone) {\n-      out->print(\" Type=%s\", NMTUtil::flag_to_name(flag));\n-    }\n-    out->print_cr(\")\\n\");\n+    INDENT_BY(29,\n+      out->print(\"(\");\n+      print_total(virtual_memory_site->reserved(), virtual_memory_site->committed());\n+      const MEMFLAGS flag = virtual_memory_site->flag();\n+      if (flag != mtNone) {\n+        out->print(\" Type=%s\", NMTUtil::flag_to_name(flag));\n+      }\n+      out->print_cr(\")\");\n+    )\n+    out->cr();\n@@ -412,1 +430,1 @@\n-  out->print_cr(\" \");\n+  out->cr();\n@@ -416,1 +434,1 @@\n-    out->print_cr(\" \");\n+    out->cr();\n@@ -419,1 +437,1 @@\n-    stack->print_on(out, 4);\n+    INDENT_BY(4, stack->print_on(out);)\n@@ -440,8 +458,10 @@\n-    out->print(\"\\n\\t\");\n-    print_virtual_memory_region(\"committed\", committed_rgn->base(), committed_rgn->size());\n-    if (stack->is_empty()) {\n-      out->print_cr(\" \");\n-    } else {\n-      out->print_cr(\" from\");\n-      stack->print_on(out, 12);\n-    }\n+    out->cr();\n+    INDENT_BY(8,\n+      print_virtual_memory_region(\"committed\", committed_rgn->base(), committed_rgn->size());\n+      if (stack->is_empty()) {\n+        out->cr();\n+      } else {\n+        out->print_cr(\" from\");\n+        INDENT_BY(4, stack->print_on(out);)\n+      }\n+    )\n@@ -451,0 +471,9 @@\n+void MemDetailReporter::report_memory_file_allocations() {\n+  stringStream st;\n+  {\n+    MemoryFileTracker::Instance::Locker lock;\n+    MemoryFileTracker::Instance::print_all_reports_on(&st, scale());\n+  }\n+  output()->print_raw(st.freeze());\n+}\n+\n@@ -453,1 +482,3 @@\n-  out->print_cr(\"\\nNative Memory Tracking:\\n\");\n+  out->cr();\n+  out->print_cr(\"Native Memory Tracking:\");\n+  out->cr();\n@@ -466,1 +497,2 @@\n-  out->print_cr(\"\\n\");\n+  out->cr();\n+  out->cr();\n@@ -551,0 +583,1 @@\n+  constexpr int indent = 28;\n@@ -584,1 +617,1 @@\n-    out->print(\"-%26s (\", NMTUtil::flag_to_name(flag));\n+    out->print(\"-%*s (\", indent - 2, NMTUtil::flag_to_name(flag));\n@@ -589,0 +622,2 @@\n+    streamIndentor si(out, indent);\n+\n@@ -592,1 +627,1 @@\n-      out->print(\"%27s (classes #\" SIZE_FORMAT \"\", \" \", _current_baseline.class_count());\n+      out->print(\"(classes #\" SIZE_FORMAT, _current_baseline.class_count());\n@@ -600,1 +635,1 @@\n-      out->print(\"%27s (  instance classes #\" SIZE_FORMAT, \" \", _current_baseline.instance_class_count());\n+      out->print(\"(  instance classes #\" SIZE_FORMAT, _current_baseline.instance_class_count());\n@@ -616,1 +651,1 @@\n-      out->print(\"%27s (threads #\" SIZE_FORMAT \"\", \" \", _current_baseline.thread_count());\n+      out->print(\"(threads #\" SIZE_FORMAT, _current_baseline.thread_count());\n@@ -623,1 +658,1 @@\n-      out->print(\"%27s (stack: \", \" \");\n+      out->print(\"(stack: \");\n@@ -641,1 +676,1 @@\n-      out->print(\"%28s(\", \" \");\n+      out->print(\"(\");\n@@ -650,1 +685,1 @@\n-      out->print(\"%27s (mmap: \", \" \");\n+      out->print(\"(mmap: \");\n@@ -659,1 +694,1 @@\n-      out->print(\"%28s(\", \" \");\n+      out->print(\"(\");\n@@ -670,2 +705,2 @@\n-      out->print(\"%27s (tracking overhead=\" SIZE_FORMAT \"%s\", \" \",\n-        amount_in_current_scale(_current_baseline.malloc_tracking_overhead()), scale);\n+      out->print(\"(tracking overhead=\" SIZE_FORMAT \"%s\",\n+                 amount_in_current_scale(_current_baseline.malloc_tracking_overhead()), scale);\n@@ -682,1 +717,1 @@\n-    out->print_cr(\" \");\n+    out->cr();\n@@ -700,2 +735,2 @@\n-  out->print_cr(\"%27s: (  %s)\", \" \", header);\n-  out->print(\"%27s (    \", \" \");\n+  out->print_cr(\"(  %s)\", header);\n+  out->print(\"(    \");\n@@ -716,2 +751,2 @@\n-  out->print(\"%27s (    used=\" SIZE_FORMAT \"%s\", \" \",\n-    amount_in_current_scale(current_stats.used()), scale);\n+  out->print(\"(    used=\" SIZE_FORMAT \"%s\",\n+             amount_in_current_scale(current_stats.used()), scale);\n@@ -726,2 +761,2 @@\n-  out->print(\"%27s (    waste=\" SIZE_FORMAT \"%s =%2.2f%%\", \" \",\n-    amount_in_current_scale(current_waste), scale, waste_percentage);\n+  out->print(\"(    waste=\" SIZE_FORMAT \"%s =%2.2f%%\",\n+             amount_in_current_scale(current_waste), scale, waste_percentage);\n@@ -844,3 +879,6 @@\n-  out->print(\"%28s (\", \" \");\n-  print_malloc_diff(current_size, current_count,\n-    early_size, early_count, flags);\n+  INDENT_BY(28,\n+    out->print(\"(\");\n+    print_malloc_diff(current_size, current_count, early_size, early_count, flags);\n+    out->print_cr(\")\");\n+  )\n+  out->cr();\n@@ -848,1 +886,0 @@\n-  out->print_cr(\")\\n\");\n@@ -877,9 +914,9 @@\n-  out->print(\"%28s (mmap: \", \" \");\n-  print_virtual_memory_diff(current_reserved, current_committed,\n-    early_reserved, early_committed);\n-\n-  if (flag != mtNone) {\n-    out->print(\" Type=%s\", NMTUtil::flag_to_name(flag));\n-  }\n-\n-  out->print_cr(\")\\n\");\n+  INDENT_BY(28,\n+    out->print(\"(mmap: \");\n+    print_virtual_memory_diff(current_reserved, current_committed, early_reserved, early_committed);\n+    if (flag != mtNone) {\n+      out->print(\" Type=%s\", NMTUtil::flag_to_name(flag));\n+    }\n+    out->print_cr(\")\");\n+  )\n+  out->cr();\n@@ -888,8 +925,0 @@\n-void MemDetailReporter::report_memory_file_allocations() {\n-  stringStream st;\n-  {\n-    MemoryFileTracker::Instance::Locker lock;\n-    MemoryFileTracker::Instance::print_all_reports_on(&st, scale());\n-  }\n-  output()->print_raw(st.freeze());\n-}\n","filename":"src\/hotspot\/share\/nmt\/memReporter.cpp","additions":133,"deletions":104,"binary":false,"changes":237,"status":"modified"},{"patch":"@@ -47,3 +47,2 @@\n-  MemReporterBase(outputStream* out, size_t scale = default_scale) :\n-    _scale(scale), _output(out)\n-  {}\n+  MemReporterBase(outputStream* out, size_t scale = default_scale);\n+  ~MemReporterBase();\n@@ -112,4 +111,1 @@\n-\n-  void print_malloc_line(const MemoryCounter* c) const;\n-  void print_virtual_memory_line(size_t reserved, size_t committed, size_t peak) const;\n-  void print_arena_line(const MemoryCounter* c) const;\n+  void print_arena(const MemoryCounter* c) const;\n","filename":"src\/hotspot\/share\/nmt\/memReporter.hpp","additions":3,"deletions":7,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -95,1 +95,4 @@\n-      _stack_storage.get(prev->val().out.stack()).print_on(stream, 4);\n+      {\n+        streamIndentor si(stream, 4);\n+        _stack_storage.get(prev->val().out.stack()).print_on(stream);\n+      }\n","filename":"src\/hotspot\/share\/nmt\/memoryFileTracker.cpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -74,4 +74,0 @@\n-void NativeCallStack::print_on(outputStream* out) const {\n-  print_on(out, 0);\n-}\n-\n@@ -79,1 +75,1 @@\n-void NativeCallStack::print_on(outputStream* out, int indent) const {\n+void NativeCallStack::print_on(outputStream* out) const {\n@@ -85,1 +81,0 @@\n-    out->fill_to(indent);\n@@ -91,1 +86,0 @@\n-      out->fill_to(indent);\n","filename":"src\/hotspot\/share\/utilities\/nativeCallStack.cpp","additions":1,"deletions":7,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -127,1 +127,0 @@\n-  void print_on(outputStream* out, int indent) const;\n","filename":"src\/hotspot\/share\/utilities\/nativeCallStack.hpp","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -47,8 +47,0 @@\n-outputStream::outputStream() {\n-  _position    = 0;\n-  _precount    = 0;\n-  _indentation = 0;\n-  _scratch     = nullptr;\n-  _scratch_len = 0;\n-}\n-\n@@ -59,0 +51,1 @@\n+  _autoindent  = false;\n@@ -162,0 +155,3 @@\n+  if (_autoindent && _position == 0) {\n+    indent();\n+  }\n@@ -191,0 +187,7 @@\n+void outputStream::print_raw(const char* str, size_t len) {\n+  if (_autoindent && _position == 0) {\n+    indent();\n+  }\n+  write(str, len);\n+}\n+\n","filename":"src\/hotspot\/share\/utilities\/ostream.cpp","additions":11,"deletions":8,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -49,0 +49,2 @@\n+   int _indentation; \/\/ current indentation\n+   bool _autoindent; \/\/ if true, every line starts with indentation\n@@ -51,1 +53,0 @@\n-   int _indentation; \/\/ current indentation\n@@ -93,2 +94,1 @@\n-   outputStream();\n-   outputStream(bool has_time_stamps);\n+   outputStream(bool has_time_stamps = false);\n@@ -107,0 +107,7 @@\n+   \/\/ Automatic indentation:\n+   \/\/ If autoindent mode is on, the following APIs will automatically indent\n+   \/\/ line starts depending on the current indentation level:\n+   \/\/ print(), print_cr(), print_raw(), print_raw_cr()\n+   \/\/ Other APIs are unaffected\n+   void set_autoindent(bool value) { _autoindent = value; }\n+\n@@ -122,4 +129,4 @@\n-   void print_raw(const char* str) { write(str, strlen(str)); }\n-   void print_raw(const char* str, size_t len) { write(str, len); }\n-   void print_raw_cr(const char* str) { write(str, strlen(str)); cr(); }\n-   void print_raw_cr(const char* str, size_t len){ write(str, len); cr(); }\n+   void print_raw(const char* str)                { print_raw(str, strlen(str)); }\n+   void print_raw(const char* str, size_t len);\n+   void print_raw_cr(const char* str)             { print_raw(str); cr(); }\n+   void print_raw_cr(const char* str, size_t len) { print_raw(str, len); cr(); }\n","filename":"src\/hotspot\/share\/utilities\/ostream.hpp","additions":14,"deletions":7,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -107,0 +107,47 @@\n+static void test_autoindent(bool on) {\n+  stringStream ss;\n+  ss.set_autoindent(on);\n+  {\n+    streamIndentor si(&ss, 5);\n+    ss.print(\"ABC\");\n+    ss.print(\"DEF\");\n+    ss.cr();\n+    ss.print_cr(\"0123\");\n+    {\n+      streamIndentor si(&ss, 5);\n+      ss.print_cr(\"4567\");\n+      ss.print_raw(\"89AB\");\n+      ss.print_raw(\"CDEXXXX\", 3);\n+      ss.print_raw_cr(\"XYZ\");\n+    }\n+    ss.print(\"%u\", 100);\n+    ss.print_raw(\"KB\");\n+    ss.cr();\n+  }\n+  ss.print(\"end\");\n+\n+  if (on) {\n+    EXPECT_STREQ(ss.base(),\n+        \"     ABCDEF\\n\"\n+        \"     0123\\n\"\n+        \"          4567\\n\"\n+        \"          89ABCDEXYZ\\n\"\n+        \"     100KB\\n\"\n+        \"end\"\n+    );\n+  } else {\n+    \/\/ no autoindent: calls should work as always without indentation\n+    EXPECT_STREQ(ss.base(),\n+        \"ABCDEF\\n\"\n+        \"0123\\n\"\n+        \"4567\\n\"\n+        \"89ABCDEXYZ\\n\"\n+        \"100KB\\n\"\n+        \"end\"\n+    );\n+  }\n+}\n+\n+TEST_VM(ostream, autoindent_on)  { test_autoindent(true);  }\n+TEST_VM(ostream, autoindent_off) { test_autoindent(false); }\n+\n","filename":"test\/hotspot\/gtest\/utilities\/test_ostream.cpp","additions":47,"deletions":0,"binary":false,"changes":47,"status":"modified"}]}