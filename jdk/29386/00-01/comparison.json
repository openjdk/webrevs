{"files":[{"patch":"@@ -311,1 +311,1 @@\n-  _end = _allocation_end;\n+  _end.store_relaxed(allocation_end());\n@@ -316,1 +316,1 @@\n-  precond(sampling_point <= _allocation_end);\n+  precond(sampling_point <= allocation_end());\n@@ -319,1 +319,1 @@\n-  _end = sampling_point;\n+  _end.store_relaxed(sampling_point);\n@@ -323,1 +323,1 @@\n-  return _allocation_end + alignment_reserve();\n+  return allocation_end() + alignment_reserve();\n","filename":"src\/hotspot\/share\/gc\/shared\/threadLocalAllocBuffer.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -37,4 +37,1 @@\n-\/\/ the threads for allocation.\n-\/\/            It is thread-private at any time, but maybe multiplexed over\n-\/\/            time across multiple threads. The park()\/unpark() pair is\n-\/\/            used to make it available for such multiplexing.\n+\/\/ the threads for allocation. It is thread-private at any time.\n@@ -42,5 +39,5 @@\n-\/\/            Heap sampling is performed via the end and allocation_end\n-\/\/            fields.\n-\/\/            allocation_end contains the real end of the tlab allocation,\n-\/\/            whereas end can be set to an arbitrary spot in the tlab to\n-\/\/            trip the return and sample the allocation.\n+\/\/ Heap sampling is performed via the end and allocation_end\n+\/\/ fields.\n+\/\/ allocation_end contains the real end of the tlab allocation,\n+\/\/ whereas end can be set to an arbitrary spot in the tlab to\n+\/\/ trip the return and sample the allocation.\n@@ -53,3 +50,3 @@\n-  HeapWord* _pf_top;                             \/\/ allocation prefetch watermark\n-  HeapWord* _end;                                \/\/ allocation end (can be the sampling end point or _allocation_end)\n-  HeapWord* _allocation_end;                     \/\/ end for allocations (actual TLAB end, excluding alignment_reserve)\n+  Atomic<HeapWord*> _pf_top;                     \/\/ allocation prefetch watermark\n+  Atomic<HeapWord*> _end;                        \/\/ allocation end (can be the sampling end point or _allocation_end)\n+  Atomic<HeapWord*> _allocation_end;             \/\/ end for allocations (actual TLAB end, excluding alignment_reserve)\n@@ -75,0 +72,2 @@\n+  HeapWord* allocation_end() const               { return _allocation_end.load_relaxed(); }\n+\n@@ -76,2 +75,2 @@\n-  void set_end(HeapWord* end)                    { _end = end; }\n-  void set_allocation_end(HeapWord* ptr)         { _allocation_end = ptr; }\n+  void set_end(HeapWord* end)                    { _end.store_relaxed(end); }\n+  void set_allocation_end(HeapWord* ptr)         { _allocation_end.store_relaxed(ptr); }\n@@ -79,1 +78,1 @@\n-  void set_pf_top(HeapWord* pf_top)              { _pf_top = pf_top; }\n+  void set_pf_top(HeapWord* pf_top)              { _pf_top.store_relaxed(pf_top); }\n@@ -117,1 +116,1 @@\n-  HeapWord* end() const                          { return _end; }\n+  HeapWord* end() const                          { return _end.load_relaxed(); }\n@@ -120,1 +119,0 @@\n-  HeapWord* pf_top() const                       { return _pf_top; }\n@@ -122,1 +120,0 @@\n-  size_t used() const                            { return pointer_delta(top(), start()); }\n","filename":"src\/hotspot\/share\/gc\/shared\/threadLocalAllocBuffer.hpp","additions":15,"deletions":18,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -449,2 +449,2 @@\n-  nonstatic_field(ThreadLocalAllocBuffer,   _end,                                             HeapWord*)                             \\\n-  nonstatic_field(ThreadLocalAllocBuffer,   _pf_top,                                          HeapWord*)                             \\\n+  nonstatic_field(ThreadLocalAllocBuffer,   _end,                                             Atomic<HeapWord*>)                     \\\n+  nonstatic_field(ThreadLocalAllocBuffer,   _pf_top,                                          Atomic<HeapWord*>)                     \\\n","filename":"src\/hotspot\/share\/jvmci\/vmStructs_jvmci.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -352,2 +352,2 @@\n-  nonstatic_field(ThreadLocalAllocBuffer,      _end,                                          HeapWord*)                             \\\n-  nonstatic_field(ThreadLocalAllocBuffer,      _pf_top,                                       HeapWord*)                             \\\n+  nonstatic_field(ThreadLocalAllocBuffer,      _end,                                          Atomic<HeapWord*>)                     \\\n+  nonstatic_field(ThreadLocalAllocBuffer,      _pf_top,                                       Atomic<HeapWord*>)                     \\\n","filename":"src\/hotspot\/share\/runtime\/vmStructs.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}