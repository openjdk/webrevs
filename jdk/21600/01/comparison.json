{"files":[{"patch":"@@ -33,0 +33,1 @@\n+#include \"gc\/z\/zLargePages.inline.hpp\"\n@@ -49,0 +50,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -235,3 +237,8 @@\n-  const ZPhysicalMemoryManager* const _physical;\n-  volatile zoffset                    _start;\n-  const zoffset_end                   _end;\n+  volatile uintptr_t _current;\n+  const uintptr_t    _end;\n+\n+  static void pretouch(zaddress zaddr, size_t size) {\n+    const uintptr_t addr = untype(zaddr);\n+    const size_t page_size = ZLargePages::is_explicit() ? ZGranuleSize : os::vm_page_size();\n+    os::pretouch_memory((void*)addr, (void*)(addr + size), page_size);\n+  }\n@@ -240,1 +247,1 @@\n-  ZPreTouchTask(const ZPhysicalMemoryManager* physical, zoffset start, zoffset_end end)\n+  ZPreTouchTask(zoffset start, zoffset_end end)\n@@ -242,3 +249,2 @@\n-      _physical(physical),\n-      _start(start),\n-      _end(end) {}\n+      _current(untype(start)),\n+      _end(untype(end)) {}\n@@ -247,0 +253,2 @@\n+    const size_t size = ZGranuleSize;\n+\n@@ -248,4 +256,3 @@\n-      \/\/ Get granule offset\n-      const size_t size = ZGranuleSize;\n-      const zoffset offset = to_zoffset(Atomic::fetch_then_add((uintptr_t*)&_start, size));\n-      if (offset >= _end) {\n+      \/\/ Claim an offset for this thread\n+      const uintptr_t claimed = Atomic::fetch_then_add(&_current, size);\n+      if (claimed >= _end) {\n@@ -256,2 +263,6 @@\n-      \/\/ Pre-touch granule\n-      _physical->pretouch(offset, size);\n+      \/\/ At this point we know that we have a valid zoffset \/ zaddress.\n+      const zoffset offset = to_zoffset(claimed);\n+      const zaddress addr = ZOffset::address(offset);\n+\n+      \/\/ Pre-touch the granule\n+      pretouch(addr, size);\n@@ -274,1 +285,1 @@\n-    ZPreTouchTask task(&_physical, page->start(), page->end());\n+    ZPreTouchTask task(page->start(), page->end());\n","filename":"src\/hotspot\/share\/gc\/z\/zPageAllocator.cpp","additions":25,"deletions":14,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -356,6 +356,0 @@\n-void ZPhysicalMemoryManager::pretouch(zoffset offset, size_t size) const {\n-  const uintptr_t addr = untype(ZOffset::address(offset));\n-  const size_t page_size = ZLargePages::is_explicit() ? ZGranuleSize : os::vm_page_size();\n-  os::pretouch_memory((void*)addr, (void*)(addr + size), page_size);\n-}\n-\n","filename":"src\/hotspot\/share\/gc\/z\/zPhysicalMemory.cpp","additions":0,"deletions":6,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -87,4 +87,0 @@\n-  void pretouch_view(zaddress addr, size_t size) const;\n-  void map_view(zaddress_unsafe addr, const ZPhysicalMemory& pmem) const;\n-  void unmap_view(zaddress_unsafe addr, size_t size) const;\n-\n@@ -105,2 +101,0 @@\n-  void pretouch(zoffset offset, size_t size) const;\n-\n","filename":"src\/hotspot\/share\/gc\/z\/zPhysicalMemory.hpp","additions":0,"deletions":6,"binary":false,"changes":6,"status":"modified"}]}