{"files":[{"patch":"@@ -2253,0 +2253,20 @@\n+\n+JNIEXPORT void JNICALL Java_sun_awt_X11_XInputMethod_moveCandidateWindow\n+ (JNIEnv *env, jobject this, jint x, jint y)\n+{\n+    X11InputMethodData *pX11IMData;\n+    XVaNestedList preedit_attr;\n+    XPoint nspot;\n+\n+    pX11IMData = getX11InputMethodData(env, this);\n+    if ((pX11IMData == NULL) || (pX11IMData->current_ic == NULL)) {\n+        return;\n+    }\n+\n+    nspot.x = x;\n+    nspot.y = y;\n+    preedit_attr = XVaCreateNestedList(0, XNSpotLocation, &nspot, NULL);\n+    XSetICValues(pX11IMData->current_ic, XNPreeditAttributes, preedit_attr, NULL);\n+\n+    XFree(preedit_attr);\n+}\n","filename":"src\/java.desktop\/aix\/native\/libawt_xawt\/awt\/awt_InputMethod.c","additions":20,"deletions":0,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import java.awt.AWTEvent;\n@@ -31,0 +32,2 @@\n+import java.awt.Dimension;\n+import java.awt.Point;\n@@ -32,0 +35,3 @@\n+import java.awt.event.KeyEvent;\n+import java.awt.event.MouseEvent;\n+import java.awt.font.TextHitInfo;\n@@ -48,0 +54,2 @@\n+    private InputMethodContext inputContext;\n+\n@@ -52,0 +60,1 @@\n+    @Override\n@@ -53,0 +62,1 @@\n+        this.inputContext = context;\n@@ -56,0 +66,1 @@\n+    @Override\n@@ -61,0 +72,3 @@\n+\n+        \/\/After window moved, this would called.\n+        positionCandidateWindow();\n@@ -63,0 +77,1 @@\n+    @Override\n@@ -67,0 +82,1 @@\n+    @Override\n@@ -78,0 +94,1 @@\n+    @Override\n@@ -96,0 +113,1 @@\n+    @Override\n@@ -104,0 +122,1 @@\n+    @Override\n@@ -129,0 +148,1 @@\n+    @Override\n@@ -134,0 +154,1 @@\n+    @Override\n@@ -138,0 +159,1 @@\n+    @Override\n@@ -148,0 +170,56 @@\n+    @Override\n+    public void dispatchEvent(AWTEvent e) {\n+        switch (e.getID()) {\n+            case KeyEvent.KEY_PRESSED:\n+            case KeyEvent.KEY_RELEASED:\n+            case MouseEvent.MOUSE_CLICKED:\n+                positionCandidateWindow();\n+                break;\n+\n+            default:\n+                break;\n+        }\n+    }\n+\n+    private void positionCandidateWindow() {\n+        if (this.inputContext == null) {\n+            return;\n+        }\n+\n+        Component client = getClientComponent();\n+        if (client == null || !client.isShowing()) {\n+            return;\n+        }\n+\n+        int x = 0;\n+        int y = 0;\n+\n+        \/\/ Get this textcomponent coordinate from root window.\n+        Component temp = client;\n+        while (temp != null) {\n+             Component parent = temp.getParent();\n+             if (parent == null) {\n+                 break;\n+             }\n+\n+             x += temp.getX();\n+             y += temp.getY();\n+             temp = parent;\n+        }\n+\n+        if (haveActiveClient()) {\n+            Rectangle rc = inputContext.getTextLocation(TextHitInfo.leading(0));\n+            x += rc.x;\n+            y += rc.y + rc.height;\n+\n+            Point p = client.getLocationOnScreen();\n+            x -= p.x;\n+            y -= p.y;\n+        } else {\n+            Dimension size = client.getSize();\n+            y += size.height;\n+        }\n+\n+        moveCandidateWindow(x, y);\n+    }\n+\n@@ -156,0 +234,1 @@\n+    private native void moveCandidateWindow(int x, int y);\n","filename":"src\/java.desktop\/unix\/classes\/sun\/awt\/X11\/XInputMethod.java","additions":79,"deletions":0,"binary":false,"changes":79,"status":"modified"},{"patch":"@@ -866,5 +866,8 @@\n-    XVaNestedList status = NULL;\n-    XIMStyle on_the_spot_styles = XIMPreeditCallbacks,\n-             active_styles = 0,\n-             passive_styles = 0,\n-             no_styles = 0;\n+    XVaNestedList status  = NULL;\n+    \/* On ubuntu, XIMPreeditCallbacks doesn't work,\n+       and block the candidate window to move with caret.\n+     *\/\n+    XIMStyle on_the_spot_styles = XIMPreeditNothing,\n+             active_styles      = 0,\n+             passive_styles     = 0,\n+             no_styles          = 0;\n@@ -897,0 +900,1 @@\n+    \/*\n@@ -903,0 +907,3 @@\n+    *\/\n+#else\n+    on_the_spot_styles |= XIMPreeditCallbacks;\n@@ -906,1 +913,1 @@\n-        active_styles |= im_styles->supported_styles[i] & on_the_spot_styles;\n+        active_styles  |= im_styles->supported_styles[i] & on_the_spot_styles;\n@@ -908,1 +915,1 @@\n-        no_styles |= im_styles->supported_styles[i] & NO_STYLES;\n+        no_styles      |= im_styles->supported_styles[i] & NO_STYLES;\n@@ -1735,0 +1742,25 @@\n+\n+JNIEXPORT void JNICALL Java_sun_awt_X11_XInputMethod_moveCandidateWindow\n+ (JNIEnv *env, jobject this, jint x, jint y)\n+{\n+    X11InputMethodData *pX11IMData;\n+    XVaNestedList preedit_attr;\n+    XPoint nspot;\n+\n+    AWT_LOCK();\n+\n+    pX11IMData = getX11InputMethodData(env, this);\n+    if ((pX11IMData == NULL) || (pX11IMData->current_ic == NULL)) {\n+        AWT_UNLOCK();\n+        return;\n+    }\n+\n+    nspot.x = x;\n+    nspot.y = y;\n+    preedit_attr = XVaCreateNestedList(0, XNSpotLocation, &nspot, NULL);\n+    XSetICValues(pX11IMData->current_ic, XNPreeditAttributes, preedit_attr, NULL);\n+\n+    XFree(preedit_attr);\n+\n+    AWT_UNLOCK();\n+}\n","filename":"src\/java.desktop\/unix\/native\/libawt_xawt\/awt\/awt_InputMethod.c","additions":39,"deletions":7,"binary":false,"changes":46,"status":"modified"}]}