{"files":[{"patch":"@@ -1138,1 +1138,1 @@\n-bool OopStorage::print_containing(oop* addr, outputStream* st) {\n+bool OopStorage::print_containing(const oop* addr, outputStream* st) {\n@@ -1142,1 +1142,1 @@\n-      st->print_cr(\" in oop storage \\\"%s\\\"\", name());\n+      st->print(\" in oop storage \\\"%s\\\"\", name());\n@@ -1149,1 +1149,1 @@\n-bool OopStorage::Block::print_containing(oop* addr, outputStream* st) {\n+bool OopStorage::Block::print_containing(const oop* addr, outputStream* st) {\n@@ -1151,1 +1151,1 @@\n-    st->print(INTPTR_FORMAT \" is a pointer %u\/\" SIZE_FORMAT \" into block %zu\",\n+    st->print(PTR_FORMAT \" is a pointer %u\/%zu into block %zu\",\n","filename":"src\/hotspot\/share\/gc\/shared\/oopStorage.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -216,1 +216,1 @@\n-  bool print_containing(oop* addr, outputStream* st);\n+  bool print_containing(const oop* addr, outputStream* st);\n","filename":"src\/hotspot\/share\/gc\/shared\/oopStorage.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -200,1 +200,1 @@\n-  bool print_containing(oop* addr, outputStream* st);\n+  bool print_containing(const oop* addr, outputStream* st);\n","filename":"src\/hotspot\/share\/gc\/shared\/oopStorage.inline.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -85,2 +85,3 @@\n-bool OopStorageSet::print_containing(oop* addr, outputStream* st) {\n-  if (addr != nullptr) {\n+bool OopStorageSet::print_containing(const void* addr, outputStream* st) {\n+  const void* aligned_addr = align_down(addr, alignof(oop*));\n+  if (aligned_addr != nullptr) {\n@@ -88,1 +89,6 @@\n-      if (_storages[i]->print_containing(addr, st)) {\n+      if (_storages[i]->print_containing((oop*) aligned_addr, st)) {\n+        if (aligned_addr != addr) {\n+          st->print_cr(\" (unaligned)\");\n+        } else {\n+          st->cr();\n+        }\n","filename":"src\/hotspot\/share\/gc\/shared\/oopStorageSet.cpp","additions":9,"deletions":3,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -94,1 +94,1 @@\n-  static bool print_containing(oop* addr, outputStream* st);\n+  static bool print_containing(const void* addr, outputStream* st);\n","filename":"src\/hotspot\/share\/gc\/shared\/oopStorageSet.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1322,1 +1322,1 @@\n-  if (OopStorageSet::print_containing((oop*)addr, st)) {\n+  if (OopStorageSet::print_containing(addr, st)) {\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -109,10 +109,25 @@\n- class PrintContainingClosure : public Closure {\n-  public:\n-    void do_oop(oop* addr) {\n-      stringStream ss;\n-      bool printed = OopStorageSet::print_containing(addr, &ss);\n-      ASSERT_TRUE(printed);\n-      ASSERT_THAT(ss.freeze(), HasSubstr(\"is a pointer\"));\n-      ASSERT_THAT(ss.freeze(), HasSubstr(\"into block\"));\n-      ASSERT_THAT(ss.freeze(), HasSubstr(\"in oop storage\"));\n-    }\n+  class PrintContainingClosure : public Closure {\n+    public:\n+      void do_oop(oop* addr) {\n+        \/\/ Direct slot hit.\n+        {\n+          stringStream ss;\n+          bool printed = OopStorageSet::print_containing(addr, &ss);\n+          ASSERT_TRUE(printed);\n+          ASSERT_THAT(ss.freeze(), HasSubstr(\"is a pointer\"));\n+          ASSERT_THAT(ss.freeze(), HasSubstr(\"into block\"));\n+          ASSERT_THAT(ss.freeze(), HasSubstr(\"in oop storage\"));\n+        }\n+\n+        \/\/ Unaligned pointer to adjacent slot, should still be in oop storage range.\n+        {\n+          char* unaligned_addr = (char*)addr + 1;\n+          stringStream ss;\n+          bool printed = OopStorageSet::print_containing(unaligned_addr, &ss);\n+          ASSERT_TRUE(printed);\n+          ASSERT_THAT(ss.freeze(), HasSubstr(\"is a pointer\"));\n+          ASSERT_THAT(ss.freeze(), HasSubstr(\"into block\"));\n+          ASSERT_THAT(ss.freeze(), HasSubstr(\"in oop storage\"));\n+          ASSERT_THAT(ss.freeze(), HasSubstr(\"(unaligned)\"));\n+        }\n+      }\n@@ -143,1 +158,1 @@\n-    bool printed = OopStorageSet::print_containing((oop*)0x1, &ss);\n+    bool printed = OopStorageSet::print_containing((char*)0x1, &ss);\n@@ -151,1 +166,1 @@\n-    bool printed = OopStorageSet::print_containing((oop*)0x8, &ss);\n+    bool printed = OopStorageSet::print_containing((char*)0x8, &ss);\n","filename":"test\/hotspot\/gtest\/gc\/shared\/test_oopStorageSet.cpp","additions":27,"deletions":12,"binary":false,"changes":39,"status":"modified"}]}