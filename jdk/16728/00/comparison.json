{"files":[{"patch":"@@ -72,0 +72,3 @@\n+  \/\/ Caveat: BufferUpdater is not MT-safe. We use it only for testing.\n+  \/\/ We would observe missing loglines if we interleaved buffers.\n+  \/\/ Emit all logs between constructor and destructor of BufferUpdater.\n@@ -73,3 +76,1 @@\n-    auto writer = AsyncLogWriter::instance();\n-    if (writer != nullptr) {\n-      const size_t sz = 2000;\n+    const size_t sz = 2000;\n@@ -77,3 +78,4 @@\n-      \/\/ shrink async buffer.\n-      AsyncLogWriter::BufferUpdater saver(1024);\n-      LogMessage(logging) lm;\n+    \/\/ shrink async buffer.\n+    AsyncLogWriter::BufferUpdater saver(1024);\n+    test_asynclog_ls(); \/\/ roughly 200 bytes.\n+    LogMessage(logging) lm;\n@@ -81,5 +83,3 @@\n-      \/\/ write more messages than its capacity in burst\n-      for (size_t i = 0; i < sz; ++i) {\n-        lm.debug(\"a lot of log...\");\n-      }\n-      lm.flush();\n+    \/\/ write more messages than its capacity in burst\n+    for (size_t i = 0; i < sz; ++i) {\n+      lm.debug(\"a lot of log...\");\n@@ -87,0 +87,1 @@\n+    lm.flush();\n@@ -96,2 +97,1 @@\n-      \/\/ at least see \"header\"\n-      return fclose(f) == 0 && sz == written && sz >= 6;\n+      return fclose(f) == 0 && sz == written;\n@@ -247,0 +247,3 @@\n+  if (AsyncLogWriter::instance() == nullptr)\n+    return;\n+\n@@ -249,5 +252,1 @@\n-\n-  AsyncLogWriter::flush();\n-  if (AsyncLogWriter::instance() != nullptr) {\n-    EXPECT_TRUE(file_contains_substring(TestLogFileName, \"messages dropped due to async logging\"));\n-  }\n+  EXPECT_TRUE(file_contains_substring(TestLogFileName, \"messages dropped due to async logging\"));\n@@ -258,1 +257,0 @@\n-  fprintf(stdout, \"header\");\n@@ -264,2 +262,7 @@\n-  test_asynclog_ls();\n-  test_asynclog_drop_messages();\n+  bool async = AsyncLogWriter::instance() != nullptr;\n+  if (async) {\n+    test_asynclog_drop_messages();\n+    AsyncLogWriter::flush();\n+  } else {\n+    test_asynclog_ls();\n+  }\n@@ -267,1 +270,0 @@\n-  AsyncLogWriter::flush();\n@@ -269,1 +271,0 @@\n-\n@@ -274,1 +275,0 @@\n-  EXPECT_TRUE(file_contains_substring(TestLogFileName, \"header\"));\n@@ -279,1 +279,1 @@\n-  if (AsyncLogWriter::instance() != nullptr) {\n+  if (async) {\n@@ -286,1 +286,0 @@\n-  fprintf(stderr, \"header\");\n@@ -292,2 +291,7 @@\n-  test_asynclog_ls();\n-  test_asynclog_drop_messages();\n+  bool async = AsyncLogWriter::instance() != nullptr;\n+  if (async) {\n+    test_asynclog_drop_messages();\n+    AsyncLogWriter::flush();\n+  } else {\n+    test_asynclog_ls();\n+  }\n@@ -295,1 +299,0 @@\n-  AsyncLogWriter::flush();\n@@ -297,1 +300,0 @@\n-\n@@ -302,1 +304,0 @@\n-  EXPECT_TRUE(file_contains_substring(TestLogFileName, \"header\"));\n@@ -307,1 +308,1 @@\n-  if (AsyncLogWriter::instance() != nullptr) {\n+  if (async) {\n","filename":"test\/hotspot\/gtest\/logging\/test_asynclog.cpp","additions":33,"deletions":32,"binary":false,"changes":65,"status":"modified"}]}