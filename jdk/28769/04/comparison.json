{"files":[{"patch":"@@ -774,1 +774,1 @@\n-  Node* tlab_end = macro->make_load(toobig_false, mem, tlab_end_adr, 0, TypeRawPtr::BOTTOM, T_ADDRESS);\n+  Node* tlab_end = macro->make_load_raw(toobig_false, mem, tlab_end_adr, 0, TypeRawPtr::BOTTOM, T_ADDRESS);\n","filename":"src\/hotspot\/share\/gc\/shared\/c2\/barrierSetC2.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -229,1 +229,1 @@\n-  AddPNode( Node *base, Node *ptr, Node *off ) : Node(nullptr,base,ptr,off) {\n+  AddPNode(Node *base, Node *ptr, Node *off) : Node(nullptr,base,ptr,off) {\n@@ -231,0 +231,3 @@\n+    assert((ptr->bottom_type() == Type::TOP) ||\n+      ((base == Compile::current()->top()) == (ptr->bottom_type()->make_ptr()->isa_oopptr() == nullptr)),\n+      \"base input only needed for heap addresses\");\n","filename":"src\/hotspot\/share\/opto\/addnode.hpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -1731,1 +1731,1 @@\n-Node *AllocateNode::make_ideal_mark(PhaseGVN *phase, Node* obj, Node* control, Node* mem) {\n+Node *AllocateNode::make_ideal_mark(PhaseGVN* phase, Node* control, Node* mem) {\n@@ -1735,1 +1735,1 @@\n-    Node* proto_adr = phase->transform(new AddPNode(klass_node, klass_node, phase->MakeConX(in_bytes(Klass::prototype_header_offset()))));\n+    Node* proto_adr = phase->transform(new AddPNode(phase->C->top(), klass_node, phase->MakeConX(in_bytes(Klass::prototype_header_offset()))));\n","filename":"src\/hotspot\/share\/opto\/callnode.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1103,1 +1103,1 @@\n-  Node* make_ideal_mark(PhaseGVN *phase, Node* obj, Node* control, Node* mem);\n+  Node* make_ideal_mark(PhaseGVN* phase, Node* control, Node* mem);\n","filename":"src\/hotspot\/share\/opto\/callnode.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -3744,1 +3744,1 @@\n-  \/\/ case #6. Constant Pool, ThreadLocal, CastX2P or\n+  \/\/ case #6. Constant Pool, ThreadLocal, CastX2P, Klass, OSR buffer buf or\n@@ -3746,1 +3746,1 @@\n-  \/\/      {ConP, ThreadLocal, CastX2P, raw Load}\n+  \/\/      {ConP, ThreadLocal, CastX2P, raw Load, Parm0}\n@@ -3788,0 +3788,1 @@\n+             (_igvn->C->is_osr_compilation() && uncast_base->is_Parm() && uncast_base->as_Parm()->_con == TypeFunc::Parms)||\n@@ -3789,0 +3790,1 @@\n+             (uncast_base->is_Mem() && (uncast_base->bottom_type()->isa_klassptr() != nullptr)) ||\n@@ -4383,1 +4385,0 @@\n-  uint unique_old = _compile->unique();\n","filename":"src\/hotspot\/share\/opto\/escape.cpp","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2737,1 +2737,1 @@\n-  Node *p1 = gvn.transform(new AddPNode(superklass, superklass, gvn.MakeConX(in_bytes(Klass::super_check_offset_offset()))));\n+  Node *p1 = gvn.transform(new AddPNode(C->top(), superklass, gvn.MakeConX(in_bytes(Klass::super_check_offset_offset()))));\n@@ -2755,1 +2755,1 @@\n-  Node *p2 = gvn.transform(new AddPNode(subklass,subklass,chk_off_X));\n+  Node* p2 = gvn.transform(new AddPNode(C->top(), subklass, chk_off_X));\n@@ -3590,1 +3590,1 @@\n-  Node* lhp = basic_plus_adr(klass_node, klass_node, in_bytes(Klass::layout_helper_offset()));\n+  Node* lhp = basic_plus_adr(top(), klass_node, in_bytes(Klass::layout_helper_offset()));\n","filename":"src\/hotspot\/share\/opto\/graphKit.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -3016,1 +3016,1 @@\n-    Node* insp = basic_plus_adr(kls, in_bytes(InstanceKlass::init_state_offset()));\n+    Node* insp = basic_plus_adr(top(), kls, in_bytes(InstanceKlass::init_state_offset()));\n@@ -3064,1 +3064,1 @@\n-  Node* jt_addr = basic_plus_adr(thread, in_bytes(JavaThread::is_in_vthread_transition_offset()));\n+  Node* jt_addr = basic_plus_adr(top(), thread, in_bytes(JavaThread::is_in_vthread_transition_offset()));\n@@ -3105,1 +3105,1 @@\n-    Node* jt_addr = basic_plus_adr(thread, in_bytes(JavaThread::is_in_vthread_transition_offset()));\n+    Node* jt_addr = basic_plus_adr(top(), thread, in_bytes(JavaThread::is_in_vthread_transition_offset()));\n@@ -3131,1 +3131,1 @@\n-    Node* addr = basic_plus_adr(thread, in_bytes(JavaThread::is_disable_suspend_offset()));\n+    Node* addr = basic_plus_adr(top(), thread, in_bytes(JavaThread::is_disable_suspend_offset()));\n@@ -3705,1 +3705,1 @@\n-  Node* vthread_offset = basic_plus_adr(jt, in_bytes(THREAD_LOCAL_OFFSET_JFR + VTHREAD_OFFSET_JFR));\n+  Node* vthread_offset = basic_plus_adr(top(), jt, in_bytes(THREAD_LOCAL_OFFSET_JFR + VTHREAD_OFFSET_JFR));\n@@ -3730,1 +3730,1 @@\n-  Node* thread_id_offset = basic_plus_adr(jt, in_bytes(THREAD_LOCAL_OFFSET_JFR + VTHREAD_ID_OFFSET_JFR));\n+  Node* thread_id_offset = basic_plus_adr(top(), jt, in_bytes(THREAD_LOCAL_OFFSET_JFR + VTHREAD_ID_OFFSET_JFR));\n@@ -3752,1 +3752,1 @@\n-  Node* vthread_epoch_offset = basic_plus_adr(jt, in_bytes(THREAD_LOCAL_OFFSET_JFR + VTHREAD_EPOCH_OFFSET_JFR));\n+  Node* vthread_epoch_offset = basic_plus_adr(top(), jt, in_bytes(THREAD_LOCAL_OFFSET_JFR + VTHREAD_EPOCH_OFFSET_JFR));\n@@ -3775,1 +3775,1 @@\n-  Node* thread_local_excluded_offset = basic_plus_adr(jt, in_bytes(THREAD_LOCAL_OFFSET_JFR + VTHREAD_EXCLUDED_OFFSET_JFR));\n+  Node* thread_local_excluded_offset = basic_plus_adr(top(), jt, in_bytes(THREAD_LOCAL_OFFSET_JFR + VTHREAD_EXCLUDED_OFFSET_JFR));\n@@ -3830,1 +3830,1 @@\n-  Node* monitor_owner_id_offset = basic_plus_adr(thread, in_bytes(JavaThread::monitor_owner_id_offset()));\n+  Node* monitor_owner_id_offset = basic_plus_adr(top(), thread, in_bytes(JavaThread::monitor_owner_id_offset()));\n@@ -3972,1 +3972,1 @@\n-  Node* p = basic_plus_adr(klass, in_bytes(Klass::java_mirror_offset()));\n+  Node* p = basic_plus_adr(top(), klass, in_bytes(Klass::java_mirror_offset()));\n@@ -4012,1 +4012,1 @@\n-  Node* modp = basic_plus_adr(kls, in_bytes(offset));\n+  Node* modp = basic_plus_adr(top(), kls, in_bytes(offset));\n@@ -4146,1 +4146,1 @@\n-    p = basic_plus_adr(kls, in_bytes(Klass::super_offset()));\n+    p = basic_plus_adr(top(), kls, in_bytes(Klass::super_offset()));\n@@ -4684,1 +4684,1 @@\n-  Node* entry_addr  = basic_plus_adr(obj_klass, entry_offset);\n+  Node* entry_addr  = basic_plus_adr(top(), obj_klass, entry_offset);\n","filename":"src\/hotspot\/share\/opto\/library_call.cpp","additions":13,"deletions":13,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -1201,2 +1201,2 @@\n-Node* PhaseMacroExpand::make_load(Node* ctl, Node* mem, Node* base, int offset, const Type* value_type, BasicType bt) {\n-  Node* adr = basic_plus_adr(base, offset);\n+Node* PhaseMacroExpand::make_load_raw(Node* ctl, Node* mem, Node* base, int offset, const Type* value_type, BasicType bt) {\n+  Node* adr = basic_plus_adr(top(), base, offset);\n@@ -1210,2 +1210,2 @@\n-Node* PhaseMacroExpand::make_store(Node* ctl, Node* mem, Node* base, int offset, Node* value, BasicType bt) {\n-  Node* adr = basic_plus_adr(base, offset);\n+Node* PhaseMacroExpand::make_store_raw(Node* ctl, Node* mem, Node* base, int offset, Node* value, BasicType bt) {\n+  Node* adr = basic_plus_adr(top(), base, offset);\n@@ -1756,1 +1756,1 @@\n-  Node* mark_node = alloc->make_ideal_mark(&_igvn, object, control, rawmem);\n+  Node* mark_node = alloc->make_ideal_mark(&_igvn, control, rawmem);\n@@ -1760,1 +1760,1 @@\n-  rawmem = make_store(control, rawmem, object, oopDesc::mark_offset_in_bytes(), mark_node, TypeX_X->basic_type());\n+  rawmem = make_store_raw(control, rawmem, object, oopDesc::mark_offset_in_bytes(), mark_node, TypeX_X->basic_type());\n@@ -1763,1 +1763,1 @@\n-    rawmem = make_store(control, rawmem, object, oopDesc::klass_offset_in_bytes(), klass_node, T_METADATA);\n+    rawmem = make_store_raw(control, rawmem, object, oopDesc::klass_offset_in_bytes(), klass_node, T_METADATA);\n@@ -1769,1 +1769,1 @@\n-    rawmem = make_store(control, rawmem, object, arrayOopDesc::length_offset_in_bytes(), length, T_INT);\n+    rawmem = make_store_raw(control, rawmem, object, arrayOopDesc::length_offset_in_bytes(), length, T_INT);\n@@ -1795,0 +1795,1 @@\n+                                            true,\n@@ -1949,1 +1950,1 @@\n-        prefetch_adr = new AddPNode( old_eden_top, new_eden_top,\n+        prefetch_adr = new AddPNode( top(), new_eden_top,\n","filename":"src\/hotspot\/share\/opto\/macro.cpp","additions":10,"deletions":9,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -61,4 +61,4 @@\n-  Node* make_load( Node* ctl, Node* mem, Node* base, int offset,\n-                   const Type* value_type, BasicType bt);\n-  Node* make_store(Node* ctl, Node* mem, Node* base, int offset,\n-                   Node* value, BasicType bt);\n+  Node* make_load_raw(Node* ctl, Node* mem, Node* base, int offset,\n+                      const Type* value_type, BasicType bt);\n+  Node* make_store_raw(Node* ctl, Node* mem, Node* base, int offset,\n+                       Node* value, BasicType bt);\n@@ -147,1 +147,1 @@\n-  bool generate_block_arraycopy(Node** ctrl, MergeMemNode** mem, Node* io,\n+  bool generate_block_arraycopy(Node** ctrl, MergeMemNode** mem,\n@@ -150,2 +150,1 @@\n-                                AllocateNode* alloc,\n-                                Node* src,  Node* src_offset,\n+                                Node* src, Node* src_offset,\n","filename":"src\/hotspot\/share\/opto\/macro.hpp","additions":6,"deletions":7,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -387,1 +387,0 @@\n-  Node* original_dest = dest;\n@@ -427,1 +426,0 @@\n-    \/\/original_dest        = dest;\n@@ -560,4 +558,3 @@\n-        didit = generate_block_arraycopy(&local_ctrl, &local_mem, local_io,\n-                                         adr_type, basic_elem_type, alloc,\n-                                         src, src_offset, dest, dest_offset,\n-                                         dest_size, acopy_to_uninitialized);\n+        didit = generate_block_arraycopy(&local_ctrl, &local_mem, adr_type,\n+                                         basic_elem_type, src, src_offset,\n+                                         dest, dest_offset, dest_size, acopy_to_uninitialized);\n@@ -644,1 +641,1 @@\n-        Node* p1 = basic_plus_adr(dest_klass, ek_offset);\n+        Node* p1 = basic_plus_adr(top(), dest_klass, ek_offset);\n@@ -921,1 +918,1 @@\n-                                       start_con, end_con, &_igvn);\n+                                       start_con, end_con, false, &_igvn);\n@@ -926,1 +923,1 @@\n-                                       start_con, end, &_igvn);\n+                                       start_con, end, false, &_igvn);\n@@ -939,1 +936,1 @@\n-                                       start_con, end, &_igvn);\n+                                       start_con, end, false, &_igvn);\n@@ -973,1 +970,1 @@\n-                                       start, end, &_igvn);\n+                                       start, end, false, &_igvn);\n@@ -984,1 +981,1 @@\n-bool PhaseMacroExpand::generate_block_arraycopy(Node** ctrl, MergeMemNode** mem, Node* io,\n+bool PhaseMacroExpand::generate_block_arraycopy(Node** ctrl, MergeMemNode** mem,\n@@ -987,2 +984,1 @@\n-                                                AllocateNode* alloc,\n-                                                Node* src,  Node* src_offset,\n+                                                Node* src, Node* src_offset,\n@@ -1136,1 +1132,1 @@\n-  Node* p3 = basic_plus_adr(dest_elem_klass, sco_offset);\n+  Node* p3 = basic_plus_adr(top(), dest_elem_klass, sco_offset);\n","filename":"src\/hotspot\/share\/opto\/macroArrayCopy.cpp","additions":11,"deletions":15,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -2566,1 +2566,7 @@\n-            return adr2->in(AddPNode::Base);\n+#ifdef ASSERT\n+            const TypeKlassPtr* tkls2 = phase->type(adr2->in(AddPNode::Address))->is_klassptr();\n+            assert(tkls2->offset() == 0, \"not a load of java_mirror\");\n+#endif\n+            assert(adr2->in(AddPNode::Base)->is_top(), \"not an off heap load\");\n+            assert(adr2->in(AddPNode::Offset)->find_intptr_t_con(-1) == in_bytes(Klass::java_mirror_offset()), \"incorrect offset\");\n+            return adr2->in(AddPNode::Address);\n@@ -4110,0 +4116,9 @@\n+Node* ClearArrayNode::make_address(Node* dest, Node* offset, bool raw_base, PhaseGVN* phase) {\n+  Node* base = dest;\n+  if (raw_base) {\n+    \/\/ May be called as part of the initialization of a just allocated object\n+    base = phase->C->top();\n+  }\n+  return phase->transform(new AddPNode(base, dest, offset));\n+}\n+\n@@ -4115,0 +4130,1 @@\n+                                   bool raw_base,\n@@ -4120,2 +4136,1 @@\n-    Node* adr = new AddPNode(dest, dest, phase->MakeConX(offset));\n-    adr = phase->transform(adr);\n+    Node* adr = make_address(dest, phase->MakeConX(offset), raw_base, phase);\n@@ -4130,1 +4145,1 @@\n-  return clear_memory(ctl, mem, dest, phase->MakeConX(offset), end_offset, phase);\n+  return clear_memory(ctl, mem, dest, phase->MakeConX(offset), end_offset, raw_base, phase);\n@@ -4136,0 +4151,1 @@\n+                                   bool raw_base,\n@@ -4155,1 +4171,1 @@\n-  Node* adr = phase->transform(new AddPNode(dest, dest, start_offset) );\n+  Node* adr = make_address(dest, start_offset, raw_base, phase);\n@@ -4163,0 +4179,1 @@\n+                                   bool raw_base,\n@@ -4176,1 +4193,1 @@\n-                       start_offset, phase->MakeConX(done_offset), phase);\n+                       start_offset, phase->MakeConX(done_offset), raw_base, phase);\n@@ -4179,2 +4196,1 @@\n-    Node* adr = new AddPNode(dest, dest, phase->MakeConX(done_offset));\n-    adr = phase->transform(adr);\n+    Node* adr = make_address(dest, phase->MakeConX(done_offset), raw_base, phase);\n@@ -5387,0 +5403,1 @@\n+                                              true,\n@@ -5445,1 +5462,1 @@\n-                                            zeroes_done, size_in_bytes, phase);\n+                                            zeroes_done, size_in_bytes, true, phase);\n","filename":"src\/hotspot\/share\/opto\/memnode.cpp","additions":26,"deletions":9,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -1078,0 +1078,1 @@\n+  static Node* make_address(Node* dest, Node* offset, bool raw_base, PhaseGVN* phase);\n@@ -1105,0 +1106,1 @@\n+                            bool raw_base,\n@@ -1109,0 +1111,1 @@\n+                            bool raw_base,\n@@ -1113,0 +1116,1 @@\n+                            bool raw_base,\n","filename":"src\/hotspot\/share\/opto\/memnode.hpp","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -445,1 +445,1 @@\n-  Node *fetch_interpreter_state(int index, BasicType bt, Node *local_addrs, Node *local_addrs_base);\n+  Node *fetch_interpreter_state(int index, BasicType bt, Node* local_addrs);\n","filename":"src\/hotspot\/share\/opto\/parse.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -106,2 +106,1 @@\n-                                     Node *local_addrs,\n-                                     Node *local_addrs_base) {\n+                                     Node* local_addrs) {\n@@ -109,1 +108,1 @@\n-  Node *adr = basic_plus_adr( local_addrs_base, local_addrs, -index*wordSize );\n+  Node *adr = basic_plus_adr(top(), local_addrs, -index*wordSize);\n@@ -124,1 +123,1 @@\n-    adr = basic_plus_adr(local_addrs_base, local_addrs, -(index+1)*wordSize);\n+    adr = basic_plus_adr(top(), local_addrs, -(index+1)*wordSize);\n@@ -223,1 +222,1 @@\n-  Node *monitors_addr = basic_plus_adr(osr_buf, osr_buf, (max_locals+mcnt*2-1)*wordSize);\n+  Node *monitors_addr = basic_plus_adr(top(), osr_buf, (max_locals+mcnt*2-1)*wordSize);\n@@ -244,1 +243,1 @@\n-    Node *lock_object = fetch_interpreter_state(index*2, T_OBJECT, monitors_addr, osr_buf);\n+    Node *lock_object = fetch_interpreter_state(index*2, T_OBJECT, monitors_addr);\n@@ -246,1 +245,1 @@\n-    Node *displaced_hdr = fetch_interpreter_state((index*2) + 1, T_ADDRESS, monitors_addr, osr_buf);\n+    Node *displaced_hdr = fetch_interpreter_state((index*2) + 1, T_ADDRESS, monitors_addr);\n@@ -274,1 +273,1 @@\n-  Node *locals_addr = basic_plus_adr(osr_buf, osr_buf, (max_locals-1)*wordSize);\n+  Node *locals_addr = basic_plus_adr(top(), osr_buf, (max_locals-1)*wordSize);\n@@ -321,1 +320,1 @@\n-    Node *value = fetch_interpreter_state(index, bt, locals_addr, osr_buf);\n+    Node *value = fetch_interpreter_state(index, bt, locals_addr);\n@@ -2132,1 +2131,1 @@\n-  Node* access_flags_addr = basic_plus_adr(klass, klass, in_bytes(Klass::misc_flags_offset()));\n+  Node* access_flags_addr = basic_plus_adr(top(), klass, in_bytes(Klass::misc_flags_offset()));\n","filename":"src\/hotspot\/share\/opto\/parse1.cpp","additions":9,"deletions":10,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -223,1 +223,1 @@\n-  Node* p2 = basic_plus_adr(array_klass, array_klass, element_klass_offset);\n+  Node* p2 = basic_plus_adr(top(), array_klass, element_klass_offset);\n","filename":"src\/hotspot\/share\/opto\/parseHelper.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -185,1 +185,1 @@\n-        Node* p1 = phase->transform(new AddPNode(superklass, superklass, phase->MakeConX(in_bytes(Klass::super_check_offset_offset()))));\n+        Node* p1 = phase->transform(new AddPNode(C->top(), superklass, phase->MakeConX(in_bytes(Klass::super_check_offset_offset()))));\n@@ -197,1 +197,1 @@\n-          Node* p2 = phase->transform(new AddPNode(subklass, subklass, chk_off_X));\n+          Node* p2 = phase->transform(new AddPNode(C->top(), subklass, chk_off_X));\n","filename":"src\/hotspot\/share\/opto\/subtypenode.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}