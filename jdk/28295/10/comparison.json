{"files":[{"patch":"@@ -805,1 +805,1 @@\n-  _iterGVN = true;\n+  _phase = PhaseValuesType::iter_gvn;\n@@ -814,1 +814,1 @@\n-  _iterGVN = true;\n+  _phase = PhaseValuesType::iter_gvn;\n@@ -1083,1 +1083,0 @@\n-    bool failure = false;\n@@ -1088,5 +1087,18 @@\n-      if (is_verify_Value())    { failure |= verify_Value_for(n); }\n-      if (is_verify_Ideal())    { failure |= verify_Ideal_for(n, false); }\n-      if (is_verify_Ideal())    { failure |= verify_Ideal_for(n, true); }\n-      if (is_verify_Identity()) { failure |= verify_Identity_for(n); }\n-      if (is_verify_invariants()) { failure |= verify_node_invariants_for(n); }\n+      \/\/ If we get an assert here, check why the reported node was not processed again in IGVN.\n+      \/\/ We should either make sure that this node is properly added back to the IGVN worklist\n+      \/\/ in PhaseIterGVN::add_users_to_worklist to update it again or add an exception\n+      \/\/ in the verification methods below if that is not possible for some reason (like Load nodes).\n+      if (is_verify_Value()) {\n+        verify_Value_for(n);\n+      }\n+      if (is_verify_Ideal()) {\n+        verify_Ideal_for(n, false);\n+        verify_Ideal_for(n, true);\n+      }\n+      if (is_verify_Identity()) {\n+        verify_Identity_for(n);\n+      }\n+      if (is_verify_invariants()) {\n+        verify_node_invariants_for(n);\n+      }\n+\n@@ -1103,5 +1115,0 @@\n-    \/\/ If we get this assert, check why the reported nodes were not processed again in IGVN.\n-    \/\/ We should either make sure that these nodes are properly added back to the IGVN worklist\n-    \/\/ in PhaseIterGVN::add_users_to_worklist to update them again or add an exception\n-    \/\/ in the verification code above if that is not possible for some reason (like Load nodes).\n-    assert(!failure, \"Missed optimization opportunity\/broken graph in PhaseIterGVN\");\n@@ -1132,1 +1139,1 @@\n-\/\/ Check that type(n) == n->Value(), return true if we have a failure.\n+\/\/ Check that type(n) == n->Value(), asserts if we have a failure.\n@@ -1137,1 +1144,1 @@\n-bool PhaseIterGVN::verify_Value_for(Node* n, bool strict) {\n+void PhaseIterGVN::verify_Value_for(const Node* n, bool strict) {\n@@ -1143,1 +1150,1 @@\n-    return false;\n+    return;\n@@ -1152,1 +1159,1 @@\n-      return false; \/\/ ignore integer widen\n+      return; \/\/ ignore integer widen\n@@ -1161,1 +1168,1 @@\n-    return false;\n+    return;\n@@ -1180,1 +1187,1 @@\n-    return false;\n+    return;\n@@ -1194,1 +1201,8 @@\n-  return true;\n+\n+  if (_phase == PhaseValuesType::iter_gvn) {\n+    assert(false, \"Missed Value optimization opportunity in PhaseIterGVN for %s\", n->Name());\n+  } else if (_phase == PhaseValuesType::ccp) {\n+    assert(false, \"PhaseCCP not at fixpoint: analysis result may be unsound for %s\", n->Name());\n+  } else {\n+    assert(false, \"Unexpected phase identifier\");\n+  }\n@@ -1198,3 +1212,3 @@\n-\/\/ Returns true if it found missed optimization opportunities and\n-\/\/         false otherwise (no missed optimization, or skipped verification).\n-bool PhaseIterGVN::verify_Ideal_for(Node* n, bool can_reshape) {\n+\/\/ Asserts if it found missed optimization opportunities or encountered unexpected changes, and\n+\/\/         returns normally otherwise (no missed optimization, or skipped verification).\n+void PhaseIterGVN::verify_Ideal_for(Node* n, bool can_reshape) {\n@@ -1214,1 +1228,1 @@\n-      return false;\n+      return;\n@@ -1225,1 +1239,1 @@\n-      return false;\n+      return;\n@@ -1235,1 +1249,1 @@\n-      return false;\n+      return;\n@@ -1244,1 +1258,1 @@\n-      return false;\n+      return;\n@@ -1263,1 +1277,1 @@\n-      return false;\n+      return;\n@@ -1342,1 +1356,1 @@\n-      return false;\n+      return;\n@@ -1366,1 +1380,1 @@\n-      return false;\n+      return;\n@@ -1398,1 +1412,1 @@\n-      return false;\n+      return;\n@@ -1410,1 +1424,1 @@\n-      return false;\n+      return;\n@@ -1439,1 +1453,1 @@\n-      return false;\n+      return;\n@@ -1464,1 +1478,1 @@\n-      return false;\n+      return;\n@@ -1484,1 +1498,1 @@\n-      return false;\n+      return;\n@@ -1507,1 +1521,1 @@\n-      return false;\n+      return;\n@@ -1520,1 +1534,1 @@\n-      return false;\n+      return;\n@@ -1536,1 +1550,1 @@\n-      return false;\n+      return;\n@@ -1550,1 +1564,1 @@\n-      return false;\n+      return;\n@@ -1576,1 +1590,1 @@\n-      return false;\n+      return;\n@@ -1588,1 +1602,1 @@\n-      return false;\n+      return;\n@@ -1596,1 +1610,1 @@\n-      return false;\n+      return;\n@@ -1611,1 +1625,1 @@\n-      return false;\n+      return;\n@@ -1625,1 +1639,1 @@\n-      return false;\n+      return;\n@@ -1634,1 +1648,1 @@\n-      return false;\n+      return;\n@@ -1644,1 +1658,1 @@\n-      return false;\n+      return;\n@@ -1657,1 +1671,1 @@\n-      return false;\n+      return;\n@@ -1662,1 +1676,1 @@\n-      return false;\n+      return;\n@@ -1668,1 +1682,1 @@\n-      return false;\n+      return;\n@@ -1677,1 +1691,1 @@\n-      return false;\n+      return;\n@@ -1686,1 +1700,1 @@\n-      return false;\n+      return;\n@@ -1691,1 +1705,1 @@\n-      return false;\n+      return;\n@@ -1696,1 +1710,1 @@\n-      return false;\n+      return;\n@@ -1701,1 +1715,1 @@\n-      return false;\n+      return;\n@@ -1712,1 +1726,1 @@\n-      return false;\n+      return;\n@@ -1719,1 +1733,1 @@\n-      return false;\n+      return;\n@@ -1735,1 +1749,1 @@\n-    return false;\n+    return;\n@@ -1749,1 +1763,1 @@\n-    return false;\n+    return;\n@@ -1768,1 +1782,1 @@\n-    return false;\n+    return;\n@@ -1787,1 +1801,1 @@\n-    return false;\n+    return;\n@@ -1819,1 +1833,1 @@\n-    return false;\n+    return;\n@@ -1826,0 +1840,6 @@\n+  \/\/ Remove 'n' from hash table in case it gets modified. We want to avoid\n+  \/\/ hitting the \"Need to remove from hash before changing edges\" assert if\n+  \/\/ a change occurs. Instead, we would like to proceed with the optimization,\n+  \/\/ return and finally hit the assert in PhaseIterGVN::verify_optimize to get\n+  \/\/ a more meaningful message\n+  _table.hash_delete(n);\n@@ -1836,1 +1856,1 @@\n-      return true;\n+      assert(false, \"Unexpected new unused nodes from applying Ideal optimization on %s\", n->Name());\n@@ -1846,1 +1866,1 @@\n-      return true;\n+      assert(false, \"Unexpected hash change from applying Ideal optimization on %s\", n->Name());\n@@ -1852,1 +1872,2 @@\n-    return false;\n+    hash_find_insert(n);\n+    return;\n@@ -1869,1 +1890,2 @@\n-  return true;\n+\n+  assert(false, \"Missed Ideal optimization opportunity in PhaseIterGVN for %s\", n->Name());\n@@ -1873,3 +1895,3 @@\n-\/\/ Returns true if it found missed optimization opportunities and\n-\/\/         false otherwise (no missed optimization, or skipped verification).\n-bool PhaseIterGVN::verify_Identity_for(Node* n) {\n+\/\/ Asserts if it found missed optimization opportunities, and\n+\/\/         returns normally otherwise (no missed optimization, or skipped verification).\n+void PhaseIterGVN::verify_Identity_for(Node* n) {\n@@ -1894,1 +1916,1 @@\n-      return false;\n+      return;\n@@ -1905,1 +1927,1 @@\n-      return false;\n+      return;\n@@ -1919,1 +1941,1 @@\n-      return false;\n+      return;\n@@ -1929,1 +1951,1 @@\n-      return false;\n+      return;\n@@ -1947,1 +1969,1 @@\n-      return false;\n+      return;\n@@ -1961,1 +1983,1 @@\n-      return false;\n+      return;\n@@ -1972,1 +1994,1 @@\n-      return false;\n+      return;\n@@ -1992,1 +2014,1 @@\n-      return false;\n+      return;\n@@ -2006,1 +2028,1 @@\n-      return false;\n+      return;\n@@ -2011,1 +2033,1 @@\n-      return false;\n+      return;\n@@ -2025,1 +2047,1 @@\n-    return false;\n+    return;\n@@ -2036,1 +2058,1 @@\n-    return false;\n+    return;\n@@ -2042,1 +2064,1 @@\n-    return false;\n+    return;\n@@ -2049,1 +2071,1 @@\n-    return false;\n+    return;\n@@ -2061,1 +2083,2 @@\n-  return true;\n+\n+  assert(false, \"Missed Identity optimization opportunity in PhaseIterGVN for %s\", n->Name());\n@@ -2065,1 +2088,1 @@\n-bool PhaseIterGVN::verify_node_invariants_for(const Node* n) {\n+void PhaseIterGVN::verify_node_invariants_for(const Node* n) {\n@@ -2073,1 +2096,2 @@\n-      return true;\n+\n+      assert(false, \"Broken node invariant for %s\", n->Name());\n@@ -2076,1 +2100,0 @@\n-  return false;\n@@ -2778,0 +2801,1 @@\n+  _phase = PhaseValuesType::ccp;\n@@ -2898,1 +2922,0 @@\n-  bool failure = false;\n@@ -2901,8 +2924,10 @@\n-    failure |= verify_Value_for(n, \/* strict = *\/ true);\n-  }\n-  \/\/ If we get this assert, check why the reported nodes were not processed again in CCP.\n-  \/\/ We should either make sure that these nodes are properly added back to the CCP worklist\n-  \/\/ in PhaseCCP::push_child_nodes_to_worklist() to update their type in the same round,\n-  \/\/ or that they are added in PhaseCCP::needs_revisit() so that analysis revisits\n-  \/\/ them at the end of the round.\n-  assert(!failure, \"PhaseCCP not at fixpoint: analysis result may be unsound.\");\n+\n+    \/\/ An assert in verify_Value_for means that PhaseCCP is not at fixpoint\n+    \/\/ and that the analysis result may be unsound.\n+    \/\/ If this happens, check why the reported nodes were not processed again in CCP.\n+    \/\/ We should either make sure that these nodes are properly added back to the CCP worklist\n+    \/\/ in PhaseCCP::push_child_nodes_to_worklist() to update their type in the same round,\n+    \/\/ or that they are added in PhaseCCP::needs_revisit() so that analysis revisits\n+    \/\/ them at the end of the round.\n+    verify_Value_for(n, true);\n+  }\n","filename":"src\/hotspot\/share\/opto\/phaseX.cpp","additions":120,"deletions":95,"binary":false,"changes":215,"status":"modified"},{"patch":"@@ -227,1 +227,7 @@\n-  bool      _iterGVN;\n+  enum class PhaseValuesType {\n+    gvn,\n+    iter_gvn,\n+    ccp\n+  };\n+\n+  PhaseValuesType _phase;\n@@ -250,1 +256,1 @@\n-  PhaseValues() : PhaseTransform(GVN), _iterGVN(false),\n+  PhaseValues() : PhaseTransform(GVN), _phase(PhaseValuesType::gvn),\n@@ -259,1 +265,1 @@\n-  PhaseIterGVN* is_IterGVN() { return (_iterGVN) ? (PhaseIterGVN*)this : nullptr; }\n+  PhaseIterGVN* is_IterGVN() { return (_phase >= PhaseValuesType::iter_gvn) ? (PhaseIterGVN*)this : nullptr; }\n@@ -493,4 +499,4 @@\n-  bool verify_Value_for(Node* n, bool strict = false);\n-  bool verify_Ideal_for(Node* n, bool can_reshape);\n-  bool verify_Identity_for(Node* n);\n-  bool verify_node_invariants_for(const Node* n);\n+  void verify_Value_for(const Node* n, bool strict = false);\n+  void verify_Ideal_for(Node* n, bool can_reshape);\n+  void verify_Identity_for(Node* n);\n+  void verify_node_invariants_for(const Node* n);\n","filename":"src\/hotspot\/share\/opto\/phaseX.hpp","additions":13,"deletions":7,"binary":false,"changes":20,"status":"modified"}]}