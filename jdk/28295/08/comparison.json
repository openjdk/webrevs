{"files":[{"patch":"@@ -1083,1 +1083,0 @@\n-    bool failure = false;\n@@ -1088,5 +1087,18 @@\n-      if (is_verify_Value())    { failure |= verify_Value_for(n); }\n-      if (is_verify_Ideal())    { failure |= verify_Ideal_for(n, false); }\n-      if (is_verify_Ideal())    { failure |= verify_Ideal_for(n, true); }\n-      if (is_verify_Identity()) { failure |= verify_Identity_for(n); }\n-      if (is_verify_invariants()) { failure |= verify_node_invariants_for(n); }\n+      \/\/ If we get an assert here, check why the reported node was not processed again in IGVN.\n+      \/\/ We should either make sure that this node is properly added back to the IGVN worklist\n+      \/\/ in PhaseIterGVN::add_users_to_worklist to update it again or add an exception\n+      \/\/ in the verification methods below if that is not possible for some reason (like Load nodes).\n+      if (is_verify_Value()) {\n+        verify_Value_for(n, \"PhaseIterGVN\");\n+      }\n+      if (is_verify_Ideal()) {\n+        verify_Ideal_for(n, false);\n+        verify_Ideal_for(n, true);\n+      }\n+      if (is_verify_Identity()) {\n+        verify_Identity_for(n);\n+      }\n+      if (is_verify_invariants()) {\n+        verify_node_invariants_for(n);\n+      }\n+\n@@ -1103,5 +1115,0 @@\n-    \/\/ If we get this assert, check why the reported nodes were not processed again in IGVN.\n-    \/\/ We should either make sure that these nodes are properly added back to the IGVN worklist\n-    \/\/ in PhaseIterGVN::add_users_to_worklist to update them again or add an exception\n-    \/\/ in the verification code above if that is not possible for some reason (like Load nodes).\n-    assert(!failure, \"Missed optimization opportunity\/broken graph in PhaseIterGVN\");\n@@ -1132,1 +1139,1 @@\n-\/\/ Check that type(n) == n->Value(), return true if we have a failure.\n+\/\/ Check that type(n) == n->Value(), asserts if we have a failure.\n@@ -1137,1 +1144,1 @@\n-bool PhaseIterGVN::verify_Value_for(Node* n, bool strict) {\n+void PhaseIterGVN::verify_Value_for(const Node* n, const char* phase, bool strict) {\n@@ -1143,1 +1150,1 @@\n-    return false;\n+    return;\n@@ -1152,1 +1159,1 @@\n-      return false; \/\/ ignore integer widen\n+      return; \/\/ ignore integer widen\n@@ -1161,1 +1168,1 @@\n-    return false;\n+    return;\n@@ -1180,1 +1187,1 @@\n-    return false;\n+    return;\n@@ -1194,1 +1201,6 @@\n-  return true;\n+\n+  if (strcmp(phase, \"PhaseIterGVN\") == 0) {\n+    assert(false, \"Missed Value optimization opportunity in PhaseIterGVN for %s\", n->Name());\n+  } else if (strcmp(phase, \"PhaseCCP\") == 0) {\n+    assert(false, \"PhaseCCP not at fixpoint: analysis result may be unsound for %s\", n->Name());\n+  }\n@@ -1198,3 +1210,3 @@\n-\/\/ Returns true if it found missed optimization opportunities and\n-\/\/         false otherwise (no missed optimization, or skipped verification).\n-bool PhaseIterGVN::verify_Ideal_for(Node* n, bool can_reshape) {\n+\/\/ Asserts if it found missed optimization opportunities or encountered unexpected changes, and\n+\/\/         returns normally otherwise (no missed optimization, or skipped verification).\n+void PhaseIterGVN::verify_Ideal_for(Node* n, bool can_reshape) {\n@@ -1214,1 +1226,1 @@\n-      return false;\n+      return;\n@@ -1225,1 +1237,1 @@\n-      return false;\n+      return;\n@@ -1235,1 +1247,1 @@\n-      return false;\n+      return;\n@@ -1244,1 +1256,1 @@\n-      return false;\n+      return;\n@@ -1263,1 +1275,1 @@\n-      return false;\n+      return;\n@@ -1342,1 +1354,1 @@\n-      return false;\n+      return;\n@@ -1366,1 +1378,1 @@\n-      return false;\n+      return;\n@@ -1398,1 +1410,1 @@\n-      return false;\n+      return;\n@@ -1410,1 +1422,1 @@\n-      return false;\n+      return;\n@@ -1439,1 +1451,1 @@\n-      return false;\n+      return;\n@@ -1464,1 +1476,1 @@\n-      return false;\n+      return;\n@@ -1484,1 +1496,1 @@\n-      return false;\n+      return;\n@@ -1507,1 +1519,1 @@\n-      return false;\n+      return;\n@@ -1520,1 +1532,1 @@\n-      return false;\n+      return;\n@@ -1536,1 +1548,1 @@\n-      return false;\n+      return;\n@@ -1550,1 +1562,1 @@\n-      return false;\n+      return;\n@@ -1576,1 +1588,1 @@\n-      return false;\n+      return;\n@@ -1588,1 +1600,1 @@\n-      return false;\n+      return;\n@@ -1596,1 +1608,1 @@\n-      return false;\n+      return;\n@@ -1611,1 +1623,1 @@\n-      return false;\n+      return;\n@@ -1625,1 +1637,1 @@\n-      return false;\n+      return;\n@@ -1634,1 +1646,1 @@\n-      return false;\n+      return;\n@@ -1644,1 +1656,1 @@\n-      return false;\n+      return;\n@@ -1657,1 +1669,1 @@\n-      return false;\n+      return;\n@@ -1662,1 +1674,1 @@\n-      return false;\n+      return;\n@@ -1668,1 +1680,1 @@\n-      return false;\n+      return;\n@@ -1677,1 +1689,1 @@\n-      return false;\n+      return;\n@@ -1686,1 +1698,1 @@\n-      return false;\n+      return;\n@@ -1691,1 +1703,1 @@\n-      return false;\n+      return;\n@@ -1696,1 +1708,1 @@\n-      return false;\n+      return;\n@@ -1701,1 +1713,1 @@\n-      return false;\n+      return;\n@@ -1712,1 +1724,1 @@\n-      return false;\n+      return;\n@@ -1719,1 +1731,1 @@\n-      return false;\n+      return;\n@@ -1735,1 +1747,1 @@\n-    return false;\n+    return;\n@@ -1749,1 +1761,1 @@\n-    return false;\n+    return;\n@@ -1768,1 +1780,1 @@\n-    return false;\n+    return;\n@@ -1787,1 +1799,1 @@\n-    return false;\n+    return;\n@@ -1819,1 +1831,1 @@\n-    return false;\n+    return;\n@@ -1826,0 +1838,6 @@\n+  \/\/ Remove 'n' from hash table in case it gets modified. We want to avoid\n+  \/\/ hitting the \"Need to remove from hash before changing edges\" assert if\n+  \/\/ a change occurs. Instead, we would like to proceed with the optimization,\n+  \/\/ return and finally hit the assert in PhaseIterGVN::verify_optimize to get\n+  \/\/ a more meaningful message\n+  _table.hash_delete(n);\n@@ -1836,1 +1854,1 @@\n-      return true;\n+      assert(false, \"Unexpected new unused nodes from applying Ideal optimization on %s\", n->Name());\n@@ -1846,1 +1864,1 @@\n-      return true;\n+      assert(false, \"Unexpected hash change from applying Ideal optimization on %s\", n->Name());\n@@ -1852,1 +1870,2 @@\n-    return false;\n+    hash_find_insert(n);\n+    return;\n@@ -1869,1 +1888,2 @@\n-  return true;\n+\n+  assert(false, \"Missed Ideal optimization opportunity in PhaseIterGVN for %s\", n->Name());\n@@ -1873,3 +1893,3 @@\n-\/\/ Returns true if it found missed optimization opportunities and\n-\/\/         false otherwise (no missed optimization, or skipped verification).\n-bool PhaseIterGVN::verify_Identity_for(Node* n) {\n+\/\/ Asserts if it found missed optimization opportunities, and\n+\/\/         returns normally otherwise (no missed optimization, or skipped verification).\n+void PhaseIterGVN::verify_Identity_for(Node* n) {\n@@ -1894,1 +1914,1 @@\n-      return false;\n+      return;\n@@ -1905,1 +1925,1 @@\n-      return false;\n+      return;\n@@ -1919,1 +1939,1 @@\n-      return false;\n+      return;\n@@ -1929,1 +1949,1 @@\n-      return false;\n+      return;\n@@ -1947,1 +1967,1 @@\n-      return false;\n+      return;\n@@ -1961,1 +1981,1 @@\n-      return false;\n+      return;\n@@ -1972,1 +1992,1 @@\n-      return false;\n+      return;\n@@ -1992,1 +2012,1 @@\n-      return false;\n+      return;\n@@ -2006,1 +2026,1 @@\n-      return false;\n+      return;\n@@ -2011,1 +2031,1 @@\n-      return false;\n+      return;\n@@ -2025,1 +2045,1 @@\n-    return false;\n+    return;\n@@ -2036,1 +2056,1 @@\n-    return false;\n+    return;\n@@ -2042,1 +2062,1 @@\n-    return false;\n+    return;\n@@ -2049,1 +2069,1 @@\n-    return false;\n+    return;\n@@ -2061,1 +2081,2 @@\n-  return true;\n+\n+  assert(false, \"Missed Identity optimization opportunity in PhaseIterGVN for %s\", n->Name());\n@@ -2065,1 +2086,1 @@\n-bool PhaseIterGVN::verify_node_invariants_for(const Node* n) {\n+void PhaseIterGVN::verify_node_invariants_for(const Node* n) {\n@@ -2073,1 +2094,2 @@\n-      return true;\n+\n+      assert(false, \"Broken node invariant for %s\", n->Name());\n@@ -2076,1 +2098,0 @@\n-  return false;\n@@ -2898,1 +2919,0 @@\n-  bool failure = false;\n@@ -2901,8 +2921,10 @@\n-    failure |= verify_Value_for(n, \/* strict = *\/ true);\n-  }\n-  \/\/ If we get this assert, check why the reported nodes were not processed again in CCP.\n-  \/\/ We should either make sure that these nodes are properly added back to the CCP worklist\n-  \/\/ in PhaseCCP::push_child_nodes_to_worklist() to update their type in the same round,\n-  \/\/ or that they are added in PhaseCCP::needs_revisit() so that analysis revisits\n-  \/\/ them at the end of the round.\n-  assert(!failure, \"PhaseCCP not at fixpoint: analysis result may be unsound.\");\n+\n+    \/\/ An assert in verify_Value_for means that PhaseCCP is not at fixpoint\n+    \/\/ and that the analysis result may be unsound.\n+    \/\/ If this happens, check why the reported nodes were not processed again in CCP.\n+    \/\/ We should either make sure that these nodes are properly added back to the CCP worklist\n+    \/\/ in PhaseCCP::push_child_nodes_to_worklist() to update their type in the same round,\n+    \/\/ or that they are added in PhaseCCP::needs_revisit() so that analysis revisits\n+    \/\/ them at the end of the round.\n+    verify_Value_for(n, \"PhaseCCP\", true);\n+  }\n","filename":"src\/hotspot\/share\/opto\/phaseX.cpp","additions":115,"deletions":93,"binary":false,"changes":208,"status":"modified"},{"patch":"@@ -493,4 +493,4 @@\n-  bool verify_Value_for(Node* n, bool strict = false);\n-  bool verify_Ideal_for(Node* n, bool can_reshape);\n-  bool verify_Identity_for(Node* n);\n-  bool verify_node_invariants_for(const Node* n);\n+  void verify_Value_for(const Node* n, const char* phase, bool strict = false);\n+  void verify_Ideal_for(Node* n, bool can_reshape);\n+  void verify_Identity_for(Node* n);\n+  void verify_node_invariants_for(const Node* n);\n","filename":"src\/hotspot\/share\/opto\/phaseX.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"}]}