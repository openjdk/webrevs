{"files":[{"patch":"@@ -320,1 +320,12 @@\n-#define IOE_FORMAT \"error=%d, %s\"\n+#define IOE_FORMAT \"error=%d, %s%s\"\n+\n+#define SPAWN_HELPER_INTERNAL_ERROR_MSG \"\\n\" \\\n+  \"Possible reasons:\\n\" \\\n+  \"  - Spawn helper ran into JDK version mismatch\\n\" \\\n+  \"  - Spawn helper ran into unexpected internal error\\n\" \\\n+  \"  - Spawn helper was terminated by another process\\n\" \\\n+  \"Possible solutions:\\n\" \\\n+  \"  - Restart JVM, especially after in-place JDK updates\\n\" \\\n+  \"  - Check system logs for JDK-related errors\\n\" \\\n+  \"  - Re-install JDK to fix permission\/versioning problems\\n\" \\\n+  \"  - Switch to legacy launch mechanism with -Djdk.lang.Process.launchMechanism=VFORK\\n\"\n@@ -323,1 +334,1 @@\n-throwIOException(JNIEnv *env, int errnum, const char *defaultDetail)\n+throwIOExceptionImpl(JNIEnv *env, int errnum, const char *defaultDetail, const char *internalErrorDetail)\n@@ -337,1 +348,1 @@\n-    fmtsize = sizeof(IOE_FORMAT) + strlen(detail) + 3 * sizeof(errnum);\n+    fmtsize = sizeof(IOE_FORMAT) + strlen(internalErrorDetail) + strlen(detail) + 3 * sizeof(errnum);\n@@ -342,1 +353,1 @@\n-    snprintf(errmsg, fmtsize, IOE_FORMAT, errnum, detail);\n+    snprintf(errmsg, fmtsize, IOE_FORMAT, errnum, detail, internalErrorDetail);\n@@ -353,0 +364,24 @@\n+\/**\n+ * Throws IOException that signifies an internal error, e.g. spawn helper failure.\n+ *\/\n+static void\n+throwInternalIOException(JNIEnv *env, int errnum, const char *defaultDetail, int mode)\n+{\n+  switch (mode) {\n+    case MODE_POSIX_SPAWN:\n+      throwIOExceptionImpl(env, errnum, defaultDetail, SPAWN_HELPER_INTERNAL_ERROR_MSG);\n+      break;\n+    default:\n+      throwIOExceptionImpl(env, errnum, defaultDetail, \"\");\n+  }\n+}\n+\n+\/**\n+ * Throws IOException that signifies a normal error.\n+ *\/\n+static void\n+throwIOException(JNIEnv *env, int errnum, const char *defaultDetail)\n+{\n+  throwIOExceptionImpl(env, errnum, defaultDetail, \"\");\n+}\n+\n@@ -356,1 +391,1 @@\n-static void throwExitCause(JNIEnv *env, int pid, int status) {\n+static void throwExitCause(JNIEnv *env, int pid, int status, int mode) {\n@@ -371,1 +406,1 @@\n-    throwIOException(env, 0, ebuf);\n+    throwInternalIOException(env, 0, ebuf, mode);\n@@ -694,1 +729,1 @@\n-        throwIOException(env, errno, \"Bad file descriptor\");\n+        throwInternalIOException(env, errno, \"Bad file descriptor\", c->mode);\n@@ -728,1 +763,1 @@\n-            throwIOException(env, errno, \"vfork failed\");\n+            throwInternalIOException(env, errno, \"vfork failed\", c->mode);\n@@ -731,1 +766,1 @@\n-            throwIOException(env, errno, \"fork failed\");\n+            throwInternalIOException(env, errno, \"fork failed\", c->mode);\n@@ -734,1 +769,1 @@\n-            throwIOException(env, errno, \"posix_spawn failed\");\n+            throwInternalIOException(env, errno, \"posix_spawn failed\", c->mode);\n@@ -748,1 +783,1 @@\n-                throwExitCause(env, p, tmpStatus);\n+                throwExitCause(env, p, tmpStatus, c->mode);\n@@ -755,2 +790,3 @@\n-                throwIOException(env, 0, \"Bad code from spawn helper \"\n-                                         \"(Failed to exec spawn helper)\");\n+                throwInternalIOException(env, 0,\n+                                         \"Bad code from spawn helper (Failed to exec spawn helper)\",\n+                                         c->mode);\n@@ -761,1 +797,1 @@\n-            throwIOException(env, errno, \"Read failed\");\n+          throwInternalIOException(env, errno, \"Read failed\", c->mode);\n@@ -773,1 +809,1 @@\n-        throwIOException(env, errno, \"Read failed\");\n+        throwInternalIOException(env, errno, \"Read failed\", c->mode);\n","filename":"src\/java.base\/unix\/native\/libjava\/ProcessImpl_md.c","additions":51,"deletions":15,"binary":false,"changes":66,"status":"modified"},{"patch":"@@ -90,0 +90,1 @@\n+    static final String SPAWNHELPER_FAILURE_MSG = \"(Possible reasons:)\";\n@@ -322,1 +323,3 @@\n-                ! matches(m, PERMISSION_DENIED_ERROR_MSG))\n+                !matches(m, PERMISSION_DENIED_ERROR_MSG))\n+                unexpected(e);\n+            if (matches(m, SPAWNHELPER_FAILURE_MSG))\n@@ -432,1 +435,3 @@\n-                                ! matches(m, NO_SUCH_FILE_ERROR_MSG))\n+                                !matches(m, NO_SUCH_FILE_ERROR_MSG))\n+                                unexpected(e);\n+                            if (matches(m, SPAWNHELPER_FAILURE_MSG))\n@@ -445,1 +450,3 @@\n-                                ! matches(m, NO_SUCH_FILE_ERROR_MSG))\n+                                !matches(m, NO_SUCH_FILE_ERROR_MSG))\n+                                unexpected(e);\n+                            if (matches(m, SPAWNHELPER_FAILURE_MSG))\n@@ -1980,0 +1987,2 @@\n+            if (matches(m, SPAWNHELPER_FAILURE_MSG))\n+                unexpected(e);\n@@ -1997,0 +2006,2 @@\n+                if (matches(m, SPAWNHELPER_FAILURE_MSG))\n+                    unexpected(e);\n@@ -2013,0 +2024,2 @@\n+            if (matches(m, SPAWNHELPER_FAILURE_MSG))\n+                unexpected(e);\n@@ -2071,2 +2084,3 @@\n-                        check(expected.getMessage()\n-                              .matches(\"[Ss]tream [Cc]losed\"));\n+                        String m = expected.getMessage();\n+                        check(m.matches(\"[Ss]tream [Cc]losed\"));\n+                        check(!matches(m, SPAWNHELPER_FAILURE_MSG));\n@@ -2124,1 +2138,2 @@\n-                            if (!ioe.getMessage().equals(\"Stream closed\")) {\n+                            String m = ioe.getMessage();\n+                            if (!m.equals(\"Stream closed\")) {\n@@ -2128,0 +2143,3 @@\n+                            if (matches(m, SPAWNHELPER_FAILURE_MSG)) {\n+                                unexpected(ioe);\n+                            }\n@@ -2181,0 +2199,3 @@\n+                            if (matches(msg, SPAWNHELPER_FAILURE_MSG)) {\n+                                unexpected(e);\n+                            }\n@@ -2273,0 +2294,3 @@\n+            if (matches(m, SPAWNHELPER_FAILURE_MSG)) {\n+                unexpected(e);\n+            }\n","filename":"test\/jdk\/java\/lang\/ProcessBuilder\/Basic.java","additions":30,"deletions":6,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -58,0 +58,1 @@\n+            \/\/ Check that exception contains rich message on failure.\n@@ -59,1 +60,5 @@\n-            System.exit(ERROR);\n+            if (e instanceof IOException && e.getMessage().contains(\"Possible reasons:\")) {\n+                System.exit(ERROR);\n+            } else {\n+                System.exit(ERROR + 3);\n+            }\n","filename":"test\/jdk\/java\/lang\/ProcessBuilder\/JspawnhelperProtocol.java","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"}]}