{"files":[{"patch":"@@ -30,1 +30,4 @@\n- * @run driver DeterministicDump\n+ * @build jdk.test.whitebox.WhiteBox\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller jdk.test.whitebox.WhiteBox\n+ * @run main\/othervm -Xbootclasspath\/a:. -XX:+UnlockDiagnosticVMOptions\n+ *                   -XX:+WhiteBoxAPI DeterministicDump\n@@ -33,0 +36,1 @@\n+import jdk.test.lib.cds.CDSArchiveUtils;\n@@ -36,0 +40,2 @@\n+import java.io.BufferedReader;\n+import java.io.File;\n@@ -37,0 +43,1 @@\n+import java.io.FileReader;\n@@ -41,0 +48,7 @@\n+\n+    static long HEADER_SIZE;      \/\/ Size of header in bytes\n+    static int HEADER_LEN = 106;  \/\/ Number of lines in CDS map file header\n+    static int LINE_OFFSET = 22;  \/\/ Offset from address to first word of data\n+    static int NUM_LINES = 5;     \/\/ Number of lines to be printed\n+    static int WORD_LEN = 16 + 1; \/\/ Length of word in map file\n+\n@@ -63,0 +77,2 @@\n+        File baseArchiveFile = new File(baseArchive + \".jsa\");\n+        HEADER_SIZE = CDSArchiveUtils.fileHeaderSize(baseArchiveFile);\n@@ -90,1 +106,1 @@\n-        return archiveName;\n+        return logName;\n@@ -96,2 +112,2 @@\n-        try (FileInputStream in0 = new FileInputStream(file0);\n-             FileInputStream in1 = new FileInputStream(file1)) {\n+        try (FileInputStream in0 = new FileInputStream(file0 + \".jsa\");\n+             FileInputStream in1 = new FileInputStream(file1 + \".jsa\")) {\n@@ -114,1 +130,4 @@\n-                        throw new RuntimeException(\"File content different at byte #\" + (total + i) + \", b0 = \" + b0 + \", b1 = \" + b1);\n+                        if (total + i > HEADER_SIZE) {\n+                            print_diff(file0 + \".map\", file1 + \".map\", total + i);\n+                            throw new RuntimeException(\"File content different at byte #\" + (total + i) + \", b0 = \" + b0 + \", b1 = \" + b1);\n+                        }\n@@ -134,0 +153,64 @@\n+\n+    \/\/ Read the mapfile and print out the lines associated with the location\n+    static void print_diff(String mapName0, String mapName1, int location) throws Exception {\n+        FileReader f0 = new FileReader(mapName0);\n+        BufferedReader b0 = new BufferedReader(f0);\n+\n+        FileReader f1 = new FileReader(mapName1);\n+        BufferedReader b1 = new BufferedReader(f1);\n+\n+        int line_num = HEADER_LEN;\n+        int word = location \/ 8;\n+        int word_offset = word % 4; \/\/ Each line in the map file prints four words\n+\n+        \/\/ Skip header text and go to first line\n+        for (int i = 0; i < HEADER_LEN; i++) {\n+            b0.readLine();\n+            b1.readLine();\n+        }\n+\n+        String s0 = \"\";\n+        String s1 = \"\";\n+        int count = 0;\n+\n+        \/\/ A line may contain 1-4 words so we iterate by word\n+        do {\n+            s0 = b0.readLine();\n+            s1 = b1.readLine();\n+            line_num++;\n+            \/\/ Skip lines with headers e.g.\n+            \/\/ [rw region          0x0000000800000000 - 0x00000008005a1f88   5906312 bytes]\n+            \/\/ or\n+            \/\/ 0x0000000800000b28: @@ TypeArrayU1       16\n+            if (!s0.contains(\": @@\") && !s0.contains(\"bytes]\")) {\n+                int words = (s0.length() - LINE_OFFSET - 70) \/ 8;\n+                count += words;\n+            }\n+        } while (count < word);\n+\n+        System.out.println(\"[First diff: map file #1 (\" + mapName0 + \")]\");\n+        String diff_f0 = print_diff_helper(b0, word_offset, s0);\n+\n+        System.out.println(\"\\n[First diff: map file #2 (\" + mapName1 + \")]\");\n+        String diff_f1 = print_diff_helper(b1, word_offset, s1);\n+\n+        System.out.printf(\"\\nByte #%d at line #%d word #%d:\\n\", location, line_num, word_offset);\n+        System.out.printf(\"%s: %s\\n%s: %s\\n\", mapName0, diff_f0, mapName1, diff_f1);\n+\n+        f0.close();\n+        f1.close();\n+    }\n+\n+    static String print_diff_helper(BufferedReader b, int word_offset, String line) throws Exception {\n+        \/\/ Extract word from line\n+        int start = LINE_OFFSET + WORD_LEN * word_offset;\n+        int end = start + WORD_LEN;\n+        String diff = line.substring(start, end);\n+\n+        \/\/ Print extra lines\n+        System.out.println(line);\n+        for (int i = 0; i < NUM_LINES; i++) {\n+            System.out.println(b.readLine());\n+        }\n+        return diff;\n+    }\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/DeterministicDump.java","additions":88,"deletions":5,"binary":false,"changes":93,"status":"modified"}]}