{"files":[{"patch":"@@ -2649,0 +2649,4 @@\n+            public byte stringCoder(String str) {\n+                return str.coder();\n+            }\n+\n","filename":"src\/java.base\/share\/classes\/java\/lang\/System.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -122,0 +122,1 @@\n+    private static final int CACHE_THRESHOLD;\n@@ -128,0 +129,3 @@\n+        String cacheThreshold = VM.getSavedProperty(\"java.lang.invoke.StringConcat.cacheThreshold\");\n+        CACHE_THRESHOLD = cacheThreshold != null ? Integer.parseInt(cacheThreshold) : 256;\n+\n@@ -1182,1 +1186,1 @@\n-        private static MethodTypeDesc prependArgs(MethodType concatArgs) {\n+        private static MethodTypeDesc prependArgs(MethodType concatArgs, boolean staticConcat) {\n@@ -1184,1 +1188,2 @@\n-            var paramTypes = new ClassDesc[parameterCount + 4];\n+            int prefixArgs = staticConcat ? 3 : 4;\n+            var paramTypes = new ClassDesc[parameterCount + prefixArgs];\n@@ -1188,1 +1193,4 @@\n-            paramTypes[3] = CD_Array_String; \/\/ constants\n+\n+            if (!staticConcat) {\n+                paramTypes[3] = CD_Array_String; \/\/ constants\n+            }\n@@ -1192,1 +1200,1 @@\n-                paramTypes[i + 4] = needStringOf(cl) ? CD_String : ConstantUtils.classDesc(cl);\n+                paramTypes[i + prefixArgs] = needStringOf(cl) ? CD_String : ConstantUtils.classDesc(cl);\n@@ -1257,9 +1265,14 @@\n-            var weakConstructorHandle = CACHE.get(concatArgs);\n-            if (weakConstructorHandle != null) {\n-                MethodHandlePair handlePair = weakConstructorHandle.get();\n-                if (handlePair != null) {\n-                    try {\n-                        var instance = handlePair.constructor.invokeBasic((Object)constants);\n-                        return handlePair.concatenator.bindTo(instance);\n-                    } catch (Throwable e) {\n-                        throw new StringConcatException(\"Exception while utilizing the hidden class\", e);\n+            boolean forceInline  = concatArgs.parameterCount() <  FORCE_INLINE_THRESHOLD;\n+            boolean staticConcat = concatArgs.parameterCount() >= CACHE_THRESHOLD;\n+\n+            if (!staticConcat) {\n+                var weakConstructorHandle = CACHE.get(concatArgs);\n+                if (weakConstructorHandle != null) {\n+                    MethodHandlePair handlePair = weakConstructorHandle.get();\n+                    if (handlePair != null) {\n+                        try {\n+                            var instance = handlePair.constructor.invokeBasic((Object)constants);\n+                            return handlePair.concatenator.bindTo(instance);\n+                        } catch (Throwable e) {\n+                            throw new StringConcatException(\"Exception while utilizing the hidden class\", e);\n+                        }\n@@ -1269,0 +1282,1 @@\n+\n@@ -1271,1 +1285,1 @@\n-                           prependArgs = prependArgs(concatArgs);\n+                           prependArgs = prependArgs(concatArgs, staticConcat);\n@@ -1275,2 +1289,0 @@\n-                        final boolean forceInline = concatArgs.parameterCount() < FORCE_INLINE_THRESHOLD;\n-\n@@ -1279,4 +1291,10 @@\n-                            clb.withSuperclass(CD_StringConcatBase)\n-                                .withFlags(ACC_FINAL | ACC_SUPER | ACC_SYNTHETIC)\n-                                .withMethodBody(INIT_NAME, MTD_INIT, 0, CONSTRUCTOR_BUILDER)\n-                                .withMethod(\"length\",\n+                            if (staticConcat) {\n+                                clb.withSuperclass(CD_Object)\n+                                   .withFlags(ACC_ABSTRACT | ACC_SUPER | ACC_SYNTHETIC);\n+                            } else {\n+                                clb.withSuperclass(CD_StringConcatBase)\n+                                   .withFlags(ACC_FINAL | ACC_SUPER | ACC_SYNTHETIC)\n+                                   .withMethodBody(INIT_NAME, MTD_INIT, 0, CONSTRUCTOR_BUILDER);\n+                            }\n+\n+                            clb.withMethod(\"length\",\n@@ -1301,1 +1319,1 @@\n-                                                mb.withCode(generatePrependMethod(prependArgs));\n+                                                mb.withCode(generatePrependMethod(prependArgs, staticConcat, constants));\n@@ -1306,1 +1324,1 @@\n-                                        ACC_FINAL,\n+                                        staticConcat ? ACC_STATIC | ACC_FINAL : ACC_FINAL,\n@@ -1313,0 +1331,2 @@\n+                                                        staticConcat,\n+                                                        constants,\n@@ -1338,0 +1358,5 @@\n+\n+                if (staticConcat) {\n+                    return lookup.findStatic(hiddenClass, METHOD_NAME, concatArgs);\n+                }\n+\n@@ -1413,0 +1438,2 @@\n+                boolean        staticConcat,\n+                String[]       constants,\n@@ -1424,1 +1451,1 @@\n-                        thisSlot      = cb.receiverSlot(),\n+                        thisSlot      = staticConcat ? 0 : cb.receiverSlot(),\n@@ -1460,0 +1487,9 @@\n+                    int coder  = JLA.stringInitCoder(),\n+                        length = 0;\n+                    if (staticConcat) {\n+                        for (var constant : constants) {\n+                            coder |= JLA.stringCoder(constant);\n+                            length += constant.length();\n+                        }\n+                    }\n+\n@@ -1463,2 +1499,12 @@\n-                    cb.aload(thisSlot)\n-                      .getfield(concatClass, \"coder\", CD_byte);\n+                    if (staticConcat) {\n+                        \/\/ coder can only be 0 or 1\n+                        if (coder == 0) {\n+                            cb.iconst_0();\n+                        } else {\n+                            cb.iconst_1();\n+                        }\n+                    } else {\n+                        cb.aload(thisSlot)\n+                          .getfield(concatClass, \"coder\", CD_byte);\n+                    }\n+\n@@ -1483,2 +1529,7 @@\n-                    cb.aload(thisSlot)\n-                      .getfield(concatClass, \"length\", CD_int);\n+                    if (staticConcat) {\n+                        cb.ldc(length);\n+                    } else {\n+                        cb.aload(thisSlot)\n+                          .getfield(concatClass, \"length\", CD_int);\n+                    }\n+\n@@ -1501,11 +1552,17 @@\n-                    cb.aload(thisSlot)\n-                      .getfield(concatClass, \"constants\", CD_Array_String)\n-                      .dup()\n-                      .astore(constantsSlot)\n-                      .ldc(paramCount)\n-                      .aaload()\n-                      .dup()\n-                      .astore(suffixSlot)\n-                      .invokevirtual(CD_String, \"length\", MTD_int)\n-                      .isub()\n-                      .istore(lengthSlot);\n+                    if (staticConcat) {\n+                        cb.ldc(constants[paramCount].length())\n+                          .isub()\n+                          .istore(lengthSlot);\n+                    } else {\n+                        cb.aload(thisSlot)\n+                          .getfield(concatClass, \"constants\", CD_Array_String)\n+                          .dup()\n+                          .astore(constantsSlot)\n+                          .ldc(paramCount)\n+                          .aaload()\n+                          .dup()\n+                          .astore(suffixSlot)\n+                          .invokevirtual(CD_String, \"length\", MTD_int)\n+                          .isub()\n+                          .istore(lengthSlot);\n+                    }\n@@ -1518,2 +1575,6 @@\n-                    cb.aload(suffixSlot)\n-                      .iload(lengthSlot)\n+                    if (staticConcat) {\n+                        cb.ldc(constants[paramCount]);\n+                    } else {\n+                        cb.aload(suffixSlot);\n+                    }\n+                    cb.iload(lengthSlot)\n@@ -1529,2 +1590,4 @@\n-                      .aload(bufSlot)\n-                      .aload(constantsSlot);\n+                      .aload(bufSlot);\n+                    if (!staticConcat) {\n+                        cb.aload(constantsSlot);\n+                    }\n@@ -1654,1 +1717,4 @@\n-        private static Consumer<CodeBuilder> generatePrependMethod(MethodTypeDesc prependArgs) {\n+        private static Consumer<CodeBuilder> generatePrependMethod(\n+                MethodTypeDesc prependArgs,\n+                boolean staticConcat, String[] constants\n+        ) {\n@@ -1673,1 +1739,1 @@\n-                    for (int i = prependArgs.parameterCount() - 1; i >= 4; i--) {\n+                    for (int i = prependArgs.parameterCount() - 1, end = staticConcat ? 3 : 4; i >= end; i--) {\n@@ -1694,5 +1760,11 @@\n-                          .loadLocal(kind, cb.parameterSlot(i))\n-                          .aload(constantsSlot)\n-                          .ldc(i - 4)\n-                          .aaload()\n-                          .invokestatic(CD_StringConcatHelper, \"prepend\", methodTypeDesc);\n+                          .loadLocal(kind, cb.parameterSlot(i));\n+\n+                        if (staticConcat) {\n+                            cb.ldc(constants[i - 3]);\n+                        } else {\n+                            cb.aload(constantsSlot)\n+                              .ldc(i - 4)\n+                              .aaload();\n+                        }\n+\n+                        cb.invokestatic(CD_StringConcatHelper, \"prepend\", methodTypeDesc);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/StringConcatFactory.java","additions":121,"deletions":49,"binary":false,"changes":170,"status":"modified"},{"patch":"@@ -467,0 +467,5 @@\n+    \/**\n+     * Get the Coder of String, which is used by StringConcatFactory to calculate the initCoder of constants\n+     *\/\n+    byte stringCoder(String str);\n+\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/access\/JavaLangAccess.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"}]}