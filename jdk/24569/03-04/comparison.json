{"files":[{"patch":"@@ -93,1 +93,0 @@\n-import static jdk.internal.net.http.frame.SettingsFrame.DEFAULT_INITIAL_WINDOW_SIZE;\n@@ -344,0 +343,1 @@\n+            super(Context.REQUEST);\n@@ -988,1 +988,4 @@\n-                        orphanedConsumer = new ValidatingHeadersConsumer(Context.RESPONSE);\n+                        orphanedConsumer = new ValidatingHeadersConsumer(\n+                                frame instanceof PushPromiseFrame ?\n+                                        Context.REQUEST :\n+                                        Context.RESPONSE);\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http2Connection.java","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -33,2 +33,2 @@\n-    public HeaderDecoder() {\n-        super(Context.REQUEST);\n+    public HeaderDecoder(Context context) {\n+        super(context);\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/common\/HeaderDecoder.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import java.util.Objects;\n@@ -41,1 +42,1 @@\n-        this.context = context;\n+        this.context = Objects.requireNonNull(context);\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/common\/ValidatingHeadersConsumer.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -27,3 +27,0 @@\n- * @library \/test\/lib \/test\/jdk\/java\/net\/httpclient\/lib\n- * @build jdk.httpclient.test.lib.http2.Http2TestServer jdk.test.lib.net.SimpleSSLContext\n- * @run testng\/othervm -Djdk.internal.httpclient.debug=true BadHeadersTest\n@@ -33,0 +30,3 @@\n+ * @library \/test\/lib \/test\/jdk\/java\/net\/httpclient\/lib\n+ * @build jdk.httpclient.test.lib.http2.Http2TestServer jdk.test.lib.net.SimpleSSLContext\n+ * @run testng\/othervm -Djdk.internal.httpclient.debug=true BadHeadersTest\n","filename":"test\/jdk\/java\/net\/httpclient\/http2\/BadHeadersTest.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -0,0 +1,184 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8354276\n+ * @library \/test\/lib \/test\/jdk\/java\/net\/httpclient\/lib\n+ * @build jdk.test.lib.net.SimpleSSLContext jdk.httpclient.test.lib.http2.Http2TestServer\n+ * @run testng\/othervm\n+ *      -Djdk.internal.httpclient.debug=true\n+ *      -Djdk.httpclient.HttpClient.log=errors,requests,responses,trace\n+ *      BadPushPromiseTest\n+ *\/\n+\n+import jdk.httpclient.test.lib.http2.Http2Handler;\n+import jdk.httpclient.test.lib.http2.Http2TestExchange;\n+import jdk.httpclient.test.lib.http2.Http2TestServer;\n+import org.testng.annotations.AfterTest;\n+import org.testng.annotations.BeforeTest;\n+import org.testng.annotations.Test;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+import java.net.ProtocolException;\n+import java.net.URI;\n+import java.net.http.HttpClient;\n+import java.net.http.HttpHeaders;\n+import java.net.http.HttpRequest;\n+import java.net.http.HttpResponse;\n+import java.net.http.HttpResponse.BodyHandlers;\n+import java.net.http.HttpResponse.PushPromiseHandler;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+\n+import static java.nio.charset.StandardCharsets.UTF_8;\n+import static java.util.List.of;\n+import static org.testng.Assert.*;\n+\n+public class BadPushPromiseTest {\n+\n+    private static final List<Map<String, List<String>>> BAD_HEADERS = of(\n+            Map.of(\":hello\", of(\"GET\")),                      \/\/ Unknown pseudo-header\n+            Map.of(\"hell o\", of(\"value\")),                    \/\/ Space in the name\n+            Map.of(\"hello\", of(\"line1\\r\\n  line2\\r\\n\")),      \/\/ Multiline value\n+            Map.of(\"hello\", of(\"DE\" + ((char) 0x7F) + \"L\")),  \/\/ Bad byte in value\n+            Map.of(\":status\", of(\"200\"))                     \/\/ Response pseudo-header in request\n+    );\n+\n+    static final String MAIN_RESPONSE_BODY = \"the main response body\";\n+\n+    Http2TestServer server;\n+    URI uri;\n+\n+    @BeforeTest\n+    public void setup() throws Exception {\n+        server = new Http2TestServer(false, 0);\n+        Http2Handler handler = new ServerPushHandler(MAIN_RESPONSE_BODY\n+        );\n+        server.addHandler(handler, \"\/\");\n+        server.start();\n+        int port = server.getAddress().getPort();\n+        System.err.println(\"Server listening on port \" + port);\n+        uri = new URI(\"http:\/\/localhost:\" + port + \"\/foo\/a\/b\/c\");\n+    }\n+\n+    @AfterTest\n+    public void teardown() {\n+        server.stop();\n+    }\n+\n+    \/*\n+     * Malformed push promise headers should kill the connection\n+     *\/\n+    @Test\n+    public void test() throws Exception {\n+        HttpClient client = HttpClient.newHttpClient();\n+\n+        for (int i=0; i< BAD_HEADERS.size(); i++) {\n+            URI uriWithQuery = URI.create(uri +  \"?BAD_HEADERS=\" + i);\n+            HttpRequest request = HttpRequest.newBuilder(uriWithQuery)\n+                    .build();\n+            System.out.println(\"\\nSending request:\" + uriWithQuery);\n+            final HttpClient cc = client;\n+            try {\n+                ConcurrentMap<HttpRequest, CompletableFuture<HttpResponse<String>>> promises\n+                        = new ConcurrentHashMap<>();\n+                PushPromiseHandler<String> pph = PushPromiseHandler\n+                        .of((r) -> BodyHandlers.ofString(), promises);\n+                HttpResponse<String> response = cc.sendAsync(request, BodyHandlers.ofString(), pph).join();\n+                fail(\"Expected exception, got :\" + response + \", \" + response.body());\n+            } catch (CompletionException ce) {\n+                System.out.println(\"Got EXPECTED: \" + ce);\n+                assertDetailMessage(ce.getCause(), i);\n+            }\n+        }\n+    }\n+\n+    \/\/ Assertions based on implementation specific detail messages. Keep in\n+    \/\/ sync with implementation.\n+    static void assertDetailMessage(Throwable throwable, int iterationIndex) {\n+        try {\n+            assertTrue(throwable instanceof ProtocolException,\n+                    \"Expected ProtocolException, got \" + throwable);\n+\n+            if (iterationIndex == 0) { \/\/ unknown\n+                assertTrue(throwable.getMessage().contains(\"Unknown pseudo-header\"),\n+                        \"Expected \\\"Unknown pseudo-header\\\" in: \" + throwable.getMessage());\n+            } else if (iterationIndex == 4) { \/\/ unexpected type\n+                assertTrue(throwable.getMessage().contains(\"not valid in context\"),\n+                        \"Expected \\\"not valid in context\\\" in: \" + throwable.getMessage());\n+            } else {\n+                assertTrue(throwable.getMessage().contains(\"Bad header\"),\n+                        \"Expected \\\"Bad header\\\" in: \" + throwable.getMessage());\n+            }\n+        } catch (AssertionError e) {\n+            System.out.println(\"Exception does not match expectation: \" + throwable);\n+            throwable.printStackTrace(System.out);\n+            throw e;\n+        }\n+    }\n+\n+    \/\/ --- server push handler ---\n+    static class ServerPushHandler implements Http2Handler {\n+\n+        private final String mainResponseBody;\n+\n+        public ServerPushHandler(String mainResponseBody) {\n+            this.mainResponseBody = mainResponseBody;\n+        }\n+\n+        public void handle(Http2TestExchange exchange) throws IOException {\n+            System.err.println(\"Server: handle \" + exchange);\n+            try (InputStream is = exchange.getRequestBody()) {\n+                is.readAllBytes();\n+            }\n+\n+            pushPromise(exchange);\n+\n+            \/\/ response data for the main response\n+            try (OutputStream os = exchange.getResponseBody()) {\n+                byte[] bytes = mainResponseBody.getBytes(UTF_8);\n+                exchange.sendResponseHeaders(200, bytes.length);\n+                os.write(bytes);\n+            }\n+        }\n+\n+        private void pushPromise(Http2TestExchange exchange) {\n+            URI requestURI = exchange.getRequestURI();\n+            String query = exchange.getRequestURI().getQuery();\n+            int badHeadersIndex = Integer.parseInt(query.substring(query.indexOf(\"=\") + 1));\n+            URI uri = requestURI.resolve(\"\/push\/\"+badHeadersIndex);\n+            InputStream is = new ByteArrayInputStream(mainResponseBody.getBytes(UTF_8));\n+            HttpHeaders headers = HttpHeaders.of(BAD_HEADERS.get(badHeadersIndex), (x, y) -> true);\n+            exchange.serverPush(uri, headers, is);\n+            System.err.println(\"Server: push sent\");\n+        }\n+    }\n+}\n","filename":"test\/jdk\/java\/net\/httpclient\/http2\/BadPushPromiseTest.java","additions":184,"deletions":0,"binary":false,"changes":184,"status":"added"}]}