{"files":[{"patch":"@@ -6338,0 +6338,27 @@\n+\/\/ Special prefetch versions which use the dcbz instruction.\n+instruct prefetch_alloc_zero(indirectMemory mem, iRegLsrc src) %{\n+  match(PrefetchAllocation (AddP mem src));\n+  predicate(AllocatePrefetchStyle == 3);\n+  ins_cost(MEMORY_REF_COST);\n+\n+  format %{ \"PREFETCH $mem, 2, $src \\t\/\/ Prefetch write-many with zero\" %}\n+  size(4);\n+  ins_encode %{\n+    __ dcbz($src$$Register, $mem$$base$$Register);\n+  %}\n+  ins_pipe(pipe_class_memory);\n+%}\n+\n+instruct prefetch_alloc_zero_no_offset(indirectMemory mem) %{\n+  match(PrefetchAllocation mem);\n+  predicate(AllocatePrefetchStyle == 3);\n+  ins_cost(MEMORY_REF_COST);\n+\n+  format %{ \"PREFETCH $mem, 2 \\t\/\/ Prefetch write-many with zero\" %}\n+  size(4);\n+  ins_encode %{\n+    __ dcbz($mem$$base$$Register);\n+  %}\n+  ins_pipe(pipe_class_memory);\n+%}\n+\n@@ -6340,0 +6367,1 @@\n+  predicate(AllocatePrefetchStyle != 3);\n@@ -6352,0 +6380,1 @@\n+  predicate(AllocatePrefetchStyle != 3);\n","filename":"src\/hotspot\/cpu\/ppc\/ppc.ad","additions":29,"deletions":0,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -40,0 +40,1 @@\n+int          ThreadLocalAllocBuffer::_reserve_for_allocation_prefetch = 0;\n@@ -227,0 +228,24 @@\n+#ifdef COMPILER2\n+  \/\/ If the C2 compiler is present, extra space is needed at the end of\n+  \/\/ TLABs, otherwise prefetching instructions generated by the C2\n+  \/\/ compiler will fault (due to accessing memory outside of heap).\n+  \/\/ The amount of space is the max of the number of lines to\n+  \/\/ prefetch for array and for instance allocations. (Extra space must be\n+  \/\/ reserved to accommodate both types of allocations.)\n+  \/\/\n+  \/\/ Only SPARC-specific BIS instructions are known to fault. (Those\n+  \/\/ instructions are generated if AllocatePrefetchStyle==3 and\n+  \/\/ AllocatePrefetchInstr==1). To be on the safe side, however,\n+  \/\/ extra space is reserved for all combinations of\n+  \/\/ AllocatePrefetchStyle and AllocatePrefetchInstr.\n+  \/\/\n+  \/\/ If the C2 compiler is not present, no space is reserved.\n+\n+  \/\/ +1 for rounding up to next cache line, +1 to be safe\n+  if (CompilerConfig::is_c2_or_jvmci_compiler_enabled()) {\n+    int lines =  MAX2(AllocatePrefetchLines, AllocateInstancePrefetchLines) + 2;\n+    _reserve_for_allocation_prefetch = (AllocatePrefetchDistance + AllocatePrefetchStepSize * lines) \/\n+                                       (int)HeapWordSize;\n+  }\n+#endif\n+\n@@ -432,1 +457,2 @@\n-  return CollectedHeap::lab_alignment_reserve();\n+  size_t reserve_size = CollectedHeap::lab_alignment_reserve();\n+  return MAX2(reserve_size, (size_t)_reserve_for_allocation_prefetch);\n","filename":"src\/hotspot\/share\/gc\/shared\/threadLocalAllocBuffer.cpp","additions":27,"deletions":1,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -61,0 +61,1 @@\n+  static int      _reserve_for_allocation_prefetch;   \/\/ Reserve at the end of the TLAB\n","filename":"src\/hotspot\/share\/gc\/shared\/threadLocalAllocBuffer.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -1917,1 +1917,2 @@\n-      \/\/ Address is aligned to execute prefetch to the beginning of cache line size.\n+      \/\/ Address is aligned to execute prefetch to the beginning of cache line size\n+      \/\/ (it is important when BIS instruction is used on SPARC as prefetch).\n","filename":"src\/hotspot\/share\/opto\/macro.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -356,0 +356,1 @@\n+     static_field(ThreadLocalAllocBuffer,      _reserve_for_allocation_prefetch,              int)                                   \\\n","filename":"src\/hotspot\/share\/runtime\/vmStructs.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -79,0 +79,1 @@\n+    long reserveForAllocationPrefetch = VM.getVM().getReserveForAllocationPrefetch();\n@@ -81,1 +82,1 @@\n-    return labAlignmentReserve * heapWordSize;\n+    return Math.max(labAlignmentReserve, reserveForAllocationPrefetch) * heapWordSize;\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/runtime\/ThreadLocalAllocBuffer.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -126,0 +126,1 @@\n+  private int          reserveForAllocationPrefetch;\n@@ -449,0 +450,2 @@\n+    CIntegerField reserveForAllocationPrefetchField = threadLocalAllocBuffer.getCIntegerField(\"_reserve_for_allocation_prefetch\");\n+    reserveForAllocationPrefetch = (int)reserveForAllocationPrefetchField.getCInteger(intType);\n@@ -915,0 +918,4 @@\n+  public int getReserveForAllocationPrefetch() {\n+    return reserveForAllocationPrefetch;\n+  }\n+\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/runtime\/VM.java","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"}]}