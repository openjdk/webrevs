{"files":[{"patch":"@@ -44,0 +44,1 @@\n+  LOG_TAG(asan) \\\n","filename":"src\/hotspot\/share\/logging\/logTag.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -505,1 +505,1 @@\n-          range(0, 17)                                                      \\\n+          range(0, 18)                                                      \\\n","filename":"src\/hotspot\/share\/runtime\/globals.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -101,0 +101,1 @@\n+#include \"sanitizers\/address.hpp\"\n@@ -698,0 +699,4 @@\n+#ifdef ADDRESS_SANITIZER\n+  Asan::initialize();\n+#endif\n+\n","filename":"src\/hotspot\/share\/runtime\/threads.cpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -0,0 +1,68 @@\n+\/*\n+ * Copyright (c) 1998, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\n+ *\/\n+\n+#ifdef ADDRESS_SANITIZER\n+\n+#include \"logging\/log.hpp\"\n+#include \"sanitizers\/address.hpp\"\n+#include \"utilities\/globalDefinitions.hpp\"\n+#include \"utilities\/vmError.hpp\"\n+\n+#include <dlfcn.h>\n+#include <stdio.h>\n+\n+\n+static const char* g_asan_report = nullptr;\n+typedef void (*callback_setter_t) (void (*callback)(const char *));\n+static callback_setter_t callback_setter = nullptr;\n+\n+extern \"C\" void asan_error_callback(const char* report_text) {\n+  \/\/ Keep things very short and simple here;\n+  \/\/ Do use as little as possible of any hotspot infrastructure.\n+  \/\/ We will print out the report text on stderr; then, we will\n+  \/\/ end the JVM with a fatal error, resulting in hs-err file\n+  \/\/ and core dump. VMError will also print the error report\n+  \/\/ to the hs-err file.\n+  g_asan_report = report_text;\n+  fprintf(stderr, \"JVM caught ASAN Error\\n\");\n+  fprintf(stderr, \"%s\\n\", report_text);\n+  fatal(\"ASAN error caught\");\n+}\n+\n+const char* Asan::report() {\n+  return g_asan_report;\n+}\n+\n+void Asan::initialize() {\n+  callback_setter = (callback_setter_t) dlsym(RTLD_DEFAULT, \"__asan_set_error_report_callback\");\n+  if (callback_setter) {\n+    callback_setter(asan_error_callback);\n+    log_info(asan)(\"JVM callback for ASAN errors successfully installed\");\n+  } else {\n+    log_info(asan)(\"*** Failed to install JVM callback for ASAN. ASAN errors will not generate hs-err files. ***\");\n+  }\n+  \/\/__asan_set_error_report_callback(asan_error_callback);\n+}\n+\n+#endif \/\/ ADDRESS_SANITIZER\n","filename":"src\/hotspot\/share\/sanitizers\/address.cpp","additions":68,"deletions":0,"binary":false,"changes":68,"status":"added"},{"patch":"@@ -29,0 +29,2 @@\n+#include \"memory\/allStatic.hpp\"\n+\n@@ -77,0 +79,8 @@\n+#ifdef ADDRESS_SANITIZER\n+struct Asan : public AllStatic {\n+  static void initialize();\n+  \/\/ Returns the ASAN report text; nullptr if no ASAN error happened.\n+  static const char* report();\n+};\n+#endif\n+\n","filename":"src\/hotspot\/share\/sanitizers\/address.hpp","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -63,0 +63,1 @@\n+#include \"sanitizers\/address.hpp\"\n@@ -913,1 +914,12 @@\n-  STEP_IF(\"printing thread\", _verbose)\n+#ifdef ADDRESS_SANITIZER\n+  STEP_IF(\"printing ASAN error information\", _verbose && Asan::report() != nullptr)\n+    st->cr();\n+    st->print_cr(\"------------------  A S A N ----------------\");\n+    st->cr();\n+    \/\/ Note: Use print_raw, not print or print_cr, to avoid truncation\n+    \/\/ (report can be longer than 2K)\n+    st->print_raw(Asan::report());\n+    st->cr();\n+#endif \/\/ ADDRESS_SANITIZER\n+\n+    STEP_IF(\"printing thread\", _verbose)\n@@ -2189,0 +2201,8 @@\n+    case 18: {\n+      \/\/ Trigger an error that should cause ASAN to report a double free or use-after-free.\n+      \/\/ Please note that this is not 100% bullet-proof since it assumes that this block\n+      \/\/ is not immediately repurposed by some other thread after free.\n+      void* const p = os::malloc(4096, mtTest);\n+      os::free(p);\n+      os::free(p);\n+    }\n","filename":"src\/hotspot\/share\/utilities\/vmError.cpp","additions":21,"deletions":1,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -0,0 +1,85 @@\n+\/*\n+ * Copyright (c) 2025, IBM Corporation. All rights reserved.\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @summary Test that we get ASAN-reports and hs-err files on ASAN error\n+ * @library \/test\/lib\n+ * @requires vm.asan\n+ * @requires vm.flagless\n+ * @requires vm.debug == true & os.family == \"linux\"\n+ * @modules java.base\/jdk.internal.misc\n+ *          java.management\n+ * @run driver AsanReportTest\n+ *\/\n+\n+\/\/ Note: this test can only run on debug since it relies on VMError::controlled_crash() which\n+\/\/ only exists in debug builds.\n+import java.io.File;\n+import java.util.Arrays;\n+import java.util.regex.Pattern;\n+\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.Platform;\n+import jdk.test.lib.process.ProcessTools;\n+\n+public class AsanReportTest {\n+\n+    private static void do_test() throws Exception {\n+\n+        ProcessBuilder pb = ProcessTools.createLimitedTestJavaProcessBuilder(\n+                \"-Xmx100M\",\n+                \"-XX:-CreateCoredumpOnCrash\",\n+                \/\/ Switch off NMT since it can alter the error ASAN sees; we want the pure double free error\n+                \"-XX:NativeMemoryTracking=off\",\n+                \/\/ Causes double-free in controlled_crash\n+                \"-XX:ErrorHandlerTest=18\",\n+                \"-version\");\n+\n+        OutputAnalyzer output = new OutputAnalyzer(pb.start());\n+\n+        output.shouldNotHaveExitValue(0);\n+\n+        \/\/ ASAN error should appear on stderr\n+        output.shouldContain(\"JVM caught ASAN Error\");\n+        output.shouldContain(\"# A fatal error has been detected by the Java Runtime Environment\");\n+        output.shouldMatch(\".*AddressSanitizer.*double-free.*\");\n+        output.shouldContain(\"#  fatal error: ASAN error\");\n+\n+        File hs_err_file = HsErrFileUtils.openHsErrFileFromOutput(output);\n+        Pattern[] pat = new Pattern[] {\n+                Pattern.compile(\".*A S A N.*\"),\n+                Pattern.compile(\".*AddressSanitizer.*double-free.*\"),\n+                Pattern.compile(\".*(crash_with_segfault|controlled_crash).*\")\n+        };\n+        HsErrFileUtils.checkHsErrFileContent(hs_err_file, pat, false);\n+\n+    }\n+\n+    public static void main(String[] args) throws Exception {\n+        do_test();\n+    }\n+\n+}\n+\n","filename":"test\/hotspot\/jtreg\/runtime\/ErrorHandling\/AsanReportTest.java","additions":85,"deletions":0,"binary":false,"changes":85,"status":"added"}]}