{"files":[{"patch":"@@ -2005,1 +2005,1 @@\n-    if (cgr != nullptr && cgr->not_global_escape(obj_node())) {\n+    if (cgr != nullptr && cgr->can_eliminate_lock(this)) {\n@@ -2201,1 +2201,1 @@\n-    if (cgr != nullptr && cgr->not_global_escape(obj_node())) {\n+    if (cgr != nullptr && cgr->can_eliminate_lock(this)) {\n","filename":"src\/hotspot\/share\/opto\/callnode.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -4958,1 +4958,1 @@\n-void Compile::mark_coarsened_boxes() {\n+void Compile::mark_unbalanced_boxes() {\n","filename":"src\/hotspot\/share\/opto\/compile.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -783,1 +783,1 @@\n-  void mark_coarsened_boxes();\n+  void mark_unbalanced_boxes();\n","filename":"src\/hotspot\/share\/opto\/compile.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2550,3 +2550,2 @@\n-        BoxLockNode* box = alock->box_node()->as_BoxLock();\n-        if (!box->is_unbalanced() && !alock->is_non_esc_obj()) {\n-          if (not_global_escape(alock->obj_node())) {\n+        if (!alock->is_non_esc_obj()) {\n+          if (can_eliminate_lock(alock)) {\n@@ -2885,0 +2884,7 @@\n+\/\/ Return true if locked object does not escape globally\n+\/\/ and locked code region (identified by BoxLockNode) is balanced:\n+\/\/ all compiled code paths have corresponding Lock\/Unlock pairs.\n+bool ConnectionGraph::can_eliminate_lock(AbstractLockNode* alock) {\n+  BoxLockNode* box = alock->box_node()->as_BoxLock();\n+  return !box->is_unbalanced() && not_global_escape(alock->obj_node());\n+}\n","filename":"src\/hotspot\/share\/opto\/escape.cpp","additions":9,"deletions":3,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -115,0 +115,1 @@\n+class  AbstractLockNode;\n@@ -633,0 +634,2 @@\n+  bool can_eliminate_lock(AbstractLockNode* alock);\n+\n","filename":"src\/hotspot\/share\/opto\/escape.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2357,1 +2357,4 @@\n-    C->mark_coarsened_boxes();\n+    \/\/ After coarsened locks are eliminated locking regions\n+    \/\/ become unbalanced. We should not execute any more\n+    \/\/ locks elimination optimizations on them.\n+    C->mark_unbalanced_boxes();\n","filename":"src\/hotspot\/share\/opto\/macro.cpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"}]}