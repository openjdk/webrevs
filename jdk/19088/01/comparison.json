{"files":[{"patch":"@@ -394,13 +394,2 @@\n-        if (index <= 0 || index >= constantPoolCount) {\n-            throw new ConstantPoolException(\"Bad CP UTF8 index: \" + index);\n-        }\n-        PoolEntry info = cp[index];\n-        if (info == null) {\n-            int offset = cpOffset[index];\n-            int tag = readU1(offset);\n-            final int q = offset + 1;\n-            if (tag != TAG_UTF8) throw new ConstantPoolException(\"Not a UTF8 - index: \" + index);\n-            AbstractPoolEntry.Utf8EntryImpl uinfo\n-                    = new AbstractPoolEntry.Utf8EntryImpl(this, index, buffer, q + 2, readU2(q));\n-            cp[index] = uinfo;\n-            return uinfo;\n+        if (entryByIndex(index, TAG_UTF8, TAG_UTF8) instanceof AbstractPoolEntry.Utf8EntryImpl utf8) {\n+            return utf8;\n@@ -408,1 +397,1 @@\n-        return (AbstractPoolEntry.Utf8EntryImpl) info;\n+        throw new ConstantPoolException(\"Not a UTF8 - index: \" + index);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/classfile\/impl\/ClassReaderImpl.java","additions":3,"deletions":14,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8320360 8330684 8331320\n+ * @bug 8320360 8330684 8331320 8331655\n@@ -39,0 +39,1 @@\n+import java.lang.classfile.constantpool.IntegerEntry;\n@@ -109,0 +110,8 @@\n+    @Test\n+    void testInvalidUtf8Entry() {\n+        var cp = ClassFile.of().parse(new byte[]{(byte)0xCA, (byte)0xFE, (byte)0xBA, (byte)0xBE,\n+            0, 0, 0, 0, 0, 3, ClassFile.TAG_INTEGER, 0, 0, 0, 0, ClassFile.TAG_NAMEANDTYPE, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}).constantPool();\n+        assertTrue(cp.entryByIndex(1) instanceof IntegerEntry); \/\/parse valid int entry first\n+        assertThrows(ConstantPoolException.class, () -> cp.entryByIndex(2));\n+    }\n+\n","filename":"test\/jdk\/jdk\/classfile\/LimitsTest.java","additions":10,"deletions":1,"binary":false,"changes":11,"status":"modified"}]}