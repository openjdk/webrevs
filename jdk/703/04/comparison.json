{"files":[{"patch":"@@ -52,2 +52,2 @@\n-    FILES := $(TOPDIR)\/src\/java.base\/share\/classes\/jdk\/internal\/PreviewFeature.java, \\\n-    DEST := $(BUILDTOOLS_OUTPUTDIR)\/gensrc\/java.base.interim\/jdk\/internal\/, \\\n+    FILES := $(TOPDIR)\/src\/java.base\/share\/classes\/jdk\/internal\/javac\/PreviewFeature.java, \\\n+    DEST := $(BUILDTOOLS_OUTPUTDIR)\/gensrc\/java.base.interim\/jdk\/internal\/javac\/, \\\n@@ -84,2 +84,2 @@\n-          --add-exports java.base\/jdk.internal=java.compiler.interim \\\n-          --add-exports java.base\/jdk.internal=jdk.compiler.interim, \\\n+          --add-exports java.base\/jdk.internal.javac=java.compiler.interim \\\n+          --add-exports java.base\/jdk.internal.javac=jdk.compiler.interim, \\\n","filename":"make\/CompileInterimLangtools.gmk","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -95,1 +95,0 @@\n-    -taglet build.tools.taglet.Preview \\\n","filename":"make\/Docs.gmk","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -658,0 +658,2 @@\n+    --add-exports java.base\/jdk.internal.javac=java.compiler.interim \\\n+    --add-exports java.base\/jdk.internal.javac=jdk.compiler.interim \\\n@@ -665,0 +667,1 @@\n+    --patch-module java.base=$(BUILDTOOLS_OUTPUTDIR)\/gensrc\/java.base.interim \\\n","filename":"make\/autoconf\/spec.gmk.in","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1,79 +0,0 @@\n-\/*\n- * Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.  Oracle designates this\n- * particular file as subject to the \"Classpath\" exception as provided\n- * by Oracle in the LICENSE file that accompanied this code.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-package build.tools.taglet;\n-\n-import java.util.Arrays;\n-import java.util.EnumSet;\n-import java.util.List;\n-import java.util.Set;\n-import java.util.function.Predicate;\n-import javax.lang.model.element.Element;\n-import com.sun.source.doctree.DocTree;\n-import com.sun.source.doctree.TextTree;\n-import com.sun.source.doctree.UnknownInlineTagTree;\n-import jdk.javadoc.doclet.Taglet;\n-import static jdk.javadoc.doclet.Taglet.Location.*;\n-\n-\/**\n- * An block tag to insert a standard warning about a preview API.\n- *\/\n-public class Preview implements Taglet {\n-\n-    \/** Returns the set of locations in which a taglet may be used. *\/\n-    @Override\n-    public Set<Location> getAllowedLocations() {\n-        return EnumSet.of(MODULE, PACKAGE, TYPE, CONSTRUCTOR, METHOD, FIELD);\n-    }\n-\n-    @Override\n-    public boolean isInlineTag() {\n-        return true;\n-    }\n-\n-    @Override\n-    public String getName() {\n-        return \"preview\";\n-    }\n-\n-    @Override\n-    public String toString(List<? extends DocTree> tags, Element elem) {\n-        UnknownInlineTagTree previewTag = (UnknownInlineTagTree) tags.get(0);\n-        List<? extends DocTree> previewContent = previewTag.getContent();\n-        String previewText = ((TextTree) previewContent.get(0)).getBody();\n-        String[] summaryAndDetails = previewText.split(\"\\n\\r?\\n\\r?\");\n-        String summary = summaryAndDetails[0];\n-        String details = summaryAndDetails.length > 1 ? summaryAndDetails[1] : summaryAndDetails[0];\n-        StackTraceElement[] stackTrace = new Exception().getStackTrace();\n-        Predicate<StackTraceElement> isSummary =\n-                el -> el.getClassName().endsWith(\"HtmlDocletWriter\") &&\n-                      el.getMethodName().equals(\"addSummaryComment\");\n-        if (Arrays.stream(stackTrace).anyMatch(isSummary)) {\n-            return \"<div style=\\\"display:inline-block; font-weight:bold\\\">\" + summary + \"<\/div><br>\";\n-        }\n-        return \"<div style=\\\"border: 1px solid red; border-radius: 5px; padding: 5px; display:inline-block; font-size: larger\\\">\" + details + \"<\/div><br>\";\n-    }\n-}\n-\n","filename":"make\/jdk\/src\/classes\/build\/tools\/taglet\/Preview.java","additions":0,"deletions":79,"binary":false,"changes":79,"status":"deleted"},{"patch":"@@ -1084,0 +1084,1 @@\n+        Map<String, Object> values = desc.values;\n@@ -1085,1 +1086,1 @@\n-        if (PREVIEW_FEATURE_ANNOTATION.equals(annotationType)) {\n+        if (PREVIEW_FEATURE_ANNOTATION_NEW.equals(annotationType)) {\n@@ -1091,0 +1092,9 @@\n+        if (PREVIEW_FEATURE_ANNOTATION_OLD.equals(annotationType)) {\n+            \/\/the non-public PreviewFeature annotation will not be available in ct.sym,\n+            \/\/replace with purely synthetic javac-internal annotation:\n+            annotationType = PREVIEW_FEATURE_ANNOTATION_INTERNAL;\n+            values = new HashMap<>(values);\n+            Boolean essentialAPI = (Boolean) values.remove(\"essentialAPI\");\n+            values.put(\"reflective\", essentialAPI != null && !essentialAPI);\n+        }\n+\n@@ -1093,1 +1103,1 @@\n-                              createElementPairs(constantPool, desc.values));\n+                              createElementPairs(constantPool, values));\n@@ -1096,1 +1106,1 @@\n-        private static final String PREVIEW_FEATURE_ANNOTATION =\n+        private static final String PREVIEW_FEATURE_ANNOTATION_OLD =\n@@ -1098,0 +1108,2 @@\n+        private static final String PREVIEW_FEATURE_ANNOTATION_NEW =\n+                \"Ljdk\/internal\/javac\/PreviewFeature;\";\n","filename":"make\/langtools\/src\/classes\/build\/tools\/symbolgenerator\/CreateSymbols.java","additions":15,"deletions":3,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -47,1 +47,1 @@\n-    --add-exports java.base\/jdk.internal=java.compiler.interim,jdk.compiler.interim \\\n+    --add-exports java.base\/jdk.internal.javac=java.compiler.interim,jdk.compiler.interim \\\n@@ -63,1 +63,0 @@\n-        --patch-module java.base=$(BUILDTOOLS_OUTPUTDIR)\/gensrc\/java.base.interim \\\n","filename":"make\/modules\/jdk.compiler\/Gendata.gmk","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -61,1 +61,0 @@\n-        --patch-module java.base=$(BUILDTOOLS_OUTPUTDIR)\/gensrc\/java.base.interim \\\n","filename":"make\/modules\/jdk.javadoc\/Gendata.gmk","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -4363,7 +4363,0 @@\n-     * {@preview Associated with sealed classes, a preview feature of the Java language.\n-     *\n-     *           This method is associated with <i>sealed classes<\/i>, a preview\n-     *           feature of the Java language. Preview features\n-     *           may be removed in a future release, or upgraded to permanent\n-     *           features of the Java language.}\n-     *\n@@ -4383,1 +4376,1 @@\n-    @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.SEALED_CLASSES, essentialAPI=false)\n+    @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.SEALED_CLASSES, reflective=true)\n@@ -4402,7 +4395,0 @@\n-     * * {@preview Associated with sealed classes, a preview feature of the Java language.\n-     *\n-     *           This method is associated with <i>sealed classes<\/i>, a preview\n-     *           feature of the Java language. Preview features\n-     *           may be removed in a future release, or upgraded to permanent\n-     *           features of the Java language.}\n-     *\n@@ -4419,1 +4405,1 @@\n-    @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.SEALED_CLASSES, essentialAPI=false)\n+    @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.SEALED_CLASSES, reflective=true)\n","filename":"src\/java.base\/share\/classes\/java\/lang\/Class.java","additions":2,"deletions":16,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n-package jdk.internal;\n+package jdk.internal.javac;\n@@ -54,1 +54,1 @@\n-    public boolean essentialAPI() default false;\n+    public boolean reflective() default false;\n@@ -72,0 +72,4 @@\n+        \/**\n+         * A key for testing.\n+         *\/\n+        TEST,\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/javac\/PreviewFeature.java","additions":6,"deletions":2,"binary":false,"changes":8,"previous_filename":"src\/java.base\/share\/classes\/jdk\/internal\/PreviewFeature.java","status":"renamed"},{"patch":"@@ -141,1 +141,1 @@\n-    exports jdk.internal to \/\/ for @HotSpotIntrinsicCandidate\n+    exports jdk.internal.javac to\n@@ -144,1 +144,0 @@\n-        jdk.incubator.vector,\n","filename":"src\/java.base\/share\/classes\/module-info.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -124,9 +124,0 @@\n-     * {@preview Associated with pattern matching for {@code\n-     * instanceof}, a preview feature of the Java language.\n-     *\n-     *           This enum constant is associated with <i>pattern\n-     *           matching for {@code instanceof}<\/i>, a preview\n-     *           feature of the Java language. Preview features\n-     *           may be removed in a future release, or upgraded to permanent\n-     *           features of the Java language.}\n-     *\n@@ -136,2 +127,2 @@\n-    @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.PATTERN_MATCHING_IN_INSTANCEOF,\n-                                 essentialAPI=false)\n+    @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.PATTERN_MATCHING_IN_INSTANCEOF,\n+                                 reflective=true)\n","filename":"src\/java.compiler\/share\/classes\/javax\/lang\/model\/element\/ElementKind.java","additions":2,"deletions":11,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -69,7 +69,0 @@\n-     * {@preview Associated with sealed classes, a preview feature of the Java language.\n-     *\n-     *           This enum constant is associated with <i>sealed classes<\/i>, a preview\n-     *           feature of the Java language. Preview features\n-     *           may be removed in a future release, or upgraded to permanent\n-     *           features of the Java language.}\n-     *\n@@ -79,2 +72,2 @@\n-    @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.SEALED_CLASSES,\n-                                             essentialAPI=false)\n+    @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.SEALED_CLASSES,\n+                                             reflective=true)\n@@ -84,7 +77,0 @@\n-     * {@preview Associated with sealed classes, a preview feature of the Java language.\n-     *\n-     *           This enum constant is associated with <i>sealed classes<\/i>, a preview\n-     *           feature of the Java language. Preview features\n-     *           may be removed in a future release, or upgraded to permanent\n-     *           features of the Java language.}\n-     *\n@@ -94,2 +80,2 @@\n-    @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.SEALED_CLASSES,\n-            essentialAPI=false)\n+    @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.SEALED_CLASSES,\n+            reflective=true)\n","filename":"src\/java.compiler\/share\/classes\/javax\/lang\/model\/element\/Modifier.java","additions":4,"deletions":18,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -199,6 +199,0 @@\n-     * {@preview Associated with sealed classes, a preview feature of the Java language.\n-     *\n-     *           This method is associated with <i>sealed classes<\/i>, a preview\n-     *           feature of the Java language. Preview features\n-     *           may be removed in a future release, or upgraded to permanent\n-     *           features of the Java language.}\n@@ -215,2 +209,2 @@\n-    @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.SEALED_CLASSES,\n-                                 essentialAPI=false)\n+    @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.SEALED_CLASSES,\n+                                 reflective=true)\n","filename":"src\/java.compiler\/share\/classes\/javax\/lang\/model\/element\/TypeElement.java","additions":2,"deletions":8,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -31,8 +31,0 @@\n- * {@preview Associated with pattern matching for instanceof, a preview feature of\n- *           the Java language.\n- *\n- *           This interface is associated with <i>pattern matching for instanceof<\/i>, a preview\n- *           feature of the Java language. Preview features\n- *           may be removed in a future release, or upgraded to permanent\n- *           features of the Java language.}\n- *\n@@ -43,0 +35,2 @@\n+@jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.PATTERN_MATCHING_IN_INSTANCEOF,\n+                                   reflective=true)\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/tree\/BindingPatternTree.java","additions":2,"deletions":8,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -90,7 +90,0 @@\n-     * {@preview Associated with sealed classes, a preview feature of the Java language.\n-     *\n-     *           This method is associated with <i>sealed classes<\/i>, a preview\n-     *           feature of the Java language. Preview features\n-     *           may be removed in a future release, or upgraded to permanent\n-     *           features of the Java language.}\n-     *\n@@ -105,2 +98,2 @@\n-    @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.SEALED_CLASSES,\n-                                             essentialAPI=false)\n+    @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.SEALED_CLASSES,\n+                                       reflective=true)\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/tree\/ClassTree.java","additions":2,"deletions":9,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -56,8 +56,0 @@\n-     * {@preview Associated with pattern matching for instanceof, a preview feature of\n-     *           the Java language.\n-     *\n-     *           This method is associated with <i>pattern matching for instanceof<\/i>, a preview\n-     *           feature of the Java language. Preview features\n-     *           may be removed in a future release, or upgraded to permanent\n-     *           features of the Java language.}\n-     *\n@@ -82,0 +74,2 @@\n+    @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.PATTERN_MATCHING_IN_INSTANCEOF,\n+                                       reflective=true)\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/tree\/InstanceOfTree.java","additions":2,"deletions":8,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -29,8 +29,0 @@\n- * {@preview Associated with pattern matching for instanceof, a preview feature of\n- *           the Java language.\n- *\n- *           This interface is associated with <i>pattern matching for instanceof<\/i>, a preview\n- *           feature of the Java language. Preview features\n- *           may be removed in a future release, or upgraded to permanent\n- *           features of the Java language.}\n- *\n@@ -42,0 +34,2 @@\n+@jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.PATTERN_MATCHING_IN_INSTANCEOF,\n+                                   reflective=true)\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/tree\/PatternTree.java","additions":2,"deletions":8,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -223,8 +223,0 @@\n-         * {@preview Associated with pattern matching for instanceof, a preview feature of\n-         *           the Java language.\n-         *\n-         *           This enum constant is associated with <i>pattern matching for instanceof<\/i>, a preview\n-         *           feature of the Java language. Preview features\n-         *           may be removed in a future release, or upgraded to permanent\n-         *           features of the Java language.}\n-         *\n@@ -235,0 +227,2 @@\n+        @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.PATTERN_MATCHING_IN_INSTANCEOF,\n+                                           reflective=true)\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/tree\/Tree.java","additions":2,"deletions":8,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -261,8 +261,0 @@\n-     * {@preview Associated with pattern matching for instanceof, a preview feature of\n-     *           the Java language.\n-     *\n-     *           This method is associated with <i>pattern matching for instanceof<\/i>, a preview\n-     *           feature of the Java language. Preview features\n-     *           may be removed in a future release, or upgraded to permanent\n-     *           features of the Java language.}\n-     *\n@@ -275,0 +267,2 @@\n+    @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.PATTERN_MATCHING_IN_INSTANCEOF,\n+                                       reflective=true)\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/source\/tree\/TreeVisitor.java","additions":2,"deletions":8,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -47,0 +47,1 @@\n+import javax.tools.StandardLocation;\n@@ -254,0 +255,3 @@\n+            \/\/when patching modules (esp. java.base), it may be impossible to\n+            \/\/clear the symbols read from the patch path:\n+            polluted |= get(JavaFileManager.class).hasLocation(StandardLocation.PATCH_MODULE_PATH);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/api\/JavacTaskPool.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -340,1 +340,1 @@\n-    public static final long PREVIEW_ESSENTIAL_API = 1L<<58; \/\/any Symbol kind\n+    public static final long PREVIEW_REFLECTIVE = 1L<<58; \/\/any Symbol kind\n@@ -511,1 +511,1 @@\n-        PREVIEW_ESSENTIAL_API(Flags.PREVIEW_ESSENTIAL_API),\n+        PREVIEW_REFLECTIVE(Flags.PREVIEW_REFLECTIVE),\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/Flags.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -45,0 +45,1 @@\n+import java.util.HashSet;\n@@ -46,0 +47,1 @@\n+import java.util.Set;\n@@ -47,0 +49,3 @@\n+import static com.sun.tools.javac.code.Flags.RECORD;\n+import static com.sun.tools.javac.code.Flags.SEALED;\n+import static com.sun.tools.javac.code.Flags.NON_SEALED;\n@@ -73,0 +78,1 @@\n+    private final Set<JavaFileObject> sourcesWithPreviewFeatures = new HashSet<>();\n@@ -93,0 +99,1 @@\n+        Source source = Source.instance(context);\n@@ -94,1 +101,1 @@\n-                new MandatoryWarningHandler(log, lint.isEnabled(LintCategory.PREVIEW), true, \"preview\", LintCategory.PREVIEW);\n+                new MandatoryWarningHandler(log, source, lint.isEnabled(LintCategory.PREVIEW), true, \"preview\", LintCategory.PREVIEW);\n@@ -131,0 +138,1 @@\n+            sourcesWithPreviewFeatures.add(log.currentSourceFile());\n@@ -144,2 +152,3 @@\n-        if (!lint.isSuppressed(LintCategory.PREVIEW)) {\n-            previewHandler.report(null,\n+        if (lint.isEnabled(LintCategory.PREVIEW)) {\n+            sourcesWithPreviewFeatures.add(log.currentSourceFile());\n+            log.mandatoryWarning(LintCategory.PREVIEW, null,\n@@ -150,0 +159,4 @@\n+    public void markUsesPreview(DiagnosticPosition pos) {\n+        sourcesWithPreviewFeatures.add(log.currentSourceFile());\n+    }\n+\n@@ -154,0 +167,4 @@\n+    public boolean usesPreview(JavaFileObject file) {\n+        return sourcesWithPreviewFeatures.contains(file);\n+    }\n+\n@@ -202,0 +219,13 @@\n+    \/**\n+     * Check whether the given symbol has been declared using\n+     * a preview language feature.\n+     *\n+     * @param sym Symbol to check\n+     * @return true iff sym has been declared using a preview language feature\n+     *\/\n+    public boolean declaredUsingPreviewFeature(Symbol sym) {\n+        return ((sym.flags() & RECORD) != 0 && isPreview(Feature.RECORDS)) ||\n+               ((sym.flags() & SEALED) != 0 && isPreview(Feature.SEALED_CLASSES)) ||\n+               ((sym.flags() & NON_SEALED) != 0 && isPreview(Feature.SEALED_CLASSES));\n+    }\n+\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/Preview.java","additions":33,"deletions":3,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -583,1 +583,1 @@\n-        previewFeatureType = enterClass(\"jdk.internal.PreviewFeature\");\n+        previewFeatureType = enterClass(\"jdk.internal.javac.PreviewFeature\");\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/Symtab.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -376,2 +376,2 @@\n-                if (isAttributeTrue(c.member(names.essentialAPI))) {\n-                    toAnnotate.flags_field |= Flags.PREVIEW_ESSENTIAL_API;\n+                if (isAttributeTrue(c.member(names.reflective))) {\n+                    toAnnotate.flags_field |= Flags.PREVIEW_REFLECTIVE;\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Annotate.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -4458,1 +4458,1 @@\n-                chk.checkPreview(tree.pos(), sym);\n+                chk.checkPreview(tree.pos(), env.info.scope.owner, sym);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Attr.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -151,1 +151,1 @@\n-        deprecationHandler = new MandatoryWarningHandler(log, verboseDeprecated,\n+        deprecationHandler = new MandatoryWarningHandler(log, null, verboseDeprecated,\n@@ -153,1 +153,1 @@\n-        removalHandler = new MandatoryWarningHandler(log, verboseRemoval,\n+        removalHandler = new MandatoryWarningHandler(log, null, verboseRemoval,\n@@ -155,1 +155,1 @@\n-        uncheckedHandler = new MandatoryWarningHandler(log, verboseUnchecked,\n+        uncheckedHandler = new MandatoryWarningHandler(log, null, verboseUnchecked,\n@@ -157,1 +157,1 @@\n-        sunApiHandler = new MandatoryWarningHandler(log, false,\n+        sunApiHandler = new MandatoryWarningHandler(log, null, false,\n@@ -242,1 +242,1 @@\n-    \/** Warn about deprecated symbol.\n+    \/** Log a preview warning.\n@@ -244,1 +244,1 @@\n-     *  @param sym        The deprecated symbol.\n+     *  @param msg        A Warning describing the problem.\n@@ -246,2 +246,3 @@\n-    void warnPreview(DiagnosticPosition pos, Symbol sym) {\n-        warnPreview(pos, Warnings.IsPreview(sym));\n+    public void warnPreviewAPI(DiagnosticPosition pos, Warning warnKey) {\n+        if (!lint.isSuppressed(LintCategory.PREVIEW))\n+            preview.reportPreviewWarning(pos, warnKey);\n@@ -254,1 +255,1 @@\n-    public void warnPreview(DiagnosticPosition pos, Warning warnKey) {\n+    public void warnDeclaredUsingPreview(DiagnosticPosition pos, Symbol sym) {\n@@ -256,1 +257,1 @@\n-            preview.reportPreviewWarning(pos, warnKey);\n+            preview.reportPreviewWarning(pos, Warnings.DeclaredUsingPreview(kindName(sym), sym));\n@@ -3540,4 +3541,9 @@\n-    void checkPreview(DiagnosticPosition pos, Symbol s) {\n-        if ((s.flags() & PREVIEW_API) != 0) {\n-            if ((s.flags() & PREVIEW_ESSENTIAL_API) != 0 && !preview.isEnabled()) {\n-                log.error(pos, Errors.IsPreview(s));\n+    void checkPreview(DiagnosticPosition pos, Symbol other, Symbol s) {\n+        if ((s.flags() & PREVIEW_API) != 0 && s.packge().modle != other.packge().modle) {\n+            if ((s.flags() & PREVIEW_REFLECTIVE) == 0) {\n+                if (!preview.isEnabled()) {\n+                    log.error(pos, Errors.IsPreview(s));\n+                } else {\n+                    preview.markUsesPreview(pos);\n+                    deferredLintHandler.report(() -> warnPreviewAPI(pos, Warnings.IsPreview(s)));\n+                }\n@@ -3545,1 +3551,10 @@\n-                deferredLintHandler.report(() -> warnPreview(pos, s));\n+                    deferredLintHandler.report(() -> warnPreviewAPI(pos, Warnings.IsPreviewReflective(s)));\n+            }\n+        }\n+        if (preview.declaredUsingPreviewFeature(s)) {\n+            if (preview.isEnabled()) {\n+                \/\/for preview disabled do presumably so not need to do anything?\n+                \/\/If \"s\" is compiled from source, then there was an error for it already;\n+                \/\/if \"s\" is from classfile, there already was an error for the classfile.\n+                preview.markUsesPreview(pos);\n+                deferredLintHandler.report(() -> warnDeclaredUsingPreview(pos, s));\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Check.java","additions":30,"deletions":15,"binary":false,"changes":45,"status":"modified"},{"patch":"@@ -1141,0 +1141,1 @@\n+                chk.checkPreview(tree.moduleName.pos(), msym, tree.directive.module);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Modules.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2863,1 +2863,1 @@\n-        chk.checkPreview(pos, sym);\n+        chk.checkPreview(pos, env.info.scope.owner, sym);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Resolve.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -117,0 +117,1 @@\n+    private final Preview preview;\n@@ -144,0 +145,1 @@\n+        preview = Preview.instance(context);\n@@ -1465,1 +1467,1 @@\n-                setFlagIfAttributeTrue(a, sym, names.essentialAPI, PREVIEW_ESSENTIAL_API);\n+                setFlagIfAttributeTrue(a, sym, names.reflective, Flags.PREVIEW_REFLECTIVE);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/TypeEnter.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1433,1 +1433,1 @@\n-                setFlagIfAttributeTrue(proxy, sym, names.essentialAPI, PREVIEW_ESSENTIAL_API);\n+                setFlagIfAttributeTrue(proxy, sym, names.reflective, PREVIEW_REFLECTIVE);\n@@ -1444,1 +1444,1 @@\n-                    setFlagIfAttributeTrue(proxy, sym, names.essentialAPI, PREVIEW_ESSENTIAL_API);\n+                    setFlagIfAttributeTrue(proxy, sym, names.reflective, PREVIEW_REFLECTIVE);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/jvm\/ClassReader.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1635,1 +1635,1 @@\n-        if (preview.isEnabled()) {\n+        if (preview.isEnabled() && preview.usesPreview(c.sourcefile)) {\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/jvm\/ClassWriter.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1634,1 +1634,1 @@\n-# 0: file name\n+# 0: file name, 1: source\n@@ -1636,1 +1636,1 @@\n-    {0} uses preview language features.\n+    {0} uses preview features of Java SE {1}.\n@@ -1638,0 +1638,1 @@\n+# 0: source\n@@ -1639,1 +1640,1 @@\n-    Some input files use preview language features.\n+    Some input files use preview features of Java SE {0}.\n@@ -1646,1 +1647,1 @@\n-# 0: file name\n+# 0: file name, 1: source\n@@ -1648,1 +1649,1 @@\n-    {0} has additional uses of preview language features.\n+    {0} has additional uses of preview features of Java SE {1}.\n@@ -1650,0 +1651,1 @@\n+# 0: source\n@@ -1651,1 +1653,1 @@\n-    Some input files additionally use preview language features.\n+    Some input files additionally use preview features of Java SE {0}.\n@@ -1785,1 +1787,1 @@\n-    {0} is an API that is part of a preview feature\n+    {0} is a preview API and may be removed in a future release.\n@@ -1789,1 +1791,6 @@\n-    {0} is an API that is part of a preview feature\n+    {0} is a preview API and is disabled by default.\\n\\\n+    (use --enable-preview to enable preview APIs)\n+\n+# 0: symbol\n+compiler.warn.is.preview.reflective=\\\n+    {0} is a reflective preview API and may be removed in a future release.\n@@ -2865,2 +2872,2 @@\n-   classfile for {0} uses preview features of Java SE {1}.\\n\\\n-   (use --enable-preview to allow loading of classfiles which contain preview features)\n+   class file for {0} uses preview features of Java SE {1}.\\n\\\n+   (use --enable-preview to allow loading of class files which contain preview features)\n@@ -2878,1 +2885,1 @@\n-   classfile for {0} uses preview features of Java SE {1}.\n+   class file for {0} uses preview features of Java SE {1}.\n@@ -3742,0 +3749,4 @@\n+\n+# 0: kind name, 1: symbol\n+compiler.warn.declared.using.preview=\\\n+    {0} {1} is declared using a preview feature, which may be removed in a future release.\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/resources\/compiler.properties","additions":22,"deletions":11,"binary":false,"changes":33,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+import com.sun.tools.javac.code.Source;\n@@ -114,1 +115,1 @@\n-    public MandatoryWarningHandler(Log log, boolean verbose,\n+    public MandatoryWarningHandler(Log log, Source source, boolean verbose,\n@@ -118,0 +119,1 @@\n+        this.source = source;\n@@ -176,4 +178,13 @@\n-            if (deferredDiagnosticArg == null)\n-                logMandatoryNote(deferredDiagnosticSource, deferredDiagnosticKind.getKey(prefix));\n-            else\n-                logMandatoryNote(deferredDiagnosticSource, deferredDiagnosticKind.getKey(prefix), deferredDiagnosticArg);\n+            if (deferredDiagnosticArg == null) {\n+                if (source != null) {\n+                    logMandatoryNote(deferredDiagnosticSource, deferredDiagnosticKind.getKey(prefix), source);\n+                } else {\n+                    logMandatoryNote(deferredDiagnosticSource, deferredDiagnosticKind.getKey(prefix));\n+                }\n+            } else {\n+                if (source != null) {\n+                    logMandatoryNote(deferredDiagnosticSource, deferredDiagnosticKind.getKey(prefix), deferredDiagnosticArg, source);\n+                } else {\n+                    logMandatoryNote(deferredDiagnosticSource, deferredDiagnosticKind.getKey(prefix), deferredDiagnosticArg);\n+                }\n+            }\n@@ -190,0 +201,1 @@\n+    private final Source source;\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/util\/MandatoryWarningHandler.java","additions":17,"deletions":5,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -89,1 +89,1 @@\n-    public final Name essentialAPI;\n+    public final Name reflective;\n@@ -262,1 +262,1 @@\n-        essentialAPI = fromString(\"essentialAPI\");\n+        reflective = fromString(\"reflective\");\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/util\/Names.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import java.util.Set;\n@@ -35,0 +36,1 @@\n+import com.sun.tools.javac.code.Source;\n@@ -163,0 +165,3 @@\n+        } else if (arg instanceof Source && arg == Source.DEFAULT &&\n+                CODES_NEEDING_SOURCE_NORMALIZATION.contains(diag.getCode())) {\n+            s = \"DEFAULT\";\n@@ -168,0 +173,3 @@\n+    \/\/where:\n+        private static final Set<String> CODES_NEEDING_SOURCE_NORMALIZATION = Set.of(\n+                \"compiler.note.preview.filename\", \"compiler.note.preview.plural\");\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/util\/RawDiagnosticFormatter.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -52,0 +52,1 @@\n+import static jdk.javadoc.internal.doclets.formats.html.LinkInfoImpl.Kind.MEMBER_DEPRECATED_PREVIEW;\n@@ -87,3 +88,3 @@\n-    protected Content getDeprecatedLink(Element member) {\n-        Content deprecatedLinkContent = new ContentBuilder();\n-        deprecatedLinkContent.add(utils.getFullyQualifiedName(member));\n+    protected Content getDeprecatedOrPreviewLink(Element member) {\n+        Content content = new ContentBuilder();\n+        content.add(utils.getFullyQualifiedName(member));\n@@ -91,2 +92,2 @@\n-            deprecatedLinkContent.add(\".\");\n-            deprecatedLinkContent.add(member.getSimpleName());\n+            content.add(\".\");\n+            content.add(member.getSimpleName());\n@@ -96,1 +97,1 @@\n-            deprecatedLinkContent.add(Entity.ZERO_WIDTH_SPACE);\n+            content.add(Entity.ZERO_WIDTH_SPACE);\n@@ -98,1 +99,1 @@\n-        deprecatedLinkContent.add(signature);\n+        content.add(signature);\n@@ -100,1 +101,1 @@\n-        return writer.getDocLink(MEMBER, utils.getEnclosingTypeElement(member), member, deprecatedLinkContent);\n+        return writer.getDocLink(MEMBER_DEPRECATED_PREVIEW, utils.getEnclosingTypeElement(member), member, content);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/AbstractExecutableMemberWriter.java","additions":9,"deletions":8,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -193,1 +193,1 @@\n-    protected abstract Content getDeprecatedLink(Element member);\n+    protected abstract Content getDeprecatedOrPreviewLink(Element member);\n@@ -286,0 +286,10 @@\n+    \/**\n+     * Add the preview information for the given member.\n+     *\n+     * @param member the member being documented.\n+     * @param contentTree the content tree to which the preview information will be added.\n+     *\/\n+    protected void addPreviewInfo(Element member, Content contentTree) {\n+        writer.addPreviewInfo(member, contentTree);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/AbstractMemberWriter.java","additions":11,"deletions":1,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+import java.util.Set;\n@@ -47,0 +48,1 @@\n+import jdk.javadoc.internal.doclets.toolkit.util.Utils.ElementFlag;\n@@ -166,1 +168,5 @@\n-        if (utils.isDeprecated(klass)) {\n+        Set<ElementFlag> flags = utils.elementFlags(klass);\n+        if (flags.contains(ElementFlag.PREVIEW)) {\n+            description.add(contents.previewPhrase);\n+            addSummaryComment(klass, description);\n+        } else if (flags.contains(ElementFlag.DEPRECATED)) {\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/AllClassesIndexWriter.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -127,0 +127,5 @@\n+    @Override\n+    public void addPreview(Element member, Content contentTree) {\n+        addPreviewInfo(member, contentTree);\n+    }\n+\n@@ -198,1 +203,1 @@\n-    protected Content getDeprecatedLink(Element member) {\n+    protected Content getDeprecatedOrPreviewLink(Element member) {\n@@ -200,1 +205,1 @@\n-        return writer.getDocLink(LinkInfoImpl.Kind.MEMBER, member, name);\n+        return writer.getDocLink(LinkInfoImpl.Kind.MEMBER_DEPRECATED_PREVIEW, member, name);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/AnnotationTypeRequiredMemberWriterImpl.java","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -435,1 +435,2 @@\n-                .label(resources.getText(\"doclet.Class\")));\n+                .label(resources.getText(\"doclet.Class\"))\n+                .skipPreview(true));\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/ClassUseWriter.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -45,0 +45,1 @@\n+import javax.lang.model.element.ElementKind;\n@@ -88,0 +89,3 @@\n+    private static final Set<String> previewModifiers\n+            = Set.of(\"sealed\", \"non-sealed\");\n+\n@@ -200,1 +204,17 @@\n-        pre.add(modifiers);\n+        String sep = null;\n+        for (String modifiersPart : modifiers.split(\" \")) {\n+            if (sep != null) {\n+                pre.add(sep);\n+            }\n+            if (previewModifiers.contains(modifiersPart)) {\n+                pre.add(modifiersPart);\n+                pre.add(new HtmlTree(TagName.SUP).add(links.createLink(getPreviewSectionAnchor(typeElement),\n+                                                      contents.previewMark)));\n+            } else {\n+                pre.add(modifiersPart);\n+            }\n+            sep = \" \";\n+        }\n+        if (modifiers.endsWith(\" \")) {\n+            pre.add(\" \");\n+        }\n@@ -262,1 +282,4 @@\n-                    pre.add(\"permits \");\n+                    pre.add(\"permits\");\n+                    pre.add(new HtmlTree(TagName.SUP).add(links.createLink(getPreviewSectionAnchor(typeElement),\n+                                                          contents.previewMark)));\n+                    pre.add(\" \");\n@@ -303,0 +326,1 @@\n+        addPreviewInfo(classInfoTree);\n@@ -311,0 +335,4 @@\n+    private void addPreviewInfo(Content classInfoTree) {\n+        addPreviewInfo(typeElement, classInfoTree);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/ClassWriterImpl.java","additions":30,"deletions":2,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -144,0 +144,5 @@\n+    @Override\n+    public void addPreview(ExecutableElement constructor, Content constructorDocTree) {\n+        addPreviewInfo(constructor, constructorDocTree);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/ConstructorWriterImpl.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -154,0 +154,4 @@\n+    public final Content previewAPI;\n+    public final Content previewLabel;\n+    public final Content previewMark;\n+    public final Content previewPhrase;\n@@ -288,0 +292,4 @@\n+        previewAPI = getContent(\"doclet.Preview_API\");\n+        previewLabel = getContent(\"doclet.Preview_Label\");\n+        previewMark = getContent(\"doclet.Preview_Mark\");\n+        previewPhrase = getContent(\"doclet.Preview\");\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/Contents.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -437,1 +437,1 @@\n-        return writer.getDeprecatedLink(e);\n+        return writer.getDeprecatedOrPreviewLink(e);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/DeprecatedListWriter.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -111,0 +111,5 @@\n+    @Override\n+    public void addPreview(VariableElement enumConstant, Content enumConstantsTree) {\n+        addPreviewInfo(enumConstant, enumConstantsTree);\n+    }\n+\n@@ -174,1 +179,1 @@\n-    protected Content getDeprecatedLink(Element member) {\n+    protected Content getDeprecatedOrPreviewLink(Element member) {\n@@ -176,1 +181,1 @@\n-        return writer.getDocLink(LinkInfoImpl.Kind.MEMBER, member, name);\n+        return writer.getDocLink(LinkInfoImpl.Kind.MEMBER_DEPRECATED_PREVIEW, member, name);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/EnumConstantWriterImpl.java","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -111,0 +111,5 @@\n+    @Override\n+    public void addPreview(VariableElement field, Content fieldTree) {\n+        addPreviewInfo(field, fieldTree);\n+    }\n+\n@@ -201,1 +206,1 @@\n-    protected Content getDeprecatedLink(Element member) {\n+    protected Content getDeprecatedOrPreviewLink(Element member) {\n@@ -203,1 +208,1 @@\n-        return writer.getDocLink(LinkInfoImpl.Kind.MEMBER, member, name);\n+        return writer.getDocLink(LinkInfoImpl.Kind.MEMBER_DEPRECATED_PREVIEW, member, name);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/FieldWriterImpl.java","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -246,0 +246,9 @@\n+        \/\/ Preview\n+        if (configuration.conditionalPages.contains(HtmlConfiguration.ConditionalPage.PREVIEW)) {\n+            section = newHelpSection(contents.previewAPI);\n+            Content previewBody = getContent(\"doclet.help.preview.body\",\n+                    links.createLink(DocPaths.PREVIEW_LIST, contents.previewAPI));\n+            section.add(HtmlTree.P(previewBody));\n+            contentTree.add(section);\n+        }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/HelpWriter.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -61,0 +61,1 @@\n+import jdk.javadoc.internal.doclets.toolkit.util.PreviewAPIListBuilder;\n@@ -121,0 +122,7 @@\n+    \/**\n+     * The collection of preview items, if any, to be displayed on the preview-list page,\n+     * or null if the page should not be generated.\n+     * The page will not be generated if there are no preview elements being documented.\n+     *\/\n+    protected PreviewAPIListBuilder previewAPIListBuilder;\n+\n@@ -137,1 +145,1 @@\n-        CONSTANT_VALUES, DEPRECATED, SERIALIZED_FORM, SYSTEM_PROPERTIES\n+        CONSTANT_VALUES, DEPRECATED, PREVIEW, SERIALIZED_FORM, SYSTEM_PROPERTIES\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/HtmlConfiguration.java","additions":9,"deletions":1,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -49,0 +49,1 @@\n+import jdk.javadoc.internal.doclets.toolkit.util.PreviewAPIListBuilder;\n@@ -130,0 +131,5 @@\n+        PreviewAPIListBuilder builder = new PreviewAPIListBuilder(configuration);\n+        if (!builder.isEmpty()) {\n+            configuration.previewAPIListBuilder = builder;\n+            configuration.conditionalPages.add(HtmlConfiguration.ConditionalPage.PREVIEW);\n+        }\n@@ -178,0 +184,4 @@\n+        if (configuration.conditionalPages.contains((HtmlConfiguration.ConditionalPage.PREVIEW))) {\n+            PreviewListWriter.generate(configuration);\n+        }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/HtmlDoclet.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -30,0 +30,1 @@\n+import java.util.EnumSet;\n@@ -31,0 +32,1 @@\n+import java.util.HashSet;\n@@ -107,1 +109,0 @@\n-import jdk.javadoc.internal.doclets.toolkit.util.Utils;\n@@ -109,0 +110,4 @@\n+import jdk.javadoc.internal.doclets.toolkit.util.Utils;\n+import jdk.javadoc.internal.doclets.toolkit.util.Utils.DeclarationPreviewLanguageFeatures;\n+import jdk.javadoc.internal.doclets.toolkit.util.Utils.ElementFlag;\n+import jdk.javadoc.internal.doclets.toolkit.util.Utils.PreviewSummary;\n@@ -635,0 +640,7 @@\n+        Set<ElementFlag> flags;\n+        if (packageElement != null) {\n+            flags = utils.elementFlags(packageElement);\n+        } else {\n+            flags = EnumSet.noneOf(ElementFlag.class);\n+        }\n+        DocLink targetLink = null;\n@@ -636,2 +648,1 @@\n-            return links.createLink(pathString(packageElement, DocPaths.PACKAGE_SUMMARY),\n-                    label);\n+            targetLink = new DocLink(pathString(packageElement, DocPaths.PACKAGE_SUMMARY));\n@@ -639,5 +650,10 @@\n-            DocLink crossPkgLink = getCrossPackageLink(packageElement);\n-            if (crossPkgLink != null) {\n-                return links.createLink(crossPkgLink, label);\n-            } else {\n-                return label;\n+            targetLink = getCrossPackageLink(packageElement);\n+        }\n+        if (targetLink != null) {\n+            if (flags.contains(ElementFlag.PREVIEW)) {\n+                return new ContentBuilder(\n+                    links.createLink(targetLink, label),\n+                    new HtmlTree(TagName.SUP)\n+                            .add(links.createLink(targetLink.withFragment(getPreviewSectionAnchor(packageElement)),\n+                                                  contents.previewMark))\n+                );\n@@ -645,0 +661,9 @@\n+            return links.createLink(targetLink, label);\n+        } else {\n+            if (flags.contains(ElementFlag.PREVIEW)) {\n+                return new ContentBuilder(\n+                    label,\n+                    new HtmlTree(TagName.SUP).add(contents.previewMark)\n+                );\n+            }\n+            return label;\n@@ -656,0 +681,2 @@\n+        Set<ElementFlag> flags = mdle != null ? utils.elementFlags(mdle)\n+                                              : EnumSet.noneOf(ElementFlag.class);\n@@ -657,3 +684,20 @@\n-        return (included)\n-                ? links.createLink(pathToRoot.resolve(docPaths.moduleSummary(mdle)), label, \"\", \"\")\n-                : label;\n+        if (included) {\n+            DocLink targetLink = new DocLink(pathToRoot.resolve(docPaths.moduleSummary(mdle)));\n+            Content link = links.createLink(targetLink, label, \"\", \"\");\n+            if (flags.contains(ElementFlag.PREVIEW) && label != contents.moduleLabel) {\n+                link = new ContentBuilder(\n+                        link,\n+                        new HtmlTree(TagName.SUP)\n+                                .add(links.createLink(targetLink.withFragment(getPreviewSectionAnchor(mdle)),\n+                                                      contents.previewMark))\n+                );\n+            }\n+            return link;\n+        }\n+        if (flags.contains(ElementFlag.PREVIEW)) {\n+            return new ContentBuilder(\n+                label,\n+                new HtmlTree(TagName.SUP).add(contents.previewMark)\n+            );\n+        }\n+        return label;\n@@ -956,0 +1000,1 @@\n+                .targetMember(element)\n@@ -963,0 +1008,1 @@\n+                .targetMember(element)\n@@ -988,1 +1034,2 @@\n-                .where(links.getAnchor(emd)));\n+                .where(links.getAnchor(emd))\n+                .targetMember(element));\n@@ -991,1 +1038,1 @@\n-                .label(label).where(links.getName(element.getSimpleName().toString())));\n+                .label(label).where(links.getName(element.getSimpleName().toString())).targetMember(element));\n@@ -1185,0 +1232,11 @@\n+    \/**\n+     * Adds the preview content.\n+     *\n+     * @param element the Element for which the summary will be generated\n+     * @param firstSentenceTags the first sentence tags for the doc\n+     * @param htmltree the documentation tree to which the summary will be added\n+     *\/\n+    public void addPreviewComment(Element element, List<? extends DocTree> firstSentenceTags, Content htmltree) {\n+        addCommentTags(element, firstSentenceTags, false, true, true, htmltree);\n+    }\n+\n@@ -1248,2 +1306,1 @@\n-        }\n-        else {\n+        } else {\n@@ -2154,0 +2211,155 @@\n+\n+    public void addPreviewSummary(Element forWhat, Content target) {\n+        if (utils.isPreviewAPI(forWhat)) {\n+            Content div = HtmlTree.DIV(HtmlStyle.block);\n+            div.add(HtmlTree.SPAN(HtmlStyle.previewLabel, contents.previewPhrase));\n+            target.add(div);\n+        }\n+    }\n+\n+    public void addPreviewInfo(Element forWhat, Content target) {\n+        if (utils.isPreviewAPI(forWhat)) {\n+            \/\/in Java platform:\n+            HtmlTree previewDiv = HtmlTree.DIV(HtmlStyle.previewBlock);\n+            previewDiv.setId(getPreviewSectionAnchor(forWhat));\n+            String name = (switch (forWhat.getKind()) {\n+                case PACKAGE, MODULE ->\n+                        ((QualifiedNameable) forWhat).getQualifiedName();\n+                case CONSTRUCTOR ->\n+                        ((TypeElement) forWhat.getEnclosingElement()).getSimpleName();\n+                default -> forWhat.getSimpleName();\n+            }).toString();\n+            Content nameCode = HtmlTree.CODE(new StringContent(name));\n+            boolean isReflectivePreview = utils.isReflectivePreviewAPI(forWhat);\n+            String leadingNoteKey =\n+                    !isReflectivePreview ? \"doclet.PreviewPlatformLeadingNote\"\n+                                         : \"doclet.ReflectivePreviewPlatformLeadingNote\";\n+            Content leadingNote = \n+                    contents.getContent(leadingNoteKey, nameCode);\n+            previewDiv.add(HtmlTree.SPAN(HtmlStyle.previewLabel,\n+                                         leadingNote));\n+            if (!isReflectivePreview) {\n+                Content note1 = contents.getContent(\"doclet.PreviewTrailingNote1\", nameCode);\n+                previewDiv.add(HtmlTree.DIV(HtmlStyle.previewComment, note1));\n+            }\n+            Content note2 = contents.getContent(\"doclet.PreviewTrailingNote2\", nameCode);\n+            previewDiv.add(HtmlTree.DIV(HtmlStyle.previewComment, note2));\n+            target.add(previewDiv);\n+        } else if (forWhat.getKind().isClass() || forWhat.getKind().isInterface()) {\n+            \/\/in custom code:\n+            List<Content> previewNotes = getPreviewNotes((TypeElement) forWhat);\n+            if (!previewNotes.isEmpty()) {\n+                Name name = forWhat.getSimpleName();\n+                Content nameCode = HtmlTree.CODE(new StringContent(name));\n+                HtmlTree previewDiv = HtmlTree.DIV(HtmlStyle.previewBlock);\n+                previewDiv.setId(getPreviewSectionAnchor(forWhat));\n+                Content leadingNote = contents.getContent(\"doclet.PreviewLeadingNote\", nameCode);\n+                previewDiv.add(HtmlTree.SPAN(HtmlStyle.previewLabel,\n+                                             leadingNote));\n+                HtmlTree ul = new HtmlTree(TagName.UL);\n+                ul.setStyle(HtmlStyle.previewComment);\n+                for (Content note : previewNotes) {\n+                    ul.add(HtmlTree.LI(note));\n+                }\n+                previewDiv.add(ul);\n+                Content note1 =\n+                        contents.getContent(\"doclet.PreviewTrailingNote1\",\n+                                            nameCode);\n+                previewDiv.add(HtmlTree.DIV(HtmlStyle.previewComment, note1));\n+                Content note2 =\n+                        contents.getContent(\"doclet.PreviewTrailingNote2\",\n+                                            name);\n+                previewDiv.add(HtmlTree.DIV(HtmlStyle.previewComment, note2));\n+                target.add(previewDiv);\n+            }\n+        }\n+    }\n+\n+    @SuppressWarnings(\"preview\")\n+    private List<Content> getPreviewNotes(TypeElement el) {\n+        String className = el.getSimpleName().toString();\n+        List<Content> result = new ArrayList<>();\n+        PreviewSummary previewAPITypes = utils.declaredUsingPreviewAPIs(el);\n+        Set<TypeElement> previewAPI = new HashSet<>(previewAPITypes.previewAPI);\n+        Set<TypeElement> reflectivePreviewAPI = new HashSet<>(previewAPITypes.reflectivePreviewAPI);\n+        Set<TypeElement> declaredUsingPreviewFeature = new HashSet<>(previewAPITypes.declaredUsingPreviewFeature);\n+        Set<DeclarationPreviewLanguageFeatures> previewLanguageFeatures = new HashSet<>();\n+        for (Element enclosed : el.getEnclosedElements()) {\n+            if (!utils.isIncluded(enclosed)) {\n+                continue;\n+            }\n+            if (!enclosed.getKind().isClass() && !enclosed.getKind().isInterface()) {\n+                PreviewSummary memberAPITypes = utils.declaredUsingPreviewAPIs(enclosed);\n+                declaredUsingPreviewFeature.addAll(memberAPITypes.declaredUsingPreviewFeature);\n+                previewAPI.addAll(memberAPITypes.previewAPI);\n+                reflectivePreviewAPI.addAll(memberAPITypes.reflectivePreviewAPI);\n+                previewLanguageFeatures.addAll(utils.previewLanguageFeaturesUsed(enclosed));\n+            } else if (!utils.previewLanguageFeaturesUsed(enclosed).isEmpty()) {\n+                declaredUsingPreviewFeature.add((TypeElement) enclosed);\n+            }\n+        }\n+        previewLanguageFeatures.addAll(utils.previewLanguageFeaturesUsed(el));\n+        if (!previewLanguageFeatures.isEmpty()) {\n+            if (previewLanguageFeatures.contains(DeclarationPreviewLanguageFeatures.SEALED_PERMITS)) {\n+                previewLanguageFeatures.remove(DeclarationPreviewLanguageFeatures.SEALED);\n+            }\n+            for (DeclarationPreviewLanguageFeatures feature : previewLanguageFeatures) {\n+                String featureDisplayName =\n+                        resources.getText(\"doclet.Declared_Using_Preview.\" + feature.name());\n+                result.add(withPreviewFeatures(\"doclet.Declared_Using_Preview\", className,\n+                                               featureDisplayName, feature.features));\n+            }\n+        }\n+        if (!declaredUsingPreviewFeature.isEmpty()) {\n+            result.add(withLinks(\"doclet.UsesDeclaredUsingPreview\", className, declaredUsingPreviewFeature));\n+        }\n+        if (!previewAPI.isEmpty()) {\n+            result.add(withLinks(\"doclet.PreviewAPI\", className, previewAPI));\n+        }\n+        if (!reflectivePreviewAPI.isEmpty()) {\n+            result.add(withLinks(\"doclet.ReflectivePreviewAPI\", className, reflectivePreviewAPI));\n+        }\n+        return result;\n+    }\n+\n+    private Content withPreviewFeatures(String key, String className, String featureName, List<String> features) {\n+        String[] sep = new String[] {\"\"};\n+        ContentBuilder featureCodes = new ContentBuilder();\n+        features.stream()\n+                .forEach(c -> {\n+                    featureCodes.add(sep[0]);\n+                    featureCodes.add(HtmlTree.CODE(new ContentBuilder().add(c)));\n+                    sep[0] = \", \";\n+                });\n+        return contents.getContent(key,\n+                                   HtmlTree.CODE(new StringContent(className)),\n+                                   new HtmlTree(TagName.EM).add(featureName),\n+                                   featureCodes);\n+    }\n+\n+    private Content withLinks(String key, String className, Set<TypeElement> elements) {\n+        String[] sep = new String[] {\"\"};\n+        ContentBuilder links = new ContentBuilder();\n+        elements.stream()\n+                .sorted((te1, te2) -> te1.getSimpleName().toString().compareTo(te2.getSimpleName().toString()))\n+                .distinct()\n+                .map(te -> getLink(new LinkInfoImpl(configuration, LinkInfoImpl.Kind.CLASS, te).label(HtmlTree.CODE(new StringContent(te.getSimpleName()))).skipPreview(true)))\n+                .forEach(c -> {\n+                    links.add(sep[0]);\n+                    links.add(c);\n+                    sep[0] = \", \";\n+                });\n+        return contents.getContent(key,\n+                                   HtmlTree.CODE(new StringContent(className)),\n+                                   links);\n+    }\n+\n+    public String getPreviewSectionAnchor(Element el) {\n+        return \"preview-\" + switch (el.getKind()) {\n+            case CONSTRUCTOR, METHOD ->\n+                links.getAnchor((ExecutableElement) el);\n+            case PACKAGE -> getPackageAnchorName((PackageElement) el);\n+            default -> utils.getFullyQualifiedName(el, false);\n+        };\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/HtmlDocletWriter.java","additions":227,"deletions":15,"binary":false,"changes":242,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import java.util.EnumSet;\n@@ -30,0 +31,1 @@\n+import java.util.Set;\n@@ -39,0 +41,2 @@\n+import jdk.javadoc.internal.doclets.formats.html.markup.HtmlTree;\n+import jdk.javadoc.internal.doclets.formats.html.markup.TagName;\n@@ -45,0 +49,1 @@\n+import jdk.javadoc.internal.doclets.toolkit.util.Utils.ElementFlag;\n@@ -81,1 +86,2 @@\n-        if (classLinkInfo.where == null || classLinkInfo.where.length() == 0) {\n+        boolean hasWhere = classLinkInfo.where != null && classLinkInfo.where.length() != 0;\n+        if (!hasWhere) {\n@@ -87,0 +93,14 @@\n+        Set<ElementFlag> flags;\n+        Element target;\n+        boolean showPreview = !classLinkInfo.skipPreview;\n+        if (!hasWhere && showPreview) {\n+            flags = utils.elementFlags(typeElement);\n+            target = typeElement;\n+        } else if ((classLinkInfo.context == LinkInfoImpl.Kind.SEE_TAG || classLinkInfo.context == LinkInfoImpl.Kind.MEMBER_DEPRECATED_PREVIEW) &&\n+                   classLinkInfo.targetMember != null && showPreview) {\n+            flags = utils.elementFlags(classLinkInfo.targetMember);\n+            target = classLinkInfo.targetMember;\n+        } else {\n+            flags = EnumSet.noneOf(ElementFlag.class);\n+            target = null;\n+        }\n@@ -100,0 +120,5 @@\n+                        if (flags.contains(ElementFlag.PREVIEW)) {\n+                            link.add(new HtmlTree(TagName.SUP).add(m_writer.links.createLink(\n+                                    filename.fragment(m_writer.getPreviewSectionAnchor(target)),\n+                                    m_writer.contents.previewMark)));\n+                        }\n@@ -112,0 +137,7 @@\n+                if (flags.contains(ElementFlag.PREVIEW)) {\n+                    link.add(new HtmlTree(TagName.SUP).add(m_writer.getCrossClassLink(\n+                        typeElement,\n+                        m_writer.getPreviewSectionAnchor(target),\n+                        m_writer.contents.previewMark,\n+                        false, false)));\n+                }\n@@ -120,0 +152,3 @@\n+        if (flags.contains(ElementFlag.PREVIEW)) {\n+            link.add(new HtmlTree(TagName.SUP).add(m_writer.contents.previewMark));\n+        }\n@@ -174,1 +209,1 @@\n-                ((LinkInfoImpl) linkInfo).getContext(), typeParam);\n+                ((LinkInfoImpl) linkInfo).getContext(), typeParam).skipPreview(true);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/LinkFactoryImpl.java","additions":37,"deletions":2,"binary":false,"changes":39,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import javax.lang.model.element.Element;\n@@ -60,0 +61,5 @@\n+        \/**\n+         * Indicate that the link appears in member documentation on the Deprecated or Preview page.\n+         *\/\n+        MEMBER_DEPRECATED_PREVIEW,\n+\n@@ -238,0 +244,5 @@\n+    \/**\n+     * The member this link points to (if any).\n+     *\/\n+    public Element targetMember;\n+\n@@ -338,1 +349,17 @@\n-     }\n+    }\n+\n+    \/**\n+     * Set the member this link points to (if any).\n+     *\/\n+    public LinkInfoImpl targetMember(Element el) {\n+        this.targetMember = el;\n+        return this;\n+    }\n+\n+    \/**\n+     * Set whether or not the preview flags should be skipped for this link.\n+     *\/\n+    public LinkInfoImpl skipPreview(boolean skipPreview) {\n+        this.skipPreview = skipPreview;\n+        return this;\n+    }\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/LinkInfoImpl.java","additions":28,"deletions":1,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import java.util.List;\n@@ -34,0 +35,1 @@\n+import javax.lang.model.type.DeclaredType;\n@@ -138,0 +140,5 @@\n+    @Override\n+    public void addPreview(ExecutableElement method, Content methodDocTree) {\n+        addPreviewInfo(method, methodDocTree);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/MethodWriterImpl.java","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import com.sun.source.doctree.DocTree;\n@@ -37,0 +38,2 @@\n+import jdk.javadoc.internal.doclets.formats.html.markup.HtmlTree;\n+import jdk.javadoc.internal.doclets.formats.html.markup.RawHtml;\n@@ -112,0 +115,1 @@\n+                        addPreviewSummary(mdle, summaryContent);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/ModuleIndexWriter.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -630,0 +630,1 @@\n+            addPreviewSummary(pkg, summary);\n@@ -824,0 +825,1 @@\n+        addPreviewInfo(mdle, moduleContentTree);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/ModuleWriterImpl.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -101,0 +101,1 @@\n+        PREVIEW,\n@@ -215,0 +216,1 @@\n+                addPreviewLink(tree);\n@@ -226,0 +228,1 @@\n+                addPreviewLink(tree);\n@@ -243,0 +246,1 @@\n+                addPreviewLink(tree);\n@@ -260,0 +264,1 @@\n+                addPreviewLink(tree);\n@@ -282,0 +287,1 @@\n+                addPreviewLink(tree);\n@@ -298,0 +304,1 @@\n+                addPreviewLink(tree);\n@@ -304,0 +311,1 @@\n+            case PREVIEW:\n@@ -316,0 +324,6 @@\n+                if (documentedPage == PageMode.PREVIEW) {\n+                    addActivePageLink(tree, contents.previewLabel,\n+                            configuration.conditionalPages.contains(HtmlConfiguration.ConditionalPage.DEPRECATED));\n+                } else {\n+                    addPreviewLink(tree);\n+                }\n@@ -339,0 +353,1 @@\n+                addPreviewLink(tree);\n@@ -350,0 +365,1 @@\n+                addPreviewLink(tree);\n@@ -872,0 +888,7 @@\n+    private void addPreviewLink(Content tree) {\n+        if (configuration.conditionalPages.contains(HtmlConfiguration.ConditionalPage.PREVIEW)) {\n+            tree.add(HtmlTree.LI(links.createLink(pathToRoot.resolve(DocPaths.PREVIEW_LIST),\n+                    contents.previewLabel, \"\", \"\")));\n+        }\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/Navigation.java","additions":23,"deletions":0,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -148,2 +148,2 @@\n-    protected Content getDeprecatedLink(Element member) {\n-        return writer.getQualifiedClassLink(LinkInfoImpl.Kind.MEMBER, member);\n+    protected Content getDeprecatedOrPreviewLink(Element member) {\n+        return writer.getQualifiedClassLink(LinkInfoImpl.Kind.MEMBER_DEPRECATED_PREVIEW, member);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/NestedClassWriterImpl.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -224,0 +224,1 @@\n+                addPreviewSummary(klass, description);\n@@ -241,0 +242,1 @@\n+        addPreviewInfo(packageElement, packageContentTree);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/PackageWriterImpl.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,405 @@\n+\/*\n+ * Copyright (c) 1997, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package jdk.javadoc.internal.doclets.formats.html;\n+\n+import jdk.javadoc.internal.doclets.formats.html.markup.Table;\n+import jdk.javadoc.internal.doclets.formats.html.markup.TableHeader;\n+\n+import java.util.EnumMap;\n+import java.util.List;\n+import java.util.SortedSet;\n+\n+import javax.lang.model.element.Element;\n+import javax.lang.model.element.ModuleElement;\n+import javax.lang.model.element.PackageElement;\n+\n+import com.sun.source.doctree.DocTree;\n+import javax.lang.model.element.ElementKind;\n+import jdk.javadoc.internal.doclets.formats.html.markup.ContentBuilder;\n+import jdk.javadoc.internal.doclets.formats.html.markup.HtmlStyle;\n+import jdk.javadoc.internal.doclets.formats.html.markup.TagName;\n+import jdk.javadoc.internal.doclets.formats.html.markup.HtmlTree;\n+import jdk.javadoc.internal.doclets.formats.html.Navigation.PageMode;\n+import jdk.javadoc.internal.doclets.formats.html.markup.StringContent;\n+import jdk.javadoc.internal.doclets.toolkit.Content;\n+import jdk.javadoc.internal.doclets.toolkit.util.DocFileIOException;\n+import jdk.javadoc.internal.doclets.toolkit.util.DocPath;\n+import jdk.javadoc.internal.doclets.toolkit.util.DocPaths;\n+import jdk.javadoc.internal.doclets.toolkit.util.PreviewAPIListBuilder;\n+import jdk.javadoc.internal.doclets.toolkit.util.PreviewAPIListBuilder.PreviewElementKind;\n+\n+\/**\n+ * Generate File to list all the preview elements with the\n+ * appropriate links.\n+ *\n+ *  <p><b>This is NOT part of any supported API.\n+ *  If you write code that depends on this, you do so at your own risk.\n+ *  This code and its internal interfaces are subject to change or\n+ *  deletion without notice.<\/b>\n+ *\n+ * @see java.util.List\n+ *\/\n+public class PreviewListWriter extends SubWriterHolderWriter {\n+\n+    private String getAnchorName(PreviewElementKind kind) {\n+        switch (kind) {\n+            case MODULE:\n+                return \"module\";\n+            case PACKAGE:\n+                return \"package\";\n+            case INTERFACE:\n+                return \"interface\";\n+            case CLASS:\n+                return \"class\";\n+            case ENUM:\n+                return \"enum\";\n+            case EXCEPTION:\n+                return \"exception\";\n+            case ERROR:\n+                return \"error\";\n+            case ANNOTATION_TYPE:\n+                return \"annotation.type\";\n+            case FIELD:\n+                return \"field\";\n+            case METHOD:\n+                return \"method\";\n+            case CONSTRUCTOR:\n+                return \"constructor\";\n+            case ENUM_CONSTANT:\n+                return \"enum.constant\";\n+            case ANNOTATION_TYPE_MEMBER:\n+                return \"annotation.type.member\";\n+            default:\n+                throw new AssertionError(\"unknown kind: \" + kind);\n+        }\n+    }\n+\n+    private String getHeadingKey(PreviewElementKind kind) {\n+        switch (kind) {\n+            case MODULE:\n+                return \"doclet.Modules\";\n+            case PACKAGE:\n+                return \"doclet.Packages\";\n+            case INTERFACE:\n+                return \"doclet.Interfaces\";\n+            case CLASS:\n+                return \"doclet.Classes\";\n+            case ENUM:\n+                return \"doclet.Enums\";\n+            case EXCEPTION:\n+                return \"doclet.Exceptions\";\n+            case ERROR:\n+                return \"doclet.Errors\";\n+            case ANNOTATION_TYPE:\n+                return \"doclet.Annotation_Types\";\n+            case FIELD:\n+                return \"doclet.Fields\";\n+            case METHOD:\n+                return \"doclet.Methods\";\n+            case CONSTRUCTOR:\n+                return \"doclet.Constructors\";\n+            case ENUM_CONSTANT:\n+                return \"doclet.Enum_Constants\";\n+            case ANNOTATION_TYPE_MEMBER:\n+                return \"doclet.Annotation_Type_Members\";\n+            default:\n+                throw new AssertionError(\"unknown kind: \" + kind);\n+        }\n+    }\n+\n+    private String getSummaryKey(PreviewElementKind kind) {\n+        switch (kind) {\n+            case MODULE:\n+                return \"doclet.modules\";\n+            case PACKAGE:\n+                return \"doclet.packages\";\n+            case INTERFACE:\n+                return \"doclet.interfaces\";\n+            case CLASS:\n+                return \"doclet.classes\";\n+            case ENUM:\n+                return \"doclet.enums\";\n+            case EXCEPTION:\n+                return \"doclet.exceptions\";\n+            case ERROR:\n+                return \"doclet.errors\";\n+            case ANNOTATION_TYPE:\n+                return \"doclet.annotation_types\";\n+            case FIELD:\n+                return \"doclet.fields\";\n+            case METHOD:\n+                return \"doclet.methods\";\n+            case CONSTRUCTOR:\n+                return \"doclet.constructors\";\n+            case ENUM_CONSTANT:\n+                return \"doclet.enum_constants\";\n+            case ANNOTATION_TYPE_MEMBER:\n+                return \"doclet.annotation_type_members\";\n+            default:\n+                throw new AssertionError(\"unknown kind: \" + kind);\n+        }\n+    }\n+\n+    private String getHeaderKey(PreviewElementKind kind) {\n+        switch (kind) {\n+            case MODULE:\n+                return \"doclet.Module\";\n+            case PACKAGE:\n+                return \"doclet.Package\";\n+            case INTERFACE:\n+                return \"doclet.Interface\";\n+            case CLASS:\n+                return \"doclet.Class\";\n+            case ENUM:\n+                return \"doclet.Enum\";\n+            case EXCEPTION:\n+                return \"doclet.Exceptions\";\n+            case ERROR:\n+                return \"doclet.Errors\";\n+            case ANNOTATION_TYPE:\n+                return \"doclet.AnnotationType\";\n+            case FIELD:\n+                return \"doclet.Field\";\n+            case METHOD:\n+                return \"doclet.Method\";\n+            case CONSTRUCTOR:\n+                return \"doclet.Constructor\";\n+            case ENUM_CONSTANT:\n+                return \"doclet.Enum_Constant\";\n+            case ANNOTATION_TYPE_MEMBER:\n+                return \"doclet.Annotation_Type_Member\";\n+            default:\n+                throw new AssertionError(\"unknown kind: \" + kind);\n+        }\n+    }\n+\n+    private EnumMap<PreviewElementKind, AbstractMemberWriter> writerMap;\n+\n+    private final Navigation navBar;\n+\n+    \/**\n+     * Constructor.\n+     *\n+     * @param configuration the configuration for this doclet\n+     * @param filename the file to be generated\n+     *\/\n+\n+    public PreviewListWriter(HtmlConfiguration configuration, DocPath filename) {\n+        super(configuration, filename);\n+        this.navBar = new Navigation(null, configuration, PageMode.PREVIEW, path);\n+        NestedClassWriterImpl classW = new NestedClassWriterImpl(this);\n+        writerMap = new EnumMap<>(PreviewElementKind.class);\n+        for (PreviewElementKind kind : PreviewElementKind.values()) {\n+           writerMap.put(kind, switch (kind) {\n+                case MODULE, PACKAGE, INTERFACE, CLASS, ENUM,\n+                     EXCEPTION, ERROR, ANNOTATION_TYPE -> classW;\n+                case FIELD -> new FieldWriterImpl(this);\n+                case METHOD -> new MethodWriterImpl(this);\n+                case CONSTRUCTOR -> new ConstructorWriterImpl(this);\n+                case ENUM_CONSTANT -> new EnumConstantWriterImpl(this);\n+                case ANNOTATION_TYPE_MEMBER -> new AnnotationTypeOptionalMemberWriterImpl(this, null);\n+            });\n+        }\n+    }\n+\n+    \/**\n+     * Get list of all the preview elements.\n+     * Then instantiate PreviewListWriter and generate File.\n+     *\n+     * @param configuration the current configuration of the doclet.\n+     * @throws DocFileIOException if there is a problem writing the preview list\n+     *\/\n+    public static void generate(HtmlConfiguration configuration) throws DocFileIOException {\n+        if (configuration.conditionalPages.contains(HtmlConfiguration.ConditionalPage.DEPRECATED)) {\n+            DocPath filename = DocPaths.PREVIEW_LIST;\n+            PreviewListWriter depr = new PreviewListWriter(configuration, filename);\n+            depr.generatePreviewListFile(\n+                   new PreviewAPIListBuilder(configuration));\n+        }\n+    }\n+\n+    \/**\n+     * Generate the preview API list.\n+     *\n+     * @param previewapi list of preview API built already.\n+     * @throws DocFileIOException if there is a problem writing the preview list\n+     *\/\n+    protected void generatePreviewListFile(PreviewAPIListBuilder previewapi)\n+            throws DocFileIOException {\n+        HtmlTree body = getHeader();\n+        bodyContents.addMainContent(getContentsList(previewapi));\n+        String memberTableSummary;\n+        Content content = new ContentBuilder();\n+        for (PreviewElementKind kind : PreviewElementKind.values()) {\n+            if (previewapi.hasDocumentation(kind)) {\n+                memberTableSummary = resources.getText(\"doclet.Member_Table_Summary\",\n+                        resources.getText(getHeadingKey(kind)),\n+                        resources.getText(getSummaryKey(kind)));\n+                TableHeader memberTableHeader = new TableHeader(\n+                        contents.getContent(getHeaderKey(kind)), contents.descriptionLabel);\n+                addPreviewAPI(previewapi.getSet(kind), getAnchorName(kind),\n+                            getHeadingKey(kind), memberTableSummary, memberTableHeader, content);\n+            }\n+        }\n+        bodyContents.addMainContent(content);\n+        HtmlTree htmlTree = HtmlTree.FOOTER();\n+        navBar.setUserFooter(getUserHeaderFooter(false));\n+        htmlTree.add(navBar.getContent(Navigation.Position.BOTTOM));\n+        addBottom(htmlTree);\n+        bodyContents.setFooter(htmlTree);\n+        String description = \"preview elements\";\n+        body.add(bodyContents);\n+        printHtmlDocument(null, description, body);\n+    }\n+\n+    \/**\n+     * Add the index link.\n+     *\n+     * @param builder the preview list builder\n+     * @param kind the kind of list being documented\n+     * @param contentTree the content tree to which the index link will be added\n+     *\/\n+    private void addIndexLink(PreviewAPIListBuilder builder,\n+            PreviewElementKind kind, Content contentTree) {\n+        if (builder.hasDocumentation(kind)) {\n+            Content li = HtmlTree.LI(links.createLink(getAnchorName(kind),\n+                    contents.getContent(getHeadingKey(kind))));\n+            contentTree.add(li);\n+        }\n+    }\n+\n+    \/**\n+     * Get the contents list.\n+     *\n+     * @param previewapi the preview list builder\n+     * @return a content tree for the contents list\n+     *\/\n+    public Content getContentsList(PreviewAPIListBuilder previewapi) {\n+        Content headContent = contents.previewAPI;\n+        Content heading = HtmlTree.HEADING_TITLE(Headings.PAGE_TITLE_HEADING,\n+                HtmlStyle.title, headContent);\n+        Content div = HtmlTree.DIV(HtmlStyle.header, heading);\n+        Content headingContent = contents.contentsHeading;\n+        div.add(HtmlTree.HEADING_TITLE(Headings.CONTENT_HEADING,\n+                headingContent));\n+        Content ul = new HtmlTree(TagName.UL);\n+        for (PreviewElementKind kind : PreviewElementKind.values()) {\n+            addIndexLink(previewapi, kind, ul);\n+        }\n+        div.add(ul);\n+        return div;\n+    }\n+\n+    \/**\n+     * Get the header for the preview API Listing.\n+     *\n+     * @return a content tree for the header\n+     *\/\n+    public HtmlTree getHeader() {\n+        String title = resources.getText(\"doclet.Window_Preview_List\");\n+        HtmlTree bodyTree = getBody(getWindowTitle(title));\n+        Content headerContent = new ContentBuilder();\n+        addTop(headerContent);\n+        navBar.setUserHeader(getUserHeaderFooter(true));\n+        headerContent.add(navBar.getContent(Navigation.Position.TOP));\n+        bodyContents.setHeader(headerContent);\n+        return bodyTree;\n+    }\n+\n+    \/**\n+     * Add preview information to the documentation tree\n+     *\n+     * @param previewList list of preview API elements\n+     * @param id the id attribute of the table\n+     * @param headingKey the caption for the preview table\n+     * @param tableSummary the summary for the preview table\n+     * @param tableHeader table headers for the preview table\n+     * @param contentTree the content tree to which the preview table will be added\n+     *\/\n+    protected void addPreviewAPI(SortedSet<Element> previewList, String id, String headingKey,\n+            String tableSummary, TableHeader tableHeader, Content contentTree) {\n+        if (previewList.size() > 0) {\n+            Content caption = contents.getContent(headingKey);\n+            Table table = new Table(HtmlStyle.summaryTable)\n+                    .setCaption(caption)\n+                    .setHeader(tableHeader)\n+                    .setId(id)\n+                    .setColumnStyles(HtmlStyle.colPreviewItemName, HtmlStyle.colLast);\n+            for (Element e : previewList) {\n+                Content link;\n+                switch (e.getKind()) {\n+                    case MODULE:\n+                        ModuleElement m = (ModuleElement) e;\n+                        link = getModuleLink(m, new StringContent(m.getQualifiedName()));\n+                        break;\n+                    case PACKAGE:\n+                        PackageElement pkg = (PackageElement) e;\n+                        link = getPackageLink(pkg, getPackageName(pkg));\n+                        break;\n+                    default:\n+                        link = getPreviewLink(e);\n+                }\n+                Content desc = new ContentBuilder();\n+                List<? extends DocTree> tags = utils.getFirstSentenceTrees(e);\n+                if (!tags.isEmpty()) {\n+                    addPreviewComment(e, tags, desc);\n+                } else {\n+                    desc.add(HtmlTree.EMPTY);\n+                }\n+                table.addRow(link, desc);\n+            }\n+            \/\/ note: singleton list\n+            contentTree.add(HtmlTree.UL(HtmlStyle.blockList, HtmlTree.LI(table)));\n+        }\n+    }\n+\n+    protected Content getPreviewLink(Element e) {\n+        AbstractMemberWriter writer;\n+        switch (e.getKind()) {\n+            case INTERFACE:\n+            case CLASS:\n+            case ENUM:\n+            case ANNOTATION_TYPE:\n+                writer = new NestedClassWriterImpl(this);\n+                break;\n+            case FIELD:\n+                writer = new FieldWriterImpl(this);\n+                break;\n+            case METHOD:\n+                writer = new MethodWriterImpl(this);\n+                break;\n+            case CONSTRUCTOR:\n+                writer = new ConstructorWriterImpl(this);\n+                break;\n+            case ENUM_CONSTANT:\n+                writer = new EnumConstantWriterImpl(this);\n+                break;\n+            default:\n+                writer = new AnnotationTypeOptionalMemberWriterImpl(this, null);\n+        }\n+        return writer.getDeprecatedOrPreviewLink(e);\n+    }\n+}\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/PreviewListWriter.java","additions":405,"deletions":0,"binary":false,"changes":405,"status":"added"},{"patch":"@@ -103,0 +103,4 @@\n+    @Override\n+    public void addPreview(ExecutableElement property, Content propertyDocTree) {\n+    }\n+\n@@ -217,2 +221,2 @@\n-    protected Content getDeprecatedLink(Element member) {\n-        return writer.getDocLink(LinkInfoImpl.Kind.MEMBER, member,\n+    protected Content getDeprecatedOrPreviewLink(Element member) {\n+        return writer.getDocLink(LinkInfoImpl.Kind.MEMBER_DEPRECATED_PREVIEW, member,\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/PropertyWriterImpl.java","additions":6,"deletions":2,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+import jdk.javadoc.internal.doclets.formats.html.markup.RawHtml;\n@@ -111,0 +112,1 @@\n+        addPreviewSummary(member, tdSummary);\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/SubWriterHolderWriter.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -81,0 +81,3 @@\n+    previewBlock,\n+    previewComment,\n+    previewLabel,\n@@ -446,0 +449,6 @@\n+    \/**\n+     * The class of the cells in a table column used to display the name\n+     * of a deprecated item.\n+     *\/\n+    colPreviewItemName,\n+\n@@ -672,0 +681,5 @@\n+    \/**\n+     * The class of the {@code body} element for the page listing any deprecated items.\n+     *\/\n+    previewListPage,\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/markup\/HtmlStyle.java","additions":14,"deletions":0,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -932,1 +932,1 @@\n-            case LABEL: case SMALL: case SPAN: case STRONG: case SUB:\n+            case LABEL: case SMALL: case SPAN: case STRONG: case SUB: case SUP:\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/markup\/HtmlTree.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -86,0 +86,1 @@\n+    SUP,\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/markup\/TagName.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -75,0 +75,1 @@\n+doclet.Window_Preview_List=Preview List\n@@ -96,0 +97,3 @@\n+doclet.Preview_API=Preview API\n+doclet.Preview_Label=Preview\n+doclet.Preview_Mark=PREVIEW\n@@ -195,0 +199,3 @@\n+doclet.help.preview.body=\\\n+    The {0} page lists all of the Preview APIs. \\\n+    Preview APIs may be removed in future implementations.\n@@ -273,0 +280,11 @@\n+doclet.PreviewLeadingNote={0} relies on preview features of the Java platform:\n+doclet.Declared_Using_Preview={0} is declared using {1}, a preview feature of the Java language ({2}).\n+doclet.PreviewAPI={0} refers to one or more preview APIs:  {1}.\n+doclet.ReflectivePreviewAPI={0} refers to one or more reflective preview APIs:  {1}.\n+doclet.UsesDeclaredUsingPreview={0} refers to one or more types which are declared using a preview feature of the Java language: {1}.\n+doclet.PreviewTrailingNote1=Programs can only use {0} when preview features are enabled.\n+doclet.PreviewTrailingNote2=Preview features may be removed in a future release, or upgraded to permanent features of the Java platform.\n+doclet.Declared_Using_Preview.SEALED=Sealed Classes\n+doclet.Declared_Using_Preview.SEALED_PERMITS=Sealed Classes\n+doclet.PreviewPlatformLeadingNote={0} is a preview API of the Java platform.\n+doclet.ReflectivePreviewPlatformLeadingNote={0} is a reflective preview API of the Java platform.\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/formats\/html\/resources\/standard.properties","additions":18,"deletions":0,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -95,0 +95,8 @@\n+    \/**\n+     * Add the preview output for the given member.\n+     *\n+     * @param member the member being documented\n+     * @param annotationDocTree content tree to which the preview information will be added\n+     *\/\n+    void addPreview(Element member, Content contentTree);\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/AnnotationTypeRequiredMemberWriter.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -73,0 +73,8 @@\n+    \/**\n+     * Add the preview output for the given member.\n+     *\n+     * @param member the member being documented\n+     * @param annotationDocTree content tree to which the preview information will be added\n+     *\/\n+    void addPreview(ExecutableElement member, Content contentTree);\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/ConstructorWriter.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -78,0 +78,8 @@\n+    \/**\n+     * Add the preview output for the given member.\n+     *\n+     * @param member the member being documented\n+     * @param annotationDocTree content tree to which the preview information will be added\n+     *\/\n+    void addPreview(VariableElement member, Content contentTree);\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/EnumConstantWriter.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -74,0 +74,8 @@\n+    \/**\n+     * Add the preview output for the given member.\n+     *\n+     * @param member the member being documented\n+     * @param annotationDocTree content tree to which the preview information will be added\n+     *\/\n+    void addPreview(VariableElement member, Content contentTree);\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/FieldWriter.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -74,0 +74,8 @@\n+    \/**\n+     * Add the preview output for the given member.\n+     *\n+     * @param member the member being documented\n+     * @param annotationDocTree content tree to which the preview information will be added\n+     *\/\n+    void addPreview(ExecutableElement member, Content contentTree);\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/MethodWriter.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -73,0 +73,8 @@\n+    \/**\n+     * Add the preview output for the given member.\n+     *\n+     * @param member the member being documented\n+     * @param annotationDocTree content tree to which the preview information will be added\n+     *\/\n+    void addPreview(ExecutableElement member, Content contentTree);\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/PropertyWriter.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -28,1 +28,0 @@\n-import java.util.ArrayList;\n@@ -31,1 +30,0 @@\n-import java.util.HashSet;\n@@ -34,1 +32,0 @@\n-import java.util.Set;\n@@ -51,2 +48,0 @@\n-import com.sun.source.tree.CompilationUnitTree;\n-import com.sun.source.util.JavacTask;\n@@ -54,1 +49,0 @@\n-import com.sun.tools.javac.api.BasicJavacTask;\n@@ -58,1 +52,0 @@\n-import com.sun.tools.javac.code.Source.Feature;\n@@ -69,1 +62,0 @@\n-import com.sun.tools.javac.model.JavacTypes;\n@@ -73,1 +65,0 @@\n-import jdk.javadoc.internal.doclint.DocLint;\n@@ -525,0 +516,11 @@\n+\n+    public boolean isPreviewAPI(Element el) {\n+        Symbol sym = (Symbol) el;\n+        return (sym.flags() & Flags.PREVIEW_API) != 0;\n+    }\n+\n+    public boolean isReflectivePreviewAPI(Element el) {\n+        Symbol sym = (Symbol) el;\n+        return (sym.flags() & Flags.PREVIEW_REFLECTIVE) != 0;\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/WorkArounds.java","additions":11,"deletions":9,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+import jdk.javadoc.internal.doclets.formats.html.AbstractMemberWriter;\n@@ -155,0 +156,1 @@\n+        buildPreviewInfo(annotationDocTree);\n@@ -177,0 +179,9 @@\n+    \/**\n+     * Build the preview information.\n+     *\n+     * @param annotationDocTree the content tree to which the documentation will be added\n+     *\/\n+    protected void buildPreviewInfo(Content annotationDocTree) {\n+        writer.addPreview(currentMember, annotationDocTree);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/builders\/AnnotationTypeRequiredMemberBuilder.java","additions":11,"deletions":0,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -135,0 +135,1 @@\n+                buildPreviewInfo(constructorDocTree);\n@@ -163,0 +164,9 @@\n+    \/**\n+     * Build the preview information.\n+     *\n+     * @param constructorDocTree the content tree to which the documentation will be added\n+     *\/\n+    protected void buildPreviewInfo(Content constructorDocTree) {\n+        writer.addDeprecated(currentConstructor, constructorDocTree);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/builders\/ConstructorBuilder.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -128,0 +128,1 @@\n+                buildPreviewInfo(enumConstantsTree);\n@@ -157,0 +158,9 @@\n+    \/**\n+     * Build the preview information.\n+     *\n+     * @param enumConstantsTree the content tree to which the documentation will be added\n+     *\/\n+    protected void buildPreviewInfo(Content enumConstantsTree) {\n+        writer.addPreview(currentElement, enumConstantsTree);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/builders\/EnumConstantBuilder.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -128,0 +128,1 @@\n+                buildPreviewInfo(fieldDocTree);\n@@ -156,0 +157,9 @@\n+    \/**\n+     * Build the preview information.\n+     *\n+     * @param fieldDocTree the content tree to which the documentation will be added\n+     *\/\n+    protected void buildPreviewInfo(Content fieldDocTree) {\n+        writer.addPreview(currentElement, fieldDocTree);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/builders\/FieldBuilder.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -126,0 +126,1 @@\n+                buildPreviewInfo(methodDocTree);\n@@ -154,0 +155,9 @@\n+    \/**\n+     * Build the preview information.\n+     *\n+     * @param methodDocTree the content tree to which the documentation will be added\n+     *\/\n+    protected void buildPreviewInfo(Content methodDocTree) {\n+        writer.addPreview(currentMethod, methodDocTree);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/builders\/MethodBuilder.java","additions":10,"deletions":0,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -155,0 +155,9 @@\n+    \/**\n+     * Build the preview information.\n+     *\n+     * @param propertyDocTree the content tree to which the documentation will be added\n+     *\/\n+    protected void buildPreviewInfo(Content propertyDocTree) {\n+        writer.addPreview(currentProperty, propertyDocTree);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/builders\/PropertyBuilder.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -211,0 +211,1 @@\n+doclet.Preview=Preview.\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/resources\/doclets.properties","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -442,1 +442,1 @@\n-.col-first, .col-second, .col-last, .col-constructor-name, .col-deprecated-item-name {\n+.col-first, .col-second, .col-last, .col-constructor-name, .col-deprecated-item-name, .col-preview-item-name {\n@@ -543,1 +543,1 @@\n-.package-hierarchy-label, .type-name-label, .type-name-link, .search-tag-link {\n+.package-hierarchy-label, .type-name-label, .type-name-link, .search-tag-link, .preview-label {\n@@ -546,1 +546,1 @@\n-.deprecation-comment, .help-footnote, .interface-name {\n+.deprecation-comment, .help-footnote, .interface-name, .preview-comment {\n@@ -560,0 +560,11 @@\n+.preview-block {\n+    font-size:14px;\n+    font-family:'DejaVu Serif', Georgia, \"Times New Roman\", Times, serif;\n+    border-style:solid;\n+    border-width:thin;\n+    border-radius:10px;\n+    padding:10px;\n+    margin-bottom:10px;\n+    margin-right:10px;\n+    display:inline-block;\n+}\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/resources\/stylesheet.css","additions":14,"deletions":3,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -127,1 +127,1 @@\n-    private Comparator<Element> deprecatedComparator = null;\n+    private Comparator<Element> summaryComparator = null;\n@@ -135,3 +135,3 @@\n-    public Comparator<Element> makeDeprecatedComparator() {\n-        if (deprecatedComparator == null) {\n-            deprecatedComparator = new ElementComparator() {\n+    public Comparator<Element> makeSummaryComparator() {\n+        if (summaryComparator == null) {\n+            summaryComparator = new ElementComparator() {\n@@ -153,1 +153,1 @@\n-        return deprecatedComparator;\n+        return summaryComparator;\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/util\/Comparators.java","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -81,1 +81,1 @@\n-                    new TreeSet<>(utils.comparators.makeDeprecatedComparator()));\n+                    new TreeSet<>(utils.comparators.makeSummaryComparator()));\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/util\/DeprecatedAPIListBuilder.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -105,0 +105,4 @@\n+    public DocLink withFragment(String fragment) {\n+        return new DocLink(path, fragment);\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/util\/DocLink.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -142,0 +142,3 @@\n+    \/** The name of the fie for preview elements. *\/\n+    public static final DocPath PREVIEW_LIST = DocPath.create(\"preview-list.html\");\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/util\/DocPaths.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -0,0 +1,188 @@\n+\/*\n+ * Copyright (c) 1998, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package jdk.javadoc.internal.doclets.toolkit.util;\n+\n+import java.util.*;\n+\n+import javax.lang.model.element.Element;\n+import javax.lang.model.element.ElementKind;\n+import javax.lang.model.element.ModuleElement;\n+import javax.lang.model.element.PackageElement;\n+import javax.lang.model.element.TypeElement;\n+\n+import jdk.javadoc.internal.doclets.toolkit.BaseConfiguration;\n+\n+\/**\n+ * Build list of all the preview packages, classes, constructors, fields and methods.\n+ *\n+ *  <p><b>This is NOT part of any supported API.\n+ *  If you write code that depends on this, you do so at your own risk.\n+ *  This code and its internal interfaces are subject to change or\n+ *  deletion without notice.<\/b>\n+ *\/\n+public class PreviewAPIListBuilder {\n+    \/**\n+     * List of preview type Lists.\n+     *\/\n+    private final Map<PreviewElementKind, SortedSet<Element>> previewMap;\n+    private final BaseConfiguration configuration;\n+    private final Utils utils;\n+    public enum PreviewElementKind {\n+        MODULE,\n+        PACKAGE,\n+        INTERFACE,\n+        CLASS,\n+        ENUM,\n+        EXCEPTION,              \/\/ no ElementKind mapping\n+        ERROR,                  \/\/ no ElementKind mapping\n+        ANNOTATION_TYPE,\n+        FIELD,\n+        METHOD,\n+        CONSTRUCTOR,\n+        ENUM_CONSTANT,\n+        ANNOTATION_TYPE_MEMBER \/\/ no ElementKind mapping\n+    };\n+    \/**\n+     * Constructor.\n+     *\n+     * @param configuration the current configuration of the doclet\n+     *\/\n+    public PreviewAPIListBuilder(BaseConfiguration configuration) {\n+        this.configuration = configuration;\n+        this.utils = configuration.utils;\n+        previewMap = new EnumMap<>(PreviewElementKind.class);\n+        for (PreviewElementKind kind : PreviewElementKind.values()) {\n+            previewMap.put(kind,\n+                    new TreeSet<>(utils.comparators.makeSummaryComparator()));\n+        }\n+        buildPreviewAPIInfo();\n+    }\n+\n+    public boolean isEmpty() {\n+        return previewMap.values().stream().allMatch(Set::isEmpty);\n+    }\n+\n+    \/**\n+     * Build the sorted list of all the preview APIs in this run.\n+     * Build separate lists for preview modules, packages, classes, constructors,\n+     * methods and fields.\n+     *\/\n+    private void buildPreviewAPIInfo() {\n+        SortedSet<ModuleElement> modules = configuration.modules;\n+        SortedSet<Element> mset = previewMap.get(PreviewElementKind.MODULE);\n+        for (Element me : modules) {\n+            if (utils.isPreviewAPI(me)) {\n+                mset.add(me);\n+            }\n+        }\n+        SortedSet<PackageElement> packages = configuration.packages;\n+        SortedSet<Element> pset = previewMap.get(PreviewElementKind.PACKAGE);\n+        for (Element pe : packages) {\n+            if (utils.isPreviewAPI(pe)) {\n+                pset.add(pe);\n+            }\n+        }\n+        for (Element e : configuration.getIncludedTypeElements()) {\n+            TypeElement te = (TypeElement)e;\n+            SortedSet<Element> eset;\n+            if (utils.isPreviewAPI(e)) {\n+                switch (e.getKind()) {\n+                    case ANNOTATION_TYPE:\n+                        eset = previewMap.get(PreviewElementKind.ANNOTATION_TYPE);\n+                        eset.add(e);\n+                        break;\n+                    case CLASS:\n+                        if (utils.isError(te)) {\n+                            eset = previewMap.get(PreviewElementKind.ERROR);\n+                        } else if (utils.isException(te)) {\n+                            eset = previewMap.get(PreviewElementKind.EXCEPTION);\n+                        } else {\n+                            eset = previewMap.get(PreviewElementKind.CLASS);\n+                        }\n+                        eset.add(e);\n+                        break;\n+                    case INTERFACE:\n+                        eset = previewMap.get(PreviewElementKind.INTERFACE);\n+                        eset.add(e);\n+                        break;\n+                    case ENUM:\n+                        eset = previewMap.get(PreviewElementKind.ENUM);\n+                        eset.add(e);\n+                        break;\n+                }\n+            }\n+            composePreviewList(previewMap.get(PreviewElementKind.FIELD),\n+                    utils.getFields(te));\n+            composePreviewList(previewMap.get(PreviewElementKind.METHOD),\n+                    utils.getMethods(te));\n+            composePreviewList(previewMap.get(PreviewElementKind.CONSTRUCTOR),\n+                    utils.getConstructors(te));\n+            if (utils.isEnum(e)) {\n+                composePreviewList(previewMap.get(PreviewElementKind.ENUM_CONSTANT),\n+                        utils.getEnumConstants(te));\n+            }\n+            if (utils.isAnnotationType(e)) {\n+                composePreviewList(previewMap.get(PreviewElementKind.ANNOTATION_TYPE_MEMBER),\n+                        utils.getAnnotationMembers(te));\n+\n+            }\n+        }\n+    }\n+\n+    \/**\n+     * Add the members into a single list of preview members.\n+     *\n+     * @param rset set of elements preview for removal.\n+     * @param sset set of preview elements.\n+     * @param members members to be added in the list.\n+     *\/\n+    private void composePreviewList(SortedSet<Element> sset, List<? extends Element> members) {\n+        for (Element member : members) {\n+            if (utils.isPreviewAPI(member)) {\n+                sset.add(member);\n+            }\n+        }\n+    }\n+\n+    \/**\n+     * Return the list of preview elements of a given type.\n+     *\n+     * @param kind the PreviewElementKind\n+     * @return\n+     *\/\n+    public SortedSet<Element> getSet(PreviewElementKind kind) {\n+        return previewMap.get(kind);\n+    }\n+\n+    \/**\n+     * Return true if the list of a given type has size greater than 0.\n+     *\n+     * @param kind the type of list being checked.\n+     *\/\n+    public boolean hasDocumentation(PreviewElementKind kind) {\n+        return !previewMap.get(kind).isEmpty();\n+    }\n+}\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/util\/PreviewAPIListBuilder.java","additions":188,"deletions":0,"binary":false,"changes":188,"status":"added"},{"patch":"@@ -102,0 +102,1 @@\n+import com.sun.source.doctree.UnknownInlineTagTree;\n@@ -122,0 +123,2 @@\n+import javax.lang.model.AnnotatedConstruct;\n+import javax.lang.model.util.SimpleAnnotationValueVisitor14;\n@@ -2927,0 +2930,252 @@\n+\n+    \/**\n+     * Return the set of preview language features used to declare the given element.\n+     *\n+     * @param e the Element to check.\n+     * @return the set of preview language features used to declare the given element\n+     *\/\n+    @SuppressWarnings(\"preview\")\n+    public Set<DeclarationPreviewLanguageFeatures> previewLanguageFeaturesUsed(Element e) {\n+        Set<DeclarationPreviewLanguageFeatures> result = new HashSet<>();\n+\n+        if ((e.getKind().isClass() || e.getKind().isInterface()) &&\n+            e.getModifiers().contains(Modifier.SEALED)) {\n+            List<? extends TypeMirror> permits = ((TypeElement) e).getPermittedSubclasses();\n+            boolean hasLinkablePermits = permits.stream()\n+                                                .anyMatch(t -> isLinkable(asTypeElement(t)));\n+            if (hasLinkablePermits) {\n+                result.add(DeclarationPreviewLanguageFeatures.SEALED_PERMITS);\n+            } else {\n+                result.add(DeclarationPreviewLanguageFeatures.SEALED);\n+            }\n+        }\n+\n+        return result;\n+    }\n+\n+    public enum DeclarationPreviewLanguageFeatures {\n+\n+        SEALED(List.of(\"sealed\")),\n+        SEALED_PERMITS(List.of(\"sealed\", \"permits\"));\n+        public final List<String> features;\n+\n+        private DeclarationPreviewLanguageFeatures(List<String> features) {\n+            this.features = features;\n+        }\n+\n+    }\n+\n+    @SuppressWarnings(\"preview\")\n+    public PreviewSummary declaredUsingPreviewAPIs(Element el) {\n+        List<TypeElement> usedInDeclaration = new ArrayList<>();\n+        usedInDeclaration.addAll(annotations2Classes(el));\n+        switch (el.getKind()) {\n+            case ANNOTATION_TYPE, CLASS, ENUM, INTERFACE, RECORD -> {\n+                TypeElement te = (TypeElement) el;\n+                for (TypeParameterElement tpe : te.getTypeParameters()) {\n+                    usedInDeclaration.addAll(types2Classes(tpe.getBounds()));\n+                }\n+                usedInDeclaration.addAll(types2Classes(List.of(te.getSuperclass())));\n+                usedInDeclaration.addAll(types2Classes(te.getInterfaces()));\n+                usedInDeclaration.addAll(types2Classes(te.getPermittedSubclasses()));\n+                usedInDeclaration.addAll(types2Classes(te.getRecordComponents().stream().map(c -> c.asType()).collect(Collectors.toList()))); \/\/TODO: annotations on record components???\n+            }\n+            case CONSTRUCTOR, METHOD -> {\n+                ExecutableElement ee = (ExecutableElement) el;\n+                for (TypeParameterElement tpe : ee.getTypeParameters()) {\n+                    usedInDeclaration.addAll(types2Classes(tpe.getBounds()));\n+                }\n+                usedInDeclaration.addAll(types2Classes(List.of(ee.getReturnType())));\n+                usedInDeclaration.addAll(types2Classes(List.of(ee.getReceiverType())));\n+                usedInDeclaration.addAll(types2Classes(ee.getThrownTypes()));\n+                usedInDeclaration.addAll(types2Classes(ee.getParameters().stream().map(p -> p.asType()).collect(Collectors.toList())));\n+                usedInDeclaration.addAll(annotationValue2Classes(ee.getDefaultValue()));\n+            }\n+            case FIELD, ENUM_CONSTANT, RECORD_COMPONENT -> {\n+                VariableElement ve = (VariableElement) el;\n+                usedInDeclaration.addAll(types2Classes(List.of(ve.asType())));\n+            }\n+            case MODULE, PACKAGE -> {\n+            }\n+            default -> throw new IllegalArgumentException(\"Unexpected: \" + el.getKind());\n+        }\n+\n+        Set<TypeElement> previewAPI = new HashSet<>();\n+        Set<TypeElement> reflectivePreviewAPI = new HashSet<>();\n+        Set<TypeElement> declaredUsingPreviewFeature = new HashSet<>();\n+\n+        for (TypeElement type : usedInDeclaration) {\n+            if (!isIncluded(type) && !configuration.extern.isExternal(type)) {\n+                continue;\n+            }\n+            if (isPreviewAPI(type)) {\n+                if (isReflectivePreviewAPI(type)) {\n+                    reflectivePreviewAPI.add(type);\n+                } else {\n+                    previewAPI.add(type);\n+                }\n+            }\n+            if (!previewLanguageFeaturesUsed(type).isEmpty()) {\n+                declaredUsingPreviewFeature.add(type);\n+            }\n+        }\n+\n+        return new PreviewSummary(previewAPI, reflectivePreviewAPI, declaredUsingPreviewFeature);\n+    }\n+\n+    private Collection<TypeElement> types2Classes(List<? extends TypeMirror> types) {\n+        List<TypeElement> result = new ArrayList<>();\n+        List<TypeMirror> todo = new ArrayList<>(types);\n+\n+        while (!todo.isEmpty()) {\n+            TypeMirror type = todo.remove(todo.size() - 1);\n+\n+            result.addAll(annotations2Classes(type));\n+\n+            if (type.getKind() == DECLARED) {\n+                DeclaredType dt = (DeclaredType) type;\n+                result.add((TypeElement) dt.asElement());\n+                todo.addAll(dt.getTypeArguments());\n+            }\n+        }\n+\n+        return result;\n+    }\n+\n+    private Collection<TypeElement> annotations2Classes(AnnotatedConstruct annotated) {\n+        List<TypeElement> result = new ArrayList<>();\n+\n+        for (AnnotationMirror am : annotated.getAnnotationMirrors()) {\n+            result.addAll(annotation2Classes(am));\n+        }\n+\n+        return result;\n+    }\n+\n+    private Collection<TypeElement> annotation2Classes(AnnotationMirror am) {\n+        List<TypeElement> result = new ArrayList<>();\n+\n+        result.addAll(types2Classes(List.of(am.getAnnotationType())));\n+        am.getElementValues()\n+          .values()\n+          .stream()\n+          .flatMap(av -> annotationValue2Classes(av).stream())\n+          .forEach(result::add);\n+\n+        return result;\n+    }\n+\n+    private Collection<TypeElement> annotationValue2Classes(AnnotationValue value) {\n+        if (value == null) {\n+            return List.of();\n+        }\n+\n+        List<TypeElement> result = new ArrayList<>();\n+\n+        value.accept(new SimpleAnnotationValueVisitor14<>() {\n+            @Override\n+            public Object visitArray(List<? extends AnnotationValue> vals, Object p) {\n+                vals.stream()\n+                    .forEach(v -> v.accept(this, null));\n+                return super.visitArray(vals, p);\n+            }\n+            @Override\n+            public Object visitAnnotation(AnnotationMirror a, Object p) {\n+                result.addAll(annotation2Classes(a));\n+                return super.visitAnnotation(a, p);\n+            }\n+\n+            @Override\n+            public Object visitType(TypeMirror t, Object p) {\n+                result.addAll(types2Classes(List.of(t)));\n+                return super.visitType(t, p);\n+            }\n+\n+        }, null);\n+\n+        return result;\n+    }\n+\n+    public static final class PreviewSummary {\n+        public final Set<TypeElement> previewAPI;\n+        public final Set<TypeElement> reflectivePreviewAPI;\n+        public final Set<TypeElement> declaredUsingPreviewFeature;\n+\n+        public PreviewSummary(Set<TypeElement> previewAPI, Set<TypeElement> reflectivePreviewAPI, Set<TypeElement> declaredUsingPreviewFeature) {\n+            this.previewAPI = previewAPI;\n+            this.reflectivePreviewAPI = reflectivePreviewAPI;\n+            this.declaredUsingPreviewFeature = declaredUsingPreviewFeature;\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return \"PreviewSummary{\" + \"previewAPI=\" + previewAPI + \", reflectivePreviewAPI=\" + reflectivePreviewAPI + \", declaredUsingPreviewFeature=\" + declaredUsingPreviewFeature + '}';\n+        }\n+\n+    }\n+\n+    \/**\n+     * Checks whether the given Element should be marked as a preview API.\n+     *\n+     * Note that if a type is marked as a preview, its members are not.\n+     *\n+     * @param el the element to check\n+     * @return true if and only if the given element should be marked as a preview API\n+     *\/\n+    public boolean isPreviewAPI(Element el) {\n+        boolean parentPreviewAPI = false;\n+        Element enclosing = el.getEnclosingElement();\n+        if (enclosing != null && (enclosing.getKind().isClass() || enclosing.getKind().isInterface())) {\n+            parentPreviewAPI = configuration.workArounds.isPreviewAPI(el.getEnclosingElement());\n+        }\n+        boolean previewAPI = configuration.workArounds.isPreviewAPI(el);\n+        return !parentPreviewAPI && previewAPI;\n+    }\n+\n+    \/**\n+     * Checks whether the given Element should be marked as a reflective preview API.\n+     *\n+     * Note that if a type is marked as a preview, its members are not.\n+     *\n+     * @param el the element to check\n+     * @return true if and only if the given element should be marked\n+     *              as a reflective preview API\n+     *\/\n+    public boolean isReflectivePreviewAPI(Element el) {\n+        return isPreviewAPI(el) && configuration.workArounds.isReflectivePreviewAPI(el);\n+    }\n+\n+    \/**\n+     * Return all flags for the given Element.\n+     *\n+     * @param el the element to test\n+     * @return the set of all the element's flags.\n+     *\/\n+    public Set<ElementFlag> elementFlags(Element el) {\n+        Set<ElementFlag> flags = EnumSet.noneOf(ElementFlag.class);\n+        PreviewSummary previewAPIs = declaredUsingPreviewAPIs(el);\n+\n+        if (isDeprecated(el)) {\n+            flags.add(ElementFlag.DEPRECATED);\n+        }\n+\n+        if (!previewLanguageFeaturesUsed(el).isEmpty() ||\n+            configuration.workArounds.isPreviewAPI(el) ||\n+            !previewAPIs.previewAPI.isEmpty() ||\n+            !previewAPIs.reflectivePreviewAPI.isEmpty() ||\n+            !previewAPIs.declaredUsingPreviewFeature.isEmpty())  {\n+            flags.add(ElementFlag.PREVIEW);\n+        }\n+\n+        return flags;\n+    }\n+\n+    \/**\n+     * An element can have flags that place it into some sub-categories, like\n+     * being a preview or a deprecated element.\n+     *\/\n+    public enum ElementFlag {\n+        DEPRECATED,\n+        PREVIEW;\n+    }\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/util\/Utils.java","additions":255,"deletions":0,"binary":false,"changes":255,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+import jdk.javadoc.internal.doclets.formats.html.LinkInfoImpl;\n@@ -142,0 +143,1 @@\n+                        linkInfo.skipPreview = true;\n@@ -207,0 +209,1 @@\n+        linkInfo.skipPreview = false;\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/util\/links\/LinkFactory.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -113,0 +113,5 @@\n+    \/**\n+     * True iff the preview flags should be skipped for this link.\n+     *\/\n+    public boolean skipPreview;\n+\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/doclets\/toolkit\/util\/links\/LinkInfo.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -1288,0 +1288,1 @@\n+                case RECORD_COMPONENT:\n","filename":"src\/jdk.javadoc\/share\/classes\/jdk\/javadoc\/internal\/tool\/ElementsTable.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -239,7 +239,0 @@\n-         * {@preview Associated with records, a preview feature of the Java language.\n-         *\n-         *           This enum constant is associated with <i>records<\/i>, a preview\n-         *           feature of the Java language. Preview features\n-         *           may be removed in a future release, or upgraded to permanent\n-         *           features of the Java language.}\n-         *\n@@ -252,1 +245,1 @@\n-        @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.RECORDS)\n+        @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.RECORDS)\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/jshell\/Snippet.java","additions":1,"deletions":8,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -59,1 +59,1 @@\n-                \"--enable-preview\", \"-source\", String.valueOf(Runtime.version().feature()) };\n+                \"--enable-preview\", \"-source\", String.valueOf(Runtime.version().feature()), \"-XDforcePreview\" };\n","filename":"test\/jdk\/java\/lang\/invoke\/defineHiddenClass\/PreviewHiddenClass.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -58,2 +58,1 @@\n- * @modules java.base\/jdk.internal\n- *          java.base\/jdk.internal.misc\n+ * @modules java.base\/jdk.internal.misc\n","filename":"test\/jdk\/java\/lang\/ref\/CleanerTest.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -30,1 +30,0 @@\n- *          java.base\/jdk.internal\n","filename":"test\/jdk\/java\/util\/Arrays\/TimSortStackSize2.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -77,1 +77,1 @@\n-               \"java.base\/jdk.internal\");\n+               \"java.base\/jdk.internal.javac\");\n","filename":"test\/jdk\/jdk\/modules\/etc\/JdkQualifiedExportTest.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -292,0 +292,1 @@\n+                \"--add-modules\", \"moduleC\",\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testModules\/TestModules.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -0,0 +1,89 @@\n+\/*\n+ * Copyright (c) 2003, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug      8250768\n+ * @summary  test generated docs for items declared using preview\n+ * @library  ..\/..\/lib\n+ * @modules jdk.javadoc\/jdk.javadoc.internal.tool\n+ *          jdk.javadoc\/jdk.javadoc.internal.doclets.formats.html.resources:+open\n+ * @build    javadoc.tester.*\n+ * @run main TestPreview\n+ *\/\n+\n+import java.nio.file.Paths;\n+import java.text.MessageFormat;\n+import java.util.ResourceBundle;\n+import javadoc.tester.JavadocTester;\n+\n+public class TestPreview extends JavadocTester {\n+\n+    public static void main(String... args) throws Exception {\n+        TestPreview tester = new TestPreview();\n+        tester.runTests();\n+    }\n+\n+    @Test\n+    public void test() {\n+        String doc = Paths.get(testSrc, \"doc\").toUri().toString();\n+        javadoc(\"-d\", \"out\",\n+                \"-XDforcePreview\", \"--enable-preview\", \"-source\", System.getProperty(\"java.specification.version\"),\n+                \"--patch-module\", \"java.base=\" + Paths.get(testSrc, \"api\").toAbsolutePath().toString(),\n+                \"--add-exports\", \"java.base\/preview=m\",\n+                \"--module-source-path\", testSrc,\n+                \"-linkoffline\", doc, doc,\n+                \"m\/pkg\");\n+        checkExit(Exit.OK);\n+\n+        ResourceBundle bundle = ResourceBundle.getBundle(\"jdk.javadoc.internal.doclets.formats.html.resources.standard\", ModuleLayer.boot().findModule(\"jdk.javadoc\").get());\n+\n+        {\n+            String zero = MessageFormat.format(bundle.getString(\"doclet.PreviewLeadingNote\"), \"<code>TestPreviewDeclaration<\/code>\");\n+            String one = MessageFormat.format(bundle.getString(\"doclet.Declared_Using_Preview\"), \"<code>TestPreviewDeclaration<\/code>\", \"<em>Sealed Classes<\/em>\", \"<code>sealed<\/code>\");\n+            String two = MessageFormat.format(bundle.getString(\"doclet.PreviewTrailingNote1\"), \"<code>TestPreviewDeclaration<\/code>\");\n+            String three = MessageFormat.format(bundle.getString(\"doclet.PreviewTrailingNote2\"), new Object[0]);\n+            String expectedTemplate = \"\"\"\n+                                      <div class=\"preview-block\" id=\"preview-pkg.TestPreviewDeclaration\"><span class=\"preview-label\">{0}<\/span>\n+                                      <ul class=\"preview-comment\">\n+                                      <li>{1}<\/li>\n+                                      <\/ul>\n+                                      <div class=\"preview-comment\">{2}<\/div>\n+                                      <div class=\"preview-comment\">{3}<\/div>\n+                                      <\/div>\"\"\";\n+            String expected = MessageFormat.format(expectedTemplate, zero, one, two, three);\n+            checkOutput(\"m\/pkg\/TestPreviewDeclaration.html\", true, expected);\n+        }\n+\n+        checkOutput(\"m\/pkg\/TestPreviewDeclarationUse.html\", true,\n+                    \"<code><a href=\\\"TestPreviewDeclaration.html\\\" title=\\\"interface in pkg\\\">TestPreviewDeclaration<\/a><sup><a href=\\\"TestPreviewDeclaration.html#preview-pkg.TestPreviewDeclaration\\\">PREVIEW<\/a><\/sup><\/code>\");\n+        checkOutput(\"m\/pkg\/TestPreviewAPIUse.html\", true,\n+                \"<a href=\\\"\" + doc + \"java.base\/preview\/Core.html\\\" title=\\\"class or interface in preview\\\" class=\\\"external-link\\\">Core<\/a><sup><a href=\\\"\" + doc + \"java.base\/preview\/Core.html#preview-preview.Core\\\" title=\\\"class or interface in preview\\\" class=\\\"external-link\\\">PREVIEW<\/a>\");\n+        checkOutput(\"m\/pkg\/DocAnnotation.html\", true,\n+                \"<div class=\\\"preview-block\\\" id=\\\"preview-pkg.DocAnnotation\\\"><span class=\\\"preview-label\\\">\");\n+        checkOutput(\"m\/pkg\/DocAnnotationUse1.html\", true,\n+                \"<div class=\\\"preview-block\\\" id=\\\"preview-pkg.DocAnnotationUse1\\\"><span class=\\\"preview-label\\\">\");\n+        checkOutput(\"m\/pkg\/DocAnnotationUse2.html\", true,\n+                \"<div class=\\\"preview-block\\\" id=\\\"preview-pkg.DocAnnotationUse2\\\"><span class=\\\"preview-label\\\">\");\n+    }\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/TestPreview.java","additions":89,"deletions":0,"binary":false,"changes":89,"status":"added"},{"patch":"@@ -0,0 +1,30 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package preview;\n+\n+import jdk.internal.javac.PreviewFeature;\n+import jdk.internal.javac.PreviewFeature.Feature;\n+\n+@PreviewFeature(feature=Feature.TEST)\n+public class Core {\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/api\/preview\/Core.java","additions":30,"deletions":0,"binary":false,"changes":30,"status":"added"},{"patch":"@@ -0,0 +1,30 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package preview;\n+\n+import jdk.internal.javac.PreviewFeature;\n+import jdk.internal.javac.PreviewFeature.Feature;\n+\n+@PreviewFeature(feature=Feature.TEST, reflective=true)\n+public class Reflective {\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/api\/preview\/Reflective.java","additions":30,"deletions":0,"binary":false,"changes":30,"status":"added"},{"patch":"@@ -0,0 +1,2 @@\n+module:java.base\n+preview\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/doc\/element-list","additions":2,"deletions":0,"binary":false,"changes":2,"status":"added"},{"patch":"","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/doc\/java.base\/preview\/Core.html","additions":0,"deletions":0,"binary":false,"changes":0,"previous_filename":"make\/langtools\/test\/TEST.ROOT","status":"copied"},{"patch":"","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/doc\/java.base\/preview\/Reflective.html","additions":0,"deletions":0,"binary":false,"changes":0,"previous_filename":"make\/langtools\/test\/TEST.ROOT","status":"copied"},{"patch":"@@ -0,0 +1,25 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+module m {\n+    exports pkg;\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/m\/module-info.java","additions":25,"deletions":0,"binary":false,"changes":25,"status":"added"},{"patch":"@@ -0,0 +1,35 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package pkg;\n+\n+import java.lang.annotation.Documented;\n+\n+@Documented\n+public @interface DocAnnotation {\n+\n+    public Class<?> a1() default Object.class;\n+    public Class<?>[] a2() default {};\n+    public Class<?> a3() default TestPreviewDeclaration.class;\n+\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/m\/pkg\/DocAnnotation.java","additions":35,"deletions":0,"binary":false,"changes":35,"status":"added"},{"patch":"@@ -0,0 +1,28 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package pkg;\n+\n+@DocAnnotation(a1=TestPreviewDeclaration.class)\n+public class DocAnnotationUse1 {\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/m\/pkg\/DocAnnotationUse1.java","additions":28,"deletions":0,"binary":false,"changes":28,"status":"added"},{"patch":"@@ -0,0 +1,28 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package pkg;\n+\n+@DocAnnotation(a2={TestPreviewDeclaration.class})\n+public class DocAnnotationUse2 {\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/m\/pkg\/DocAnnotationUse2.java","additions":28,"deletions":0,"binary":false,"changes":28,"status":"added"},{"patch":"@@ -0,0 +1,33 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package pkg;\n+\n+import preview.*;\n+\n+public class TestPreviewAPIUse {\n+\n+    public Core fieldCore;\n+    public Reflective fieldReflective;\n+\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/m\/pkg\/TestPreviewAPIUse.java","additions":33,"deletions":0,"binary":false,"changes":33,"status":"added"},{"patch":"@@ -0,0 +1,28 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package pkg;\n+\n+public sealed interface TestPreviewDeclaration permits Impl {\n+}\n+class Impl implements TestPreviewDeclaration {}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/m\/pkg\/TestPreviewDeclaration.java","additions":28,"deletions":0,"binary":false,"changes":28,"status":"added"},{"patch":"@@ -0,0 +1,30 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package pkg;\n+\n+public class TestPreviewDeclarationUse {\n+\n+    public TestPreviewDeclaration field;\n+\n+}\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testPreview\/m\/pkg\/TestPreviewDeclarationUse.java","additions":30,"deletions":0,"binary":false,"changes":30,"status":"added"},{"patch":"@@ -62,1 +62,1 @@\n-                \"public sealed class <span class=\\\"type-name-label\\\">A<\/span>\");\n+                \"public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">A<\/span>\");\n@@ -78,1 +78,1 @@\n-                \"public sealed interface <span class=\\\"type-name-label\\\">A<\/span>\");\n+                \"public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> interface <span class=\\\"type-name-label\\\">A<\/span>\");\n@@ -95,1 +95,1 @@\n-                \"public sealed class <span class=\\\"type-name-label\\\">A<\/span>\");\n+                \"public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">A<\/span>\");\n@@ -98,1 +98,1 @@\n-                \"public non-sealed class <span class=\\\"type-name-label\\\">B<\/span>\");\n+                \"public non-sealed<sup><a href=\\\"#preview-p.B\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">B<\/span>\");\n@@ -115,1 +115,1 @@\n-                \"public sealed interface <span class=\\\"type-name-label\\\">A<\/span>\");\n+                \"public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> interface <span class=\\\"type-name-label\\\">A<\/span>\");\n@@ -118,1 +118,1 @@\n-                \"public non-sealed interface <span class=\\\"type-name-label\\\">B<\/span>\");\n+                \"public non-sealed<sup><a href=\\\"#preview-p.B\\\">PREVIEW<\/a><\/sup> interface <span class=\\\"type-name-label\\\">B<\/span>\");\n@@ -135,1 +135,1 @@\n-                \"public sealed class <span class=\\\"type-name-label\\\">A<\/span>\");\n+                \"public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">A<\/span>\");\n@@ -138,1 +138,1 @@\n-                \"public abstract sealed class <span class=\\\"type-name-label\\\">B<\/span>\");\n+                \"public abstract sealed<sup><a href=\\\"#preview-p.B\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">B<\/span>\");\n@@ -155,1 +155,1 @@\n-                \"public sealed interface <span class=\\\"type-name-label\\\">A<\/span>\");\n+                \"public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> interface <span class=\\\"type-name-label\\\">A<\/span>\");\n@@ -158,1 +158,1 @@\n-                \"public sealed interface <span class=\\\"type-name-label\\\">B<\/span>\");\n+                \"public sealed<sup><a href=\\\"#preview-p.B\\\">PREVIEW<\/a><\/sup> interface <span class=\\\"type-name-label\\\">B<\/span>\");\n@@ -176,1 +176,1 @@\n-                \"<pre>public sealed class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n+                \"<pre>public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n@@ -178,1 +178,1 @@\n-                + \"permits <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a><\/pre>\");\n+                + \"permits<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a><sup><a href=\\\"B.html#preview-p.B\\\">PREVIEW<\/a><\/sup><\/pre>\");\n@@ -198,1 +198,1 @@\n-                \"<pre>public sealed class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n+                \"<pre>public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n@@ -200,3 +200,3 @@\n-                + \"permits <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a>, \"\n-                + \"<a href=\\\"C.html\\\" title=\\\"class in p\\\">C<\/a>, \"\n-                + \"<a href=\\\"D.html\\\" title=\\\"class in p\\\">D<\/a><\/pre>\");\n+                + \"permits<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a><sup><a href=\\\"B.html#preview-p.B\\\">PREVIEW<\/a><\/sup>, \"\n+                + \"<a href=\\\"C.html\\\" title=\\\"class in p\\\">C<\/a><sup><a href=\\\"C.html#preview-p.C\\\">PREVIEW<\/a><\/sup>, \"\n+                + \"<a href=\\\"D.html\\\" title=\\\"class in p\\\">D<\/a><sup><a href=\\\"D.html#preview-p.D\\\">PREVIEW<\/a><\/sup><\/pre>\");\n@@ -222,1 +222,1 @@\n-                \"<pre>public sealed class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n+                \"<pre>public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n@@ -224,2 +224,2 @@\n-                + \"permits <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a>, \"\n-                + \"<a href=\\\"C.html\\\" title=\\\"class in p\\\">C<\/a> \"\n+                + \"permits<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a><sup><a href=\\\"B.html#preview-p.B\\\">PREVIEW<\/a><\/sup>, \"\n+                + \"<a href=\\\"C.html\\\" title=\\\"class in p\\\">C<\/a><sup><a href=\\\"C.html#preview-p.C\\\">PREVIEW<\/a><\/sup> \"\n@@ -247,1 +247,1 @@\n-                \"<pre>public sealed class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n+                \"<pre>public sealed<sup><a href=\\\"#preview\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n@@ -249,2 +249,2 @@\n-                + \"permits <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a>, \"\n-                + \"<a href=\\\"C.html\\\" title=\\\"class in p\\\">C<\/a>, p.D<\/pre>\");\n+                + \"permits<sup><a href=\\\"#preview\\\">PREVIEW<\/a><\/sup> <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a><sup><a href=\\\"B.html#preview\\\">PREVIEW<\/a><\/sup>, \"\n+                + \"<a href=\\\"C.html\\\" title=\\\"class in p\\\">C<\/a><sup><a href=\\\"C.html#preview\\\">PREVIEW<\/a><\/sup>, p.D<\/pre>\");\n@@ -272,1 +272,1 @@\n-                \"<pre>public sealed class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n+                \"<pre>public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n@@ -274,2 +274,2 @@\n-                + \"permits <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a>, \"\n-                + \"<a href=\\\"C.html\\\" title=\\\"class in p\\\">C<\/a> \"\n+                + \"permits<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a><sup><a href=\\\"B.html#preview-p.B\\\">PREVIEW<\/a><\/sup>, \"\n+                + \"<a href=\\\"C.html\\\" title=\\\"class in p\\\">C<\/a><sup><a href=\\\"C.html#preview-p.C\\\">PREVIEW<\/a><\/sup> \"\n@@ -297,1 +297,1 @@\n-                \"<pre>public sealed class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n+                \"<pre>public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n@@ -299,3 +299,3 @@\n-                + \"permits <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a>, \"\n-                + \"<a href=\\\"C.html\\\" title=\\\"class in p\\\">C<\/a>, \"\n-                + \"<a href=\\\"D.html\\\" title=\\\"class in p\\\">D<\/a><\/pre>\");\n+                + \"permits<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> <a href=\\\"B.html\\\" title=\\\"class in p\\\">B<\/a><sup><a href=\\\"B.html#preview-p.B\\\">PREVIEW<\/a><\/sup>, \"\n+                + \"<a href=\\\"C.html\\\" title=\\\"class in p\\\">C<\/a><sup><a href=\\\"C.html#preview-p.C\\\">PREVIEW<\/a><\/sup>, \"\n+                + \"<a href=\\\"D.html\\\" title=\\\"class in p\\\">D<\/a><sup><a href=\\\"D.html#preview-p.D\\\">PREVIEW<\/a><\/sup><\/pre>\");\n@@ -322,1 +322,1 @@\n-                \"<pre>public sealed class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n+                \"<pre>public sealed<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> class <span class=\\\"type-name-label\\\">A<\/span>\\n\"\n@@ -324,3 +324,3 @@\n-                + \"permits <a href=\\\"A.B.html\\\" title=\\\"class in p\\\">A.B<\/a>, \"\n-                + \"<a href=\\\"A.C.html\\\" title=\\\"class in p\\\">A.C<\/a>, \"\n-                + \"<a href=\\\"A.D.html\\\" title=\\\"class in p\\\">A.D<\/a><\/pre>\");\n+                + \"permits<sup><a href=\\\"#preview-p.A\\\">PREVIEW<\/a><\/sup> <a href=\\\"A.B.html\\\" title=\\\"class in p\\\">A.B<\/a><sup><a href=\\\"A.B.html#preview-p.A.B\\\">PREVIEW<\/a><\/sup>, \"\n+                + \"<a href=\\\"A.C.html\\\" title=\\\"class in p\\\">A.C<\/a><sup><a href=\\\"A.C.html#preview-p.A.C\\\">PREVIEW<\/a><\/sup>, \"\n+                + \"<a href=\\\"A.D.html\\\" title=\\\"class in p\\\">A.D<\/a><sup><a href=\\\"A.D.html#preview-p.A.D\\\">PREVIEW<\/a><\/sup><\/pre>\");\n","filename":"test\/langtools\/jdk\/javadoc\/doclet\/testSealedTypes\/TestSealedTypes.java","additions":33,"deletions":33,"binary":false,"changes":66,"status":"modified"},{"patch":"@@ -152,0 +152,3 @@\n+            \/\/ ignore this partial key\n+            if (rk.startsWith(\"doclet.Declared_Using_Preview.\"))\n+                continue;\n","filename":"test\/langtools\/jdk\/javadoc\/tool\/CheckResourceKeys.java","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -118,0 +118,1 @@\n+compiler.warn.is.preview.reflective                     # difficult to produce reliably despite future changes to java.base\n","filename":"test\/langtools\/tools\/javac\/diags\/examples.not-yet.txt","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -25,1 +25,1 @@\n-\/\/ key: compiler.note.preview.filename\n+\/\/ key: compiler.note.preview.plural\n","filename":"test\/langtools\/tools\/javac\/diags\/examples\/CantExtendSealedInAnotherModule\/CantExtendSealedInAnotherModule.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -25,1 +25,1 @@\n-\/\/ key: compiler.note.preview.filename\n+\/\/ key: compiler.note.preview.plural\n","filename":"test\/langtools\/tools\/javac\/diags\/examples\/CantExtendSealedInAnotherPkg\/CantExtendSealedInAnotherPkg.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+\/\/ key: compiler.warn.declared.using.preview\n","filename":"test\/langtools\/tools\/javac\/diags\/examples\/SealedTypes.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -0,0 +1,4 @@\n+FauxEnum3.java:11:14: compiler.err.enum.types.not.extensible\n+- compiler.note.preview.filename: FauxEnum3.java, DEFAULT\n+- compiler.note.preview.recompile\n+1 error\n\\ No newline at end of file\n","filename":"test\/langtools\/tools\/javac\/enum\/FauxEnum3-preview.out","additions":4,"deletions":0,"binary":false,"changes":4,"status":"added"},{"patch":"@@ -216,0 +216,4 @@\n+    public List<JavaFileObject> getSources() {\n+        return sources;\n+    }\n+\n","filename":"test\/langtools\/tools\/javac\/lib\/combo\/ComboTask.java","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -197,1 +197,1 @@\n-            for (String pack : new String[] {\"\", \"java.lang\", \"java.lang.annotation\", \"jdk.internal\"}) {\n+            for (String pack : new String[] {\"\", \"java.lang\", \"java.lang.annotation\", \"jdk.internal.javac\"}) {\n","filename":"test\/langtools\/tools\/javac\/options\/BCPOrSystemNotSpecified.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -7,1 +7,1 @@\n-- compiler.note.preview.filename: BindingsExistTest.java\n+- compiler.note.preview.filename: BindingsExistTest.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/BindingsExistTest.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -10,1 +10,1 @@\n-- compiler.note.preview.filename: BindingsTest1Merging.java\n+- compiler.note.preview.filename: BindingsTest1Merging.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/BindingsTest1Merging.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -52,1 +52,1 @@\n-- compiler.note.preview.filename: BindingsTest2.java\n+- compiler.note.preview.filename: BindingsTest2.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/BindingsTest2.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -30,1 +30,0 @@\n- *      java.base\/jdk.internal\n","filename":"test\/langtools\/tools\/javac\/patterns\/BreakAndLoops.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-- compiler.note.preview.filename: CastConversionMatch.java\n+- compiler.note.preview.filename: CastConversionMatch.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/CastConversionMatch.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -30,1 +30,0 @@\n- *      java.base\/jdk.internal\n","filename":"test\/langtools\/tools\/javac\/patterns\/ConditionalTest.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -25,1 +25,1 @@\n-- compiler.note.preview.filename: DuplicateBindingTest.java\n+- compiler.note.preview.filename: DuplicateBindingTest.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/DuplicateBindingTest.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-- compiler.note.preview.filename: EnsureTypesOrderTest.java\n+- compiler.note.preview.filename: EnsureTypesOrderTest.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/EnsureTypesOrderTest.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -3,1 +3,1 @@\n-- compiler.note.preview.filename: ImpossibleTypeTest.java\n+- compiler.note.preview.filename: ImpossibleTypeTest.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/ImpossibleTypeTest.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -14,1 +14,1 @@\n-- compiler.note.preview.filename: MatchBindingScopeTest.java\n+- compiler.note.preview.filename: MatchBindingScopeTest.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/MatchBindingScopeTest.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -13,1 +13,1 @@\n-- compiler.note.preview.filename: PatternMatchPosTestData.java\n+- compiler.note.preview.filename: PatternMatchPosTestData.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/PatternMatchPosTest.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-- compiler.note.preview.filename: PatternVariablesAreFinal.java\n+- compiler.note.preview.filename: PatternVariablesAreFinal.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/PatternVariablesAreFinal.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -5,1 +5,1 @@\n-- compiler.note.preview.filename: Reifiable.java\n+- compiler.note.preview.filename: Reifiable.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/Reifiable.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -5,1 +5,1 @@\n-- compiler.note.preview.filename: ReifiableOld.java\n+- compiler.note.preview.filename: ReifiableOld.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/ReifiableOld.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-- compiler.note.preview.filename: UncheckedWarningOnMatchesTest.java\n+- compiler.note.preview.filename: UncheckedWarningOnMatchesTest.java, DEFAULT\n","filename":"test\/langtools\/tools\/javac\/patterns\/UncheckedWarningOnMatchesTest.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-PreviewAPIsWithRelease.java:13:22: compiler.warn.is.preview: RECORD\n+PreviewAPIsWithRelease.java:13:22: compiler.warn.is.preview.reflective: RECORD\n","filename":"test\/langtools\/tools\/javac\/platform\/PreviewAPIsWithRelease.out","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -0,0 +1,5 @@\n+- compiler.warn.preview.feature.use.classfile: DeclaredUsingPreviewDeclarations.class, 16\n+- compiler.warn.preview.feature.use.classfile: DeclaredUsingPreviewDeclarations$C.class, 16\n+- compiler.warn.preview.feature.use.classfile: DeclaredUsingPreviewDeclarations$C2.class, 16\n+DeclaredUsingPreview.java:9:37: compiler.warn.declared.using.preview: kindname.class, DeclaredUsingPreviewDeclarations.C\n+4 warnings\n","filename":"test\/langtools\/tools\/javac\/preview\/DeclaredUsingPreview-class.out","additions":5,"deletions":0,"binary":false,"changes":5,"status":"added"},{"patch":"@@ -0,0 +1,7 @@\n+DeclaredUsingPreviewDeclarations.java:3:5: compiler.warn.preview.feature.use.plural: (compiler.misc.feature.sealed.classes)\n+DeclaredUsingPreviewDeclarations.java:3:5: compiler.warn.preview.feature.use.plural: (compiler.misc.feature.sealed.classes)\n+DeclaredUsingPreviewDeclarations.java:4:5: compiler.warn.preview.feature.use.plural: (compiler.misc.feature.sealed.classes)\n+DeclaredUsingPreview.java:9:37: compiler.warn.declared.using.preview: kindname.class, DeclaredUsingPreviewDeclarations.C\n+DeclaredUsingPreview.java:10:37: compiler.warn.declared.using.preview: kindname.class, DeclaredUsingPreviewDeclarations.C2\n+DeclaredUsingPreviewDeclarations.java:4:33: compiler.warn.declared.using.preview: kindname.class, DeclaredUsingPreviewDeclarations.C\n+6 warnings\n","filename":"test\/langtools\/tools\/javac\/preview\/DeclaredUsingPreview-source.out","additions":7,"deletions":0,"binary":false,"changes":7,"status":"added"},{"patch":"@@ -0,0 +1,11 @@\n+\/**\n+ * @test \/nodynamiccopyright\/\n+ * @bug 8250768\n+ * @summary Verify javac correctly reports errors for uses of classes declared using preview features.\n+ * @compile\/ref=DeclaredUsingPreview-source.out -XDrawDiagnostics --enable-preview -source ${jdk.version} -Xlint:preview DeclaredUsingPreview.java DeclaredUsingPreviewDeclarations.java\n+ * @compile\/ref=DeclaredUsingPreview-class.out -XDrawDiagnostics --enable-preview -source ${jdk.version} -Xlint:preview DeclaredUsingPreview.java\n+ *\/\n+public class DeclaredUsingPreview {\n+    DeclaredUsingPreviewDeclarations.C c;\n+    DeclaredUsingPreviewDeclarations.C2 c2; \/\/TODO: should cause warning?\n+}\n","filename":"test\/langtools\/tools\/javac\/preview\/DeclaredUsingPreview.java","additions":11,"deletions":0,"binary":false,"changes":11,"status":"added"},{"patch":"@@ -0,0 +1,5 @@\n+\/\/\/nodynamiccopyright\/\n+public class DeclaredUsingPreviewDeclarations {\n+    sealed class C {}\n+    non-sealed class C2 extends C {}\n+}\n","filename":"test\/langtools\/tools\/javac\/preview\/DeclaredUsingPreviewDeclarations.java","additions":5,"deletions":0,"binary":false,"changes":5,"status":"added"},{"patch":"@@ -0,0 +1,221 @@\n+\/*\n+ * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @library \/tools\/lib\n+ * @modules\n+ *      jdk.compiler\/com.sun.tools.javac.api\n+ *      jdk.compiler\/com.sun.tools.javac.main\n+ *      jdk.jdeps\/com.sun.tools.classfile\n+ * @build toolbox.ToolBox toolbox.JavacTask\n+ * @run main PreviewAutoSuppress\n+ *\/\n+import com.sun.tools.classfile.ClassFile;\n+import java.io.InputStream;\n+import java.nio.file.Files;\n+import toolbox.JavacTask;\n+import toolbox.Task;\n+import toolbox.TestRunner;\n+import toolbox.ToolBox;\n+\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.List;\n+\n+public class PreviewAutoSuppress extends TestRunner {\n+\n+    protected ToolBox tb;\n+\n+    PreviewAutoSuppress() {\n+        super(System.err);\n+        tb = new ToolBox();\n+    }\n+\n+    public static void main(String... args) throws Exception {\n+        PreviewAutoSuppress t = new PreviewAutoSuppress();\n+        t.runTests();\n+    }\n+\n+    protected void runTests() throws Exception {\n+        runTests(m -> new Object[] { Paths.get(m.getName()) });\n+    }\n+\n+    @Test\n+    public void declarationWarning(Path base) throws Exception {\n+        Path src = base.resolve(\"src\");\n+        tb.writeJavaFiles(src,\n+                          \"\"\"\n+                          package test;\n+                          public class Outer {\n+                              record R(int i) {}\n+                              R r;\n+                          }\n+                          \"\"\",\n+                          \"\"\"\n+                          package test;\n+                          public class Use {\n+                            Outer.R r;\n+                          }\n+                          \"\"\");\n+        Path classes = base.resolve(\"classes\");\n+\n+        List<String> log = new JavacTask(tb, Task.Mode.CMDLINE)\n+                .outdir(classes)\n+                .options(\"--enable-preview\",\n+                         \"-source\", String.valueOf(Runtime.version().feature()),\n+                         \"-Xlint:preview\",\n+                         \"-XDforcePreview\",\n+                         \"-XDrawDiagnostics\")\n+                .files(tb.findJavaFiles(src))\n+                .run()\n+                .writeAll()\n+                .getOutputLines(Task.OutputKind.DIRECT);\n+\n+        List<String> expected =\n+                List.of(\"Outer.java:3:5: compiler.warn.preview.feature.use.plural: (compiler.misc.feature.records)\",\n+                        \"Outer.java:3:5: compiler.warn.preview.feature.use.plural: (compiler.misc.feature.records)\",\n+                        \"Outer.java:4:5: compiler.warn.declared.using.preview: kindname.record, test.Outer.R\",\n+                        \"Use.java:3:8: compiler.warn.declared.using.preview: kindname.record, test.Outer.R\",\n+                        \"4 warnings\");\n+        if (!log.equals(expected))\n+            throw new Exception(\"expected output not found\" + log);\n+        checkPreviewClassfile(classes.resolve(\"test\").resolve(\"Outer.class\"),\n+                              true); \/\/TODO: correct?\n+        checkPreviewClassfile(classes.resolve(\"test\").resolve(\"Outer$R.class\"),\n+                              true);\n+        checkPreviewClassfile(classes.resolve(\"test\").resolve(\"Use.class\"),\n+                              true);\n+    }\n+\n+    @Test\n+    public void previewAPI(Path base) throws Exception {\n+        Path apiSrc = base.resolve(\"api-src\");\n+        tb.writeJavaFiles(apiSrc,\n+                          \"\"\"\n+                          package preview.api;\n+                          @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.TEST)\n+                          public class Outer {\n+                              public void test() {}\n+                          }\n+                          \"\"\",\n+                          \"\"\"\n+                          package preview.impl;\n+                          import preview.api.Outer;\n+                          public class Impl {\n+                              public void run() {\n+                                  new Outer().test();\n+                              }\n+                              public static class C extends Outer {}\n+                          }\n+                          \"\"\");\n+        Path apiClasses = base.resolve(\"api-classes\");\n+\n+        new JavacTask(tb, Task.Mode.CMDLINE)\n+                .outdir(apiClasses)\n+                .options(\"-XDforcePreview\",\n+                         \"-XDrawDiagnostics\",\n+                         \"--patch-module\", \"java.base=\" + apiSrc.toString(),\n+                         \"-Werror\")\n+                .files(tb.findJavaFiles(apiSrc))\n+                .run()\n+                .writeAll()\n+                .getOutputLines(Task.OutputKind.DIRECT);\n+\n+        checkPreviewClassfile(apiClasses.resolve(\"preview\").resolve(\"api\").resolve(\"Outer.class\"),\n+                              false);\n+        checkPreviewClassfile(apiClasses.resolve(\"preview\").resolve(\"impl\").resolve(\"Impl.class\"),\n+                              false);\n+        checkPreviewClassfile(apiClasses.resolve(\"preview\").resolve(\"impl\").resolve(\"Impl$C.class\"),\n+                              false);\n+\n+        Path testSrc = base.resolve(\"test-src\");\n+        tb.writeJavaFiles(testSrc,\n+                          \"\"\"\n+                          package test;\n+                          import preview.api.Outer;\n+                          public class Use {\n+                              public void run() {\n+                                  new Outer().test();\n+                              }\n+                              public static class C extends Outer {}\n+                          }\n+                          \"\"\");\n+        Path testClasses = base.resolve(\"test-classes\");\n+        List<String> log = new JavacTask(tb, Task.Mode.CMDLINE)\n+                .outdir(testClasses)\n+                .options(\"--patch-module\", \"java.base=\" + apiClasses.toString(),\n+                         \"--add-exports\", \"java.base\/preview.api=ALL-UNNAMED\",\n+                         \"-XDrawDiagnostics\")\n+                .files(tb.findJavaFiles(testSrc))\n+                .run(Task.Expect.FAIL)\n+                .writeAll()\n+                .getOutputLines(Task.OutputKind.DIRECT);\n+\n+        List<String> expected =\n+                List.of(\"Use.java:2:19: compiler.err.is.preview: preview.api.Outer\",\n+                        \"Use.java:7:35: compiler.err.is.preview: preview.api.Outer\",\n+                        \"Use.java:5:13: compiler.err.is.preview: preview.api.Outer\",\n+                        \"3 errors\");\n+\n+        if (!log.equals(expected))\n+            throw new Exception(\"expected output not found\" + log);\n+\n+        log = new JavacTask(tb, Task.Mode.CMDLINE)\n+                .outdir(testClasses)\n+                .options(\"--patch-module\", \"java.base=\" + apiClasses.toString(),\n+                         \"--add-exports\", \"java.base\/preview.api=ALL-UNNAMED\",\n+                         \"--enable-preview\",\n+                         \"-Xlint:preview\",\n+                         \"-source\", String.valueOf(Runtime.version().feature()),\n+                         \"-XDrawDiagnostics\")\n+                .files(tb.findJavaFiles(testSrc))\n+                .run()\n+                .writeAll()\n+                .getOutputLines(Task.OutputKind.DIRECT);\n+\n+        expected =\n+                List.of(\"Use.java:5:13: compiler.warn.is.preview: preview.api.Outer\",\n+                        \"Use.java:7:35: compiler.warn.is.preview: preview.api.Outer\",\n+                        \"2 warnings\");\n+\n+        if (!log.equals(expected))\n+            throw new Exception(\"expected output not found\" + log);\n+\n+        checkPreviewClassfile(testClasses.resolve(\"test\").resolve(\"Use.class\"),\n+                              true);\n+        checkPreviewClassfile(testClasses.resolve(\"test\").resolve(\"Use$C.class\"),\n+                              true);\n+    }\n+\n+    private void checkPreviewClassfile(Path p, boolean preview) throws Exception {\n+        try (InputStream in = Files.newInputStream(p)) {\n+            ClassFile cf = ClassFile.read(in);\n+            if (preview && cf.minor_version != 65535) {\n+                throw new IllegalStateException(\"Expected preview class, but got: \" + cf.minor_version);\n+            } else if (!preview && cf.minor_version != 0) {\n+                throw new IllegalStateException(\"Expected minor version == 0 but got: \" + cf.minor_version);\n+            }\n+        }\n+    }\n+}\n","filename":"test\/langtools\/tools\/javac\/preview\/PreviewAutoSuppress.java","additions":221,"deletions":0,"binary":false,"changes":221,"status":"added"},{"patch":"@@ -30,1 +30,1 @@\n- *      java.base\/jdk.internal\n+ *      java.base\/jdk.internal.javac\n@@ -35,0 +35,1 @@\n+ *      jdk.jdeps\/com.sun.tools.classfile\n@@ -37,2 +38,2 @@\n- * @compile --enable-preview -source ${jdk.version} PreviewErrors.java\n- * @run main\/othervm --enable-preview PreviewErrors\n+ * @compile PreviewErrors.java\n+ * @run main PreviewErrors\n@@ -51,0 +52,1 @@\n+import java.util.Map;\n@@ -52,0 +54,1 @@\n+import java.util.TreeMap;\n@@ -55,1 +58,7 @@\n-import jdk.internal.PreviewFeature;\n+import com.sun.tools.classfile.ClassFile;\n+import com.sun.tools.classfile.ConstantPoolException;\n+import java.io.FileWriter;\n+import java.io.UncheckedIOException;\n+import java.io.Writer;\n+import java.util.Map.Entry;\n+import javax.tools.JavaFileObject;\n@@ -69,0 +78,23 @@\n+    private static String previewAPI(PreviewElementType elementType) {\n+        return \"\"\"\n+               package preview.api;\n+               public class ${name} {\n+                   @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.${preview}\n+                                                ${reflective})\n+                   public static void test() { }\n+                   @jdk.internal.javac.PreviewFeature(feature=jdk.internal.javac.PreviewFeature.Feature.${preview}\n+                                                ${reflective})\n+                   public static class Clazz {}\n+               }\n+               \"\"\".replace(\"${name}\", elementType.className)\n+                  .replace(\"${preview}\", \"TEST\")\n+                  .replace(\"${reflective}\", elementType.reflective);\n+    }\n+\n+    private static final String SEALED_DECLARATION = \"\"\"\n+                                                     package user;\n+                                                     public sealed interface R {}\n+                                                     final class C implements R {}\n+                                                     \"\"\";\n+\n+    static Map<PreviewElementType, Map<Preview, Map<Suppress, Map<Lint, StringBuilder>>>> parts = new TreeMap<>();\n@@ -71,1 +103,0 @@\n-                .withDimension(\"ESSENTIAL\", (x, essential) -> x.essential = essential, EssentialAPI.values())\n@@ -75,1 +106,1 @@\n-                .withDimension(\"FROM\", (x, from) -> x.from = from, PreviewFrom.values())\n+                .withDimension(\"ELEMENT_TYPE\", (x, elementType) -> x.elementType = elementType, PreviewElementType.values())\n@@ -77,0 +108,73 @@\n+        if (args.length == 1) {\n+            try (Writer out = new FileWriter(args[0])) {\n+                int petCount = 0;\n+                for (Entry<PreviewElementType, Map<Preview, Map<Suppress, Map<Lint, StringBuilder>>>> pet : parts.entrySet()) {\n+                    petCount++;\n+                    switch (pet.getKey()) {\n+                        case API_REFLECTIVE_CLASS, API_CLASS -> {\n+                            if (pet.getKey() == PreviewElementType.API_REFLECTIVE_CLASS) {\n+                                out.write(\"<h2>\" + petCount + \". Reflective Preview API<\/h2>\\n\");\n+                            } else {\n+                                out.write(\"<h2>\" + petCount + \". Preview API<\/h2>\\n\");\n+                            }\n+                            out.write(\"API source (part of java.base):\\n\");\n+                            out.write(\"<pre>\\n\");\n+                            String previewAPI = previewAPI(pet.getKey());\n+                            out.write(previewAPI);\n+                            out.write(\"\\n<\/pre>\\n\");\n+                        }\n+                        case REFER_TO_DECLARATION_CLASS -> {\n+                            out.write(\"<h2>\" + petCount + \". Using an element declared using a preview feature<\/h2>\\n\");\n+                            out.write(\"Element declaration:\\n\");\n+                            out.write(\"<pre>\\n\");\n+                            out.write(SEALED_DECLARATION);\n+                            out.write(\"\\n<\/pre>\\n\");\n+                        }\n+                        case LANGUAGE -> {\n+                            out.write(\"<h2>\" + petCount + \". Using preview language feature<\/h2>\\n\");\n+                        }\n+                    }\n+                    int prevCount = 0;\n+                    for (Entry<Preview, Map<Suppress, Map<Lint, StringBuilder>>> prev : pet.getValue().entrySet()) {\n+                        prevCount++;\n+                        switch (prev.getKey()) {\n+                            case YES -> {\n+                                out.write(\"<h3>\" + petCount + \".\" + prevCount + \". With --enable-preview<\/h3>\\n\");\n+                            }\n+                            case NO -> {\n+                                out.write(\"<h3>\" + petCount + \".\" + prevCount + \". Without --enable-preview<\/h3>\\n\");\n+                            }\n+                        }\n+                        int supCount = 0;\n+                        for (Entry<Suppress, Map<Lint, StringBuilder>> sup : prev.getValue().entrySet()) {\n+                            supCount++;\n+                            switch (sup.getKey()) {\n+                                case YES -> {\n+                                    out.write(\"<h4>\" + petCount + \".\" + prevCount + \".\" + supCount + \". Usages suppressed with @SuppressWarnings<\/h4>\\n\");\n+                                }\n+                                case NO -> {\n+                                    out.write(\"<h4>\" + petCount + \".\" + prevCount + \".\" + supCount + \". Usages not suppressed with @SuppressWarnings<\/h4>\\n\");\n+                                }\n+                            }\n+                            int lintCount = 0;\n+                            for (Entry<Lint, StringBuilder> lint : sup.getValue().entrySet()) {\n+                                lintCount++;\n+                                switch (lint.getKey()) {\n+                                    case NONE -> {\n+                                        out.write(\"<h5>\" + petCount + \".\" + prevCount + \".\" + supCount + \".\" + lintCount + \". Neither -Xlint:preview nor -Xlint:-preview<\/h5>\\n\");\n+                                    }\n+                                    case ENABLE_PREVIEW -> {\n+                                        out.write(\"<h5>\" + petCount + \".\" + prevCount + \".\" + supCount + \".\" + lintCount + \". With -Xlint:preview<\/h5>\\n\");\n+                                    }\n+                                    case DISABLE_PREVIEW -> {\n+                                        out.write(\"<h5>\" + petCount + \".\" + prevCount + \".\" + supCount + \".\" + lintCount + \". With -Xlint:-preview<\/h5>\\n\");\n+                                    }\n+                                }\n+                                out.write(lint.getValue().toString());\n+                                out.write(\"\\n\");\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+        }\n@@ -79,1 +183,0 @@\n-    private EssentialAPI essential;\n@@ -83,1 +186,1 @@\n-    private PreviewFrom from;\n+    private PreviewElementType elementType;\n@@ -88,0 +191,1 @@\n+        tb.cleanDirectory(base);\n@@ -95,23 +199,1 @@\n-        String previewAPI = \"\"\"\n-                            package preview.api;\n-                            public class Extra {\n-                                @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.${preview}\n-                                                             ${essential})\n-                                public static void test() { }\n-                                @jdk.internal.PreviewFeature(feature=jdk.internal.PreviewFeature.Feature.${preview}\n-                                                             ${essential})\n-                                public static class Clazz {}\n-                            }\n-                            \"\"\".replace(\"${preview}\", PreviewFeature.Feature.values()[0].name())\n-                               .replace(\"${essential}\", essential.expand(null));\n-\n-         if (from == PreviewFrom.CLASS) {\n-            tb.writeJavaFiles(srcJavaBase, previewAPI);\n-\n-            new JavacTask(tb)\n-                    .outdir(classesJavaBase)\n-                    .options(\"--patch-module\", \"java.base=\" + srcJavaBase.toString())\n-                    .files(tb.findJavaFiles(srcJavaBase))\n-                    .run()\n-                    .writeAll();\n-         }\n+        String previewAPI = previewAPI(elementType);\n@@ -120,10 +202,0 @@\n-                .withSourceFromTemplate(\"\"\"\n-                                        package test;\n-                                        public class Test {\n-                                            #{SUPPRESS}\n-                                            public void test() {\n-                                                preview.api.Extra.test();\n-                                                preview.api.Extra.Clazz c;\n-                                            }\n-                                        }\n-                                        \"\"\")\n@@ -134,9 +206,52 @@\n-        if (from == PreviewFrom.CLASS) {\n-            task.withOption(\"--patch-module\")\n-                .withOption(\"java.base=\" + classesJavaBase.toString())\n-                .withOption(\"--add-exports\")\n-                .withOption(\"java.base\/preview.api=ALL-UNNAMED\");\n-        } else {\n-            task.withSourceFromTemplate(\"Extra\", previewAPI)\n-                .withOption(\"--add-exports\")\n-                .withOption(\"java.base\/jdk.internal=ALL-UNNAMED\");\n+        switch (elementType) {\n+            case API_CLASS, API_REFLECTIVE_CLASS -> {\n+                tb.writeJavaFiles(srcJavaBase, previewAPI);\n+\n+                new JavacTask(tb)\n+                        .outdir(classesJavaBase)\n+                        .options(\"--patch-module\", \"java.base=\" + srcJavaBase.toString())\n+                        .files(tb.findJavaFiles(srcJavaBase))\n+                        .run()\n+                        .writeAll();\n+\n+                task.withOption(\"--patch-module\")\n+                    .withOption(\"java.base=\" + classesJavaBase.toString())\n+                    .withOption(\"--add-exports\")\n+                    .withOption(\"java.base\/preview.api=ALL-UNNAMED\");\n+            }\n+            case API_SOURCE, API_REFLECTIVE_SOURCE -> {\n+                tb.writeJavaFiles(srcJavaBase, previewAPI);\n+\n+                task.withOption(\"--patch-module\")\n+                    .withOption(\"java.base=\" + srcJavaBase.toString())\n+                    .withOption(\"--add-exports\")\n+                    .withOption(\"java.base\/preview.api=ALL-UNNAMED\");\n+            }\n+            case LANGUAGE -> {\n+                task.withOption(\"-XDforcePreview=true\");\n+            }\n+            case REFER_TO_DECLARATION_CLASS -> {\n+                tb.writeJavaFiles(srcJavaBase, SEALED_DECLARATION);\n+\n+                new JavacTask(tb)\n+                        .outdir(classesJavaBase)\n+                        .options(\"--patch-module\", \"java.base=\" + srcJavaBase.toString(),\n+                                 \"--enable-preview\",\n+                                 \"-source\", String.valueOf(Runtime.version().feature()))\n+                        .files(tb.findJavaFiles(srcJavaBase))\n+                        .run()\n+                        .writeAll();\n+\n+                task.withOption(\"--patch-module\")\n+                    .withOption(\"java.base=\" + classesJavaBase.toString())\n+                    .withOption(\"--add-exports\")\n+                    .withOption(\"java.base\/user=ALL-UNNAMED\");\n+            }\n+            case REFER_TO_DECLARATION_SOURCE -> {\n+                tb.writeJavaFiles(srcJavaBase, SEALED_DECLARATION);\n+\n+                task.withOption(\"--patch-module\")\n+                    .withOption(\"java.base=\" + srcJavaBase.toString())\n+                    .withOption(\"--add-exports\")\n+                    .withOption(\"java.base\/user=ALL-UNNAMED\");\n+            }\n@@ -145,0 +260,10 @@\n+        task.withSourceFromTemplate(\"\"\"\n+                                    package test;\n+                                    public class Test {\n+                                        #{SUPPRESS}\n+                                        public void test(Object o) {\n+                                            #{ELEMENT_TYPE}\n+                                        }\n+                                    }\n+                                    \"\"\");\n+\n@@ -146,1 +271,1 @@\n-            task = task.withOption(preview.expand(null));\n+            task.withOption(preview.expand(null));\n@@ -150,1 +275,1 @@\n-            task = task.withOption(lint.expand(null));\n+            task.withOption(lint.expand(null));\n@@ -158,1 +283,0 @@\n-                Set<String> expected;\n@@ -160,9 +284,36 @@\n-                if (essential == EssentialAPI.YES) {\n-                    if (preview == Preview.YES) {\n-                        if (suppress == Suppress.YES) {\n-                            expected = Set.of();\n-                        } else if (lint == Lint.ENABLE_PREVIEW) {\n-                            expected = Set.of(\"5:26:compiler.warn.is.preview\", \"6:26:compiler.warn.is.preview\");\n-                        } else {\n-                            expected = Set.of(\"-1:-1:compiler.note.preview.filename\",\n-                                              \"-1:-1:compiler.note.preview.recompile\");\n+                boolean previewClass = true;\n+                Set<String> expected = null;\n+                if (preview == Preview.NO) {\n+                    switch (elementType) {\n+                        case LANGUAGE -> {\n+                            ok = false;\n+                            expected = Set.of(\"5:41:compiler.err.preview.feature.disabled\");\n+                        }\n+                        case REFER_TO_DECLARATION_CLASS -> {\n+                            ok = false;\n+                            expected = Set.of(\"-1:-1:compiler.err.preview.feature.disabled.classfile\");\n+                        }\n+                        case REFER_TO_DECLARATION_SOURCE -> {\n+                            ok = false;\n+                            expected = Set.of(\"2:8:compiler.err.preview.feature.disabled.plural\");\n+                        }\n+                        case API_CLASS, API_SOURCE -> {\n+                            ok = false;\n+                            expected = Set.of(\"6:17:compiler.err.is.preview\",\n+                                              \"5:25:compiler.err.is.preview\");\n+                        }\n+                        case API_REFLECTIVE_CLASS, API_REFLECTIVE_SOURCE -> {\n+                            ok = true;\n+                            previewClass = false;\n+                            if (suppress == Suppress.YES) {\n+                                expected = Set.of();\n+                            } else if (lint == Lint.NONE || lint == Lint.ENABLE_PREVIEW) {\n+                                expected = Set.of(\"6:20:compiler.warn.is.preview.reflective\",\n+                                                  \"5:28:compiler.warn.is.preview.reflective\");\n+                            } else {\/\/-Xlint:-preview\n+                                expected = Set.of(\"-1:-1:compiler.note.preview.filename\",\n+                                                  \"-1:-1:compiler.note.preview.recompile\");\n+                            }\n+                        }\n+                        default -> {\n+                            throw new IllegalStateException(elementType.name());\n@@ -170,4 +321,0 @@\n-                        ok = true;\n-                    } else {\n-                        expected = Set.of(\"5:26:compiler.err.is.preview\", \"6:26:compiler.err.is.preview\");\n-                        ok = false;\n@@ -176,9 +323,0 @@\n-                    if (suppress == Suppress.YES) {\n-                        expected = Set.of();\n-                    } else if ((preview == Preview.YES && (lint == Lint.NONE || lint == Lint.DISABLE_PREVIEW)) ||\n-                               (preview == Preview.NO && lint == Lint.DISABLE_PREVIEW)) {\n-                        expected = Set.of(\"-1:-1:compiler.note.preview.filename\",\n-                                          \"-1:-1:compiler.note.preview.recompile\");\n-                    } else {\n-                        expected = Set.of(\"5:26:compiler.warn.is.preview\", \"6:26:compiler.warn.is.preview\");\n-                    }\n@@ -186,0 +324,91 @@\n+                    switch (elementType) {\n+                        case LANGUAGE -> {\n+                            if (lint == Lint.ENABLE_PREVIEW) {\n+                                expected = Set.of(\"5:41:compiler.warn.preview.feature.use\");\n+                            } else {\n+                                expected = Set.of(\"-1:-1:compiler.note.preview.filename\",\n+                                                  \"-1:-1:compiler.note.preview.recompile\");\n+                            }\n+                        }\n+                        case REFER_TO_DECLARATION_CLASS -> {\n+                            if (suppress == Suppress.YES) {\n+                                if (lint == Lint.ENABLE_PREVIEW) {\n+                                    expected = Set.of(\"-1:-1:compiler.warn.preview.feature.use.classfile\");\n+                                } else {\n+                                    expected = Set.of(\/*\"-1:-1:compiler.note.preview.filename\",\n+                                                      \"-1:-1:compiler.note.preview.recompile\"*\/);\n+                                }\n+                            } else if (lint == Lint.ENABLE_PREVIEW) {\n+                                expected = Set.of(\"5:13:compiler.warn.declared.using.preview\",\n+                                                  \"5:24:compiler.warn.declared.using.preview\",\n+                                                  \"-1:-1:compiler.warn.preview.feature.use.classfile\");\n+                            } else {\n+                                expected = Set.of(\"-1:-1:compiler.note.preview.filename\",\n+                                                  \"-1:-1:compiler.note.preview.recompile\");\n+                            }\n+                        }\n+                        case REFER_TO_DECLARATION_SOURCE -> {\n+                            if (lint == Lint.ENABLE_PREVIEW) {\n+                                if (suppress == Suppress.YES) {\n+                                    expected = Set.of(\"2:8:compiler.warn.preview.feature.use.plural\",\n+                                                      \"3:26:compiler.warn.declared.using.preview\");\n+                                } else {\n+                                    expected = Set.of(\"5:13:compiler.warn.declared.using.preview\",\n+                                                      \"5:24:compiler.warn.declared.using.preview\",\n+                                                      \"2:8:compiler.warn.preview.feature.use.plural\",\n+                                                      \"3:26:compiler.warn.declared.using.preview\");\n+                                }\n+                            } else {\n+                                if (suppress == Suppress.YES) {\n+                                    expected = Set.of(\"-1:-1:compiler.note.preview.filename\",\n+                                                      \"-1:-1:compiler.note.preview.recompile\");\n+                                } else {\n+                                    expected = Set.of(\"-1:-1:compiler.note.preview.plural\",\n+                                                      \"-1:-1:compiler.note.preview.recompile\");\n+                                }\n+                            }\n+                        }\n+                        case API_CLASS, API_SOURCE -> {\n+                            if (suppress == Suppress.YES) {\n+                                expected = Set.of();\n+                            } else if (lint == Lint.ENABLE_PREVIEW) {\n+                                expected = Set.of(\"6:17:compiler.warn.is.preview\",\n+                                                  \"5:25:compiler.warn.is.preview\");\n+                            } else {\n+                                expected = Set.of(\"-1:-1:compiler.note.preview.filename\",\n+                                                  \"-1:-1:compiler.note.preview.recompile\");\n+                            }\n+                        }\n+                        case API_REFLECTIVE_CLASS, API_REFLECTIVE_SOURCE -> {\n+                            previewClass = false;\n+                            if (suppress == Suppress.YES) {\n+                                expected = Set.of();\n+                            } else if (lint == Lint.ENABLE_PREVIEW) {\n+                                expected = Set.of(\"6:20:compiler.warn.is.preview.reflective\",\n+                                                  \"5:28:compiler.warn.is.preview.reflective\");\n+                            } else {\n+                                expected = Set.of(\"-1:-1:compiler.note.preview.filename\",\n+                                                  \"-1:-1:compiler.note.preview.recompile\");\n+                            }\n+                        }\n+                    }\n+                }\n+                if (!elementType.isSource) {\n+                    try {\n+                        parts.computeIfAbsent(elementType, x -> new TreeMap<>())\n+                                .computeIfAbsent(preview, x -> new TreeMap<>())\n+                                .computeIfAbsent(suppress, x -> new TreeMap<>())\n+                                .computeIfAbsent(lint, x -> new StringBuilder())\n+                                .append(\"<pre>\\n\")\n+                                .append(task.getSources().head.getCharContent(false))\n+                                .append(\"\\n<\/pre>\\n\")\n+                                .append(\"<pre>\\n\")\n+                                .append(Arrays.stream(Diagnostic.Kind.values())\n+                                              .flatMap(kind -> result.diagnosticsForKind(kind).reverse().stream())\n+                                              .filter(d -> d.getSource() == null || !d.getSource().getName().contains(\"R.java\"))\n+                                              .map(d -> (d.getSource() != null ? d.getSource().getName() + \":\" + d.getLineNumber() + \":\" : \"\") + d.getKind()+ \": \" + d.getMessage(null)).collect(Collectors.joining(\"\\n\")))\n+                                .append(\"\\n<\/pre>\\n\")\n+                                .append(ok ? previewClass ? \"Test.class is marked as a preview class file.\" : \"Test.class is <b>NOT<\/b> marked as a preview class file.\" : \"Does not compile.\");\n+                    } catch (IOException ex) {\n+                        throw new UncheckedIOException(ex);\n+                    }\n@@ -189,1 +418,21 @@\n-                        throw new IllegalStateException(\"Did not succeed as expected.\" + actual);\n+                        throw new IllegalStateException(\"Did not succeed as expected for preview=\" + preview + \", lint=\" + lint + \", suppress=\" + suppress + \", elementType=\" + elementType + \": actual:\\\"\" + actual + \"\\\"\");\n+                    }\n+                    ClassFile cf;\n+                    try {\n+                        JavaFileObject testClass = null;\n+                        for (JavaFileObject classfile : result.get()) {\n+                            if (classfile.isNameCompatible(\"Test\", JavaFileObject.Kind.CLASS)){\n+                                testClass = classfile;\n+                            }\n+                        }\n+                        if (testClass == null) {\n+                            throw new IllegalStateException(\"Cannot find Test.class\");\n+                        }\n+                        cf = ClassFile.read(testClass.openInputStream());\n+                    } catch (IOException | ConstantPoolException ex) {\n+                        throw new IllegalStateException(ex);\n+                    }\n+                    if (previewClass && cf.minor_version != 65535) {\n+                        throw new IllegalStateException(\"Expected preview class, but got: \" + cf.minor_version);\n+                    } else if (!previewClass && cf.minor_version != 0) {\n+                        throw new IllegalStateException(\"Expected minor version == 0 but got: \" + cf.minor_version);\n@@ -193,1 +442,1 @@\n-                        throw new IllegalStateException(\"Succeed unexpectedly.\");\n+                        throw new IllegalStateException(\"Succeed unexpectedly for preview=\" + preview + \", lint=\" + lint + \", suppress=\" + suppress + \", elementType=\" + elementType);\n@@ -196,2 +445,2 @@\n-                if (!expected.equals(actual)) {\n-                    throw new IllegalStateException(\"Unexpected output for \" + essential + \", \" + preview + \", \" + lint + \", \" + suppress + \", \" + from + \": actual: \\\"\" + actual + \"\\\", expected: \\\"\" + expected + \"\\\"\");\n+                if (expected != null && !expected.equals(actual)) {\n+                    throw new IllegalStateException(\"Unexpected output for preview=\" + preview + \", lint=\" + lint + \", suppress=\" + suppress + \", elementType=\" + elementType + \": actual: \\\"\" + actual + \"\\\", expected: \\\"\" + expected + \"\\\"\");\n@@ -202,15 +451,0 @@\n-    public enum EssentialAPI implements ComboParameter {\n-        YES(\", essentialAPI=true\"),\n-        NO(\", essentialAPI=false\");\n-\n-        private final String code;\n-\n-        private EssentialAPI(String code) {\n-            this.code = code;\n-        }\n-\n-        public String expand(String optParameter) {\n-            return code;\n-        }\n-    }\n-\n@@ -263,5 +497,43 @@\n-    public enum PreviewFrom implements ComboParameter {\n-        CLASS,\n-        SOURCE;\n-\n-        private PreviewFrom() {\n+    public enum PreviewElementType implements ComboParameter {\n+        LANGUAGE(\"boolean b = o instanceof String s;\", \", reflective=false\", \"\", false),\n+        REFER_TO_DECLARATION_SOURCE(\"user.R d1; user.R d2;\", \", reflective=false\", \"\", true),\n+        REFER_TO_DECLARATION_CLASS(\"user.R d1; user.R d2;\", \", reflective=false\", \"\", false),\n+        API_CLASS(\"\"\"\n+                  preview.api.Core.test();\n+                  preview.api.Core.Clazz c;\n+                  \"\"\",\n+                  \", reflective=false\",\n+                  \"Core\",\n+                false),\n+        API_REFLECTIVE_CLASS(\"\"\"\n+                  preview.api.Reflect.test();\n+                  preview.api.Reflect.Clazz c;\n+                  \"\"\",\n+                  \", reflective=true\",\n+                  \"Reflect\",\n+                false),\n+        API_SOURCE(\"\"\"\n+                   preview.api.Core.test();\n+                   preview.api.Core.Clazz c;\n+                   \"\"\",\n+                   \", reflective=false\",\n+                   \"Core\",\n+                   true),\n+        API_REFLECTIVE_SOURCE(\"\"\"\n+                   preview.api.Reflect.test();\n+                   preview.api.Reflect.Clazz c;\n+                   \"\"\",\n+                   \", reflective=true\",\n+                   \"Reflect\",\n+                   true);\n+\n+        String code;\n+        String reflective;\n+        String className;\n+        boolean isSource;\n+\n+        private PreviewElementType(String code, String reflective, String className, boolean isSource) {\n+            this.code = code;\n+            this.reflective = reflective;\n+            this.className = className;\n+            this.isSource = isSource;\n@@ -271,1 +543,1 @@\n-            throw new IllegalStateException();\n+            return code;\n","filename":"test\/langtools\/tools\/javac\/preview\/PreviewErrors.java","additions":372,"deletions":100,"binary":false,"changes":472,"status":"modified"},{"patch":"@@ -118,19 +118,18 @@\n-                \"Note: visiting: SealedInterface Modifiers: [abstract, sealed]\",\n-                \"Note:     this class has: 2, permitted subclasses\",\n-                \"Note:     permitted subclass: NonSealedClass1\",\n-                \"Note:     permitted subclass: SealedClass\",\n-                \"Note: visiting: NonSealedClass1 Modifiers: [non-sealed]\",\n-                \"Note:     this class has: 0, permitted subclasses\",\n-                \"Note: visiting: SealedClass Modifiers: [sealed]\",\n-                \"Note:     this class has: 2, permitted subclasses\",\n-                \"Note:     permitted subclass: FinalClass\",\n-                \"Note:     permitted subclass: NonSealedClass2\",\n-                \"Note: visiting: FinalClass Modifiers: [final]\",\n-                \"Note:     this class has: 0, permitted subclasses\",\n-                \"Note: visiting: NonSealedClass2 Modifiers: [non-sealed]\",\n-                \"Note:     this class has: 0, permitted subclasses\",\n-                \"Note: visiting: ClassOutOfSealedHierarchy Modifiers: []\",\n-                \"Note:     this class has: 0, permitted subclasses\",\n-                \"Note: testSealedClassesProcessor\" + File.separator + \"src\" + File.separator\n-                        + \"Test\" + File.separator + \"SealedInterface.java uses preview language features.\",\n-                \"Note: Recompile with -Xlint:preview for details.\"\n+                \"- compiler.note.proc.messager: visiting: SealedInterface Modifiers: [abstract, sealed]\",\n+                \"- compiler.note.proc.messager:     this class has: 2, permitted subclasses\",\n+                \"- compiler.note.proc.messager:     permitted subclass: NonSealedClass1\",\n+                \"- compiler.note.proc.messager:     permitted subclass: SealedClass\",\n+                \"- compiler.note.proc.messager: visiting: NonSealedClass1 Modifiers: [non-sealed]\",\n+                \"- compiler.note.proc.messager:     this class has: 0, permitted subclasses\",\n+                \"- compiler.note.proc.messager: visiting: SealedClass Modifiers: [sealed]\",\n+                \"- compiler.note.proc.messager:     this class has: 2, permitted subclasses\",\n+                \"- compiler.note.proc.messager:     permitted subclass: FinalClass\",\n+                \"- compiler.note.proc.messager:     permitted subclass: NonSealedClass2\",\n+                \"- compiler.note.proc.messager: visiting: FinalClass Modifiers: [final]\",\n+                \"- compiler.note.proc.messager:     this class has: 0, permitted subclasses\",\n+                \"- compiler.note.proc.messager: visiting: NonSealedClass2 Modifiers: [non-sealed]\",\n+                \"- compiler.note.proc.messager:     this class has: 0, permitted subclasses\",\n+                \"- compiler.note.proc.messager: visiting: ClassOutOfSealedHierarchy Modifiers: []\",\n+                \"- compiler.note.proc.messager:     this class has: 0, permitted subclasses\",\n+                \"- compiler.note.preview.filename: SealedInterface.java, DEFAULT\",\n+                \"- compiler.note.preview.recompile\"\n@@ -143,1 +142,2 @@\n-                            \"-source\", Integer.toString(Runtime.version().feature()))\n+                            \"-source\", Integer.toString(Runtime.version().feature()),\n+                            \"-XDrawDiagnostics\")\n","filename":"test\/langtools\/tools\/javac\/processing\/model\/element\/TestSealed.java","additions":20,"deletions":20,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -604,0 +604,2 @@\n+            \"- compiler.note.preview.plural: DEFAULT\",\n+            \"- compiler.note.preview.recompile\",\n","filename":"test\/langtools\/tools\/javac\/sealed\/SealedDiffConfigurationsTest.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -95,1 +95,1 @@\n-                                \"java.base\/jdk.internal\",\n+                                \"java.base\/jdk.internal.javac\",\n","filename":"test\/langtools\/tools\/jdeps\/listdeps\/ListModuleDeps.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}