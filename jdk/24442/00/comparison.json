{"files":[{"patch":"@@ -84,0 +84,1 @@\n+import javax.lang.model.element.ModuleElement;\n@@ -251,0 +252,4 @@\n+        return guessKind(code, null);\n+    }\n+\n+    private Tree.Kind guessKind(String code, boolean[] moduleImport) {\n@@ -258,0 +263,3 @@\n+            if (moduleImport != null && unitTree.getKind() == Kind.IMPORT) {\n+                moduleImport[0] = ((ImportTree) unitTree).isModule();\n+            }\n@@ -293,2 +301,4 @@\n-        OuterWrap codeWrap = switch (guessKind(code)) {\n-            case IMPORT -> proc.outerMap.wrapImport(Wrap.simpleWrap(code + \"any.any\"), null);\n+        boolean[] moduleImport = new boolean[1];\n+        OuterWrap codeWrap = switch (guessKind(code, moduleImport)) {\n+            case IMPORT -> moduleImport[0] ? proc.outerMap.wrapImport(Wrap.simpleWrap(code), null)\n+                                           : proc.outerMap.wrapImport(Wrap.simpleWrap(code + \"any.any\"), null);\n@@ -300,1 +310,1 @@\n-                .filter(s -> s.continuation().startsWith(requiredPrefix) && !s.continuation().equals(REPL_DOESNOTMATTER_CLASS_NAME))\n+                .filter(s -> s.filteringText.startsWith(requiredPrefix) && !s.continuation().equals(REPL_DOESNOTMATTER_CLASS_NAME))\n@@ -302,0 +312,1 @@\n+                .map(s -> (Suggestion) s)\n@@ -305,1 +316,1 @@\n-    private List<Suggestion> computeSuggestions(OuterWrap code, int cursor, int[] anchor) {\n+    private List<SuggestionImpl> computeSuggestions(OuterWrap code, int cursor, int[] anchor) {\n@@ -309,1 +320,1 @@\n-            List<Suggestion> result = new ArrayList<>();\n+            List<SuggestionImpl> result = new ArrayList<>();\n@@ -396,0 +407,10 @@\n+\n+                        if (it != null && it.isModule()) {\n+                            String fullCode = code.wrapped();\n+                            int selectStart = (int) sp.getStartPosition(topLevel, tp.getLeaf());\n+                            int selectEnd   = (int) sp.getEndPosition(topLevel, tp.getLeaf());\n+                            String qualifiedPrefix = fullCode.substring(selectStart, selectEnd);\n+\n+                            addModuleElements(at, qualifiedPrefix, result);\n+                        }\n+\n@@ -455,12 +476,19 @@\n-                            \/\/ the context of the identifier is an import, look for\n-                            \/\/ package names that start with the identifier.\n-                            \/\/ If and when Java allows imports from the default\n-                            \/\/ package to the default package which would allow\n-                            \/\/ JShell to change to use the default package, and that\n-                            \/\/ change is done, then this should use some variation\n-                            \/\/ of membersOf(at, at.getElements().getPackageElement(\"\").asType(), false)\n-                            addElements(listPackages(at, \"\"),\n-                                    it.isStatic()\n-                                            ? STATIC_ONLY.and(accessibility)\n-                                            : accessibility,\n-                                    smartFilter, result);\n+                            if (it.isModule()) {\n+                                addModuleElements(at, \"\", result);\n+                            } else {\n+                                \/\/ the context of the identifier is an import, look for\n+                                \/\/ package names that start with the identifier.\n+                                \/\/ If and when Java allows imports from the default\n+                                \/\/ package to the default package which would allow\n+                                \/\/ JShell to change to use the default package, and that\n+                                \/\/ change is done, then this should use some variation\n+                                \/\/ of membersOf(at, at.getElements().getPackageElement(\"\").asType(), false)\n+                                addElements(listPackages(at, \"\"),\n+                                        it.isStatic()\n+                                                ? STATIC_ONLY.and(accessibility)\n+                                                : accessibility,\n+                                        smartFilter, result);\n+\n+                                \/\/check source level(!)\n+                                result.add(new SuggestionImpl(\"module\", false));\n+                            }\n@@ -980,1 +1008,4 @@\n-    private void addElements(Iterable<? extends Element> elements, Predicate<Element> accept, Predicate<Element> smart, List<Suggestion> result) {\n+    private void addElements(Iterable<? extends Element> elements,\n+                             Predicate<Element> accept,\n+                             Predicate<Element> smart,\n+                             List<SuggestionImpl> result) {\n@@ -983,1 +1014,6 @@\n-    private void addElements(Iterable<? extends Element> elements, Predicate<Element> accept, Predicate<Element> smart, Function<Boolean, String> paren, List<Suggestion> result) {\n+\n+    private void addElements(Iterable<? extends Element> elements,\n+                             Predicate<Element> accept,\n+                             Predicate<Element> smart,\n+                             Function<Boolean, String> paren,\n+                             List<SuggestionImpl> result) {\n@@ -1015,0 +1051,13 @@\n+    private void addModuleElements(AnalyzeTask at,\n+                                   String prefix,\n+                                   List<SuggestionImpl> result) {\n+        for (ModuleElement me : at.getElements().getAllModuleElements()) {\n+            if (!me.getQualifiedName().toString().startsWith(prefix)) {\n+                continue;\n+            }\n+            result.add(new SuggestionImpl(me.getQualifiedName().toString(),\n+                                          me.getSimpleName().toString(),\n+                                          false));\n+        }\n+    }\n+\n@@ -1375,1 +1424,4 @@\n-    private void addScopeElements(AnalyzeTask at, Scope scope, Function<Element, Iterable<? extends Element>> elementConvertor, Predicate<Element> filter, Predicate<Element> smartFilter, List<Suggestion> result) {\n+    private void addScopeElements(AnalyzeTask at, Scope scope,\n+                                  Function<Element, Iterable<? extends Element>> elementConvertor,\n+                                  Predicate<Element> filter, Predicate<Element> smartFilter,\n+                                  List<SuggestionImpl> result) {\n@@ -2156,0 +2208,1 @@\n+        private final String filteringText;\n@@ -2165,0 +2218,12 @@\n+            this(continuation, continuation, matchesType);\n+        }\n+\n+        \/**\n+         * Create a {@code Suggestion} instance.\n+         *\n+         * @param continuation a candidate continuation of the user's input\n+         * @param filteringText a filtering prefix\n+         * @param matchesType does the candidate match the target type\n+         *\/\n+        public SuggestionImpl(String continuation, String filteringText,\n+                              boolean matchesType) {\n@@ -2166,0 +2231,1 @@\n+            this.filteringText = filteringText;\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/jshell\/SourceCodeAnalysisImpl.java","additions":86,"deletions":20,"binary":false,"changes":106,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug 8131025 8141092 8153761 8145263 8131019 8175886 8176184 8176241 8176110 8177466 8197439 8221759 8234896 8240658 8278039 8286206 8296789 8314662 8326333\n+ * @bug 8131025 8141092 8153761 8145263 8131019 8175886 8176184 8176241 8176110 8177466 8197439 8221759 8234896 8240658 8278039 8286206 8296789 8314662 8326333 8353581\n@@ -824,0 +824,8 @@\n+\n+    \/\/JDK-8353581: completion for module imports:\n+    public void testModuleImport() {\n+        assertCompletionIncludesExcludes(\"import |\", Set.of(\"module\"), Set.of());\n+        assertCompletionIncludesExcludes(\"import module |\", Set.of(\"java.base\"), Set.of(\"java.\", \"module\"));\n+        assertCompletionIncludesExcludes(\"import module java.|\", Set.of(\"java.base\"), Set.of());\n+        assertCompletion(\"import module java.ba|\", \"java.base\");\n+    }\n","filename":"test\/langtools\/jdk\/jshell\/CompletionSuggestionTest.java","additions":10,"deletions":2,"binary":false,"changes":12,"status":"modified"}]}