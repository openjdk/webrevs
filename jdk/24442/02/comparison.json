{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -86,0 +86,1 @@\n+import javax.lang.model.element.ModuleElement;\n@@ -253,0 +254,4 @@\n+        return guessKind(code, null);\n+    }\n+\n+    private Tree.Kind guessKind(String code, boolean[] moduleImport) {\n@@ -260,0 +265,3 @@\n+            if (moduleImport != null && unitTree.getKind() == Kind.IMPORT) {\n+                moduleImport[0] = ((ImportTree) unitTree).isModule();\n+            }\n@@ -295,2 +303,4 @@\n-        OuterWrap codeWrap = switch (guessKind(code)) {\n-            case IMPORT -> proc.outerMap.wrapImport(Wrap.simpleWrap(code + \"any.any\"), null);\n+        boolean[] moduleImport = new boolean[1];\n+        OuterWrap codeWrap = switch (guessKind(code, moduleImport)) {\n+            case IMPORT -> moduleImport[0] ? proc.outerMap.wrapImport(Wrap.simpleWrap(code), null)\n+                                           : proc.outerMap.wrapImport(Wrap.simpleWrap(code + \"any.any\"), null);\n@@ -300,3 +310,3 @@\n-        String requiredPrefix = identifier;\n-        return computeSuggestions(codeWrap, cursor, anchor).stream()\n-                .filter(s -> s.continuation().startsWith(requiredPrefix) && !s.continuation().equals(REPL_DOESNOTMATTER_CLASS_NAME))\n+        String[] requiredPrefix = new String[] {identifier};\n+        return computeSuggestions(codeWrap, cursor, requiredPrefix, anchor).stream()\n+                .filter(s -> s.continuation().startsWith(requiredPrefix[0]) && !s.continuation().equals(REPL_DOESNOTMATTER_CLASS_NAME))\n@@ -307,1 +317,1 @@\n-    private List<Suggestion> computeSuggestions(OuterWrap code, int cursor, int[] anchor) {\n+    private List<Suggestion> computeSuggestions(OuterWrap code, int cursor, String[] requiredPrefix, int[] anchor) {\n@@ -398,0 +408,15 @@\n+\n+                        if (it != null && it.isModule()) {\n+                            int selectStart = (int) sp.getStartPosition(topLevel, tp.getLeaf());\n+                            String qualifiedPrefix = it.getQualifiedIdentifier().getKind() == Kind.MEMBER_SELECT\n+                                ? ((MemberSelectTree) it.getQualifiedIdentifier()).getExpression().toString() + \".\"\n+                                : \"\";\n+\n+                            addModuleElements(at, qualifiedPrefix, result);\n+\n+                            requiredPrefix[0] = qualifiedPrefix + requiredPrefix[0];\n+                            anchor[0] = selectStart;\n+\n+                            return result;\n+                        }\n+\n@@ -457,12 +482,18 @@\n-                            \/\/ the context of the identifier is an import, look for\n-                            \/\/ package names that start with the identifier.\n-                            \/\/ If and when Java allows imports from the default\n-                            \/\/ package to the default package which would allow\n-                            \/\/ JShell to change to use the default package, and that\n-                            \/\/ change is done, then this should use some variation\n-                            \/\/ of membersOf(at, at.getElements().getPackageElement(\"\").asType(), false)\n-                            addElements(listPackages(at, \"\"),\n-                                    it.isStatic()\n-                                            ? STATIC_ONLY.and(accessibility)\n-                                            : accessibility,\n-                                    smartFilter, result);\n+                            if (it.isModule()) {\n+                                addModuleElements(at, \"\", result);\n+                            } else {\n+                                \/\/ the context of the identifier is an import, look for\n+                                \/\/ package names that start with the identifier.\n+                                \/\/ If and when Java allows imports from the default\n+                                \/\/ package to the default package which would allow\n+                                \/\/ JShell to change to use the default package, and that\n+                                \/\/ change is done, then this should use some variation\n+                                \/\/ of membersOf(at, at.getElements().getPackageElement(\"\").asType(), false)\n+                                addElements(listPackages(at, \"\"),\n+                                        it.isStatic()\n+                                                ? STATIC_ONLY.and(accessibility)\n+                                                : accessibility,\n+                                        smartFilter, result);\n+\n+                                result.add(new SuggestionImpl(\"module \", false));\n+                            }\n@@ -1017,0 +1048,12 @@\n+    private void addModuleElements(AnalyzeTask at,\n+                                   String prefix,\n+                                   List<Suggestion> result) {\n+        for (ModuleElement me : at.getElements().getAllModuleElements()) {\n+            if (!me.getQualifiedName().toString().startsWith(prefix)) {\n+                continue;\n+            }\n+            result.add(new SuggestionImpl(me.getQualifiedName().toString(),\n+                                          false));\n+        }\n+    }\n+\n","filename":"src\/jdk.jshell\/share\/classes\/jdk\/jshell\/SourceCodeAnalysisImpl.java","additions":62,"deletions":19,"binary":false,"changes":81,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,1 @@\n- * @bug 8131025 8141092 8153761 8145263 8131019 8175886 8176184 8176241 8176110 8177466 8197439 8221759 8234896 8240658 8278039 8286206 8296789 8314662 8326333 8326333\n+ * @bug 8131025 8141092 8153761 8145263 8131019 8175886 8176184 8176241 8176110 8177466 8197439 8221759 8234896 8240658 8278039 8286206 8296789 8314662 8326333 8326333 8353581\n@@ -827,0 +827,10 @@\n+\n+    \/\/JDK-8353581: completion for module imports:\n+    public void testModuleImport() {\n+        assertCompletionIncludesExcludes(\"import |\", Set.of(\"module \"), Set.of());\n+        assertCompletionIncludesExcludes(\"import module |\", Set.of(\"java.base\"), Set.of(\"java.\", \"module\"));\n+        assertCompletionIncludesExcludes(\"import module java.|\", Set.of(\"java.base\"), Set.of());\n+        assertCompletion(\"import module java.ba|\", \"java.base\");\n+        assertCompletionIncludesExcludes(\"import module ja|\", Set.of(\"java.base\"), Set.of(\"jdk.compiler\"));\n+        assertCompletion(\"import module java\/*c*\/.\/*c*\/ba|\", \"java.base\");\n+    }\n","filename":"test\/langtools\/jdk\/jshell\/CompletionSuggestionTest.java","additions":12,"deletions":2,"binary":false,"changes":14,"status":"modified"}]}