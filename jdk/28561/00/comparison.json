{"files":[{"patch":"@@ -107,1 +107,1 @@\n-          \/\/ ShenandoahOldGarbageThreshold so it will be promoted in place, or because there is not sufficient room\n+          \/\/ old garbage threshold so it will be promoted in place, or because there is not sufficient room\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahGenerationalHeuristics.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -74,1 +74,2 @@\n-  _fragmentation_last_old_region(0)\n+  _fragmentation_last_old_region(0),\n+  _old_garbage_threshold(ShenandoahOldGarbageThreshold)\n@@ -388,1 +389,1 @@\n-  const size_t garbage_threshold = region_size_bytes * ShenandoahOldGarbageThreshold \/ 100;\n+  const size_t garbage_threshold = region_size_bytes * get_old_garbage_threshold() \/ 100;\n@@ -658,0 +659,1 @@\n+    adjust_old_garbage_threshold();\n@@ -680,0 +682,1 @@\n+    adjust_old_garbage_threshold();\n@@ -708,0 +711,1 @@\n+      adjust_old_garbage_threshold();\n@@ -716,1 +720,35 @@\n-  return this->ShenandoahHeuristics::should_start_gc();\n+  bool result = this->ShenandoahHeuristics::should_start_gc();\n+  if (result) {\n+    adjust_old_garbage_threshold();\n+  }\n+  return result;\n+}\n+\n+void ShenandoahOldHeuristics::adjust_old_garbage_threshold() {\n+  const uintx MinimumOldGarbageThreshold = 10;\n+  const uintx InterventionPercentage = 50;\n+\n+  const ShenandoahHeap* heap = ShenandoahHeap::heap();\n+  size_t old_regions_size = _old_generation->used_regions_size();\n+  size_t soft_max_size = heap->soft_max_capacity();\n+  uintx percent_used = (uintx) ((old_regions_size * 100) \/ soft_max_size);\n+  _old_garbage_threshold = ShenandoahOldGarbageThreshold;\n+  if (percent_used > InterventionPercentage) {\n+    uintx severity = percent_used - InterventionPercentage;    \/\/ ranges from 0 to 50\n+    if (MinimumOldGarbageThreshold < ShenandoahOldGarbageThreshold) {\n+      uintx adjustment_potential = ShenandoahOldGarbageThreshold - MinimumOldGarbageThreshold;\n+      \/\/ With default values:\n+      \/\/   if percent_used > 80, garbage_threshold is 10\n+      \/\/   else if percent_used > 65, garbage_threshold is 15\n+      \/\/   else if percent_used > 50, garbage_threshold is 20\n+      if (severity > 30) {\n+        _old_garbage_threshold = ShenandoahOldGarbageThreshold - adjustment_potential;\n+      } else if (severity > 15) {\n+        _old_garbage_threshold = ShenandoahOldGarbageThreshold - 2 * adjustment_potential \/ 3;\n+      } else {\n+        _old_garbage_threshold = ShenandoahOldGarbageThreshold - adjustment_potential \/ 3;\n+      }\n+      log_info(gc)(\"Adjusting old garbage threshold to %lu because Old Generation used regions represents %lu%% of heap\",\n+                   _old_garbage_threshold, percent_used);\n+    }\n+  }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahOldHeuristics.cpp","additions":41,"deletions":3,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -105,0 +105,3 @@\n+  \/\/ adapted value of ShenandoahOldGarbageThreshold\n+  uintx _old_garbage_threshold;\n+\n@@ -203,0 +206,3 @@\n+\n+  inline uintx get_old_garbage_threshold() { return _old_garbage_threshold; }\n+\n@@ -206,0 +212,1 @@\n+  void adjust_old_garbage_threshold();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/heuristics\/shenandoahOldHeuristics.hpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -509,1 +509,1 @@\n-\/\/ ShenandoahOldGarbageThreshold amounts of garbage.  We identify these regions by setting the appropriate entry of\n+\/\/ the old garbage threshold amount of garbage.  We identify these regions by setting the appropriate entry of\n@@ -534,1 +534,2 @@\n-  const size_t old_garbage_threshold = (ShenandoahHeapRegion::region_size_bytes() * ShenandoahOldGarbageThreshold) \/ 100;\n+  const size_t old_garbage_threshold =\n+    (ShenandoahHeapRegion::region_size_bytes() * heap->old_generation()->heuristics()->get_old_garbage_threshold()) \/ 100;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGeneration.cpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -74,1 +74,1 @@\n-  \/\/ Criterion 2. region garbage percentage > ShenandoahOldGarbageThreshold\n+  \/\/ Criterion 2. region garbage percentage > old garbage threshold\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGeneration.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -148,1 +148,1 @@\n-      \/\/ more garbage than ShenandoahOldGarbageThreshold, we'll promote by evacuation.  If there is room for evacuation\n+      \/\/ more garbage than the old garbage threshold, we'll promote by evacuation.  If there is room for evacuation\n@@ -180,1 +180,2 @@\n-    const size_t old_garbage_threshold = (region_size_bytes * ShenandoahOldGarbageThreshold) \/ 100;\n+    const size_t old_garbage_threshold =\n+      (region_size_bytes * _heap->old_generation()->heuristics()->get_old_garbage_threshold()) \/ 100;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahGenerationalEvacuationTask.cpp","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -231,1 +231,1 @@\n-    _live_bytes_after_last_mark = ShenandoahHeap::heap()->capacity() * INITIAL_LIVE_FRACTION \/ FRACTIONAL_DENOMINATOR;\n+    _live_bytes_after_last_mark = ShenandoahHeap::heap()->soft_max_capacity() * INITIAL_LIVE_FRACTION \/ FRACTIONAL_DENOMINATOR;\n@@ -247,1 +247,6 @@\n-  size_t result = _live_bytes_after_last_mark + (_live_bytes_after_last_mark * _growth_before_compaction) \/ FRACTIONAL_DENOMINATOR;\n+  size_t threshold_by_relative_growth =\n+    _live_bytes_after_last_mark + (_live_bytes_after_last_mark * _growth_before_compaction) \/ FRACTIONAL_DENOMINATOR;\n+  size_t threshold_by_growth_into_percent_remaining = (size_t)\n+    (_live_bytes_after_last_mark + ((ShenandoahHeap::heap()->soft_max_capacity() - _live_bytes_after_last_mark)\n+                                    * ShenandoahMinOldGenGrowthRemainingHeapPercent \/ 100.0));\n+  size_t result = MIN2(threshold_by_relative_growth, threshold_by_growth_into_percent_remaining);\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahOldGeneration.cpp","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -62,1 +62,1 @@\n-  product(double, ShenandoahMinOldGenGrowthPercent, 12.5, EXPERIMENTAL,     \\\n+  product(double, ShenandoahMinOldGenGrowthPercent, 50, EXPERIMENTAL,       \\\n@@ -65,3 +65,2 @@\n-          \"at completion of the most recent old-generation marking \"        \\\n-          \"effort, heuristics may trigger the start of a new old-gen \"      \\\n-          \"collection.\")                                                    \\\n+          \"at the start of the previous old-generation marking effort, \"    \\\n+          \"heuristics may trigger the start of a new old-gen collection.\")  \\\n@@ -70,1 +69,16 @@\n-  product(uintx, ShenandoahIgnoreOldGrowthBelowPercentage,10, EXPERIMENTAL, \\\n+  product(double, ShenandoahMinOldGenGrowthRemainingHeapPercent,            \\\n+          50, EXPERIMENTAL,                                                 \\\n+          \"(Generational mode only) If the usage within old generation \"    \\\n+          \"has grown to exceed this percent of the remaining heap that \"    \\\n+          \"was not marked live within the old generation at the time \"      \\\n+          \"of the last old-generation marking effort, heuristics may \"      \\\n+          \"trigger the start of a new old-gen collection.  Setting \"        \\\n+          \"this value to a smaller value may cause back-to-back old \"       \\\n+          \"generation marking triggers, since the typical memory used \"     \\\n+          \"by the old generation is about 30% larger than the live \"        \\\n+          \"memory contained within the old generation (because default \"    \\\n+          \"value of ShenandoahOldGarbageThreshold is 25.\")                  \\\n+          range(0.0,100.0)                                                  \\\n+                                                                            \\\n+  product(uintx, ShenandoahIgnoreOldGrowthBelowPercentage,                  \\\n+          40, EXPERIMENTAL,                                                 \\\n@@ -80,1 +94,1 @@\n-          50, EXPERIMENTAL,                                                 \\\n+          100, EXPERIMENTAL,                                                \\\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoah_globals.hpp","additions":20,"deletions":6,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -102,0 +102,3 @@\n+                \"-XX:ShenandoahMinOldGenGrowthPercent=12.5\",\n+                \"-XX:ShenandoahIgnoreOldGrowthBelowPercentage=10\",\n+                \"-XX:ShenandoahMinOldGenGrowthRemainingHeapPercent=100\",\n@@ -103,1 +106,2 @@\n-                \"-XX:ShenandoahGuaranteedOldGCInterval=0\"\n+                \"-XX:ShenandoahGuaranteedOldGCInterval=0\",\n+                \"-XX:-UseCompactObjectHeaders\"\n@@ -113,0 +117,3 @@\n+                \"-XX:ShenandoahMinOldGenGrowthPercent=12.5\",\n+                \"-XX:ShenandoahIgnoreOldGrowthBelowPercentage=10\",\n+                \"-XX:ShenandoahMinOldGenGrowthRemainingHeapPercent=100\",\n","filename":"test\/hotspot\/jtreg\/gc\/shenandoah\/generational\/TestOldGrowthTriggers.java","additions":8,"deletions":1,"binary":false,"changes":9,"status":"modified"}]}