{"files":[{"patch":"@@ -470,3 +470,3 @@\n-  OSContainer::print_container_helper(st, kmem_limit, \"kernel_memory_limit_in_bytes\");\n-  OSContainer::print_container_helper(st, kmem_usage, \"kernel_memory_usage_in_bytes\");\n-  OSContainer::print_container_helper(st, kmem_max_usage, \"kernel_memory_max_usage_in_bytes\");\n+  OSContainer::print_container_helper(st, kmem_limit, \"kernel_memory_limit\");\n+  OSContainer::print_container_helper(st, kmem_usage, \"kernel_memory_usage\");\n+  OSContainer::print_container_helper(st, kmem_max_usage, \"kernel_memory_max_usage\");\n","filename":"src\/hotspot\/os\/linux\/cgroupV1Subsystem_linux.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -381,2 +381,2 @@\n-  OSContainer::print_container_helper(st, swap_current, \"memory_swap_current_in_bytes\");\n-  OSContainer::print_container_helper(st, swap_limit, \"memory_swap_max_limit_in_bytes\");\n+  OSContainer::print_container_helper(st, swap_current, \"memory_swap_current\");\n+  OSContainer::print_container_helper(st, swap_limit, \"memory_swap_max_limit\");\n","filename":"src\/hotspot\/os\/linux\/cgroupV2Subsystem_linux.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -290,0 +290,25 @@\n+template<typename T> struct metric_fmt;\n+template<> struct metric_fmt<unsigned long long int> { static constexpr const char* fmt = \"%llu\"; };\n+template<> struct metric_fmt<unsigned long int> { static constexpr const char* fmt = \"%lu\"; };\n+template<> struct metric_fmt<int> { static constexpr const char* fmt = \"%d\"; };\n+template<> struct metric_fmt<const char*> { static constexpr const char* fmt = \"%s\"; };\n+\n+template void OSContainer::print_container_metric<unsigned long long int>(outputStream*, const char*, unsigned long long int, const char*);\n+template void OSContainer::print_container_metric<unsigned long int>(outputStream*, const char*, unsigned long int, const char*);\n+template void OSContainer::print_container_metric<int>(outputStream*, const char*, int, const char*);\n+template void OSContainer::print_container_metric<const char*>(outputStream*, const char*, const char*, const char*);\n+\n+template <typename T>\n+void OSContainer::print_container_metric(outputStream* st, const char* metrics, T value, const char* unit) {\n+  constexpr int max_length = 38; \/\/ Longest \"metric: value\" string (\"maximum number of tasks: not supported\")\n+  constexpr int longest_value = max_length - 11; \/\/ Max length - shortest \"metric: \" string (\"cpu_quota: \")\n+  char value_str[longest_value + 1] = {};\n+  os::snprintf_checked(value_str, longest_value, metric_fmt<T>::fmt, value);\n+  st->print(\"%s: %*s\", metrics, max_length - static_cast<int>(strlen(metrics)) - 2, value_str); \/\/ -2 for the \": \"\n+  if (unit[0] != '\\0') {\n+    st->print_cr(\" %s\", unit);\n+  } else {\n+    st->print_cr(\"\");\n+  }\n+}\n+\n@@ -291,1 +316,0 @@\n-  st->print(\"%s: \", metrics);\n@@ -295,1 +319,1 @@\n-        st->print_cr(PHYS_MEM_TYPE_FORMAT \" k\", (physical_memory_size_type)(res.value() \/ K));\n+        print_container_metric(st, metrics, res.value() \/ K, \"kB\");\n@@ -297,1 +321,1 @@\n-        st->print_cr(PHYS_MEM_TYPE_FORMAT, res.value());\n+        print_container_metric(st, metrics, res.value(), \"B\");\n@@ -300,1 +324,1 @@\n-      st->print_cr(\"%s\", \"unlimited\");\n+      print_container_metric(st, metrics, \"unlimited\");\n@@ -304,1 +328,1 @@\n-    st->print_cr(\"%s\", \"unavailable\");\n+    print_container_metric(st, metrics, \"unavailable\");\n","filename":"src\/hotspot\/os\/linux\/osContainer_linux.cpp","additions":29,"deletions":5,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -68,0 +68,2 @@\n+  template <typename T>\n+  static void print_container_metric(outputStream* st, const char* metrics, T value, const char* unit = \"\");\n","filename":"src\/hotspot\/os\/linux\/osContainer_linux.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2435,1 +2435,1 @@\n-  st->print_cr(\"container_type: %s\", p_ct != nullptr ? p_ct : \"not supported\");\n+  OSContainer::print_container_metric(st, \"container_type\", p_ct != nullptr ? p_ct : \"not supported\");\n@@ -2438,1 +2438,1 @@\n-  st->print_cr(\"cpu_cpuset_cpus: %s\", p != nullptr ? p : \"not supported\");\n+  OSContainer::print_container_metric(st, \"cpu_cpuset_cpus\", p != nullptr ? p : \"not supported\");\n@@ -2442,1 +2442,1 @@\n-  st->print_cr(\"cpu_memory_nodes: %s\", p != nullptr ? p : \"not supported\");\n+  OSContainer::print_container_metric(st, \"cpu_memory_nodes\", p != nullptr ? p : \"not supported\");\n@@ -2447,1 +2447,0 @@\n-  st->print(\"active_processor_count: \");\n@@ -2451,1 +2450,1 @@\n-      st->print_cr(\"%d, but overridden by -XX:ActiveProcessorCount %d\", i, ActiveProcessorCount);\n+      OSContainer::print_container_metric(st, \"active_processor_count\", ActiveProcessorCount, \"(from -XX:ActiveProcessorCount)\");\n@@ -2453,1 +2452,1 @@\n-      st->print_cr(\"%d\", i);\n+      OSContainer::print_container_metric(st, \"active_processor_count\", i);\n@@ -2456,1 +2455,1 @@\n-    st->print_cr(\"not supported\");\n+    OSContainer::print_container_metric(st, \"active_processor_count\", \"not supported\");\n@@ -2461,1 +2460,0 @@\n-  st->print(\"cpu_quota: \");\n@@ -2463,1 +2461,1 @@\n-    st->print_cr(\"%d\", i);\n+    OSContainer::print_container_metric(st, \"cpu_quota\", i);\n@@ -2465,1 +2463,1 @@\n-    st->print_cr(\"%s\", !supported ? \"not supported\" : \"no quota\");\n+    OSContainer::print_container_metric(st, \"cpu_quota\", !supported ? \"not supported\" : \"no quota\");\n@@ -2469,1 +2467,0 @@\n-  st->print(\"cpu_period: \");\n@@ -2471,1 +2468,1 @@\n-    st->print_cr(\"%d\", i);\n+    OSContainer::print_container_metric(st, \"cpu_period\", i);\n@@ -2473,1 +2470,1 @@\n-    st->print_cr(\"%s\", !supported ? \"not supported\" : \"no period\");\n+    OSContainer::print_container_metric(st, \"cpu_period\", !supported ? \"not supported\" : \"no period\");\n@@ -2477,1 +2474,0 @@\n-  st->print(\"cpu_shares: \");\n@@ -2479,1 +2475,1 @@\n-    st->print_cr(\"%d\", i);\n+    OSContainer::print_container_metric(st, \"cpu_shares\", i);\n@@ -2481,1 +2477,1 @@\n-    st->print_cr(\"%s\", !supported ? \"not supported\" : \"no shares\");\n+    OSContainer::print_container_metric(st, \"cpu_shares\", !supported ? \"not supported\" : \"no shares\");\n@@ -2486,1 +2482,0 @@\n-  st->print(\"cpu_usage_in_micros: \");\n@@ -2488,1 +2483,1 @@\n-    st->print_cr(UINT64_FORMAT, j);\n+    OSContainer::print_container_metric(st, \"cpu_usage\", j, \"us\");\n@@ -2490,1 +2485,1 @@\n-    st->print_cr(\"%s\", !supported ? \"not supported\" : \"no usage\");\n+    OSContainer::print_container_metric(st, \"cpu_usage\", !supported ? \"not supported\" : \"no usage\");\n@@ -2533,8 +2528,8 @@\n-  OSContainer::print_container_helper(st, memory_limit, \"memory_limit_in_bytes\");\n-  OSContainer::print_container_helper(st, mem_swap_limit, \"memory_and_swap_limit_in_bytes\");\n-  OSContainer::print_container_helper(st, mem_soft_limit, \"memory_soft_limit_in_bytes\");\n-  OSContainer::print_container_helper(st, mem_throttle_limit, \"memory_throttle_limit_in_bytes\");\n-  OSContainer::print_container_helper(st, mem_usage, \"memory_usage_in_bytes\");\n-  OSContainer::print_container_helper(st, mem_max_usage, \"memory_max_usage_in_bytes\");\n-  OSContainer::print_container_helper(st, rss_usage, \"rss_usage_in_bytes\");\n-  OSContainer::print_container_helper(st, cache_usage, \"cache_usage_in_bytes\");\n+  OSContainer::print_container_helper(st, memory_limit, \"memory_limit\");\n+  OSContainer::print_container_helper(st, mem_swap_limit, \"memory_and_swap_limit\");\n+  OSContainer::print_container_helper(st, mem_soft_limit, \"memory_soft_limit\");\n+  OSContainer::print_container_helper(st, mem_throttle_limit, \"memory_throttle_limit\");\n+  OSContainer::print_container_helper(st, mem_usage, \"memory_usage\");\n+  OSContainer::print_container_helper(st, mem_max_usage, \"memory_max_usage\");\n+  OSContainer::print_container_helper(st, rss_usage, \"rss_usage\");\n+  OSContainer::print_container_helper(st, cache_usage, \"cache_usage\");\n@@ -2545,1 +2540,0 @@\n-  st->print(\"maximum number of tasks: \");\n@@ -2547,1 +2541,1 @@\n-    st->print_cr(UINT64_FORMAT, j);\n+    OSContainer::print_container_metric(st, \"maximum number of tasks\", j);\n@@ -2549,1 +2543,1 @@\n-    st->print_cr(\"%s\", !supported ? \"not supported\" : \"unlimited\");\n+    OSContainer::print_container_metric(st, \"maximum number of tasks\", !supported ? \"not supported\" : \"unlimited\");\n@@ -2553,1 +2547,0 @@\n-  st->print(\"current number of tasks: \");\n@@ -2555,1 +2548,1 @@\n-    st->print_cr(UINT64_FORMAT, j);\n+    OSContainer::print_container_metric(st, \"current number of tasks\", j);\n@@ -2557,1 +2550,1 @@\n-    st->print_cr(\"%s\", !supported ? \"not supported\" : \"no current tasks\");\n+    OSContainer::print_container_metric(st, \"current number of tasks\", !supported ? \"not supported\" : \"no tasks\");\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":26,"deletions":33,"binary":false,"changes":59,"status":"modified"},{"patch":"@@ -76,12 +76,0 @@\n-    private static void shouldMatchWithValue(OutputAnalyzer output, String match, String value) {\n-        output.shouldContain(match);\n-        String str = output.getOutput();\n-        for (String s : str.split(System.lineSeparator())) {\n-            if (s.contains(match)) {\n-                if (!s.contains(value)) {\n-                    throw new RuntimeException(\"memory_swap_current_in_bytes NOT \" + value + \"! Line was : \" + s);\n-                }\n-            }\n-        }\n-    }\n-\n@@ -91,2 +79,2 @@\n-            shouldMatchWithValue(out, \"memory_swap_max_limit_in_bytes\", \"0\");\n-            shouldMatchWithValue(out, \"memory_swap_current_in_bytes\", \"0\");\n+            DockerTestUtils.shouldMatchWithValue(out, \"memory_swap_max_limit\", \"0\");\n+            DockerTestUtils.shouldMatchWithValue(out, \"memory_swap_current\", \"0\");\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestContainerInfo.java","additions":2,"deletions":14,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -131,6 +131,6 @@\n-        targetOut.shouldContain(\"active_processor_count: 2\"); \/\/ initial value\n-        targetOut.shouldContain(\"active_processor_count: 3\"); \/\/ updated value\n-        targetOut.shouldContain(\"memory_limit_in_bytes: 512000 k\"); \/\/ initial value\n-        targetOut.shouldContain(\"memory_and_swap_limit_in_bytes: 512000 k\"); \/\/ initial value\n-        targetOut.shouldContain(\"memory_limit_in_bytes: 307200 k\"); \/\/ updated value\n-        targetOut.shouldContain(\"memory_and_swap_limit_in_bytes: 307200 k\"); \/\/ updated value\n+        DockerTestUtils.shouldMatchWithValue(targetOut, \"active_processor_count\", \"2\"); \/\/ initial value\n+        DockerTestUtils.shouldMatchWithValue(targetOut, \"active_processor_count\", \"3\"); \/\/ updated value\n+        DockerTestUtils.shouldMatchWithValue(targetOut, \"memory_limit\", \"512000 kB\"); \/\/ initial value\n+        DockerTestUtils.shouldMatchWithValue(targetOut, \"memory_and_swap_limit\", \"512000 kB\"); \/\/ initial value\n+        DockerTestUtils.shouldMatchWithValue(targetOut, \"memory_limit\", \"307200 kB\"); \/\/ updated value\n+        DockerTestUtils.shouldMatchWithValue(targetOut, \"memory_and_swap_limit\", \"307200 kB\"); \/\/ updated value\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestLimitsUpdating.java","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -172,2 +172,2 @@\n-            .shouldMatch(\"memory_limit_in_bytes:.*\" + expectedMem)\n-            .shouldNotMatch(\"memory_and_swap_limit_in_bytes:.*not supported\")\n+            .shouldMatch(\"memory_limit:.*\" + expectedMem)\n+            .shouldNotMatch(\"memory_and_swap_limit:.*not supported\")\n@@ -176,1 +176,1 @@\n-            .shouldMatch(\"memory_and_swap_limit_in_bytes:.*(\" + expectedMem + \"|\" + expectedSwap + \")\");\n+            .shouldMatch(\"memory_and_swap_limit:.*(\" + expectedMem + \"|\" + expectedSwap + \")\");\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestMemoryAwareness.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -130,1 +130,1 @@\n-          out.shouldContain(\"cpu_shares: \" + valueExpected);\n+          DockerTestUtils.shouldMatchWithValue(out, \"cpu_shares\", String.valueOf(valueExpected));\n@@ -133,1 +133,1 @@\n-          out.shouldNotContain(\"cpu_shares: no shares\");\n+          DockerTestUtils.shouldNotMatchWithValue(out, \"cpu_shares\", \"no shares\");\n@@ -144,1 +144,1 @@\n-        out.shouldContain(\"but overridden by -XX:ActiveProcessorCount 2\");\n+        DockerTestUtils.shouldMatchWithValue(out, \"active_processor_count\", \"2 (from -XX:ActiveProcessorCount)\");\n@@ -161,1 +161,1 @@\n-            \"memory_max_usage_in_bytes\",\n+            \"memory_max_usage\",\n@@ -164,2 +164,2 @@\n-            \"rss_usage_in_bytes\",\n-            \"cache_usage_in_bytes\"\n+            \"rss_usage\",\n+            \"cache_usage\"\n@@ -173,3 +173,3 @@\n-            out.shouldContain(\"kernel_memory_usage_in_bytes\");\n-            out.shouldContain(\"kernel_memory_max_usage_in_bytes\");\n-            out.shouldContain(\"kernel_memory_limit_in_bytes\");\n+            out.shouldContain(\"kernel_memory_usage\");\n+            out.shouldContain(\"kernel_memory_max_usage\");\n+            out.shouldContain(\"kernel_memory_limit\");\n@@ -178,2 +178,2 @@\n-                out.shouldContain(\"memory_swap_current_in_bytes\");\n-                out.shouldContain(\"memory_swap_max_limit_in_bytes\");\n+                out.shouldContain(\"memory_swap_current\");\n+                out.shouldContain(\"memory_swap_max_limit\");\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestMisc.java","additions":11,"deletions":11,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -41,0 +41,1 @@\n+import java.util.regex.Pattern;\n@@ -344,0 +345,10 @@\n+    public static void shouldMatchWithValue(OutputAnalyzer output, String metric, String value) throws Exception {\n+        String pattern = \"^\" + Pattern.quote(metric) + \":\\\\s*\" + Pattern.quote(value) + \".*$\";\n+        output.shouldMatch(pattern);\n+    }\n+\n+    public static void shouldNotMatchWithValue(OutputAnalyzer output, String metric, String value) throws Exception {\n+        String pattern = \"^\" + Pattern.quote(metric) + \":\\\\s*\" + Pattern.quote(value) + \".*$\";\n+        output.shouldNotMatch(pattern);\n+    }\n+\n","filename":"test\/lib\/jdk\/test\/lib\/containers\/docker\/DockerTestUtils.java","additions":11,"deletions":0,"binary":false,"changes":11,"status":"modified"}]}