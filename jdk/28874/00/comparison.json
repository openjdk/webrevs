{"files":[{"patch":"@@ -347,4 +347,0 @@\n-        \/\/ remap the connection to a draining connection\n-        final QuicEndpoint endpoint = this.connection.endpoint();\n-        assert endpoint != null : \"QUIC endpoint is null\";\n-        endpoint.draining(connection);\n@@ -442,1 +438,1 @@\n-        \/\/ remap (or remove) the QuicConnectionImpl in QuicEndpoint.\n+        \/\/ remap the QuicConnectionImpl in QuicEndpoint.\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/quic\/ConnectionTerminatorImpl.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2814,1 +2814,1 @@\n-                \/\/ we remove the connection from the endpoint for such cases.\n+                \/\/ we switch this connection to one that does not respond to incoming packets.\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/quic\/QuicConnectionImpl.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1512,1 +1512,2 @@\n-     * This will completely remove the connection from the connection map.\n+     * This will replace the {@link QuicConnectionImpl} with a {@link DrainingConnection} that\n+     * will discard all incoming packets.\n@@ -1521,1 +1522,1 @@\n-        removeConnection(connection);\n+        draining(connection);\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/quic\/QuicEndpoint.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -50,0 +50,1 @@\n+import jdk.internal.net.http.quic.QuicTransportParameters;\n@@ -61,0 +62,1 @@\n+import static org.junit.jupiter.api.Assertions.assertNotEquals;\n@@ -66,0 +68,1 @@\n+ * @bug 8373877\n@@ -90,0 +93,4 @@\n+        \/\/ Use a longer max ack delay to inflate the draining time (3xPTO)\n+        final QuicTransportParameters transportParameters = new QuicTransportParameters();\n+        transportParameters.setIntParameter(QuicTransportParameters.ParameterId.max_ack_delay,\n+                (1 << 14) - 1); \/\/ 16 seconds, maximum allowed\n@@ -182,0 +189,3 @@\n+            \/\/ Check that the (closing) connection is still registered with the endpoint\n+            assertNotEquals(0, conn.endpoint().connectionCount(),\n+                    \"Expected the QUIC connection to be registered\");\n@@ -234,0 +244,2 @@\n+            \/\/ send ping in case the connection_close message gets lost\n+            conn.underlyingQuicConnection().requestSendPing();\n@@ -240,0 +252,5 @@\n+            \/\/ wait for a while to let the connection close completely\n+            Thread.sleep(10);\n+            \/\/ Check that the (draining) connection is still registered with the endpoint\n+            assertNotEquals(0, conn.endpoint().connectionCount(),\n+                    \"Expected the QUIC connection to be registered\");\n","filename":"test\/jdk\/java\/net\/httpclient\/quic\/StatelessResetReceiptTest.java","additions":17,"deletions":0,"binary":false,"changes":17,"status":"modified"}]}