{"files":[{"patch":"@@ -41,7 +41,17 @@\n-\/**\n- * The flavor of method handle which emulates an invoke instruction\n- * on a predetermined argument.  The JVM dispatches to the correct method\n- * when the handle is created, not when it is invoked.\n- *\n- * All bound arguments are encapsulated in dedicated species.\n- *\/\n+\/\/\/ The flavor of method handle which is constructed with unmodifiable bound values,\n+\/\/\/ usable by lambda forms. For example, they can carry a configuration object\n+\/\/\/ for its lambda form, or carry an underlying method handle and its bound\n+\/\/\/ arguments for currying.\n+\/\/\/\n+\/\/\/ Each BMH acts like a strongly-typed argument list, where the types are\n+\/\/\/ [BasicType]s.  This type information is recorded by its species, represented\n+\/\/\/ by a per-class [SpeciesData].  A [Specializer] manages lookup for any species.\n+\/\/\/\n+\/\/\/ Factories are provided by [BoundMethodHandle.SpeciesData#factory()].\n+\/\/\/ Getters are exposed as [BoundMethodHandle.SpeciesData#getter(int)],\n+\/\/\/ which can be included as names in lambda forms.\n+\/\/\/\n+\/\/\/ [SimpleMethodHandle] (with no bound value) and [Species_L] (with a bound\n+\/\/\/ reference value) are explicitly provided to prevent bootstrap loops; the\n+\/\/\/ rest may be generated on demand, or may be pregenerated by\n+\/\/\/ [GenerateJLIClassesHelper].\n@@ -468,12 +478,4 @@\n-        \/**\n-         * Generation of concrete BMH classes.\n-         *\n-         * A concrete BMH species is fit for binding a number of values adhering to a\n-         * given type pattern. Reference types are erased.\n-         *\n-         * BMH species are cached by type pattern.\n-         *\n-         * A BMH species has a number of fields with the concrete (possibly erased) types of\n-         * bound values. Setters are provided as an API in BMH. Getters are exposed as MHs,\n-         * which can be included as names in lambda forms.\n-         *\/\n+        \/\/\/ Generates concrete BMH classes.\n+        \/\/\/\n+        \/\/\/ [GenerateJLIClassesHelper] can pre-generate species that are known\n+        \/\/\/ to be loaded from [MethodHandleStatics#traceSpeciesType].\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/BoundMethodHandle.java","additions":21,"deletions":19,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -199,1 +199,13 @@\n-    \/* Placeholder class for DelegatingMethodHandles generated ahead of time *\/\n+    \/\/\/ Holds pre-generated bytecode for lambda forms used by DelegatingMethodHandle.\n+    \/\/\/\n+    \/\/\/ This class may be substituted in the JDK's modules image, or in an AOT\n+    \/\/\/ cache, by a version generated by [GenerateJLIClassesHelper].\n+    \/\/\/\n+    \/\/\/ The method names of this class are internal tokens recognized by\n+    \/\/\/ [InvokerBytecodeGenerator#lookupPregenerated] and is subject to change.\n+    \/\/\/\n+    \/\/\/ To view the actual content of this class in a JDK, run the `javap` in\n+    \/\/\/ that JDK with: (Note to escape `$` in bash)\n+    \/\/\/ ```\n+    \/\/\/ javap -c -p -v java.lang.invoke.DelegatingMethodHandle\\$Holder\n+    \/\/\/ ```\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/DelegatingMethodHandle.java","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -942,1 +942,13 @@\n-    \/* Placeholder class for DirectMethodHandles generated ahead of time *\/\n+    \/\/\/ Holds pre-generated bytecode for lambda forms used by DirectMethodHandle.\n+    \/\/\/\n+    \/\/\/ This class may be substituted in the JDK's modules image, or in an AOT\n+    \/\/\/ cache, by a version generated by [GenerateJLIClassesHelper].\n+    \/\/\/\n+    \/\/\/ The method names of this class are internal tokens recognized by\n+    \/\/\/ [InvokerBytecodeGenerator#lookupPregenerated] and is subject to change.\n+    \/\/\/\n+    \/\/\/ To view the actual content of this class in a JDK, run the `javap` in\n+    \/\/\/ that JDK with: (Note to escape `$` in bash)\n+    \/\/\/ ```\n+    \/\/\/ javap -c -p -v java.lang.invoke.DirectMethodHandle\\$Holder\n+    \/\/\/ ```\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/DirectMethodHandle.java","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -50,5 +50,66 @@\n-\/**\n- * Helper class to assist the GenerateJLIClassesPlugin to get access to\n- * generate classes ahead of time.\n- *\/\n-class GenerateJLIClassesHelper {\n+\/\/\/ Generates bound method handle species classes, and classes with methods that\n+\/\/\/ hold compiled lambda form bytecode ahead of time, so certain lambda forms\n+\/\/\/ no longer need to spin classes because they can find existing bytecode.\n+\/\/\/ Bytecode pre-generation reduces static initialization costs, footprint costs,\n+\/\/\/ and circular dependencies that may arise if a class is generated per\n+\/\/\/ LambdaForm by [InvokerBytecodeGenerator].\n+\/\/\/\n+\/\/\/ Since lambda forms and bound method handle species are closely tied to\n+\/\/\/ method types, which have many varieties, this generator needs *traces* to\n+\/\/\/ detect which method types are used, so generation matches the actual usage.\n+\/\/\/ See the main entrypoint [#generateHolderClasses(Stream)] for more details\n+\/\/\/ about *traces*.\n+\/\/\/\n+\/\/\/ Note this pregeneration does not cover all lambda forms that can be created.\n+\/\/\/ For example, forms created by [LambdaFormEditor] are not captured.\n+\/\/\/\n+\/\/\/ Pregenerated species classes are resolved in [ClassSpecializer.Factory#loadSpecies]\n+\/\/\/ and behave identically to on-demand generated ones.  Pregenerated lambda\n+\/\/\/ forms are resolved in [InvokerBytecodeGenerator#lookupPregenerated], which\n+\/\/\/ looks up methods for code from the following 4 possibly-generated classes:\n+\/\/\/  -  [Invokers.Holder]\n+\/\/\/  -  [DirectMethodHandle.Holder]\n+\/\/\/  -  [DelegatingMethodHandle.Holder]\n+\/\/\/  -  [LambdaForm.Holder]\n+\/\/\/\n+\/\/\/ [VarHandle] linker forms, analogous to invoker forms in [Invokers.Holder],\n+\/\/\/ have a similar pre-generation system except it is done at source generation;\n+\/\/\/ they reside in [VarHandleGuards].\n+\/\/\/\n+\/\/\/ ## Usages of this generator\n+\/\/\/ Currently, `GenerateJLIClassesHelper` is invoked when creating a modular JDK\n+\/\/\/ image or generating an AOT cache.\n+\/\/\/\n+\/\/\/ #### Modular Image\n+\/\/\/ When creating a modular JDK image,\n+\/\/\/ `jdk.tools.jlink.internal.plugins.GenerateJLIClassesPlugin` passes the\n+\/\/\/ *traces* in the file `jdk\/tools\/jlink\/internal\/plugins\/default_jli_trace.txt`\n+\/\/\/ in `$JAVA_HOME\/lib\/modules` to this generator.  The *traces* are generated\n+\/\/\/ from the execution of `build.tools.classlist.HelloClasslist` in the build\n+\/\/\/ process of the JDK.\n+\/\/\/\n+\/\/\/ > To list all the Species classes in a JDK image:\n+\/\/\/ > ```\n+\/\/\/ > jimage list $JAVA_HOME\/lib\/modules | grep BoundMethodHandle.Species_\n+\/\/\/ > ```\n+\/\/\/\n+\/\/\/ > All these pregenerated classes can be examined by javap in the same image:\n+\/\/\/ > (Note to escape `$` in bash)\n+\/\/\/ > ```\n+\/\/\/ > javap -c -p -v java.lang.invoke.LambdaForm\\$Holder\n+\/\/\/ > ```\n+\/\/\/\n+\/\/\/ #### AOT Cache\n+\/\/\/ When creating an AOT cache, *traces* generated from the training run are\n+\/\/\/ captured and stored inside the AOT configuration file, and are accessed with\n+\/\/\/ the C++ `FinalImageRecipes` class.  Classes regenerated from these *traces*\n+\/\/\/ are linked in assembly phase; see `regeneratedClasses.hpp`.\n+\/\/\/\n+\/\/\/ @see #generateHolderClasses(Stream)\n+\/\/\/ @see BoundMethodHandle.Specializer\n+\/\/\/ @see DelegatingMethodHandle.Holder\n+\/\/\/ @see DirectMethodHandle.Holder\n+\/\/\/ @see Invokers.Holder\n+\/\/\/ @see LambdaForm.Holder\n+\/\/\/ @see VarHandleGuards\n+final class GenerateJLIClassesHelper {\n@@ -324,7 +385,17 @@\n-    \/*\n-     * Returns a map of class name in internal form to the corresponding class bytes\n-     * per the given stream of SPECIES_RESOLVE and LF_RESOLVE trace logs.\n-     *\n-     * Used by GenerateJLIClassesPlugin to pre-generate holder classes during\n-     * jlink phase.\n-     *\/\n+    \/\/\/ Returns a map from class names in internal form to the corresponding\n+    \/\/\/ class bytes.\n+    \/\/\/\n+    \/\/\/ A few known lambda forms, such as field accessors, can be comprehensively\n+    \/\/\/ generated.  Most others lambda forms are associated with unique method\n+    \/\/\/ types; thus they are generated per the given stream of SPECIES_RESOLVE\n+    \/\/\/ and LF_RESOLVE *trace* logs, which are created according to {@link\n+    \/\/\/ MethodHandleStatics#TRACE_RESOLVE} configuration.\n+    \/\/\/\n+    \/\/\/ The names of methods in the generated classes are internal tokens\n+    \/\/\/ recognized by [InvokerBytecodeGenerator#lookupPregenerated] and are\n+    \/\/\/ subject to change.\n+    \/\/\/\n+    \/\/\/ @param traces the *traces* to determine the lambda forms and species\n+    \/\/\/        to generate\n+    \/\/\/ @see MethodHandleStatics#traceLambdaForm\n+    \/\/\/ @see MethodHandleStatics#traceSpeciesType\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/GenerateJLIClassesHelper.java","additions":83,"deletions":12,"binary":false,"changes":95,"status":"modified"},{"patch":"@@ -448,0 +448,1 @@\n+    \/\/\/ Look up a method that may have been generated by [GenerateJLIClassesHelper].\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/InvokerBytecodeGenerator.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -700,1 +700,13 @@\n-    \/* Placeholder class for Invokers generated ahead of time *\/\n+    \/\/\/ Holds pre-generated bytecode for lambda forms used by method type invokers.\n+    \/\/\/\n+    \/\/\/ This class may be substituted in the JDK's modules image, or in an AOT\n+    \/\/\/ cache, by a version generated by [GenerateJLIClassesHelper].\n+    \/\/\/\n+    \/\/\/ The method names of this class are internal tokens recognized by\n+    \/\/\/ [InvokerBytecodeGenerator#lookupPregenerated] and is subject to change.\n+    \/\/\/\n+    \/\/\/ To view the actual content of this class in a JDK, run the `javap` in\n+    \/\/\/ that JDK with: (Note to escape `$` in bash)\n+    \/\/\/ ```\n+    \/\/\/ javap -c -p -v java.lang.invoke.Invokers\\$Holder\n+    \/\/\/ ```\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/Invokers.java","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -142,0 +142,3 @@\n+    \/\/\/ Represents the \"basic\" types that exist in the JVM linkage and stack\/locals.\n+    \/\/\/ All objects are erased to a reference.\n+    \/\/\/ All subwords (boolean, byte, char, short) are promoted to int.\n@@ -143,1 +146,1 @@\n-        L_TYPE('L', Object.class, Wrapper.OBJECT, TypeKind.REFERENCE), \/\/ all reference types\n+        L_TYPE('L', Object.class, Wrapper.OBJECT, TypeKind.REFERENCE),\n@@ -147,2 +150,2 @@\n-        D_TYPE('D', double.class, Wrapper.DOUBLE, TypeKind.DOUBLE),  \/\/ all primitive types\n-        V_TYPE('V', void.class,   Wrapper.VOID,   TypeKind.VOID);    \/\/ not valid in all contexts\n+        D_TYPE('D', double.class, Wrapper.DOUBLE, TypeKind.DOUBLE),  \/\/ end arg types\n+        V_TYPE('V', void.class,   Wrapper.VOID,   TypeKind.VOID);    \/\/ only valid in method return\n@@ -1733,1 +1736,13 @@\n-    \/* Placeholder class for identity and constant forms generated ahead of time *\/\n+    \/\/\/ Holds pre-generated bytecode for common lambda forms.\n+    \/\/\/\n+    \/\/\/ This class may be substituted in the JDK's modules image, or in an AOT\n+    \/\/\/ cache, by a version generated by [GenerateJLIClassesHelper].\n+    \/\/\/\n+    \/\/\/ The method names of this class are internal tokens recognized by\n+    \/\/\/ [InvokerBytecodeGenerator#lookupPregenerated] and is subject to change.\n+    \/\/\/\n+    \/\/\/ To view the actual content of this class in a JDK, run the `javap` in\n+    \/\/\/ that JDK with: (Note to escape `$` in bash)\n+    \/\/\/ ```\n+    \/\/\/ javap -c -p -v java.lang.invoke.LambdaForm\\$Holder\n+    \/\/\/ ```\n","filename":"src\/java.base\/share\/classes\/java\/lang\/invoke\/LambdaForm.java","additions":19,"deletions":4,"binary":false,"changes":23,"status":"modified"}]}