{"files":[{"patch":"@@ -30,1 +30,0 @@\n-import jdk.internal.misc.ThreadTracker;\n@@ -216,0 +215,3 @@\n+    \/\/ this will be set when the thread is initializing a JAR verifier\n+    private static final ScopedValue<Boolean> IN_VERIFIER_INIT = ScopedValue.newInstance();\n+\n@@ -1028,12 +1030,0 @@\n-    private static class ThreadTrackHolder {\n-        static final ThreadTracker TRACKER = new ThreadTracker();\n-    }\n-\n-    private static Object beginInit() {\n-        return ThreadTrackHolder.TRACKER.begin();\n-    }\n-\n-    private static void endInit(Object key) {\n-        ThreadTrackHolder.TRACKER.end(key);\n-    }\n-\n@@ -1046,8 +1036,18 @@\n-        if (jv != null && !jvInitialized) {\n-            Object key = beginInit();\n-            try {\n-                initializeVerifier();\n-                jvInitialized = true;\n-            } finally {\n-                endInit(key);\n-            }\n+        if (jv == null || jvInitialized) {\n+            return;\n+        }\n+        try {\n+            \/\/ mark the current thread as initializing\n+            \/\/ the JAR verifier\n+            ScopedValue.where(IN_VERIFIER_INIT, true).call(\n+                    new ScopedValue.CallableOp<Void, Exception>() {\n+                        @Override\n+                        public Void call() {\n+                            initializeVerifier();\n+                            jvInitialized = true;\n+                            return null;\n+                        }\n+                    });\n+        } catch (Exception e) {\n+            \/\/ should not happen\n+            throw new AssertionError(e);\n@@ -1057,0 +1057,3 @@\n+    \/**\n+     * {@return true if the current thread is initializing a JAR verifier, false otherwise}\n+     *\/\n@@ -1058,1 +1061,1 @@\n-        return ThreadTrackHolder.TRACKER.contains(Thread.currentThread());\n+        return IN_VERIFIER_INIT.isBound();\n","filename":"src\/java.base\/share\/classes\/java\/util\/jar\/JarFile.java","additions":25,"deletions":22,"binary":false,"changes":47,"status":"modified"}]}