{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -840,0 +840,46 @@\n+#ifdef ASSERT\n+void C2_MacroAssembler::checked_cast_int(const TypeInt* type, Register dst) {\n+  BLOCK_COMMENT(\"CastII {\");\n+  Label fail;\n+  Label succeed;\n+  cmpl(dst, type->_lo);\n+  jccb(Assembler::less, fail);\n+  cmpl(dst, type->_hi);\n+  jccb(Assembler::lessEqual, succeed);\n+  bind(fail);\n+  movl(rax, dst);\n+  movl(rcx, type->_lo);\n+  movl(rdx, type->_hi);\n+  hlt(); \/\/ hlt so we have the stack trace\n+  bind(succeed);\n+  BLOCK_COMMENT(\"} \/\/ CastII\");\n+}\n+\n+void C2_MacroAssembler::checked_cast_long(const TypeLong* type, Register dst, Register tmp) {\n+  BLOCK_COMMENT(\"CastLL {\");\n+  Label fail;\n+  Label succeed;\n+  if (is_simm32(type->_lo)) {\n+    cmpq(dst, checked_cast<int>(type->_lo));\n+  } else {\n+    mov64(tmp, type->_lo);\n+    cmpq(dst, tmp);\n+  }\n+  jccb(Assembler::less, fail);\n+  if (is_simm32(type->_hi)) {\n+    cmpq(dst, checked_cast<int>(type->_hi));\n+  } else {\n+    mov64(tmp, type->_hi);\n+    cmpq(dst, tmp);\n+  }\n+  jccb(Assembler::lessEqual, succeed);\n+  bind(fail);\n+  movq(rax, dst);\n+  mov64(rcx, type->_lo);\n+  mov64(rdx, type->_hi);\n+  hlt(); \/\/ hlt so we have the stack trace\n+  bind(succeed);\n+  BLOCK_COMMENT(\"} \/\/ CastLL\");\n+}\n+#endif \/\/ ASSERT\n+\n","filename":"src\/hotspot\/cpu\/x86\/c2_MacroAssembler_x86.cpp","additions":47,"deletions":1,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -47,0 +47,5 @@\n+#ifdef ASSERT\n+  void checked_cast_int(const TypeInt* type, Register dst);\n+  void checked_cast_long(const TypeLong* type, Register dst, Register tmp);\n+#endif\n+\n","filename":"src\/hotspot\/cpu\/x86\/c2_MacroAssembler_x86.hpp","additions":6,"deletions":1,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n-\/\/ Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n+\/\/ Copyright (c) 2003, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -6994,0 +6994,1 @@\n+  predicate(VerifyConstraintCasts == 0);\n@@ -7003,0 +7004,13 @@\n+instruct castII_checked(rRegI dst, rFlagsReg cr)\n+%{\n+  predicate(VerifyConstraintCasts > 0);\n+  match(Set dst (CastII dst));\n+\n+  effect(KILL cr);\n+  format %{ \"# checked_cast_II $dst\" %}\n+  ins_encode %{\n+    DEBUG_ONLY(__ checked_cast_int(bottom_type()->is_int(), $dst$$Register));\n+  %}\n+  ins_pipe(pipe_slow);\n+%}\n+\n@@ -7005,0 +7019,1 @@\n+  predicate(VerifyConstraintCasts == 0);\n@@ -7014,0 +7029,13 @@\n+instruct castLL_checked(rRegL dst, rRegL tmp, rFlagsReg cr)\n+%{\n+  predicate(VerifyConstraintCasts > 0);\n+  match(Set dst (CastLL dst));\n+\n+  effect(KILL cr, TEMP tmp);\n+  format %{ \"# checked_cast_LL $dst\" %}\n+  ins_encode %{\n+    DEBUG_ONLY(__ checked_cast_long(bottom_type()->is_long(), $dst$$Register, $tmp$$Register));\n+  %}\n+  ins_pipe(pipe_slow);\n+%}\n+\n","filename":"src\/hotspot\/cpu\/x86\/x86_64.ad","additions":29,"deletions":1,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -34,0 +34,2 @@\n+class TypeInt;\n+class TypeLong;\n","filename":"src\/hotspot\/share\/opto\/c2_MacroAssembler.hpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -663,0 +663,10 @@\n+  develop(uint, VerifyConstraintCasts, 0,                                   \\\n+          \"Perform runtime checks to verify the value of a \"                \\\n+          \"ConstraintCast lies inside its type\"                             \\\n+          \"0 = does not perform any verification, \"                         \\\n+          \"1 = perform verification on ConstraintCastNodes that are \"       \\\n+              \"present during code emission, \"                              \\\n+          \"2 = Do not do widening of ConstraintCastNodes so that we can \"   \\\n+              \"have more verification coverage\")                            \\\n+          range(0, 2)                                                       \\\n+                                                                            \\\n","filename":"src\/hotspot\/share\/opto\/c2_globals.hpp","additions":11,"deletions":1,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -527,0 +527,12 @@\n+\n+  \/\/ At VerifyConstraintCasts == 1, we verify the ConstraintCastNodes that are present during code\n+  \/\/ emission. This allows us detecting possible mis-scheduling due to these nodes being pinned at\n+  \/\/ the wrong control nodes.\n+  \/\/ At VerifyConstraintCasts == 2, we do not perform widening so that we can verify the\n+  \/\/ correctness of more ConstraintCastNodes. This further helps us detect possible\n+  \/\/ mis-transformations that may happen due to these nodes being pinned at the wrong control\n+  \/\/ nodes.\n+  if (VerifyConstraintCasts > 1) {\n+    return res;\n+  }\n+\n","filename":"src\/hotspot\/share\/opto\/castnode.cpp","additions":13,"deletions":1,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -0,0 +1,46 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8346836\n+ * @requires vm.debug == true & vm.flavor == \"server\"\n+ * @summary Run with -Xcomp to test -XX:+StressGCM -XX:VerifyConstraintCasts=1 in debug builds.\n+ *\n+ * @run main\/othervm\/timeout=300 -Xbatch -Xcomp -XX:+StressGCM -XX:VerifyConstraintCasts=1 compiler.c2.TestVerifyConstraintCasts\n+ *\/\n+\n+\/*\n+ * @test\n+ * @bug 8346836\n+ * @requires vm.debug == true & vm.flavor == \"server\"\n+ * @summary Run with -Xcomp to test -XX:+StressGCM -XX:VerifyConstraintCasts=2 in debug builds.\n+ *\n+ * @run main\/othervm\/timeout=300 -Xbatch -Xcomp -XX:+StressGCM -XX:VerifyConstraintCasts=2 compiler.c2.TestVerifyConstraintCasts\n+ *\/\n+package compiler.c2;\n+\n+public class TestVerifyConstraintCasts {\n+    public static void main(String[] args) {\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/TestVerifyConstraintCasts.java","additions":46,"deletions":0,"binary":false,"changes":46,"status":"added"}]}