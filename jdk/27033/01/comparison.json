{"files":[{"patch":"@@ -66,0 +66,1 @@\n+#include <new>\n@@ -299,1 +300,1 @@\n-  ResourceMark _rm;\n+  static int level;\n@@ -301,0 +302,4 @@\n+  bool _has_rm;\n+  \/\/ ResourceMark is only created if a Thread or a JavaThread is required,\n+  \/\/ and we are actually on a Thread.\n+  union { ResourceMark _rm; };\n@@ -302,5 +307,6 @@\n-  static int level;\n-  Command(const char* str) {\n-    if (level++ > 0)  return;\n-    tty->cr();\n-    tty->print_cr(\"\\\"Executing %s\\\"\", str);\n+  Command(const char* str) : _has_rm(false) {\n+    if (level++ == 0) {\n+      tty->cr();\n+      tty->print_cr(\"\\\"Executing %s\\\"\", str);\n+    }\n+    tty->flush();\n@@ -308,1 +314,0 @@\n-\n@@ -310,0 +315,1 @@\n+    if (_has_rm) _rm.~ResourceMark();\n@@ -313,0 +319,14 @@\n+\n+  bool onThread() {\n+    Thread* thread = Thread::current_or_null();\n+    if (thread == nullptr) {\n+      tty->print_cr(\"Failed: Current thread is not attached\");\n+      return false;\n+    }\n+\n+    if (!_has_rm) {\n+      ::new (&_rm) ResourceMark();\n+      _has_rm = true;\n+    }\n+    return true;\n+  }\n@@ -373,0 +393,1 @@\n+  if (!c.onThread()) return;\n@@ -382,0 +403,1 @@\n+  if (!c.onThread()) return;\n@@ -396,0 +418,1 @@\n+  if (!c.onThread()) return;\n@@ -422,3 +445,0 @@\n-  if (Thread::current_or_null() == nullptr) return;\n-  Command c(\"ps\");\n-\n@@ -426,0 +446,2 @@\n+  Command c(\"ps\");\n+  if (!c.onThread()) return;\n@@ -427,0 +449,4 @@\n+  if (p == nullptr) {\n+    tty->print_cr(\"Failed: JavaThread::active is null\");\n+    return;\n+  }\n@@ -453,0 +479,1 @@\n+  if (!c.onThread()) return;\n@@ -454,0 +481,4 @@\n+  if (p == nullptr) {\n+    tty->print_cr(\"Failed: JavaThread::active is null\");\n+    return;\n+  }\n@@ -463,9 +494,12 @@\n-  {\n-    Command c(\"psf\");\n-    JavaThread* p = JavaThread::active();\n-    tty->print(\" for thread: \");\n-    p->print();\n-    tty->cr();\n-    if (p->has_last_Java_frame()) {\n-      p->trace_frames();\n-    }\n+  Command c(\"psf\");\n+  if (!c.onThread()) return;\n+  JavaThread* p = JavaThread::active();\n+  if (p == nullptr) {\n+    tty->print_cr(\"Failed: JavaThread::active is null\");\n+    return;\n+  }\n+  tty->print(\" for thread: \");\n+  p->print();\n+  tty->cr();\n+  if (p->has_last_Java_frame()) {\n+    p->trace_frames();\n@@ -478,0 +512,1 @@\n+  if (!c.onThread()) return;\n@@ -484,0 +519,2 @@\n+  if (!c.onThread()) return;\n+\n@@ -489,1 +526,0 @@\n-  if (Thread::current_or_null() == nullptr) return;\n@@ -491,0 +527,1 @@\n+  if (!c.onThread()) return;\n@@ -537,0 +574,1 @@\n+  if (!c.onThread()) return;\n@@ -543,0 +581,1 @@\n+  if (!c.onThread()) return;\n@@ -554,0 +593,1 @@\n+  if (!c.onThread()) return;\n@@ -561,0 +601,1 @@\n+  if (!c.onThread()) return;\n@@ -647,0 +688,1 @@\n+  if (!c.onThread()) return;\n@@ -665,0 +707,1 @@\n+  if (!c.onThread()) return;\n","filename":"src\/hotspot\/share\/utilities\/debug.cpp","additions":63,"deletions":20,"binary":false,"changes":83,"status":"modified"}]}