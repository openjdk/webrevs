{"files":[{"patch":"@@ -299,1 +299,1 @@\n-  ResourceMark _rm;\n+  static int level;\n@@ -301,0 +301,4 @@\n+  bool _has_rm;\n+  \/\/ ResourceMark is only created if a Thread or a JavaThread is required,\n+  \/\/ and we are actually on a Thread.\n+  union { ResourceMark _rm; };\n@@ -302,5 +306,6 @@\n-  static int level;\n-  Command(const char* str) {\n-    if (level++ > 0)  return;\n-    tty->cr();\n-    tty->print_cr(\"\\\"Executing %s\\\"\", str);\n+  Command(const char* str) : _has_rm(false) {\n+    if (level++ == 0) {\n+      tty->cr();\n+      tty->print_cr(\"\\\"Executing %s\\\"\", str);\n+    }\n+    tty->flush();\n@@ -308,1 +313,0 @@\n-\n@@ -310,0 +314,1 @@\n+    if (_has_rm) _rm.~ResourceMark();\n@@ -313,0 +318,24 @@\n+\n+  bool onThread() {\n+    Thread* thread = Thread::current_or_null();\n+    if (thread == nullptr) {\n+      tty->print_cr(\"Failed: Current thread is not attached\");\n+      return false;\n+    }\n+\n+    if (!_has_rm) {\n+      ::new (&_rm) ResourceMark();\n+      _has_rm = true;\n+    }\n+    return true;\n+  }\n+\n+  bool onJavaThread() {\n+    if (!onThread()) return false;\n+\n+    if (JavaThread::active() == nullptr) {\n+      tty->print_cr(\"Failed: Current thread is not a java thread or the vm thread\");\n+      return false;\n+    }\n+    return true;\n+  }\n@@ -373,0 +402,1 @@\n+  if (!c.onThread()) return;\n@@ -382,0 +412,1 @@\n+  if (!c.onThread()) return;\n@@ -396,0 +427,1 @@\n+  if (!c.onThread()) return;\n@@ -422,1 +454,0 @@\n-  if (Thread::current_or_null() == nullptr) return;\n@@ -424,0 +455,1 @@\n+  if (!c.onJavaThread()) return;\n@@ -453,0 +485,1 @@\n+  if (!c.onJavaThread()) return;\n@@ -463,9 +496,8 @@\n-  {\n-    Command c(\"psf\");\n-    JavaThread* p = JavaThread::active();\n-    tty->print(\" for thread: \");\n-    p->print();\n-    tty->cr();\n-    if (p->has_last_Java_frame()) {\n-      p->trace_frames();\n-    }\n+  Command c(\"psf\");\n+  if (!c.onJavaThread()) return;\n+  JavaThread* p = JavaThread::active();\n+  tty->print(\" for thread: \");\n+  p->print();\n+  tty->cr();\n+  if (p->has_last_Java_frame()) {\n+    p->trace_frames();\n@@ -478,0 +510,1 @@\n+  if (!c.onThread()) return;\n@@ -484,0 +517,2 @@\n+  if (!c.onThread()) return;\n+\n@@ -489,1 +524,0 @@\n-  if (Thread::current_or_null() == nullptr) return;\n@@ -491,0 +525,1 @@\n+  if (!c.onThread()) return;\n@@ -537,0 +572,1 @@\n+  if (!c.onThread()) return;\n@@ -543,0 +579,1 @@\n+  if (!c.onThread()) return;\n@@ -554,0 +591,1 @@\n+  if (!c.onThread()) return;\n@@ -561,0 +599,1 @@\n+  if (!c.onThread()) return;\n@@ -647,0 +686,1 @@\n+  if (!c.onThread()) return;\n@@ -665,0 +705,1 @@\n+  if (!c.onThread()) return;\n","filename":"src\/hotspot\/share\/utilities\/debug.cpp","additions":59,"deletions":18,"binary":false,"changes":77,"status":"modified"}]}