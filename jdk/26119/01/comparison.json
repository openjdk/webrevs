{"files":[{"patch":"@@ -1885,4 +1885,6 @@\n-oop java_lang_Thread::async_get_stack_trace(oop java_thread, TRAPS) {\n-  ThreadsListHandle tlh(JavaThread::current());\n-  JavaThread* thread;\n-  bool is_virtual = java_lang_VirtualThread::is_instance(java_thread);\n+oop java_lang_Thread::async_get_stack_trace(jobject jthread, TRAPS) {\n+  ThreadsListHandle tlh(THREAD);\n+  JavaThread* java_thread = nullptr;\n+  oop thread_oop;\n+  tlh.cv_internal_thread_to_JavaThread(jthread, &java_thread, &thread_oop);\n+  bool is_virtual = java_lang_VirtualThread::is_instance(thread_oop);\n@@ -1890,1 +1892,1 @@\n-    oop carrier_thread = java_lang_VirtualThread::carrier_thread(java_thread);\n+    oop carrier_thread = java_lang_VirtualThread::carrier_thread(thread_oop);\n@@ -1894,3 +1896,1 @@\n-    thread = java_lang_Thread::thread(carrier_thread);\n-  } else {\n-    thread = java_lang_Thread::thread(java_thread);\n+    java_thread = java_lang_Thread::thread(carrier_thread);\n@@ -1898,1 +1898,2 @@\n-  if (thread == nullptr) {\n+  if (java_thread == nullptr) {\n+    \/\/ terminated platform thread or unmounted virtual thread\n@@ -1980,1 +1981,1 @@\n-  GetStackTraceHandshakeClosure gsthc(Handle(THREAD, java_thread));\n+  GetStackTraceHandshakeClosure gsthc(Handle(THREAD, thread_oop));\n@@ -1982,1 +1983,1 @@\n-   Handshake::execute(&gsthc, &tlh, thread);\n+   Handshake::execute(&gsthc, &tlh, java_thread);\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.cpp","additions":12,"deletions":11,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -462,1 +462,1 @@\n-  static oop async_get_stack_trace(oop java_thread, TRAPS);\n+  static oop async_get_stack_trace(jobject jthread, TRAPS);\n","filename":"src\/hotspot\/share\/classfile\/javaClasses.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2960,1 +2960,1 @@\n-  oop trace = java_lang_Thread::async_get_stack_trace(JNIHandles::resolve(jthread), THREAD);\n+  oop trace = java_lang_Thread::async_get_stack_trace(jthread, THREAD);\n","filename":"src\/hotspot\/share\/prims\/jvm.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}