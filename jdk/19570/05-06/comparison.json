{"files":[{"patch":"@@ -56,19 +56,15 @@\n-    } else {\n-      if (ALLOW_BLOCK) {\n-        ThreadBlockInVM block(java_thread);\n-        if (SafepointSynchronize::is_synchronizing()) {\n-          \/\/ If safepoint is pending, we want to block and allow safepoint to proceed.\n-          \/\/ Normally, TBIVM above would block us in its destructor.\n-          \/\/\n-          \/\/ But that blocking only happens when TBIVM knows the thread poll is armed.\n-          \/\/ There is a window between announcing a safepoint and arming the thread poll\n-          \/\/ during which trying to continuously enter TBIVM is counter-productive.\n-          \/\/ Under high contention, we may end up going in circles thousands of times.\n-          \/\/ To avoid it, we wait here until local poll is armed and then proceed\n-          \/\/ to TBVIM exit for blocking. We do not SpinPause, but yield to let\n-          \/\/ VM thread to arm the poll sooner.\n-          while (SafepointSynchronize::is_synchronizing() &&\n-                 !SafepointMechanism::local_poll_armed(java_thread)) {\n-            os::naked_yield();\n-          }\n-        } else {\n+    } else if (ALLOW_BLOCK) {\n+      ThreadBlockInVM block(java_thread);\n+      if (SafepointSynchronize::is_synchronizing()) {\n+        \/\/ If safepoint is pending, we want to block and allow safepoint to proceed.\n+        \/\/ Normally, TBIVM above would block us in its destructor.\n+        \/\/\n+        \/\/ But that blocking only happens when TBIVM knows the thread poll is armed.\n+        \/\/ There is a window between announcing a safepoint and arming the thread poll\n+        \/\/ during which trying to continuously enter TBIVM is counter-productive.\n+        \/\/ Under high contention, we may end up going in circles thousands of times.\n+        \/\/ To avoid it, we wait here until local poll is armed and then proceed\n+        \/\/ to TBVIM exit for blocking. We do not SpinPause, but yield to let\n+        \/\/ VM thread to arm the poll sooner.\n+        while (SafepointSynchronize::is_synchronizing() &&\n+               !SafepointMechanism::local_poll_armed(java_thread)) {\n@@ -80,0 +76,2 @@\n+    } else {\n+      os::naked_yield();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahLock.cpp","additions":17,"deletions":19,"binary":false,"changes":36,"status":"modified"}]}