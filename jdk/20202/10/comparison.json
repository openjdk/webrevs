{"files":[{"patch":"@@ -34,0 +34,1 @@\n+#include \"utilities\/bitMap.hpp\"\n@@ -695,1 +696,1 @@\n-  const size_t length = JVMFlag::numFlags - 1;\n+  constexpr size_t length = (sizeof(flagTable) \/ sizeof(JVMFlag)) - 1;\n@@ -704,8 +705,7 @@\n-  \/\/ Sort\n-  JVMFlag** array = NEW_C_HEAP_ARRAY_RETURN_NULL(JVMFlag*, length, mtArguments);\n-  if (array != nullptr) {\n-    for (size_t i = 0; i < length; i++) {\n-      array[i] = &flagTable[i];\n-    }\n-    qsort(array, length, sizeof(JVMFlag*), compare_flags);\n-\n+  BitMap::bm_word_t iteratorArray[BitMap::calc_size_in_words(length)];\n+  BitMapView iteratorMarkers(iteratorArray, length);\n+  iteratorMarkers.clear_range(0, length);\n+  \/\/ Print the flag with best sort value, then mark it.\n+  for (size_t j = 0; j < length; j++) {\n+    JVMFlag* bestFlag = nullptr;\n+    size_t bestFlagIndex = 0;\n@@ -713,2 +713,7 @@\n-      if (array[i]->is_unlocked() && !(skipDefaults && array[i]->is_default())) {\n-        array[i]->print_on(out, withComments, printRanges);\n+      const bool skip = (skipDefaults && flagTable[i].is_default());\n+      const bool visited = iteratorMarkers.at(i);\n+      if (!visited && flagTable[i].is_unlocked() && !skip) {\n+        if ((bestFlag == nullptr) || (strcmp(bestFlag->name(), flagTable[i].name()) > 0)) {\n+          bestFlag = &flagTable[i];\n+          bestFlagIndex = i;\n+        }\n@@ -717,7 +722,3 @@\n-    FREE_C_HEAP_ARRAY(JVMFlag*, array);\n-  } else {\n-    \/\/ OOM? Print unsorted.\n-    for (size_t i = 0; i < length; i++) {\n-      if (flagTable[i].is_unlocked() && !(skipDefaults && flagTable[i].is_default())) {\n-        flagTable[i].print_on(out, withComments, printRanges);\n-      }\n+    if (bestFlag != nullptr) {\n+      bestFlag->print_on(out, withComments, printRanges);\n+      iteratorMarkers.at_put(bestFlagIndex, true);\n","filename":"src\/hotspot\/share\/runtime\/flags\/jvmFlag.cpp","additions":19,"deletions":18,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -200,5 +200,0 @@\n-void BitMap::verify_size(idx_t size_in_bits) {\n-  assert(size_in_bits <= max_size_in_bits(),\n-         \"out of bounds: \" SIZE_FORMAT, size_in_bits);\n-}\n-\n","filename":"src\/hotspot\/share\/utilities\/bitMap.cpp","additions":0,"deletions":5,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -70,2 +70,2 @@\n-  static idx_t max_size_in_words() { return raw_to_words_align_down(~idx_t(0)); }\n-  static idx_t max_size_in_bits() { return max_size_in_words() * BitsPerWord; }\n+  constexpr static idx_t max_size_in_words() { return raw_to_words_align_down(~idx_t(0)); }\n+  constexpr static idx_t max_size_in_bits() { return max_size_in_words() * BitsPerWord; }\n@@ -74,1 +74,1 @@\n-  static idx_t raw_to_words_align_up(idx_t bit) {\n+  constexpr static idx_t raw_to_words_align_up(idx_t bit) {\n@@ -79,1 +79,1 @@\n-  static idx_t raw_to_words_align_down(idx_t bit) {\n+  constexpr static idx_t raw_to_words_align_down(idx_t bit) {\n@@ -198,1 +198,1 @@\n-  static idx_t calc_size_in_words(size_t size_in_bits) {\n+  constexpr static idx_t calc_size_in_words(size_t size_in_bits) {\n@@ -260,1 +260,7 @@\n-  static void verify_size(idx_t size_in_bits) NOT_DEBUG_RETURN;\n+  constexpr static void verify_size(idx_t size_in_bits) {\n+#ifdef ASSERT\n+    assert(size_in_bits <= max_size_in_bits(),\n+           \"out of bounds: \" SIZE_FORMAT, size_in_bits);\n+#endif\n+  }\n+\n","filename":"src\/hotspot\/share\/utilities\/bitMap.hpp","additions":12,"deletions":6,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -225,1 +225,1 @@\n-const int LogBytesPerWord    = 3;\n+constexpr int LogBytesPerWord    = 3;\n@@ -227,1 +227,1 @@\n-const int LogBytesPerWord    = 2;\n+constexpr int LogBytesPerWord    = 2;\n@@ -236,1 +236,1 @@\n-const int LogBitsPerByte     = 3;\n+constexpr int LogBitsPerByte     = 3;\n@@ -239,1 +239,1 @@\n-const int LogBitsPerWord     = LogBitsPerByte + LogBytesPerWord;\n+constexpr int LogBitsPerWord     = LogBitsPerByte + LogBytesPerWord;\n@@ -245,1 +245,1 @@\n-const int BitsPerWord        = 1 << LogBitsPerWord;\n+constexpr int BitsPerWord        = 1 << LogBitsPerWord;\n","filename":"src\/hotspot\/share\/utilities\/globalDefinitions.hpp","additions":5,"deletions":5,"binary":false,"changes":10,"status":"modified"}]}