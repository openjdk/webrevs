{"files":[{"patch":"@@ -389,10 +389,3 @@\n-            final Field field;\n-            final int modifiers;\n-            try {\n-                field = tclass.getDeclaredField(fieldName);\n-                modifiers = field.getModifiers();\n-                sun.reflect.misc.ReflectUtil.ensureMemberAccess(\n-                    caller, tclass, null, modifiers);\n-            } catch (Exception ex) {\n-                throw new RuntimeException(ex);\n-            }\n+            FieldUpdaterUtil.FieldAndModifiers fam =\n+                FieldUpdaterUtil.getFieldWithAccess(tclass, fieldName, caller);\n+            FieldUpdaterUtil.validateField(fam.field, int.class);\n@@ -400,3 +393,1 @@\n-            FieldUpdaterUtil.validateField(field, int.class);\n-\n-            this.cclass = FieldUpdaterUtil.computeAccessClass(tclass, caller, modifiers);\n+            this.cclass = FieldUpdaterUtil.computeAccessClass(tclass, caller, fam.modifiers);\n@@ -404,1 +395,1 @@\n-            this.offset = U.objectFieldOffset(field);\n+            this.offset = U.objectFieldOffset(fam.field);\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/atomic\/AtomicIntegerFieldUpdater.java","additions":5,"deletions":14,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -384,10 +384,3 @@\n-            final Field field;\n-            final int modifiers;\n-            try {\n-                field = tclass.getDeclaredField(fieldName);\n-                modifiers = field.getModifiers();\n-                sun.reflect.misc.ReflectUtil.ensureMemberAccess(\n-                    caller, tclass, null, modifiers);\n-            } catch (Exception ex) {\n-                throw new RuntimeException(ex);\n-            }\n+            FieldUpdaterUtil.FieldAndModifiers fam =\n+                FieldUpdaterUtil.getFieldWithAccess(tclass, fieldName, caller);\n+            FieldUpdaterUtil.validateField(fam.field, long.class);\n@@ -395,3 +388,1 @@\n-            FieldUpdaterUtil.validateField(field, long.class);\n-\n-            this.cclass = FieldUpdaterUtil.computeAccessClass(tclass, caller, modifiers);\n+            this.cclass = FieldUpdaterUtil.computeAccessClass(tclass, caller, fam.modifiers);\n@@ -399,1 +390,1 @@\n-            this.offset = U.objectFieldOffset(field);\n+            this.offset = U.objectFieldOffset(fam.field);\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/atomic\/AtomicLongFieldUpdater.java","additions":5,"deletions":14,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -345,12 +345,2 @@\n-            final Field field;\n-            final Class<?> fieldClass;\n-            final int modifiers;\n-            try {\n-                field = tclass.getDeclaredField(fieldName);\n-                modifiers = field.getModifiers();\n-                sun.reflect.misc.ReflectUtil.ensureMemberAccess(\n-                    caller, tclass, null, modifiers);\n-                fieldClass = field.getType();\n-            } catch (Exception ex) {\n-                throw new RuntimeException(ex);\n-            }\n+            FieldUpdaterUtil.FieldAndModifiers fam =\n+                FieldUpdaterUtil.getFieldWithAccess(tclass, fieldName, caller);\n@@ -358,1 +348,1 @@\n-            if (vclass != fieldClass)\n+            if (vclass != fam.field.getType())\n@@ -361,1 +351,1 @@\n-            FieldUpdaterUtil.validateField(field, null);\n+            FieldUpdaterUtil.validateField(fam.field, null);\n@@ -363,1 +353,1 @@\n-            this.cclass = FieldUpdaterUtil.computeAccessClass(tclass, caller, modifiers);\n+            this.cclass = FieldUpdaterUtil.computeAccessClass(tclass, caller, fam.modifiers);\n@@ -366,1 +356,1 @@\n-            this.offset = U.objectFieldOffset(field);\n+            this.offset = U.objectFieldOffset(fam.field);\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/atomic\/AtomicReferenceFieldUpdater.java","additions":6,"deletions":16,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import jdk.internal.reflect.Reflection;\n@@ -41,0 +42,29 @@\n+    \/**\n+     * Looks up a field and ensures the caller has access to it.\n+     *\n+     * @param tclass the class holding the field\n+     * @param fieldName the name of the field\n+     * @param caller the class constructing the updater\n+     * @param <T> the type of instances of tclass\n+     * @return the field and its modifiers\n+     * @throws RuntimeException if the field cannot be found or accessed\n+     *\/\n+    static <T> FieldAndModifiers getFieldWithAccess(Class<T> tclass, String fieldName, Class<?> caller) {\n+        try {\n+            Field field = tclass.getDeclaredField(fieldName);\n+            int modifiers = field.getModifiers();\n+            Reflection.ensureMemberAccess(caller, tclass, null, modifiers);\n+            return new FieldAndModifiers(field, modifiers);\n+        } catch (Exception ex) {\n+            throw new RuntimeException(ex);\n+        }\n+    }\n+\n+    \/**\n+     * Holds a field and its modifiers.\n+     *\n+     * @param field the field\n+     * @param modifiers the field's modifiers\n+     *\/\n+    static record FieldAndModifiers(Field field, int modifiers) {}\n+\n","filename":"src\/java.base\/share\/classes\/java\/util\/concurrent\/atomic\/FieldUpdaterUtil.java","additions":30,"deletions":0,"binary":false,"changes":30,"status":"modified"}]}