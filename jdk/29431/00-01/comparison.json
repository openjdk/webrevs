{"files":[{"patch":"@@ -29,0 +29,1 @@\n+import java.io.PrintStream;\n@@ -37,0 +38,1 @@\n+import java.net.SocketTimeoutException;\n@@ -51,1 +53,1 @@\n-import java.util.stream.IntStream;\n+import java.util.stream.Stream;\n@@ -53,0 +55,1 @@\n+import static java.lang.Boolean.parseBoolean;\n@@ -61,1 +64,1 @@\n- * @test\n+ * @test id=sync\n@@ -64,0 +67,1 @@\n+ * @requires os.family != \"windows\"\n@@ -65,3 +69,24 @@\n- * @run junit\/othervm -Dtest.proxy ${test.main.class}\n- * @run junit\/othervm -Dtest.async ${test.main.class}\n- * @run junit\/othervm -Dtest.async -Dtest.proxy ${test.main.class}\n+ *\/\n+\n+\/*\n+ * @test id=sync-proxy\n+ * @bug 8208391 8375352\n+ * @summary Verifies behavior on `connect()` timeouts\n+ * @requires os.family != \"windows\"\n+ * @run junit\/othervm -Dtest.proxy=true ${test.main.class}\n+ *\/\n+\n+\/*\n+ * @test id=async\n+ * @bug 8208391 8375352\n+ * @summary Verifies behavior on `connect()` timeouts\n+ * @requires os.family != \"windows\"\n+ * @run junit\/othervm -Dtest.async=true ${test.main.class}\n+ *\/\n+\n+\/*\n+ * @test id=async-proxy\n+ * @bug 8208391 8375352\n+ * @summary Verifies behavior on `connect()` timeouts\n+ * @requires os.family != \"windows\"\n+ * @run junit\/othervm -Dtest.async=true -Dtest.proxy=true ${test.main.class}\n@@ -72,0 +97,17 @@\n+    \/\/ This test verifies the `HttpClient` behavior on `connect()` failures.\n+    \/\/\n+    \/\/ Earlier, the test was trying to connect `example.com:8080` to trigger a `connect()` failure.\n+    \/\/ This worked, until it doesn't â€” `example.com:8080` started responding in certain test environments.\n+    \/\/\n+    \/\/ Now we create a `ServerSocket` and exhaust all its \"SYN backlog\" and \"Accept queue\".\n+    \/\/ The expectation is that the platform socket in this state will block on `connect()`.\n+    \/\/ Well... It doesn't on Windows, whereas it does on Linux and macOS.\n+    \/\/ Windows doesn't block and immediately responds with `java.net.ConnectException: Connection refused: connect`.\n+    \/\/ Neither it is deterministic how many connections are needed to exhaust a socket admission queue.\n+    \/\/ Hence, we took the following decisions:\n+    \/\/\n+    \/\/ 1. Skip this test on Windows\n+    \/\/ 2. Exhaust server socket admission queue by going into a loop\n+\n+    private static final PrintStream LOGGER = System.out;\n+\n@@ -75,1 +117,1 @@\n-     * A {@link ServerSocket} whose admission will be blocked by exhausting all its backlog.\n+     * A {@link ServerSocket} whose admission will be blocked by exhausting all its \"SYN backlog\" and \"Accept queue\".\n@@ -82,1 +124,1 @@\n-    private static final List<Socket> CLIENT_SOCKETS = createClientSockets();\n+    private static final List<Socket> CLIENT_SOCKETS = createClientSocketsExhaustingServerSocketAdmission();\n@@ -86,1 +128,1 @@\n-            System.err.println(\"Creating server socket\");\n+            LOGGER.println(\"Creating server socket\");\n@@ -93,18 +135,31 @@\n-    private static List<Socket> createClientSockets() {\n-        int socketCount = BACKLOG   \/\/ to fill up the backlog\n-                + 1;                \/\/ to connect\n-        return IntStream\n-                .range(0, socketCount)\n-                .mapToObj(socketIndex -> {\n-                    try {\n-                        System.err.printf(\n-                                \"Creating client socket %s\/%s to exhaust the server socket admission%n\",\n-                                (socketIndex + 1), socketCount);\n-                        return new Socket(SERVER_SOCKET.getInetAddress(), SERVER_SOCKET.getLocalPort());\n-                    } catch (IOException ioe) {\n-                        String message = String.format(\n-                                \"Failed creating client socket %s\/%s\",\n-                                (socketIndex + 1), socketCount);\n-                        throw new RuntimeException(message, ioe);\n-                    }\n-                }).toList();\n+    private static List<Socket> createClientSocketsExhaustingServerSocketAdmission() {\n+        List<Socket> sockets = new ArrayList<>();\n+        int maxSocketCount = BACKLOG   \/\/ To fill up the backlog\n+                + 512;                 \/\/ Giving some slack, should be enough to exhaust the admission queue.\n+        int socketIndex = 0;\n+        for (; socketIndex < maxSocketCount; socketIndex++) {\n+            try {\n+                LOGGER.printf(\n+                        \"Creating client socket %s\/%s to exhaust the server socket admission%n\",\n+                        (socketIndex + 1), maxSocketCount);\n+                Socket socket = new Socket();\n+                socket.connect(SERVER_SOCKET.getLocalSocketAddress(), 5000);\n+                sockets.add(socket);\n+            } catch (ConnectException | SocketTimeoutException exception) {\n+                LOGGER.printf(\n+                        \"Received expected `%s` while creating client socket %s\/%s%n\",\n+                        exception.getClass().getName(), (socketIndex + 1), maxSocketCount);\n+                return sockets;\n+            } catch (IOException ioe) {\n+                String message = String.format(\n+                        \"Received unexpected exception while creating client socket %s\/%s\",\n+                        (socketIndex + 1), maxSocketCount);\n+                closeSockets(SERVER_SOCKET, sockets);\n+                throw new RuntimeException(message, ioe);\n+            }\n+        }\n+        String message = String.format(\n+                \"Connected %s sockets, but still could not exhaust the socket admission\",\n+                maxSocketCount);\n+        closeSockets(SERVER_SOCKET, sockets);\n+        throw new RuntimeException(message);\n@@ -114,3 +169,19 @@\n-    public static void closeSockets() throws IOException {\n-        for (Socket CLIENT_SOCKET : CLIENT_SOCKETS) {\n-            CLIENT_SOCKET.close();\n+    public static void closeSockets() {\n+        closeSockets(SERVER_SOCKET, CLIENT_SOCKETS);\n+    }\n+\n+    private static void closeSockets(ServerSocket serverSocket, List<Socket> clientSockets) {\n+        Throwable[] throwable = {null};\n+        Stream.concat(clientSockets.stream(), Stream.of(serverSocket)).forEach(closeable -> {\n+            try {\n+                closeable.close();\n+            } catch (Exception exception) {\n+                if (throwable[0] == null) {\n+                    throwable[0] = exception;\n+                } else {\n+                    throwable[0].addSuppressed(exception);\n+                }\n+            }\n+        });\n+        if (throwable[0] != null) {\n+            throwable[0].printStackTrace(System.out);\n@@ -118,1 +189,0 @@\n-        SERVER_SOCKET.close();\n@@ -181,2 +251,2 @@\n-        ProxySelector proxySelector = System.getProperty(\"test.proxy\") != null ? PROXY_SELECTOR : NO_PROXY;\n-        boolean async = System.getProperty(\"test.async\") != null;\n+        ProxySelector proxySelector = parseBoolean(System.getProperty(\"test.proxy\")) ? PROXY_SELECTOR : NO_PROXY;\n+        boolean async = parseBoolean(System.getProperty(\"test.async\"));\n@@ -202,1 +272,1 @@\n-            System.err.printf(\"iteration %d%n\", i);\n+            LOGGER.printf(\"iteration %d%n\", i);\n@@ -210,1 +280,1 @@\n-                System.err.printf(\"Client: received in %d millis%n\", elapsedTime);\n+                LOGGER.printf(\"Client: received in %d millis%n\", elapsedTime);\n@@ -214,1 +284,1 @@\n-                System.err.printf(\"Client: received in %d millis%n\", elapsedTime);\n+                LOGGER.printf(\"Client: received in %d millis%n\", elapsedTime);\n@@ -217,1 +287,1 @@\n-                    e.printStackTrace(System.err);\n+                    e.printStackTrace(LOGGER);\n@@ -220,1 +290,1 @@\n-                    System.err.printf(\"Caught ConnectException with \"\n+                    LOGGER.printf(\"Caught ConnectException with \"\n@@ -236,1 +306,1 @@\n-            System.err.printf(\"iteration %d%n\", i);\n+            LOGGER.printf(\"iteration %d%n\", i);\n@@ -244,1 +314,1 @@\n-                System.err.printf(\"Client: received in %d millis%n\", elapsedTime);\n+                LOGGER.printf(\"Client: received in %d millis%n\", elapsedTime);\n@@ -248,1 +318,1 @@\n-                    System.err.printf(\"Caught ConnectException with \"\n+                    LOGGER.printf(\"Caught ConnectException with \"\n@@ -291,1 +361,1 @@\n-            t.printStackTrace(System.err);\n+            t.printStackTrace(LOGGER);\n@@ -296,1 +366,1 @@\n-            t.printStackTrace(System.err);\n+            t.printStackTrace(LOGGER);\n@@ -299,1 +369,1 @@\n-        System.err.printf(\"Caught expected HttpConnectTimeoutException with ConnectException\"\n+        LOGGER.printf(\"Caught expected HttpConnectTimeoutException with ConnectException\"\n@@ -308,3 +378,3 @@\n-        System.err.println(\"Unexpected response: \" + response);\n-        System.err.println(\"Headers: \" + response.headers());\n-        System.err.println(\"Body: \" + response.body());\n+        LOGGER.println(\"Unexpected response: \" + response);\n+        LOGGER.println(\"Headers: \" + response.headers());\n+        LOGGER.println(\"Body: \" + response.body());\n@@ -312,0 +382,1 @@\n+\n","filename":"test\/jdk\/java\/net\/httpclient\/ConnectTimeoutTest.java","additions":117,"deletions":46,"binary":false,"changes":163,"status":"modified"}]}