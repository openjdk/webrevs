{"files":[{"patch":"@@ -67,19 +67,4 @@\n-        static final MethodHandle CALLOC;\n-        static final MethodHandle FREE;\n-        static final Consumer<MemorySegment> CLEANUP;\n-\n-        static {\n-            var linker = Linker.nativeLinker();\n-            var lookup = linker.defaultLookup();\n-            var callocAddr = lookup.findOrThrow(\"calloc\");\n-            var freeAddr = lookup.findOrThrow(\"free\");\n-            CALLOC = linker.downcallHandle(callocAddr, FunctionDescriptor.of(ValueLayout.JAVA_LONG, ValueLayout.JAVA_LONG, ValueLayout.JAVA_LONG));\n-            FREE = linker.downcallHandle(freeAddr, FunctionDescriptor.ofVoid(ValueLayout.JAVA_LONG));\n-            CLEANUP = ms -> {\n-                try {\n-                    FREE.invokeExact(ms.address());\n-                } catch (Throwable e) {\n-                    throw new AssertionError(e);\n-                }\n-            };\n-        }\n+        static final MethodHandle CALLOC = Linker.nativeLinker()\n+                .downcallHandle(\n+                        Linker.nativeLinker().defaultLookup().findOrThrow(\"calloc\"),\n+                        FunctionDescriptor.of(ValueLayout.ADDRESS, ValueLayout.JAVA_LONG, ValueLayout.JAVA_LONG));\n@@ -87,1 +72,1 @@\n-        static long calloc(long size) {\n+        static MemorySegment calloc(long size) {\n@@ -89,3 +74,3 @@\n-                return (long)CALLOC.invokeExact(1L, size);\n-            } catch (Throwable e) {\n-                throw new AssertionError(e);\n+                return (MemorySegment)CALLOC.invokeExact(size, 1L);\n+            } catch (Throwable ex) {\n+                throw new IllegalStateException(ex);\n@@ -109,2 +94,2 @@\n-            long address = calloc(byteSize);\n-            return MemorySegment.ofAddress(address).reinterpret(byteSize, arena, CLEANUP);\n+            return calloc(byteSize)\n+                    .reinterpret(byteSize, arena, CLayouts::freeMemory);\n","filename":"test\/micro\/org\/openjdk\/bench\/java\/lang\/foreign\/AllocTest.java","additions":10,"deletions":25,"binary":false,"changes":35,"status":"modified"}]}