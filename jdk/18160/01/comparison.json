{"files":[{"patch":"@@ -2491,4 +2491,12 @@\n-  \/\/ share global compressor, local DumpWriter is not responsible for its life cycle\n-  DumpWriter segment_writer(DumpMerger::get_writer_path(writer()->get_file_path(), dumper_id),\n-                            writer()->is_overwrite(), writer()->compressor());\n-  if (!segment_writer.has_error()) {\n+  \/\/ For serial heap dump, write everything directly to global writer.\n+  DumpWriter* local_writer = writer();\n+  \/\/ For parallel heap dump, create a segment writer for a separte file\n+  \/\/ containing a segment of the dump.\n+  if (is_parallel_dump()) {\n+    \/\/ share global compressor, local DumpWriter is not responsible for its life cycle\n+    local_writer = new DumpWriter(\n+        DumpMerger::get_writer_path(writer()->get_file_path(), dumper_id),\n+        writer()->is_overwrite(), writer()->compressor());\n+  }\n+\n+  if (!local_writer->has_error()) {\n@@ -2499,1 +2507,1 @@\n-      ClassDumper class_dumper(&segment_writer);\n+      ClassDumper class_dumper(local_writer);\n@@ -2503,1 +2511,1 @@\n-      dump_threads(&segment_writer);\n+      dump_threads(local_writer);\n@@ -2506,1 +2514,1 @@\n-      JNIGlobalsDumper jni_dumper(&segment_writer);\n+      JNIGlobalsDumper jni_dumper(local_writer);\n@@ -2514,1 +2522,1 @@\n-      StickyClassDumper stiky_class_dumper(&segment_writer);\n+      StickyClassDumper stiky_class_dumper(local_writer);\n@@ -2527,1 +2535,1 @@\n-    HeapObjectDumper obj_dumper(&segment_writer, this);\n+    HeapObjectDumper obj_dumper(local_writer, this);\n@@ -2535,2 +2543,2 @@\n-    segment_writer.finish_dump_segment();\n-    segment_writer.flush();\n+    local_writer->finish_dump_segment();\n+    local_writer->flush();\n@@ -2539,1 +2547,3 @@\n-  _dumper_controller->dumper_complete(&segment_writer, writer());\n+  if (is_parallel_dump()) {\n+    _dumper_controller->dumper_complete(local_writer, writer());\n+    delete local_writer;\n@@ -2541,2 +2551,2 @@\n-  if (is_vm_dumper(dumper_id)) {\n-    _dumper_controller->wait_all_dumpers_complete();\n+    if (is_vm_dumper(dumper_id)) {\n+      _dumper_controller->wait_all_dumpers_complete();\n@@ -2544,2 +2554,2 @@\n-    \/\/ flush global writer\n-    writer()->flush();\n+      \/\/ flush global writer\n+      writer()->flush();\n@@ -2547,2 +2557,3 @@\n-    \/\/ At this point, all fragments of the heapdump have been written to separate files.\n-    \/\/ We need to merge them into a complete heapdump and write HPROF_HEAP_DUMP_END at that time.\n+      \/\/ At this point, all fragments of the heapdump have been written to separate files.\n+      \/\/ We need to merge them into a complete heapdump and write HPROF_HEAP_DUMP_END at that time.\n+    }\n@@ -2653,15 +2664,3 @@\n-  \/\/ Heap dump process is done in two phases\n-  \/\/\n-  \/\/ Phase 1: Concurrent threads directly write heap data to multiple heap files.\n-  \/\/          This is done by VM_HeapDumper, which is performed within safepoint.\n-  \/\/\n-  \/\/ Phase 2: Merge multiple heap files into one complete heap dump file.\n-  \/\/          This is done by DumpMerger, which is performed outside safepoint\n-\n-  DumpMerger merger(path, &writer, dumper.dump_seq());\n-  Thread* current_thread = Thread::current();\n-  if (current_thread->is_AttachListener_thread()) {\n-    \/\/ perform heapdump file merge operation in the current thread prevents us\n-    \/\/ from occupying the VM Thread, which in turn affects the occurrence of\n-    \/\/ GC and other VM operations.\n-    merger.do_merge();\n+  if (!dumper.is_parallel_dump()) {\n+    DumperSupport::end_of_dump(&writer);\n+    writer.flush();\n@@ -2669,3 +2668,20 @@\n-    \/\/ otherwise, performs it by VM thread\n-    VM_HeapDumpMerge op(&merger);\n-    VMThread::execute(&op);\n+    \/\/ Heap dump process is done in two phases\n+    \/\/\n+    \/\/ Phase 1: Concurrent threads directly write heap data to multiple heap files.\n+    \/\/          This is done by VM_HeapDumper, which is performed within safepoint.\n+    \/\/\n+    \/\/ Phase 2: Merge multiple heap files into one complete heap dump file.\n+    \/\/          This is done by DumpMerger, which is performed outside safepoint\n+\n+    DumpMerger merger(path, &writer, dumper.dump_seq());\n+    Thread* current_thread = Thread::current();\n+    if (current_thread->is_AttachListener_thread()) {\n+      \/\/ perform heapdump file merge operation in the current thread prevents us\n+      \/\/ from occupying the VM Thread, which in turn affects the occurrence of\n+      \/\/ GC and other VM operations.\n+      merger.do_merge();\n+    } else {\n+      \/\/ otherwise, performs it by VM thread\n+      VM_HeapDumpMerge op(&merger);\n+      VMThread::execute(&op);\n+    }\n","filename":"src\/hotspot\/share\/services\/heapDumper.cpp","additions":52,"deletions":36,"binary":false,"changes":88,"status":"modified"}]}