{"files":[{"patch":"@@ -1063,0 +1063,23 @@\n+  \/\/ The speculative check also needs to create the pointer expressions for both\n+  \/\/ VPointers. We must check that we can do that, i.e. that all variables of the\n+  \/\/ VPointers are available at the speculative check (and not just pre-loop invariant).\n+  if (!this->can_make_pointer_expression_at_speculative_check()) {\n+#ifdef ASSERT\n+    if (_vloop.is_trace_speculative_aliasing_analysis()) {\n+      tty->print_cr(\"VPointer::can_make_speculative_aliasing_check_with: not all variables of VPointer are avaialbe at speculative check!\");\n+      this->print_on(tty);\n+    }\n+#endif\n+    return false;\n+  }\n+\n+  if (!other.can_make_pointer_expression_at_speculative_check()) {\n+#ifdef ASSERT\n+    if (_vloop.is_trace_speculative_aliasing_analysis()) {\n+      tty->print_cr(\"VPointer::can_make_speculative_aliasing_check_with: not all variables of VPointer are avaialbe at speculative check!\");\n+      other.print_on(tty);\n+    }\n+#endif\n+    return false;\n+  }\n+\n@@ -1150,0 +1173,2 @@\n+  assert(vp1.can_make_pointer_expression_at_speculative_check(), \"variables must be available early enough to avoid cycles\");\n+  assert(vp2.can_make_pointer_expression_at_speculative_check(), \"variables must be available early enough to avoid cycles\");\n","filename":"src\/hotspot\/share\/opto\/vectorization.cpp","additions":25,"deletions":0,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -1191,0 +1191,16 @@\n+  \/\/ We already know that all non-iv summands are pre loop invariant.\n+  \/\/ See init_are_non_iv_summands_pre_loop_invariant\n+  \/\/ That is good enough for alignment computations in the pre-loop limit. But it is not\n+  \/\/ sufficient if we want to use the variables of the VPointer at the speculative check,\n+  \/\/ which is further up before the pre-loop.\n+  bool can_make_pointer_expression_at_speculative_check() const {\n+    bool success = true;\n+    mem_pointer().for_each_non_empty_summand([&] (const MemPointerSummand& s) {\n+      Node* variable = s.variable();\n+      if (variable != _vloop.iv() && !_vloop.is_available_for_speculative_check(variable)) {\n+        success = false;\n+      }\n+    });\n+    return success;\n+  }\n+\n","filename":"src\/hotspot\/share\/opto\/vectorization.hpp","additions":16,"deletions":0,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -0,0 +1,72 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test id=with-flags\n+ * @bug 8373502\n+ * @summary Test where a VPointer variable was pinned at the pre-loop, but not available at the\n+ *          Auto_Vectorization_Check, and so it should not be used for the auto vectorization\n+ *          aliasing check, to avoid a bad (circular) graph.\n+ * @run main\/othervm\n+ *      -XX:+IgnoreUnrecognizedVMOptions\n+ *      -XX:CompileCommand=compileonly,*TestAliasingCheckVPointerVariablesNotAvailable::test\n+ *      -XX:-TieredCompilation\n+ *      -Xcomp\n+ *      ${test.main.class}\n+ *\/\n+\n+\/*\n+ * @test id=vanilla\n+ * @bug 8373502\n+ * @run main ${test.main.class}\n+ *\/\n+\n+package compiler.loopopts.superword;\n+\n+public class TestAliasingCheckVPointerVariablesNotAvailable {\n+    static int iFld;\n+\n+    public static void main(String[] strArr) {\n+        test();\n+    }\n+\n+    static void test() {\n+        int iArr[] = new int[400];\n+        boolean flag = false;\n+        for (int i = 6; i < 50000; i++) { \/\/ Trigger OSR\n+            try {\n+                int x = 234 \/ iFld;\n+                iFld = iArr[3];\n+            } catch (ArithmeticException a_e) {\n+            }\n+            for (int j = i; j < 2; j++) {\n+                if (flag) {\n+                    iArr[j] = 117;\n+                } else {\n+                    iArr[1] = 34;\n+                }\n+                iArr[1] += i;\n+            }\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/compiler\/loopopts\/superword\/TestAliasingCheckVPointerVariablesNotAvailable.java","additions":72,"deletions":0,"binary":false,"changes":72,"status":"added"}]}