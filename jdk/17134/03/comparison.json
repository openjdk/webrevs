{"files":[{"patch":"@@ -1644,0 +1644,13 @@\n+  static bool is_vthread_mounted(oop vt) {\n+    \/\/ The code should be consistent with the \"mounted virtual thread\" case\n+    \/\/ (VM_HeapDumper::dump_stack_traces(), ThreadDumper::get_top_frame()).\n+    \/\/ I.e. virtual thread is mounted if its carrierThread is not null\n+    \/\/ and is_vthread_mounted() for the carrier thread returns true.\n+    oop carrier_thread = java_lang_VirtualThread::carrier_thread(vt);\n+    if (carrier_thread == nullptr) {\n+      return false;\n+    }\n+    JavaThread* java_thread = java_lang_Thread::thread(carrier_thread);\n+    return java_thread->is_vthread_mounted();\n+  }\n+\n@@ -1921,1 +1934,4 @@\n-    if (java_lang_VirtualThread::is_instance(o) && ThreadDumper::should_dump_vthread(o)) {\n+    \/\/ If we encounter an unmounted virtual thread it needs to be dumped explicitly\n+    \/\/ (mounted virtual threads are dumped with their carriers).\n+    if (java_lang_VirtualThread::is_instance(o)\n+        && ThreadDumper::should_dump_vthread(o) && !ThreadDumper::is_vthread_mounted(o)) {\n","filename":"src\/hotspot\/share\/services\/heapDumper.cpp","additions":17,"deletions":1,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+import java.util.HashSet;\n@@ -30,0 +31,1 @@\n+import java.util.Set;\n@@ -226,0 +228,3 @@\n+            \/\/ And detect thread object duplicates.\n+            Set<Long> uniqueThreads = new HashSet<>();\n+\n@@ -228,0 +233,2 @@\n+                JavaHeapObject threadObj = snapshot.findThing(thread.getId());\n+                JavaClass threadClass = threadObj.getClazz();\n@@ -230,1 +237,7 @@\n-                log(\"thread \" + thread.getIdString() + \", \" + frames.length + \" frames\");\n+                log(\"thread \" + thread.getIdString() + \" (\" + threadClass.getName() + \"), \" + frames.length + \" frames\");\n+\n+                if (uniqueThreads.contains(thread.getId())) {\n+                    log(\" - ERROR: duplicate\");\n+                } else {\n+                    uniqueThreads.add(thread.getId());\n+                }\n@@ -253,0 +266,4 @@\n+            if (threads.size() != uniqueThreads.size()) {\n+                throw new RuntimeException(\"Thread duplicates detected (\" + (threads.size() - uniqueThreads.size()) + \")\");\n+            }\n+\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/vthread\/HeapDump\/VThreadInHeapDump.java","additions":18,"deletions":1,"binary":false,"changes":19,"status":"modified"}]}