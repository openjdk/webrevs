{"files":[{"patch":"@@ -79,2 +79,0 @@\n-serviceability\/jvmti\/NMethodRelocation\/NMethodRelocationTest.java 8369150 generic-all\n-\n","filename":"test\/hotspot\/jtreg\/ProblemList.txt","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -25,0 +25,7 @@\n+ * This test verifies that COMPILED_METHOD_LOAD and COMPILED_METHOD_UNLOAD\n+ * events are correctly sent for relocated nmethods. In some cases, these\n+ * events may not be received if the VM exits. For this reason, the test will\n+ * issue a warning but still pass when the events are not observed.\n+ * However, the test will fail if the method fails to compile or if the\n+ * nmethod fails to relocate.\n+\n@@ -26,1 +33,0 @@\n- *\n@@ -31,0 +37,2 @@\n+ * @requires vm.flavor == \"server\" & (vm.opt.TieredStopAtLevel == null | vm.opt.TieredStopAtLevel == 4)\n+ * @requires !vm.emulatedClient\n@@ -58,0 +66,1 @@\n+                \"-Xbatch\",\n@@ -75,1 +84,1 @@\n-        Pattern pattern = Pattern.compile(\"(?m)^Relocated nmethod from (0x[0-9a-f]{16}) to (0x[0-9a-f]{16})$\");\n+        Pattern pattern = Pattern.compile(\"<COMPILED_METHOD_LOAD>:   name: compiledMethod, code: (0x[0-9a-f]{16})\");\n@@ -78,3 +87,6 @@\n-        if (matcher.find()) {\n-            String fromAddr = matcher.group(1);\n-            String toAddr = matcher.group(2);\n+        if (!matcher.find()) {\n+            System.err.println(oa.getOutput());\n+            System.err.println(\"WARNING: Unable to find first COMPILED_METHOD_LOAD event\");\n+            return;\n+        }\n+        String fromAddr = matcher.group(1);\n@@ -82,6 +94,1 @@\n-            \/\/ Confirm events sent for both original and relocated nmethod\n-            oa.shouldContain(\"<COMPILED_METHOD_LOAD>:   name: compiledMethod, code: \" + fromAddr);\n-            oa.shouldContain(\"<COMPILED_METHOD_LOAD>:   name: compiledMethod, code: \" + toAddr);\n-            oa.shouldContain(\"<COMPILED_METHOD_UNLOAD>:   name: compiledMethod, code: \" + fromAddr);\n-            oa.shouldContain(\"<COMPILED_METHOD_UNLOAD>:   name: compiledMethod, code: \" + toAddr);\n-        } else {\n+        if (!matcher.find()) {\n@@ -89,1 +96,17 @@\n-            throw new RuntimeException(\"Unable to find relocation information\");\n+            System.err.println(\"WARNING: Unable to find second COMPILED_METHOD_LOAD event\");\n+            return;\n+        }\n+        String toAddr = matcher.group(1);\n+\n+        \/\/ Confirm the nmethod was actually relocated\n+        Asserts.assertTrue(fromAddr != toAddr);\n+\n+        \/\/ Check for UNLOAD events but only warn if missing\n+        if (!output.contains(\"<COMPILED_METHOD_UNLOAD>:   name: compiledMethod, code: \" + fromAddr)) {\n+            System.err.println(oa.getOutput());\n+            System.err.println(\"WARNING: COMPILED_METHOD_UNLOAD event not found for address: \" + fromAddr);\n+        }\n+\n+        if (!output.contains(\"<COMPILED_METHOD_UNLOAD>:   name: compiledMethod, code: \" + toAddr)) {\n+            System.err.println(oa.getOutput());\n+            System.err.println(\"WARNING: COMPILED_METHOD_UNLOAD event not found for address: \" + toAddr);\n@@ -145,2 +168,3 @@\n-        while (WHITE_BOX.isMethodQueuedForCompilation(method)) {\n-            Thread.onSpinWait();\n+\n+        if(!WHITE_BOX.isMethodCompiled(method)) {\n+            throw new AssertionError(\"Method not compiled\");\n@@ -170,3 +194,0 @@\n-        WHITE_BOX.lockCompilation();\n-\n-        System.out.printf(\"Relocated nmethod from 0x%016x to 0x%016x%n\", originalNMethod.code_begin, relocatedNMethod.code_begin);\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/NMethodRelocation\/NMethodRelocationTest.java","additions":38,"deletions":17,"binary":false,"changes":55,"status":"modified"}]}