{"files":[{"patch":"@@ -80,1 +80,1 @@\n-            pipesForPid(MY_PID);\n+            lsofForAll();\n@@ -93,1 +93,2 @@\n-        Set<PipeRecord> pipesBefore = pipesForPid(MY_PID);\n+        List<String> lsofLines = lsofForAll();\n+        Set<PipeRecord> pipesBefore = pipesFromLSOF(lsofLines, MY_PID);\n@@ -95,0 +96,3 @@\n+            \/\/ Dump all lsof output to aid debugging\n+            System.out.println(\"Output from lsof\");\n+            lsofLines.forEach(System.err::println);\n@@ -125,1 +129,2 @@\n-        Set<PipeRecord> pipesAfter = pipesForPid(MY_PID);\n+        lsofLines = lsofForAll();\n+        Set<PipeRecord> pipesAfter = pipesFromLSOF(lsofLines, MY_PID);\n@@ -133,0 +138,3 @@\n+            \/\/ Dump all lsof output to aid debugging\n+            System.out.println(\"\\nOutput from lsof\");\n+            lsofLines.forEach(System.err::println);\n@@ -154,1 +162,2 @@\n-            final Set<PipeRecord> pipes = pipesForPid(p.pid());\n+            List<String> lsofLines = lsofForAll();\n+            final Set<PipeRecord> pipes = pipesFromLSOF(lsofLines, p.pid());\n@@ -157,0 +166,5 @@\n+            if (uniquePipes != pipes.size()) {\n+                \/\/ Dump all lsof output to aid debugging\n+                System.out.println(\"\\nOutput from lsof\");\n+                lsofLines.forEach(System.err::println);\n+            }\n@@ -188,1 +202,0 @@\n-     * Files are used for `lsof` input and output to avoid creating pipes.\n@@ -191,3 +204,30 @@\n-    static Set<PipeRecord> pipesForPid(long pid) throws IOException {\n-        Path lsofEmptyInput = Files.createTempFile(\"lsof-\", \"empty\");\n-        Path lsofOutput = Files.createTempFile(\"lsof-\", \"tmp\");\n+    private static Set<PipeRecord> pipesForPid(long pid) throws IOException {\n+        var lines = lsofForAll();\n+        return pipesFromLSOF(lines, pid);\n+    }\n+\n+    \/**\n+     * Extract the PipeRecords from the `lsof` output for this process and a designated child process.\n+     *\n+     * @param lines lines of lsof output\n+     * @param pid pid of child process of interest\n+     * @return a Set of PipeRecords for parent and child\n+     *\/\n+    private static LinkedHashSet<PipeRecord> pipesFromLSOF(List<String> lines, long pid) {\n+        return lines.stream()\n+                .map(PipelineLeaksFD::pipeFromLSOF)\n+                .filter(pr -> pr != null &&\n+                        (pr.pid() == pid || pr.pid() == MY_PID))\n+                .collect(Collectors.toCollection(LinkedHashSet::new));\n+    }\n+\n+    \/**\n+     * Collect the output of `lsof` for all files.\n+     * Files are used for `lsof` input and output to avoid creating pipes.\n+     * @return a List of lines output from `lsof`.\n+     *\/\n+    private static List<String> lsofForAll() throws IOException {\n+        Path tmpDir = Path.of(\".\");\n+        String tmpPrefix = \"lsof-\";\n+        Path lsofEmptyInput = Files.createTempFile(tmpDir, tmpPrefix, \".empty\");\n+        Path lsofOutput = Files.createTempFile(tmpDir, tmpPrefix, \".tmp\");\n@@ -202,7 +242,1 @@\n-            List<String> lines = Files.readAllLines(lsofOutput);\n-            \/\/ Collect all the pipes for the processes (parent, waiting child)\n-            return lines.stream()\n-                    .map(PipelineLeaksFD::pipeFromLSOF)\n-                    .filter(pr -> pr != null &&\n-                            (pr.pid() == pid || pr.pid() == MY_PID))\n-                    .collect(Collectors.toCollection(LinkedHashSet::new));\n+            return Files.readAllLines(lsofOutput);\n","filename":"test\/jdk\/java\/lang\/ProcessBuilder\/PipelineLeaksFD.java","additions":49,"deletions":15,"binary":false,"changes":64,"status":"modified"}]}