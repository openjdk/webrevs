{"files":[{"patch":"@@ -29,1 +29,0 @@\n-import java.io.InputStream;\n@@ -33,0 +32,2 @@\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n@@ -145,0 +146,5 @@\n+            String expectedTypeName = redirectError\n+                    ? \"java.lang.ProcessBuilder$NullInputStream\"\n+                    : \"java.lang.ProcessImpl$ProcessPipeInputStream\";\n+            assertEquals(expectedTypeName, p.getErrorStream().getClass().getName(),\n+                    \"errorStream type is incorrect\");\n@@ -169,2 +175,1 @@\n-     * The pipes used by invoking the `lsof` process are removed from set captured\n-     * for the parent (this test) and the child (waiting).\n+     * Files are used for `lsof` input and output to avoid creating pipes.\n@@ -174,0 +179,2 @@\n+        Path lsofEmptyInput = Files.createTempFile(\"lsof-\", \"empty\");\n+        Path lsofOutput = Files.createTempFile(\"lsof-\", \"tmp\");\n@@ -175,1 +182,3 @@\n-                .redirectErrorStream(true)\n+                .redirectOutput(lsofOutput.toFile())\n+                .redirectInput(lsofEmptyInput.toFile()) \/\/ empty input\n+                .redirectError(ProcessBuilder.Redirect.DISCARD) \/\/ ignored output\n@@ -177,2 +186,2 @@\n-            long lsofPid = p.pid();\n-            List<String> lines = p.inputReader().readAllLines();\n+            int status = p.waitFor();\n+            assertEquals(0, status, \"Process 'lsof' failed\");\n@@ -180,2 +189,3 @@\n-            \/\/ Collect all the pipes for the three processes (parent, waiting child, lsof)\n-            Set<PipeRecord> pipes = lines.stream()\n+            List<String> lines = Files.readAllLines(lsofOutput);\n+            \/\/ Collect all the pipes for the processes (parent, waiting child)\n+            return lines.stream()\n@@ -184,1 +194,1 @@\n-                            (pr.pid() == pid || pr.pid() == MY_PID || pr.pid() == lsofPid))\n+                            (pr.pid() == pid || pr.pid() == MY_PID))\n@@ -186,7 +196,2 @@\n-            \/\/ Extract the `lsof` pipe keys and remove those pipes from the set\n-            List<KeyedString> lsofPipeNames = pipes.stream()\n-                    .filter(pr1 -> pr1.pid() == lsofPid)\n-                    .map(PipeRecord::myKey)\n-                    .toList();\n-            pipes.removeIf(p1 -> lsofPipeNames.contains(p1.myKey()));\n-            return pipes;\n+        } catch (InterruptedException ie) {\n+            throw new IOException(\"Waiting for lsof exit interrupted\", ie);\n","filename":"test\/jdk\/java\/lang\/ProcessBuilder\/PipelineLeaksFD.java","additions":21,"deletions":16,"binary":false,"changes":37,"status":"modified"}]}