{"files":[{"patch":"@@ -281,1 +281,1 @@\n-  if (compiler->is_jvmci()) {\n+  if (compiler->is_jvmci() && !UseJVMCINativeLibrary) {\n@@ -300,1 +300,1 @@\n-      if (compiler->is_jvmci()) {\n+      if (compiler->is_jvmci() && !UseJVMCINativeLibrary) {\n@@ -946,4 +946,0 @@\n-    jobject thread_handle = nullptr;\n-    \/\/ Create all j.l.Thread objects for C1 and C2 threads here, but only one\n-    \/\/ for JVMCI compiler which can create further ones on demand.\n-    JVMCI_ONLY(if (!UseJVMCICompiler || !UseDynamicNumberOfCompilerThreads || i == 0) {)\n@@ -953,2 +949,1 @@\n-    thread_handle = JNIHandles::make_global(thread_oop);\n-    JVMCI_ONLY(})\n+    jobject thread_handle = JNIHandles::make_global(thread_oop);\n@@ -1032,7 +1027,9 @@\n-      if (UseJVMCICompiler) {\n-        \/\/ Native compiler threads as used in C1\/C2 can reuse the j.l.Thread\n-        \/\/ objects as their existence is completely hidden from the rest of\n-        \/\/ the VM (and those compiler threads can't call Java code to do the\n-        \/\/ creation anyway). For JVMCI we have to create new j.l.Thread objects\n-        \/\/ as they are visible and we can see unexpected thread lifecycle\n-        \/\/ transitions if we bind them to new JavaThreads.\n+      if (UseJVMCICompiler && !UseJVMCINativeLibrary && _compiler2_objects[i] == nullptr) {\n+        \/\/ Native compiler threads as used in C1\/C2 can reuse the j.l.Thread objects as their\n+        \/\/ existence is completely hidden from the rest of the VM (and those compiler threads can't\n+        \/\/ call Java code to do the creation anyway).\n+        \/\/\n+        \/\/ For pure Java JVMCI we have to create new j.l.Thread objects as they are visible and we\n+        \/\/ can see unexpected thread lifecycle transitions if we bind them to new JavaThreads.  For\n+        \/\/ native library JVMCI it's preferred to use the C1\/C2 strategy as this avoids unnecessary\n+        \/\/ coupling with Java.\n@@ -1066,0 +1063,1 @@\n+      guarantee(compiler2_object(i) != nullptr, \"Thread oop must exist\");\n","filename":"src\/hotspot\/share\/compiler\/compileBroker.cpp","additions":13,"deletions":15,"binary":false,"changes":28,"status":"modified"}]}