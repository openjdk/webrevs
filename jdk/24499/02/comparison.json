{"files":[{"patch":"@@ -45,0 +45,1 @@\n+    private final PrintWriter err;\n@@ -51,1 +52,1 @@\n-    public JNativeScanTask(PrintWriter out, List<Path> classPaths, List<Path> modulePaths,\n+    public JNativeScanTask(PrintWriter out, PrintWriter err, List<Path> classPaths, List<Path> modulePaths,\n@@ -54,0 +55,1 @@\n+        this.err = err;\n@@ -74,0 +76,3 @@\n+        Set<String> errors = new LinkedHashSet<>();\n+        Diagnostics diagnostics = (context, error) ->\n+                errors.add(\"Error while processing method: \" + context + \": \" + error.getMessage());\n@@ -77,1 +82,1 @@\n-            NativeMethodFinder finder = NativeMethodFinder.create(classesToScan, systemClassResolver);\n+            NativeMethodFinder finder = NativeMethodFinder.create(diagnostics, classesToScan, systemClassResolver);\n@@ -85,1 +90,1 @@\n-            case DUMP_ALL -> dumpAll(allRestrictedMethods);\n+            case DUMP_ALL -> dumpAll(allRestrictedMethods, errors);\n@@ -159,1 +164,1 @@\n-    private void dumpAll(SortedMap<ClassFileSource, SortedMap<ClassDesc, List<RestrictedUse>>> allRestrictedMethods) {\n+    private void dumpAll(SortedMap<ClassFileSource, SortedMap<ClassDesc, List<RestrictedUse>>> allRestrictedMethods, Set<String> errors) {\n@@ -180,0 +185,4 @@\n+        if (!errors.isEmpty()) {\n+            err.println(\"Error(s) while processing classes:\");\n+            errors.forEach(error -> err.println(\"  \" + error));\n+        }\n@@ -195,0 +204,4 @@\n+\n+    interface Diagnostics {\n+        void error(MethodRef context, JNativeScanFatalError error);\n+    }\n","filename":"src\/jdk.jdeps\/share\/classes\/com\/sun\/tools\/jnativescan\/JNativeScanTask.java","additions":17,"deletions":4,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -168,1 +168,1 @@\n-        new JNativeScanTask(out, classPathJars, modulePaths, rootModules, version, action).run();\n+        new JNativeScanTask(out, err, classPathJars, modulePaths, rootModules, version, action).run();\n","filename":"src\/jdk.jdeps\/share\/classes\/com\/sun\/tools\/jnativescan\/Main.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -27,0 +27,1 @@\n+import com.sun.tools.jnativescan.JNativeScanTask.Diagnostics;\n@@ -47,0 +48,1 @@\n+    private final Diagnostics diagnostics;\n@@ -50,1 +52,2 @@\n-    private NativeMethodFinder(ClassResolver classesToScan, ClassResolver systemClassResolver) {\n+    private NativeMethodFinder(Diagnostics diagnostics, ClassResolver classesToScan, ClassResolver systemClassResolver) {\n+        this.diagnostics = diagnostics;\n@@ -55,2 +58,3 @@\n-    public static NativeMethodFinder create(ClassResolver classesToScan, ClassResolver systemClassResolver) throws JNativeScanFatalError, IOException {\n-        return new NativeMethodFinder(classesToScan, systemClassResolver);\n+    public static NativeMethodFinder create(Diagnostics diagnostics, ClassResolver classesToScan,\n+                                            ClassResolver systemClassResolver) throws JNativeScanFatalError, IOException {\n+        return new NativeMethodFinder(diagnostics, classesToScan, systemClassResolver);\n@@ -71,17 +75,16 @@\n-                         try {\n-                             code.forEach(e -> {\n-                                 switch (e) {\n-                                     case InvokeInstruction invoke -> {\n-                                         MethodRef ref = MethodRef.ofInvokeInstruction(invoke);\n-                                         if (isRestrictedMethod(ref)) {\n-                                             perMethod.add(ref);\n-                                         }\n-                                     }\n-                                     default -> {\n-                                     }\n-                                 }\n-                             });\n-                         } catch (JNativeScanFatalError e) {\n-                             throw new JNativeScanFatalError(\"Error while processing method: \" +\n-                                     MethodRef.ofModel(methodModel), e);\n-                         }\n+                        code.forEach(e -> {\n+                            switch (e) {\n+                                case InvokeInstruction invoke -> {\n+                                    MethodRef ref = MethodRef.ofInvokeInstruction(invoke);\n+                                    try {\n+                                        if (isRestrictedMethod(ref)) {\n+                                            perMethod.add(ref);\n+                                        }\n+                                    } catch (JNativeScanFatalError ex) {\n+                                        diagnostics.error(MethodRef.ofModel(methodModel), ex);\n+                                    }\n+                                }\n+                                default -> {\n+                                }\n+                            }\n+                        });\n","filename":"src\/jdk.jdeps\/share\/classes\/com\/sun\/tools\/jnativescan\/NativeMethodFinder.java","additions":23,"deletions":20,"binary":false,"changes":43,"status":"modified"},{"patch":"@@ -38,0 +38,3 @@\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n@@ -52,2 +55,3 @@\n-        assertFailure(jnativescan(\"--class-path\", MISSING_SYSTEM.toString(), \"--release\", \"21\"))\n-                .stdoutShouldBeEmpty()\n+        List<String> stderr = assertSuccess(jnativescan(\"--class-path\", MISSING_SYSTEM.toString(), \"--release\", \"21\"))\n+                .stdoutShouldContain(\"<no restricted methods>\")\n+                .stderrShouldContain(\"Error(s) while processing classes\")\n@@ -56,1 +60,0 @@\n-                .stderrShouldContain(\"CAUSED BY:\")\n@@ -58,1 +61,4 @@\n-                .stderrShouldContain(\"java.lang.Compiler\");\n+                .stderrShouldContain(\"java.lang.Compiler\")\n+                .stderrAsLines();\n+\n+        assertEquals(2, stderr.size(), \"Unexpected number of lines in stderr\");\n","filename":"test\/langtools\/tools\/jnativescan\/TestMissingSystemClass.java","additions":10,"deletions":4,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+        java.lang.Compiler.enable(); \/\/ should be de-duplicated in the error logs\n","filename":"test\/langtools\/tools\/jnativescan\/cases\/classpath\/missingsystem\/App.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}