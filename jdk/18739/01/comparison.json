{"files":[{"patch":"@@ -31,0 +31,2 @@\n+import sun.security.action.GetPropertyAction;\n+\n@@ -38,1 +40,1 @@\n-     * Maximum size of event list (in the future this may be tunable)\n+     * Maximum size of event list\n@@ -40,1 +42,13 @@\n-    static final int MAX_EVENT_LIST_SIZE    = 512;\n+    @SuppressWarnings(\"removal\")\n+    static final int MAX_EVENT_LIST_SIZE;\n+    static {\n+        String rawValue = GetPropertyAction.privilegedGetProperty(\n+            \"jdk.nio.file.maxWatchEvents\", \"512\");\n+        int intValue;\n+        try {\n+            intValue = Integer.decode(rawValue);\n+        } catch (NumberFormatException e) {\n+            intValue = 512;\n+        }\n+        MAX_EVENT_LIST_SIZE = intValue;\n+    }\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/fs\/AbstractWatchKey.java","additions":16,"deletions":2,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -0,0 +1,97 @@\n+\/*\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/* @test\n+ * @bug 8330077\n+ * @summary Tests WatchService behavior with more entries in a watched directory\n+ *     than the default event limit\n+ * @library ..\n+ * @run main\/othervm LotsOfEntries 600 fail\n+ * @run main\/othervm -Djdk.nio.file.maxWatchEvents=invalid LotsOfEntries 600 fail\n+ * @run main\/othervm -Djdk.nio.file.maxWatchEvents=700 LotsOfEntries 600 pass\n+ *\/\n+\n+import java.nio.file.*;\n+import static java.nio.file.StandardWatchEventKinds.*;\n+import java.util.*;\n+import java.util.concurrent.TimeUnit;\n+import java.util.stream.Collectors;\n+\n+public class LotsOfEntries {\n+\n+    static void testCreateLotsOfEntries(Path dir, int numEvents, boolean fail) throws Exception {\n+        try (WatchService watcher = FileSystems.getDefault().newWatchService()) {\n+            System.out.format(\"register %s for events\\n\", dir);\n+            WatchKey key = dir.register(watcher, ENTRY_CREATE);\n+\n+            System.out.format(\"create %d entries\\n\", numEvents);\n+            Set<Path> entries = new HashSet<>();\n+            for (int i = 0; i < numEvents; i++) {\n+                Path entry = dir.resolve(\"entry\" + i);\n+                entries.add(entry);\n+                Files.createFile(entry);\n+            }\n+\n+            \/\/ wait for key to be signalled - the timeout is long to allow for\n+            \/\/ polling implementations\n+            System.out.println(\"poll watcher...\");\n+            WatchKey signalledKey = watcher.poll(15, TimeUnit.SECONDS);\n+            if (key != signalledKey) {\n+                throw new RuntimeException(\"Unexpected key returned from poll\");\n+            }\n+\n+            if (fail) {\n+                System.out.println(\"poll expecting overflow...\");\n+                var events = key.pollEvents();\n+                if (events.size() != 1) {\n+                    throw new RuntimeException(\"Expected a single event\");\n+                }\n+                if (!events.getFirst().kind().equals(OVERFLOW)) {\n+                    throw new RuntimeException(\"Expected overflow event\");\n+                }\n+            } else {\n+                System.out.println(\"poll not expecting overflow...\");\n+                Set<Path> contexts = key.pollEvents().stream()\n+                    .map(WatchEvent::context)\n+                    .map(Path.class::cast)\n+                    .map(entry -> dir.resolve(entry))\n+                    .collect(Collectors.toSet());\n+                if (!entries.equals(contexts)) {\n+                    throw new RuntimeException(\n+                        \"Expected events on: \" + entries + \", got: \" + contexts);\n+                }\n+            }\n+        }\n+    }\n+\n+    public static void main(String[] args) throws Exception {\n+        Path dir = TestUtil.createTemporaryDirectory();\n+        int numEvents = Integer.parseInt(args[0]);\n+        boolean fail = args[1].equals(\"fail\");\n+        try {\n+            testCreateLotsOfEntries(dir, numEvents, fail);\n+        } finally {\n+            TestUtil.removeAll(dir);\n+        }\n+    }\n+}\n","filename":"test\/jdk\/java\/nio\/file\/WatchService\/LotsOfEntries.java","additions":97,"deletions":0,"binary":false,"changes":97,"status":"added"}]}