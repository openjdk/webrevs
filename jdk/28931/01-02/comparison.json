{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -146,1 +146,3 @@\n-        userPrincipal = new UnixPrincipal(ss.getUsername());\n+        if (ss.getUsername() != null) {\n+            userPrincipal = new UnixPrincipal(ss.getUsername());\n+        }\n@@ -165,0 +167,4 @@\n+            System.out.println(\"\\t\\t\\tusername = \" + ss.getUsername());\n+            if (ss.getpwuid_r_error != null) {\n+                System.out.println(\"\\t\\t\\t\\t[Reason: \" + ss.getpwuid_r_error + \"]\");\n+            }\n@@ -209,1 +215,1 @@\n-            if (!subject.getPrincipals().contains(userPrincipal))\n+            if (userPrincipal != null && !subject.getPrincipals().contains(userPrincipal)) {\n@@ -211,1 +217,2 @@\n-            if (!subject.getPrincipals().contains(UIDPrincipal))\n+            }\n+            if (!subject.getPrincipals().contains(UIDPrincipal)) {\n@@ -213,1 +220,2 @@\n-            if (!subject.getPrincipals().contains(GIDPrincipal))\n+            }\n+            if (!subject.getPrincipals().contains(GIDPrincipal)) {\n@@ -215,0 +223,1 @@\n+            }\n","filename":"src\/jdk.security.auth\/share\/classes\/com\/sun\/security\/auth\/module\/UnixLoginModule.java","additions":14,"deletions":5,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -35,0 +35,1 @@\n+import java.lang.foreign.StructLayout;\n@@ -38,0 +39,1 @@\n+import java.lang.invoke.VarHandle;\n@@ -70,0 +72,4 @@\n+    \/\/ Record the reason why getpwuid_r failed. UnixLoginModule\n+    \/\/ will display the message when debug is on.\n+    String getpwuid_r_error = null;\n+\n@@ -84,0 +90,9 @@\n+    private static Linker.Option ccs = Linker.Option.captureCallState(\"errno\");\n+    private static final StructLayout capturedStateLayout = Linker.Option.captureStateLayout();\n+    private static final VarHandle errnoHandle = capturedStateLayout.varHandle(\n+            MemoryLayout.PathElement.groupElement(\"errno\"));\n+\n+    private static final MethodHandle strerror = LINKER\n+            .downcallHandle(SYMBOL_LOOKUP.findOrThrow(\"strerror\"),\n+                    FunctionDescriptor.of(C_POINTER, C_INT));\n+\n@@ -86,1 +101,1 @@\n-                    FunctionDescriptor.of(C_INT, C_INT, C_POINTER));\n+                    FunctionDescriptor.of(C_INT, C_INT, C_POINTER), ccs);\n@@ -130,1 +145,2 @@\n-            int groupnum = (int) getgroups.invokeExact(0, MemorySegment.NULL);\n+            MemorySegment capturedState = scope.allocate(capturedStateLayout);\n+            int groupnum = (int) getgroups.invokeExact(capturedState, 0, MemorySegment.NULL);\n@@ -136,1 +152,1 @@\n-            groupnum = (int) getgroups.invokeExact(groupnum, gs);\n+            groupnum = (int) getgroups.invokeExact(capturedState, groupnum, gs);\n@@ -138,1 +154,4 @@\n-                throw new RuntimeException(\"getgroups returns \" + groupnum);\n+                var errno = (int) errnoHandle.get(capturedState, 0L);\n+                var errMsg = (MemorySegment) strerror.invokeExact(errno);\n+                throw new RuntimeException(\"getgroups returns \" + groupnum\n+                        + \". Reason: \" + errMsg.reinterpret(Long.MAX_VALUE).getString(0));\n@@ -146,3 +165,3 @@\n-            var resbuf = scope.allocate(passwd_layout);\n-            var pwd = scope.allocate(C_POINTER);\n-            var pwd_buf = scope.allocate(GETPW_R_SIZE_MAX);\n+            var pwd = scope.allocate(passwd_layout);\n+            var result = scope.allocate(C_POINTER);\n+            var buffer = scope.allocate(GETPW_R_SIZE_MAX);\n@@ -151,2 +170,8 @@\n-                    tmpUid, resbuf, pwd_buf, GETPW_R_SIZE_MAX, pwd);\n-            if (out != 0 || pwd.get(ValueLayout.ADDRESS, 0).equals(MemorySegment.NULL)) {\n+                    tmpUid, pwd, buffer, GETPW_R_SIZE_MAX, result);\n+            if (out != 0 || result.get(ValueLayout.ADDRESS, 0).equals(MemorySegment.NULL)) {\n+                if (out != 0) {\n+                    var err = (MemorySegment) strerror.invokeExact(out);\n+                    getpwuid_r_error = err.reinterpret(Long.MAX_VALUE).getString(0);\n+                } else {\n+                    getpwuid_r_error = \"the requested entry is not found\";\n+                }\n@@ -157,3 +182,3 @@\n-                uid = resbuf.get(pw_uid_layout, pw_uid_offset);\n-                gid = resbuf.get(pw_gid_layout, pw_gid_offset);\n-                username = resbuf.get(pw_name_layout, pw_name_offset).getString(0);\n+                uid = pwd.get(pw_uid_layout, pw_uid_offset);\n+                gid = pwd.get(pw_gid_layout, pw_gid_offset);\n+                username = pwd.get(pw_name_layout, pw_name_offset).getString(0);\n","filename":"src\/jdk.security.auth\/share\/classes\/com\/sun\/security\/auth\/module\/UnixSystem.java","additions":38,"deletions":13,"binary":false,"changes":51,"status":"modified"}]}