{"files":[{"patch":"@@ -34,8 +34,7 @@\n-$(eval $(call SetupJdkLibrary, BUILD_LIBJAAS, \\\n-    NAME := jaas, \\\n-    OPTIMIZATION := LOW, \\\n-    EXTRA_HEADER_DIRS := java.base:libjava, \\\n-    LIBS_windows := advapi32.lib mpr.lib netapi32.lib user32.lib, \\\n-))\n-\n-TARGETS += $(BUILD_LIBJAAS)\n+ifeq ($(call isTargetOs, windows), true)\n+  $(eval $(call SetupJdkLibrary, BUILD_LIBJAAS, \\\n+      NAME := jaas, \\\n+      OPTIMIZATION := LOW, \\\n+      EXTRA_HEADER_DIRS := java.base:libjava, \\\n+      LIBS_windows := advapi32.lib mpr.lib netapi32.lib user32.lib, \\\n+  ))\n@@ -43,0 +42,2 @@\n+  TARGETS += $(BUILD_LIBJAAS)\n+endif\n","filename":"make\/modules\/jdk.security.auth\/Lib.gmk","additions":9,"deletions":8,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -29,1 +29,0 @@\n-import java.io.IOException;\n@@ -124,2 +123,0 @@\n-        long[] unixGroups = null;\n-\n@@ -127,0 +124,8 @@\n+            \/\/ TODO: Shall we fail early for unsupported systems?\n+            \/\/ 1. If it's Windows, we should fail immediately to avoid\n+            \/\/    cygwin-like functions being loaded, which are not supported\n+            \/\/    and could have a different `long`.\n+            \/\/ 2. The FFM code has only been tested on macOS and Linux and\n+            \/\/    might fail on other *nix systems. Especially, the `passwd`\n+            \/\/    struct could be defined differently, although I've checked\n+            \/\/    several and an extra 100 chars at the end seems enough.\n@@ -128,1 +133,3 @@\n-        } catch (UnsatisfiedLinkError ule) {\n+        } catch (ExceptionInInitializerError | UnsatisfiedLinkError ule) {\n+            \/\/ Errors could happen in either static blocks or the constructor,\n+            \/\/ both have a cause.\n@@ -130,1 +137,1 @@\n-            throw new FailedLoginException\n+            var error = new FailedLoginException\n@@ -134,0 +141,7 @@\n+            if (ule.getCause() != null) {\n+                error.initCause(ule.getCause());\n+            }\n+            throw error;\n+        }\n+        if (ss.getUsername() != null) {\n+            userPrincipal = new UnixPrincipal(ss.getUsername());\n@@ -135,1 +149,0 @@\n-        userPrincipal = new UnixPrincipal(ss.getUsername());\n@@ -138,0 +151,1 @@\n+        long[] unixGroups = null;\n@@ -153,3 +167,8 @@\n-            unixGroups = ss.getGroups();\n-            for (int i = 0; i < unixGroups.length; i++) {\n-                System.out.println(\"\\t\\t\\tsupp gid = \" + unixGroups[i]);\n+            System.out.println(\"\\t\\t\\tusername = \" + ss.getUsername());\n+            if (ss.getpwuid_r_error != null) {\n+                System.out.println(\"\\t\\t\\t\\t[Reason: \" + ss.getpwuid_r_error + \"]\");\n+            }\n+            if (unixGroups != null) {\n+                for (int i = 0; i < unixGroups.length; i++) {\n+                    System.out.println(\"\\t\\t\\tsupp gid = \" + unixGroups[i]);\n+                }\n@@ -196,1 +215,1 @@\n-            if (!subject.getPrincipals().contains(userPrincipal))\n+            if (userPrincipal != null && !subject.getPrincipals().contains(userPrincipal)) {\n@@ -198,1 +217,2 @@\n-            if (!subject.getPrincipals().contains(UIDPrincipal))\n+            }\n+            if (!subject.getPrincipals().contains(UIDPrincipal)) {\n@@ -200,1 +220,2 @@\n-            if (!subject.getPrincipals().contains(GIDPrincipal))\n+            }\n+            if (!subject.getPrincipals().contains(GIDPrincipal)) {\n@@ -202,0 +223,1 @@\n+            }\n","filename":"src\/jdk.security.auth\/share\/classes\/com\/sun\/security\/auth\/module\/UnixLoginModule.java","additions":35,"deletions":13,"binary":false,"changes":48,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2026, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,15 @@\n+import java.lang.foreign.AddressLayout;\n+import java.lang.foreign.Arena;\n+import java.lang.foreign.FunctionDescriptor;\n+import java.lang.foreign.GroupLayout;\n+import java.lang.foreign.Linker;\n+import java.lang.foreign.MemoryLayout;\n+import java.lang.foreign.MemorySegment;\n+import java.lang.foreign.StructLayout;\n+import java.lang.foreign.SymbolLookup;\n+import java.lang.foreign.ValueLayout;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.VarHandle;\n+\n+import static java.lang.foreign.MemoryLayout.PathElement.groupElement;\n+\n@@ -34,0 +49,1 @@\n+@SuppressWarnings(\"restricted\")\n@@ -36,5 +52,3 @@\n-    private native void getUnixInfo();\n-\n-    \/\/ Warning: the following 4 fields are used by Unix.c\n-\n-    \/** The current username. *\/\n+    \/**\n+     * The current username.\n+     *\/\n@@ -43,1 +57,3 @@\n-    \/** The current user ID. *\/\n+    \/**\n+     * The current user ID.\n+     *\/\n@@ -46,1 +62,3 @@\n-    \/** The current group ID. *\/\n+    \/**\n+     * The current group ID.\n+     *\/\n@@ -49,1 +67,3 @@\n-    \/** The current list of groups. *\/\n+    \/**\n+     * The current list of groups.\n+     *\/\n@@ -52,0 +72,67 @@\n+    \/\/ Record the reason why getpwuid_r failed. UnixLoginModule\n+    \/\/ will display the message when debug is on.\n+    String getpwuid_r_error = null;\n+\n+    private static final Linker LINKER = Linker.nativeLinker();\n+    private static final SymbolLookup SYMBOL_LOOKUP = SymbolLookup.loaderLookup()\n+            .or(LINKER.defaultLookup());\n+\n+    private static final ValueLayout.OfByte C_CHAR\n+            = (ValueLayout.OfByte) LINKER.canonicalLayouts().get(\"char\");\n+    private static final ValueLayout.OfInt C_INT\n+            = (ValueLayout.OfInt) LINKER.canonicalLayouts().get(\"int\");\n+    private static final AddressLayout C_POINTER\n+            = ((AddressLayout) LINKER.canonicalLayouts().get(\"void*\"))\n+            .withTargetLayout(MemoryLayout.sequenceLayout(java.lang.Long.MAX_VALUE, C_CHAR));\n+    private static final ValueLayout.OfLong C_LONG\n+            = (ValueLayout.OfLong) LINKER.canonicalLayouts().get(\"long\");\n+\n+    private static Linker.Option ccs = Linker.Option.captureCallState(\"errno\");\n+    private static final StructLayout capturedStateLayout = Linker.Option.captureStateLayout();\n+    private static final VarHandle errnoHandle = capturedStateLayout.varHandle(\n+            MemoryLayout.PathElement.groupElement(\"errno\"));\n+\n+    private static final MethodHandle strerror = LINKER\n+            .downcallHandle(SYMBOL_LOOKUP.findOrThrow(\"strerror\"),\n+                    FunctionDescriptor.of(C_POINTER, C_INT));\n+\n+    private static final MethodHandle getgroups = LINKER\n+            .downcallHandle(SYMBOL_LOOKUP.findOrThrow(\"getgroups\"),\n+                    FunctionDescriptor.of(C_INT, C_INT, C_POINTER), ccs);\n+    private static final MethodHandle getuid = LINKER\n+            .downcallHandle(SYMBOL_LOOKUP.findOrThrow(\"getuid\"),\n+                    FunctionDescriptor.of(C_INT));\n+    private static final MethodHandle getgid = LINKER\n+            .downcallHandle(SYMBOL_LOOKUP.findOrThrow(\"getgid\"),\n+                    FunctionDescriptor.of(C_INT));\n+    private static final MethodHandle getpwuid_r = LINKER\n+            .downcallHandle(SYMBOL_LOOKUP.findOrThrow(\"getpwuid_r\"),\n+                    FunctionDescriptor.of(C_INT, C_INT, C_POINTER, C_POINTER,\n+                            C_LONG, C_POINTER));\n+\n+    private static final GroupLayout passwd_layout = MemoryLayout.structLayout(\n+            C_POINTER.withName(\"pw_name\"),\n+            C_POINTER.withName(\"pw_passwd\"),\n+            C_INT.withName(\"pw_uid\"),\n+            C_INT.withName(\"pw_gid\"),\n+            \/\/ Different platforms have different fields in `struct passwd`.\n+            \/\/ While we don't need those fields here, the struct needs to be\n+            \/\/ big enough to avoid buffer overflow when `getpwuid_r` is called.\n+            MemoryLayout.sequenceLayout(100, C_CHAR).withName(\"dummy\"));\n+\n+    private static final ValueLayout.OfInt pw_uid_layout\n+            = (ValueLayout.OfInt) passwd_layout.select(groupElement(\"pw_uid\"));\n+    private static final long pw_uid_offset\n+            = passwd_layout.byteOffset(groupElement(\"pw_uid\"));\n+    private static final ValueLayout.OfInt pw_gid_layout\n+            = (ValueLayout.OfInt) passwd_layout.select(groupElement(\"pw_gid\"));\n+    private static final long pw_gid_offset\n+            = passwd_layout.byteOffset(groupElement(\"pw_gid\"));\n+    private static final AddressLayout pw_name_layout\n+            = (AddressLayout) passwd_layout.select(groupElement(\"pw_name\"));\n+    private static final long pw_name_offset\n+            = passwd_layout.byteOffset(groupElement(\"pw_name\"));\n+\n+    \/\/ sysconf(_SC_GETPW_R_SIZE_MAX) on macOS is 4096 and 1024 on Linux\n+    private static final long GETPW_R_SIZE_MAX = 4096L;\n+\n@@ -56,1 +143,0 @@\n-    @SuppressWarnings(\"restricted\")\n@@ -58,2 +144,47 @@\n-        System.loadLibrary(\"jaas\");\n-        getUnixInfo();\n+        try (Arena scope = Arena.ofConfined()) {\n+            MemorySegment capturedState = scope.allocate(capturedStateLayout);\n+            int groupnum = (int) getgroups.invokeExact(capturedState, 0, MemorySegment.NULL);\n+            if (groupnum == -1) {\n+                throw new RuntimeException(\"getgroups returns \" + groupnum);\n+            }\n+\n+            var gs = scope.allocate(C_INT, groupnum);\n+            groupnum = (int) getgroups.invokeExact(capturedState, groupnum, gs);\n+            if (groupnum == -1) {\n+                var errno = (int) errnoHandle.get(capturedState, 0L);\n+                var errMsg = (MemorySegment) strerror.invokeExact(errno);\n+                throw new RuntimeException(\"getgroups returns \" + groupnum\n+                        + \". Reason: \" + errMsg.reinterpret(Long.MAX_VALUE).getString(0));\n+            }\n+\n+            groups = new long[groupnum];\n+            for (int i = 0; i < groupnum; i++) {\n+                groups[i] = gs.getAtIndex(C_INT, i);\n+            }\n+\n+            var pwd = scope.allocate(passwd_layout);\n+            var result = scope.allocate(C_POINTER);\n+            var buffer = scope.allocate(GETPW_R_SIZE_MAX);\n+            var tmpUid = (int)getuid.invokeExact();\n+            int out = (int) getpwuid_r.invokeExact(\n+                    tmpUid, pwd, buffer, GETPW_R_SIZE_MAX, result);\n+            if (out != 0 || result.get(ValueLayout.ADDRESS, 0).equals(MemorySegment.NULL)) {\n+                if (out != 0) {\n+                    var err = (MemorySegment) strerror.invokeExact(out);\n+                    getpwuid_r_error = err.reinterpret(Long.MAX_VALUE).getString(0);\n+                } else {\n+                    getpwuid_r_error = \"the requested entry is not found\";\n+                }\n+                uid = tmpUid;\n+                gid = (int)getgid.invokeExact();\n+                username = null;\n+            } else {\n+                uid = pwd.get(pw_uid_layout, pw_uid_offset);\n+                gid = pwd.get(pw_gid_layout, pw_gid_offset);\n+                username = pwd.get(pw_name_layout, pw_name_offset).getString(0);\n+            }\n+        } catch (Throwable t) {\n+            var error = new UnsatisfiedLinkError(\"FFM calls failed\");\n+            error.initCause(t);\n+            throw error;\n+        }\n","filename":"src\/jdk.security.auth\/share\/classes\/com\/sun\/security\/auth\/module\/UnixSystem.java","additions":143,"deletions":12,"binary":false,"changes":155,"status":"modified"},{"patch":"@@ -1,130 +0,0 @@\n-\/*\n- * Copyright (c) 2000, 2021, Oracle and\/or its affiliates. All rights reserved.\n- * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n- *\n- * This code is free software; you can redistribute it and\/or modify it\n- * under the terms of the GNU General Public License version 2 only, as\n- * published by the Free Software Foundation.  Oracle designates this\n- * particular file as subject to the \"Classpath\" exception as provided\n- * by Oracle in the LICENSE file that accompanied this code.\n- *\n- * This code is distributed in the hope that it will be useful, but WITHOUT\n- * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n- * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n- * version 2 for more details (a copy is included in the LICENSE file that\n- * accompanied this code).\n- *\n- * You should have received a copy of the GNU General Public License version\n- * 2 along with this work; if not, write to the Free Software Foundation,\n- * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n- *\n- * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n- * or visit www.oracle.com if you need additional information or have any\n- * questions.\n- *\/\n-\n-#include <jni.h>\n-#include \"jni_util.h\"\n-#include \"com_sun_security_auth_module_UnixSystem.h\"\n-#include <stdio.h>\n-#include <sys\/types.h>\n-#include <unistd.h>\n-#include <stdlib.h>\n-#include <string.h>\n-\n-#include <pwd.h>\n-\n-\/*\n- * Declare library specific JNI_Onload entry if static build\n- *\/\n-DEF_STATIC_JNI_OnLoad\n-\n-JNIEXPORT void JNICALL\n-Java_com_sun_security_auth_module_UnixSystem_getUnixInfo\n-                                                (JNIEnv *env, jobject obj) {\n-\n-    int i;\n-    char pwd_buf[1024];\n-    struct passwd *pwd = NULL;\n-    struct passwd resbuf;\n-    jfieldID userNameID;\n-    jfieldID userID;\n-    jfieldID groupID;\n-    jfieldID supplementaryGroupID;\n-\n-    jstring jstr;\n-    jlongArray jgroups;\n-    jlong *jgroupsAsArray;\n-    jsize numSuppGroups;\n-    gid_t *groups;\n-    jclass cls;\n-\n-    numSuppGroups = getgroups(0, NULL);\n-    if (numSuppGroups == -1) {\n-        return;\n-    }\n-    groups = (gid_t *)calloc(numSuppGroups, sizeof(gid_t));\n-    if (groups == NULL) {\n-        jclass cls = (*env)->FindClass(env,\"java\/lang\/OutOfMemoryError\");\n-        if (cls != NULL) {\n-            (*env)->ThrowNew(env, cls, NULL);\n-        }\n-        return;\n-    }\n-\n-    cls = (*env)->GetObjectClass(env, obj);\n-\n-    supplementaryGroupID = (*env)->GetFieldID(env, cls, \"groups\", \"[J\");\n-    if (supplementaryGroupID == 0) {\n-        goto cleanUpAndReturn;\n-    }\n-\n-    if (getgroups(numSuppGroups, groups) != -1) {\n-        jgroups = (*env)->NewLongArray(env, numSuppGroups);\n-        if (jgroups == NULL) {\n-            goto cleanUpAndReturn;\n-        }\n-        jgroupsAsArray = (*env)->GetLongArrayElements(env, jgroups, 0);\n-        if (jgroupsAsArray == NULL) {\n-            goto cleanUpAndReturn;\n-        }\n-        for (i = 0; i < numSuppGroups; i++) {\n-            jgroupsAsArray[i] = groups[i];\n-        }\n-        (*env)->ReleaseLongArrayElements(env, jgroups, jgroupsAsArray, 0);\n-        (*env)->SetObjectField(env, obj, supplementaryGroupID, jgroups);\n-    }\n-\n-    userNameID = (*env)->GetFieldID(env, cls, \"username\", \"Ljava\/lang\/String;\");\n-    if (userNameID == 0) {\n-        goto cleanUpAndReturn;\n-    }\n-\n-    userID = (*env)->GetFieldID(env, cls, \"uid\", \"J\");\n-    if (userID == 0) {\n-        goto cleanUpAndReturn;\n-    }\n-\n-    groupID = (*env)->GetFieldID(env, cls, \"gid\", \"J\");\n-    if (groupID == 0) {\n-        goto cleanUpAndReturn;\n-    }\n-\n-    memset(pwd_buf, 0, sizeof(pwd_buf));\n-    if (getpwuid_r(getuid(), &resbuf, pwd_buf, sizeof(pwd_buf), &pwd) == 0 &&\n-            pwd != NULL) {\n-        (*env)->SetLongField(env, obj, userID, pwd->pw_uid);\n-        (*env)->SetLongField(env, obj, groupID, pwd->pw_gid);\n-        jstr = (*env)->NewStringUTF(env, pwd->pw_name);\n-        if (jstr == NULL) {\n-            goto cleanUpAndReturn;\n-        }\n-        (*env)->SetObjectField(env, obj, userNameID, jstr);\n-    } else {\n-        (*env)->SetLongField(env, obj, userID, getuid());\n-        (*env)->SetLongField(env, obj, groupID, getgid());\n-    }\n-cleanUpAndReturn:\n-    free(groups);\n-    return;\n-}\n","filename":"src\/jdk.security.auth\/unix\/native\/libjaas\/Unix.c","additions":0,"deletions":130,"binary":false,"changes":130,"status":"deleted"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,1 @@\n+ * @modules java.base\/jdk.internal.util\n@@ -30,0 +31,2 @@\n+import jdk.internal.util.OperatingSystem;\n+\n@@ -42,1 +45,1 @@\n-        login(\"cross-platform\",\n+        login(true, \"cross-platform\",\n@@ -45,2 +48,2 @@\n-        login(\"windows\", NT_MODULE, \"required\");\n-        login(\"unix\", UNIX_MODULE, \"required\");\n+        login(OperatingSystem.isWindows(), \"windows\", NT_MODULE, \"required\");\n+        login(!OperatingSystem.isWindows(), \"unix\", UNIX_MODULE, \"required\");\n@@ -49,1 +52,1 @@\n-    static void login(String test, String... conf) throws Exception {\n+    static void login(boolean shouldSucceed, String test, String... conf) throws Exception {\n@@ -71,0 +74,3 @@\n+            if (!shouldSucceed) {\n+                throw new RuntimeException(\"Should not succeed\");\n+            }\n@@ -72,0 +78,3 @@\n+            if (shouldSucceed) {\n+                throw new RuntimeException(\"Should succeed\");\n+            }\n@@ -73,1 +82,1 @@\n-            if(e.getMessage().startsWith(\"Failed in attempt to import\")) {\n+            if (e.getMessage().startsWith(\"Failed in attempt to import\")) {\n@@ -76,0 +85,2 @@\n+            } else {\n+                throw new RuntimeException(\"Unexpected error\", e);\n","filename":"test\/jdk\/com\/sun\/security\/auth\/module\/AllPlatforms.java","additions":17,"deletions":6,"binary":false,"changes":23,"status":"modified"}]}