{"files":[{"patch":"@@ -26,0 +26,1 @@\n+import java.nio.file.DirectoryStream;\n@@ -39,1 +40,1 @@\n- * @summary Check for unwanted file (types\/extensions) in the jdk image\n+ * @summary Check for unwanted files (types\/extensions) in the jdk image\n@@ -50,0 +51,14 @@\n+    private static boolean isGpl(Path myFile) {\n+        if (myFile == null || !Files.exists(myFile)) {\n+            return false;\n+        }\n+\n+        try {\n+            String firstLine = Files.readAllLines(myFile).stream()\n+                                    .findFirst().orElse(\"\");\n+            return firstLine.contains(\"The GNU General Public License (GPL)\");\n+        } catch (IOException e) {\n+            return false;\n+        }\n+    }\n+\n@@ -151,0 +166,46 @@\n+\n+        Path legalDir = mainDirToScan.resolve(\"legal\");\n+        ArrayList<String> allowedEndingsLegalDir = new ArrayList<>();\n+        allowedEndingsLegalDir.add(\".md\");\n+        allowedEndingsLegalDir.add(\"ADDITIONAL_LICENSE_INFO\");\n+        allowedEndingsLegalDir.add(\"ASSEMBLY_EXCEPTION\");\n+        allowedEndingsLegalDir.add(\"LICENSE\");\n+\n+        \/\/ those MUST be in every subdir of the legal dir\n+        ArrayList<String> requiredFilesInLegalSubdirs = new ArrayList<>();\n+        requiredFilesInLegalSubdirs.add(\"LICENSE\");\n+\n+        Path javabaseLicenseFile = mainDirToScan.resolve(\"legal\/java.base\/LICENSE\");\n+        if (isGpl(javabaseLicenseFile)) {\n+            System.out.println(\"GPL info found in java.base LICENSE file\");\n+            requiredFilesInLegalSubdirs.add(\"ADDITIONAL_LICENSE_INFO\");\n+            requiredFilesInLegalSubdirs.add(\"ASSEMBLY_EXCEPTION\");\n+        }\n+\n+        if (Files.isDirectory(legalDir)) {\n+            System.out.println(\"Legal directory to scan:\" + legalDir);\n+            try (DirectoryStream<Path> stream = Files.newDirectoryStream(legalDir)) {\n+                for (Path subfolder : stream) {\n+                    if (Files.isDirectory(subfolder)) {\n+                        System.out.println(\"Checking legal dir subfolder for required files: \" + subfolder.getFileName());\n+\n+                        for (String fileName : requiredFilesInLegalSubdirs) {\n+                            Path filePath = subfolder.resolve(fileName);\n+                            if (Files.exists(filePath)) {\n+                                System.out.println(\"  Found \" + fileName);\n+                            } else {\n+                                System.out.println(\"  Missing \" + fileName);\n+                                throw new Error(\"legal dir scan for required files failed\");\n+                            }\n+                        }\n+                    }\n+                }\n+            }\n+\n+            boolean legalDirRes = scanFiles(legalDir, allowedEndingsLegalDir);\n+            if (legalDirRes) {\n+                System.out.println(\"Legal directory scan successful.\");\n+            } else {\n+                throw new Error(\"Legal dir scan failed\");\n+            }\n+        }\n","filename":"test\/jdk\/build\/CheckFiles.java","additions":62,"deletions":1,"binary":false,"changes":63,"status":"modified"}]}