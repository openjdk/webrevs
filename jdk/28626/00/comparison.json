{"files":[{"patch":"@@ -292,0 +292,1 @@\n+        SocketException ex = null;\n@@ -310,1 +311,0 @@\n-            return n;\n@@ -317,2 +317,2 @@\n-            \/\/ throw SocketException to maintain compatibility\n-            throw asSocketException(ioe);\n+            \/\/ translate to SocketException to maintain compatibility\n+            ex = asSocketException(ioe);\n@@ -322,0 +322,7 @@\n+        if (n <= 0 && isInputClosed) {\n+            return -1;\n+        }\n+        if (ex != null) {\n+            throw ex;\n+        }\n+        return n;\n@@ -414,0 +421,1 @@\n+        SocketException ex = null;\n@@ -422,1 +430,0 @@\n-            return n;\n@@ -426,2 +433,2 @@\n-            \/\/ throw SocketException to maintain compatibility\n-            throw asSocketException(ioe);\n+            \/\/ translate to SocketException to maintain compatibility\n+            ex = asSocketException(ioe);\n@@ -431,0 +438,4 @@\n+        if (ex != null) {\n+            throw ex;\n+        }\n+        return n;\n","filename":"src\/java.base\/share\/classes\/sun\/nio\/ch\/NioSocketImpl.java","additions":17,"deletions":6,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2019, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -27,1 +27,0 @@\n- * @run testng AsyncShutdown\n@@ -29,0 +28,1 @@\n+ * @run junit AsyncShutdown\n@@ -32,0 +32,2 @@\n+import java.io.InputStream;\n+import java.io.OutputStream;\n@@ -41,2 +43,4 @@\n-import org.testng.annotations.Test;\n-import static org.testng.Assert.*;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+import static org.junit.jupiter.api.Assertions.*;\n@@ -44,2 +48,1 @@\n-@Test\n-public class AsyncShutdown {\n+class AsyncShutdown {\n@@ -47,1 +50,3 @@\n-    public void testShutdownInput1() throws IOException {\n+    @ParameterizedTest\n+    @ValueSource(booleans = { false, true })\n+    void testShutdownInput(boolean timed) throws IOException {\n@@ -49,0 +54,1 @@\n+            InputStream in = s1.getInputStream();\n@@ -50,2 +56,5 @@\n-            int n = s1.getInputStream().read();\n-            assertTrue(n == -1);\n+            if (timed) {\n+                s1.setSoTimeout(30*1000);\n+            }\n+            assertEquals(-1, in.read());\n+            assertEquals(0, in.available());\n@@ -55,10 +64,2 @@\n-    public void testShutdownInput2() throws IOException {\n-        withConnection((s1, s2) -> {\n-            scheduleShutdownInput(s1, 2000);\n-            s1.setSoTimeout(30*1000);\n-            int n = s1.getInputStream().read();\n-            assertTrue(n == -1);\n-        });\n-    }\n-\n-    public void testShutdownOutput1() throws IOException {\n+    @Test\n+    void testShutdownOutput1() throws IOException {\n@@ -66,0 +67,1 @@\n+            OutputStream out = s1.getOutputStream();\n@@ -70,1 +72,1 @@\n-                    s1.getOutputStream().write(data);\n+                    out.write(data);\n@@ -76,1 +78,2 @@\n-    public void testShutdownOutput2() throws IOException {\n+    @Test\n+    void testShutdownOutput2() throws IOException {\n@@ -81,1 +84,1 @@\n-                assertTrue(false);\n+                fail();\n@@ -84,0 +87,1 @@\n+            OutputStream out = s1.getOutputStream();\n@@ -88,1 +92,1 @@\n-                    s1.getOutputStream().write(data);\n+                    out.write(data);\n","filename":"test\/jdk\/java\/net\/Socket\/AsyncShutdown.java","additions":27,"deletions":23,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -24,1 +24,1 @@\n-\/**\n+\/*\n@@ -26,1 +26,1 @@\n- * @bug 8284161\n+ * @bug 8284161 8372958\n@@ -32,1 +32,1 @@\n-\/**\n+\/*\n@@ -40,1 +40,1 @@\n-\/**\n+\/*\n@@ -63,0 +63,2 @@\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n@@ -93,13 +95,2 @@\n-    @Test\n-    void testSocketRead1() throws Exception {\n-        testSocketRead(0);\n-    }\n-\n-    \/**\n-     * Virtual thread blocks in timed read.\n-     *\/\n-    @Test\n-    void testSocketRead2() throws Exception {\n-        testSocketRead(60_000);\n-    }\n-\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n@@ -205,13 +196,2 @@\n-    @Test\n-    void testSocketReadAsyncClose1() throws Exception {\n-        testSocketReadAsyncClose(0);\n-    }\n-\n-    \/**\n-     * Socket close while virtual thread blocked in timed read.\n-     *\/\n-    @Test\n-    void testSocketReadAsyncClose2() throws Exception {\n-        testSocketReadAsyncClose(0);\n-    }\n-\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n@@ -233,1 +213,3 @@\n-                } catch (SocketException expected) { }\n+                } catch (SocketException expected) {\n+                    log(expected);\n+                }\n@@ -239,1 +221,1 @@\n-     * Virtual thread interrupted while blocked in Socket read.\n+     * Socket shutdownInput while virtual thread blocked in read.\n@@ -241,3 +223,20 @@\n-    @Test\n-    void testSocketReadInterrupt1() throws Exception {\n-        testSocketReadInterrupt(0);\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n+    void testSocketReadAsyncShutdownInput(int timeout) throws Exception {\n+        VThreadRunner.run(() -> {\n+            try (var connection = new Connection()) {\n+                Socket s = connection.socket1();\n+\n+                \/\/ delayed shutdown of input stream\n+                InputStream in = s.getInputStream();\n+                runAfterParkedAsync(s::shutdownInput);\n+\n+                \/\/ read should return -1\n+                if (timeout > 0) {\n+                    s.setSoTimeout(timeout);\n+                }\n+                assertEquals(-1, in.read());\n+                assertEquals(0, in.available());\n+                assertFalse(s.isClosed());\n+            }\n+        });\n@@ -247,1 +246,1 @@\n-     * Virtual thread interrupted while blocked in Socket read with timeout\n+     * Virtual thread interrupted while blocked in Socket read.\n@@ -249,5 +248,2 @@\n-    @Test\n-    void testSocketReadInterrupt2() throws Exception {\n-        testSocketReadInterrupt(60_000);\n-    }\n-\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n@@ -272,0 +268,1 @@\n+                    log(expected);\n@@ -288,1 +285,1 @@\n-                \/\/ delayedclose of s\n+                \/\/ delayed close of s\n@@ -298,1 +295,30 @@\n-                } catch (SocketException expected) { }\n+                } catch (SocketException expected) {\n+                    log(expected);\n+                }\n+            }\n+        });\n+    }\n+\n+    \/**\n+     * Socket shutdownOutput while virtual thread blocked in write.\n+     *\/\n+    @Test\n+    void testSocketWriteAsyncShutdownOutput() throws Exception {\n+        VThreadRunner.run(() -> {\n+            try (var connection = new Connection()) {\n+                Socket s = connection.socket1();\n+\n+                \/\/ delayed shutdown of output stream\n+                OutputStream out = s.getOutputStream();\n+                runAfterParkedAsync(s::shutdownOutput);\n+\n+                \/\/ write to s should block, then throw\n+                try {\n+                    byte[] ba = new byte[100*1024];\n+                    for (;;) {\n+                        out.write(ba);\n+                    }\n+                } catch (SocketException expected) {\n+                    log(expected);\n+                }\n+                assertFalse(s.isClosed());\n@@ -324,0 +350,1 @@\n+                    log(expected);\n@@ -358,1 +385,3 @@\n-                } catch (SocketTimeoutException expected) { }\n+                } catch (SocketTimeoutException expected) {\n+                    log(expected);\n+                }\n@@ -387,13 +416,2 @@\n-    @Test\n-    void testServerSocketAccept2() throws Exception {\n-        testServerSocketAccept(0);\n-    }\n-\n-    \/**\n-     * Virtual thread blocks in timed accept.\n-     *\/\n-    @Test\n-    void testServerSocketAccept3() throws Exception {\n-        testServerSocketAccept(60_000);\n-    }\n-\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n@@ -425,13 +443,2 @@\n-    @Test\n-    void testServerSocketAcceptAsyncClose1() throws Exception {\n-        testServerSocketAcceptAsyncClose(0);\n-    }\n-\n-    \/**\n-     * ServerSocket close while virtual thread blocked in timed accept.\n-     *\/\n-    @Test\n-    void testServerSocketAcceptAsyncClose2() throws Exception {\n-        testServerSocketAcceptAsyncClose(60_000);\n-    }\n-\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n@@ -454,1 +461,3 @@\n-                } catch (SocketException expected) { }\n+                } catch (SocketException expected) {\n+                    log(expected);\n+                }\n@@ -462,13 +471,2 @@\n-    @Test\n-    void testServerSocketAcceptInterrupt1() throws Exception {\n-        testServerSocketAcceptInterrupt(0);\n-    }\n-\n-    \/**\n-     * Virtual thread interrupted while blocked in ServerSocket accept with timeout.\n-     *\/\n-    @Test\n-    void testServerSocketAcceptInterrupt2() throws Exception {\n-        testServerSocketAcceptInterrupt(60_000);\n-    }\n-\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n@@ -493,0 +491,1 @@\n+                    log(expected);\n@@ -532,14 +531,3 @@\n-    @Test\n-    void testDatagramSocketSendReceive2() throws Exception {\n-        testDatagramSocketSendReceive(0);\n-    }\n-\n-    \/**\n-     * Virtual thread blocks in DatagramSocket receive with timeout.\n-     *\/\n-    @Test\n-    void testDatagramSocketSendReceive3() throws Exception {\n-        testDatagramSocketSendReceive(60_000);\n-    }\n-\n-    private void testDatagramSocketSendReceive(int timeout) throws Exception {\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n+    void testDatagramSocketSendReceive(int timeout) throws Exception {\n@@ -588,1 +576,3 @@\n-                } catch (SocketTimeoutException expected) { }\n+                } catch (SocketTimeoutException expected) {\n+                    log(expected);\n+                }\n@@ -596,14 +586,3 @@\n-    @Test\n-    void testDatagramSocketReceiveAsyncClose1() throws Exception {\n-        testDatagramSocketReceiveAsyncClose(0);\n-    }\n-\n-    \/**\n-     * DatagramSocket close while virtual thread blocked with timeout.\n-     *\/\n-    @Test\n-    void testDatagramSocketReceiveAsyncClose2() throws Exception {\n-        testDatagramSocketReceiveAsyncClose(60_000);\n-    }\n-\n-    private void testDatagramSocketReceiveAsyncClose(int timeout) throws Exception {\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n+    void testDatagramSocketReceiveAsyncClose(int timeout) throws Exception {\n@@ -627,1 +606,3 @@\n-                } catch (SocketException expected) { }\n+                } catch (SocketException expected) {\n+                    log(expected);\n+                }\n@@ -635,14 +616,3 @@\n-    @Test\n-    void testDatagramSocketReceiveInterrupt1() throws Exception {\n-        testDatagramSocketReceiveInterrupt(0);\n-    }\n-\n-    \/**\n-     * Virtual thread interrupted while blocked in DatagramSocket receive with timeout.\n-     *\/\n-    @Test\n-    void testDatagramSocketReceiveInterrupt2() throws Exception {\n-        testDatagramSocketReceiveInterrupt(60_000);\n-    }\n-\n-    private void testDatagramSocketReceiveInterrupt(int timeout) throws Exception {\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n+    void testDatagramSocketReceiveInterrupt(int timeout) throws Exception {\n@@ -668,0 +638,1 @@\n+                    log(expected);\n@@ -740,0 +711,7 @@\n+\n+    \/**\n+     * Log to System.err to inline with the JUnit messages.\n+     *\/\n+    static void log(Throwable e) {\n+        System.err.println(e);\n+    }\n","filename":"test\/jdk\/java\/net\/vthread\/BlockingSocketOps.java","additions":107,"deletions":129,"binary":false,"changes":236,"status":"modified"},{"patch":"@@ -69,0 +69,2 @@\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n@@ -304,14 +306,3 @@\n-    @Test\n-    void testSocketAdaptorRead1() throws Exception {\n-        testSocketAdaptorRead(0);\n-    }\n-\n-    \/**\n-     * Virtual thread blocks in SocketChannel adaptor read with timeout.\n-     *\/\n-    @Test\n-    void testSocketAdaptorRead2() throws Exception {\n-        testSocketAdaptorRead(60_000);\n-    }\n-\n-    private void testSocketAdaptorRead(int timeout) throws Exception {\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n+    void testSocketAdaptorRead(int timeout) throws Exception {\n@@ -423,14 +414,3 @@\n-    @Test\n-    void testSocketChannelAdaptorAccept1() throws Exception {\n-        testSocketChannelAdaptorAccept(0);\n-    }\n-\n-    \/**\n-     * Virtual thread blocks in ServerSocketChannel adaptor accept with timeout.\n-     *\/\n-    @Test\n-    void testSocketChannelAdaptorAccept2() throws Exception {\n-        testSocketChannelAdaptorAccept(60_000);\n-    }\n-\n-    private void testSocketChannelAdaptorAccept(int timeout) throws Exception {\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n+    void testSocketChannelAdaptorAccept(int timeout) throws Exception {\n@@ -549,14 +529,3 @@\n-    @Test\n-    void testDatagramSocketAdaptorReceive1() throws Exception {\n-        testDatagramSocketAdaptorReceive(0);\n-    }\n-\n-    \/**\n-     * Virtual thread blocks in DatagramSocket adaptor receive with timeout.\n-     *\/\n-    @Test\n-    void testDatagramSocketAdaptorReceive2() throws Exception {\n-        testDatagramSocketAdaptorReceive(60_000);\n-    }\n-\n-    private void testDatagramSocketAdaptorReceive(int timeout) throws Exception {\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n+    void testDatagramSocketAdaptorReceive(int timeout) throws Exception {\n@@ -588,15 +557,3 @@\n-    @Test\n-    void testDatagramSocketAdaptorReceiveAsyncClose1() throws Exception {\n-        testDatagramSocketAdaptorReceiveAsyncClose(0);\n-    }\n-\n-    \/**\n-     * DatagramChannel close while virtual thread blocked in adaptor receive\n-     * with timeout.\n-     *\/\n-    @Test\n-    void testDatagramSocketAdaptorReceiveAsyncClose2() throws Exception {\n-        testDatagramSocketAdaptorReceiveAsyncClose(60_1000);\n-    }\n-\n-    private void testDatagramSocketAdaptorReceiveAsyncClose(int timeout) throws Exception {\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n+    void testDatagramSocketAdaptorReceiveAsyncClose(int timeout) throws Exception {\n@@ -624,15 +581,3 @@\n-    @Test\n-    void testDatagramSocketAdaptorReceiveInterrupt1() throws Exception {\n-        testDatagramSocketAdaptorReceiveInterrupt(0);\n-    }\n-\n-    \/**\n-     * Virtual thread interrupted while blocked in DatagramSocket adaptor receive\n-     * with timeout.\n-     *\/\n-    @Test\n-    void testDatagramSocketAdaptorReceiveInterrupt2() throws Exception {\n-        testDatagramSocketAdaptorReceiveInterrupt(60_1000);\n-    }\n-\n-    private void testDatagramSocketAdaptorReceiveInterrupt(int timeout) throws Exception {\n+    @ParameterizedTest\n+    @ValueSource(ints = { 0, 60_000 })\n+    void testDatagramSocketAdaptorReceiveInterrupt(int timeout) throws Exception {\n","filename":"test\/jdk\/java\/nio\/channels\/vthread\/BlockingChannelOps.java","additions":17,"deletions":72,"binary":false,"changes":89,"status":"modified"}]}