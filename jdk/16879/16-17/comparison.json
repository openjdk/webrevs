{"files":[{"patch":"@@ -36,0 +36,1 @@\n+ * @run main\/othervm --add-opens=java.base\/java.io=ALL-UNNAMED TransferToTrusted\n@@ -61,1 +62,1 @@\n-    public static void main(String[] args) throws IOException {\n+    public static void main(String[] args) throws Exception {\n@@ -65,1 +66,0 @@\n-        byte[] dup = Arrays.copyOf(buf, buf.length);\n@@ -67,2 +67,6 @@\n-        var bis = new BufferedInputStream(new ByteArrayInputStream(dup));\n-        bis.mark(dup.length);\n+        var outputStreams = new OutputStream[]{\n+                new ByteArrayOutputStream(),\n+                new FileOutputStream(File.createTempFile(TransferToTrusted.class.getName(), null)),\n+                new PipedOutputStream(new PipedInputStream(length)),\n+                new UntrustedOutputStream()\n+        };\n@@ -70,11 +74,2 @@\n-        var tempFile = File.createTempFile(TransferToTrusted.class.getName(), null);\n-        try {\n-            var outputStreams = new OutputStream[]{\n-                    new ByteArrayOutputStream(),\n-                    new FileOutputStream(tempFile),\n-                    new PipedOutputStream(new PipedInputStream(length)),\n-                    new UntrustedOutputStream()\n-            };\n-\n-            for (var out : outputStreams) {\n-                System.err.println(\"out: \" + out.getClass().getName());\n+        for (var out : outputStreams) {\n+            System.err.println(\"out: \" + out.getClass().getName());\n@@ -82,0 +77,3 @@\n+            var bis = new BufferedInputStream(new ByteArrayInputStream(buf.clone()));\n+            try (out; bis) {\n+                bis.read();\/\/need this to fill the BIS.buf in\n@@ -83,5 +81,4 @@\n-                bis.reset();\n-                try (out) {\n-                    if (!Arrays.equals(buf, bis.readAllBytes())) {\n-                        throw new RuntimeException(\"Internal buffer was modified\");\n-                    }\n+                var internalBuffer = bis.getClass().getDeclaredField(\"buf\");\n+                internalBuffer.setAccessible(true);\n+                if (!Arrays.equals(buf, Arrays.copyOf((byte[]) internalBuffer.get(bis), length))) {\n+                    throw new RuntimeException(\"Internal buffer was modified\");\n@@ -89,1 +86,0 @@\n-                bis.reset();\n@@ -91,2 +87,0 @@\n-        } finally {\n-            tempFile.delete();\n","filename":"test\/jdk\/java\/io\/BufferedInputStream\/TransferToTrusted.java","additions":17,"deletions":23,"binary":false,"changes":40,"status":"modified"}]}