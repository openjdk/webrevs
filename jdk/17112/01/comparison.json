{"files":[{"patch":"@@ -1744,3 +1744,8 @@\n-void ShenandoahHeap::set_gc_state_all_threads(char state) {\n-  for (JavaThreadIteratorWithHandle jtiwh; JavaThread *t = jtiwh.next(); ) {\n-    ShenandoahThreadLocalData::set_gc_state(t, state);\n+void ShenandoahHeap::set_gc_state_all_threads() {\n+  assert(ShenandoahSafepoint::is_at_shenandoah_safepoint(), \"Must be at Shenandoah safepoint\");\n+  if (_gc_state_changed) {\n+    _gc_state_changed = false;\n+    char state = gc_state();\n+    for (JavaThreadIteratorWithHandle jtiwh; JavaThread *t = jtiwh.next(); ) {\n+      ShenandoahThreadLocalData::set_gc_state(t, state);\n+    }\n@@ -1751,1 +1756,1 @@\n-  assert(ShenandoahSafepoint::is_at_shenandoah_safepoint(), \"Should really be Shenandoah safepoint\");\n+  assert(ShenandoahSafepoint::is_at_shenandoah_safepoint(), \"Must be at Shenandoah safepoint\");\n@@ -1753,1 +1758,1 @@\n-  set_gc_state_all_threads(_gc_state.raw_value());\n+  _gc_state_changed = true;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.cpp","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -127,0 +127,1 @@\n+\n@@ -286,0 +287,1 @@\n+  bool _gc_state_changed;\n@@ -294,1 +296,0 @@\n-  void set_gc_state_all_threads(char state);\n@@ -299,0 +300,2 @@\n+  void set_gc_state_all_threads();\n+  bool has_gc_state_changed() { return _gc_state_changed; }\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahHeap.hpp","additions":4,"deletions":1,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -38,0 +38,9 @@\n+bool VM_ShenandoahOperation::doit_prologue() {\n+  assert(!ShenandoahHeap::heap()->has_gc_state_changed(), \"GC State can only be changed on a safepoint.\");\n+  return true;\n+}\n+\n+void VM_ShenandoahOperation::doit_epilogue() {\n+  assert(!ShenandoahHeap::heap()->has_gc_state_changed(), \"GC State was not synchronized to java threads.\");\n+}\n+\n@@ -39,0 +48,1 @@\n+  VM_ShenandoahOperation::doit_prologue();\n@@ -44,0 +54,1 @@\n+  VM_ShenandoahOperation::doit_epilogue();\n@@ -54,0 +65,1 @@\n+  ShenandoahHeap::heap()->set_gc_state_all_threads();\n@@ -59,0 +71,1 @@\n+  ShenandoahHeap::heap()->set_gc_state_all_threads();\n@@ -64,0 +77,1 @@\n+  ShenandoahHeap::heap()->set_gc_state_all_threads();\n@@ -69,0 +83,1 @@\n+  ShenandoahHeap::heap()->set_gc_state_all_threads();\n@@ -74,0 +89,1 @@\n+  ShenandoahHeap::heap()->set_gc_state_all_threads();\n@@ -79,0 +95,1 @@\n+  ShenandoahHeap::heap()->set_gc_state_all_threads();\n@@ -84,0 +101,1 @@\n+  ShenandoahHeap::heap()->set_gc_state_all_threads();\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVMOperations.cpp","additions":18,"deletions":0,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -51,0 +51,2 @@\n+  bool doit_prologue() override;\n+  void doit_epilogue() override;\n@@ -56,2 +58,2 @@\n-  bool doit_prologue();\n-  void doit_epilogue();\n+  bool doit_prologue() override;\n+  void doit_epilogue() override;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVMOperations.hpp","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -623,0 +623,2 @@\n+  ShenandoahHeap::heap()->set_gc_state_all_threads();\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahVerifier.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}