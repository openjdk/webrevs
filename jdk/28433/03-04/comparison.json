{"files":[{"patch":"@@ -440,1 +440,2 @@\n-  ADD(_crc_table);\n+  \/\/ this is added in generic code\n+  \/\/ ADD(_crc_table);\n","filename":"src\/hotspot\/cpu\/aarch64\/stubRoutines_aarch64.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -444,1 +444,2 @@\n-  ADD(_crc_table);\n+  \/\/ this is added in generic code\n+  \/\/ ADD(_crc_table);\n","filename":"src\/hotspot\/cpu\/x86\/stubRoutines_x86.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1722,1 +1722,1 @@\n-#define _extrs_max 350\n+#define _extrs_max 380\n@@ -1731,1 +1731,1 @@\n-\/\/ th esame across an assembly run and subsequent production run\n+\/\/ the same across an assembly run and subsequent production run\n@@ -1733,4 +1733,5 @@\n-#define SET_ADDRESS(type, addr)                           \\\n-  {                                                       \\\n-    type##_addr[type##_length++] = (address) (addr);      \\\n-    assert(type##_length <= type##_max, \"increase size\"); \\\n+#define ADD_EXTERNAL_ADDRESS(addr)                              \\\n+  {                                                             \\\n+    hash_address((address) addr, _extrs_length);                  \\\n+    _extrs_addr[_extrs_length++] = (address) (addr);             \\\n+    assert(_extrs_length <= _extrs_max, \"increase size\");       \\\n@@ -1739,0 +1740,26 @@\n+\/\/ insert into to the address hash table the index of an external\n+\/\/ address or a stub address in the list of external or stub\n+\/\/ addresses, respectively, keyed by the relevant address\n+\n+void AOTCodeAddressTable::hash_address(address addr, int idx) {\n+  \/\/ only do this if we are caching stubs and we have a non-null\n+  \/\/ address to record\n+  if (!AOTStubCaching) {\n+    return;\n+  }\n+  if (addr == nullptr) {\n+    return;\n+  }\n+  \/\/ check opened_cache because this can be called before the cache is\n+  \/\/ properly initialized and only continue when dumping is enabled\n+  if (opened_cache != nullptr && opened_cache->for_dump()) {\n+    if (_hash_table == nullptr) {\n+      _hash_table = new (mtCode) AOTCodeAddressHashTable();\n+    }\n+    assert(_hash_table->get(addr) == nullptr, \"repeated insert of address \" INTPTR_FORMAT, p2i(addr));\n+    _hash_table->put(addr, idx);\n+    log_trace(aot, codecache)(\"Address \" INTPTR_FORMAT \" inserted into AOT Code Cache address hash table with index '%d'\",\n+                              p2i(addr), idx);\n+  }\n+}\n+\n@@ -1751,5 +1778,5 @@\n-    SET_ADDRESS(_extrs, SharedRuntime::exception_handler_for_return_address); \/\/ used by forward_exception\n-    SET_ADDRESS(_extrs, CompressedOops::base_addr()); \/\/ used by call_stub\n-    SET_ADDRESS(_extrs, Thread::current); \/\/ used by call_stub\n-    SET_ADDRESS(_extrs, SharedRuntime::throw_StackOverflowError);\n-    SET_ADDRESS(_extrs, SharedRuntime::throw_delayed_StackOverflowError);\n+    ADD_EXTERNAL_ADDRESS(SharedRuntime::exception_handler_for_return_address); \/\/ used by forward_exception\n+    ADD_EXTERNAL_ADDRESS(CompressedOops::base_addr()); \/\/ used by call_stub\n+    ADD_EXTERNAL_ADDRESS(Thread::current); \/\/ used by call_stub\n+    ADD_EXTERNAL_ADDRESS(SharedRuntime::throw_StackOverflowError);\n+    ADD_EXTERNAL_ADDRESS(SharedRuntime::throw_delayed_StackOverflowError);\n@@ -1759,4 +1786,4 @@\n-  SET_ADDRESS(_extrs, SharedRuntime::fixup_callers_callsite);\n-  SET_ADDRESS(_extrs, SharedRuntime::handle_wrong_method);\n-  SET_ADDRESS(_extrs, SharedRuntime::handle_wrong_method_abstract);\n-  SET_ADDRESS(_extrs, SharedRuntime::handle_wrong_method_ic_miss);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::fixup_callers_callsite);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::handle_wrong_method);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::handle_wrong_method_abstract);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::handle_wrong_method_ic_miss);\n@@ -1764,1 +1791,1 @@\n-  SET_ADDRESS(_extrs, JavaThread::aarch64_get_thread_helper);\n+  ADD_EXTERNAL_ADDRESS(JavaThread::aarch64_get_thread_helper);\n@@ -1768,9 +1795,9 @@\n-  SET_ADDRESS(_extrs, &SharedRuntime::_jbyte_array_copy_ctr); \/\/ used by arraycopy stub on arm32 and x86_64\n-  SET_ADDRESS(_extrs, &SharedRuntime::_jshort_array_copy_ctr); \/\/ used by arraycopy stub\n-  SET_ADDRESS(_extrs, &SharedRuntime::_jint_array_copy_ctr); \/\/ used by arraycopy stub\n-  SET_ADDRESS(_extrs, &SharedRuntime::_jlong_array_copy_ctr); \/\/ used by arraycopy stub\n-  SET_ADDRESS(_extrs, &SharedRuntime::_oop_array_copy_ctr); \/\/ used by arraycopy stub\n-  SET_ADDRESS(_extrs, &SharedRuntime::_checkcast_array_copy_ctr); \/\/ used by arraycopy stub\n-  SET_ADDRESS(_extrs, &SharedRuntime::_unsafe_array_copy_ctr); \/\/ used by arraycopy stub\n-  SET_ADDRESS(_extrs, &SharedRuntime::_generic_array_copy_ctr); \/\/ used by arraycopy stub\n-  SET_ADDRESS(_extrs, &SharedRuntime::_unsafe_set_memory_ctr); \/\/ used by arraycopy stub\n+  ADD_EXTERNAL_ADDRESS(&SharedRuntime::_jbyte_array_copy_ctr); \/\/ used by arraycopy stub on arm32 and x86_64\n+  ADD_EXTERNAL_ADDRESS(&SharedRuntime::_jshort_array_copy_ctr); \/\/ used by arraycopy stub\n+  ADD_EXTERNAL_ADDRESS(&SharedRuntime::_jint_array_copy_ctr); \/\/ used by arraycopy stub\n+  ADD_EXTERNAL_ADDRESS(&SharedRuntime::_jlong_array_copy_ctr); \/\/ used by arraycopy stub\n+  ADD_EXTERNAL_ADDRESS(&SharedRuntime::_oop_array_copy_ctr); \/\/ used by arraycopy stub\n+  ADD_EXTERNAL_ADDRESS(&SharedRuntime::_checkcast_array_copy_ctr); \/\/ used by arraycopy stub\n+  ADD_EXTERNAL_ADDRESS(&SharedRuntime::_unsafe_array_copy_ctr); \/\/ used by arraycopy stub\n+  ADD_EXTERNAL_ADDRESS(&SharedRuntime::_generic_array_copy_ctr); \/\/ used by arraycopy stub\n+  ADD_EXTERNAL_ADDRESS(&SharedRuntime::_unsafe_set_memory_ctr); \/\/ used by arraycopy stub\n@@ -1779,1 +1806,1 @@\n-  SET_ADDRESS(_extrs, SharedRuntime::enable_stack_reserved_zone);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::enable_stack_reserved_zone);\n@@ -1782,2 +1809,2 @@\n-  SET_ADDRESS(_extrs, SharedRuntime::montgomery_multiply);\n-  SET_ADDRESS(_extrs, SharedRuntime::montgomery_square);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::montgomery_multiply);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::montgomery_square);\n@@ -1786,8 +1813,8 @@\n-  SET_ADDRESS(_extrs, SharedRuntime::d2f);\n-  SET_ADDRESS(_extrs, SharedRuntime::d2i);\n-  SET_ADDRESS(_extrs, SharedRuntime::d2l);\n-  SET_ADDRESS(_extrs, SharedRuntime::dcos);\n-  SET_ADDRESS(_extrs, SharedRuntime::dexp);\n-  SET_ADDRESS(_extrs, SharedRuntime::dlog);\n-  SET_ADDRESS(_extrs, SharedRuntime::dlog10);\n-  SET_ADDRESS(_extrs, SharedRuntime::dpow);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::d2f);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::d2i);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::d2l);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::dcos);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::dexp);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::dlog);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::dlog10);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::dpow);\n@@ -1795,1 +1822,1 @@\n-  SET_ADDRESS(_extrs, SharedRuntime::drem);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::drem);\n@@ -1797,4 +1824,4 @@\n-  SET_ADDRESS(_extrs, SharedRuntime::dsin);\n-  SET_ADDRESS(_extrs, SharedRuntime::dtan);\n-  SET_ADDRESS(_extrs, SharedRuntime::f2i);\n-  SET_ADDRESS(_extrs, SharedRuntime::f2l);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::dsin);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::dtan);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::f2i);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::f2l);\n@@ -1802,1 +1829,1 @@\n-  SET_ADDRESS(_extrs, SharedRuntime::frem);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::frem);\n@@ -1804,5 +1831,5 @@\n-  SET_ADDRESS(_extrs, SharedRuntime::l2d);\n-  SET_ADDRESS(_extrs, SharedRuntime::l2f);\n-  SET_ADDRESS(_extrs, SharedRuntime::ldiv);\n-  SET_ADDRESS(_extrs, SharedRuntime::lmul);\n-  SET_ADDRESS(_extrs, SharedRuntime::lrem);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::l2d);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::l2f);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::ldiv);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::lmul);\n+  ADD_EXTERNAL_ADDRESS(SharedRuntime::lrem);\n@@ -1811,1 +1838,1 @@\n-  SET_ADDRESS(_extrs, &JvmtiExport::_should_notify_object_alloc);\n+  ADD_EXTERNAL_ADDRESS(&JvmtiExport::_should_notify_object_alloc);\n@@ -1814,2 +1841,3 @@\n-  SET_ADDRESS(_extrs, ThreadIdentifier::unsafe_offset());\n-  SET_ADDRESS(_extrs, Thread::current);\n+  ADD_EXTERNAL_ADDRESS(ThreadIdentifier::unsafe_offset());\n+  \/\/ already added\n+  \/\/ ADD_EXTERNAL_ADDRESS(Thread::current);\n@@ -1817,2 +1845,2 @@\n-  SET_ADDRESS(_extrs, os::javaTimeMillis);\n-  SET_ADDRESS(_extrs, os::javaTimeNanos);\n+  ADD_EXTERNAL_ADDRESS(os::javaTimeMillis);\n+  ADD_EXTERNAL_ADDRESS(os::javaTimeNanos);\n@@ -1820,1 +1848,1 @@\n-  SET_ADDRESS(_extrs, os::breakpoint);\n+  ADD_EXTERNAL_ADDRESS(os::breakpoint);\n@@ -1823,1 +1851,1 @@\n-  SET_ADDRESS(_extrs, StubRoutines::crc_table_addr());\n+  ADD_EXTERNAL_ADDRESS(StubRoutines::crc_table_addr());\n@@ -1825,2 +1853,2 @@\n-  SET_ADDRESS(_extrs, &SharedRuntime::_partial_subtype_ctr);\n-  SET_ADDRESS(_extrs, JavaThread::verify_cross_modify_fence_failure);\n+  ADD_EXTERNAL_ADDRESS(&SharedRuntime::_partial_subtype_ctr);\n+  ADD_EXTERNAL_ADDRESS(JavaThread::verify_cross_modify_fence_failure);\n@@ -1830,2 +1858,2 @@\n-  SET_ADDRESS(_extrs, JfrIntrinsicSupport::write_checkpoint);\n-  SET_ADDRESS(_extrs, JfrIntrinsicSupport::return_lease);\n+  ADD_EXTERNAL_ADDRESS(JfrIntrinsicSupport::write_checkpoint);\n+  ADD_EXTERNAL_ADDRESS(JfrIntrinsicSupport::return_lease);\n@@ -1834,1 +1862,1 @@\n-  SET_ADDRESS(_extrs, UpcallLinker::handle_uncaught_exception); \/\/ used by upcall_stub_exception_handler\n+  ADD_EXTERNAL_ADDRESS(UpcallLinker::handle_uncaught_exception); \/\/ used by upcall_stub_exception_handler\n@@ -1838,10 +1866,11 @@\n-    SET_ADDRESS(_extrs, Deoptimization::fetch_unroll_info);\n-    SET_ADDRESS(_extrs, Deoptimization::unpack_frames);\n-    SET_ADDRESS(_extrs, SafepointSynchronize::handle_polling_page_exception);\n-    SET_ADDRESS(_extrs, SharedRuntime::resolve_opt_virtual_call_C);\n-    SET_ADDRESS(_extrs, SharedRuntime::resolve_virtual_call_C);\n-    SET_ADDRESS(_extrs, SharedRuntime::resolve_static_call_C);\n-    SET_ADDRESS(_extrs, SharedRuntime::throw_delayed_StackOverflowError);\n-    SET_ADDRESS(_extrs, SharedRuntime::throw_AbstractMethodError);\n-    SET_ADDRESS(_extrs, SharedRuntime::throw_IncompatibleClassChangeError);\n-    SET_ADDRESS(_extrs, SharedRuntime::throw_NullPointerException_at_call);\n+    ADD_EXTERNAL_ADDRESS(Deoptimization::fetch_unroll_info);\n+    ADD_EXTERNAL_ADDRESS(Deoptimization::unpack_frames);\n+    ADD_EXTERNAL_ADDRESS(SafepointSynchronize::handle_polling_page_exception);\n+    ADD_EXTERNAL_ADDRESS(SharedRuntime::resolve_opt_virtual_call_C);\n+    ADD_EXTERNAL_ADDRESS(SharedRuntime::resolve_virtual_call_C);\n+    ADD_EXTERNAL_ADDRESS(SharedRuntime::resolve_static_call_C);\n+    \/\/ already added\n+    \/\/ ADD_EXTERNAL_ADDRESS(SharedRuntime::throw_delayed_StackOverflowError);\n+    ADD_EXTERNAL_ADDRESS(SharedRuntime::throw_AbstractMethodError);\n+    ADD_EXTERNAL_ADDRESS(SharedRuntime::throw_IncompatibleClassChangeError);\n+    ADD_EXTERNAL_ADDRESS(SharedRuntime::throw_NullPointerException_at_call);\n@@ -1853,28 +1882,29 @@\n-    SET_ADDRESS(_extrs, static_cast<int (*)(oopDesc*)>(SharedRuntime::dtrace_object_alloc));\n-    SET_ADDRESS(_extrs, SharedRuntime::register_finalizer);\n-    SET_ADDRESS(_extrs, Runtime1::is_instance_of);\n-    SET_ADDRESS(_extrs, Runtime1::exception_handler_for_pc);\n-    SET_ADDRESS(_extrs, Runtime1::check_abort_on_vm_exception);\n-    SET_ADDRESS(_extrs, Runtime1::new_instance);\n-    SET_ADDRESS(_extrs, Runtime1::counter_overflow);\n-    SET_ADDRESS(_extrs, Runtime1::new_type_array);\n-    SET_ADDRESS(_extrs, Runtime1::new_object_array);\n-    SET_ADDRESS(_extrs, Runtime1::new_multi_array);\n-    SET_ADDRESS(_extrs, Runtime1::throw_range_check_exception);\n-    SET_ADDRESS(_extrs, Runtime1::throw_index_exception);\n-    SET_ADDRESS(_extrs, Runtime1::throw_div0_exception);\n-    SET_ADDRESS(_extrs, Runtime1::throw_null_pointer_exception);\n-    SET_ADDRESS(_extrs, Runtime1::throw_array_store_exception);\n-    SET_ADDRESS(_extrs, Runtime1::throw_class_cast_exception);\n-    SET_ADDRESS(_extrs, Runtime1::throw_incompatible_class_change_error);\n-    SET_ADDRESS(_extrs, Runtime1::monitorenter);\n-    SET_ADDRESS(_extrs, Runtime1::monitorexit);\n-    SET_ADDRESS(_extrs, Runtime1::deoptimize);\n-    SET_ADDRESS(_extrs, Runtime1::access_field_patching);\n-    SET_ADDRESS(_extrs, Runtime1::move_klass_patching);\n-    SET_ADDRESS(_extrs, Runtime1::move_mirror_patching);\n-    SET_ADDRESS(_extrs, Runtime1::move_appendix_patching);\n-    SET_ADDRESS(_extrs, Runtime1::predicate_failed_trap);\n-    SET_ADDRESS(_extrs, Runtime1::unimplemented_entry);\n-    SET_ADDRESS(_extrs, Thread::current);\n-    SET_ADDRESS(_extrs, CompressedKlassPointers::base_addr());\n+    ADD_EXTERNAL_ADDRESS(static_cast<int (*)(oopDesc*)>(SharedRuntime::dtrace_object_alloc));\n+    ADD_EXTERNAL_ADDRESS(SharedRuntime::register_finalizer);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::is_instance_of);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::exception_handler_for_pc);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::check_abort_on_vm_exception);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::new_instance);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::counter_overflow);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::new_type_array);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::new_object_array);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::new_multi_array);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::throw_range_check_exception);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::throw_index_exception);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::throw_div0_exception);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::throw_null_pointer_exception);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::throw_array_store_exception);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::throw_class_cast_exception);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::throw_incompatible_class_change_error);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::monitorenter);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::monitorexit);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::deoptimize);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::access_field_patching);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::move_klass_patching);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::move_mirror_patching);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::move_appendix_patching);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::predicate_failed_trap);\n+    ADD_EXTERNAL_ADDRESS(Runtime1::unimplemented_entry);\n+    \/\/ already added\n+    \/\/ ADD_EXTERNAL_ADDRESS(Thread::current);\n+    ADD_EXTERNAL_ADDRESS(CompressedKlassPointers::base_addr());\n@@ -1887,20 +1917,20 @@\n-    SET_ADDRESS(_extrs, Deoptimization::uncommon_trap);\n-    SET_ADDRESS(_extrs, OptoRuntime::handle_exception_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::new_instance_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::new_array_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::new_array_nozero_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::multianewarray2_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::multianewarray3_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::multianewarray4_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::multianewarray5_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::multianewarrayN_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::complete_monitor_locking_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::monitor_notify_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::monitor_notifyAll_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::rethrow_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::slow_arraycopy_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::register_finalizer_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::vthread_end_first_transition_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::vthread_start_final_transition_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::vthread_start_transition_C);\n-    SET_ADDRESS(_extrs, OptoRuntime::vthread_end_transition_C);\n+    ADD_EXTERNAL_ADDRESS(Deoptimization::uncommon_trap);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::handle_exception_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::new_instance_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::new_array_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::new_array_nozero_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::multianewarray2_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::multianewarray3_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::multianewarray4_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::multianewarray5_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::multianewarrayN_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::complete_monitor_locking_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::monitor_notify_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::monitor_notifyAll_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::rethrow_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::slow_arraycopy_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::register_finalizer_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::vthread_end_first_transition_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::vthread_start_final_transition_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::vthread_start_transition_C);\n+    ADD_EXTERNAL_ADDRESS(OptoRuntime::vthread_end_transition_C);\n@@ -1908,1 +1938,1 @@\n-    SET_ADDRESS(_extrs, JavaThread::verify_cross_modify_fence_failure);\n+    ADD_EXTERNAL_ADDRESS(JavaThread::verify_cross_modify_fence_failure);\n@@ -1914,5 +1944,5 @@\n-  SET_ADDRESS(_extrs, G1BarrierSetRuntime::write_ref_field_pre_entry);\n-  SET_ADDRESS(_extrs, G1BarrierSetRuntime::write_ref_array_pre_narrow_oop_entry); \/\/ used by arraycopy stubs\n-  SET_ADDRESS(_extrs, G1BarrierSetRuntime::write_ref_array_pre_oop_entry); \/\/ used by arraycopy stubs\n-  SET_ADDRESS(_extrs, G1BarrierSetRuntime::write_ref_array_post_entry); \/\/ used by arraycopy stubs\n-  SET_ADDRESS(_extrs, BarrierSetNMethod::nmethod_stub_entry_barrier); \/\/ used by method_entry_barrier\n+  ADD_EXTERNAL_ADDRESS(G1BarrierSetRuntime::write_ref_field_pre_entry);\n+  ADD_EXTERNAL_ADDRESS(G1BarrierSetRuntime::write_ref_array_pre_narrow_oop_entry); \/\/ used by arraycopy stubs\n+  ADD_EXTERNAL_ADDRESS(G1BarrierSetRuntime::write_ref_array_pre_oop_entry); \/\/ used by arraycopy stubs\n+  ADD_EXTERNAL_ADDRESS(G1BarrierSetRuntime::write_ref_array_post_entry); \/\/ used by arraycopy stubs\n+  ADD_EXTERNAL_ADDRESS(BarrierSetNMethod::nmethod_stub_entry_barrier); \/\/ used by method_entry_barrier\n@@ -1922,3 +1952,9 @@\n-  SET_ADDRESS(_extrs, ShenandoahRuntime::write_barrier_pre);\n-  SET_ADDRESS(_extrs, ShenandoahRuntime::load_reference_barrier_phantom);\n-  SET_ADDRESS(_extrs, ShenandoahRuntime::load_reference_barrier_phantom_narrow);\n+  ADD_EXTERNAL_ADDRESS(ShenandoahRuntime::write_barrier_pre);\n+  ADD_EXTERNAL_ADDRESS(ShenandoahRuntime::load_reference_barrier_strong);\n+  ADD_EXTERNAL_ADDRESS(ShenandoahRuntime::load_reference_barrier_strong_narrow);\n+  ADD_EXTERNAL_ADDRESS(ShenandoahRuntime::load_reference_barrier_weak);\n+  ADD_EXTERNAL_ADDRESS(ShenandoahRuntime::load_reference_barrier_weak_narrow);\n+  ADD_EXTERNAL_ADDRESS(ShenandoahRuntime::load_reference_barrier_phantom);\n+  ADD_EXTERNAL_ADDRESS(ShenandoahRuntime::load_reference_barrier_phantom_narrow);\n+  ADD_EXTERNAL_ADDRESS(ShenandoahRuntime::arraycopy_barrier_oop);\n+  ADD_EXTERNAL_ADDRESS(ShenandoahRuntime::arraycopy_barrier_narrow_oop);\n@@ -1927,2 +1963,14 @@\n-  SET_ADDRESS(_extrs, ZBarrierSetRuntime::load_barrier_on_oop_field_preloaded_addr());\n-  SET_ADDRESS(_extrs, ZBarrierSetRuntime::load_barrier_on_phantom_oop_field_preloaded_addr());\n+  ADD_EXTERNAL_ADDRESS(ZBarrierSetRuntime::load_barrier_on_oop_field_preloaded_addr());\n+  ADD_EXTERNAL_ADDRESS(ZBarrierSetRuntime::load_barrier_on_oop_field_preloaded_store_good_addr());\n+  ADD_EXTERNAL_ADDRESS(ZBarrierSetRuntime::load_barrier_on_weak_oop_field_preloaded_addr());\n+  ADD_EXTERNAL_ADDRESS(ZBarrierSetRuntime::load_barrier_on_phantom_oop_field_preloaded_addr());\n+  ADD_EXTERNAL_ADDRESS(ZBarrierSetRuntime::no_keepalive_load_barrier_on_weak_oop_field_preloaded_addr());\n+  ADD_EXTERNAL_ADDRESS(ZBarrierSetRuntime::no_keepalive_load_barrier_on_phantom_oop_field_preloaded_addr());\n+  ADD_EXTERNAL_ADDRESS(ZBarrierSetRuntime::store_barrier_on_oop_field_with_healing_addr());\n+  ADD_EXTERNAL_ADDRESS(ZBarrierSetRuntime::store_barrier_on_oop_field_without_healing_addr());\n+  ADD_EXTERNAL_ADDRESS(ZBarrierSetRuntime::no_keepalive_store_barrier_on_oop_field_without_healing_addr());\n+  ADD_EXTERNAL_ADDRESS(ZBarrierSetRuntime::load_barrier_on_oop_array_addr());\n+\n+  ADD_EXTERNAL_ADDRESS(ZPointerVectorLoadBadMask);\n+  ADD_EXTERNAL_ADDRESS(ZPointerVectorStoreBadMask);\n+  ADD_EXTERNAL_ADDRESS(ZPointerVectorStoreGoodMask);\n@@ -1930,1 +1978,2 @@\n-  SET_ADDRESS(_extrs, &ZPointerLoadShift);\n+  ADD_EXTERNAL_ADDRESS(&ZPointerLoadShift);\n+  ADD_EXTERNAL_ADDRESS(&ZPointerLoadShiftTable);\n@@ -1935,1 +1984,1 @@\n-  SET_ADDRESS(_extrs, MacroAssembler::debug64);\n+  ADD_EXTERNAL_ADDRESS(MacroAssembler::debug64);\n@@ -1950,3 +1999,3 @@\n-  SET_ADDRESS(_extrs, Continuation::prepare_thaw); \/\/ used by cont_thaw\n-  SET_ADDRESS(_extrs, Continuation::thaw_entry()); \/\/ used by cont_thaw\n-  SET_ADDRESS(_extrs, ContinuationEntry::thaw_call_pc_address()); \/\/ used by cont_preempt_stub\n+  ADD_EXTERNAL_ADDRESS(Continuation::prepare_thaw); \/\/ used by cont_thaw\n+  ADD_EXTERNAL_ADDRESS(Continuation::thaw_entry()); \/\/ used by cont_thaw\n+  ADD_EXTERNAL_ADDRESS(ContinuationEntry::thaw_call_pc_address()); \/\/ used by cont_preempt_stub\n@@ -1963,1 +2012,1 @@\n-    SET_ADDRESS(_extrs, addresses.at(i));\n+    ADD_EXTERNAL_ADDRESS(addresses.at(i));\n@@ -1978,0 +2027,1 @@\n+  hash_address(a, idx);\n@@ -2197,0 +2247,9 @@\n+  if (_hash_table != nullptr) {\n+    int *result = _hash_table->get(addr);\n+    if (result != nullptr) {\n+      id = *result;\n+      log_trace(aot, codecache)(\"Address \" INTPTR_FORMAT \" retrieved from AOT Code Cache address hash table with index '%d'\",\n+                                p2i(addr), id);\n+      return id;\n+    }\n+  }\n","filename":"src\/hotspot\/share\/code\/aotCodeCache.cpp","additions":193,"deletions":134,"binary":false,"changes":327,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"utilities\/hashTable.hpp\"\n@@ -124,0 +125,10 @@\n+\/\/ we use a hash table to speed up translation of external addresses\n+\/\/ or stub addresses to their corresponding indexes when dumping stubs\n+\/\/ or nmethods to the AOT code cache.\n+class AOTCodeAddressHashTable : public HashTable<\n+  address,\n+  int,\n+  36137, \/\/ prime number\n+  AnyObj::C_HEAP,\n+  mtCode> {};\n+\n@@ -136,1 +147,1 @@\n-  bool _complete;\n+  AOTCodeAddressHashTable* _hash_table;\n@@ -138,0 +149,1 @@\n+  void hash_address(address addr, int idx);\n@@ -148,1 +160,1 @@\n-    _complete(false)\n+    _hash_table(nullptr)\n","filename":"src\/hotspot\/share\/code\/aotCodeCache.hpp","additions":14,"deletions":2,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -609,1 +609,1 @@\n-  address uncommon_trap() const                  { return code_begin() + _uncommon_trap_offset; }\n+  address uncommon_trap() const                  { return (EnableJVMCI ? code_begin() + _uncommon_trap_offset : nullptr); }\n@@ -615,1 +615,1 @@\n-  address implicit_exception_uncommon_trap() const { return code_begin() + _implicit_exception_uncommon_trap_offset; }\n+  address implicit_exception_uncommon_trap() const { return (EnableJVMCI ? code_begin() + _implicit_exception_uncommon_trap_offset : nullptr); }\n","filename":"src\/hotspot\/share\/code\/codeBlob.hpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"}]}