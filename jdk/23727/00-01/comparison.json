{"files":[{"patch":"@@ -29,1 +29,1 @@\n-import java.io.IOException;\n+import java.io.FileOutputStream;\n@@ -35,0 +35,1 @@\n+import java.security.PrivateKey;\n@@ -38,1 +39,0 @@\n-import java.util.Arrays;\n@@ -43,0 +43,1 @@\n+import jdk.test.lib.security.KeyStoreUtils;\n@@ -70,0 +71,1 @@\n+    private static final String PASSWORD = \"changeit\";\n@@ -73,0 +75,1 @@\n+     *\n@@ -77,2 +80,8 @@\n-        final String ktBaseParameters = \"-storepass changeit \" +\n-                                        \"-keypass changeit \" +\n+        final String intAliase = \"int\";\n+        final String userAlias = \"user\";\n+        final String caAlias = \"ca\";\n+\n+        final String certplaceCerts = \"certreplace.certs\";\n+\n+        final String ktBaseParameters = \"-storepass \" + PASSWORD + \" \" +\n+                                        \"-keypass \" + PASSWORD + \" \" +\n@@ -87,1 +96,1 @@\n-                              \"-genkeypair -alias ca -dname CN=CA -keyalg rsa -sigalg md2withrsa -ext bc\");\n+                              \"-genkeypair -alias \" + caAlias + \" -dname CN=CA -keyalg rsa -sigalg md2withrsa -ext bc\");\n@@ -89,1 +98,1 @@\n-                              \"-genkeypair -alias int -dname CN=Int -keyalg rsa\");\n+                              \"-genkeypair -alias \" + intAliase + \" -dname CN=Int -keyalg rsa\");\n@@ -91,1 +100,3 @@\n-                              \"-genkeypair -alias user -dname CN=User -keyalg rsa\");\n+                              \"-genkeypair -alias \" + userAlias + \" -dname CN=User -keyalg rsa\");\n+\n+        final KeyStore keyStore = KeyStoreUtils.loadKeyStore(CERTREPLACE_JKS, PASSWORD);\n@@ -94,0 +105,3 @@\n+        final String intReqFile = intAliase + \".req\";\n+        final String intCertFileName = intAliase + \".cert\";\n+\n@@ -95,3 +109,1 @@\n-                              \"-certreq -alias int -file int.req\");\n-        SecurityTools.keytool(ktBaseParameters +\n-                              \"-gencert -rfc -alias ca -ext bc -infile int.req -outfile int.cert\");\n+                              \"-certreq -alias \" + intAliase + \" -file \" + intReqFile);\n@@ -99,1 +111,2 @@\n-                              \"-import -alias int -file int.cert\");\n+                              \"-gencert -rfc -alias \" + caAlias + \" -ext bc -infile \" + intReqFile + \" \" +\n+                              \"-outfile \" + intCertFileName);\n@@ -101,0 +114,13 @@\n+        \/\/putting the certificate in the keystore\n+        final CertificateFactory certificateFactory = CertificateFactory.getInstance(\"X509\");\n+        final Certificate[] certs = new Certificate[]{\n+                certificateFactory.generateCertificate(\n+                        new FileInputStream(intCertFileName)\n+                )\n+        };\n+        final PrivateKey privateKey = (PrivateKey) keyStore.getKey(intAliase, PASSWORD.toCharArray());\n+        keyStore.setKeyEntry(intAliase, privateKey, PASSWORD.toCharArray(), certs);\n+        keyStore.store(new FileOutputStream(CERTREPLACE_JKS), PASSWORD.toCharArray());\n+\n+\n+        final String userReqFile = userAlias + \".req\";\n@@ -102,3 +128,1 @@\n-                              \"-certreq -alias user -file user.req\");\n-        SecurityTools.keytool(ktBaseParameters +\n-                              \"-gencert -rfc -alias int -infile user.req -outfile user.cert\");\n+                              \"-certreq -alias \" + userAlias + \" -file \" + userReqFile);\n@@ -106,1 +130,3 @@\n-                              \"-import -alias user -file user.cert\");\n+                              \"-gencert -rfc -alias \" + intAliase + \" \" +\n+                              \"-infile \" + userReqFile + \" \" +\n+                              \"-outfile \" + certplaceCerts); \/\/ this will create certreplace.certs which is later appended\n@@ -109,5 +135,1 @@\n-        final Path certPath = Paths.get(\"certreplace.certs\");\n-\n-        final String outputUser = SecurityTools.keytool(ktBaseParameters +\n-                                                        \"-export -alias user -rfc\").getOutput();\n-        Files.write(certPath, outputUser.getBytes());\n+        final Path certPath = Paths.get(certplaceCerts);\n@@ -115,3 +137,1 @@\n-        final String outputInt = SecurityTools.keytool(ktBaseParameters +\n-                                                       \"-export -rfc -alias int\").getOutput();\n-        Files.write(certPath, outputInt.getBytes(), StandardOpenOption.APPEND);\n+        Files.write(certPath, Files.readAllBytes(Path.of(intCertFileName)), StandardOpenOption.APPEND);\n@@ -120,1 +140,1 @@\n-                                                      \"-export -rfc -alias ca\").getOutput();\n+                                                      \"-export -rfc -alias \" + caAlias).getOutput();\n@@ -125,5 +145,3 @@\n-                              \"-selfcert -alias ca\");\n-        SecurityTools.keytool(ktBaseParameters +\n-                              \"-delete -alias int\");\n-        SecurityTools.keytool(ktBaseParameters +\n-                              \"-delete -alias user\");\n+                              \"-selfcert -alias \" + caAlias);\n+        keyStore.deleteEntry(intAliase);\n+        keyStore.deleteEntry(userAlias);\n@@ -134,0 +152,1 @@\n+     *\n@@ -138,2 +157,6 @@\n-        final String ktBaseParameters = \"-storepass changeit \" +\n-                                        \"-keypass changeit \" +\n+        final String ca1Alias = \"ca1\";\n+        final String ca2Alias = \"ca2\";\n+        final String userAlias = \"user\";\n+\n+        final String ktBaseParameters = \"-storepass \" + PASSWORD + \" \" +\n+                                        \"-keypass \" + PASSWORD + \" \" +\n@@ -149,1 +172,1 @@\n-                              \" -genkeypair -alias ca1 -dname CN=CA -keyalg rsa \" +\n+                              \"-genkeypair -alias \" + ca1Alias + \" -dname CN=CA -keyalg rsa \" +\n@@ -152,1 +175,1 @@\n-                              \"-genkeypair -alias ca2 -dname CN=CA -keyalg rsa \" +\n+                              \"-genkeypair -alias \" + ca2Alias + \" -dname CN=CA -keyalg rsa \" +\n@@ -155,1 +178,3 @@\n-                              \"-genkeypair -alias user -dname CN=User -keyalg rsa\");\n+                              \"-genkeypair -alias \" + userAlias + \" -dname CN=User -keyalg rsa\");\n+\n+        final KeyStore keyStore = KeyStoreUtils.loadKeyStore(SAMEDN_JKS, PASSWORD);\n@@ -159,0 +184,3 @@\n+        \/\/ Automatically saves the certs to the certs files\n+\n+        final String userReqFile = userAlias + \".req\";\n@@ -160,1 +188,1 @@\n-                              \"-certreq -alias user -file user.req\");\n+                              \"-certreq -alias \" + userAlias + \" -file \" + userReqFile);\n@@ -162,1 +190,2 @@\n-                              \"-gencert -rfc -alias ca1 -startdate -1M -infile user.req -outfile samedn1.certs\");\n+                              \"-gencert -rfc -alias \" + ca1Alias + \" \" +\n+                              \"-startdate -1M -infile \" + userReqFile + \" -outfile samedn1.certs\");\n@@ -164,1 +193,2 @@\n-                              \"-gencert -rfc -alias ca2 -startdate -1M -infile user.req -outfile samedn2.certs\");\n+                              \"-gencert -rfc -alias \" + ca2Alias + \" \" +\n+                              \"-startdate -1M -infile \" + userReqFile + \" -outfile samedn2.certs\");\n@@ -166,15 +196,2 @@\n-        \/\/ 3. Append the ca file\n-        final Path samedn1CertPath = Paths.get(\"samedn1.certs\");\n-        final Path samedn2CertPath = Paths.get(\"samedn2.certs\");\n-\n-        final String outputCa1 = SecurityTools.keytool(ktBaseParameters +\n-                                                       \"-export -rfc -alias ca1\").getOutput();\n-        Files.write(samedn1CertPath, outputCa1.getBytes(), StandardOpenOption.APPEND);\n-\n-        final String outputCa2 = SecurityTools.keytool(ktBaseParameters +\n-                                                       \"-export -rfc -alias ca2\").getOutput();\n-        Files.write(samedn2CertPath, outputCa2.getBytes(), StandardOpenOption.APPEND);\n-\n-        \/\/ 4. Remove user for cacerts\n-        SecurityTools.keytool(ktBaseParameters +\n-                              \"-delete -alias user\");\n+        \/\/ 3. Remove user for cacerts\n+        keyStore.deleteEntry(userAlias);\n","filename":"test\/jdk\/sun\/security\/validator\/CertReplace.java","additions":69,"deletions":52,"binary":false,"changes":121,"status":"modified"}]}