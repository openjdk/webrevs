{"files":[{"patch":"@@ -473,0 +473,11 @@\n+  if (JvmtiExport::should_post_thread_life()) {\n+    JvmtiExport::post_thread_end(thread);\n+  }\n+\n+  \/\/ Always call even when there are not JVMTI environments yet, since environments\n+  \/\/ may be attached late and JVMTI must track phases of VM execution\n+  JvmtiExport::post_vm_death();\n+  JvmtiAgentList::unload_agents();\n+\n+  \/\/ No user code can be executed in the current thread after this point.\n+\n@@ -479,1 +490,1 @@\n-  \/\/ Run before exit and then stop concurrent GC threads\n+  \/\/ Run before exit and then stop concurrent GC threads.\n@@ -495,9 +506,0 @@\n-  if (JvmtiExport::should_post_thread_life()) {\n-    JvmtiExport::post_thread_end(thread);\n-  }\n-\n-  \/\/ Always call even when there are not JVMTI environments yet, since environments\n-  \/\/ may be attached late and JVMTI must track phases of VM execution\n-  JvmtiExport::post_vm_death();\n-  JvmtiAgentList::unload_agents();\n-\n","filename":"src\/hotspot\/share\/runtime\/java.cpp","additions":12,"deletions":10,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -0,0 +1,81 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/*\n+ * @test\n+ * @summary Test verifies that VM still can execute java code, allocate\n+ *          memory, and call GC in the VMDeath event callback.\n+ *\n+ * @bug 8367902\n+ * @requires vm.jvmti\n+ * @library \/test\/lib\n+ * @build jdk.test.whitebox.WhiteBox\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller jdk.test.whitebox.WhiteBox\n+ * @run main\/othervm\/native TestAllocatingInVMDeath\n+ *\/\n+import java.time.LocalDateTime;\n+import java.time.format.DateTimeFormatter;\n+\n+import jdk.test.lib.Asserts;\n+import jdk.test.lib.process.OutputAnalyzer;\n+import jdk.test.lib.process.ProcessTools;\n+import jdk.test.whitebox.WhiteBox;\n+\n+public class TestAllocatingInVMDeath {\n+    public static String UPCALL_MARKER = \"Hello from upCall. \";\n+\n+    public static void main(String[] args) throws Exception {\n+    ProcessBuilder pb = ProcessTools.createTestJavaProcessBuilder(\n+                \"-agentlib:TestAllocatingInVMDeath\",\n+                \"--enable-native-access=ALL-UNNAMED\",\n+                \"-Xbootclasspath\/a:.\",\n+                \"-XX:+UnlockDiagnosticVMOptions\",\n+                \"-XX:+WhiteBoxAPI\",\n+                \"DoWork\");\n+\n+        OutputAnalyzer oa = new OutputAnalyzer(pb.start());\n+        String output = oa.getOutput();\n+        System.err.println(\"DoWork output:\");\n+        System.err.println(output);\n+        Asserts.assertTrue(oa.getExitValue() == 0);\n+        Asserts.assertTrue(output.contains(UPCALL_MARKER));\n+    }\n+}\n+\n+class DoWork {\n+    static final WhiteBox WHITE_BOX = WhiteBox.getWhiteBox();\n+\n+    \/\/ This method is called from VMDeath event callback.\n+    static void upCall() {\n+        \/\/ Do some work including memory allocation, so it can't be optimized by compiler.\n+        LocalDateTime now = LocalDateTime.now();\n+        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSS\");\n+        String result = TestAllocatingInVMDeath.UPCALL_MARKER + now.format(formatter);\n+        WHITE_BOX.fullGC();\n+        System.out.println(result);\n+    }\n+\n+    public static void main(String argv[]) throws Exception {\n+        System.out.println(\"Hello from DoWork main().\");\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/events\/VMDeath\/AllocatingInVMDeath\/TestAllocatingInVMDeath.java","additions":81,"deletions":0,"binary":false,"changes":81,"status":"added"},{"patch":"@@ -0,0 +1,59 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+#include \"jvmti.h\"\n+#include \"jni.h\"\n+#include \"jvmti_common.hpp\"\n+\n+static void JNICALL\n+cbVMDeath(jvmtiEnv* jvmti, JNIEnv* jni) {\n+  jclass clz = jni->FindClass(\"DoWork\");\n+  if (clz == nullptr) {\n+    fatal(jni, \"Can't find DoWork class.\");\n+    return;\n+  }\n+  jmethodID mid = jni->GetStaticMethodID(clz, \"upCall\", \"()V\");\n+  if (mid == nullptr) {\n+    fatal(jni, \"Can't find upCall method.\");\n+  }\n+  jni->CallStaticObjectMethod(clz, mid);\n+}\n+\n+JNIEXPORT jint JNICALL\n+Agent_OnLoad(JavaVM *vm, char *options, void *reserved) {\n+  jvmtiEnv *jvmti = nullptr;\n+  jint res = vm->GetEnv((void **) &jvmti, JVMTI_VERSION_21);\n+  if (res != JNI_OK) {\n+    return JNI_ERR;\n+  }\n+  jvmtiError err = JVMTI_ERROR_NONE;\n+\n+  jvmtiEventCallbacks callbacks;\n+  (void) memset(&callbacks, 0, sizeof (callbacks));\n+  callbacks.VMDeath = &cbVMDeath;\n+  err = jvmti->SetEventCallbacks(&callbacks, (int) sizeof (jvmtiEventCallbacks));\n+  check_jvmti_error(err, \"SetEventCallbacks\");\n+  err = jvmti->SetEventNotificationMode(JVMTI_ENABLE, JVMTI_EVENT_VM_DEATH, nullptr);\n+  check_jvmti_error(err, \"SetEventNotificationMode\");\n+  return JNI_OK;\n+}\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/events\/VMDeath\/AllocatingInVMDeath\/libTestAllocatingInVMDeath.cpp","additions":59,"deletions":0,"binary":false,"changes":59,"status":"added"}]}