{"files":[{"patch":"@@ -81,0 +81,1 @@\n+#include \"utilities\/tuple.hpp\"\n@@ -179,1 +180,2 @@\n-\n+long os::Linux::kernel_version_major = -1;\n+long os::Linux::kernel_version_minor = -1;\n@@ -2969,0 +2971,9 @@\n+\/\/ Define MADV_POPULATE_READ here so we can build HotSpot on old systems.\n+#define MADV_POPULATE_READ_value 22\n+#ifndef MADV_POPULATE_READ\n+  #define MADV_POPULATE_READ MADV_POPULATE_READ_value\n+#else\n+  \/\/ Sanity-check our assumed default value if we build with a new enough libc.\n+  STATIC_ASSERT(MADV_POPULATE_READ == MADV_POPULATE_READ_value);\n+#endif\n+\n@@ -2978,0 +2989,18 @@\n+\/\/ Define MADV_DONTNEED_LOCKED here so we can build HotSpot on old systems.\n+#define MADV_DONTNEED_LOCKED_value 24\n+#ifndef MADV_DONTNEED_LOCKED\n+  #define MADV_DONTNEED_LOCKED MADV_DONTNEED_LOCKED_value\n+#else\n+  \/\/ Sanity-check our assumed default value if we build with a new enough libc.\n+  STATIC_ASSERT(MADV_DONTNEED_LOCKED == MADV_DONTNEED_LOCKED_value);\n+#endif\n+\n+\/\/ Define MADV_COLLAPSE here so we can build HotSpot on old systems.\n+#define MADV_COLLAPSE_value 25\n+#ifndef MADV_COLLAPSE\n+  #define MADV_COLLAPSE MADV_COLLAPSE_value\n+#else\n+  \/\/ Sanity-check our assumed default value if we build with a new enough libc.\n+  STATIC_ASSERT(MADV_COLLAPSE == MADV_COLLAPSE_value);\n+#endif\n+\n@@ -2988,0 +3017,21 @@\n+\/\/ Guard newer madv numbers by checking kernel versions, as downstream kernels\n+\/\/ might use the numbers as unexpected behaviors.\n+bool os::Linux::can_use_madvise_flag(int advice) {\n+  static constexpr Tuple<int, long, long> adviceVersions[] = {\n+    { MADV_POPULATE_READ,   5, 14 },\n+    { MADV_POPULATE_WRITE,  5, 14 },\n+    { MADV_DONTNEED_LOCKED, 5, 18 },\n+    { MADV_COLLAPSE,        6,  1 }\n+  };\n+\n+  for (auto &t : adviceVersions) {\n+    if (advice == t.get<0>()) {\n+      return kernel_version_major > t.get<1>() ||\n+        (kernel_version_major == t.get<1>() &&\n+         kernel_version_minor >= t.get<2>());\n+    }\n+  }\n+\n+  return true;\n+}\n+\n@@ -4525,0 +4575,2 @@\n+  Linux::kernel_version(&Linux::kernel_version_major, &Linux::kernel_version_minor);\n+\n@@ -4806,2 +4858,0 @@\n-    long major, minor;\n-    Linux::kernel_version(&major, &minor);\n@@ -4809,1 +4859,1 @@\n-      ((major > 5 || (major == 5 && minor >= 14)) &&\n+      (Linux::can_use_madvise_flag(MADV_POPULATE_WRITE) &&\n@@ -4816,1 +4866,1 @@\n-      UseMadvPopulateWrite = false;\n+      FLAG_SET_ERGO(UseMadvPopulateWrite, false);\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":55,"deletions":5,"binary":false,"changes":60,"status":"modified"},{"patch":"@@ -46,0 +46,3 @@\n+  static long kernel_version_major;\n+  static long kernel_version_minor;\n+\n@@ -196,0 +199,2 @@\n+  static bool can_use_madvise_flag(int advice);\n+\n","filename":"src\/hotspot\/os\/linux\/os_linux.hpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"}]}