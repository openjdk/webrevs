{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2006, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2006, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -43,1 +43,1 @@\n-    static boolean error = false;\n+    static boolean handlerIsDaemon = false;\n@@ -45,9 +45,1 @@\n-    public static void read (InputStream i) throws IOException {\n-        while (i.read() != -1);\n-        i.close();\n-    }\n-\n-    \/**\n-     * @param args\n-     *\/\n-    public static void main(String[] args) {\n+    public static void main(String[] args) throws IOException {\n@@ -56,3 +48,4 @@\n-                InputStream is = t.getRequestBody();\n-                read(is);\n-                \/\/ .. read the request body\n+                try (InputStream is = t.getRequestBody();\n+                     OutputStream os = t.getResponseBody()) {\n+                    is.readAllBytes();\n+                    \/\/ .. read the request body\n@@ -60,5 +53,5 @@\n-                t.sendResponseHeaders(200, response.length());\n-                OutputStream os = t.getResponseBody();\n-                os.write(response.getBytes());\n-                os.close();\n-                error = Thread.currentThread().isDaemon();\n+                    t.sendResponseHeaders(200, response.length());\n+                    os.write(response.getBytes());\n+                    os.close();\n+                    handlerIsDaemon = Thread.currentThread().isDaemon();\n+                }\n@@ -68,2 +61,2 @@\n-\n-        HttpServer server;\n+        InetAddress loopback = InetAddress.getLoopbackAddress();\n+        HttpServer server = HttpServer.create(new InetSocketAddress(loopback, 0), 10);\n@@ -71,3 +64,0 @@\n-            InetAddress loopback = InetAddress.getLoopbackAddress();\n-            server = HttpServer.create(new InetSocketAddress(loopback, 0), 10);\n-\n@@ -77,1 +67,1 @@\n-                server.start();\n+            server.start();\n@@ -79,1 +69,0 @@\n-            String s = \"http:\/\/localhost:\"+port+\"\/apps\/foo\";\n@@ -81,5 +70,5 @@\n-                      .scheme(\"http\")\n-                      .loopback()\n-                      .port(port)\n-                      .path(\"\/apps\/foo\")\n-                      .toURL();\n+                    .scheme(\"http\")\n+                    .loopback()\n+                    .port(port)\n+                    .path(\"\/apps\/foo\")\n+                    .toURL();\n@@ -87,4 +76,4 @@\n-            read (is);\n-            server.stop(0);\n-            if (error) {\n-                throw new RuntimeException (\"error in test\");\n+            is.readAllBytes();\n+            is.close();\n+            if (handlerIsDaemon) {\n+                throw new RuntimeException(\"request was handled by a daemon thread\");\n@@ -92,3 +81,1 @@\n-\n-        }\n-        catch (Exception e) {\n+        } catch (Exception e) {\n@@ -96,0 +83,2 @@\n+        } finally {\n+            server.stop(0);\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/bugs\/B6431193.java","additions":27,"deletions":38,"binary":false,"changes":65,"status":"modified"}]}