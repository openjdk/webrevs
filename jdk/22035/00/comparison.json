{"files":[{"patch":"@@ -50,1 +50,0 @@\n-import java.security.AccessControlContext;\n@@ -2137,3 +2136,0 @@\n-            public Thread newThreadWithAcc(Runnable target, @SuppressWarnings(\"removal\") AccessControlContext acc) {\n-                return new Thread(target, acc);\n-            }\n","filename":"src\/java.base\/share\/classes\/java\/lang\/System.java","additions":0,"deletions":4,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -30,3 +30,0 @@\n-import java.security.AccessController;\n-import java.security.AccessControlContext;\n-import java.security.PrivilegedAction;\n@@ -44,2 +41,0 @@\n-import jdk.internal.reflect.CallerSensitive;\n-import jdk.internal.reflect.Reflection;\n@@ -55,1 +50,0 @@\n-import sun.security.util.SecurityConstants;\n@@ -650,15 +644,0 @@\n-    \/**\n-     * Returns the context class loader to inherit from the parent thread.\n-     * See Thread initialization.\n-     *\/\n-    private static ClassLoader contextClassLoader(Thread parent) {\n-        @SuppressWarnings(\"removal\")\n-        SecurityManager sm = System.getSecurityManager();\n-        if (sm == null || isCCLOverridden(parent.getClass())) {\n-            return parent.getContextClassLoader();\n-        } else {\n-            \/\/ skip call to getContextClassLoader\n-            return parent.contextClassLoader;\n-        }\n-    }\n-\n@@ -674,1 +653,0 @@\n-     * @param acc ignored\n@@ -676,3 +654,1 @@\n-    @SuppressWarnings(\"removal\")\n-    Thread(ThreadGroup g, String name, int characteristics, Runnable task,\n-           long stackSize, AccessControlContext acc) {\n+    Thread(ThreadGroup g, String name, int characteristics, Runnable task, long stackSize) {\n@@ -689,1 +665,0 @@\n-            SecurityManager sm = System.getSecurityManager();\n@@ -691,5 +666,0 @@\n-                \/\/ the security manager can choose the thread group\n-                if (sm != null) {\n-                    g = sm.getThreadGroup();\n-                }\n-\n@@ -697,3 +667,1 @@\n-                if (g == null) {\n-                    g = parent.getThreadGroup();\n-                }\n+                g = parent.getThreadGroup();\n@@ -701,9 +669,0 @@\n-\n-            \/\/ permission checks when creating a child Thread\n-            if (sm != null) {\n-                sm.checkAccess(g);\n-                if (isCCLOverridden(getClass())) {\n-                    sm.checkPermission(SecurityConstants.SUBCLASS_IMPLEMENTATION_PERMISSION);\n-                }\n-            }\n-\n@@ -729,1 +688,1 @@\n-                    this.contextClassLoader = contextClassLoader(parent);\n+                    this.contextClassLoader = parent.getContextClassLoader();\n@@ -760,1 +719,1 @@\n-            this.contextClassLoader = contextClassLoader(parent);\n+            this.contextClassLoader = parent.getContextClassLoader();\n@@ -1102,1 +1061,1 @@\n-        this(null, null, 0, null, 0, null);\n+        this(null, null, 0, null, 0);\n@@ -1123,10 +1082,1 @@\n-        this(null, null, 0, task, 0, null);\n-    }\n-\n-    \/**\n-     * Creates a new Thread that inherits the given AccessControlContext\n-     * but thread-local variables are not inherited.\n-     * This is not a public constructor.\n-     *\/\n-    Thread(Runnable task, @SuppressWarnings(\"removal\") AccessControlContext acc) {\n-        this(null, null, 0, task, 0, acc);\n+        this(null, null, 0, task, 0);\n@@ -1157,1 +1107,1 @@\n-        this(group, null, 0, task, 0, null);\n+        this(group, null, 0, task, 0);\n@@ -1174,1 +1124,1 @@\n-        this(null, checkName(name), 0, null, 0, null);\n+        this(null, checkName(name), 0, null, 0);\n@@ -1195,1 +1145,1 @@\n-        this(group, checkName(name), 0, null, 0, null);\n+        this(group, checkName(name), 0, null, 0);\n@@ -1217,1 +1167,1 @@\n-        this(null, checkName(name), 0, task, 0, null);\n+        this(null, checkName(name), 0, task, 0);\n@@ -1253,1 +1203,1 @@\n-        this(group, checkName(name), 0, task, 0, null);\n+        this(group, checkName(name), 0, task, 0);\n@@ -1327,1 +1277,1 @@\n-        this(group, checkName(name), 0, task, stackSize, null);\n+        this(group, checkName(name), 0, task, stackSize);\n@@ -1387,1 +1337,1 @@\n-                task, stackSize, null);\n+                task, stackSize);\n@@ -2137,1 +2087,0 @@\n-    @CallerSensitive\n@@ -2139,10 +2088,1 @@\n-        ClassLoader cl = this.contextClassLoader;\n-        if (cl == null)\n-            return null;\n-        @SuppressWarnings(\"removal\")\n-        SecurityManager sm = System.getSecurityManager();\n-        if (sm != null) {\n-            Class<?> caller = Reflection.getCallerClass();\n-            ClassLoader.checkClassLoaderPermission(cl, caller);\n-        }\n-        return cl;\n+        return contextClassLoader;\n@@ -2164,5 +2104,0 @@\n-        @SuppressWarnings(\"removal\")\n-        SecurityManager sm = System.getSecurityManager();\n-        if (sm != null) {\n-            sm.checkPermission(new RuntimePermission(\"setContextClassLoader\"));\n-        }\n@@ -2217,6 +2152,0 @@\n-            \/\/ check for getStackTrace permission\n-            @SuppressWarnings(\"removal\")\n-            SecurityManager security = System.getSecurityManager();\n-            if (security != null) {\n-                security.checkPermission(SecurityConstants.GET_STACK_TRACE_PERMISSION);\n-            }\n@@ -2282,8 +2211,0 @@\n-        \/\/ check for getStackTrace permission\n-        @SuppressWarnings(\"removal\")\n-        SecurityManager security = System.getSecurityManager();\n-        if (security != null) {\n-            security.checkPermission(SecurityConstants.GET_STACK_TRACE_PERMISSION);\n-            security.checkPermission(SecurityConstants.MODIFY_THREADGROUP_PERMISSION);\n-        }\n-\n@@ -2304,58 +2225,0 @@\n-    \/** cache of subclass security audit results *\/\n-    private static class Caches {\n-        \/** cache of subclass security audit results *\/\n-        static final ClassValue<Boolean> subclassAudits =\n-            new ClassValue<>() {\n-                @Override\n-                protected Boolean computeValue(Class<?> type) {\n-                    return auditSubclass(type);\n-                }\n-            };\n-    }\n-\n-    \/**\n-     * Verifies that this (possibly subclass) instance can be constructed\n-     * without violating security constraints: the subclass must not override\n-     * security-sensitive non-final methods, or else the\n-     * \"enableContextClassLoaderOverride\" RuntimePermission is checked.\n-     *\/\n-    private static boolean isCCLOverridden(Class<?> cl) {\n-        if (cl == Thread.class)\n-            return false;\n-\n-        return Caches.subclassAudits.get(cl);\n-    }\n-\n-    \/**\n-     * Performs reflective checks on given subclass to verify that it doesn't\n-     * override security-sensitive non-final methods.  Returns true if the\n-     * subclass overrides any of the methods, false otherwise.\n-     *\/\n-    private static boolean auditSubclass(final Class<?> subcl) {\n-        @SuppressWarnings(\"removal\")\n-        Boolean result = AccessController.doPrivileged(\n-            new PrivilegedAction<>() {\n-                public Boolean run() {\n-                    for (Class<?> cl = subcl;\n-                         cl != Thread.class;\n-                         cl = cl.getSuperclass())\n-                    {\n-                        try {\n-                            cl.getDeclaredMethod(\"getContextClassLoader\", new Class<?>[0]);\n-                            return Boolean.TRUE;\n-                        } catch (NoSuchMethodException ex) {\n-                        }\n-                        try {\n-                            Class<?>[] params = {ClassLoader.class};\n-                            cl.getDeclaredMethod(\"setContextClassLoader\", params);\n-                            return Boolean.TRUE;\n-                        } catch (NoSuchMethodException ex) {\n-                        }\n-                    }\n-                    return Boolean.FALSE;\n-                }\n-            }\n-        );\n-        return result.booleanValue();\n-    }\n-\n@@ -2600,6 +2463,0 @@\n-        @SuppressWarnings(\"removal\")\n-        SecurityManager sm = System.getSecurityManager();\n-        if (sm != null) {\n-            sm.checkPermission(\n-                new RuntimePermission(\"setDefaultUncaughtExceptionHandler\"));\n-        }\n@@ -2672,1 +2529,0 @@\n-    @SuppressWarnings(\"removal\")\n","filename":"src\/java.base\/share\/classes\/java\/lang\/Thread.java","additions":14,"deletions":158,"binary":false,"changes":172,"status":"modified"},{"patch":"@@ -182,1 +182,1 @@\n-            var thread = new Thread(group, name, characteristics(), task, stackSize, null);\n+            var thread = new Thread(group, name, characteristics(), task, stackSize);\n@@ -356,1 +356,1 @@\n-            Thread thread = new Thread(group, name, characteristics(), task, stackSize, null);\n+            Thread thread = new Thread(group, name, characteristics(), task, stackSize);\n","filename":"src\/java.base\/share\/classes\/java\/lang\/ThreadBuilders.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -27,2 +27,0 @@\n-import java.security.AccessController;\n-import java.security.PrivilegedAction;\n@@ -62,1 +60,0 @@\n-import sun.security.action.GetPropertyAction;\n@@ -896,1 +893,0 @@\n-    @SuppressWarnings(\"removal\")\n@@ -1264,1 +1260,0 @@\n-    @SuppressWarnings(\"removal\")\n@@ -1266,31 +1261,25 @@\n-        ForkJoinWorkerThreadFactory factory = pool -> {\n-            PrivilegedAction<ForkJoinWorkerThread> pa = () -> new CarrierThread(pool);\n-            return AccessController.doPrivileged(pa);\n-        };\n-        PrivilegedAction<ForkJoinPool> pa = () -> {\n-            int parallelism, maxPoolSize, minRunnable;\n-            String parallelismValue = System.getProperty(\"jdk.virtualThreadScheduler.parallelism\");\n-            String maxPoolSizeValue = System.getProperty(\"jdk.virtualThreadScheduler.maxPoolSize\");\n-            String minRunnableValue = System.getProperty(\"jdk.virtualThreadScheduler.minRunnable\");\n-            if (parallelismValue != null) {\n-                parallelism = Integer.parseInt(parallelismValue);\n-            } else {\n-                parallelism = Runtime.getRuntime().availableProcessors();\n-            }\n-            if (maxPoolSizeValue != null) {\n-                maxPoolSize = Integer.parseInt(maxPoolSizeValue);\n-                parallelism = Integer.min(parallelism, maxPoolSize);\n-            } else {\n-                maxPoolSize = Integer.max(parallelism, 256);\n-            }\n-            if (minRunnableValue != null) {\n-                minRunnable = Integer.parseInt(minRunnableValue);\n-            } else {\n-                minRunnable = Integer.max(parallelism \/ 2, 1);\n-            }\n-            Thread.UncaughtExceptionHandler handler = (t, e) -> { };\n-            boolean asyncMode = true; \/\/ FIFO\n-            return new ForkJoinPool(parallelism, factory, handler, asyncMode,\n-                         0, maxPoolSize, minRunnable, pool -> true, 30, SECONDS);\n-        };\n-        return AccessController.doPrivileged(pa);\n+        ForkJoinWorkerThreadFactory factory = pool -> new CarrierThread(pool);\n+        int parallelism, maxPoolSize, minRunnable;\n+        String parallelismValue = System.getProperty(\"jdk.virtualThreadScheduler.parallelism\");\n+        String maxPoolSizeValue = System.getProperty(\"jdk.virtualThreadScheduler.maxPoolSize\");\n+        String minRunnableValue = System.getProperty(\"jdk.virtualThreadScheduler.minRunnable\");\n+        if (parallelismValue != null) {\n+            parallelism = Integer.parseInt(parallelismValue);\n+        } else {\n+            parallelism = Runtime.getRuntime().availableProcessors();\n+        }\n+        if (maxPoolSizeValue != null) {\n+            maxPoolSize = Integer.parseInt(maxPoolSizeValue);\n+            parallelism = Integer.min(parallelism, maxPoolSize);\n+        } else {\n+            maxPoolSize = Integer.max(parallelism, 256);\n+        }\n+        if (minRunnableValue != null) {\n+            minRunnable = Integer.parseInt(minRunnableValue);\n+        } else {\n+            minRunnable = Integer.max(parallelism \/ 2, 1);\n+        }\n+        Thread.UncaughtExceptionHandler handler = (t, e) -> { };\n+        boolean asyncMode = true; \/\/ FIFO\n+        return new ForkJoinPool(parallelism, factory, handler, asyncMode,\n+                     0, maxPoolSize, minRunnable, pool -> true, 30, SECONDS);\n@@ -1313,1 +1302,1 @@\n-        String propValue = GetPropertyAction.privilegedGetProperty(propName);\n+        String propValue = System.getProperty(propName);\n@@ -1344,1 +1333,1 @@\n-        String propValue = GetPropertyAction.privilegedGetProperty(\"jdk.tracePinnedThreads\");\n+        String propValue = System.getProperty(\"jdk.tracePinnedThreads\");\n","filename":"src\/java.base\/share\/classes\/java\/lang\/VirtualThread.java","additions":27,"deletions":38,"binary":false,"changes":65,"status":"modified"},{"patch":"@@ -147,6 +147,0 @@\n-    \/**\n-     * Returns a new Thread with the given Runnable and an\n-     * inherited AccessControlContext.\n-     *\/\n-    Thread newThreadWithAcc(Runnable target, @SuppressWarnings(\"removal\") AccessControlContext acc);\n-\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/access\/JavaLangAccess.java","additions":0,"deletions":6,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -28,2 +28,0 @@\n-import java.security.AccessController;\n-import java.security.PrivilegedAction;\n@@ -117,1 +115,0 @@\n-    @SuppressWarnings(\"removal\")\n@@ -119,9 +116,5 @@\n-        return AccessController.doPrivileged(new PrivilegedAction<ThreadGroup>() {\n-            public ThreadGroup run() {\n-                ThreadGroup group = JLA.currentCarrierThread().getThreadGroup();\n-                for (ThreadGroup p; (p = group.getParent()) != null; )\n-                    group = p;\n-                var carrierThreadsGroup = new ThreadGroup(group, \"CarrierThreads\");\n-                return carrierThreadsGroup;\n-            }\n-        });\n+        ThreadGroup group = JLA.currentCarrierThread().getThreadGroup();\n+        for (ThreadGroup p; (p = group.getParent()) != null; )\n+            group = p;\n+        var carrierThreadsGroup = new ThreadGroup(group, \"CarrierThreads\");\n+        return carrierThreadsGroup;\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/misc\/CarrierThread.java","additions":5,"deletions":12,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -28,4 +28,0 @@\n-import java.security.AccessControlContext;\n-import java.security.AccessController;\n-import java.security.ProtectionDomain;\n-import java.security.PrivilegedAction;\n@@ -72,12 +68,2 @@\n-        if (System.getSecurityManager() == null) {\n-            return createThread(name, target, 0L,\n-                    ClassLoader.getSystemClassLoader(), priority);\n-        }\n-        return AccessController.doPrivileged(\n-                new PrivilegedAction<Thread>() {\n-                    @Override\n-                    public Thread run() {\n-                        return createThread(name, target, 0L,\n-                                ClassLoader.getSystemClassLoader(), priority);\n-                    }\n-                });\n+        return createThread(name, target, 0L,\n+                ClassLoader.getSystemClassLoader(), priority);\n@@ -106,11 +92,1 @@\n-        if (System.getSecurityManager() == null) {\n-            return createThread(name, target, 0L, null, priority);\n-        }\n-        return AccessController.doPrivileged(\n-                new PrivilegedAction<Thread>() {\n-                    @Override\n-                    public Thread run() {\n-                        return createThread(name, target, 0L,\n-                                null, priority);\n-                    }\n-                });\n+        return createThread(name, target, 0L, null, priority);\n@@ -125,11 +101,1 @@\n-        if (System.getSecurityManager() == null) {\n-            return createThread(name, target, stackSize, null, priority);\n-        }\n-        return AccessController.doPrivileged(\n-                new PrivilegedAction<Thread>() {\n-                    @Override\n-                    public Thread run() {\n-                        return createThread(name, target, 0L,\n-                                null, priority);\n-                    }\n-                });\n+        return createThread(name, target, stackSize, null, priority);\n@@ -210,12 +176,1 @@\n-            final ThreadGroup root = group;\n-            if (System.getSecurityManager() == null) {\n-                INNOCUOUSTHREADGROUP = new ThreadGroup(root, \"InnocuousThreadGroup\");\n-            } else {\n-                INNOCUOUSTHREADGROUP = AccessController.doPrivileged(\n-                    new PrivilegedAction<ThreadGroup>() {\n-                        @Override\n-                        public ThreadGroup run() {\n-                            return new ThreadGroup(root, \"InnocuousThreadGroup\");\n-                        }\n-                    });\n-            }\n+            INNOCUOUSTHREADGROUP = new ThreadGroup(group, \"InnocuousThreadGroup\");\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/misc\/InnocuousThread.java","additions":5,"deletions":50,"binary":false,"changes":55,"status":"modified"},{"patch":"@@ -168,1 +168,0 @@\n-        java.naming,\n","filename":"src\/java.base\/share\/classes\/module-info.java","additions":0,"deletions":1,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,2 +28,0 @@\n-import jdk.internal.access.SharedSecrets;\n-\n@@ -112,1 +110,0 @@\n-    @SuppressWarnings(\"removal\")\n@@ -114,6 +111,1 @@\n-        AccessControlContext acc = AccessController.getContext();\n-        \/\/ 4290486: doPrivileged is needed to create a thread in\n-        \/\/ an environment that restricts \"modifyThreadGroup\".\n-        PrivilegedAction<Thread> act =\n-                () -> SharedSecrets.getJavaLangAccess().newThreadWithAcc(r, acc);\n-        return AccessController.doPrivileged(act);\n+        return new Thread(r);\n","filename":"src\/java.naming\/share\/classes\/com\/sun\/jndi\/ldap\/VersionHelper.java","additions":2,"deletions":10,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -76,1 +76,0 @@\n-               \"java\/lang\/Thread#getContextClassLoader ()Ljava\/lang\/ClassLoader;\",\n@@ -84,1 +83,0 @@\n-               \"java\/lang\/Thread#getContextClassLoader (Ljava\/lang\/Class;)Ljava\/lang\/ClassLoader;\",\n","filename":"test\/jdk\/jdk\/internal\/reflect\/CallerSensitive\/CheckCSMs.java","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"}]}