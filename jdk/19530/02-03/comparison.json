{"files":[{"patch":"@@ -161,0 +161,7 @@\n+#ifdef LINUX\n+class Whitebox_Linux : public os::Linux {\n+ public:\n+  static int host_cpus() { return os::Linux::active_processor_count(); }\n+};\n+#endif\n+\n@@ -2491,0 +2498,6 @@\n+\/\/ Physical cpus of the host machine (including containers), Linux only.\n+WB_ENTRY(jint, WB_HostCPUs(JNIEnv* env, jobject o))\n+  LINUX_ONLY(return Whitebox_Linux::host_cpus();)\n+  return -1; \/\/ Not used\/implemented on other platforms\n+WB_END\n+\n@@ -2932,0 +2945,1 @@\n+  {CC\"hostCPUs\",                  CC\"()I\",            (void*)&WB_HostCPUs },\n","filename":"src\/hotspot\/share\/prims\/whitebox.cpp","additions":14,"deletions":0,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -30,2 +30,3 @@\n- * @build HelloSystemd\n- * @run driver SystemdMemoryAwarenessTest\n+ * @build HelloSystemd jdk.test.whitebox.WhiteBox\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller -jar whitebox.jar jdk.test.whitebox.WhiteBox\n+ * @run main\/othervm -Xbootclasspath\/a:whitebox.jar -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI SystemdMemoryAwarenessTest\n@@ -35,0 +36,1 @@\n+import jdk.test.whitebox.WhiteBox;\n@@ -42,0 +44,2 @@\n+    private static final WhiteBox wb = WhiteBox.getWhiteBox();\n+\n@@ -48,2 +52,10 @@\n-        \/\/ 1 GB memory and 2 cores CPU\n-        opts.memoryLimit(\"1000M\").cpuLimit(\"200%\");\n+        \/\/ 1 GB memory\n+        opts.memoryLimit(\"1000M\");\n+        int physicalCpus = wb.hostCPUs();\n+        if (physicalCpus < 3) {\n+           System.err.println(\"WARNING: host system only has \" + physicalCpus + \" expected >= 3\");\n+        }\n+        \/\/ 1 or 2 cores limit depending on physical CPUs\n+        int coreLimit = Math.min(physicalCpus, 2);\n+        System.out.println(\"DEBUG: Running test with a CPU limit of \" + coreLimit);\n+        opts.cpuLimit(String.format(\"%d%%\", coreLimit * 100));\n@@ -58,1 +70,1 @@\n-                .shouldContain(\"OSContainer::active_processor_count: 2\")\n+                .shouldContain(\"OSContainer::active_processor_count: \" + coreLimit)\n","filename":"test\/hotspot\/jtreg\/containers\/systemd\/SystemdMemoryAwarenessTest.java","additions":17,"deletions":5,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -767,0 +767,1 @@\n+  public native int hostCPUs();\n","filename":"test\/lib\/jdk\/test\/whitebox\/WhiteBox.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}