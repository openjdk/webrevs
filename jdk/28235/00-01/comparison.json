{"files":[{"patch":"@@ -51,4 +51,0 @@\n-    \/\/ The maximum alignment supported by malloc - typically 16 bytes on\n-    \/\/ 64-bit platforms and 8 bytes on 32-bit platforms.\n-    private static final long MAX_MALLOC_ALIGN = Unsafe.ADDRESS_SIZE == 4 ? 8 : 16;\n-\n@@ -206,2 +202,3 @@\n-        if (byteAlignment >= MAX_MALLOC_ALIGN) {\n-            allocationSize = alignedSize + byteAlignment - MAX_MALLOC_ALIGN;\n+        long defaultAlignment = alignmentForSize(alignedSize);\n+        if (byteAlignment > defaultAlignment) {\n+            allocationSize = alignedSize + byteAlignment - defaultAlignment;\n@@ -253,0 +250,10 @@\n+    private static final boolean IS_FREEBSD = System.getProperty(\"os.name\").equals(\"FreeBSD\");\n+\n+    private static long alignmentForSize(long size) {\n+        if (IS_FREEBSD && size <= Double.BYTES) {\n+            return Double.BYTES;\n+        } else {\n+            return Unsafe.ADDRESS_SIZE == 4 ? 8 : 16;\n+        }\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/foreign\/SegmentFactories.java","additions":13,"deletions":6,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -63,1 +63,1 @@\n-            MemorySegment segment = arena.allocate(aligned);;\n+            MemorySegment segment = arena.allocate(aligned);\n@@ -65,0 +65,6 @@\n+\n+            \/\/ Allocate another segment and fill it with data to\n+            \/\/ check that the first segment is not overwritten\n+            MemorySegment nextSegment = arena.allocate(aligned);\n+            vh.set(nextSegment, 0L, 0xffffff);\n+\n","filename":"test\/jdk\/java\/foreign\/TestMemoryAlignment.java","additions":7,"deletions":1,"binary":false,"changes":8,"status":"modified"}]}