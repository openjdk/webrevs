{"files":[{"patch":"@@ -413,9 +413,17 @@\n-  if (FLAG_IS_DEFAULT(AOTCache) &&\n-      FLAG_IS_DEFAULT(AOTMode)) {\n-    bool has_cache_output = !FLAG_IS_DEFAULT(AOTCacheOutput);\n-    bool has_config = !FLAG_IS_DEFAULT(AOTConfiguration);\n-    if (!has_cache_output && !has_config) {\n-      \/\/ AOT flags are not used. Use classic CDS workflow\n-      return;\n-    } else if (has_cache_output) {\n-      \/\/ If AOTCacheOutput has been set, default mode is \"record\".\n+  bool has_cache = !FLAG_IS_DEFAULT(AOTCache);\n+  bool has_cache_output = !FLAG_IS_DEFAULT(AOTCacheOutput);\n+  bool has_config = !FLAG_IS_DEFAULT(AOTConfiguration);\n+  bool has_mode = !FLAG_IS_DEFAULT(AOTMode);\n+\n+  if (!has_cache && !has_cache_output && !has_config && !has_mode) {\n+    \/\/ AOT flags are not used. Use classic CDS workflow\n+    return;\n+  }\n+\n+  if (has_cache && has_cache_output) {\n+    vm_exit_during_initialization(\"Only one of AOTCache or AOTCacheOutput can be specified\");\n+  }\n+\n+  if (!has_cache && (!has_mode || strcmp(AOTMode, \"auto\") == 0)) {\n+    if (has_cache_output) {\n+      \/\/ If AOTCacheOutput has been set, effective mode is \"record\".\n@@ -423,0 +431,1 @@\n+      log_info(cds)(\"Selected AOTMode=record because AOTCacheOutput is specified\");\n@@ -449,1 +458,2 @@\n-    vm_exit_during_initialization(\"AOTConfiguration can only be used with -XX:AOTMode=record or -XX:AOTMode=create\");\n+    vm_exit_during_initialization(err_msg(\"AOTConfiguration can only be used with when AOTMode is record or create (selected AOTMode = %s)\", \n+                                          FLAG_IS_DEFAULT(AOTMode) ? \"auto\" : AOTMode));\n@@ -532,0 +542,2 @@\n+  assert(!(has_cache && has_cache_output), \"already checked\");\n+\n@@ -534,2 +546,0 @@\n-  } else if (has_cache && has_cache_output) {\n-    vm_exit_during_initialization(\"Only one of AOTCache or AOTCacheOutput can be specified\");\n@@ -542,0 +552,1 @@\n+  \/\/ No need to check for (!has_cache_output), as we don't look at AOTCacheOutput after here.\n","filename":"src\/hotspot\/share\/cds\/cdsConfig.cpp","additions":23,"deletions":12,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -4053,0 +4053,2 @@\n+    This option cannot be used together with `-XX:AOTCacheOutput`.\n+\n@@ -4055,1 +4057,3 @@\n-    This option can be used only with `-XX:AOTMode=record` and `-XX:AOTMode=create`.\n+    This option cannot be used together with `-XX:AOTCache`.\n+\n+    When `-XX:AOTCacheOutput` is specified:\n@@ -4057,2 +4061,3 @@\n-    If `-XX:AOTCacheOutput` is specified but `-XX:AOTMode` is not specified,\n-    then `AOTMode` will be given the value of `record`.\n+    - If `-XX:AOTMode` is not specified, then `AOTMode` will be given the value of `record`.\n+    - If `-XX:AOTMode=auto` is specified, the JVM behaves if `-XX:AOTMode=record` were specified.\n+    - If `-XX:AOTMode=on` is specified, the JVM will exit with an error.\n@@ -4062,1 +4067,0 @@\n-    This option can be used only with `-XX:AOTMode=record` and `-XX:AOTMode=create`.\n@@ -4065,0 +4069,8 @@\n+    When `-XX:AOTConfiguration` can be used only if:\n+\n+    - `-XX:AOTMode=record` is specified, or\n+    - `-XX:AOTCacheOutput` is specified, and `-XX:AOTMode=auto` is specified, or\n+    - `-XX:AOTCacheOutput` is specified, and `-XX:AOTMode` is not specidied.\n+\n+    In all other cases, the JVM will exit with an error.\n+\n","filename":"src\/java.base\/share\/man\/java.md","additions":16,"deletions":4,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -186,1 +186,1 @@\n-        printTestCase(\"One step training run (JEP-JDK-8354330\");\n+        printTestCase(\"One step training run (JEP-514\");\n@@ -213,0 +213,13 @@\n+        \/\/ Set AOTCacheOutput\/AOTConfiguration\/AOTMode=auto; Ergo changes: AOTMode=record\n+        pb = ProcessTools.createLimitedTestJavaProcessBuilder(\n+            \"-XX:AOTMode=auto\",\n+            \"-XX:AOTCacheOutput=\" + aotCacheFile,\n+            \"-XX:AOTConfiguration=\" + aotConfigFile,\n+            \"-Xlog:cds=debug\",\n+            \"-cp\", appJar, helloClass);\n+        out = CDSTestUtils.executeAndLog(pb, \"ontstep-train\");\n+        out.shouldContain(\"Hello World\");\n+        out.shouldContain(\"AOTConfiguration recorded: \" + aotConfigFile);\n+        out.shouldContain(\"AOTCache creation is complete: hello.aot\");\n+        out.shouldHaveExitValue(0);\n+\n@@ -224,0 +237,12 @@\n+        \/\/ Set AOTCacheOutput\/AOTMode=auto only; Ergo for: AOTMode=record, AOTConfiguration=<temp>\n+        pb = ProcessTools.createLimitedTestJavaProcessBuilder(\n+            \"-XX:AOTMode=auto\",\n+            \"-XX:AOTCacheOutput=\" + aotCacheFile,\n+            \"-Xlog:cds=debug\",\n+            \"-cp\", appJar, helloClass);\n+        out = CDSTestUtils.executeAndLog(pb, \"ontstep-train\");\n+        out.shouldContain(\"Hello World\");\n+        out.shouldContain(\"Temporary AOTConfiguration recorded: \" + aotCacheFile + \".config\");\n+        out.shouldContain(\"AOTCache creation is complete: hello.aot\");\n+        out.shouldHaveExitValue(0);\n+\n@@ -262,1 +287,11 @@\n-        printTestCase(\"Use AOTConfiguration without AOTMode\");\n+        printTestCase(\"Use AOTConfiguration without AOTMode\/AOTCacheOutput\");\n+        pb = ProcessTools.createLimitedTestJavaProcessBuilder(\n+            \"-XX:AOTConfiguration=\" + aotConfigFile,\n+            \"-cp\", appJar, helloClass);\n+\n+        out = CDSTestUtils.executeAndLog(pb, \"neg\");\n+        out.shouldContain(\"AOTConfiguration can only be used with when AOTMode is record or create (selected AOTMode = auto)\");\n+        out.shouldNotHaveExitValue(0);\n+\n+        \/\/----------------------------------------------------------------------\n+        printTestCase(\"Use AOTConfiguration with AOTMode=on\");\n@@ -264,0 +299,1 @@\n+            \"-XX:AOTMode=on\",\n@@ -268,1 +304,1 @@\n-        out.shouldContain(\"AOTConfiguration can only be used with -XX:AOTMode=record or -XX:AOTMode=create\");\n+        out.shouldContain(\"AOTConfiguration can only be used with when AOTMode is record or create (selected AOTMode = on)\");\n","filename":"test\/hotspot\/jtreg\/runtime\/cds\/appcds\/aotFlags\/AOTFlags.java","additions":39,"deletions":3,"binary":false,"changes":42,"status":"modified"}]}