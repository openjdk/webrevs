{"files":[{"patch":"@@ -503,1 +503,0 @@\n-  Monitor timer(Mutex::nosafepoint, \"VM_ExitTimer_lock\");\n@@ -512,4 +511,16 @@\n-  \/\/ wait for user threads too. Numbers are in 10 milliseconds.\n-  int wait_time_per_attempt = 10;               \/\/ in milliseconds\n-  int max_wait_attempts_user_thread = UserThreadWaitAttemptsAtExit;\n-  int max_wait_attempts_compiler_thread = 1000; \/\/ at least 10 seconds\n+  \/\/ wait for user threads too.\n+\n+  \/\/ Time per attempt. It is practical to start waiting with 10us delays\n+  \/\/ (around scheduling delay \/ timer slack), and exponentially ramp up\n+  \/\/ to 10ms if compiler threads are not responding.\n+  jlong max_wait_time = millis_to_nanos(10);\n+  jlong wait_time = 10000;\n+\n+  jlong start_time = os::javaTimeNanos();\n+\n+  \/\/ Deadline for user threads in native code.\n+  \/\/ User-settable flag counts \"attempts\" in 10ms units.\n+  jlong user_threads_deadline = start_time + (UserThreadWaitAttemptsAtExit * millis_to_nanos(10));\n+\n+  \/\/ Deadline for compiler threads: at least 10 seconds.\n+  jlong compiler_threads_deadline = start_time + millis_to_nanos(10000);\n@@ -517,1 +528,0 @@\n-  int attempts = 0;\n@@ -546,0 +556,2 @@\n+    jlong time = os::javaTimeNanos();\n+\n@@ -547,6 +559,7 @@\n-       return 0;\n-    } else if (attempts >= max_wait_attempts_compiler_thread) {\n-       return num_active;\n-    } else if (num_active_compiler_thread == 0 &&\n-               attempts >= max_wait_attempts_user_thread) {\n-       return num_active;\n+      return 0;\n+    }\n+    if (time >= compiler_threads_deadline) {\n+      return num_active;\n+    }\n+    if ((num_active_compiler_thread == 0) && (time >= user_threads_deadline)) {\n+      return num_active;\n@@ -555,4 +568,2 @@\n-    attempts++;\n-\n-    MonitorLocker ml(&timer, Mutex::_no_safepoint_check_flag);\n-    ml.wait(wait_time_per_attempt);\n+    os::naked_short_nanosleep(wait_time);\n+    wait_time = MIN2(max_wait_time, wait_time * 2);\n","filename":"src\/hotspot\/share\/runtime\/vmOperations.cpp","additions":27,"deletions":16,"binary":false,"changes":43,"status":"modified"}]}