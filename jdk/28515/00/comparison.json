{"files":[{"patch":"@@ -98,1 +98,1 @@\n-  product(bool, UseSIMDForSHA3Intrinsic, true,                          \\\n+  product(bool, UseSIMDForSHA3Intrinsic, false,                         \\\n","filename":"src\/hotspot\/cpu\/aarch64\/globals_aarch64.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -11940,2 +11940,1 @@\n-    if (UseSHA3Intrinsics) {\n-\n+    if (UseSHA3Intrinsics && UseSIMDForSHA3Intrinsic) {\n@@ -11943,7 +11942,5 @@\n-      if (UseSIMDForSHA3Intrinsic) {\n-         StubRoutines::_sha3_implCompress     = generate_sha3_implCompress(StubId::stubgen_sha3_implCompress_id);\n-         StubRoutines::_sha3_implCompressMB   = generate_sha3_implCompress(StubId::stubgen_sha3_implCompressMB_id);\n-      } else {\n-         StubRoutines::_sha3_implCompress     = generate_sha3_implCompress_gpr(StubId::stubgen_sha3_implCompress_id);\n-         StubRoutines::_sha3_implCompressMB   = generate_sha3_implCompress_gpr(StubId::stubgen_sha3_implCompressMB_id);\n-      }\n+      StubRoutines::_sha3_implCompress     = generate_sha3_implCompress(StubId::stubgen_sha3_implCompress_id);\n+      StubRoutines::_sha3_implCompressMB   = generate_sha3_implCompress(StubId::stubgen_sha3_implCompressMB_id);\n+    } else if (UseSHA3Intrinsics) {\n+      StubRoutines::_sha3_implCompress     = generate_sha3_implCompress_gpr(StubId::stubgen_sha3_implCompress_id);\n+      StubRoutines::_sha3_implCompressMB   = generate_sha3_implCompress_gpr(StubId::stubgen_sha3_implCompressMB_id);\n","filename":"src\/hotspot\/cpu\/aarch64\/stubGenerator_aarch64.cpp","additions":6,"deletions":9,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -378,3 +378,14 @@\n-  if (UseSHA && VM_Version::supports_sha3()) {\n-    \/\/ Auto-enable UseSHA3Intrinsics on hardware with performance benefit.\n-    \/\/ Note that the evaluation of UseSHA3Intrinsics shows better performance\n+  if (UseSHA) {\n+    \/\/ No need to check VM_Version::supports_sha3(), since a fallback GPR intrinsic implementation is provided.\n+    if (FLAG_IS_DEFAULT(UseSHA3Intrinsics)) {\n+      FLAG_SET_DEFAULT(UseSHA3Intrinsics, true);\n+    }\n+  } else if (UseSHA3Intrinsics) {\n+    \/\/ Matches the documented and tested behavior: the -UseSHA option disables all SHA intrinsics.\n+    warning(\"UseSHA3Intrinsics requires that UseSHA is enabled.\");\n+    FLAG_SET_DEFAULT(UseSHA3Intrinsics, false);\n+  }\n+\n+  if (UseSHA3Intrinsics && VM_Version::supports_sha3()) {\n+    \/\/ Auto-enable UseSIMDForSHA3Intrinsic on hardware with performance benefit.\n+    \/\/ Note that the evaluation of SHA3 extension Intrinsics shows better performance\n@@ -383,2 +394,2 @@\n-      if (FLAG_IS_DEFAULT(UseSHA3Intrinsics)) {\n-        FLAG_SET_DEFAULT(UseSHA3Intrinsics, true);\n+      if (FLAG_IS_DEFAULT(UseSIMDForSHA3Intrinsic)) {\n+        FLAG_SET_DEFAULT(UseSIMDForSHA3Intrinsic, true);\n@@ -387,1 +398,2 @@\n-  } else if (UseSHA3Intrinsics && UseSIMDForSHA3Intrinsic) {\n+  }\n+  if (UseSHA3Intrinsics && UseSIMDForSHA3Intrinsic && !VM_Version::supports_sha3()) {\n","filename":"src\/hotspot\/cpu\/aarch64\/vm_version_aarch64.cpp","additions":18,"deletions":6,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -1343,1 +1343,2 @@\n-  if (supports_evex() && supports_avx512bw()) {\n+  if (UseSHA && supports_evex() && supports_avx512bw()) {\n+      \/\/ Matches the documented and tested behavior: the -UseSHA option disables all SHA intrinsics.\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -125,1 +125,1 @@\n-                return IntrinsicPredicates.SHA3_INSTRUCTION_AVAILABLE;\n+                return IntrinsicPredicates.SHA3_INTRINSIC_AVAILABLE;\n","filename":"test\/hotspot\/jtreg\/compiler\/intrinsics\/sha\/cli\/DigestOptionsBase.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -31,4 +31,1 @@\n- * @requires os.arch == \"aarch64\" & os.family == \"mac\"\n- * @comment sha3 is only implemented on AArch64 for now.\n- *          UseSHA3Intrinsics is only auto-enabled on Apple silicon, because it\n- *          may introduce performance regression on others. See JDK-8297092.\n+ * @requires (os.arch == \"aarch64\" | os.arch == \"amd64\" | os.arch == \"x86_64\")\n","filename":"test\/hotspot\/jtreg\/compiler\/intrinsics\/sha\/cli\/TestUseSHA3IntrinsicsOptionOnSupportedCPU.java","additions":1,"deletions":4,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -83,1 +83,2 @@\n-                        new String[] { DigestOptionsBase.getWarningForUnsupportedCPU(optionName) },\n+                        new String[] { \"warning: \" }, \/\/ Accept any warning message, e.g. \"requires that UseSHA is enabled\"\n+                                                      \/\/ or the common \"not available on this CPU\" message.\n","filename":"test\/hotspot\/jtreg\/compiler\/intrinsics\/sha\/cli\/testcases\/GenericTestCaseForSupportedCPU.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -74,1 +74,2 @@\n-                        new String[] { DigestOptionsBase.getWarningForUnsupportedCPU(optionName) },\n+                        new String[] { \"warning: \" }, \/\/ Accept any warning message, e.g. \"requires that UseSHA is enabled\"\n+                                                      \/\/ or the common \"not available on this CPU\" message.\n","filename":"test\/hotspot\/jtreg\/compiler\/intrinsics\/sha\/cli\/testcases\/GenericTestCaseForUnsupportedCPU.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -112,0 +112,6 @@\n+    public static final BooleanSupplier SHA3_INTRINSIC_AVAILABLE\n+            \/\/ AArch64 has both SHA3-based and GPR-based implementations of the SHA3 intrinsic. No need for the SHA3 capability.\n+            = new OrPredicate(new CPUSpecificPredicate(\"aarch64.*\", null, null),\n+              new OrPredicate(new CPUSpecificPredicate(\"amd64.*\",   new String[] {\"avx512f\", \"avx512bw\"}, null),\n+                              new CPUSpecificPredicate(\"x86_64\",    new String[] {\"avx512f\", \"avx512bw\"}, null)));\n+\n","filename":"test\/hotspot\/jtreg\/compiler\/testlibrary\/sha\/predicate\/IntrinsicPredicates.java","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"}]}