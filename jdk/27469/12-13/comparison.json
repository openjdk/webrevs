{"files":[{"patch":"@@ -209,1 +209,7 @@\n-        Http1ResponseBodySubscriber(BodySubscriber<U> userSubscriber, Http1Exchange<U> exchange) {\n+\n+        private final boolean cancelTimerOnTermination;\n+\n+        Http1ResponseBodySubscriber(\n+                BodySubscriber<U> userSubscriber,\n+                boolean cancelTimerOnTermination,\n+                Http1Exchange<U> exchange) {\n@@ -211,0 +217,1 @@\n+            this.cancelTimerOnTermination = cancelTimerOnTermination;\n@@ -226,1 +233,3 @@\n-            exchange.exchange.multi.cancelTimer();\n+            if (cancelTimerOnTermination) {\n+                exchange.exchange.multi.cancelTimer();\n+            }\n@@ -468,3 +477,4 @@\n-        Http1ResponseBodySubscriber<T> bs =\n-                new Http1ResponseBodySubscriber<T>(subscriber, this);\n-        return bs;\n+        var cancelTimerOnTermination =\n+                exchange.multi.cancelTimerOnResponseBodySubscriberTermination(\n+                        exchange.request().isWebSocket(), response.statusCode());\n+        return new Http1ResponseBodySubscriber<>(subscriber, cancelTimerOnTermination, this);\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http1Exchange.java","additions":15,"deletions":5,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -557,1 +557,4 @@\n-        Http3StreamResponseSubscriber(BodySubscriber<U> subscriber) {\n+\n+        private final boolean cancelTimerOnTermination;\n+\n+        Http3StreamResponseSubscriber(BodySubscriber<U> subscriber, boolean cancelTimerOnTermination) {\n@@ -559,0 +562,1 @@\n+            this.cancelTimerOnTermination = cancelTimerOnTermination;\n@@ -573,1 +577,3 @@\n-            exchange.multi.cancelTimer();\n+            if (cancelTimerOnTermination) {\n+                exchange.multi.cancelTimer();\n+            }\n@@ -598,3 +604,4 @@\n-        Http3StreamResponseSubscriber<T> subscriber =\n-                new Http3StreamResponseSubscriber<>(handler.apply(response));\n-        return subscriber;\n+        var cancelTimerOnTermination =\n+                exchange.multi.cancelTimerOnResponseBodySubscriberTermination(\n+                        exchange.request().isWebSocket(), response.statusCode());\n+        return new Http3StreamResponseSubscriber<>(handler.apply(response), cancelTimerOnTermination);\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http3ExchangeImpl.java","additions":12,"deletions":5,"binary":false,"changes":17,"status":"modified"},{"patch":"@@ -245,6 +245,0 @@\n-\n-        @Override\n-        protected void onTermination() {\n-            exchange.multi.cancelTimer();\n-        }\n-\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Http3PushPromiseStream.java","additions":0,"deletions":6,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -263,0 +263,11 @@\n+    \/**\n+     * {@return {@code true}, if it is allowed to cancel the request timer on\n+     * response body subscriber termination; {@code false}, otherwise}\n+     *\n+     * @param webSocket indicates if the associated request is a WebSocket handshake\n+     * @param statusCode the status code of the associated response\n+     *\/\n+    public boolean cancelTimerOnResponseBodySubscriberTermination(boolean webSocket, int statusCode) {\n+        return webSocket || statusCode < 100 || statusCode >= 200;\n+    }\n+\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/MultiExchange.java","additions":11,"deletions":0,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -394,3 +394,4 @@\n-        Http2StreamResponseSubscriber<T> subscriber =\n-                new Http2StreamResponseSubscriber<>(handler.apply(response));\n-        return subscriber;\n+        var cancelTimerOnTermination =\n+                exchange.multi.cancelTimerOnResponseBodySubscriberTermination(\n+                        exchange.request().isWebSocket(), response.statusCode());\n+        return new Http2StreamResponseSubscriber<>(handler.apply(response), cancelTimerOnTermination);\n@@ -1728,0 +1729,5 @@\n+        @Override\n+        Http2StreamResponseSubscriber<T> createResponseSubscriber(BodyHandler<T> handler, ResponseInfo response) {\n+            return new Http2StreamResponseSubscriber<T>(handler.apply(response), false);\n+        }\n+\n@@ -1958,1 +1964,4 @@\n-        Http2StreamResponseSubscriber(BodySubscriber<U> subscriber) {\n+\n+        private final boolean cancelTimerOnTermination;\n+\n+        Http2StreamResponseSubscriber(BodySubscriber<U> subscriber, boolean cancelTimerOnTermination) {\n@@ -1960,0 +1969,1 @@\n+            this.cancelTimerOnTermination = cancelTimerOnTermination;\n@@ -1974,1 +1984,3 @@\n-            exchange.multi.cancelTimer();\n+            if (cancelTimerOnTermination) {\n+                exchange.multi.cancelTimer();\n+            }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/Stream.java","additions":17,"deletions":5,"binary":false,"changes":22,"status":"modified"}]}