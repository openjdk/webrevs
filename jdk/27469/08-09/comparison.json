{"files":[{"patch":"@@ -150,1 +150,1 @@\n-         * time includes any SSL\/TLS handshake.\n+         * time includes any WebSocket and SSL\/TLS handshakes.\n","filename":"src\/java.net.http\/share\/classes\/java\/net\/http\/WebSocket.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1833,0 +1833,7 @@\n+    \/\/ Visible for tests\n+    List<TimeoutEvent> timers() {\n+        synchronized (this) {\n+            return new ArrayList<>(timeouts);\n+        }\n+    }\n+\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/HttpClientImpl.java","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+import static jdk.internal.net.http.HttpClientTimerAccess.assertNoResponseTimerEventRegistrations;\n@@ -47,0 +48,1 @@\n+ *          access\n@@ -48,0 +50,3 @@\n+ *        java.net.http\/jdk.internal.net.http.HttpClientTimerAccess\n+ *        jdk.httpclient.test.lib.common.HttpServerAdapters\n+ *        jdk.test.lib.net.SimpleSSLContext\n@@ -66,0 +71,1 @@\n+ *          access\n@@ -67,0 +73,3 @@\n+ *        java.net.http\/jdk.internal.net.http.HttpClientTimerAccess\n+ *        jdk.httpclient.test.lib.common.HttpServerAdapters\n+ *        jdk.test.lib.net.SimpleSSLContext\n@@ -116,0 +125,2 @@\n+            LOGGER.log(\"Verifying the registered response timer events\");\n+            assertNoResponseTimerEventRegistrations(client);\n@@ -142,0 +153,2 @@\n+            LOGGER.log(\"Verifying the registered response timer events\");\n+            assertNoResponseTimerEventRegistrations(client);\n@@ -176,0 +189,2 @@\n+            LOGGER.log(\"Verifying the registered response timer events\");\n+            assertNoResponseTimerEventRegistrations(client);\n@@ -202,0 +217,2 @@\n+            LOGGER.log(\"Verifying the registered response timer events\");\n+            assertNoResponseTimerEventRegistrations(client);\n@@ -225,0 +242,48 @@\n+    \/**\n+     * Tests timeouts using\n+     * {@link HttpClient#send(HttpRequest, HttpResponse.BodyHandler) HttpClient::send}\n+     * against a server delivering 204, i.e., no content, which is handled\n+     * through a specialized path served by {@code MultiExchange::handleNoBody}.\n+     *\/\n+    @ParameterizedTest\n+    @MethodSource(\"serverRequestPairs\")\n+    void testSendOnNoBody(ServerRequestPair pair) throws Exception {\n+\n+        ServerRequestPair.SERVER_HANDLER_BEHAVIOUR =\n+                ServerRequestPair.ServerHandlerBehaviour.DELIVER_NO_BODY;\n+\n+        try (HttpClient client = pair.createClientWithEstablishedConnection()) {\n+            assertTimeoutPreemptively(REQUEST_TIMEOUT.multipliedBy(2), () -> {\n+                LOGGER.log(\"Sending the request\");\n+                client.send(pair.request(), HttpResponse.BodyHandlers.discarding());\n+            });\n+            LOGGER.log(\"Verifying the registered response timer events\");\n+            assertNoResponseTimerEventRegistrations(client);\n+        }\n+\n+    }\n+\n+    \/**\n+     * Tests timeouts using\n+     * {@link HttpClient#sendAsync(HttpRequest, HttpResponse.BodyHandler) HttpClient::sendAsync}\n+     * against a server delivering 204, i.e., no content, which is handled\n+     * through a specialized path served by {@code MultiExchange::handleNoBody}.\n+     *\/\n+    @ParameterizedTest\n+    @MethodSource(\"serverRequestPairs\")\n+    void testSendAsyncOnNoBody(ServerRequestPair pair) throws Exception {\n+\n+        ServerRequestPair.SERVER_HANDLER_BEHAVIOUR =\n+                ServerRequestPair.ServerHandlerBehaviour.DELIVER_NO_BODY;\n+\n+        try (HttpClient client = pair.createClientWithEstablishedConnection()) {\n+            assertTimeoutPreemptively(REQUEST_TIMEOUT.multipliedBy(2), () -> {\n+                LOGGER.log(\"Sending the request asynchronously\");\n+                client.sendAsync(pair.request(), HttpResponse.BodyHandlers.discarding()).get();\n+            });\n+            LOGGER.log(\"Verifying the registered response timer events\");\n+            assertNoResponseTimerEventRegistrations(client);\n+        }\n+\n+    }\n+\n","filename":"test\/jdk\/java\/net\/httpclient\/TimeoutResponseBodyTest.java","additions":65,"deletions":0,"binary":false,"changes":65,"status":"modified"},{"patch":"@@ -34,0 +34,1 @@\n+import static jdk.internal.net.http.HttpClientTimerAccess.assertNoResponseTimerEventRegistrations;\n@@ -44,0 +45,1 @@\n+ *          access\n@@ -45,0 +47,3 @@\n+ *        java.net.http\/jdk.internal.net.http.HttpClientTimerAccess\n+ *        jdk.httpclient.test.lib.common.HttpServerAdapters\n+ *        jdk.test.lib.net.SimpleSSLContext\n@@ -63,0 +68,1 @@\n+ *          access\n@@ -64,0 +70,3 @@\n+ *        java.net.http\/jdk.internal.net.http.HttpClientTimerAccess\n+ *        jdk.httpclient.test.lib.common.HttpServerAdapters\n+ *        jdk.test.lib.net.SimpleSSLContext\n@@ -103,0 +112,2 @@\n+            LOGGER.log(\"Verifying the registered response timer events\");\n+            assertNoResponseTimerEventRegistrations(client);\n@@ -124,0 +135,2 @@\n+            LOGGER.log(\"Verifying the registered response timer events\");\n+            assertNoResponseTimerEventRegistrations(client);\n","filename":"test\/jdk\/java\/net\/httpclient\/TimeoutResponseHeaderTest.java","additions":13,"deletions":0,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -155,1 +155,2 @@\n-            DELIVER_BODY_SLOWLY\n+            DELIVER_BODY_SLOWLY,\n+            DELIVER_NO_BODY\n@@ -240,3 +241,1 @@\n-                        case BLOCK_BEFORE_HEADER_DELIVERY:\n-                            sleepIndefinitely(serverId, connectionKey);\n-                            break;\n+                        case BLOCK_BEFORE_HEADER_DELIVERY -> sleepIndefinitely(serverId, connectionKey);\n@@ -244,1 +243,1 @@\n-                        case BLOCK_BEFORE_BODY_DELIVERY:\n+                        case BLOCK_BEFORE_BODY_DELIVERY -> {\n@@ -247,1 +246,1 @@\n-                            break;\n+                        }\n@@ -249,1 +248,1 @@\n-                        case DELIVER_BODY_SLOWLY:\n+                        case DELIVER_BODY_SLOWLY -> {\n@@ -252,1 +251,4 @@\n-                            break;\n+                        }\n+\n+                        case DELIVER_NO_BODY -> sendResponseHeaders(serverId, exchange, connectionKey, 204, 0);\n+\n@@ -276,0 +278,10 @@\n+            sendResponseHeaders(serverId, exchange, connectionKey, 200, CONTENT_LENGTH);\n+        }\n+\n+        private static void sendResponseHeaders(\n+                String serverId,\n+                HttpTestExchange exchange,\n+                String connectionKey,\n+                int statusCode,\n+                long contentLength)\n+                throws IOException {\n@@ -277,1 +289,1 @@\n-            exchange.sendResponseHeaders(200, CONTENT_LENGTH);\n+            exchange.sendResponseHeaders(statusCode, contentLength);\n","filename":"test\/jdk\/java\/net\/httpclient\/TimeoutResponseTestSupport.java","additions":21,"deletions":9,"binary":false,"changes":30,"status":"modified"},{"patch":"@@ -0,0 +1,59 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+package jdk.internal.net.http;\n+\n+import java.net.http.HttpClient;\n+\n+public enum HttpClientTimerAccess {;\n+\n+    public static void assertNoResponseTimerEventRegistrations(HttpClient client) {\n+        assertTimerEventRegistrationCount(client, ResponseTimerEvent.class, 0);\n+    }\n+\n+    private static void assertTimerEventRegistrationCount(\n+            HttpClient client,\n+            Class<? extends TimeoutEvent> clazz,\n+            long expectedCount) {\n+        var facade = assertType(HttpClientFacade.class, client);\n+        var actualCount = facade.impl.timers().stream().filter(clazz::isInstance).count();\n+        if (actualCount != 0) {\n+            throw new AssertionError(\n+                    \"Found %s occurrences of `%s` timer event registrations while expecting %s.\".formatted(\n+                            actualCount, clazz.getCanonicalName(), expectedCount));\n+        }\n+    }\n+\n+    private static <T> T assertType(Class<T> expectedType, Object instance) {\n+        if (!expectedType.isInstance(instance)) {\n+            var expectedTypeName = expectedType.getCanonicalName();\n+            var actualTypeName = instance != null ? instance.getClass().getCanonicalName() : null;\n+            throw new AssertionError(\n+                    \"Was expecting an instance of type `%s`, found: `%s`\".formatted(\n+                            expectedTypeName, actualTypeName));\n+        }\n+        @SuppressWarnings(\"unchecked\")\n+        T typedInstance = (T) instance;\n+        return typedInstance;\n+    }\n+\n+}\n","filename":"test\/jdk\/java\/net\/httpclient\/access\/java.net.http\/jdk\/internal\/net\/http\/HttpClientTimerAccess.java","additions":59,"deletions":0,"binary":false,"changes":59,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,2 @@\n- * @bug 8217429\n+ * @bug 8217429 8208693\n+ * @library ..\/access\n@@ -28,0 +29,1 @@\n+ *        java.net.http\/jdk.internal.net.http.HttpClientTimerAccess\n@@ -51,0 +53,1 @@\n+import java.util.concurrent.CountDownLatch;\n@@ -61,0 +64,1 @@\n+import static jdk.internal.net.http.HttpClientTimerAccess.assertNoResponseTimerEventRegistrations;\n@@ -146,0 +150,33 @@\n+    \/**\n+     * Verifies that the internally issued request to establish the WebSocket\n+     * connection does not leave any response timers registered at the client\n+     * after the WebSocket handshake.\n+     *\/\n+    @Test\n+    public void responseTimerCleanUp() throws Exception {\n+        try (var server = new DummyWebSocketServer()) {\n+            server.open();\n+            try (var client = newBuilder().proxy(NO_PROXY).build()) {\n+                var connectionEstablished = new CountDownLatch(1);\n+                var webSocketListener = new WebSocket.Listener() {\n+\n+                    @Override\n+                    public void onOpen(WebSocket webSocket) {\n+                        connectionEstablished.countDown();\n+                    }\n+\n+                };\n+                var webSocket = client\n+                        .newWebSocketBuilder()\n+                        .buildAsync(server.getURI(), webSocketListener)\n+                        .join();\n+                try {\n+                    connectionEstablished.await();\n+                    assertNoResponseTimerEventRegistrations(client);\n+                } finally {\n+                    webSocket.abort();\n+                }\n+            }\n+        }\n+    }\n+\n","filename":"test\/jdk\/java\/net\/httpclient\/websocket\/WebSocketTest.java","additions":39,"deletions":2,"binary":false,"changes":41,"status":"modified"}]}