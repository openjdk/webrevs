{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2002, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2002, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,1 @@\n+import java.util.Collections;\n@@ -29,0 +30,1 @@\n+import java.util.stream.IntStream;\n@@ -78,2 +80,1 @@\n-    \/\/ threadList and loadObjectList are filled by attach0 method\n-    private List<ThreadProxy> threadList;\n+    \/\/ loadObjectList are filled by attach0 method\n@@ -82,0 +83,2 @@\n+    private List<JavaThread> javaThreadList;\n+\n@@ -244,0 +247,12 @@\n+    private void fillJavaThreadList() {\n+      \/\/ TODO: thread list on macOS is now supported for corefile only.\n+      if (!isCore && isDarwin) {\n+          javaThreadList = Collections.emptyList();\n+      } else {\n+          Threads threads = VM.getVM().getThreads();\n+          javaThreadList = IntStream.range(0, threads.getNumberOfThreads())\n+                                    .mapToObj(threads::getJavaThreadAt)\n+                                    .toList();\n+      }\n+    }\n+\n@@ -247,1 +262,0 @@\n-        threadList = new ArrayList<>();\n@@ -267,1 +281,0 @@\n-        threadList = new ArrayList<>();\n@@ -281,1 +294,1 @@\n-        threadList = null;\n+        javaThreadList = null;\n@@ -495,1 +508,6 @@\n-      return threadList;\n+      if (javaThreadList == null) {\n+        fillJavaThreadList();\n+      }\n+      return javaThreadList.stream()\n+                           .map(JavaThread::getThreadProxy)\n+                           .toList();\n@@ -564,1 +582,1 @@\n-        all java threads recorded in Threads. Also adds the ThreadProxy to threadList *\/\n+        all java threads recorded in Threads. *\/\n@@ -567,3 +585,4 @@\n-        Threads threads = VM.getVM().getThreads();\n-        int len = threads.getNumberOfThreads();\n-        long[] result = new long[len * 3];    \/\/ triple\n+        if (javaThreadList == null) {\n+            fillJavaThreadList();\n+        }\n+        long[] result = new long[javaThreadList.size() * 3];    \/\/ triple\n@@ -572,2 +591,1 @@\n-        for (int k = 0; k < threads.getNumberOfThreads(); k++) {\n-            JavaThread t = threads.getJavaThreadAt(k);\n+        for (var t : javaThreadList) {\n@@ -576,3 +594,1 @@\n-            BsdThread bsdt = (BsdThread)t.getThreadProxy();\n-            long uid = bsdt.getUniqueThreadId();\n-            if (threadList != null) threadList.add(bsdt);\n+            long uid = ((BsdThread)t.getThreadProxy()).getUniqueThreadId();\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/debugger\/bsd\/BsdDebuggerLocal.java","additions":32,"deletions":16,"binary":false,"changes":48,"status":"modified"}]}