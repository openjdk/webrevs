{"files":[{"patch":"@@ -218,1 +218,1 @@\n-    site->commit_memory(rgn->committed_size());\n+    site->commit_memory(VirtualMemoryTracker::Instance::committed_size(rgn));\n","filename":"src\/hotspot\/share\/nmt\/memBaseline.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -425,1 +425,1 @@\n-  bool all_committed = reserved_rgn->size() == reserved_rgn->committed_size();\n+  bool all_committed = reserved_rgn->size() == VirtualMemoryTracker::Instance::committed_size(reserved_rgn);\n","filename":"src\/hotspot\/share\/nmt\/memReporter.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -222,2 +222,1 @@\n-size_t ReservedMemoryRegion::committed_size() const {\n-  size_t committed = 0;\n+size_t VirtualMemoryTracker::committed_size(const ReservedMemoryRegion* rmr) {\n@@ -225,1 +224,1 @@\n-  VirtualMemoryTracker::Instance::tree()->visit_committed_regions(*this, [&](CommittedMemoryRegion& crgn) {\n+  tree()->visit_committed_regions(*rmr, [&](CommittedMemoryRegion& crgn) {\n@@ -232,4 +231,14 @@\n-address ReservedMemoryRegion::thread_stack_uncommitted_bottom() const {\n-  address bottom = base();\n-  address top = base() + size();\n-  VirtualMemoryTracker::Instance::tree()->visit_committed_regions(*this, [&](CommittedMemoryRegion& crgn) {\n+size_t VirtualMemoryTracker::Instance::committed_size(const ReservedMemoryRegion* rmr) {\n+  assert(_tracker != nullptr, \"Sanity check\");\n+  return _tracker->committed_size(rmr);\n+}\n+\n+address VirtualMemoryTracker::Instance::thread_stack_uncommitted_bottom(const ReservedMemoryRegion* rmr) {\n+  assert(_tracker != nullptr, \"Sanity check\");\n+  return _tracker->thread_stack_uncommitted_bottom(rmr);\n+}\n+\n+address VirtualMemoryTracker::thread_stack_uncommitted_bottom(const ReservedMemoryRegion* rmr) {\n+  address bottom = rmr->base();\n+  address top = rmr->end();\n+    tree()->visit_committed_regions(*rmr, [&](CommittedMemoryRegion& crgn) {\n@@ -294,1 +303,1 @@\n-      address stack_bottom = rgn->thread_stack_uncommitted_bottom();\n+      address stack_bottom = VirtualMemoryTracker::Instance::thread_stack_uncommitted_bottom(rgn);\n","filename":"src\/hotspot\/share\/nmt\/virtualMemoryTracker.cpp","additions":17,"deletions":8,"binary":false,"changes":25,"status":"modified"},{"patch":"@@ -333,6 +333,0 @@\n-  \/\/ uncommitted thread stack bottom, above guard pages if there is any.\n-  address thread_stack_uncommitted_bottom() const;\n-\n-  size_t committed_size() const;\n-\n-\n@@ -385,0 +379,3 @@\n+  size_t committed_size(const ReservedMemoryRegion* rmr);\n+  address thread_stack_uncommitted_bottom(const ReservedMemoryRegion* rmr);\n+\n@@ -407,0 +404,3 @@\n+    static size_t committed_size(const ReservedMemoryRegion* rmr);\n+    \/\/ uncommitted thread stack bottom, above guard pages if there is any.\n+    static address thread_stack_uncommitted_bottom(const ReservedMemoryRegion* rmr);\n","filename":"src\/hotspot\/share\/nmt\/virtualMemoryTracker.hpp","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -53,1 +53,1 @@\n-#define check(rmr, regions) check_inner((rmr), (regions), ARRAY_SIZE(regions), __FILE__, __LINE__)\n+#define check(vmt, rmr, regions) check_inner((vmt), (rmr), (regions), ARRAY_SIZE(regions), __FILE__, __LINE__)\n@@ -55,1 +55,1 @@\n-#define check_empty(rmr)                              \\\n+#define check_empty(vmt, rmr)                              \\\n@@ -57,1 +57,1 @@\n-    check_inner((rmr), nullptr, 0, __FILE__, __LINE__);  \\\n+    check_inner((vmt), (rmr), nullptr, 0, __FILE__, __LINE__);  \\\n@@ -60,1 +60,1 @@\n-static void diagnostic_print(const ReservedMemoryRegion& rmr) {\n+static void diagnostic_print(VirtualMemoryTracker& vmt, const ReservedMemoryRegion& rmr) {\n@@ -68,1 +68,1 @@\n-static void check_inner(const ReservedMemoryRegion& rmr, R* regions, size_t regions_size, const char* file, int line) {\n+static void check_inner(VirtualMemoryTracker& vmt, const ReservedMemoryRegion& rmr, R* regions, size_t regions_size, const char* file, int line) {\n@@ -73,1 +73,1 @@\n-  diagnostic_print(rmr);\n+  diagnostic_print(vmt, rmr);\n@@ -77,1 +77,1 @@\n-  VirtualMemoryTracker::Instance::tree()->visit_committed_regions(rmr, [&](CommittedMemoryRegion& region) {\n+  vmt.tree()->visit_committed_regions(rmr, [&](CommittedMemoryRegion& region) {\n@@ -87,1 +87,1 @@\n-  EXPECT_EQ(size, rmr.committed_size()) << WHERE;\n+  EXPECT_EQ(size, vmt.committed_size(&rmr)) << WHERE;\n@@ -93,0 +93,2 @@\n+    VirtualMemoryTracker vmt(true);\n+    RegionsTree* rtree = vmt.tree();\n@@ -94,1 +96,1 @@\n-    ReservedSpace rs = MemoryReserver::reserve(size, mtTest);\n+    const address addr = (address)0x0000A000;\n@@ -96,1 +98,1 @@\n-    address addr = (address)rs.base();\n+    vmt.add_reserved_region(addr, size, CALLER_PC, mtTest);\n@@ -105,3 +107,0 @@\n-    RegionsTree* rtree = VirtualMemoryTracker::Instance::tree();\n-    MemTracker::NmtVirtualMemoryLocker nvml;\n-\n@@ -121,1 +120,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -127,1 +126,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -133,1 +132,1 @@\n-      check(rmr, r);\n+      check(vmt,rmr, r);\n@@ -138,1 +137,1 @@\n-    ASSERT_EQ(rmr.committed_size(), 0u);\n+    ASSERT_EQ(vmt.committed_size(&rmr), 0u);\n@@ -146,1 +145,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -153,1 +152,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -161,1 +160,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -166,3 +165,1 @@\n-    ASSERT_EQ(rmr.committed_size(), 0u);\n-\n-    rtree->tree().remove_all();\n+    ASSERT_EQ(vmt.committed_size(&rmr), 0u);\n@@ -172,0 +169,2 @@\n+    VirtualMemoryTracker vmt(true);\n+    RegionsTree* rtree = vmt.tree();\n@@ -173,6 +172,1 @@\n-    ReservedSpace rs = MemoryReserver::reserve(size, mtTest);\n-\n-    RegionsTree* rtree = VirtualMemoryTracker::Instance::tree();\n-    MemTracker::NmtVirtualMemoryLocker nvml;\n-\n-    address addr = (address)rs.base();\n+    const address addr = (address)0x0000A000;\n@@ -180,0 +174,1 @@\n+    vmt.add_reserved_region(addr, size, CALLER_PC, mtTest);\n@@ -202,1 +197,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -208,1 +203,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -213,1 +208,1 @@\n-    ASSERT_EQ(rmr.committed_size(), 4 * cs);\n+    ASSERT_EQ(vmt.committed_size(&rmr), 4 * cs);\n@@ -218,1 +213,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -223,1 +218,1 @@\n-    ASSERT_EQ(rmr.committed_size(), 0u);\n+    ASSERT_EQ(vmt.committed_size(&rmr), 0u);\n@@ -233,1 +228,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -241,1 +236,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -247,1 +242,1 @@\n-    ASSERT_EQ(rmr.committed_size(), 4 * cs);\n+    ASSERT_EQ(vmt.committed_size(&rmr), 4 * cs);\n@@ -254,1 +249,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -261,0 +256,2 @@\n+    VirtualMemoryTracker vmt(true);\n+    RegionsTree* rtree = vmt.tree();\n@@ -262,4 +259,1 @@\n-    ReservedSpace rs = MemoryReserver::reserve(size, mtTest);\n-\n-    RegionsTree* rtree = VirtualMemoryTracker::Instance::tree();\n-    MemTracker::NmtVirtualMemoryLocker nvml;\n+    const address addr = (address)0x0000A000;\n@@ -267,1 +261,1 @@\n-    address addr = (address)rs.base();\n+    vmt.add_reserved_region(addr, size, CALLER_PC, mtTest);\n@@ -290,1 +284,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -296,1 +290,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -302,1 +296,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -308,1 +302,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -314,1 +308,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -320,1 +314,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -326,1 +320,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -332,1 +326,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -337,1 +331,1 @@\n-    ASSERT_EQ(rmr.committed_size(), 0u);\n+    ASSERT_EQ(vmt.committed_size(&rmr), 0u);\n@@ -348,1 +342,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -355,1 +349,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -362,1 +356,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -367,1 +361,1 @@\n-    ASSERT_EQ(rmr.committed_size(), 0u);\n+    ASSERT_EQ(vmt.committed_size(&rmr), 0u);\n@@ -374,1 +368,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -380,1 +374,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -387,1 +381,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -393,1 +387,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -400,1 +394,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -406,1 +400,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -412,1 +406,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -420,1 +414,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -438,0 +432,2 @@\n+    VirtualMemoryTracker vmt(true);\n+    RegionsTree* rtree = vmt.tree();\n@@ -439,6 +435,1 @@\n-    ReservedSpace rs = MemoryReserver::reserve(size, mtTest);\n-\n-    RegionsTree* rtree = VirtualMemoryTracker::Instance::tree();\n-    MemTracker::NmtVirtualMemoryLocker nvml;\n-\n-    address addr = (address)rs.base();\n+    const address addr = (address)0x0000A000;\n@@ -446,0 +437,1 @@\n+    vmt.add_reserved_region(addr, size, CALLER_PC, mtTest);\n@@ -464,1 +456,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -468,1 +460,1 @@\n-      check_empty(rmr);\n+      check_empty(vmt, rmr);\n@@ -480,1 +472,1 @@\n-        check(rmr, r);\n+        check(vmt, rmr, r);\n@@ -490,1 +482,1 @@\n-        check(rmr, r);\n+        check(vmt, rmr, r);\n@@ -500,1 +492,1 @@\n-        check(rmr, r);\n+        check(vmt, rmr, r);\n@@ -504,1 +496,1 @@\n-      check_empty(rmr);\n+      check_empty(vmt, rmr);\n@@ -510,1 +502,1 @@\n-      check_empty(rmr);\n+      check_empty(vmt, rmr);\n@@ -518,1 +510,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -521,1 +513,1 @@\n-      check_empty(rmr);\n+      check_empty(vmt, rmr);\n@@ -528,1 +520,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -531,1 +523,1 @@\n-      check_empty(rmr);\n+      check_empty(vmt, rmr);\n@@ -538,1 +530,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -541,1 +533,1 @@\n-      check_empty(rmr);\n+      check_empty(vmt, rmr);\n@@ -548,1 +540,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -551,1 +543,1 @@\n-      check_empty(rmr);\n+      check_empty(vmt, rmr);\n@@ -558,1 +550,1 @@\n-      check(rmr, r);\n+      check(vmt, rmr, r);\n@@ -561,1 +553,1 @@\n-      check_empty(rmr);\n+      check_empty(vmt, rmr);\n","filename":"test\/hotspot\/gtest\/runtime\/test_virtualMemoryTracker.cpp","additions":79,"deletions":87,"binary":false,"changes":166,"status":"modified"}]}