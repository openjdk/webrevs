{"files":[{"patch":"@@ -104,0 +104,1 @@\n+  FN(idealloop,   C2 Ideal Loop arena) \\\n","filename":"src\/hotspot\/share\/memory\/arena.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -3758,0 +3758,14 @@\n+IdealLoopTree::IdealLoopTree(PhaseIdealLoop* phase, Node* head, Node* tail): _parent(nullptr), _next(nullptr), _child(nullptr),\n+                                                                             _head(head), _tail(tail),\n+                                                                             _phase(phase),\n+                                                                             _local_loop_unroll_limit(0), _local_loop_unroll_factor(0),\n+                                                                             _body(phase->arena()),\n+                                                                             _nest(0), _irreducible(0), _has_call(0), _has_sfpt(0), _rce_candidate(0),\n+                                                                             _has_range_checks(0), _has_range_checks_computed(0),\n+                                                                             _safepts(nullptr),\n+                                                                             _required_safept(nullptr),\n+                                                                             _allow_optimizations(true) {\n+  precond(_head != nullptr);\n+  precond(_tail != nullptr);\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/loopnode.cpp","additions":14,"deletions":0,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -672,15 +672,1 @@\n-  IdealLoopTree( PhaseIdealLoop* phase, Node *head, Node *tail )\n-    : _parent(nullptr), _next(nullptr), _child(nullptr),\n-      _head(head), _tail(tail),\n-      _phase(phase),\n-      _local_loop_unroll_limit(0), _local_loop_unroll_factor(0),\n-      _body(Compile::current()->comp_arena()),\n-      _nest(0), _irreducible(0), _has_call(0), _has_sfpt(0), _rce_candidate(0),\n-      _has_range_checks(0), _has_range_checks_computed(0),\n-      _safepts(nullptr),\n-      _required_safept(nullptr),\n-      _allow_optimizations(true)\n-  {\n-    precond(_head != nullptr);\n-    precond(_tail != nullptr);\n-  }\n+  IdealLoopTree(PhaseIdealLoop* phase, Node* head, Node* tail);\n@@ -892,0 +878,2 @@\n+  Arena _arena; \/\/ For data whose lifetime is a single pass of loop optimizations\n+\n@@ -1052,0 +1040,2 @@\n+  Arena* arena() { return &_arena; };\n+\n@@ -1226,1 +1216,2 @@\n-    _loop_or_ctrl(igvn.C->comp_arena()),\n+    _arena(mtCompiler, Arena::Tag::tag_idealloop),\n+    _loop_or_ctrl(&_arena),\n@@ -1241,1 +1232,2 @@\n-    _loop_or_ctrl(igvn.C->comp_arena()),\n+    _arena(mtCompiler, Arena::Tag::tag_idealloop),\n+    _loop_or_ctrl(&_arena),\n","filename":"src\/hotspot\/share\/opto\/loopnode.hpp","additions":9,"deletions":17,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -0,0 +1,332 @@\n+\/*\n+ * Copyright (c) 2025 IBM Corporation. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+\/**\n+ * @test\n+ * @key stress randomness\n+ * @bug 8370519\n+ * @summary C2: Hit MemLimit when running with +VerifyLoopOptimizations\n+ * @run main\/othervm -XX:CompileCommand=compileonly,*TestVerifyLoopOptimizationsHighMemUsage*::* -XX:-TieredCompilation -Xbatch\n+ *                   -XX:+UnlockDiagnosticVMOptions -XX:+IgnoreUnrecognizedVMOptions\n+ *                   -XX:+StressLoopPeeling -XX:+VerifyLoopOptimizations \n+ *                   -XX:StressSeed=3106998670 TestVerifyLoopOptimizationsHighMemUsage\n+ * @run main ${test.main.class}\n+ *\/\n+\n+public class TestVerifyLoopOptimizationsHighMemUsage {\n+\n+    public static final int N = 400;\n+\n+    public static long instanceCount=-13L;\n+    public static volatile short sFld=-16143;\n+    public byte byFld=28;\n+    public boolean bFld=false;\n+    public int iFld=-159;\n+    public static float fArrFld[]=new float[N];\n+    public static volatile double dArrFld[]=new double[N];\n+\n+    public static long lMeth_check_sum = 0;\n+\n+    public long lMeth(int i1) {\n+\n+        int i2=11, i3=37085, i4=177, i5=190, i6=-234, i7=13060, iArr[]=new int[N];\n+        float f=1.179F;\n+        double d=2.9685, d1=0.17775;\n+        long lArr[]=new long[N];\n+        boolean bArr[]=new boolean[N];\n+\n+        for (i2 = 15; i2 < 330; ++i2) {\n+            for (i4 = 1; i4 < 5; ++i4) {\n+                TestVerifyLoopOptimizationsHighMemUsage.fArrFld[i4 + 1] = (++i1);\n+                for (i6 = 2; i6 > 1; i6 -= 3) {\n+                    iArr[i6] <<= i1;\n+                    switch ((i2 * 5) + 54) {\n+                    case 156:\n+                        if (i4 != 0) {\n+                        }\n+                        i5 += (int)(f++);\n+                        switch (((((i3++) >>> 1) % 8) * 5) + 92) {\n+                        case 123:\n+                            iArr[i6 - 1] -= ((i5++) * Math.max(i6 | i2, --i7));\n+                            switch (((i2 % 1) * 5) + 91) {\n+                            case 92:\n+                                f = i1;\n+                                f = -32.539F;\n+                            default:\n+                                i3 -= (int)TestVerifyLoopOptimizationsHighMemUsage.instanceCount;\n+                            }\n+                        case 109:\n+                            if (i4 != 0) {\n+                            }\n+                            break;\n+                        case 98:\n+                            i3 -= i6;\n+                            break;\n+                        case 99:\n+                            iArr = iArr;\n+                        case 100:\n+                            TestVerifyLoopOptimizationsHighMemUsage.sFld = (short)-166L;\n+                            break;\n+                        case 117:\n+                            i1 = i7;\n+                            break;\n+                        case 101:\n+                            TestVerifyLoopOptimizationsHighMemUsage.instanceCount += -3L;\n+                            break;\n+                        case 116:\n+                            byFld &= (byte)i5;\n+                        default:\n+                            TestVerifyLoopOptimizationsHighMemUsage.instanceCount += i6;\n+                        }\n+                        break;\n+                    case 168:\n+                        TestVerifyLoopOptimizationsHighMemUsage.instanceCount = -122;\n+                        break;\n+                    case 342:\n+                        byFld -= (byte)-135;\n+                        break;\n+                    case 283:\n+                        i1 = (int)TestVerifyLoopOptimizationsHighMemUsage.instanceCount;\n+                        break;\n+                    case 91:\n+                        i7 -= i1;\n+                        break;\n+                    case 281:\n+                        i1 += i3;\n+                        break;\n+                    case 328:\n+                        i5 += i6;\n+                        break;\n+                    case 322:\n+                        TestVerifyLoopOptimizationsHighMemUsage.instanceCount = i7;\n+                        break;\n+                    case 228:\n+                        if (bFld) continue;\n+                        break;\n+                    case 114:\n+                        lArr[i2 - 1] -= i1;\n+                        break;\n+                    case 207:\n+                        iArr = iArr;\n+                        break;\n+                    case 209:\n+                        i7 |= i1;\n+                        break;\n+                    case 354:\n+                        i7 += byFld;\n+                        break;\n+                    case 108:\n+                        i1 <<= i1;\n+                    case 398:\n+                        i5 += (i6 * i6);\n+                        break;\n+                    case 144:\n+                        bFld = true;\n+                        break;\n+                    case 218:\n+                        f += i1;\n+                        break;\n+                    case 116:\n+                        iArr = iArr;\n+                        break;\n+                    case 296:\n+                        i5 = (int)TestVerifyLoopOptimizationsHighMemUsage.instanceCount;\n+                    case 198:\n+                        i1 = (int)TestVerifyLoopOptimizationsHighMemUsage.instanceCount;\n+                    case 173:\n+                        i5 = (int)TestVerifyLoopOptimizationsHighMemUsage.instanceCount;\n+                        break;\n+                    case 258:\n+                        f = TestVerifyLoopOptimizationsHighMemUsage.instanceCount;\n+                        break;\n+                    case 105:\n+                        i5 = i1;\n+                    case 120:\n+                        d = -6201927065613177484L;\n+                        break;\n+                    case 374:\n+                        i3 = (int)TestVerifyLoopOptimizationsHighMemUsage.instanceCount;\n+                        break;\n+                    case 248:\n+                        i5 += i6;\n+                        break;\n+                    case 140:\n+                        i1 \/= (int)(i1 | 1);\n+                        break;\n+                    case 366:\n+                        f = -181;\n+                        break;\n+                    case 222:\n+                    case 57:\n+                        iArr[i2 - 1] >>= i2;\n+                        break;\n+                    case 261:\n+                        i1 = -3;\n+                        break;\n+                    case 106:\n+                        TestVerifyLoopOptimizationsHighMemUsage.sFld = (short)-35383;\n+                        break;\n+                    case 306:\n+                        TestVerifyLoopOptimizationsHighMemUsage.dArrFld[i6 - 1] -= d1;\n+                        break;\n+                    case 292:\n+                        i7 = i3;\n+                        break;\n+                    case 93:\n+                    case 187:\n+                        i1 += i6;\n+                    case 399:\n+                        iArr[i6 + 1] = (int)TestVerifyLoopOptimizationsHighMemUsage.instanceCount;\n+                        break;\n+                    case 151:\n+                        i3 += i6;\n+                        break;\n+                    case 287:\n+                        bFld = bFld;\n+                        break;\n+                    case 148:\n+                        f = (float)-77.43986;\n+                    case 247:\n+                        i7 |= i1;\n+                    case 352:\n+                        try {\n+                            i5 = (i6 \/ -44130);\n+                            i1 = (i7 % i4);\n+                            iArr[i4 + 1] = (12 \/ i2);\n+                        } catch (ArithmeticException a_e) {}\n+                        break;\n+                    case 170:\n+                        f += (((i6 * i1) + i4) - i5);\n+                    case 404:\n+                        i5 += (i6 ^ TestVerifyLoopOptimizationsHighMemUsage.instanceCount);\n+                        break;\n+                    case 74:\n+                    case 370:\n+                    case 211:\n+                        i5 += i6;\n+                        break;\n+                    case 359:\n+                        TestVerifyLoopOptimizationsHighMemUsage.instanceCount += (-11 + (i6 * i6));\n+                    case 345:\n+                        f -= i4;\n+                        break;\n+                    case 238:\n+                        TestVerifyLoopOptimizationsHighMemUsage.instanceCount *= i6;\n+                    case 123:\n+                        i5 <<= i7;\n+                        break;\n+                    case 236:\n+                        if (i4 != 0) {\n+                        }\n+                        break;\n+                    case 61:\n+                        TestVerifyLoopOptimizationsHighMemUsage.instanceCount = i7;\n+                        break;\n+                    case 302:\n+                        if (bFld) continue;\n+                    case 231:\n+                        try {\n+                            i5 = (i2 \/ i5);\n+                            i1 = (-40725 \/ iArr[i4 + 1]);\n+                            i3 = (-1719830216 % iFld);\n+                        } catch (ArithmeticException a_e) {}\n+                        break;\n+                    case 340:\n+                        i3 += i1;\n+                        break;\n+                    case 162:\n+                        f += (-12 + (i6 * i6));\n+                        break;\n+                    case 252:\n+                        i7 |= i2;\n+                        break;\n+                    case 58:\n+                        bArr[i6] = bFld;\n+                        break;\n+                    case 251:\n+                        i7 += (int)d;\n+                        break;\n+                    case 179:\n+                        f += (((i6 * TestVerifyLoopOptimizationsHighMemUsage.sFld) + i4) - iFld);\n+                        break;\n+                    case 403:\n+                        iArr[i6 + 1] += iFld;\n+                        break;\n+                    case 78:\n+                        f *= TestVerifyLoopOptimizationsHighMemUsage.instanceCount;\n+                        break;\n+                    case 396:\n+                        byFld -= (byte)i4;\n+                        break;\n+                    case 301:\n+                        TestVerifyLoopOptimizationsHighMemUsage.instanceCount += (-48773 + (i6 * i6));\n+                        break;\n+                    case 378:\n+                        i7 -= (int)150L;\n+                        break;\n+                    case 244:\n+                        i5 += (((i6 * TestVerifyLoopOptimizationsHighMemUsage.instanceCount) + TestVerifyLoopOptimizationsHighMemUsage.instanceCount) - i2);\n+                    case 133:\n+                        if (iFld != 0) {\n+                        }\n+                        break;\n+                    case 391:\n+                        i3 += i6;\n+                    case 152:\n+                        lArr[i2 + 1] += i2;\n+                        break;\n+                    }\n+                }\n+            }\n+        }\n+        long meth_res = i1 + i2 + i3 + i4 + i5 + i6 + i7 + Float.floatToIntBits(f) + Double.doubleToLongBits(d) +\n+            Double.doubleToLongBits(d1)\n+            + checkSum(iArr)\n+            + checkSum(lArr)\n+            ;\n+        return (long)meth_res;\n+    }\n+\n+    public static long checkSum(int[] a) {\n+        long sum = 0;\n+        for (int j = 0; j < a.length; j++) {\n+            sum += (a[j] \/ (j + 1) + a[j] % (j + 1));\n+        }\n+        return sum;\n+    }\n+\n+    public static long checkSum(long[] a) {\n+        long sum = 0;\n+        for (int j = 0; j < a.length; j++) {\n+            sum += (a[j] \/ (j + 1) + a[j] % (j + 1));\n+        }\n+        return sum;\n+    }\n+\n+    public static void main(String[] strArr) {\n+        TestVerifyLoopOptimizationsHighMemUsage _instance = new TestVerifyLoopOptimizationsHighMemUsage();\n+        for (int i = 0; i < 10; i++ ) {\n+            _instance.lMeth(-159);\n+        }\n+    }\n+}\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/TestVerifyLoopOptimizationsHighMemUsage.java","additions":332,"deletions":0,"binary":false,"changes":332,"status":"added"}]}