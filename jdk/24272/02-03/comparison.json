{"files":[{"patch":"@@ -26,0 +26,2 @@\n+#include \"runtime\/javaThread.hpp\"\n+#include \"runtime\/mutexLocker.hpp\"\n@@ -28,0 +30,26 @@\n+Thread* AOTClassFilter::_filtering_thread = nullptr;\n+\n+AOTClassFilter::FilterMark::FilterMark() {\n+  MutexLocker ml(DumpTimeTable_lock, Mutex::_no_safepoint_check_flag);\n+  assert(_current_mark == nullptr &&_filtering_thread == nullptr,\n+         \"impl note: we support only a single AOTClassFilter used by a single thread\");\n+  _current_mark = this;\n+  _filtering_thread = Thread::current();\n+}\n+\n+AOTClassFilter::FilterMark::~FilterMark() {\n+  MutexLocker ml(DumpTimeTable_lock, Mutex::_no_safepoint_check_flag);\n+  assert(_current_mark == this && _filtering_thread == Thread::current(), \"sanity\");\n+  _current_mark = nullptr;\n+  _filtering_thread = nullptr;\n+}\n+\n+\/\/ Is called only from SystemDictionaryShared::init_dumptime_info(), which holds DumpTimeTable_lock\n+bool AOTClassFilter::is_aot_tooling_class(InstanceKlass* ik) {\n+  assert_lock_strong(DumpTimeTable_lock);\n+  if (_current_mark == nullptr || _filtering_thread != Thread::current()) {\n+    return false;\n+  } else {\n+    return _current_mark->is_aot_tooling_class(ik);\n+  }\n+}\n","filename":"src\/hotspot\/share\/cds\/aotClassFilter.cpp","additions":28,"deletions":0,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -29,1 +29,0 @@\n-#include \"runtime\/atomic.hpp\"\n@@ -33,1 +32,1 @@\n-class JavaThread;\n+class Thread;\n@@ -46,9 +45,2 @@\n-    FilterMark() {\n-      FilterMark* old_mark = Atomic::cmpxchg(&_current_mark, (FilterMark*)nullptr, this);\n-      assert(old_mark == nullptr, \"impl note: we support only a single AOTClassFilter used by a single thread\");\n-    }\n-    ~FilterMark() {\n-      FilterMark* old_mark = Atomic::cmpxchg(&_current_mark, this, (FilterMark*)nullptr);\n-      assert(old_mark == this, \"sanity\");\n-    }\n-\n+    FilterMark();\n+    ~FilterMark();\n@@ -60,3 +52,1 @@\n-  static bool is_aot_tooling_class(InstanceKlass* ik) {\n-    return (_current_mark == nullptr) ? false : _current_mark->is_aot_tooling_class(ik);\n-  }\n+  static bool is_aot_tooling_class(InstanceKlass* ik);\n@@ -67,0 +57,1 @@\n+  static Thread* _filtering_thread;\n","filename":"src\/hotspot\/share\/cds\/aotClassFilter.hpp","additions":5,"deletions":14,"binary":false,"changes":19,"status":"modified"}]}