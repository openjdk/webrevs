{"files":[{"patch":"@@ -135,1 +135,1 @@\n-        if (c >= 'A' && c <= 'Z') {\n+        if (!(c == '\\r' || c == '\\n' || (c >= 'a' && c <= 'z'))) {\n@@ -150,1 +150,1 @@\n-        \/\/ Normalize the first `char`\n+        \/\/ Upper-case the first `char`\n@@ -157,1 +157,3 @@\n-            cs[0] = (char) (c - o);\n+            if (c >= 'a' && c <= 'z') {\n+                cs[0] = (char) (c - o);\n+            }\n@@ -161,1 +163,1 @@\n-        \/\/ Normalize the secondary `char`s\n+        \/\/ Lower-case the secondary `char`s\n","filename":"src\/jdk.httpserver\/share\/classes\/com\/sun\/net\/httpserver\/Headers.java","additions":6,"deletions":4,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -52,0 +52,3 @@\n+import java.util.stream.IntStream;\n+import java.util.stream.Stream;\n+\n@@ -65,0 +68,2 @@\n+import static org.testng.Assert.assertNotSame;\n+import static org.testng.Assert.assertSame;\n@@ -453,0 +458,76 @@\n+    @Test\n+    public static void testNormalizeOnNull() {\n+        assertThrows(NullPointerException.class, () -> normalize(null));\n+    }\n+\n+    @DataProvider\n+    public static Object[][] illegalKeys() {\n+        var illegalChars = List.of('\\r', '\\n');\n+        var illegalStrings = Stream\n+                \/\/ Insert an illegal char at every possible position of following strings\n+                .of(\"Ab\", \"ab\", \"_a\", \"2a\")\n+                .flatMap(s -> IntStream\n+                        .range(0, s.length() + 1)\n+                        .boxed()\n+                        .flatMap(i -> illegalChars\n+                                .stream()\n+                                .map(c -> s.substring(0, i) + c + s.substring(i))));\n+        return Stream\n+                .concat(illegalChars.stream().map(c -> \"\" + c), illegalStrings)\n+                .map(s -> new Object[]{s})\n+                .toArray(Object[][]::new);\n+    }\n+\n+    @Test(dataProvider = \"illegalKeys\")\n+    public static void testNormalizeOnIllegalKeys(String illegalKey) {\n+        assertThrows(IllegalArgumentException.class, () -> normalize(illegalKey));\n+    }\n+\n+    @DataProvider\n+    public static Object[][] normalizedKeys() {\n+        return new Object[][]{\n+                \/\/ Empty string\n+                {\"\"},\n+                \/\/ Non-alpha prefix\n+                {\"_\"},\n+                {\"0\"},\n+                {\"_xy-@\"},\n+                {\"0xy-@\"},\n+                \/\/ Upper-case prefix\n+                {\"A\"},\n+                {\"B\"},\n+                {\"Ayz-@\"},\n+                {\"Byz-@\"},\n+        };\n+    }\n+\n+    @Test(dataProvider = \"normalizedKeys\")\n+    public static void testNormalizeOnNormalizedKeys(String normalizedKey) {\n+        \/\/ Verify that the fast-path is taken\n+        assertSame(normalize(normalizedKey), normalizedKey);\n+    }\n+\n+    @DataProvider\n+    public static Object[][] notNormalizedKeys() {\n+        return new Object[][]{\n+                {\"a\"},\n+                {\"b\"},\n+                {\"axy-@\"},\n+                {\"bxy-@\"},\n+        };\n+    }\n+\n+    @Test(dataProvider = \"notNormalizedKeys\")\n+    public static void testNormalizeOnNotNormalizedKeys(String notNormalizedKey) {\n+        var normalizedKey = normalize(notNormalizedKey);\n+        \/\/ Verify that the fast-path is *not* taken\n+        assertNotSame(normalizedKey, notNormalizedKey);\n+        \/\/ Verify the result\n+        var expectedNormalizedKey = normalizedKey.substring(0, 1).toUpperCase() + normalizedKey.substring(1);\n+        assertEquals(normalizedKey, expectedNormalizedKey);\n+    }\n+\n+    private static String normalize(String key) {\n+        return Headers.of(key, \"foo\").keySet().iterator().next();\n+    }\n+\n","filename":"test\/jdk\/com\/sun\/net\/httpserver\/HeadersTest.java","additions":82,"deletions":1,"binary":false,"changes":83,"status":"modified"},{"patch":"@@ -79,0 +79,1 @@\n+            \"4ccept-charset\",   \/\/ Already normalized with a non-alpha first letter\n","filename":"test\/micro\/org\/openjdk\/bench\/sun\/net\/httpserver\/HeaderNormalization.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}