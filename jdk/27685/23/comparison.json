{"files":[{"patch":"@@ -31,0 +31,1 @@\n+#include \"sanitizers\/address.hpp\"\n@@ -53,0 +54,1 @@\n+    asan_unpoison_self();\n@@ -62,0 +64,1 @@\n+    asan_poison_self();\n","filename":"src\/hotspot\/share\/nmt\/mallocHeader.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -30,0 +30,1 @@\n+#include \"sanitizers\/address.hpp\"\n@@ -89,1 +90,0 @@\n-\n@@ -113,3 +113,8 @@\n-  uint8_t* footer_address() const   { return ((address)this) + sizeof(MallocHeader) + _size; }\n-  uint16_t get_footer() const       { return build_footer(footer_address()[0], footer_address()[1]); }\n-  void set_footer(uint16_t v)       { footer_address()[0] = (uint8_t)(v >> 8); footer_address()[1] = (uint8_t)v; }\n+  uint16_t get_footer() const {\n+    return build_footer(footer_address()[0], footer_address()[1]);\n+  }\n+\n+  void set_footer(uint16_t v) {\n+    footer_address()[0] = (uint8_t)(v >> 8);\n+    footer_address()[1] = (uint8_t)v;\n+  }\n@@ -120,0 +125,8 @@\n+  #ifndef _LP64\n+  inline uint32_t alt_canary() const { return _alt_canary; }\n+  inline void set_alt_canary(uint32_t value) { _alt_canary = value; }\n+  #endif\n+\n+  inline void set_header_canary(uint16_t value) { _canary = value; }\n+  inline uint16_t canary() const { return _canary; }\n+\n@@ -121,0 +134,12 @@\n+  void asan_poison_self() const {\n+    AsanPoisoningHelper::poison_memory(footer_address(), sizeof(uint16_t)); \/\/ don't change the order\n+    AsanPoisoningHelper::poison_memory(this, sizeof(MallocHeader));\n+  }\n+\n+  void asan_unpoison_self() const {\n+    AsanPoisoningHelper::unpoison_memory(this, sizeof(MallocHeader));\n+    AsanPoisoningHelper::unpoison_memory(footer_address(), sizeof(uint16_t));\n+  }\n+\n+  uint8_t* footer_address() const { return ((address)this) + sizeof(MallocHeader) + size(); }\n+\n@@ -131,1 +156,2 @@\n-  inline size_t size()  const { return _size; }\n+  inline size_t size() const { return _size; }\n+\n@@ -142,3 +168,2 @@\n-\n-  bool is_dead() const { return _canary == _header_canary_dead_mark; }\n-  bool is_live() const { return _canary == _header_canary_live_mark; }\n+  bool is_dead() const { return canary() == _header_canary_dead_mark; }\n+  bool is_live() const { return canary() == _header_canary_live_mark; }\n","filename":"src\/hotspot\/share\/nmt\/mallocHeader.hpp","additions":34,"deletions":9,"binary":false,"changes":43,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,2 +38,2 @@\n-  : _size(size), _mst_marker(mst_marker), _mem_tag(mem_tag),\n-    _unused(0), _canary(_header_canary_live_mark)\n+  : _size(size), _mst_marker(mst_marker), _mem_tag(mem_tag), _unused(0),\n+   _canary(_header_canary_live_mark)\n@@ -44,1 +44,1 @@\n-  NOT_LP64(_alt_canary = _header_alt_canary_live_mark;)\n+  NOT_LP64(set_alt_canary(_header_alt_canary_live_mark);)\n@@ -46,0 +46,1 @@\n+  asan_poison_self();\n@@ -49,1 +50,1 @@\n-  assert(_canary == _header_canary_dead_mark, \"must be dead\");\n+  assert(canary() == _header_canary_dead_mark, \"must be dead\");\n@@ -51,3 +52,3 @@\n-  NOT_LP64(assert(_alt_canary == _header_alt_canary_dead_mark, \"must be dead\"));\n-  _canary = _header_canary_live_mark;\n-  NOT_LP64(_alt_canary = _header_alt_canary_live_mark);\n+  NOT_LP64(assert(alt_canary() == _header_alt_canary_dead_mark, \"must be dead\"));\n+  set_header_canary(_header_canary_live_mark);\n+  NOT_LP64(set_alt_canary(_header_alt_canary_live_mark);)\n@@ -55,0 +56,1 @@\n+  asan_poison_self();\n@@ -59,2 +61,3 @@\n-  _canary = _header_canary_dead_mark;\n-  NOT_LP64(_alt_canary = _header_alt_canary_dead_mark);\n+  asan_unpoison_self();\n+  set_header_canary(_header_canary_dead_mark);\n+  NOT_LP64(set_alt_canary(_header_alt_canary_dead_mark);)\n@@ -124,3 +127,3 @@\n-  return ( (_canary == _header_canary_live_mark NOT_LP64(&& _alt_canary == _header_alt_canary_live_mark)) ||\n-           (_canary == _header_canary_dead_mark NOT_LP64(&& _alt_canary == _header_alt_canary_dead_mark)) ) &&\n-           _size > 0 && _size < max_reasonable_malloc_size;\n+  return ( (canary() == _header_canary_live_mark NOT_LP64(&& alt_canary() == _header_alt_canary_live_mark)) ||\n+           (canary() == _header_canary_dead_mark NOT_LP64(&& alt_canary() == _header_alt_canary_dead_mark)) ) &&\n+           size() > 0 && size() < max_reasonable_malloc_size;\n@@ -133,0 +136,3 @@\n+  AsanPoisoningHelper aph_header(this, sizeof(MallocHeader));\n+  AsanPoisoningHelper aph_footer(footer_address(), sizeof(_canary));\n+\n@@ -134,1 +140,1 @@\n-  if (_canary != _header_canary_live_mark) {\n+  if (canary() != _header_canary_live_mark) {\n@@ -142,1 +148,1 @@\n-  if (_alt_canary != _header_alt_canary_live_mark) {\n+  if (alt_canary() != _header_alt_canary_live_mark) {\n@@ -150,1 +156,1 @@\n-  if (_size >= max_reasonable_malloc_size) {\n+  if (size() >= max_reasonable_malloc_size) {\n","filename":"src\/hotspot\/share\/nmt\/mallocHeader.inline.hpp","additions":22,"deletions":16,"binary":false,"changes":38,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+#include \"sanitizers\/address.hpp\"\n@@ -198,0 +199,1 @@\n+    AsanPoisoningHelper aph(header2, sizeof(MallocHeader));\n@@ -212,0 +214,1 @@\n+  header->asan_unpoison_self();\n","filename":"src\/hotspot\/share\/nmt\/mallocTracker.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -710,1 +710,3 @@\n-    const size_t old_size = MallocTracker::malloc_header(memblock)->size();\n+    MallocHeader* header = MallocTracker::malloc_header(memblock);\n+    header->asan_unpoison_self();\n+    const size_t old_size = header->size();\n@@ -714,0 +716,1 @@\n+      header->asan_poison_self();\/\/ keep current header poisoned when realloc failed\n@@ -717,3 +720,2 @@\n-    \/\/ Perform integrity checks on and mark the old block as dead *before* calling the real realloc(3) since it\n-    \/\/ may invalidate the old block, including its header.\n-    MallocHeader* header = MallocHeader::resolve_checked(memblock);\n+    \/\/ resolve_checked() will poison the header on return. Get FreeInfo and mem_tag here to avoid unpoisoning again.\n+    const MallocHeader::FreeInfo free_info = header->free_info();\n@@ -722,1 +724,4 @@\n-    const MallocHeader::FreeInfo free_info = header->free_info();\n+\n+    \/\/ Perform integrity checks on and mark the old block as dead *before* calling the real realloc(3) since it\n+    \/\/ may invalidate the old block, including its header.\n+    header = MallocHeader::resolve_checked(memblock);\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -79,0 +79,36 @@\n+\n+#ifdef ADDRESS_SANITIZER\n+\/\/ This class uses RAII to temproraily unpoison a memory block.\n+\/\/ Note that on dtor the memory block will be poisoned, regardless of its original un-\/poisoned state.\n+\/\/ General un\/poisoning API are provided too.\n+class AsanPoisoningHelper {\n+  const void* _memory_region;\n+  const size_t _size;\n+ public:\n+  AsanPoisoningHelper() = delete;\n+  AsanPoisoningHelper(const void* addr, const size_t size) : _memory_region(addr), _size(size) {\n+    ASAN_UNPOISON_MEMORY_REGION(_memory_region, _size);\n+  }\n+  ~AsanPoisoningHelper() {\n+    ASAN_POISON_MEMORY_REGION(_memory_region, _size);\n+  }\n+  static void poison_memory(const void* addr, const size_t size) {\n+    ASAN_POISON_MEMORY_REGION(addr, size);\n+  }\n+  static void unpoison_memory(const void* addr, size_t size) {\n+    ASAN_UNPOISON_MEMORY_REGION(addr, size);\n+  }\n+};\n+\n+#else\n+\n+class AsanPoisoningHelper {\n+ public:\n+  AsanPoisoningHelper() = delete;\n+  AsanPoisoningHelper(const void* addr, const size_t size) {}\n+  ~AsanPoisoningHelper() { }\n+  static void poison_memory(const void* addr, const size_t size) { }\n+  static void unpoison_memory(const void* addr, size_t size) { }\n+};\n+#endif\n+\n","filename":"src\/hotspot\/share\/sanitizers\/address.hpp","additions":36,"deletions":0,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -32,1 +32,0 @@\n-#include \"unittest.hpp\"\n@@ -34,2 +33,1 @@\n-\n-#if !INCLUDE_ASAN\n+#include \"unittest.hpp\"\n@@ -55,0 +53,2 @@\n+#if !INCLUDE_ASAN\n+\n@@ -183,5 +183,7 @@\n-TEST_VM_FATAL_ERROR_MSG(NMT, memory_corruption_call_stack, \".*header canary.*\") {\n-  if (MemTracker::tracking_level() != NMT_detail) {\n-    guarantee(false, \"fake message ignore this - header canary\");\n-  }\n-  const size_t SIZE = 1024;\n+#else \/\/ ASAN is enabled\n+\n+#define DEFINE_ASAN_TEST(test_function)  \\\n+  DEFINE_TEST(test_function, \".*AddressSanitizer.*\")\n+\n+static void test_write_header() {\n+  const size_t SIZE = 10;\n@@ -189,2 +191,34 @@\n-  *(p - 1) = 0;\n-  os::free(p);\n+  uint16_t* canary_ptr = (uint16_t*)((char*)p - sizeof(uint16_t));\n+  *canary_ptr = 1;\n+}\n+\n+static void test_read_header() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  uint16_t* canary_ptr = (uint16_t*)((char*)p - sizeof(uint16_t));\n+  uint16_t read_canary = 0;\n+  read_canary = *canary_ptr;\n+}\n+\n+static void test_write_footer() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n+  uint16_t* footer_ptr = (uint16_t*)(mh->footer_address());\n+  *footer_ptr = 1;\n+}\n+\n+static void test_read_footer() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n+  uint16_t* footer_ptr = (uint16_t*)(mh->footer_address());\n+  uint16_t read_footer = *footer_ptr;\n+}\n+\n+static void test_write_header_after_realloc() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  p = (char*)os::realloc(p, 2 * SIZE, mtTest);\n+  uint16_t* canary_ptr = (uint16_t*)((char*)p - sizeof(uint16_t));\n+  *canary_ptr = 1;\n@@ -193,0 +227,67 @@\n+static void test_read_header_after_realloc() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  p = (char*)os::realloc(p, 2 * SIZE, mtTest);\n+  uint16_t* canary_ptr = (uint16_t*)((char*)p - sizeof(uint16_t));\n+  uint16_t read_canary = 0;\n+  read_canary = *canary_ptr;\n+}\n+\n+static void test_write_footer_after_realloc() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  p = (char*)os::realloc(p, 2 * SIZE, mtTest);\n+  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n+  uint16_t* footer_ptr = (uint16_t*)(mh->footer_address());\n+  *footer_ptr = 1;\n+}\n+\n+static void test_read_footer_after_realloc() {\n+  const size_t SIZE = 10;\n+  char* p = (char*)os::malloc(SIZE, mtTest);\n+  p = (char*)os::realloc(p, 2 * SIZE, mtTest);\n+  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n+  uint16_t* footer_ptr = (uint16_t*)(mh->footer_address());\n+  uint16_t read_footer = *footer_ptr;\n+}\n+\n+DEFINE_ASAN_TEST(test_write_header);\n+DEFINE_ASAN_TEST(test_read_header);\n+DEFINE_ASAN_TEST(test_write_footer);\n+DEFINE_ASAN_TEST(test_read_footer);\n+DEFINE_ASAN_TEST(test_write_header_after_realloc);\n+DEFINE_ASAN_TEST(test_read_header_after_realloc);\n+DEFINE_ASAN_TEST(test_write_footer_after_realloc);\n+DEFINE_ASAN_TEST(test_read_footer_after_realloc);\n+\n+static void test_poison_local() {\n+  uint16_t a;\n+  ASAN_POISON_MEMORY_REGION(&a, sizeof(a));\n+  a = 2;\n+}\n+\n+DEFINE_ASAN_TEST(test_poison_local);\n+\n+TEST_VM(NMT_ASAN, test_unpoison_temporarily_no_death) {\n+  uint16_t a;\n+  ASAN_POISON_MEMORY_REGION(&a, sizeof(a));\n+  {\n+    AsanPoisoningHelper aph(&a, sizeof(a));\n+    a = 2;\n+    EXPECT_EQ(a, 2);\n+  }\n+}\n+\n+static void test_unpoison_temporarily() {\n+  uint16_t a;\n+  ASAN_POISON_MEMORY_REGION(&a, sizeof(a));\n+  {\n+    AsanPoisoningHelper aph(&a, sizeof(a));\n+    a = 2;\n+    EXPECT_EQ(a, 2);\n+  }\n+  a = 3;\n+}\n+\n+DEFINE_ASAN_TEST(test_unpoison_temporarily);\n+\n","filename":"test\/hotspot\/gtest\/nmt\/test_nmt_buffer_overflow_detection.cpp","additions":111,"deletions":10,"binary":false,"changes":121,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+  hdr->asan_unpoison_self();\n","filename":"test\/hotspot\/gtest\/nmt\/test_nmt_cornercases.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}