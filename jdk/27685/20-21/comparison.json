{"files":[{"patch":"@@ -31,0 +31,1 @@\n+#include \"sanitizers\/address.hpp\"\n@@ -53,0 +54,1 @@\n+    asan_unpoison_self();\n@@ -62,0 +64,1 @@\n+    asan_poison_self();\n","filename":"src\/hotspot\/share\/nmt\/mallocHeader.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -114,1 +114,0 @@\n-    AsanPoisoningHelper aph(reinterpret_cast<uint16_t*>(footer_address()));\n@@ -119,1 +118,0 @@\n-    AsanPoisoningHelper aph(reinterpret_cast<uint16_t*>(footer_address()));\n@@ -127,14 +125,0 @@\n-  void asan_poison_self() {\n-      AsanPoisoningHelper<uint16_t>::poison_memory(&_canary);\n-      AsanPoisoningHelper<uint16_t>::poison_memory(reinterpret_cast<uint16_t*>(footer_address()));\n-      AsanPoisoningHelper<size_t>::poison_memory(&_size);\n-      NOT_LP64(AsanPoisoningHelper<uint32_t>::poison_memory(&_alt_canary));\n-  }\n-\n-  void asan_unpoison_self() {\n-      AsanPoisoningHelper<uint16_t>::unpoison_memory(&_canary);\n-      AsanPoisoningHelper<uint16_t>::unpoison_memory(reinterpret_cast<uint16_t*>(footer_address()));\n-      AsanPoisoningHelper<size_t>::unpoison_memory(&_size);\n-      NOT_LP64(AsanPoisoningHelper<uint32_t>::unpoison_memory(&_alt_canary));\n-  }\n-\n@@ -142,9 +126,2 @@\n-  inline uint32_t alt_canary() const {\n-    AsanPoisoningHelper aph(&_alt_canary);\n-    return _alt_canary;\n-  }\n-\n-  inline void set_alt_canary(uint32_t value) {\n-    AsanPoisoningHelper aph(&_alt_canary);\n-      _alt_canary = value;\n-  }\n+  inline uint32_t alt_canary() const { return _alt_canary; }\n+  inline void set_alt_canary(uint32_t value) { _alt_canary = value; }\n@@ -153,4 +130,7 @@\n-  inline void set_header_canary(uint16_t value) {\n-    \/\/ _canary is unpoisoned until aph dtor is called\n-    AsanPoisoningHelper aph(&_canary);\n-    _canary = value;\n+  inline void set_header_canary(uint16_t value) { _canary = value; }\n+  inline uint16_t canary() const { return _canary; }\n+\n+public:\n+  void asan_poison_self() const {\n+    AsanPoisoningHelper::poison_memory(footer_address(), sizeof(uint16_t)); \/\/ don't change the order\n+    AsanPoisoningHelper::poison_memory(this, sizeof(MallocHeader));\n@@ -159,3 +139,3 @@\n-  inline uint16_t canary() const {\n-    AsanPoisoningHelper aph(&_canary);\n-    return _canary;\n+  void asan_unpoison_self() const {\n+    AsanPoisoningHelper::unpoison_memory(this, sizeof(MallocHeader));\n+    AsanPoisoningHelper::unpoison_memory(footer_address(), sizeof(uint16_t));\n@@ -164,1 +144,0 @@\n-public:\n@@ -177,4 +156,1 @@\n-  inline size_t size() const {\n-    AsanPoisoningHelper aph(&_size);\n-    return _size;\n-  }\n+  inline size_t size() const { return _size; }\n","filename":"src\/hotspot\/share\/nmt\/mallocHeader.hpp","additions":13,"deletions":37,"binary":false,"changes":50,"status":"modified"},{"patch":"@@ -136,0 +136,3 @@\n+  AsanPoisoningHelper aph_header(this, sizeof(MallocHeader));\n+  AsanPoisoningHelper aph_footer(footer_address(), sizeof(_canary));\n+\n","filename":"src\/hotspot\/share\/nmt\/mallocHeader.inline.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -199,0 +199,1 @@\n+    AsanPoisoningHelper aph(header2, sizeof(MallocHeader));\n@@ -213,0 +214,1 @@\n+  header->asan_unpoison_self();\n","filename":"src\/hotspot\/share\/nmt\/mallocTracker.cpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -710,1 +710,3 @@\n-    const size_t old_size = MallocTracker::malloc_header(memblock)->size();\n+    MallocHeader* header = MallocTracker::malloc_header(memblock);\n+    header->asan_unpoison_self();\n+    const size_t old_size = header->size();\n@@ -714,0 +716,1 @@\n+      header->asan_poison_self();\/\/ keep current header poisoned when realloc failed\n@@ -717,3 +720,2 @@\n-    \/\/ Perform integrity checks on and mark the old block as dead *before* calling the real realloc(3) since it\n-    \/\/ may invalidate the old block, including its header.\n-    MallocHeader* header = MallocHeader::resolve_checked(memblock);\n+    \/\/ resolve_checked() will poison the header on return. Get FreeInfo and mem_tag here to avoid unpoisoning again.\n+    const MallocHeader::FreeInfo free_info = header->free_info();\n@@ -722,1 +724,4 @@\n-    const MallocHeader::FreeInfo free_info = header->free_info();\n+\n+    \/\/ Perform integrity checks on and mark the old block as dead *before* calling the real realloc(3) since it\n+    \/\/ may invalidate the old block, including its header.\n+    header = MallocHeader::resolve_checked(memblock);\n","filename":"src\/hotspot\/share\/runtime\/os.cpp","additions":10,"deletions":5,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -79,1 +79,5 @@\n-template<typename T>\n+\n+#ifdef ADDRESS_SANITIZER\n+\/\/ This class uses RAII to temproraily unpoison a memory block.\n+\/\/ Note that on dtor the memory block will be poisoned, regardless of its original un-\/poisoned state.\n+\/\/ General un\/poisoning API are provided too.\n@@ -81,1 +85,2 @@\n-  const T* _memory_region;\n+  const void* _memory_region;\n+  const size_t _size;\n@@ -84,4 +89,2 @@\n-  AsanPoisoningHelper(const T* addr) : _memory_region(addr) {\n-    #if INCLUDE_ASAN\n-      ASAN_UNPOISON_MEMORY_REGION(_memory_region, sizeof(T));\n-    #endif\n+  AsanPoisoningHelper(const void* addr, const size_t size) : _memory_region(addr), _size(size) {\n+    ASAN_UNPOISON_MEMORY_REGION(_memory_region, _size);\n@@ -90,3 +93,1 @@\n-    #if INCLUDE_ASAN\n-      ASAN_POISON_MEMORY_REGION(_memory_region, sizeof(T));\n-    #endif\n+    ASAN_POISON_MEMORY_REGION(_memory_region, _size);\n@@ -94,4 +95,2 @@\n-  static void poison_memory(const T* addr) {\n-    #if INCLUDE_ASAN\n-      ASAN_POISON_MEMORY_REGION(addr, sizeof(T));\n-    #endif\n+  static void poison_memory(const void* addr, const size_t size) {\n+    ASAN_POISON_MEMORY_REGION(addr, size);\n@@ -99,4 +98,2 @@\n-  static void unpoison_memory(const T* addr) {\n-    #if INCLUDE_ASAN\n-      ASAN_UNPOISON_MEMORY_REGION(addr, sizeof(T));\n-    #endif\n+  static void unpoison_memory(const void* addr, size_t size) {\n+    ASAN_UNPOISON_MEMORY_REGION(addr, size);\n@@ -106,0 +103,12 @@\n+#elif\n+\n+class AsanPoisoningHelper {\n+ public:\n+  AsanPoisoningHelper() = delete;\n+  AsanPoisoningHelper(const void* addr, const size_t size) {}\n+  ~AsanPoisoningHelper() { }\n+  static void poison_memory(const void* addr, const size_t size) { }\n+  static void unpoison_memory(const void* addr, size_t size) { }\n+};\n+#endif\n+\n","filename":"src\/hotspot\/share\/sanitizers\/address.hpp","additions":26,"deletions":17,"binary":false,"changes":43,"status":"modified"},{"patch":"@@ -35,2 +35,0 @@\n-#if !INCLUDE_ASAN\n-\n@@ -55,0 +53,2 @@\n+#if !INCLUDE_ASAN\n+\n@@ -185,10 +185,2 @@\n-#define DEFINE_ASAN_TEST(test_function)                                                   \\\n-  TEST_VM_FATAL_ERROR_MSG(NMT_ASAN, test_function, \".*AddressSanitizer.*\") {              \\\n-    if (MemTracker::tracking_level() > NMT_off) {                                         \\\n-      test_function ();                                                                   \\\n-    } else {                                                                              \\\n-      \/* poisoning header\/footer of memory requires NMT to be on. If off, fake assert. *\/ \\\n-      guarantee(false,                                                                    \\\n-                \"fake message ignore this - AddressSanitizer\");                           \\\n-    }                                                                                     \\\n-  }\n+#define DEFINE_ASAN_TEST(test_function)  \\\n+  DEFINE_TEST(test_function, \".*AddressSanitizer.*\")\n@@ -196,1 +188,1 @@\n-static void test_write_canary() {\n+static void test_write_header() {\n@@ -203,1 +195,1 @@\n-static void test_read_canary() {\n+static void test_read_header() {\n@@ -227,17 +219,1 @@\n-static void test_write_size() {\n-  const size_t SIZE = 10;\n-  char* p = (char*)os::malloc(SIZE, mtTest);\n-  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n-  size_t* size_ptr = (size_t*)(mh NOT_LP64(+ sizeof(uint32_t)));\n-  *size_ptr = 1;\n-}\n-\n-static void test_read_size() {\n-  const size_t SIZE = 10;\n-  char* p = (char*)os::malloc(SIZE, mtTest);\n-  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n-  size_t* size_ptr = (size_t*)(mh NOT_LP64(+ sizeof(uint32_t)));\n-  size_t read_size = *size_ptr;\n-}\n-\n-static void test_write_canary_after_realloc() {\n+static void test_write_header_after_realloc() {\n@@ -251,1 +227,1 @@\n-static void test_read_canary_after_realloc() {\n+static void test_read_header_after_realloc() {\n@@ -278,21 +254,2 @@\n-static void test_write_size_after_realloc() {\n-  const size_t SIZE = 10;\n-  char* p = (char*)os::malloc(SIZE, mtTest);\n-  p = (char*)os::realloc(p, 2 * SIZE, mtTest);\n-  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n-  size_t* size_ptr = (size_t*)(mh NOT_LP64(+ sizeof(uint32_t)));\n-  *size_ptr = 1;\n-}\n-\n-static void test_read_size_after_realloc() {\n-  const size_t SIZE = 10;\n-  char* p = (char*)os::malloc(SIZE, mtTest);\n-  p = (char*)os::realloc(p, 2 * SIZE, mtTest);\n-  MallocHeader* mh = (MallocHeader*)(p - sizeof(MallocHeader));\n-  size_t* size_ptr = (size_t*)(mh NOT_LP64(+ sizeof(uint32_t)));\n-  size_t read_size = *size_ptr;\n-}\n-\n-\n-DEFINE_ASAN_TEST(test_write_canary);\n-DEFINE_ASAN_TEST(test_read_canary);\n+DEFINE_ASAN_TEST(test_write_header);\n+DEFINE_ASAN_TEST(test_read_header);\n@@ -301,4 +258,2 @@\n-DEFINE_ASAN_TEST(test_write_size);\n-DEFINE_ASAN_TEST(test_read_size);\n-DEFINE_ASAN_TEST(test_write_canary_after_realloc);\n-DEFINE_ASAN_TEST(test_read_canary_after_realloc);\n+DEFINE_ASAN_TEST(test_write_header_after_realloc);\n+DEFINE_ASAN_TEST(test_read_header_after_realloc);\n@@ -307,2 +262,0 @@\n-DEFINE_ASAN_TEST(test_write_size_after_realloc);\n-DEFINE_ASAN_TEST(test_read_size_after_realloc);\n@@ -322,1 +275,1 @@\n-    AsanPoisoningHelper<uint16_t> aph(&a);\n+    AsanPoisoningHelper aph(&a, sizeof(a));\n@@ -332,1 +285,1 @@\n-    AsanPoisoningHelper<uint16_t> aph(&a);\n+    AsanPoisoningHelper aph(&a, sizeof(a));\n","filename":"test\/hotspot\/gtest\/nmt\/test_nmt_buffer_overflow_detection.cpp","additions":14,"deletions":61,"binary":false,"changes":75,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+  hdr->asan_unpoison_self();\n","filename":"test\/hotspot\/gtest\/nmt\/test_nmt_cornercases.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}