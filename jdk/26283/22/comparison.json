{"files":[{"patch":"@@ -2459,0 +2459,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/aarch64\/aarch64.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1066,0 +1066,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/arm\/arm.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2386,0 +2386,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/ppc\/ppc.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2056,0 +2056,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/riscv\/riscv.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1868,0 +1868,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/s390\/s390.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2636,0 +2636,64 @@\n+static bool is_ndd_demotable(const MachNode* mdef) {\n+  return ((mdef->flags() & Node::PD::Flag_ndd_demotable) != 0);\n+}\n+\n+static bool is_ndd_demotable_commutative(const MachNode* mdef) {\n+  return ((mdef->flags() & Node::PD::Flag_ndd_demotable_commutative) != 0);\n+}\n+\n+static bool is_demotion_candidate(const MachNode* mdef) {\n+  return (is_ndd_demotable(mdef) || is_ndd_demotable_commutative(mdef));\n+}\n+\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef,\n+                                            int oper_index) {\n+  if (mdef == nullptr) {\n+    return false;\n+  }\n+\n+  if (mdef->num_opnds() <= oper_index || mdef->operand_index(oper_index) < 0 ||\n+      mdef->in(mdef->operand_index(oper_index)) == nullptr) {\n+    assert(oper_index != 1 || !is_demotion_candidate(mdef), \"%s\", mdef->Name());\n+    assert(oper_index != 2 || !is_ndd_demotable_commutative(mdef), \"%s\", mdef->Name());\n+    return false;\n+  }\n+\n+  \/\/ Complex memory operand covers multiple incoming edges needed for\n+  \/\/ address computation. Biasing def towards any address component will not\n+  \/\/ result in NDD demotion by assembler.\n+  if (mdef->operand_num_edges(oper_index) != 1) {\n+    assert(!is_ndd_demotable(mdef), \"%s\", mdef->Name());\n+    return false;\n+  }\n+\n+  \/\/ Demotion candidate must be register mask compatible with definition.\n+  const RegMask& oper_mask = mdef->in_RegMask(mdef->operand_index(oper_index));\n+  if (!oper_mask.overlap(mdef->out_RegMask())) {\n+    assert(!is_demotion_candidate(mdef), \"%s\", mdef->Name());\n+    return false;\n+  }\n+\n+  switch (oper_index) {\n+  \/\/ First operand of MachNode corresponding to Intel APX NDD selection\n+  \/\/ pattern can share its assigned register with definition operand if\n+  \/\/ their live ranges do not overlap. In such a scenario we can demote\n+  \/\/ it to legacy map0\/map1 instruction by replacing its 4-byte extended\n+  \/\/ EVEX prefix with shorter REX\/REX2 encoding. Demotion candidates\n+  \/\/ are decorated with a special flag by instruction selector.\n+  case 1:\n+    return is_demotion_candidate(mdef);\n+\n+  \/\/ Definition operand of commutative operation can be biased towards second\n+  \/\/ operand.\n+  case 2:\n+    return is_ndd_demotable_commutative(mdef);\n+\n+  \/\/ Current scheme only selects up to two biasing candidates\n+  default:\n+    assert(false, \"unhandled operand index: %s\", mdef->Name());\n+    break;\n+  }\n+\n+  return false;\n+}\n+\n@@ -2815,1 +2879,1 @@\n-  enum NodeFlags {\n+  enum NodeFlags : uint64_t {\n@@ -2827,1 +2891,3 @@\n-    _last_flag                = Flag_clears_sign_flag\n+    Flag_ndd_demotable        = Node::_last_flag << 12,\n+    Flag_ndd_demotable_commutative = Node::_last_flag << 13,\n+    _last_flag                = Flag_ndd_demotable_commutative\n@@ -9804,1 +9870,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -9832,1 +9898,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -9875,1 +9941,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -9932,0 +9998,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -9986,0 +10053,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -10092,1 +10160,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -10120,1 +10188,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -10163,1 +10231,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -10219,0 +10287,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -10273,0 +10342,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -10987,1 +11057,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11001,1 +11071,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11044,1 +11114,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11102,1 +11172,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11116,1 +11186,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11159,1 +11229,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11231,1 +11301,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11259,1 +11329,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11300,1 +11370,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11328,1 +11398,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11373,0 +11443,1 @@\n+  flag(PD::Flag_ndd_demotable_commutative);\n@@ -11414,0 +11485,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11465,0 +11537,1 @@\n+  flag(PD::Flag_ndd_demotable_commutative);\n@@ -11506,0 +11579,1 @@\n+  flag(PD::Flag_ndd_demotable_commutative);\n@@ -11780,0 +11854,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11808,0 +11883,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11914,0 +11990,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12020,0 +12097,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12127,0 +12205,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12155,0 +12234,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12261,0 +12341,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12367,0 +12448,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12538,0 +12620,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12602,0 +12685,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12654,0 +12738,1 @@\n+\n@@ -12667,0 +12752,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12731,0 +12817,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12808,1 +12895,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -12901,1 +12988,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -12945,1 +13032,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13145,1 +13232,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13174,1 +13261,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13188,1 +13275,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13232,1 +13319,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13308,1 +13395,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13334,0 +13421,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -13364,1 +13452,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13410,1 +13498,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13489,1 +13577,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13545,1 +13633,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13589,1 +13677,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13792,1 +13880,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13847,1 +13935,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13861,1 +13949,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13906,1 +13994,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13985,1 +14073,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -14011,0 +14099,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -14041,1 +14130,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -14087,1 +14176,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -16542,0 +16631,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -16593,0 +16683,1 @@\n+  flag(PD::Flag_ndd_demotable);\n","filename":"src\/hotspot\/cpu\/x86\/x86.ad","additions":129,"deletions":38,"binary":false,"changes":167,"status":"modified"},{"patch":"@@ -1474,0 +1474,59 @@\n+OptoReg::Name PhaseChaitin::select_bias_lrg_color(LRG& lrg) {\n+  uint bias_lrg1_idx = _lrg_map.find(lrg._copy_bias);\n+  uint bias_lrg2_idx = _lrg_map.find(lrg._copy_bias2);\n+\n+  \/\/ If bias_lrg1 has a color\n+  if (bias_lrg1_idx != 0 && !_ifg->_yanked->test(bias_lrg1_idx)) {\n+    OptoReg::Name reg = lrgs(bias_lrg1_idx).reg();\n+    \/\/  and it is legal for lrg\n+    if (is_legal_reg(lrg, reg)) {\n+      return reg;\n+    }\n+  }\n+\n+  \/\/ If bias_lrg2 has a color\n+  if (bias_lrg2_idx != 0 && !_ifg->_yanked->test(bias_lrg2_idx)) {\n+    OptoReg::Name reg = lrgs(bias_lrg2_idx).reg();\n+    \/\/  and it is legal for lrg\n+    if (is_legal_reg(lrg, reg)) {\n+      return reg;\n+    }\n+  }\n+\n+  uint bias_lrg_idx = 0;\n+  if (bias_lrg1_idx != 0 && bias_lrg2_idx != 0) {\n+    \/\/ Since none of the bias live ranges are part of the IFG yet, constrain the\n+    \/\/ definition mask with the bias live range with the least degrees of\n+    \/\/ freedom. This will increase the chances of register sharing once the bias\n+    \/\/ live range becomes part of the IFG.\n+    lrgs(bias_lrg1_idx).compute_set_mask_size();\n+    lrgs(bias_lrg2_idx).compute_set_mask_size();\n+    bias_lrg_idx = lrgs(bias_lrg1_idx).degrees_of_freedom() >\n+                           lrgs(bias_lrg2_idx).degrees_of_freedom()\n+                       ? bias_lrg2_idx\n+                       : bias_lrg1_idx;\n+  } else if (bias_lrg1_idx != 0) {\n+    bias_lrg_idx = bias_lrg1_idx;\n+  } else if (bias_lrg2_idx != 0) {\n+    bias_lrg_idx = bias_lrg2_idx;\n+  }\n+\n+  \/\/ Register masks with offset excludes all mask bits before the offset.\n+  \/\/ Such masks are mainly used for allocation from stack slots. Constrain the\n+  \/\/ register mask of definition live range using bias mask only if\n+  \/\/ both masks have zero offset.\n+  if (bias_lrg_idx != 0 && !lrg.mask().is_offset() &&\n+      !lrgs(bias_lrg_idx).mask().is_offset()) {\n+    \/\/ Choose a color which is legal for bias_lrg\n+    ResourceMark rm(C->regmask_arena());\n+    RegMask tempmask(lrg.mask(), C->regmask_arena());\n+    tempmask.and_with(lrgs(bias_lrg_idx).mask());\n+    tempmask.clear_to_sets(lrg.num_regs());\n+    OptoReg::Name reg = find_first_set(lrg, tempmask);\n+    if (OptoReg::is_valid(reg)) {\n+      return reg;\n+    }\n+  }\n+  return OptoReg::Bad;\n+}\n+\n@@ -1495,19 +1554,4 @@\n-  uint copy_lrg = _lrg_map.find(lrg._copy_bias);\n-  if (copy_lrg != 0) {\n-    \/\/ If he has a color,\n-    if(!_ifg->_yanked->test(copy_lrg)) {\n-      OptoReg::Name reg = lrgs(copy_lrg).reg();\n-      \/\/  And it is legal for you,\n-      if (is_legal_reg(lrg, reg)) {\n-        return reg;\n-      }\n-    } else if (!lrg.mask().is_offset()) {\n-      \/\/ Choose a color which is legal for him\n-      ResourceMark rm(C->regmask_arena());\n-      RegMask tempmask(lrg.mask(), C->regmask_arena());\n-      tempmask.and_with(lrgs(copy_lrg).mask());\n-      tempmask.clear_to_sets(lrg.num_regs());\n-      OptoReg::Name reg = find_first_set(lrg, tempmask);\n-      if (OptoReg::is_valid(reg))\n-        return reg;\n-    }\n+  \/\/ Try biasing the color with non-interfering bias live range[s].\n+  OptoReg::Name reg = select_bias_lrg_color(lrg);\n+  if (OptoReg::is_valid(reg)) {\n+    return reg;\n@@ -1527,1 +1571,1 @@\n-  OptoReg::Name reg = lrg.mask().find_first_elem();\n+  reg = lrg.mask().find_first_elem();\n@@ -1643,0 +1687,21 @@\n+\n+    Node* def = lrg->_def;\n+    if (lrg->is_singledef() && !lrg->_is_bound && def->is_Mach()) {\n+      MachNode* mdef = def->as_Mach();\n+      if (Matcher::is_register_biasing_candidate(mdef, 1)) {\n+        Node* in1 = mdef->in(mdef->operand_index(1));\n+        if (in1 != nullptr && lrg->_copy_bias == 0) {\n+          lrg->_copy_bias = _lrg_map.find(in1);\n+        }\n+      }\n+\n+      \/\/ For commutative operations, def allocation can also be\n+      \/\/ biased towards LRG of second input's def.\n+      if (Matcher::is_register_biasing_candidate(mdef, 2)) {\n+        Node* in2 = mdef->in(mdef->operand_index(2));\n+        if (in2 != nullptr && lrg->_copy_bias2 == 0) {\n+          lrg->_copy_bias2 = _lrg_map.find(in2);\n+        }\n+      }\n+    }\n+\n","filename":"src\/hotspot\/share\/opto\/chaitin.cpp","additions":85,"deletions":20,"binary":false,"changes":105,"status":"modified"},{"patch":"@@ -66,0 +66,1 @@\n+  uint _copy_bias2;             \/\/ Index of second LRG which we want to share color\n@@ -706,0 +707,2 @@\n+  \/\/ Helper function which implements color biasing\n+  OptoReg::Name select_bias_lrg_color(LRG& lrg);\n","filename":"src\/hotspot\/share\/opto\/chaitin.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -91,0 +91,1 @@\n+  print_property((lrg._copy_bias2 != 0), \"copy_bias2\", lrg._copy_bias2);\n","filename":"src\/hotspot\/share\/opto\/idealGraphPrinter.cpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -463,0 +463,7 @@\n+int MachNode::operand_num_edges(uint oper_index) const {\n+  if (num_opnds() > oper_index) {\n+    return _opnds[oper_index]->num_edges();\n+  }\n+  return 0;\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/machnode.cpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -269,0 +269,1 @@\n+  int  operand_num_edges(uint operand) const;\n","filename":"src\/hotspot\/share\/opto\/machnode.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -515,0 +515,2 @@\n+  static bool is_register_biasing_candidate(const MachNode* mdef, int oper_index);\n+\n","filename":"src\/hotspot\/share\/opto\/matcher.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -831,20 +831,20 @@\n-  enum NodeFlags {\n-    Flag_is_Copy                     = 1 << 0, \/\/ should be first bit to avoid shift\n-    Flag_rematerialize               = 1 << 1,\n-    Flag_needs_anti_dependence_check = 1 << 2,\n-    Flag_is_macro                    = 1 << 3,\n-    Flag_is_Con                      = 1 << 4,\n-    Flag_is_cisc_alternate           = 1 << 5,\n-    Flag_is_dead_loop_safe           = 1 << 6,\n-    Flag_may_be_short_branch         = 1 << 7,\n-    Flag_avoid_back_to_back_before   = 1 << 8,\n-    Flag_avoid_back_to_back_after    = 1 << 9,\n-    Flag_has_call                    = 1 << 10,\n-    Flag_has_swapped_edges           = 1 << 11,\n-    Flag_is_scheduled                = 1 << 12,\n-    Flag_is_expensive                = 1 << 13,\n-    Flag_is_predicated_vector        = 1 << 14,\n-    Flag_for_post_loop_opts_igvn     = 1 << 15,\n-    Flag_for_merge_stores_igvn       = 1 << 16,\n-    Flag_is_removed_by_peephole      = 1 << 17,\n-    Flag_is_predicated_using_blend   = 1 << 18,\n+  enum NodeFlags : uint64_t {\n+    Flag_is_Copy                     = 1ULL << 0, \/\/ should be first bit to avoid shift\n+    Flag_rematerialize               = 1ULL << 1,\n+    Flag_needs_anti_dependence_check = 1ULL << 2,\n+    Flag_is_macro                    = 1ULL << 3,\n+    Flag_is_Con                      = 1ULL << 4,\n+    Flag_is_cisc_alternate           = 1ULL << 5,\n+    Flag_is_dead_loop_safe           = 1ULL << 6,\n+    Flag_may_be_short_branch         = 1ULL << 7,\n+    Flag_avoid_back_to_back_before   = 1ULL << 8,\n+    Flag_avoid_back_to_back_after    = 1ULL << 9,\n+    Flag_has_call                    = 1ULL << 10,\n+    Flag_has_swapped_edges           = 1ULL << 11,\n+    Flag_is_scheduled                = 1ULL << 12,\n+    Flag_is_expensive                = 1ULL << 13,\n+    Flag_is_predicated_vector        = 1ULL << 14,\n+    Flag_for_post_loop_opts_igvn     = 1ULL << 15,\n+    Flag_for_merge_stores_igvn       = 1ULL << 16,\n+    Flag_is_removed_by_peephole      = 1ULL << 17,\n+    Flag_is_predicated_using_blend   = 1ULL << 18,\n","filename":"src\/hotspot\/share\/opto\/node.hpp","additions":20,"deletions":20,"binary":false,"changes":40,"status":"modified"}]}