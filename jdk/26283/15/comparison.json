{"files":[{"patch":"@@ -2476,0 +2476,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/aarch64\/aarch64.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1079,0 +1079,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/arm\/arm.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2393,0 +2393,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/ppc\/ppc.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2073,0 +2073,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/riscv\/riscv.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1896,0 +1896,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/s390\/s390.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2636,0 +2636,51 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  if (mdef == nullptr) {\n+    return false;\n+  }\n+\n+  if (mdef->num_opnds() <= oper_index || mdef->operand_index(oper_index) < 0 ||\n+      \/\/ Complex memory operand covers multiple incoming edges needed for\n+      \/\/ address computation, biasing def towards any address component will not\n+      \/\/ result into NDD demotion by assembler.\n+      mdef->operand_num_edges(oper_index) != 1) {\n+    return false;\n+  }\n+\n+\n+  bool res = false;\n+  switch (oper_index) {\n+    \/\/ First operand of MachNode corresponding to Intel APX NDD selection\n+    \/\/ pattern can share its assigned register with definition operand if\n+    \/\/ their live ranges do not overlap. In such a scenario we can demote\n+    \/\/ it to legacy map0\/map1 instruction by replacing its 4-byte extended\n+    \/\/ EVEX prefix with shorter REX\/REX2 encoding. Demotion candidates\n+    \/\/ are decorated with a special flag by instruction selector.\n+    case 1: {\n+      res = (((mdef->flags() & Node::PD::Flag_ndd_demotable) != 0) ||\n+              ((mdef->flags() & Node::PD::Flag_ndd_demotable_commutative) != 0));\n+\n+    }\n+    break;\n+\n+    \/\/ Definition operand of commutative operation can be biased towards\n+    \/\/ second operand.\n+    case 2: {\n+      res = ((mdef->flags() & Node::PD::Flag_ndd_demotable_commutative) != 0);\n+    }\n+    break;\n+\n+    \/\/ Current scheme only selects upto two biaising candidates\n+    default: {\n+      assert(false, \"unhandled operand index\");\n+    }\n+    break;\n+  }\n+\n+  if (res) {\n+    \/\/ Demotion candidate must be register mask compatible with definition.\n+    assert(mdef->in_RegMask(mdef->operand_index(oper_index)).overlap(mdef->out_RegMask()), \"sanity\");\n+  }\n+\n+  return res;\n+}\n+\n@@ -2825,1 +2876,1 @@\n-  enum NodeFlags {\n+  enum NodeFlags : uint64_t {\n@@ -2837,1 +2888,3 @@\n-    _last_flag                = Flag_clears_sign_flag\n+    Flag_ndd_demotable        = Node::_last_flag << 12,\n+    Flag_ndd_demotable_commutative = Node::_last_flag << 13,\n+    _last_flag                = Flag_ndd_demotable_commutative\n@@ -9828,1 +9881,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -9856,1 +9909,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -9899,1 +9952,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -9956,0 +10009,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -10010,0 +10064,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -10116,1 +10171,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -10144,1 +10199,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -10187,1 +10242,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -10243,0 +10298,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -10297,0 +10353,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11011,1 +11068,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11025,1 +11082,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11068,1 +11125,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11126,1 +11183,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11140,1 +11197,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11183,1 +11240,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11255,1 +11312,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11283,1 +11340,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11324,1 +11381,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11352,1 +11409,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11397,0 +11454,1 @@\n+  flag(PD::Flag_ndd_demotable_commutative);\n@@ -11438,0 +11496,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11489,0 +11548,1 @@\n+  flag(PD::Flag_ndd_demotable_commutative);\n@@ -11530,0 +11590,1 @@\n+  flag(PD::Flag_ndd_demotable_commutative);\n@@ -11804,0 +11865,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11832,0 +11894,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11938,0 +12001,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12044,0 +12108,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12151,0 +12216,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12179,0 +12245,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12285,0 +12352,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12391,0 +12459,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12562,0 +12631,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12626,0 +12696,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12678,0 +12749,1 @@\n+\n@@ -12691,0 +12763,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12755,0 +12828,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12832,1 +12906,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -12925,1 +12999,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -12969,1 +13043,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13169,1 +13243,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13198,1 +13272,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13212,1 +13286,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13256,1 +13330,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13332,1 +13406,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13358,0 +13432,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -13388,1 +13463,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13434,1 +13509,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13513,1 +13588,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13569,1 +13644,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13613,1 +13688,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13816,1 +13891,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13871,1 +13946,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13885,1 +13960,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13930,1 +14005,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -14009,1 +14084,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -14035,0 +14110,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -14065,1 +14141,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -14111,1 +14187,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -16566,0 +16642,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -16617,0 +16694,1 @@\n+  flag(PD::Flag_ndd_demotable);\n","filename":"src\/hotspot\/cpu\/x86\/x86.ad","additions":116,"deletions":38,"binary":false,"changes":154,"status":"modified"},{"patch":"@@ -1474,0 +1474,42 @@\n+OptoReg::Name PhaseChaitin::select_bias_lrg_color(LRG &lrg) {\n+  uint bias_lrg1_idx = lrg._copy_bias;\n+  uint bias_lrg2_idx = lrg._copy_bias2;\n+\n+  \/\/ If bias_lrg1 has a color\n+  if (bias_lrg1_idx != 0 && !_ifg->_yanked->test(bias_lrg1_idx)) {\n+    OptoReg::Name reg = lrgs(bias_lrg1_idx).reg();\n+    \/\/  And it is legal for lrg\n+    if (is_legal_reg(lrg, reg)) {\n+      return reg;\n+    }\n+  \/\/ If bias_lrg2 has a color\n+  } else if (bias_lrg2_idx != 0 && !_ifg->_yanked->test(bias_lrg2_idx)) {\n+    OptoReg::Name reg = lrgs(bias_lrg2_idx).reg();\n+    \/\/  And it is legal for lrg\n+    if (is_legal_reg(lrg, reg)) {\n+      return reg;\n+    }\n+  } else if (!lrg.mask().is_offset()) {\n+    \/\/ Since both the bias live ranges are not part of IFG yet,\n+    \/\/ hence constrain the definition mask with the bias\n+    \/\/ live range with minimum degree of freedom, this will enhance\n+    \/\/ the chances of register sharing once the bias live range\n+    \/\/ becomes the part of IFG.\n+    uint bias_lrg = lrgs(bias_lrg1_idx).degrees_of_freedom() >\n+                            lrgs(bias_lrg2_idx).degrees_of_freedom()\n+                        ? bias_lrg2_idx\n+                        : bias_lrg1_idx;\n+\n+    \/\/ Choose a color which is legal for bias_lrg\n+    ResourceMark rm(C->regmask_arena());\n+    RegMask tempmask(lrg.mask(), C->regmask_arena());\n+    tempmask.and_with(lrgs(bias_lrg).mask());\n+    tempmask.clear_to_sets(lrg.num_regs());\n+    OptoReg::Name reg = find_first_set(lrg, tempmask);\n+    if (OptoReg::is_valid(reg)) {\n+      return reg;\n+    }\n+  }\n+  return OptoReg::Bad;\n+}\n+\n@@ -1495,19 +1537,4 @@\n-  uint copy_lrg = _lrg_map.find(lrg._copy_bias);\n-  if (copy_lrg != 0) {\n-    \/\/ If he has a color,\n-    if(!_ifg->_yanked->test(copy_lrg)) {\n-      OptoReg::Name reg = lrgs(copy_lrg).reg();\n-      \/\/  And it is legal for you,\n-      if (is_legal_reg(lrg, reg)) {\n-        return reg;\n-      }\n-    } else if (!lrg.mask().is_offset()) {\n-      \/\/ Choose a color which is legal for him\n-      ResourceMark rm(C->regmask_arena());\n-      RegMask tempmask(lrg.mask(), C->regmask_arena());\n-      tempmask.and_with(lrgs(copy_lrg).mask());\n-      tempmask.clear_to_sets(lrg.num_regs());\n-      OptoReg::Name reg = find_first_set(lrg, tempmask);\n-      if (OptoReg::is_valid(reg))\n-        return reg;\n-    }\n+  \/\/ Try biasing the color with non-interfering bias live range[s].\n+  OptoReg::Name reg = select_bias_lrg_color(lrg);\n+  if (OptoReg::is_valid(reg)) {\n+    return reg;\n@@ -1527,1 +1554,1 @@\n-  OptoReg::Name reg = lrg.mask().find_first_elem();\n+  reg = lrg.mask().find_first_elem();\n@@ -1643,0 +1670,21 @@\n+\n+    Node* def = lrg->_def;\n+    if (lrg->is_singledef() && !lrg->_is_bound && def->is_Mach()) {\n+      MachNode* mdef = def->as_Mach();\n+      if (Matcher::is_register_biasing_candidate(mdef, 1)) {\n+        Node* in1 = mdef->in(mdef->operand_index(1));\n+        if (in1 != nullptr && lrg->_copy_bias == 0) {\n+          lrg->_copy_bias = _lrg_map.find(in1);\n+        }\n+      }\n+\n+      \/\/ For commutative operation, def allocation can also be\n+      \/\/ biased towards LRG of second input's def.\n+      if (Matcher::is_register_biasing_candidate(mdef, 2)) {\n+        Node* in2 = mdef->in(mdef->operand_index(2));\n+        if (in2 != nullptr && lrg->_copy_bias2 == 0) {\n+          lrg->_copy_bias2 = _lrg_map.find(in2);\n+        }\n+      }\n+    }\n+\n","filename":"src\/hotspot\/share\/opto\/chaitin.cpp","additions":68,"deletions":20,"binary":false,"changes":88,"status":"modified"},{"patch":"@@ -66,0 +66,1 @@\n+  uint _copy_bias2;             \/\/ Index of second LRG which we want to share color\n@@ -706,0 +707,2 @@\n+  \/\/ Helper function which implements color biasing\n+  OptoReg::Name select_bias_lrg_color(LRG& lrg);\n","filename":"src\/hotspot\/share\/opto\/chaitin.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -1126,0 +1126,3 @@\n+      if (lrg._copy_bias2 != 0) {\n+        print_prop(\"copy_bias2\", lrg._copy_bias2);\n+      }\n","filename":"src\/hotspot\/share\/opto\/idealGraphPrinter.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -463,0 +463,7 @@\n+int MachNode::operand_num_edges(uint oper_index) const {\n+  if (num_opnds() > oper_index) {\n+    return _opnds[oper_index]->num_edges();\n+  }\n+  return 0;\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/machnode.cpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -269,0 +269,1 @@\n+  int  operand_num_edges(uint operand) const;\n","filename":"src\/hotspot\/share\/opto\/machnode.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -509,0 +509,2 @@\n+  static bool is_register_biasing_candidate(const MachNode* mdef, int oper_index);\n+\n","filename":"src\/hotspot\/share\/opto\/matcher.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -831,20 +831,20 @@\n-  enum NodeFlags {\n-    Flag_is_Copy                     = 1 << 0, \/\/ should be first bit to avoid shift\n-    Flag_rematerialize               = 1 << 1,\n-    Flag_needs_anti_dependence_check = 1 << 2,\n-    Flag_is_macro                    = 1 << 3,\n-    Flag_is_Con                      = 1 << 4,\n-    Flag_is_cisc_alternate           = 1 << 5,\n-    Flag_is_dead_loop_safe           = 1 << 6,\n-    Flag_may_be_short_branch         = 1 << 7,\n-    Flag_avoid_back_to_back_before   = 1 << 8,\n-    Flag_avoid_back_to_back_after    = 1 << 9,\n-    Flag_has_call                    = 1 << 10,\n-    Flag_has_swapped_edges           = 1 << 11,\n-    Flag_is_scheduled                = 1 << 12,\n-    Flag_is_expensive                = 1 << 13,\n-    Flag_is_predicated_vector        = 1 << 14,\n-    Flag_for_post_loop_opts_igvn     = 1 << 15,\n-    Flag_for_merge_stores_igvn       = 1 << 16,\n-    Flag_is_removed_by_peephole      = 1 << 17,\n-    Flag_is_predicated_using_blend   = 1 << 18,\n+  enum NodeFlags : uint64_t {\n+    Flag_is_Copy                     = 1ULL << 0, \/\/ should be first bit to avoid shift\n+    Flag_rematerialize               = 1ULL << 1,\n+    Flag_needs_anti_dependence_check = 1ULL << 2,\n+    Flag_is_macro                    = 1ULL << 3,\n+    Flag_is_Con                      = 1ULL << 4,\n+    Flag_is_cisc_alternate           = 1ULL << 5,\n+    Flag_is_dead_loop_safe           = 1ULL << 6,\n+    Flag_may_be_short_branch         = 1ULL << 7,\n+    Flag_avoid_back_to_back_before   = 1ULL << 8,\n+    Flag_avoid_back_to_back_after    = 1ULL << 9,\n+    Flag_has_call                    = 1ULL << 10,\n+    Flag_has_swapped_edges           = 1ULL << 11,\n+    Flag_is_scheduled                = 1ULL << 12,\n+    Flag_is_expensive                = 1ULL << 13,\n+    Flag_is_predicated_vector        = 1ULL << 14,\n+    Flag_for_post_loop_opts_igvn     = 1ULL << 15,\n+    Flag_for_merge_stores_igvn       = 1ULL << 16,\n+    Flag_is_removed_by_peephole      = 1ULL << 17,\n+    Flag_is_predicated_using_blend   = 1ULL << 18,\n","filename":"src\/hotspot\/share\/opto\/node.hpp","additions":20,"deletions":20,"binary":false,"changes":40,"status":"modified"}]}