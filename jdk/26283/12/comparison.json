{"files":[{"patch":"@@ -2476,0 +2476,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/aarch64\/aarch64.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1079,0 +1079,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/arm\/arm.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2393,0 +2393,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/ppc\/ppc.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2073,0 +2073,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/riscv\/riscv.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -1896,0 +1896,4 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+  return false;\n+}\n+\n","filename":"src\/hotspot\/cpu\/s390\/s390.ad","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2636,0 +2636,35 @@\n+bool Matcher::is_register_biasing_candidate(const MachNode *mdef, int oper_index) {\n+  if (mdef == nullptr) {\n+    return false;\n+  }\n+\n+  if (mdef->num_opnds() <= oper_index || mdef->operand_index(oper_index) < 0 ||\n+      \/\/ Complex memory operand covers multiple incoming edges needed for\n+      \/\/ address computation, biasing def towards any address component will not\n+      \/\/ result into NDD demotion by assembler.\n+      mdef->operand_num_edges(oper_index) == 1) {\n+    return false;\n+  }\n+\n+  \/\/ First operand of MachNode corresponding to Intel APX NDD selection\n+  \/\/ pattern can share its assigned register with definition operand if\n+  \/\/ their live ranges do not overlap, in such a scenario we can demote\n+  \/\/ it to legacy map0\/map1 instruction by replacing its 4-byte extended\n+  \/\/ EVEX prefix with shorter REX\/REX2 encoding. Demotion candidates\n+  \/\/ are decorated with a special flag by instruction selector.\n+  if (oper_index == 1 &&\n+      ((mdef->flags() & Node::PD::Flag_ndd_demotable) != 0)) {\n+    return true;\n+  }\n+\n+  \/\/ For commutative operation allocation of definition\n+  \/\/ operand can also be biased towards second operand.\n+  if (oper_index == 2 &&\n+      ((mdef->flags() & Node::PD::Flag_ndd_commutative) != 0) &&\n+      ((mdef->flags() & Node::PD::Flag_ndd_demotable) != 0)) {\n+    return true;\n+  }\n+\n+  return false;\n+}\n+\n@@ -2825,1 +2860,1 @@\n-  enum NodeFlags {\n+  enum NodeFlags : uint64_t {\n@@ -2837,1 +2872,3 @@\n-    _last_flag                = Flag_clears_sign_flag\n+    Flag_ndd_demotable        = Node::_last_flag << 12,\n+    Flag_ndd_commutative      = Node::_last_flag << 13,\n+    _last_flag                = Flag_ndd_commutative\n@@ -9828,1 +9865,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -9856,1 +9893,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -9899,1 +9936,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -9956,0 +9993,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -10010,0 +10048,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -10116,1 +10155,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -10144,1 +10183,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -10187,1 +10226,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -10243,0 +10282,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -10297,0 +10337,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11011,1 +11052,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11025,1 +11066,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11068,1 +11109,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11126,1 +11167,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11140,1 +11181,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11183,1 +11224,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11255,1 +11296,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11283,1 +11324,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11324,1 +11365,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11352,1 +11393,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable);\n@@ -11397,0 +11438,1 @@\n+  flag(PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -11438,0 +11480,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11489,0 +11532,1 @@\n+  flag(PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -11530,0 +11574,1 @@\n+  flag(PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -11804,0 +11849,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11832,0 +11878,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -11938,0 +11985,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12044,0 +12092,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12151,0 +12200,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12179,0 +12229,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12285,0 +12336,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12391,0 +12443,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12562,0 +12615,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12626,0 +12680,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12678,0 +12733,1 @@\n+\n@@ -12691,0 +12747,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12755,0 +12812,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -12832,1 +12890,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -12925,1 +12983,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -12969,1 +13027,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -13169,1 +13227,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -13198,1 +13256,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13212,1 +13270,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13256,1 +13314,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13332,1 +13390,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -13358,0 +13416,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -13388,1 +13447,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13434,1 +13493,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13513,1 +13572,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -13569,1 +13628,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13613,1 +13672,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -13816,1 +13875,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -13871,1 +13930,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13885,1 +13944,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -13930,1 +13989,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -14009,1 +14068,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -14035,0 +14094,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -14065,1 +14125,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable);\n@@ -14111,1 +14171,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n@@ -16566,0 +16626,1 @@\n+  flag(PD::Flag_ndd_demotable);\n@@ -16617,0 +16678,1 @@\n+  flag(PD::Flag_ndd_demotable);\n","filename":"src\/hotspot\/cpu\/x86\/x86.ad","additions":100,"deletions":38,"binary":false,"changes":138,"status":"modified"},{"patch":"@@ -1474,0 +1474,24 @@\n+OptoReg::Name PhaseChaitin::select_bias_lrg_color(LRG& lrg, uint bias_lrg) {\n+  if (bias_lrg != 0) {\n+    \/\/ If bias_lrg has a color\n+    if (!_ifg->_yanked->test(bias_lrg)) {\n+      OptoReg::Name reg = lrgs(bias_lrg).reg();\n+      \/\/  And it is legal for lrg\n+      if (is_legal_reg(lrg, reg)) {\n+        return reg;\n+      }\n+    } else if (!lrg.mask().is_offset()) {\n+      \/\/ Choose a color which is legal for bias_lrg\n+      ResourceMark rm(C->regmask_arena());\n+      RegMask tempmask(lrg.mask(), C->regmask_arena());\n+      tempmask.and_with(lrgs(bias_lrg).mask());\n+      tempmask.clear_to_sets(lrg.num_regs());\n+      OptoReg::Name reg = find_first_set(lrg, tempmask);\n+      if (OptoReg::is_valid(reg)) {\n+        return reg;\n+      }\n+    }\n+  }\n+  return OptoReg::Bad;\n+}\n+\n@@ -1495,0 +1519,1 @@\n+  \/\/ Try biasing the color with non-interfering first input's lrg.\n@@ -1496,18 +1521,10 @@\n-  if (copy_lrg != 0) {\n-    \/\/ If he has a color,\n-    if(!_ifg->_yanked->test(copy_lrg)) {\n-      OptoReg::Name reg = lrgs(copy_lrg).reg();\n-      \/\/  And it is legal for you,\n-      if (is_legal_reg(lrg, reg)) {\n-        return reg;\n-      }\n-    } else if (!lrg.mask().is_offset()) {\n-      \/\/ Choose a color which is legal for him\n-      ResourceMark rm(C->regmask_arena());\n-      RegMask tempmask(lrg.mask(), C->regmask_arena());\n-      tempmask.and_with(lrgs(copy_lrg).mask());\n-      tempmask.clear_to_sets(lrg.num_regs());\n-      OptoReg::Name reg = find_first_set(lrg, tempmask);\n-      if (OptoReg::is_valid(reg))\n-        return reg;\n-    }\n+  OptoReg::Name reg = select_bias_lrg_color(lrg, copy_lrg);\n+  if (reg != OptoReg::Bad) {\n+    return reg;\n+  }\n+  \/\/ For commutative operations, try biasing the color with non-interfering\n+  \/\/ second input's lrg.\n+  copy_lrg = _lrg_map.find(lrg._copy_bias2);\n+  reg = select_bias_lrg_color(lrg, copy_lrg);\n+  if (reg != OptoReg::Bad) {\n+    return reg;\n@@ -1527,1 +1544,1 @@\n-  OptoReg::Name reg = lrg.mask().find_first_elem();\n+  reg = lrg.mask().find_first_elem();\n@@ -1643,0 +1660,25 @@\n+\n+    Node* def = lrg->_def;\n+    MachNode* mdef = lrg->is_singledef() && !lrg->_is_bound && def->is_Mach() ? def->as_Mach() : nullptr;\n+    if (Matcher::is_register_biasing_candidate(mdef, 1)) {\n+      Node* in1 = mdef->in(mdef->operand_index(1));\n+      if (in1 != nullptr) {\n+        uint lrg_in1 = _lrg_map.find(in1);\n+        if (lrg_in1 != 0 && lrg->_copy_bias == 0) {\n+          lrg->_copy_bias = lrg_in1;\n+        }\n+      }\n+    }\n+\n+    \/\/ For commutative operation, def allocation can also be\n+    \/\/ biased towards LRG of second input's def.\n+    if (Matcher::is_register_biasing_candidate(mdef, 2)) {\n+      Node* in2 = mdef->in(mdef->operand_index(2));\n+      if (in2 != nullptr) {\n+        uint lrg_in2 = _lrg_map.find(in2);\n+        if (lrg_in2 != 0 && lrg->_copy_bias2 == 0) {\n+          lrg->_copy_bias2 = lrg_in2;\n+        }\n+      }\n+    }\n+\n","filename":"src\/hotspot\/share\/opto\/chaitin.cpp","additions":61,"deletions":19,"binary":false,"changes":80,"status":"modified"},{"patch":"@@ -66,0 +66,1 @@\n+  uint _copy_bias2;             \/\/ Index of second LRG which we want to share color\n@@ -706,0 +707,2 @@\n+  \/\/ Helper function which implements color biasing\n+  OptoReg::Name select_bias_lrg_color(LRG& lrg, uint bias_lrg);\n","filename":"src\/hotspot\/share\/opto\/chaitin.hpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -463,0 +463,7 @@\n+int MachNode::operand_num_edges(uint oper_index) const {\n+  if (num_opnds() > oper_index) {\n+    return _opnds[oper_index]->num_edges();\n+  }\n+  return 0;\n+}\n+\n","filename":"src\/hotspot\/share\/opto\/machnode.cpp","additions":7,"deletions":0,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -269,0 +269,1 @@\n+  int  operand_num_edges(uint operand) const;\n","filename":"src\/hotspot\/share\/opto\/machnode.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -509,0 +509,2 @@\n+  static bool is_register_biasing_candidate(const MachNode* mdef, int oper_index);\n+\n","filename":"src\/hotspot\/share\/opto\/matcher.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -831,20 +831,20 @@\n-  enum NodeFlags {\n-    Flag_is_Copy                     = 1 << 0, \/\/ should be first bit to avoid shift\n-    Flag_rematerialize               = 1 << 1,\n-    Flag_needs_anti_dependence_check = 1 << 2,\n-    Flag_is_macro                    = 1 << 3,\n-    Flag_is_Con                      = 1 << 4,\n-    Flag_is_cisc_alternate           = 1 << 5,\n-    Flag_is_dead_loop_safe           = 1 << 6,\n-    Flag_may_be_short_branch         = 1 << 7,\n-    Flag_avoid_back_to_back_before   = 1 << 8,\n-    Flag_avoid_back_to_back_after    = 1 << 9,\n-    Flag_has_call                    = 1 << 10,\n-    Flag_has_swapped_edges           = 1 << 11,\n-    Flag_is_scheduled                = 1 << 12,\n-    Flag_is_expensive                = 1 << 13,\n-    Flag_is_predicated_vector        = 1 << 14,\n-    Flag_for_post_loop_opts_igvn     = 1 << 15,\n-    Flag_for_merge_stores_igvn       = 1 << 16,\n-    Flag_is_removed_by_peephole      = 1 << 17,\n-    Flag_is_predicated_using_blend   = 1 << 18,\n+  enum NodeFlags : uint64_t {\n+    Flag_is_Copy                     = 1ULL << 0, \/\/ should be first bit to avoid shift\n+    Flag_rematerialize               = 1ULL << 1,\n+    Flag_needs_anti_dependence_check = 1ULL << 2,\n+    Flag_is_macro                    = 1ULL << 3,\n+    Flag_is_Con                      = 1ULL << 4,\n+    Flag_is_cisc_alternate           = 1ULL << 5,\n+    Flag_is_dead_loop_safe           = 1ULL << 6,\n+    Flag_may_be_short_branch         = 1ULL << 7,\n+    Flag_avoid_back_to_back_before   = 1ULL << 8,\n+    Flag_avoid_back_to_back_after    = 1ULL << 9,\n+    Flag_has_call                    = 1ULL << 10,\n+    Flag_has_swapped_edges           = 1ULL << 11,\n+    Flag_is_scheduled                = 1ULL << 12,\n+    Flag_is_expensive                = 1ULL << 13,\n+    Flag_is_predicated_vector        = 1ULL << 14,\n+    Flag_for_post_loop_opts_igvn     = 1ULL << 15,\n+    Flag_for_merge_stores_igvn       = 1ULL << 16,\n+    Flag_is_removed_by_peephole      = 1ULL << 17,\n+    Flag_is_predicated_using_blend   = 1ULL << 18,\n","filename":"src\/hotspot\/share\/opto\/node.hpp","additions":20,"deletions":20,"binary":false,"changes":40,"status":"modified"}]}