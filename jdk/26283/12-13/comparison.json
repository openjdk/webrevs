{"files":[{"patch":"@@ -2476,1 +2476,1 @@\n-bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int biasing_candidate, int oper_index) {\n","filename":"src\/hotspot\/cpu\/aarch64\/aarch64.ad","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1079,1 +1079,1 @@\n-bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int biasing_candidate, int oper_index) {\n","filename":"src\/hotspot\/cpu\/arm\/arm.ad","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2393,1 +2393,1 @@\n-bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int biasing_candidate, int oper_index) {\n","filename":"src\/hotspot\/cpu\/ppc\/ppc.ad","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2073,1 +2073,1 @@\n-bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int biasing_candidate, int oper_index) {\n","filename":"src\/hotspot\/cpu\/riscv\/riscv.ad","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1896,1 +1896,1 @@\n-bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int oper_index) {\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int biasing_candidate, int oper_index) {\n","filename":"src\/hotspot\/cpu\/s390\/s390.ad","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2636,1 +2636,1 @@\n-bool Matcher::is_register_biasing_candidate(const MachNode *mdef, int oper_index) {\n+bool Matcher::is_register_biasing_candidate(const MachNode* mdef, int biasing_candidate, int oper_index) {\n@@ -2645,1 +2645,1 @@\n-      mdef->operand_num_edges(oper_index) == 1) {\n+      mdef->operand_num_edges(oper_index) != 1) {\n@@ -2649,9 +2649,3 @@\n-  \/\/ First operand of MachNode corresponding to Intel APX NDD selection\n-  \/\/ pattern can share its assigned register with definition operand if\n-  \/\/ their live ranges do not overlap, in such a scenario we can demote\n-  \/\/ it to legacy map0\/map1 instruction by replacing its 4-byte extended\n-  \/\/ EVEX prefix with shorter REX\/REX2 encoding. Demotion candidates\n-  \/\/ are decorated with a special flag by instruction selector.\n-  if (oper_index == 1 &&\n-      ((mdef->flags() & Node::PD::Flag_ndd_demotable) != 0)) {\n-    return true;\n+  \/\/ Demotion candidate must be register mask compatible with definition.\n+  if (!mdef->in_RegMask(mdef->operand_index(oper_index)).overlap(mdef->out_RegMask())) {\n+    return false;\n@@ -2660,6 +2654,20 @@\n-  \/\/ For commutative operation allocation of definition\n-  \/\/ operand can also be biased towards second operand.\n-  if (oper_index == 2 &&\n-      ((mdef->flags() & Node::PD::Flag_ndd_commutative) != 0) &&\n-      ((mdef->flags() & Node::PD::Flag_ndd_demotable) != 0)) {\n-    return true;\n+  switch (biasing_candidate) {\n+    \/\/ First operand of MachNode corresponding to Intel APX NDD selection\n+    \/\/ pattern can share its assigned register with definition operand if\n+    \/\/ their live ranges do not overlap. In such a scenario we can demote\n+    \/\/ it to legacy map0\/map1 instruction by replacing its 4-byte extended\n+    \/\/ EVEX prefix with shorter REX\/REX2 encoding. Demotion candidates\n+    \/\/ are decorated with a special flag by instruction selector.\n+    case 1: {\n+      return (((mdef->flags() & Node::PD::Flag_ndd_demotable) != 0) ||\n+              ((mdef->flags() & Node::PD::Flag_ndd_demotable_commutative) != 0));\n+    }\n+\n+    \/\/ Definition operand of commutative operation can be biased towards\n+    \/\/ second operand.\n+    case 2: {\n+      return ((mdef->flags() & Node::PD::Flag_ndd_demotable_commutative) != 0);\n+    }\n+\n+    \/\/ Current scheme only selects upto two biaising candidates\n+    default: return false;\n@@ -2873,2 +2881,2 @@\n-    Flag_ndd_commutative      = Node::_last_flag << 13,\n-    _last_flag                = Flag_ndd_commutative\n+    Flag_ndd_demotable_commutative = Node::_last_flag << 13,\n+    _last_flag                = Flag_ndd_demotable_commutative\n@@ -9865,1 +9873,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -9936,1 +9944,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -10155,1 +10163,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -10226,1 +10234,1 @@\n-  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_overflow_flag, PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_carry_flag, PD::Flag_sets_parity_flag, PD::Flag_ndd_demotable_commutative);\n@@ -11438,1 +11446,1 @@\n-  flag(PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_ndd_demotable_commutative);\n@@ -11532,1 +11540,1 @@\n-  flag(PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_ndd_demotable_commutative);\n@@ -11574,1 +11582,1 @@\n-  flag(PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_ndd_demotable_commutative);\n@@ -12890,1 +12898,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13027,1 +13035,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13227,1 +13235,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13390,1 +13398,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13572,1 +13580,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13672,1 +13680,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -13875,1 +13883,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -14068,1 +14076,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n@@ -14171,1 +14179,1 @@\n-  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable, PD::Flag_ndd_commutative);\n+  flag(PD::Flag_sets_sign_flag, PD::Flag_sets_zero_flag, PD::Flag_sets_parity_flag, PD::Flag_clears_overflow_flag, PD::Flag_clears_carry_flag, PD::Flag_ndd_demotable_commutative);\n","filename":"src\/hotspot\/cpu\/x86\/x86.ad","additions":43,"deletions":35,"binary":false,"changes":78,"status":"modified"},{"patch":"@@ -1663,6 +1663,11 @@\n-    if (Matcher::is_register_biasing_candidate(mdef, 1)) {\n-      Node* in1 = mdef->in(mdef->operand_index(1));\n-      if (in1 != nullptr) {\n-        uint lrg_in1 = _lrg_map.find(in1);\n-        if (lrg_in1 != 0 && lrg->_copy_bias == 0) {\n-          lrg->_copy_bias = lrg_in1;\n+    if (mdef != nullptr) {\n+      int i = 1;\n+      for (; i < mdef->num_opnds(); i++) {\n+        if (Matcher::is_register_biasing_candidate(mdef, 1, i)) {\n+          Node* in1 = mdef->in(mdef->operand_index(i));\n+          if (in1 != nullptr) {\n+            uint lrg_in1 = _lrg_map.find(in1);\n+            if (lrg_in1 != 0 && lrg->_copy_bias == 0) {\n+              lrg->_copy_bias = lrg_in1;\n+            }\n+          }\n@@ -1671,1 +1676,0 @@\n-    }\n@@ -1673,8 +1677,11 @@\n-    \/\/ For commutative operation, def allocation can also be\n-    \/\/ biased towards LRG of second input's def.\n-    if (Matcher::is_register_biasing_candidate(mdef, 2)) {\n-      Node* in2 = mdef->in(mdef->operand_index(2));\n-      if (in2 != nullptr) {\n-        uint lrg_in2 = _lrg_map.find(in2);\n-        if (lrg_in2 != 0 && lrg->_copy_bias2 == 0) {\n-          lrg->_copy_bias2 = lrg_in2;\n+      \/\/ For commutative operation, def allocation can also be\n+      \/\/ biased towards LRG of second input's def.\n+      for (; i < mdef->num_opnds(); i++) {\n+        if (Matcher::is_register_biasing_candidate(mdef, 2, i)) {\n+          Node* in2 = mdef->in(mdef->operand_index(i));\n+          if (in2 != nullptr) {\n+            uint lrg_in2 = _lrg_map.find(in2);\n+            if (lrg_in2 != 0 && lrg->_copy_bias2 == 0) {\n+              lrg->_copy_bias2 = lrg_in2;\n+            }\n+          }\n","filename":"src\/hotspot\/share\/opto\/chaitin.cpp","additions":22,"deletions":15,"binary":false,"changes":37,"status":"modified"},{"patch":"@@ -1126,0 +1126,3 @@\n+      if (lrg._copy_bias2 != 0) {\n+        print_prop(\"copy_bias2\", lrg._copy_bias2);\n+      }\n","filename":"src\/hotspot\/share\/opto\/idealGraphPrinter.cpp","additions":3,"deletions":0,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -509,1 +509,1 @@\n-  static bool is_register_biasing_candidate(const MachNode* mdef, int oper_index);\n+  static bool is_register_biasing_candidate(const MachNode* mdef, int biasing_candidate, int oper_index);\n","filename":"src\/hotspot\/share\/opto\/matcher.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}