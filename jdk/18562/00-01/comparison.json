{"files":[{"patch":"@@ -64,1 +64,1 @@\n-address VM_Version::_apx_state_restore_error_handler = (address)VM_Version::report_apx_state_restore_error;\n+address VM_Version::_apx_state_restore_warning_handler = (address)VM_Version::report_apx_state_restore_warning;\n@@ -116,2 +116,4 @@\n-    \/\/__ mov64(r15, 0L);\n-    \/\/ FIXME Uncomment following code after OS enablement of\n+    \/* FIXME Uncomment following code after OS enablement of\n+    bool save_apx = UseAPX;\n+    VM_Version::set_apx_cpuFeatures();\n+    UseAPX = true;\n@@ -119,2 +121,5 @@\n-    \/\/__ mov64(r16, 0L);\n-    \/\/__ mov64(r31, 0L);\n+    __ mov64(r16, 0L);\n+    __ mov64(r31, 0L);\n+    UseAPX = save_apx;\n+    VM_Version::clean_cpuFeatures();\n+    *\/\n@@ -137,1 +142,1 @@\n-    Label ext_cpuid8, done, wrapup, vector_save_restore, apx_save_restore_error;\n+    Label ext_cpuid8, done, wrapup, vector_save_restore, apx_save_restore_warning;\n@@ -433,2 +438,4 @@\n-    \/* FIXME: Uncomment after integration of JDK-8328998\n-    __ mov64(r15, VM_Version::egpr_test_value());\n+    \/* FIXME: Uncomment while integrating JDK-8329032\n+    bool save_apx = UseAPX;\n+    VM_Version::set_apx_cpuFeatures();\n+    UseAPX = true;\n@@ -444,2 +451,2 @@\n-    \/\/ Validate the contents of r15, r16 and r31\n-    \/* FIXME: Uncomment after integration of JDK-8328998\n+    \/\/ Validate the contents of r16 and r31\n+    \/* FIXME: Uncomment after integration of JDK-8329032\n@@ -447,2 +454,0 @@\n-    __ cmpq(rax, r15);\n-    __ jccb(Assembler::notEqual, apx_save_restore_error);\n@@ -450,1 +455,1 @@\n-    __ jccb(Assembler::notEqual, apx_save_restore_error);\n+    __ jccb(Assembler::notEqual, apx_save_restore_warning);\n@@ -454,3 +459,4 @@\n-    \/\/ Generate SEGV to signal unsuccessful save\/restore.\n-    __ bind(apx_save_restore_error);\n-    __ lea(rax, ExternalAddress(VM_Version::_apx_state_restore_error_handler));\n+    UseAPX = save_apx;\n+\n+    __ bind(apx_save_restore_warning);\n+    __ lea(rax, ExternalAddress(VM_Version::_apx_state_restore_warning_handler));\n@@ -871,0 +877,5 @@\n+void VM_Version::report_apx_state_restore_warning() {\n+  tty->print(\"warning: Unsuccessful EGPRs state restoration across signal handling, setting UseAPX to false.\\n\");\n+  _cpuid_info.sefsl1_cpuid7_edx.bits.apx_f = 0;\n+}\n+\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.cpp","additions":27,"deletions":16,"binary":false,"changes":43,"status":"modified"},{"patch":"@@ -477,0 +477,1 @@\n+    \/\/ eax = 7, ecx = 0\n@@ -620,2 +621,1 @@\n-  static void report_apx_state_restore_error() { report_vm_error(__FILE__, __LINE__,\"Unsuccessful APX state restoration.\\n\"); }\n-\n+  static void report_apx_state_restore_warning();\n@@ -633,1 +633,1 @@\n-  static address _apx_state_restore_error_handler;\n+  static address _apx_state_restore_warning_handler;\n","filename":"src\/hotspot\/cpu\/x86\/vm_version_x86.hpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -420,1 +420,1 @@\n-    if ((sig == SIGSEGV) && VM_Version::is_cpuinfo_segv_addr_apx(pc)) {\n+    if ((sig == SIGSEGV || sig == SIGBUS) && VM_Version::is_cpuinfo_segv_addr_apx(pc)) {\n","filename":"src\/hotspot\/os_cpu\/bsd_x86\/os_bsd_x86.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}