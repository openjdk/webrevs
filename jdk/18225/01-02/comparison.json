{"files":[{"patch":"@@ -37,1 +37,2 @@\n- * @build JfrReporter\n+ * @build JfrReporter jdk.test.whitebox.WhiteBox PrintContainerInfo\n+ * @run driver jdk.test.lib.helpers.ClassFileInstaller -jar whitebox.jar jdk.test.whitebox.WhiteBox\n@@ -63,0 +64,1 @@\n+        Common.prepareWhiteBox();\n@@ -219,8 +221,18 @@\n-        Common.logNewTestCase(\"Memory: --memory = \" + memValueToSet + \" --memory-swap = \" + swapValueToSet);\n-         OutputAnalyzer out = DockerTestUtils.dockerRunJava(\n-                                      commonDockerOpts()\n-                                      .addDockerOpts(\"--memory=\" + memValueToSet)\n-                                      .addDockerOpts(\"--memory-swap=\" + swapValueToSet)\n-                                      \/\/ The default memory-swappiness vaule is inherited from the host machine, which maybe 0\n-                                      .addDockerOpts(\"--memory-swappiness=60\")\n-                                      .addClassOptions(\"jdk.SwapSpace\"));\n+        OutputAnalyzer out;\n+        if (isCgroupV1(memValueToSet)) {\n+            Common.logNewTestCase(\"Memory: --memory = \" + memValueToSet + \" --memory-swap = \" + swapValueToSet + \" --memory-swappiness = 60\");\n+            out = DockerTestUtils.dockerRunJava(\n+                                          commonDockerOpts()\n+                                          .addDockerOpts(\"--memory=\" + memValueToSet)\n+                                          .addDockerOpts(\"--memory-swap=\" + swapValueToSet)\n+                                          \/\/ With Cgroupv1, The default memory-swappiness vaule is inherited from the host machine, which maybe 0\n+                                          .addDockerOpts(\"--memory-swappiness=60\")\n+                                          .addClassOptions(\"jdk.SwapSpace\"));\n+        } else {\n+            Common.logNewTestCase(\"Memory: --memory = \" + memValueToSet + \" --memory-swap = \" + swapValueToSet);\n+            out = DockerTestUtils.dockerRunJava(\n+                                          commonDockerOpts()\n+                                          .addDockerOpts(\"--memory=\" + memValueToSet)\n+                                          .addDockerOpts(\"--memory-swap=\" + swapValueToSet)\n+                                          .addClassOptions(\"jdk.SwapSpace\"));\n+        }\n@@ -292,0 +304,13 @@\n+\n+    private static boolean isCgroupV1(String memValueToSet) throws Exception {\n+        DockerRunOptions opts = Common.newOpts(imageName, \"PrintContainerInfo\")\n+                      .addDockerOpts(\"--memory=\" + memValueToSet)\n+                      .addDockerOpts(\"--memory-swap=\" + memValueToSet); \/\/ no swap\n+        Common.addWhiteBoxOpts(opts);\n+\n+        OutputAnalyzer out = Common.run(opts);\n+        if (out.contains(\"cgroupv1\")) {\n+            return true;\n+        }\n+        return false;\n+    }\n","filename":"test\/hotspot\/jtreg\/containers\/docker\/TestJFREvents.java","additions":34,"deletions":9,"binary":false,"changes":43,"status":"modified"}]}