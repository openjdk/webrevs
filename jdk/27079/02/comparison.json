{"files":[{"patch":"@@ -113,0 +113,1 @@\n+    public static final int ERROR_CANT_RESOLVE_FILENAME = 1921;\n","filename":"src\/java.base\/windows\/classes\/sun\/nio\/fs\/WindowsConstants.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -36,0 +36,1 @@\n+import java.util.concurrent.atomic.AtomicLong;\n@@ -421,8 +422,12 @@\n-    @Override\n-    public boolean isSameFile(Path obj1, Path obj2) throws IOException {\n-        WindowsPath file1 = WindowsPath.toWindowsPath(obj1);\n-        if (file1.equals(obj2))\n-            return true;\n-        if (obj2 == null)\n-            throw new NullPointerException();\n-        if (!(obj2 instanceof WindowsPath))\n+    \/\/ contains file attributes and its handle\n+    \/\/ the attributes' key is valid as long as the handle remains open\n+    private record LinkAttributes(WindowsFileAttributes attrs, long handle) {\n+        public boolean equals(Object obj) {\n+            if (obj == this)\n+                return true;\n+            if (obj instanceof LinkAttributes other) {\n+                WindowsFileAttributes oattrs = other.attrs();\n+                return oattrs.volSerialNumber() == attrs.volSerialNumber() && \n+                       oattrs.fileIndexHigh()   == attrs.fileIndexHigh() &&\n+                       oattrs.fileIndexLow()    == attrs.fileIndexLow();\n+            }\n@@ -430,1 +435,7 @@\n-        WindowsPath file2 = (WindowsPath)obj2;\n+        }\n+\n+        public int hashCode() {\n+            return attrs.volSerialNumber() +\n+                   attrs.fileIndexHigh() + attrs.fileIndexLow();\n+        }\n+    }\n@@ -432,2 +443,6 @@\n-        \/\/ open both files and see if they are the same\n-        long h1 = 0L;\n+    \/\/ find the attributes of the last accessible link in the chain\n+    private LinkAttributes lastFileAttrs(WindowsPath path)\n+        throws IOException, WindowsException\n+    {\n+        var fileAttrs = new HashSet<LinkAttributes>();\n+        LinkAttributes lastFileAttrs = null;\n@@ -435,5 +450,34 @@\n-            h1 = file1.openForReadAttributeAccess(true);\n-        } catch (WindowsException x) {\n-            if (x.lastError() != ERROR_FILE_NOT_FOUND &&\n-                x.lastError() != ERROR_PATH_NOT_FOUND)\n-                x.rethrowAsIOException(file1);\n+            while (path != null) {\n+                long h;\n+                try {\n+                    h = path.openForReadAttributeAccess(false);\n+                } catch (WindowsException x) {\n+                    if (x.lastError() != ERROR_FILE_NOT_FOUND &&\n+                        x.lastError() != ERROR_PATH_NOT_FOUND)\n+                        throw x;\n+                    break;\n+                }\n+\n+                WindowsFileAttributes attrs =\n+                    WindowsFileAttributes.readAttributes(h);\n+                if (!attrs.isSymbolicLink())\n+                    break;\n+\n+                LinkAttributes linkAttr = new LinkAttributes(attrs, h);\n+                if (!fileAttrs.add(linkAttr))\n+                    throw new FileSystemLoopException(path.toString());\n+\n+                lastFileAttrs = linkAttr;\n+\n+                String target = WindowsLinkSupport.readLink(path, h);\n+                path = WindowsPath.parse(path.getFileSystem(), target);\n+            }\n+        } catch (IOException|WindowsException e) {\n+            if (lastFileAttrs != null) {\n+                CloseHandle(lastFileAttrs.handle());\n+                throw e;\n+            }\n+        } finally {\n+            fileAttrs.remove(lastFileAttrs);\n+            for (LinkAttributes la : fileAttrs)\n+                CloseHandle(la.handle());\n@@ -442,3 +486,2 @@\n-        \/\/ if file1 does not exist, it cannot equal file2\n-        if (h1 == 0L)\n-            return false;\n+        return lastFileAttrs;\n+    }\n@@ -446,0 +489,3 @@\n+    \/\/ find the key by following links\n+    private LinkAttributes fileAttrs(WindowsPath file) throws WindowsException {\n+        long h = INVALID_HANDLE_VALUE;\n@@ -447,7 +493,10 @@\n-            WindowsFileAttributes attrs1 = null;\n-            try {\n-                attrs1 = WindowsFileAttributes.readAttributes(h1);\n-            } catch (WindowsException x) {\n-                x.rethrowAsIOException(file1);\n-            }\n-            long h2 = 0L;\n+            h = file.openForReadAttributeAccess(true);\n+        } catch (WindowsException x) {\n+            if (x.lastError() != ERROR_FILE_NOT_FOUND &&\n+                x.lastError() != ERROR_PATH_NOT_FOUND &&\n+                x.lastError() != ERROR_CANT_RESOLVE_FILENAME)\n+                throw x;\n+        }\n+\n+        if (h != INVALID_HANDLE_VALUE) {\n+            WindowsFileAttributes attrs = null;\n@@ -455,1 +504,1 @@\n-                h2 = file2.openForReadAttributeAccess(true);\n+                attrs = WindowsFileAttributes.readAttributes(h);\n@@ -457,3 +506,2 @@\n-                if (x.lastError() != ERROR_FILE_NOT_FOUND &&\n-                    x.lastError() != ERROR_PATH_NOT_FOUND)\n-                    x.rethrowAsIOException(file2);\n+                CloseHandle(h);\n+                throw x;\n@@ -462,3 +510,2 @@\n-            \/\/ if file2 does not exist, it cannot equal file1, which does\n-            if (h2 == 0L)\n-                return false;\n+            return new LinkAttributes(attrs, h);\n+        }\n@@ -466,2 +513,23 @@\n-            try {\n-                WindowsFileAttributes attrs2 = null;\n+        return null;\n+    }\n+\n+    @Override\n+    public boolean isSameFile(Path obj1, Path obj2) throws IOException {\n+        \/\/ toWindowsPath verifies its argument is a non-null WindowsPath\n+        WindowsPath file1 = WindowsPath.toWindowsPath(obj1);\n+        if (file1.equals(obj2))\n+            return true;\n+        if (obj2 == null)\n+            throw new NullPointerException();\n+        if (!(obj2 instanceof WindowsPath))\n+            return false;\n+        WindowsPath file2 = (WindowsPath)obj2;\n+\n+        LinkAttributes attrs1 = null;\n+        try {\n+            attrs1 = fileAttrs(file1);\n+            if (attrs1 == null)\n+                attrs1 = lastFileAttrs(file1);\n+            if (attrs1 != null) {\n+                WindowsFileAttributes attrs = attrs1.attrs();\n+                LinkAttributes attrs2 = null;\n@@ -469,3 +537,10 @@\n-                    attrs2 = WindowsFileAttributes.readAttributes(h2);\n-                } catch (WindowsException x) {\n-                    x.rethrowAsIOException(file2);\n+                     attrs2 = fileAttrs(file2);\n+                     if (attrs2 == null)\n+                         attrs2 = lastFileAttrs(file2);\n+                     if (attrs2 != null)\n+                         return attrs1.equals(attrs2);\n+                } catch (WindowsException y) {\n+                    y.rethrowAsIOException(file2);\n+                } finally {\n+                    if (attrs2 != null)\n+                        CloseHandle(attrs2.handle());\n@@ -473,3 +548,0 @@\n-                return WindowsFileAttributes.isSameFile(attrs1, attrs2);\n-            } finally {\n-                CloseHandle(h2);\n@@ -477,0 +549,2 @@\n+        } catch (WindowsException x) {\n+            x.rethrowAsIOException(file1);\n@@ -478,1 +552,2 @@\n-            CloseHandle(h1);\n+            if (attrs1 != null)\n+                CloseHandle(attrs1.handle());\n@@ -480,0 +555,2 @@\n+\n+        return false;\n","filename":"src\/java.base\/windows\/classes\/sun\/nio\/fs\/WindowsFileSystemProvider.java","additions":119,"deletions":42,"binary":false,"changes":161,"status":"modified"},{"patch":"@@ -87,1 +87,1 @@\n-            return readLinkImpl(path, handle);\n+            return readLink(path, handle);\n@@ -292,2 +292,1 @@\n-    private static String readLinkImpl(WindowsPath path, long handle)\n-        throws IOException\n+    static String readLink(WindowsPath path, long handle) throws IOException\n","filename":"src\/java.base\/windows\/classes\/sun\/nio\/fs\/WindowsLinkSupport.java","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -25,1 +25,1 @@\n- * @bug 8154364 8366254\n+ * @bug 8154364 8365626 8366254\n@@ -27,1 +27,0 @@\n- * @requires (os.family != \"windows\")\n@@ -53,0 +52,1 @@\n+import org.junit.jupiter.api.condition.EnabledIf;\n@@ -69,0 +69,2 @@\n+    private boolean supportsSymbolicLinks;\n+\n@@ -78,0 +80,6 @@\n+\n+        supportsSymbolicLinks = TestUtil.supportsSymbolicLinks(home);\n+    }\n+\n+    private boolean supportsSymbolicLinks() {\n+        return supportsSymbolicLinks;\n@@ -206,1 +214,0 @@\n-        Files.createSymbolicLink(c, a);\n@@ -208,1 +215,4 @@\n-        list.add(Arguments.of(true, a, c));\n+        if (supportsSymbolicLinks) {\n+            Files.createSymbolicLink(c, a);\n+            list.add(Arguments.of(true, a, c));\n+        }\n@@ -223,1 +233,0 @@\n-        Files.createSymbolicLink(c, a);\n@@ -229,1 +238,4 @@\n-        list.add(Arguments.of(false, a, c));\n+        if (supportsSymbolicLinks) {\n+            list.add(Arguments.of(false, a, c));\n+            Files.createSymbolicLink(c, a);\n+        }\n@@ -271,0 +283,1 @@\n+    @EnabledIf(\"supportsSymbolicLinks\")\n@@ -313,0 +326,1 @@\n+    @EnabledIf(\"supportsSymbolicLinks\")\n@@ -350,0 +364,1 @@\n+    @EnabledIf(\"supportsSymbolicLinks\")\n@@ -385,0 +400,1 @@\n+    @EnabledIf(\"supportsSymbolicLinks\")\n@@ -422,0 +438,1 @@\n+    @EnabledIf(\"supportsSymbolicLinks\")\n@@ -452,0 +469,1 @@\n+    @EnabledIf(\"supportsSymbolicLinks\")\n","filename":"test\/jdk\/java\/nio\/file\/Files\/IsSameFile.java","additions":24,"deletions":6,"binary":false,"changes":30,"status":"modified"}]}