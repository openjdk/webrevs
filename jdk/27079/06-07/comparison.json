{"files":[{"patch":"@@ -465,0 +465,2 @@\n+        long h = INVALID_HANDLE_VALUE;\n+\n@@ -467,1 +469,0 @@\n-                long h;\n@@ -477,10 +478,2 @@\n-                WindowsFileAttributes attrs;\n-                try {\n-                    attrs = WindowsFileAttributes.readAttributes(h);\n-                } catch (WindowsException x) {\n-                    CloseHandle(h);\n-                    throw x;\n-                }\n-\n-                if (!attrs.isSymbolicLink()) {\n-                    CloseHandle(h);\n+                WindowsFileAttributes attrs = WindowsFileAttributes.readAttributes(h);\n+                if (!attrs.isSymbolicLink())\n@@ -488,1 +481,0 @@\n-                }\n@@ -491,2 +483,1 @@\n-                if (!linkAttrs.add(linkAttr)) {\n-                    CloseHandle(h);\n+                if (!linkAttrs.add(linkAttr))\n@@ -494,1 +485,2 @@\n-                }\n+\n+                h = INVALID_HANDLE_VALUE;\n@@ -498,1 +490,1 @@\n-                String target = WindowsLinkSupport.readLink(path, h);\n+                String target = WindowsLinkSupport.readLink(path, linkAttr.handle());\n@@ -508,0 +500,4 @@\n+            \/\/ close vestigial handle\n+            if (h != INVALID_HANDLE_VALUE)\n+                CloseHandle(h);\n+\n@@ -530,1 +526,1 @@\n-        long h = INVALID_HANDLE_VALUE;\n+        long h;\n@@ -534,5 +530,4 @@\n-            if (x.lastError() != ERROR_FILE_NOT_FOUND &&\n-                x.lastError() != ERROR_PATH_NOT_FOUND &&\n-                x.lastError() != ERROR_CANT_RESOLVE_FILENAME)\n-                throw x;\n-        }\n+            if (x.lastError() == ERROR_FILE_NOT_FOUND ||\n+                x.lastError() == ERROR_PATH_NOT_FOUND ||\n+                x.lastError() == ERROR_CANT_RESOLVE_FILENAME)\n+                return null;\n@@ -540,8 +535,2 @@\n-        if (h != INVALID_HANDLE_VALUE) {\n-            WindowsFileAttributes attrs = null;\n-            try {\n-                attrs = WindowsFileAttributes.readAttributes(h);\n-            } catch (WindowsException x) {\n-                CloseHandle(h);\n-                throw x;\n-            }\n+            throw x;\n+        }\n@@ -549,1 +538,6 @@\n-            return new EntryAttributes(attrs, h);\n+        WindowsFileAttributes attrs = null;\n+        try {\n+            attrs = WindowsFileAttributes.readAttributes(h);\n+        } catch (WindowsException x) {\n+            CloseHandle(h);\n+            throw x;\n@@ -552,1 +546,1 @@\n-        return null;\n+        return new EntryAttributes(attrs, h);\n@@ -567,0 +561,2 @@\n+        EntryAttributes attrs2 = null;\n+        WindowsPath pathForException = file1;\n@@ -568,18 +564,6 @@\n-            attrs1 = realPathAttributes(file1);\n-            if (attrs1 == null)\n-                attrs1 = lastLinkAttributes(file1);\n-            if (attrs1 != null) {\n-                WindowsFileAttributes attrs = attrs1.attrs();\n-                EntryAttributes attrs2 = null;\n-                try {\n-                    attrs2 = realPathAttributes(file2);\n-                    if (attrs2 == null)\n-                        attrs2 = lastLinkAttributes(file2);\n-                    if (attrs2 != null)\n-                        return attrs1.equals(attrs2);\n-                } catch (WindowsException y) {\n-                    y.rethrowAsIOException(file2);\n-                } finally {\n-                    if (attrs2 != null)\n-                        CloseHandle(attrs2.handle());\n-                }\n+            if ((attrs1 = realPathAttributes(file1)) != null ||\n+                (attrs1 = lastLinkAttributes(file1)) != null) {\n+                pathForException = file2;\n+                if ((attrs2 = realPathAttributes(file2)) != null ||\n+                    (attrs2 = lastLinkAttributes(file2)) != null)\n+                    return attrs1.equals(attrs2);\n@@ -588,1 +572,1 @@\n-            x.rethrowAsIOException(file1);\n+            x.rethrowAsIOException(pathForException);\n@@ -590,1 +574,1 @@\n-            if (attrs1 != null)\n+            if (attrs1 != null) {\n@@ -592,0 +576,3 @@\n+                if (attrs2 != null)\n+                    CloseHandle(attrs2.handle());\n+            }\n","filename":"src\/java.base\/windows\/classes\/sun\/nio\/fs\/WindowsFileSystemProvider.java","additions":39,"deletions":52,"binary":false,"changes":91,"status":"modified"}]}