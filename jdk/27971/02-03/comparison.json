{"files":[{"patch":"@@ -2728,5 +2728,20 @@\n-  if (dirp != nullptr) {\n-    struct dirent* dentp;\n-    while ((dentp = readdir(dirp)) != nullptr) {\n-      if (isdigit(dentp->d_name[0])) {\n-        fds++;\n+  const int TIMEOUT_MS = 50;\n+  struct timespec start, now;\n+  clock_gettime(CLOCK_MONOTONIC, &start);\n+  struct dirent* dentp;\n+  bool timed_out = false;\n+\n+  if (dirp == nullptr) {\n+    st->print_cr(\"OpenFileDescriptorCount = unknown\");\n+    return;\n+  }\n+\n+  while ((dentp = readdir(dirp)) != nullptr) {\n+    if (isdigit(dentp->d_name[0])) fds++;\n+    if (fds % 100 == 0) {\n+      clock_gettime(CLOCK_MONOTONIC, &now);\n+      long elapsed_ms = (now.tv_sec - start.tv_sec) * 1000L +\n+                        (now.tv_nsec - start.tv_nsec) \/ 1000000L;\n+      if (elapsed_ms > TIMEOUT_MS) {\n+        timed_out = true;\n+        break;\n@@ -2735,2 +2750,5 @@\n-    closedir(dirp);\n-    st->print_cr(\"OpenFileDescriptorCount = %d\", fds - 1); \/\/ minus the opendir fd itself\n+  }\n+\n+  closedir(dirp);\n+  if (timed_out) {\n+    st->print_cr(\"OpenFileDescriptorCount > %d\", fds - 1); \/\/ minus the opendir fd itself\n@@ -2738,1 +2756,1 @@\n-    st->print_cr(\"OpenFileDescriptorCount = unknown\");\n+    st->print_cr(\"OpenFileDescriptorCount = %d\", fds - 1);\n","filename":"src\/hotspot\/os\/aix\/os_aix.cpp","additions":26,"deletions":8,"binary":false,"changes":34,"status":"modified"},{"patch":"@@ -85,0 +85,1 @@\n+# include <dirent.h>\n@@ -116,0 +117,1 @@\n+# include <time.h>\n@@ -5456,5 +5458,20 @@\n-  if (dirp != nullptr) {\n-    struct dirent* dentp;\n-    while ((dentp = readdir(dirp)) != nullptr) {\n-      if (isdigit(dentp->d_name[0])) {\n-        fds++;\n+  struct dirent* dentp;\n+  const int TIMEOUT_MS = 50;\n+  struct timespec start, now;\n+  clock_gettime(CLOCK_MONOTONIC, &start);\n+  bool timed_out = false;\n+\n+  if (dirp == nullptr) {\n+    st->print_cr(\"OpenFileDescriptorCount = unknown\");\n+    return;\n+  }\n+\n+  while ((dentp = readdir(dirp)) != nullptr) {\n+    if (isdigit(dentp->d_name[0])) fds++;\n+    if (fds % 100 == 0) {\n+      clock_gettime(CLOCK_MONOTONIC, &now);\n+      long elapsed_ms = (now.tv_sec - start.tv_sec) * 1000L +\n+                        (now.tv_nsec - start.tv_nsec) \/ 1000000L;\n+      if (elapsed_ms > TIMEOUT_MS) {\n+        timed_out = true;\n+        break;\n@@ -5463,2 +5480,5 @@\n-    closedir(dirp);\n-    st->print_cr(\"OpenFileDescriptorCount = %d\", fds - 1); \/\/ minus the opendir fd itself\n+  }\n+\n+  closedir(dirp);\n+  if (timed_out) {\n+    st->print_cr(\"OpenFileDescriptorCount > %d\", fds - 1); \/\/ minus the opendir fd itself\n@@ -5466,1 +5486,1 @@\n-    st->print_cr(\"OpenFileDescriptorCount = unknown\");\n+    st->print_cr(\"OpenFileDescriptorCount = %d\", fds - 1);\n@@ -5468,1 +5488,3 @@\n-}\n\\ No newline at end of file\n+}\n+\n+\n","filename":"src\/hotspot\/os\/linux\/os_linux.cpp","additions":31,"deletions":9,"binary":false,"changes":40,"status":"modified"}]}