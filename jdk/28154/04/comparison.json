{"files":[{"patch":"@@ -263,0 +263,13 @@\n+            \/\/ Check location of an optional manifest entry\n+            if (\"META-INF\/MANIFEST.MF\".equals(entryName)) {\n+                int index = entryInfo.cen().order();\n+                if (index > 1) { \/\/ Expect base manifest at index 0 or 1\n+                    String position = Integer.toString(index);\n+                    errorAndInvalid(formatMsg(\"error.validator.manifest.wrong.position\", position));\n+                } else if (index == 1) { \/\/ Ensure \"META-INF\/\" preceeds manifest\n+                    String firstName = entries.sequencedKeySet().getFirst();\n+                    if (!\"META-INF\/\".equals(firstName)) {\n+                        errorAndInvalid(formatMsg(\"error.validator.metainf.wrong.position\", firstName));\n+                    }\n+                }\n+            }\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/tools\/jar\/Validator.java","additions":13,"deletions":0,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -137,0 +137,4 @@\n+error.validator.metainf.wrong.position=\\\n+        expected entry META-INF\/ to be at position 0, but found: {0}\n+error.validator.manifest.wrong.position=\\\n+        expected entry META-INF\/MANIFEST.MF to be at position 0 or 1, but found it at position: {0}\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/tools\/jar\/resources\/jar.properties","additions":4,"deletions":0,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -41,0 +41,2 @@\n+import static org.junit.jupiter.api.Assertions.assertLinesMatch;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n@@ -45,0 +47,1 @@\n+import java.io.FileInputStream;\n@@ -53,0 +56,1 @@\n+import java.util.jar.JarInputStream;\n@@ -309,0 +313,90 @@\n+    \/**\n+     * Validates that base manifest-related entries are at expected LOC positions.\n+     * <p>\n+     * Copied from <code>JarInputStream.java<\/code>:\n+     * <pre>\n+     * This implementation assumes the META-INF\/MANIFEST.MF entry\n+     * should be either the first or the second entry (when preceded\n+     * by the dir META-INF\/). It skips the META-INF\/ and then\n+     * \"consumes\" the MANIFEST.MF to initialize the Manifest object.\n+     * <\/pre>\n+     * This test does not do a similar CEN check in the event that the LOC and CEN\n+     * entries do not match. Those mismatch cases are already checked by other tests.\n+     *\/\n+    @Test\n+    public void testWrongManifestPositions() throws IOException {\n+        testWrongManifestPosition(\n+                Path.of(\"wrong-entry-position-A.jar\"),\n+                \"\"\"\n+                expected entry META-INF\/ to be at position 0, but found: PLACEHOLDER\n+                \"\"\",\n+                EntryWriter.ofText(\"PLACEHOLDER\", \"0\"),\n+                EntryWriter.ofText(META_INF + \"MANIFEST.MF\", \"Manifest-Version: 1.0\"));\n+        testWrongManifestPosition(\n+                Path.of(\"wrong-entry-position-B.jar\"),\n+                \"\"\"\n+                expected entry META-INF\/MANIFEST.MF to be at position 0 or 1, but found it at position: 2\n+                \"\"\",\n+                EntryWriter.ofDirectory(META_INF),\n+                EntryWriter.ofText(\"PLACEHOLDER\", \"1\"),\n+                EntryWriter.ofText(META_INF + \"MANIFEST.MF\", \"Manifest-Version: 1.0\"));\n+        testWrongManifestPosition(\n+                Path.of(\"wrong-entry-position-C.jar\"),\n+                \"\"\"\n+                expected entry META-INF\/MANIFEST.MF to be at position 0 or 1, but found it at position: 4\n+                \"\"\",\n+                EntryWriter.ofDirectory(META_INF),\n+                EntryWriter.ofText(\"PLACEHOLDER1\", \"1\"),\n+                EntryWriter.ofText(\"PLACEHOLDER2\", \"2\"),\n+                EntryWriter.ofText(\"PLACEHOLDER3\", \"3\"),\n+                EntryWriter.ofText(META_INF + \"MANIFEST.MF\", \"Manifest-Version: 1.0\"));\n+    }\n+\n+    private void testWrongManifestPosition(\n+            Path path, String expectedErrorMessage, EntryWriter... entries) throws IOException {\n+        createZipFile(path, entries);\n+        \/\/ first check JAR file with streaming API\n+        try (var jis = new JarInputStream(new FileInputStream(path.toFile()))) {\n+            var manifest = jis.getManifest();\n+            assertNull(manifest, \"Manifest not null?!\");\n+        }\n+        \/\/ now validate with tool CLI\n+        try {\n+            jar(\"--validate --file \" + path);\n+            fail(\"Expecting non-zero exit code validating: \" + path);\n+        } catch (IOException e) {\n+            var err = e.getMessage();\n+            System.out.println(err);\n+            assertLinesMatch(expectedErrorMessage.lines(), err.lines());\n+        }\n+    }\n+\n+    record EntryWriter(ZipEntry entry, Writer writer) {\n+        @FunctionalInterface\n+        interface Writer {\n+            void write(ZipOutputStream stream) throws IOException;\n+        }\n+        static EntryWriter ofDirectory(String name) {\n+            return new EntryWriter(new ZipEntry(name), _ -> {});\n+        }\n+        static EntryWriter ofText(String name, String text) {\n+            return new EntryWriter(new ZipEntry(name),\n+                    stream -> stream.write(text.getBytes(StandardCharsets.UTF_8)));\n+        }\n+    }\n+\n+    private static void createZipFile(Path path, EntryWriter... entries) throws IOException {\n+        System.out.printf(\"%n%n*****Creating Zip file with %d entries*****%n\".formatted(entries.length));\n+        var out = new ByteArrayOutputStream(1024);\n+        try (var zos = new ZipOutputStream(out)) {\n+            for (var entry : entries) {\n+                System.out.printf(\"  %s%n\".formatted(entry.entry().getName()));\n+                zos.putNextEntry(entry.entry());\n+                entry.writer().write(zos);\n+                zos.closeEntry();\n+            }\n+            zos.flush();\n+        }\n+        Files.write(path, out.toByteArray());\n+    }\n+\n","filename":"test\/jdk\/tools\/jar\/ValidatorTest.java","additions":94,"deletions":0,"binary":false,"changes":94,"status":"modified"}]}