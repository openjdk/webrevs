{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2009, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2009, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -40,0 +40,1 @@\n+import sun.security.util.KeyUtil;\n@@ -209,1 +210,2 @@\n-                dac.permits(trustedPubKey.getAlgorithm(), cp, true);\n+                dac.permits(KeyUtil.getAlgorithm(trustedPubKey),\n+                    cp, true);\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/certpath\/AlgorithmChecker.java","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -32,0 +32,1 @@\n+import java.util.List;\n@@ -73,0 +74,50 @@\n+    \/\/ Allocate the immutable lists as needed. Overwriting is not a concern.\n+    private static List<String> aliasEdDSA = null;\n+    private static List<String> aliasEd25519 = null;\n+    private static List<String> aliasXDH = null;\n+    private static List<String> aliasX25519 = null;\n+\n+    \/**\n+     * getAlias() adds extra algorithm names to the String if matched.  Used by\n+     * checkAlgorithm(), it returns additional names that may be on the\n+     * DisabledAlgorithmConstraints list.\n+     *\/\n+    public static List<String> getAliases(String algorithm) {\n+        return switch (algorithm) {\n+            case \"EdDSA\" -> {\n+                if (aliasEdDSA == null) {\n+                    aliasEdDSA = List.of(\"EdDSA\", \"Ed25519\", \"Ed448\");\n+                }\n+                yield aliasEdDSA;\n+            }\n+            case \"Ed25519\" -> {\n+                if (aliasEd25519 == null) {\n+                    aliasEd25519 = List.of(\"EdDSA\", \"Ed25519\");\n+                }\n+                yield aliasEd25519;\n+            }\n+            case \"XDH\" ->  {\n+                if (aliasXDH == null) {\n+                    aliasXDH = List.of(\"XDH\", \"X25519\", \"X448\");\n+                }\n+                yield aliasXDH;\n+            }\n+            case \"X25519\" ->  {\n+                if (aliasX25519 == null) {\n+                    aliasX25519 = List.of(\"XDH\", \"X25519\");\n+                }\n+                yield aliasX25519;\n+            }\n+            default -> List.of();\n+        };\n+    }\n+\n+    \/**\n+     * This checks a given `algorithm' against the list of 'algorithms' from\n+     * the DisabledAlgorithmConstraints or LegacyAlgorithmConstraints.\n+     *\n+     * @param algorithms List of algorithms from the constraints list\n+     * @param algorithm algorithm being checked against list\n+     * @param decomposer class the decomposing names into sub-elements\n+     * @return\n+     *\/\n@@ -79,2 +130,6 @@\n-        if (algorithms.contains(algorithm)) {\n-            return false;\n+        \/\/ Check `algorithm` against disabled algorithms and their aliases\n+        for (String a : algorithms) {\n+            if (algorithm.equalsIgnoreCase(a) ||\n+                getAliases(a).contains(algorithm)) {\n+                return false;\n+            }\n","filename":"src\/java.base\/share\/classes\/sun\/security\/util\/AbstractAlgorithmConstraints.java","additions":58,"deletions":3,"binary":false,"changes":61,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -37,1 +37,0 @@\n-import java.security.interfaces.XECKey;\n@@ -41,1 +40,0 @@\n-import java.security.spec.NamedParameterSpec;\n@@ -48,1 +46,0 @@\n-import java.util.Arrays;\n@@ -157,1 +154,1 @@\n-        algorithmConstraints = new Constraints(propertyName, disabledAlgorithms);\n+        algorithmConstraints = new Constraints(disabledAlgorithms);\n@@ -271,10 +268,10 @@\n-        if (key instanceof ECKey) {\n-            NamedCurve nc = CurveDB.lookup(((ECKey)key).getParams());\n-            return (nc == null ? List.of()\n-                               : Arrays.asList(nc.getNameAndAliases()));\n-        } else if (key instanceof XECKey) {\n-            return List.of(\n-                ((NamedParameterSpec)((XECKey)key).getParams()).getName());\n-        } else {\n-            return List.of();\n-        }\n+        return switch (key) {\n+            case ECKey ecKey -> {\n+                NamedCurve nc = CurveDB.lookup(ecKey.getParams());\n+                if (nc == null) {\n+                    yield List.of();\n+                }\n+                yield List.of(nc.getNameAndAliases());\n+            }\n+            default -> List.of(KeyUtil.getAlgorithm(key));\n+        };\n@@ -304,1 +301,1 @@\n-        if (!permits(primitives, key.getAlgorithm(), null)) {\n+        if (!permits(primitives, KeyUtil.getAlgorithm(key), null)) {\n@@ -341,1 +338,1 @@\n-        public Constraints(String propertyName, Set<String> constraintSet) {\n+        public Constraints(Set<String> constraintSet) {\n@@ -463,1 +460,1 @@\n-            List<Constraint> list = getConstraints(key.getAlgorithm());\n+            List<Constraint> list = getConstraints(KeyUtil.getAlgorithm(key));\n@@ -517,1 +514,1 @@\n-                    algorithms.add(key.getAlgorithm());\n+                    algorithms.add(KeyUtil.getAlgorithm(key));\n","filename":"src\/java.base\/share\/classes\/sun\/security\/util\/DisabledAlgorithmConstraints.java","additions":16,"deletions":19,"binary":false,"changes":35,"status":"modified"},{"patch":"@@ -177,0 +177,16 @@\n+    \/*\n+     If the key is a sub-algorithm of a larger group of algorithms, this method\n+     will return that sub-algorithm.  For example, key.getAlgorithm() returns\n+     \"EdDSA\", but the underlying key maybe \"Ed448\".  For\n+     DisabledAlgorithmConstraints (DAC), this distinction is important.\n+     \"EdDSA\" means all curves for DAC, but when using it with\n+     KeyPairGenerator, EdDSA means Ed25519.\n+     *\/\n+    public static String getAlgorithm(Key key) {\n+        return switch (key) {\n+            case EdECKey ed -> ed.getParams().getName();\n+            case XECKey xe -> ((NamedParameterSpec) xe.getParams()).getName();\n+            default -> key.getAlgorithm();\n+        };\n+    }\n+\n","filename":"src\/java.base\/share\/classes\/sun\/security\/util\/KeyUtil.java","additions":16,"deletions":0,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -0,0 +1,145 @@\n+\/*\n+ * Copyright (c) 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.  Oracle designates this\n+ * particular file as subject to the \"Classpath\" exception as provided\n+ * by Oracle in the LICENSE file that accompanied this code.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import sun.security.util.DisabledAlgorithmConstraints;\n+\n+import java.security.CryptoPrimitive;\n+import java.security.KeyPairGenerator;\n+import java.security.PrivateKey;\n+import java.security.Security;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.Set;\n+\n+\/*\n+ * @test\n+ * @bug 8346129\n+ * @modules java.base\/sun.security.util\n+ * @summary Check DisabledAlgorithmConstraints methods permit(Key) and\n+ * permit(Set<CryptoPrimitive>, String, APS) with EdDSA & XDH keys\n+ *\n+ * @run main\/othervm DisabledAlgorithmPermits Ed25519\n+ * @run main\/othervm DisabledAlgorithmPermits Ed448\n+ * @run main\/othervm DisabledAlgorithmPermits EdDSA\n+ * @run main\/othervm DisabledAlgorithmPermits X25519\n+ * @run main\/othervm DisabledAlgorithmPermits X448\n+ * @run main\/othervm DisabledAlgorithmPermits XDH\n+ *\/\n+\n+public class DisabledAlgorithmPermits {\n+    public static void main(String[] args) throws Exception {\n+        String algorithm = args[0];\n+        Security.setProperty(\"x\", algorithm);\n+\n+        \/\/ Expected table are the expected results from the test\n+        List<TestCase> expected = switch (algorithm) {\n+            case \"Ed25519\" ->\n+                Arrays.asList(\n+                    new TestCase(\"EdDSA\", false),\n+                    new TestCase(\"Ed25519\", false),\n+                    new TestCase(\"Ed448\", true),\n+                    new TestCase(\"X448\", true));\n+            case \"Ed448\" ->\n+                Arrays.asList(\n+                    new TestCase(\"EdDSA\", true),\n+                    new TestCase(\"Ed25519\", true),\n+                    new TestCase(\"Ed448\", false),\n+                    new TestCase(\"X448\", true));\n+            case \"EdDSA\" ->\n+                Arrays.asList(\n+                    new TestCase(\"EdDSA\", false),\n+                    new TestCase(\"Ed25519\", false),\n+                    new TestCase(\"Ed448\", false),\n+                    new TestCase(\"X448\", true));\n+            case \"X25519\" ->\n+                Arrays.asList(\n+                    new TestCase(\"XDH\", false),\n+                    new TestCase(\"X25519\", false),\n+                    new TestCase(\"X448\", true),\n+                    new TestCase(\"Ed448\", true));\n+            case \"X448\" ->\n+                Arrays.asList(\n+                    new TestCase(\"XDH\", true),\n+                    new TestCase(\"X25519\", true),\n+                    new TestCase(\"X448\", false),\n+                    new TestCase(\"Ed448\", true));\n+            case \"XDH\" ->\n+                Arrays.asList(\n+                    new TestCase(\"XDH\", false),\n+                    new TestCase(\"X25519\", false),\n+                    new TestCase(\"X448\", false),\n+                    new TestCase(\"Ed448\", true));\n+            default -> null;\n+        };\n+\n+        Objects.requireNonNull(expected, \"algorithm being tested \" +\n+            algorithm + \" not in expected table\");\n+        System.out.println(\"---\");\n+        var dac = new DisabledAlgorithmConstraints(\"x\");\n+        System.out.println(\"disabled algorithms = \" + Security.getProperty(\"x\"));\n+        expected.stream().forEach(tc -> {\n+            boolean r;\n+            System.out.print(\"\\tpermits(Set.of(CryptoPrimitive.SIGNATURE), \\\"\" +\n+                tc.testAlgo + \"\\\", null): \" +\n+                (r = dac.permits(Set.of(CryptoPrimitive.SIGNATURE),\n+                tc.testAlgo, null)) + \" : \" );\n+            if (r != tc.expected) {\n+                System.out.println(\"failed.\");\n+                throw new AssertionError(\"failed.  Expected \" +\n+                    tc.expected);\n+            }\n+            System.out.println(\"pass\");\n+        });\n+        expected.stream().forEach(tc -> {\n+            PrivateKey k;\n+            try {\n+                k = KeyPairGenerator.getInstance(tc.testAlgo).generateKeyPair().\n+                    getPrivate();\n+            } catch (Exception e) {\n+                throw new RuntimeException(e);\n+            }\n+            boolean r;\n+            System.out.print(\"\\tpermits(Set.of(CryptoPrimitive.SIGNATURE), \" +\n+                tc.testAlgo + \" privkey): \" +\n+                (r = dac.permits(Set.of(CryptoPrimitive.SIGNATURE), k)) +\n+                \" : \" );\n+            if (r != tc.expected) {\n+                System.out.println(\"failed.\");\n+                throw new AssertionError(\"failed.  Expected \" +\n+                    tc.expected);\n+            }\n+            System.out.println(\"pass\");\n+        });\n+        System.out.println(\"---\");\n+    }\n+\n+    record TestCase(int testType, String testAlgo, boolean expected) {\n+        TestCase(String testAlgo, boolean expected) {\n+            this( 0, testAlgo, expected);\n+        }\n+    }\n+}\n+\n","filename":"test\/jdk\/sun\/security\/util\/AlgorithmConstraints\/DisabledAlgorithmPermits.java","additions":145,"deletions":0,"binary":false,"changes":145,"status":"added"}]}