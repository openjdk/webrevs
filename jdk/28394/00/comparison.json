{"files":[{"patch":"@@ -108,3 +108,7 @@\n-void ParallelArguments::initialize_heap_flags_and_sizes_one_pass() {\n-  \/\/ Do basic sizing work\n-  GenArguments::initialize_heap_flags_and_sizes();\n+size_t ParallelArguments::young_gen_size_lower_bound() {\n+  const size_t num_eden_spaces = UseNUMA\n+      ? os::numa_get_groups_num()\n+      : 1;\n+\n+  \/\/ One for each space in eden and two survivors\n+  return (num_eden_spaces + 2) * SpaceAlignment;\n@@ -114,15 +118,3 @@\n-  initialize_heap_flags_and_sizes_one_pass();\n-\n-  if (!UseLargePages) {\n-    ParallelScavengeHeap::set_desired_page_size(os::vm_page_size());\n-    return;\n-  }\n-\n-  \/\/ If using large-page, need to update SpaceAlignment so that spaces are page-size aligned.\n-  const size_t min_pages = 4; \/\/ 1 for eden + 1 for each survivor + 1 for old\n-  const size_t page_sz = os::page_size_for_region_aligned(MinHeapSize, min_pages);\n-  ParallelScavengeHeap::set_desired_page_size(page_sz);\n-\n-  if (page_sz == os::vm_page_size()) {\n-    log_warning(gc, heap)(\"MinHeapSize (%zu) must be large enough for 4 * page-size; Disabling UseLargePages for heap\", MinHeapSize);\n-    return;\n+  const size_t page_size = UseLargePages ? os::large_page_size() : os::vm_page_size();\n+  if (page_size > SpaceAlignment) {\n+    SpaceAlignment = page_size;\n@@ -131,7 +123,1 @@\n-  \/\/ Space is largepage-aligned.\n-  size_t new_alignment = page_sz;\n-  if (new_alignment != SpaceAlignment) {\n-    SpaceAlignment = new_alignment;\n-    \/\/ Redo everything from the start\n-    initialize_heap_flags_and_sizes_one_pass();\n-  }\n+  GenArguments::initialize_heap_flags_and_sizes();\n","filename":"src\/hotspot\/share\/gc\/parallel\/parallelArguments.cpp","additions":11,"deletions":25,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -36,0 +36,1 @@\n+  virtual size_t young_gen_size_lower_bound();\n@@ -38,2 +39,0 @@\n-  void initialize_heap_flags_and_sizes_one_pass();\n-\n","filename":"src\/hotspot\/share\/gc\/parallel\/parallelArguments.hpp","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -65,1 +65,0 @@\n-size_t ParallelScavengeHeap::_desired_page_size = 0;\n@@ -70,2 +69,1 @@\n-  assert(_desired_page_size != 0, \"Should be initialized\");\n-  ReservedHeapSpace heap_rs = Universe::reserve_heap(reserved_heap_size, HeapAlignment, _desired_page_size);\n+  ReservedHeapSpace heap_rs = Universe::reserve_heap(reserved_heap_size, HeapAlignment);\n","filename":"src\/hotspot\/share\/gc\/parallel\/parallelScavengeHeap.cpp","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -79,3 +79,0 @@\n-  \/\/ At startup, calculate the desired OS page-size based on heap size and large-page flags.\n-  static size_t _desired_page_size;\n-\n@@ -144,5 +141,0 @@\n-  static void set_desired_page_size(size_t page_size) {\n-    assert(is_power_of_2(page_size), \"precondition\");\n-    _desired_page_size = page_size;\n-  }\n-\n","filename":"src\/hotspot\/share\/gc\/parallel\/parallelScavengeHeap.hpp","additions":0,"deletions":8,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -47,9 +47,0 @@\n-static size_t young_gen_size_lower_bound() {\n-  \/\/ The young generation must be aligned and have room for eden + two survivors\n-  return 3 * SpaceAlignment;\n-}\n-\n-static size_t old_gen_size_lower_bound() {\n-  return SpaceAlignment;\n-}\n-\n@@ -74,0 +65,9 @@\n+size_t GenArguments::young_gen_size_lower_bound() {\n+  \/\/ The young generation must be aligned and have room for eden + two survivors\n+  return 3 * SpaceAlignment;\n+}\n+\n+size_t GenArguments::old_gen_size_lower_bound() {\n+  return SpaceAlignment;\n+}\n+\n","filename":"src\/hotspot\/share\/gc\/shared\/genArguments.cpp","additions":9,"deletions":9,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -53,0 +53,2 @@\n+  virtual size_t young_gen_size_lower_bound();\n+  virtual size_t old_gen_size_lower_bound();\n","filename":"src\/hotspot\/share\/gc\/shared\/genArguments.hpp","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -75,0 +75,1 @@\n+#include \"runtime\/globals.hpp\"\n@@ -974,1 +975,1 @@\n-ReservedHeapSpace Universe::reserve_heap(size_t heap_size, size_t alignment, size_t desired_page_size) {\n+ReservedHeapSpace Universe::reserve_heap(size_t heap_size, size_t alignment) {\n@@ -985,14 +986,1 @@\n-  size_t page_size;\n-  if (desired_page_size == 0) {\n-    if (UseLargePages) {\n-      page_size = os::large_page_size();\n-    } else {\n-      page_size = os::vm_page_size();\n-    }\n-  } else {\n-    \/\/ Parallel is the only collector that might opt out of using large pages\n-    \/\/ for the heap.\n-    assert(UseParallelGC , \"only Parallel\");\n-    \/\/ Use caller provided value.\n-    page_size = desired_page_size;\n-  }\n+  size_t page_size = UseLargePages ? os::large_page_size() : os::vm_page_size();\n@@ -1000,0 +988,1 @@\n+\n","filename":"src\/hotspot\/share\/memory\/universe.cpp","additions":4,"deletions":15,"binary":false,"changes":19,"status":"modified"},{"patch":"@@ -319,1 +319,1 @@\n-  static ReservedHeapSpace reserve_heap(size_t heap_size, size_t alignment, size_t desired_page_size = 0);\n+  static ReservedHeapSpace reserve_heap(size_t heap_size, size_t alignment);\n","filename":"src\/hotspot\/share\/memory\/universe.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -32,0 +32,1 @@\n+ * @comment Since 8372150, UseLargePages may alter Min and Initial heap size\n@@ -33,0 +34,1 @@\n+ * @requires !vm.opt.final.UseLargePages\n","filename":"test\/hotspot\/jtreg\/gc\/arguments\/TestParallelHeapSizeFlags.java","additions":2,"deletions":0,"binary":false,"changes":2,"status":"modified"}]}