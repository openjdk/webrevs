{"files":[{"patch":"@@ -4870,1 +4870,11 @@\n-      autovectorize(lpt, &autovectorization_arena);\n+      AutoVectorizeStatus status = autovectorize(lpt, &autovectorization_arena);\n+\n+      if (status == AutoVectorizeStatus::TriedAndFailed) {\n+        \/\/ We tried vectorization, but failed. From now on only unroll the loop.\n+        CountedLoopNode* cl = lpt->_head->as_CountedLoop();\n+        if (cl->has_passed_slp()) {\n+          C->set_major_progress();\n+          cl->set_notpassed_slp();\n+          cl->mark_do_unroll_only();\n+        }\n+      }\n","filename":"src\/hotspot\/share\/opto\/loopnode.cpp","additions":11,"deletions":1,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -1434,2 +1434,7 @@\n-  \/\/ Apply autovectorization if possible\n-  bool autovectorize(IdealLoopTree* lpt, ResourceArea* arena);\n+  \/\/ AutoVectorize the loop: replace scalar ops with vector ops.\n+  enum AutoVectorizeStatus {\n+    Impossible,      \/\/ This loop has the wrong shape to even try vectorization.\n+    Success,         \/\/ We just successfully vectorized the loop.\n+    TriedAndFailed,  \/\/ We tried to vectorize, but failed.\n+  };\n+  AutoVectorizeStatus autovectorize(IdealLoopTree* lpt, ResourceArea* arena);\n","filename":"src\/hotspot\/share\/opto\/loopnode.hpp","additions":7,"deletions":2,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -4213,1 +4213,3 @@\n-bool PhaseIdealLoop::autovectorize(IdealLoopTree* lpt, ResourceArea* arena) {\n+\/\/ AutoVectorize the loop: replace scalar ops with vector ops.\n+PhaseIdealLoop::AutoVectorizeStatus\n+PhaseIdealLoop::autovectorize(IdealLoopTree* lpt, ResourceArea* arena) {\n@@ -4215,2 +4217,3 @@\n-  if (!lpt->is_counted()) { return false; }\n-  CountedLoopNode* cl = lpt->_head->as_CountedLoop();\n+  if (!lpt->is_counted()) {\n+    return AutoVectorizeStatus::Impossible;\n+  }\n@@ -4219,1 +4222,4 @@\n-  if (!cl->is_main_loop()) { return false; }\n+  CountedLoopNode* cl = lpt->_head->as_CountedLoop();\n+  if (!cl->is_main_loop()) {\n+    return AutoVectorizeStatus::Impossible;\n+  }\n@@ -4222,7 +4228,2 @@\n-  if (vloop.check_preconditions()) {\n-    \/\/ Ensure that all data structures from autovectorization are deallocated later.\n-    ResourceMark rm(arena);\n-    SuperWord sw(arena, vloop);\n-    if (sw.transform_loop()) {\n-      return true;\n-    }\n+  if (!vloop.check_preconditions()) {\n+    return AutoVectorizeStatus::TriedAndFailed;\n@@ -4231,6 +4232,5 @@\n-  \/\/ This counted main-loop either failed preconditions,\n-  \/\/ or in SuperWord. From now on only unroll the loop.\n-  if (cl->has_passed_slp()) {\n-    C->set_major_progress();\n-    cl->set_notpassed_slp();\n-    cl->mark_do_unroll_only();\n+  \/\/ Ensure that all data structures from autovectorization are deallocated later.\n+  ResourceMark rm(arena);\n+  SuperWord sw(arena, vloop);\n+  if (!sw.transform_loop()) {\n+    return AutoVectorizeStatus::TriedAndFailed;\n@@ -4238,1 +4238,2 @@\n-  return false;\n+\n+  return AutoVectorizeStatus::Success;\n","filename":"src\/hotspot\/share\/opto\/loopopts.cpp","additions":19,"deletions":18,"binary":false,"changes":37,"status":"modified"}]}