{"files":[{"patch":"@@ -468,5 +468,11 @@\n-    \/\/ We can skip marks on a freshly-allocated object in Eden.\n-    \/\/ Keep this code in sync with new_deferred_store_barrier() in runtime.cpp.\n-    \/\/ That routine informs GC to take appropriate compensating steps,\n-    \/\/ upon a slow-path allocation, so as to make this card-mark\n-    \/\/ elision safe.\n+    \/\/ We use card marks to track old to young references in Generational Shenandoah;\n+    \/\/ see flag ShenandoahCardBarrier above.\n+    \/\/ Objects are always allocated in the young generation and initialized\n+    \/\/ before they are promoted. There's always a safepoint (e.g. at final mark)\n+    \/\/ before an object is promoted from young to old. Promotion entails dirtying of\n+    \/\/ the cards backing promoted objects, so they will be guaranteed to be scanned\n+    \/\/ at the next remembered set scan of the old generation.\n+    \/\/ Thus, we can safely skip card-marking of initializing stores on a\n+    \/\/ freshly-allocated object. If any of the assumptions above change in\n+    \/\/ the future, this code will need to be re-examined; see check in\n+    \/\/ ShenandoahCardBarrier::on_slowpath_allocation_exit().\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/c2\/shenandoahBarrierSetC2.cpp","additions":11,"deletions":5,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -91,0 +91,8 @@\n+void ShenandoahBarrierSet::on_slowpath_allocation_exit(JavaThread* thread, oop new_obj) {\n+#if COMPILER2_OR_JVMCI\n+  assert(!(ReduceInitialCardMarks && ShenandoahCardBarrier) || ShenandoahGenerationalHeap::heap()->is_in_young(new_obj),\n+         \"Error: losing card mark on initialzing store to old gen\");\n+#endif \/\/ COMPILER2_OR_JVMCI\n+  assert(thread->deferred_card_mark().is_empty(), \"We don't use this\");\n+}\n+\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahBarrierSet.cpp","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -80,1 +80,1 @@\n-  void print_on(outputStream* st) const;\n+  void print_on(outputStream* st) const override;\n@@ -87,4 +87,8 @@\n-  virtual void on_thread_create(Thread* thread);\n-  virtual void on_thread_destroy(Thread* thread);\n-  virtual void on_thread_attach(Thread* thread);\n-  virtual void on_thread_detach(Thread* thread);\n+  \/\/ Support for optimizing compilers to call the barrier set on slow path allocations\n+  \/\/ that did not enter a TLAB. Used for e.g. ReduceInitialCardMarks to take any\n+  \/\/ compensating actions to restore card-marks that might otherwise be incorrectly elided.\n+  void on_slowpath_allocation_exit(JavaThread* thread, oop new_obj) override;\n+  void on_thread_create(Thread* thread) override;\n+  void on_thread_destroy(Thread* thread) override;\n+  void on_thread_attach(Thread* thread) override;\n+  void on_thread_detach(Thread* thread) override;\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/shenandoahBarrierSet.hpp","additions":9,"deletions":5,"binary":false,"changes":14,"status":"modified"}]}