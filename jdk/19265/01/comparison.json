{"files":[{"patch":"@@ -1785,0 +1785,26 @@\n+\/\/\n+\/\/ Following shift instruct's are shared by vectorization (in SLP, superword.cpp) and vector API.\n+\/\/\n+\/\/ Shift behaviour in vectorization is defined by java language spec, which includes:\n+\/\/  1. \"If the promoted type of the left-hand operand is int, then only the five lowest-order bits of\n+\/\/      the right-hand operand are used as the shift distance. It is as if the right-hand operand were\n+\/\/      subjected to a bitwise logical AND operator & (ยง15.22.1) with the mask value 0x1f (0b11111).\n+\/\/      The shift distance actually used is therefore always in the range 0 to 31, inclusive.\"\n+\/\/  2. similarly, for long \"with the mask value 0x3f (0b111111)\"\n+\/\/ check https:\/\/docs.oracle.com\/javase\/specs\/jls\/se21\/html\/jls-15.html#jls-15.19 for details.\n+\/\/\n+\/\/ Shift behaviour in Vector APi is defined as:\n+\/\/   e.g. for ASHR, \"a>>(n&(ESIZE*8-1))\"\n+\/\/   this behaviour is the same as shift instrunction's in riscv vector extension.\n+\/\/ check https:\/\/docs.oracle.com\/en\/java\/javase\/21\/docs\/api\/jdk.incubator.vector\/jdk\/incubator\/vector\/VectorOperators.html#ASHR\n+\/\/ and https:\/\/github.com\/riscv\/riscv-v-spec\/blob\/master\/v-spec.adoc#116-vector-single-width-shift-instructions for details.\n+\/\/\n+\/\/ Despite the difference between these 2 behaviours, the same shift instruct's of byte and short are\n+\/\/ still shared between vectorization and Vector API. The way it works is hidden inside the implementation\n+\/\/ of vectorization and Vector API:\n+\/\/  1. when doing optimization vectorization masks the shift value with \"(BitsPerInt - 1)\" or \"(BitsPerLong - 1)\"\n+\/\/  2. in Vector API, shift value is masked with SHIFT_MASK (e.g. for ByteVector it's \"Byte.SIZE - 1\")\n+\/\/\n+\/\/ If not because of this pre-processing of shift value respectively in vectorization and Vector API, then\n+\/\/ e.g. for a byte shift value 16, the intrinsic behaviour will be different, and they can not share the same\n+\/\/ instruct here, as vectorization requires x >> 16, but Vector API requires x >> (16 & 7).\n","filename":"src\/hotspot\/cpu\/riscv\/riscv_v.ad","additions":26,"deletions":0,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -30,1 +30,2 @@\n- * @requires os.arch == \"aarch64\" & vm.compiler2.enabled\n+ * @requires vm.compiler2.enabled\n+ * @requires os.arch == \"aarch64\" | os.arch == \"riscv64\"\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/aarch64\/TestVectorShiftShorts.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -484,0 +484,3 @@\n+    @IR(counts = { IRNode.SUB_VI, \"> 0\", IRNode.LSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -493,0 +496,3 @@\n+    @IR(counts = { IRNode.SUB_VI, \"> 0\", IRNode.LSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -525,0 +531,8 @@\n+    @IR(counts = { IRNode.ADD_VI,\n+                   IRNode.VECTOR_SIZE + \"min(max_int, max_long)\", \"> 0\",\n+                   IRNode.RSHIFT_VI,\n+                   IRNode.VECTOR_SIZE + \"min(max_int, max_long)\", \"> 0\",\n+                   IRNode.SUB_VI,\n+                   IRNode.VECTOR_SIZE + \"min(max_int, max_long)\", \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -545,0 +559,8 @@\n+    @IR(counts = { IRNode.ADD_VI,\n+                   IRNode.VECTOR_SIZE + \"min(max_int, max_long)\", \"> 0\",\n+                   IRNode.RSHIFT_VI,\n+                   IRNode.VECTOR_SIZE + \"min(max_int, max_long)\", \"> 0\",\n+                   IRNode.SUB_VI,\n+                   IRNode.VECTOR_SIZE + \"min(max_int, max_long)\", \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -665,0 +687,3 @@\n+    @IR(counts = { IRNode.LSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -674,0 +699,3 @@\n+    @IR(counts = { IRNode.LSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -686,0 +714,5 @@\n+    @IR(counts = { IRNode.LSHIFT_VI,     \"= 0\",\n+                   IRNode.LOAD_VECTOR_I, \"> 0\",\n+                   IRNode.STORE_VECTOR,  \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -698,0 +731,5 @@\n+    @IR(counts = { IRNode.LSHIFT_VI,     \"= 0\",\n+                   IRNode.LOAD_VECTOR_I, \"> 0\",\n+                   IRNode.STORE_VECTOR,  \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -707,0 +745,3 @@\n+    @IR(counts = { IRNode.LSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -716,0 +757,3 @@\n+    @IR(counts = { IRNode.URSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -725,0 +769,3 @@\n+    @IR(counts = { IRNode.URSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -737,0 +784,5 @@\n+    @IR(counts = { IRNode.URSHIFT_VI,    \"= 0\",\n+                   IRNode.LOAD_VECTOR_I, \"> 0\",\n+                   IRNode.STORE_VECTOR,  \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -749,0 +801,5 @@\n+    @IR(counts = { IRNode.URSHIFT_VI,    \"= 0\",\n+                   IRNode.LOAD_VECTOR_I, \"> 0\",\n+                   IRNode.STORE_VECTOR,  \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -758,0 +815,3 @@\n+    @IR(counts = { IRNode.URSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -767,0 +827,3 @@\n+    @IR(counts = { IRNode.RSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -776,0 +839,3 @@\n+    @IR(counts = { IRNode.RSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -788,0 +854,5 @@\n+    @IR(counts = { IRNode.RSHIFT_VI,     \"= 0\",\n+                   IRNode.LOAD_VECTOR_I, \"> 0\",\n+                   IRNode.STORE_VECTOR,  \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -800,0 +871,5 @@\n+    @IR(counts = { IRNode.RSHIFT_VI,     \"= 0\",\n+                   IRNode.LOAD_VECTOR_I, \"> 0\",\n+                   IRNode.STORE_VECTOR,  \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n@@ -809,0 +885,3 @@\n+    @IR(counts = { IRNode.RSHIFT_VI, \"> 0\" },\n+        applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"})\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/cr7200264\/TestIntVect.java","additions":79,"deletions":0,"binary":false,"changes":79,"status":"modified"},{"patch":"@@ -37,1 +37,2 @@\n- * @requires ((os.arch==\"amd64\" | os.arch==\"x86_64\") & (vm.opt.UseSSE == \"null\" | vm.opt.UseSSE > 3)) | os.arch==\"aarch64\"\n+ * @requires ((os.arch==\"amd64\" | os.arch==\"x86_64\") & (vm.opt.UseSSE == \"null\" | vm.opt.UseSSE > 3)) | os.arch==\"aarch64\" |\n+ *           (os.arch == \"riscv64\" & vm.cpu.features ~= \".*v,.*\")\n","filename":"test\/hotspot\/jtreg\/compiler\/c2\/irTests\/TestVectorizeURShiftSubword.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -107,0 +107,1 @@\n+        \"v\",\n","filename":"test\/hotspot\/jtreg\/compiler\/lib\/ir_framework\/test\/IREncodingPrinter.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -38,1 +38,1 @@\n- * @requires (os.simpleArch == \"x64\") | (os.simpleArch == \"aarch64\")\n+ * @requires (os.simpleArch == \"x64\") | (os.simpleArch == \"aarch64\") | (os.simpleArch == \"riscv64\")\n@@ -102,0 +102,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VI, \">0\"})\n@@ -113,0 +116,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VI, \">0\"})\n@@ -124,0 +130,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VS, \">0\"})\n@@ -135,0 +144,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VS, \">0\"})\n@@ -146,0 +158,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.LSHIFT_VL, \">0\"})\n@@ -157,0 +172,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.URSHIFT_VL, \">0\"})\n@@ -190,0 +208,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VS, \">0\"})\n","filename":"test\/hotspot\/jtreg\/compiler\/vectorization\/runner\/ArrayShiftOpTest.java","additions":22,"deletions":1,"binary":false,"changes":23,"status":"modified"},{"patch":"@@ -194,0 +194,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.LSHIFT_VB, \">0\"})\n@@ -205,0 +208,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VB, \">0\"})\n@@ -216,0 +222,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VB, \">0\"})\n","filename":"test\/hotspot\/jtreg\/compiler\/vectorization\/runner\/BasicByteOpTest.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -196,0 +196,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.LSHIFT_VC, \">0\"})\n@@ -207,0 +210,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.URSHIFT_VC, \">0\"})\n@@ -218,0 +224,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.URSHIFT_VC, \">0\"})\n","filename":"test\/hotspot\/jtreg\/compiler\/vectorization\/runner\/BasicCharOpTest.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -203,0 +203,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.LSHIFT_VI, \">0\"})\n@@ -214,0 +217,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VI, \">0\"})\n@@ -225,0 +231,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.URSHIFT_VI, \">0\"})\n","filename":"test\/hotspot\/jtreg\/compiler\/vectorization\/runner\/BasicIntOpTest.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -39,1 +39,1 @@\n- * @requires (os.simpleArch == \"x64\") | (os.simpleArch == \"aarch64\")\n+ * @requires (os.simpleArch == \"x64\") | (os.simpleArch == \"aarch64\") | (os.simpleArch == \"riscv64\")\n@@ -195,0 +195,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.LSHIFT_VL, \">0\"})\n@@ -206,0 +209,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VL, \">0\"})\n@@ -217,0 +223,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.URSHIFT_VL, \">0\"})\n","filename":"test\/hotspot\/jtreg\/compiler\/vectorization\/runner\/BasicLongOpTest.java","additions":10,"deletions":1,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -194,0 +194,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.LSHIFT_VS, \">0\"})\n@@ -205,0 +208,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VS, \">0\"})\n@@ -241,0 +247,3 @@\n+    @IR(applyIfPlatform = {\"riscv64\", \"true\"},\n+        applyIfCPUFeature = {\" v \", \"true\"},\n+        counts = {IRNode.RSHIFT_VS, \">0\"})\n","filename":"test\/hotspot\/jtreg\/compiler\/vectorization\/runner\/BasicShortOpTest.java","additions":9,"deletions":0,"binary":false,"changes":9,"status":"modified"}]}