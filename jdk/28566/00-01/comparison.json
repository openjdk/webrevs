{"files":[{"patch":"@@ -27,1 +27,1 @@\n- * @test TestParallelGCThreads\n+ * @test id=DefaultValue\n@@ -29,2 +29,1 @@\n- * @requires vm.gc == null\n- * @summary Tests argument processing for ParallelGCThreads\n+ * @summary Tests default value of ParallelGCThreads\n@@ -33,5 +32,42 @@\n- * @modules java.base\/jdk.internal.misc\n- *          java.management\n- * @build jdk.test.whitebox.WhiteBox\n- * @run driver jdk.test.lib.helpers.ClassFileInstaller jdk.test.whitebox.WhiteBox\n- * @run main\/othervm -Xbootclasspath\/a:. -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI gc.arguments.TestParallelGCThreads\n+ * @requires vm.gc.Z | vm.gc.Parallel | vm.gc.G1\n+ * @run driver gc.arguments.TestParallelGCThreads DefaultValue\n+ *\/\n+\n+\/*\n+ * @test id=Z\n+ * @bug 8059527 8081382\n+ * @summary Tests argument processing for ParallelGCThreads with ZGC\n+ * @library \/test\/lib\n+ * @library \/\n+ * @requires vm.gc.Z\n+ * @run driver gc.arguments.TestParallelGCThreads Z\n+ *\/\n+\n+\/*\n+ * @test id=Parallel\n+ * @bug 8059527 8081382\n+ * @summary Tests argument processing for ParallelGCThreads with Parallel GC\n+ * @library \/test\/lib\n+ * @library \/\n+ * @requires vm.gc.Parallel\n+ * @run driver gc.arguments.TestParallelGCThreads Parallel\n+ *\/\n+\n+\/*\n+ * @test id=G1\n+ * @bug 8059527 8081382\n+ * @summary Tests argument processing for ParallelGCThreads with G1 GC\n+ * @library \/test\/lib\n+ * @library \/\n+ * @requires vm.gc.G1\n+ * @run driver gc.arguments.TestParallelGCThreads G1\n+ *\/\n+\n+\/*\n+ * @test id=MaxValue\n+ * @bug 8059527 8081382\n+ * @summary Tests max value for ParallelGCThreads\n+ * @library \/test\/lib\n+ * @library \/\n+ * @requires vm.gc.Serial\n+ * @run driver gc.arguments.TestParallelGCThreads MaxValue\n@@ -40,2 +76,0 @@\n-import java.util.ArrayList;\n-import java.util.List;\n@@ -44,2 +78,0 @@\n-import jtreg.SkippedException;\n-import jdk.test.whitebox.gc.GC;\n@@ -50,2 +82,25 @@\n-    testFlags();\n-    testDefaultValue();\n+    if (args.length == 0) {\n+      throw new IllegalArgumentException(\"Test type must be specified as argument\");\n+    }\n+\n+    String testType = args[0];\n+\n+    switch (testType) {\n+      case \"DefaultValue\":\n+        testDefaultValue();\n+        break;\n+      case \"Z\":\n+        testFlags(\"-XX:+UseZGC\");\n+        break;\n+      case \"Parallel\":\n+        testFlags(\"-XX:+UseParallelGC\");\n+        break;\n+      case \"G1\":\n+        testFlags(\"-XX:+UseG1GC\");\n+        break;\n+      case \"MaxValue\":\n+        testMaxValue();\n+        break;\n+      default:\n+        throw new IllegalArgumentException(\"Unknown test type \\\"\" + testType + \"\\\"\");\n+    }\n@@ -59,1 +114,1 @@\n-  public static void testDefaultValue()  throws Exception {\n+  private static void testDefaultValue()  throws Exception {\n@@ -80,3 +135,1 @@\n-  public static void testFlags() throws Exception {\n-    \/\/ For each parallel collector (G1, Parallel)\n-    List<String> supportedGC = new ArrayList<String>();\n+  private static void testFlags(String gcFlag) throws Exception {\n@@ -84,13 +137,7 @@\n-    if (GC.G1.isSupported()) {\n-      supportedGC.add(\"G1\");\n-    }\n-    if (GC.Parallel.isSupported()) {\n-      supportedGC.add(\"Parallel\");\n-    }\n-    if (GC.Z.isSupported()) {\n-      supportedGC.add(\"Z\");\n-    }\n-\n-    if (supportedGC.isEmpty()) {\n-      throw new SkippedException(\"Skipping test because none of G1\/Parallel is supported.\");\n-    }\n+    \/\/ Make sure the VM does not allow ParallelGCThreads set to 0\n+    OutputAnalyzer output = GCArguments.executeTestJava(\n+        gcFlag,\n+        \"-XX:ParallelGCThreads=0\",\n+        \"-XX:+PrintFlagsFinal\",\n+        \"-version\");\n+    output.shouldHaveExitValue(1);\n@@ -98,5 +145,5 @@\n-    for (String gc : supportedGC) {\n-      \/\/ Make sure the VM does not allow ParallelGCThreads set to 0\n-      OutputAnalyzer output = GCArguments.executeTestJava(\n-          \"-XX:+Use\" + gc + \"GC\",\n-          \"-XX:ParallelGCThreads=0\",\n+    \/\/ Do some basic testing to ensure the flag updates the count\n+    for (long i = 1; i <= 3; i++) {\n+      long count = getParallelGCThreadCount(\n+          gcFlag,\n+          \"-XX:ParallelGCThreads=\" + i,\n@@ -105,11 +152,1 @@\n-      output.shouldHaveExitValue(1);\n-\n-      \/\/ Do some basic testing to ensure the flag updates the count\n-      for (long i = 1; i <= 3; i++) {\n-        long count = getParallelGCThreadCount(\n-            \"-XX:+Use\" + gc + \"GC\",\n-            \"-XX:ParallelGCThreads=\" + i,\n-            \"-XX:+PrintFlagsFinal\",\n-            \"-version\");\n-        Asserts.assertEQ(count, i, \"Specifying ParallelGCThreads=\" + i + \" for \" + gc + \"GC does not set the thread count properly!\");\n-      }\n+      Asserts.assertEQ(count, i, \"Specifying ParallelGCThreads=\" + i + \" for \\\"\" + gcFlag + \"\\\" does not set the thread count properly!\");\n@@ -117,0 +154,1 @@\n+  }\n@@ -118,0 +156,1 @@\n+  private static void testMaxValue() throws Exception {\n","filename":"test\/hotspot\/jtreg\/gc\/arguments\/TestParallelGCThreads.java","additions":86,"deletions":47,"binary":false,"changes":133,"status":"modified"}]}