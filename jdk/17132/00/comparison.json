{"files":[{"patch":"@@ -29,1 +29,1 @@\n-import java.util.Date;\n+import java.util.*;\n@@ -182,0 +182,2 @@\n+    private record AttributeInfo(Byte[] valueTags, Class<?> valueClass, boolean singleValued) {}\n+\n@@ -190,4 +192,0 @@\n-        \/\/ set unused PKCS9_OIDS entries to null\n-        \/\/ rest are initialized with public constants\n-        PKCS9_OIDS[0] = PKCS9_OIDS[11] = PKCS9_OIDS[12] = PKCS9_OIDS[13] =\n-        PKCS9_OIDS[15] = null;\n@@ -201,12 +199,12 @@\n-    public static final ObjectIdentifier EMAIL_ADDRESS_OID = PKCS9_OIDS[1] =\n-            ObjectIdentifier.of(KnownOIDs.EmailAddress);\n-    public static final ObjectIdentifier UNSTRUCTURED_NAME_OID = PKCS9_OIDS[2] =\n-            ObjectIdentifier.of(KnownOIDs.UnstructuredName);\n-    public static final ObjectIdentifier CONTENT_TYPE_OID = PKCS9_OIDS[3] =\n-            ObjectIdentifier.of(KnownOIDs.ContentType);\n-    public static final ObjectIdentifier MESSAGE_DIGEST_OID = PKCS9_OIDS[4] =\n-            ObjectIdentifier.of(KnownOIDs.MessageDigest);\n-    public static final ObjectIdentifier SIGNING_TIME_OID = PKCS9_OIDS[5] =\n-            ObjectIdentifier.of(KnownOIDs.SigningTime);\n-    public static final ObjectIdentifier COUNTERSIGNATURE_OID = PKCS9_OIDS[6] =\n-            ObjectIdentifier.of(KnownOIDs.CounterSignature);\n+    public static final ObjectIdentifier EMAIL_ADDRESS_OID =\n+        ObjectIdentifier.of(KnownOIDs.EmailAddress);\n+    public static final ObjectIdentifier UNSTRUCTURED_NAME_OID =\n+        ObjectIdentifier.of(KnownOIDs.UnstructuredName);\n+    public static final ObjectIdentifier CONTENT_TYPE_OID =\n+        ObjectIdentifier.of(KnownOIDs.ContentType);\n+    public static final ObjectIdentifier MESSAGE_DIGEST_OID =\n+        ObjectIdentifier.of(KnownOIDs.MessageDigest);\n+    public static final ObjectIdentifier SIGNING_TIME_OID =\n+        ObjectIdentifier.of(KnownOIDs.SigningTime);\n+    public static final ObjectIdentifier COUNTERSIGNATURE_OID =\n+        ObjectIdentifier.of(KnownOIDs.CounterSignature);\n@@ -214,1 +212,1 @@\n-            PKCS9_OIDS[7] = ObjectIdentifier.of(KnownOIDs.ChallengePassword);\n+        ObjectIdentifier.of(KnownOIDs.ChallengePassword);\n@@ -216,1 +214,1 @@\n-            PKCS9_OIDS[8] = ObjectIdentifier.of(KnownOIDs.UnstructuredAddress);\n+        ObjectIdentifier.of(KnownOIDs.UnstructuredAddress);\n@@ -218,2 +216,1 @@\n-            PKCS9_OIDS[9] =\n-            ObjectIdentifier.of(KnownOIDs.ExtendedCertificateAttributes);\n+        ObjectIdentifier.of(KnownOIDs.ExtendedCertificateAttributes);\n@@ -221,2 +218,1 @@\n-            PKCS9_OIDS[10] =\n-            ObjectIdentifier.of(KnownOIDs.IssuerAndSerialNumber);\n+        ObjectIdentifier.of(KnownOIDs.IssuerAndSerialNumber);\n@@ -226,1 +222,1 @@\n-            PKCS9_OIDS[14] = ObjectIdentifier.of(KnownOIDs.ExtensionRequest);\n+        ObjectIdentifier.of(KnownOIDs.ExtensionRequest);\n@@ -228,1 +224,1 @@\n-            PKCS9_OIDS[16] = ObjectIdentifier.of(KnownOIDs.SigningCertificate);\n+        ObjectIdentifier.of(KnownOIDs.SigningCertificate);\n@@ -230,2 +226,1 @@\n-            PKCS9_OIDS[17] =\n-            ObjectIdentifier.of(KnownOIDs.SignatureTimestampToken);\n+        ObjectIdentifier.of(KnownOIDs.SignatureTimestampToken);\n@@ -233,45 +228,10 @@\n-            PKCS9_OIDS[18] =\n-            ObjectIdentifier.of(KnownOIDs.CMSAlgorithmProtection);\n-\n-    \/**\n-     * Acceptable ASN.1 tags for DER encodings of values of PKCS9\n-     * attributes, by index in <code>PKCS9_OIDS<\/code>.\n-     * Sets of acceptable tags are represented as arrays.\n-     *\/\n-    private static final Byte[][] PKCS9_VALUE_TAGS = {\n-        null,\n-        {DerValue.tag_IA5String},   \/\/ EMailAddress\n-        {DerValue.tag_IA5String,\n-         DerValue.tag_PrintableString,\n-         DerValue.tag_T61String,\n-         DerValue.tag_BMPString,\n-         DerValue.tag_UniversalString,\n-         DerValue.tag_UTF8String},  \/\/ UnstructuredName\n-        {DerValue.tag_ObjectId},    \/\/ ContentType\n-        {DerValue.tag_OctetString}, \/\/ MessageDigest\n-        {DerValue.tag_UtcTime,\n-         DerValue.tag_GeneralizedTime}, \/\/ SigningTime\n-        {DerValue.tag_Sequence},    \/\/ Countersignature\n-        {DerValue.tag_PrintableString,\n-         DerValue.tag_T61String,\n-         DerValue.tag_BMPString,\n-         DerValue.tag_UniversalString,\n-         DerValue.tag_UTF8String},   \/\/ ChallengePassword\n-        {DerValue.tag_PrintableString,\n-         DerValue.tag_T61String,\n-         DerValue.tag_BMPString,\n-         DerValue.tag_UniversalString,\n-         DerValue.tag_UTF8String},   \/\/ UnstructuredAddress\n-        {DerValue.tag_SetOf},       \/\/ ExtendedCertificateAttributes\n-        {DerValue.tag_Sequence},    \/\/ issuerAndSerialNumber\n-        null,\n-        null,\n-        null,\n-        {DerValue.tag_Sequence},    \/\/ extensionRequest\n-        {DerValue.tag_Sequence},    \/\/ SMIMECapability\n-        {DerValue.tag_Sequence},    \/\/ SigningCertificate\n-        {DerValue.tag_Sequence},    \/\/ SignatureTimestampToken\n-        {DerValue.tag_Sequence}     \/\/ CMSAlgorithmProtection\n-    };\n-\n-    private static final Class<?>[] VALUE_CLASSES = new Class<?>[19];\n+        ObjectIdentifier.of(KnownOIDs.CMSAlgorithmProtection);\n+\n+    private static final Map<ObjectIdentifier,AttributeInfo> oidMap = new LinkedHashMap<>();\n+    private static void add(ObjectIdentifier oid, boolean singleValued,\n+                            Class<?> valueClass, Byte[] valueTags) {\n+        AttributeInfo info = new AttributeInfo(valueTags,valueClass,singleValued);\n+        if (oidMap.put(oid, info) != null) {\n+            throw new RuntimeException(\"Duplication oid: \" + oid);\n+        }\n+    }\n@@ -283,23 +243,53 @@\n-            VALUE_CLASSES[0] = null;  \/\/ not used\n-            VALUE_CLASSES[1] = str;   \/\/ EMailAddress\n-            VALUE_CLASSES[2] = str;   \/\/ UnstructuredName\n-            VALUE_CLASSES[3] =        \/\/ ContentType\n-                Class.forName(\"sun.security.util.ObjectIdentifier\");\n-            VALUE_CLASSES[4] = BYTE_ARRAY_CLASS; \/\/ MessageDigest (byte[])\n-            VALUE_CLASSES[5] = Class.forName(\"java.util.Date\"); \/\/ SigningTime\n-            VALUE_CLASSES[6] =        \/\/ Countersignature\n-                Class.forName(\"[Lsun.security.pkcs.SignerInfo;\");\n-            VALUE_CLASSES[7] =        \/\/ ChallengePassword\n-                Class.forName(\"java.lang.String\");\n-            VALUE_CLASSES[8] = str;   \/\/ UnstructuredAddress\n-            VALUE_CLASSES[9] = null;  \/\/ ExtendedCertificateAttributes\n-            VALUE_CLASSES[10] = null;  \/\/ IssuerAndSerialNumber\n-            VALUE_CLASSES[11] = null;  \/\/ not used\n-            VALUE_CLASSES[12] = null;  \/\/ not used\n-            VALUE_CLASSES[13] = null;  \/\/ not used\n-            VALUE_CLASSES[14] =        \/\/ ExtensionRequest\n-                Class.forName(\"sun.security.x509.CertificateExtensions\");\n-            VALUE_CLASSES[15] = null;  \/\/ not supported yet\n-            VALUE_CLASSES[16] = null;  \/\/ not supported yet\n-            VALUE_CLASSES[17] = BYTE_ARRAY_CLASS;  \/\/ SignatureTimestampToken\n-            VALUE_CLASSES[18] = BYTE_ARRAY_CLASS;  \/\/ CMSAlgorithmProtection\n+            add(EMAIL_ADDRESS_OID, false, str,\n+                new Byte[]{DerValue.tag_IA5String});\n+\n+            add(UNSTRUCTURED_NAME_OID, false, str, new Byte[]{\n+                DerValue.tag_IA5String,\n+                DerValue.tag_PrintableString,\n+                DerValue.tag_T61String,\n+                DerValue.tag_BMPString,\n+                DerValue.tag_UniversalString,\n+                DerValue.tag_UTF8String});\n+\n+            add(CONTENT_TYPE_OID, true,\n+                Class.forName(\"sun.security.util.ObjectIdentifier\"),\n+                new Byte[]{DerValue.tag_ObjectId});\n+\n+            add(MESSAGE_DIGEST_OID, true, BYTE_ARRAY_CLASS,\n+                new Byte[]{DerValue.tag_OctetString});\n+\n+            add(SIGNING_TIME_OID, true, Class.forName(\"java.util.Date\"),\n+                new Byte[]{DerValue.tag_UtcTime, DerValue.tag_GeneralizedTime});\n+\n+            add(COUNTERSIGNATURE_OID, false,\n+                Class.forName(\"[Lsun.security.pkcs.SignerInfo;\"),\n+                new Byte[] {DerValue.tag_Sequence});\n+\n+            add(CHALLENGE_PASSWORD_OID, true,\n+                Class.forName(\"java.lang.String\"), new Byte[]{\n+                    DerValue.tag_PrintableString,\n+                    DerValue.tag_T61String,\n+                    DerValue.tag_BMPString,\n+                    DerValue.tag_UniversalString,\n+                    DerValue.tag_UTF8String});\n+\n+            add(UNSTRUCTURED_ADDRESS_OID, false, str, new Byte[]{\n+                DerValue.tag_PrintableString,\n+                DerValue.tag_T61String,\n+                DerValue.tag_BMPString,\n+                DerValue.tag_UniversalString,\n+                DerValue.tag_UTF8String});\n+\n+            add(EXTENSION_REQUEST_OID, true,\n+                Class.forName(\"sun.security.x509.CertificateExtensions\"),\n+                new Byte[]{DerValue.tag_Sequence});\n+\n+            add(SIGNING_CERTIFICATE_OID, true, null,\n+                new Byte[]{DerValue.tag_Sequence});\n+\n+            add(SIGNATURE_TIMESTAMP_TOKEN_OID, true, BYTE_ARRAY_CLASS,\n+                new Byte[]{DerValue.tag_Sequence});\n+\n+            add(CMS_ALGORITHM_PROTECTION_OID, true, BYTE_ARRAY_CLASS,\n+                new Byte[]{DerValue.tag_Sequence});\n+\n@@ -311,26 +301,0 @@\n-    \/**\n-     * Array indicating which PKCS9 attributes are single-valued,\n-     * by index in <code>PKCS9_OIDS<\/code>.\n-     *\/\n-    private static final boolean[] SINGLE_VALUED = {\n-      false,\n-      false,   \/\/ EMailAddress\n-      false,   \/\/ UnstructuredName\n-      true,    \/\/ ContentType\n-      true,    \/\/ MessageDigest\n-      true,    \/\/ SigningTime\n-      false,   \/\/ Countersignature\n-      true,    \/\/ ChallengePassword\n-      false,   \/\/ UnstructuredAddress\n-      false,   \/\/ ExtendedCertificateAttributes\n-      true,    \/\/ IssuerAndSerialNumber - not supported yet\n-      false,   \/\/ not used\n-      false,   \/\/ not used\n-      false,   \/\/ not used\n-      true,    \/\/ ExtensionRequest\n-      true,    \/\/ SMIMECapability - not supported yet\n-      true,    \/\/ SigningCertificate\n-      true,    \/\/ SignatureTimestampToken\n-      true,    \/\/ CMSAlgorithmProtection\n-    };\n-\n@@ -346,1 +310,1 @@\n-    private int index;\n+    private AttributeInfo info;\n@@ -378,2 +342,2 @@\n-        index = indexOf(oid, PKCS9_OIDS, 1);\n-        Class<?> clazz = index == -1 ? BYTE_ARRAY_CLASS: VALUE_CLASSES[index];\n+        info = oidMap.get(oid);\n+        Class<?> clazz = (info == null) ? BYTE_ARRAY_CLASS : info.valueClass();\n@@ -397,1 +361,0 @@\n-\n@@ -421,2 +384,2 @@\n-        index = indexOf(oid, PKCS9_OIDS, 1);\n-        if (index == -1) {\n+        info = oidMap.get(oid);\n+        if (info == null) {\n@@ -431,1 +394,1 @@\n-        if (SINGLE_VALUED[index] && elems.length > 1)\n+        if (info.singleValued() && elems.length > 1)\n@@ -438,1 +401,1 @@\n-            if (indexOf(tag, PKCS9_VALUE_TAGS[index], 0) == -1)\n+            if (indexOf(tag, info.valueTags(), 0) == -1)\n@@ -442,4 +405,6 @@\n-        switch (index) {\n-        case 1:     \/\/ email address\n-        case 2:     \/\/ unstructured name\n-        case 8:     \/\/ unstructured address\n+        \/\/should the behavior be different for RSA\/smime\n+        KnownOIDs knownOID = KnownOIDs.findMatch(oid.toString());\n+        switch (knownOID) {\n+        case KnownOIDs.EmailAddress:\n+        case KnownOIDs.UnstructuredName:\n+        case KnownOIDs.UnstructuredAddress:\n@@ -455,1 +420,1 @@\n-        case 3:     \/\/ content type\n+        case KnownOIDs.ContentType:\n@@ -459,1 +424,1 @@\n-        case 4:     \/\/ message digest\n+        case KnownOIDs.MessageDigest:\n@@ -463,1 +428,1 @@\n-        case 5:     \/\/ signing time\n+        case KnownOIDs.SigningTime:\n@@ -469,1 +434,1 @@\n-        case 6:     \/\/ countersignature\n+        case KnownOIDs.CounterSignature:\n@@ -479,1 +444,1 @@\n-        case 7:     \/\/ challenge password\n+        case KnownOIDs.ChallengePassword:\n@@ -483,18 +448,1 @@\n-        case 9:     \/\/ extended-certificate attribute -- not supported\n-            throw new IOException(\"PKCS9 extended-certificate \" +\n-                                  \"attribute not supported.\");\n-            \/\/ break unnecessary\n-        case 10:    \/\/ issuerAndserialNumber attribute -- not supported\n-            throw new IOException(\"PKCS9 IssuerAndSerialNumber \" +\n-                                  \"attribute not supported.\");\n-            \/\/ break unnecessary\n-        case 11:    \/\/ RSA DSI proprietary\n-        case 12:    \/\/ RSA DSI proprietary\n-            throw new IOException(\"PKCS9 RSA DSI attributes \" +\n-                                  \"11 and 12, not supported.\");\n-            \/\/ break unnecessary\n-        case 13:    \/\/ S\/MIME unused attribute\n-            throw new IOException(\"PKCS9 attribute #13 not supported.\");\n-            \/\/ break unnecessary\n-\n-        case 14:     \/\/ ExtensionRequest\n+        case KnownOIDs.ExtensionRequest:\n@@ -505,5 +453,1 @@\n-        case 15:     \/\/ SMIME-capability attribute -- not supported\n-            throw new IOException(\"PKCS9 SMIMECapability \" +\n-                                  \"attribute not supported.\");\n-            \/\/ break unnecessary\n-        case 16:     \/\/ SigningCertificate attribute\n+        case KnownOIDs.SigningCertificate:\n@@ -513,2 +457,2 @@\n-        case 17:     \/\/ SignatureTimestampToken attribute\n-        case 18:     \/\/ CMSAlgorithmProtection\n+        case KnownOIDs.SignatureTimestampToken:\n+        case KnownOIDs.CMSAlgorithmProtection:\n@@ -518,1 +462,1 @@\n-        default: \/\/ can't happen\n+        default: \/\/ Can't happen\n@@ -534,2 +478,3 @@\n-        switch (index) {\n-        case -1:    \/\/ Unknown\n+\n+        KnownOIDs knownOID = KnownOIDs.findMatch(oid.toString());\n+        if (knownOID == null) {\n@@ -537,3 +482,7 @@\n-            break;\n-        case 1:     \/\/ email address\n-        case 2:     \/\/ unstructured name\n+            out.write(DerValue.tag_Sequence, temp.toByteArray());\n+            return;\n+        }\n+\n+        switch (knownOID) {\n+        case KnownOIDs.EmailAddress:\n+        case KnownOIDs.UnstructuredName:\n@@ -553,1 +502,1 @@\n-        case 3:     \/\/ content type\n+        case KnownOIDs.ContentType:\n@@ -561,1 +510,1 @@\n-        case 4:     \/\/ message digest\n+        case KnownOIDs.MessageDigest:\n@@ -569,1 +518,1 @@\n-        case 5:     \/\/ signing time\n+        case KnownOIDs.SigningTime:\n@@ -577,1 +526,1 @@\n-        case 6:     \/\/ countersignature\n+        case KnownOIDs.CounterSignature:\n@@ -581,1 +530,1 @@\n-        case 7:     \/\/ challenge password\n+        case KnownOIDs.ChallengePassword:\n@@ -589,1 +538,1 @@\n-        case 8:     \/\/ unstructured address\n+        case KnownOIDs.UnstructuredAddress:\n@@ -603,18 +552,1 @@\n-        case 9:     \/\/ extended-certificate attribute -- not supported\n-            throw new IllegalArgumentException(\"PKCS9 extended-certificate \" +\n-                                  \"attribute not supported.\");\n-            \/\/ break unnecessary\n-        case 10:    \/\/ issuerAndserialNumber attribute -- not supported\n-            throw new IllegalArgumentException(\"PKCS9 IssuerAndSerialNumber \" +\n-                                  \"attribute not supported.\");\n-            \/\/ break unnecessary\n-        case 11:    \/\/ RSA DSI proprietary\n-        case 12:    \/\/ RSA DSI proprietary\n-            throw new IllegalArgumentException(\"PKCS9 RSA DSI attributes \" +\n-                                  \"11 and 12, not supported.\");\n-            \/\/ break unnecessary\n-        case 13:    \/\/ S\/MIME unused attribute\n-            throw new IllegalArgumentException(\"PKCS9 attribute #13 not supported.\");\n-            \/\/ break unnecessary\n-\n-        case 14:     \/\/ ExtensionRequest\n+        case KnownOIDs.ExtensionRequest:\n@@ -628,3 +560,0 @@\n-        case 15:    \/\/ SMIMECapability\n-            throw new IllegalArgumentException(\"PKCS9 attribute #15 not supported.\");\n-            \/\/ break unnecessary\n@@ -632,1 +561,1 @@\n-        case 16:    \/\/ SigningCertificate\n+        case KnownOIDs.SigningCertificate:\n@@ -640,2 +569,2 @@\n-        case 17:    \/\/ SignatureTimestampToken\n-        case 18:    \/\/ CMSAlgorithmProtection\n+        case KnownOIDs.SignatureTimestampToken:\n+        case KnownOIDs.CMSAlgorithmProtection:\n@@ -645,1 +574,1 @@\n-        default: \/\/ can't happen\n+        default: \/\/ Can't happen\n@@ -656,1 +585,1 @@\n-        return index != -1;\n+        return info != null;\n@@ -677,1 +606,1 @@\n-        return index == -1 || SINGLE_VALUED[index];\n+        return info == null || info.singleValued();\n@@ -726,1 +655,1 @@\n-        if (index == -1) {\n+        if (info == null) {\n@@ -733,1 +662,1 @@\n-        if (index == -1 || SINGLE_VALUED[index]) {\n+        if (info == null || info.singleValued()) {\n@@ -786,1 +715,1 @@\n-        Byte[] expectedTags = PKCS9_VALUE_TAGS[index];\n+        Byte[] expectedTags = info.valueTags();\n@@ -805,1 +734,1 @@\n-}\n+}\n\\ No newline at end of file\n","filename":"src\/java.base\/share\/classes\/sun\/security\/pkcs\/PKCS9Attribute.java","additions":135,"deletions":206,"binary":false,"changes":341,"status":"modified"}]}