{"files":[{"patch":"@@ -140,0 +140,39 @@\n+    \/**\n+     * Returns a resource node in the given module, or null if no resource of\n+     * that name exists.\n+     *\n+     * <p>This is equivalent to:\n+     * <pre>{@code\n+     * findNode(\"\/modules\/\" + moduleName + \"\/\" + resourcePath)\n+     * }<\/pre>\n+     * but more performant, and returns {@code null} for directories.\n+     *\n+     * @param moduleName The module name of the requested resource.\n+     * @param resourcePath Trailing module-relative resource path, not starting\n+     *     with {@code '\/'}.\n+     *\/\n+    public Node findResourceNode(String moduleName, String resourcePath)\n+            throws IOException {\n+        ensureOpen();\n+        return reader.findResourceNode(moduleName, resourcePath);\n+    }\n+\n+    \/**\n+     * Returns whether a resource exists in the given module.\n+     *\n+     * <p>This is equivalent to:\n+     * <pre>{@code\n+     * findResourceNode(moduleName, resourcePath) != null\n+     * }<\/pre>\n+     * but more performant, and will not create or cache new nodes.\n+     *\n+     * @param moduleName The module name of the resource being tested for.\n+     * @param resourcePath Trailing module-relative resource path, not starting\n+     *     with {@code '\/'}.\n+     *\/\n+    public boolean containsResource(String moduleName, String resourcePath)\n+            throws IOException {\n+        ensureOpen();\n+        return reader.containsResource(moduleName, resourcePath);\n+    }\n+\n@@ -310,0 +349,40 @@\n+        \/**\n+         * Returns a resource node in the given module, or null if no resource of\n+         * that name exists.\n+         *\/\n+        synchronized Node findResourceNode(String moduleName, String resourcePath) {\n+            \/\/ Unlike findNode(), this method makes only one lookup in the\n+            \/\/ underlying jimage, but can only reliably return resource nodes.\n+            if (moduleName.contains(\"\/\") || resourcePath.startsWith(\"\/\")) {\n+                return null;\n+            }\n+            String jimageName = \"\/\" + moduleName + \"\/\" + resourcePath;\n+            String nodeName = MODULES_ROOT + jimageName;\n+            Node node = nodes.get(nodeName);\n+            if (node == null) {\n+                ImageLocation loc = findLocation(jimageName);\n+                if (loc != null && isResource(loc)) {\n+                    node = newResource(nodeName, loc);\n+                    nodes.put(node.getName(), node);\n+                }\n+                return node;\n+            } else {\n+                return node.isResource() ? node : null;\n+            }\n+        }\n+\n+        \/** Returns whether a resource exists in the given module. *\/\n+        synchronized boolean containsResource(String moduleName, String resourcePath) {\n+            \/\/ This method is tuned for cases where resources are likely to NOT\n+            \/\/ exist, so it skips checking the nodes cache and only checks for\n+            \/\/ an ImageLocation.\n+            if (moduleName.contains(\"\/\") || resourcePath.startsWith(\"\/\")) {\n+                return false;\n+            }\n+            \/\/ No leading \"\/modules\" (and if the given module name is 'modules'\n+            \/\/ then 'isResource()' returns false to prevent false positives).\n+            String jimageName = \"\/\" + moduleName + \"\/\" + resourcePath;\n+            ImageLocation loc = findLocation(jimageName);\n+            return loc != null && isResource(loc);\n+        }\n+\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/jimage\/ImageReader.java","additions":79,"deletions":0,"binary":false,"changes":79,"status":"modified"},{"patch":"@@ -417,2 +417,2 @@\n-        private boolean containsResource(String resourcePath) throws IOException {\n-            Objects.requireNonNull(resourcePath);\n+        private boolean containsResource(String module, String name) throws IOException {\n+            Objects.requireNonNull(name);\n@@ -422,7 +422,1 @@\n-            if (imageReader != null) {\n-                ImageReader.Node node = imageReader.findNode(\"\/modules\" + resourcePath);\n-                return node != null && node.isResource();\n-            } else {\n-                \/\/ not an images build\n-                return false;\n-            }\n+            return imageReader != null && imageReader.containsResource(module, name);\n@@ -433,4 +427,2 @@\n-            Objects.requireNonNull(name);\n-            String resourcePath = \"\/\" + module + \"\/\" + name;\n-            if (containsResource(resourcePath)) {\n-                URI u = JNUA.create(\"jrt\", resourcePath);\n+            if (containsResource(module, name)) {\n+                URI u = JNUA.create(\"jrt\", \"\/\" + module + \"\/\" + name);\n@@ -468,3 +460,1 @@\n-            String nodeName = \"\/modules\/\" + module + \"\/\" + name;\n-            ImageReader.Node node = reader.findNode(nodeName);\n-            return (node != null && node.isResource()) ? node : null;\n+            return reader.findResourceNode(module, name);\n","filename":"src\/java.base\/share\/classes\/jdk\/internal\/module\/SystemModuleFinders.java","additions":6,"deletions":16,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -90,2 +90,2 @@\n-            Node node = READER.findNode(\"\/modules\/\" + module + \"\/\" + path);\n-            if (node == null || !node.isResource()) {\n+            Node node = READER.findResourceNode(module, path);\n+            if (node == null) {\n","filename":"src\/java.base\/share\/classes\/sun\/net\/www\/protocol\/jrt\/JavaRuntimeURLConnection.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -46,0 +46,1 @@\n+import static org.junit.jupiter.api.Assertions.assertFalse;\n@@ -125,0 +126,38 @@\n+    @ParameterizedTest\n+    @ValueSource(strings = {\n+            \"modfoo:com\/foo\/Alpha.class\",\n+            \"modbar:com\/bar\/One.class\",\n+    })\n+    public void testResourceNodes_present(String modAndPath) throws IOException {\n+        try (ImageReader reader = ImageReader.open(image)) {\n+            String[] parts = modAndPath.split(\":\");\n+            assertNotNull(reader.findResourceNode(parts[0], parts[1]));\n+            assertTrue(reader.containsResource(parts[0], parts[1]));\n+        }\n+    }\n+\n+    \/\/ Important to ensure we cannot be fooled.\n+    @ParameterizedTest\n+    @ValueSource(strings = {\n+            \/\/ Absolute resource names are not allowed.\n+            \"modfoo:\/com\/bar\/One.class\",\n+            \/\/ Resource in wrong module.\n+            \"modfoo:com\/bar\/One.class\",\n+            \"modbar:com\/foo\/Alpha.class\",\n+            \/\/ JImage entries exist for these, but they are not resources.\n+            \"modules:modfoo\/com\/foo\/Alpha.class\",\n+            \"packages:com.foo\/modfoo\",\n+            \/\/ Don't permit module names to contain paths.\n+            \"modfoo\/com\/bar:One.class\",\n+            \"modfoo\/com:bar\/One.class\",\n+            \"modules\/modfoo\/com:foo\/Alpha.class\",\n+            \/\/ Or module name to be empty.\n+            \":modfoo\/com\/foo\/Alpha.class\"})\n+    public void testFindResourceNode_absent(String modAndPath) throws IOException {\n+        try (ImageReader reader = ImageReader.open(image)) {\n+            String[] parts = modAndPath.split(\":\");\n+            assertNull(reader.findResourceNode(parts[0], parts[1]));\n+            assertFalse(reader.containsResource(parts[0], parts[1]));\n+        }\n+    }\n+\n","filename":"test\/jdk\/jdk\/internal\/jimage\/ImageReaderTest.java","additions":39,"deletions":0,"binary":false,"changes":39,"status":"modified"}]}