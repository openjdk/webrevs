{"files":[{"patch":"@@ -42,2 +42,2 @@\n-  AtomicAccess::add(&_sweep_duration, other->_sweep_duration, memory_order_relaxed);\n-  AtomicAccess::add(&_yield_during_sweep_duration, other->_yield_during_sweep_duration, memory_order_relaxed);\n+  _sweep_duration.add_then_fetch(other->_sweep_duration.load_relaxed(), memory_order_relaxed);\n+  _yield_during_sweep_duration.add_then_fetch(other->yield_during_sweep_duration(), memory_order_relaxed);\n@@ -45,6 +45,6 @@\n-  AtomicAccess::add(&_cards_scanned, other->_cards_scanned, memory_order_relaxed);\n-  AtomicAccess::add(&_cards_clean, other->_cards_clean, memory_order_relaxed);\n-  AtomicAccess::add(&_cards_not_parsable, other->_cards_not_parsable, memory_order_relaxed);\n-  AtomicAccess::add(&_cards_already_refer_to_cset, other->_cards_already_refer_to_cset, memory_order_relaxed);\n-  AtomicAccess::add(&_cards_refer_to_cset, other->_cards_refer_to_cset, memory_order_relaxed);\n-  AtomicAccess::add(&_cards_no_cross_region, other->_cards_no_cross_region, memory_order_relaxed);\n+  _cards_scanned.add_then_fetch(other->cards_scanned(), memory_order_relaxed);\n+  _cards_clean.add_then_fetch(other->cards_clean(), memory_order_relaxed);\n+  _cards_not_parsable.add_then_fetch(other->cards_not_parsable(), memory_order_relaxed);\n+  _cards_already_refer_to_cset.add_then_fetch(other->cards_already_refer_to_cset(), memory_order_relaxed);\n+  _cards_refer_to_cset.add_then_fetch(other->cards_refer_to_cset(), memory_order_relaxed);\n+  _cards_no_cross_region.add_then_fetch(other->cards_no_cross_region(), memory_order_relaxed);\n@@ -52,1 +52,1 @@\n-  AtomicAccess::add(&_refine_duration, other->_refine_duration, memory_order_relaxed);\n+  _refine_duration.add_then_fetch(other->refine_duration(), memory_order_relaxed);\n@@ -56,1 +56,9 @@\n-  *this = G1ConcurrentRefineStats();\n+  _sweep_duration.store_relaxed(0);\n+  _yield_during_sweep_duration.store_relaxed(0);\n+  _cards_scanned.store_relaxed(0);\n+  _cards_clean.store_relaxed(0);\n+  _cards_not_parsable.store_relaxed(0);\n+  _cards_already_refer_to_cset.store_relaxed(0);\n+  _cards_refer_to_cset.store_relaxed(0);\n+  _cards_no_cross_region.store_relaxed(0);\n+  _refine_duration.store_relaxed(0);\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentRefineStats.cpp","additions":18,"deletions":10,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -29,0 +29,1 @@\n+#include \"runtime\/atomic.hpp\"\n@@ -36,3 +37,3 @@\n-  jlong _sweep_duration;              \/\/ Time spent sweeping the table finding non-clean cards\n-                                      \/\/ and refining them.\n-  jlong _yield_during_sweep_duration; \/\/ Time spent yielding during the sweep (not doing the sweep).\n+  Atomic<jlong> _sweep_duration;              \/\/ Time spent sweeping the table finding non-clean cards\n+                                              \/\/ and refining them.\n+  Atomic<jlong> _yield_during_sweep_duration; \/\/ Time spent yielding during the sweep (not doing the sweep).\n@@ -40,6 +41,6 @@\n-  size_t _cards_scanned;              \/\/ Total number of cards scanned.\n-  size_t _cards_clean;                \/\/ Number of cards found clean.\n-  size_t _cards_not_parsable;         \/\/ Number of cards we could not parse and left unrefined.\n-  size_t _cards_already_refer_to_cset;\/\/ Number of cards marked found to be already young.\n-  size_t _cards_refer_to_cset;        \/\/ Number of dirty cards that were recently found to contain a to-cset reference.\n-  size_t _cards_no_cross_region;      \/\/ Number of dirty cards that were dirtied, but then cleaned again by the mutator.\n+  Atomic<size_t> _cards_scanned;              \/\/ Total number of cards scanned.\n+  Atomic<size_t> _cards_clean;                \/\/ Number of cards found clean.\n+  Atomic<size_t> _cards_not_parsable;         \/\/ Number of cards we could not parse and left unrefined.\n+  Atomic<size_t> _cards_already_refer_to_cset;\/\/ Number of cards marked found to be already young.\n+  Atomic<size_t> _cards_refer_to_cset;        \/\/ Number of dirty cards that were recently found to contain a to-cset reference.\n+  Atomic<size_t> _cards_no_cross_region;      \/\/ Number of dirty cards that were dirtied, but then cleaned again by the mutator.\n@@ -47,1 +48,1 @@\n-  jlong _refine_duration;             \/\/ Time spent during actual refinement.\n+  Atomic<jlong> _refine_duration;             \/\/ Time spent during actual refinement.\n@@ -54,3 +55,3 @@\n-  jlong sweep_duration() const { return _sweep_duration - _yield_during_sweep_duration; }\n-  jlong yield_during_sweep_duration() const { return _yield_during_sweep_duration; }\n-  jlong refine_duration() const { return _refine_duration; }\n+  jlong sweep_duration() const { return _sweep_duration.load_relaxed() - yield_during_sweep_duration(); }\n+  jlong yield_during_sweep_duration() const { return _yield_during_sweep_duration.load_relaxed(); }\n+  jlong refine_duration() const { return _refine_duration.load_relaxed(); }\n@@ -61,7 +62,7 @@\n-  size_t cards_scanned() const { return _cards_scanned; }\n-  size_t cards_clean() const { return _cards_clean; }\n-  size_t cards_not_clean() const { return _cards_scanned - _cards_clean; }\n-  size_t cards_not_parsable() const { return _cards_not_parsable; }\n-  size_t cards_already_refer_to_cset() const { return _cards_already_refer_to_cset; }\n-  size_t cards_refer_to_cset() const { return _cards_refer_to_cset; }\n-  size_t cards_no_cross_region() const { return _cards_no_cross_region; }\n+  size_t cards_scanned() const { return _cards_scanned.load_relaxed(); }\n+  size_t cards_clean() const { return _cards_clean.load_relaxed(); }\n+  size_t cards_not_clean() const { return cards_scanned() - cards_clean(); }\n+  size_t cards_not_parsable() const { return _cards_not_parsable.load_relaxed(); }\n+  size_t cards_already_refer_to_cset() const { return _cards_already_refer_to_cset.load_relaxed(); }\n+  size_t cards_refer_to_cset() const { return _cards_refer_to_cset.load_relaxed(); }\n+  size_t cards_no_cross_region() const { return _cards_no_cross_region.load_relaxed(); }\n@@ -70,1 +71,1 @@\n-  size_t cards_pending() const { return cards_not_clean() - _cards_already_refer_to_cset; }\n+  size_t cards_pending() const { return cards_not_clean() - cards_already_refer_to_cset(); }\n@@ -72,1 +73,1 @@\n-  size_t cards_to_cset() const { return _cards_already_refer_to_cset + _cards_refer_to_cset; }\n+  size_t cards_to_cset() const { return cards_already_refer_to_cset() + cards_refer_to_cset(); }\n@@ -74,3 +75,3 @@\n-  void inc_sweep_time(jlong t) { _sweep_duration += t; }\n-  void inc_yield_during_sweep_duration(jlong t) { _yield_during_sweep_duration += t; }\n-  void inc_refine_duration(jlong t) { _refine_duration += t; }\n+  void inc_sweep_time(jlong t) { _sweep_duration.store_relaxed(_sweep_duration.load_relaxed() + t); }\n+  void inc_yield_during_sweep_duration(jlong t) { _yield_during_sweep_duration.store_relaxed(yield_during_sweep_duration() + t); }\n+  void inc_refine_duration(jlong t) { _refine_duration.store_relaxed(refine_duration() + t); }\n@@ -78,6 +79,6 @@\n-  void inc_cards_scanned(size_t increment) { _cards_scanned += increment; }\n-  void inc_cards_clean(size_t increment) { _cards_clean += increment; }\n-  void inc_cards_not_parsable() { _cards_not_parsable++; }\n-  void inc_cards_already_refer_to_cset() { _cards_already_refer_to_cset++; }\n-  void inc_cards_refer_to_cset() { _cards_refer_to_cset++; }\n-  void inc_cards_no_cross_region() { _cards_no_cross_region++; }\n+  void inc_cards_scanned(size_t increment) { _cards_scanned.store_relaxed(cards_scanned() + increment); }\n+  void inc_cards_clean(size_t increment) { _cards_clean.store_relaxed(cards_clean() + increment); }\n+  void inc_cards_not_parsable() { _cards_not_parsable.store_relaxed(cards_not_parsable() + 1); }\n+  void inc_cards_already_refer_to_cset() { _cards_already_refer_to_cset.store_relaxed(cards_already_refer_to_cset() + 1); }\n+  void inc_cards_refer_to_cset() { _cards_refer_to_cset.store_relaxed(cards_refer_to_cset() + 1); }\n+  void inc_cards_no_cross_region() { _cards_no_cross_region.store_relaxed(cards_no_cross_region() + 1); }\n","filename":"src\/hotspot\/share\/gc\/g1\/g1ConcurrentRefineStats.hpp","additions":32,"deletions":31,"binary":false,"changes":63,"status":"modified"}]}