{"files":[{"patch":"@@ -739,1 +739,1 @@\n-    lea(rscratch1, CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone));\n+    lea(rscratch1, RuntimeAddress(CAST_FROM_FN_PTR(address, SharedRuntime::enable_stack_reserved_zone)));\n@@ -1882,1 +1882,1 @@\n-  lea(rscratch2, ExternalAddress(StubRoutines::verify_oop_subroutine_entry_address()));\n+  lea(rscratch2, RuntimeAddress(StubRoutines::verify_oop_subroutine_entry_address()));\n@@ -1921,1 +1921,1 @@\n-  lea(rscratch2, ExternalAddress(StubRoutines::verify_oop_subroutine_entry_address()));\n+  lea(rscratch2, RuntimeAddress(StubRoutines::verify_oop_subroutine_entry_address()));\n@@ -6457,1 +6457,1 @@\n-    lea(rscratch1, CAST_FROM_FN_PTR(address, JavaThread::verify_cross_modify_fence_failure));\n+    lea(rscratch1, RuntimeAddress(CAST_FROM_FN_PTR(address, JavaThread::verify_cross_modify_fence_failure)));\n","filename":"src\/hotspot\/cpu\/aarch64\/macroAssembler_aarch64.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -7048,1 +7048,1 @@\n-    __ lea(rscratch1, ExternalAddress(StubRoutines::throw_StackOverflowError_entry()));\n+    __ lea(rscratch1, RuntimeAddress(StubRoutines::throw_StackOverflowError_entry()));\n","filename":"src\/hotspot\/cpu\/aarch64\/stubGenerator_aarch64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -1340,2 +1340,2 @@\n-    address unsatisfied = (SharedRuntime::native_method_throw_unsatisfied_link_error_entry());\n-    __ mov(rscratch2, unsatisfied);\n+    ExternalAddress unsatisfied(SharedRuntime::native_method_throw_unsatisfied_link_error_entry());\n+    __ lea(rscratch2, unsatisfied);\n@@ -1435,1 +1435,1 @@\n-    __ mov(rscratch2, CAST_FROM_FN_PTR(address, JavaThread::check_special_condition_for_native_trans));\n+    __ lea(rscratch2, RuntimeAddress(CAST_FROM_FN_PTR(address, JavaThread::check_special_condition_for_native_trans)));\n@@ -1485,1 +1485,1 @@\n-    __ mov(rscratch2, CAST_FROM_FN_PTR(address, SharedRuntime::reguard_yellow_pages));\n+    __ lea(rscratch2, RuntimeAddress(CAST_FROM_FN_PTR(address, SharedRuntime::reguard_yellow_pages)));\n@@ -2088,1 +2088,1 @@\n-  __ bl(Interpreter::trace_code(t->tos_in()));\n+  __ bl(RuntimeAddress(Interpreter::trace_code(t->tos_in())));\n","filename":"src\/hotspot\/cpu\/aarch64\/templateInterpreterGenerator_aarch64.cpp","additions":6,"deletions":6,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -550,1 +550,1 @@\n-  ExternalAddress target(StubRoutines::verify_oop_subroutine_entry_address());\n+  RuntimeAddress target(StubRoutines::verify_oop_subroutine_entry_address());\n@@ -595,1 +595,1 @@\n-  ExternalAddress target(StubRoutines::verify_oop_subroutine_entry_address());\n+  RuntimeAddress target(StubRoutines::verify_oop_subroutine_entry_address());\n","filename":"src\/hotspot\/cpu\/riscv\/macroAssembler_riscv.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -3777,1 +3777,1 @@\n-    __ la(t0, ExternalAddress(StubRoutines::throw_StackOverflowError_entry()));\n+    __ la(t0, RuntimeAddress(StubRoutines::throw_StackOverflowError_entry()));\n","filename":"src\/hotspot\/cpu\/riscv\/stubGenerator_riscv.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -1114,2 +1114,2 @@\n-    address unsatisfied = (SharedRuntime::native_method_throw_unsatisfied_link_error_entry());\n-    __ mv(t, unsatisfied);\n+    ExternalAddress unsatisfied(SharedRuntime::native_method_throw_unsatisfied_link_error_entry());\n+    __ la(t, unsatisfied);\n@@ -1818,1 +1818,1 @@\n-  __ call(Interpreter::trace_code(t->tos_in()));\n+  __ rt_call(Interpreter::trace_code(t->tos_in()));\n","filename":"src\/hotspot\/cpu\/riscv\/templateInterpreterGenerator_riscv.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -3705,1 +3705,1 @@\n-  __ jump(ExternalAddress(StubRoutines::throw_StackOverflowError_entry()));\n+  __ jump(RuntimeAddress(StubRoutines::throw_StackOverflowError_entry()));\n","filename":"src\/hotspot\/cpu\/x86\/stubGenerator_x86_64.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -181,1 +181,1 @@\n-  __ jump(ExternalAddress(Interpreter::throw_exception_entry()));\n+  __ jump(RuntimeAddress(Interpreter::throw_exception_entry()));\n@@ -549,1 +549,1 @@\n-  __ jump(ExternalAddress(StubRoutines::throw_StackOverflowError_entry()));\n+  __ jump(RuntimeAddress(StubRoutines::throw_StackOverflowError_entry()));\n","filename":"src\/hotspot\/cpu\/x86\/templateInterpreterGenerator_x86.cpp","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2023, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -777,1 +777,1 @@\n-  __ jump(ExternalAddress(Interpreter::_throw_ArrayIndexOutOfBoundsException_entry));\n+  __ jump(RuntimeAddress(Interpreter::_throw_ArrayIndexOutOfBoundsException_entry));\n@@ -1155,1 +1155,1 @@\n-  __ jump(ExternalAddress(Interpreter::_throw_ArrayStoreException_entry));\n+  __ jump(RuntimeAddress(Interpreter::_throw_ArrayStoreException_entry));\n@@ -1435,1 +1435,1 @@\n-             ExternalAddress(Interpreter::_throw_ArithmeticException_entry));\n+             RuntimeAddress(Interpreter::_throw_ArithmeticException_entry));\n@@ -1448,1 +1448,1 @@\n-             ExternalAddress(Interpreter::_throw_ArithmeticException_entry));\n+             RuntimeAddress(Interpreter::_throw_ArithmeticException_entry));\n@@ -1461,1 +1461,1 @@\n-             ExternalAddress(Interpreter::_throw_ArithmeticException_entry));\n+             RuntimeAddress(Interpreter::_throw_ArithmeticException_entry));\n@@ -1475,1 +1475,1 @@\n-             ExternalAddress(Interpreter::_throw_ArithmeticException_entry));\n+             RuntimeAddress(Interpreter::_throw_ArithmeticException_entry));\n@@ -4225,1 +4225,1 @@\n-  __ jump(ExternalAddress(Interpreter::_throw_ClassCastException_entry));\n+  __ jump(RuntimeAddress(Interpreter::_throw_ClassCastException_entry));\n@@ -4343,1 +4343,1 @@\n-  __ jump(ExternalAddress(Interpreter::throw_exception_entry()));\n+  __ jump(RuntimeAddress(Interpreter::throw_exception_entry()));\n","filename":"src\/hotspot\/cpu\/x86\/templateTable_x86.cpp","additions":9,"deletions":9,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -35,0 +35,1 @@\n+#include \"runtime\/os.hpp\"\n@@ -223,0 +224,5 @@\n+#ifndef PRODUCT\n+static int total_access_count = 0;\n+static GrowableArray<int>* extern_hist = nullptr;\n+#endif\n+\n@@ -231,0 +237,6 @@\n+#ifndef PRODUCT\n+  if (PrintNMethodStatistics) {\n+    Arena* arena = &_recorder->_arena;\n+    extern_hist = new(arena) GrowableArray<int>(arena, 512, 512, 0);\n+  }\n+#endif\n@@ -234,1 +246,0 @@\n-  MutexLocker ml(ExternalsRecorder_lock, Mutex::_no_safepoint_check_flag);\n@@ -236,1 +247,10 @@\n-  return _recorder->_externals.find_index(adr);\n+  MutexLocker ml(ExternalsRecorder_lock, Mutex::_no_safepoint_check_flag);\n+  int index = _recorder->_externals.find_index(adr);\n+#ifndef PRODUCT\n+  if (PrintNMethodStatistics) {\n+    total_access_count++;\n+    int n = extern_hist->at_grow(index, 0);\n+    extern_hist->at_put(index, (n + 1));\n+  }\n+#endif\n+  return index;\n@@ -240,0 +260,1 @@\n+  assert(_recorder != nullptr, \"sanity\");\n@@ -243,1 +264,0 @@\n-  assert(_recorder != nullptr, \"sanity\");\n@@ -248,1 +268,0 @@\n-  MutexLocker ml(ExternalsRecorder_lock, Mutex::_no_safepoint_check_flag);\n@@ -250,0 +269,1 @@\n+  MutexLocker ml(ExternalsRecorder_lock, Mutex::_no_safepoint_check_flag);\n@@ -254,0 +274,9 @@\n+extern \"C\" {\n+  \/\/ Order from large to small values\n+  static int count_cmp(const void *i, const void *j) {\n+    int a = *(int*)i;\n+    int b = *(int*)j;\n+    return a < b ? 1 : a > b ? -1 : 0;\n+  }\n+}\n+\n@@ -255,1 +284,54 @@\n-  tty->print_cr(\"External addresses table: %d entries\", count());\n+  int cnt = count();\n+  tty->print_cr(\"External addresses table: %d entries, %d accesses\", cnt, total_access_count);\n+  { \/\/ Print most accessed entries in the table.\n+    int* array = NEW_C_HEAP_ARRAY(int, (2 * cnt), mtCode);\n+    for (int i = 0; i < cnt; i++) {\n+      array[(2 * i) + 0] = extern_hist->at(i);\n+      array[(2 * i) + 1] = i;\n+    }\n+    \/\/ Reverse sort to have \"hottest\" addresses first.\n+    qsort(array, cnt, 2*sizeof(int), count_cmp);\n+    \/\/ Print all entries with Verbose flag otherwise only top 5.\n+    int limit = (Verbose || cnt <= 5) ? cnt : 5;\n+    int j = 0;\n+    for (int i = 0; i < limit; i++) {\n+      int index = array[(2 * i) + 1];\n+      int n = extern_hist->at(index);\n+      if (n > 0) {\n+        address addr = at(index);\n+        tty->print(\"%d: %8d \" INTPTR_FORMAT \" :\", j++, n, p2i(addr));\n+        if (addr != nullptr) {\n+          if (StubRoutines::contains(addr)) {\n+            StubCodeDesc* desc = StubCodeDesc::desc_for(addr);\n+            if (desc == nullptr) {\n+              desc = StubCodeDesc::desc_for(addr + frame::pc_return_offset);\n+            }\n+            const char* stub_name = (desc != nullptr) ? desc->name() : \"<unknown>\";\n+            tty->print(\" stub: %s\", stub_name);\n+          } else {\n+            ResourceMark rm;\n+            const int buflen = 1024;\n+            char* buf = NEW_RESOURCE_ARRAY(char, buflen);\n+            int offset = 0;\n+            if (os::dll_address_to_function_name(addr, buf, buflen, &offset)) {\n+              tty->print(\" extn: %s\", buf);\n+              if (offset != 0) {\n+                tty->print(\"+%d\", offset);\n+              }\n+            } else {\n+              if (CodeCache::contains((void*)addr)) {\n+                \/\/ Something in CodeCache\n+                tty->print(\" in CodeCache\");\n+              } else {\n+                \/\/ It could be string\n+                memcpy(buf, (char*)addr, 80);\n+                buf[80] = '\\0';\n+                tty->print(\" '%s'\", buf);\n+              }\n+            }\n+          }\n+        }\n+        tty->cr();\n+      }\n+    }\n+  }\n","filename":"src\/hotspot\/share\/code\/oopRecorder.cpp","additions":87,"deletions":5,"binary":false,"changes":92,"status":"modified"}]}