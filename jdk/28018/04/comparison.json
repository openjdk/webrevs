{"files":[{"patch":"@@ -59,0 +59,1 @@\n+import com.sun.tools.javac.comp.Check;\n@@ -2312,1 +2313,5 @@\n-                addTypeAnnotationsToSymbol(sym, newList);\n+                Completer previousCompleter = sym.completer;\n+                sym.completer = sym -> {\n+                    addTypeAnnotationsToSymbol(sym, newList);\n+                    previousCompleter.complete(sym);\n+                };\n@@ -2328,0 +2333,1 @@\n+        DeferredCompletionFailureHandler.Handler prevCFHandler = dcfh.setHandler(dcfh.speculativeCodeHandler);\n@@ -2337,0 +2343,2 @@\n+        } finally {\n+            dcfh.setHandler(prevCFHandler);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/jvm\/ClassReader.java","additions":9,"deletions":1,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -26,1 +26,1 @@\n- * @bug 8337998\n+ * @bug 8337998 8370800\n@@ -39,0 +39,11 @@\n+import java.util.Set;\n+\n+import javax.annotation.processing.AbstractProcessor;\n+import javax.annotation.processing.RoundEnvironment;\n+import javax.annotation.processing.SupportedAnnotationTypes;\n+import javax.lang.model.SourceVersion;\n+import javax.lang.model.element.Element;\n+import javax.lang.model.element.TypeElement;\n+import javax.lang.model.type.TypeMirror;\n+import javax.lang.model.util.ElementFilter;\n+import javax.tools.Diagnostic;\n@@ -46,0 +57,1 @@\n+        t.testAnnotationProcessing();\n@@ -48,1 +60,4 @@\n-    void testMissingEnclosingType() throws Exception {\n+    Path src;\n+    Path out;\n+\n+    void setup() throws Exception {\n@@ -70,1 +85,1 @@\n-        Path src = base.resolve(\"src\");\n+        src = base.resolve(\"src\");\n@@ -73,1 +88,1 @@\n-        Path out = base.resolve(\"out\");\n+        out = base.resolve(\"out\");\n@@ -76,0 +91,4 @@\n+    }\n+\n+    void testMissingEnclosingType() throws Exception {\n+        setup();\n@@ -85,1 +104,45 @@\n-                        .run(Expect.FAIL)\n+                        .run(Expect.SUCCESS)\n+                        .writeAll()\n+                        .getOutputLines(Task.OutputKind.DIRECT);\n+    }\n+\n+    @SupportedAnnotationTypes(\"*\")\n+    public static class Processor extends AbstractProcessor {\n+        @Override\n+        public SourceVersion getSupportedSourceVersion() {\n+            return SourceVersion.latestSupported();\n+        }\n+\n+        boolean first = true;\n+\n+        @Override\n+        public boolean process(Set<? extends TypeElement> annotations, RoundEnvironment roundEnv) {\n+            if (!first) {\n+                return false;\n+            }\n+            Element te = processingEnv.getElementUtils().getTypeElement(\"B\");\n+            for (var f : ElementFilter.fieldsIn(te.getEnclosedElements())) {\n+                TypeMirror t = f.asType();\n+                processingEnv\n+                        .getMessager()\n+                        .printMessage(\n+                                Diagnostic.Kind.NOTE,\n+                                \"%s (%s) has annotations [%s]\"\n+                                        .formatted(f, t, t.getAnnotationMirrors()));\n+            }\n+            first = false;\n+            return false;\n+        }\n+    }\n+\n+    void testAnnotationProcessing() throws Exception {\n+        setup();\n+\n+        List<String> log =\n+                new JavacTask(tb)\n+                        .outdir(out)\n+                        .classpath(out)\n+                        .options(\"-XDrawDiagnostics\")\n+                        .files(src.resolve(\"C.java\"))\n+                        .processors(new Processor())\n+                        .run(Expect.SUCCESS)\n@@ -90,0 +153,23 @@\n+                List.of(\n+                        \"- compiler.note.proc.messager: a (@Anno A<java.lang.String>) has\"\n+                            + \" annotations [@Anno]\");\n+        if (!expectedOutput.equals(log)) {\n+            throw new Exception(\"expected output not found: \" + log);\n+        }\n+\n+        \/\/ now if we remove A.class there will be an error and the annotations won't be available\n+        \/\/ but javac should not crash\n+        tb.deleteFiles(out.resolve(\"A.class\"));\n+\n+        log =\n+                new JavacTask(tb)\n+                        .outdir(out)\n+                        .classpath(out)\n+                        .options(\"-XDrawDiagnostics\")\n+                        .files(src.resolve(\"C.java\"))\n+                        .processors(new Processor())\n+                        .run(Expect.FAIL)\n+                        .writeAll()\n+                        .getOutputLines(Task.OutputKind.DIRECT);\n+\n+        expectedOutput =\n@@ -92,1 +178,2 @@\n-                            + \" (compiler.misc.class.file.not.found: A)\",\n+                                + \" (compiler.misc.class.file.not.found: A)\",\n+                        \"- compiler.note.proc.messager: a (A<java.lang.String>) has annotations []\",\n","filename":"test\/langtools\/tools\/javac\/annotations\/typeAnnotations\/CompletionErrorOnEnclosingType.java","additions":93,"deletions":6,"binary":false,"changes":99,"status":"modified"}]}