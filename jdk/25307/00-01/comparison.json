{"files":[{"patch":"@@ -154,1 +154,1 @@\n-void JVMCI::initialize_compiler(TRAPS) {\n+void JVMCI::initialize_compiler_in_create_vm(TRAPS) {\n@@ -165,1 +165,18 @@\n-  runtime->call_getCompiler(CHECK);\n+\n+  \/\/ Enter a JVMCI env, which will load libjvmci if it's in use\n+  JVMCIENV_FROM_THREAD(THREAD);\n+  int init_error = JVMCIENV->init_error();\n+  if (init_error != JNI_OK) {\n+    if (PrintCompilation) {\n+      const char* msg = JVMCIENV->init_error_msg();\n+      tty->print_cr(\"COMPILER INIT ERROR: Error creating or attaching to libjvmci (err: %d, description: %s)\",\n+        init_error, msg == nullptr ? \"unknown\" : msg);\n+    }\n+    return;\n+  }\n+\n+  \/\/ Failures in the calls below will propagate to the caller\n+  \/\/ and cause VM to exit.\n+  JVMCIObject jvmciRuntime = runtime->get_HotSpotJVMCIRuntime(JVMCI_CHECK);\n+  runtime->initialize(JVMCI_CHECK);\n+  JVMCIENV->call_HotSpotJVMCIRuntime_getCompiler(jvmciRuntime, JVMCI_CHECK);\n","filename":"src\/hotspot\/share\/jvmci\/jvmci.cpp","additions":19,"deletions":2,"binary":false,"changes":21,"status":"modified"},{"patch":"@@ -194,3 +194,2 @@\n-  \/\/ Called to force initialization of the JVMCI compiler\n-  \/\/ early in VM startup.\n-  static void initialize_compiler(TRAPS);\n+  \/\/ Called to initialize the JVMCI compiler during VM startup.\n+  static void initialize_compiler_in_create_vm(TRAPS);\n","filename":"src\/hotspot\/share\/jvmci\/jvmci.hpp","additions":2,"deletions":3,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -746,16 +746,0 @@\n-void JVMCIRuntime::call_getCompiler(TRAPS) {\n-  JVMCIENV_FROM_THREAD(THREAD);\n-  int init_error = JVMCIENV->init_error();\n-  if (init_error != JNI_OK) {\n-    if (PrintCompilation) {\n-      const char* msg = JVMCIENV->init_error_msg();\n-      tty->print_cr(\"COMPILER INIT ERROR: Error creating or attaching to libjvmci (err: %d, description: %s)\",\n-        init_error, msg == nullptr ? \"unknown\" : msg);\n-    }\n-    return;\n-  }\n-  JVMCIObject jvmciRuntime = JVMCIRuntime::get_HotSpotJVMCIRuntime(JVMCI_CHECK);\n-  initialize(JVMCI_CHECK);\n-  JVMCIENV->call_HotSpotJVMCIRuntime_getCompiler(jvmciRuntime, JVMCI_CHECK);\n-}\n-\n","filename":"src\/hotspot\/share\/jvmci\/jvmciRuntime.cpp","additions":0,"deletions":16,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -376,2 +376,0 @@\n-  void call_getCompiler(TRAPS);\n-\n","filename":"src\/hotspot\/share\/jvmci\/jvmciRuntime.hpp","additions":0,"deletions":2,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -838,1 +838,1 @@\n-    JVMCI::initialize_compiler(CHECK_JNI_ERR);\n+    JVMCI::initialize_compiler_in_create_vm(CHECK_JNI_ERR);\n","filename":"src\/hotspot\/share\/runtime\/threads.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}