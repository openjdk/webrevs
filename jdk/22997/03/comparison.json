{"files":[{"patch":"@@ -932,2 +932,0 @@\n-    assert(!_thread->is_in_VTMS_transition(), \"CFLH events are not allowed in VTMS transition\");\n-\n@@ -1104,2 +1102,2 @@\n-  if (JavaThread::current()->is_in_VTMS_transition()) {\n-    return false; \/\/ no events should be posted if thread is in VTMS transition\n+  if (JavaThread::current()->should_hide_jvmti_events()) {\n+    return false;\n@@ -1241,2 +1239,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -1381,2 +1379,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -1418,2 +1416,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -1756,2 +1754,2 @@\n-  if (javaThread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (javaThread->should_hide_jvmti_events()) {\n+    return;\n@@ -1780,2 +1778,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -1823,2 +1821,2 @@\n-  if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (mh->jvmti_mount_transition() || thread->should_hide_jvmti_events()) {\n+    return;\n@@ -1915,2 +1913,2 @@\n-  if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (mh->jvmti_mount_transition() || thread->should_hide_jvmti_events()) {\n+    return;\n@@ -1991,2 +1989,2 @@\n-  if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (mh->jvmti_mount_transition() || thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2033,2 +2031,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2155,2 +2153,2 @@\n-      if (mh->jvmti_mount_transition() || thread->is_in_VTMS_transition()) {\n-        return; \/\/ no events should be posted if thread is in VTMS transition\n+      if (mh->jvmti_mount_transition() || thread->should_hide_jvmti_events()) {\n+        return;\n@@ -2201,2 +2199,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2237,2 +2235,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2287,2 +2285,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2318,2 +2316,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2393,2 +2391,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2432,2 +2430,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2506,1 +2504,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"compiled method load events are not allowed in VTMS transition\");\n+  assert(!thread->should_hide_jvmti_events(), \"compiled method load events are not allowed in critical sections\");\n@@ -2529,1 +2527,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"compiled method load events are not allowed in VTMS transition\");\n+  assert(!thread->should_hide_jvmti_events(), \"compiled method load events are not allowed in critical sections\");\n@@ -2554,1 +2552,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"dynamic code generated events are not allowed in VTMS transition\");\n+  assert(!thread->should_hide_jvmti_events(), \"dynamic code generated events are not allowed in critical sections\");\n@@ -2602,1 +2600,1 @@\n-  assert(!thread->is_in_VTMS_transition(), \"dynamic code generated events are not allowed in VTMS transition\");\n+  assert(!thread->should_hide_jvmti_events(), \"dynamic code generated events are not allowed in critical sections\");\n@@ -2757,2 +2755,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2790,2 +2788,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2824,2 +2822,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2858,2 +2856,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2900,2 +2898,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n@@ -2937,2 +2935,2 @@\n-  if (thread->is_in_VTMS_transition()) {\n-    return; \/\/ no events should be posted if thread is in VTMS transition\n+  if (thread->should_hide_jvmti_events()) {\n+    return;\n","filename":"src\/hotspot\/share\/prims\/jvmtiExport.cpp","additions":50,"deletions":52,"binary":false,"changes":102,"status":"modified"},{"patch":"@@ -724,0 +724,5 @@\n+  \/\/ Temporarily skip posting JVMTI events for safety reasons when executions is in a critical section:\n+  \/\/ - is in a VTMS transition (_is_in_VTMS_transition)\n+  \/\/ - is in an interruptLock or similar critical section (_is_disable_suspend)\n+  bool should_hide_jvmti_events() const          { return _is_in_VTMS_transition || _is_disable_suspend; }\n+\n","filename":"src\/hotspot\/share\/runtime\/javaThread.hpp","additions":5,"deletions":0,"binary":false,"changes":5,"status":"modified"}]}