{"files":[{"patch":"@@ -56,0 +56,47 @@\n+#include <type_traits>\n+\n+\/\/ Virtual methods are not allowed in code blobs to simplify caching compiled code.\n+\/\/ Check all \"leaf\" subclasses of CodeBlob class.\n+\n+static_assert(!std::is_polymorphic<nmethod>::value,            \"no virtual methods are allowed in nmethod\");\n+static_assert(!std::is_polymorphic<AdapterBlob>::value,        \"no virtual methods are allowed in code blobs\");\n+static_assert(!std::is_polymorphic<VtableBlob>::value,         \"no virtual methods are allowed in code blobs\");\n+static_assert(!std::is_polymorphic<MethodHandlesAdapterBlob>::value, \"no virtual methods are allowed in code blobs\");\n+static_assert(!std::is_polymorphic<RuntimeStub>::value,        \"no virtual methods are allowed in code blobs\");\n+static_assert(!std::is_polymorphic<DeoptimizationBlob>::value, \"no virtual methods are allowed in code blobs\");\n+static_assert(!std::is_polymorphic<SafepointBlob>::value,      \"no virtual methods are allowed in code blobs\");\n+static_assert(!std::is_polymorphic<UpcallStub>::value,         \"no virtual methods are allowed in code blobs\");\n+#ifdef COMPILER2\n+static_assert(!std::is_polymorphic<ExceptionBlob>::value,      \"no virtual methods are allowed in code blobs\");\n+static_assert(!std::is_polymorphic<UncommonTrapBlob>::value,   \"no virtual methods are allowed in code blobs\");\n+#endif\n+\n+\/\/ Add proxy vtables.\n+\/\/ We need only few for now - they are used only from prints.\n+const nmethod::Vptr                  nmethod::_vptr;\n+const BufferBlob::Vptr               BufferBlob::_vptr;\n+const RuntimeStub::Vptr              RuntimeStub::_vptr;\n+const SingletonBlob::Vptr            SingletonBlob::_vptr;\n+const DeoptimizationBlob::Vptr       DeoptimizationBlob::_vptr;\n+const UpcallStub::Vptr               UpcallStub::_vptr;\n+\n+const CodeBlob::Vptr* CodeBlob::vptr() const {\n+  constexpr const CodeBlob::Vptr* array[(size_t)CodeBlobKind::Number_Of_Kinds] = {\n+      nullptr\/* None *\/,\n+      &nmethod::_vptr,\n+      &BufferBlob::_vptr,\n+      &AdapterBlob::_vptr,\n+      &VtableBlob::_vptr,\n+      &MethodHandlesAdapterBlob::_vptr,\n+      &RuntimeStub::_vptr,\n+      &DeoptimizationBlob::_vptr,\n+      &SafepointBlob::_vptr,\n+#ifdef COMPILER2\n+      &ExceptionBlob::_vptr,\n+      &UncommonTrapBlob::_vptr,\n+#endif\n+      &UpcallStub::_vptr\n+  };\n+\n+  return array[(size_t)_kind];\n+}\n@@ -389,1 +436,1 @@\n-: RuntimeBlob(name, CodeBlobKind::Runtime_Stub, cb, size, sizeof(RuntimeStub),\n+: RuntimeBlob(name, CodeBlobKind::RuntimeStub, cb, size, sizeof(RuntimeStub),\n@@ -485,0 +532,1 @@\n+#ifdef COMPILER2\n@@ -489,1 +537,0 @@\n-#ifdef COMPILER2\n@@ -496,1 +543,1 @@\n-: SingletonBlob(\"UncommonTrapBlob\", CodeBlobKind::Uncommon_Trap, cb,\n+: SingletonBlob(\"UncommonTrapBlob\", CodeBlobKind::UncommonTrap, cb,\n@@ -519,4 +566,0 @@\n-\n-#endif \/\/ COMPILER2\n-\n-\n@@ -526,1 +569,0 @@\n-#ifdef COMPILER2\n@@ -556,1 +598,0 @@\n-\n@@ -559,1 +600,0 @@\n-\n@@ -647,1 +687,17 @@\n-void CodeBlob::print_on(outputStream* st) const {\n+void CodeBlob::verify() {\n+  if (is_nmethod()) {\n+    as_nmethod()->verify();\n+  }\n+}\n+\n+void CodeBlob::print_on_v(outputStream* st) const {\n+  vptr()->print_on(this, st);\n+}\n+\n+void CodeBlob::print() const { print_on_v(tty); }\n+\n+void CodeBlob::print_value_on_v(outputStream* st) const {\n+  vptr()->print_value_on(this, st);;\n+}\n+\n+void CodeBlob::print_on_nv(outputStream* st) const {\n@@ -652,3 +708,1 @@\n-void CodeBlob::print() const { print_on(tty); }\n-\n-void CodeBlob::print_value_on(outputStream* st) const {\n+void CodeBlob::print_value_on_nv(outputStream* st) const {\n@@ -658,0 +712,14 @@\n+void CodeBlob::print_block_comment(outputStream* stream, address block_begin) const {\n+#if defined(SUPPORT_ASSEMBLY) || defined(SUPPORT_ABSTRACT_ASSEMBLY)\n+  if (is_nmethod()) {\n+    as_nmethod()->print_nmethod_labels(stream, block_begin);\n+  }\n+#endif\n+\n+#ifndef PRODUCT\n+  ptrdiff_t offset = block_begin - code_begin();\n+  assert(offset >= 0, \"Expecting non-negative offset!\");\n+  _asm_remarks.print(uint(offset), stream);\n+#endif\n+  }\n+\n@@ -711,1 +779,1 @@\n-      nm->print(st);\n+      nm->print_on_v(st);\n@@ -716,5 +784,1 @@\n-  print_on(st);\n-}\n-\n-void BufferBlob::verify() {\n-  \/\/ unimplemented\n+  print_on_v(st);\n@@ -724,1 +788,1 @@\n-  RuntimeBlob::print_on(st);\n+  RuntimeBlob::print_on_nv(st);\n@@ -732,4 +796,0 @@\n-void RuntimeStub::verify() {\n-  \/\/ unimplemented\n-}\n-\n@@ -738,1 +798,1 @@\n-  RuntimeBlob::print_on(st);\n+  RuntimeBlob::print_on_nv(st);\n@@ -748,4 +808,0 @@\n-void SingletonBlob::verify() {\n-  \/\/ unimplemented\n-}\n-\n@@ -754,1 +810,1 @@\n-  RuntimeBlob::print_on(st);\n+  RuntimeBlob::print_on_nv(st);\n@@ -767,4 +823,0 @@\n-void UpcallStub::verify() {\n-  \/\/ unimplemented\n-}\n-\n@@ -772,1 +824,1 @@\n-  RuntimeBlob::print_on(st);\n+  RuntimeBlob::print_on_nv(st);\n","filename":"src\/hotspot\/share\/code\/codeBlob.cpp","additions":88,"deletions":36,"binary":false,"changes":124,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1998, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1998, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -64,1 +64,0 @@\n-\/\/    ExceptionBlob      : Used for stack unrolling\n@@ -66,0 +65,1 @@\n+\/\/    ExceptionBlob      : Used for stack unrolling\n@@ -83,2 +83,2 @@\n-  MH_Adapter,\n-  Runtime_Stub,\n+  MHAdapter,\n+  RuntimeStub,\n@@ -86,1 +86,0 @@\n-  Exception,\n@@ -88,1 +87,4 @@\n-  Uncommon_Trap,\n+#ifdef COMPILER2\n+  Exception,\n+  UncommonTrap,\n+#endif\n@@ -131,0 +133,11 @@\n+ struct Vptr {\n+    virtual void print_on(const CodeBlob* instance, outputStream* st) const {\n+      instance->print_on_nv(st);\n+    }\n+    virtual void print_value_on(const CodeBlob* instance, outputStream* st) const {\n+      instance->print_value_on_nv(st);\n+    }\n+  };\n+\n+  const Vptr* vptr() const;\n+\n@@ -141,1 +154,1 @@\n-  virtual ~CodeBlob() {\n+  ~CodeBlob() {\n@@ -155,1 +168,1 @@\n-  bool is_runtime_stub() const                { return _kind == CodeBlobKind::Runtime_Stub; }\n+  bool is_runtime_stub() const                { return _kind == CodeBlobKind::RuntimeStub; }\n@@ -157,1 +170,2 @@\n-  bool is_uncommon_trap_stub() const          { return _kind == CodeBlobKind::Uncommon_Trap; }\n+#ifdef COMPILER2\n+  bool is_uncommon_trap_stub() const          { return _kind == CodeBlobKind::UncommonTrap; }\n@@ -159,0 +173,4 @@\n+#else\n+  bool is_uncommon_trap_stub() const          { return false; }\n+  bool is_exception_stub() const              { return false; }\n+#endif\n@@ -162,1 +180,1 @@\n-  bool is_method_handles_adapter_blob() const { return _kind == CodeBlobKind::MH_Adapter; }\n+  bool is_method_handles_adapter_blob() const { return _kind == CodeBlobKind::MHAdapter; }\n@@ -166,2 +184,2 @@\n-  nmethod* as_nmethod_or_null()               { return is_nmethod() ? (nmethod*) this : nullptr; }\n-  nmethod* as_nmethod()                       { assert(is_nmethod(), \"must be nmethod\"); return (nmethod*) this; }\n+  nmethod* as_nmethod_or_null() const         { return is_nmethod() ? (nmethod*) this : nullptr; }\n+  nmethod* as_nmethod() const                 { assert(is_nmethod(), \"must be nmethod\"); return (nmethod*) this; }\n@@ -236,4 +254,7 @@\n-  virtual void verify() = 0;\n-  virtual void print() const;\n-  virtual void print_on(outputStream* st) const;\n-  virtual void print_value_on(outputStream* st) const;\n+  void verify();\n+  void print() const;\n+  void print_on_v(outputStream* st) const;\n+  void print_value_on_v(outputStream* st) const;\n+  void print_on_nv(outputStream* st) const;\n+  void print_value_on_nv(outputStream* st) const;\n+\n@@ -244,7 +265,1 @@\n-  virtual void print_block_comment(outputStream* stream, address block_begin) const {\n-#ifndef PRODUCT\n-    ptrdiff_t offset = block_begin - code_begin();\n-    assert(offset >= 0, \"Expecting non-negative offset!\");\n-    _asm_remarks.print(uint(offset), stream);\n-#endif\n-  }\n+  void print_block_comment(outputStream* stream, address block_begin) const;\n@@ -321,2 +336,2 @@\n-  \/\/ Verification support\n-  void verify() override;\n+  void print_on(outputStream* st) const;\n+  void print_value_on(outputStream* st) const;\n@@ -324,2 +339,10 @@\n-  void print_on(outputStream* st) const override;\n-  void print_value_on(outputStream* st) const override;\n+  class Vptr : public CodeBlob::Vptr {\n+    void print_on(const CodeBlob* instance, outputStream* st) const override {\n+      ((const BufferBlob*)instance)->print_on(st);\n+    }\n+    void print_value_on(const CodeBlob* instance, outputStream* st) const override {\n+      ((const BufferBlob*)instance)->print_value_on(st);\n+    }\n+  };\n+\n+  static const Vptr _vptr;\n@@ -358,1 +381,1 @@\n-  MethodHandlesAdapterBlob(int size): BufferBlob(\"MethodHandles adapters\", CodeBlobKind::MH_Adapter, size) {}\n+  MethodHandlesAdapterBlob(int size): BufferBlob(\"MethodHandles adapters\", CodeBlobKind::MHAdapter, size) {}\n@@ -401,2 +424,11 @@\n-  \/\/ Verification support\n-  void verify() override;\n+  void print_on(outputStream* st) const;\n+  void print_value_on(outputStream* st) const;\n+\n+  class Vptr : public CodeBlob::Vptr {\n+    void print_on(const CodeBlob* instance, outputStream* st) const override {\n+      instance->as_runtime_stub()->print_on(st);\n+    }\n+    void print_value_on(const CodeBlob* instance, outputStream* st) const override {\n+      instance->as_runtime_stub()->print_value_on(st);\n+    }\n+  };\n@@ -404,2 +436,1 @@\n-  void print_on(outputStream* st) const override;\n-  void print_value_on(outputStream* st) const override;\n+  static const Vptr _vptr;\n@@ -433,2 +464,2 @@\n-  \/\/ Verification support\n-  void verify() override; \/\/ does nothing\n+  void print_on(outputStream* st) const;\n+  void print_value_on(outputStream* st) const;\n@@ -436,2 +467,10 @@\n-  void print_on(outputStream* st) const override;\n-  void print_value_on(outputStream* st) const override;\n+  class Vptr : public CodeBlob::Vptr {\n+    void print_on(const CodeBlob* instance, outputStream* st) const override {\n+      ((const SingletonBlob*)instance)->print_on(st);\n+    }\n+    void print_value_on(const CodeBlob* instance, outputStream* st) const override {\n+      ((const SingletonBlob*)instance)->print_value_on(st);\n+    }\n+  };\n+\n+  static const Vptr _vptr;\n@@ -482,3 +521,0 @@\n-  \/\/ Printing\n-  void print_value_on(outputStream* st) const override;\n-\n@@ -514,0 +550,10 @@\n+\n+  void print_value_on(outputStream* st) const;\n+\n+  class Vptr : public CodeBlob::Vptr {\n+    void print_value_on(const CodeBlob* instance, outputStream* st) const override {\n+      ((const DeoptimizationBlob*)instance)->print_value_on(st);\n+    }\n+  };\n+\n+  static const Vptr _vptr;\n@@ -622,1 +668,2 @@\n-  jobject receiver() { return _receiver; }\n+  jobject  receiver()          { return _receiver; }\n+  ByteSize frame_data_offset() { return _frame_data_offset; }\n@@ -626,1 +673,1 @@\n-  \/\/ GC\/Verification support\n+  \/\/ GC support\n@@ -628,1 +675,0 @@\n-  void verify() override;\n@@ -630,3 +676,13 @@\n-  \/\/ Misc.\n-  void print_on(outputStream* st) const override;\n-  void print_value_on(outputStream* st) const override;\n+  void print_on(outputStream* st) const;\n+  void print_value_on(outputStream* st) const;\n+\n+  class Vptr : public CodeBlob::Vptr {\n+    void print_on(const CodeBlob* instance, outputStream* st) const override {\n+      instance->as_upcall_stub()->print_on(st);\n+    }\n+    void print_value_on(const CodeBlob* instance, outputStream* st) const override {\n+      instance->as_upcall_stub()->print_value_on(st);\n+    }\n+  };\n+\n+  static const Vptr _vptr;\n","filename":"src\/hotspot\/share\/code\/codeBlob.hpp","additions":101,"deletions":45,"binary":false,"changes":146,"status":"modified"},{"patch":"@@ -881,1 +881,1 @@\n-      _code->print_value_on(st);\n+      _code->print_value_on_v(st);\n","filename":"src\/hotspot\/share\/code\/dependencies.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -81,1 +81,1 @@\n-        nm->print_on(&ls);\n+        nm->print_on_v(&ls);\n","filename":"src\/hotspot\/share\/code\/dependencyContext.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -955,1 +955,1 @@\n-    print_on(&ss);\n+    print_on_v(&ss);\n@@ -3032,6 +3032,1 @@\n-void nmethod::print() const {\n-  ttyLocker ttyl;   \/\/ keep the following output all in one block\n-  print(tty);\n-}\n-\n-void nmethod::print(outputStream* st) const {\n+void nmethod::print_on(outputStream* st) const {\n@@ -3403,1 +3398,1 @@\n-  this->print(st);\n+  this->print_on_v(st);\n","filename":"src\/hotspot\/share\/code\/nmethod.cpp","additions":3,"deletions":8,"binary":false,"changes":11,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -903,1 +903,1 @@\n-  void verify() override;\n+  void verify();\n@@ -915,2 +915,1 @@\n-  void print()                 const override;\n-  void print(outputStream* st) const;\n+  void print_on(outputStream* st) const;\n@@ -925,1 +924,1 @@\n-  void print_value_on(outputStream* st) const override;\n+  void print_value_on(outputStream* st) const;\n@@ -944,2 +943,0 @@\n-  \/\/ need to re-define this from CodeBlob else the overload hides it\n-  void print_on(outputStream* st) const override { CodeBlob::print_on(st); }\n@@ -954,7 +951,0 @@\n-  void print_block_comment(outputStream* stream, address block_begin) const override {\n-#if defined(SUPPORT_ASSEMBLY) || defined(SUPPORT_ABSTRACT_ASSEMBLY)\n-    print_nmethod_labels(stream, block_begin);\n-    CodeBlob::print_block_comment(stream, block_begin);\n-#endif\n-  }\n-\n@@ -998,0 +988,14 @@\n+\n+  struct Vptr : public CodeBlob::Vptr {\n+    void print_on(const CodeBlob* instance, outputStream* st) const override {\n+      ttyLocker ttyl;\n+      instance->as_nmethod()->print_on(st);\n+    }\n+#if defined(SUPPORT_DATA_STRUCTS)\n+    void print_value_on(const CodeBlob* instance, outputStream* st) const override {\n+      ((const nmethod*)instance)->print_value_on(st);\n+    }\n+#endif\n+  };\n+\n+  static const Vptr _vptr;\n","filename":"src\/hotspot\/share\/code\/nmethod.hpp","additions":18,"deletions":14,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -567,1 +567,1 @@\n-  cb->print_value_on(tty);  tty->cr();\n+  cb->print_value_on_v(tty);  tty->cr();\n","filename":"src\/hotspot\/share\/compiler\/oopMap.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -652,1 +652,1 @@\n-      cb->print_value_on(tty);\n+      cb->print_value_on_v(tty);\n","filename":"src\/hotspot\/share\/jvmci\/jvmciRuntime.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -2368,1 +2368,1 @@\n-    code()->print_value_on(st);\n+    code()->print_value_on_v(st);\n","filename":"src\/hotspot\/share\/oops\/method.cpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -322,1 +322,1 @@\n-    nm->print_value_on(&ls);\n+    nm->print_value_on_v(&ls);\n@@ -540,1 +540,1 @@\n-    _cb->print_value_on(st);\n+    _cb->print_value_on_v(st);\n","filename":"src\/hotspot\/share\/runtime\/frame.cpp","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -178,1 +178,1 @@\n-      nm()->print_on(&ss);\n+      nm()->print_on_v(&ss);\n","filename":"src\/hotspot\/share\/runtime\/vframe.inline.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -553,0 +553,1 @@\n+  nonstatic_field(CodeBlob,                    _kind,                                         CodeBlobKind)                          \\\n@@ -1920,0 +1921,1 @@\n+  declare_integer_type(CodeBlobKind)                                      \\\n@@ -2377,0 +2379,16 @@\n+  \/****************\/                                                      \\\n+  \/* CodeBlobKind *\/                                                      \\\n+  \/****************\/                                                      \\\n+                                                                          \\\n+  declare_constant(CodeBlobKind::Nmethod)                                 \\\n+  declare_constant(CodeBlobKind::Buffer)                                  \\\n+  declare_constant(CodeBlobKind::Adapter)                                 \\\n+  declare_constant(CodeBlobKind::Vtable)                                  \\\n+  declare_constant(CodeBlobKind::MHAdapter)                               \\\n+  declare_constant(CodeBlobKind::RuntimeStub)                             \\\n+  declare_constant(CodeBlobKind::Deoptimization)                          \\\n+  declare_constant(CodeBlobKind::Exception)                               \\\n+  declare_constant(CodeBlobKind::Safepoint)                               \\\n+  declare_constant(CodeBlobKind::UncommonTrap)                            \\\n+  declare_constant(CodeBlobKind::Upcall)                                  \\\n+                                                                          \\\n","filename":"src\/hotspot\/share\/runtime\/vmStructs.cpp","additions":18,"deletions":0,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -65,1 +65,1 @@\n-    return VM.getVM().getCodeCache().createCodeBlobWrapper(blobAddr);\n+    return VM.getVM().getCodeCache().createCodeBlobWrapper(blobAddr, blobAddr);\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/c1\/Runtime1.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,4 +53,0 @@\n-  public boolean isAdapterBlob() {\n-    return true;\n-  }\n-\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/AdapterBlob.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -52,4 +52,0 @@\n-\n-  public boolean isBufferBlob() {\n-    return true;\n-  }\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/BufferBlob.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2015, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2015, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -46,0 +46,1 @@\n+  private static CIntegerField kindField;\n@@ -55,0 +56,13 @@\n+  \/\/ Kinds of Codeblob\n+  private static int NMethodKind;\n+  private static int BufferKind;\n+  private static int AdapterKind;\n+  private static int VtableKind;\n+  private static int MHAdapterKind;\n+  private static int RuntimeStubKind;\n+  private static int DeoptimizationKind;\n+  private static int ExceptionKind;\n+  private static int SafepointKind;\n+  private static int UncommonTrapKind;\n+  private static int UpcallKind;\n+\n@@ -66,0 +80,1 @@\n+    kindField                = type.getCIntegerField(\"_kind\");\n@@ -79,0 +94,14 @@\n+\n+    NMethodKind        = db.lookupIntConstant(\"CodeBlobKind::Nmethod\").intValue();\n+    BufferKind         = db.lookupIntConstant(\"CodeBlobKind::Buffer\").intValue();\n+    AdapterKind        = db.lookupIntConstant(\"CodeBlobKind::Adapter\").intValue();\n+    VtableKind         = db.lookupIntConstant(\"CodeBlobKind::Vtable\").intValue();\n+    MHAdapterKind      = db.lookupIntConstant(\"CodeBlobKind::MHAdapter\").intValue();\n+    RuntimeStubKind    = db.lookupIntConstant(\"CodeBlobKind::RuntimeStub\").intValue();\n+    DeoptimizationKind = db.lookupIntConstant(\"CodeBlobKind::Deoptimization\").intValue();\n+    SafepointKind      = db.lookupIntConstant(\"CodeBlobKind::Safepoint\").intValue();\n+    UpcallKind         = db.lookupIntConstant(\"CodeBlobKind::Upcall\").intValue();\n+    if (VM.getVM().isServerCompiler()) {\n+      ExceptionKind    = db.lookupIntConstant(\"CodeBlobKind::Exception\").intValue();\n+      UncommonTrapKind = db.lookupIntConstant(\"CodeBlobKind::UncommonTrap\").intValue();\n+    }\n@@ -89,0 +118,31 @@\n+  public static Class<?> getClassFor(Address addr) {\n+      CodeBlob cb = new CodeBlob(addr);\n+      if (cb.isNMethod()) {\n+          return NMethod.class;\n+      } else if (cb.isBufferBlob()) {\n+          return BufferBlob.class;\n+      } else if (cb.isAdapterBlob()) {\n+          return AdapterBlob.class;\n+      } else if (cb.isVtableBlob()) {\n+          return VtableBlob.class;\n+      } else if (cb.isMHAdapterBlob()) {\n+          return MethodHandlesAdapterBlob.class;\n+      } else if (cb.isRuntimeStub()) {\n+          return RuntimeStub.class;\n+      } else if (cb.isDeoptimizationBlob()) {\n+          return DeoptimizationBlob.class;\n+      } else if (cb.isSafepointBlob()) {\n+          return SafepointBlob.class;\n+      } else if (cb.isUpcallStub()) {\n+          return UpcallStub.class;\n+      }\n+      if (VM.getVM().isServerCompiler()) {\n+        if (cb.isExceptionBlob()) {\n+            return ExceptionBlob.class;\n+        } else if (cb.isUncommonTrapBlob()) {\n+            return UncommonTrapBlob.class;\n+        }\n+      }\n+      return null;\n+  }\n+\n@@ -127,0 +187,4 @@\n+  public int getKind() {\n+    return (int) kindField.getValue(addr);\n+  }\n+\n@@ -138,1 +202,3 @@\n-  public boolean isBufferBlob()         { return false; }\n+  public boolean isBufferBlob()         { return getKind() == BufferKind; }\n+\n+  public boolean isNMethod()            { return getKind() == NMethodKind; }\n@@ -140,1 +206,1 @@\n-  public boolean isCompiled()           { return false; }\n+  public boolean isRuntimeStub()        { return getKind() == RuntimeStubKind; }\n@@ -142,1 +208,1 @@\n-  public boolean isNMethod()            { return false; }\n+  public boolean isUpcallStub()         { return getKind() == UpcallKind; }\n@@ -144,1 +210,1 @@\n-  public boolean isRuntimeStub()        { return false; }\n+  public boolean isDeoptimizationBlob() { return getKind() == DeoptimizationKind; }\n@@ -146,1 +212,1 @@\n-  public boolean isUpcallStub()         { return false; }\n+  public boolean isUncommonTrapBlob()   { return getKind() == UncommonTrapKind; }\n@@ -148,1 +214,1 @@\n-  public boolean isDeoptimizationStub() { return false; }\n+  public boolean isExceptionBlob()      { return getKind() == ExceptionKind; }\n@@ -150,1 +216,1 @@\n-  public boolean isUncommonTrapStub()   { return false; }\n+  public boolean isSafepointBlob()      { return getKind() == SafepointKind; }\n@@ -152,1 +218,1 @@\n-  public boolean isExceptionStub()      { return false; }\n+  public boolean isAdapterBlob()        { return getKind() == AdapterKind; }\n@@ -154,1 +220,1 @@\n-  public boolean isSafepointStub()      { return false; }\n+  public boolean isMHAdapterBlob()      { return getKind() == MHAdapterKind; }\n@@ -156,1 +222,1 @@\n-  public boolean isAdapterBlob()        { return false; }\n+  public boolean isVtableBlob()         { return getKind() == VtableKind; }\n@@ -158,1 +224,1 @@\n-  \/\/ Fine grain nmethod support: isNmethod() == isJavaMethod() || isNativeMethod() || isOSRMethod()\n+  \/\/ Fine grain nmethod support: isNMethod() == isJavaMethod() || isNativeMethod() || isOSRMethod()\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/CodeBlob.java","additions":78,"deletions":12,"binary":false,"changes":90,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -38,1 +38,0 @@\n-  private static VirtualConstructor virtualConstructor;\n@@ -54,16 +53,0 @@\n-\n-    virtualConstructor = new VirtualConstructor(db);\n-    \/\/ Add mappings for all possible CodeBlob subclasses\n-    virtualConstructor.addMapping(\"BufferBlob\", BufferBlob.class);\n-    virtualConstructor.addMapping(\"nmethod\", NMethod.class);\n-    virtualConstructor.addMapping(\"RuntimeStub\", RuntimeStub.class);\n-    virtualConstructor.addMapping(\"AdapterBlob\", AdapterBlob.class);\n-    virtualConstructor.addMapping(\"MethodHandlesAdapterBlob\", MethodHandlesAdapterBlob.class);\n-    virtualConstructor.addMapping(\"VtableBlob\", VtableBlob.class);\n-    virtualConstructor.addMapping(\"UpcallStub\", UpcallStub.class);\n-    virtualConstructor.addMapping(\"SafepointBlob\", SafepointBlob.class);\n-    virtualConstructor.addMapping(\"DeoptimizationBlob\", DeoptimizationBlob.class);\n-    if (VM.getVM().isServerCompiler()) {\n-      virtualConstructor.addMapping(\"ExceptionBlob\", ExceptionBlob.class);\n-      virtualConstructor.addMapping(\"UncommonTrapBlob\", UncommonTrapBlob.class);\n-    }\n@@ -95,1 +78,0 @@\n-    CodeBlob result = null;\n@@ -107,11 +89,2 @@\n-    try {\n-      result = (CodeBlob) virtualConstructor.instantiateWrapperFor(containing_heap.findStart(start));\n-    }\n-    catch (WrongTypeException wte) {\n-      Address cbAddr = null;\n-      try {\n-        cbAddr = containing_heap.findStart(start);\n-      }\n-      catch (Exception findEx) {\n-        findEx.printStackTrace();\n-      }\n+    Address cbAddr = containing_heap.findStart(start);\n+    if (cbAddr == null) return null;\n@@ -119,0 +92,6 @@\n+    return createCodeBlobWrapper(cbAddr, start);\n+  }\n+\n+  public CodeBlob createCodeBlobWrapper(Address cbAddr, Address start) {\n+    Class<?> cbClass = CodeBlob.getClassFor(cbAddr);\n+    if (cbClass == null) {\n@@ -120,3 +99,1 @@\n-      if (cbAddr != null) {\n-        message = message + \"@\" + cbAddr + \" \";\n-      }\n+      message = message + \"@\" + cbAddr + \" \";\n@@ -125,1 +102,1 @@\n-      throw new RuntimeException(message, wte);\n+      throw new RuntimeException(message);\n@@ -127,1 +104,1 @@\n-    if (result == null) return null;\n+    CodeBlob result = (CodeBlob) VMObjectFactory.newObject(cbClass, cbAddr);\n@@ -156,21 +133,0 @@\n-  \/** Routine for instantiating appropriately-typed wrapper for a\n-      CodeBlob. Used by CodeCache, Runtime1, etc. *\/\n-  public CodeBlob createCodeBlobWrapper(Address codeBlobAddr) {\n-    try {\n-      return (CodeBlob) virtualConstructor.instantiateWrapperFor(codeBlobAddr);\n-    }\n-    catch (Exception e) {\n-      String message = \"Unable to deduce type of CodeBlob from address \" + codeBlobAddr +\n-                       \" (expected type nmethod, RuntimeStub, VtableBlob, \";\n-      if (VM.getVM().isClientCompiler()) {\n-        message = message + \" or \";\n-      }\n-      message = message + \"SafepointBlob\";\n-      if (VM.getVM().isServerCompiler()) {\n-        message = message + \", DeoptimizationBlob, or ExceptionBlob\";\n-      }\n-      message = message + \")\";\n-      throw new RuntimeException(message);\n-    }\n-  }\n-\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/CodeCache.java","additions":12,"deletions":56,"binary":false,"changes":68,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -52,4 +52,0 @@\n-\n-  public boolean isDeoptimizationStub() {\n-    return true;\n-  }\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/DeoptimizationBlob.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -55,4 +55,0 @@\n-\n-  public boolean isExceptionStub() {\n-    return true;\n-  }\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/ExceptionBlob.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2011, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2011, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,4 +53,0 @@\n-  public boolean isMethodHandlesAdapterBlob() {\n-    return true;\n-  }\n-\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/MethodHandlesAdapterBlob.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -120,1 +120,0 @@\n-  public boolean isNMethod()      { return true;                    }\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/NMethod.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -56,4 +56,0 @@\n-  public boolean isRuntimeStub() {\n-    return true;\n-  }\n-\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/RuntimeStub.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -54,4 +54,0 @@\n-\n-  public boolean isSafepointStub() {\n-    return true;\n-  }\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/SafepointBlob.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -52,2 +52,0 @@\n-\n-  public boolean isSingletonBlob()      { return true; }\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/SingletonBlob.java","additions":1,"deletions":3,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -54,4 +54,0 @@\n-\n-  public boolean isUncommonTrapStub() {\n-    return true;\n-  }\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/UncommonTrapBlob.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2024, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -88,4 +88,0 @@\n-  public boolean isUpcallStub() {\n-    return true;\n-  }\n-\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/UpcallStub.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -36,4 +36,0 @@\n-    public boolean isVtableBlob() {\n-        return true;\n-    }\n-\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/code\/VtableBlob.java","additions":1,"deletions":5,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2022, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -111,1 +111,1 @@\n-        CodeBlob blob = cache.createCodeBlobWrapper(findStart(ptr));\n+        CodeBlob blob = cache.createCodeBlobWrapper(findStart(ptr), ptr);\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/memory\/CodeHeap.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -165,0 +165,6 @@\n+                            } else if (cb.isAdapterBlob()) {\n+                               out.println(\"<AdapterBlob>\");\n+                            } else if (cb.isVtableBlob()) {\n+                               out.println(\"<VtableBlob>\");\n+                            } else if (cb.isMHAdapterBlob()) {\n+                               out.println(\"<MethodHandlesAdapterBlob>\");\n@@ -167,8 +173,10 @@\n-                            } else if (cb.isDeoptimizationStub()) {\n-                               out.println(\"<DeoptimizationStub>\");\n-                            } else if (cb.isUncommonTrapStub()) {\n-                               out.println(\"<UncommonTrap>\");\n-                            } else if (cb.isExceptionStub()) {\n-                               out.println(\"<ExceptionStub>\");\n-                            } else if (cb.isSafepointStub()) {\n-                               out.println(\"<SafepointStub>\");\n+                            } else if (cb.isUpcallStub()) {\n+                               out.println(\"<UpcallStub>\");\n+                            } else if (cb.isDeoptimizationBlob()) {\n+                               out.println(\"<DeoptimizationBlob>\");\n+                            } else if (cb.isUncommonTrapBlob()) {\n+                               out.println(\"<UncommonTrapBlob>\");\n+                            } else if (cb.isExceptionBlob()) {\n+                               out.println(\"<ExceptionBlob>\");\n+                            } else if (cb.isSafepointBlob()) {\n+                               out.println(\"<SafepointBlob>\");\n","filename":"src\/jdk.hotspot.agent\/share\/classes\/sun\/jvm\/hotspot\/tools\/PStack.java","additions":17,"deletions":9,"binary":false,"changes":26,"status":"modified"}]}