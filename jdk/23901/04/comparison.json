{"files":[{"patch":"@@ -113,0 +113,6 @@\n+  <Event name=\"JavaMonitorNotify\" category=\"Java Application\" label=\"Java Monitor Notify\" description=\"Notifying a Java monitor\" thread=\"true\" stackTrace=\"true\">\n+    <Field type=\"Class\" name=\"monitorClass\" label=\"Monitor Class\" description=\"Class of object waited on\" \/>\n+    <Field type=\"uint\" name=\"notifiedCount\" label=\"Notified Threads\" description=\"Number of actually notified threads\" \/>\n+    <Field type=\"ulong\" contentType=\"address\" name=\"address\" label=\"Monitor Address\" description=\"Address of object waited on\" relation=\"JavaMonitorAddress\" \/>\n+  <\/Event>\n+\n","filename":"src\/hotspot\/share\/jfr\/metadata\/metadata.xml","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -1958,1 +1958,2 @@\n-void ObjectMonitor::notify_internal(JavaThread* current) {\n+bool ObjectMonitor::notify_internal(JavaThread* current) {\n+  bool did_notify = false;\n@@ -1983,0 +1984,1 @@\n+    did_notify = true;\n@@ -1998,0 +2000,19 @@\n+  return did_notify;\n+}\n+\n+static void post_monitor_notify_event(EventJavaMonitorNotify* event,\n+                                    ObjectMonitor* monitor,\n+                                    int notified_count) {\n+  assert(event != nullptr, \"invariant\");\n+  assert(monitor != nullptr, \"invariant\");\n+  const Klass* monitor_klass = monitor->object()->klass();\n+  if (ObjectMonitor::is_jfr_excluded(monitor_klass)) {\n+    return;\n+  }\n+  event->set_monitorClass(monitor_klass);\n+  \/\/ Set an address that is 'unique enough', such that events close in\n+  \/\/ time and with the same address are likely (but not guaranteed) to\n+  \/\/ belong to the same object.\n+  event->set_address((uintptr_t)monitor);\n+  event->set_notifiedCount(notified_count);\n+  event->commit();\n@@ -2016,0 +2037,2 @@\n+\n+  EventJavaMonitorNotify event;\n@@ -2017,2 +2040,6 @@\n-  notify_internal(current);\n-  OM_PERFDATA_OP(Notifications, inc(1));\n+  int tally = notify_internal(current) ? 1 : 0;\n+  OM_PERFDATA_OP(Notifications, inc(tally));\n+\n+  if ((tally > 0) && event.should_commit()) {\n+    post_monitor_notify_event(&event, this, \/* notified_count = *\/ tally);\n+  }\n@@ -2034,0 +2061,1 @@\n+  EventJavaMonitorNotify event;\n@@ -2037,2 +2065,3 @@\n-    tally++;\n-    notify_internal(current);\n+    if (notify_internal(current)) {\n+      tally++;\n+    }\n@@ -2042,0 +2071,4 @@\n+\n+  if ((tally > 0) && event.should_commit()) {\n+    post_monitor_notify_event(&event, this, \/* notified_count = *\/ tally);\n+  }\n","filename":"src\/hotspot\/share\/runtime\/objectMonitor.cpp","additions":38,"deletions":5,"binary":false,"changes":43,"status":"modified"},{"patch":"@@ -439,1 +439,1 @@\n-  void      notify_internal(JavaThread* current);\n+  bool      notify_internal(JavaThread* current);\n","filename":"src\/hotspot\/share\/runtime\/objectMonitor.hpp","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -98,0 +98,6 @@\n+    <event name=\"jdk.JavaMonitorNotify\">\n+      <setting name=\"enabled\">false<\/setting>\n+      <setting name=\"stackTrace\">true<\/setting>\n+      <setting name=\"threshold\">0 ms<\/setting>\n+    <\/event>\n+\n","filename":"src\/jdk.jfr\/share\/conf\/jfr\/default.jfc","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -98,0 +98,6 @@\n+    <event name=\"jdk.JavaMonitorNotify\">\n+      <setting name=\"enabled\">false<\/setting>\n+      <setting name=\"stackTrace\">true<\/setting>\n+      <setting name=\"threshold\">0 ms<\/setting>\n+    <\/event>\n+\n","filename":"src\/jdk.jfr\/share\/conf\/jfr\/profile.jfc","additions":6,"deletions":0,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -0,0 +1,110 @@\n+\/*\n+ * Copyright (c) 2013, 2025, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package jdk.jfr.event.runtime;\n+\n+import static jdk.test.lib.Asserts.assertFalse;\n+import static jdk.test.lib.Asserts.assertTrue;\n+\n+import java.time.Duration;\n+import java.util.List;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+\n+import jdk.jfr.Recording;\n+import jdk.jfr.consumer.RecordingStream;\n+import jdk.jfr.consumer.RecordedClass;\n+import jdk.jfr.consumer.RecordedEvent;\n+import jdk.test.lib.jfr.EventNames;\n+import jdk.test.lib.jfr.Events;\n+import jdk.test.lib.thread.TestThread;\n+import jdk.test.lib.thread.XRun;\n+\n+\/**\n+ * @test\n+ * @requires vm.flagless\n+ * @requires vm.hasJFR\n+ * @library \/test\/lib\n+ * @run main\/othervm jdk.jfr.event.runtime.TestJavaMonitorNotifyEvent\n+ *\/\n+public class TestJavaMonitorNotifyEvent {\n+\n+    private static final String FIELD_KLASS_NAME = \"monitorClass.name\";\n+    private static final String FIELD_ADDRESS    = \"address\";\n+    private static final String FIELD_NOTIFIED_COUNT = \"notifiedCount\";\n+\n+    private final static String EVENT_NAME = EventNames.JavaMonitorNotify;\n+    private static final long WAIT_TIME = 123456;\n+\n+    static class Lock {\n+    }\n+\n+    public static void main(String[] args) throws Throwable {\n+        final Lock lock = new Lock();\n+        final String lockClassName = lock.getClass().getName().replace('.', '\/');\n+        final long mainThreadId = Thread.currentThread().threadId();\n+\n+        List<RecordedEvent> events = new CopyOnWriteArrayList<>();\n+        try (RecordingStream rs = new RecordingStream()) {\n+            rs.enable(EVENT_NAME).withoutThreshold();\n+            rs.onEvent(EVENT_NAME, e -> {\n+                long threadId = e.getThread().getJavaThreadId();\n+                Object clazz = e.getValue(FIELD_KLASS_NAME);\n+                if (clazz.equals(lockClassName) && (threadId == mainThreadId)) {\n+                    events.add(e);\n+                    rs.close();\n+                }\n+            });\n+            rs.startAsync();\n+\n+            final CountDownLatch latch = new CountDownLatch(1);\n+            TestThread waitThread = new TestThread(new XRun() {\n+                @Override\n+                public void xrun() throws Throwable {\n+                    synchronized (lock) {\n+                        latch.countDown();\n+                        lock.wait(WAIT_TIME);\n+                    }\n+                }\n+            });\n+            try {\n+                waitThread.start();\n+                latch.await();\n+                synchronized (lock) {\n+                    lock.notifyAll();\n+                }\n+            } finally {\n+                waitThread.join();\n+            }\n+\n+            rs.awaitTermination();\n+\n+            System.out.println(events);\n+            assertFalse(events.isEmpty());\n+            for (RecordedEvent ev : events) {\n+                Events.assertField(ev, FIELD_ADDRESS).notEqual(0L);\n+                Events.assertField(ev, FIELD_NOTIFIED_COUNT).equal(1);\n+            }\n+        }\n+    }\n+}\n","filename":"test\/jdk\/jdk\/jfr\/event\/runtime\/TestJavaMonitorNotifyEvent.java","additions":110,"deletions":0,"binary":false,"changes":110,"status":"added"},{"patch":"@@ -61,0 +61,1 @@\n+    public static final String JavaMonitorNotify = PREFIX + \"JavaMonitorNotify\";\n","filename":"test\/lib\/jdk\/test\/lib\/jfr\/EventNames.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}