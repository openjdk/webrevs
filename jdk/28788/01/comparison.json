{"files":[{"patch":"@@ -1584,1 +1584,1 @@\n-    public void draining(final QuicPacketReceiver connection) {\n+    public void draining(final QuicConnectionImpl connection) {\n@@ -1587,0 +1587,7 @@\n+\n+        final long idleTimeout = connection.peerPtoMs() * 3; \/\/ 3 PTO\n+        connection.localConnectionIdManager().close();\n+        DrainingConnection draining = new DrainingConnection(connection.connectionIds(), idleTimeout);\n+        \/\/ we can ignore stateless reset in the draining state.\n+        remapPeerIssuedResetToken(connection, draining);\n+\n@@ -1588,1 +1595,2 @@\n-                connections.compute(id, this::remapDraining));\n+                connections.compute(id, (i, r) -> remapDraining(i, r, draining)));\n+        draining.startTimer();\n@@ -1592,1 +1600,1 @@\n-    private DrainingConnection remapDraining(QuicConnectionId id, QuicPacketReceiver conn) {\n+    private DrainingConnection remapDraining(QuicConnectionId id, QuicPacketReceiver conn, DrainingConnection draining) {\n@@ -1595,1 +1603,1 @@\n-        if (conn instanceof ClosingConnection closing) {\n+        if (conn instanceof QuicConnectionImpl || conn instanceof ClosingConnection) {\n@@ -1597,14 +1605,0 @@\n-            final var draining = closing.toDraining();\n-            remapPeerIssuedResetToken(closing, draining);\n-            draining.startTimer();\n-            return draining;\n-        } else if (conn instanceof DrainingConnection draining) {\n-            return draining;\n-        } else if (conn instanceof QuicConnectionImpl impl) {\n-            final long idleTimeout = impl.peerPtoMs() * 3; \/\/ 3 PTO\n-            impl.localConnectionIdManager().close();\n-            if (debugOn) debug.log(\"remapping %s to DrainingConnection\", id);\n-            var draining = new DrainingConnection(conn.connectionIds(), idleTimeout);\n-            \/\/ we can ignore stateless reset in the draining state.\n-            remapPeerIssuedResetToken(impl, draining);\n-            draining.startTimer();\n@@ -1612,0 +1606,2 @@\n+        } else if (conn instanceof DrainingConnection d) {\n+            return d;\n@@ -1626,3 +1622,9 @@\n-        ByteBuffer closing = ByteBuffer.allocate(datagram.limit());\n-        closing.put(datagram.slice());\n-        closing.flip();\n+        ByteBuffer closingDatagram = ByteBuffer.allocate(datagram.limit());\n+        closingDatagram.put(datagram.slice());\n+        closingDatagram.flip();\n+\n+        final long idleTimeout = connection.peerPtoMs() * 3; \/\/ 3 PTO\n+        connection.localConnectionIdManager().close();\n+        var closingConnection = new ClosingConnection(connection.connectionIds(), idleTimeout, datagram);\n+        remapPeerIssuedResetToken(connection, closingConnection);\n+\n@@ -1630,1 +1632,2 @@\n-                connections.compute(id, (i, r) -> remapClosing(i, r, closing)));\n+                connections.compute(id, (i, r) -> remapClosing(i, r, closingConnection)));\n+        closingConnection.startTimer();\n@@ -1634,1 +1637,1 @@\n-    private ClosedConnection remapClosing(QuicConnectionId id, QuicPacketReceiver conn, ByteBuffer datagram) {\n+    private ClosedConnection remapClosing(QuicConnectionId id, QuicPacketReceiver conn, ClosingConnection closingConnection) {\n@@ -1637,1 +1640,4 @@\n-        if (conn instanceof ClosingConnection closing) {\n+        if (conn instanceof QuicConnectionImpl) {\n+            if (debugOn) debug.log(\"remapping %s to ClosingConnection\", id);\n+            return closingConnection;\n+        } else if (conn instanceof ClosingConnection closing) {\n@@ -1642,8 +1648,0 @@\n-        } else if (conn instanceof QuicConnectionImpl impl) {\n-            final long idleTimeout = impl.peerPtoMs() * 3; \/\/ 3 PTO\n-            impl.localConnectionIdManager().close();\n-            if (debugOn) debug.log(\"remapping %s to ClosingConnection\", id);\n-            var closing = new ClosingConnection(conn.connectionIds(), idleTimeout, datagram);\n-            remapPeerIssuedResetToken(impl, closing);\n-            closing.startTimer();\n-            return closing;\n@@ -1899,4 +1897,0 @@\n-\n-        private DrainingConnection toDraining() {\n-            return new DrainingConnection(localConnectionIds, maxIdleTimeMs);\n-        }\n","filename":"src\/java.net.http\/share\/classes\/jdk\/internal\/net\/http\/quic\/QuicEndpoint.java","additions":30,"deletions":36,"binary":false,"changes":66,"status":"modified"},{"patch":"@@ -74,0 +74,1 @@\n+ * @bug 8373409\n","filename":"test\/jdk\/java\/net\/httpclient\/http3\/H3ErrorHandlingTest.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}