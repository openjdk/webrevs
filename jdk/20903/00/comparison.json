{"files":[{"patch":"@@ -3,0 +3,1 @@\n+ * Copyright (c) 2024, Alibaba Group Holding Limited. All Rights Reserved.\n@@ -28,0 +29,2 @@\n+import jdk.internal.access.JavaLangAccess;\n+import jdk.internal.access.SharedSecrets;\n@@ -30,0 +33,1 @@\n+import java.nio.charset.StandardCharsets;\n@@ -48,0 +52,1 @@\n+    private static final JavaLangAccess JLA = SharedSecrets.getJavaLangAccess();\n@@ -576,2 +581,1 @@\n-        byte[] bytearr;\n-        char[] chararr;\n+        byte[] bytearr = null;\n@@ -579,3 +583,2 @@\n-            if (dis.bytearr.length < utflen) {\n-                dis.bytearr = new byte[utflen*2];\n-                dis.chararr = new char[utflen*2];\n+            if (dis.bytearr.length >= utflen) {\n+                bytearr = dis.bytearr;\n@@ -583,3 +586,3 @@\n-            chararr = dis.chararr;\n-            bytearr = dis.bytearr;\n-        } else {\n+        }\n+        boolean trusted = false;\n+        if (bytearr == null) {\n@@ -587,1 +590,1 @@\n-            chararr = new char[utflen];\n+            trusted = true;\n@@ -595,0 +598,14 @@\n+        int ascii = JLA.countPositives(bytearr, 0, utflen);\n+        if (ascii == utflen) {\n+            String str;\n+            if (trusted) {\n+                str = JLA.newStringNoRepl(bytearr, StandardCharsets.ISO_8859_1);\n+            } else {\n+                str = new String(bytearr, 0, utflen, StandardCharsets.ISO_8859_1);\n+            }\n+            return str;\n+        }\n+        if (trusted && in instanceof DataInputStream dis) {\n+            dis.bytearr = bytearr;\n+            trusted = false;\n+        }\n@@ -596,5 +613,14 @@\n-        while (count < utflen) {\n-            c = (int) bytearr[count] & 0xff;\n-            if (c > 127) break;\n-            count++;\n-            chararr[chararr_count++]=(char)c;\n+        char[] chararr;\n+        if (in instanceof DataInputStream dis) {\n+            if (dis.chararr.length < (utflen << 1)) {\n+                dis.chararr = new char[utflen << 1];\n+            }\n+            chararr = dis.chararr;\n+        } else {\n+            chararr = new char[utflen];\n+        }\n+\n+        if (ascii != 0) {\n+            JLA.inflateBytesToChars(bytearr, 0, chararr, 0, ascii);\n+            count += ascii;\n+            chararr_count += ascii;\n","filename":"src\/java.base\/share\/classes\/java\/io\/DataInputStream.java","additions":40,"deletions":14,"binary":false,"changes":54,"status":"modified"}]}