{"files":[{"patch":"@@ -202,1 +202,1 @@\n-  assert(value < ZBackingOffsetMax, \"Offset out of bounds (\" PTR_FORMAT \" < \" PTR_FORMAT \")\", value, ZAddressOffsetMax);\n+  assert(value < ZBackingOffsetMax, \"Offset out of bounds (\" PTR_FORMAT \" < \" PTR_FORMAT \")\", value, ZBackingOffsetMax);\n@@ -208,1 +208,1 @@\n-  assert(value <= ZBackingOffsetMax, \"Offset out of bounds (\" PTR_FORMAT \" <= \" PTR_FORMAT \")\", value, ZAddressOffsetMax);\n+  assert(value <= ZBackingOffsetMax, \"Offset out of bounds (\" PTR_FORMAT \" <= \" PTR_FORMAT \")\", value, ZBackingOffsetMax);\n@@ -213,1 +213,1 @@\n-  assert(value < ZBackingOffsetMax, \"Value out of bounds (\" PTR_FORMAT \" < \" PTR_FORMAT \")\", value, ZAddressOffsetMax);\n+  assert(value < ZBackingOffsetMax, \"Value out of bounds (\" PTR_FORMAT \" < \" PTR_FORMAT \")\", value, ZBackingOffsetMax);\n@@ -230,1 +230,1 @@\n-  assert(value <= ZBackingOffsetMax, \"Value out of bounds (\" PTR_FORMAT \" <= \" PTR_FORMAT \")\", value, ZAddressOffsetMax);\n+  assert(value <= ZBackingOffsetMax, \"Value out of bounds (\" PTR_FORMAT \" <= \" PTR_FORMAT \")\", value, ZBackingOffsetMax);\n","filename":"src\/hotspot\/share\/gc\/z\/zAddress.inline.hpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -47,5 +47,6 @@\n-  ZHeap*            _old_heap;\n-  ZGenerationOld*   _old_old;\n-  ZGenerationYoung* _old_young;\n-  ZAddressReserver  _zaddress_reserver;\n-  zoffset           _page_offset;\n+  ZHeap*                       _old_heap;\n+  ZGenerationOld*              _old_old;\n+  ZGenerationYoung*            _old_young;\n+  ZAddressReserver             _zaddress_reserver;\n+  ZPhysicalMemoryBackingMocker _physical_backing;\n+  zoffset                      _page_offset;\n@@ -76,2 +77,10 @@\n-    char* const addr = (char*)untype(ZOffset::address_unsafe(_page_offset));\n-    os::commit_memory(addr, ZGranuleSize, \/* executable *\/ false);\n+    \/\/ Setup backing storage\n+    _physical_backing.SetUp(ZGranuleSize);\n+\n+    size_t committed = _physical_backing()->commit(zbacking_offset(0), ZGranuleSize, 0);\n+\n+    if (committed != ZGranuleSize) {\n+      GTEST_SKIP() << \"Unable to commit memory\";\n+    }\n+\n+    _physical_backing()->map(ZOffset::address_unsafe(_page_offset), ZGranuleSize, zbacking_offset(0));\n@@ -87,2 +96,2 @@\n-      char* const addr = (char*)untype(ZOffset::address_unsafe(_page_offset));\n-      os::uncommit_memory(addr, ZGranuleSize, false \/* executable *\/);\n+      _physical_backing()->unmap(ZOffset::address_unsafe(_page_offset), ZGranuleSize);\n+      _physical_backing()->uncommit(zbacking_offset(0), ZGranuleSize);\n@@ -91,0 +100,2 @@\n+    _physical_backing.TearDown();\n+\n","filename":"test\/hotspot\/gtest\/gc\/z\/test_zForwarding.cpp","additions":20,"deletions":9,"binary":false,"changes":29,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+#include \"gc\/z\/zPhysicalMemoryManager.hpp\"\n@@ -107,0 +108,48 @@\n+  class ZPhysicalMemoryBackingMocker {\n+    size_t                  _old_max;\n+    ZPhysicalMemoryBacking* _backing;\n+    bool                    _active;\n+\n+    static size_t set_max(size_t max_capacity) {\n+      size_t old_max = ZBackingOffsetMax;\n+\n+      ZBackingOffsetMax = max_capacity;\n+      ZBackingIndexMax = checked_cast<uint32_t>(ZBackingOffsetMax >> ZGranuleSizeShift);\n+\n+      return old_max;\n+    }\n+\n+  public:\n+    ZPhysicalMemoryBackingMocker()\n+      : _old_max(0),\n+        _backing(nullptr),\n+        _active(false) {}\n+\n+    void SetUp(size_t max_capacity) {\n+      GTEST_EXPECT_FALSE(_active) << \"SetUp called twice without a TearDown\";\n+\n+      _old_max = set_max(max_capacity);\n+\n+      char* const mem = (char*)os::malloc(sizeof(ZPhysicalMemoryBacking), mtTest);\n+      _backing = new (mem) ZPhysicalMemoryBacking(ZGranuleSize);\n+\n+      _active = true;\n+    }\n+\n+    void TearDown() {\n+      GTEST_EXPECT_TRUE(_active) << \"TearDown called without a preceding SetUp\";\n+\n+      _active = false;\n+\n+      _backing->~ZPhysicalMemoryBacking();\n+      os::free(_backing);\n+      _backing = nullptr;\n+\n+      set_max(_old_max);\n+    }\n+\n+    ZPhysicalMemoryBacking* operator()() {\n+      return _backing;\n+    }\n+  };\n+\n","filename":"test\/hotspot\/gtest\/gc\/z\/zunittest.hpp","additions":49,"deletions":0,"binary":false,"changes":49,"status":"modified"}]}