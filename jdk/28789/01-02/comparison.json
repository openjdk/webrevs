{"files":[{"patch":"@@ -41,1 +41,0 @@\n-#include \"opto\/opcodes.hpp\"\n@@ -699,2 +698,0 @@\n-  } else if (mem->Opcode() == Op_StrInflatedCopy || mem->Opcode() == Op_StrCompressedCopy || mem->Opcode() == Op_EncodeISOArray) {\n-    res = mem->in(1);\n@@ -1607,3 +1604,0 @@\n-        } else if (mem->Opcode() == Op_StrInflatedCopy || mem->Opcode() == Op_StrCompressedCopy || mem->Opcode() == Op_EncodeISOArray) {\n-          stack.push(mem, mem->req());\n-          mem = mem->in(1);\n@@ -2154,2 +2148,1 @@\n-      } else if ((u->adr_type() == TypePtr::BOTTOM &&\n-                  u->Opcode() != Op_StrInflatedCopy && mem->Opcode() != Op_StrCompressedCopy && mem->Opcode() != Op_EncodeISOArray) ||\n+      } else if ((u->adr_type() == TypePtr::BOTTOM && u->Opcode() != Op_StrInflatedCopy) ||\n@@ -2341,2 +2334,1 @@\n-      } else if ((u->adr_type() == TypePtr::BOTTOM &&\n-                  u->Opcode() != Op_StrInflatedCopy && mem->Opcode() != Op_StrCompressedCopy && mem->Opcode() != Op_EncodeISOArray) ||\n+      } else if ((u->adr_type() == TypePtr::BOTTOM && u->Opcode() != Op_StrInflatedCopy) ||\n","filename":"src\/hotspot\/share\/gc\/shenandoah\/c2\/shenandoahSupport.cpp","additions":2,"deletions":10,"binary":false,"changes":12,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+#include \"opto\/memnode.hpp\"\n@@ -43,0 +44,1 @@\n+#include \"opto\/opcodes.hpp\"\n@@ -4186,0 +4188,1 @@\n+  const TypePtr* dst_type = TypeAryPtr::BYTES;\n@@ -4187,1 +4190,1 @@\n-  Node* mem = capture_memory(adr_type, src_type, TypeAryPtr::BYTES);\n+  Node* mem = capture_memory(adr_type, src_type, dst_type);\n@@ -4190,0 +4193,1 @@\n+  set_memory(res_mem, dst_type);\n@@ -4191,3 +4195,23 @@\n-    set_all_memory(res_mem);\n-  } else {\n-    set_memory(res_mem, adr_type);\n+    \/\/ If dst_type and src_type are different, str may have an anti-dependency with another node\n+    \/\/ consuming src_type\n+    \/\/ For example:\n+    \/\/  compress_string\n+    \/\/  StoreC\n+    \/\/ has this memory graph (use->def):\n+    \/\/  compress_string -> MergeMem -> CharMem\n+    \/\/                       StoreC\n+    \/\/ The scheduler needs to ensure that compress_string is not executed after StoreC, or it will\n+    \/\/ read the wrong memory. For normal loads, the scheduler computes its anti-dependencies to\n+    \/\/ ensure the memory it reads from is not killed. Since we do not compute anti-dependencies for\n+    \/\/ StrCompressedCopyNode, manually insert a MemBar so the anti-dependency becomes use-def\n+    \/\/ dependency:\n+    \/\/  StoreC -> MemBar -> MergeMem -> compress_string -> MergeMem -> CharMem\n+    \/\/                               -------------------------------->\n+    Node* all_mem = reset_memory();\n+    set_all_memory(all_mem);\n+    Node* membar = new MemBarCPUOrderNode(C, C->get_alias_index(src_type), nullptr);\n+    membar->init_req(TypeFunc::Control, control());\n+    membar->init_req(TypeFunc::Memory, all_mem);\n+    membar = _gvn.transform(membar);\n+    set_control(_gvn.transform(new ProjNode(membar, TypeFunc::Control)));\n+    set_memory(_gvn.transform(new ProjNode(membar, TypeFunc::Memory)), src_type);\n@@ -4201,1 +4225,2 @@\n-  \/\/ Capture src and dst memory (see comment in 'compress_string').\n+  \/\/ Similar to compress_string\n+  const TypePtr* src_type = TypeAryPtr::BYTES;\n@@ -4203,1 +4228,1 @@\n-  Node* mem = capture_memory(adr_type, TypeAryPtr::BYTES, dst_type);\n+  Node* mem = capture_memory(adr_type, src_type, dst_type);\n@@ -4206,0 +4231,1 @@\n+  set_memory(res_mem, dst_type);\n@@ -4207,3 +4233,8 @@\n-    set_all_memory(res_mem);\n-  } else {\n-    set_memory(res_mem, adr_type);\n+    Node* all_mem = reset_memory();\n+    set_all_memory(all_mem);\n+    Node* membar = new MemBarCPUOrderNode(C, C->get_alias_index(src_type), nullptr);\n+    membar->init_req(TypeFunc::Control, control());\n+    membar->init_req(TypeFunc::Memory, all_mem);\n+    membar = _gvn.transform(membar);\n+    set_control(_gvn.transform(new ProjNode(membar, TypeFunc::Control)));\n+    set_memory(_gvn.transform(new ProjNode(membar, TypeFunc::Memory)), src_type);\n","filename":"src\/hotspot\/share\/opto\/graphKit.cpp","additions":40,"deletions":9,"binary":false,"changes":49,"status":"modified"},{"patch":"@@ -6238,0 +6238,1 @@\n+  \/\/ See GraphKit::compress_string\n@@ -6239,1 +6240,1 @@\n-  Node* mem = capture_memory(adr_type, TypeAryPtr::get_array_body_type(src_elem), TypeAryPtr::BYTES);\n+  Node* mem = capture_memory(adr_type, src_type, dst_type);\n@@ -6243,0 +6244,1 @@\n+  set_memory(res_mem, dst_type);\n@@ -6244,3 +6246,8 @@\n-    set_all_memory(res_mem);\n-  } else {\n-    set_memory(res_mem, adr_type);\n+    Node* all_mem = reset_memory();\n+    set_all_memory(all_mem);\n+    Node* membar = new MemBarCPUOrderNode(C, C->get_alias_index(src_type), nullptr);\n+    membar->init_req(TypeFunc::Control, control());\n+    membar->init_req(TypeFunc::Memory, all_mem);\n+    membar = _gvn.transform(membar);\n+    set_control(_gvn.transform(new ProjNode(membar, TypeFunc::Control)));\n+    set_memory(_gvn.transform(new ProjNode(membar, TypeFunc::Memory)), src_type);\n@@ -6248,0 +6255,1 @@\n+\n","filename":"src\/hotspot\/share\/opto\/library_call.cpp","additions":12,"deletions":4,"binary":false,"changes":16,"status":"modified"}]}