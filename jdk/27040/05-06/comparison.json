{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2001, 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2001, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -57,0 +57,1 @@\n+\/\/ doWork1 algorithm:\n@@ -80,0 +81,75 @@\n+\/\/\n+\/\/ doWork2 algorithm:\n+\/\/\n+\/\/ main               waiter              resumer\n+\/\/ =================  ==================  ===================\n+\/\/ launch waiter\n+\/\/ <launch returns>   waiter running\n+\/\/ launch resumer     enter threadLock\n+\/\/ <launch returns>   threadLock.wait()   resumer running\n+\/\/ enter threadLock   :                   wait for notify\n+\/\/ threadLock.notify  wait finishes       :\n+\/\/ :                  reenter blocks      :\n+\/\/ suspend waiter     <suspended>         :\n+\/\/ <ready to test>    :                   :\n+\/\/ :                  :                   :\n+\/\/ notify resumer     :                   wait finishes\n+\/\/ delay 1-second     :                   :\n+\/\/ exit threadLock    :                   :\n+\/\/ join resumer       :                   enter threadLock\n+\/\/ :                  <resumed>           resume waiter\n+\/\/ :                  :                   exit threadLock\n+\/\/ :                  reenter threadLock  :\n+\/\/ <join returns>     :                   resumer exits\n+\/\/ join waiter        :\n+\/\/ <join returns>     waiter exits\n+\/\/\n+\/\/ Note: The sleep(1-second) in main along with the delayed exit\n+\/\/       of threadLock in main forces the resumer thread to reach\n+\/\/       \"enter threadLock\" and block. This difference from doWork1\n+\/\/       forces the resumer thread to be contending for threadLock\n+\/\/       while the waiter thread is in threadLock.wait() increasing\n+\/\/       stress on the monitor sub-system.\n+\/\/\n+\n+\/\/\n+\/\/ doWork3 algorithm:\n+\/\/\n+\/\/ main                 waiter                  resumer\n+\/\/ ===================  ======================  ===================\n+\/\/ launch waiter\n+\/\/ <launch returns>     waiter running\n+\/\/ launch resumer       enter threadLock\n+\/\/ <launch returns>     while !READY_TO_NOTIFY  resumer running\n+\/\/ delay 1-second         threadLock.wait(1)    wait for notify\n+\/\/ enter threadLock     :                       :\n+\/\/ set READY_TO_NOTIFY  :\n+\/\/ threadLock.notify    wait finishes           :\n+\/\/ :                    reenter blocks          :\n+\/\/ suspend waiter       <suspended>             :\n+\/\/ <ready to test>      :                       :\n+\/\/ :                    :                       :\n+\/\/ notify resumer       :                       wait finishes\n+\/\/ delay 1-second       :                       :\n+\/\/ exit threadLock      :                       :\n+\/\/ join resumer         :                       enter threadLock\n+\/\/ :                    <resumed>               resume waiter\n+\/\/ :                    :                       exit threadLock\n+\/\/ :                    reenter threadLock      :\n+\/\/ <join returns>       :                       resumer exits\n+\/\/ join waiter          :\n+\/\/ <join returns>       waiter exits\n+\/\/\n+\/\/ Note: The sleep(1-second) in main along with the delayed exit\n+\/\/       of threadLock in main forces the resumer thread to reach\n+\/\/       \"enter threadLock\" and block. This difference from doWork1\n+\/\/       forces the resumer thread to be contending for threadLock\n+\/\/       while the waiter thread is in the threadLock.wait(1) tight\n+\/\/       loop increasing stress on the monitor sub-system.\n+\/\/\n+\/\/ Note: The first sleep(1-second) in main and the wait(1) in the waiter\n+\/\/       thread allows the waiter thread to loop tightly here:\n+\/\/         while !READY_TO_NOTIFY\n+\/\/           threadLock.wait(1)\n+\/\/\n+\n@@ -110,1 +186,6 @@\n-        int test = Integer.parseInt(args[0]);\n+        if (args.length == 0) {\n+            System.err.println(\"Invalid number of arguments, there should be at least a test case given.\");\n+            usage();\n+        }\n+\n+        int test = Integer.parseUnsignedInt(args[0]);\n@@ -121,1 +202,1 @@\n-        if (args.length == 0) {\n+        if (args.length == 1) {\n@@ -124,3 +205,3 @@\n-            int argIndex = 0;\n-            int argsLeft = args.length;\n-            if (args[0].equals(\"-p\")) {\n+            int argIndex = 1;\n+            int argsLeft = args.length-argIndex;\n+            if (args[argIndex].equals(\"-p\")) {\n@@ -128,1 +209,1 @@\n-                argIndex = 1;\n+                argIndex = 2;\n@@ -156,1 +237,1 @@\n-        System.err.println(\"Usage: \" + AGENT_LIB + \" [-p][time_max]\");\n+        System.err.println(\"Usage: \" + AGENT_LIB + \" [N][-p][time_max]\");\n@@ -158,0 +239,1 @@\n+        System.err.println(\"    N        ::= test case\");\n@@ -297,1 +379,1 @@\n-    \/\/ Notify the resumer while holding the threadLock\n+    \/\/ Notify the resumer while holding the threadLock.\n@@ -370,1 +452,2 @@\n-                \/\/ - a threadLock enter in the resumer thread\n+                \/\/ - a blocked threadLock enter in the resumer thread while the\n+                \/\/   threadLock is held by the main thread.\n@@ -428,1 +511,1 @@\n-                waiter = new SuspendWithObjectMonitorWaitWorker(\"waiter\", 1);\n+                waiter = new SuspendWithObjectMonitorWaitWorker(\"waiter\", 100);\n@@ -452,4 +535,0 @@\n-            try {\n-                Thread.sleep(1000);\n-            } catch(Exception e) {}\n-\n@@ -467,0 +546,4 @@\n+                try {\n+                    Thread.sleep(200);\n+                } catch(Exception e) {}\n+\n@@ -491,1 +574,2 @@\n-                \/\/ - a threadLock enter in the resumer thread\n+                \/\/ - a blocked threadLock enter in the resumer thread while the\n+                \/\/   threadLock is held by the main thread.\n@@ -605,1 +689,1 @@\n-        \/\/ - tries to grab the threadLock (should not block!)\n+        \/\/ - tries to grab the threadLock (should not block with doWork1!)\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/SuspendWithObjectMonitorWait\/SuspendWithObjectMonitorWait.java","additions":101,"deletions":17,"binary":false,"changes":118,"status":"modified"}]}