{"files":[{"patch":"@@ -1869,1 +1869,1 @@\n-  bool was_notified = false;\n+  bool was_notified = true;\n@@ -1883,1 +1883,1 @@\n-        \/\/ Intentionally empty\n+        was_notified = false;\n@@ -1908,1 +1908,0 @@\n-    was_notified = true;\n@@ -1917,1 +1916,0 @@\n-\n@@ -1933,1 +1931,1 @@\n-    \/\/ post monitor waited event. Note that this is past-tense, we are done waiting.\n+    \/\/ Post monitor waited event. Note that this is past-tense, we are done waiting.\n@@ -1975,1 +1973,0 @@\n-      \/\/ Done waiting, post the corresponding event\n@@ -2056,0 +2053,3 @@\n+        \/\/ This is is now conditional as if the monitor_waited even\n+        \/\/ is allowed, then a thread, even virtual, should not be moved to\n+        \/\/ the entry_list, but rather unparked and let run. See the comment below.\n@@ -2064,0 +2064,3 @@\n+      \/\/ If the monitor_waited JVMTI event is not allowed, a thread is\n+      \/\/ transferred to the entry_list, and it will eventually be unparked\n+      \/\/ only when it is chosen to become a successor.\n@@ -2066,0 +2069,10 @@\n+      \/\/ However, if the monitor_waited event is allowed, then\n+      \/\/ a thread is unpraked immediately and let run. It is not\n+      \/\/ on the entry_list, and thus cannot become a successor.\n+      \/\/ Its state should be TS_RUN, as it is neither on wait_list\n+      \/\/ nor on the entry_list.\n+      \/\/ By not allowing a thread to become a successor we\n+      \/\/ avoid a problem of having a suspension point when posting\n+      \/\/ the monitor_waited JVMTI event, as suspending such a thread\n+      \/\/ is no harm.\n+\n@@ -2071,1 +2084,1 @@\n-      ParkEvent* Trigger;\n+      ParkEvent* evt;\n@@ -2079,1 +2092,1 @@\n-        Trigger = t->_ParkEvent;\n+        evt = t->_ParkEvent;\n@@ -2083,1 +2096,1 @@\n-        Trigger = ObjectMonitor::vthread_unparker_ParkEvent();\n+        evt = ObjectMonitor::vthread_unparker_ParkEvent();\n@@ -2088,1 +2101,1 @@\n-        Trigger->unpark();\n+        evt->unpark();\n@@ -2092,1 +2105,1 @@\n-        Trigger->unpark();\n+        evt->unpark();\n@@ -2094,1 +2107,0 @@\n-\n@@ -2279,0 +2291,4 @@\n+  \/\/ We check against the state, rather than if was_notified,\n+  \/\/ because, if monitor_waited JVMTI event is allowed, there can be a vthead which\n+  \/\/ is not on the entry_list, but has been notified in the sense that it has been\n+  \/\/ unparked directly in notify_internal(). Its state is then TS_RUN.\n","filename":"src\/hotspot\/share\/runtime\/objectMonitor.cpp","additions":28,"deletions":12,"binary":false,"changes":40,"status":"modified"},{"patch":"@@ -221,1 +221,1 @@\n-                test = new SuspendWithObjectMonitorWait1();\n+                test = new SuspendWithObjectMonitorWaitDefault();\n@@ -224,1 +224,1 @@\n-                test = new SuspendWithObjectMonitorWait2();\n+                test = new SuspendWithObjectMonitorWaitReentryPartFirst();\n@@ -227,1 +227,1 @@\n-                test = new SuspendWithObjectMonitorWait3();\n+                test = new SuspendWithObjectMonitorWaitReentryPartSecond();\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/SuspendWithObjectMonitorWait\/SuspendWithObjectMonitorWaitBase.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -30,2 +30,2 @@\n- * @compile SuspendWithObjectMonitorWait1.java\n- * @run main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait1 1\n+ * @compile SuspendWithObjectMonitorWaitDefault.java\n+ * @run main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWaitDefault 1\n@@ -37,1 +37,2 @@\n-\/\/ doWork1 algorithm:\n+\/\/ SuspendWithObjectMonitorWaitDefault algorithm:\n+\/\/\n@@ -61,1 +62,1 @@\n-public class SuspendWithObjectMonitorWait1 extends SuspendWithObjectMonitorWaitBase {\n+public class SuspendWithObjectMonitorWaitDefault extends SuspendWithObjectMonitorWaitBase {\n@@ -71,1 +72,1 @@\n-        SuspendWithObjectMonitorWaitWorker resumer;    \/\/ resumer thread\n+        SuspendWithObjectMonitorWaitWorker resumer;   \/\/ resumer thread\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/SuspendWithObjectMonitorWait\/SuspendWithObjectMonitorWaitDefault.java","additions":6,"deletions":5,"binary":false,"changes":11,"previous_filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/SuspendWithObjectMonitorWait\/SuspendWithObjectMonitorWait1.java","status":"renamed"},{"patch":"@@ -30,2 +30,2 @@\n- * @compile SuspendWithObjectMonitorWait2.java\n- * @run main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait2 2\n+ * @compile SuspendWithObjectMonitorWaitReentryPartFirst.java\n+ * @run main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWaitReentryPartFirst 2\n@@ -37,1 +37,1 @@\n-\/\/ doWork2 algorithm:\n+\/\/ SuspendWithObjectMonitorWaitReentryPartFirst algorithm:\n@@ -64,1 +64,1 @@\n-\/\/       \"enter threadLock\" and block. This difference from doWork1\n+\/\/       \"enter threadLock\" and block. This difference from the default scenario\n@@ -70,1 +70,1 @@\n-public class SuspendWithObjectMonitorWait2 extends SuspendWithObjectMonitorWaitBase {\n+public class SuspendWithObjectMonitorWaitReentryPartFirst extends SuspendWithObjectMonitorWaitBase {\n@@ -80,1 +80,1 @@\n-        SuspendWithObjectMonitorWaitWorker resumer;    \/\/ resumer thread\n+        SuspendWithObjectMonitorWaitWorker resumer;   \/\/ resumer thread\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/SuspendWithObjectMonitorWait\/SuspendWithObjectMonitorWaitReentryPartFirst.java","additions":6,"deletions":6,"binary":false,"changes":12,"previous_filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/SuspendWithObjectMonitorWait\/SuspendWithObjectMonitorWait2.java","status":"renamed"},{"patch":"@@ -30,2 +30,2 @@\n- * @compile SuspendWithObjectMonitorWait3.java\n- * @run main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait3 3\n+ * @compile SuspendWithObjectMonitorWaitReentryPartSecond.java\n+ * @run main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWaitReentryPartSecond 3\n@@ -37,1 +37,1 @@\n-\/\/ doWork3 algorithm:\n+\/\/ SuspendWithObjectMonitorWaitReentryPartSecond algorithm:\n@@ -66,1 +66,1 @@\n-\/\/       \"enter threadLock\" and block. This difference from doWork1\n+\/\/       \"enter threadLock\" and block. This difference from the default scenario\n@@ -76,1 +76,1 @@\n-public class SuspendWithObjectMonitorWait3 extends SuspendWithObjectMonitorWaitBase {\n+public class SuspendWithObjectMonitorWaitReentryPartSecond extends SuspendWithObjectMonitorWaitBase {\n@@ -86,1 +86,1 @@\n-        SuspendWithObjectMonitorWaitWorker resumer;    \/\/ resumer thread\n+        SuspendWithObjectMonitorWaitWorker resumer;   \/\/ resumer thread\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/SuspendWithObjectMonitorWait\/SuspendWithObjectMonitorWaitReentryPartSecond.java","additions":6,"deletions":6,"binary":false,"changes":12,"previous_filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/SuspendWithObjectMonitorWait\/SuspendWithObjectMonitorWait3.java","status":"renamed"}]}