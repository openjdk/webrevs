{"files":[{"patch":"@@ -54,0 +54,16 @@\n+\/*\n+ * @test\n+ * @summary Test options parser test cases\n+ * @requires vm.jvmti\n+ * @library \/test\/lib\n+ * @compile SuspendWithObjectMonitorWait.java\n+ * @comment main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait\n+ * @comment main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait -p\n+ * @comment main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait 1 -p 5 junk\n+ * @comment main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait junk\n+ * @comment main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait 1 junk\n+ * @comment main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait -p 1 junk\n+ * @comment main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait 1 -p junk\n+ * @comment main\/othervm\/native -agentlib:SuspendWithObjectMonitorWait SuspendWithObjectMonitorWait 1 junk -p\n+ *\/\n+\n@@ -124,1 +140,1 @@\n-\/\/ delay 1-second         threadLock.wait(1)    wait for notify\n+\/\/ :                    threadLock.wait(1)      wait for notify\n@@ -128,1 +144,1 @@\n-\/\/ :                    reenter blocks          :\n+\/\/ : delay 200ms        reenter blocks          :\n@@ -150,4 +166,3 @@\n-\/\/ Note: The first sleep(1-second) in main and the wait(1) in the waiter\n-\/\/       thread allows the waiter thread to loop tightly here:\n-\/\/         while !READY_TO_NOTIFY\n-\/\/           threadLock.wait(1)\n+\/\/ Note: sleep(200ms) here while holding the threadLock to allow the\n+\/\/       waiter thread's timed wait to finish before we attempt to\n+\/\/       suspend the waiter thread.\n@@ -187,1 +202,6 @@\n-            System.err.println(\"Invalid number of arguments, there should be at least a test case given.\");\n+            System.err.println(\"Invalid number of arguments, there should be at least a test_case given.\");\n+            usage();\n+        }\n+\n+        if (args.length > 3) {\n+            System.err.println(\"Invalid number of arguments, there are too many arguments.\");\n@@ -191,1 +211,0 @@\n-        int test = Integer.parseUnsignedInt(args[0]);\n@@ -201,0 +220,1 @@\n+        int testCase = 0;\n@@ -202,5 +222,1 @@\n-        if (args.length == 1) {\n-            timeMax = DEF_TIME_MAX;\n-        } else {\n-            int argIndex = 1;\n-            int argsLeft = args.length-argIndex;\n+        for (int argIndex = 0; argIndex < args.length; argIndex++) {\n@@ -208,0 +224,1 @@\n+                \/\/ Handle optional -p arg regardless of position.\n@@ -209,2 +226,1 @@\n-                argIndex = 2;\n-                argsLeft--;\n+                continue;\n@@ -212,3 +228,19 @@\n-            if (argsLeft == 0) {\n-                timeMax = DEF_TIME_MAX;\n-            } else if (argsLeft == 1) {\n+\n+            if (testCase == 0) {\n+                try {\n+                    \/\/ testCase must be the first non-optional arg.\n+                    testCase = Integer.parseUnsignedInt(args[argIndex]);\n+                } catch (NumberFormatException nfe) {\n+                    System.err.println(\"'\" + args[argIndex] +\n+                            \"': invalid test_case value.\");\n+                    usage();\n+                }\n+                if (testCase < 1 || testCase > 3) {\n+                    System.err.println(\"Invalid test_case value: '\" + testCase + \"'\");\n+                    usage();\n+                }\n+                continue;\n+            }\n+\n+            if (argIndex < args.length) {\n+                \/\/ timeMax is an optional arg.\n@@ -219,1 +251,1 @@\n-                                       \"': invalid timeMax value.\");\n+                            \"': invalid time_max value.\");\n@@ -223,1 +255,1 @@\n-                usage();\n+                timeMax = DEF_TIME_MAX;\n@@ -227,1 +259,7 @@\n-        System.exit(run(timeMax, System.out, test) + exit_delta);\n+        if (testCase == 0) {\n+            \/\/ Just -p was given.\n+            System.err.println(\"Invalid number of arguments, no test_case given.\");\n+            usage();\n+        }\n+\n+        System.exit(run(timeMax, System.out, testCase) + exit_delta);\n@@ -237,1 +275,1 @@\n-        System.err.println(\"Usage: \" + AGENT_LIB + \" [N][-p][time_max]\");\n+        System.err.println(\"Usage: \" + AGENT_LIB + \" test_case [-p] [time_max]\");\n@@ -239,5 +277,5 @@\n-        System.err.println(\"    N        ::= test case\");\n-        System.err.println(\"    -p       ::= print debug info\");\n-        System.err.println(\"    time_max ::= max looping time in seconds\");\n-        System.err.println(\"                 (default is \" + DEF_TIME_MAX +\n-                           \" seconds)\");\n+        System.err.println(\"    test_case ::= 1 | 2 | 3\");\n+        System.err.println(\"    -p        ::= print debug info\");\n+        System.err.println(\"    time_max  ::= max looping time in seconds\");\n+        System.err.println(\"                  (default is \" + DEF_TIME_MAX +\n+                \" seconds)\");\n@@ -247,2 +285,2 @@\n-    public static int run(int timeMax, PrintStream out, int test) {\n-        switch (test) {\n+    public static int run(int timeMax, PrintStream out, int testCase) {\n+        switch (testCase) {\n@@ -252,1 +290,1 @@\n-            default: throw new RuntimeException(\"Unknown test\");\n+            default: throw new RuntimeException(\"Unknown test_case: \" + testCase);\n@@ -470,0 +508,2 @@\n+                    \/\/ Delay for 1-second while holding the threadLock to force the\n+                    \/\/ resumer thread to block on entering the threadLock.\n@@ -548,1 +588,1 @@\n-                } catch(Exception e) {}\n+                } catch (Exception e) {}\n@@ -592,0 +632,2 @@\n+                    \/\/ Delay for 1-second while holding the threadLock to force the\n+                    \/\/ resumer thread to block on entering the threadLock.\n@@ -593,1 +635,1 @@\n-                } catch(Exception e) {}\n+                } catch (Exception e) {}\n","filename":"test\/hotspot\/jtreg\/serviceability\/jvmti\/SuspendWithObjectMonitorWait\/SuspendWithObjectMonitorWait.java","additions":74,"deletions":32,"binary":false,"changes":106,"status":"modified"}]}