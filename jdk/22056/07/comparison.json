{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -33,0 +33,1 @@\n+import java.util.stream.Stream;\n@@ -34,1 +35,0 @@\n-import com.sun.tools.javac.code.Symbol.*;\n@@ -36,0 +36,2 @@\n+import com.sun.tools.javac.tree.JCTree.*;\n+import com.sun.tools.javac.util.Assert;\n@@ -39,1 +41,0 @@\n-import com.sun.tools.javac.util.List;\n@@ -41,0 +42,1 @@\n+import com.sun.tools.javac.util.Names;\n@@ -42,1 +44,0 @@\n-import com.sun.tools.javac.util.Pair;\n@@ -52,2 +53,2 @@\n-public class Lint\n-{\n+public class Lint {\n+\n@@ -66,2 +67,9 @@\n-     * Returns the result of combining the values in this object with\n-     * the given annotation.\n+     * Obtain an instance with additional warning supression applied from any\n+     * @SuppressWarnings and\/or @Deprecated annotations on the given symbol.\n+     *\n+     * <p>\n+     * The returned instance will be different from this instance if and only if\n+     * {@link #suppressionsFrom} returns a non-empty set.\n+     *\n+     * @param sym symbol\n+     * @return lint instance with new warning suppressions applied, or this instance if none\n@@ -69,2 +77,9 @@\n-    public Lint augment(Attribute.Compound attr) {\n-        return augmentor.augment(this, attr);\n+    public Lint augment(Symbol sym) {\n+        EnumSet<LintCategory> suppressions = suppressionsFrom(sym);\n+        if (!suppressions.isEmpty()) {\n+            Lint lint = new Lint(this);\n+            lint.values.removeAll(suppressions);\n+            lint.suppressedValues.addAll(suppressions);\n+            return lint;\n+        }\n+        return this;\n@@ -73,1 +88,0 @@\n-\n@@ -75,2 +89,2 @@\n-     * Returns the result of combining the values in this object with\n-     * the metadata on the given symbol.\n+     * Returns a new Lint that has the given LintCategorys enabled.\n+     * @param lc one or more categories to be enabled\n@@ -78,8 +92,4 @@\n-    public Lint augment(Symbol sym) {\n-        Lint l = augmentor.augment(this, sym.getDeclarationAttributes());\n-        if (sym.isDeprecated() && sym.isDeprecatableViaAnnotation()) {\n-            if (l == this)\n-                l = new Lint(this);\n-            l.values.remove(LintCategory.DEPRECATION);\n-            l.suppressedValues.add(LintCategory.DEPRECATION);\n-        }\n+    public Lint enable(LintCategory... lc) {\n+        Lint l = new Lint(this);\n+        l.values.addAll(Arrays.asList(lc));\n+        l.suppressedValues.removeAll(Arrays.asList(lc));\n@@ -100,1 +110,5 @@\n-    private final AugmentVisitor augmentor;\n+    private final Context context;\n+\n+    \/\/ These are initialized lazily to avoid dependency loops\n+    private Symtab syms;\n+    private Names names;\n@@ -102,0 +116,1 @@\n+    \/\/ Invariant: it's never the case that a category is in both \"values\" and \"suppressedValues\"\n@@ -117,1 +132,1 @@\n-            values = EnumSet.noneOf(LintCategory.class);\n+            values = LintCategory.newEmptySet();\n@@ -120,1 +135,1 @@\n-            values = EnumSet.noneOf(LintCategory.class);\n+            values = LintCategory.newEmptySet();\n@@ -149,1 +164,1 @@\n-        suppressedValues = EnumSet.noneOf(LintCategory.class);\n+        suppressedValues = LintCategory.newEmptySet();\n@@ -151,0 +166,1 @@\n+        this.context = context;\n@@ -152,1 +168,0 @@\n-        augmentor = new AugmentVisitor(context);\n@@ -156,1 +171,3 @@\n-        this.augmentor = other.augmentor;\n+        this.context = other.context;\n+        this.syms = other.syms;\n+        this.names = other.names;\n@@ -163,1 +180,1 @@\n-        return \"Lint:[values\" + values + \" suppressedValues\" + suppressedValues + \"]\";\n+        return \"Lint:[enable\" + values + \",suppress\" + suppressedValues + \"]\";\n@@ -376,0 +393,5 @@\n+        public static EnumSet<LintCategory> newEmptySet() {\n+            return EnumSet.noneOf(LintCategory.class);\n+        }\n+\n+        \/** Get the string representing this category in @SuppressAnnotations and -Xlint options. *\/\n@@ -407,63 +429,16 @@\n-    protected static class AugmentVisitor implements Attribute.Visitor {\n-        private final Context context;\n-        private Symtab syms;\n-        private Lint parent;\n-        private Lint lint;\n-\n-        AugmentVisitor(Context context) {\n-            \/\/ to break an ugly sequence of initialization dependencies,\n-            \/\/ we defer the initialization of syms until it is needed\n-            this.context = context;\n-        }\n-\n-        Lint augment(Lint parent, Attribute.Compound attr) {\n-            initSyms();\n-            this.parent = parent;\n-            lint = null;\n-            attr.accept(this);\n-            return (lint == null ? parent : lint);\n-        }\n-\n-        Lint augment(Lint parent, List<Attribute.Compound> attrs) {\n-            initSyms();\n-            this.parent = parent;\n-            lint = null;\n-            for (Attribute.Compound a: attrs) {\n-                a.accept(this);\n-            }\n-            return (lint == null ? parent : lint);\n-        }\n-\n-        private void initSyms() {\n-            if (syms == null)\n-                syms = Symtab.instance(context);\n-        }\n-\n-        private void suppress(LintCategory lc) {\n-            if (lint == null)\n-                lint = new Lint(parent);\n-            lint.suppressedValues.add(lc);\n-            lint.values.remove(lc);\n-        }\n-\n-        public void visitConstant(Attribute.Constant value) {\n-            if (value.type.tsym == syms.stringType.tsym) {\n-                LintCategory.get((String)value.value)\n-                  .ifPresent(this::suppress);\n-            }\n-        }\n-\n-        public void visitClass(Attribute.Class clazz) {\n-        }\n-\n-        \/\/ If we find a @SuppressWarnings annotation, then we continue\n-        \/\/ walking the tree, in order to suppress the individual warnings\n-        \/\/ specified in the @SuppressWarnings annotation.\n-        public void visitCompound(Attribute.Compound compound) {\n-            if (compound.type.tsym == syms.suppressWarningsType.tsym) {\n-                for (List<Pair<MethodSymbol,Attribute>> v = compound.values;\n-                     v.nonEmpty(); v = v.tail) {\n-                    Pair<MethodSymbol,Attribute> value = v.head;\n-                    if (value.fst.name.toString().equals(\"value\"))\n-                        value.snd.accept(this);\n-                }\n+    \/**\n+     * Obtain the set of recognized lint warning categories suppressed at the given symbol's declaration.\n+     *\n+     * <p>\n+     * This set can be non-empty only if the symbol is annotated with either\n+     * @SuppressWarnings or @Deprecated.\n+     *\n+     * @param symbol symbol corresponding to a possibly-annotated declaration\n+     * @return new warning suppressions applied to sym\n+     *\/\n+    public EnumSet<LintCategory> suppressionsFrom(Symbol symbol) {\n+        EnumSet<LintCategory> suppressions = suppressionsFrom(symbol.getDeclarationAttributes().stream());\n+        if (symbol.isDeprecated() && symbol.isDeprecatableViaAnnotation())\n+            suppressions.add(LintCategory.DEPRECATION);\n+        return suppressions;\n+    }\n@@ -471,2 +446,13 @@\n-            }\n-        }\n+    \/**\n+     * Retrieve the recognized lint categories suppressed by the given @SuppressWarnings annotation.\n+     *\n+     * @param annotation @SuppressWarnings annotation, or null\n+     * @return set of lint categories, possibly empty but never null\n+     *\/\n+    private EnumSet<LintCategory> suppressionsFrom(JCAnnotation annotation) {\n+        initializeIfNeeded();\n+        if (annotation == null)\n+            return LintCategory.newEmptySet();\n+        Assert.check(annotation.attribute.type.tsym == syms.suppressWarningsType.tsym);\n+        return suppressionsFrom(Stream.of(annotation).map(anno -> anno.attribute));\n+    }\n@@ -474,4 +460,10 @@\n-        public void visitArray(Attribute.Array array) {\n-            for (Attribute value : array.values)\n-                value.accept(this);\n-        }\n+    \/\/ Find the @SuppressWarnings annotation in the given stream and extract the recognized suppressions\n+    private EnumSet<LintCategory> suppressionsFrom(Stream<Attribute.Compound> attributes) {\n+        initializeIfNeeded();\n+        EnumSet<LintCategory> result = LintCategory.newEmptySet();\n+        attributes\n+          .filter(attribute -> attribute.type.tsym == syms.suppressWarningsType.tsym)\n+          .map(this::suppressionsFrom)\n+          .forEach(result::addAll);\n+        return result;\n+    }\n@@ -479,1 +471,8 @@\n-        public void visitEnum(Attribute.Enum e) {\n+    \/\/ Given a @SuppressWarnings annotation, extract the recognized suppressions\n+    private EnumSet<LintCategory> suppressionsFrom(Attribute.Compound suppressWarnings) {\n+        EnumSet<LintCategory> result = LintCategory.newEmptySet();\n+        Attribute.Array values = (Attribute.Array)suppressWarnings.member(names.value);\n+        for (Attribute value : values.values) {\n+            Optional.of((String)((Attribute.Constant)value).value)\n+              .flatMap(LintCategory::get)\n+              .ifPresent(result::add);\n@@ -481,0 +480,2 @@\n+        return result;\n+    }\n@@ -482,1 +483,4 @@\n-        public void visitError(Attribute.Error e) {\n+    private void initializeIfNeeded() {\n+        if (syms == null) {\n+            syms = Symtab.instance(context);\n+            names = Names.instance(context);\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/code\/Lint.java","additions":103,"deletions":99,"binary":false,"changes":202,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -2948,0 +2948,1 @@\n+    \/\/ Apply special flag \"-XDwarnOnAccessToMembers\" which turns on just this particular warning for all types of access\n@@ -2949,4 +2950,11 @@\n-        if (warnOnAnyAccessToMembers ||\n-            (lint.isEnabled(LintCategory.SERIAL) &&\n-            !lint.isSuppressed(LintCategory.SERIAL) &&\n-            isLambda)) {\n+        final Lint prevLint = setLint(warnOnAnyAccessToMembers ? lint.enable(LintCategory.SERIAL) : lint);\n+        try {\n+            if (warnOnAnyAccessToMembers || isLambda)\n+                checkAccessFromSerializableElementInner(tree, isLambda);\n+        } finally {\n+            setLint(prevLint);\n+        }\n+    }\n+\n+    private void checkAccessFromSerializableElementInner(final JCTree tree, boolean isLambda) {\n+        if (lint.isEnabled(LintCategory.SERIAL)) {\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/comp\/Check.java","additions":13,"deletions":5,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2009, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2009, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -56,0 +56,1 @@\n+import com.sun.tools.javac.code.Lint.LintCategory;\n@@ -93,1 +94,2 @@\n-        boolean warn = options.isLintSet(\"path\");\n+        boolean warn = options.isLintSet(LintCategory.PATH.option);\n+        boolean fileClashOption = options.isLintSet(LintCategory.OUTPUT_FILE_CLASH.option);\n@@ -95,0 +97,2 @@\n+\n+        \/\/ Only track file clashes if enabled\n@@ -96,1 +100,1 @@\n-            outputFilesWritten = options.isLintSet(\"output-file-clash\") ? new HashSet<>() : null;\n+            outputFilesWritten = fileClashOption ? new HashSet<>() : null;\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/file\/BaseFileManager.java","additions":7,"deletions":3,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1999, 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1999, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -222,1 +222,1 @@\n-     * Report an error at the given position using the provided arguments.\n+     * Report a warning at the given position using the provided arguments.\n@@ -227,1 +227,1 @@\n-    protected void lexWarning(int pos, JCDiagnostic.Warning key) {\n+    protected void lexWarning(int pos, JCDiagnostic.LintWarning key) {\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/parser\/JavaTokenizer.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2010, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2025, Oracle and\/or its affiliates. All rights reserved.\n@@ -45,2 +45,2 @@\n-    private EnumSet<LintCategory> nonSilentLintSet = EnumSet.noneOf(LintCategory.class);\n-    private EnumSet<LintCategory> silentLintSet = EnumSet.noneOf(LintCategory.class);\n+    private EnumSet<LintCategory> nonSilentLintSet = LintCategory.newEmptySet();\n+    private EnumSet<LintCategory> silentLintSet = LintCategory.newEmptySet();\n","filename":"src\/jdk.compiler\/share\/classes\/com\/sun\/tools\/javac\/util\/Warner.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"}]}