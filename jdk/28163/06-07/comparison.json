{"files":[{"patch":"@@ -36,0 +36,1 @@\n+import java.util.function.Supplier;\n@@ -68,1 +69,0 @@\n-        Objects.requireNonNull(withId);\n@@ -70,0 +70,6 @@\n+        return copyWithDefaultValue(withId, () -> value);\n+    }\n+\n+    default Options copyWithDefaultValue(WithOptionIdentifier withId, Supplier<Object> valueSupplier) {\n+        Objects.requireNonNull(withId);\n+        Objects.requireNonNull(valueSupplier);\n@@ -73,1 +79,1 @@\n-            return copyWithParent(of(Map.of(withId, value)));\n+            return copyWithParent(of(Map.of(withId, valueSupplier.get())));\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/Options.java","additions":8,"deletions":2,"binary":false,"changes":10,"status":"modified"},{"patch":"@@ -286,1 +286,1 @@\n-                optionSpecFormatter.format(\"@<filename>\", Optional.empty(), I18N.getString(\"main.option.argument-file\"), sink);\n+                optionSpecFormatter.format(\"@<filename>\", Optional.empty(), I18N.getString(\"help.option.argument-file\"), sink);\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/StandardHelpFormatter.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -116,1 +116,1 @@\n-            .description(\"main.option.type\" + resourceKeySuffix(OperatingSystem.current()))\n+            .description(\"help.option.type\" + resourceKeySuffix(OperatingSystem.current()))\n@@ -118,1 +118,1 @@\n-                b.description(\"main.option.type\" + resourceKeySuffix(context.os()));\n+                b.description(\"help.option.type\" + resourceKeySuffix(context.os()));\n@@ -169,1 +169,1 @@\n-                        return StandardValidator.IS_EXISTENT_NOT_DIRECTORY.test(path);\n+                        return StandardValidator.IS_FILE_OR_SYMLINK.test(path);\n@@ -203,1 +203,1 @@\n-                    b.description(\"main.option.app-content\" + resourceKeySuffix(context.os()));\n+                    b.description(\"help.option.app-content\" + resourceKeySuffix(context.os()));\n@@ -232,1 +232,1 @@\n-                    b.description(\"main.option.install-dir\" + resourceKeySuffix(context.os()));\n+                    b.description(\"help.option.install-dir\" + resourceKeySuffix(context.os()));\n@@ -243,1 +243,1 @@\n-                    b.description(\"main.option.app-image\" + resourceKeySuffix(context.os()));\n+                    b.description(\"help.option.app-image\" + resourceKeySuffix(context.os()));\n@@ -254,1 +254,1 @@\n-            .description(\"main.option.installer-runtime-image\")\n+            .description(\"help.option.installer-runtime-image\")\n@@ -279,1 +279,1 @@\n-                    b.description(\"main.option.module-path\" + resourceKeySuffix(context.os()));\n+                    b.description(\"help.option.module-path\" + resourceKeySuffix(context.os()));\n@@ -506,1 +506,1 @@\n-            .validator(StandardValidator.IS_EXISTENT_NOT_DIRECTORY)\n+            .validator(StandardValidator.IS_FILE_OR_SYMLINK)\n@@ -551,1 +551,1 @@\n-                .description(\"main.option.\" + name)\n+                .description(\"help.option.\" + name)\n@@ -631,1 +631,1 @@\n-                .description(\"main.option.add-launcher\" + resourceKeySuffix(OperatingSystem.current()))\n+                .description(\"help.option.add-launcher\" + resourceKeySuffix(OperatingSystem.current()))\n@@ -633,1 +633,1 @@\n-                    b.description(\"main.option.add-launcher\" + resourceKeySuffix(context.os()));\n+                    b.description(\"help.option.add-launcher\" + resourceKeySuffix(context.os()));\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/StandardOption.java","additions":12,"deletions":12,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -40,0 +40,1 @@\n+import jdk.jpackage.internal.util.FileUtils;\n@@ -48,2 +49,12 @@\n-    public static final Predicate<Path> IS_EXISTENT_NOT_DIRECTORY = path -> {\n-        return Files.exists(path) && !Files.isDirectory(path);\n+    public static final Predicate<Path> IS_FILE_OR_SYMLINK = path -> {\n+        if (Files.isRegularFile(path)) {\n+            return true;\n+        } else if (Files.isSymbolicLink(path)) {\n+            try {\n+                return Files.isRegularFile(FileUtils.readSymlinkTargetRecursive(path));\n+            } catch (IOException ex) {\n+                return false;\n+            }\n+        } else {\n+            return false;\n+        }\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/StandardValidator.java","additions":13,"deletions":2,"binary":false,"changes":15,"status":"modified"},{"patch":"@@ -76,1 +76,1 @@\n-main.option.argument-file=\\\n+help.option.argument-file=\\\n@@ -80,1 +80,1 @@\n-main.option.about-url=\\\n+help.option.about-url=\\\n@@ -83,1 +83,1 @@\n-main.option.add-launcher.win=\\\n+help.option.add-launcher.win=\\\n@@ -97,1 +97,1 @@\n-main.option.add-launcher.linux=\\\n+help.option.add-launcher.linux=\\\n@@ -111,1 +111,1 @@\n-main.option.add-launcher.mac=\\\n+help.option.add-launcher.mac=\\\n@@ -125,1 +125,1 @@\n-main.option.add-modules=\\\n+help.option.add-modules=\\\n@@ -134,1 +134,1 @@\n-main.option.app-content=\\\n+help.option.app-content=\\\n@@ -139,1 +139,1 @@\n-main.option.app-content.mac=\\\n+help.option.app-content.mac=\\\n@@ -149,1 +149,1 @@\n-main.option.app-image=\\\n+help.option.app-image=\\\n@@ -154,1 +154,1 @@\n-main.option.app-image.mac=\\\n+help.option.app-image.mac=\\\n@@ -160,1 +160,1 @@\n-main.option.app-version=\\\n+help.option.app-version=\\\n@@ -163,1 +163,1 @@\n-main.option.arguments=\\\n+help.option.arguments=\\\n@@ -168,1 +168,1 @@\n-main.option.copyright=\\\n+help.option.copyright=\\\n@@ -171,1 +171,1 @@\n-main.option.description=\\\n+help.option.description=\\\n@@ -174,1 +174,1 @@\n-main.option.dest=\\\n+help.option.dest=\\\n@@ -179,1 +179,1 @@\n-main.option.file-associations=\\\n+help.option.file-associations=\\\n@@ -186,1 +186,1 @@\n-main.option.help=\\\n+help.option.help=\\\n@@ -190,1 +190,1 @@\n-main.option.icon=\\\n+help.option.icon=\\\n@@ -194,1 +194,1 @@\n-main.option.input=\\\n+help.option.input=\\\n@@ -200,1 +200,1 @@\n-main.option.install-dir=\\\n+help.option.install-dir=\\\n@@ -203,1 +203,1 @@\n-main.option.install-dir.win=\\\n+help.option.install-dir.win=\\\n@@ -207,1 +207,1 @@\n-main.option.installer-runtime-image=\\\n+help.option.installer-runtime-image=\\\n@@ -212,1 +212,1 @@\n-main.option.java-options=\\\n+help.option.java-options=\\\n@@ -216,1 +216,1 @@\n-main.option.jlink-options=\\\n+help.option.jlink-options=\\\n@@ -222,1 +222,1 @@\n-main.option.launcher-as-service=\\\n+help.option.launcher-as-service=\\\n@@ -226,1 +226,1 @@\n-main.option.license-file=\\\n+help.option.license-file=\\\n@@ -230,1 +230,1 @@\n-main.option.linux-app-category=\\\n+help.option.linux-app-category=\\\n@@ -234,1 +234,1 @@\n-main.option.linux-app-release=\\\n+help.option.linux-app-release=\\\n@@ -238,1 +238,1 @@\n-main.option.linux-deb-maintainer=\\\n+help.option.linux-deb-maintainer=\\\n@@ -241,1 +241,1 @@\n-main.option.linux-menu-group=\\\n+help.option.linux-menu-group=\\\n@@ -244,1 +244,1 @@\n-main.option.linux-package-deps=\\\n+help.option.linux-package-deps=\\\n@@ -247,1 +247,1 @@\n-main.option.linux-package-name=\\\n+help.option.linux-package-name=\\\n@@ -250,1 +250,1 @@\n-main.option.linux-rpm-license-type=\\\n+help.option.linux-rpm-license-type=\\\n@@ -253,1 +253,1 @@\n-main.option.linux-shortcut=\\\n+help.option.linux-shortcut=\\\n@@ -256,1 +256,1 @@\n-main.option.mac-app-category=\\\n+help.option.mac-app-category=\\\n@@ -260,1 +260,1 @@\n-main.option.mac-app-image-sign-identity=\\\n+help.option.mac-app-image-sign-identity=\\\n@@ -265,1 +265,1 @@\n-main.option.mac-app-store=\\\n+help.option.mac-app-store=\\\n@@ -269,1 +269,1 @@\n-main.option.mac-dmg-content=\\\n+help.option.mac-dmg-content=\\\n@@ -273,1 +273,1 @@\n-main.option.mac-entitlements=\\\n+help.option.mac-entitlements=\\\n@@ -277,1 +277,1 @@\n-main.option.mac-installer-sign-identity=\\\n+help.option.mac-installer-sign-identity=\\\n@@ -282,1 +282,1 @@\n-main.option.mac-package-identifier=\\\n+help.option.mac-package-identifier=\\\n@@ -288,1 +288,1 @@\n-main.option.mac-package-name=\\\n+help.option.mac-package-name=\\\n@@ -295,1 +295,1 @@\n-main.option.mac-package-signing-prefix=\\\n+help.option.mac-package-signing-prefix=\\\n@@ -300,1 +300,1 @@\n-main.option.mac-sign=\\\n+help.option.mac-sign=\\\n@@ -304,1 +304,1 @@\n-main.option.mac-signing-keychain=\\\n+help.option.mac-signing-keychain=\\\n@@ -308,1 +308,1 @@\n-main.option.mac-signing-key-user-name=\\\n+help.option.mac-signing-key-user-name=\\\n@@ -315,1 +315,1 @@\n-main.option.main-class=\\\n+help.option.main-class=\\\n@@ -319,1 +319,1 @@\n-main.option.main-jar=\\\n+help.option.main-jar=\\\n@@ -325,1 +325,1 @@\n-main.option.module=\\\n+help.option.module=\\\n@@ -332,1 +332,1 @@\n-main.option.module-path=\\\n+help.option.module-path=\\\n@@ -338,1 +338,1 @@\n-main.option.module-path.win=\\\n+help.option.module-path.win=\\\n@@ -345,1 +345,1 @@\n-main.option.name=\\\n+help.option.name=\\\n@@ -348,1 +348,1 @@\n-main.option.resource-dir=\\\n+help.option.resource-dir=\\\n@@ -354,1 +354,1 @@\n-main.option.runtime-image=\\\n+help.option.runtime-image=\\\n@@ -363,1 +363,1 @@\n-main.option.temp=\\\n+help.option.temp=\\\n@@ -371,1 +371,1 @@\n-main.option.type.win=\\\n+help.option.type.win=\\\n@@ -376,1 +376,1 @@\n-main.option.type.linux=\\\n+help.option.type.linux=\\\n@@ -381,1 +381,1 @@\n-main.option.type.mac=\\\n+help.option.type.mac=\\\n@@ -387,1 +387,1 @@\n-main.option.vendor=\\\n+help.option.vendor=\\\n@@ -390,1 +390,1 @@\n-main.option.verbose=\\\n+help.option.verbose=\\\n@@ -393,1 +393,1 @@\n-main.option.version=\\\n+help.option.version=\\\n@@ -396,1 +396,1 @@\n-main.option.win-console=\\\n+help.option.win-console=\\\n@@ -400,1 +400,1 @@\n-main.option.win-dir-chooser=\\\n+help.option.win-dir-chooser=\\\n@@ -404,1 +404,1 @@\n-main.option.win-help-url=\\\n+help.option.win-help-url=\\\n@@ -407,1 +407,1 @@\n-main.option.win-menu=\\\n+help.option.win-menu=\\\n@@ -410,1 +410,1 @@\n-main.option.win-menu-group=\\\n+help.option.win-menu-group=\\\n@@ -413,1 +413,1 @@\n-main.option.win-per-user-install=\\\n+help.option.win-per-user-install=\\\n@@ -416,1 +416,1 @@\n-main.option.win-shortcut=\\\n+help.option.win-shortcut=\\\n@@ -419,1 +419,1 @@\n-main.option.win-shortcut-prompt=\\\n+help.option.win-shortcut-prompt=\\\n@@ -423,1 +423,1 @@\n-main.option.win-update-url=\\\n+help.option.win-update-url=\\\n@@ -426,1 +426,1 @@\n-main.option.win-upgrade-uuid=\\\n+help.option.win-upgrade-uuid=\\\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/resources\/HelpResources.properties","additions":71,"deletions":71,"binary":false,"changes":142,"status":"modified"},{"patch":"@@ -31,0 +31,1 @@\n+import java.nio.file.NotLinkException;\n@@ -103,0 +104,13 @@\n+    public static Path readSymlinkTargetRecursive(Path symlink) throws IOException, NotLinkException {\n+        try {\n+            var target = Files.readSymbolicLink(symlink);\n+            if (Files.isSymbolicLink(target)) {\n+                return readSymlinkTargetRecursive(target);\n+            } else {\n+                return target;\n+            }\n+        } catch (NotLinkException ex) {\n+            throw ex;\n+        }\n+    }\n+\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/util\/FileUtils.java","additions":14,"deletions":0,"binary":false,"changes":14,"status":"modified"},{"patch":"@@ -25,0 +25,1 @@\n+import java.util.Collection;\n@@ -123,3 +124,2 @@\n-    public static final Set<PackageType> NATIVE = Stream.concat(\n-            Stream.concat(LINUX.stream(), WINDOWS.stream()),\n-            MAC.stream()).collect(Collectors.toUnmodifiableSet());\n+    public static final Set<PackageType> NATIVE = Stream.of(LINUX, WINDOWS, MAC)\n+            .flatMap(Collection::stream).collect(Collectors.toUnmodifiableSet());\n","filename":"test\/jdk\/tools\/jpackage\/helpers\/jdk\/jpackage\/test\/PackageType.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+import org.junit.jupiter.api.Assertions;\n@@ -39,0 +40,2 @@\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n@@ -111,2 +114,3 @@\n-    @Test\n-    public void test_copyWithDefaultValue() {\n+    @ParameterizedTest\n+    @ValueSource(booleans = {true, false})\n+    public void test_copyWithDefaultValue(boolean supplier) {\n@@ -122,1 +126,5 @@\n-        options = options.copyWithDefaultValue(barOV, 89);\n+        if (supplier) {\n+            options = options.copyWithDefaultValue(barOV, () -> 89);\n+        } else {\n+            options = options.copyWithDefaultValue(barOV, 89);\n+        }\n@@ -127,2 +135,3 @@\n-    @Test\n-    public void test_copyWithDefaultValue_nop() {\n+    @ParameterizedTest\n+    @ValueSource(booleans = {true, false})\n+    public void test_copyWithDefaultValue_nop(boolean supplier) {\n@@ -136,1 +145,8 @@\n-        options = options.copyWithDefaultValue(barOV, 75);\n+        if (supplier) {\n+            options = options.copyWithDefaultValue(barOV, () -> {\n+                Assertions.fail(\"Should not be called\");\n+                return null;\n+            });\n+        } else {\n+            options = options.copyWithDefaultValue(barOV, 75);\n+        }\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/cli\/OptionsTest.java","additions":22,"deletions":6,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -44,0 +44,2 @@\n+import org.junit.jupiter.api.condition.DisabledOnOs;\n+import org.junit.jupiter.api.condition.OS;\n@@ -70,1 +72,1 @@\n-    public void test_IS_EXISTENT_NOT_DIRECTORY(@TempDir Path tempDir) throws IOException {\n+    public void test_IS_FILE_OR_SYMLINK(@TempDir Path tempDir) throws IOException {\n@@ -72,1 +74,1 @@\n-        final var testee = StandardValidator.IS_EXISTENT_NOT_DIRECTORY;\n+        final var testee = StandardValidator.IS_FILE_OR_SYMLINK;\n@@ -86,0 +88,30 @@\n+    @Test\n+    @DisabledOnOs(OS.WINDOWS)\n+    public void test_IS_FILE_OR_SYMLINK_symlink_file(@TempDir Path tempDir) throws IOException {\n+\n+        final var file = tempDir.resolve(\"foo\");\n+        Files.writeString(file, \"foo\");\n+\n+        final var symlink = Files.createSymbolicLink(tempDir.resolve(\"foo-symlink\"), file);\n+\n+        assertTrue(StandardValidator.IS_FILE_OR_SYMLINK.test(symlink));\n+    }\n+\n+    @Test\n+    @DisabledOnOs(OS.WINDOWS)\n+    public void test_IS_FILE_OR_SYMLINK_symlink_dir(@TempDir Path tempDir) throws IOException {\n+\n+        final var symlink = Files.createSymbolicLink(tempDir.resolve(\"foo-symlink\"), tempDir);\n+\n+        assertFalse(StandardValidator.IS_FILE_OR_SYMLINK.test(symlink));\n+    }\n+\n+    @Test\n+    @DisabledOnOs(OS.WINDOWS)\n+    public void test_IS_FILE_OR_SYMLINK_symlink_invalid(@TempDir Path tempDir) throws IOException {\n+\n+        final var symlink = Files.createSymbolicLink(tempDir.resolve(\"foo-symlink\"), tempDir.resolve(\"foo\"));\n+\n+        assertFalse(StandardValidator.IS_FILE_OR_SYMLINK.test(symlink));\n+    }\n+\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/cli\/StandardValidatorTest.java","additions":34,"deletions":2,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -28,0 +28,1 @@\n+import java.nio.file.Path;\n@@ -41,0 +42,1 @@\n+import jdk.jpackage.test.HelloApp;\n@@ -43,0 +45,1 @@\n+import jdk.jpackage.test.JavaAppDesc;\n@@ -45,0 +48,1 @@\n+import jdk.jpackage.test.PackageType;\n@@ -61,0 +65,5 @@\n+\n+        \/\/ Create test jar only once.\n+        \/\/ Besides of saving time, this avoids asynchronous invocations of java tool provider that randomly fail.\n+        APP_JAR.set(HelloApp.createBundle(JavaAppDesc.parse(\"Hello!\"), TKit.workDir()));\n+\n@@ -112,1 +121,1 @@\n-            init(JPackageCommand.helloAppImage()).executeAndAssertHelloAppImageCreated();\n+            init(new JPackageCommand()).setPackageType(PackageType.IMAGE).executeAndAssertImageCreated();\n@@ -118,3 +127,1 @@\n-            new PackageTest().configureHelloApp().addInitializer(cmd -> {\n-                init(cmd);\n-            }).run(Action.CREATE_AND_UNPACK);\n+            new PackageTest().addInitializer(AsyncTest::init).run(Action.CREATE_AND_UNPACK);\n@@ -131,1 +138,5 @@\n-        return cmd.useToolProvider(true).setFakeRuntime().setArgumentValue(\"--name\", \"Foo\");\n+        return cmd.useToolProvider(true).setFakeRuntime()\n+                .setDefaultInputOutput()\n+                .setArgumentValue(\"--input\", APP_JAR.get().getParent())\n+                .setArgumentValue(\"--main-jar\", APP_JAR.get().getFileName())\n+                .setArgumentValue(\"--name\", \"Foo\");\n@@ -210,0 +221,1 @@\n+    private static final InheritableThreadLocal<Path> APP_JAR = new InheritableThreadLocal<>();\n","filename":"test\/jdk\/tools\/jpackage\/share\/AsyncTest.java","additions":17,"deletions":5,"binary":false,"changes":22,"status":"modified"}]}