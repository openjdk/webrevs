{"files":[{"patch":"@@ -42,0 +42,1 @@\n+import java.util.function.Consumer;\n@@ -48,0 +49,1 @@\n+import jdk.jpackage.internal.model.JPackageException;\n@@ -146,10 +148,4 @@\n-    static final class Runner {\n-\n-        int run(Supplier<? extends Collection<? extends Exception>> r) {\n-            final var exceptions = runIt(r);\n-            exceptions.forEach(this::reportError);\n-            if (exceptions.isEmpty()) {\n-                return 0;\n-            } else {\n-                return 1;\n-            }\n+    record ErrorReporter(Consumer<Throwable> stackTracePrinter, Consumer<String> messagePrinter) {\n+        ErrorReporter {\n+            Objects.requireNonNull(stackTracePrinter);\n+            Objects.requireNonNull(stackTracePrinter);\n@@ -158,1 +154,1 @@\n-        private void reportError(Throwable t) {\n+        void reportError(Throwable t) {\n@@ -166,1 +162,1 @@\n-                printError(t);\n+                printError(t, Optional.empty());\n@@ -170,2 +166,12 @@\n-        private void printError(Throwable t) {\n-            printError(t, Optional.empty());\n+        private void printError(Throwable t, Optional<String> advice) {\n+            stackTracePrinter.accept(t);\n+\n+            String msg;\n+            if (isAlienExceptionType(t)) {\n+                msg = t.toString();\n+            } else {\n+                msg = t.getMessage();\n+            }\n+\n+            messagePrinter.accept(I18N.format(\"message.error-header\", msg));\n+            advice.ifPresent(v -> messagePrinter.accept(I18N.format(\"message.advice-header\", v)));\n@@ -174,5 +180,30 @@\n-        private void printError(Throwable t, Optional<String> advice) {\n-            Log.verbose(t);\n-\/\/            Log.fatalError(I18N.format(\"message.error-header\", t.getMessage()));\n-            Log.fatalError(Optional.ofNullable(t.getMessage()).orElseGet(t::toString));\n-            advice.ifPresent(v -> Log.fatalError(I18N.format(\"message.advice-header\", v)));\n+        private static boolean isAlienExceptionType(Throwable t) {\n+            switch (t) {\n+                case JPackageException _ -> {\n+                    return false;\n+                }\n+                case Utils.ParseException _ -> {\n+                    return false;\n+                }\n+                case StandardOption.AddLauncherIllegalArgumentException _ -> {\n+                    return false;\n+                }\n+                default -> {\n+                    return true;\n+                }\n+            }\n+        }\n+    }\n+\n+\n+    static final class Runner {\n+\n+        int run(Supplier<? extends Collection<? extends Exception>> r) {\n+            final var exceptions = runIt(r);\n+            if (exceptions.isEmpty()) {\n+                return 0;\n+            } else {\n+                var errorReporter = new ErrorReporter(Log::verbose, Log::fatalError);\n+                exceptions.forEach(errorReporter::reportError);\n+                return 1;\n+            }\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/Main.java","additions":50,"deletions":19,"binary":false,"changes":69,"status":"modified"},{"patch":"@@ -664,1 +664,1 @@\n-                        throw new AddLauncherInvalidPropertyFile(I18N.format(\n+                        throw new AddLauncherInvalidPropertyFileException(I18N.format(\n@@ -690,1 +690,11 @@\n-    static final class AddLauncherInvalidNameException extends IllegalArgumentException {\n+    static class AddLauncherIllegalArgumentException extends IllegalArgumentException {\n+\n+        AddLauncherIllegalArgumentException(String message) {\n+            super(message);\n+        }\n+\n+        private static final long serialVersionUID = 1L;\n+    }\n+\n+\n+    static final class AddLauncherInvalidNameException extends AddLauncherIllegalArgumentException {\n@@ -700,1 +710,1 @@\n-    static final class AddLauncherInvalidPropertyFile extends IllegalArgumentException {\n+    static final class AddLauncherInvalidPropertyFileException extends AddLauncherIllegalArgumentException {\n@@ -702,1 +712,1 @@\n-        AddLauncherInvalidPropertyFile(String msg) {\n+        AddLauncherInvalidPropertyFileException(String msg) {\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/cli\/StandardOption.java","additions":14,"deletions":4,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -49,1 +49,1 @@\n-public class ConfigException extends RuntimeException {\n+public class ConfigException extends JPackageException {\n@@ -67,5 +67,0 @@\n-    public ConfigException(Throwable cause) {\n-        super(cause);\n-        this.advice = null;\n-    }\n-\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/ConfigException.java","additions":1,"deletions":6,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -31,1 +31,1 @@\n- * Generic jpackage exception.\n+ * Generic jpackage exception with non-null message.\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/model\/JPackageException.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -53,1 +53,1 @@\n-message.error-header=Error: {0}\n+message.error-header={0}\n","filename":"src\/jdk.jpackage\/share\/classes\/jdk\/jpackage\/internal\/resources\/MainResources.properties","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -146,1 +146,3 @@\n-                return expectErrorExitCode().expectStderr(msg);\n+                return expectErrorExitCode().expectStderr(Stream.of(msg).map(v -> {\n+                    return I18N.format(\"message.error-header\", v);\n+                }).toList());\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/cli\/MainTest.java","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -50,1 +50,1 @@\n-import jdk.jpackage.internal.cli.StandardOption.AddLauncherInvalidPropertyFile;\n+import jdk.jpackage.internal.cli.StandardOption.AddLauncherInvalidPropertyFileException;\n@@ -476,1 +476,1 @@\n-                    new AddLauncherInvalidPropertyFile(I18N.format(\"error.paramater-add-launcher-not-file\", nonExistentPropertyFile, \"b\")),\n+                    new AddLauncherInvalidPropertyFileException(I18N.format(\"error.paramater-add-launcher-not-file\", nonExistentPropertyFile, \"b\")),\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/cli\/OptionsProcessorTest.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -20,1 +20,0 @@\n-ErrorTest.test(NATIVE; app-desc=Hello; args-add=[--mac-app-store, --runtime-image, @@JAVA_HOME@@]; errors=[ERR_MacAppStoreRuntimeBinExists+[@@JAVA_HOME@@]])\n@@ -22,4 +21,0 @@\n-ErrorTest.test(NATIVE; app-desc=Hello; args-add=[--mac-installer-sign-identity, bar, --mac-signing-key-user-name, foo, --mac-sign]; errors=[ERR_MutuallyExclusiveOptions+[--mac-signing-key-user-name, --mac-installer-sign-identity]])\n-ErrorTest.test(NATIVE; app-desc=Hello; args-add=[--mac-installer-sign-identity, bar, --mac-signing-key-user-name, foo]; errors=[ERR_MutuallyExclusiveOptions+[--mac-signing-key-user-name, --mac-installer-sign-identity]])\n-ErrorTest.test(NATIVE; app-desc=Hello; args-add=[--mac-signing-key-user-name, foo, --mac-installer-sign-identity, bar, --mac-sign]; errors=[ERR_MutuallyExclusiveOptions+[--mac-signing-key-user-name, --mac-installer-sign-identity]])\n-ErrorTest.test(NATIVE; app-desc=Hello; args-add=[--mac-signing-key-user-name, foo, --mac-installer-sign-identity, bar]; errors=[ERR_MutuallyExclusiveOptions+[--mac-signing-key-user-name, --mac-installer-sign-identity]])\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/cli\/OptionsValidationFailTest.excludes","additions":0,"deletions":5,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -102,0 +102,5 @@\n+\n+                var errorReporter = new Main.ErrorReporter(ex -> {\n+                    ex.printStackTrace(err);\n+                }, out::append);\n+\n@@ -104,2 +109,1 @@\n-                    out.append(firstErr.getMessage());\n-                    firstErr.printStackTrace(err);\n+                    errorReporter.reportError(firstErr);\n@@ -112,4 +116,1 @@\n-                            errors.forEach(ex -> {\n-                                out.append(ex.getMessage());\n-                                ex.printStackTrace(err);\n-                            });\n+                            errors.forEach(errorReporter::reportError);\n","filename":"test\/jdk\/tools\/jpackage\/junit\/share\/jdk.jpackage\/jdk\/jpackage\/internal\/cli\/OptionsValidationFailTest.java","additions":7,"deletions":6,"binary":false,"changes":13,"status":"modified"}]}