{"files":[{"patch":"@@ -253,1 +253,1 @@\n-      assert(idx < _leak_context_edges->length(), \"invariant\");\n+      assert(idx < _leak_context_edges->length(), \"invariant idx: %d >= length: %d\", idx, _leak_context_edges->length());\n@@ -271,0 +271,2 @@\n+  const int upper_bits = sample_object->mark().value() >> markWord::lock_bits;\n+  assert((upper_bits | idx) == idx, \"idx codec error : (%d | %d) != %d\", upper_bits, idx, idx);\n","filename":"src\/hotspot\/share\/jfr\/leakprofiler\/chains\/edgeStore.cpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -37,3 +37,6 @@\n-  if (UseShenandoahGC) {\n-    \/\/ Leak Profiler uses mark words in the ways that might interfere\n-    \/\/ with concurrent GC uses of them. This affects Shenandoah.\n+  if (UseCompactObjectHeaders || UseShenandoahGC) {\n+    \/\/ 1. With a 32-bit mark word in Lilliput2, we don't have enough unused\n+    \/\/    bits to store edge index information in the mark word\n+    \/\/ 2. Even without compressed object headers, with Shenandoah, we don't\n+    \/\/    have enough free bits in the mark word because of needing that\n+    \/\/    space for forwarding pointers in the evacuation & update refs phase.\n","filename":"src\/hotspot\/share\/jfr\/leakprofiler\/leakProfiler.cpp","additions":6,"deletions":3,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -33,1 +33,2 @@\n-\/\/ The hash (preceding klass bits) shall be a direct neighbor but not interleave\n+\/\/ The hashctrl bits (preceding klass bits) shall be a direct neighbor but not interleave\n+\/\/ klass_shift=13, hashctrl_shift=11, hashctrl_bits=2, so 13 == 2 + 11\n","filename":"src\/hotspot\/share\/oops\/markWord.cpp","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -49,1 +49,3 @@\n-\/\/  klass:22  unused_gap:29 hash:2 -->| unused_gap:4  age:4  self-fwd:1  lock:2 (normal object)\n+\/\/  unused:32 klass:19 hashctrl:2 -->| unused_gap:4  age:4  self-fwd:1  lock:2 (normal object)\n+\/\/\n+\/\/  Note: klass occupies bits 13-31 (19 bits), hashctrl occupies bits 11-12 (2 bits)\n@@ -153,3 +155,15 @@\n-  \/\/ We store the (narrow) Klass* in the bits 43 to 64.\n-\n-  \/\/ These are for bit-precise extraction of the narrow Klass* from the 64-bit Markword\n+  \/\/ With UseCompactObjectHeaders: We store the (narrow) Klass* in bits 13-31 (19 bits total).\n+  \/\/ Without UseCompactObjectHeaders: Klass* is stored separately in object header, not in markword.\n+\n+  \/\/ These are for bit-precise extraction of the narrow Klass* from the markword (UseCompactObjectHeaders only)\n+  \/\/\n+  \/\/ Bit position summary for UseCompactObjectHeaders:\n+  \/\/ Bits  0- 1: lock (2 bits)\n+  \/\/ Bit   2   : self-fwd (1 bit)\n+  \/\/ Bits  3- 6: age (4 bits)\n+  \/\/ Bits  7-10: unused_gap (4 bits)\n+  \/\/ Bits 11-12: hashctrl (2 bits) - hash control state\n+  \/\/ Bits 13-31: klass (19 bits) - narrow klass pointer\n+  \/\/ Bits 32-63: unused (32 bits)\n+  \/\/\n+  \/\/ Without UseCompactObjectHeaders, klass is stored separately in object header\n","filename":"src\/hotspot\/share\/oops\/markWord.hpp","additions":18,"deletions":4,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -68,0 +68,1 @@\n+    private static final Boolean COMPACT_HEADERS = WhiteBox.getWhiteBox().getBooleanVMFlag(\"UseCompactObjectHeaders\");\n@@ -69,1 +70,1 @@\n-    private static final int BYTE_ARRAY_OVERHEAD = (Platform.is64bit() && !COMPRESSED_CLASS_PTRS) ? 24 : 16;\n+    private static final int BYTE_ARRAY_OVERHEAD = COMPACT_HEADERS ? 12 : ((Platform.is64bit() && !COMPRESSED_CLASS_PTRS) ? 24 : 16);\n","filename":"test\/jdk\/jdk\/jfr\/event\/allocation\/TestObjectAllocationInNewTLABEvent.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -68,0 +68,1 @@\n+    private static final Boolean COMPACT_HEADERS = WhiteBox.getWhiteBox().getBooleanVMFlag(\"UseCompactObjectHeaders\");\n@@ -69,1 +70,1 @@\n-    private static final int BYTE_ARRAY_OVERHEAD = (Platform.is64bit() && !COMPRESSED_CLASS_PTRS) ? 24 : 16;\n+    private static final int BYTE_ARRAY_OVERHEAD = COMPACT_HEADERS ? 12 : ((Platform.is64bit() && !COMPRESSED_CLASS_PTRS) ? 24 : 16);\n","filename":"test\/jdk\/jdk\/jfr\/event\/allocation\/TestObjectAllocationOutsideTLABEvent.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -56,0 +56,1 @@\n+    private static final Boolean COMPACT_HEADERS = WhiteBox.getWhiteBox().getBooleanVMFlag(\"UseCompactObjectHeaders\");\n@@ -57,1 +58,1 @@\n-    private static final int BYTE_ARRAY_OVERHEAD = (Platform.is64bit() && !COMPRESSED_CLASS_PTRS) ? 24 : 16;\n+    private static final int BYTE_ARRAY_OVERHEAD = COMPACT_HEADERS ? 12 : ((Platform.is64bit() && !COMPRESSED_CLASS_PTRS) ? 24 : 16);\n","filename":"test\/jdk\/jdk\/jfr\/event\/allocation\/TestObjectAllocationSampleEventThrottling.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestAllocationTime.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -41,0 +41,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestArrayInformation.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestCircularReference.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -43,1 +43,1 @@\n- * @requires vm.flagless\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestClassLoaderLeak.java","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -43,0 +43,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestFieldInformation.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+ * @requires vm.opt.final.UseCompactObjectHeaders == false\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestG1.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestHeapDeep.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestHeapShallow.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -48,0 +48,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestLargeRootSet.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -42,0 +42,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestLastKnownHeapUsage.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestListenerLeak.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -45,1 +45,0 @@\n- * @requires vm.hasJFR\n@@ -47,0 +46,2 @@\n+ * @requires vm.hasJFR\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestMetadataRetention.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -40,0 +40,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestObjectAge.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -43,0 +43,1 @@\n+ * @comment Marked as flagless until JDK-8344015 is fixed\n@@ -45,2 +46,1 @@\n- * @requires vm.flagless\n- * @comment Marked as flagless until JDK-8344015 is fixed\n+ * @requires vm.opt.final.UseCompactObjectHeaders == false\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestObjectDescription.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -43,0 +43,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestObjectSize.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -40,0 +40,1 @@\n+ * @requires vm.opt.final.UseCompactObjectHeaders == false\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestParallel.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -37,0 +37,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestReferenceChainLimit.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -38,0 +38,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestSanityDefault.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -40,0 +40,1 @@\n+ * @requires vm.opt.final.UseCompactObjectHeaders == false\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestSerial.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -39,0 +39,1 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestThreadLocalLeak.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -37,1 +37,0 @@\n- * @requires vm.hasJFR & vm.gc.Z\n@@ -39,0 +38,2 @@\n+ * @requires vm.hasJFR & vm.gc.Z\n+ * @requires vm.opt.final.UseCompactObjectHeaders == false\n","filename":"test\/jdk\/jdk\/jfr\/event\/oldobject\/TestZ.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -43,1 +43,0 @@\n- * @summary The test verifies JFR.dump command\n@@ -46,0 +45,2 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n+ * @summary The test verifies JFR.dump command\n","filename":"test\/jdk\/jdk\/jfr\/jcmd\/TestJcmdDump.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -44,1 +44,1 @@\n- * @summary Start a recording with or without path-to-gc-roots\n+ * @requires vm.flagless\n@@ -46,0 +46,2 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n+ * @summary Start a recording with or without path-to-gc-roots\n@@ -48,1 +50,0 @@\n- * @requires vm.flagless\n","filename":"test\/jdk\/jdk\/jfr\/jcmd\/TestJcmdDumpPathToGCRoots.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -37,1 +37,1 @@\n- * @summary Test -XX:FlightRecorderOptions:old-object-queue-size\n+ * @requires vm.flagless\n@@ -39,0 +39,2 @@\n+ * @requires !(vm.opt.final.UseCompactObjectHeaders == true | vm.opt.final.UseShenandoahGC == true)\n+ * @summary Test -XX:FlightRecorderOptions:old-object-queue-size\n@@ -41,1 +43,0 @@\n- * @requires vm.flagless\n","filename":"test\/jdk\/jdk\/jfr\/startupargs\/TestOldObjectQueueSize.java","additions":3,"deletions":2,"binary":false,"changes":5,"status":"modified"},{"patch":"@@ -384,0 +384,1 @@\n+        vmOptFinalFlag(map, \"UseCompactObjectHeaders\");\n","filename":"test\/jtreg-ext\/requires\/VMProps.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"}]}