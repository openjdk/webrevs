{"files":[{"patch":"@@ -70,1 +70,3 @@\n-  JfrCheckpointManager::on_unloading_classes();\n+  if (JfrRecorder::is_created() || JfrRecorder::is_started_on_commandline()) {\n+    JfrCheckpointManager::on_unloading_classes();\n+  }\n","filename":"src\/hotspot\/share\/jfr\/jfr.cpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -120,2 +120,2 @@\n-                                                                        thread_local_buffer_prealloc_count,\n-                                                                        thread_local_buffer_prealloc_count)) {\n+                                                                           thread_local_buffer_prealloc_count,\n+                                                                           thread_local_buffer_prealloc_count)) {\n@@ -128,2 +128,2 @@\n-                                                                                        JFR_MSPACE_UNLIMITED_CACHE_SIZE,\n-                                                                                        virtual_thread_local_buffer_prealloc_count)) {\n+                                                                                           JFR_MSPACE_UNLIMITED_CACHE_SIZE,\n+                                                                                           virtual_thread_local_buffer_prealloc_count)) {\n","filename":"src\/hotspot\/share\/jfr\/recorder\/checkpoint\/jfrCheckpointManager.cpp","additions":4,"deletions":4,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -58,0 +58,1 @@\n+  friend class JfrDeprecationManager;\n","filename":"src\/hotspot\/share\/jfr\/recorder\/checkpoint\/jfrCheckpointWriter.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -89,3 +89,0 @@\n-\/\/ Subsystem\n-static JfrCheckpointManager* _checkpoint_manager = nullptr;\n-\n@@ -102,3 +99,4 @@\n-  _checkpoint_manager = JfrCheckpointManager::create();\n-  if (_checkpoint_manager == nullptr || !_checkpoint_manager->initialize_early()) {\n-    return false;\n+  if (is_started_on_commandline()) {\n+    if (!create_checkpoint_manager()) {\n+      return false;\n+    }\n@@ -295,1 +293,1 @@\n-  if (!create_checkpoint_manager()) {\n+  if (!initialize_checkpoint_manager()) {\n@@ -324,0 +322,1 @@\n+static JfrCheckpointManager* _checkpoint_manager = nullptr;\n@@ -360,0 +359,11 @@\n+  assert(_checkpoint_manager == nullptr, \"invariant\");\n+  _checkpoint_manager = JfrCheckpointManager::create();\n+  return _checkpoint_manager != nullptr && _checkpoint_manager->initialize_early();\n+}\n+\n+bool JfrRecorder::initialize_checkpoint_manager() {\n+  if (_checkpoint_manager == nullptr) {\n+    if (!create_checkpoint_manager()) {\n+      return false;\n+    }\n+  }\n","filename":"src\/hotspot\/share\/jfr\/recorder\/jfrRecorder.cpp","additions":17,"deletions":7,"binary":false,"changes":24,"status":"modified"},{"patch":"@@ -45,0 +45,1 @@\n+  static bool initialize_checkpoint_manager();\n","filename":"src\/hotspot\/share\/jfr\/recorder\/jfrRecorder.hpp","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -374,1 +374,1 @@\n-  if (writer.has_data() && _pending_head != nullptr) {\n+  if (_pending_head != nullptr) {\n@@ -376,0 +376,2 @@\n+  } else {\n+    writer.cancel();\n","filename":"src\/hotspot\/share\/jfr\/support\/jfrDeprecationManager.cpp","additions":3,"deletions":1,"binary":false,"changes":4,"status":"modified"}]}