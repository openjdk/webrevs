{"files":[{"patch":"@@ -101,4 +101,7 @@\n-        if (filesLoader != null) {\n-            filesLoader.loadThread.interrupt();\n-            filesLoader.cancelRunnables();\n-            filesLoader = null;\n+        synchronized (this) {\n+            if (filesLoader != null) {\n+                filesLoader.loadThread.interrupt();\n+                filesLoader = null;\n+                \/\/ Increment fetch ID to invalidate pending DoChangeContents\n+                fetchID.incrementAndGet();\n+            }\n@@ -159,4 +162,4 @@\n-        if (filesLoader != null) {\n-            filesLoader.loadThread.interrupt();\n-            filesLoader.cancelRunnables();\n-        }\n+        synchronized (this) {\n+            if (filesLoader != null) {\n+                filesLoader.loadThread.interrupt();\n+            }\n@@ -164,3 +167,4 @@\n-        int fid = fetchID.incrementAndGet();\n-        setBusy(true, fid);\n-        filesLoader = new FilesLoader(currentDirectory, fid);\n+            int fid = fetchID.incrementAndGet();\n+            setBusy(true, fid);\n+            filesLoader = new FilesLoader(currentDirectory, fid);\n+        }\n@@ -273,1 +277,0 @@\n-        private volatile DoChangeContents runnable;\n@@ -294,2 +297,0 @@\n-            FileSystemView fileSystem = fileSystemView;\n-\n@@ -300,1 +301,1 @@\n-            File[] list = fileSystem.getFiles(currentDirectory, useFileHiding);\n+            File[] list = fileSystemView.getFiles(currentDirectory, useFileHiding);\n@@ -307,1 +308,1 @@\n-            Vector<File> newFiles = new Vector<File>();\n+            final Vector<File> newFiles = new Vector<File>();\n@@ -309,1 +310,1 @@\n-            \/\/ run through the file list, add directories and selectable files to fileCache\n+            \/\/ Run through the file list, add directories and selectable files to fileCache\n@@ -336,1 +337,1 @@\n-            runnable = ShellFolder.invoke(new Callable<DoChangeContents>() {\n+            DoChangeContents runnable = ShellFolder.invoke(new Callable<DoChangeContents>() {\n@@ -392,1 +393,1 @@\n-                                cancelRunnables();\n+                                return null;\n@@ -405,6 +406,0 @@\n-\n-        private void cancelRunnables() {\n-            if (runnable != null) {\n-                runnable.cancel();\n-            }\n-        }\n@@ -519,1 +514,0 @@\n-        private boolean doFire = true;\n@@ -521,2 +515,2 @@\n-        private int addStart = 0;\n-        private int remStart = 0;\n+        private final int addStart;\n+        private final int remStart;\n@@ -524,2 +518,3 @@\n-        DoChangeContents(List<File> addFiles, int addStart, List<File> remFiles,\n-                         int remStart, int fid) {\n+        private DoChangeContents(List<File> addFiles, int addStart,\n+                                 List<File> remFiles, int remStart,\n+                                 int fid) {\n@@ -533,3 +528,5 @@\n-        synchronized void cancel() {\n-            doFire = false;\n-        }\n+        @Override\n+        public void run() {\n+            if (fetchID.get() != fid) {\n+                return;\n+            }\n@@ -537,13 +534,6 @@\n-        public synchronized void run() {\n-            if (fetchID.get() == fid && doFire) {\n-                int remSize = (remFiles == null) ? 0 : remFiles.size();\n-                int addSize = (addFiles == null) ? 0 : addFiles.size();\n-                synchronized(fileCache) {\n-                    if (remSize > 0) {\n-                        fileCache.removeAll(remFiles);\n-                    }\n-                    if (addSize > 0) {\n-                        fileCache.addAll(addStart, addFiles);\n-                    }\n-                    files = null;\n-                    directories = null;\n+            final int remSize = (remFiles == null) ? 0 : remFiles.size();\n+            final int addSize = (addFiles == null) ? 0 : addFiles.size();\n+            final int cacheSize;\n+            synchronized (fileCache) {\n+                if (remSize > 0) {\n+                    fileCache.removeAll(remFiles);\n@@ -551,6 +541,2 @@\n-                if (remSize > 0 && addSize == 0) {\n-                    fireIntervalRemoved(BasicDirectoryModel.this, remStart, remStart + remSize - 1);\n-                } else if (addSize > 0 && remSize == 0 && addStart + addSize <= fileCache.size()) {\n-                    fireIntervalAdded(BasicDirectoryModel.this, addStart, addStart + addSize - 1);\n-                } else {\n-                    fireContentsChanged();\n+                if (addSize > 0) {\n+                    fileCache.addAll(addStart, addFiles);\n@@ -558,0 +544,10 @@\n+                files = null;\n+                directories = null;\n+                cacheSize = fileCache.size();\n+            }\n+            if (remSize > 0 && addSize == 0) {\n+                fireIntervalRemoved(BasicDirectoryModel.this, remStart, remStart + remSize - 1);\n+            } else if (addSize > 0 && remSize == 0 && addStart + addSize <= cacheSize) {\n+                fireIntervalAdded(BasicDirectoryModel.this, addStart, addStart + addSize - 1);\n+            } else {\n+                fireContentsChanged();\n","filename":"src\/java.desktop\/share\/classes\/javax\/swing\/plaf\/basic\/BasicDirectoryModel.java","additions":48,"deletions":52,"binary":false,"changes":100,"status":"modified"}]}