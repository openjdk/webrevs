{"files":[{"patch":"@@ -8,1 +8,1 @@\n-  <style type=\"text\/css\">\n+  <style>\n@@ -24,1 +24,1 @@\n-<nav id=\"TOC\">\n+<nav id=\"TOC\" role=\"doc-toc\">\n@@ -43,0 +43,1 @@\n+<li><a href=\"#pkcs11-tests\">PKCS11 Tests<\/a><\/li>\n@@ -61,1 +62,1 @@\n-<p>For some common top-level tests, direct make targets have been generated. This includes all JTReg test groups, the hotspot gtest, and custom tests (if present). This means that <code>make run-test-tier1<\/code> is equivalent to <code>make run-test TEST=&quot;tier1&quot;<\/code>, but the latter is more tab-completion friendly. For more complex test runs, the <code>run-test TEST=&quot;x&quot;<\/code> solution needs to be used.<\/p>\n+<p>For some common top-level tests, direct make targets have been generated. This includes all JTReg test groups, the hotspot gtest, and custom tests (if present). This means that <code>make run-test-tier1<\/code> is equivalent to <code>make run-test TEST=\"tier1\"<\/code>, but the latter is more tab-completion friendly. For more complex test runs, the <code>run-test TEST=\"x\"<\/code> solution needs to be used.<\/p>\n@@ -104,2 +105,2 @@\n-<p>These variables use a keyword=value approach to allow multiple values to be set. So, for instance, <code>JTREG=&quot;JOBS=1;TIMEOUT=8&quot;<\/code> will set the JTReg concurrency level to 1 and the timeout factor to 8. This is equivalent to setting <code>JTREG_JOBS=1 JTREG_TIMEOUT=8<\/code>, but using the keyword format means that the <code>JTREG<\/code> variable is parsed and verified for correctness, so <code>JTREG=&quot;TMIEOUT=8&quot;<\/code> would give an error, while <code>JTREG_TMIEOUT=8<\/code> would just pass unnoticed.<\/p>\n-<p>To separate multiple keyword=value pairs, use <code>;<\/code> (semicolon). Since the shell normally eats <code>;<\/code>, the recommended usage is to write the assignment inside qoutes, e.g. <code>JTREG=&quot;...;...&quot;<\/code>. This will also make sure spaces are preserved, as in <code>JTREG=&quot;VM_OPTIONS=-XshowSettings -Xlog:gc+ref=debug&quot;<\/code>.<\/p>\n+<p>These variables use a keyword=value approach to allow multiple values to be set. So, for instance, <code>JTREG=\"JOBS=1;TIMEOUT=8\"<\/code> will set the JTReg concurrency level to 1 and the timeout factor to 8. This is equivalent to setting <code>JTREG_JOBS=1 JTREG_TIMEOUT=8<\/code>, but using the keyword format means that the <code>JTREG<\/code> variable is parsed and verified for correctness, so <code>JTREG=\"TMIEOUT=8\"<\/code> would give an error, while <code>JTREG_TMIEOUT=8<\/code> would just pass unnoticed.<\/p>\n+<p>To separate multiple keyword=value pairs, use <code>;<\/code> (semicolon). Since the shell normally eats <code>;<\/code>, the recommended usage is to write the assignment inside qoutes, e.g. <code>JTREG=\"...;...\"<\/code>. This will also make sure spaces are preserved, as in <code>JTREG=\"VM_OPTIONS=-XshowSettings -Xlog:gc+ref=debug\"<\/code>.<\/p>\n@@ -155,1 +156,1 @@\n-<p>Use <code>JTREG=&quot;OPTIONS=--help all&quot;<\/code> to see all available JTReg options.<\/p>\n+<p>Use <code>JTREG=\"OPTIONS=--help all\"<\/code> to see all available JTReg options.<\/p>\n@@ -172,1 +173,1 @@\n-<p>Use <code>GTEST=&quot;OPTIONS=--help&quot;<\/code> to see all available Gtest options.<\/p>\n+<p>Use <code>GTEST=\"OPTIONS=--help\"<\/code> to see all available Gtest options.<\/p>\n@@ -181,0 +182,5 @@\n+<h3 id=\"pkcs11-tests\">PKCS11 Tests<\/h3>\n+<p>It is highly recommended to use the latest NSS version when running PKCS11 tests. Improper NSS version may lead to unexpected failures which are hard to diagnose. For example, sun\/security\/pkcs11\/Secmod\/AddTrustedCert.java may fail on Ubuntu 18.04 with the default NSS version in the system. To run these tests correctly, the system property <<code>jdk.test.lib.artifacts.&lt;NAME&gt;<\/code> is required on Ubuntu 18.04 to specify the alternative NSS lib directories.The<code>&lt;NAME&gt;<\/code> component should be replaced with the name element of the appropriate <code>@Artifact<\/code> class. (See<code>test\/jdk\/sun\/security\/pkcs11\/PKCS11Test.java<\/code>)<\/p>\n+<p>For example:<\/p>\n+<pre><code>$ make test TEST=&quot;jtreg:sun\/security\/pkcs11\/Secmod\/AddTrustedCert.java&quot; JTREG=&quot;JAVA_OPTIONS=-Djdk.test.lib.artifacts.nsslib-linux_aarch64=\/path\/to\/NSS-libs&quot<\/code><\/pre>\n+<p>For more notes about the PKCS11 tests, please refer to test\/jdk\/sun\/security\/pkcs11\/README.<\/p>\n","filename":"doc\/testing.html","additions":13,"deletions":7,"binary":false,"changes":20,"status":"modified"},{"patch":"@@ -373,0 +373,16 @@\n+### PKCS11 Tests\n+\n+It is highly recommended to use the latest NSS version when running PKCS11 tests.\n+Improper NSS version may lead to unexpected failures which are hard to diagnose.\n+For example, sun\/security\/pkcs11\/Secmod\/AddTrustedCert.java may fail on Ubuntu\n+18.04 with the default NSS version in the system.\n+To run these tests correctly, the system property `jdk.test.lib.artifacts.<NAME>` is required on\n+Ubuntu 18.04 to specify the alternative NSS lib directory. The `<NAME>`\n+component should be replaced with the name element of the appropriate\n+`@Artifact` class. (See `test\/jdk\/sun\/security\/pkcs11\/PKCS11Test.java`)\n+For example:\n+\n+    $ make test TEST=\"jtreg:sun\/security\/pkcs11\/Secmod\/AddTrustedCert.java\" JTREG=\"JAVA_OPTIONS=-Djdk.test.lib.artifacts.nsslib-linux_aarch64=\/path\/to\/NSS-libs\"\n+\n+For more notes about the PKCS11 tests, please refer to test\/jdk\/sun\/security\/pkcs11\/README.\n+\n","filename":"doc\/testing.md","additions":16,"deletions":0,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -637,6 +637,1 @@\n-sun\/security\/tools\/keytool\/NssTest.java                         8295343,8204203 linux-all,windows-all\n-sun\/security\/pkcs11\/Signature\/TestRSAKeyLength.java             8295343 linux-all\n-sun\/security\/pkcs11\/rsa\/TestSignatures.java                     8295343 linux-all\n-sun\/security\/pkcs11\/rsa\/TestKeyPairGenerator.java               8295343 linux-all\n-sun\/security\/pkcs11\/rsa\/TestKeyFactory.java                     8295343 linux-all\n-sun\/security\/pkcs11\/KeyStore\/Basic.java                         8295343 linux-all\n+sun\/security\/tools\/keytool\/NssTest.java                         8204203 linux-all,windows-all\n","filename":"test\/jdk\/ProblemList.txt","additions":1,"deletions":6,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -51,1 +51,0 @@\n-import java.util.HashMap;\n@@ -387,3 +386,3 @@\n-        String[] nssLibDirs = getNssLibPaths(osid);\n-        if (nssLibDirs == null) {\n-            System.out.println(\"Warning: unsupported OS: \" + osid\n+        String nssLibDir = fetchNssLib(osid);\n+        if (nssLibDir == null) {\n+            throw new SkippedException(\"Warning: unsupported OS: \" + osid\n@@ -391,5 +390,0 @@\n-            return null;\n-        }\n-        if (nssLibDirs.length == 0) {\n-            System.out.println(\"Warning: NSS not supported on this platform, skipping test\");\n-            return null;\n@@ -398,7 +392,4 @@\n-        Path nssLibPath = null;\n-        for (String dir : nssLibDirs) {\n-            Path libPath = Paths.get(dir).resolve(System.mapLibraryName(library));\n-            if (Files.exists(libPath)) {\n-                nssLibPath = libPath;\n-                break;\n-            }\n+        String libraryName = System.mapLibraryName(library);\n+        Path libPath = Paths.get(nssLibDir).resolve(libraryName);\n+        if (!Files.exists(libPath)) {\n+            throw new SkippedException(\"NSS library \\\"\" + libraryName + \"\\\" was not found in \" + nssLibDir);\n@@ -406,5 +397,2 @@\n-        if (nssLibPath == null) {\n-            System.out.println(\"Warning: can't find NSS library on this machine, skipping test\");\n-            return null;\n-        }\n-        return nssLibPath;\n+\n+        return libPath;\n@@ -734,71 +722,0 @@\n-    \/\/ Location of the NSS libraries on each supported platform\n-    private static Map<String, String[]> getOsMap() {\n-        if (osMap != null) {\n-            return osMap;\n-        }\n-\n-        osMap = new HashMap<>();\n-        osMap.put(\"SunOS-sparc-32\", new String[] { \"\/usr\/lib\/mps\/\" });\n-        osMap.put(\"SunOS-sparcv9-64\", new String[] { \"\/usr\/lib\/mps\/64\/\" });\n-        osMap.put(\"SunOS-x86-32\", new String[] { \"\/usr\/lib\/mps\/\" });\n-        osMap.put(\"SunOS-amd64-64\", new String[] { \"\/usr\/lib\/mps\/64\/\" });\n-        osMap.put(\"Linux-i386-32\", new String[]{\n-                \"\/usr\/lib\/i386-linux-gnu\/\",\n-                \"\/usr\/lib32\/\",\n-                \"\/usr\/lib\/\"});\n-        osMap.put(\"Linux-amd64-64\", new String[]{\n-                \"\/usr\/lib\/x86_64-linux-gnu\/\",\n-                \"\/usr\/lib\/x86_64-linux-gnu\/nss\/\",\n-                \"\/usr\/lib64\/\"});\n-        osMap.put(\"Linux-ppc64-64\", new String[]{\"\/usr\/lib64\/\"});\n-        osMap.put(\"Linux-ppc64le-64\", new String[]{\"\/usr\/lib64\/\"});\n-        osMap.put(\"Linux-s390x-64\", new String[]{\"\/usr\/lib64\/\"});\n-        osMap.put(\"Windows-x86-32\", new String[]{});\n-        osMap.put(\"Windows-amd64-64\", new String[]{});\n-        osMap.put(\"MacOSX-x86_64-64\", new String[]{});\n-        osMap.put(\"Linux-arm-32\", new String[]{\n-                \"\/usr\/lib\/arm-linux-gnueabi\/nss\/\",\n-                \"\/usr\/lib\/arm-linux-gnueabihf\/nss\/\"});\n-        \/\/ Exclude linux-aarch64 at the moment until the following bug is fixed:\n-        \/\/ 8296631: NSS tests failing on OL9 linux-aarch64 hosts\n-\/\/        osMap.put(\"Linux-aarch64-64\", new String[] {\n-\/\/                \"\/usr\/lib\/aarch64-linux-gnu\/\",\n-\/\/                \"\/usr\/lib\/aarch64-linux-gnu\/nss\/\",\n-\/\/                \"\/usr\/lib64\/\" });\n-        return osMap;\n-    }\n-\n-    private static String[] getNssLibPaths(String osId) {\n-        String[] preferablePaths = getPreferableNssLibPaths(osId);\n-        if (preferablePaths.length != 0) {\n-            return preferablePaths;\n-        } else {\n-            return getOsMap().get(osId);\n-        }\n-    }\n-\n-    private static String[] getPreferableNssLibPaths(String osId) {\n-        List<String> nssLibPaths = new ArrayList<>();\n-\n-        String customNssLibPaths = System.getProperty(\"test.nss.lib.paths\");\n-        if (customNssLibPaths == null) {\n-            \/\/ If custom local NSS lib path is not provided,\n-            \/\/ try to download NSS libs from artifactory\n-            String path = fetchNssLib(osId);\n-            if (path != null) {\n-                nssLibPaths.add(path);\n-            }\n-        } else {\n-            String[] paths = customNssLibPaths.split(\",\");\n-            for (String path : paths) {\n-                if (!path.endsWith(File.separator)) {\n-                    nssLibPaths.add(path + File.separator);\n-                } else {\n-                    nssLibPaths.add(path);\n-                }\n-            }\n-        }\n-\n-        return nssLibPaths.toArray(new String[0]);\n-    }\n-\n","filename":"test\/jdk\/sun\/security\/pkcs11\/PKCS11Test.java","additions":9,"deletions":92,"binary":false,"changes":101,"status":"modified"},{"patch":"@@ -7,3 +7,5 @@\n-1. Specified by system property test.nss.lib.paths\n-System property test.nss.lib.paths can specify a set of absolute paths to\n-the local NSS library directories. The paths are separated by comma.\n+1. Specified by system property jdk.test.lib.artifacts.<NAME>\n+The system property, jdk.test.lib.artifacts.<NAME>, can specify an absolute path\n+to the local NSS library directory. The <NAME> component should be replaced with\n+the name element of the appropriate @Artifact class.\n+(See `test\/jdk\/sun\/security\/pkcs11\/PKCS11Test.java`)\n@@ -12,3 +14,2 @@\n-If the value of system property test.nss.lib.paths is not set, the tests will try\n-to download pre-built NSS libraries from artifactory server. Currently, the\n-tests only looks for libraries for Windows and MacOSX platforms on artifactory.\n+If the value of system property jdk.test.lib.artifacts.<NAME> is not set, the\n+tests will try to download pre-built NSS libraries from artifactory server.\n","filename":"test\/jdk\/sun\/security\/pkcs11\/README","additions":7,"deletions":6,"binary":false,"changes":13,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2018, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2018, 2023 Oracle and\/or its affiliates. All rights reserved.\n@@ -59,3 +59,4 @@\n-        Files.copy(dbPath.resolve(\"cert8.db\"), Paths.get(\"cert8.db\"));\n-        Files.copy(dbPath.resolve(\"key3.db\"), Paths.get(\"key3.db\"));\n-        Files.copy(dbPath.resolve(\"secmod.db\"), Paths.get(\"secmod.db\"));\n+        Path destDir = Path.of( \"tmpdb\");\n+        Files.createDirectory(destDir);\n+        Files.copy(dbPath.resolve(\"cert9.db\"), destDir.resolve(\"cert9.db\"));\n+        Files.copy(dbPath.resolve(\"key4.db\"), destDir.resolve(\"key4.db\"));\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/NssTest.java","additions":5,"deletions":4,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -9,1 +9,1 @@\n-nssArgs = \"configdir='.' certPrefix='' keyPrefix='' secmod='secmod.db'\"\n+nssArgs = \"configdir='sql:.\/tmpdb' certPrefix='' keyPrefix='' secmod='secmod.db'\"\n","filename":"test\/jdk\/sun\/security\/tools\/keytool\/p11-nss.txt","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"}]}