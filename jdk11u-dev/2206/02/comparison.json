{"files":[{"patch":"@@ -106,1 +106,1 @@\n-static void initialize(JNIEnv *env, jthread thread, EventIndex triggering_ei);\n+static void initialize(JNIEnv *env, jthread thread, EventIndex triggering_ei, EventInfo *opt_info);\n@@ -442,1 +442,1 @@\n-        initialize(env, thread, EI_VM_INIT);\n+        initialize(env, thread, EI_VM_INIT, NULL);\n@@ -495,0 +495,10 @@\n+    EventInfo info;\n+    info.ei = EI_EXCEPTION;\n+    info.thread = thread;\n+    info.clazz = getMethodClass(jvmti_env, method);\n+    info.method = method;\n+    info.location = location;\n+    info.object = exception;\n+    info.u.exception.catch_clazz = getMethodClass(jvmti_env, catch_method);\n+    info.u.exception.catch_method = catch_method;\n+    info.u.exception.catch_location = catch_location;\n@@ -509,1 +519,1 @@\n-        initialize(env, thread, EI_EXCEPTION);\n+        initialize(env, thread, EI_EXCEPTION, &info);\n@@ -513,5 +523,3 @@\n-        jclass clazz;\n-\n-        \/* Get class of exception thrown *\/\n-        clazz = JNI_FUNC_PTR(env,GetObjectClass)(env, exception);\n-        if ( clazz != NULL ) {\n+        jclass exception_clazz = JNI_FUNC_PTR(env, GetObjectClass)(env, exception);\n+        \/* check class of exception thrown *\/\n+        if ( exception_clazz != NULL ) {\n@@ -520,1 +528,1 @@\n-            error = classSignature(clazz, &signature, NULL);\n+            error = classSignature(exception_clazz, &signature, NULL);\n@@ -526,1 +534,1 @@\n-                initialize(env, thread, EI_EXCEPTION);\n+                initialize(env, thread, EI_EXCEPTION, &info);\n@@ -667,0 +675,2 @@\n+ *\n+ * @param opt_info optional event info to use, might be null\n@@ -669,1 +679,1 @@\n-initialize(JNIEnv *env, jthread thread, EventIndex triggering_ei)\n+initialize(JNIEnv *env, jthread thread, EventIndex triggering_ei, EventInfo *opt_info)\n@@ -757,1 +767,0 @@\n-        EventInfo info;\n@@ -759,1 +768,3 @@\n-        LOG_MISC((\"triggering_ei != EI_VM_INIT\"));\n+        LOG_MISC((\"triggering_ei == EI_EXCEPTION\"));\n+        JDI_ASSERT(triggering_ei == EI_EXCEPTION);\n+        JDI_ASSERT(opt_info != NULL);\n@@ -761,3 +772,2 @@\n-        (void)memset(&info,0,sizeof(info));\n-        info.ei = triggering_ei;\n-        eventHelper_recordEvent(&info, 0, suspendPolicy, initEventBag);\n+        threadControl_onEventHandlerEntry(currentSessionID, opt_info->ei, thread, NULL);\n+        eventHelper_recordEvent(opt_info, 0, suspendPolicy, initEventBag);\n@@ -1398,1 +1408,1 @@\n-        initialize(env, thread, EI_VM_INIT);\n+        initialize(env, thread, EI_VM_INIT, NULL);\n","filename":"src\/jdk.jdwp.agent\/share\/native\/libjdwp\/debugInit.c","additions":27,"deletions":17,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -0,0 +1,158 @@\n+\/*\n+ * Copyright (c) 2023 SAP SE. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import com.sun.jdi.Bootstrap;\n+import com.sun.jdi.VirtualMachine;\n+import com.sun.jdi.connect.AttachingConnector;\n+import com.sun.jdi.connect.Connector;\n+import com.sun.jdi.connect.IllegalConnectorArgumentsException;\n+import com.sun.jdi.event.EventIterator;\n+import com.sun.jdi.event.EventQueue;\n+import com.sun.jdi.event.EventSet;\n+import com.sun.jdi.event.Event;\n+import com.sun.jdi.event.ExceptionEvent;\n+import lib.jdb.Debuggee;\n+\n+import java.io.IOException;\n+import java.net.ServerSocket;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+\/*\n+ * @test\n+ * @bug 8317920\n+ * @summary Tests for JDWP agent to send valid exception event with onthrow option\n+ * @library \/test\/lib\n+ *\n+ * @build ThrowCaughtException JdwpOnThrowTest\n+ * @run main\/othervm JdwpOnThrowTest\n+ *\/\n+public class JdwpOnThrowTest {\n+\n+    private static long TIMEOUT = 10000;\n+\n+    private static String ATTACH_CONNECTOR = \"com.sun.jdi.SocketAttach\";\n+    \/\/ cache socket attaching connector\n+    private static AttachingConnector attachingConnector;\n+\n+    public static void main(String[] args) throws Exception {\n+        int port = findFreePort();\n+        try (Debuggee debuggee = Debuggee.launcher(\"ThrowCaughtException\").setAddress(\"localhost:\" + port)\n+                                         .enableOnThrow(\"Ex\", \"Start\").setSuspended(true).launch()) {\n+            VirtualMachine vm = null;\n+            try {\n+                vm = attach(\"localhost\", \"\" + port);\n+                EventQueue queue = vm.eventQueue();\n+                log(\"Waiting for exception event\");\n+                long start = System.currentTimeMillis();\n+                while (start + TIMEOUT > System.currentTimeMillis()) {\n+                    EventSet eventSet = queue.remove(TIMEOUT);\n+                    EventIterator eventIterator = eventSet.eventIterator();\n+                    while(eventIterator.hasNext() && start + TIMEOUT > System.currentTimeMillis()) {\n+                        Event event = eventIterator.next();\n+                        if (event instanceof ExceptionEvent) {\n+                            ExceptionEvent ex = (ExceptionEvent)event;\n+                            verifyExceptionEvent(ex);\n+                            log(\"Received exception event: \" + event);\n+                            vm.dispose();\n+                            return;\n+                        }\n+                        log(\"Received event: \" + event);\n+                    }\n+                }\n+                throw new RuntimeException(\"ERROR: failed to receive exception event\");\n+            } catch (IOException ex) {\n+                throw new RuntimeException(\"ERROR: failed to attach\", ex);\n+            }\n+        }\n+    }\n+\n+    private static void verifyExceptionEvent(ExceptionEvent ex) throws Exception {\n+        if (ex.exception() == null) {\n+            throw new RuntimeException(\"Exception is null\");\n+        }\n+        if (ex.exception().type() == null) {\n+            throw new RuntimeException(\"Exception type is null\");\n+        }\n+        if (ex.exception().referenceType() == null) {\n+            throw new RuntimeException(\"Exception reference type is null\");\n+        }\n+        if (ex.catchLocation() == null) {\n+            throw new RuntimeException(\"Exception catch location is null\");\n+        }\n+        if (!ex.location().equals(ex.thread().frame(0).location())) {\n+            throw new RuntimeException(\n+                String.format(\"Throw location %s and location of first frame %s are not equal\",\n+                                ex.location(), ex.thread().frame(0).location()));\n+        }\n+        if (!ex.exception().type().name().equals(\"Ex\")) {\n+            throw new RuntimeException(\"Exception has wrong type: \" + ex.exception().type().name());\n+        }\n+    }\n+\n+    private static int findFreePort() {\n+        try (ServerSocket socket = new ServerSocket(0)) {\n+            return socket.getLocalPort();\n+        } catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    private static VirtualMachine attach(String address, String port) throws IOException {\n+        if (attachingConnector == null) {\n+            attachingConnector = (AttachingConnector)getConnector(ATTACH_CONNECTOR);\n+        }\n+        Map<String, Connector.Argument> args = attachingConnector.defaultArguments();\n+        setConnectorArg(args, \"hostname\", address);\n+        setConnectorArg(args, \"port\", port);\n+        try {\n+            return attachingConnector.attach(args);\n+        } catch (IllegalConnectorArgumentsException e) {\n+            \/\/ unexpected.. wrap in RuntimeException\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    private static Connector getConnector(String name) {\n+        for (Connector connector : Bootstrap.virtualMachineManager().allConnectors()) {\n+            if (connector.name().equalsIgnoreCase(name)) {\n+                return connector;\n+            }\n+        }\n+        throw new IllegalArgumentException(\"Connector \" + name + \" not found\");\n+    }\n+\n+    private static void setConnectorArg(Map<String, Connector.Argument> args, String name, String value) {\n+        Connector.Argument arg = args.get(name);\n+        if (arg == null) {\n+            throw new IllegalArgumentException(\"Argument \" + name + \" is not defined\");\n+        }\n+        arg.setValue(value);\n+    }\n+\n+    private static void log(Object o) {\n+        System.out.println(String.valueOf(o));\n+    }\n+\n+}\n","filename":"test\/jdk\/com\/sun\/jdi\/JdwpOnThrowTest.java","additions":158,"deletions":0,"binary":false,"changes":158,"status":"added"},{"patch":"@@ -0,0 +1,36 @@\n+\/*\n+ * Copyright (c) 2023 SAP SE. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+ public class ThrowCaughtException {\n+    public static void main(String args[]) throws Exception {\n+        try {\n+            System.out.println(\"Start\");\n+            throw new Ex();\n+        } catch (Exception e) {\n+            System.out.println(e);\n+        }\n+    }\n+}\n+\n+class Ex extends RuntimeException {\n+}\n","filename":"test\/jdk\/com\/sun\/jdi\/ThrowCaughtException.java","additions":36,"deletions":0,"binary":false,"changes":36,"status":"added"},{"patch":"@@ -71,0 +71,3 @@\n+        private String onthrow = \"\";\n+        private boolean waitForPortPrint = true;\n+        private String expectedOutputBeforeThrow = \"\";\n@@ -99,0 +102,8 @@\n+        \/\/ required to pass non null port with address and emit string before the throw\n+        public Launcher enableOnThrow(String value, String expectedOutputBeforeThrow) {\n+            this.onthrow = value;\n+            this.waitForPortPrint = false;\n+            this.expectedOutputBeforeThrow = expectedOutputBeforeThrow;\n+            return this;\n+        }\n+\n@@ -101,0 +112,1 @@\n+            String onthrowArgs = onthrow.isEmpty() ? \"\" : \",onthrow=\" + onthrow + \",launch=exit\";\n@@ -103,1 +115,2 @@\n-                    + \",server=y,suspend=\" + (suspended ? \"y\" : \"n\"));\n+                    + \",server=y,suspend=\" + (suspended ? \"y\" : \"n\")\n+                    + onthrowArgs);\n@@ -110,1 +123,1 @@\n-            return new Debuggee(prepare(), name);\n+            return new Debuggee(prepare(), name, waitForPortPrint, expectedOutputBeforeThrow);\n@@ -118,1 +131,1 @@\n-    private Debuggee(ProcessBuilder pb, String name) {\n+    private Debuggee(ProcessBuilder pb, String name, boolean waitForPortPrint, String expectedOutputBeforeThrow) {\n@@ -122,0 +135,12 @@\n+        if (!waitForPortPrint) {\n+            try {\n+                p = ProcessTools.startProcess(name, pb, s -> {output.add(s);}, s -> {\n+                    return s.equals(expectedOutputBeforeThrow);\n+                }, 30, TimeUnit.SECONDS);\n+            } catch (IOException | InterruptedException | TimeoutException ex) {\n+                throw new RuntimeException(\"failed to launch debuggee\", ex);\n+            }\n+            transport = null;\n+            address = null;\n+            return;\n+        }\n@@ -170,0 +195,3 @@\n+        if (transport == null) {\n+            throw new IllegalStateException(\"transport is not available\");\n+        }\n@@ -174,0 +202,3 @@\n+        if (address == null) {\n+            throw new IllegalStateException(\"address is not available\");\n+        }\n","filename":"test\/jdk\/com\/sun\/jdi\/lib\/jdb\/Debuggee.java","additions":34,"deletions":3,"binary":false,"changes":37,"status":"modified"}]}