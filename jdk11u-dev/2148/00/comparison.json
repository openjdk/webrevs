{"files":[{"patch":"@@ -32,0 +32,1 @@\n+import sun.hotspot.gc.GC;\n@@ -36,1 +37,1 @@\n- * @requires vm.hasSA & vm.gc != \"Z\"\n+ * @requires vm.hasSA\n@@ -42,13 +43,1 @@\n- * @run main\/othervm -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI -Xbootclasspath\/a:. TestUniverse withoutZ\n- *\/\n-\n-\/**\n- * @test\n- * @summary Test the 'universe' command of jhsdb clhsdb.\n- * @requires vm.hasSA & vm.gc == \"Z\"\n- * @bug 8190307\n- * @library \/test\/lib\n- * @build jdk.test.lib.apps.*\n- * @build sun.hotspot.WhiteBox\n- * @run driver ClassFileInstaller sun.hotspot.WhiteBox sun.hotspot.WhiteBox$WhiteBoxPermission\n- * @run main\/othervm -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI -Xbootclasspath\/a:. TestUniverse withZ\n+ * @run main\/othervm -XX:+UnlockDiagnosticVMOptions -XX:+WhiteBoxAPI -Xbootclasspath\/a:. TestUniverse\n@@ -59,3 +48,1 @@\n-    private static void testClhsdbForUniverse(long lingeredAppPid,\n-                                              String gc) throws Exception {\n-\n+    private static void testClhsdbForUniverse(long lingeredAppPid, GC gc) throws Exception {\n@@ -68,13 +55,2 @@\n-        if (gc.contains(\"UseZGC\")) {\n-            expStrings.add(\"ZHeap\");\n-        }\n-        if (gc.contains(\"G1GC\")) {\n-            expStrings.add(\"garbage-first heap\");\n-            expStrings.add(\"region size\");\n-            expStrings.add(\"G1 Young Generation:\");\n-            expStrings.add(\"regions  =\");\n-        }\n-        if (gc.contains(\"UseConcMarkSweepGC\")) {\n-            expStrings.add(\"Gen 1: concurrent mark-sweep generation\");\n-        }\n-        if (gc.contains(\"UseSerialGC\")) {\n+        switch (gc) {\n+        case Serial:\n@@ -82,2 +58,3 @@\n-        }\n-        if (gc.contains(\"UseParallelGC\")) {\n+            break;\n+\n+        case Parallel:\n@@ -87,2 +64,14 @@\n-        }\n-        if (gc.contains(\"UseEpsilonGC\")) {\n+            break;\n+\n+        case ConcMarkSweep:\n+            expStrings.add(\"Gen 1: concurrent mark-sweep generation\");\n+            break;\n+\n+        case G1:\n+            expStrings.add(\"garbage-first heap\");\n+            expStrings.add(\"region size\");\n+            expStrings.add(\"G1 Young Generation:\");\n+            expStrings.add(\"regions  =\");\n+            break;\n+\n+        case Epsilon:\n@@ -93,0 +82,9 @@\n+            break;\n+\n+        case Z:\n+            expStrings.add(\"ZHeap\");\n+            break;\n+\n+        case Shenandoah:\n+            expStrings.add(\"Shenandoah Heap\");\n+            break;\n@@ -94,0 +92,1 @@\n+\n@@ -98,1 +97,1 @@\n-    public static void test(String gc) throws Exception {\n+    private static void test(GC gc) throws Exception {\n@@ -101,6 +100,2 @@\n-            List<String> vmArgs = new ArrayList<String>();\n-            vmArgs.add(\"-XX:+UnlockExperimentalVMOptions\"); \/\/ unlock experimental GCs\n-            vmArgs.add(gc);\n-            app = LingeredApp.startApp(vmArgs);\n-            System.out.println (\"Started LingeredApp with the GC option \" + gc +\n-                                \" and pid \" + app.getPid());\n+            app = LingeredApp.startApp(List.of(\"-XX:+UnlockExperimentalVMOptions\", \"-XX:+Use\" + gc + \"GC\"));\n+            System.out.println (\"Started LingeredApp with \" + gc + \"GC and pid \" + app.getPid());\n@@ -113,0 +108,18 @@\n+    private static boolean isSelectedAndSupported(GC gc) {\n+        if (!gc.isSelected()) {\n+            \/\/ Not selected\n+            return false;\n+        }\n+\n+        if (Compiler.isGraalEnabled()) {\n+            if (gc == GC.ConcMarkSweep || gc == GC.Epsilon || gc == GC.Z || gc == GC.Shenandoah) {\n+                \/\/ Not supported\n+                System.out.println (\"Skipped testing of \" + gc + \"GC, not supported by Graal\");\n+                return false;\n+            }\n+        }\n+\n+        \/\/ Selected and supported\n+        return true;\n+    }\n+\n@@ -114,1 +127,1 @@\n-        System.out.println(\"Starting TestUniverse test\");\n+        System.out.println(\"Starting TestUniverse\");\n@@ -116,7 +129,3 @@\n-            test(\"-XX:+UseG1GC\");\n-            test(\"-XX:+UseParallelGC\");\n-            test(\"-XX:+UseSerialGC\");\n-            if (!Compiler.isGraalEnabled()) { \/\/ Graal does not support all GCs\n-                test(\"-XX:+UseConcMarkSweepGC\");\n-                if (args[0].equals(\"withZ\")) {\n-                    test(\"-XX:+UseZGC\");\n+            for (GC gc: GC.values()) {\n+                if (isSelectedAndSupported(gc)) {\n+                    test(gc);\n@@ -124,1 +133,0 @@\n-                test(\"-XX:+UseEpsilonGC\");\n","filename":"test\/hotspot\/jtreg\/serviceability\/sa\/TestUniverse.java","additions":58,"deletions":50,"binary":false,"changes":108,"status":"modified"}]}