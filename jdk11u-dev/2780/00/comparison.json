{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 1997, 2015, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 1997, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -565,10 +565,0 @@\n-            kit.read(r, doc, 0);\n-        } catch (BadLocationException e) {\n-            throw new IOException(e.getMessage());\n-        } catch (ChangedCharSetException changedCharSetException) {\n-            String charSetSpec = changedCharSetException.getCharSetSpec();\n-            if (changedCharSetException.keyEqualsCharSet()) {\n-                putClientProperty(\"charset\", charSetSpec);\n-            } else {\n-                setCharsetFromContentTypeParameters(charSetSpec);\n-            }\n@@ -576,8 +566,7 @@\n-                in.reset();\n-            } catch (IOException exception) {\n-                \/\/mark was invalidated\n-                in.close();\n-                URL url = (URL)doc.getProperty(Document.StreamDescriptionProperty);\n-                if (url != null) {\n-                    URLConnection conn = url.openConnection();\n-                    in = conn.getInputStream();\n+                kit.read(r, doc, 0);\n+            } catch (BadLocationException e) {\n+                throw new IOException(e.getMessage());\n+            } catch (ChangedCharSetException changedCharSetException) {\n+                String charSetSpec = changedCharSetException.getCharSetSpec();\n+                if (changedCharSetException.keyEqualsCharSet()) {\n+                    putClientProperty(\"charset\", charSetSpec);\n@@ -585,2 +574,15 @@\n-                    \/\/there is nothing we can do to recover stream\n-                    throw changedCharSetException;\n+                    setCharsetFromContentTypeParameters(charSetSpec);\n+                }\n+                try {\n+                    in.reset();\n+                } catch (IOException exception) {\n+                    \/\/mark was invalidated\n+                    in.close();\n+                    URL url = (URL)doc.getProperty(Document.StreamDescriptionProperty);\n+                    if (url != null) {\n+                        URLConnection conn = url.openConnection();\n+                        in = conn.getInputStream();\n+                    } else {\n+                        \/\/there is nothing we can do to recover stream\n+                        throw changedCharSetException;\n+                    }\n@@ -588,0 +590,5 @@\n+                try {\n+                    doc.remove(0, doc.getLength());\n+                } catch (BadLocationException e) {}\n+                doc.putProperty(\"IgnoreCharsetDirective\", Boolean.valueOf(true));\n+                read(in, doc);\n@@ -589,5 +596,0 @@\n-            try {\n-                doc.remove(0, doc.getLength());\n-            } catch (BadLocationException e) {}\n-            doc.putProperty(\"IgnoreCharsetDirective\", Boolean.valueOf(true));\n-            read(in, doc);\n","filename":"src\/java.desktop\/share\/classes\/javax\/swing\/JEditorPane.java","additions":28,"deletions":26,"binary":false,"changes":54,"status":"modified"},{"patch":"@@ -0,0 +1,74 @@\n+\/*\n+ * Copyright (c) 2024, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+\n+import javax.swing.JEditorPane;\n+import javax.swing.text.BadLocationException;\n+import javax.swing.text.Document;\n+import javax.swing.text.Element;\n+\n+\/*\n+ * @test\n+ * @bug 8328953\n+ * @summary Verifies JEditorPane.read doesn't throw ChangedCharSetException\n+            but handles it and reads HTML in the specified encoding\n+ * @run main EditorPaneCharset\n+ *\/\n+\n+public final class EditorPaneCharset {\n+    private static final String CYRILLIC_TEXT =\n+            \"\\u041F\\u0440\\u0438\\u0432\\u0435\\u0442, \\u043C\\u0438\\u0440!\";\n+    private static final String HTML_CYRILLIC =\n+            \"<html lang=\\\"ru\\\">\\n\" +\n+            \"<head>\\n\" +\n+            \"    <meta http-equiv=\\\"Content-Type\\\" \" +\n+            \"          content=\\\"text\/html; charset=windows-1251\\\">\\n\" +\n+            \"<\/head><body>\\n\" +\n+            \"<p>\" + CYRILLIC_TEXT + \"<\/p>\\n\" +\n+            \"<\/body><\/html>\\n\";\n+\n+    public static void main(String[] args) throws IOException, BadLocationException {\n+        JEditorPane editorPane = new JEditorPane();\n+        editorPane.setContentType(\"text\/html\");\n+        Document document = editorPane.getDocument();\n+\n+        \/\/ Shouldn't throw ChangedCharSetException\n+        editorPane.read(\n+                new ByteArrayInputStream(\n+                        HTML_CYRILLIC.getBytes(\n+                                Charset.forName(\"windows-1251\"))),\n+                document);\n+\n+        Element root = document.getDefaultRootElement();\n+        Element body = root.getElement(1);\n+        Element p = body.getElement(0);\n+        String pText = document.getText(p.getStartOffset(),\n+                                        p.getEndOffset() - p.getStartOffset() - 1);\n+        if (!CYRILLIC_TEXT.equals(pText)) {\n+            throw new RuntimeException(\"Text doesn't match\");\n+        }\n+    }\n+}\n","filename":"test\/jdk\/javax\/swing\/JEditorPane\/EditorPaneCharset.java","additions":74,"deletions":0,"binary":false,"changes":74,"status":"added"}]}