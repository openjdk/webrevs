{"files":[{"patch":"@@ -69,0 +69,1 @@\n+import sun.nio.fs.DefaultFileSystemProvider;\n@@ -1377,0 +1378,7 @@\n+        \/**\n+         * A class representing a key to a ZIP file. A key is based\n+         * on the file key if available, or the path value if the\n+         * file key is not available. The key is also based on the\n+         * file's last modified time to allow for cases where a ZIP\n+         * file is re-opened after it has been modified.\n+         *\/\n@@ -1378,1 +1386,1 @@\n-            BasicFileAttributes attrs;\n+            final BasicFileAttributes attrs;\n@@ -1380,0 +1388,1 @@\n+            final boolean utf8;\n@@ -1381,1 +1390,1 @@\n-            public Key(File file, BasicFileAttributes attrs) {\n+            public Key(File file, BasicFileAttributes attrs, ZipCoder zc) {\n@@ -1384,0 +1393,1 @@\n+                this.utf8 = zc.isUTF8();\n@@ -1387,2 +1397,5 @@\n-                long t = attrs.lastModifiedTime().toMillis();\n-                return ((int)(t ^ (t >>> 32))) + file.hashCode();\n+                long t = utf8 ? 0 : Long.MAX_VALUE;\n+                t += attrs.lastModifiedTime().toMillis();\n+                Object fk = attrs.fileKey();\n+                return Long.hashCode(t) +\n+                        (fk != null ? fk.hashCode() : file.hashCode());\n@@ -1393,1 +1406,4 @@\n-                    Key key = (Key)obj;\n+                    Key key = (Key) obj;\n+                    if (key.utf8 != utf8) {\n+                        return false;\n+                    }\n@@ -1408,1 +1424,6 @@\n-\n+        \/**\n+         * Use the platform's default file system to avoid\n+         * issues when the VM is configured to use a custom file system provider.\n+         *\/\n+        private static final java.nio.file.FileSystem builtInFS =\n+                DefaultFileSystemProvider.theFileSystem();\n@@ -1414,1 +1435,2 @@\n-                        Files.readAttributes(file.toPath(), BasicFileAttributes.class));\n+                        Files.readAttributes(builtInFS.getPath(file.getPath()),\n+                                BasicFileAttributes.class), zc);\n","filename":"src\/java.base\/share\/classes\/java\/util\/zip\/ZipFile.java","additions":29,"deletions":7,"binary":false,"changes":36,"status":"modified"},{"patch":"@@ -26,0 +26,1 @@\n+ * @bug 4313887 7006126 8142968 8178380 8183320 8210112 8266345 8263940\n@@ -39,0 +40,2 @@\n+import java.util.ArrayList;\n+import java.util.List;\n@@ -40,0 +43,2 @@\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n@@ -43,1 +48,0 @@\n-import org.testng.annotations.BeforeTest;\n@@ -75,0 +79,39 @@\n+    \/**\n+     * Test override of default FileSystemProvider with a\n+     * FileSystemProvider jar and the main application on the class path.\n+     *\/\n+    public void testClassPathWithFileSystemProviderJar() throws Exception {\n+        String testClasses = System.getProperty(\"test.classes\");\n+        Path jar = Path.of(\"testFileSystemProvider.jar\");\n+        Files.deleteIfExists(jar);\n+        createFileSystemProviderJar(jar, Path.of(testClasses));\n+        String classpath = jar + File.pathSeparator + testClasses\n+                + File.separator + \"modules\" + File.separator + \"m\";\n+        int exitValue = exec(SET_DEFAULT_FSP, \"-cp\", classpath, \"p.Main\");\n+        assertTrue(exitValue == 0);\n+    }\n+\n+    \/**\n+     * Creates a JAR containing the FileSystemProvider used to override the\n+     * default FileSystemProvider\n+     *\/\n+    private void createFileSystemProviderJar(Path jar, Path dir) throws IOException {\n+\n+        List<String>  args = new ArrayList<>();\n+        args.add(\"--create\");\n+        args.add(\"--file=\" + jar);\n+        try (Stream<Path> stream = Files.list(dir)) {\n+            List<String> paths = stream\n+                    .map(path -> path.getFileName().toString())\n+                    .filter(f -> f.startsWith(\"TestProvider\"))\n+                    .collect(Collectors.toList());\n+            for(var p : paths) {\n+                args.add(\"-C\");\n+                args.add(dir.toString());\n+                args.add(p);\n+            }\n+        }\n+        int ret = JAR_TOOL.run(System.out, System.out, args.toArray(new String[0]));\n+        assertTrue(ret == 0);\n+    }\n+\n","filename":"test\/jdk\/java\/nio\/file\/spi\/SetDefaultProvider.java","additions":44,"deletions":1,"binary":false,"changes":45,"status":"modified"}]}