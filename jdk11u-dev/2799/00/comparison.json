{"files":[{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2014, 2015, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2014, 2024, Oracle and\/or its affiliates. All rights reserved.\n@@ -26,1 +26,0 @@\n-import java.util.Enumeration;\n@@ -28,0 +27,1 @@\n+import java.util.Map;\n@@ -30,1 +30,0 @@\n-import java.util.jar.JarInputStream;\n@@ -32,0 +31,1 @@\n+import java.util.stream.Collectors;\n@@ -33,0 +33,1 @@\n+import java.util.zip.ZipFile;\n@@ -106,3 +107,2 @@\n-        BufferedInputStream srcis, dstis;\n-        srcis = new BufferedInputStream(new FileInputStream(src));\n-        dstis = new BufferedInputStream(new FileInputStream(dst));\n+        ZipFile zSrc = new ZipFile(src);\n+        ZipFile zDst = new ZipFile(dst);\n@@ -110,4 +110,2 @@\n-        int s = 0, d, pos = 0;\n-        while (s != -1) { \/\/ Checking of just one result for EOF is enough\n-            s = srcis.read();\n-            d = dstis.read();\n+        Map<String, Long> srcCRCs = zSrc.stream().collect(Collectors.toMap(ZipEntry::getName, ZipEntry::getCrc));\n+        Map<String, Long> dstCRCs = zDst.stream().collect(Collectors.toMap(ZipEntry::getName, ZipEntry::getCrc));\n@@ -115,3 +113,4 @@\n-            if (s != d) {\n-                throw new IOException(\"Files are differ starting at position: \"\n-                + Integer.toHexString(pos));\n+        for(Map.Entry<String, Long> srcCRC: srcCRCs.entrySet()) {\n+            ZipEntry dstEntry = zDst.getEntry(srcCRC.getKey());\n+            if (dstEntry.getCrc() != srcCRC.getValue()) {\n+                throw new IOException(\"CRC mismatch in entry \" + srcCRC.getKey());\n@@ -119,0 +118,2 @@\n+            dstCRCs.remove(srcCRC.getKey());\n+        }\n@@ -120,1 +121,2 @@\n-            pos++;\n+        if (! dstCRCs.isEmpty()) {\n+            throw new IOException(\"Destination file \" + dst.getAbsolutePath() + \" has more zip entries than source file \" + src.getAbsolutePath());\n@@ -123,2 +125,2 @@\n-        srcis.close();\n-        dstis.close();\n+        zSrc.close();\n+        zDst.close();\n","filename":"test\/jdk\/tools\/pack200\/PackTestZip64.java","additions":18,"deletions":16,"binary":false,"changes":34,"status":"modified"}]}