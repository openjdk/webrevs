{"files":[{"patch":"@@ -34,2 +34,2 @@\n-            new Model64(false, false),\n-            new Model64(true, true),\n+            new Model64(false, false, 8),\n+            new Model64(true, true, 8),\n@@ -40,1 +40,1 @@\n-            new Model64(false, true),\n+            new Model64(false, true, 8),\n@@ -45,6 +45,6 @@\n-            new Model64_Lilliput(false, 8, 8, false),\n-            new Model64_Lilliput(true, 8, 8, false),\n-            new Model64_Lilliput(true, 16, 8, false),\n-            new Model64_Lilliput(false, 8, 8, true),\n-            new Model64_Lilliput(true, 8, 8, true),\n-            new Model64_Lilliput(true, 16, 8, true),\n+            new Model64_Lilliput(false, 8,  1),\n+            new Model64_Lilliput(true,  8,  1),\n+            new Model64_Lilliput(true,  16, 1),\n+            new Model64_Lilliput(false, 8,  2),\n+            new Model64_Lilliput(true,  8,  2),\n+            new Model64_Lilliput(true,  16, 2),\n","filename":"jol-cli\/src\/main\/java\/org\/openjdk\/jol\/operations\/EstimatedModels.java","additions":9,"deletions":9,"binary":false,"changes":18,"status":"modified"},{"patch":"@@ -116,1 +116,1 @@\n-        long jdk8_noCoops =         computeWithLayouter(data, new HotSpotLayouter(new Model64(false, false), 8));\n+        long jdk8_noCoops =         computeWithLayouter(data, new HotSpotLayouter(new Model64(false, false, 8), 8));\n@@ -139,1 +139,1 @@\n-        long jdk15_noCoops =        computeWithLayouter(data, new HotSpotLayouter(new Model64(false, true), 15));\n+        long jdk15_noCoops =        computeWithLayouter(data, new HotSpotLayouter(new Model64(false, true,  8), 15));\n@@ -147,1 +147,1 @@\n-        out.println(\"=== Stock 64-bit OpenJDK (JDK >= 15)\");\n+        out.println(\"=== Stock 64-bit OpenJDK (JDK >= 15): Field Layout Improvements\");\n@@ -166,1 +166,1 @@\n-        out.println(\"=== Experimental 64-bit OpenJDK: Lilliput, 64-bit headers\");\n+        out.println(\"=== Experimental 64-bit OpenJDK (JDK >= 24): Lilliput 1 (64-bit headers)\");\n@@ -169,7 +169,7 @@\n-        long jdkLilliput_noBase_noCoops =          computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(false,  8,    8, false), 99));\n-        long jdkLilliput_noBase_coops =            computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,   8,    8, false), 99));\n-        long jdkLilliput_noBase_coops_align16 =    computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  16,    8, false), 99));\n-        long jdkLilliput_noBase_coops_align32 =    computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  32,    8, false), 99));\n-        long jdkLilliput_noBase_coops_align64 =    computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  64,    8, false), 99));\n-        long jdkLilliput_noBase_coops_align128 =   computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true, 128,    8, false), 99));\n-        long jdkLilliput_noBase_coops_align256 =   computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true, 256,    8, false), 99));\n+        long jdkLilliput_noCoops =          computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(false,  8,   1), 99));\n+        long jdkLilliput_coops =            computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,   8,   1), 99));\n+        long jdkLilliput_coops_align16 =    computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  16,   1), 99));\n+        long jdkLilliput_coops_align32 =    computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  32,   1), 99));\n+        long jdkLilliput_coops_align64 =    computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  64,   1), 99));\n+        long jdkLilliput_coops_align128 =   computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true, 128,   1), 99));\n+        long jdkLilliput_coops_align256 =   computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true, 256,   1), 99));\n@@ -183,8 +183,7 @@\n-            printLine(msg_noCoops_ccp,      rawSize, jdkLilliput_noBase_noCoops,            jdkLilliput_noBase_coops, jdk8_noCoops,         jdk15_noCoops);\n-            printLine(msg_coops,            rawSize, jdkLilliput_noBase_coops,              jdkLilliput_noBase_coops, jdk8_coops,           jdk15_coops);\n-            printLine(msg_coops_align16,    rawSize, jdkLilliput_noBase_coops_align16,      jdkLilliput_noBase_coops, jdk8_coops_align16,   jdk15_coops_align16);\n-            printLine(msg_coops_align32,    rawSize, jdkLilliput_noBase_coops_align32,      jdkLilliput_noBase_coops, jdk8_coops_align32,   jdk15_coops_align32);\n-            printLine(msg_coops_align64,    rawSize, jdkLilliput_noBase_coops_align64,      jdkLilliput_noBase_coops, jdk8_coops_align64,   jdk15_coops_align64);\n-            printLine(msg_coops_align128,   rawSize, jdkLilliput_noBase_coops_align128,     jdkLilliput_noBase_coops, jdk8_coops_align128,  jdk15_coops_align128);\n-            printLine(msg_coops_align256,   rawSize, jdkLilliput_noBase_coops_align256,     jdkLilliput_noBase_coops, jdk8_coops_align256,  jdk15_coops_align256);\n-\n+            printLine(msg_noCoops_ccp,      rawSize, jdkLilliput_noCoops,          jdkLilliput_coops, jdk8_noCoops,           jdk15_noCoops);\n+            printLine(msg_coops,            rawSize, jdkLilliput_coops,            jdkLilliput_coops, jdk8_coops,             jdk15_coops);\n+            printLine(msg_coops_align16,    rawSize, jdkLilliput_coops_align16,    jdkLilliput_coops, jdk8_coops_align16,     jdk15_coops_align16);\n+            printLine(msg_coops_align32,    rawSize, jdkLilliput_coops_align32,    jdkLilliput_coops, jdk8_coops_align32,     jdk15_coops_align32);\n+            printLine(msg_coops_align64,    rawSize, jdkLilliput_coops_align64,    jdkLilliput_coops, jdk8_coops_align64,     jdk15_coops_align64);\n+            printLine(msg_coops_align128,   rawSize, jdkLilliput_coops_align128,   jdkLilliput_coops, jdk8_coops_align128,    jdk15_coops_align128);\n+            printLine(msg_coops_align256,   rawSize, jdkLilliput_coops_align256,   jdkLilliput_coops, jdk8_coops_align256,    jdk15_coops_align256);\n@@ -194,1 +193,1 @@\n-        out.println(\"=== Experimental 64-bit OpenJDK: Lilliput, 64-bit headers, array base improvements\");\n+        out.println(\"=== Experimental 64-bit OpenJDK (Prototype): Lilliput 2 (32-bit headers)\");\n@@ -197,7 +196,7 @@\n-        long jdkLilliput_base_noCoops =          computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(false,  8,  4, false), 99));\n-        long jdkLilliput_base_coops =            computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,   8,  4, false), 99));\n-        long jdkLilliput_base_coops_align16 =    computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  16,  4, false), 99));\n-        long jdkLilliput_base_coops_align32 =    computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  32,  4, false), 99));\n-        long jdkLilliput_base_coops_align64 =    computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  64,  4, false), 99));\n-        long jdkLilliput_base_coops_align128 =   computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true, 128,  4, false), 99));\n-        long jdkLilliput_base_coops_align256 =   computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true, 256,  4, false), 99));\n+        long jdkLilliput32_noCoops =        computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(false,  8,   2), 99));\n+        long jdkLilliput32_coops =          computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,   8,   2), 99));\n+        long jdkLilliput32_coops_align16 =  computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  16,   2), 99));\n+        long jdkLilliput32_coops_align32 =  computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  32,   2), 99));\n+        long jdkLilliput32_coops_align64 =  computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  64,   2), 99));\n+        long jdkLilliput32_coops_align128 = computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true, 128,   2), 99));\n+        long jdkLilliput32_coops_align256 = computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true, 256,   2), 99));\n@@ -208,28 +207,1 @@\n-                    \"Footprint\", \"Overhead\", \"JVM Mode\", \"JDK < 15\", \"JDK >= 15\", \"Lill-64\", \"Description\"\n-            );\n-\n-            printLine(msg_noCoops_ccp,      rawSize, jdkLilliput_base_noCoops,          jdkLilliput_base_coops, jdk8_noCoops,           jdk15_noCoops,          jdkLilliput_noBase_noCoops);\n-            printLine(msg_coops,            rawSize, jdkLilliput_base_coops,            jdkLilliput_base_coops, jdk8_coops,             jdk15_coops,            jdkLilliput_noBase_coops);\n-            printLine(msg_coops_align16,    rawSize, jdkLilliput_base_coops_align16,    jdkLilliput_base_coops, jdk8_coops_align16,     jdk15_coops_align16,    jdkLilliput_noBase_coops_align16);\n-            printLine(msg_coops_align32,    rawSize, jdkLilliput_base_coops_align32,    jdkLilliput_base_coops, jdk8_coops_align32,     jdk15_coops_align32,    jdkLilliput_noBase_coops_align32);\n-            printLine(msg_coops_align64,    rawSize, jdkLilliput_base_coops_align64,    jdkLilliput_base_coops, jdk8_coops_align64,     jdk15_coops_align64,    jdkLilliput_noBase_coops_align64);\n-            printLine(msg_coops_align128,   rawSize, jdkLilliput_base_coops_align128,   jdkLilliput_base_coops, jdk8_coops_align128,    jdk15_coops_align128,   jdkLilliput_noBase_coops_align128);\n-            printLine(msg_coops_align256,   rawSize, jdkLilliput_base_coops_align256,   jdkLilliput_base_coops, jdk8_coops_align256,    jdk15_coops_align256,   jdkLilliput_noBase_coops_align256);\n-        }\n-        out.println();\n-\n-        out.println(\"=== Experimental 64-bit OpenJDK: Lilliput, 32-bit headers\");\n-        out.println();\n-\n-        long jdkLilliput32_noCoops =        computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(false,  8, 8, true), 99));\n-        long jdkLilliput32_coops =          computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,   8, 8, true), 99));\n-        long jdkLilliput32_coops_align16 =  computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  16, 8, true), 99));\n-        long jdkLilliput32_coops_align32 =  computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  32, 8, true), 99));\n-        long jdkLilliput32_coops_align64 =  computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true,  64, 8, true), 99));\n-        long jdkLilliput32_coops_align128 = computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true, 128, 8, true), 99));\n-        long jdkLilliput32_coops_align256 = computeWithLayouter(data, new HotSpotLayouter(new Model64_Lilliput(true, 256, 8, true), 99));\n-\n-        {\n-            out.printf(\"%37s %s%n\", \"\", \"Upgrade From:\");\n-            out.printf(\"%10s, %10s, %10s, %10s, %10s, %10s, %10s,     %s%n\",\n-                    \"Footprint\", \"Overhead\", \"JVM Mode\", \"JDK < 15\", \"JDK >= 15\", \"Lill-64\", \"Lill-64-AB\", \"Description\"\n+                    \"Footprint\", \"Overhead\", \"JVM Mode\", \"JDK < 15\", \"JDK >= 15\", \"Lilliput 1\", \"Description\"\n@@ -238,7 +210,7 @@\n-            printLine(msg_noCoops_ccp,    rawSize,  jdkLilliput32_noCoops,        jdkLilliput32_coops, jdk8_noCoops,          jdk15_noCoops,          jdkLilliput_noBase_noCoops,         jdkLilliput_base_noCoops);\n-            printLine(msg_coops,          rawSize,  jdkLilliput32_coops,          jdkLilliput32_coops, jdk8_coops,            jdk15_coops,            jdkLilliput_noBase_coops,           jdkLilliput_base_coops);\n-            printLine(msg_coops_align16,  rawSize,  jdkLilliput32_coops_align16,  jdkLilliput32_coops, jdk8_coops_align16,    jdk15_coops_align16,    jdkLilliput_noBase_coops_align16,   jdkLilliput_base_coops_align16);\n-            printLine(msg_coops_align32,  rawSize,  jdkLilliput32_coops_align32,  jdkLilliput32_coops, jdk8_coops_align32,    jdk15_coops_align32,    jdkLilliput_noBase_coops_align32,   jdkLilliput_base_coops_align32);\n-            printLine(msg_coops_align64,  rawSize,  jdkLilliput32_coops_align64,  jdkLilliput32_coops, jdk8_coops_align64,    jdk15_coops_align64,    jdkLilliput_noBase_coops_align64,   jdkLilliput_base_coops_align64);\n-            printLine(msg_coops_align128, rawSize,  jdkLilliput32_coops_align128, jdkLilliput32_coops, jdk8_coops_align256,   jdk15_coops_align128,   jdkLilliput_noBase_coops_align128,  jdkLilliput_base_coops_align128);\n-            printLine(msg_coops_align256, rawSize,  jdkLilliput32_coops_align256, jdkLilliput32_coops, jdk8_coops_align256,   jdk15_coops_align256,   jdkLilliput_noBase_coops_align256,  jdkLilliput_base_coops_align256);\n+            printLine(msg_noCoops_ccp,    rawSize,  jdkLilliput32_noCoops,        jdkLilliput32_coops, jdk8_noCoops,          jdk15_noCoops,          jdkLilliput_noCoops);\n+            printLine(msg_coops,          rawSize,  jdkLilliput32_coops,          jdkLilliput32_coops, jdk8_coops,            jdk15_coops,            jdkLilliput_coops);\n+            printLine(msg_coops_align16,  rawSize,  jdkLilliput32_coops_align16,  jdkLilliput32_coops, jdk8_coops_align16,    jdk15_coops_align16,    jdkLilliput_coops_align16);\n+            printLine(msg_coops_align32,  rawSize,  jdkLilliput32_coops_align32,  jdkLilliput32_coops, jdk8_coops_align32,    jdk15_coops_align32,    jdkLilliput_coops_align32);\n+            printLine(msg_coops_align64,  rawSize,  jdkLilliput32_coops_align64,  jdkLilliput32_coops, jdk8_coops_align64,    jdk15_coops_align64,    jdkLilliput_coops_align64);\n+            printLine(msg_coops_align128, rawSize,  jdkLilliput32_coops_align128, jdkLilliput32_coops, jdk8_coops_align128,   jdk15_coops_align128,   jdkLilliput_coops_align128);\n+            printLine(msg_coops_align256, rawSize,  jdkLilliput32_coops_align256, jdkLilliput32_coops, jdk8_coops_align256,   jdk15_coops_align256,   jdkLilliput_coops_align256);\n","filename":"jol-cli\/src\/main\/java\/org\/openjdk\/jol\/operations\/HeapDumpEstimates.java","additions":34,"deletions":62,"binary":false,"changes":96,"status":"modified"},{"patch":"@@ -67,0 +67,1 @@\n+            layouters.add(new HotSpotLayouter(model, 23));\n","filename":"jol-cli\/src\/main\/java\/org\/openjdk\/jol\/operations\/ObjectInternalsEstimates.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -83,1 +83,1 @@\n-     * Return the minimal alignment for array bases.\n+     * Machine address size.\n@@ -85,1 +85,1 @@\n-     * @return minimal array base alignment\n+     * @return machine address size, in bytes\n@@ -87,1 +87,2 @@\n-    int arrayBaseAlignment();\n+    int addressSize();\n+\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/datamodel\/DataModel.java","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -97,2 +97,1 @@\n-    public int arrayBaseAlignment() {\n-        \/\/ Can be just address size\n+    public int addressSize() {\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/datamodel\/Model32.java","additions":1,"deletions":2,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -46,4 +46,0 @@\n-    public Model64(boolean compressedRefs, boolean compressedClasses) {\n-        this(compressedRefs, compressedClasses, 8);\n-    }\n-\n@@ -101,1 +97,1 @@\n-    public int arrayBaseAlignment() {\n+    public int addressSize() {\n@@ -110,1 +106,1 @@\n-                \", \" + align + \"-byte aligned\";\n+                \", \" + align + \"-byte aligned objects\";\n@@ -115,6 +111,2 @@\n-        if (this == o) {\n-            return true;\n-        }\n-        if (o == null || getClass() != o.getClass()) {\n-            return false;\n-        }\n+        if (this == o) return true;\n+        if (o == null || getClass() != o.getClass()) return false;\n@@ -122,1 +114,3 @@\n-        return align == model64.align;\n+        return align == model64.align &&\n+                compRefs == model64.compRefs &&\n+                compKlass == model64.compKlass;\n@@ -127,1 +121,1 @@\n-        return Objects.hash(align);\n+        return Objects.hash(align, compRefs, compKlass);\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/datamodel\/Model64.java","additions":8,"deletions":14,"binary":false,"changes":22,"status":"modified"},{"patch":"@@ -27,0 +27,2 @@\n+import java.util.Objects;\n+\n@@ -35,1 +37,0 @@\n-    private final int arrayBaseAlign;\n@@ -37,5 +38,1 @@\n-    private final boolean target;\n-\n-    public Model64_Lilliput() {\n-        this(false, 8, 8, false);\n-    }\n+    private final int version;\n@@ -43,1 +40,1 @@\n-    public Model64_Lilliput(boolean compRefs, int align, int arrayBaseAlign, boolean target) {\n+    public Model64_Lilliput(boolean compRefs, int align, int version) {\n@@ -46,2 +43,1 @@\n-        this.arrayBaseAlign = target ? 4 : arrayBaseAlign;\n-        this.target = target;\n+        this.version = version;\n@@ -52,1 +48,1 @@\n-        return target ? 1 : 8;\n+        return (version >= 2) ? 1 : 8;\n@@ -57,1 +53,1 @@\n-        return target ? 3 : 0;\n+        return (version >= 2) ? 3 : 0;\n@@ -101,2 +97,2 @@\n-    public int arrayBaseAlignment() {\n-        return arrayBaseAlign;\n+    public int addressSize() {\n+        return 8;\n@@ -108,1 +104,1 @@\n-                \", Lilliput (\" + (target ? \"ultimate target\" : \"current experiment\") + \")\" +\n+                \", Lilliput \" + (version >= 2 ? \"2 (32-bit headers)\" : \"1 (64-bit headers)\") +\n@@ -119,1 +115,1 @@\n-        return align == that.align;\n+        return align == that.align && compRefs == that.compRefs && version == that.version;\n@@ -124,1 +120,1 @@\n-        return align;\n+        return Objects.hash(align, compRefs, version);\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/datamodel\/Model64_Lilliput.java","additions":12,"deletions":16,"binary":false,"changes":28,"status":"modified"},{"patch":"@@ -76,10 +76,0 @@\n-    int arrayBaseAlignment;\n-\n-    private static int guessArrayBaseAlignment(String type) {\n-        int byteOff = VM.current().arrayBaseOffset(type);\n-        if ((byteOff % 8) == 0) return 8;\n-        if ((byteOff % 4) == 0) return 4;\n-        if ((byteOff % 2) == 0) return 2;\n-        return 1;\n-    }\n-\n@@ -87,17 +77,2 @@\n-    public int arrayBaseAlignment() {\n-        if (arrayBaseAlignment != 0) {\n-            return arrayBaseAlignment;\n-        }\n-        int al = Integer.MAX_VALUE;\n-        al = Math.min(al, guessArrayBaseAlignment(\"boolean\"));\n-        al = Math.min(al, guessArrayBaseAlignment(\"byte\"));\n-        al = Math.min(al, guessArrayBaseAlignment(\"short\"));\n-        al = Math.min(al, guessArrayBaseAlignment(\"char\"));\n-        al = Math.min(al, guessArrayBaseAlignment(\"int\"));\n-        al = Math.min(al, guessArrayBaseAlignment(\"float\"));\n-        al = Math.min(al, guessArrayBaseAlignment(\"long\"));\n-        al = Math.min(al, guessArrayBaseAlignment(\"double\"));\n-        al = Math.min(al, guessArrayBaseAlignment(\"Object\"));\n-        arrayBaseAlignment = al;\n-\n-        return al;\n+    public int addressSize() {\n+        return VM.current().addressSize();\n@@ -111,2 +86,1 @@\n-                (objectAlignment() + \"-byte aligned objects, \") +\n-                (arrayBaseAlignment() + \"-byte aligned array bases\");\n+                (objectAlignment() + \"-byte aligned objects\");\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/datamodel\/ModelVM.java","additions":3,"deletions":29,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -82,3 +82,4 @@\n-            \/\/ Array bases are aligned by HeapWord size:\n-            \/\/  https:\/\/bugs.openjdk.java.net\/browse\/JDK-8139457\n-            base = MathUtil.align(base, Math.max(model.arrayBaseAlignment(), scale));\n+            \/\/ Array bases are aligned by HeapWord size in older JDKs\n+            \/\/  https:\/\/bugs.openjdk.org\/browse\/JDK-8139457\n+            int minArrayBaseAlignment = (jdkVersion >= 23) ? 4 : model.addressSize();\n+            base = MathUtil.align(base, Math.max(minArrayBaseAlignment, scale));\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/layouters\/HotSpotLayouter.java","additions":4,"deletions":3,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -73,2 +73,2 @@\n-            new Model64(false, false),\n-            new Model64(true, true),\n+            new Model64(false, false, 8),\n+            new Model64(true, true, 8),\n@@ -79,1 +79,1 @@\n-            new Model64(false, true),\n+            new Model64(false, true, 8),\n","filename":"jol-samples\/src\/main\/java\/org\/openjdk\/jol\/samples\/JOLSample_10_DataModels.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"}]}