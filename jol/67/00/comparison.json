{"files":[{"patch":"@@ -19,1 +19,1 @@\n-        java: [8, 11, 17, 21]\n+        java: [8, 11, 17, 21, 25]\n","filename":".github\/workflows\/pre-integration.yml","additions":1,"deletions":1,"binary":false,"changes":2,"status":"modified"},{"patch":"@@ -68,0 +68,1 @@\n+            layouters.add(new HotSpotLayouter(model, 25));\n","filename":"jol-cli\/src\/main\/java\/org\/openjdk\/jol\/operations\/ObjectInternalsEstimates.java","additions":1,"deletions":0,"binary":false,"changes":1,"status":"modified"},{"patch":"@@ -84,0 +84,12 @@\n+                    <execution>\n+                        <id>tests-mof<\/id>\n+                        <phase>test<\/phase>\n+                        <goals>\n+                            <goal>test<\/goal>\n+                        <\/goals>\n+                        <configuration>\n+                            <argLine>-Djol.magicFieldOffset=true<\/argLine>\n+                            <forkCount>4<\/forkCount>\n+                            <reuseForks>true<\/reuseForks>\n+                        <\/configuration>\n+                    <\/execution>\n@@ -400,0 +412,112 @@\n+        <profile>\n+            <id>lilliput-tests<\/id>\n+            <activation>\n+                <jdk>[25,)<\/jdk>\n+            <\/activation>\n+            <build>\n+                <plugins>\n+                    <plugin>\n+                        <groupId>org.apache.maven.plugins<\/groupId>\n+                        <artifactId>maven-surefire-plugin<\/artifactId>\n+                        <executions>\n+                            <execution>\n+                                <id>tests-1g-minus-coops-plus-ucoh<\/id>\n+                                <phase>test<\/phase>\n+                                <goals>\n+                                    <goal>test<\/goal>\n+                                <\/goals>\n+                                <configuration>\n+                                    <argLine>-Xmx1g -XX:-UseCompressedOops -XX:+UseCompactObjectHeaders<\/argLine>\n+                                    <forkCount>4<\/forkCount>\n+                                    <reuseForks>true<\/reuseForks>\n+                                <\/configuration>\n+                            <\/execution>\n+                            <execution>\n+                                <id>tests-1g-minus-coops-plus-ucoh-align16<\/id>\n+                                <phase>test<\/phase>\n+                                <goals>\n+                                    <goal>test<\/goal>\n+                                <\/goals>\n+                                <configuration>\n+                                    <argLine>-Xmx1g -XX:-UseCompressedOops -XX:ObjectAlignmentInBytes=16 -XX:+UseCompactObjectHeaders<\/argLine>\n+                                    <forkCount>4<\/forkCount>\n+                                    <reuseForks>true<\/reuseForks>\n+                                <\/configuration>\n+                            <\/execution>\n+                            <execution>\n+                                <id>tests-1g-plus-coops-plus-ucoh<\/id>\n+                                <phase>test<\/phase>\n+                                <goals>\n+                                    <goal>test<\/goal>\n+                                <\/goals>\n+                                <configuration>\n+                                    <argLine>-Xmx1g -XX:+UseCompressedOops -XX:+UseCompactObjectHeaders<\/argLine>\n+                                    <forkCount>4<\/forkCount>\n+                                    <reuseForks>true<\/reuseForks>\n+                                <\/configuration>\n+                            <\/execution>\n+                            <execution>\n+                                <id>tests-1g-plus-coops-plus-ucoh-align16<\/id>\n+                                <phase>test<\/phase>\n+                                <goals>\n+                                    <goal>test<\/goal>\n+                                <\/goals>\n+                                <configuration>\n+                                    <argLine>-Xmx1g -XX:+UseCompressedOops -XX:ObjectAlignmentInBytes=16 -XX:+UseCompactObjectHeaders<\/argLine>\n+                                    <forkCount>4<\/forkCount>\n+                                    <reuseForks>true<\/reuseForks>\n+                                <\/configuration>\n+                            <\/execution>\n+                            <execution>\n+                                <id>tests-4g-minus-coops-plus-ucoh<\/id>\n+                                <phase>test<\/phase>\n+                                <goals>\n+                                    <goal>test<\/goal>\n+                                <\/goals>\n+                                <configuration>\n+                                    <argLine>-Xmx4g -XX:-UseCompressedOops -XX:+UseCompactObjectHeaders<\/argLine>\n+                                    <forkCount>1<\/forkCount>\n+                                    <reuseForks>true<\/reuseForks>\n+                                <\/configuration>\n+                            <\/execution>\n+                            <execution>\n+                                <id>tests-4g-minus-coops-plus-ucoh-align16<\/id>\n+                                <phase>test<\/phase>\n+                                <goals>\n+                                    <goal>test<\/goal>\n+                                <\/goals>\n+                                <configuration>\n+                                    <argLine>-Xmx4g -XX:-UseCompressedOops -XX:ObjectAlignmentInBytes=16 -XX:+UseCompactObjectHeaders<\/argLine>\n+                                    <forkCount>1<\/forkCount>\n+                                    <reuseForks>true<\/reuseForks>\n+                                <\/configuration>\n+                            <\/execution>\n+                            <execution>\n+                                <id>tests-4g-plus-coops-plus-ucoh<\/id>\n+                                <phase>test<\/phase>\n+                                <goals>\n+                                    <goal>test<\/goal>\n+                                <\/goals>\n+                                <configuration>\n+                                    <argLine>-Xmx4g -XX:+UseCompressedOops -XX:+UseCompactObjectHeaders<\/argLine>\n+                                    <forkCount>1<\/forkCount>\n+                                    <reuseForks>true<\/reuseForks>\n+                                <\/configuration>\n+                            <\/execution>\n+                            <execution>\n+                                <id>tests-4g-plus-coops-plus-ucoh-align16<\/id>\n+                                <phase>test<\/phase>\n+                                <goals>\n+                                    <goal>test<\/goal>\n+                                <\/goals>\n+                                <configuration>\n+                                    <argLine>-Xmx4g -XX:+UseCompressedOops -XX:ObjectAlignmentInBytes=16 -XX:+UseCompactObjectHeaders<\/argLine>\n+                                    <forkCount>1<\/forkCount>\n+                                    <reuseForks>true<\/reuseForks>\n+                                <\/configuration>\n+                            <\/execution>\n+                        <\/executions>\n+                    <\/plugin>\n+                <\/plugins>\n+            <\/build>\n+        <\/profile>\n","filename":"jol-core\/pom.xml","additions":124,"deletions":0,"binary":false,"changes":124,"status":"modified"},{"patch":"@@ -110,2 +110,3 @@\n-        for (String k : hierarchy) {\n-            Collection<FieldData> fields = cd.fieldsFor(k);\n+        \/\/ Ref fields are clustered together in more modern JDKs:\n+        \/\/  https:\/\/bugs.openjdk.org\/browse\/JDK-8353273\n+        boolean clusterOops = (jdkVersion >= 25);\n@@ -113,30 +114,4 @@\n-            SortedSet<FieldLayout> current = new TreeSet<>();\n-            for (int size : new int[]{8, 4, 2, 1}) {\n-                for (FieldData f : fields) {\n-                    if (!f.isPrimitive()) continue;\n-                    int fSize = model.sizeOf(f.typeClass());\n-                    if (fSize != size) continue;\n-\n-                    for (int t = 0; t < Integer.MAX_VALUE; t++) {\n-                        if (claimed.get(t * size, (t + 1) * size).isEmpty()) {\n-                            claimed.set(t * size, (t + 1) * size);\n-                            current.add(new FieldLayout(f, t * size, size));\n-                            break;\n-                        }\n-                    }\n-                }\n-            }\n-            for (int size : new int[]{8, 4, 2, 1}) {\n-                for (FieldData f : fields) {\n-                    if (f.isPrimitive()) continue;\n-                    int fSize = model.sizeOf(f.typeClass());\n-                    if (fSize != size) continue;\n-\n-                    for (int t = 0; t < Integer.MAX_VALUE; t++) {\n-                        if (claimed.get(t * size, (t + 1) * size).isEmpty()) {\n-                            claimed.set(t * size, (t + 1) * size);\n-                            current.add(new FieldLayout(f, t * size, size));\n-                            break;\n-                        }\n-                    }\n-                }\n+        for (String k : hierarchy) {\n+            boolean refsFirst = false;\n+            if (clusterOops && !result.isEmpty()) {\n+                refsFirst = !result.last().data().isPrimitive();\n@@ -144,1 +119,4 @@\n-            result.addAll(current);\n+\n+            Collection<FieldData> fields = cd.fieldsFor(k);\n+            newLayouterWork(fields, claimed, result,  refsFirst);\n+            newLayouterWork(fields, claimed, result, !refsFirst);\n@@ -152,0 +130,17 @@\n+    private void newLayouterWork(Collection<FieldData> fields, BitSet claimed, SortedSet<FieldLayout> result, boolean doRefs) {\n+        for (int size : new int[]{8, 4, 2, 1}) {\n+            for (FieldData f : fields) {\n+                if (doRefs == f.isPrimitive()) continue;\n+                int fSize = model.sizeOf(f.typeClass());\n+                if (fSize != size) continue;\n+                for (int t = 0; t < Integer.MAX_VALUE; t++) {\n+                    if (claimed.get(t * size, (t + 1) * size).isEmpty()) {\n+                        claimed.set(t * size, (t + 1) * size);\n+                        result.add(new FieldLayout(f, t * size, size));\n+                        break;\n+                    }\n+                }\n+            }\n+        }\n+    }\n+\n","filename":"jol-core\/src\/main\/java\/org\/openjdk\/jol\/layouters\/HotSpotLayouter.java","additions":28,"deletions":33,"binary":false,"changes":61,"status":"modified"},{"patch":"@@ -0,0 +1,16 @@\n+package org.openjdk.jol;\n+\n+public class TestUtils {\n+\n+    public static final int JDK_VERSION = getVersion();\n+\n+    private static int getVersion() {\n+        try {\n+            return Integer.parseInt(System.getProperty(\"java.specification.version\"));\n+        } catch (Exception e) {\n+            \/\/ Assume JDK 8\n+            return 8;\n+        }\n+    }\n+\n+}\n","filename":"jol-core\/src\/test\/java\/org\/openjdk\/jol\/TestUtils.java","additions":16,"deletions":0,"binary":false,"changes":16,"status":"added"},{"patch":"@@ -3,0 +3,2 @@\n+import org.junit.Assume;\n+import org.junit.Before;\n@@ -4,0 +6,1 @@\n+import org.openjdk.jol.TestUtils;\n@@ -7,0 +10,5 @@\n+    @Before\n+    public void beforeMethod() {\n+        Assume.assumeTrue(TestUtils.JDK_VERSION < 25 || (System.getProperty(\"jol.magicFieldOffset\") != null));\n+    }\n+\n","filename":"jol-core\/src\/test\/java\/org\/openjdk\/jol\/info\/ClassLayoutPrivatesTest.java","additions":8,"deletions":0,"binary":false,"changes":8,"status":"modified"},{"patch":"@@ -0,0 +1,98 @@\n+package org.openjdk.jol.layouters;\n+\n+import org.junit.Assert;\n+import org.junit.Test;\n+import org.openjdk.jol.datamodel.ModelVM;\n+import org.openjdk.jol.info.ClassData;\n+import org.openjdk.jol.info.ClassLayout;\n+import org.openjdk.jol.util.ClassGenerator;\n+\n+import java.util.Random;\n+\n+public class HotspotLayouterCompactTest {\n+\n+    \/\/ We expect this test to never realistically fail, as failure\n+    \/\/ would point to JDK issue, not JOL bug. Therefore, run with fewer iterations.\n+    private static final int ITERATIONS = 5000;\n+\n+    @Test\n+    public void testSingleClass() throws Exception {\n+        tryWithClasses(1, 5);\n+    }\n+\n+    @Test\n+    public void testTwoClasses() throws Exception {\n+        tryWithClasses(2, 5);\n+    }\n+\n+    @Test\n+    public void testThreeClasses() throws Exception {\n+        tryWithClasses(3, 6);\n+    }\n+\n+    @Test\n+    public void testArrays() {\n+        for (int c = 0; c < 128; c++) {\n+            tryWithArrays(new boolean[c]);\n+            tryWithArrays(new byte[c]);\n+            tryWithArrays(new char[c]);\n+            tryWithArrays(new int[c]);\n+            tryWithArrays(new float[c]);\n+            tryWithArrays(new long[c]);\n+            tryWithArrays(new double[c]);\n+            tryWithArrays(new Object[c]);\n+        }\n+    }\n+\n+    public void tryWithArrays(Object array) {\n+        ClassLayout actual = ClassLayout.parseInstance(array);\n+        ClassData cd = ClassData.parseInstance(array);\n+\n+        HotSpotLayouter layouter8  = new HotSpotLayouter(new ModelVM(), 8);\n+        HotSpotLayouter layouter15 = new HotSpotLayouter(new ModelVM(), 15);\n+        HotSpotLayouter layouter23 = new HotSpotLayouter(new ModelVM(), 23);\n+        HotSpotLayouter layouter25 = new HotSpotLayouter(new ModelVM(), 25);\n+\n+        ClassLayout layout8  = layouter8.layout(cd);\n+        ClassLayout layout15 = layouter15.layout(cd);\n+        ClassLayout layout23 = layouter23.layout(cd);\n+        ClassLayout layout25 = layouter25.layout(cd);\n+\n+        Assert.assertTrue(\"JDK 15 is better than JDK 8: \\n\" + layout15 + \"\\n\" + layout8,\n+                layout15.instanceSize() <= layout8.instanceSize());\n+        Assert.assertTrue(\"JDK 23 is better than JDK 15: \\n\" + layout23 + \"\\n\" + layout15,\n+                layout23.instanceSize() <= layout15.instanceSize());\n+        Assert.assertTrue(\"JDK 25 is better than JDK 23: \\n\" + layout25 + \"\\n\" + layout23,\n+                layout25.instanceSize() <= layout23.instanceSize());\n+    }\n+\n+    public void tryWithClasses(int hierarchyDepth, int fieldsPerClass) throws Exception {\n+        Random seeder = new Random();\n+\n+        for (int c = 0; c < ITERATIONS; c++) {\n+            int seed = seeder.nextInt();\n+            Class<?> cl = ClassGenerator.generate(new Random(seed), hierarchyDepth, fieldsPerClass);\n+\n+            ClassLayout actual = ClassLayout.parseClass(cl);\n+            ClassData cd = ClassData.parseClass(cl);\n+\n+            HotSpotLayouter layouter8  = new HotSpotLayouter(new ModelVM(), 8);\n+            HotSpotLayouter layouter15 = new HotSpotLayouter(new ModelVM(), 15);\n+            HotSpotLayouter layouter23 = new HotSpotLayouter(new ModelVM(), 23);\n+            HotSpotLayouter layouter25 = new HotSpotLayouter(new ModelVM(), 25);\n+\n+            ClassLayout layout8  = layouter8.layout(cd);\n+            ClassLayout layout15 = layouter15.layout(cd);\n+            ClassLayout layout23 = layouter23.layout(cd);\n+            ClassLayout layout25 = layouter25.layout(cd);\n+\n+            Assert.assertTrue(\"JDK 15 is better than JDK 8: \\n\" + layout15 + \"\\n\" + layout8,\n+                    layout15.instanceSize() <= layout8.instanceSize());\n+            Assert.assertTrue(\"JDK 23 is better than JDK 15: \\n\" + layout23 + \"\\n\" + layout15,\n+                    layout23.instanceSize() <= layout15.instanceSize());\n+            Assert.assertTrue(\"JDK 25 is better than JDK 23: \\n\" + layout25 + \"\\n\" + layout23,\n+                    layout25.instanceSize() <= layout23.instanceSize());\n+        }\n+    }\n+\n+}\n","filename":"jol-core\/src\/test\/java\/org\/openjdk\/jol\/layouters\/HotspotLayouterCompactTest.java","additions":98,"deletions":0,"binary":false,"changes":98,"status":"added"},{"patch":"@@ -4,0 +4,1 @@\n+import org.junit.Ignore;\n@@ -5,0 +6,1 @@\n+import org.openjdk.jol.TestUtils;\n@@ -17,8 +19,0 @@\n-    private int getVersion() {\n-        try {\n-            return Integer.parseInt(System.getProperty(\"java.specification.version\"));\n-        } catch (Exception e) {\n-            return -1;\n-        }\n-    }\n-\n@@ -27,1 +21,1 @@\n-        tryWithClasses(1, 5, getVersion());\n+        tryWithClasses(1, 5);\n@@ -32,1 +26,6 @@\n-        tryWithClasses(2, 5, getVersion());\n+        tryWithClasses(2, 5);\n+    }\n+\n+    @Test\n+    public void testThreeClasses() throws Exception {\n+        tryWithClasses(3, 6);\n@@ -37,1 +36,0 @@\n-        int version = getVersion();\n@@ -39,8 +37,8 @@\n-            tryWithArrays(new boolean[c], version);\n-            tryWithArrays(new byte[c],    version);\n-            tryWithArrays(new char[c],    version);\n-            tryWithArrays(new int[c],     version);\n-            tryWithArrays(new float[c],   version);\n-            tryWithArrays(new long[c],    version);\n-            tryWithArrays(new double[c],  version);\n-            tryWithArrays(new Object[c],  version);\n+            tryWithArrays(new boolean[c]);\n+            tryWithArrays(new byte[c]);\n+            tryWithArrays(new char[c]);\n+            tryWithArrays(new int[c]);\n+            tryWithArrays(new float[c]);\n+            tryWithArrays(new long[c]);\n+            tryWithArrays(new double[c]);\n+            tryWithArrays(new Object[c]);\n@@ -50,1 +48,1 @@\n-    public void tryWithArrays(Object array, int jdkVersion) {\n+    public void tryWithArrays(Object array) {\n@@ -54,1 +52,1 @@\n-        HotSpotLayouter layouter = new HotSpotLayouter(new ModelVM(), jdkVersion);\n+        HotSpotLayouter layouter = new HotSpotLayouter(new ModelVM(), TestUtils.JDK_VERSION);\n@@ -63,1 +61,1 @@\n-    public void tryWithClasses(int hierarchyDepth, int fieldsPerClass, int jdkVersion) throws Exception {\n+    public void tryWithClasses(int hierarchyDepth, int fieldsPerClass) throws Exception {\n@@ -65,1 +63,1 @@\n-        HotSpotLayouter layouter = new HotSpotLayouter(new ModelVM(), jdkVersion);\n+        HotSpotLayouter layouter = new HotSpotLayouter(new ModelVM(), TestUtils.JDK_VERSION);\n","filename":"jol-core\/src\/test\/java\/org\/openjdk\/jol\/layouters\/HotspotLayouterRealTest.java","additions":21,"deletions":23,"binary":false,"changes":44,"status":"modified"},{"patch":"@@ -12,0 +12,2 @@\n+import java.util.ArrayList;\n+import java.util.List;\n@@ -65,11 +67,7 @@\n-    public void testHotspot_Old() {\n-        for (int c = 0; c < ITERATIONS; c++) {\n-            ClassData cd = ClassData.parseClass(CLS[c]);\n-            try {\n-                for (DataModel model : MODELS) {\n-                    HotSpotLayouter layouter = new HotSpotLayouter(model, 8);\n-                    layouter.layout(cd);\n-                }\n-            } catch (Exception e) {\n-                Assert.fail(\"Failed. Seed = \" + SEEDS[c]);\n-            }\n+    public void testHotspot() {\n+        List<Layouter> layouters = new ArrayList<>();\n+        for (DataModel model : MODELS) {\n+            layouters.add(new HotSpotLayouter(model, 8));\n+            layouters.add(new HotSpotLayouter(model, 15));\n+            layouters.add(new HotSpotLayouter(model, 23));\n+            layouters.add(new HotSpotLayouter(model, 25));\n@@ -77,4 +75,0 @@\n-    }\n-\n-    @Test\n-    public void testHotspot_New() {\n@@ -84,2 +78,1 @@\n-                for (DataModel model : MODELS) {\n-                    HotSpotLayouter layouter = new HotSpotLayouter(model, 15);\n+                for (Layouter layouter : layouters) {\n","filename":"jol-core\/src\/test\/java\/org\/openjdk\/jol\/layouters\/LayouterInvariantsTest.java","additions":10,"deletions":17,"binary":false,"changes":27,"status":"modified"}]}