{"files":[{"patch":"@@ -291,1 +291,2 @@\n-        java.naming;\n+        java.naming,\n+        jdk.jartool;\n","filename":"src\/java.base\/share\/classes\/module-info.java","additions":2,"deletions":1,"binary":false,"changes":3,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2009, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2009, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -134,1 +134,1 @@\n-     *             JAR timestamp if jar files are being validated and the\n+     *             timestamp if JAR files are being validated and the\n@@ -163,1 +163,1 @@\n-     * {@code PKIXParameter} date, and {@code varient}\n+     * {@code PKIXParameter} date, and {@code variant}.\n@@ -167,2 +167,4 @@\n-     * @param pkixdate Date the constraints are checked against. The value is\n-     *             either the PKIXParameters date or null for the current date.\n+     * @param date the date specified by the PKIXParameters date, or the\n+     *             timestamp if JAR files are being validated and the\n+     *             JAR is timestamped. May be null if no timestamp or\n+     *             PKIXParameter date is set.\n@@ -172,2 +174,2 @@\n-    public AlgorithmChecker(TrustAnchor anchor, Date pkixdate, String variant) {\n-        this(anchor, certPathDefaultConstraints, pkixdate, variant);\n+    public AlgorithmChecker(TrustAnchor anchor, Date date, String variant) {\n+        this(anchor, certPathDefaultConstraints, date, variant);\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/certpath\/AlgorithmChecker.java","additions":9,"deletions":7,"binary":false,"changes":16,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -42,1 +42,1 @@\n-class CertPathConstraintsParameters implements ConstraintsParameters {\n+public class CertPathConstraintsParameters implements ConstraintsParameters {\n@@ -106,1 +106,1 @@\n-        sb.append(\"\\n  Variant: \").append(variant);\n+        sb.append(\"  Variant: \").append(variant);\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/certpath\/CertPathConstraintsParameters.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -91,0 +91,1 @@\n+        private Date timestampDate;\n@@ -157,0 +158,5 @@\n+        \/\/ The date() param is used when enforcing the validity period\n+        \/\/ of certificates and when checking the time period of revocation data.\n+        \/\/ The main difference between the date() and timestamp() method is\n+        \/\/ that the date() method only uses the timestamp (if specified)\n+        \/\/ for certificates in a code signer's chain.\n@@ -159,2 +165,7 @@\n-                \/\/ use timestamp if checking signed code that is\n-                \/\/ timestamped, otherwise use date parameter\n+                \/\/ Use timestamp if checking signed code that is\n+                \/\/ timestamped, otherwise use date parameter.\n+                \/\/ Note that TSA server certificates do not use the\n+                \/\/ timestamp, which means that an expired TSA certificate\n+                \/\/ is considered a validation failure. This policy means\n+                \/\/ that signed and timestamped code is valid until the TSA\n+                \/\/ certificate expires (assuming all other checks are valid).\n@@ -213,0 +224,11 @@\n+        \/\/ The timestamp() param is passed as the date param when creating an\n+        \/\/ AlgorithmChecker. An AlgorithmChecker always uses the timestamp\n+        \/\/ if specified in order to enforce the denyAfter constraint.\n+        Date timestamp() {\n+            \/\/ return timestamp date if set, otherwise use date parameter\n+            if (timestampDate == null) {\n+                timestampDate = (timestamp != null)\n+                    ? timestamp.getTimestamp() : date();\n+            }\n+            return timestampDate;\n+        }\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/certpath\/PKIX.java","additions":24,"deletions":2,"binary":false,"changes":26,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -179,2 +179,2 @@\n-        certPathCheckers.add(new AlgorithmChecker(anchor, null, params.date(),\n-                params.variant()));\n+        certPathCheckers.add(new AlgorithmChecker(anchor, null,\n+                params.timestamp(), params.variant()));\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/certpath\/PKIXCertPathValidator.java","additions":3,"deletions":3,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2000, 2017, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2000, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -347,1 +347,1 @@\n-                        buildParams.date(), buildParams.variant()));\n+                        buildParams.timestamp(), buildParams.variant()));\n","filename":"src\/java.base\/share\/classes\/sun\/security\/provider\/certpath\/SunCertPathBuilder.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -42,1 +42,0 @@\n-import java.text.SimpleDateFormat;\n@@ -686,2 +685,0 @@\n-        private static final SimpleDateFormat dateFormat =\n-                new SimpleDateFormat(\"EEE, MMM d HH:mm:ss z yyyy\");\n@@ -721,1 +718,1 @@\n-                        dateFormat.format(denyAfterDate));\n+                        denyAfterDate);\n@@ -752,2 +749,2 @@\n-                        dateFormat.format(denyAfterDate) + \"; params date: \" +\n-                        dateFormat.format(currentDate) + cp.extendedExceptionMsg(),\n+                        denyAfterDate + \"; params date: \" +\n+                        currentDate + cp.extendedExceptionMsg(),\n","filename":"src\/java.base\/share\/classes\/sun\/security\/util\/DisabledAlgorithmConstraints.java","additions":3,"deletions":6,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2020, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -53,1 +53,1 @@\n-    \/\/ The keys of the signers\n+    \/\/ The keys of the signers and TSA\n@@ -55,1 +55,1 @@\n-    \/\/ The certs in the signers' chains that are issued by the trust anchor\n+    \/\/ The certs in the signers and TSA chain that are issued by the trust anchor\n@@ -76,1 +76,1 @@\n-            init(signer.getSignerCertPath());\n+            addToCertsAndKeys(signer.getSignerCertPath());\n@@ -85,1 +85,1 @@\n-                init(timestamp.getSignerCertPath());\n+                addToCertsAndKeys(timestamp.getSignerCertPath());\n@@ -101,2 +101,14 @@\n-    \/\/ extract last certificate and key from chain\n-    private void init(CertPath cp) {\n+    public JarConstraintsParameters(List<X509Certificate> chain, Timestamp timestamp) {\n+        this.keys = new HashSet<>();\n+        this.certsIssuedByAnchor = new HashSet<>();\n+        addToCertsAndKeys(chain);\n+        if (timestamp != null) {\n+            addToCertsAndKeys(timestamp.getSignerCertPath());\n+            this.timestamp = timestamp.getTimestamp();\n+        } else {\n+            this.timestamp = null;\n+        }\n+    }\n+\n+    \/\/ extract last certificate and signer's public key from chain\n+    private void addToCertsAndKeys(CertPath cp) {\n@@ -106,0 +118,4 @@\n+        addToCertsAndKeys(chain);\n+    }\n+\n+    private void addToCertsAndKeys(List<X509Certificate> chain) {\n@@ -171,1 +187,1 @@\n-        sb.append(\"\\n  Variant: \").append(getVariant());\n+        sb.append(\"  Variant: \").append(getVariant());\n","filename":"src\/java.base\/share\/classes\/sun\/security\/util\/JarConstraintsParameters.java","additions":24,"deletions":8,"binary":false,"changes":32,"status":"modified"},{"patch":"@@ -578,1 +578,1 @@\n-# There is one defined security property:  jdk.disabled.NamedCurves\n+# There is one defined security property:  jdk.disabled.namedCurves\n@@ -655,0 +655,1 @@\n+    SHA1 usage SignedJAR & denyAfter 2019-01-01, \\\n@@ -719,1 +720,2 @@\n-      DSA keySize < 1024, include jdk.disabled.namedCurves\n+      DSA keySize < 1024, SHA1 denyAfter 2019-01-01, \\\n+      include jdk.disabled.namedCurves\n","filename":"src\/java.base\/share\/conf\/security\/java.security","additions":4,"deletions":2,"binary":false,"changes":6,"status":"modified"},{"patch":"@@ -57,0 +57,1 @@\n+import sun.security.provider.certpath.CertPathConstraintsParameters;\n@@ -943,1 +944,2 @@\n-                            X509Certificate signer = si.getCertificate(p7);\n+                            ArrayList<X509Certificate> chain = si.getCertificateChain(p7);\n+                            X509Certificate signer = chain.get(0);\n@@ -965,0 +967,2 @@\n+                                JarConstraintsParameters jcp =\n+                                    new JarConstraintsParameters(chain, si.getTimestamp());\n@@ -968,3 +972,3 @@\n-                                        verifyWithWeak(digestAlg, DIGEST_PRIMITIVE_SET, false),\n-                                        verifyWithWeak(sigAlg, SIG_PRIMITIVE_SET, false),\n-                                        verifyWithWeak(key),\n+                                        verifyWithWeak(digestAlg, DIGEST_PRIMITIVE_SET, false, jcp),\n+                                        verifyWithWeak(sigAlg, SIG_PRIMITIVE_SET, false, jcp),\n+                                        verifyWithWeak(key, jcp),\n@@ -973,3 +977,3 @@\n-                                        verifyWithWeak(tsDigestAlg, DIGEST_PRIMITIVE_SET, true),\n-                                        verifyWithWeak(tsSigAlg, SIG_PRIMITIVE_SET, true),\n-                                        verifyWithWeak(tsKey));\n+                                        verifyWithWeak(tsDigestAlg, DIGEST_PRIMITIVE_SET, true, jcp),\n+                                        verifyWithWeak(tsSigAlg, SIG_PRIMITIVE_SET, true, jcp),\n+                                        verifyWithWeak(tsKey, jcp));\n@@ -977,0 +981,2 @@\n+                                JarConstraintsParameters jcp =\n+                                    new JarConstraintsParameters(chain, null);\n@@ -980,3 +986,3 @@\n-                                        verifyWithWeak(digestAlg, DIGEST_PRIMITIVE_SET, false),\n-                                        verifyWithWeak(sigAlg, SIG_PRIMITIVE_SET, false),\n-                                        verifyWithWeak(key));\n+                                        verifyWithWeak(digestAlg, DIGEST_PRIMITIVE_SET, false, jcp),\n+                                        verifyWithWeak(sigAlg, SIG_PRIMITIVE_SET, false, jcp),\n+                                        verifyWithWeak(key, jcp));\n@@ -985,0 +991,1 @@\n+                            e.printStackTrace();\n@@ -1311,4 +1318,16 @@\n-    private String verifyWithWeak(String alg, Set<CryptoPrimitive> primitiveSet, boolean tsa) {\n-        if (DISABLED_CHECK.permits(primitiveSet, alg, null)) {\n-            if (LEGACY_CHECK.permits(primitiveSet, alg, null)) {\n-                return alg;\n+    private String verifyWithWeak(String alg, Set<CryptoPrimitive> primitiveSet,\n+        boolean tsa, JarConstraintsParameters jcp) {\n+\n+        try {\n+            DISABLED_CHECK.permits(alg, jcp);\n+        } catch (CertPathValidatorException e) {\n+            disabledAlgFound = true;\n+            return String.format(rb.getString(\"with.disabled\"), alg);\n+        }\n+        try {\n+            LEGACY_CHECK.permits(alg, jcp);\n+            return alg;\n+        } catch (CertPathValidatorException e) {\n+            if (primitiveSet == SIG_PRIMITIVE_SET) {\n+                legacyAlg |= 2;\n+                legacySigAlg = alg;\n@@ -1316,3 +1335,3 @@\n-                if (primitiveSet == SIG_PRIMITIVE_SET) {\n-                   legacyAlg |= 2;\n-                   legacySigAlg = alg;\n+                if (tsa) {\n+                    legacyAlg |= 4;\n+                    legacyTsaDigestAlg = alg;\n@@ -1320,7 +1339,2 @@\n-                    if (tsa) {\n-                        legacyAlg |= 4;\n-                        legacyTsaDigestAlg = alg;\n-                    } else {\n-                        legacyAlg |= 1;\n-                        legacyDigestAlg = alg;\n-                    }\n+                    legacyAlg |= 1;\n+                    legacyDigestAlg = alg;\n@@ -1328,1 +1342,0 @@\n-                return String.format(rb.getString(\"with.weak\"), alg);\n@@ -1330,3 +1343,1 @@\n-        } else {\n-            disabledAlgFound = true;\n-            return String.format(rb.getString(\"with.disabled\"), alg);\n+            return String.format(rb.getString(\"with.weak\"), alg);\n@@ -1336,1 +1347,1 @@\n-    private String verifyWithWeak(PublicKey key) {\n+    private String verifyWithWeak(PublicKey key, JarConstraintsParameters jcp) {\n@@ -1338,7 +1349,10 @@\n-        if (DISABLED_CHECK.permits(SIG_PRIMITIVE_SET, key)) {\n-            if (LEGACY_CHECK.permits(SIG_PRIMITIVE_SET, key)) {\n-                if (kLen >= 0) {\n-                    return String.format(rb.getString(\"key.bit\"), kLen);\n-                } else {\n-                    return rb.getString(\"unknown.size\");\n-                }\n+        try {\n+            DISABLED_CHECK.permits(key.getAlgorithm(), jcp);\n+        } catch (CertPathValidatorException e) {\n+            disabledAlgFound = true;\n+            return String.format(rb.getString(\"key.bit.disabled\"), kLen);\n+        }\n+        try {\n+            LEGACY_CHECK.permits(key.getAlgorithm(), jcp);\n+            if (kLen >= 0) {\n+                return String.format(rb.getString(\"key.bit\"), kLen);\n@@ -1346,3 +1360,1 @@\n-                weakPublicKey = key;\n-                legacyAlg |= 8;\n-                return String.format(rb.getString(\"key.bit.weak\"), kLen);\n+                return rb.getString(\"unknown.size\");\n@@ -1350,3 +1362,4 @@\n-        } else {\n-           disabledAlgFound = true;\n-           return String.format(rb.getString(\"key.bit.disabled\"), kLen);\n+        } catch (CertPathValidatorException e) {\n+            weakPublicKey = key;\n+            legacyAlg |= 8;\n+            return String.format(rb.getString(\"key.bit.weak\"), kLen);\n@@ -1356,3 +1369,8 @@\n-    private void checkWeakSign(String alg, Set<CryptoPrimitive> primitiveSet, boolean tsa) {\n-        if (DISABLED_CHECK.permits(primitiveSet, alg, null)) {\n-            if (!LEGACY_CHECK.permits(primitiveSet, alg, null)) {\n+    private void checkWeakSign(String alg, Set<CryptoPrimitive> primitiveSet,\n+        boolean tsa, JarConstraintsParameters jcp) {\n+\n+        try {\n+            DISABLED_CHECK.permits(alg, jcp);\n+            try {\n+                LEGACY_CHECK.permits(alg, jcp);\n+            } catch (CertPathValidatorException e) {\n@@ -1360,1 +1378,1 @@\n-                   legacyAlg |= 2;\n+                    legacyAlg |= 2;\n@@ -1369,1 +1387,1 @@\n-        } else {\n+        } catch (CertPathValidatorException e) {\n@@ -1382,3 +1400,6 @@\n-    private void checkWeakSign(PrivateKey key) {\n-        if (DISABLED_CHECK.permits(SIG_PRIMITIVE_SET, key)) {\n-            if (!LEGACY_CHECK.permits(SIG_PRIMITIVE_SET, key)) {\n+    private void checkWeakSign(PrivateKey key, JarConstraintsParameters jcp) {\n+        try {\n+            DISABLED_CHECK.permits(key.getAlgorithm(), jcp);\n+            try {\n+                LEGACY_CHECK.permits(key.getAlgorithm(), jcp);\n+            } catch (CertPathValidatorException e) {\n@@ -1387,1 +1408,1 @@\n-        } else {\n+        } catch (CertPathValidatorException e) {\n@@ -1414,1 +1435,1 @@\n-        Date timestamp, boolean checkUsage) throws Exception {\n+        Date timestamp, boolean checkUsage, CertPathConstraintsParameters cpcp) throws Exception {\n@@ -1618,1 +1639,3 @@\n-        checkWeakSign(digestalg, DIGEST_PRIMITIVE_SET, false);\n+        JarConstraintsParameters jcp =\n+            new JarConstraintsParameters(Arrays.asList(certChain), null);\n+        checkWeakSign(digestalg, DIGEST_PRIMITIVE_SET, false, jcp);\n@@ -1623,1 +1646,1 @@\n-        checkWeakSign(tSADigestAlg, DIGEST_PRIMITIVE_SET, true);\n+        checkWeakSign(tSADigestAlg, DIGEST_PRIMITIVE_SET, true, jcp);\n@@ -1628,1 +1651,1 @@\n-        checkWeakSign(sigalg, SIG_PRIMITIVE_SET, false);\n+        checkWeakSign(sigalg, SIG_PRIMITIVE_SET, false, jcp);\n@@ -1630,1 +1653,1 @@\n-        checkWeakSign(privateKey);\n+        checkWeakSign(privateKey, jcp);\n@@ -1728,0 +1751,2 @@\n+                    CertPathConstraintsParameters cpcp =\n+                        new CertPathConstraintsParameters(tsaCert, Validator.VAR_TSA_SERVER, null, null);\n@@ -1729,1 +1754,1 @@\n-                            printCert(true, \"\", tsaCert, null, false));\n+                            printCert(true, \"\", tsaCert, null, false, cpcp));\n@@ -1935,0 +1960,3 @@\n+        @SuppressWarnings(\"unchecked\")\n+        List<X509Certificate> chain = (List<X509Certificate>)certs;\n+        TrustAnchor anchor = findTrustAnchor(chain);\n@@ -1936,1 +1964,3 @@\n-            sb.append(printCert(false, tab2, c, timestamp, first));\n+            CertPathConstraintsParameters cpcp =\n+                new CertPathConstraintsParameters((X509Certificate)c, Validator.VAR_CODE_SIGNING, anchor, timestamp);\n+            sb.append(printCert(false, tab2, c, timestamp, first, cpcp));\n@@ -1949,0 +1979,4 @@\n+            List<? extends Certificate> tscerts = ts.getSignerCertPath().getCertificates();\n+            @SuppressWarnings(\"unchecked\")\n+            List<X509Certificate> tschain = (List<X509Certificate>)tscerts;\n+            anchor = findTrustAnchor(chain);\n@@ -1950,2 +1984,4 @@\n-            for (Certificate c : ts.getSignerCertPath().getCertificates()) {\n-                sb.append(printCert(true, tab2, c, null, false));\n+            for (Certificate c : tschain) {\n+                CertPathConstraintsParameters cpcp =\n+                    new CertPathConstraintsParameters((X509Certificate)c, Validator.VAR_TSA_SERVER, anchor, timestamp);\n+                sb.append(printCert(true, tab2, c, null, false, cpcp));\n@@ -1972,0 +2008,9 @@\n+    private TrustAnchor findTrustAnchor(List<X509Certificate> chain) {\n+        X509Certificate last = chain.get(chain.size() - 1);\n+        Optional<X509Certificate> trusted =\n+            trustedCerts.stream()\n+                        .filter(c -> c.getSubjectX500Principal().equals(last.getIssuerX500Principal()))\n+                        .findFirst();\n+        return trusted.isPresent() ? new TrustAnchor(trusted.get(), null) : null;\n+    }\n+\n","filename":"src\/jdk.jartool\/share\/classes\/sun\/security\/tools\/jarsigner\/Main.java","additions":105,"deletions":60,"binary":false,"changes":165,"status":"modified"},{"patch":"@@ -1,98 +0,0 @@\n-#\n-# Copyright (c) 2002, 2013, Oracle and\/or its affiliates. All rights reserved.\n-# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n-#\n-# This code is free software; you can redistribute it and\/or modify it\n-# under the terms of the GNU General Public License version 2 only, as\n-# published by the Free Software Foundation.\n-#\n-# This code is distributed in the hope that it will be useful, but WITHOUT\n-# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n-# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n-# version 2 for more details (a copy is included in the LICENSE file that\n-# accompanied this code).\n-#\n-# You should have received a copy of the GNU General Public License version\n-# 2 along with this work; if not, write to the Free Software Foundation,\n-# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n-#\n-# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n-# or visit www.oracle.com if you need additional information or have any\n-# questions.\n-#\n-\n-# @test\n-# @bug 4504355\n-# @summary problems if signed crypto provider is the most preferred provider\n-#\n-# @run shell Dyn.sh\n-\n-# set a few environment variables so that the shell-script can run stand-alone\n-# in the source directory\n-if [ \"${TESTSRC}\" = \"\" ] ; then\n-   TESTSRC=\".\"\n-fi\n-\n-if [ \"${TESTCLASSES}\" = \"\" ] ; then\n-   TESTCLASSES=\".\"\n-fi\n-\n-if [ \"${TESTJAVA}\" = \"\" ] ; then\n-   echo \"TESTJAVA not set.  Test cannot execute.\"\n-   echo \"FAILED!!!\"\n-   exit 1\n-fi\n-\n-if [ \"${COMPILEJAVA}\" = \"\" ]; then\n-   COMPILEJAVA=\"${TESTJAVA}\"\n-fi\n-\n-# set platform-dependent variables\n-OS=`uname -s`\n-case \"$OS\" in\n-  SunOS )\n-    PATHSEP=\":\"\n-    FILESEP=\"\/\"\n-    ;;\n-  Linux )\n-    PATHSEP=\":\"\n-    FILESEP=\"\/\"\n-    ;;\n-  Darwin )\n-    PATHSEP=\":\"\n-    FILESEP=\"\/\"\n-    ;;\n-  AIX )\n-    PATHSEP=\":\"\n-    FILESEP=\"\/\"\n-    ;;\n-  CYGWIN* )\n-    PATHSEP=\";\"\n-    FILESEP=\"\/\"\n-    ;;\n-  Windows* )\n-    PATHSEP=\";\"\n-    FILESEP=\"\\\\\"\n-    ;;\n-  * )\n-    echo \"Unrecognized system!\"\n-    exit 1;\n-    ;;\n-esac\n-\n-# remove old class files\n-cd ${TESTCLASSES}${FILESEP}\n-rm DynSignedProvFirst.class\n-\n-# compile the test program\n-${COMPILEJAVA}${FILESEP}bin${FILESEP}javac ${TESTJAVACOPTS} ${TESTTOOLVMOPTS} \\\n-        -classpath ${TESTSRC}${FILESEP}exp.jar \\\n-        -d ${TESTCLASSES}${FILESEP} \\\n-        ${TESTSRC}${FILESEP}DynSignedProvFirst.java\n-\n-# run the test\n-${TESTJAVA}${FILESEP}bin${FILESEP}java ${TESTVMOPTS} \\\n-        -classpath \"${TESTCLASSES}${PATHSEP}${TESTSRC}${FILESEP}exp.jar\" \\\n-        DynSignedProvFirst\n-\n-exit $?\n","filename":"test\/jdk\/java\/security\/Security\/signedfirst\/Dyn.sh","additions":0,"deletions":98,"binary":false,"changes":98,"status":"deleted"},{"patch":"@@ -0,0 +1,96 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\/*\n+ * @test\n+ * @bug 4504355 4744260\n+ * @summary problems if signed crypto provider is the most preferred provider\n+ * @modules java.base\/sun.security.tools.keytool\n+ *          jdk.jartool\/sun.security.tools.jarsigner\n+ * @library \/test\/lib\n+ * @run main\/othervm DynStatic\n+ *\/\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.List;\n+\n+import jdk.test.lib.compiler.CompilerUtils;\n+import jdk.test.lib.process.ProcessTools;\n+import jdk.test.lib.util.JarUtils;\n+\n+public class DynStatic {\n+\n+    private static final String TEST_SRC =\n+        Paths.get(System.getProperty(\"test.src\")).toString();\n+    private static final Path TEST_CLASSES =\n+        Paths.get(System.getProperty(\"test.classes\"));\n+\n+    private static final Path EXP_SRC_DIR = Paths.get(TEST_SRC, \"com\");\n+    private static final Path EXP_DEST_DIR = Paths.get(\"build\");\n+    private static final Path DYN_SRC =\n+        Paths.get(TEST_SRC, \"DynSignedProvFirst.java\");\n+    private static final Path STATIC_SRC =\n+        Paths.get(TEST_SRC, \"StaticSignedProvFirst.java\");\n+\n+    private static final String STATIC_PROPS =\n+        Paths.get(TEST_SRC, \"Static.props\").toString();\n+\n+    public static void main(String[] args) throws Exception {\n+\n+        \/\/ Compile the provider\n+        CompilerUtils.compile(EXP_SRC_DIR, EXP_DEST_DIR);\n+\n+        \/\/ Create a jar file containing the provider\n+        JarUtils.createJarFile(Path.of(\"exp.jar\"), EXP_DEST_DIR, \"com\");\n+\n+        \/\/ Create a keystore\n+        sun.security.tools.keytool.Main.main(\n+            (\"-genkeypair -dname CN=Signer -keystore exp.ks -storepass \"\n+                + \"changeit -keypass changeit -keyalg rsa\").split(\" \"));\n+\n+        \/\/ Sign jar\n+        sun.security.tools.jarsigner.Main.main(\n+                \"-storepass changeit -keystore exp.ks exp.jar mykey\"\n+                        .split(\" \"));\n+\n+        \/\/ Compile the DynSignedProvFirst test program\n+        CompilerUtils.compile(DYN_SRC, TEST_CLASSES, \"-classpath\", \"exp.jar\");\n+\n+        \/\/ Run the DynSignedProvFirst test program\n+        ProcessTools.executeTestJvm(\"-classpath\",\n+            TEST_CLASSES.toString() + File.pathSeparator + \"exp.jar\",\n+            \"DynSignedProvFirst\")\n+            .shouldContain(\"test passed\");\n+\n+        \/\/ Compile the StaticSignedProvFirst test program\n+        CompilerUtils.compile(STATIC_SRC, TEST_CLASSES, \"-classpath\", \"exp.jar\");\n+\n+        \/\/ Run the StaticSignedProvFirst test program\n+        ProcessTools.executeTestJvm(\"-classpath\",\n+            TEST_CLASSES.toString() + File.pathSeparator + \"exp.jar\",\n+            \"-Djava.security.properties=file:\" + STATIC_PROPS,\n+            \"StaticSignedProvFirst\")\n+            .shouldContain(\"test passed\");\n+    }\n+}\n","filename":"test\/jdk\/java\/security\/Security\/signedfirst\/DynStatic.java","additions":96,"deletions":0,"binary":false,"changes":96,"status":"added"},{"patch":"@@ -1,100 +0,0 @@\n-#\n-# Copyright (c) 2002, 2013, Oracle and\/or its affiliates. All rights reserved.\n-# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n-#\n-# This code is free software; you can redistribute it and\/or modify it\n-# under the terms of the GNU General Public License version 2 only, as\n-# published by the Free Software Foundation.\n-#\n-# This code is distributed in the hope that it will be useful, but WITHOUT\n-# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n-# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n-# version 2 for more details (a copy is included in the LICENSE file that\n-# accompanied this code).\n-#\n-# You should have received a copy of the GNU General Public License version\n-# 2 along with this work; if not, write to the Free Software Foundation,\n-# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n-#\n-# Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n-# or visit www.oracle.com if you need additional information or have any\n-# questions.\n-#\n-\n-# @test\n-# @bug 4504355 4744260\n-# @summary problems if signed crypto provider is the most preferred provider\n-#\n-# @run shell Static.sh\n-\n-# set a few environment variables so that the shell-script can run stand-alone\n-# in the source directory\n-if [ \"${TESTSRC}\" = \"\" ] ; then\n-   TESTSRC=\".\"\n-fi\n-\n-if [ \"${TESTCLASSES}\" = \"\" ] ; then\n-   TESTCLASSES=\".\"\n-fi\n-\n-if [ \"${TESTJAVA}\" = \"\" ] ; then\n-   echo \"TESTJAVA not set.  Test cannot execute.\"\n-   echo \"FAILED!!!\"\n-   exit 1\n-fi\n-\n-if [ \"${COMPILEJAVA}\" = \"\" ]; then\n-   COMPILEJAVA=\"${TESTJAVA}\"\n-fi\n-\n-# set platform-dependent variables\n-OS=`uname -s`\n-case \"$OS\" in\n-  SunOS )\n-    PATHSEP=\":\"\n-    FILESEP=\"\/\"\n-    ;;\n-  Linux )\n-    PATHSEP=\":\"\n-    FILESEP=\"\/\"\n-    ;;\n-  Darwin )\n-    PATHSEP=\":\"\n-    FILESEP=\"\/\"\n-    ;;\n-  AIX )\n-    PATHSEP=\":\"\n-    FILESEP=\"\/\"\n-    ;;\n-  CYGWIN* )\n-    PATHSEP=\";\"\n-    FILESEP=\"\/\"\n-    ;;\n-  Windows* )\n-    PATHSEP=\";\"\n-    FILESEP=\"\\\\\"\n-    ;;\n-  * )\n-    echo \"Unrecognized system!\"\n-    exit 1;\n-    ;;\n-esac\n-\n-# remove old class files\n-cd ${TESTCLASSES}${FILESEP}\n-rm StaticSignedProvFirst.class\n-\n-# compile the test program\n-${COMPILEJAVA}${FILESEP}bin${FILESEP}javac ${TESTJAVACOPTS} ${TESTTOOLVMOPTS} \\\n-        -classpath \"${TESTCLASSES}${PATHSEP}${TESTSRC}${FILESEP}exp.jar\" \\\n-        -d ${TESTCLASSES}${FILESEP} \\\n-        ${TESTSRC}${FILESEP}StaticSignedProvFirst.java\n-\n-# run the test\n-cd ${TESTSRC}${FILESEP}\n-${TESTJAVA}${FILESEP}bin${FILESEP}java ${TESTVMOPTS} \\\n-        -classpath \"${TESTCLASSES}${PATHSEP}${TESTSRC}${FILESEP}exp.jar\" \\\n-        -Djava.security.properties=file:${TESTSRC}${FILESEP}Static.props \\\n-        StaticSignedProvFirst\n-\n-exit $?\n","filename":"test\/jdk\/java\/security\/Security\/signedfirst\/Static.sh","additions":0,"deletions":100,"binary":false,"changes":100,"status":"deleted"},{"patch":"@@ -0,0 +1,34 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package com.sun.exp.provider;\n+\n+import java.security.Provider;\n+\n+public class EXP extends Provider {\n+\n+    public EXP() {\n+        super(\"EXP\", 0.0d, \"Test provider\");\n+        put(\"MessageDigest.SHA1\", \"com.sun.exp.provider.SHA\");\n+    }\n+}\n","filename":"test\/jdk\/java\/security\/Security\/signedfirst\/com\/sun\/exp\/provider\/EXP.java","additions":34,"deletions":0,"binary":false,"changes":34,"status":"added"},{"patch":"@@ -0,0 +1,33 @@\n+\/*\n+ * Copyright (c) 2021, Oracle and\/or its affiliates. All rights reserved.\n+ * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.\n+ *\n+ * This code is free software; you can redistribute it and\/or modify it\n+ * under the terms of the GNU General Public License version 2 only, as\n+ * published by the Free Software Foundation.\n+ *\n+ * This code is distributed in the hope that it will be useful, but WITHOUT\n+ * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n+ * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License\n+ * version 2 for more details (a copy is included in the LICENSE file that\n+ * accompanied this code).\n+ *\n+ * You should have received a copy of the GNU General Public License version\n+ * 2 along with this work; if not, write to the Free Software Foundation,\n+ * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.\n+ *\n+ * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA\n+ * or visit www.oracle.com if you need additional information or have any\n+ * questions.\n+ *\/\n+\n+package com.sun.exp.provider;\n+\n+import java.security.MessageDigestSpi;\n+\n+public class SHA extends MessageDigestSpi {\n+    protected void engineReset() {}\n+    protected void engineUpdate(byte input) {}\n+    protected void engineUpdate(byte[] input, int offset, int len) {}\n+    protected byte[] engineDigest() { return null; }\n+}\n","filename":"test\/jdk\/java\/security\/Security\/signedfirst\/com\/sun\/exp\/provider\/SHA.java","additions":33,"deletions":0,"binary":false,"changes":33,"status":"added"},{"filename":"test\/jdk\/java\/security\/Security\/signedfirst\/exp.jar","binary":true,"status":"deleted"},{"filename":"test\/jdk\/java\/security\/Security\/signedfirst\/keystore.jks","binary":true,"status":"deleted"},{"filename":"test\/jdk\/java\/util\/jar\/JarFile\/Signed.jar","binary":true,"status":"modified"},{"filename":"test\/jdk\/java\/util\/jar\/JarFile\/test.jar","binary":true,"status":"modified"},{"filename":"test\/jdk\/java\/util\/jar\/JarInputStream\/signed.jar","binary":true,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2010, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2010, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -54,1 +54,1 @@\n-        SecurityTools.jarsigner(ksArgs + \" -digestalg SHA1 \"\n+        SecurityTools.jarsigner(ksArgs + \" -digestalg SHA-256 \"\n","filename":"test\/jdk\/sun\/security\/tools\/jarsigner\/DiffEnd.java","additions":2,"deletions":2,"binary":false,"changes":4,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2007, 2019, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2007, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -54,0 +54,2 @@\n+        String propArgs = \" -J-Djava.security.properties=\"\n+                + src.resolve(\"OldSig.props\");\n@@ -56,1 +58,2 @@\n-        SecurityTools.jarsigner(\"-verify \" + ksArgs + \" -verbose B.jar c\")\n+        SecurityTools.jarsigner(\"-verify \" + ksArgs + propArgs\n+                + \" -verbose B.jar c\")\n","filename":"test\/jdk\/sun\/security\/tools\/jarsigner\/OldSig.java","additions":5,"deletions":2,"binary":false,"changes":7,"status":"modified"},{"patch":"@@ -0,0 +1,2 @@\n+# Re-enable SHA-1 since OldSig.java test uses it\n+jdk.jar.disabledAlgorithms=MD2,MD5,RSA keySize < 1024,DSA keySize < 1024\n","filename":"test\/jdk\/sun\/security\/tools\/jarsigner\/OldSig.props","additions":2,"deletions":0,"binary":false,"changes":2,"status":"added"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2005, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2005, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -28,0 +28,2 @@\n+ * @library \/test\/lib\n+ * @run main\/othervm Test4431684\n@@ -34,0 +36,2 @@\n+import jdk.test.lib.security.SecurityUtils;\n+\n@@ -38,0 +42,3 @@\n+        \/\/ Re-enable SHA1 since JavaApplication1.jar uses it\n+        SecurityUtils.removeFromDisabledAlgs(\"jdk.jar.disabledAlgorithms\",\n+            List.of(\"SHA1\"));\n","filename":"test\/jdk\/sun\/security\/tools\/jarsigner\/Test4431684.java","additions":8,"deletions":1,"binary":false,"changes":9,"status":"modified"},{"patch":"@@ -2,1 +2,1 @@\n- * Copyright (c) 2003, 2020, Oracle and\/or its affiliates. All rights reserved.\n+ * Copyright (c) 2003, 2021, Oracle and\/or its affiliates. All rights reserved.\n@@ -66,0 +66,1 @@\n+ *      8269039\n@@ -208,0 +209,3 @@\n+            } else if (path.equals(\"tsbefore2019\")) {\n+                \/\/ Saturday, August 18, 2018 7:04:58 PM\n+                instant = Instant.ofEpochSecond(1534619098l);\n@@ -354,0 +358,11 @@\n+                \/\/ should not be disabled because timestamped before 2019\n+                signVerbose(\"tsbefore2019\", \"unsigned.jar\", \"tsbefore2019.jar\", \"pre2019signer\",\n+                        \"-digestalg\", \"SHA-1\")\n+                        .shouldHaveExitValue(4);\n+\n+                verify(\"tsbefore2019.jar\", \"-verbose\")\n+                        .shouldHaveExitValue(0)\n+                        .shouldMatch(\"Digest.*SHA-1.*(weak)\")\n+                        .shouldMatch(\"signer certificate expired on .*. \"\n+                                + \"However, the JAR will be valid\");\n+\n@@ -427,1 +442,1 @@\n-                \/\/ Legacy algorithms\n+                \/\/ Disabled algorithms\n@@ -429,10 +444,9 @@\n-                        \"-strict\", \"-digestalg\", \"SHA-1\")\n-                        .shouldHaveExitValue(0)\n-                        .shouldContain(\"jar signed, with signer errors\")\n-                        .shouldMatch(\"SHA-1.*-digestalg.*will be disabled\");\n-                verify(\"sha1alg.jar\", \"-strict\")\n-                        .shouldHaveExitValue(0)\n-                        .shouldContain(\"jar verified, with signer errors\")\n-                        .shouldContain(\"SHA-1 digest algorithm is considered a security risk\")\n-                        .shouldContain(\"This algorithm will be disabled in a future update\")\n-                        .shouldNotContain(\"is disabled\");\n+                        \"-digestalg\", \"SHA-1\")\n+                        .shouldHaveExitValue(4)\n+                        .shouldContain(\"jar signed\")\n+                        .shouldContain(\"with signer errors\")\n+                        .shouldMatch(\"SHA-1.*-digestalg.*is disabled\");\n+                verify(\"sha1alg.jar\", \"-verbose\")\n+                        .shouldHaveExitValue(16)\n+                        .shouldContain(\"treated as unsigned\")\n+                        .shouldMatch(\"Digest.*SHA-1.*(disabled)\");\n@@ -441,9 +455,8 @@\n-                        .shouldHaveExitValue(0)\n-                        .shouldContain(\"jar signed, with signer errors\")\n-                        .shouldMatch(\"SHA-1.*-tsadigestalg.*will be disabled\")\n-                        .shouldNotContain(\"is disabled\");\n-                verify(\"sha1tsaalg.jar\", \"-strict\")\n-                        .shouldHaveExitValue(0)\n-                        .shouldContain(\"jar verified, with signer errors\")\n-                        .shouldContain(\"SHA-1 digest algorithm is considered a security risk\")\n-                        .shouldNotContain(\"is disabled\");\n+                        .shouldHaveExitValue(4)\n+                        .shouldContain(\"jar signed\")\n+                        .shouldContain(\"with signer errors\")\n+                        .shouldMatch(\"SHA-1.*-tsadigestalg.*is disabled\");\n+                verify(\"sha1tsaalg.jar\", \"-verbose\")\n+                        .shouldHaveExitValue(16)\n+                        .shouldContain(\"treated as unsigned\")\n+                        .shouldMatch(\"Timestamp.*digest.*SHA-1.*(disabled)\");\n@@ -451,1 +464,0 @@\n-                \/\/ Disabled algorithms\n@@ -489,1 +501,1 @@\n-                \/\/ Legacy algorithms\n+                \/\/ Disabled algorithms\n@@ -492,5 +504,10 @@\n-                        .shouldHaveExitValue(0)\n-                        .shouldMatch(\"SHA1.*-digestalg.*will be disabled\")\n-                        .shouldMatch(\"SHA1.*-tsadigestalg.*will be disabled\")\n-                        .shouldMatch(\"SHA1withRSA.*-sigalg.*will be disabled\");\n-                checkWeak(\"tsweak.jar\");\n+                        .shouldHaveExitValue(4)\n+                        .shouldMatch(\"SHA1.*-digestalg.*is disabled\")\n+                        .shouldMatch(\"SHA1.*-tsadigestalg.*is disabled\")\n+                        .shouldMatch(\"SHA1withRSA.*-sigalg.*is disabled\");\n+                verify(\"tsweak.jar\", \"-verbose\")\n+                        .shouldHaveExitValue(16)\n+                        .shouldContain(\"treated as unsigned\")\n+                        .shouldMatch(\"Digest algorithm: .*(disabled)\")\n+                        .shouldMatch(\"Signature algorithm: .*(disabled)\")\n+                        .shouldMatch(\"Timestamp digest algorithm: .*(disabled)\");\n@@ -498,0 +515,1 @@\n+                \/\/ Legacy algorithms (1024-bit key)\n@@ -506,1 +524,1 @@\n-                \/\/ Algorithm used in signing is weak\n+                \/\/ Algorithm used in signing is disabled\n@@ -509,4 +527,6 @@\n-                        .shouldContain(\"-digestalg option is considered a security risk.\")\n-                        .shouldContain(\"This algorithm will be disabled in a future update.\")\n-                        .shouldHaveExitValue(0);\n-                checkHalfWeak(\"halfWeak.jar\");\n+                        .shouldContain(\"-digestalg option is considered a security risk and is disabled.\")\n+                        .shouldHaveExitValue(4);\n+                verify(\"halfWeak.jar\", \"-verbose\")\n+                        .shouldHaveExitValue(16)\n+                        .shouldContain(\"treated as unsigned\")\n+                        .shouldMatch(\"Digest algorithm: .*(disabled)\");\n@@ -950,0 +970,1 @@\n+        keytool(\"-alias pre2019signer -genkeypair -dname CN=pre2019signer\");\n@@ -956,0 +977,1 @@\n+        keytool(\"-alias tsbefore2019 -genkeypair -dname CN=tsbefore2019\");\n@@ -979,0 +1001,1 @@\n+        gencert(\"pre2019signer\", \"-startdate 2018\/06\/01 -validity 365\");\n@@ -1012,0 +1035,1 @@\n+        gencert(\"tsbefore2019\", \"-ext eku:critical=ts -startdate 2018\/01\/01 -validity 3000\");\n","filename":"test\/jdk\/sun\/security\/tools\/jarsigner\/TimestampCheck.java","additions":57,"deletions":33,"binary":false,"changes":90,"status":"modified"}]}